<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-aspnet-list] issues with intermittent apache hangups
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=%5BMono-aspnet-list%5D%20issues%20with%20intermittent%20apache%20hangups&In-Reply-To=1302035065208-3429084.post%40n4.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001228.html">
   <LINK REL="Next"  HREF="001242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-aspnet-list] issues with intermittent apache hangups</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=%5BMono-aspnet-list%5D%20issues%20with%20intermittent%20apache%20hangups&In-Reply-To=1302035065208-3429084.post%40n4.nabble.com"
       TITLE="[Mono-aspnet-list] issues with intermittent apache hangups">grendel at twistedcode.net
       </A><BR>
    <I>Mon Apr 11 09:03:06 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001228.html">[Mono-aspnet-list] issues with intermittent apache hangups
</A></li>
        <LI>Next message: <A HREF="001242.html">[Mono-aspnet-list] issues with intermittent apache hangups
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1241">[ date ]</a>
              <a href="thread.html#1241">[ thread ]</a>
              <a href="subject.html#1241">[ subject ]</a>
              <a href="author.html#1241">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 5 Apr 2011 15:24:25 -0500 (CDT)
Dan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">parnham at gmail.com</A>&gt; wrote:

Hey Dan,
&gt;<i> This appears to have fixed the problem but may have uncovered a more sinister
</I>&gt;<i> bug. With the patch applied it seems our application now runs out of memory
</I>&gt;<i> (so the previously seen exception was actually being triggered by a memory
</I>&gt;<i> leak). 
</I>[snip]
&gt;<i> At first I thought that something within our application was causing the
</I>&gt;<i> memory leak, but now I'm not so sure. I first tried updating all of the
</I>&gt;<i> third-party libraries we use to the latest versions, but that didn't make a
</I>&gt;<i> difference. 
</I>&gt;<i> 
</I>&gt;<i> Next I hacked the xsp startup script on my development machine to enable the
</I>&gt;<i> heapshot profiler and ran the application for about 45 mins. The results
</I>&gt;<i> were as follows:
</I>[snip]
&gt;<i> By the end of the test CacheItem was on top for memory usage and instance
</I>&gt;<i> count (even managed to beat System.String). It seems that these cache items
</I>&gt;<i> are never being garbage collected!
</I>&gt;<i> 
</I>&gt;<i> With traces enabled in mprof-report I gleaned this:
</I>&gt;<i> 2947320      24561      120 System.Web.Caching.CacheItem (bytes: +123600,
</I>&gt;<i> count: +1030)
</I>&gt;<i> 		51 root references (0 pinning)
</I>&gt;<i> 		24554 references from: System.Web.Caching.CacheItem[]
</I>&gt;<i> 		34 references from: System.Collections.Generic.LinkedListNode
</I>&gt;<i> 
</I>&gt;<i> which doesn't help too much.
</I>&gt;<i> 
</I>&gt;<i> So my next step was to hack the System.Web.Caching.Cache so that it logged
</I>&gt;<i> every time an item was added to the timedItems queue. The log was filled
</I>&gt;<i> with these (always an InProcSessionItem):
</I>&gt;<i> 
</I>&gt;<i> Enqueued timed cache item @@@<A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">InProc at AE0F3F94D18773EB8CC2821E</A> with value
</I>&gt;<i> System.Web.SessionState.InProcSessionItem expiring at 05/04/2011 19:21:57
</I>[snip]
&gt;<i> Hopefully somebody who understands how HttpApplication works can provide
</I>&gt;<i> some insight into what is happening and whether it is a bug in mono or how
</I>&gt;<i> we are using it?
</I>The issue here was the way the in-proc session handler handled item timeout reset. It would first
remove the item from the cache (it uses an internal instance of the Cache class) and then insert
it back in the cache. With a big number of items, that would grow the timed items priority queue
heap much more than was necessary and generate a lot of duplicate internal cache items. The effects
would be different depending on the application's usage of session data.
I've just committed a possible fix for the issue to Mono's master branch (I haven't committed it to
the mono-2-10 branch since it is a potentially breaking change which needs to be tested in real
life first) in commit 0eff07d0fc4ef1ef3c584e71a8dd54ab708543e8 (tests have been committed in
c00c5d00fddf18969c9869492f7e1235d960076b if you're interested). The fix applies cleanly to the 2.10
branch, so please apply it and test with your application to see whether it fixed the issue. Please
let me know about the results, thanks :)

marek

&gt;<i> Dan wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I've applied just the changes in that commit to our 2.10.1 installation
</I>&gt;<i> &gt; and have our test system back up and running again. It would usually crash
</I>&gt;<i> &gt; within 1-3 days, so hopefully I will be able to confirm whether or not
</I>&gt;<i> &gt; that seems to have done the trick by the end of the week.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Many thanks,
</I>&gt;<i> &gt; Dan
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Marek Habersack wrote:
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; This should be fixed by the commits:
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; 2ec75014bdf04074faeb4126f26dd3f71bb90c9d (master)
</I>&gt;<i> &gt;&gt; e57e16fee47961b8aaa2b0b22d70617b1a5b769f (mono-2-10)
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Thanks to Rodrigo Kumpera for spotting the issue :)
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; marek
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> View this message in context:
</I>&gt;<i> <A HREF="http://mono.1490590.n4.nabble.com/issues-with-intermittent-apache-hangups-tp3264509p3429084.html">http://mono.1490590.n4.nabble.com/issues-with-intermittent-apache-hangups-tp3264509p3429084.html</A>
</I>&gt;<i> Sent from the Mono - ASP.NET mailing list archive at Nabble.com.
</I>&gt;<i> _______________________________________________ Mono-aspnet-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">Mono-aspnet-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">http://lists.ximian.com/mailman/listinfo/mono-aspnet-list</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001228.html">[Mono-aspnet-list] issues with intermittent apache hangups
</A></li>
	<LI>Next message: <A HREF="001242.html">[Mono-aspnet-list] issues with intermittent apache hangups
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1241">[ date ]</a>
              <a href="thread.html#1241">[ thread ]</a>
              <a href="subject.html#1241">[ subject ]</a>
              <a href="author.html#1241">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">More information about the Mono-aspnet-list
mailing list</a><br>
</body></html>
