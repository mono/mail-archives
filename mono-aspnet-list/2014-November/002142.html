<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-aspnet-list] How to fix exception in System.Web or other way	to render view in WebAPI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20How%20to%20fix%20exception%20in%20System.Web%20or%20other%20way%0A%09to%20render%20view%20in%20WebAPI&In-Reply-To=%3CB176CED5F9614BFEA73D76DF0416B710%40dell2%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-aspnet-list] How to fix exception in System.Web or other way	to render view in WebAPI</H1>
    <B>Andrus</B> 
    <A HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20How%20to%20fix%20exception%20in%20System.Web%20or%20other%20way%0A%09to%20render%20view%20in%20WebAPI&In-Reply-To=%3CB176CED5F9614BFEA73D76DF0416B710%40dell2%3E"
       TITLE="[Mono-aspnet-list] How to fix exception in System.Web or other way	to render view in WebAPI">kobruleht2 at hot.ee
       </A><BR>
    <I>Tue Nov 11 07:07:56 UTC 2014</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2142">[ date ]</a>
              <a href="thread.html#2142">[ thread ]</a>
              <a href="subject.html#2142">[ subject ]</a>
              <a href="author.html#2142">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

Code from
<A HREF="http://forums.asp.net/t/2017674.aspx?How+to+return+rendered+razor+view+from+Web+API+controller">http://forums.asp.net/t/2017674.aspx?How+to+return+rendered+razor+view+from+Web+API+controller</A>
is used to render Razor view to string in ASP.NET MVC4 WebAPI controller. It
creates fake controller since WebAPI
does not have regular controller reuired by Razor:

     public class ValuesController : ApiController
        {

            public HttpResponseMessage Get()
            {
                var body = RenderViewToString(&quot;Values&quot;,
&quot;~/Views/Home/Index.cshtml&quot;, new object());
                return Request.CreateResponse(HttpStatusCode.OK, new {
content = body });
            }

            public static string RenderViewToString(string controllerName,
string viewName, object viewData)
            {
                using (var writer = new StringWriter())
                {
                    var routeData = new RouteData();
                    routeData.Values.Add(&quot;controller&quot;, controllerName);
                    var fakeControllerContext = new ControllerContext(new
HttpContextWrapper(new HttpContext(new HttpRequest(null,
&quot;<A HREF="http://google.com">http://google.com</A>&quot;, null), new HttpResponse(null))), routeData, new
FakeController());
                    var razorViewEngine = new RazorViewEngine();
                    var razorViewResult =
razorViewEngine.FindView(fakeControllerContext, viewName, &quot;&quot;, false);

                    var viewContext = new ViewContext(fakeControllerContext,
razorViewResult.View, new ViewDataDictionary(viewData), new
TempDataDictionary(), writer);
                    razorViewResult.View.Render(viewContext, writer);
                    return writer.ToString();
                }
            }
        }

        public class FakeController : ControllerBase  { protected override
void ExecuteCore() { }  }


In ASP.NET it works OK .
In Mono it causes NullreferenceException at line
`razorViewResult.View.Render(viewContext, writer);`

    at System.Web.HttpRequest.get_IsLocal () &lt;0x00026&gt;
    at System.Web.HttpRequestWrapper.get_IsLocal () &lt;0x0001b&gt;
    at System.Web.WebPages.WebPageHttpHandler.ShouldGenerateSourceHeader
(System.Web.HttpContextBase) &lt;0x0001f&gt;
    at System.Web.WebPages.WebPageBase.ExecutePageHierarchy () &lt;0x0002b&gt;
    at System.Web.Mvc.WebViewPage.ExecutePageHierarchy () &lt;0x0005f&gt;
    at System.Web.WebPages.StartPage.RunPage () &lt;0x0001f&gt;
    at System.Web.WebPages.StartPage.ExecutePageHierarchy () &lt;0x00057&gt;
    at System.Web.WebPages.WebPageBase.ExecutePageHierarchy
(System.Web.WebPages.WebPageContext,System.IO.TextWriter,System.Web.WebPages.WebPageRenderingBase)
&lt;0x000e5&gt;
    at System.Web.Mvc.RazorView.RenderView
(System.Web.Mvc.ViewContext,System.IO.TextWriter,object) &lt;0x00227&gt;
    at System.Web.Mvc.BuildManagerCompiledView.Render
(System.Web.Mvc.ViewContext,System.IO.TextWriter) &lt;0x000a8&gt;
    at Controllers.APIBase.RenderViewToString (string,string,object)

Mono 3.2.5 in Debian amd64 is used.
It looks like exception occurs in IsLocal() getter

<A HREF="https://github.com/mono/mono/blob/mono-3.2.5-branch/mcs/class/System.Web/System.Web/HttpRequest.cs#L1671">https://github.com/mono/mono/blob/mono-3.2.5-branch/mcs/class/System.Web/System.Web/HttpRequest.cs#L1671</A>

How to fix or diagnose this ?

If similar method is called from regular MVC4 controller using regular
controller context, it works in Mono also.
How to make it work from WebAPI controller also ?
Or is it possible to use workaround, e.q call MVC4 controller to render and
grab its result or use RazorEngine .


ndrus. 

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2142">[ date ]</a>
              <a href="thread.html#2142">[ thread ]</a>
              <a href="subject.html#2142">[ subject ]</a>
              <a href="author.html#2142">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">More information about the Mono-aspnet-list
mailing list</a><br>
</body></html>
