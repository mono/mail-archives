<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;have&nbsp;a&nbsp;setup&nbsp;here&nbsp;with&nbsp;mono&nbsp;+&nbsp;nginx&nbsp;+&nbsp;fastcgi&nbsp;+&nbsp;upstart&nbsp;on&nbsp;ubuntu&nbsp;12.04&nbsp;and&nbsp;it&nbsp;works&nbsp;fine. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;agree&nbsp;with&nbsp;Daniel&#39;s&nbsp;comment&nbsp;that&nbsp;you&nbsp;should&nbsp;probably&nbsp;use&nbsp;unix&nbsp;sockets&nbsp;if&nbsp;the&nbsp;fastcgi&nbsp;server&nbsp;and&nbsp;the&nbsp;web&nbsp;server&nbsp;run&nbsp;on&nbsp;the&nbsp;same&nbsp;machine. &lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also&nbsp;you&nbsp;probably&nbsp;want&nbsp;fastcgi-mono-server4&nbsp;to&nbsp;use&nbsp;.NET&nbsp;4.0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&#39;t&nbsp;help&nbsp;you&nbsp;with&nbsp;your&nbsp;error&nbsp;messages&nbsp;but&nbsp;what&nbsp;I&nbsp;can&nbsp;do&nbsp;is&nbsp;give&nbsp;you&nbsp;our&nbsp;configuration&nbsp;files&nbsp;and&nbsp;you&nbsp;can&nbsp;start&nbsp;from&nbsp;there.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;short&nbsp;explanation:&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;run&nbsp;4&nbsp;instances&nbsp;of&nbsp;the&nbsp;application&nbsp;and&nbsp;they&nbsp;are&nbsp;configured&nbsp;as&nbsp;an&nbsp;upstream&nbsp;for&nbsp;nginx.&nbsp;The&nbsp;load&nbsp;balancing&nbsp;is&nbsp;done&nbsp;by&nbsp;ip_hash &lt;/div&gt;&lt;div&gt;There&nbsp;is&nbsp;a&nbsp;main&nbsp;service&nbsp;and&nbsp;4&nbsp;worker&nbsp;services.&nbsp;The&nbsp;worker&nbsp;services&nbsp;are&nbsp;actual&nbsp;fastcgi&nbsp;instances.&nbsp;I&#39;m&nbsp;not&nbsp;sure&nbsp;if&nbsp;you&nbsp;really&nbsp;need&nbsp;that&nbsp;but&nbsp;we&nbsp;did&nbsp;that&nbsp;because&nbsp;we&nbsp;were&nbsp;plaing&nbsp;with&nbsp;nginx&nbsp;load&nbsp;balancing.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;&quot;location&nbsp;^~&nbsp;...&quot;&nbsp;lines&nbsp;should&nbsp;make&nbsp;nginx&nbsp;handle&nbsp;the&nbsp;static&nbsp;files.&nbsp;This&nbsp;way&nbsp;the&nbsp;fastcgi&nbsp;server&nbsp;only&nbsp;has&nbsp;to&nbsp;deal&nbsp;with&nbsp;the&nbsp;dynamic&nbsp;content.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;you&nbsp;create&nbsp;the&nbsp;directories&nbsp;make&nbsp;sure&nbsp;they&nbsp;have&nbsp;proper&nbsp;permissions.&nbsp;The&nbsp;fastcgi&nbsp;socket&nbsp;has&nbsp;to&nbsp;be&nbsp;writable&nbsp;by&nbsp;the&nbsp;user&nbsp;www-data&nbsp; as&nbsp;well<br>
 -&nbsp;or&nbsp;whatever&nbsp;user&nbsp;is&nbsp;nginx&nbsp;process&nbsp;running&nbsp;under.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&nbsp;below&nbsp;the&nbsp;configuration&nbsp;files.&nbsp;If&nbsp;you&nbsp;discover&nbsp;that&nbsp;we&nbsp;do&nbsp;something&nbsp;wrong&nbsp;please&nbsp;let&nbsp;me&nbsp;know.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Hope&nbsp;this&nbsp;helps!&lt;/div&gt;<br>
&lt;div&gt;ovidiu&lt;/div&gt;&lt;div&gt;&lt;br&gt;nginx&nbsp;configuration&nbsp;-&nbsp;goes&nbsp;to&nbsp;/etc/nginx/sites-enabled/myapp&lt;br&gt;**************************************************************&lt;br&gt;&lt;br&gt;upstream&nbsp;myapp&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;ip_hash;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;unix:/var/run/myapp/socket-1;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;unix:/var/run/myapp/socket-2;&lt;br&gt;&nbsp;&nbsp;server&nbsp;unix:/var/run/myapp/socket-3;&lt;br&gt;&nbsp;&nbsp;server&nbsp;unix:/var/run/myapp/socket-4;&lt;br&gt;}&lt;br&gt;&lt;br&gt;server&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;listen&nbsp;80;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;server_name&nbsp;&lt;a&nbsp;href=&quot;http://myapp.com&quot;&gt;myapp.com&lt;/a&gt;&nbsp;;&lt;br&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;access_log&nbsp;/var/log/myapp/nginx-access.log;&lt;br&gt;&nbsp;&nbsp;&nbsp;error_log&nbsp;/var/log/myapp/nginx-error.log;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;root&nbsp;/opt/myapp;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;^~&nbsp;/bootstrap/&nbsp;{&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;location&nbsp;^~&nbsp;/css/&nbsp;{&nbsp;}&lt;br&gt;&nbsp;location&nbsp;^~&nbsp;/img/&nbsp;{&nbsp;}&lt;br&gt;&nbsp;location&nbsp;^~&nbsp;/js/&nbsp;{&nbsp;}&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;^~&nbsp;/jslib/&nbsp;{&nbsp;}&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;location&nbsp;^~&nbsp;/Scripts/&nbsp;{&nbsp;}&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;location&nbsp;/&nbsp;{&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client_max_body_size&nbsp;4096m;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_pass&nbsp;myapp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastcgi_read_timeout&nbsp;100;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;/etc/nginx/fastcgi_params;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;<br>
&lt;br&gt;This&nbsp;is&nbsp;the&nbsp;upstart&nbsp;script&nbsp;for&nbsp;our&nbsp;main&nbsp;service&nbsp;-&nbsp;goes&nbsp;to&nbsp;/etc/init/myapp.conf&lt;br&gt;*******************************************************&lt;br&gt;description&nbsp;&quot;MyApp&nbsp;service&quot;&lt;br&gt;version&nbsp;&quot;%%version%%&quot;&lt;br&gt;<br>
author&nbsp;&quot;....&quot;&lt;br&gt;&lt;br&gt;env&nbsp;RUN_DIR=/var/run/myapp&lt;br&gt;env&nbsp;USER=www-data&lt;br&gt;env&nbsp;GROUP=myapp&lt;br&gt;&lt;br&gt;#disable&nbsp;the&nbsp;service&nbsp;for&nbsp;now&nbsp;&lt;br&gt;#start&nbsp;on&nbsp;runlevel&nbsp;[2345]&lt;br&gt;stop&nbsp;on&nbsp;shutdown&lt;br&gt;&lt;br&gt;env&nbsp;WORKERS=4&lt;br&gt;&lt;br&gt;pre-start&nbsp;script&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger&nbsp;&quot;myapp:&nbsp;prestart...&quot;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkdir&nbsp;-p&nbsp;$RUN_DIR&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chown&nbsp;$USER.$GROUP&nbsp;$RUN_DIR&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chmod&nbsp;770&nbsp;$RUN_DIR&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger&nbsp;&quot;myapp:&nbsp;starting&nbsp;$WORKERS&nbsp;workers&quot;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;`seq&nbsp;1&nbsp;$WORKERS`&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logger&nbsp;&quot;myapp:&nbsp;Starting&nbsp;worker&nbsp;$i&quot;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;myapp-worker&nbsp;N=$i&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;done&lt;br&gt;end&nbsp;script&lt;br&gt;&lt;br&gt;script&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#dummy&nbsp;process&nbsp;used&nbsp;to&nbsp;keep&nbsp;this&nbsp;instance&nbsp;alive&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#When&nbsp;this&nbsp;instance&nbsp;is&nbsp;stopped&nbsp;all&nbsp;the&nbsp;worker&nbsp;processes&nbsp;will&nbsp;stop&nbsp;also&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;because&nbsp;they&nbsp;have&nbsp;their&nbsp;stop&nbsp;on&nbsp;condition&nbsp;looks&nbsp;like&nbsp;this:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;stop&nbsp;on&nbsp;stopping&nbsp;myapp&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;true;&nbsp;do&nbsp;sleep&nbsp;1000;&nbsp;done&lt;br&gt;<br>
end&nbsp;script&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;the&nbsp;startup&nbsp;script&nbsp;for&nbsp;our&nbsp;worker&nbsp;service&nbsp;-&nbsp;goes&nbsp;to&nbsp;/etc/init/myapp-worker.conf&lt;br&gt;*********************************************************&lt;br&gt;description&nbsp;&quot;Myapp&nbsp;FastCGI&nbsp;worker&quot;&lt;br&gt;version&nbsp;&quot;%%version%%&quot;&lt;br&gt;<br>
author&nbsp;&quot;....&quot;&lt;br&gt;&lt;br&gt;instance&nbsp;$N&lt;br&gt;usage&nbsp;&quot;N&nbsp;-&nbsp;the&nbsp;instance&nbsp;nubmer&quot;&lt;br&gt;&lt;br&gt;env&nbsp;APPS=/etc/myapp/webapps&lt;br&gt;env&nbsp;SOCKET=unix:/var/run/myapp/socket&lt;br&gt;env&nbsp;LOG=/var/log/myapp/fastcgi&lt;br&gt;env&nbsp;APP_DIR=/opt/myapp&lt;br&gt;<br>
env&nbsp;FASTCGI_SERVER=fastcgi-mono-server4&lt;br&gt;env&nbsp;MONO_ENV_OPTIONS=&quot;--gc=sgen&quot;&nbsp;#This&nbsp;is&nbsp;recommended.&nbsp;The&nbsp;old&nbsp;style&nbsp;GC&nbsp;does&nbsp;not&nbsp;compact&nbsp;the&nbsp;memory&lt;br&gt;&lt;br&gt;umask&nbsp;0002&lt;br&gt;&lt;br&gt;expect&nbsp;fork&lt;br&gt;&lt;br&gt;#this&nbsp;instance&nbsp;is&nbsp;started&nbsp;by&nbsp;&#39;start&nbsp;myapp&#39;&nbsp;and&nbsp;is&nbsp;stopped&nbsp;by&nbsp;&#39;stop&nbsp;myapp&#39;&lt;br&gt;<br>
stop&nbsp;on&nbsp;stopping&nbsp;myapp&lt;br&gt;&lt;br&gt;respawn&lt;br&gt;respawn&nbsp;limit&nbsp;10&nbsp;5&lt;br&gt;&lt;br&gt;setgid&nbsp;myapp&lt;br&gt;setuid&nbsp;www-data&lt;br&gt;&lt;br&gt;exec&nbsp;$FASTCGI_SERVER&nbsp;--applications=/:$APP_DIR&nbsp;&nbsp;--socket=$SOCKET-$N&nbsp;--logfile=$LOG-$N.log&nbsp;&amp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Apr&nbsp;2,&nbsp;2013&nbsp;at&nbsp;4:42&nbsp;PM,&nbsp;maxunique&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rezkootvali@rambler.ru&quot;&nbsp;target=&quot;_blank&quot;&gt;rezkootvali@rambler.ru&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;from&nbsp;error.log&lt;br&gt;<br>
[error]&nbsp;4099#0:&nbsp;*1&nbsp;upstream&nbsp;sent&nbsp;unexpected&nbsp;FastCGI&nbsp;record:&nbsp;3&nbsp;while&nbsp;reading&lt;br&gt;<br>
response&nbsp;header&nbsp;from&nbsp;upstream,&nbsp;client:&nbsp;192.168.1.2,&nbsp;server:&nbsp;[domain],&lt;br&gt;<br>
request:&nbsp;&quot;GET&nbsp;/&nbsp;HTTP/1.1&quot;,&nbsp;upstream:&nbsp;&quot;fastcgi://&lt;a&nbsp;href=&quot;http://127.0.0.1:9000&quot;&nbsp;target=&quot;_blank&quot;&gt;127.0.0.1:9000&lt;/a&gt;&quot;,&nbsp;host:&lt;br&gt;<br>
&quot;[domain]&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
--&lt;br&gt;<br>
View&nbsp;this&nbsp;message&nbsp;in&nbsp;context:&nbsp;&lt;a&nbsp;href=&quot;http://mono.1490590.n4.nabble.com/CentOS-Mono-nginx-tp4659199p4659204.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mono.1490590.n4.nabble.com/CentOS-Mono-nginx-tp4659199p4659204.html&lt;/a&gt;&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;Sent&nbsp;from&nbsp;the&nbsp;Mono&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;http://ASP.NET&quot;&nbsp;target=&quot;_blank&quot;&gt;ASP.NET&lt;/a&gt;&nbsp;mailing&nbsp;list&nbsp;archive&nbsp;at&nbsp;Nabble.com.&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-aspnet-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-aspnet-list@lists.ximian.com&quot;&gt;Mono-aspnet-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-aspnet-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-aspnet-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
