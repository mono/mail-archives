<tt>
&lt;html&gt;<br>
&lt;body&gt;<br>
Hi,&lt;br&gt;&lt;br&gt;<br>
I&nbsp;tried&nbsp;your&nbsp;patch&nbsp;adding&nbsp;some&nbsp;other&nbsp;message&nbsp;and&nbsp;I&nbsp;found&nbsp;that&nbsp;the&nbsp;problem<br>
is&nbsp;inside&nbsp;private_file_needs_copying&nbsp;where&nbsp;there's&nbsp;a&nbsp;check&nbsp;on&nbsp;field<br>
st_mode&nbsp;of&nbsp;stat&nbsp;structure.&lt;br&gt;<br>
The&nbsp;problem&nbsp;is&nbsp;that&nbsp;in&nbsp;my&nbsp;installation&nbsp;the&nbsp;source&nbsp;file&nbsp;have&nbsp;not&nbsp;the&nbsp;same<br>
access&nbsp;rights&nbsp;of&nbsp;the&nbsp;shadow&nbsp;copy&nbsp;so&nbsp;mono&nbsp;copies&nbsp;the&nbsp;files&nbsp;everytime.&lt;br&gt;<br>
I&nbsp;can&nbsp;change&nbsp;access&nbsp;rights&nbsp;to&nbsp;source&nbsp;files&nbsp;but&nbsp;I&nbsp;think&nbsp;it's&nbsp;wrong&nbsp;to<br>
check&nbsp;the&nbsp;access&nbsp;mode&nbsp;because&nbsp;it's&nbsp;not&nbsp;a&nbsp;value&nbsp;that&nbsp;helps&nbsp;to&nbsp;understand<br>
if&nbsp;a&nbsp;file&nbsp;is&nbsp;up-to-date,&nbsp;size&nbsp;and&nbsp;mtime&nbsp;should&nbsp;be&nbsp;enough.&nbsp;Do&nbsp;you<br>
agree?&lt;br&gt;<br>
Another&nbsp;thing.&nbsp;I&nbsp;saw&nbsp;on&nbsp;the&nbsp;same&nbsp;function&nbsp;that&nbsp;at&nbsp;the&nbsp;first&nbsp;run&nbsp;after<br>
apache&nbsp;restart&nbsp;mono&nbsp;doesn't&nbsp;find&nbsp;the&nbsp;assembly&nbsp;in&nbsp;cache&nbsp;directoryì&nbsp;and&nbsp;it<br>
makes&nbsp;a&nbsp;copy.&nbsp;&lt;br&gt;<br>
This&nbsp;is&nbsp;because&nbsp;every&nbsp;time&nbsp;the&nbsp;service&nbsp;is&nbsp;stopped&nbsp;the&nbsp;user-temp-aspnet<br>
directory&nbsp;is&nbsp;cleaned.&nbsp;But&nbsp;in&nbsp;this&nbsp;way&nbsp;everytime&nbsp;we&nbsp;restart&nbsp;apache&nbsp;we&nbsp;need<br>
to&nbsp;wait&nbsp;the&nbsp;same&nbsp;loading&nbsp;time&nbsp;of&nbsp;the&nbsp;first&nbsp;time&nbsp;after&nbsp;site&nbsp;installation.<br>
Temporary&nbsp;files&nbsp;could&nbsp;be&nbsp;kept&nbsp;in&nbsp;cache&nbsp;directory&nbsp;in&nbsp;order&nbsp;to&nbsp;avoid<br>
reloading,&nbsp;this&nbsp;should&nbsp;dramatically&nbsp;increase&nbsp;mono&nbsp;asp.net&nbsp;loading<br>
time.&lt;br&gt;<br>
I&nbsp;think&nbsp;MS.NET&nbsp;act&nbsp;like&nbsp;this&nbsp;cause&nbsp;the&nbsp;second&nbsp;run&nbsp;after&nbsp;site&nbsp;installation<br>
is&nbsp;quicker&nbsp;than&nbsp;the&nbsp;first,&nbsp;in&nbsp;mono&nbsp;is&nbsp;everytime&nbsp;equal.&lt;br&gt;&lt;br&gt;<br>
As&nbsp;for&nbsp;private_file_needs_copying&nbsp;I&nbsp;think&nbsp;it&nbsp;could&nbsp;be&nbsp;modified&nbsp;like&nbsp;this,<br>
hope&nbsp;this&nbsp;helps:&lt;br&gt;&lt;br&gt;<br>
&lt;tt&gt;static&nbsp;gboolean&lt;br&gt;<br>
private_file_needs_copying&nbsp;(const&nbsp;char&nbsp;*src,&nbsp;struct&nbsp;stat&nbsp;*sbuf_src,&nbsp;char<br>
*dest)&lt;br&gt;<br>
{&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;struct<br>
stat&nbsp;sbuf_dest;&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;if&nbsp;(stat<br>
(src,&nbsp;sbuf_src)&nbsp;==&nbsp;-1&nbsp;||&nbsp;stat&nbsp;(dest,&nbsp;&amp;amp;sbuf_dest)&nbsp;==&nbsp;-1)&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;return&nbsp;TRUE;&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;if<br>
(sbuf_src-&amp;gt;st_size&nbsp;==&nbsp;sbuf_dest.st_size&nbsp;&amp;amp;&amp;amp;&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sbuf_src-&amp;gt;st_mtime&nbsp;==&nbsp;sbuf_dest.st_mtime)&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;return<br>
FALSE;&lt;br&gt;<br>
&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;return<br>
TRUE;&lt;br&gt;<br>
}&lt;br&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/tt&gt;At&nbsp;13.30&nbsp;02/10/2009,&nbsp;Robert&nbsp;Jordan&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;type=cite&nbsp;class=cite&nbsp;cite=&quot;&quot;&gt;Hi,&lt;br&gt;&lt;br&gt;<br>
APS&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;type=cite&nbsp;class=cite&nbsp;cite=&quot;&quot;&gt;and&nbsp;so&nbsp;on,&nbsp;for&nbsp;the&nbsp;thousands&nbsp;of<br>
files&nbsp;placed&nbsp;inside&nbsp;the&nbsp;bin&nbsp;directory.&lt;br&gt;<br>
It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;there's&nbsp;some&nbsp;problem&nbsp;cause&nbsp;all&nbsp;the&nbsp;files&nbsp;seems<br>
missing&nbsp;even&nbsp;if&nbsp;they&nbsp;are&nbsp;there&nbsp;and&nbsp;it&nbsp;always&nbsp;redo&nbsp;the&nbsp;copying.&lt;br&gt;<br>
Most&nbsp;of&nbsp;the&nbsp;loading&nbsp;time&nbsp;is&nbsp;spent&nbsp;in&nbsp;this&nbsp;multiple&nbsp;shadow&nbsp;copying,&nbsp;as&nbsp;I<br>
have&nbsp;many&nbsp;assemblies&nbsp;inside&nbsp;bin&nbsp;directory&nbsp;this&nbsp;cause&nbsp;an&nbsp;heavy&nbsp;disk&nbsp;usage<br>
and&nbsp;many&nbsp;minutes&nbsp;of&nbsp;wait.&lt;/blockquote&gt;&lt;br&gt;<br>
The&nbsp;log&nbsp;message&nbsp;might&nbsp;be&nbsp;misleading:&nbsp;it&nbsp;is&nbsp;even&nbsp;emitted&nbsp;when&lt;br&gt;<br>
the&nbsp;assembly&nbsp;was&nbsp;not&nbsp;actually&nbsp;shadow-copied&nbsp;due&nbsp;to&nbsp;mtime&lt;br&gt;<br>
equality.&lt;br&gt;&lt;br&gt;<br>
Try&nbsp;the&nbsp;attached&nbsp;patch&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;copy&nbsp;operations&nbsp;are&lt;br&gt;<br>
actually&nbsp;skipped&nbsp;(grep&nbsp;for&nbsp;&amp;quot;up-to-date&amp;quot;&nbsp;in&nbsp;your&nbsp;logs).&lt;br&gt;&lt;br&gt;<br>
Robert&lt;br&gt;&lt;br&gt;<br>
--&nbsp;&lt;br&gt;<br>
Il&nbsp;messaggio&nbsp;e'&nbsp;stato&nbsp;analizzato&nbsp;alla&nbsp;ricerca&nbsp;di&nbsp;virus&nbsp;o&lt;br&gt;<br>
contenuti&nbsp;pericolosi&nbsp;da&nbsp;MailScanner,&nbsp;ed&nbsp;e'&lt;br&gt;<br>
risultato&nbsp;non&nbsp;infetto.&lt;br&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;<br>
Index:&nbsp;metadata/appdomain.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---<br>
metadata/appdomain.c&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;(revision<br>
142262)&lt;br&gt;<br>
+++<br>
metadata/appdomain.c&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;(working<br>
copy)&lt;br&gt;<br>
@@&nbsp;-1431,8&nbsp;+1431,10&nbsp;@@&lt;br&gt;<br>
&amp;nbsp;&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;<br>
mono_raise_exception&nbsp;(exc);&lt;br&gt;<br>
&amp;nbsp;&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;}&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;br&gt;<br>
&amp;nbsp;&lt;br&gt;<br>
-&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;if<br>
(!private_file_needs_copying&nbsp;(filename,&nbsp;&amp;amp;src_sbuf,&nbsp;shadow))&lt;br&gt;<br>
+&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;if<br>
(!private_file_needs_copying&nbsp;(filename,&nbsp;&amp;amp;src_sbuf,&nbsp;shadow))&nbsp;{&lt;br&gt;<br>
+&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;mono_trace<br>
(G_LOG_LEVEL_INFO,&nbsp;MONO_TRACE_ASSEMBLY,&nbsp;&amp;quot;Shadow&nbsp;copy&nbsp;%s&nbsp;of&nbsp;%s&nbsp;is<br>
up-to-date.\n&amp;quot;,&nbsp;shadow,&nbsp;filename);&lt;br&gt;<br>
&amp;nbsp;&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;&lt;x-tab&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;return&nbsp;(char*)<br>
shadow;&lt;br&gt;<br>
+&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;}&lt;br&gt;<br>
&amp;nbsp;&lt;br&gt;<br>
&amp;nbsp;&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;orig&nbsp;=<br>
g_utf8_to_utf16&nbsp;(filename,&nbsp;strlen&nbsp;(filename),&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&lt;br&gt;<br>
&amp;nbsp;&lt;x-tab&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/x-tab&gt;dest&nbsp;=<br>
g_utf8_to_utf16&nbsp;(shadow,&nbsp;strlen&nbsp;(shadow),&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&lt;br&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-aspnet-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
Mono-aspnet-list@lists.ximian.com&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-aspnet-list&quot;&nbsp;eudora=&quot;autourl&quot;&gt;<br>
http://lists.ximian.com/mailman/listinfo/mono-aspnet-list&lt;/a&gt;&lt;/blockquote&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
