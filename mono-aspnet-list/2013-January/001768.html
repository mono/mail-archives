<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-aspnet-list] WebRequest POST with client certificate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20WebRequest%20POST%20with%20client%20certificate&In-Reply-To=%3C50F34516.5030404%40cervis.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001782.html">
   <LINK REL="Next"  HREF="001769.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-aspnet-list] WebRequest POST with client certificate</H1>
    <B>Stefan Kadow</B> 
    <A HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20WebRequest%20POST%20with%20client%20certificate&In-Reply-To=%3C50F34516.5030404%40cervis.de%3E"
       TITLE="[Mono-aspnet-list] WebRequest POST with client certificate">stefan.kadow at cervis.de
       </A><BR>
    <I>Sun Jan 13 23:36:54 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="001782.html">[Mono-aspnet-list] mvc3 FileCacheProvider Serialize Error	reporting
</A></li>
        <LI>Next message: <A HREF="001769.html">[Mono-aspnet-list] CSS Syntax Highlighting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1768">[ date ]</a>
              <a href="thread.html#1768">[ thread ]</a>
              <a href="subject.html#1768">[ subject ]</a>
              <a href="author.html#1768">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
I have a MVC2 web application running on Debian squeeze with Apache 
2.2.16, OpenSSL 0.9.8 and mono 2.6.7. I want to secure the access with 
SSL client certificates, for identification and authorization.

The client programm running on another machine uses the HttpWebRequest 
class for accessing the server with HTTP methods &quot;GET&quot; and &quot;POST&quot;. On 
windows machines the client program runs fine using .NET 3.5.
On Linux machines the client program runs only with HTTP method &quot;GET&quot;. A 
WebRequest with HTTP method &quot;POST&quot; throws an exception. I tried the 
following code on client machines with Debian squeeze (mono 2.6.7) and 
Debian wheezy (mono 2.10.8).

The following code (HTTP &quot;GET&quot;) runs successful on Windows and Linux:
     HttpWebRequest request = (HttpWebRequest)
         WebRequest.Create(&quot;<A HREF="https://server.net/mvc/contr/action">https://server.net/mvc/contr/action</A>&quot;);

     X509Certificate2Collection certColl =
         new X509Certificate2Collection();
     certColl.Import(&quot;certfile.p12&quot;, &quot;123&quot;,
         X509KeyStorageFlags.Exportable);
     request.ClientCertificates.AddRange(certColl);

     HttpWebResponse response = (HttpWebResponse)request.GetResponse();
     Console.WriteLine(response.StatusDescription);

     Stream responseStream = response.GetResponseStream();
     StreamReader reader = new StreamReader(responseStream);
     Console.WriteLine(reader.ReadToEnd());


The following code (HTTP &quot;POST&quot;) runs successful on Windows, but throws 
an excpection on Linux:
     HttpWebRequest request = (HttpWebRequest)
         WebRequest.Create(&quot;<A HREF="https://server.net/mvc/contr/action">https://server.net/mvc/contr/action</A>&quot;);

     X509Certificate2Collection certColl =
         new X509Certificate2Collection();
     certColl.Import(&quot;certfile.p12&quot;, &quot;123&quot;,
         X509KeyStorageFlags.Exportable);
     request.ClientCertificates.AddRange(certColl);

     string postData = @&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;utf-8\&quot;?&gt;
&lt;message/&gt;&quot;;
     byte[] byteArray = Encoding.UTF8.GetBytes(postData);
     request.Method = &quot;POST&quot;;
     request.ContentType = &quot;text/xml&quot;;
     request.ContentLength = byteArray.Length;
     request.KeepAlive = false;  // needed for POST-requests(?)

     Stream requestStream = request.GetRequestStream();
     requestStream.Write(byteArray, 0, byteArray.Length);  // exception
     requestStream.Close();

     HttpWebResponse response = (HttpWebResponse)request.GetResponse();
     Console.WriteLine(response.StatusDescription);

     Stream responseStream = response.GetResponseStream();
     StreamReader reader = new StreamReader(responseStream);
     Console.WriteLine(reader.ReadToEnd());


The exception thrown is:
System.Net.WebException: Error getting response stream (ReadDone1): 
ReceiveFailure ---&gt; System.IO.IOException: The authentication or 
decryption has failed. ---&gt; Mono.Security.Protocol.Tls.TlsException: The 
authentication or decryption has failed.

Apache error log lists:
[error] Re-negotiation handshake failed: Not accepted by client!?

Apache configuration:
     # mono.security needs old/insecure re-negotiation:
     SSLInsecureRenegotiation on
     &lt;Directory /var/www/bin/mvc&gt;
         SSLVerifyClient require
         SSLVerifyDepth 1
         SSLUserName SSL_CLIENT_S_DN_CN
         SSLOptions +StdEnvVars +ExportCertData +OptRenegotiate
     &lt;/Directory&gt;

The server certificate is signed by GeoTrust, the GeoTrust root 
certificate is installed with certmgr.exe in Trust store. The 
self-signed CA certificate, which signed the client certificates is part 
of the pkcs12-file and additionally installed in Trust store, too.
But, the certificates can not be the problem, because the WebRequests 
with HTTP method GET are running fine on Linux client machines.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001782.html">[Mono-aspnet-list] mvc3 FileCacheProvider Serialize Error	reporting
</A></li>
	<LI>Next message: <A HREF="001769.html">[Mono-aspnet-list] CSS Syntax Highlighting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1768">[ date ]</a>
              <a href="thread.html#1768">[ thread ]</a>
              <a href="subject.html#1768">[ subject ]</a>
              <a href="author.html#1768">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">More information about the Mono-aspnet-list
mailing list</a><br>
</body></html>
