<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-aspnet-list] Very slow website compilation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=%5BMono-aspnet-list%5D%20Very%20slow%20website%20compilation&In-Reply-To=ha4o95%2429t%241%40ger.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000475.html">
   <LINK REL="Next"  HREF="000481.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-aspnet-list] Very slow website compilation</H1>
    <B>APS</B> 
    <A HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=%5BMono-aspnet-list%5D%20Very%20slow%20website%20compilation&In-Reply-To=ha4o95%2429t%241%40ger.gmane.org"
       TITLE="[Mono-aspnet-list] Very slow website compilation">dev.malst at apsystems.it
       </A><BR>
    <I>Mon Oct  5 09:19:37 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000475.html">[Mono-aspnet-list] Very slow website compilation
</A></li>
        <LI>Next message: <A HREF="000481.html">[Mono-aspnet-list] Very slow website compilation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#478">[ date ]</a>
              <a href="thread.html#478">[ thread ]</a>
              <a href="subject.html#478">[ subject ]</a>
              <a href="author.html#478">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I tried your patch adding some other message and 
I found that the problem is inside 
private_file_needs_copying where there's a check 
on field st_mode of stat structure.
The problem is that in my installation the source 
file have not the same access rights of the 
shadow copy so mono copies the files everytime.
I can change access rights to source files but I 
think it's wrong to check the access mode because 
it's not a value that helps to understand if a 
file is up-to-date, size and mtime should be enough. Do you agree?
Another thing. I saw on the same function that at 
the first run after apache restart mono doesn't 
find the assembly in cache directory&#236; and it makes a copy.
This is because every time the service is stopped 
the user-temp-aspnet directory is cleaned. But in 
this way everytime we restart apache we need to 
wait the same loading time of the first time 
after site installation. Temporary files could be 
kept in cache directory in order to avoid 
reloading, this should dramatically increase mono asp.net loading time.
I think MS.NET act like this cause the second run 
after site installation is quicker than the first, in mono is everytime equal.

As for private_file_needs_copying I think it 
could be modified like this, hope this helps:

static gboolean
private_file_needs_copying (const char *src, struct stat *sbuf_src, char *dest)
{
         struct stat sbuf_dest;

         if (stat (src, sbuf_src) == -1 || stat (dest, &amp;sbuf_dest) == -1)
                 return TRUE;
         if (sbuf_src-&gt;st_size == sbuf_dest.st_size &amp;&amp;
             sbuf_src-&gt;st_mtime == sbuf_dest.st_mtime)
                 return FALSE;
         return TRUE;
}


At 13.30 02/10/2009, Robert Jordan wrote:
&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>APS wrote:
</I>&gt;&gt;<i>and so on, for the thousands of files placed inside the bin directory.
</I>&gt;&gt;<i>It seems to me that there's some problem cause 
</I>&gt;&gt;<i>all the files seems missing even if they are 
</I>&gt;&gt;<i>there and it always redo the copying.
</I>&gt;&gt;<i>Most of the loading time is spent in this 
</I>&gt;&gt;<i>multiple shadow copying, as I have many 
</I>&gt;&gt;<i>assemblies inside bin directory this cause an 
</I>&gt;&gt;<i>heavy disk usage and many minutes of wait.
</I>&gt;<i>
</I>&gt;<i>The log message might be misleading: it is even emitted when
</I>&gt;<i>the assembly was not actually shadow-copied due to mtime
</I>&gt;<i>equality.
</I>&gt;<i>
</I>&gt;<i>Try the attached patch to see if the copy operations are
</I>&gt;<i>actually skipped (grep for &quot;up-to-date&quot; in your logs).
</I>&gt;<i>
</I>&gt;<i>Robert
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>Il messaggio e' stato analizzato alla ricerca di virus o
</I>&gt;<i>contenuti pericolosi da MailScanner, ed e'
</I>&gt;<i>risultato non infetto.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Index: metadata/appdomain.c
</I>&gt;<i>===================================================================
</I>&gt;<i>--- metadata/appdomain.c        (revision 142262)
</I>&gt;<i>+++ metadata/appdomain.c        (working copy)
</I>&gt;<i>@@ -1431,8 +1431,10 @@
</I>&gt;<i>                 mono_raise_exception (exc);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>-       if (!private_file_needs_copying (filename, &amp;src_sbuf, shadow))
</I>&gt;<i>+       if (!private_file_needs_copying (filename, &amp;src_sbuf, shadow)) {
</I>&gt;<i>+               mono_trace (G_LOG_LEVEL_INFO, 
</I>&gt;<i>MONO_TRACE_ASSEMBLY, &quot;Shadow copy %s of %s is 
</I>&gt;<i>up-to-date.\n&quot;, shadow, filename);
</I>&gt;<i>                 return (char*) shadow;
</I>&gt;<i>+       }
</I>&gt;<i>
</I>&gt;<i>         orig = g_utf8_to_utf16 (filename, 
</I>&gt;<i> strlen (filename), NULL, NULL, NULL);
</I>&gt;<i>         dest = g_utf8_to_utf16 (shadow, strlen (shadow), NULL, NULL, NULL);
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Mono-aspnet-list mailing list
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">Mono-aspnet-list at lists.ximian.com</A>
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">http://lists.ximian.com/mailman/listinfo/mono-aspnet-list</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-aspnet-list/attachments/20091005/d8bc840f/attachment.html">http://lists.ximian.com/pipermail/mono-aspnet-list/attachments/20091005/d8bc840f/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000475.html">[Mono-aspnet-list] Very slow website compilation
</A></li>
	<LI>Next message: <A HREF="000481.html">[Mono-aspnet-list] Very slow website compilation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#478">[ date ]</a>
              <a href="thread.html#478">[ thread ]</a>
              <a href="subject.html#478">[ subject ]</a>
              <a href="author.html#478">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">More information about the Mono-aspnet-list
mailing list</a><br>
</body></html>
