<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-aspnet-list] How to show dynamic data from npgsql in WebGrid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20How%20to%20show%20dynamic%20data%20from%20npgsql%20in%20WebGrid&In-Reply-To=%3C9E1722676D0F441C8E141F3EE9E3D7BD%40dell2%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002115.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-aspnet-list] How to show dynamic data from npgsql in WebGrid</H1>
    <B>Andrus</B> 
    <A HREF="mailto:mono-aspnet-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-aspnet-list%5D%20How%20to%20show%20dynamic%20data%20from%20npgsql%20in%20WebGrid&In-Reply-To=%3C9E1722676D0F441C8E141F3EE9E3D7BD%40dell2%3E"
       TITLE="[Mono-aspnet-list] How to show dynamic data from npgsql in WebGrid">kobruleht2 at hot.ee
       </A><BR>
    <I>Sat Jul 26 09:30:01 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="002115.html">[Mono-aspnet-list] Monodevelop source code
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In Mono ASP .NET MVC4 application, WebGrid shows npgsql dynamic data last row values in every row.

In Mono code below returns

    ?column?
    B
    B

How to force it to return proper result?

If running in windows under Microsoft .NET it returns proper result:

    ?column?
    A
    B

Controller:

        public ActionResult Test()
        {
            var data = TestData();
            return View(&quot;ReportData&quot;, new ReportDataViewModel(data, &quot;&quot;));
        }

        IEnumerable&lt;dynamic&gt; TestData()
        {
            using (var connection = new NpgsqlConnection(ConnectionString()))
            {
                connection.Open();
                DbCommand command = (DbCommand)connection.CreateCommand();
                command.CommandText = &quot;select 'A' union select 'B'&quot;;
                using (command)
                {
                    IEnumerable&lt;string&gt; columnNames = null;
                    using (DbDataReader reader = command.ExecuteReader())
                    {
                        foreach (DbDataRecord record in reader)
                        {
                            if (columnNames == null)
                                columnNames = GetColumnNames(record);
                            yield return new CustomDynamicRecord(columnNames, record);
                        }
                    }
                }
            }
        }

        static IEnumerable&lt;string&gt; GetColumnNames(DbDataRecord record)
        {
            for (int i = 0; i &lt; record.FieldCount; i++)
            {
                yield return record.GetName(i);
            }
        }

        static string ConnectionString()
        {
            NpgsqlConnectionStringBuilder csb = new NpgsqlConnectionStringBuilder()
            {
                SearchPath = &quot;public&quot;,
                Host = &quot;localhost&quot;,
                Database = &quot;eeva&quot;,
                UserName = &quot;postgres&quot;,
                Password = &quot;secret&quot;
            };
            return csb.ConnectionString;
        }


CustomDynamicRecord class is copied from ASP.NET source code with minor modifications:

    using System;
    using System.Collections.Generic;
    using System.ComponentModel;
    using System.Data;
    using System.Diagnostics;
    using System.Dynamic;
    using System.Globalization;
    using System.Linq;
    using WebMatrix.Data.Resources;

    public sealed class CustomDynamicRecord : DynamicObject, ICustomTypeDescriptor
    {
        public CustomDynamicRecord(IEnumerable&lt;string&gt; columnNames, IDataRecord record)
        {
            Columns = columnNames.ToList();
            Record = record;
        }

        public IList&lt;string&gt; Columns { get; private set; }

        private IDataRecord Record { get; set; }

        public object this[string name]
        {
            get
            {
                return GetValue(Record[name]);
            }
        }

        public object this[int index]
        {
            get
            {
                return GetValue(Record[index]);
            }
        }

        public override bool TryGetMember(GetMemberBinder binder, out object result)
        {
            result = this[binder.Name];
            return true;
        }

        static object GetValue(object value)
        {
            if (DBNull.Value == value || value == null)
              return null;
           return value;
        }

        public override IEnumerable&lt;string&gt; GetDynamicMemberNames()
        {
            return Columns;
        }

        private void VerifyColumn(string name)
        {
            if (!Columns.Contains(name, StringComparer.OrdinalIgnoreCase))
            {
                throw new InvalidOperationException(
                    String.Format(CultureInfo.CurrentCulture,
                                  &quot;Invalid Column Name &quot; + name));
            }
        }

        AttributeCollection ICustomTypeDescriptor.GetAttributes()
        {
            return AttributeCollection.Empty;
        }

        string ICustomTypeDescriptor.GetClassName()
        {
            return null;
        }

        string ICustomTypeDescriptor.GetComponentName()
        {
            return null;
        }

        TypeConverter ICustomTypeDescriptor.GetConverter()
        {
            return null;
        }

        EventDescriptor ICustomTypeDescriptor.GetDefaultEvent()
        {
            return null;
        }

        PropertyDescriptor ICustomTypeDescriptor.GetDefaultProperty()
        {
            return null;
        }

        object ICustomTypeDescriptor.GetEditor(Type editorBaseType)
        {
            return null;
        }

        EventDescriptorCollection ICustomTypeDescriptor.GetEvents(Attribute[] attributes)
        {
            return EventDescriptorCollection.Empty;
        }

        EventDescriptorCollection ICustomTypeDescriptor.GetEvents()
        {
            return EventDescriptorCollection.Empty;
        }

        PropertyDescriptorCollection ICustomTypeDescriptor.GetProperties(Attribute[] attributes)
        {
            return ((ICustomTypeDescriptor)this).GetProperties();
        }

        PropertyDescriptorCollection ICustomTypeDescriptor.GetProperties()
        {
            var properties = from columnName in Columns
                             let columnIndex = Record.GetOrdinal(columnName)
                             let type = Record.GetFieldType(columnIndex)
                             select new DynamicPropertyDescriptor(columnName, type);

            return new PropertyDescriptorCollection(properties.ToArray(), readOnly: true);
        }

        object ICustomTypeDescriptor.GetPropertyOwner(PropertyDescriptor pd)
        {
            return this;
        }

        private class DynamicPropertyDescriptor : PropertyDescriptor
        {
            private static readonly Attribute[] _empty = new Attribute[0];
            private readonly Type _type;

            public DynamicPropertyDescriptor(string name, Type type)
                : base(name, _empty)
            {
                _type = type;
            }

            public override Type ComponentType
            {
                get { return typeof(EevaDynamicRecord); }
            }

            public override bool IsReadOnly
            {
                get { return true; }
            }

            public override Type PropertyType
            {
                get { return _type; }
            }

            public override bool CanResetValue(object component)
            {
                return false;
            }

            public override object GetValue(object component)
            {
                EevaDynamicRecord record = component as EevaDynamicRecord;
                // REVIEW: Should we throw if the wrong object was passed in?
                if (record != null)
                {
                    return record[Name];
                }
                return null;
            }

            public override void ResetValue(object component)
            {
                throw new InvalidOperationException(
                    String.Format(CultureInfo.CurrentCulture,
                                  &quot;DataResources.RecordIsReadOnly&quot;, Name));
            }

            public override void SetValue(object component, object value)
            {
                throw new InvalidOperationException(
                    String.Format(CultureInfo.CurrentCulture,
                                  &quot;DataResources.RecordIsReadOnly&quot;, Name));
            }

            public override bool ShouldSerializeValue(object component)
            {
                return false;
            }
        }
    }


View:

    @inherits ViewBase&lt;ViewModels.ReportDataViewModel&gt;
    @using System.Web.Helpers
    
    @{ Layout = null;
     var gd = new WebGrid(source: Model.Rows, canSort: false , rowsPerPage:100 );
    }
    
    &lt;!DOCTYPE html&gt;
    &lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
      @gd.GetHtml()
    &lt;/body&gt;
    &lt;/html&gt;


Model:

    namespace ViewModels
    {
        public class ReportDataViewModel : ViewModelBase
        {
            public IEnumerable&lt;dynamic&gt; Rows { get; set; }
     
            public ReportDataViewModel(IEnumerable&lt;dynamic&gt; rows)
            {
                Rows = rows;
            }
        }
    }

Posted also in <A HREF="http://stackoverflow.com/questions/24965486/how-to-show-dynamic-data-using-npgsql-in-mono-in-webgrid">http://stackoverflow.com/questions/24965486/how-to-show-dynamic-data-using-npgsql-in-mono-in-webgrid</A>

Andrus.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-aspnet-list/attachments/20140726/7a1abec5/attachment-0001.html">http://lists.ximian.com/pipermail/mono-aspnet-list/attachments/20140726/7a1abec5/attachment-0001.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002115.html">[Mono-aspnet-list] Monodevelop source code
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2116">[ date ]</a>
              <a href="thread.html#2116">[ thread ]</a>
              <a href="subject.html#2116">[ subject ]</a>
              <a href="author.html#2116">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-aspnet-list">More information about the Mono-aspnet-list
mailing list</a><br>
</body></html>
