<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Problem with crypto in assembly wrapped in COM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To=22B92EF8DAABDA48879D5188A70FBEF602CFD441%40kmdex5.intern.kmd.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030624.html">
   <LINK REL="Next"  HREF="030626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Problem with crypto in assembly wrapped in COM</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To=22B92EF8DAABDA48879D5188A70FBEF602CFD441%40kmdex5.intern.kmd.dk"
       TITLE="[Mono-list] Problem with crypto in assembly wrapped in COM">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Wed Feb  8 09:23:37 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="030624.html">[Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
        <LI>Next message: <A HREF="030626.html">[Mono-list] Group- and Decimal-Separator Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30625">[ date ]</a>
              <a href="thread.html#30625">[ thread ]</a>
              <a href="subject.html#30625">[ subject ]</a>
              <a href="author.html#30625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Kim,

On Wed, 2006-02-08 at 13:24 +0100, Hellan.Kim KHE wrote:
&gt;<i> We have an assembly containing crypto functionality (X.509 certificates,
</I>&gt;<i> PKCS#12, PKCS#7...) from Mono.Security.dll. So far it has been running
</I>&gt;<i> fine in both WinForm and Webform environments (.NET 2.0).
</I>&gt;<i> We have had to wrap this assembly in COM to allow it to be run from old
</I>&gt;<i> ASP platforms.
</I>
Nice. As far as I know you're the first to use Mono.Security.dll via
COM. I'm glad it works (even if not completely ;-)

&gt;<i> We now get the following errors when the .NET/COM component is called
</I>&gt;<i> from a webpage:
</I>&gt;<i> 
</I>&gt;<i> Error: exception=System.Security.Cryptography.CryptographicException:
</I>&gt;<i> The system cannot find the file specified.
</I>&gt;<i> 
</I>&gt;<i>    at System.Security.Cryptography.Utils.CreateProvHandle(CspParameters
</I>&gt;<i> parameters, Boolean randomKeyContainer)
</I>&gt;<i>    at
</I>&gt;<i> System.Security.Cryptography.RSACryptoServiceProvider.ImportParameters(R
</I>&gt;<i> SAParameters parameters)
</I>&gt;<i>    at Mono.Security.Cryptography.PKCS8.PrivateKeyInfo.DecodeRSA(Byte[]
</I>&gt;<i> keypair)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.AddPrivateKey(PrivateKeyInfo pki)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.ReadSafeBag(ASN1 safeBag)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.Decode(Byte[] data)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.LoadFromFile(String filename, String
</I>&gt;<i> password)
</I>&gt;<i> ....
</I>&gt;<i> ....
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have a theory what is happening...
</I>&gt;<i> In DecodeRSA() you have the following lines:
</I>&gt;<i> 
</I>&gt;<i> RSA rsa = RSA.Create ();
</I>&gt;<i> rsa.ImportParameters (param);
</I>&gt;<i> 
</I>&gt;<i> I have seen before that ImportParameters() had problems in
</I>&gt;<i> webapplications, because it apparently tries to access some keystores,
</I>&gt;<i> that the IIS user does not have access to. A COM wrapped assembly
</I>&gt;<i> probably have even less rights than a standalone assembly.
</I>&gt;<i> This is the code I used instead in my application to solve the problem:
</I>
Yes. Even if the .NET API makes key containers optional (for importing
or using keyparis), MS implementation is dependent on CryptoAPI, which
is dependent on the key stores, which depends on the current user (and
its permissions).

&gt;<i> CspParameters CSPParam = new CspParameters();
</I>&gt;<i> CSPParam.Flags = CspProviderFlags.UseMachineKeyStore;
</I>&gt;<i> RSACryptoServiceProvider rsa;
</I>&gt;<i> if(System.Web.HttpContext.Current == null)	// WinForm
</I>&gt;<i>   rsa = new RSACryptoServiceProvider();
</I>&gt;<i> else			// WebForm - Uses Machine store for keys
</I>&gt;<i>   rsa = new RSACryptoServiceProvider(CSPParam);
</I>&gt;<i> rsa.ImportParameters(rsaParam);
</I>
This will work for your own code. However Mono can't adopt this as this
would make Mono.Security.dll depends on System.Web (and create more
circular dependencies on Mono).

&gt;<i> Has anyone else had this problem and do you have a solution for it?
</I>
This is a well known problem (on Windows + .NET crypto). IIRC there is a
few knowledge base article on the subject. It is also a common question
on MS newsgroups. 

&gt;<i> Maybe you have to change some security settings in .NET or elsewhere to
</I>&gt;<i> allow this...I don't know.
</I>
Google should find them easily (kb + newsgroups). There may be a &quot;fix&quot;
for this. IIRC there was one .config trick that I think it works only
for WSE stuff... but I may be wrong.

&gt;<i> I'm a bit stuck since I can't control what Mono is doing.
</I>
Please do look at Google and see if and how this can be fixed. It would
be nice to report the finding on this mailing-list (i.e. giving Google
another chance to index the answer ;-).

If a fix isn't possible then I think I could change Mono.Security's
source code to trap the first ImportParameters for a
CryptographicException, then re-try the ImportParameters using the
UseMachineKeyStore (as a second/last chance).
-- 
Sebastien Pouliot  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">sebastien at ximian.com</A>&gt;
Blog: <A HREF="http://pages.infinit.net/ctech/">http://pages.infinit.net/ctech/</A>

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030624.html">[Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
	<LI>Next message: <A HREF="030626.html">[Mono-list] Group- and Decimal-Separator Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30625">[ date ]</a>
              <a href="thread.html#30625">[ thread ]</a>
              <a href="subject.html#30625">[ subject ]</a>
              <a href="author.html#30625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
