<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Problem with crypto in assembly wrapped in COM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030623.html">
   <LINK REL="Next"  HREF="030625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Problem with crypto in assembly wrapped in COM</H1>
    <B>Hellan.Kim KHE</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To="
       TITLE="[Mono-list] Problem with crypto in assembly wrapped in COM">KHE at kmd.dk
       </A><BR>
    <I>Wed Feb  8 07:24:04 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="030623.html">[Mono-list] :WOMB: 0.1.0 release (testing)
</A></li>
        <LI>Next message: <A HREF="030625.html">[Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30624">[ date ]</a>
              <a href="thread.html#30624">[ thread ]</a>
              <a href="subject.html#30624">[ subject ]</a>
              <a href="author.html#30624">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We have an assembly containing crypto functionality (X.509 certificates,
PKCS#12, PKCS#7...) from Mono.Security.dll. So far it has been running
fine in both WinForm and Webform environments (.NET 2.0).
We have had to wrap this assembly in COM to allow it to be run from old
ASP platforms.
We now get the following errors when the .NET/COM component is called
from a webpage:

Error: exception=System.Security.Cryptography.CryptographicException:
The system cannot find the file specified.

   at System.Security.Cryptography.Utils.CreateProvHandle(CspParameters
parameters, Boolean randomKeyContainer)
   at
System.Security.Cryptography.RSACryptoServiceProvider.ImportParameters(R
SAParameters parameters)
   at Mono.Security.Cryptography.PKCS8.PrivateKeyInfo.DecodeRSA(Byte[]
keypair)
   at Mono.Security.X509.PKCS12.AddPrivateKey(PrivateKeyInfo pki)
   at Mono.Security.X509.PKCS12.ReadSafeBag(ASN1 safeBag)
   at Mono.Security.X509.PKCS12.Decode(Byte[] data)
   at Mono.Security.X509.PKCS12.LoadFromFile(String filename, String
password)
....
....


I have a theory what is happening...
In DecodeRSA() you have the following lines:

RSA rsa = RSA.Create ();
rsa.ImportParameters (param);

I have seen before that ImportParameters() had problems in
webapplications, because it apparently tries to access some keystores,
that the IIS user does not have access to. A COM wrapped assembly
probably have even less rights than a standalone assembly.
This is the code I used instead in my application to solve the problem:

CspParameters CSPParam = new CspParameters();
CSPParam.Flags = CspProviderFlags.UseMachineKeyStore;
RSACryptoServiceProvider rsa;
if(System.Web.HttpContext.Current == null)	// WinForm
  rsa = new RSACryptoServiceProvider();
else			// WebForm - Uses Machine store for keys
  rsa = new RSACryptoServiceProvider(CSPParam);
rsa.ImportParameters(rsaParam);


Has anyone else had this problem and do you have a solution for it?
Maybe you have to change some security settings in .NET or elsewhere to
allow this...I don't know.
I'm a bit stuck since I can't control what Mono is doing.

Any hints/help appreciated!

Thanks,
Kim




_______________________________________________________________________________________
www.kmd.dk   www.kundenet.kmd.dk   www.eboks.dk   www.civitas.dk   www.netborger.dk www.organisator.dk

Hvis du har modtaget denne mail ved en fejl vil jeg gerne, at du informerer mig og sletter den.
KMD skaber it-services, der fremmer effektivitet hos det offentlige, erhvervslivet og borgerne.

If you received this e-mail by mistake, please notify me and delete it. Thank you.
Our mission is to enhance the efficiency of the public sector and improve its service of the general public. 

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030623.html">[Mono-list] :WOMB: 0.1.0 release (testing)
</A></li>
	<LI>Next message: <A HREF="030625.html">[Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30624">[ date ]</a>
              <a href="thread.html#30624">[ thread ]</a>
              <a href="subject.html#30624">[ subject ]</a>
              <a href="author.html#30624">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
