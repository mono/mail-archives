<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> SV: [Mono-list] Problem with crypto in assembly wrapped in COM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=SV%3A%20%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030673.html">
   <LINK REL="Next"  HREF="030677.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>SV: [Mono-list] Problem with crypto in assembly wrapped in COM</H1>
    <B>Hellan.Kim KHE</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=SV%3A%20%5BMono-list%5D%20Problem%20with%20crypto%20in%20assembly%20wrapped%20in%20COM&In-Reply-To="
       TITLE="SV: [Mono-list] Problem with crypto in assembly wrapped in COM">KHE at kmd.dk
       </A><BR>
    <I>Tue Feb 14 04:44:46 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="030673.html">[Mono-list] compile java code with monodevelop
</A></li>
        <LI>Next message: <A HREF="030677.html">SV: [Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30676">[ date ]</a>
              <a href="thread.html#30676">[ thread ]</a>
              <a href="subject.html#30676">[ subject ]</a>
              <a href="author.html#30676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again

We have been investigating this some more. Apparently the problem is &quot;working as intended&quot;. Why it is so, is described here:
<A HREF="http://support.microsoft.com/default.aspx?scid=KB;EN-US;322371">http://support.microsoft.com/default.aspx?scid=KB;EN-US;322371</A>

The solution is, instead of using:
  RSA rsa = RSA.Create();
use this:
  CspParameters CSPParam = new CspParameters();
  CSPParam.Flags = CspProviderFlags.UseMachineKeyStore;
  RSACryptoServiceProvider rsa = new RSACryptoServiceProvider(CSPParam);
or maybe this:
  RSACryptoServiceProvider rsa = new RSACryptoServiceProvider();
  rsa.UseMachineKeyStore = true;

I don't think there is any way around this, other than to fix the Mono code as you (Sebastien) suggested.
Fortunately I think it is only in a few files that you do the RSA.Create(), and call ImportParameters() afterwards.

If you decide to make the fix, we would be happy to test it with our COM wrapped assembly immediately.
If you want a bugzilla report to initiate it, let me know and I will make one.

Thanks,
Kim


-----Oprindelig meddelelse-----
Fra: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A>] P&#229; vegne af Hellan.Kim KHE
Sendt: 10. februar 2006 09:35
Til: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">sebastien.pouliot at gmail.com</A>
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list at lists.ximian.com</A>
Emne: SV: [Mono-list] Problem with crypto in assembly wrapped in COM

Hi Sebastien,

Thank you for answering.
I didn't mean that Mono should adapt our code, it was just to show
something that worked for us.
We will try to see if we can find a solution for this problem.
I'll let you know what we find.

/Kim

-----Oprindelig meddelelse-----
Fra: Sebastien Pouliot [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">sebastien.pouliot at gmail.com</A>] 
Sendt: 8. februar 2006 15:24
Til: Hellan.Kim KHE
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list at lists.ximian.com</A>
Emne: Re: [Mono-list] Problem with crypto in assembly wrapped in COM

Hello Kim,

On Wed, 2006-02-08 at 13:24 +0100, Hellan.Kim KHE wrote:
&gt;<i> We have an assembly containing crypto functionality (X.509
</I>certificates,
&gt;<i> PKCS#12, PKCS#7...) from Mono.Security.dll. So far it has been running
</I>&gt;<i> fine in both WinForm and Webform environments (.NET 2.0).
</I>&gt;<i> We have had to wrap this assembly in COM to allow it to be run from
</I>old
&gt;<i> ASP platforms.
</I>
Nice. As far as I know you're the first to use Mono.Security.dll via
COM. I'm glad it works (even if not completely ;-)

&gt;<i> We now get the following errors when the .NET/COM component is called
</I>&gt;<i> from a webpage:
</I>&gt;<i> 
</I>&gt;<i> Error: exception=System.Security.Cryptography.CryptographicException:
</I>&gt;<i> The system cannot find the file specified.
</I>&gt;<i> 
</I>&gt;<i>    at
</I>System.Security.Cryptography.Utils.CreateProvHandle(CspParameters
&gt;<i> parameters, Boolean randomKeyContainer)
</I>&gt;<i>    at
</I>&gt;<i>
</I>System.Security.Cryptography.RSACryptoServiceProvider.ImportParameters(R
&gt;<i> SAParameters parameters)
</I>&gt;<i>    at Mono.Security.Cryptography.PKCS8.PrivateKeyInfo.DecodeRSA(Byte[]
</I>&gt;<i> keypair)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.AddPrivateKey(PrivateKeyInfo pki)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.ReadSafeBag(ASN1 safeBag)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.Decode(Byte[] data)
</I>&gt;<i>    at Mono.Security.X509.PKCS12.LoadFromFile(String filename, String
</I>&gt;<i> password)
</I>&gt;<i> ....
</I>&gt;<i> ....
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have a theory what is happening...
</I>&gt;<i> In DecodeRSA() you have the following lines:
</I>&gt;<i> 
</I>&gt;<i> RSA rsa = RSA.Create ();
</I>&gt;<i> rsa.ImportParameters (param);
</I>&gt;<i> 
</I>&gt;<i> I have seen before that ImportParameters() had problems in
</I>&gt;<i> webapplications, because it apparently tries to access some keystores,
</I>&gt;<i> that the IIS user does not have access to. A COM wrapped assembly
</I>&gt;<i> probably have even less rights than a standalone assembly.
</I>&gt;<i> This is the code I used instead in my application to solve the
</I>problem:

Yes. Even if the .NET API makes key containers optional (for importing
or using keyparis), MS implementation is dependent on CryptoAPI, which
is dependent on the key stores, which depends on the current user (and
its permissions).

&gt;<i> CspParameters CSPParam = new CspParameters();
</I>&gt;<i> CSPParam.Flags = CspProviderFlags.UseMachineKeyStore;
</I>&gt;<i> RSACryptoServiceProvider rsa;
</I>&gt;<i> if(System.Web.HttpContext.Current == null)	// WinForm
</I>&gt;<i>   rsa = new RSACryptoServiceProvider();
</I>&gt;<i> else			// WebForm - Uses Machine store for keys
</I>&gt;<i>   rsa = new RSACryptoServiceProvider(CSPParam);
</I>&gt;<i> rsa.ImportParameters(rsaParam);
</I>
This will work for your own code. However Mono can't adopt this as this
would make Mono.Security.dll depends on System.Web (and create more
circular dependencies on Mono).

&gt;<i> Has anyone else had this problem and do you have a solution for it?
</I>
This is a well known problem (on Windows + .NET crypto). IIRC there is a
few knowledge base article on the subject. It is also a common question
on MS newsgroups. 

&gt;<i> Maybe you have to change some security settings in .NET or elsewhere
</I>to
&gt;<i> allow this...I don't know.
</I>
Google should find them easily (kb + newsgroups). There may be a &quot;fix&quot;
for this. IIRC there was one .config trick that I think it works only
for WSE stuff... but I may be wrong.

&gt;<i> I'm a bit stuck since I can't control what Mono is doing.
</I>
Please do look at Google and see if and how this can be fixed. It would
be nice to report the finding on this mailing-list (i.e. giving Google
another chance to index the answer ;-).

If a fix isn't possible then I think I could change Mono.Security's
source code to trap the first ImportParameters for a
CryptographicException, then re-try the ImportParameters using the
UseMachineKeyStore (as a second/last chance).
-- 
Sebastien Pouliot  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">sebastien at ximian.com</A>&gt;
Blog: <A HREF="http://pages.infinit.net/ctech/">http://pages.infinit.net/ctech/</A>





_______________________________________________________________________________________
www.kmd.dk   www.kundenet.kmd.dk   www.eboks.dk   www.civitas.dk   www.netborger.dk www.organisator.dk

Hvis du har modtaget denne mail ved en fejl vil jeg gerne, at du informerer mig og sletter den.
KMD skaber it-services, der fremmer effektivitet hos det offentlige, erhvervslivet og borgerne.

If you received this e-mail by mistake, please notify me and delete it. Thank you.
Our mission is to enhance the efficiency of the public sector and improve its service of the general public. 

_______________________________________________
Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>




_______________________________________________________________________________________
www.kmd.dk   www.kundenet.kmd.dk   www.eboks.dk   www.civitas.dk   www.netborger.dk www.organisator.dk

Hvis du har modtaget denne mail ved en fejl vil jeg gerne, at du informerer mig og sletter den.
KMD skaber it-services, der fremmer effektivitet hos det offentlige, erhvervslivet og borgerne.

If you received this e-mail by mistake, please notify me and delete it. Thank you.
Our mission is to enhance the efficiency of the public sector and improve its service of the general public. 





_______________________________________________________________________________________
www.kmd.dk   www.kundenet.kmd.dk   www.eboks.dk   www.civitas.dk   www.netborger.dk www.organisator.dk

Hvis du har modtaget denne mail ved en fejl vil jeg gerne, at du informerer mig og sletter den.
KMD skaber it-services, der fremmer effektivitet hos det offentlige, erhvervslivet og borgerne.

If you received this e-mail by mistake, please notify me and delete it. Thank you.
Our mission is to enhance the efficiency of the public sector and improve its service of the general public. 

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030673.html">[Mono-list] compile java code with monodevelop
</A></li>
	<LI>Next message: <A HREF="030677.html">SV: [Mono-list] Problem with crypto in assembly wrapped in COM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30676">[ date ]</a>
              <a href="thread.html#30676">[ thread ]</a>
              <a href="subject.html#30676">[ subject ]</a>
              <a href="author.html#30676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
