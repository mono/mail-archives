<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] System.TimeZone
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:AjayKumar.Dwivedi%40dresdner-bank.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003162.html">
   <LINK REL="Next"  HREF="003165.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] System.TimeZone
   </H1>
    <B>Dwivedi , Ajay Kumar
    </B> 
    <A HREF="mailto:AjayKumar.Dwivedi%40dresdner-bank.com"
       TITLE="[Mono-list] System.TimeZone">AjayKumar.Dwivedi@dresdner-bank.com
       </A><BR>
    <I>Thu, 14 Feb 2002 14:52:24 -0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="003162.html">[Mono-list] Re: Gda in Mono
</A></li>
        <LI> Next message: <A HREF="003165.html">[Mono-list] System.TimeZone
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3160">[ date ]</a>
              <a href="thread.html#3160">[ thread ]</a>
              <a href="subject.html#3160">[ subject ]</a>
              <a href="author.html#3160">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This message is in MIME format. Since your mail reader does not understand
this format, some or all of this message may not be legible.

------_=_NextPart_000_01C1B567.369A8600
Content-Type: text/plain;
	charset=&quot;iso-8859-1&quot;

Hi all,
	Here are System.TimeZone and System.CurrentTimeZone classes. 
CurrentTimeZone class uses some hardcoded values for Testing purposes.

Regards,
Ajay

&gt;<i> How large is it?
</I>&gt;<i> Send it to the list so ppl can review it.
</I>

------_=_NextPart_000_01C1B567.369A8600
Content-Type: application/octet-stream;
	name=&quot;CurrentTimeZone.cs&quot;
Content-Disposition: attachment;
	filename=&quot;CurrentTimeZone.cs&quot;

//Author : Dwivedi, Ajay kumar
//Email  : <A HREF="mailto:adwiv@yahoo.com">adwiv@yahoo.com</A>
using System.Globalization;
using System.Collections;

namespace System
{
	/// &lt;summary&gt;
	/// This inner class is implementation of timezone for the users machine.
	/// &lt;/summary&gt;
	/// &lt;remarks&gt;This class is returned by CurrentTimeZone Property of System.TimeZone.&lt;/remarks&gt;
	/// &lt;todo&gt; FIXME: What about Thread Synchronization during native calls? &lt;/todo&gt;
	internal class CurrentTimeZone : TimeZone
	{
		/// &lt;summary&gt;
		/// A yearwise cache of DaylightTime. Filled as needed. The current year
		/// is filled by the constuctor.
		/// &lt;/summary&gt;
		private static System.Collections.Hashtable daylightCache = new Hashtable(1);

		/// &lt;summary&gt;
		/// utcOffsetWithOutDLS represents the offset when daylightsaving is not on.
		/// &lt;/summary&gt;
		private static TimeSpan		utcOffsetWithOutDLS;

		/// &lt;summary&gt;
		/// utcOffsetWithDLS represents the offset when daylightsaving is on.
		/// &lt;/summary&gt;
		private static TimeSpan		utcOffsetWithDLS;

		/// &lt;summary&gt;
		/// Daylight Name. Empty if no DaylightSaving.
		/// &lt;/summary&gt;
		private static string		daylightName;
		private static string		standardName;

		internal CurrentTimeZone()
			:base()
		{
			//TODO: call some system method and fill all the fields.
			//Doing Some Hardcoding for Testing purposes
			// /me in Vladivostok? Nah.. Just for DaylightSaving Sake.
			utcOffsetWithOutDLS = new TimeSpan(10,0,0);
			utcOffsetWithDLS = new TimeSpan(11,0,0);
			daylightName = &quot;Vladivostok Daylight Time&quot;;
			standardName = &quot;Vladivostok Standard Time&quot;;
			DaylightTime dlt = new DaylightTime(new DateTime(2002,3,31,2,0,0),
				new DateTime(2002,10,27,3,0,0),new TimeSpan(1,0,0));
			daylightCache.Add(2002,dlt);
		}

		public override string DaylightName
		{
			get
			{
				return daylightName;
			}
		}
		
		public override string StandardName 
		{
			get 
			{
				return standardName;
			}
		}
		
		public override DaylightTime GetDaylightChanges(int year)
		{
			if(year &lt; 1 || year &gt; 9999)
				throw new ArgumentOutOfRangeException(&quot;year&quot;,year,&quot;Range must be between 1 and 9999&quot;);

			if(daylightCache[year]==null)
			{
				//TODO: do something and put the DaylightTime corresponding to the time in cache.
				DaylightTime dlt = new DaylightTime(new DateTime(0),
					new DateTime(0),new TimeSpan(0));
				daylightCache.Add(year,dlt);
			}
			return (DaylightTime) daylightCache[year];
		}

		public override TimeSpan GetUtcOffset(DateTime time)
		{
			if(IsDaylightSavingTime(time))
			{
				return utcOffsetWithDLS;
			}
			return utcOffsetWithOutDLS;
		}
	}
}
------_=_NextPart_000_01C1B567.369A8600
Content-Type: application/octet-stream;
	name=&quot;TimeZone.cs&quot;
Content-Disposition: attachment;
	filename=&quot;TimeZone.cs&quot;

//Author : Dwivedi, Ajay kumar
//Email  : <A HREF="mailto:adwiv@yahoo.com">adwiv@yahoo.com</A>
using System.Globalization;

namespace System
{
	/// &lt;summary&gt;
	/// Summary description for TimeZone.
	/// &lt;/summary&gt;
	public abstract class TimeZone
	{
		/// &lt;summary&gt;
		/// This field stores the current TimeZone;
		/// &lt;/summary&gt;
		private static TimeZone currentTimeZone;

		/// &lt;summary&gt;
		/// Initializes a new instance of the TimeZone class.
		/// &lt;/summary&gt;
		/// &lt;remarks&gt;Does nothing&lt;/remarks&gt;
		protected TimeZone()
		{}

		public abstract string DaylightName {get;}
		public abstract string StandardName {get;}
		public abstract DaylightTime GetDaylightChanges(int year);
		public abstract TimeSpan GetUtcOffset(DateTime time);

		/// &lt;summary&gt;
		/// Returns the TimeZone Class for the Systems TimeZone
		/// &lt;/summary&gt;
		public static TimeZone CurrentTimeZone
		{
			get
			{ 
				//FIXME: What is the probability that local timezone may change
				if(currentTimeZone == null)
				{
					currentTimeZone = new CurrentTimeZone();
				}
				return currentTimeZone;
			}
		}

		/// &lt;summary&gt;
		/// Returns a value indicating whether the specified date and time is 
		/// within the daylight saving time periods associated with that date.
		/// &lt;/summary&gt;
		public static bool IsDaylightSavingTime(DateTime time,DaylightTime daylightTimes)
		{
			//FIXME: Are these start and End inclusive in the DaylightSaving?
			//		 Who cares.. Its just a 0.1 microsecond.

			if(daylightTimes == null)
				throw new ArgumentNullException(&quot;daylightTimes&quot;);

			// If Start==End, as in the case of No daylight saving
			if(daylightTimes.Start.Ticks == daylightTimes.End.Ticks)
			{
				return false;
			}
			else if(daylightTimes.Start.Ticks &lt; daylightTimes.End.Ticks)
			{	//We are in northern hemisphere.
				// If time lies between Start and End, daylight saving is on
				if(daylightTimes.Start.Ticks &lt; time.Ticks &amp;&amp; daylightTimes.End.Ticks &gt; time.Ticks)
					return true;
			}
			else if(daylightTimes.Start.Ticks &gt; daylightTimes.End.Ticks) // if is Redundant here
			{	// We are in southern hemisphere.
				// If years are same, and If time is less than End OR 
				// more than Start daylight saving is on
				if(time.Year == daylightTimes.Start.Year &amp;&amp; time.Year == daylightTimes.End.Year)
				{
					if( time.Ticks &lt; daylightTimes.End.Ticks ||  time.Ticks &gt; daylightTimes.Start.Ticks)
						return true;
				}
			}

			return false;
		}
		
		/// &lt;summary&gt;
		/// Returns a value indicating whether the specified date and time is 
		/// within the daylight saving time periods associated with that date.
		/// &lt;/summary&gt;
		public virtual bool IsDaylightSavingTime(DateTime time)
		{
			return IsDaylightSavingTime(time, GetDaylightChanges(time.Year));
		}

		/// &lt;summary&gt;
		/// Returns the local time that corresponds to a specified coordinated universal time (UTC).
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;time&quot;&gt;A DateTime instance that specifies the UTC time.&lt;/param&gt;
		/// &lt;returns&gt;A DateTime instance whose value is the local time that corresponds to time.&lt;/returns&gt;
		public virtual DateTime ToLocalTime(DateTime time)
		{
			return new DateTime (time.Ticks + GetUtcOffset(time).Ticks);
		}

		/// &lt;summary&gt;
		/// Returns the Universal time that corresponds to a specified local time (UTC).
		/// &lt;/summary&gt;
		/// &lt;param name=&quot;time&quot;&gt;A DateTime instance that specifies the local time.&lt;/param&gt;
		/// &lt;returns&gt;A DateTime instance whose value is the UTC time that corresponds to time.&lt;/returns&gt;
		public virtual DateTime ToUniversalTime(DateTime time)
		{
			return new DateTime(time.Ticks - GetUtcOffset(time).Ticks);
		}
	}
}
------_=_NextPart_000_01C1B567.369A8600--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003162.html">[Mono-list] Re: Gda in Mono
</A></li>
	<LI> Next message: <A HREF="003165.html">[Mono-list] System.TimeZone
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3160">[ date ]</a>
              <a href="thread.html#3160">[ thread ]</a>
              <a href="subject.html#3160">[ subject ]</a>
              <a href="author.html#3160">[ author ]</a>
         </LI>
       </UL>
</body></html>
