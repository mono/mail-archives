<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] the System.String rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003405.html">
   <LINK REL="Next"  HREF="003407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] the System.String rewrite
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] the System.String rewrite">lupus@ximian.com
       </A><BR>
    <I>Fri, 22 Feb 2002 20:13:08 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="003405.html">[Mono-list] Mint does not interpret Threading Code
</A></li>
        <LI> Next message: <A HREF="003407.html">[Mono-list] the System.String rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3406">[ date ]</a>
              <a href="thread.html#3406">[ thread ]</a>
              <a href="subject.html#3406">[ subject ]</a>
              <a href="author.html#3406">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Anyone with lots of spare cycles? Read on.

Basically, a string needs to be represented as a contiguus chunk of
memory (at the time I proposed this it was for performance/memory usage
reasons, but it turns out that this is required by the implementation).

The current String.cs code has done his duty, but it's time to replace
it. It basically needs to go through the same set of changes that I did 
for the array representation a few months ago. I haven't tackled the
work for string, because its a big task and, after patching it here and 
there, the current code somewhat works.

So, here is how a string appears now (as a C structure):

	struct MonoString {
		MonoObject obj;
		int length;
		MonoArray *c_str;
	};

MonoArray is:
	struct MonoArray {
		MonoObject obj;
		int length;
		double data [0];
	}

Note the size of the data array: since arrays are fixed sized, when we
allocate the object, we also reserve room for length items in the array
(the type double is used only for alignment reasons).

The string representation needs to become something like:

	struct MonoString {
		MonoObject obj;
		int length;
		guint16 chars [0];
	};

This works just as well as for arrays: we allocate the object in one
chunk (note that strings are immutable, hence fixed size as well).

This also means that the char array is not directly accessible from C#
and as such, most of String.cs is useless :-(. We need to design the
interface and have the C# code do argument checking and then call an
internalcall in the runtime that will do all the work.
Some code will need to change in the runtime as well, but mostly in
metadata/object.c.

As you see, it's a big task, I think at least a full week of work,
but someone will have to do it ;-) The advantage will be: higher speed,
lower memory usage an eternal glory! (uhm, maybe not:-).
So, any help with this is appreciated!

Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003405.html">[Mono-list] Mint does not interpret Threading Code
</A></li>
	<LI> Next message: <A HREF="003407.html">[Mono-list] the System.String rewrite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3406">[ date ]</a>
              <a href="thread.html#3406">[ thread ]</a>
              <a href="subject.html#3406">[ subject ]</a>
              <a href="author.html#3406">[ author ]</a>
         </LI>
       </UL>
</body></html>
