<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] the System.String rewrite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:joe%40fatnsoft.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003406.html">
   <LINK REL="Next"  HREF="003421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] the System.String rewrite
   </H1>
    <B>Joe Tennies
    </B> 
    <A HREF="mailto:joe%40fatnsoft.com"
       TITLE="[Mono-list] the System.String rewrite">joe@fatnsoft.com
       </A><BR>
    <I>22 Feb 2002 14:42:55 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="003406.html">[Mono-list] the System.String rewrite
</A></li>
        <LI> Next message: <A HREF="003421.html">[Mono-list] Status of Bison port to C#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3407">[ date ]</a>
              <a href="thread.html#3407">[ thread ]</a>
              <a href="subject.html#3407">[ subject ]</a>
              <a href="author.html#3407">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'd take this if it's still available in a week.  I'm a little busy
between now and then.

If someone wants to work on this, go right ahead and take it.  There's
plenty to go around ;)

On Fri, 2002-02-22 at 13:13, Paolo Molaro wrote:
&gt;<i> Anyone with lots of spare cycles? Read on.
</I>&gt;<i> 
</I>&gt;<i> Basically, a string needs to be represented as a contiguus chunk of
</I>&gt;<i> memory (at the time I proposed this it was for performance/memory usage
</I>&gt;<i> reasons, but it turns out that this is required by the implementation).
</I>&gt;<i> 
</I>&gt;<i> The current String.cs code has done his duty, but it's time to replace
</I>&gt;<i> it. It basically needs to go through the same set of changes that I did 
</I>&gt;<i> for the array representation a few months ago. I haven't tackled the
</I>&gt;<i> work for string, because its a big task and, after patching it here and 
</I>&gt;<i> there, the current code somewhat works.
</I>&gt;<i> 
</I>&gt;<i> So, here is how a string appears now (as a C structure):
</I>&gt;<i> 
</I>&gt;<i> 	struct MonoString {
</I>&gt;<i> 		MonoObject obj;
</I>&gt;<i> 		int length;
</I>&gt;<i> 		MonoArray *c_str;
</I>&gt;<i> 	};
</I>&gt;<i> 
</I>&gt;<i> MonoArray is:
</I>&gt;<i> 	struct MonoArray {
</I>&gt;<i> 		MonoObject obj;
</I>&gt;<i> 		int length;
</I>&gt;<i> 		double data [0];
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> Note the size of the data array: since arrays are fixed sized, when we
</I>&gt;<i> allocate the object, we also reserve room for length items in the array
</I>&gt;<i> (the type double is used only for alignment reasons).
</I>&gt;<i> 
</I>&gt;<i> The string representation needs to become something like:
</I>&gt;<i> 
</I>&gt;<i> 	struct MonoString {
</I>&gt;<i> 		MonoObject obj;
</I>&gt;<i> 		int length;
</I>&gt;<i> 		guint16 chars [0];
</I>&gt;<i> 	};
</I>&gt;<i> 
</I>&gt;<i> This works just as well as for arrays: we allocate the object in one
</I>&gt;<i> chunk (note that strings are immutable, hence fixed size as well).
</I>&gt;<i> 
</I>&gt;<i> This also means that the char array is not directly accessible from C#
</I>&gt;<i> and as such, most of String.cs is useless :-(. We need to design the
</I>&gt;<i> interface and have the C# code do argument checking and then call an
</I>&gt;<i> internalcall in the runtime that will do all the work.
</I>&gt;<i> Some code will need to change in the runtime as well, but mostly in
</I>&gt;<i> metadata/object.c.
</I>&gt;<i> 
</I>&gt;<i> As you see, it's a big task, I think at least a full week of work,
</I>&gt;<i> but someone will have to do it ;-) The advantage will be: higher speed,
</I>&gt;<i> lower memory usage an eternal glory! (uhm, maybe not:-).
</I>&gt;<i> So, any help with this is appreciated!
</I>&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> lupus
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> <A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
</I>&gt;<i> <A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> 
</I>




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003406.html">[Mono-list] the System.String rewrite
</A></li>
	<LI> Next message: <A HREF="003421.html">[Mono-list] Status of Bison port to C#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3407">[ date ]</a>
              <a href="thread.html#3407">[ thread ]</a>
              <a href="subject.html#3407">[ subject ]</a>
              <a href="author.html#3407">[ author ]</a>
         </LI>
       </UL>
</body></html>
