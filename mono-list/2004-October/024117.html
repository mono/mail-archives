<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Custom Marshalling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="024116.html">
   <LINK REL="Next"  HREF="024118.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Custom Marshalling
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] Custom Marshalling">jonpryor@vt.edu
       </A><BR>
    <I>Thu, 28 Oct 2004 22:10:28 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="024116.html">[Mono-list] Custom Marshalling
</A></li>
        <LI> Next message: <A HREF="024118.html">AW: AW: AW: [Mono-list] Daily build errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24117">[ date ]</a>
              <a href="thread.html#24117">[ thread ]</a>
              <a href="subject.html#24117">[ subject ]</a>
              <a href="author.html#24117">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You're making this far too difficult on yourself.  See below.

On Thu, 2004-10-28 at 19:57, <A HREF="mailto:Neale.Ferguson@SoftwareAG-USA.com">Neale.Ferguson@SoftwareAG-USA.com</A> wrote:
&gt;<i> I'll attempt to think before I type this time :-)
</I>&gt;<i> 
</I>&gt;<i> I have a a C routine I wish to call that takes the following parameters:
</I>&gt;<i> 
</I>&gt;<i> typedef struct XXXCB {
</I>&gt;<i>     short a;
</I>&gt;<i>     char  b[2];
</I>&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> void scumbag(XXXCB *cb, char *v);
</I>
&lt;snip/&gt;

&gt;<i> In C# I'd code XXXCB as:
</I>&gt;<i> 
</I>&gt;<i> public struct XXXCB {
</I>&gt;<i> 	public short a;
</I>&gt;<i> 	[MarshalAS(UnmanagedType.ByValArray, SizeConst=2)}
</I>&gt;<i> 	public byte[] b;
</I>&gt;<i> }
</I>
Good declaration.

&gt;<i> Now, because the variable &quot;v&quot; can be a different length of each call
</I>&gt;<i> (up to 32K is size) I can't use MarshalAs(UnmanagedType.ByValArray) as
</I>&gt;<i> mcs demands that SizeConst= be coded (using SizeParamIndex= doesn't
</I>&gt;<i> work, in fact I don't think it's supported).
</I>
There's a bigger problem: ByValArray doesn't mean what you think it
does.  At least, not entirely.

ByValArray means that it's a contiguous blob of memory, which is why you
used it in your XXXCB structure declaration -- you needed to specify the
size of &quot;b&quot;.  Perfectly natural.

However, it means the *same thing* no matter where it's applied.  So
applied to a method argument, it means &quot;push a blob of data SizeConst
bytes onto the stack&quot;).  This is NOT what C does; C always pushes a
*pointer* to an array onto the stack.  Compare these two (C-like)
declarations:

	// ByValArray equivalent
	void scumbag (XXXCB *cb, struct {char data[SOME_LENGTH];} v);

	// LPArray equivalent:
	void scumbag (XXXCB *cb, char *v);

The first one probably isn't valid C, and certainly isn't what you want
when invoking existing C code (but may be useful when dealing with other
languages).

Obviously, you don't want ByValArray for method arguments.  You want
LPArray.  Fortunately, this is the default, and marshals the number of
elements inside the array:

	[DllImport (libname)]
	private static extern void scumbag (ref XXXCB cb, byte[] v);

Usage is straight-forward:

	XXXCB cb = new XXXCB();
	scumbag (ref cb, Encoding.ASCII.GetBytes (&quot;this is my v arg1&quot;));
	scumbag (ref cb, Encoding.ASCII.GetBytes (&quot;this is another v&quot;));

Consequently, you don't need the custom marshaler.

 - Jon



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="024116.html">[Mono-list] Custom Marshalling
</A></li>
	<LI> Next message: <A HREF="024118.html">AW: AW: AW: [Mono-list] Daily build errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24117">[ date ]</a>
              <a href="thread.html#24117">[ thread ]</a>
              <a href="subject.html#24117">[ subject ]</a>
              <a href="author.html#24117">[ author ]</a>
         </LI>
       </UL>
</body></html>
