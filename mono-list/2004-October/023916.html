<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Marshaling data from managed callback to unmanaged code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jfehlig%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="023915.html">
   <LINK REL="Next"  HREF="023917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Marshaling data from managed callback to unmanaged code
   </H1>
    <B>Jim Fehlig
    </B> 
    <A HREF="mailto:jfehlig%40novell.com"
       TITLE="[Mono-list] Marshaling data from managed callback to unmanaged code">jfehlig@novell.com
       </A><BR>
    <I>Wed, 20 Oct 2004 18:43:15 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="023915.html">[Mono-list] New to Mono and back to Linux
</A></li>
        <LI> Next message: <A HREF="023917.html">[Mono-list] XML Web Service, File not found
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23916">[ date ]</a>
              <a href="thread.html#23916">[ thread ]</a>
              <a href="subject.html#23916">[ subject ]</a>
              <a href="author.html#23916">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a MIME message. If you are reading this text, you may want to 
consider changing to a mail reader or gateway that understands how to 
properly handle MIME multipart messages.

--=__Part6B4B5033.0__=
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

I'm having problems marshaling data from a managed callback to the =
calling=20
unmanaged function.  I have read Jonathan Pryor's interop doc at=20
<A HREF="http://www.jprl.com/~jon/interop.html">http://www.jprl.com/~jon/interop.html</A> and found=20
<A HREF="http://lists.ximian.com/archives/public/mono-list/2004-February/018214.html=">http://lists.ximian.com/archives/public/mono-list/2004-February/018214.html=</A>
=20
in the archives but still unable to figure this one out.=20
=20
The code below is a simplified version of what I am trying to accomplish.=
=20
=20
native_cb.c=20
#include &lt;stdio.h&gt;=20
#include &lt;string.h&gt;=20
=20
typedef int (*PasswordCallbackFunc)( char *user, char *password );=20
=20
PasswordCallbackFunc cbFunc =3D NULL;=20
=20
void SetPasswordCallbackFunction( int (*callbackFunc)(char *user, char =
*password) )=20
{=20
cbFunc =3D callbackFunc;=20
}=20
=20
void DoSomething()=20
{=20
   int ccode;=20
   char user[1024];=20
   char passwd[1024];=20
=20
   memset( user, 0, 1024 );=20
   memset( passwd, 0, 1024 );=20
   if ( cbFunc !=3D NULL )=20
   {=20
      ccode =3D cbFunc( user, passwd );=20
      printf( NATIVE: cbFunc called, returned %d\n, ccode );=20
      printf( NATIVE: Results:\n\tUser =3D %s\n\tPasswd =3D %s\n,=20
              user, passwd );=20
   }=20
   else=20
   {=20
      printf( NATIVE: cbFunc is NULL!\n );=20
   }=20
}=20
=20
managed_cb.cs=20
using System;=20
using System.Runtime.InteropServices;=20
=20
public delegate int PassWordCallback( [ MarshalAs(UnmanagedType.ByValTStr, =
SizeConst=3D1024) ]out string user,=20
                                      [ MarshalAs(UnmanagedType.ByValTStr, =
SizeConst=3D1024) ]out string passwd );=20
=20
public class Test=20
{=20
   [ DllImport(native) ]=20
      private static extern void SetPasswordCallbackFunction( PassWordCallb=
ack cb );=20
   [ DllImport(native) ]=20
      private static extern void DoSomething();=20
=20
   private static int MyCallback( [ MarshalAs(UnmanagedType.ByValTStr, =
SizeConst=3D1024) ]out string user,=20
                                  [ MarshalAs(UnmanagedType.ByValTStr, =
SizeConst=3D1024) ]out string passwd )=20
   {=20
      Console.WriteLine( MANAGED: MyCallback called! );=20
      user =3D rufas;=20
      passwd =3D foobar;=20
      return 0;=20
   }=20
=20
   public static void Main()=20
   {=20
      PassWordCallback cb =3D new PassWordCallback( MyCallback );=20
      SetPasswordCallbackFunction( cb );=20
      Console.WriteLine( MANAGED: Registered callback with native library =
- now forcing the library to invoke the callback );=20
      DoSomething();=20
      Console.WriteLine( MANAGED: Done...! );=20
   }=20
}=20
=20
=20
Running this code gives the following results:=20
<A HREF="mailto:jfehlig@jfehlig">jfehlig@jfehlig</A>:~/temp/mono/test_code&gt; mono managed.exe=20
MANAGED: Registered callback with native library - now forcing the library =
to invoke the callback=20
MANAGED: MyCallback called!=20
NATIVE: cbFunc called, returned 0=20
NATIVE: Results:=20
        User =3D h=20
        Passwd =3D =C0=CC=20
MANAGED: Done...!=20
=20
I even tried using the MarshalAs attribute on the managed  MyCallback =
method with no success.=20
I am certainly not the first person to attempt this.  Any suggestions?=20
=20
Thanks.=20
Jim=20


--=__Part6B4B5033.0__=
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

&lt;html&gt;
  &lt;head&gt;
    &lt;style type=3D&quot;text/css&quot;&gt;
      &lt;!--
        body { line-height: normal; margin-bottom: 1px; font-variant: =
normal; margin-left: 4px; margin-top: 4px; margin-right: 4px }
      --&gt;
    &lt;/style&gt;
   =20
  &lt;/head&gt;
  &lt;body&gt;
    &lt;DIV&gt;
      I'm having problems marshaling data from a managed callback to the =
calling
    &lt;/DIV&gt;
    &lt;DIV&gt;
      unmanaged function. &amp;nbsp;I have read Jonathan Pryor's interop doc =
at
    &lt;/DIV&gt;
    &lt;DIV&gt;
      <A HREF="http://www.jprl.com/~jon/interop.html">http://www.jprl.com/~jon/interop.html</A> and found
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &lt;font color=3D&quot;#0000ff&quot;&gt;&lt;a href=3D&quot;<A HREF="http://lists.ximian.com/archives/p=">http://lists.ximian.com/archives/p=</A>
ublic/mono-list/2004-February/018214.html&quot;&gt;&lt;i&gt;&lt;u&gt;<A HREF="http://lists.ximian.com/ar=">http://lists.ximian.com/ar=</A>
chives/public/mono-list/2004-February/018214.html&lt;/u&gt;&lt;/i&gt;&lt;/a&gt;&lt;/font&gt;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      in the archives but still unable to figure this one out.
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      The code below is a simplified version of what I am trying to =
accomplish.
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      native_cb.c
    &lt;/DIV&gt;
    &lt;DIV&gt;
      #include &amp;lt;stdio.h&amp;gt;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      #include &amp;lt;string.h&amp;gt;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      typedef int (*PasswordCallbackFunc)( char *user, char *password );
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      PasswordCallbackFunc cbFunc =3D NULL;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      void SetPasswordCallbackFunction( int (*callbackFunc)(char *user, =
char *password) )
    &lt;/DIV&gt;
    &lt;DIV&gt;
      {
    &lt;/DIV&gt;
    &lt;DIV&gt;
      cbFunc =3D callbackFunc;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      }
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      void DoSomething()
    &lt;/DIV&gt;
    &lt;DIV&gt;
      {
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;int ccode;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;char user[1024];
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;char passwd[1024];
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;memset( user, 0, 1024 );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;memset( passwd, 0, 1024 );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;if ( cbFunc !=3D NULL )
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ccode =3D cbFunc( user, passwd =
);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf( &amp;quot;NATIVE: cbFunc =
called, returned %d\n&amp;quot;, ccode );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf( &amp;quot;NATIVE: Results:\n\=
tUser =3D %s\n\tPasswd =3D %s\n&amp;quot;,
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nb=
sp;&amp;nbsp;&amp;nbsp;user, passwd );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;else
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printf( &amp;quot;NATIVE: cbFunc is =
NULL!\n&amp;quot; );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      }
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      managed_cb.cs
    &lt;/DIV&gt;
    &lt;DIV&gt;
      using System;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      using System.Runtime.InteropServices;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      public delegate int PassWordCallback( [ MarshalAs(UnmanagedType.ByVal=
TStr, SizeConst=3D1024) ]out string user,
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nb=
sp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nb=
sp;&amp;nbsp;[ MarshalAs(UnmanagedType.ByValTStr, SizeConst=3D1024) ]out =
string passwd );
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      public class Test
    &lt;/DIV&gt;
    &lt;DIV&gt;
      {
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[ DllImport(&amp;quot;native&amp;quot;) ]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;private static extern void =
SetPasswordCallbackFunction( PassWordCallback cb );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[ DllImport(&amp;quot;native&amp;quot;) ]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;private static extern void =
DoSomething();
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;private static int MyCallback( [ MarshalAs(Unmanage=
dType.ByValTStr, SizeConst=3D1024) ]out string user,
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nb=
sp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;=
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;[ MarshalAs(Unm=
anagedType.ByValTStr, SizeConst=3D1024) ]out string passwd )
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Console.WriteLine( &amp;quot;MANAGED:=
 MyCallback called!&amp;quot; );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;user =3D &amp;quot;rufas&amp;quot;;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;passwd =3D &amp;quot;foobar&amp;quot;;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return 0;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public static void Main()
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;PassWordCallback cb =3D new =
PassWordCallback( MyCallback );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;SetPasswordCallbackFunction( cb =
);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Console.WriteLine( &amp;quot;MANAGED:=
 Registered callback with native library - now forcing the library to =
invoke the callback&amp;quot; );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;DoSomething();
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Console.WriteLine( &amp;quot;MANAGED:=
 Done...!&amp;quot; );
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      }
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      Running this code gives the following results:
    &lt;/DIV&gt;
    &lt;DIV&gt;
      <A HREF="mailto:jfehlig@jfehlig">jfehlig@jfehlig</A>:~/temp/mono/test_code&amp;gt; mono managed.exe
    &lt;/DIV&gt;
    &lt;DIV&gt;
      MANAGED: Registered callback with native library - now forcing the =
library to invoke the callback
    &lt;/DIV&gt;
    &lt;DIV&gt;
      MANAGED: MyCallback called!
    &lt;/DIV&gt;
    &lt;DIV&gt;
      NATIVE: cbFunc called, returned 0
    &lt;/DIV&gt;
    &lt;DIV&gt;
      NATIVE: Results:
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;User =3D h
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Passwd =3D&amp;nbsp;&amp;#192=
;&amp;#204;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      MANAGED: Done...!
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      I even tried using the MarshalAs attribute on the managed &amp;nbsp;MyCal=
lback method with no success.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      I am certainly not the first person to attempt this. &amp;nbsp;Any =
suggestions?
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      Thanks.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      Jim
    &lt;/DIV&gt;
  &lt;/body&gt;
&lt;/html&gt;

--=__Part6B4B5033.0__=--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="023915.html">[Mono-list] New to Mono and back to Linux
</A></li>
	<LI> Next message: <A HREF="023917.html">[Mono-list] XML Web Service, File not found
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23916">[ date ]</a>
              <a href="thread.html#23916">[ thread ]</a>
              <a href="subject.html#23916">[ subject ]</a>
              <a href="author.html#23916">[ author ]</a>
         </LI>
       </UL>
</body></html>
