<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [vargaz@freemail.hu: [Ikvm-developers] Eclipse under mono]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013943.html">
   <LINK REL="Next"  HREF="013900.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [vargaz@freemail.hu: [Ikvm-developers] Eclipse under mono]
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] [vargaz@freemail.hu: [Ikvm-developers] Eclipse under mono]">lupus@ximian.com
       </A><BR>
    <I>Sat, 10 May 2003 21:42:17 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="013943.html">[Mono-list] Problems compiling monodoc
</A></li>
        <LI> Next message: <A HREF="013900.html">[Mono-list] New Mono 0.24 RPMS  available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13899">[ date ]</a>
              <a href="thread.html#13899">[ thread ]</a>
              <a href="subject.html#13899">[ subject ]</a>
              <a href="author.html#13899">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--gneEPciiIl/aKvOT
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

Master hacker Zoltan did it again: he got eclipse running
with IKVM using the mono runtime.

Cheers!

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better

--gneEPciiIl/aKvOT
Content-Type: message/rfc822
Content-Disposition: inline

Return-Path: &lt;<A HREF="mailto:ikvm-developers-admin@lists.sourceforge.net">ikvm-developers-admin@lists.sourceforge.net</A>&gt;
Delivered-To: <A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>
Received: from sc8-sf-list2.sourceforge.net (lists.sourceforge.net [66.35.250.206])
	by skeptopotamus.ximian.com (Postfix) with ESMTP id 69A7F63071
	for &lt;<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>&gt;; Sat, 10 May 2003 05:53:07 -0400 (EDT)
Received: from sc8-sf-list1-b.sourceforge.net ([10.3.1.13] helo=sc8-sf-list1.sourceforge.net)
	by sc8-sf-list2.sourceforge.net with esmtp (Exim 3.31-VA-mm2 #1 (Debian))
	id 19ER2h-0004CU-00; Sat, 10 May 2003 02:53:23 -0700
Received: from fmx1.freemail.hu ([195.228.242.221])
	by sc8-sf-list1.sourceforge.net with smtp (Exim 3.31-VA-mm2 #1 (Debian))
	id 19ER1h-00082r-00
	for &lt;<A HREF="mailto:ikvm-developers@lists.sourceforge.net">ikvm-developers@lists.sourceforge.net</A>&gt;; Sat, 10 May 2003 02:52:21 -0700
Received: (qmail 30838 invoked from network); 10 May 2003 11:52:18 +0200
Received: from fm9.freemail.hu (195.228.242.209)
  by fmx1.freemail.hu with SMTP; 10 May 2003 11:52:18 +0200
Received: (qmail 37703 invoked by uid 814275); 10 May 2003 11:52:17 +0200
From: Varga Zoltan &lt;<A HREF="mailto:vargaz@freemail.hu">vargaz@freemail.hu</A>&gt;
To: <A HREF="mailto:ikvm-developers@lists.sourceforge.net">ikvm-developers@lists.sourceforge.net</A>
Message-ID: &lt;<A HREF="mailto:freemail.20030410115217.37695@fm9.freemail.hu">freemail.20030410115217.37695@fm9.freemail.hu</A>&gt;
X-Originating-IP: [212.121.135.226]
X-HTTP-User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.0; en-US; rv:1.3) Gecko/20030312
MIME-Version: 1.0
Content-Type: MULTIPART/MIXED; BOUNDARY=&quot;0-1804289383-1052560337=:37695&quot;
Subject: [Ikvm-developers] Eclipse under mono
Sender: <A HREF="mailto:ikvm-developers-admin@lists.sourceforge.net">ikvm-developers-admin@lists.sourceforge.net</A>
Errors-To: <A HREF="mailto:ikvm-developers-admin@lists.sourceforge.net">ikvm-developers-admin@lists.sourceforge.net</A>
X-BeenThere: <A HREF="mailto:ikvm-developers@lists.sourceforge.net">ikvm-developers@lists.sourceforge.net</A>
X-Mailman-Version: 2.0.9-sf.net
Precedence: bulk
List-Help: &lt;mailto:<A HREF="mailto:ikvm-developers-request@lists.sourceforge.net">ikvm-developers-request@lists.sourceforge.net</A>?subject=help&gt;
List-Post: &lt;mailto:<A HREF="mailto:ikvm-developers@lists.sourceforge.net">ikvm-developers@lists.sourceforge.net</A>&gt;
List-Subscribe: &lt;<A HREF="https://lists.sourceforge.net/lists/listinfo/ikvm-developers">https://lists.sourceforge.net/lists/listinfo/ikvm-developers</A>&gt;,
	&lt;mailto:<A HREF="mailto:ikvm-developers-request@lists.sourceforge.net">ikvm-developers-request@lists.sourceforge.net</A>?subject=subscribe&gt;
List-Id: &lt;ikvm-developers.lists.sourceforge.net&gt;
List-Unsubscribe: &lt;<A HREF="https://lists.sourceforge.net/lists/listinfo/ikvm-developers">https://lists.sourceforge.net/lists/listinfo/ikvm-developers</A>&gt;,
	&lt;mailto:<A HREF="mailto:ikvm-developers-request@lists.sourceforge.net">ikvm-developers-request@lists.sourceforge.net</A>?subject=unsubscribe&gt;
List-Archive: &lt;<A HREF="http://sourceforge.net/mailarchive/forum.php?forum=ikvm-developers">http://sourceforge.net/mailarchive/forum.php?forum=ikvm-developers</A>&gt;
Date: Sat, 10 May 2003 11:52:17 +0200 (CEST)

--0-1804289383-1052560337=:37695
Content-Type: TEXT/PLAIN; CHARSET=ISO-8859-2


                                         Hi,

  I got Eclipse running under IKVM under Mono. A screenshot,
Makefiles
etc. can be found here:

<A HREF="http://www.nexus.hu/vargaz/">http://www.nexus.hu/vargaz/</A>

The port uses a JNI provider written in C which works with
mono. Eclipse
startup up+shuts down in about 1 minute on an 1Ghz PC, while
consuming about 90MB of memory. It works with Mono 0.24 and
current
mono CVS.

I made some modifications to IKVM which are in the attached
patch.
Could they be applied to the official version?

The modifications are:
-  ikvm.build: fix case of directory names
- ClassLoaderWrapper.cs: Create Assemblies with Run flag, so the
  runtime can apply some memory saving optimizations.
- TypeWrapper.cs: Cache field lookups
- classpath.cs: Make shared library loading work under UNIX

There is one other issue: Mono does not yet support the 
GetLoadedModules() method, so this has to be commmented out
in classpath.cs and in Handler.java.

BTW: The IBM RVM project includes a nice JNI testsuite:

<A HREF="http://www-124.ibm.com/developerworks/oss/jikesrvm/">http://www-124.ibm.com/developerworks/oss/jikesrvm/</A>

The Mauve test status of mono:
191 of 7294 tests failed

Would it be possible to post the Mauve test results of IKVM
somewhere
(with -verbose) so I can compare it to the Mono version?

                                        have fun

                                                Zoltan










--0-1804289383-1052560337=:37695
Content-Type: APPLICATION/octet-stream; name=&quot;small.diff&quot;
Content-Disposition: attachment; filename=&quot;small.diff&quot;

Index: ikvm.build
===================================================================
RCS file: /cvsroot/ikvm/ikvm/ikvm.build,v
retrieving revision 1.2
diff -u -3 -p -u -b -r1.2 ikvm.build
--- ikvm.build	8 Jan 2003 13:35:05 -0000	1.2
+++ ikvm.build	18 Apr 2003 13:50:13 -0000
@@ -1,8 +1,8 @@
 &lt;?xml version=&quot;1.0&quot;?&gt;
 &lt;project name=&quot;ikvm&quot; default=&quot;all&quot;&gt;
     &lt;target name=&quot;all&quot;&gt;
-        &lt;nant buildfile=&quot;ik.vm.net/ik.vm.net.build&quot; /&gt;
-        &lt;nant buildfile=&quot;ik.vm.jni/ik.vm.jni.build&quot; /&gt;
+        &lt;nant buildfile=&quot;IK.VM.NET/ik.vm.net.build&quot; /&gt;
+        &lt;nant buildfile=&quot;IK.VM.JNI/ik.vm.jni.build&quot; /&gt;
         &lt;nant buildfile=&quot;netexp/netexp.build&quot; /&gt;
         &lt;nant buildfile=&quot;ikvmc/ikvmc.build&quot; /&gt;
         &lt;nant buildfile=&quot;classpath/classpath.build&quot; /&gt;
Index: IK.VM.NET/ClassLoaderWrapper.cs
===================================================================
RCS file: /cvsroot/ikvm/ikvm/IK.VM.NET/ClassLoaderWrapper.cs,v
retrieving revision 1.16
diff -u -3 -p -u -b -r1.16 ClassLoaderWrapper.cs
--- IK.VM.NET/ClassLoaderWrapper.cs	14 Apr 2003 09:41:58 -0000	1.16
+++ IK.VM.NET/ClassLoaderWrapper.cs	18 Apr 2003 13:50:14 -0000
@@ -567,7 +568,7 @@ class ClassLoaderWrapper
 	{
 		AssemblyName name = new AssemblyName();
 		name.Name = &quot;ikvm_dynamic_assembly__&quot; + (this == GetBootstrapClassLoader() ? &quot;bootstrap&quot; : javaClassLoader);
-		AssemblyBuilder assemblyBuilder = AppDomain.CurrentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.RunAndSave);
+		AssemblyBuilder assemblyBuilder = AppDomain.CurrentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.Run);
 		ModuleBuilder moduleBuilder = assemblyBuilder.DefineDynamicModule(name.Name, JVM.Debug);
 		if(JVM.Debug)
 		{
Index: IK.VM.NET/TypeWrapper.cs
===================================================================
RCS file: /cvsroot/ikvm/ikvm/IK.VM.NET/TypeWrapper.cs,v
retrieving revision 1.23
diff -u -3 -p -u -b -r1.23 TypeWrapper.cs
--- IK.VM.NET/TypeWrapper.cs	14 Apr 2003 09:41:58 -0000	1.23
+++ IK.VM.NET/TypeWrapper.cs	18 Apr 2003 13:50:14 -0000
@@ -4104,6 +4143,7 @@ sealed class FieldWrapper
 	private IntPtr cookie;
 	internal CodeEmitter EmitGet;
 	internal CodeEmitter EmitSet;
+	private FieldInfo field;
 
 	internal FieldWrapper(TypeWrapper declaringType, string name, string sig, Modifiers modifiers)
 	{
@@ -4368,7 +4408,7 @@ sealed class FieldWrapper
 		return field;
 	}
 
-	internal void SetValue(object obj, object val)
+	internal FieldInfo LookupField()
 	{
 		// TODO this is a broken implementation (for one thing, it needs to support redirection)
 		BindingFlags bindings = BindingFlags.Public | BindingFlags.NonPublic;
@@ -4380,21 +4420,24 @@ sealed class FieldWrapper
 		{
 			bindings |= BindingFlags.Instance;
 		}
-		DeclaringType.Type.GetField(name, bindings).SetValue(obj, val);
+		return DeclaringType.Type.GetField(name, bindings);
 	}
 
-	internal object GetValue(object obj)
-	{
-		// TODO this is a broken implementation (for one thing, it needs to support redirection)
-		BindingFlags bindings = BindingFlags.Public | BindingFlags.NonPublic;
-		if(IsStatic)
+	internal void SetValue(object obj, object val)
 		{
-			bindings |= BindingFlags.Static;
+		if (field == null)
+			field = LookupField ();
+		field.SetValue(obj, val);
 		}
-		else
+
+	internal object GetValue(object obj)
 		{
-			bindings |= BindingFlags.Instance;
-		}
-		return DeclaringType.Type.GetField(name, bindings).GetValue(obj);
+		if (field == null)
+			field = LookupField ();
+		return field.GetValue (obj);
 	}
 }
Index: IK.VM.NET/classpath.cs
===================================================================
RCS file: /cvsroot/ikvm/ikvm/IK.VM.NET/classpath.cs,v
retrieving revision 1.25
diff -u -3 -p -u -b -r1.25 classpath.cs
--- IK.VM.NET/classpath.cs	14 Apr 2003 09:41:58 -0000	1.25
+++ IK.VM.NET/classpath.cs	18 Apr 2003 13:50:14 -0000
@@ -456,6 +456,9 @@ namespace NativeCode.java
 
 			public static string nativeGetLibname(string pathname, string libname)
 			{
+				if (Environment.OSVersion.ToString ().IndexOf (&quot;Unix&quot;) &gt;= 0)
+					return &quot;lib&quot; + libname + &quot;.so&quot;;
+
 				// HACK this seems like a lame way of doing things, but in order to get Eclipse to work,
 				// we have append .dll to the libname here
 				if(!libname.ToUpper().EndsWith(&quot;.DLL&quot;))
@@ -939,10 +942,13 @@ namespace NativeCode.java
 				{
 					if(!(assemblies[i] is NetSystem.Reflection.Emit.AssemblyBuilder))
 					{
+						/*
+						  // GetLoadedModules() is not implemented under mono
 						if(assemblies[i].GetLoadedModules()[0].GetField(name) != null)
 						{
 							return assemblies[i];
 						}
+						*/
 					}
 				}
 				return null;


--0-1804289383-1052560337=:37695--



-------------------------------------------------------
Enterprise Linux Forum Conference &amp; Expo, June 4-6, 2003, Santa Clara
The only event dedicated to issues related to Linux enterprise solutions
www.enterpriselinuxforum.com

_______________________________________________
Ikvm-developers mailing list
<A HREF="mailto:Ikvm-developers@lists.sourceforge.net">Ikvm-developers@lists.sourceforge.net</A>
<A HREF="https://lists.sourceforge.net/lists/listinfo/ikvm-developers">https://lists.sourceforge.net/lists/listinfo/ikvm-developers</A>

--gneEPciiIl/aKvOT--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013943.html">[Mono-list] Problems compiling monodoc
</A></li>
	<LI> Next message: <A HREF="013900.html">[Mono-list] New Mono 0.24 RPMS  available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13899">[ date ]</a>
              <a href="thread.html#13899">[ thread ]</a>
              <a href="subject.html#13899">[ subject ]</a>
              <a href="author.html#13899">[ author ]</a>
         </LI>
       </UL>
</body></html>
