<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] System.Web.Mail
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pt99par%40student.bth.se">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="012279.html">
   <LINK REL="Next"  HREF="012284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] System.Web.Mail
   </H1>
    <B>Per Arneng
    </B> 
    <A HREF="mailto:pt99par%40student.bth.se"
       TITLE="[Mono-list] System.Web.Mail">pt99par@student.bth.se
       </A><BR>
    <I>Tue, 18 Feb 2003 15:33:51 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="012279.html">[Mono-list] Re: Mono Queue Server
</A></li>
        <LI> Next message: <A HREF="012284.html">[Mono-list] About Format Function (VB.NET)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12292">[ date ]</a>
              <a href="thread.html#12292">[ thread ]</a>
              <a href="subject.html#12292">[ subject ]</a>
              <a href="author.html#12292">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--------------Boundary-00=_FSDIDFBEFLQ8SISB06MI
Content-Type: text/plain;
  charset=&quot;us-ascii&quot;
Content-Transfer-Encoding: quoted-printable

Hi!

Here is a some code to get SmtpMail  to work. It works
with basic mails. There is still a lot to do to get a full=20
implementation but i figured it would be nice to get it
working even if it isnt 100% finsished.

SmtpMail.cs  - The updated version of the one on the cvs to
                    use my classes

SmtpClient.cs -  A class that represents a connection to a=20
                      Smtp server.

SmtpResponse.cs - A class that represents a response from
                             an smtp server

These files works if they are put in the System.Web.Mail dir
but  SmtpClient.cs &amp; SmtpResponse.cs should probably
be somewhere else.

Note! this is my first contrib so there is probably many things
that arent as they should .. coding standard and stuff like that..
so feel free to reply with comments on that :)=20

//Per Arneng &lt;<A HREF="mailto:pt99par@student.bth.se">pt99par@student.bth.se</A>&gt;=20
                          =20

--------------Boundary-00=_FSDIDFBEFLQ8SISB06MI
Content-Type: text/x-c++src;
  charset=&quot;us-ascii&quot;;
  name=&quot;SmtpClient.cs&quot;
Content-Transfer-Encoding: 7bit
Content-Description: A class for handling the comunication to a smtp server
Content-Disposition: attachment; filename=&quot;SmtpClient.cs&quot;

// SmtpClient.cs
// author: Per Arneng &lt;<A HREF="mailto:pt99par@student.bth.se">pt99par@student.bth.se</A>&gt;
using System;
using System.Net;
using System.IO;
using System.Text;
using System.Net.Sockets;

namespace System.Web.Mail {

    /// represents a connection to a smtp server
    public class SmtpClient {
	
	private string server;
	private TcpClient tcpConnection;
	private Stream stream;
	private Encoding encoding;
	
	//Initialise the variables and connect
	public SmtpClient( string server ) {
	    
	    this.server = server;
	    encoding = new ASCIIEncoding( );

	    Connect();
	}
	
	// make the actual connection
	// and HELO handshaking
	private void Connect() {
	    tcpConnection = new TcpClient( server , 25 );
	    
	    stream = tcpConnection.GetStream();
	    
	    SmtpResponse response;
	    
	    // read the server greeting
	    response = ReadResponse();
	    
	    // write the HELO command to the server
	    WriteLine( String.Format( &quot;HELO {0}&quot; , Dns.GetHostName() ) );
	    
	    // read the response from
	    // the HELO command
	    response  = ReadResponse();
	}
		
	// sends a message to the server
	public void Send( MailMessage msg ) {
	    
	    if( msg.Attachments.Count &gt; 0 )
		throw new NotImplementedException( &quot;Attachments are not &quot; + 
						   &quot;implemented yet.&quot;);
	    
	    if( ( msg.From == null ) || ( msg.To == null ) )
		throw new ArgumentException( &quot;From &amp; To properties must be set.&quot; );
	    
	    SmtpResponse response;
	    
	    // start with a reset incase old data
	    // is present at the server in this session
	    WriteLine( &quot;RSET&quot; );
	    response  = ReadResponse();
	    
	    WriteLine( String.Format( &quot;MAIL FROM: {0}&quot; , msg.From ) );
	    response  = ReadResponse();
	    
	    WriteLine( String.Format( &quot;RCPT TO: {0}&quot; , msg.To ) );
	    response  = ReadResponse();
	    
	    WriteLine( &quot;DATA&quot;);
	    response  = ReadResponse();
	    
	    // send the headers
	    SendHeaders( msg );
	    
	    // send the &quot;&quot; delimitor between
	    // the headers and the body
	    WriteLine( &quot;&quot; );

	    // send the mail body
	    WriteLine( msg.Body );
	    
	    // send a &quot;.&quot; on a single row by itself
	    // to tell the server that there is no
	    // more data
	    WriteLine( &quot;.&quot; );
	    response  = ReadResponse();	    
	}
	
	// send the standard headers
	// and the custom in MailMessage
	// FIXME: more headers needs to be added so
	// that all properties from MailMessage are sent..
	// missing: Priority , UrlContentBase,UrlContentLocation
	private void SendHeaders( MailMessage msg ) {
	    	    
	    WriteLine( String.Format(&quot;From: {0}&quot;, msg.From ) );
	    WriteLine( String.Format(&quot;To: {0}&quot;, msg.To ) );
	    
	    if( msg.Cc != null )
		WriteLine( String.Format(&quot;Cc: {0}&quot;, msg.Cc ) );
	    
	    if( msg.Bcc != null )
		WriteLine( String.Format(&quot;Bcc: {0}&quot;, msg.Bcc ) );
	    
	    if( msg.Subject != null )
		WriteLine( String.Format(&quot;Subject: {0}&quot;, msg.Subject ) );

	    if( msg.UrlContentBase != null )
		WriteLine( String.Format(&quot;Subject: {0}&quot;, msg.Subject ) );
	    
	    // send the content type
	    string contentType = &quot;&quot;;
	    
	    switch( msg.BodyFormat ) {
		
	    case MailFormat.Html: contentType = &quot;text/html&quot;; break;
	    case MailFormat.Text: contentType = &quot;text/plain&quot;; break;
	    
	    default: contentType = &quot;text/plain&quot;; break;

	    }
	    
	    WriteLine( String.Format(&quot;Content-Type: {0}&quot;, contentType ) );
	    
	    // write the custom headers
	    foreach( string key in msg.Headers.Keys ) {
		string value = (string)msg.Headers[ key ];
		WriteLine( String.Format( &quot;{0}: {1}&quot; , key , value ));
	    }
	}
	
	
	// closes the connection
	public void Close() {
	    
	    WriteLine( &quot;QUIT&quot; );
	    SmtpResponse response  = ReadResponse();
	    
	    tcpConnection.Close();
	}
	
	// writes a line to the server
	private void WriteLine( string line ) {
	    byte[] buffer = 
		encoding.GetBytes( String.Format( &quot;{0}\r\n&quot; , line ) );
	    
	    stream.Write( buffer , 0 , buffer.Length );
	
	    // DebugPrint( line );
	}
	
	// read a line from the server
	private SmtpResponse ReadResponse( ) {
	    string line = null;
	    
	    byte[] buffer = new byte[ 4096 ];
	    
	    int readLength = stream.Read( buffer , 0 , 
					  buffer.Length );
	    
	    if( readLength &gt; 0 ) { 
	    
		line = encoding.GetString( buffer , 0 , readLength );
		
		line = line.TrimEnd( new Char[] { '\r' , '\n' , ' ' } );
			
	    }
	    
	    // DebugPrint( line );

	    // parse the line to a response object
	    SmtpResponse response = SmtpResponse.Parse( line );
	    
	    // FIXME:
	    // There should probably be a better 
	    // error control than this later on
	    if( ( response.StatusCode / 100 ) == 5 ) 
		throw new IOException( &quot;Smtp error: &quot; + response.RawResponse );
	    
	    return response;
	} 
	
	/// debug printing 
	private void DebugPrint( string line ) {
	    Console.WriteLine( &quot;smtp: {0}&quot; , line );
	}
	
    }

}

--------------Boundary-00=_FSDIDFBEFLQ8SISB06MI
Content-Type: text/x-c++src;
  charset=&quot;us-ascii&quot;;
  name=&quot;SmtpMail.cs&quot;
Content-Transfer-Encoding: 7bit
Content-Description: The updated cvs version 
Content-Disposition: attachment; filename=&quot;SmtpMail.cs&quot;

//
// System.Web.Mail.SmtpMail.cs
//
// Author(s):
//    Lawrence Pit (<A HREF="mailto:loz@cable.a2000.nl">loz@cable.a2000.nl</A>)
//    Per Arneng (<A HREF="mailto:pt99par@student.bth.se">pt99par@student.bth.se</A>)
//

using System;
using System.Net;
using System.Reflection;

namespace System.Web.Mail
{
	/// &lt;remarks&gt;
	/// &lt;/remarks&gt;
	public class SmtpMail
	{
	    
	    private static string smtpServer = &quot;localhost&quot;;
		
		// Constructor		
		private SmtpMail ()
		{
		    /* nothing here */
		}		

		// Properties
		public static string SmtpServer {
			get { return smtpServer; } 
			set { smtpServer = value; }
		}
		
		
		public static void Send (MailMessage message) 
	        {
		    
		    SmtpClient client = new SmtpClient (smtpServer);
		    
		    client.Send (message);
		    
		    client.Close ();
		}
		
		public static void Send (string from, string to, string subject, string messageText) 
		{
			MailMessage message = new MailMessage ();
			message.From = from;
			message.To = to;
			message.Subject = subject;
			message.Body = messageText;
			Send (message);
		}
	
	}
	
} //namespace System.Web.Mail

--------------Boundary-00=_FSDIDFBEFLQ8SISB06MI
Content-Type: text/x-c++src;
  charset=&quot;us-ascii&quot;;
  name=&quot;SmtpResponse.cs&quot;
Content-Transfer-Encoding: 7bit
Content-Description: Represents a response from an smtp server
Content-Disposition: attachment; filename=&quot;SmtpResponse.cs&quot;

// SmtpResponse.cs
// author: Per Arneng &lt;<A HREF="mailto:pt99par@student.bth.se">pt99par@student.bth.se</A>&gt;
using System;

namespace System.Web.Mail {

    /// this class represents the response from the smtp server
    public class SmtpResponse {
	
	private string rawResponse;
	private int statusCode;
	private string[] parts;

	/// use the Parse method to create instances
	protected SmtpResponse() {}

	/// the smtp status code FIXME: change to Enumeration?
	public int StatusCode {
	    get { return statusCode; }
	    set { statusCode = value; }
	}
	
	/// the response as it was recieved
	public string RawResponse {
	    get { return rawResponse; }
	    set { rawResponse = value; }
	}

	/// the response as parts where ; was used as delimiter
	public string[] Parts {
	    get { return parts; }
	    set { parts = value; }
	}

	/// parses a new response object from a response string
	public static SmtpResponse Parse( string line ) {
	    SmtpResponse response = new SmtpResponse();
	    
	    if( line == null )
		throw new ArgumentNullException( &quot;Null is not allowed &quot; + 
						 &quot;as a response string.&quot;);

	    if( line.Length &lt; 4 ) 
		throw new FormatException( &quot;Response is to short &quot; + 
					   line.Length + &quot;.&quot;);
	    
	    if( line[ 3 ] != ' ' )
		throw new FormatException( &quot;Response format is wrong.&quot;);
	    
	    // parse the response code
	    response.StatusCode = Int32.Parse( line.Substring( 0 , 3 ) );
	    
	    // set the rawsponse
	    response.RawResponse = line;

	    // set the response parts
	    response.Parts = line.Substring( 0 , 3 ).Split( ';' );

	    return response;
	}
    }

}

--------------Boundary-00=_FSDIDFBEFLQ8SISB06MI--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="012279.html">[Mono-list] Re: Mono Queue Server
</A></li>
	<LI> Next message: <A HREF="012284.html">[Mono-list] About Format Function (VB.NET)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12292">[ date ]</a>
              <a href="thread.html#12292">[ thread ]</a>
              <a href="subject.html#12292">[ subject ]</a>
              <a href="author.html#12292">[ author ]</a>
         </LI>
       </UL>
</body></html>
