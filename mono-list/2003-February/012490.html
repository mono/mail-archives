<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] DbDataAdapter.Fill patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:avd%40openlinksw.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="012459.html">
   <LINK REL="Next"  HREF="012491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] DbDataAdapter.Fill patch
   </H1>
    <B>Aleksey Demakov
    </B> 
    <A HREF="mailto:avd%40openlinksw.com"
       TITLE="[Mono-list] DbDataAdapter.Fill patch">avd@openlinksw.com
       </A><BR>
    <I>Wed, 26 Feb 2003 05:20:44 +0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="012459.html">[Mono-list] DbDataAdapter.Fill patch
</A></li>
        <LI> Next message: <A HREF="012491.html">[Mono-list] DbDataAdapter.Fill patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12490">[ date ]</a>
              <a href="thread.html#12490">[ thread ]</a>
              <a href="subject.html#12490">[ subject ]</a>
              <a href="author.html#12490">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.
--------------020102050909030809040405
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit

Well, I found .NET docs quite unclear on this issue. The docs even
provide code samples which I believe won't work.

Using MSDN (from January 2003) I found the following.

The docs for System.Data.IDataAdapter.Update and
System.Data.Common.DataAdapter.Update both say:

 &gt; Calls the respective INSERT, UPDATE, or DELETE statements for each
 &gt; inserted, updated, or deleted row in the specified DataSet from a
 &gt; DataTable named &quot;Table&quot;.

However the docs for
System.Data.Common.DataAdapter.Update (DataSet) says:

 &gt; Calls the respective INSERT, UPDATE, or DELETE statements for each
 &gt; inserted, updated, or deleted row in the specified DataSet.

As you can see in this case the &quot;from a DataTable named &quot;Table&quot;&quot; part
is missing. I think that this is simply a documentation bug in the MS
docs.

We can use some elementary logic to make this point. A DataAdapter
can actually perform an update only if it has its UpdateCommand,
DeleteCommand, and InsertCommand properties set to some reasonable
SQL statements that will do the necessary actions. Alternatively
it can be associated with a CommandBuilder object. I think it's
clear that an SQL update statement (like
&quot;update t set s = ? where id = ?&quot;) can update only one table.
If you execute such command on a DataTable filled with different 
DataAdapter from a different database table the result will be
unpredictable.

If this is not enough I wrote a simple program that shows how this
works. I've tested it only with MS .NET framework though, not with
Mono. It's source and output is attached.

Regards,
Aleksey

Alan Tam wrote:
&gt;<i> May I know where is it stated that one DataAdapter updates only one table? I
</I>&gt;<i> also believe so, but I found the code very strange, including trying to find
</I>&gt;<i> the DataTable associated to each schemaRow. I'm totally confused.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Alan
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i> From: &quot;Aleksey Demakov&quot; &lt;<A HREF="mailto:avd@openlinksw.com">avd@openlinksw.com</A>&gt;
</I>&gt;<i> To: &quot;Alan Tam&quot; &lt;<A HREF="mailto:Tam@SiuLung.com">Tam@SiuLung.com</A>&gt;
</I>&gt;<i> Cc: &lt;<A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>&gt;
</I>&gt;<i> Sent: Tuesday, February 25, 2003 5:24 PM
</I>&gt;<i> Subject: Re: [Mono-list] DbDataAdapter.Fill patch
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>So what's wrong with it? I think that a DataAdapter at one time
</I>&gt;&gt;<i>should update only one table. It's absolutely wrong to iterate
</I>&gt;&gt;<i>through all the tables in the DataSet because the DataAdapter
</I>&gt;&gt;<i>contains only one set of update commands while different tables
</I>&gt;&gt;<i>require different commands.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Regards,
</I>&gt;&gt;<i>Aleksey
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Alan Tam wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>The bottom half of the patch has been applied. Thank you.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>For the upper half, we may need more discussion. As far as I've observed,
</I>&gt;<i> 
</I>&gt;<i> the
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i>patch changes the code to simulate Microsoft behavior, which seems to be a
</I>&gt;&gt;&gt;<i>wrong behavior. I wonder if we should follow suit.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Regards,
</I>&gt;&gt;&gt;<i>Alan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>----- Original Message -----
</I>&gt;&gt;&gt;<i>From: &quot;Aleksey Demakov&quot; &lt;<A HREF="mailto:avd@openlinksw.com">avd@openlinksw.com</A>&gt;
</I>&gt;&gt;&gt;<i>To: &lt;<A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>&gt;
</I>&gt;&gt;&gt;<i>Sent: Wednesday, January 22, 2003 4:37 AM
</I>&gt;&gt;&gt;<i>Subject: [Mono-list] DbDataAdapter.Fill patch
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Hi all,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>I've found that the DbDataAdapter.Update (DataTable dataTable)
</I>&gt;&gt;&gt;&gt;<i>and Update (DataSet dataSet, string sourceTable) methods
</I>&gt;&gt;&gt;&gt;<i>iterate through all tables of the given dataSet and try
</I>&gt;&gt;&gt;&gt;<i>to update them with this DataAdapter. I believe that
</I>&gt;&gt;&gt;&gt;<i>this is incorrect.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>The dataSet can contain multiple DataTables which are
</I>&gt;&gt;&gt;&gt;<i>Filled using different DataAdapters with different
</I>&gt;&gt;&gt;&gt;<i>select/insert/delete/update commans. Consequently
</I>&gt;&gt;&gt;&gt;<i>one DataAdapter cannot be be able to perform all the
</I>&gt;&gt;&gt;&gt;<i>needed updates.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Unfortunately, the .NET docs are silent about this
</I>&gt;&gt;&gt;&gt;<i>issue. But I believe that DbDataAdapter.Update methods
</I>&gt;&gt;&gt;&gt;<i>should be symmetric to Fill methods. So as Fill (DataSet)
</I>&gt;&gt;&gt;&gt;<i>method fills only one DataSet table with default
</I>&gt;&gt;&gt;&gt;<i>name &quot;Table&quot;, the Update (DataSet) method should
</I>&gt;&gt;&gt;&gt;<i>only update default table. And Update (DataSet, string)
</I>&gt;&gt;&gt;&gt;<i>method should only update the specified table.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>The attached patch fixes also another problem.
</I>&gt;&gt;&gt;&gt;<i>The original code might pass a null DataTableMapping
</I>&gt;&gt;&gt;&gt;<i>value which is then used to create a RowUpdatingEventArgs
</I>&gt;&gt;&gt;&gt;<i>instance. So RowUpdatingEvent handler (for instance
</I>&gt;&gt;&gt;&gt;<i>CommandBuilder) could get null DataTableMapping which
</I>&gt;&gt;&gt;&gt;<i>might be unexpected. The patch makes sure that a non-null
</I>&gt;&gt;&gt;&gt;<i>DataTableMapping is passed.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Regards,
</I>&gt;&gt;&gt;&gt;<i>Aleksey
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>-----------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i>-
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Index: DbDataAdapter.cs
</I>&gt;&gt;&gt;&gt;<i>===================================================================
</I>&gt;&gt;&gt;&gt;<i>RCS file: /mono/mcs/class/System.Data/System.Data.Common/DbDataAdapter.cs,v
</I>&gt;&gt;&gt;&gt;<i>retrieving revision 1.21
</I>&gt;&gt;&gt;&gt;<i>diff -u -r1.21 DbDataAdapter.cs
</I>&gt;&gt;&gt;&gt;<i>--- DbDataAdapter.cs 12 Nov 2002 13:47:37 -0000 1.21
</I>&gt;&gt;&gt;&gt;<i>+++ DbDataAdapter.cs 21 Jan 2003 10:05:50 -0000
</I>&gt;&gt;&gt;&gt;<i>@@ -356,10 +356,7 @@
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public override int Update (DataSet dataSet)
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>- int result = 0;
</I>&gt;&gt;&gt;&gt;<i>- foreach (DataTable table in dataSet.Tables)
</I>&gt;&gt;&gt;&gt;<i>- result += Update (table);
</I>&gt;&gt;&gt;&gt;<i>- return result;
</I>&gt;&gt;&gt;&gt;<i>+ return Update (dataSet, &quot;Table&quot;);
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public int Update (DataTable dataTable)
</I>&gt;&gt;&gt;&gt;<i>@@ -447,11 +444,16 @@
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public int Update (DataSet dataSet, string sourceTable)
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>- int result = 0;
</I>&gt;&gt;&gt;&gt;<i>- DataTableMapping tableMapping = TableMappings [sourceTable];
</I>&gt;&gt;&gt;&gt;<i>- foreach (DataTable dataTable in dataSet.Tables)
</I>&gt;&gt;&gt;&gt;<i>- result += Update (dataTable, tableMapping);
</I>&gt;&gt;&gt;&gt;<i>- return result;
</I>&gt;&gt;&gt;&gt;<i>+ MissingMappingAction mappingAction = MissingMappingAction;
</I>&gt;&gt;&gt;&gt;<i>+ if (mappingAction == MissingMappingAction.Ignore)
</I>&gt;&gt;&gt;&gt;<i>+ mappingAction = MissingMappingAction.Error;
</I>&gt;&gt;&gt;&gt;<i>+ DataTableMapping tableMapping =
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>DataTableMappingCollection.GetTableMappingBySchemaAction (TableMappings,
</I>&gt;&gt;&gt;<i>sourceTable, sourceTable, mappingAction);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>+
</I>&gt;&gt;&gt;&gt;<i>+ DataTable dataTable = dataSet.Tables[tableMapping.DataSetTable];
</I>&gt;&gt;&gt;&gt;<i>+ if (dataTable == null)
</I>&gt;&gt;&gt;&gt;<i>+     throw new ArgumentException (&quot;sourceTable&quot;);
</I>&gt;&gt;&gt;&gt;<i>+
</I>&gt;&gt;&gt;&gt;<i>+ return Update (dataTable, tableMapping);
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> protected virtual void OnFillError (FillErrorEventArgs value)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> 
</I>

--------------020102050909030809040405
Content-Type: text/plain;
 name=&quot;u.cs&quot;
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename=&quot;u.cs&quot;

using System;
using System.Data;
using System.Data.SqlClient;

public class Test
{
	static SqlConnection conn = new SqlConnection(&quot;server=(local);Trusted_Connection=yes;database=northwind&quot;);
	static SqlDataAdapter da1 = new SqlDataAdapter(&quot;select * from foo&quot;, conn);
	static SqlDataAdapter da2 = new SqlDataAdapter(&quot;select * from bar&quot;, conn);
	static SqlDataAdapter da3 = new SqlDataAdapter(&quot;select * from baz&quot;, conn);
	static DataSet ds = new DataSet();

	public static void Main ()
	{
		conn.Open ();
		Create ();

		SqlCommandBuilder b1 = new SqlCommandBuilder (da1);
		da1.RowUpdating += new SqlRowUpdatingEventHandler (RowUpdatingHandler);
		da1.MissingSchemaAction = MissingSchemaAction.AddWithKey;
		da1.Fill (ds, &quot;Foo&quot;);
		ds.Tables[&quot;Foo&quot;].Rows[0][&quot;FooData&quot;] = &quot;foo2&quot;;

		SqlCommandBuilder b2 = new SqlCommandBuilder (da2);
		da2.RowUpdating += new SqlRowUpdatingEventHandler (RowUpdatingHandler);
		da2.MissingSchemaAction = MissingSchemaAction.AddWithKey;
		da2.Fill (ds, &quot;Bar&quot;);
		ds.Tables[&quot;Bar&quot;].Rows[0][&quot;BarData&quot;] = &quot;bar2&quot;;

		try {
			Console.WriteLine (&quot;Calling da1.Update() without table parameter.&quot;);
			da1.Update (ds);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
		try 
		{
			Console.WriteLine (&quot;Calling da2.Update() without table parameter.&quot;);
			da2.Update (ds);
			Console.WriteLine (&quot;Ok.&quot;);
		} 
		catch (Exception e) 
		{
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
		try 
		{
			Console.WriteLine (&quot;Calling da1.Update() with table name parameter.&quot;);
			da1.Update (ds, &quot;Foo&quot;);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
		try 
		{
			Console.WriteLine (&quot;Calling da2.Update() with table name parameter.&quot;);
			da2.Update (ds, &quot;Bar&quot;);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}

		Console.WriteLine (&quot;Once again. Fill a table with the default name.&quot;);
		SqlCommandBuilder b3 = new SqlCommandBuilder (da3);
		da3.RowUpdating += new SqlRowUpdatingEventHandler (RowUpdatingHandler);
		da3.MissingSchemaAction = MissingSchemaAction.AddWithKey;
		da3.Fill (ds);
		ds.Tables[&quot;Table&quot;].Rows[0][&quot;BazData&quot;] = &quot;baz2&quot;;

		try {
			Console.WriteLine (&quot;Calling da1.Update() without table parameter.&quot;);
			da1.Update (ds);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
		try 
		{
			Console.WriteLine (&quot;Calling da2.Update() without table parameter.&quot;);
			da2.Update (ds);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
		try 
		{
			Console.WriteLine (&quot;Calling da3.Update() without table parameter.&quot;);
			da2.Update (ds);
			Console.WriteLine (&quot;Ok.&quot;);
		} catch (Exception e) {
			Console.WriteLine (&quot;Caught an exception: &quot;);
			Console.WriteLine (e);
		}
	}

	private static void Create ()
	{
		SqlCommand cmd = new SqlCommand ();
		cmd.Connection = conn;

		try
		{
			cmd.CommandText = &quot;drop table foo&quot;;
			cmd.ExecuteNonQuery ();
		}
		catch (Exception)
		{
		}
		try
		{
			cmd.CommandText = &quot;drop table bar&quot;;
			cmd.ExecuteNonQuery ();
		}
		catch (Exception)
		{
		}
		try
		{
			cmd.CommandText = &quot;drop table baz&quot;;
			cmd.ExecuteNonQuery ();
		}
		catch (Exception)
		{
		}

		cmd.CommandText = &quot;create table foo (FooId int primary key, FooData varchar (100))&quot;;
		cmd.ExecuteNonQuery ();
		cmd.CommandText = &quot;insert into foo values (1, 'foo1')&quot;;
		cmd.ExecuteNonQuery ();

		cmd.CommandText = &quot;create table bar (BarId int primary key, BarData varchar (100))&quot;;
		cmd.ExecuteNonQuery ();
		cmd.CommandText = &quot;insert into bar values (1, 'bar1')&quot;;
		cmd.ExecuteNonQuery ();

		cmd.CommandText = &quot;create table baz (BazId int primary key, BazData varchar (100))&quot;;
		cmd.ExecuteNonQuery ();
		cmd.CommandText = &quot;insert into baz values (1, 'baz1')&quot;;
		cmd.ExecuteNonQuery ();

		cmd.Dispose ();
	}

	private static void RowUpdatingHandler (object sender, SqlRowUpdatingEventArgs e)
	{
		Console.WriteLine (&quot;Updating with command: {0}&quot;, e.Command.CommandText);
	}
}

--------------020102050909030809040405
Content-Type: text/plain;
 name=&quot;out&quot;
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename=&quot;out&quot;

Calling da1.Update() without table parameter.
Caught an exception: 
System.InvalidOperationException: Update unable to find TableMapping['Table'] or DataTable 'Table'.
   at System.Data.Common.DbDataAdapter.Update(DataSet dataSet, String srcTable)
   at System.Data.Common.DbDataAdapter.Update(DataSet dataSet)
   at Test.Main()
Calling da2.Update() without table parameter.
Caught an exception: 
System.InvalidOperationException: Update unable to find TableMapping['Table'] or DataTable 'Table'.
   at System.Data.Common.DbDataAdapter.Update(DataSet dataSet, String srcTable)
   at System.Data.Common.DbDataAdapter.Update(DataSet dataSet)
   at Test.Main()
Calling da1.Update() with table name parameter.
Updating with command: UPDATE foo SET FooData = @p1 WHERE ( (FooId = @p2) AND ((FooData IS NULL AND @p3 IS NULL) OR (FooData = @p4)) )
Ok.
Calling da2.Update() with table name parameter.
Updating with command: UPDATE bar SET BarData = @p1 WHERE ( (BarId = @p2) AND ((BarData IS NULL AND @p3 IS NULL) OR (BarData = @p4)) )
Ok.

--------------020102050909030809040405--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="012459.html">[Mono-list] DbDataAdapter.Fill patch
</A></li>
	<LI> Next message: <A HREF="012491.html">[Mono-list] DbDataAdapter.Fill patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12490">[ date ]</a>
              <a href="thread.html#12490">[ thread ]</a>
              <a href="subject.html#12490">[ subject ]</a>
              <a href="author.html#12490">[ author ]</a>
         </LI>
       </UL>
</body></html>
