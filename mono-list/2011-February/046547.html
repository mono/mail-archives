<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Assertion failures when using Moq on Linux/ARM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Assertion%20failures%20when%20using%20Moq%20on%20Linux/ARM&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046546.html">
   <LINK REL="Next"  HREF="046548.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Assertion failures when using Moq on Linux/ARM</H1>
    <B>Weeble</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Assertion%20failures%20when%20using%20Moq%20on%20Linux/ARM&In-Reply-To="
       TITLE="[Mono-list] Assertion failures when using Moq on Linux/ARM">clockworksaint at gmail.com
       </A><BR>
    <I>Fri Feb  4 05:52:52 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="046546.html">[Mono-list] cs0011 error on 2.8.2
</A></li>
        <LI>Next message: <A HREF="046548.html">[Mono-list] Assertion failures when using Moq on Linux/ARM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46547">[ date ]</a>
              <a href="thread.html#46547">[ thread ]</a>
              <a href="subject.html#46547">[ subject ]</a>
              <a href="author.html#46547">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm currently running Mono 2.6.7 on an ARM box (a Sheevaplug) running
Linux. When I try to run unit tests that work on Windows-x86 with
Microsoft's CLR and on Linux-x86 with Mono, they fail often (but not
always) with an assertion:

ERROR:mini-arm.c:2579:handle_thunk: assertion failed: (pdata.found == 1)
Stacktrace:

  at (wrapper managed-to-native)
System.Delegate.CreateDelegate_internal
(System.Type,object,System.Reflection.MethodInfo,bool) &lt;0xffffffff&gt;
  at System.Delegate.CreateDelegate
(System.Type,object,System.Reflection.MethodInfo,bool) &lt;0x006c0&gt;
  at System.Delegate.CreateDelegate
(System.Type,object,System.Reflection.MethodInfo) &lt;0x0002f&gt;
  at System.Reflection.Emit.DynamicMethod.CreateDelegate
(System.Type,object) &lt;0x0003f&gt;
  at System.Linq.Expressions.EmitContext.CreateDelegate
(System.Runtime.CompilerServices.ExecutionScope) &lt;0x0003f&gt;
  at System.Linq.Expressions.CompilationContext.CreateDelegate
(int,System.Runtime.CompilerServices.ExecutionScope) &lt;0x00043&gt;
  at System.Linq.Expressions.CompilationContext.CreateDelegate () &lt;0x0003f&gt;
  at System.Linq.Expressions.LambdaExpression.Compile () &lt;0x00053&gt;
  at System.Linq.Expressions.Expression`1&lt;object&gt;.Compile () &lt;0x0001b&gt;
  at Moq.Mock.GetInterceptor
(System.Linq.Expressions.Expression,Moq.Mock) &lt;0x00073&gt;
  at Moq.Mock.Verify&lt;object&gt;
(Moq.Mock,System.Linq.Expressions.Expression`1&lt;System.Action`1&lt;object&gt;&gt;,Moq.Times,string)
&lt;0x001eb&gt;
  at Moq.Mock`1&lt;object&gt;.Verify
(System.Linq.Expressions.Expression`1&lt;System.Action`1&lt;object&gt;&gt;)
&lt;0x00063&gt;
...

You can see the source of GetInterceptor here:
<A HREF="http://code.google.com/p/moq/source/browse/trunk/Source/Mock.cs#sl_svn751_676">http://code.google.com/p/moq/source/browse/trunk/Source/Mock.cs#sl_svn751_676</A>

private static Interceptor GetInterceptor(Expression fluentExpression,
Mock mock)
{
        var targetExpression = FluentMockVisitor.Accept(fluentExpression, mock);
        var targetLambda =
Expression.Lambda&lt;Func&lt;Mock&gt;&gt;(Expression.Convert(targetExpression,
typeof(Mock)));
        var targetObject = targetLambda.Compile()();
        return targetObject.Interceptor;
}

The expression getting passed in is fairly trivial. My code does this:

iMockListener.Verify(x =&gt; x.SetPropInt(1, 1999));

And then I think Verify extracts the object expression from the method
call which I guess is just the identity function?

Looking at mini-arm.c, I think that assertion is saying that it can't
find an appropriate place to create the thunk for a delegate. Is that
right?

1. Is this a bug?
2. If I move to Mono 2.8, am I likely to have any better luck?
3. Does Moq create too many delegates to work properly on ARM? Is this
an inappropriate library to use on an ARM device?
4. Is this problem limited only to doing advanced stuff with Linq
expressions or can it happen simple from creating a lot of delegates?
5. Is it useful for me to try to put together a minimal example to
replicate the problem?

Best regards,

Weeble.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046546.html">[Mono-list] cs0011 error on 2.8.2
</A></li>
	<LI>Next message: <A HREF="046548.html">[Mono-list] Assertion failures when using Moq on Linux/ARM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46547">[ date ]</a>
              <a href="thread.html#46547">[ thread ]</a>
              <a href="subject.html#46547">[ subject ]</a>
              <a href="author.html#46547">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
