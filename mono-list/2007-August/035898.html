<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Hang on JIT-ing fn with P/Invoke?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Hang%20on%20JIT-ing%20fn%20with%20P/Invoke%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035894.html">
   <LINK REL="Next"  HREF="035899.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Hang on JIT-ing fn with P/Invoke?</H1>
    <B>Andy Hume</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Hang%20on%20JIT-ing%20fn%20with%20P/Invoke%3F&In-Reply-To="
       TITLE="[Mono-list] Hang on JIT-ing fn with P/Invoke?">andyhume32 at yahoo.co.uk
       </A><BR>
    <I>Thu Aug  9 09:01:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="035894.html">[Mono-list] SecurityIdentifier and IdentityReference	op_Equality
</A></li>
        <LI>Next message: <A HREF="035899.html">[Mono-list] Hang on JIT-ing fn with P/Invoke?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35898">[ date ]</a>
              <a href="thread.html#35898">[ thread ]</a>
              <a href="subject.html#35898">[ subject ]</a>
              <a href="author.html#35898">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Can someone try reproducing this for me.  When I run the following program it hangs _before_ entering the function doing a certain P/Invoke call.  If I comment out the sdp_list_append call it runs to completion.  It doesn't occur when run on the Windows mono.exe, but does in the Mono Suse vmx.  It needs BlueZ's libbluetooth.

My best guess is that the jitter is getting stuck?  There may well be something wrong with the P/Invoke definitions :-,), but I'm reporting the hang.


using System;
using System.Runtime.InteropServices;

class Foo2
{
    static void Main()
    {
        Console.WriteLine(&quot;entering Main&quot;);
        fn1();
    }
    static void fn1()
    {
        Console.WriteLine(&quot;entering fn1&quot;);
        fn2();
    }
    static void fn2()
    {
        Console.WriteLine(&quot;entering fn2&quot;);
        fn3();
    }

    static void fn3()
    {
        Console.WriteLine(&quot;entering fn3&quot;);
        uuid_t svc_uuid = new uuid_t();
        NativeMethods.sdp_uuid16_create(svc_uuid, 0x0100);
        // With this call in place, the programs hangs apparently
        // before entering this function. 'kill -QUIT' shows
        // Main-&gt;fn1-&gt;fn2-&gt;fn2&lt;0xffffffff&gt;
        // Comment it out and the program runs to completion
        // (likely producing a memory error when it does so).
        /**/
        sdp_list_t search_list
            = NativeMethods.sdp_list_append(null, svc_uuid);
        //*/
    }

    [StructLayout(LayoutKind.Sequential)]
    class uuid_t
    {
        public byte type;
        public Guid uuid128; //?
    }

    [StructLayout(LayoutKind.Sequential)]
    class sdp_list_t
    {
        public sdp_list_t next;
        public IntPtr data;
    }

    class NativeMethods
    {
        const string BluetoothLibrary = &quot;libbluetooth&quot;;

        //sdp_list_t* sdp_list_append(sdp_list_t* list, void* d);
        [DllImport(BluetoothLibrary)]
        internal static extern sdp_list_t sdp_list_append(sdp_list_t list, uuid_t d);

        //uuid_t* sdp_uuid16_create(uuid_t* uuid, uint16_t data);
        [DllImport(BluetoothLibrary)]
        internal static extern uuid_t sdp_uuid16_create(uuid_t uuid, Int16 data);

    }

}//class


The stack trace at hang is the following; note no fn3.

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono at mono</A>:~/Desktop/andy&gt; mono --debug foo2.exe
entering fnMain
entering fn1
entering fn2
Full thread dump:

&quot;&quot; tid=0x0xb7d74ae0 this=0x0x21e10:
  at Foo2.fn2 () &lt;0xffffffff&gt;
  at Foo2.fn2 () &lt;0x00013&gt;
  at Foo2.fn1 () &lt;0x00012&gt;
  at Foo2.Main () &lt;0x00012&gt;
  at (wrapper runtime-invoke) System.Object.runtime_invoke_void (object,intptr,intptr,intptr) &lt;0xffffffff&gt;

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035894.html">[Mono-list] SecurityIdentifier and IdentityReference	op_Equality
</A></li>
	<LI>Next message: <A HREF="035899.html">[Mono-list] Hang on JIT-ing fn with P/Invoke?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35898">[ date ]</a>
              <a href="thread.html#35898">[ thread ]</a>
              <a href="subject.html#35898">[ subject ]</a>
              <a href="author.html#35898">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
