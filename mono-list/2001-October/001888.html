<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] patch: use relative numbering for runtime type checks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dietmar%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001894.html">
   <LINK REL="Next"  HREF="001889.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] patch: use relative numbering for runtime type checks
   </H1>
    <B>Dietmar Maurer
    </B> 
    <A HREF="mailto:dietmar%40ximian.com"
       TITLE="[Mono-list] patch: use relative numbering for runtime type checks">dietmar@ximian.com
       </A><BR>
    <I>25 Oct 2001 11:32:05 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="001894.html">[Mono-list] interop question
</A></li>
        <LI> Next message: <A HREF="001889.html">[Mono-list] integrate python in mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1888">[ date ]</a>
              <a href="thread.html#1888">[ thread ]</a>
              <a href="subject.html#1888">[ subject ]</a>
              <a href="author.html#1888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Index: mono/interpreter/ChangeLog
===================================================================
RCS file: /cvs/public/mono/mono/interpreter/ChangeLog,v
retrieving revision 1.72
diff -u -r1.72 ChangeLog
--- mono/interpreter/ChangeLog	2001/10/15 09:50:03	1.72
+++ mono/interpreter/ChangeLog	2001/10/25 05:31:50
@@ -1,3 +1,8 @@
+2001-10-25  Dietmar Maurer  &lt;<A HREF="mailto:dietmar@ximian.com">dietmar@ximian.com</A>&gt;
+
+	* interp.c (ves_exec_method): use relative numbering for runtime
+	type checks (and make it work with interfaces)
+
 2001-10-15  Dietmar Maurer  &lt;<A HREF="mailto:dietmar@ximian.com">dietmar@ximian.com</A>&gt;
 
 	* interp.c: removed newobj()
Index: mono/interpreter/interp.c
===================================================================
RCS file: /cvs/public/mono/mono/interpreter/interp.c,v
retrieving revision 1.88
diff -u -r1.88 interp.c
--- mono/interpreter/interp.c	2001/10/15 09:50:03	1.88
+++ mono/interpreter/interp.c	2001/10/25 05:31:50
@@ -2061,22 +2061,27 @@
 			token = read32 (ip);
 			c = mono_class_get (image, token);
 
+			if (!c-&gt;inited)
+				init_class (c);
+
 			g_assert (sp [-1].type == VAL_OBJ);
 
 			if ((o = sp [-1].data.p)) {
-				/* 
-				 * fixme: this only works for class casts, but not for 
-				 * interface casts. 
-				 */
+
 				oclass = o-&gt;klass;
-				while (oclass) {
-					if (c == oclass) {
-						sp [-1].data.vt.klass = oclass;
+
+				if (c-&gt;flags &amp; TYPE_ATTRIBUTE_INTERFACE) {
+					if ((c-&gt;interface_id &lt; oclass-&gt;interface_count) &amp;&amp;
+					    oclass-&gt;interface_offsets [c-&gt;interface_id])
 						found = TRUE;
-						break;
+					g_error (&quot;fixme: dont know if this works&quot;);
+				} else {
+					if ((oclass-&gt;baseval - c-&gt;baseval) &lt;= c-&gt;diffval) {
+						sp [-1].data.vt.klass = c;
+						found = TRUE;
 					}
-					oclass = oclass-&gt;parent;
 				}
+
 				if (!found) {
 					if (do_isinst) {
 						sp [-1].data.p = NULL;
Index: mono/metadata/ChangeLog
===================================================================
RCS file: /cvs/public/mono/mono/metadata/ChangeLog,v
retrieving revision 1.77
diff -u -r1.77 ChangeLog
--- mono/metadata/ChangeLog	2001/10/17 03:58:33	1.77
+++ mono/metadata/ChangeLog	2001/10/25 05:31:50
@@ -1,3 +1,8 @@
+2001-10-25  Dietmar Maurer  &lt;<A HREF="mailto:dietmar@ximian.com">dietmar@ximian.com</A>&gt;
+
+	* class.c (mono_compute_relative_numbering): use relative
+	numbering to support fast runtime type checks.
+
 2001-10-17  Sean MacIsaac  &lt;<A HREF="mailto:macisaac@ximian.com">macisaac@ximian.com</A>&gt;
 
 	* class.c (mono_class_create_from_typeref): added debugging output
Index: mono/metadata/class.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/class.c,v
retrieving revision 1.43
diff -u -r1.43 class.c
--- mono/metadata/class.c	2001/10/17 03:58:33	1.43
+++ mono/metadata/class.c	2001/10/25 05:31:50
@@ -394,6 +394,25 @@
 	//printf (&quot;METAEND %s.%s\n&quot;, class-&gt;name_space, class-&gt;name);
 }
 
+/*
+ * Compute a relative numbering of the class hierarchy as described in
+ * &quot;Java for Large-Scale Scientific Computations?&quot;
+ */
+static void
+mono_compute_relative_numbering (MonoClass *class, int *c)
+{
+	GList *s;
+
+	(*c)++;
+
+	class-&gt;baseval = *c;
+
+	for (s = class-&gt;subclasses; s; s = s-&gt;next)
+		mono_compute_relative_numbering ((MonoClass *)s-&gt;data, c); 
+	
+	class-&gt;diffval = *c -  class-&gt;baseval;
+}
+
 /**
  * @image: context where the image is created
  * @type_token:  typedef token
@@ -468,9 +487,12 @@
 		class-&gt;parent = NULL;
 		class-&gt;instance_size = sizeof (MonoObject);
 	} else if (!(cols [0] &amp; TYPE_ATTRIBUTE_INTERFACE)) {
+		int rnum = 0;
 		class-&gt;parent = mono_class_get (image,  mono_metadata_token_from_dor
(cols [3]));
 		class-&gt;valuetype = class-&gt;parent-&gt;valuetype;
 		class-&gt;enumtype = class-&gt;parent-&gt;enumtype;
+		class-&gt;parent-&gt;subclasses = g_list_prepend
(class-&gt;parent-&gt;subclasses, class);
+		mono_compute_relative_numbering (mono_defaults.object_class, &amp;rnum);
 	}
 
 	if (!strcmp (nspace, &quot;System&quot;)) {
@@ -703,6 +725,7 @@
 	MonoClass *class;
 	static MonoClass *parent = NULL;
 	guint32 key;
+	int rnum = 0;
 
 	g_assert (rank &lt;= 255);
 
@@ -732,6 +755,8 @@
 	class-&gt;instance_size = mono_class_instance_size (class-&gt;parent);
 	class-&gt;class_size = 0;
 	class-&gt;vtable_size = parent-&gt;vtable_size;
+	class-&gt;parent-&gt;subclasses = g_list_prepend (class-&gt;parent-&gt;subclasses,
class);
+	mono_compute_relative_numbering (mono_defaults.object_class, &amp;rnum);
 
 	class-&gt;rank = rank;
 	class-&gt;element_class = eclass;
Index: mono/metadata/class.h
===================================================================
RCS file: /cvs/public/mono/mono/metadata/class.h,v
retrieving revision 1.24
diff -u -r1.24 class.h
--- mono/metadata/class.h	2001/10/15 09:50:03	1.24
+++ mono/metadata/class.h	2001/10/25 05:31:50
@@ -24,7 +24,8 @@
 	guint valuetype       : 1; /* derives from System.ValueType */
 	guint enumtype        : 1; /* derives from System.Enum */
 
-	MonoClass *parent;
+	MonoClass  *parent;
+	GList      *subclasses; /* list of all subclasses */
 
 	const char *name;
 	const char *name_space;
@@ -40,6 +41,12 @@
 	int        instance_size;
 	int        class_size;
 	int        vtable_size; /* number of slots */
+
+	/*
+	 * relartive numbering for fast type checking
+	 */
+	unsigned int baseval;
+	unsigned int diffval;
 
 	/*
 	 * From the TypeDef table




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001894.html">[Mono-list] interop question
</A></li>
	<LI> Next message: <A HREF="001889.html">[Mono-list] integrate python in mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1888">[ date ]</a>
              <a href="thread.html#1888">[ thread ]</a>
              <a href="subject.html#1888">[ subject ]</a>
              <a href="author.html#1888">[ author ]</a>
         </LI>
       </UL>
</body></html>
