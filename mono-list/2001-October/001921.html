<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Class library developers: locking issues to keep in mind
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:serge%40wildwestsoftware.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001920.html">
   <LINK REL="Next"  HREF="001917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Class library developers: locking issues to keep in mind
   </H1>
    <B>Serge
    </B> 
    <A HREF="mailto:serge%40wildwestsoftware.com"
       TITLE="[Mono-list] Class library developers: locking issues to keep in mind">serge@wildwestsoftware.com
       </A><BR>
    <I>Mon, 29 Oct 2001 16:16:49 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="001920.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
        <LI> Next message: <A HREF="001917.html">[Mono-list] Class library developers: locking issues to keep in	mind
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1921">[ date ]</a>
              <a href="thread.html#1921">[ thread ]</a>
              <a href="subject.html#1921">[ subject ]</a>
              <a href="author.html#1921">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Exactly, this is the correct solution (albeit only for static fields). This
is also solution mentioned by William Pugh.
However, taking into account current behaviour of both C# compiler and
runtime, the following little change is needed for C# version:

class Singleton {
 private static class SingletonHolder {
      static readonly Singleton singleton;

      // required!
      static SingletonHolder () {
       singleton = new Singleton();
      }
 }

 public static Singleton GetHeavyObject() {
      return SingletonHolder.singleton;
 }
}

This way (explicit static constructor) BeforeFieldInit will be ommited and
instance will be created on-demand.
And with line like this:
 static readonly Singleton singleton = new Singleton();
Compiler will create static constructor itself, enable BeforeFieldInit, and
instance will be initialized sometimes before the first access.
This is the subtle difference between Java and .NET initialization
sequences.
All in all, explicitly provided static constructor is always needed if you
want Java-like delayed initialization.

Thanks,
Sergey



----- Original Message -----
From: &quot;Alexander Klyubin&quot; &lt;<A HREF="mailto:klyubin@aqris.com">klyubin@aqris.com</A>&gt;
To: &lt;<A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>&gt;
Sent: Monday, October 29, 2001 3:50 PM
Subject: Re: [Mono-list] Class library developers: locking issues to keep in
mind


&gt;<i> Just browsed Joshua Bloch's Effective Java (ISBN: 0201310058). He also
</I>&gt;<i> states that DCL is broken in Java. As one of the solutions in item #48
</I>&gt;<i> initialize-on-demand holder class idiom is proposed. Applied to our
</I>&gt;<i> situation it looks like this:
</I>&gt;<i>
</I>&gt;<i> class Singleton {
</I>&gt;<i>    private static class SingletonHolder {
</I>&gt;<i>      static final Singleton singleton = new Singleton();
</I>&gt;<i>    }
</I>&gt;<i>
</I>&gt;<i>    public static Singleton GetHeavyObject() {
</I>&gt;<i>      return SingletonHolder.singleton;
</I>&gt;<i>    }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> It uses Java's feature that class (SingletonHolder) is not initialized
</I>&gt;<i> until it is first used. What this essentially means is that new
</I>&gt;<i> Singleton() will be executed on first invocation of GetHeavyObject, not
</I>&gt;<i> earlier.
</I>&gt;<i>
</I>&gt;<i> Alexander Klyubin
</I>&gt;<i>
</I>




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001920.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
	<LI> Next message: <A HREF="001917.html">[Mono-list] Class library developers: locking issues to keep in	mind
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1921">[ date ]</a>
              <a href="thread.html#1921">[ thread ]</a>
              <a href="subject.html#1921">[ subject ]</a>
              <a href="author.html#1921">[ author ]</a>
         </LI>
       </UL>
</body></html>
