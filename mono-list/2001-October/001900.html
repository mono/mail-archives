<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Class library developers: locking issues to keep in mind
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:klyubin%40aqris.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001896.html">
   <LINK REL="Next"  HREF="001901.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Class library developers: locking issues to keep in mind
   </H1>
    <B>Alexander Klyubin
    </B> 
    <A HREF="mailto:klyubin%40aqris.com"
       TITLE="[Mono-list] Class library developers: locking issues to keep in mind">klyubin@aqris.com
       </A><BR>
    <I>Sun, 28 Oct 2001 10:20:47 +0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="001896.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
        <LI> Next message: <A HREF="001901.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1900">[ date ]</a>
              <a href="thread.html#1900">[ thread ]</a>
              <a href="subject.html#1900">[ subject ]</a>
              <a href="author.html#1900">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I don't know that much about .NET memory model as of Java's one, but in 
Java the code with on-demand locking you provided is called 
Double-checked Locking (DCL). The problem with it is that it is not 
guaranteed to work in all JVMs as synchronizing memory thread's own 
local memory with shared main memory accessible to all threads can work 
differently in different JVMs. Maybe memory model is organized 
differently in .NET languages compared to Java. But as similarity 
between C# and Java is realy big, I suspect memory model should be quite 
similar if not the same.

Here are good articles on this topic for Java. You migh also want to 
find out more by simply searching JavaWorld (www.javaworld.com) for 
&quot;DCL&quot;. But these two are the core ones to understand the problem:

1. Double-checked locking: Clever, but broken
<A HREF="http://www.javaworld.com/javaworld/jw-02-2001/jw-0209-double.html">http://www.javaworld.com/javaworld/jw-02-2001/jw-0209-double.html</A>

2. Can double-checked locking be fixed?
<A HREF="http://www.javaworld.com/javaworld/jw-05-2001/jw-0525-double.html">http://www.javaworld.com/javaworld/jw-05-2001/jw-0525-double.html</A>


Regards,
Alexander Klyubin

Miguel de Icaza wrote:

&gt;<i>    I noticed today that I have been writing thread-unsafe code in my
</I>&gt;<i> code that goes into the class libraries.  Some classes for example
</I>&gt;<i> provide static properties, and to avoid a costly initialization at
</I>&gt;<i> bootstrap time, you want to create some of those values on demand
</I>&gt;<i> instead of doing it constructor, like this:
</I>&gt;<i> 
</I>&gt;<i>    class Sample {
</I>&gt;<i> 	static SomeObject MyProperty {
</I>&gt;<i> 		get {
</I>&gt;<i> 			if (some_object == null)
</I>&gt;<i> 				some_object = new SomeObject ();
</I>&gt;<i> 			return some_object;
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i>    }
</I>&gt;<i> 
</I>&gt;<i>    Well, it turns out that the code above is not thread safe, because
</I>&gt;<i> two threads might be hitting the same spot at the same time and two
</I>&gt;<i> copies of SomeObject would be created.  Then later on, comparissions
</I>&gt;<i> would not work (if p == MyProperty).  To correct that situation, you
</I>&gt;<i> have to lock on either the instance (this) or the class (typeof (this)),
</I>&gt;<i> like this:
</I>&gt;<i> 
</I>&gt;<i>     class Sample {
</I>&gt;<i> 	static SomeObject MyProperty {
</I>&gt;<i> 		get {
</I>&gt;<i> 			if (some_object != null)
</I>&gt;<i> 				return some_object;
</I>&gt;<i> 			lock (typeof (Sample)){
</I>&gt;<i> 				if (some_object == null)
</I>&gt;<i> 					some_object = new SomeObject ();
</I>&gt;<i> 				return some_object;
</I>&gt;<i> 			}
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>    Notice that you first test for initialization: if it is not null, you
</I>&gt;<i> can return the value without ever locking.  You only lock (which is an
</I>&gt;<i> expensive operation) if the value needs to be computed.
</I>&gt;<i> 
</I>&gt;<i>    Now, notice how we test for the value *inside* the lock.  This is
</I>&gt;<i> important because the value might have been initialized in a separate
</I>&gt;<i> thread before we reach lock.
</I>&gt;<i> 
</I>&gt;<i> Miguel.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> 
</I>




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001896.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
	<LI> Next message: <A HREF="001901.html">[Mono-list] Class library developers: locking issues to keep in mind
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1900">[ date ]</a>
              <a href="thread.html#1900">[ thread ]</a>
              <a href="subject.html#1900">[ subject ]</a>
              <a href="author.html#1900">[ author ]</a>
         </LI>
       </UL>
</body></html>
