<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HttpWebRequest.GetResponse%28%29%20can%20trigger%20an%0A%20uncatchable%20exception&In-Reply-To=CANkhFq_tSbLRXdQ5_UxRp5XezZJmWnk7Q_LzMeHMGMdkz8QCNg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="047338.html">
   <LINK REL="Next"  HREF="047341.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception</H1>
    <B>Christopher David Howie</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HttpWebRequest.GetResponse%28%29%20can%20trigger%20an%0A%20uncatchable%20exception&In-Reply-To=CANkhFq_tSbLRXdQ5_UxRp5XezZJmWnk7Q_LzMeHMGMdkz8QCNg%40mail.gmail.com"
       TITLE="[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception">me at chrishowie.com
       </A><BR>
    <I>Sun Jul 10 05:31:10 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="047338.html">[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception
</A></li>
        <LI>Next message: <A HREF="047341.html">[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47340">[ date ]</a>
              <a href="thread.html#47340">[ thread ]</a>
              <a href="subject.html#47340">[ subject ]</a>
              <a href="author.html#47340">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> On Sat, 9 Jul 2011 11:50:34 -0400, Gonzalo Paniagua Javier wrote:
&gt;<i> Not much I can do without a test case.
</I>
 I know.  :(  The worst bug is the one that only happens once in a blue 
 moon.

&gt;<i> I'd say that this is a problem reusing a connection and somehow 2
</I>&gt;<i> threads &quot;own&quot; the same stream. Set KeepAlive to false (and increase
</I>&gt;<i> the number of file descriptors! (ulimit)) and see if you can still
</I>&gt;<i> reproduce the problem. If it does not happen, bingo! Reduce the
</I>&gt;<i> 'maxconnections' setting via app.config file to 1 and begin as many
</I>&gt;<i> requests as possible to the same URL. If you can reproduce it this
</I>&gt;<i> way, it's easier to find when 2 threads are using the same stream.
</I>
 I'm using the following code:

 ----------&gt;8----------
 using System;
 using System.Linq;
 using System.Net;
 using System.Threading;

 internal class Program
 {
     private static string url;

     private const int THREAD_COUNT = 1000;

     private static void Main(string[] args)
     {
         ServicePointManager.DefaultConnectionLimit = 1;

         url = args.Length &gt; 0 ? args[0] : &quot;<A HREF="http://localhost/&quot;;">http://localhost/&quot;;</A>

         var threads = new Thread[THREAD_COUNT];

         for (int i = 0; i &lt; THREAD_COUNT; i++) {
             threads[i] = new Thread(WorkerThread);
             threads[i].Start();
         }

         for (int i = 0; i &lt; THREAD_COUNT; i++) {
             threads[i].Join();
         }
     }

     private static void WorkerThread()
     {
         for (;;) {
             var request = (HttpWebRequest)WebRequest.Create(url);
             request.KeepAlive = false;

             try {
                 using (request.GetResponse())
                     Console.Write('.');
             } catch {
                 Console.Write('!');
             }
         }
     }
 }
 ----------&gt;8----------

 So far (10+ minutes) no exception has been thrown by this test.  I'd be 
 open to suggestions on how to tweak it.

&gt;<i> Also check the values of the variables involved in that BlockCopy 
</I>&gt;<i> call
</I>&gt;<i> and the values of readBuffer* before the call.
</I>
 I know that readBufferOffset is -1.  I'm not sure about the others.  If 
 we can get a consistent repro then I'll be able to check pretty easily.

-- 
 Chris Howie
 <A HREF="http://www.chrishowie.com">http://www.chrishowie.com</A>
 <A HREF="http://en.wikipedia.org/wiki/User:Crazycomputers">http://en.wikipedia.org/wiki/User:Crazycomputers</A>

 If you correspond with me on a regular basis, please read this 
 document: <A HREF="http://www.chrishowie.com/email-preferences/">http://www.chrishowie.com/email-preferences/</A>

 PGP fingerprint: 2B7A B280 8B12 21CC 260A DF65 6FCE 505A CF83 38F5

 ------------------------------------------------------------------------
                     IMPORTANT INFORMATION/DISCLAIMER

 This document should be read only by those persons to whom it is 
 addressed.  If you have received this message it was obviously addressed 
 to you and therefore you can read it.

 Additionally, by sending an email to ANY of my addresses or to ANY 
 mailing lists to which I am subscribed, whether intentionally or 
 accidentally, you are agreeing that I am &quot;the intended recipient,&quot; and 
 that I may do whatever I wish with the contents of any message received 
 from you, unless a pre-existing agreement prohibits me from so doing.

 This overrides any disclaimer or statement of confidentiality that may 
 be included on your message.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="047338.html">[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception
</A></li>
	<LI>Next message: <A HREF="047341.html">[Mono-list] HttpWebRequest.GetResponse() can trigger an uncatchable exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47340">[ date ]</a>
              <a href="thread.html#47340">[ thread ]</a>
              <a href="subject.html#47340">[ subject ]</a>
              <a href="author.html#47340">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
