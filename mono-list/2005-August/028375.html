<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] WebControls.DataGrid and DataReader problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20WebControls.DataGrid%20and%20DataReader%20problems&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028373.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] WebControls.DataGrid and DataReader problems</H1>
    <B>Francisco Figueiredo Jr.</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20WebControls.DataGrid%20and%20DataReader%20problems&In-Reply-To="
       TITLE="[Mono-list] WebControls.DataGrid and DataReader problems">fxjrlists at yahoo.com.br
       </A><BR>
    <I>Wed Aug 31 22:41:16 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="028373.html">[Mono-list] WinFS
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28375">[ date ]</a>
              <a href="thread.html#28375">[ thread ]</a>
              <a href="subject.html#28375">[ subject ]</a>
              <a href="author.html#28375">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1



Hi all,


I'm getting some problems when using WebControls.DataGrid and a
DataReader as datasource.

The problem seems to be with the enumerator getting past the size of
reader when reading values to fill a grid.

I received a report from Jan Waiz about getting exceptions when using an
NpgsqlDataReader when using a grid and a setting PageSize and
VirtualItemCount properties.

When using a dataset as datasource this problem doesn't appear.


Sample test case:


//  THIS IS THE CODE THAT WORKS !!!!!!!!!!!!!!!!!!!!!!!!!
      //  Dont forget to disable above Source when trying this :-)
/*
      //  Get a Connection...
      NpgsqlConnection oConn = new NpgsqlConnection();
      //  ...with a guilty Connection-String
      oConn.ConnectionString = &quot;DRIVER={PostgreSQL};&quot; +
                               &quot;SERVER=127.0.0.1;&quot; +
                               &quot;UID=npgsql_tests;&quot; +
                               &quot;DATABASE=npgsql_tests&quot;;
      oConn.Open();

      DataSet oDSet = new DataSet();

      DataAdapter oAdap = new NpgsqlDataAdapter( &quot;SELECT * FROM
MyTable&quot;, oConn );
      oAdap.Fill( oDSet );

      // Normaly via a Count-Statement.
      DataGrid1.VirtualItemCount = 3;
      DataGrid1.PageSize = 10;
      //  Assign and bind Datareader
      DataGrid1.DataSource = oDSet;
      DataGrid1.DataBind();

      //  Finish. Close what has to be closing...
      oConn.Close();

=========================================================


  //  THIS IS THE CODE THAT DOESNT WORK
      //  Dont forget to disable below Source when trying this :-)

            //  Get a Connection...
                  Npgsql.NpgsqlConnection oConn = new
Npgsql.NpgsqlConnection();
                  //  ...with a guilty Connection-String
      oConn.ConnectionString = &quot;DRIVER={PostgreSQL};&quot; +
                               &quot;SERVER=127.0.0.1;&quot; +
                               &quot;UID=npgsql_tests;&quot; +
                               &quot;DATABASE=npgsql_tests&quot;;

                  oConn.Open();
                  //  Get a Command-Object
      Npgsql.NpgsqlCommand oCmnd = oConn.CreateCommand();
      //  Assign Statement
      oCmnd.CommandText = &quot;SELECT * FROM MyTable&quot;;

      //  Get a Datareader
      Npgsql.NpgsqlDataReader oRead = oCmnd.ExecuteReader();

      // Normaly via a Count-Statement.
      DataGrid1.VirtualItemCount = 3;
      DataGrid1.PageSize = 10;
      //  Assign and bind Datareader
      DataGrid1.DataSource = oRead;
      DataGrid1.DataBind();

      //  Finish. Close what has to be closing...
      oRead.Close();
                  oConn.Close();



The only difference between those tests are the datasource type.


This is the stack trace he receives:

//  What happens. If PageSize is larger than VirtaulItemCount, following
  //  Runtime-Error happens when running in Mono.
  //    System.InvalidOperationException: DataReader positioned beyond
end of result set.
  //    in &lt;0x00072&gt; Npgsql.NpgsqlDataReader:CheckHaveRow ()
  //    in &lt;0x00029&gt; Npgsql.NpgsqlDataReader:GetValues (System.Object[]
Values)
  //    in &lt;0x00031&gt; System.Data.Common.DbEnumerator:get_Current ()
  //    in &lt;0x00016&gt;
System.Web.UI.WebControls.PagedDataSource+PrivateIEnumeratorEnumerator:get_Current
()
  //    in &lt;0x006e2&gt;
System.Web.UI.WebControls.DataGrid:CreateControlHierarchy (Boolean
useDataSource)
  //    in &lt;0x0003f&gt;
System.Web.UI.WebControls.BaseDataList:OnDataBinding (System.EventArgs e)
  //    in &lt;0x00023&gt; System.Web.UI.WebControls.BaseDataList:DataBind ()
  //    in &lt;0x000b7&gt; NpgTest.Default:Page_Load (System.Object sender,
System.EventArgs e)
  //    in (wrapper delegate-invoke)
System.MulticastDelegate:invoke_void_object_EventArgs
(object,System.EventArgs)
  //    in &lt;0x0005c&gt; System.Web.UI.Control:OnLoad (System.EventArgs e)
  //    in &lt;0x00026&gt; System.Web.UI.Control:LoadRecursive ()
  //    in &lt;0x00212&gt; System.Web.UI.Page:InternalProcessRequest ()
  //    in &lt;0x000af&gt; System.Web.UI.Page:ProcessRequest
(System.Web.HttpContext context)
  //    in &lt;0x00233&gt;
System.Web.HttpApplication+ExecuteHandlerState:Execute ()
  //    in &lt;0x0007c&gt;
System.Web.HttpApplication+StateMachine:ExecuteState (IStateHandler
state, System.Boolean readysync)



After checking Npgsql logs, it seems that return value of
NpgsqlDataReader.Read() isn't being checked when it returns false when
there is no more row to be read. As this seems to be ignored, code tries
to read data again and NpgsqlDataReader throws an exception saying there
is no more data to read.


I tested that code with latest svn code and I could see that it is
already fixed.

I just wanted to confirm if this was really a bug with last released
code as with 1.1.8.3 this problem still exists.

Thanks in advance.



- --
Regards,

Francisco Figueiredo Jr.
Npgsql Lead Developer
<A HREF="http://gborg.postgresql.org/project/npgsql">http://gborg.postgresql.org/project/npgsql</A>
MonoBrasil Project Founder Member
<A HREF="http://monobrasil.softwarelivre.org">http://monobrasil.softwarelivre.org</A>


- -------------
&quot;Science without religion is lame;
religion without science is blind.&quot;

                  ~ Albert Einstein
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.6 (GNU/Linux)
Comment: Using GnuPG with Thunderbird - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iQEVAwUBQxZqTP7iFmsNzeXfAQL4owf/fyWBrem6m77ouo1SVFYgoPU7AV0jrHp0
mP+ipRc1y6agf+gu+tJLuknOwiR9xavGY3zuXIfk2+L4DLg8Yrp5spF/tKUZkCfu
dMutvevFP4IZDySUzFUn5Ydnp8osoFzxas7BH1Gq1joeChmopa+1aXDqSn6hRW1z
yRxEim/fpzEqj7viaTM7S/vcucRwfqyBPDQcdLqxOUUZYaNjlcaN0/5Rvf2pf6mp
4+fP1N0WLELuxJ/Z0tNwi0dtPPaUKEfbNaJgIgEFAoQ0QXMz3Nca0ag7V5lZM4z2
JjvixBptZO/+Q/ND4jY8EWMed66FyUFPn5gTfRMtV9sT/Aztb001rw==
=zPJo
-----END PGP SIGNATURE-----

	
	
		
_______________________________________________________ 
Yahoo! Acesso Gr&#225;tis - Internet r&#225;pida e gr&#225;tis. 
Instale o discador agora! <A HREF="http://br.acesso.yahoo.com/">http://br.acesso.yahoo.com/</A>
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028373.html">[Mono-list] WinFS
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28375">[ date ]</a>
              <a href="thread.html#28375">[ thread ]</a>
              <a href="subject.html#28375">[ subject ]</a>
              <a href="author.html#28375">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
