<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Multiplatform DllImport?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rweather%40zip.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="002268.html">
   <LINK REL="Next"  HREF="002260.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Multiplatform DllImport?
   </H1>
    <B>Rhys Weatherley
    </B> 
    <A HREF="mailto:rweather%40zip.com.au"
       TITLE="[Mono-list] Multiplatform DllImport?">rweather@zip.com.au
       </A><BR>
    <I>Sat, 24 Nov 2001 09:47:51 +1000</I>
    <P><UL>
        <LI> Previous message: <A HREF="002268.html">[Mono-list] Multiplatform DllImport?
</A></li>
        <LI> Next message: <A HREF="002260.html">[Mono-list] Intrinsicly Non-Portable?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2279">[ date ]</a>
              <a href="thread.html#2279">[ thread ]</a>
              <a href="subject.html#2279">[ subject ]</a>
              <a href="author.html#2279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Miguel de Icaza wrote:

&gt;<i> &gt;   How are we supposed to be dealing with classes which offer platform
</I>&gt;<i> &gt; services (e.g. System.Net.Sockets.Socket)? This class will need to
</I>&gt;<i> &gt; import not only things like socket, bind, listen, connect, but also
</I>&gt;<i> &gt; Win32 (Winsock) functions like WSAStartup and WSACleanup. I hate to
</I>&gt;<i> &gt; ask before looking so...
</I>&gt;<i>
</I>&gt;<i> At least on the Unix side of things we should be doing that using the
</I>&gt;<i> wrapper code in mono/mono/wrapper and maybe also for Windows
</I>&gt;<i> compatibility (this makes sure that enumeration constants from the
</I>&gt;<i> underlying OS are mapped correctly).
</I>
As another data point, I recently had to address the problem
of &quot;same function name, different library&quot; that is common
on Unix platforms for Portable.NET.  e.g. &quot;listen&quot; living in
&quot;libc&quot; on some platforms, and &quot;libsocket&quot; on others.

Instead of having a separate .cs file for every platform
to import the definition using PInvoke, I introduced a private
attribute called &quot;DllImportMap&quot;.  e.g.

[DllImportMap(&quot;winsock.dll&quot;, &quot;*-sunos-*&quot;, &quot;libsocket.so&quot;)]
[DllImportMap(&quot;winsock.dll&quot;, &quot;std-shared-object&quot;, &quot;libc.so&quot;)]
class SocketOps
{
    [DllImport(&quot;winsock.dll&quot;)]
    public int listen(int fd, int backlog);
}

This specifies that &quot;winsock.dll&quot; is the default if all
the engine knows about is Windows (e.g. Microsoft's).
It then provides a number of mapping instructions on
either the method or the class which map the Windows
names to Unix names (I've put it on the class here).

The standard Unix version is specified with the tag
&quot;std-shared-object&quot;, and the standard Windows version
is specified with &quot;std-win32-dll&quot;.  Overrides can be
specified by matching on the autoconf-chosen host
identifier. The CLR processes the instructions in order,
and uses the first it finds.

This doesn't solve the &quot;different function name,
same purpose&quot; problem, of course, but it does solve
a big part of the multi-platform import issues.

So as not to introduce too much embrace and extend,
I made the attribute &quot;floating&quot;.  That is, it can be in
any namespace.  This allows a &quot;private&quot; class to be
put into the importing assembly called something like
&quot;MyNamespace.DllImportMapAttribute&quot;.  This will
not pollute the global namespace, and so third party
programmers will not come to rely upon it by accident.

Cheers,

Rhys.





</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="002268.html">[Mono-list] Multiplatform DllImport?
</A></li>
	<LI> Next message: <A HREF="002260.html">[Mono-list] Intrinsicly Non-Portable?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2279">[ date ]</a>
              <a href="thread.html#2279">[ thread ]</a>
              <a href="subject.html#2279">[ subject ]</a>
              <a href="author.html#2279">[ author ]</a>
         </LI>
       </UL>
</body></html>
