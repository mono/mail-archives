<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] SqlDecimal problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:tim%40timcoleman.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="009252.html">
   <LINK REL="Next"  HREF="009253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] SqlDecimal problems
   </H1>
    <B>Tim Coleman
    </B> 
    <A HREF="mailto:tim%40timcoleman.com"
       TITLE="[Mono-list] SqlDecimal problems">tim@timcoleman.com
       </A><BR>
    <I>Wed, 23 Oct 2002 19:16:21 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="009252.html">[Mono-list] SqlDecimal problems
</A></li>
        <LI> Next message: <A HREF="009253.html">[Mono-list] Embed example dose not compile :(
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9256">[ date ]</a>
              <a href="thread.html#9256">[ thread ]</a>
              <a href="subject.html#9256">[ subject ]</a>
              <a href="author.html#9256">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 23 Oct 2002 22:34:30 +0300
ville &lt;<A HREF="mailto:vi64pa@koti.soon.fi">vi64pa@koti.soon.fi</A>&gt; wrote:

&gt;<i> 
</I>&gt;<i> Weird! I made test suite for SqlDecimal and it didn't work correctly. For 
</I>&gt;<i> example:
</I>&gt;<i> 
</I>&gt;<i> // FIXME: windows: Conversion overflow
</I>&gt;<i> AssertEquals  (&quot;#B03&quot;, Decimal.MaxValue, SqlDecimal.MaxValue.Value);
</I>&gt;<i> AssertEquals (&quot;#B04&quot;, Decimal.MinValue, SqlDecimal.MinValue.Value);
</I>&gt;<i> 
</I>&gt;<i> It is obvious that ms wont handle SqlDecimal internal value as a decimal,  but 
</I>&gt;<i> ain't this bug or what?
</I>&gt;<i> 
</I>&gt;<i> And another (much weirder):
</I>&gt;<i> 
</I>&gt;<i> // FIXME: 6464.6464 --&gt; 64646464 ??? with windows
</I>&gt;<i> AssertEquals (&quot;#N13a&quot;, (int)64646464, Test1.ToSqlInt32 ().Value);
</I>&gt;<i> // FIXME: 12.12m --&gt; 1212 ??? with windows
</I>&gt;<i> AssertEquals (&quot;#N13b&quot;, (int)1212, new SqlDecimal(12.12m).ToSqlInt32 ().Value);
</I>&gt;<i> 
</I>&gt;<i> and with ToInt64 or ToInt16 everything went alright.
</I>&gt;<i> 
</I>&gt;<i> somebody help me, please.
</I>&gt;<i> 
</I>
Heh,

If you look back at the archives from April or May when I originally implemented these classes, you will see I had quite a bit of trouble with SqlDecimal.

You see, the problem is that SqlDecimal is 128 bits.  The decimal type is only 96 bits.


Here's the contents of the mail I wrote

-----Original Message-----
 From: Tim Coleman [mailto:<A HREF="mailto:tcoleman@opentext.com">tcoleman@opentext.com</A>]
 Sent: Tuesday, May 07, 2002 8:48 PM
 To: <A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>
 Subject: System.Data.SqlTypes.SqlDecimal


 I have an issue with the System.Data.SqlTypes.SqlDecimal structure.
 It would seem that the appropriate internal representation would
 be to store the value as a decimal.  There's just one problem with
 this: decimals are 96 bit values while SqlDecimals can be 128 bit.

 Importantly, there are two constructors for SqlDecimal that take
 arrays of four integers representing the 128 bit value.  I've noticed,
 that even on .NET, if you pass in a value with the high 32 bits set
 to anything, you will get an OverflowException when you try to do
 things like get the Value of it.  However, what doesn't make sense
 is that you can actually write the value out to the console (!).
 What I would like to know is how this data is stored and displayed
 if you can't fit it into a decimal.  It's clear that MS does not 
 store it in a decimal, because you would get an overflow immediately.
 I could see that if the upper 32 bits are zero, then you could create
 the decimal cleanly using the first 96 bits.. but anyway, here's some
 code that I ran on CSC.  You can't run it on linux because I haven't
 got that part of the class library done yet (because of this problem).

 using System;
 using System.Data.SqlTypes;

 	class MainApp {
 		public static void Main ()
 		{
 			int[] bits = new int[4];
 			bits[0] = 1;
 			bits[1] = 1;
 			bits[2] = 1;
 			bits[3] = 1;
 			byte bPrecision = 38;
 			byte bScale = 10;
 			bool fPositive = true;

 			SqlDecimal x = new SqlDecimal (bPrecision, bScale, fPositive, bits);

 			// works correctly
 			System.Console.WriteLine (x);
 			
 			// throws an exception
 			try {
 				System.Console.WriteLine (x.Value);
 			} catch (OverflowException e) {
 				System.Console.WriteLine (e.Message);
 			}

 			bits[0] = 1;
 			bits[1] = 1;
 			bits[2] = 1;
 			bits[3] = 0;

 			x = new SqlDecimal (bPrecision, bScale, fPositive, bits);
 			
 			// works fine
 			System.Console.WriteLine (x.Value);
 		}
 	}

-- 
Tim Coleman &lt;<A HREF="mailto:tim@timcoleman.com">tim@timcoleman.com</A>&gt;                       [43.28 N 80.31 W]
BMath, Honours Combinatorics and Optimization, University of Waterloo
Software Developer, Global Services, Open Text Corporation
&quot;Under capitalism, man exploits man.  Under communism, it's just the
 opposite.&quot; -- J.K. Galbraith


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="009252.html">[Mono-list] SqlDecimal problems
</A></li>
	<LI> Next message: <A HREF="009253.html">[Mono-list] Embed example dose not compile :(
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9256">[ date ]</a>
              <a href="thread.html#9256">[ thread ]</a>
              <a href="subject.html#9256">[ subject ]</a>
              <a href="author.html#9256">[ author ]</a>
         </LI>
       </UL>
</body></html>
