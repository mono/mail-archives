<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: [DotGNU]Qt.dll verification errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="009125.html">
   <LINK REL="Next"  HREF="009131.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: [DotGNU]Qt.dll verification errors
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] Re: [DotGNU]Qt.dll verification errors">lupus@ximian.com
       </A><BR>
    <I>Thu, 17 Oct 2002 12:52:08 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="009125.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
        <LI> Next message: <A HREF="009131.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9128">[ date ]</a>
              <a href="thread.html#9128">[ thread ]</a>
              <a href="subject.html#9128">[ subject ]</a>
              <a href="author.html#9128">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/17/02 Rhys Weatherley wrote:
&gt;<i> The ECMA spec says that the &quot;DataSize&quot; member of an exception
</I>&gt;<i> block should be &quot;n * 12 + 4&quot; for a tiny format block, or &quot;n * 24 + 4&quot;
</I>&gt;<i> for a fat format block.  Qt.dll appears to have &quot;n * 24&quot; instead
</I>&gt;<i> in the fat format header.  This causes pnet to drop sections because
</I>&gt;<i> it thinks that they are &quot;truncated&quot;, which technically they are.
</I>
The spec also says:

24.4.5  Method Data Section  
At the next 4-byte boundary following the method body can be extra
method data sections. These method data 
sections start with a two byte header (1 byte flags, 1 byte for the
length of the actual data)  or a four byte header  
^^^^^^^^^^^^^^^^^^^^^^^^^
(1 byte for flags, and 3 bytes for length of the actual data). The first
                                   ^^^^^^^^^^^^^^^^^^^^^^^^^
byte determines the kind of the header, and 
what data is in the actual section:  

It may just be because I'm not a native speaker, but when there is a
header + data and someone talks about the &quot;length of the actual data&quot;
it quite clearly means the length refers to the length of data, not
data+header. In the table it contradict itself and says that the
DataSize needs the +4 (the header size).
In fact, a few lines below the code that parses the header I added a
comment:
	/* LAMESPEC: it seems the size includes the header */

&gt;<i> Mono appears to handle both correct and incorrect formats through
</I>&gt;<i> dumb luck also.  Around line 1500 of mono/metadata/metadata.c:
</I>&gt;<i> 
</I>&gt;<i>     mh-&gt;num_clauses = is_fat ? sect_data_len / 24: sect_data_len / 12;
</I>&gt;<i> 
</I>&gt;<i> If the value is &quot;n * 24&quot; or &quot;n * 24 + 4&quot;, the &quot;+ 4&quot; will be
</I>&gt;<i> truncated off and Mono will do the right thing.
</I>
There is nothing about dumb luck in that code: it does always the right
thing with any of the two interpretations of the spec.
I don't remember if (at the time I wrote the code) the ms tools produced
exception headers with the actual data length or added the header size.
The fact the peverify doesn't complain probably means that the behaviour
is fine (as long as it's done in the last section).
Anyway, I'll change reflection to output the header size as currently
produced by csc since it actually doesn't change anything for mono.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="009125.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
	<LI> Next message: <A HREF="009131.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9128">[ date ]</a>
              <a href="thread.html#9128">[ thread ]</a>
              <a href="subject.html#9128">[ subject ]</a>
              <a href="author.html#9128">[ author ]</a>
         </LI>
       </UL>
</body></html>
