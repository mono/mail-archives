<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: [DotGNU]Qt.dll verification errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rweather%40zip.com.au">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="009123.html">
   <LINK REL="Next"  HREF="009128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: [DotGNU]Qt.dll verification errors
   </H1>
    <B>Rhys Weatherley
    </B> 
    <A HREF="mailto:rweather%40zip.com.au"
       TITLE="[Mono-list] Re: [DotGNU]Qt.dll verification errors">rweather@zip.com.au
       </A><BR>
    <I>Thu, 17 Oct 2002 18:11:58 +1000</I>
    <P><UL>
        <LI> Previous message: <A HREF="009123.html">[Mono-list] patents on ISO/ECMA C#
</A></li>
        <LI> Next message: <A HREF="009128.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9125">[ date ]</a>
              <a href="thread.html#9125">[ thread ]</a>
              <a href="subject.html#9125">[ subject ]</a>
              <a href="author.html#9125">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="mailto:gopalv82@symonds.net">gopalv82@symonds.net</A> wrote:

&gt;<i> Well it works fine when I compile it with cscc ... The errant
</I>&gt;<i> code is in Qt.dll in the QT# .debs distro ...
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://prdownloads.sourceforge.net/qtcsharp/qtsharp_0.5-1_i386.deb?download">http://prdownloads.sourceforge.net/qtcsharp/qtsharp_0.5-1_i386.deb?download</A>
</I>&gt;<i> 
</I>&gt;<i> I am unable to test it as I have an old version of QT and am
</I>&gt;<i> unable to compile qtc ... But the error was reported on ilverify
</I>&gt;<i> of the Qt.dll
</I>&gt;<i> 
</I>&gt;<i> I think it is a bug with the image read ? .. viz I'm getting '-1'
</I>&gt;<i> in member.c but no '.try' in the dissassembled code ...
</I>
OK, found it.  Sort of.  I think it's a bug in mcs (sorry guys :-) ).

The ECMA spec says that the &quot;DataSize&quot; member of an exception
block should be &quot;n * 12 + 4&quot; for a tiny format block, or &quot;n * 24 + 4&quot;
for a fat format block.  Qt.dll appears to have &quot;n * 24&quot; instead
in the fat format header.  This causes pnet to drop sections because
it thinks that they are &quot;truncated&quot;, which technically they are.

Pnet's behaviour appears to be consistent with MS'es compiler.
Although I admit my version of csc is a little old.  Weird thing
is, MS'es diassembler can handle the qtsharp code.  Maybe their
range checking isn't all that great and so they process it through
sheer dumb luck?

Mono appears to handle both correct and incorrect formats through
dumb luck also.  Around line 1500 of mono/metadata/metadata.c:

    mh-&gt;num_clauses = is_fat ? sect_data_len / 24: sect_data_len / 12;

If the value is &quot;n * 24&quot; or &quot;n * 24 + 4&quot;, the &quot;+ 4&quot; will be
truncated off and Mono will do the right thing.

So, in summary, cscc-compiled code appears to be ECMA-compatible and
should work on both pnet and Mono just fine, but mcs-compiled code
won't work on pnet because my range-checking is a lot stricter.
Unless I've missed something obvious, of course.  I'm willing to
be convinced that I'm wrong.

I could add a &quot;mcs bug filter&quot; to pnet I suppose, but it would
probably be better for mcs to be fixed to generate ECMA-compatible
exception blocks.

Cheers,

Rhys.



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="009123.html">[Mono-list] patents on ISO/ECMA C#
</A></li>
	<LI> Next message: <A HREF="009128.html">[Mono-list] Re: [DotGNU]Qt.dll verification errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9125">[ date ]</a>
              <a href="thread.html#9125">[ thread ]</a>
              <a href="subject.html#9125">[ subject ]</a>
              <a href="author.html#9125">[ author ]</a>
         </LI>
       </UL>
</body></html>
