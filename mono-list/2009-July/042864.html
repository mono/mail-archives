<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Not all subscribers to event are being called...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Not%20all%20subscribers%20to%20event%20are%20being%20called...&In-Reply-To=49F8FE3E.1010809%40inovonics.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042858.html">
   <LINK REL="Next"  HREF="042872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Not all subscribers to event are being called...</H1>
    <B>Ryan Kirkpatrick</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Not%20all%20subscribers%20to%20event%20are%20being%20called...&In-Reply-To=49F8FE3E.1010809%40inovonics.com"
       TITLE="[Mono-list] Not all subscribers to event are being called...">ryan.kirkpatrick at inovonics.com
       </A><BR>
    <I>Mon Jul  6 18:06:05 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="042858.html">[Mono-list] Porting PyGtk tutorial to GTK# - Help needed
</A></li>
        <LI>Next message: <A HREF="042872.html">[Mono-list] Not all subscribers to event are being called...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42864">[ date ]</a>
              <a href="thread.html#42864">[ thread ]</a>
              <a href="subject.html#42864">[ subject ]</a>
              <a href="author.html#42864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ryan Kirkpatrick wrote:
&gt;<i> While porting a .NET library I wrote from Windows (VS2008) to Linux 
</I>&gt;<i> (Mono 2.x) I have encountered a strange problem.
</I>
This is a follow-up to my report of this problem about two months ago. I
ended needing a newer version of Mono than 2.2 (namely for DbLinq), so I
had to find a solution to this problem. Having more free CPU cycles than
brain cycles, I set a server to downloading different revisions from the
Mono SVN trunk (starting with the HEAD and moving back towards the 2.2
branch), building them, and testing them with my code. After a rough
binary search, I found the revision that broke my code, 123349, with
this log entry:

2009-01-14  Mark Probst  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mark.probst at gmail.com</A>&gt;
method-to-ir.c: Handle delegate invocation optimization earlier,
otherwise it would be handled (much more slowly) by the final/sealed
optimization.

This change swapped the order of the optimized delegate invocation with
the standard (non-virtual) delegate invocation. Apparently that
optimized version, using delegate trampolines, broke my code. This
optimization is only enabled if
MONO_ARCH_HAVE_CREATE_DELEGATE_TRAMPOLINE is defined (in my case in
mini-x86.h), and when it was not enabled (by commenting out the
#define), then current versions of Mono (namely the SVN trunk HEAD) was
able to run my code without issue.

I tried, but failed (again, short on brain cycles :), to understand how
this change was breaking my code. Apparently these delegate trampoline
optimizations and the events in my code do not mix well. I do not have a 
test case I can provide, so if some one can resolve this issue based on 
the above (and original problem description below), that would be great. 
Otherwise I will just continue to disable the delegate trampolines 
(performance without them is fine). Thanks!

&gt;<i> Here is a high-level description of what is going on:
</I>&gt;<i> 
</I>&gt;<i> *) Class Top has an event Run that can be subscribed by 'public'.
</I>&gt;<i> 
</I>&gt;<i> *) Class TopPlus inherits from Top and subscribes to Run.
</I>&gt;<i> 
</I>&gt;<i> *) Class Side takes TopPlus as a parameter to its constructor and 
</I>&gt;<i> subscribes to TopPlus.Run.
</I>&gt;<i> 
</I>&gt;<i> *) Now, I create an instance of TopPlus, 'tp', and use that instance
</I>&gt;<i> in creating an instance of Side, 's'.
</I>&gt;<i> 
</I>&gt;<i> *) Finally, I call tp.Run(), and TopPlus' subscribe gets called, but
</I>&gt;<i>  Side's subscriber does not get run.
</I>&gt;<i> 
</I>&gt;<i> It is a bit more complex than this, but that is the gist of what is 
</I>&gt;<i> going on. What is curious is that I observed this behavior in
</I>&gt;<i> versions of Mono older than 2.2, but it did not occur in 2.2 (i.e.
</I>&gt;<i> both subscribers got called). I had figured the issue had already
</I>&gt;<i> been found and fixed, but today in testing with Mono 2.4, this
</I>&gt;<i> behavior (i.e. only TopPlus' subscriber being called) returned! I
</I>&gt;<i> have run mono with the --trace option to verify Side's subscriber is
</I>&gt;<i> indeed never being called when the event is called.
</I>&gt;<i> 
</I>&gt;<i> I can't provide code as it is proprietary, and my attempts to create
</I>&gt;<i> a simple test case so far have failed. I have narrowed it down to a 
</I>&gt;<i> runtime issue, as it does not matter if the library is built with
</I>&gt;<i> Mono 2.2, Mono 2.4, or VS2008. It is the version of '/usr/bin/mono'
</I>&gt;<i> that is used that affects this behavior. I know this is all a bit
</I>&gt;<i> vague, but before I write a long winded, detailed explanation of my
</I>&gt;<i> library's architecture I would like to know if the above brings any
</I>&gt;<i> know issues or workarounds to mind. Thanks!
</I>
-- 
Ryan Kirkpatrick &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">ryan.kirkpatrick at inovonics.com</A>&gt;, 303-209-7190
Senior Design Engineer
Inovonics Wireless Corporation

This email transmission and any documents, files or previous email
messages attached to it contains information that is confidential
or legally privileged. If you are not the intended recipient or a
person responsible for delivering this transmission to the intended
recipient, you are hereby notified that you must not read this
transmission and that any disclosure, copying, printing,
distribution or use of this transmission is strictly prohibited. If
you have received this transmission in error, please immediately
notify the sender by telephone or return email and delete the
original transmission and its attachments without reading or saving
in any manner. Thank you.
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042858.html">[Mono-list] Porting PyGtk tutorial to GTK# - Help needed
</A></li>
	<LI>Next message: <A HREF="042872.html">[Mono-list] Not all subscribers to event are being called...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42864">[ date ]</a>
              <a href="thread.html#42864">[ thread ]</a>
              <a href="subject.html#42864">[ subject ]</a>
              <a href="author.html#42864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
