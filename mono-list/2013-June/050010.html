<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Sockets severe non-linear performance degradation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Sockets%20severe%20non-linear%20performance%20degradation&In-Reply-To=%3CCACmR%2BBAWBP4Cpp_EWNvqPWyiQRC9T85DqX91BrjWHSufw_EB3Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="050008.html">
   <LINK REL="Next"  HREF="050009.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Sockets severe non-linear performance degradation</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Sockets%20severe%20non-linear%20performance%20degradation&In-Reply-To=%3CCACmR%2BBAWBP4Cpp_EWNvqPWyiQRC9T85DqX91BrjWHSufw_EB3Q%40mail.gmail.com%3E"
       TITLE="[Mono-list] Sockets severe non-linear performance degradation">kumpera at gmail.com
       </A><BR>
    <I>Tue Jun 25 15:29:49 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="050008.html">[Mono-list] Sockets severe non-linear performance degradation
</A></li>
        <LI>Next message: <A HREF="050009.html">[Mono-list] Mono SIGABRT Error when using SystemSounds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50010">[ date ]</a>
              <a href="thread.html#50010">[ thread ]</a>
              <a href="subject.html#50010">[ subject ]</a>
              <a href="author.html#50010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please file a bug with a test case if you think it's a bug on mono's stack.


On Mon, Jun 24, 2013 at 10:58 AM, Ian Gardner &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">ian at cambsgardner.me.uk</A>&gt;wrote:

&gt;<i> Platform: linux ubuntu 12.04 AMD64
</I>&gt;<i> Mono version 2.10.8.1
</I>&gt;<i>
</I>&gt;<i> I have just started with C# and have a simple client-server test app
</I>&gt;<i> that measures throughput and latency from the client for a typical
</I>&gt;<i> send+recieve message scenario. As I increase the message size to more
</I>&gt;<i> than the socket send+recieve buffer size performance falls off a cliff,
</I>&gt;<i> whereas I would expect latency (round trip time) to increase approx
</I>&gt;<i> linearly with the ratio round_up((message size) / (socket buf size))
</I>&gt;<i> and throughput (bytes/sec) to stay approx constant.
</I>&gt;<i>
</I>&gt;<i> I set socket buffer send and receive sizes = N
</I>&gt;<i>
</I>&gt;<i> When message size &lt; N:
</I>&gt;<i> Roundtrip Latency: 1-3 milliseconds
</I>&gt;<i> Throughput: ~2 Mbyte/sec
</I>&gt;<i>
</I>&gt;<i> This compares well with my equivalent java/C code on the same machine,
</I>&gt;<i> about equalling java as I would expect and being a bit slower than
</I>&gt;<i> native C sockets (I can comfortably get sub-millisecond round trips
</I>&gt;<i> with C, throughput around 5Mbyte/sec)
</I>&gt;<i>
</I>&gt;<i> When N &lt; message size &lt; 2 * N:
</I>&gt;<i> Roundtrip Latency: 400-1000 milliseconds
</I>&gt;<i> Throughput: 50-100 Kbyte/sec
</I>&gt;<i>
</I>&gt;<i> Machine shows very low CPU usage so it appears that the IO subsystem is
</I>&gt;<i> not rescheduling a thread blocked on IO in a timely manner. This
</I>&gt;<i> puzzles me since a direct mapping of the Socket methods onto the C
</I>&gt;<i> library counterparts should achieve what is required. So have I missed
</I>&gt;<i> some critical option, or does mono do something with IO/thread mapping
</I>&gt;<i> onto the OS that is causing this?
</I>&gt;<i>
</I>&gt;<i> Some more detail on my test app:
</I>&gt;<i> The basic loop I am timing is.
</I>&gt;<i> 1. Client writes random sized buffer to socket
</I>&gt;<i> 2. Server reads data
</I>&gt;<i> 3. Server writes random sized buffer to socket
</I>&gt;<i> 4. Client reads data and stops timer
</I>&gt;<i>
</I>&gt;<i> A message consists of a small fixed header indicating the size of
</I>&gt;<i> following data.
</I>&gt;<i> Thus:
</I>&gt;<i>   write requires one system call since I coalesce header+data
</I>&gt;<i>   read requires two system calls, one for fixed header and one for
</I>&gt;<i>     variable data
</I>&gt;<i>
</I>&gt;<i> Both client and server sockets are given the same options:
</I>&gt;<i>   socket.ReceiveBufferSize = 16000;
</I>&gt;<i>   socket.SendBufferSize = 16000;
</I>&gt;<i>   socket.NoDelay = true;
</I>&gt;<i>   socket.SetSocketOption(**SocketOptionLevel.Socket,
</I>&gt;<i>                          SocketOptionName.DontLinger, false);
</I>&gt;<i>
</I>&gt;<i> I have tried three basic approaches to the read/write loop.
</I>&gt;<i> A. socket.Blocking = true and use socket.Receive()/socket.Send()
</I>&gt;<i> B. socket.Blocking = true/false and use the async versions of
</I>&gt;<i>    socket.Receive()/socket.Send()**. I.e. socket.BeginReceive() followed
</I>&gt;<i>    immediately by socket.EndReceive()
</I>&gt;<i> C. socket.Blocking = false and use socket.Receive()/socket.Send() and
</I>&gt;<i>    socket.Poll(SelectMode.**SelectRead or SelectWrite)
</I>&gt;<i>    to wait for data where appropriate.
</I>&gt;<i>
</I>&gt;<i> All three approaches show the same problem.
</I>&gt;<i> Both A and C map to the same approach I have used in native sockets
</I>&gt;<i> programming, and B may map to C internally so I did not really expect
</I>&gt;<i> it to be any better.
</I>&gt;<i>
</I>&gt;<i> A few more points:
</I>&gt;<i> 1. The code is operating correctly in the sense that it reliably
</I>&gt;<i>    transfers data (which I CRC32 check), it is solely performance which
</I>&gt;<i>    is the problem.
</I>&gt;<i> 2. I use the high resolution System.Diagnostics.Stopwatch.**GetTimestamp()
</I>&gt;<i> 3. I call an explicit System.GC.Collect() before starting each timed
</I>&gt;<i>    test to reduce chances of GC skewing the timings.
</I>&gt;<i> 4. I have tested over a standard TCP socket on main machine address and
</I>&gt;<i>    also on local loopback address, no change.
</I>&gt;<i> 5. I have not tested on windows since I purged microsoft from my life
</I>&gt;<i>    several years ago and currently have no windows machine.
</I>&gt;<i> 6. It is not possible from test code to know if delay is in read, write
</I>&gt;<i>    or both read+write blocking.
</I>&gt;<i>
</I>&gt;<i> Any help would be appreciated.
</I>&gt;<i>
</I>&gt;<i> ______________________________**_________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/**mailman/listinfo/mono-list&lt;http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/**mailman/listinfo/mono-list&lt;http://lists.ximian.com/mailman/listinfo/mono-list</A>&gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20130625/b06ecdf5/attachment.html">http://lists.ximian.com/pipermail/mono-list/attachments/20130625/b06ecdf5/attachment.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="050008.html">[Mono-list] Sockets severe non-linear performance degradation
</A></li>
	<LI>Next message: <A HREF="050009.html">[Mono-list] Mono SIGABRT Error when using SystemSounds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50010">[ date ]</a>
              <a href="thread.html#50010">[ thread ]</a>
              <a href="subject.html#50010">[ subject ]</a>
              <a href="author.html#50010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
