<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Private key failure SslStream based authentication on Mono/UbuntuLinux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Private%20key%20failure%20SslStream%20based%20authentication%0A%20on%20Mono/UbuntuLinux&In-Reply-To=BANLkTikCMxM%3Du4HK3r6KcC%3DbC-UWEoL8Gg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="047119.html">
   <LINK REL="Next"  HREF="047130.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Private key failure SslStream based authentication on Mono/UbuntuLinux</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Private%20key%20failure%20SslStream%20based%20authentication%0A%20on%20Mono/UbuntuLinux&In-Reply-To=BANLkTikCMxM%3Du4HK3r6KcC%3DbC-UWEoL8Gg%40mail.gmail.com"
       TITLE="[Mono-list] Private key failure SslStream based authentication on Mono/UbuntuLinux">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Thu May 26 16:31:40 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="047119.html">[Mono-list] Private key failure SslStream based authentication on	Mono/UbuntuLinux
</A></li>
        <LI>Next message: <A HREF="047130.html">[Mono-list] Private key failure SslStream based authentication	on Mono/UbuntuLinux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47120">[ date ]</a>
              <a href="thread.html#47120">[ thread ]</a>
              <a href="subject.html#47120">[ subject ]</a>
              <a href="author.html#47120">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Chirag,

On Thu, 2011-05-26 at 13:17 -0700, Chirag Patel wrote:
&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> I am working on migrating my .NET based windows service to mono and linux.
</I>&gt;<i> 
</I>&gt;<i> I am using SslStream and its BeginAuthenticateServer method.
</I>&gt;<i> 
</I>&gt;<i> Exception: The authentication or decryption has failed.
</I>&gt;<i> Inner Exception: Server certificate Private Key unavailable.
</I>&gt;<i> at Mono.Security.Protocol.Tls.Handshake.Server.TlsClientKeyExchange.ProcessAsSsl3
</I>&gt;<i> () [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i>   at Mono.Security.Protocol.Tls.Handshake.HandshakeMessage.Process ()
</I>&gt;<i> [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i>   at (wrapper remoting-invoke-with-check)
</I>&gt;<i> Mono.Security.Protocol.Tls.Handshake.HandshakeMessage:Process ()
</I>&gt;<i>   at Mono.Security.Protocol.Tls.ServerRecordProtocol.ProcessHandshakeMessage
</I>&gt;<i> (Mono.Security.Protocol.Tls.TlsStream handMsg) [0x00000] in &lt;filename
</I>&gt;<i> unknown&gt;:0
</I>&gt;<i>   at Mono.Security.Protocol.Tls.RecordProtocol.InternalReceiveRecordCallback
</I>&gt;<i> (IAsyncResult asyncResult) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="http://lists.ximian.com/pipermail/mono-list/2007-February/034278.html]">http://lists.ximian.com/pipermail/mono-list/2007-February/034278.html]</A>
</I>&gt;<i> 
</I>&gt;<i> I see that Sebastien has pointed out using alternate
</I>&gt;<i> Mono.Security.Protocol.Tls.SslServerStream class,
</I>&gt;<i> and its delegate to fetch private key. (because of difference between
</I>&gt;<i> linux vs. windows handling of certs.)
</I>
That's an alternative, not the best, but it has quite a bit of source
code using it (e.g. xsp) and is easy to adapt (to whatever source you're
loading the private key from).

&gt;<i> What is next? Just use the server certificate from SslServerStream
</I>&gt;<i> property, and dispose the stream?
</I>
No, if you start using SslServerStream then you'll need to use it
completely (forget SslStream).

&gt;<i> And continue using original Microsoft SslStream?
</I>
That's another choice and needs a different solution :)

&gt;<i> Or
</I>&gt;<i> I just have to use Mono's SslServerStream and manually write read
</I>&gt;<i> &quot;any/irrelevant&quot; data to proceed with authentication?
</I>
No

&gt;<i> I am using PFX file. I did include private key. So, Do I even need to
</I>&gt;<i> use the delegate to load private key separately??
</I>&gt;<i> (How can I debug whether the loaded X509Certificate instance has the
</I>&gt;<i> private key loaded.)
</I>&gt;<i> 
</I>&gt;<i> I have also tried this with a Verisign issued real certificate. But
</I>&gt;<i> since that entire thing including export was done on Windows, I tried
</I>&gt;<i> my code with self-signed (linux - openssl) cert.
</I>
Two things comes to mind:

1. make sure Mono can read your PKCS12 file (e.g. load it using
X509Certificate2 and dump its properties). This is important because
Mono's ASN.1 implementation does not support &quot;indefinite length&quot; and
some tools generates them.

2. When using SslStream + PKCS12 also make sure you're using
X509Certificate2 (***2*** not X509Certificate). This will ensure the
private key, if present, will be loaded in memory and will let SslStream
use it.

Sebastien

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="047119.html">[Mono-list] Private key failure SslStream based authentication on	Mono/UbuntuLinux
</A></li>
	<LI>Next message: <A HREF="047130.html">[Mono-list] Private key failure SslStream based authentication	on Mono/UbuntuLinux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47120">[ date ]</a>
              <a href="thread.html#47120">[ thread ]</a>
              <a href="subject.html#47120">[ subject ]</a>
              <a href="author.html#47120">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
