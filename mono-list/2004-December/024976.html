<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Support for marshalling of C# string to unmanaged
 wchar_t on Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="024965.html">
   <LINK REL="Next"  HREF="024978.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Support for marshalling of C# string to unmanaged
 wchar_t on Linux
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] Support for marshalling of C# string to unmanaged
 wchar_t on Linux">jonpryor@vt.edu
       </A><BR>
    <I>Thu, 16 Dec 2004 21:22:10 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="024965.html">[Mono-list] Support for marshalling of C# string to unmanaged wchar_t on Linux
</A></li>
        <LI> Next message: <A HREF="024978.html">[Mono-list] Support for marshalling of C# string to unmanaged
 wchar_t on Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24976">[ date ]</a>
              <a href="thread.html#24976">[ thread ]</a>
              <a href="subject.html#24976">[ subject ]</a>
              <a href="author.html#24976">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Your code is buggy, but I'll tackle it anyway. :-)

On Thu, 2004-12-16 at 13:12 +0000, Kala B wrote:
&gt;<i> Hi,
</I>&gt;<i> Does mono support marshalling of C# string to
</I>&gt;<i> unmanaged wchar_t on Linux? 
</I>
No.  Actually, I was surprised it ran at all (I was expecting a
g_assert_not_reached() message), but once I ran it, the problem became
clear: When Mono marshals to CharSet.Unicode, it doesn't marshal to a
Unix wchar_t, it marshals to a Windows wchar_t.

Wchar_t on most Unix platforms is 4 bytes (32-bits), while it's 2 bytes
(16-bits) on Windows.  This is easy for Mono to do (as it stores all
strings as 16-bit Unicode strings internally), and difficult for lots of
other people.

Though wchar_t has enough problems in Unix/Linux that I've been told to
avoid it.  It's more trouble than it's worth -- sticking with UTF-8 is
far easier to do.  (Then there's the immortal question of how to
portably convert between wchar_t* and char*.  You could use wcstombs,
but the standard doesn't say what encoding it'll use, which makes it
nearly useless for most practical purposes...)

&gt;<i> It does not seem to work. Consider the following
</I>&gt;<i> sample code, 
</I>&gt;<i> ( contents of 3 files ) 
</I>&gt;<i> 1. chash.cs
</I>&gt;<i>    This C# code makes a call to a C API, which takes a
</I>&gt;<i> wchar_t[].
</I>&gt;<i> 2. testlib.c
</I>&gt;<i>    This is the C code which implements the C API.
</I>&gt;<i> 3. makefile
</I>&gt;<i>    to build the library and C# exe.
</I>
&lt;snip/&gt;

&gt;<i> Contents of testlib.c
</I>&gt;<i> ---------------------
</I>&gt;<i> #include &lt;stdio.h&gt;
</I>&gt;<i> #include &lt;wchar.h&gt;
</I>&gt;<i> 
</I>&gt;<i> typedef struct _id
</I>&gt;<i> {
</I>&gt;<i>     int len;
</I>&gt;<i>     wchar_t name[256];
</I>
Change &quot;name&quot; to the following and things work better:

	unsigned char name[256];
&gt;<i> }Id;
</I>&gt;<i> 
</I>&gt;<i> int TestFn(Id *id)
</I>&gt;<i> {
</I>&gt;<i>     printf(&quot;%s\t%S\t%d\n&quot;,__func__,id-&gt;name,id-&gt;len);
</I>
This printf is broken -- %S isn't valid.  %ls is the correct
standardized way to print a wchar_t string, but since name isn't a
wchar_t[] it won't work anyway.  So we'll change it to make it nicer:

	printf (&quot;%s\t%d\n&quot;, __func__, id-&gt;len);
	for (int i = 0; i &lt; id-&gt;len; ++i)
		printf (&quot;\t%.3i: %c\n&quot;, i, (char) id-&gt;name[i]);

&gt;<i>     printf(&quot;wcslen returns.. %d\n&quot;,strlen(id-&gt;name));
</I>
Besides, you're not even using wcslen here, you're using strlen here.
OF COURSE it'll return &quot;1&quot; -- it'll hit the &quot;null&quot; embedded in the first
wide character.

&gt;<i> Could you please help? 
</I>&gt;<i> If marshalling is not supported, could you please
</I>&gt;<i> suggest some alternate solution to solve the issue?
</I>
Alternate solution: Use UTF-8.  Lots of libraries support it, it
requires minimal changes and support, and most other libraries/platforms
are migrating toward it (see Gnome and KDE).  The only reason to not use
UTF-8 is portability with Windows, which makes it easier to use the
WCHAR type, but Windows still supports UTF-8 in its conversion
functions.

 - Jon



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="024965.html">[Mono-list] Support for marshalling of C# string to unmanaged wchar_t on Linux
</A></li>
	<LI> Next message: <A HREF="024978.html">[Mono-list] Support for marshalling of C# string to unmanaged
 wchar_t on Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24976">[ date ]</a>
              <a href="thread.html#24976">[ thread ]</a>
              <a href="subject.html#24976">[ subject ]</a>
              <a href="author.html#24976">[ author ]</a>
         </LI>
       </UL>
</body></html>
