<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: bug report for new JIT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013323.html">
   <LINK REL="Next"  HREF="013329.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: bug report for new JIT
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] Re: bug report for new JIT">lupus@ximian.com
       </A><BR>
    <I>Wed, 9 Apr 2003 15:50:04 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="013323.html">[Mono-list] Re: bug report for new JIT
</A></li>
        <LI> Next message: <A HREF="013329.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13324">[ date ]</a>
              <a href="thread.html#13324">[ thread ]</a>
              <a href="subject.html#13324">[ subject ]</a>
              <a href="author.html#13324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/09/03 dietmar wrote:
&gt;<i> &gt; solve also other issues, like the need for the icall for the
</I>&gt;<i> &gt; process_guid lluis found recently and it would lower memory usage).
</I>&gt;<i> &gt; Or we can do it just for the string intern pool: have it shared across
</I>&gt;<i> &gt; appdomains (it should not be too complex).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; And since this is done at compile time it's way faster than your
</I>&gt;<i> &gt; proposed workaround that needs to call ldstr for each of the case stmts
</I>&gt;<i> &gt; every time the code is executed.
</I>&gt;<i> 
</I>&gt;<i> We already do that, but this does not solve the problem with multiple
</I>&gt;<i> domains and shared code. So it is not faster, or I don't understand what
</I>&gt;<i> you talk about.
</I>
For shared code your solution results in this code:
	mono_ldstr (...);
	mono_ldstr (...);
	... repeat for each string in the switch ...
	check isinterned

Note that the mono_ldstr() calls could be easyly in the tens or more, like in
mcs and corlib. With the other solutions the mono_ldstr calls are done
at method compile time, not each time the method is executed, so it's
faster.

I just committed a simple solution to cvs that does a lazy sync of the
intern table across appdomains, it's not the best solution (that would
be having the root domain and domain-independent strings), but it works
and the overhead is:
	*) a loop over the existing appdomains when isinterned() is
	called on a string interned in a domain different from the
	current one (this happens only the first time)
	*) a loop over the existing appdomains when isinterned() is
	called on a string that was not interned. I guess we'll have
	many other scalability issues to fix before hitting this one
	when we'll have hundreds of appdomains running....

For AOT, you'll have to save in the shared library the tokens of the
ldstr-referenced strings together with each method and when the method
is loaded, you just call mono_ldstr() on the string tokens associated
with the method.

&gt;<i> &gt; But this would not solve the issue, since one can always write the
</I>&gt;<i> &gt; (correct) IL code mcs currently produces and the bug resurfaces.
</I>&gt;<i> 
</I>&gt;<i> Well, &quot;correct&quot; is the wrong word - this is just how you define correct
</I>&gt;<i> behaviour. I think using the C# compiler to handle the issue is much
</I>
It's not me that defined the behaviour of the CLR, though:-)

&gt;<i> An performance of that approach is faster, because you only slow down
</I>&gt;<i> code which uses switch statements on strings (which is quite seldom),
</I>&gt;<i> whereas the other approach slows down code all code containing ldstr
</I>&gt;<i> opcodes.
</I>
Nope, see above for the performance evaluation:
	num_switch_cases mono_ldstr() calls (always)
vs
	num_appdomains hash table lookups when isintern fails
And non-shared code is not affected.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013323.html">[Mono-list] Re: bug report for new JIT
</A></li>
	<LI> Next message: <A HREF="013329.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13324">[ date ]</a>
              <a href="thread.html#13324">[ thread ]</a>
              <a href="subject.html#13324">[ subject ]</a>
              <a href="author.html#13324">[ author ]</a>
         </LI>
       </UL>
</body></html>
