<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Passing structures to pinvoke (or: mono bug)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pbaena%40uol.com.ar">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013210.html">
   <LINK REL="Next"  HREF="013220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Passing structures to pinvoke (or: mono bug)
   </H1>
    <B>Pablo Baena
    </B> 
    <A HREF="mailto:pbaena%40uol.com.ar"
       TITLE="[Mono-list] Passing structures to pinvoke (or: mono bug)">pbaena@uol.com.ar
       </A><BR>
    <I>01 Apr 2003 05:24:01 +0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="013210.html">[Mono-list] A present for Nick - or - Gtk# NUnit GUI clone
</A></li>
        <LI> Next message: <A HREF="013220.html">[Mono-list] Passing structures to pinvoke (or: mono bug)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13213">[ date ]</a>
              <a href="thread.html#13213">[ thread ]</a>
              <a href="subject.html#13213">[ subject ]</a>
              <a href="author.html#13213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-FYLieRvMdCbjWjopjgsl
Content-Type: multipart/alternative; boundary=&quot;=-PvCdiUSTvCR1VWtTQzgy&quot;


--=-PvCdiUSTvCR1VWtTQzgy
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Finally, I can pass a class to pinvoke as an 'out' parameter. Attached
are the samples that runs on .NET, but still won't run on mono.

Cheers!


--=-PvCdiUSTvCR1VWtTQzgy
Content-Type: text/html; charset=utf-8
Content-Transfer-Encoding: 7bit

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 TRANSITIONAL//EN&quot;&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
  &lt;META HTTP-EQUIV=&quot;Content-Type&quot; CONTENT=&quot;text/html; CHARSET=UTF-8&quot;&gt;
  &lt;META NAME=&quot;GENERATOR&quot; CONTENT=&quot;GtkHTML/1.1.7&quot;&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
Finally, I can pass a class to pinvoke as an 'out' parameter. Attached are the samples that runs on .NET, but still won't run on mono.&lt;BR&gt;
&lt;BR&gt;
Cheers!&lt;BR&gt;
&lt;BR&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;

--=-PvCdiUSTvCR1VWtTQzgy--

--=-FYLieRvMdCbjWjopjgsl
Content-Disposition: attachment; filename=struct.c
Content-Type: text/x-c; name=struct.c; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit


#include &lt;stdio.h&gt;
typedef struct
{
	char* str;
	int i;
} test_arr_t;
 
typedef struct
{
		test_arr_t* arr;
		int nr_of_arrs;
} test_t;

int modify_it (test_t** testme)
{
	test_t* ptest = (test_t *) malloc (sizeof (test_t));
	if (ptest==NULL) {
		printf (&quot;coño\n&quot;);
		return 0;
	}
	
	ptest-&gt;arr = (test_arr_t *) malloc (2 * sizeof (test_arr_t));
	ptest-&gt;arr[0].i = 1;
	ptest-&gt;arr[0].str = (char *) malloc (sizeof(char)*24);
	strcpy (ptest-&gt;arr[0].str, &quot;Hello&quot;);
	ptest-&gt;arr[1].i = 2;
	ptest-&gt;arr[1].str = (char *) malloc (sizeof(char)*24);
	strcpy (ptest-&gt;arr[1].str, &quot;baby&quot;);
	ptest-&gt;nr_of_arrs = 2;

	*testme = ptest;
	return 0;
}

--=-FYLieRvMdCbjWjopjgsl
Content-Disposition: attachment; filename=test2.cs
Content-Type: text/plain; name=test2.cs; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

using System;
using System.Runtime.InteropServices;

namespace teststruct
{
	[ StructLayout( LayoutKind.Sequential )]
	class test_struct_arr
	{
		public string str;
		public int i;
	}
	
	[ StructLayout( LayoutKind.Sequential )]
	class test_struct
	{
		public IntPtr arr;
		public int nr_of_arrs;
	}

	class Class1
	{
		[DllImport (&quot;library&quot;)]
		static extern int modify_it (out test_struct p);
				
		[STAThread]
		static void Main(string[] args)
		{
			test_struct testme;
			modify_it (out testme);

			if (testme != null)
			{				
				if (testme.nr_of_arrs != 2)
				{
					Console.WriteLine (&quot;{0} elements? Yeah, right...&quot;, testme.nr_of_arrs);
					return;
				}

				test_struct_arr[] tarr = new test_struct_arr[testme.nr_of_arrs];
				IntPtr current = testme.arr;
				
				for( int i = 0; i &lt; testme.nr_of_arrs; i++ )
				{
					tarr[ i ] = new test_struct_arr();
					Marshal.PtrToStructure( current, tarr[ i ]);
				
					//Marshal.FreeCoTaskMem( (IntPtr)Marshal.ReadInt32( current ));
					//Marshal.DestroyStructure( current, typeof(test_struct_arr) );

					current = (IntPtr)((int)current + 
						Marshal.SizeOf( tarr[ i ] ));

					Console.WriteLine (&quot;i[{0}] = {1} {2}&quot;, i, tarr[i].str, tarr[i].i);         
				}
			}
			else
			{
				Console.WriteLine (&quot;testme wasn't set&quot;);
			}
		}
	}
}

--=-FYLieRvMdCbjWjopjgsl--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013210.html">[Mono-list] A present for Nick - or - Gtk# NUnit GUI clone
</A></li>
	<LI> Next message: <A HREF="013220.html">[Mono-list] Passing structures to pinvoke (or: mono bug)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13213">[ date ]</a>
              <a href="thread.html#13213">[ thread ]</a>
              <a href="subject.html#13213">[ subject ]</a>
              <a href="author.html#13213">[ author ]</a>
         </LI>
       </UL>
</body></html>
