<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: bug report for new JIT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013318.html">
   <LINK REL="Next"  HREF="013322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: bug report for new JIT
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] Re: bug report for new JIT">lupus@ximian.com
       </A><BR>
    <I>Wed, 9 Apr 2003 13:14:11 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="013318.html">[Mono-list] Re: bug report for new JIT
</A></li>
        <LI> Next message: <A HREF="013322.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13320">[ date ]</a>
              <a href="thread.html#13320">[ thread ]</a>
              <a href="subject.html#13320">[ subject ]</a>
              <a href="author.html#13320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/09/03 dietmar wrote:
&gt;<i> On Tue, 2003-03-25 at 19:23, <A HREF="mailto:Zoltan.2.Varga@nokia.com">Zoltan.2.Varga@nokia.com</A> wrote: 
</I>&gt;<i> &gt; class Bug {
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;         static public void Main() {
</I>&gt;<i> &gt;                 string s2 = &quot;C&quot;;
</I>&gt;<i> &gt;                 string s = &quot;AB&quot; + s2;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;                 switch (s) {
</I>&gt;<i> &gt;                 case &quot;ABC&quot;:
</I>&gt;<i> &gt;                         Console.WriteLine (&quot;OK.&quot;);
</I>&gt;<i> &gt;                         break;
</I>&gt;<i> &gt;                 default:
</I>&gt;<i> &gt;                         Console.WriteLine (&quot;NOT OK&quot;);
</I>&gt;<i> &gt;                         break;
</I>&gt;<i> &gt;                 }
</I>&gt;<i> &gt;         }
</I>&gt;<i> &gt; }
</I>&gt;<i> 
</I>&gt;<i> mcs creates the following code for the switch (s)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         IL_001a: ldloc.2
</I>&gt;<i>         IL_001b: call string valuetype [corlib]System.String::IsInterned(string)
</I>&gt;<i>         IL_0020: stloc.2
</I>&gt;<i>         IL_0021: ldloc.2
</I>&gt;<i>         IL_0022: ldstr &quot;ABC&quot;
</I>&gt;<i>         IL_0027: bne.un IL_0040
</I>&gt;<i> 
</I>&gt;<i> The problem is that &quot;ABC&quot; is not interned when IsInterned is called.
</I>&gt;<i> 
</I>&gt;<i> csc produces the following code instead:
</I>&gt;<i> 
</I>&gt;<i> /* generate a ldstr for each case label*/ 
</I>&gt;<i>         IL_0012: ldstr &quot;ABC&quot;
</I>&gt;<i> 	/* pop all values from evaluation stack */
</I>&gt;<i>         IL_0017: leave.s IL_0019
</I>&gt;<i> 	...
</I>&gt;<i>         IL_001e: ldloc.2
</I>&gt;<i>         IL_001f: call string valuetype [corlib]System.String::IsInterned(string)
</I>&gt;<i>         IL_0024: stloc.2
</I>&gt;<i>         IL_0025: ldloc.2
</I>&gt;<i>         IL_0026: ldstr &quot;ABC&quot;
</I>&gt;<i>         IL_002b: beq.s IL_002f
</I>&gt;<i> 
</I>&gt;<i> This code makes sure that all case values are interned before IsInterned
</I>&gt;<i> is called. This code also works with AppDomains.
</I>&gt;<i> 
</I>&gt;<i> The AOT compiler also triggers this problem.
</I>&gt;<i> 
</I>&gt;<i> Paolo said the the correct fix would be to have some runtime magic to
</I>&gt;<i> intern all used strings before a method is called. I agree that this
</I>&gt;<i> would work, but its complex to implement and produces slow code.
</I>
Here is the answer I got from the MS people a year ago when I brought up
the issue:
	Easiest way is just to intern each string that is loaded by ldstr when
	you JIT the method containing the ldstr opcode. That way the JITted
	version of ldstr can just load the reference that is already held by the
	intern table.

I think it's easier for them, because they use a sort of root appdomain
where mscorlib is loaded and I guess they intern the strings in this
root appdomain: maybe someone can write a test that uses ldstr to load
the same string in two different appdomains and check the string objects have
the same address. We can either implement this same solution (it would
solve also other issues, like the need for the icall for the
process_guid lluis found recently and it would lower memory usage).
Or we can do it just for the string intern pool: have it shared across
appdomains (it should not be too complex).

And since this is done at compile time it's way faster than your
proposed workaround that needs to call ldstr for each of the case stmts
every time the code is executed.

&gt;<i> My suggestion is to modify mcs to produce the same code as csc, which
</I>&gt;<i> should be easy to implement.
</I>
But this would not solve the issue, since one can always write the
(correct) IL code mcs currently produces and the bug resurfaces.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013318.html">[Mono-list] Re: bug report for new JIT
</A></li>
	<LI> Next message: <A HREF="013322.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13320">[ date ]</a>
              <a href="thread.html#13320">[ thread ]</a>
              <a href="subject.html#13320">[ subject ]</a>
              <a href="author.html#13320">[ author ]</a>
         </LI>
       </UL>
</body></html>
