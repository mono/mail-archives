<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: bug report for new JIT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dietmar%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013317.html">
   <LINK REL="Next"  HREF="013320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: bug report for new JIT
   </H1>
    <B>dietmar
    </B> 
    <A HREF="mailto:dietmar%40ximian.com"
       TITLE="[Mono-list] Re: bug report for new JIT">dietmar@ximian.com
       </A><BR>
    <I>09 Apr 2003 11:44:00 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="013317.html">[Mono-list] A Volunteer for the Mono Java Compiler
</A></li>
        <LI> Next message: <A HREF="013320.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13318">[ date ]</a>
              <a href="thread.html#13318">[ thread ]</a>
              <a href="subject.html#13318">[ subject ]</a>
              <a href="author.html#13318">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2003-03-25 at 19:23, <A HREF="mailto:Zoltan.2.Varga@nokia.com">Zoltan.2.Varga@nokia.com</A> wrote: 
&gt;<i>                                         Hi,
</I>&gt;<i> 
</I>&gt;<i>  I would like to report two new problems I found.
</I>&gt;<i> 
</I>&gt;<i> - When running with --optimize=shared, case statements for strings
</I>&gt;<i> sometimes do not work 
</I>&gt;<i> because the code generated by the C# compiler calls IsInterned on the
</I>&gt;<i> string and the string
</I>&gt;<i> is not in the interned table because mono_ldstr() is not called yet.
</I>&gt;<i> The old JIT had the
</I>&gt;<i> same problem but it did not manifest itself because it called
</I>&gt;<i> mono_ldstr() during 
</I>&gt;<i> compilation all the time. But this only put the string into the intern
</I>&gt;<i> table for the 
</I>&gt;<i> current appdomain, which is not enough. 
</I>&gt;<i> 
</I>&gt;<i> Here is a testcase:
</I>&gt;<i> &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> using System;
</I>&gt;<i> 
</I>&gt;<i> class Bug {
</I>&gt;<i> 
</I>&gt;<i>         static public void Main() {
</I>&gt;<i>                 string s2 = &quot;C&quot;;
</I>&gt;<i>                 string s = &quot;AB&quot; + s2;
</I>&gt;<i> 
</I>&gt;<i>                 switch (s) {
</I>&gt;<i>                 case &quot;ABC&quot;:
</I>&gt;<i>                         Console.WriteLine (&quot;OK.&quot;);
</I>&gt;<i>                         break;
</I>&gt;<i>                 default:
</I>&gt;<i>                         Console.WriteLine (&quot;NOT OK&quot;);
</I>&gt;<i>                         break;
</I>&gt;<i>                 }
</I>&gt;<i>         }
</I>&gt;<i> }
</I>
mcs creates the following code for the switch (s)


        IL_001a: ldloc.2
        IL_001b: call string valuetype [corlib]System.String::IsInterned(string)
        IL_0020: stloc.2
        IL_0021: ldloc.2
        IL_0022: ldstr &quot;ABC&quot;
        IL_0027: bne.un IL_0040

The problem is that &quot;ABC&quot; is not interned when IsInterned is called.

csc produces the following code instead:

/* generate a ldstr for each case label*/ 
        IL_0012: ldstr &quot;ABC&quot;
	/* pop all values from evaluation stack */
        IL_0017: leave.s IL_0019
	...
        IL_001e: ldloc.2
        IL_001f: call string valuetype [corlib]System.String::IsInterned(string)
        IL_0024: stloc.2
        IL_0025: ldloc.2
        IL_0026: ldstr &quot;ABC&quot;
        IL_002b: beq.s IL_002f

This code makes sure that all case values are interned before IsInterned
is called. This code also works with AppDomains.

The AOT compiler also triggers this problem.

Paolo said the the correct fix would be to have some runtime magic to
intern all used strings before a method is called. I agree that this
would work, but its complex to implement and produces slow code.

My suggestion is to modify mcs to produce the same code as csc, which
should be easy to implement.

Maybe we should also ask the ECMA people if the really want that
&quot;hidden&quot; runtime feature. IMO its not necessary to make the runtime more
complex than it already is.

- Dietmar
















</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013317.html">[Mono-list] A Volunteer for the Mono Java Compiler
</A></li>
	<LI> Next message: <A HREF="013320.html">[Mono-list] Re: bug report for new JIT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13318">[ date ]</a>
              <a href="thread.html#13318">[ thread ]</a>
              <a href="subject.html#13318">[ subject ]</a>
              <a href="author.html#13318">[ author ]</a>
         </LI>
       </UL>
</body></html>
