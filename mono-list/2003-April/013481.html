<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] 2 bugs in Mono.Data.Tds.Protocol namespace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:nosyryev%40attbi.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013480.html">
   <LINK REL="Next"  HREF="013482.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] 2 bugs in Mono.Data.Tds.Protocol namespace
   </H1>
    <B>Igor Nosyryev
    </B> 
    <A HREF="mailto:nosyryev%40attbi.com"
       TITLE="[Mono-list] 2 bugs in Mono.Data.Tds.Protocol namespace">nosyryev@attbi.com
       </A><BR>
    <I>Mon, 21 Apr 2003 20:10:43 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="013480.html">[Mono-list] System classes
</A></li>
        <LI> Next message: <A HREF="013482.html">[Mono-list] RE: monoQLE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13481">[ date ]</a>
              <a href="thread.html#13481">[ thread ]</a>
              <a href="subject.html#13481">[ subject ]</a>
              <a href="author.html#13481">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------=_NextPart_000_0508_01C30842.16822EC0
Content-Type: text/plain;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

1. Class TdsComm. Method GetString adds extra byte to a string at end. =
It suppose to be '\0', but '\0' is valid value in .NET string, so this =
byte must not be used.=20

Code before:

  public string GetString (int len, bool wide)
  {
   if (wide) {
    char[] chars =3D new char[len];
    for (int i =3D 0; i &lt; len; ++i) {
     int lo =3D ((byte) GetByte ()) &amp; 0xFF;
     int hi =3D ((byte) GetByte ()) &amp; 0xFF;
     chars[i] =3D (char) (lo | ( hi &lt;&lt; 8));
    }
    return new String (chars);
   }
   else {
    byte[] result =3D new byte[len + 1];
    Array.Copy (GetBytes (len, false), result, len);
    return (encoder.GetString (result));
   }
  }
=20
Fix:

  public string GetString (int len, bool wide)
  {
   if (wide) {
    char[] chars =3D new char[len];
    for (int i =3D 0; i &lt; len; ++i) {
     int lo =3D ((byte) GetByte ()) &amp; 0xFF;
     int hi =3D ((byte) GetByte ()) &amp; 0xFF;
     chars[i] =3D (char) (lo | ( hi &lt;&lt; 8));
    }
    return new String (chars);
   }
   else {
    byte[] result =3D new byte[len];
    Array.Copy (GetBytes (len, false), result, len);
    return (encoder.GetString (result));
   }
  }
=20
2. Class Tds. Method GetDecimalValue. Method reads extra byte if a =
DECIMAL field contains NULL. As a result server's response is parsed =
incorrectly and this method fires an exception.

Code before:

  private object GetDecimalValue (byte precision, byte scale)
  {
   int[] bits =3D new int[4] {0,0,0,0};

   int len =3D (comm.GetByte() &amp; 0xff) - 1;
   bool positive =3D (comm.GetByte () =3D=3D 1);

   if (len &lt; 0)
    return null;
   if (len &gt; 16)
    throw new OverflowException ();

   for (int i =3D 0, index =3D 0; i &lt; len &amp;&amp; i &lt; 16; i +=3D 4, index =
+=3D 1)=20
    bits[index] =3D comm.GetTdsInt ();

   if (bits [3] !=3D 0)=20
    return new TdsBigDecimal (precision, scale, !positive, bits);
   else
    return new Decimal (bits[0], bits[1], bits[2], !positive, scale);
  }
=20
Fix:

  private object GetDecimalValue (byte precision, byte scale)
  {
   int[] bits =3D new int[4] {0,0,0,0};

   int len =3D (comm.GetByte() &amp; 0xff) - 1;
   if (len &lt; 0) return null;

   bool positive =3D (comm.GetByte () =3D=3D 1);

   if (len &gt; 16)
    throw new OverflowException ();

   for (int i =3D 0, index =3D 0; i &lt; len &amp;&amp; i &lt; 16; i +=3D 4, index =
+=3D 1)=20
    bits[index] =3D comm.GetTdsInt ();

   if (bits [3] !=3D 0)=20
    return new TdsBigDecimal (precision, scale, !positive, bits);
   else
    return new Decimal (bits[0], bits[1], bits[2], !positive, scale);
  }
=20
----------------------------------------
Igor Nosyryev
E-mail: <A HREF="mailto:nosyryev@attbi.com">nosyryev@attbi.com</A>

------=_NextPart_000_0508_01C30842.16822EC0
Content-Type: text/html;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;
&lt;HTML&gt;&lt;HEAD&gt;
&lt;META http-equiv=3DContent-Type content=3D&quot;text/html; =
charset=3Diso-8859-1&quot;&gt;
&lt;META content=3D&quot;MSHTML 6.00.2800.1141&quot; name=3DGENERATOR&gt;
&lt;STYLE&gt;&lt;/STYLE&gt;
&lt;/HEAD&gt;
&lt;BODY bgColor=3D#ffffff&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;1. Class TdsComm. Method GetString =
adds extra=20
byte to a string at end. It suppose to be '\0', but '\0' is valid value =
in .NET=20
string, so this byte must not be used. &lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;Code before:&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&amp;nbsp;&amp;nbsp;public string =
GetString=20
(int len, bool wide)&lt;BR&gt;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (wide)=20
{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;char[] chars =3D new=20
char[len];&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i =3D 0; i &amp;lt; len; ++i) =

{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int lo =3D ((byte) GetByte ()) &amp;amp;=20
0xFF;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int hi =3D ((byte) GetByte ()) =
&amp;amp;=20
0xFF;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;chars[i] =3D (char) (lo | ( hi =
&amp;lt;&amp;lt;=20
8));&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return new =
String=20
(chars);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;else=20
{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;byte[] result =3D new byte[len +=20
1];&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Array.Copy (GetBytes (len, false), =
result,=20
len);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return (encoder.GetString=20
(result));&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/FONT=
&gt;<i>&lt;/DIV&gt;
</I>&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;Fix:&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&amp;nbsp;&amp;nbsp;public string =
GetString=20
(int len, bool wide)&lt;BR&gt;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (wide)=20
{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;char[] chars =3D new=20
char[len];&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i =3D 0; i &amp;lt; len; ++i) =

{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int lo =3D ((byte) GetByte ()) &amp;amp;=20
0xFF;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;int hi =3D ((byte) GetByte ()) =
&amp;amp;=20
0xFF;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;chars[i] =3D (char) (lo | ( hi =
&amp;lt;&amp;lt;=20
8));&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return new =
String=20
(chars);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;else=20
{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;byte[] result =3D &lt;FONT color=3D#ff0000&gt;new =

byte[len]&lt;/FONT&gt;;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Array.Copy (GetBytes (len, =
false),=20
result, len);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return (encoder.GetString=20
(result));&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/FONT=
&gt;<i>&lt;/DIV&gt;
</I>&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;2. Class Tds. Method GetDecimalValue. =
Method=20
reads extra byte if a DECIMAL field contains NULL. As a result server's =
response=20
is parsed incorrectly and this method fires an exception.&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;Code before:&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;private object =
GetDecimalValue=20
(byte precision, byte scale)&lt;BR&gt;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;int[] =
bits =3D=20
new int[4] {0,0,0,0};&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;int len =3D =
(comm.GetByte()=20
&amp;amp; 0xff) - 1;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;bool positive =3D (comm.GetByte () =
=3D=3D=20
1);&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (len &amp;lt;=20
0)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return null;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (len =
&amp;gt;<i>=20
</I>16)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw new OverflowException =
();&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i =
=3D 0, index =3D=20
0; i &amp;lt; len &amp;amp;&amp;amp; i &amp;lt; 16; i +=3D 4, index +=3D 1)=20
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;bits[index] =3D comm.GetTdsInt =
();&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if =
(bits [3] !=3D 0)=20
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return new TdsBigDecimal (precision, scale,=20
!positive, =
bits);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;else&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return=20
new Decimal (bits[0], bits[1], bits[2], !positive,=20
scale);&lt;BR&gt;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;Fix:&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;private object =
GetDecimalValue=20
(byte precision, byte scale)&lt;BR&gt;&amp;nbsp;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;int[] =
bits =3D=20
new int[4] {0,0,0,0};&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;int len =3D =
(comm.GetByte()=20
&amp;amp; 0xff) - 1;&lt;BR&gt;&lt;FONT color=3D#ff0000&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (len &amp;lt; =
0) return=20
null;&lt;/FONT&gt;&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;bool =
positive =3D=20
(comm.GetByte () =3D=3D 1);&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (len &amp;gt;=20
16)&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;throw new OverflowException =
();&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot; size=3D2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;for (int i =
=3D 0, index =3D=20
0; i &amp;lt; len &amp;amp;&amp;amp; i &amp;lt; 16; i +=3D 4, index +=3D 1)=20
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;bits[index] =3D comm.GetTdsInt =
();&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;FONT face=3D&quot;Courier New&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;if =
(bits [3] !=3D 0)=20
&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return new TdsBigDecimal (precision, scale,=20
!positive, =
bits);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;else&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return=20
new Decimal (bits[0], bits[1], bits[2], !positive,=20
scale);&lt;BR&gt;&amp;nbsp;&amp;nbsp;}&lt;BR&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana=20
size=3D2&gt;----------------------------------------&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT face=3DVerdana size=3D2&gt;Igor Nosyryev&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;FONT face=3DVerdana&gt;E-mail: &lt;/FONT&gt;&lt;A=20
href=3D&quot;mailto:<A HREF="mailto:nosyryev@attbi.com">nosyryev@attbi.com</A>&quot;&gt;&lt;FONT=20
face=3DVerdana&gt;<A HREF="mailto:nosyryev@attbi.com">nosyryev@attbi.com</A>&lt;/FONT&gt;&lt;/A&gt;&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;

------=_NextPart_000_0508_01C30842.16822EC0--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013480.html">[Mono-list] System classes
</A></li>
	<LI> Next message: <A HREF="013482.html">[Mono-list] RE: monoQLE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13481">[ date ]</a>
              <a href="thread.html#13481">[ thread ]</a>
              <a href="subject.html#13481">[ subject ]</a>
              <a href="author.html#13481">[ author ]</a>
         </LI>
       </UL>
</body></html>
