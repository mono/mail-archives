<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Re: bug report for new JIT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:ChrisD%40monkey.biz">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013341.html">
   <LINK REL="Next"  HREF="013344.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Re: bug report for new JIT
   </H1>
    <B>Chris Day
    </B> 
    <A HREF="mailto:ChrisD%40monkey.biz"
       TITLE="[Mono-list] Re: bug report for new JIT">ChrisD@monkey.biz
       </A><BR>
    <I>Thu, 10 Apr 2003 09:47:00 +1000</I>
    <P><UL>
        <LI> Previous message: <A HREF="013341.html">[Mono-list] bug in reflection.c
</A></li>
        <LI> Next message: <A HREF="013344.html">[Mono-list] Small patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13343">[ date ]</a>
              <a href="thread.html#13343">[ thread ]</a>
              <a href="subject.html#13343">[ subject ]</a>
              <a href="author.html#13343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> From: dietmar [mailto:<A HREF="mailto:dietmar@ximian.com">dietmar@ximian.com</A>]=20
</I>&gt;<i> On Wed, 2003-04-09 at 16:10, Jeroen Frijters wrote:
</I>&gt;<i> &gt; Another thing to consider is garbage collection. Hopefully=20
</I>&gt;<i> the intern=20
</I>&gt;<i> &gt; table has weak references to the strings that the user put=20
</I>&gt;<i> in there,=20
</I>&gt;<i> &gt; but strings put in there by ldstr shouldn't be gargbage collected=20
</I>&gt;<i> &gt; (except when the AppDomain unloads).
</I>&gt;<i> &gt;=20
</I>&gt;<i> &gt; Imagine what happens if:
</I>&gt;<i> &gt;=20
</I>&gt;<i> &gt; &gt; 	mono_ldstr (...);
</I>&gt;<i> &gt; &gt; 	mono_ldstr (...);
</I>&gt;<i> &gt; &gt; 	... repeat for each string in the switch ...
</I>&gt;<i> &gt; *GC happens (because of another thread)*
</I>&gt;<i> &gt; &gt; 	check isinterned
</I>&gt;<i> &gt;=20
</I>&gt;<i> &gt; If the ldstr strings were garbage collected the isinterned=20
</I>&gt;<i> check would=20
</I>&gt;<i> &gt; fail.
</I>
There is an article on CodeProject which talks about what the MS CLR
does in the cases of switches on strings.

<A HREF="http://www.codeproject.com/csharp/strings.asp">http://www.codeproject.com/csharp/strings.asp</A>

The relevant part is towards the bottom, it also shows the IL that is
output for these cases.

&gt;&gt;&gt;<i>
</I>C# supports switches on strings. In doing so, it uses an efficient
mechanism for switching.

For small number of cases, the compiler will generate code that looks at
the internal string hash table. The compiler will first call
String.IsIntern on the switch value. String.IsIntern actually returns a
string instead of boolean, returning null for failure, and the interned
value of the string for success.

Every string constant in a case label is automatically known at
compile-time and is therefore guaranteed to be intern. At that point,
the compiler will compare the interned value of the string to each
string constant using reference equality.

If the number of cases is large (in this example it was 14), the
compiler generates a sparse hashtable constructed with a loadfactor of
.5 and with twice the capacity. [[ In actuality, a hashtable of with a
loadfactor of .5 is generated with nearly a 3-1 ratio, since the
Hashtable will try to maintain keep make sure that the ratio of used
buckets to available buckets in the table is at most (loadfactor * .72),
where the default loadfactor is 1. The magic number .72 represents the
optimal ratio to balance speed and memory as determined by Microsoft
performance tests. ]]

The hashtable will map each string to a corresponding index as shown in
the C# illustration of what the compiler generates below.
&lt;&lt;&lt;

HTH

Chris

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013341.html">[Mono-list] bug in reflection.c
</A></li>
	<LI> Next message: <A HREF="013344.html">[Mono-list] Small patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13343">[ date ]</a>
              <a href="thread.html#13343">[ thread ]</a>
              <a href="subject.html#13343">[ subject ]</a>
              <a href="author.html#13343">[ author ]</a>
         </LI>
       </UL>
</body></html>
