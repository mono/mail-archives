<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Address Sanitizer report interpretation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Address%20Sanitizer%20report%20interpretation&In-Reply-To=%3CE9E04E3B-05E7-4573-BD51-2A03FF022719%40mugginsoft.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="051977.html">
   <LINK REL="Next"  HREF="051979.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Address Sanitizer report interpretation</H1>
    <B>Jonathan Mitchell</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Address%20Sanitizer%20report%20interpretation&In-Reply-To=%3CE9E04E3B-05E7-4573-BD51-2A03FF022719%40mugginsoft.com%3E"
       TITLE="[Mono-list] Address Sanitizer report interpretation">jonathan at mugginsoft.com
       </A><BR>
    <I>Thu Dec  3 21:23:47 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="051977.html">[Mono-list] Adopting Code of Conduct
</A></li>
        <LI>Next message: <A HREF="051979.html">[Mono-list] VB.NET Support in Mono 4.2.1?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51978">[ date ]</a>
              <a href="thread.html#51978">[ thread ]</a>
              <a href="subject.html#51978">[ subject ]</a>
              <a href="author.html#51978">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Xcode 7 has a new valgrind like tool called Address Sanitizer.
My OS X app links to the embedded API so this gets targeted by the tool. 

So I get a memcpy heap buffer overflow sanitation report for Mono as below and identify (I think) the call site in fill_reflection_assembly_name
It says:

0x6040007e2ef1 is located 0 bytes to the right of 33-byte region [0x6040007e2ed0,0x6040007e2ef1)
So that means that we have written 1 byte past the end of the buffer pointed to by mono_array_addr (aname-&gt;publicKey, guint8, 0)?
So either that address is incorrect or pkey_len is too long?

I am only getting started with this tool so I am not yet inclined to take everything it says at face value yet - perhaps it generates false positives.

I don&#8217;t know the guts of Mono well enough to know whether the memcpy() below looks suspect or not.

Jonathan

==================

Memcpy call site

==================

fill_reflection_assembly_name ()

...
pkey_ptr = (char*)name-&gt;public_key;
pkey_len = mono_metadata_decode_blob_size (pkey_ptr, &amp;pkey_ptr);

MONO_OBJECT_SETREF (aname, publicKey, mono_array_new (domain, mono_defaults.byte_class, pkey_len));
memcpy (mono_array_addr (aname-&gt;publicKey, guint8, 0), pkey_ptr, pkey_len); &lt;&lt; I think this is the overflow
aname-&gt;flags |= ASSEMBLYREF_FULL_PUBLIC_KEY_FLAG;

=======================

AddressSanitizer output

=================================================================
==19261==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6040007e2ef1 at pc 0x000100e90cf4 bp 0x700000523b20 sp 0x7000005232d8
READ of size 48 at 0x6040007e2ef1 thread T23
   #0 0x100e90cf3 in wrap_memcpy (/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/7.0.0/lib/darwin/libclang_rt.asan_osx_dynamic.dylib+0x3acf3)
   #1 0x102902c3b in fill_reflection_assembly_name (/Users/jonathan/Library/Developer/Xcode/DerivedData/DummyApp-evzyclkfwllgccgdmfnxveopjbku/Build/Products/Debug/DummyApp.app/Contents/LGPL/Frameworks/Mono64.framework/Versions/4.0.4.4/lib/libmonosgen-2.0.1.dylib+0x143c3b)
   #2 0x1028fd950 in ves_icall_System_Reflection_AssemblyName_ParseName (/Users/jonathan/Library/Developer/Xcode/DerivedData/DummyApp-evzyclkfwllgccgdmfnxveopjbku/Build/Products/Debug/DummyApp.app/Contents/LGPL/Frameworks/Mono64.framework/Versions/4.0.4.4/lib/libmonosgen-2.0.1.dylib+0x13e950)
   #3 0x121727b0e  (&lt;unknown module&gt;)
   #4 0x12d10e6d5  (&lt;unknown module&gt;)
   #5 0x12d107493  (&lt;unknown module&gt;)
   #6 0x12d1068cc  (&lt;unknown module&gt;)

0x6040007e2ef1 is located 0 bytes to the right of 33-byte region [0x6040007e2ed0,0x6040007e2ef1)
allocated by thread T23 here:
   #0 0x100e9359c in wrap_strdup (/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/7.0.0/lib/darwin/libclang_rt.asan_osx_dynamic.dylib+0x3d59c)
   #1 0x1028cd729 in build_assembly_name (/Users/jonathan/Library/Developer/Xcode/DerivedData/DummyApp-evzyclkfwllgccgdmfnxveopjbku/Build/Products/Debug/DummyApp.app/Contents/LGPL/Frameworks/Mono64.framework/Versions/4.0.4.4/lib/libmonosgen-2.0.1.dylib+0x10e729)
   #2 0x1028cd2a4 in mono_assembly_name_parse_full (/Users/jonathan/Library/Developer/Xcode/DerivedData/DummyApp-evzyclkfwllgccgdmfnxveopjbku/Build/Products/Debug/DummyApp.app/Contents/LGPL/Frameworks/Mono64.framework/Versions/4.0.4.4/lib/libmonosgen-2.0.1.dylib+0x10e2a4)
   #3 0x1028fd920 in ves_icall_System_Reflection_AssemblyName_ParseName (/Users/jonathan/Library/Developer/Xcode/DerivedData/DummyApp-evzyclkfwllgccgdmfnxveopjbku/Build/Products/Debug/DummyApp.app/Contents/LGPL/Frameworks/Mono64.framework/Versions/4.0.4.4/lib/libmonosgen-2.0.1.dylib+0x13e920)
   #4 0x121727b0e  (&lt;unknown module&gt;)
   #5 0x12d10e6d5  (&lt;unknown module&gt;)
   #6 0x12d107493  (&lt;unknown module&gt;)
   #7 0x12d1068cc  (&lt;unknown module&gt;)

Thread T23 created by T2 here:
   &lt;empty stack&gt;

Thread T2 created by T0 here:
   &lt;empty stack&gt;

SUMMARY: AddressSanitizer: heap-buffer-overflow ??:0 wrap_memcpy
Shadow bytes around the buggy address:
 0x1c08000fc580: fa fa fa fa fa fa fa fa fa fa 00 00 00 00 00 fa
 0x1c08000fc590: fa fa 00 00 00 00 00 00 fa fa 00 00 00 00 00 00
 0x1c08000fc5a0: fa fa 00 00 00 00 00 00 fa fa 00 00 00 00 00 00
 0x1c08000fc5b0: fa fa fd fd fd fd fd fd fa fa 00 00 00 00 00 00
 0x1c08000fc5c0: fa fa fd fd fd fd fd fd fa fa 00 00 00 00 00 00
=&gt;0x1c08000fc5d0: fa fa 00 00 00 00 00 00 fa fa 00 00 00 00[01]fa
 0x1c08000fc5e0: fa fa fd fd fd fd fd fd fa fa 00 00 00 00 00 00
 0x1c08000fc5f0: fa fa fd fd fd fd fd fd fa fa 00 00 00 00 00 00
 0x1c08000fc600: fa fa fd fd fd fd fd fa fa fa fd fd fd fd fd fa
 0x1c08000fc610: fa fa fd fd fd fd fd fd fa fa fd fd fd fd fd fa
 0x1c08000fc620: fa fa fd fd fd fd fd fa fa fa fd fd fd fd fd fa
Shadow byte legend (one shadow byte represents 8 application bytes):
 Addressable:           00
 Partially addressable: 01 02 03 04 05 06 07 
 Heap left redzone:       fa
 Heap right redzone:      fb
 Freed heap region:       fd
 Stack left redzone:      f1
 Stack mid redzone:       f2
 Stack right redzone:     f3
 Stack partial redzone:   f4
 Stack after return:      f5
 Stack use after scope:   f8
 Global redzone:          f9
 Global init order:       f6
 Poisoned by user:        f7
 Container overflow:      fc
 Array cookie:            ac
 Intra object redzone:    bb
 ASan internal:           fe
 Left alloca redzone:     ca
 Right alloca redzone:    cb
==19261==ABORTING


Regards

Jonathan Mitchell
Mugginsoft LLP

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">jonathan at mugginsoft.com</A>
-----------------------------------------------------------------------------
KosmicTask - the Integrated Scripting Environment for OS X.
<A HREF="http://www.mugginsoft.com/KosmicTask">http://www.mugginsoft.com/KosmicTask</A>
-----------------------------------------------------------------------------
Follow on Twitter @KosmicTask
-----------------------------------------------------------------------------
Github <A HREF="http://github.com/mugginsoft">http://github.com/mugginsoft</A>












</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="051977.html">[Mono-list] Adopting Code of Conduct
</A></li>
	<LI>Next message: <A HREF="051979.html">[Mono-list] VB.NET Support in Mono 4.2.1?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51978">[ date ]</a>
              <a href="thread.html#51978">[ thread ]</a>
              <a href="subject.html#51978">[ subject ]</a>
              <a href="author.html#51978">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
