<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Listen on same port ipv4 and ipv6
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Listen%20on%20same%20port%20ipv4%20and%20ipv6&In-Reply-To=%3CCAA2GJqWLUXM-GaMV0ewZbMq3QON61Q7RPkm_6C%2BjFrvt2e4fmQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="051990.html">
   <LINK REL="Next"  HREF="051992.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Listen on same port ipv4 and ipv6</H1>
    <B>J Decker</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Listen%20on%20same%20port%20ipv4%20and%20ipv6&In-Reply-To=%3CCAA2GJqWLUXM-GaMV0ewZbMq3QON61Q7RPkm_6C%2BjFrvt2e4fmQ%40mail.gmail.com%3E"
       TITLE="[Mono-list] Listen on same port ipv4 and ipv6">d3ck0r at gmail.com
       </A><BR>
    <I>Fri Dec 11 23:51:50 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="051990.html">[Mono-list] Listen on same port ipv4 and ipv6
</A></li>
        <LI>Next message: <A HREF="051992.html">[Mono-list] Listen on same port ipv4 and ipv6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51991">[ date ]</a>
              <a href="thread.html#51991">[ thread ]</a>
              <a href="subject.html#51991">[ subject ]</a>
              <a href="author.html#51991">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Dec 11, 2015 at 3:25 PM, J Decker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">d3ck0r at gmail.com</A>&gt; wrote:
&gt;<i> On Fri, Dec 11, 2015 at 2:33 PM, J Decker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">d3ck0r at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> On Fri, Dec 11, 2015 at 1:56 PM, J Decker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">d3ck0r at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> On Fri, Dec 11, 2015 at 1:50 PM, J Decker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">d3ck0r at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> (First let me vent a little and say I LOVE all the consistency in
</I>&gt;&gt;&gt;&gt;<i> network libraries; in MS.NET closing a IPV6 TcpClient sets Client to
</I>&gt;&gt;&gt;&gt;<i> null, whereas IPV4 TcpCLient only disposes the object)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I found this old message with no responses..
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/pipermail/mono-list/2014-May/050905.html">http://lists.ximian.com/pipermail/mono-list/2014-May/050905.html</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I want to listen at the same port address at 0.0.0.0 and :: (ipv4 and
</I>&gt;&gt;&gt;&gt;<i> 6 address respectively)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> in C I would open two listeners.  But I think maybe the .NET runtime
</I>&gt;&gt;&gt;&gt;<i> is pre-checking if that port is already used in some internal list of
</I>&gt;&gt;&gt;&gt;<i> sockets before attemping to open it in reality.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> in C# I will have to do the same thing, since connecting to the v6
</I>&gt;&gt;&gt;&gt;<i> address with only the v4 listener at 0.0.0.0 listening fails to
</I>&gt;&gt;&gt;&gt;<i> connect and times out.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Windows I have to, and it works; but again with Mono on Linux it
</I>&gt;&gt;&gt;&gt;<i> doesn't work.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This is the code that fails.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> internal GameServer()
</I>&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;<i> byte[] raw_ipv4 = { 0, 0, 0, 0 };
</I>&gt;&gt;&gt;<i> IPAddress addr = new IPAddress( raw_ipv4 );
</I>&gt;&gt;&gt;<i> listener = new TcpListener( addr, Settings.Read( &quot;Server Port&quot;,
</I>&gt;&gt;&gt;<i> GameServer.serving_port ) );
</I>&gt;&gt;&gt;<i> listener.Start();
</I>&gt;&gt;&gt;<i> byte[] raw_ipv6 = { 0,0,0,0
</I>&gt;&gt;&gt;<i> ,0, 0, 0, 0
</I>&gt;&gt;&gt;<i> ,0, 0, 0, 0
</I>&gt;&gt;&gt;<i> ,0, 0, 0, 0 };
</I>&gt;&gt;&gt;<i> IPAddress addr_v6 = new IPAddress( raw_ipv6 );
</I>&gt;&gt;&gt;<i> listener_v6 = new TcpListener( addr_v6, Settings.Read( &quot;Server Port&quot;,
</I>&gt;&gt;&gt;<i> GameServer.serving_port ) );
</I>&gt;&gt;&gt;<i> listener_v6.Start(); /* Exception - EADDRINUSE ; even though it's not
</I>&gt;&gt;&gt;<i> and needs to be opened */
</I>&gt;&gt;&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Supposedly this is the fix.  (I checked my C code and remembered I was
</I>&gt;<i> doing something with SetSockOpt)
</I>&gt;<i> _Socket.SetSocketOption(SocketOptionLevel.Socket,
</I>&gt;<i> SocketOptionName.ReuseAddress, True)
</I>&gt;<i>
</I>&gt;<i> But GetSocketOption returns 1 for reuse to start with... and setting
</I>&gt;<i> it doesn't seem to do anything :(
</I>
System.Net.Sockets.SocketOptionName 0xf is not supported at Socket level

The SO_REUSEPORT socket option
<A HREF="https://lwn.net/Articles/542629/">https://lwn.net/Articles/542629/</A>
&quot;One of the features merged in the 3.9 development cycle was TCP and
UDP support for theSO_REUSEPORT socket option; that support was
implemented in a series of patches by Tom Herbert. The new socket
option allows multiple sockets on the same host to bind to the same
port, and is intended to improve the performance of multithreaded
network server applications running on top of multicore systems.&quot;

SO_REUSEPORT is 15 on SOL_SOCKET layer.

And of course 'convert_sockopt_level_and_name' is needed to go from
.NET defines to system values; and it doesn't allow passing arbitrary
values.

I guess... GetSocketOption for reuseaddr returns TRUE because it is
... it doesn't actually appear there's internal checking like I had
supposed, and they're all reflections from actual system error
codes...

is REUSEPORT 'needed' on newer linux kernels?  I don't quite
understand if it's for finer control or a requirment
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="051990.html">[Mono-list] Listen on same port ipv4 and ipv6
</A></li>
	<LI>Next message: <A HREF="051992.html">[Mono-list] Listen on same port ipv4 and ipv6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51991">[ date ]</a>
              <a href="thread.html#51991">[ thread ]</a>
              <a href="subject.html#51991">[ subject ]</a>
              <a href="author.html#51991">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
