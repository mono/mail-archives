<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] strange mono initialization problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="007926.html">
   <LINK REL="Next"  HREF="007935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] strange mono initialization problem
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] strange mono initialization problem">lupus@ximian.com
       </A><BR>
    <I>Sat, 24 Aug 2002 13:08:01 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="007926.html">[Mono-list] strange mono initialization problem
</A></li>
        <LI> Next message: <A HREF="007935.html">[Mono-list] strange mono initialization problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7932">[ date ]</a>
              <a href="thread.html#7932">[ thread ]</a>
              <a href="subject.html#7932">[ subject ]</a>
              <a href="author.html#7932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/24/02 John Sohn wrote:
&gt;<i> &gt; A possible solution to the problem is to use a linker version script
</I>&gt;<i> &gt; so that those functions are not exported by the libmono library
</I>&gt;<i> &gt; (it would be a good idea to implement this in any case, IMHO).
</I>&gt;<i> &gt; have a file that reads:
</I>&gt;<i> &gt; == snip snip ==
</I>&gt;<i> &gt; VER_1 {
</I>&gt;<i> &gt; 	global: 
</I>&gt;<i> &gt; 		mono_*;
</I>&gt;<i> &gt; 	local:
</I>&gt;<i> &gt; 		*;
</I>&gt;<i> &gt; };
</I>&gt;<i> &gt; == snip snip ==
</I>&gt;<i> &gt; And then add to jit/Makefile.am:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; libmono_la_LDFLAGS=--version-script=ldscript
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Can you test if that fixes the shared libmono issue when linking to
</I>&gt;<i> &gt; libwine?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> I am not familiar with this process but I created a file called ldscript
</I>&gt;<i> with the contents above and added the libmono_la_LDFLAGS as shown above.
</I>&gt;<i> If I did this correctly I am still getting a segfault when dynamically
</I>&gt;<i> linking the library. The debugger is still stepping into the Wine
</I>&gt;<i> TlsAlloc (when called inside of mono) instead of Mono's. It seems as
</I>&gt;<i> though libmono.so is calling the wrong (WineLib) version of TlsAlloc.
</I>&gt;<i> This is happening within the mono_init function.
</I>
Sorry, I was sloppy (I went from memory): the change to
Makefile.am should read:

diff -u -r1.35 Makefile.am
--- Makefile.am	12 Aug 2002 10:05:51 -0000	1.35
+++ Makefile.am	24 Aug 2002 10:36:44 -0000
@@ -3,6 +3,8 @@
 	$(GMODULE_CFLAGS)		\
 	$(GLIB_CFLAGS)
 
+libmono_la_LDFLAGS=-Wl,-version-script=ldscript
+
 if X86
 bin_PROGRAMS = mono
 lib_LTLIBRARIES = libmono.la

i.e. with -Wl,... otherwise the option is not passed down to the linker.
You can then check with:
	nm -D .libs/libmono.so|grep ' T '

that only symbols starting with &quot;mono_&quot; are exported.
Can you retest with that change?

&gt;<i> &gt; If libwine is used to implement the S.W.Forms classes, can't it be
</I>&gt;<i> &gt; used with P/Invoke? What is the reason you choose to embed mono instead
</I>&gt;<i> &gt; of using P/Invoke on libwine? ...
</I>&gt;<i> 
</I>&gt;<i> I tried several different ways of calling Win32/WineLib functions within
</I>&gt;<i> a Mono compiled application but the only way I was able to get Mono and
</I>&gt;<i> Wine code to execute within these environments was to embed the JIT
</I>&gt;<i> engine inside of a small WineLib application. The two .c files in CVS
</I>&gt;<i> under mcs/class/System.Windows.Forms/WINELib creates a WineLib
</I>&gt;<i> application (monostub.exe.so) that accepts the name of a mono executable
</I>&gt;<i> to run on the command line. This application is very small but since the
</I>&gt;<i> application is executing under Wine all Win32 functions are now
</I>&gt;<i> available as you mention using DllImport. This application enables any
</I>&gt;<i> of the WineLib/Win32 functions to be available to Mono applications when
</I>&gt;<i> they are started under using this application instead of the regular
</I>&gt;<i> &quot;mono&quot; command.
</I>&gt;<i> 
</I>&gt;<i> So as far as I can tell, the Mono engine needs to be embedded in a small
</I>&gt;<i> application that will run under the WineLib environment. Creating an
</I>&gt;<i> application for WineLib (unfortunately) is not as easy as gcc mywinapp.c
</I>&gt;<i> -lwine. At this point DllImport's can then be used (running inside this
</I>&gt;<i> WineLib/embedded Mono application) to access all of the Win32/WineLib
</I>&gt;<i> API.
</I>
Yeah, I know that. It's fine for testing if implementing S.W.Forms
works out using wine (BTW, thanks for doing that!). It's just that it's
not a possible long-term solution, IMHO, having two different mono
loaders, one linked to libwine that can use S.W.F and one that can't.
Anyway, maybe we can discuss this later with the wine people if your
experiments turn out to work.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="007926.html">[Mono-list] strange mono initialization problem
</A></li>
	<LI> Next message: <A HREF="007935.html">[Mono-list] strange mono initialization problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7932">[ date ]</a>
              <a href="thread.html#7932">[ thread ]</a>
              <a href="subject.html#7932">[ subject ]</a>
              <a href="author.html#7932">[ author ]</a>
         </LI>
       </UL>
</body></html>
