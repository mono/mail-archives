<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] strange mono initialization problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="007877.html">
   <LINK REL="Next"  HREF="007898.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] strange mono initialization problem
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] strange mono initialization problem">lupus@ximian.com
       </A><BR>
    <I>Thu, 22 Aug 2002 13:01:40 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="007877.html">[Mono-list] strange mono initialization problem
</A></li>
        <LI> Next message: <A HREF="007898.html">[Mono-list] strange mono initialization problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7895">[ date ]</a>
              <a href="thread.html#7895">[ thread ]</a>
              <a href="subject.html#7895">[ subject ]</a>
              <a href="author.html#7895">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--NtwzykIc2mflq5ck
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

On 08/21/02 John Sohn wrote:
&gt;<i> I have been experiencing the same problem while trying to use WineLib 
</I>&gt;<i> with the Mono embedding API. The WineLib &quot;application&quot; is a shared
</I>&gt;<i> library that gets invoked by the wine command so I believe it is the
</I>&gt;<i> same problem as the one mentioned below. It looks like both of our
</I>&gt;<i> projects are shared libraries that get called from another application.
</I>&gt;<i> This code is in CVS under mcs/class/System.Windows.Forms/WINELib. 
</I>&gt;<i> 
</I>&gt;<i> I am using the embedding API to statically link the Mono JIT engine with
</I>&gt;<i> this shared library. Dynamically linking the mono engine does not seem
</I>&gt;<i> to work as conflicts appear to exist between the mono and wine
</I>&gt;<i> libraries. For the last few days I had been getting the same results
</I>
Please, can you elaborate on what kind of conflicts?
Statically linking the mono engine is not a good idea, generally: the
only app that may do it is mono itself (for speed reasons: linking it
dynamically gets us a 5-10% slowdown).

&gt;<i> mentioned below. The application would hang on the mono_jit_init.
</I>&gt;<i> However with the latest build from CVS the application now segfaults. If
</I>&gt;<i> I disable garbage collection when building Mono the applications runs
</I>&gt;<i> successfully. I had been using the Mono 0.13 snapshots successfully with
</I>&gt;<i> garbage collection enabled so it seems a change occurred between the
</I>&gt;<i> 0.13 and the 0.14 tag in CVS to cause this problem. I am using the
</I>
Something may have changed in the build setup, but nothing in the code
is related to this issue. Hans Boehm says it may actually be a bug in
the dynamic linker and he added a workaround in gc 6.1.

&gt;<i> latest version (6.1) of the garbage collection library. I am running
</I>
My tests (and others) say libgc 6.1 fixes the issue. Are you sure
you're using 6.1 and not an alpha release of it?
I tryed also linking my test case to libwine, but maybe I need to call
some function from it too, but with libgc 6.1 it works correctly.
If you can reproduce the issue starting from the simple test I'm attaching,
let me know so that we can investigate further.
Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better

--NtwzykIc2mflq5ck
Content-Type: text/x-csrc; charset=us-ascii
Content-Disposition: attachment; filename=&quot;main.c&quot;

#include &lt;dlfcn.h&gt;
#include &lt;stdio.h&gt;

typedef void (*func)(void);
int main() {
	void *lib;
	func sym;

	lib = dlopen (&quot;./gclib.so&quot;, RTLD_NOW);
	printf (&quot;got lib: %p (%s)\n&quot;, lib, dlerror());
	sym = dlsym (lib, &quot;do_stuff&quot;);
	printf (&quot;got sym: %p (%s)\n&quot;, sym, dlerror());
	sym ();
	return 0;
}

--NtwzykIc2mflq5ck
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=makefile

#
# If you have unpacked gc6.1.tar.gz in this dir (and built it)
# run with:
# LD_LIBRARY_PATH=gc6.1/.libs/ ./main
# or with
# ./main
# you can build using 
# 	make NEWGC=
# to use the installed libgc

NEWGC=-L./gc6.1/.libs
all: gclib.so main

gclib.so: gclib.c makefile
	gcc -Wall -g -shared -o gclib.so gclib.c $(NEWGC) -lgc

# add -lgc to the following command line and it works
main: main.c makefile
	gcc -Wall -g -o main main.c -ldl

clean:
	-rm -f main gclib.so


--NtwzykIc2mflq5ck
Content-Type: text/x-csrc; charset=us-ascii
Content-Disposition: attachment; filename=&quot;gclib.c&quot;

#include &lt;gc/gc.h&gt;
#include &lt;stdio.h&gt;

#define NUM 10000
#define SIZE 10000
void
do_stuff () {
	void *p;
	int i;
	printf (&quot;in do_stuff()\n&quot;);
	for (i = 0; i &lt; NUM; ++i)
		p = GC_malloc (SIZE);
}


--NtwzykIc2mflq5ck--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="007877.html">[Mono-list] strange mono initialization problem
</A></li>
	<LI> Next message: <A HREF="007898.html">[Mono-list] strange mono initialization problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7895">[ date ]</a>
              <a href="thread.html#7895">[ thread ]</a>
              <a href="subject.html#7895">[ subject ]</a>
              <a href="author.html#7895">[ author ]</a>
         </LI>
       </UL>
</body></html>
