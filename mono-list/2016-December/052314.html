<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Easy way to deadlock Mono with concurrent	HttpWebRequests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.dot.net?Subject=Re%3A%20%5BMono-list%5D%20Easy%20way%20to%20deadlock%20Mono%20with%20concurrent%0A%09HttpWebRequests&In-Reply-To=%3Cf3b7465e-39e1-1d60-8b14-815d6374e525%40codicesoftware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052313.html">
   <LINK REL="Next"  HREF="052317.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Easy way to deadlock Mono with concurrent	HttpWebRequests</H1>
    <B>Rubén de Alba</B> 
    <A HREF="mailto:mono-list%40lists.dot.net?Subject=Re%3A%20%5BMono-list%5D%20Easy%20way%20to%20deadlock%20Mono%20with%20concurrent%0A%09HttpWebRequests&In-Reply-To=%3Cf3b7465e-39e1-1d60-8b14-815d6374e525%40codicesoftware.com%3E"
       TITLE="[Mono-list] Easy way to deadlock Mono with concurrent	HttpWebRequests">rdealba at codicesoftware.com
       </A><BR>
    <I>Fri Dec 23 11:27:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052313.html">[Mono-list] F# version in Xamarin repos
</A></li>
        <LI>Next message (by thread): <A HREF="052317.html">[Mono-list] Easy way to deadlock Mono with concurrent	HttpWebRequests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52314">[ date ]</a>
              <a href="thread.html#52314">[ thread ]</a>
              <a href="subject.html#52314">[ subject ]</a>
              <a href="author.html#52314">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We can deadlock Mono launching a few HttpWebRequests. We can 
consistently reproduce in our app, but only sometimes happens in the 
attached program.

We initially detected this on a server pulling data from Azure. It 
deadlocks and it is unable to handle a single new request (since we rely 
on Socket.BeginReceive for that, and the callback is never invoked once 
the deadlock happens).

We suspect it could still be related to this ancient issue: 
<A HREF="http://www.mono-project.com/archived/articlethreadpool_deadlocks/">http://www.mono-project.com/archived/articlethreadpool_deadlocks/</A>

I have attached a small sample application to reproduce the issue. It 
occasionally deadlocks on *Mono 4.6.2*.*7* (and older) no matter whether 
the machine has 1 core or 8. What is consistent is that it performs 
worse than expected and fails. Not sure if this is a hint.

What the app does is:

* It launches 40 HttpWebRequest.GetResponse() in parallel.
* Most of them fail (&quot;The authentication or decryption has failed.&quot;, 
&quot;The request timed out&quot;) .
* The program retries if they fail - and retries also fail.
* CPU is very high (90% on my test box).
* After a while sometimes the entire program hangs.
* We also tried the HttpClient class using async calls and no threadpool 
but result wasn't any better.

Some interesting notes:
* The same code works well in .NET/Windows.
* And launching the 40 concurrent requests is super fast there compared 
to super slow using Mono.


Any hints or workarounds will be greatly appreciated :-P

Thanks!

Rubén,

www.plasticscm.com

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-list/attachments/20161223/75082055/attachment.html">http://lists.dot.net/pipermail/mono-list/attachments/20161223/75082055/attachment.html</A>&gt;
-------------- next part --------------
﻿using System;
using System.IO;
using System.Net;
using System.Threading;

namespace threadpool_httpwebrequests
{
    class Program
    {
        static long mCounter = 0;

        static void Main(string[] args)
        {
            ServicePointManager.UseNagleAlgorithm = false;
            ServicePointManager.Expect100Continue = false;
            ServicePointManager.DefaultConnectionLimit = 500;

            int requestsCount = 40;

            if (args.Length == 1)
                requestsCount = int.Parse(args[0]);

            int ini = Environment.TickCount;

            Console.WriteLine(&quot;Going to launch {0} concurrent https requests...&quot;, requestsCount);

            LaunchClientRequest(requestsCount);

            WaitForRequestsToComplete(requestsCount);

            Console.WriteLine(&quot;The {0} requests finished {1} ms&quot;,
                requestsCount, Environment.TickCount - ini);
            Console.WriteLine(&quot;Test finished!&quot;);
        }

        static void LaunchClientRequest(int requestsCount)
        {
            for (int i = 0; i &lt; requestsCount; i++)
                ThreadPool.QueueUserWorkItem(Read, null);
        }

        static void WaitForRequestsToComplete(int requestsCount)
        {
            while (Interlocked.Read(ref mCounter) != requestsCount)
                System.Threading.Thread.Sleep(500);
        }

        static void Read(object state)
        {
            for (int i = 0; i &lt; 3; i++)
            {
                if (Read())
                    break;
            }
            Interlocked.Increment(ref mCounter);
        }

        static bool Read()
        {
            try
            {
                HttpWebRequest request = HttpWebRequest.Create(&quot;<A HREF="https://www.google.com">https://www.google.com</A>&quot;) as HttpWebRequest;
                request.Method = &quot;GET&quot;;
                request.ContentLength = 0;
                request.ContentType = &quot;text/HTML&quot;;

                using (HttpWebResponse response = request.GetResponse() as HttpWebResponse)
                using (Stream stream = response.GetResponseStream())
                using (BinaryReader reader = new BinaryReader(stream))
                {
                    Console.WriteLine(reader.ReadString());
                    return true;
                }
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
                return false;
            }
        }
    }
}
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052313.html">[Mono-list] F# version in Xamarin repos
</A></li>
	<LI>Next message (by thread): <A HREF="052317.html">[Mono-list] Easy way to deadlock Mono with concurrent	HttpWebRequests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52314">[ date ]</a>
              <a href="thread.html#52314">[ thread ]</a>
              <a href="subject.html#52314">[ subject ]</a>
              <a href="author.html#52314">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
