<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Embedded API. Numeric Boxing and GC
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Embedded%20API.%20Numeric%20Boxing%20and%20GC&In-Reply-To=%3CCACmR%2BBAwm1XKhnZ12jXf3i1UwOFk9zwR0LFbCxkX2-_MEkJC%3Dg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="050680.html">
   <LINK REL="Next"  HREF="050685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Embedded API. Numeric Boxing and GC</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Embedded%20API.%20Numeric%20Boxing%20and%20GC&In-Reply-To=%3CCACmR%2BBAwm1XKhnZ12jXf3i1UwOFk9zwR0LFbCxkX2-_MEkJC%3Dg%40mail.gmail.com%3E"
       TITLE="[Mono-list] Embedded API. Numeric Boxing and GC">kumpera at gmail.com
       </A><BR>
    <I>Wed Feb 26 16:15:43 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="050680.html">[Mono-list] Embedded API. Numeric Boxing and GC
</A></li>
        <LI>Next message: <A HREF="050685.html">[Mono-list] Embedded API. Numeric Boxing and GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50684">[ date ]</a>
              <a href="thread.html#50684">[ thread ]</a>
              <a href="subject.html#50684">[ subject ]</a>
              <a href="author.html#50684">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This code is wrong, it will fail when the object is moved since the
gchandle is not pinning the target.

Avoid pinning as much as possible since it does hurt performance a lot.

The solution is to remove the monoObject field and
use mono_gchandle_get_target against the GC handle.


On Tue, Feb 25, 2014 at 5:20 AM, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">jonathan at mugginsoft.com</A> &lt;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">jonathan at mugginsoft.com</A>&gt; wrote:

&gt;<i> I box my numeric primitives using a macro:
</I>&gt;<i>
</I>&gt;<i> #define DB_BOX_INT64( x ) ( mono_value_box(mono_domain_get(),
</I>&gt;<i> mono_get_int64_class(), &amp;x) )
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And use it like so:
</I>&gt;<i>
</I>&gt;<i> 1.
</I>&gt;<i>
</I>&gt;<i> - (void)box
</I>&gt;<i> {
</I>&gt;<i> MonoObject *monoObject = DB_BOX_INT64(value);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> I save the MonoObject * into a local variable. The collector will see the
</I>&gt;<i> object on the stack and collect it only when the enclosing function
</I>&gt;<i> completes.
</I>&gt;<i>
</I>&gt;<i> 2.
</I>&gt;<i> - (void)box:(long long)value
</I>&gt;<i> {
</I>&gt;<i>         self.monoObject = DB_BOX_INT64(value);
</I>&gt;<i>         self.gcHandle = mono_gchandle_new(self.monoObject, FALSE);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> - (void)dealloc
</I>&gt;<i> {
</I>&gt;<i>         mono_gchandle_free(self.gcHandle);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> I save the MonoObject * into an instance variable. The collector will free
</I>&gt;<i> the MonoObject after the call to mono_gchandle_free().
</I>&gt;<i>
</I>&gt;<i> Is the above correct?
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Jonathan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20140226/f99d6fcb/attachment.html">http://lists.ximian.com/pipermail/mono-list/attachments/20140226/f99d6fcb/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="050680.html">[Mono-list] Embedded API. Numeric Boxing and GC
</A></li>
	<LI>Next message: <A HREF="050685.html">[Mono-list] Embedded API. Numeric Boxing and GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50684">[ date ]</a>
              <a href="thread.html#50684">[ thread ]</a>
              <a href="subject.html#50684">[ subject ]</a>
              <a href="author.html#50684">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
