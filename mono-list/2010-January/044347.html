<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] mono performance, 20x differential with Java (what am i doing wrong)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20mono%20performance%2C%0A%2020x%20differential%20with%20Java%20%28what%20am%20i%20doing%20wrong%29&In-Reply-To=D1FFAD50-48DC-49AD-9AE2-20C32D9D9C36%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="044345.html">
   <LINK REL="Next"  HREF="044355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] mono performance, 20x differential with Java (what am i doing wrong)</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20mono%20performance%2C%0A%2020x%20differential%20with%20Java%20%28what%20am%20i%20doing%20wrong%29&In-Reply-To=D1FFAD50-48DC-49AD-9AE2-20C32D9D9C36%40gmail.com"
       TITLE="[Mono-list] mono performance, 20x differential with Java (what am i doing wrong)">miguel at novell.com
       </A><BR>
    <I>Fri Jan 29 13:43:01 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="044345.html">[Mono-list] mono performance,	20x differential with Java (what am 	i doing wrong)
</A></li>
        <LI>Next message: <A HREF="044355.html">[Mono-list] mono performance,	20x differential with Java (what am i doing wrong)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44347">[ date ]</a>
              <a href="thread.html#44347">[ thread ]</a>
              <a href="subject.html#44347">[ subject ]</a>
              <a href="author.html#44347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Jonathan,

    We were recently investigating some work on this area and there are
a couple of things that you can do to improve the execution speed for
computationally intensive code:

	* Compile Mono using the LLVM backend, I strongly recommend
	  that you use Mono from SVN where a lot of new LLVM integration
	  work has taken place.

	* Our Arrays-bounds-check elimination code is not as strong
	  as it could be.    One thing that you can do, for tasks that
	  will take days to run, and where you know that you will not
	  get an out-of-range exception is to remove from the
	  runtime arrays bounds checking.

    I recently did both of those, and it results in a 4x performance
improvement in SciMark and matches Java's performance.

    Mono needs more work in the area of arrays bounds checking
elimination as the above is not really a production solution (removing
the ABC checks from the runtime).   But it should be useful for those
that need this today.

    Get this patch:

	<A HREF="http://tirania.org/tmp/bounds-check-elim.diff">http://tirania.org/tmp/bounds-check-elim.diff</A>

    Then build Mono with LLVM:

	<A HREF="http://www.mono-project.com/Mono_LLVM">http://www.mono-project.com/Mono_LLVM</A>

    It will get you a 4x perf boost (the patch is for x86-64, if you are
in another platform you will need to remove the equivalent code).
Perhaps an interim solution is for us to add a -O=noboundscheck.


&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'm quite familiar with both the .NET and Java development
</I>&gt;<i> environments, but only recently have begun to experiment with mono, so
</I>&gt;<i> forgive me if I'm not clued-in.   
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I specialize in numerical work that often involves a lot large-scale
</I>&gt;<i> array manipulation for linear algebra, timeseries, etc.    My main
</I>&gt;<i> production platforms are OSX and Linux.   I've been doing most of my
</I>&gt;<i> work on the JVM over the past few years, though spent a couple of
</I>&gt;<i> years with .NET when it was pre-release / pre-1.0.  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My main interest is in Ocaml, particularly the F# variant as the basis
</I>&gt;<i> for my numerical work.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> One of the first things I do when considering a platform is run
</I>&gt;<i> benchmarks, as performance is critical for what I do.    Starting with
</I>&gt;<i> C# I wrote a test to gauge the array-access overhead associated with
</I>&gt;<i> the platform.  Without knowing how to tweak the mono runtime to turn
</I>&gt;<i> on any particular optimisations, the results were quite poor for this
</I>&gt;<i> specific test (see code at the end of this posting).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The test on my MacPro 2.6 Ghz / Snow Leopard with mono 2.6.1 gave the
</I>&gt;<i> result of:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 16 sec, 130 ms for 1000 iterations
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> the same code, modified just for IO, etc on the Java VM (without
</I>&gt;<i> -server)  gave a runtime of:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  0 sec, 831 ms
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> changing the # of iterations to higher amounts did nothing to improve
</I>&gt;<i> the ratio.   Java is 20x faster in this benchmark.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I could not find any documentation concerning settings for the
</I>&gt;<i> -optimize flag on the mono VM, so perhaps there is a setting I should
</I>&gt;<i> be using.   
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Secondly, I saw the posting concerning the optional use of LLVM.  I
</I>&gt;<i> have not been able to build mono on OSX as am having problems building
</I>&gt;<i> glib.  I'm wondering whether anyone has a packaged up version of glib
</I>&gt;<i> or better a packaged up version of mono with LLVM enabled.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I have heard only good things about LLVM performance, so hoping that
</I>&gt;<i> this will help address this gap.   Hopefully I am doing something
</I>&gt;<i> wrong here and the performance is much closer.   Test code below ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> regards
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Jonathan
</I>&gt;<i> --
</I>&gt;<i> <A HREF="http://tr8dr.wordpress.com/">http://tr8dr.wordpress.com/</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> using System;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> namespace Performance
</I>&gt;<i> {
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public class ArrayTest
</I>&gt;<i> {
</I>&gt;<i> 
</I>&gt;<i> public static double test1 (double[] vec)
</I>&gt;<i> {
</I>&gt;<i> double sum = 0;
</I>&gt;<i> for (int i = 8 ; i &lt; vec.Length ; i++)
</I>&gt;<i> {
</I>&gt;<i> vec[i] = 2*vec[i] - vec[i-1];
</I>&gt;<i> for (int j = 1 ; j &lt; 8 ; j++)
</I>&gt;<i> sum += 1.3 * vec[j-1];
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> return sum;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> public static void Main (string[] argv)
</I>&gt;<i> {
</I>&gt;<i> int iterations = argv.Length &gt; 0 ? int.Parse(argv[0]) : 1000;
</I>&gt;<i> 
</I>&gt;<i> double[] vec = new double[100000];
</I>&gt;<i> for (int i = 0 ; i &lt; vec.Length ; i++)
</I>&gt;<i> vec[i] = i;
</I>&gt;<i> 
</I>&gt;<i> DateTime Tstart = DateTime.Now;
</I>&gt;<i> Console.WriteLine (&quot;starting performance test on &quot; + iterations + &quot;
</I>&gt;<i> iterations&quot;);
</I>&gt;<i> 
</I>&gt;<i> double sum = 0;
</I>&gt;<i> for (int i = 0 ; i &lt; iterations ; i++)
</I>&gt;<i> sum += test1 (vec);
</I>&gt;<i> 
</I>&gt;<i> DateTime Tend = DateTime.Now;
</I>&gt;<i> TimeSpan Tspan = Tend - Tstart;
</I>&gt;<i> Console.WriteLine (&quot;ending performance test on &quot; + iterations + &quot;
</I>&gt;<i> iterations, time: &quot; + Tspan.Seconds + &quot;:&quot; + Tspan.Milliseconds);
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Console.WriteLine (&quot;result: &quot; + sum);
</I>&gt;<i> }
</I>&gt;<i> }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="044345.html">[Mono-list] mono performance,	20x differential with Java (what am 	i doing wrong)
</A></li>
	<LI>Next message: <A HREF="044355.html">[Mono-list] mono performance,	20x differential with Java (what am i doing wrong)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44347">[ date ]</a>
              <a href="thread.html#44347">[ thread ]</a>
              <a href="subject.html#44347">[ subject ]</a>
              <a href="author.html#44347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
