<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Marshaling problem in .19
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jlaban%40wanadoo.fr">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011589.html">
   <LINK REL="Next"  HREF="011554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Marshaling problem in .19
   </H1>
    <B>Jerome Laban
    </B> 
    <A HREF="mailto:jlaban%40wanadoo.fr"
       TITLE="[Mono-list] Marshaling problem in .19">jlaban@wanadoo.fr
       </A><BR>
    <I>Sun, 26 Jan 2003 19:11:06 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="011589.html">[Mono-list] Marshaling problem in .19
</A></li>
        <LI> Next message: <A HREF="011554.html">[Mono-list] problem with Directory::GetParent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11607">[ date ]</a>
              <a href="thread.html#11607">[ thread ]</a>
              <a href="subject.html#11607">[ subject ]</a>
              <a href="author.html#11607">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------=_NextPart_000_058B_01C2C56E.ADA1ED20
Content-Type: text/plain;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: 8bit

Hi

It seems that there is a interpretation bug in the
CustomAttributeBuilder.get_umarshal method.

Some fix for the CustomAttributeBuilder.cs file is included with this post.
(I don't know where to find the meaning of the two bytes before string
size). If I trust the header of the file, this is your code Paolo.

But this does not seem to be enough, for the type description of this struct
:<i>
</I>
    [StructLayout(LayoutKind.Sequential)]
    public struct Test {
        [MarshalAs(UnmanagedType.ByValTStr, SizeConst=4)]
        public string a;
    }

Here is the IL disassembly from the mcs generated file :

    .field public marshal( fixed sysstring []) string a

Whereas with the csc generated file it is :

    .field public marshal( fixed sysstring[4]) string a

This seems to be an IL emitter bug, but I cannot find where it is...

By the way, the test file marshal2.cs fails with mono 0.19 and probably with
the 0.18 too.

___________
Jerome.

----- Original Message ----- 
From: &quot;Jérôme LABAN&quot; &lt;<A HREF="mailto:jlaban@wanadoo.fr">jlaban@wanadoo.fr</A>&gt;
To: &lt;<A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>&gt;
Sent: Saturday, January 25, 2003 9:08 PM
Subject: Re: [Mono-list] Marshaling problem in .19


&gt;<i> I'm also having troubles using String marshalling in some cases :
</I>&gt;<i>
</I>&gt;<i>     [MarshalAs(UnmanagedType.ByValStr, SizeConst=16)]
</I>&gt;<i>
</I>&gt;<i> seems to be loaded as
</I>&gt;<i>
</I>&gt;<i>     [MarshalAs(UnmanagedType.LPStr)]
</I>&gt;<i>
</I>&gt;<i> While actually, in the method emit_struct_info (marshal.c) on the line
</I>3013,
&gt;<i> I presume that
</I>&gt;<i> the info-&gt;fields[i].mspec should not return a NULL pointer when a marshal
</I>&gt;<i> attribute is set.
</I>&gt;<i>
</I>&gt;<i> Using LPStr while it should be ByValStr leads the marshaller to use string
</I>&gt;<i> data as a pointer.
</I>&gt;<i>
</I>&gt;<i> Is this a type loader problem ? mspec member should be filled with
</I>something
&gt;<i> I guess...
</I>&gt;<i>
</I>
------=_NextPart_000_058B_01C2C56E.ADA1ED20
Content-Type: application/octet-stream;
	name=&quot;CustomAttributeBuilder.cs.diff&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;CustomAttributeBuilder.cs.diff&quot;

69,74c69,71=0A=
&lt; 		internal static string string_from_bytes (byte[] data, int pos, int =
len) {=0A=
&lt; 			char[] chars =3D new char [len];=0A=
&lt; 			// FIXME: use a utf8 decoder here=0A=
&lt; 			for (int i =3D 0; i &lt; len; ++i)=0A=
&lt; 				chars [i] =3D (char)data [pos + i];=0A=
&lt; 			return new String (chars);=0A=
---=0A=
&gt;<i>         internal static string string_from_bytes (byte[] data, int =
</I>pos, int len)=20
&gt;<i>         {=0A=
</I>&gt;<i>             return System.Text.Encoding.UTF8.GetString(data, pos, len);=0A=
</I>78a76=0A=
&gt;<i> =0A=
</I>79a78=0A=
&gt;<i>             int sizeConst =3D 0;=0A=
</I>92,93c91,96=0A=
&lt; 			for (int i =3D 0; i &lt; nnamed; ++i) {=0A=
&lt; 				byte type =3D data [pos++];=0A=
---=0A=
&gt;<i> 			for (int i =3D 0; i &lt; nnamed; ++i)=0A=
</I>&gt;<i>             {=0A=
</I>&gt;<i>                 int paramType; // What is this ?=0A=
</I>&gt;<i>                 paramType =3D (int)data [pos++];=0A=
</I>&gt;<i>                 paramType |=3D ((int)data [pos++]) &lt;&lt; 8;=0A=
</I>&gt;<i> =0A=
</I>96a100=0A=
&gt;<i> =0A=
</I>104a109,115=0A=
&gt;<i>                 case &quot;SizeConst&quot;:=0A=
</I>&gt;<i>                     value =3D (int)data [pos++];=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 8;=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 16;=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 24;=0A=
</I>&gt;<i>                     sizeConst =3D value;=0A=
</I>&gt;<i>                     break;=0A=
</I>110c121,122=0A=
&lt; 			switch ((UnmanagedType)utype) {=0A=
---=0A=
&gt;<i>             switch ((UnmanagedType)utype)=20
</I>&gt;<i>             {=0A=
</I>115a128=0A=
&gt;<i>                     return =
</I>UnmanagedMarshal.DefineByValArray(sizeConst);=0A=
116a130=0A=
&gt;<i>                     return UnmanagedMarshal.DefineByValTStr(sizeConst);=0A=
</I>
------=_NextPart_000_058B_01C2C56E.ADA1ED20--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011589.html">[Mono-list] Marshaling problem in .19
</A></li>
	<LI> Next message: <A HREF="011554.html">[Mono-list] problem with Directory::GetParent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11607">[ date ]</a>
              <a href="thread.html#11607">[ thread ]</a>
              <a href="subject.html#11607">[ subject ]</a>
              <a href="author.html#11607">[ author ]</a>
         </LI>
       </UL>
</body></html>
