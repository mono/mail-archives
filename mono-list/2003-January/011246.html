<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Performance / array access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mitchskin%40attbi.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011239.html">
   <LINK REL="Next"  HREF="011407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Performance / array access
   </H1>
    <B>Mitchell Skinner
    </B> 
    <A HREF="mailto:mitchskin%40attbi.com"
       TITLE="[Mono-list] Performance / array access">mitchskin@attbi.com
       </A><BR>
    <I>14 Jan 2003 15:41:53 -0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="011239.html">[Mono-list] Performance / array access
</A></li>
        <LI> Next message: <A HREF="011407.html">[Mono-list] Performance / array access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11246">[ date ]</a>
              <a href="thread.html#11246">[ thread ]</a>
              <a href="subject.html#11246">[ subject ]</a>
              <a href="author.html#11246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

The runtime inserts array bounds checks to prevent things like buffer
overflows.  So the following code:
   int len = array.Length;
   for (int i = 0; i &lt; len; ++i)
      sum += array [i];
becomes something like:
   int len = array.Length;
   for (int i = 0; i &lt; len; ++i) {
      if (i &gt;= array.Length) throw new Exception; //forgot which
      sum += array [i];
   }

In the fast case, the MS JIT is smart enough to analyze the following
code and figure out that &quot;i&quot; will not go out of the bounds of the array
(because i starts at zero and stays below array.Length):
   for (int i = 0; i &lt; array.Length; ++i)
      sum += array [i];

If the for loop isn't set up exactly like that, I don't think the MS JIT is able to eliminate the bounds check (unless perhaps there are constants involved).  Is the code you have below (comparing i with a &quot;size&quot; variable) the exact code you tested?  If &quot;size&quot; is not a constant, I would be suprised to find that there was a major difference between MS and mono.

Are you using the MS 1.0 release or the 1.1 release?

Mitch


On Tue, 2003-01-14 at 13:38, Tom Fransen wrote:
&gt;<i> Piers,
</I>&gt;<i> 
</I>&gt;<i> can you spend a few more words on this. Why is the second case slower?
</I>&gt;<i> 
</I>&gt;<i> Furthermore if I use a simple loop to fill an array the
</I>&gt;<i> speed difference is a factor 3. I have a bubble sort method
</I>&gt;<i> that I execute a larger number of times. On Mono it takes 19 seconds
</I>&gt;<i> on the MS stuff ~6 seconds. This is a big difference. So why I am
</I>&gt;<i> losing a factor 3 on the following loop.
</I>&gt;<i> 
</I>&gt;<i>                 // Fill aray worst case, all elements need to be swapped
</I>&gt;<i>                 for(int i=0; i&lt; size; i++)
</I>&gt;<i>                 {
</I>&gt;<i>                     array[i] = size - i;
</I>&gt;<i>                 }
</I>&gt;<i> 
</I>&gt;<i> I am testing with some small benchmarks, but real applications (e.g. an MP3
</I>&gt;<i> decoder)
</I>&gt;<i> often use tables stored in arrays to do certain calculations.
</I>&gt;<i> So although the benchmark maybe syntetic certain application will
</I>&gt;<i> suffer from these penalties.
</I>&gt;<i> 
</I>&gt;<i> regards,
</I>&gt;<i> Tom
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Miguel de Icaza [mailto:<A HREF="mailto:miguel@ximian.com">miguel@ximian.com</A>]
</I>&gt;<i> Sent: Monday, January 13, 2003 3:22 AM
</I>&gt;<i> To: Piers Haken
</I>&gt;<i> Cc: Tom Fransen; <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
</I>&gt;<i> Subject: RE: [Mono-list] Performance / array access
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> &gt; Yeah, Microsoft's JIT lifts invariant bounds-checks. But I believe
</I>&gt;<i> &gt; it's pretty limited.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For example, the check is removed in the following case:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   for (int i = 0; i &lt; array.Length; ++i)
</I>&gt;<i> &gt;     sum += array [i];
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But not here:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   int len = array.Length;
</I>&gt;<i> &gt;   for (int i = 0; i &lt; len; ++i)
</I>&gt;<i> &gt;     sum += array [i];
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So the first case is (counter-intuitively) faster than the second.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don't believe Mono's JIT makes this optimization. Maybe the new JIT
</I>&gt;<i> &gt; will ;-)
</I>&gt;<i> 
</I>&gt;<i> This is a very good observation.  Because it seems that this particular
</I>&gt;<i> kind of loop is detected by the JIT engine.
</I>&gt;<i> 
</I>&gt;<i> Array-bounds-check elimination is something we want to do with the new
</I>&gt;<i> JIT, but it is not implemented at this point.  The new JIT features a
</I>&gt;<i> new intermediate representation that simplifies implementing this sort
</I>&gt;<i> of thing, but it is still on its bootstrapping phases of life.
</I>&gt;<i> 
</I>&gt;<i> Miguel
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>-- 
Mitchell Skinner &lt;<A HREF="mailto:mitchskin@attbi.com">mitchskin@attbi.com</A>&gt;



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011239.html">[Mono-list] Performance / array access
</A></li>
	<LI> Next message: <A HREF="011407.html">[Mono-list] Performance / array access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11246">[ date ]</a>
              <a href="thread.html#11246">[ thread ]</a>
              <a href="subject.html#11246">[ subject ]</a>
              <a href="author.html#11246">[ author ]</a>
         </LI>
       </UL>
</body></html>
