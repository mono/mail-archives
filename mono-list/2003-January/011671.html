<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Unhandled Exception: System.ArgumentException: Arg_InvalidUTF8
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:btouchet%40drakonis.dyndns.org">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011669.html">
   <LINK REL="Next"  HREF="011666.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Unhandled Exception: System.ArgumentException: Arg_InvalidUTF8
   </H1>
    <B>btouchet
    </B> 
    <A HREF="mailto:btouchet%40drakonis.dyndns.org"
       TITLE="[Mono-list] Unhandled Exception: System.ArgumentException: Arg_InvalidUTF8">btouchet@drakonis.dyndns.org
       </A><BR>
    <I>27 Jan 2003 22:43:11 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="011669.html">[Mono-list] Beginnings of an Alpha trampoline.
</A></li>
        <LI> Next message: <A HREF="011666.html">[Mono-list] Bug 35150
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11671">[ date ]</a>
              <a href="thread.html#11671">[ thread ]</a>
              <a href="subject.html#11671">[ subject ]</a>
              <a href="author.html#11671">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-QC6m/r6JYl0ngpyHfLGH
Content-Type: text/plain
Content-Transfer-Encoding: quoted-printable

I have application which generates the following message when trying to
read a line with a character with a value greater than 0x7f (in this
particular case it is the (C) symbol in a text file):

Unhandled Exception: System.ArgumentException: Arg_InvalidUTF8
Parameter name: bytes
in &lt;0x003a2&gt; 00 System.Text.UTF8Encoding:InternalGetChars
(byte[],int,int,char[],int,uint&amp;,uint&amp;,bool,bool)
in &lt;0x00039&gt; 00 .UTF8Decoder:GetChars (byte[],int,int,char[],int)
in &lt;0x00374&gt; 00 System.IO.StreamReader:ReadBuffer ()
in &lt;0x00088&gt; 00 System.IO.StreamReader:Read ()
in &lt;0x00049&gt; 00 System.IO.StreamReader:ReadLine ()
in &lt;0x002c3&gt; 00 lc.Class1:ConvertFile (System.IO.FileInfo)
in &lt;0x001cc&gt; 00 lc.Class1:Main (string[])

I have tried this same code in MS .NET and they just discard the
character, where instead in mono it throws the above exception.

I followed the code down to UTF8Encoding.cs and it seems that when i hit
the InternalGetChars if leftsize =3D=3D 0 and the character leftover isn't =
a
value under 0x80 or a UTF start value then an exception is thrown.

I replaced the following code=20
if (leftSize =3D=3D 0) {
...
...
} else {
	// Invalid UTF-8 start character.
	if (throwOnInvalid) {
		throw new ArgumentException (_(&quot;Arg_InvalidUTF8&quot;), &quot;bytes1&quot;);
	}

with :

if (leftSize =3D=3D 0) {
...
...
} else {
	if (posn &gt;=3D length) {
		throw new ArgumentException (_(&quot;Arg_InsufficientSpace&quot;), &quot;chars&quot;);
	}
	chars[posn++] =3D (char)ch;

and my program is now happy.


What i would like to know is, wouldn't be better if the character were
just added to the buffer without any fuss (or least discarded without an
exception being thrown like what seems to be happening under .NET)?=20

--=20
btouchet &lt;<A HREF="mailto:btouchet@drakonis.dyndns.org">btouchet@drakonis.dyndns.org</A>&gt;

--=-QC6m/r6JYl0ngpyHfLGH
Content-Type: application/pgp-signature; name=signature.asc
Content-Description: This is a digitally signed message part

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.0.7 (GNU/Linux)

iD8DBQA+NfxPvko8cCR4S6IRAizlAKCRtXGbF0xsNc5kxzhr8z/RC+nMLACgrSbi
VaoLfsUlusQzCASSl2bB0uk=
=52CT
-----END PGP SIGNATURE-----

--=-QC6m/r6JYl0ngpyHfLGH--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011669.html">[Mono-list] Beginnings of an Alpha trampoline.
</A></li>
	<LI> Next message: <A HREF="011666.html">[Mono-list] Bug 35150
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11671">[ date ]</a>
              <a href="thread.html#11671">[ thread ]</a>
              <a href="subject.html#11671">[ subject ]</a>
              <a href="author.html#11671">[ author ]</a>
         </LI>
       </UL>
</body></html>
