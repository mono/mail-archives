<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Patches for MarshalAsAttribute in 0.19
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jlaban%40wanadoo.fr">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011613.html">
   <LINK REL="Next"  HREF="011645.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Patches for MarshalAsAttribute in 0.19
   </H1>
    <B>Jerome Laban
    </B> 
    <A HREF="mailto:jlaban%40wanadoo.fr"
       TITLE="[Mono-list] Patches for MarshalAsAttribute in 0.19">jlaban@wanadoo.fr
       </A><BR>
    <I>Mon, 27 Jan 2003 00:19:48 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="011613.html">[Mono-list] Runtime not working in Cygwin
</A></li>
        <LI> Next message: <A HREF="011645.html">[Mono-list] Patches for MarshalAsAttribute in 0.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11620">[ date ]</a>
              <a href="thread.html#11620">[ thread ]</a>
              <a href="subject.html#11620">[ subject ]</a>
              <a href="author.html#11620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------=_NextPart_000_05CF_01C2C599.CDCB0DE0
Content-Type: multipart/alternative;
	boundary=&quot;----=_NextPart_001_05D0_01C2C599.CDD2AF00&quot;


------=_NextPart_001_05D0_01C2C599.CDD2AF00
Content-Type: text/plain;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

Hi,

Thanks to miguel I've found where the problem concerning the =
MarshalAsAttribute was. The blob containing the pseudo custom attribute =
data was not filled at all when using mcs to generate the assembly.

So, here are tree patches for Mono-0.19, maybe partial but fixing the =
marshaling for types UnmanagedType.ByValArray and =
UnmanagedType.ByValTStr with a SizeConst parameter.

mono-0.19/mono/metadata/reflection.c
mcs-0.19/class/System.Reflection.Emit/FieldBuilder.cs
mcs-0.19/class/System.Reflection.Emit/CustomAttributeBuilder.cs

(Sorry if patches are not like they are used to be, I'm not used to make =
diff files)

These patches allows marshal1 to marshal4 tests to run without errors.

Could anyone test it and commit it if ok ?

thanks,

Jerome.
------=_NextPart_001_05D0_01C2C599.CDD2AF00
Content-Type: text/html;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.0 Transitional//EN&quot;&gt;
&lt;HTML&gt;&lt;HEAD&gt;
&lt;META http-equiv=3DContent-Type content=3D&quot;text/html; =
charset=3Diso-8859-1&quot;&gt;
&lt;META content=3D&quot;MSHTML 6.00.2800.1126&quot; name=3DGENERATOR&gt;
&lt;STYLE&gt;&lt;/STYLE&gt;
&lt;/HEAD&gt;
&lt;BODY bgColor=3D#ffffff&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;Hi,&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;Thanks to miguel I've found where the problem =
concerning the=20
MarshalAsAttribute was. The blob containing the pseudo custom attribute =
data was=20
not filled at all when using mcs to generate the assembly.&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;So, here are tree patches for Mono-0.19, maybe =
partial but=20
fixing the marshaling for types UnmanagedType.ByValArray and=20
UnmanagedType.ByValTStr with a SizeConst parameter.&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;mono-0.19/mono/metadata/reflection.c&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT=20
size=3D2&gt;mcs-0.19/class/System.Reflection.Emit/FieldBuilder.cs&lt;/FONT&gt;&lt;/DI=
V&gt;
&lt;DIV&gt;&lt;FONT=20
size=3D2&gt;mcs-0.19/class/System.Reflection.Emit/CustomAttributeBuilder.cs&lt;=
/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;(Sorry if patches are not like they are used to be, =
I'm not=20
used to make diff files)&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;These patches allows marshal1 to marshal4 tests to =
run without=20
errors.&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;Could anyone test it and commit it if ok =
?&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;thanks,&lt;/FONT&gt;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;
&lt;DIV&gt;&lt;FONT size=3D2&gt;Jerome.&lt;/FONT&gt;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;

------=_NextPart_001_05D0_01C2C599.CDD2AF00--

------=_NextPart_000_05CF_01C2C599.CDCB0DE0
Content-Type: application/octet-stream;
	name=&quot;reflection.c.diff&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;reflection.c.diff&quot;

1057,1060c1057,1066=0A=
&lt; 	/* FIXME: handle ARRAY and other unmanaged types that need extra info =
*/=0A=
&lt; 	default:=0A=
&lt; 		mono_metadata_encode_value (minfo-&gt;type, p, &amp;p);=0A=
&lt; 		break;=0A=
---=0A=
&gt;<i>         case MONO_NATIVE_BYVALTSTR:=0A=
</I>&gt;<i>         case MONO_NATIVE_BYVALARRAY:=0A=
</I>&gt;<i>             mono_metadata_encode_value (minfo-&gt;type, p, &amp;p);=0A=
</I>&gt;<i>             mono_metadata_encode_value (minfo-&gt;count, p, &amp;p);=0A=
</I>&gt;<i>             break;=0A=
</I>&gt;<i> =0A=
</I>&gt;<i> 	    /* FIXME: handle ARRAY and other unmanaged types that need extra =
</I>info */=0A=
&gt;<i> 	    default:=0A=
</I>&gt;<i> 		    mono_metadata_encode_value (minfo-&gt;type, p, &amp;p);=0A=
</I>&gt;<i> 		    break;=0A=
</I>
------=_NextPart_000_05CF_01C2C599.CDCB0DE0
Content-Type: application/octet-stream;
	name=&quot;FieldBuilder.cs.diff&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;FieldBuilder.cs.diff&quot;

96a97=0A=
&gt;<i>                 attrs |=3D FieldAttributes.HasFieldMarshal;=0A=
</I>
------=_NextPart_000_05CF_01C2C599.CDCB0DE0
Content-Type: application/octet-stream;
	name=&quot;CustomAttributeBuilder.cs.diff&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;CustomAttributeBuilder.cs.diff&quot;

69,74c69,71=0A=
&lt; 		internal static string string_from_bytes (byte[] data, int pos, int =
len) {=0A=
&lt; 			char[] chars =3D new char [len];=0A=
&lt; 			// FIXME: use a utf8 decoder here=0A=
&lt; 			for (int i =3D 0; i &lt; len; ++i)=0A=
&lt; 				chars [i] =3D (char)data [pos + i];=0A=
&lt; 			return new String (chars);=0A=
---=0A=
&gt;<i>         internal static string string_from_bytes (byte[] data, int =
</I>pos, int len)=20
&gt;<i>         {=0A=
</I>&gt;<i>             return System.Text.Encoding.UTF8.GetString(data, pos, len);=0A=
</I>78a76=0A=
&gt;<i> =0A=
</I>79a78=0A=
&gt;<i>             int sizeConst =3D 0;=0A=
</I>92,93c91,96=0A=
&lt; 			for (int i =3D 0; i &lt; nnamed; ++i) {=0A=
&lt; 				byte type =3D data [pos++];=0A=
---=0A=
&gt;<i> 			for (int i =3D 0; i &lt; nnamed; ++i)=0A=
</I>&gt;<i>             {=0A=
</I>&gt;<i>                 int paramType; // What is this ?=0A=
</I>&gt;<i>                 paramType =3D (int)data [pos++];=0A=
</I>&gt;<i>                 paramType |=3D ((int)data [pos++]) &lt;&lt; 8;=0A=
</I>&gt;<i> =0A=
</I>96a100=0A=
&gt;<i> =0A=
</I>104a109,115=0A=
&gt;<i>                 case &quot;SizeConst&quot;:=0A=
</I>&gt;<i>                     value =3D (int)data [pos++];=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 8;=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 16;=0A=
</I>&gt;<i>                     value |=3D ((int)data [pos++]) &lt;&lt; 24;=0A=
</I>&gt;<i>                     sizeConst =3D value;=0A=
</I>&gt;<i>                     break;=0A=
</I>110c121,122=0A=
&lt; 			switch ((UnmanagedType)utype) {=0A=
---=0A=
&gt;<i>             switch ((UnmanagedType)utype)=20
</I>&gt;<i>             {=0A=
</I>115a128=0A=
&gt;<i>                     return =
</I>UnmanagedMarshal.DefineByValArray(sizeConst);=0A=
116a130=0A=
&gt;<i>                     return UnmanagedMarshal.DefineByValTStr(sizeConst);=0A=
</I>
------=_NextPart_000_05CF_01C2C599.CDCB0DE0--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011613.html">[Mono-list] Runtime not working in Cygwin
</A></li>
	<LI> Next message: <A HREF="011645.html">[Mono-list] Patches for MarshalAsAttribute in 0.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11620">[ date ]</a>
              <a href="thread.html#11620">[ thread ]</a>
              <a href="subject.html#11620">[ subject ]</a>
              <a href="author.html#11620">[ author ]</a>
         </LI>
       </UL>
</body></html>
