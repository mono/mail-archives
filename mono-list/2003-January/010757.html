<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] mono_verify_corlib - Checking on non-standard fields - Why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="010753.html">
   <LINK REL="Next"  HREF="010801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] mono_verify_corlib - Checking on non-standard fields - Why?
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] mono_verify_corlib - Checking on non-standard fields - Why?">lupus@ximian.com
       </A><BR>
    <I>Thu, 2 Jan 2003 16:44:43 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="010753.html">[Mono-list] mono_verify_corlib - Checking on non-standard fields - Why?
</A></li>
        <LI> Next message: <A HREF="010801.html">[Mono-list] Re: mono_verify_corlib - Checking on non-standard fields - Why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10757">[ date ]</a>
              <a href="thread.html#10757">[ thread ]</a>
              <a href="subject.html#10757">[ subject ]</a>
              <a href="author.html#10757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/02/03 bvv wrote:
&gt;<i> Running mint I found that there's a check done on the corlib. 
</I>&gt;<i> interp.c has a call to funciton &quot;mono_verify_corlib&quot; which is 
</I>&gt;<i> found in verify.c.
</I>&gt;<i> I was surprised to find that the verification involves checking if 
</I>&gt;<i> certain &quot;private&quot; fields are present in various classes of corlib. 
</I>&gt;<i> I say &quot;private&quot; because these fields are *NOT* part of the ECMA 
</I>&gt;<i> standard class definitions.
</I>&gt;<i> 
</I>&gt;<i> I stepped through Rotor code to see if they do they same thing, 
</I>&gt;<i> and yes they do!
</I>&gt;<i> 
</I>&gt;<i> If u try to replace Rotor's corlib with mono's corlib the checking 
</I>&gt;<i> that Rotor does on the corlib fails because the *private* fields 
</I>&gt;<i> that Rotor expects to find are either not available in mono's 
</I>&gt;<i> corlib or the name of the field differs!
</I>&gt;<i> 
</I>&gt;<i> Now, what i don't understand is
</I>&gt;<i> What's the purpose of corlib verification?
</I>&gt;<i> Why is corlib verification done based on such *private* fields?
</I>
The easiest and fastest way to communicate between the managed world and
the unmanaged world of the runtime is to lay out the things in memory in
a way that is understood by both worlds. Many types that are tightly
coupled with the runtime implementation (such as String, Type, the
Reflection and Reflection.Emit stuff and so on) have the same memory
layout in the managed and unmanaged world: mono_verify_corlib ()
checks that this is the case (not all the fields and types are checked
yet, though).
As a trivial example, consider the System.String class: there is one
field declared in the C# side of things: length. This field is accessed by the
string class code, but it is also accessed (and set) by the runtime, in
C code. Now, you could access it in C code by queyring the metadata for
the offset of the field and accessing it with address arithmetric and an
indirect load/store (in the early days of mono we used to do that and I bet
we still do it for some types somewhere). It's ways better to define a C
struct that has the same layout as the managed string class, so that in
C code you can access the fields of the structure naturally: the code is
cleaner and faster.

lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="010753.html">[Mono-list] mono_verify_corlib - Checking on non-standard fields - Why?
</A></li>
	<LI> Next message: <A HREF="010801.html">[Mono-list] Re: mono_verify_corlib - Checking on non-standard fields - Why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10757">[ date ]</a>
              <a href="thread.html#10757">[ thread ]</a>
              <a href="subject.html#10757">[ subject ]</a>
              <a href="author.html#10757">[ author ]</a>
         </LI>
       </UL>
</body></html>
