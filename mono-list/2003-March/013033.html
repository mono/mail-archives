<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] System.Net.Sockets.SocketException
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:simon%40psionics.demon.co.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013032.html">
   <LINK REL="Next"  HREF="013039.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] System.Net.Sockets.SocketException
   </H1>
    <B>Simon Waite
    </B> 
    <A HREF="mailto:simon%40psionics.demon.co.uk"
       TITLE="[Mono-list] System.Net.Sockets.SocketException">simon@psionics.demon.co.uk
       </A><BR>
    <I>Thu, 20 Mar 2003 00:32:02 -0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="013032.html">[Mono-list] System.Net.Sockets.SocketException
</A></li>
        <LI> Next message: <A HREF="013039.html">[Mono-list] System.Net.Sockets.SocketException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13033">[ date ]</a>
              <a href="thread.html#13033">[ thread ]</a>
              <a href="subject.html#13033">[ subject ]</a>
              <a href="author.html#13033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Plaintexted for the reply

Hi Tim,

----
But I get the following with the mono runtime:

Unhandled Exception:
TPSoftware.Q3PlugsNet.Exceptions.ConnectionRefusedException
:<i> The connection was refused by the remote host: 195.130.132.155:27961
</I>Some sort of w32 error occurred ---&gt; System.Net.Sockets.SocketException:
Some so
rt of w32 error occurred
in (unmanaged) 06 System.Net.Sockets.Socket:RecvFrom_internal
(intptr,byte[],int
,int,System.Net.Sockets.SocketFlags,System.Net.SocketAddress&amp;)
----

Looks like some odd interaction between mono and win32s Winsock2 layer.

Have you tried to run your app on a linux as well ? I would be pleased
to give it a try under linux for you.

Otherwise see if you can make a simple testcase, and file a bugzilla report!

Regards,

Simon




----- Original Message -----
From: Timothy Parez
To: <A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>
Sent: Wednesday, March 19, 2003 11:19 PM
Subject: Re: [Mono-list] System.Net.Sockets.SocketException


Update 2:
The error doesn't seem to be gone at all :(
So the problem remains.
----- Original Message -----
From: Timothy Parez
To: <A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>
Sent: Wednesday, March 19, 2003 11:52 PM
Subject: Re: [Mono-list] System.Net.Sockets.SocketException


Update:

It seems that when I changed everything to ASCII instead of UTF7 everything
works fine and there are no more socket exceptions. Although I don't get the
link between the encoding and the socket exceptions, so it may be
coïncidence.

Can someone verify this ?
----- Original Message -----
From: Timothy Parez
To: <A HREF="mailto:mono-list@ximian.com">mono-list@ximian.com</A>
Sent: Wednesday, March 19, 2003 11:08 PM
Subject: [Mono-list] System.Net.Sockets.SocketException


Hi,

I'm writing a set of class libs for .NET/Mono,
except for the UTF7 Encoding in my other post, it should work fine.
And it does on .NET, but not on Mono.

I don't know where to start, but I'll try to explain.

First of all I have a Base Class which amongst other members has the
following function

 private void ExecuteQuery()
  {
   UdpClient client = new UdpClient();
   //Connect to the server and send the query data
   try
   {
    client.Connect(ip,port);
    client.Send(data,data.Length);
   }
   catch
   {
    client.Close();
    throw new Exceptions.InvalidHostException(&quot;Unknown host: &quot; + ip);
   }

   //Listen for a response - This is the client side
   IPEndPoint serverIPEndPoint = new IPEndPoint(IPAddress.Any,0);

   //Receive the response
   try
   {
    queryResponse = client.Receive(ref serverIPEndPoint);
   }
   catch (Exception e)
   {
    throw new Exceptions.ConnectionRefusedException(&quot;The connection was
refused by the remote host: &quot; + ip + &quot;:&quot; + port.ToString() + &quot;\n&quot; +
e.Message,e);
   }
   finally
   {
    client.Close();
   }
  }

As you can see it sends a n array of bytes to the server and receives some
in return.

Then I have a derived class which has 2 important functions:

  public string RequestStatus()
  {
   //Create the byte[] array to send
   byte[] query =
{0xFF,0xFF,0xFF,0xFF,0x67,0x65,0x74,0x73,0x74,0x61,0x74,0x75,0x73,0xA};

   //Create a new separator
   char separator = Convert.ToChar(10);

   //A statusRequest consists of both rules and players separated by
char(10)
   string[] response = this.QueryToString(query).Split(separator);

   //Get the rules and players
   string rules = this.RulesToXml(response[0]);
   string players = this.PlayersToXml(response);

   return
this.CreateXmlBody(&quot;Quake3&quot;,&quot;statusRequest&quot;,string.Concat(rules,players));
  }

And

  public string RequestInfo()
  {
   //Create the byte[] array to send
   byte[] query =
{0xFF,0xFF,0xFF,0xFF,0x67,0x65,0x74,0x69,0x6E,0x66,0x6F,0xA};

   //Query the server and get the response in a string
   string response = this.QueryToString(query);

   //Create the default xml body and put the rules in it
   string returnValue =
this.CreateXmlBody(&quot;Quake3&quot;,&quot;infoRequest&quot;,this.RulesToXml(response));

   //return the XML
   return returnValue;
  }

As you can see there is almost no difference between them.
Now they both run fine with the .NET runtime, but with the mono runtime the
.RequestStatus() fails.

When does it fail well when the QueryToString function is called,
so if I run RequestInfo() the QueryToString function is called and it all
works fine,
if I run RequestStatus() the QueryToString function is called and it goes
wrong.
In my opinion the only difference so far is the array of bytes to be sent.

Example:

Let's say I use the following code for an application

using System;
using TPSoftware.Q3PlugsNet;
using TPSoftware.Q3PlugsNet.Exceptions;

class MainClass
{
 public static void Main(string[] args)
 {

  //Create a new Q3Query

 // Q3Query quakeClient = new Q3Query(&quot;195.130.132.153&quot;,27961);
  Q3Query quakeClient = new Q3Query(&quot;195.130.132.155&quot;,27961);

  try
  {
   string info = quakeClient.RequestStatus();
   Console.WriteLine(info);
  }
  catch (Exception e)
  {
   Console.WriteLine(&quot;ERROR:&quot;);
   Console.WriteLine(&quot;\n&quot; + e.ToString());

  }
  finally
  {
  Console.ReadLine();
  }
 }
}

Well then I get the following result with .NET runtime

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-7&quot; standalone=&quot;yes&quot;?&gt;&lt;Q3Plugs.NET&gt;&lt;Query
type=
&quot;statusRequest&quot; protocol=&quot;Quake3&quot;&gt;&lt;Server ipadress=&quot;195.130.132.155&quot;
port=&quot;27961
&quot; /&gt;&lt;Rules count=&quot;28&quot;&gt;&lt;rule name=&quot;capturelimit&quot;&gt;&lt;![CDATA[8]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;
sv_floodProtect&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;sv_maxPing&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule
&gt;<i>&lt;rule name=&quot;sv_minPing&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
</I>name=&quot;sv_maxRate&quot;&gt;&lt;![CDATA[15
000]]&gt;&lt;/rule&gt;&lt;rule name=&quot;sv_punkbuster&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;sv_maxcl
ients&quot;&gt;&lt;![CDATA[14]]&gt;&lt;/rule&gt;&lt;rule name=&quot;sv_hostname&quot;&gt;&lt;![CDATA[Telenet Q3A
OSP CA
 Server]]&gt;&lt;/rule&gt;&lt;rule name=&quot;timelimit&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;fraglimi
t&quot;&gt;&lt;![CDATA[25]]&gt;&lt;/rule&gt;&lt;rule name=&quot;dmflags&quot;&gt;&lt;![CDATA[8]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;ver
sion&quot;&gt;&lt;![CDATA[Q3 1.32 linux-i386 Oct  7 2002]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;g_gametype&quot;&gt;&lt;
![CDATA[5]]&gt;&lt;/rule&gt;&lt;rule name=&quot;protocol&quot;&gt;&lt;![CDATA[68]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;mapnam
e&quot;&gt;&lt;![CDATA[q3dm6]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;sv_privateClients&quot;&gt;&lt;![CDATA[2]]&gt;&lt;/rule&gt;&lt;r
ule name=&quot;sv_allowDownload&quot;&gt;&lt;![CDATA[1]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;server_promode&quot;&gt;&lt;![C
DATA[0]]&gt;&lt;/rule&gt;&lt;rule name=&quot;server_cq3&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;g_needpa
ss&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;server_ospauth&quot;&gt;&lt;![CDATA[2]]&gt;&lt;/rule&gt;&lt;rule na
me=&quot;gamename&quot;&gt;&lt;![CDATA[osp]]&gt;&lt;/rule&gt;&lt;rule name=&quot;gameversion&quot;&gt;&lt;![CDATA[OSP
v1.03]
]&gt;&lt;/rule&gt;&lt;rule name=&quot;Players_Red&quot;&gt;&lt;![CDATA[2 4 6 8 10 ]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;Play
ers_Blue&quot;&gt;&lt;![CDATA[1 3 5 7 9 ]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;Score_Red&quot;&gt;&lt;![CDATA[15]]&gt;&lt;/ru
le&gt;&lt;rule name=&quot;Score_Blue&quot;&gt;&lt;![CDATA[17]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;Score_Time&quot;&gt;&lt;![CDATA
[Round 33/49]]&gt;&lt;/rule&gt;&lt;/Rules&gt;&lt;Players count=&quot;10&quot;&gt;&lt;Player score=&quot;20&quot;
ping=&quot;15&quot;&gt;&lt;
![CDATA[&quot;^5DA^4.^5Ch^7a^5o^7s&quot;]]&gt;&lt;/Player&gt;&lt;Player score=&quot;12&quot;
ping=&quot;24&quot;&gt;&lt;![CDATA[
&quot;UnnamedPlaye^1r&quot;]]&gt;&lt;/Player&gt;&lt;Player score=&quot;48&quot;
ping=&quot;38&quot;&gt;&lt;![CDATA[&quot;^b^0*^n^7mnl
^b^0*&quot;]]&gt;&lt;/Player&gt;&lt;Player score=&quot;38&quot;
ping=&quot;38&quot;&gt;&lt;![CDATA[&quot;^xffffff^9eHk^b^4*^n^0T
^9N^0T&quot;]]&gt;&lt;/Player&gt;&lt;Player score=&quot;80&quot;
ping=&quot;25&quot;&gt;&lt;![CDATA[&quot;^5B^7osje^5R&quot;]]&gt;&lt;/Play
er&gt;&lt;Player score=&quot;85&quot;
ping=&quot;24&quot;&gt;&lt;![CDATA[&quot;^x00FF00^2911^xFFFFFF^0&gt;&gt;^7SaTo&quot;]]&gt;&lt;/P
layer&gt;&lt;Player score=&quot;18&quot; ping=&quot;52&quot;&gt;&lt;![CDATA[&quot;^4jerome&quot;]]&gt;&lt;/Player&gt;&lt;Player
score=
&quot;96&quot; ping=&quot;41&quot;&gt;&lt;![CDATA[&quot;^x3366FF^7e^0C^7'.E^0mo^7Z&quot;]]&gt;&lt;/Player&gt;&lt;Player
score=&quot;1
1&quot; ping=&quot;16&quot;&gt;&lt;![CDATA[&quot;crypto&quot;]]&gt;&lt;/Player&gt;&lt;Player score=&quot;73&quot;
ping=&quot;40&quot;&gt;&lt;![CDATA[
&quot;^0fearl^33^0ss&quot;]]&gt;&lt;/Player&gt;&lt;/Players&gt;&lt;/Query&gt;&lt;/Q3Plugs.NET&gt;

But I get the following with the mono runtime:

Unhandled Exception:
TPSoftware.Q3PlugsNet.Exceptions.ConnectionRefusedException
:<i> The connection was refused by the remote host: 195.130.132.155:27961
</I>Some sort of w32 error occurred ---&gt; System.Net.Sockets.SocketException:
Some so
rt of w32 error occurred
in (unmanaged) 06 System.Net.Sockets.Socket:RecvFrom_internal
(intptr,byte[],int
,int,System.Net.Sockets.SocketFlags,System.Net.SocketAddress&amp;)
in &lt;0x00004&gt; 06 System.Net.Sockets.Socket:RecvFrom_internal
(intptr,byte[],int,i
nt,System.Net.Sockets.SocketFlags,System.Net.SocketAddress&amp;)
in &lt;0x00155&gt; 00 System.Net.Sockets.Socket:ReceiveFrom
(byte[],int,int,System.Net
.Sockets.SocketFlags,System.Net.EndPoint&amp;)
in &lt;0x00180&gt; 00 System.Net.Sockets.Socket:ReceiveFrom
(byte[],int,int,System.Net
.Sockets.SocketFlags,System.Net.EndPoint&amp;)
in &lt;0x0002a&gt; 00 System.Net.Sockets.Socket:ReceiveFrom
(byte[],System.Net.EndPoin
t&amp;)
in &lt;0x000af&gt; 00 System.Net.Sockets.UdpClient:Receive
(System.Net.IPEndPoint&amp;)
in &lt;0x0016b&gt; 00 TPSoftware.Q3PlugsNet.QueryBase:ExecuteQuery ()
--- End of inner exception stack trace ---

in &lt;0x002b4&gt; 00 TPSoftware.Q3PlugsNet.QueryBase:ExecuteQuery ()
in &lt;0x0005b&gt; 01 System.MulticastDelegate:invoke_void ()


However if I change the above code to:

using System;
using TPSoftware.Q3PlugsNet;
using TPSoftware.Q3PlugsNet.Exceptions;

class MainClass
{
 public static void Main(string[] args)
 {

  //Create a new Q3Query

 // Q3Query quakeClient = new Q3Query(&quot;195.130.132.153&quot;,27961);
  Q3Query quakeClient = new Q3Query(&quot;195.130.132.155&quot;,27961);

  try
  {
   string info = quakeClient.RequestInfo(); // RequestInfo instead of
RequestStatus !!!!!!!!
   Console.WriteLine(info);
  }
  catch (Exception e)
  {
   Console.WriteLine(&quot;ERROR:&quot;);
   Console.WriteLine(&quot;\n&quot; + e.ToString());


  }
  finally
  {
  Console.ReadLine();
  }
 }
}

I get the following output with .NET

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-7&quot; standalone=&quot;yes&quot;?&gt;&lt;Q3Plugs.NET&gt;&lt;Query
type=
&quot;infoRequest&quot; protocol=&quot;Quake3&quot;&gt;&lt;Server ipadress=&quot;195.130.132.155&quot;
port=&quot;27961&quot;
/&gt;&lt;Rules count=&quot;9&quot;&gt;&lt;rule name=&quot;game&quot;&gt;&lt;![CDATA[osp]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;punkbuste
r&quot;&gt;&lt;![CDATA[0]]&gt;&lt;/rule&gt;&lt;rule name=&quot;pure&quot;&gt;&lt;![CDATA[1]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;gametyp
e&quot;&gt;&lt;![CDATA[5]]&gt;&lt;/rule&gt;&lt;rule name=&quot;sv_maxclients&quot;&gt;&lt;![CDATA[12]]&gt;&lt;/rule&gt;&lt;rule
nam
e=&quot;clients&quot;&gt;&lt;![CDATA[2]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;mapname&quot;&gt;&lt;![CDATA[q3dm6]]&gt;&lt;/rule&gt;&lt;ru
le name=&quot;hostname&quot;&gt;&lt;![CDATA[Telenet Q3A OSP CA Server]]&gt;&lt;/rule&gt;&lt;rule
name=&quot;proto
col&quot;&gt;&lt;![CDATA[68]]&gt;&lt;/rule&gt;&lt;/Rules&gt;&lt;/Query&gt;&lt;/Q3Plugs.NET&gt;

And the following output with mono (don't mind the encoding, that's another
bug)

???xml version???1.0?? encoding???utf-7?? standalone???yes????
??Q3Plugs.NET? ??
Query type???infoRequest?? protocol???Quake3??? ??Server
ipadress???195.130.132.
155?? port???27961?? /? ???Rules count????+BDJAAARO?????
name?????+BDJAAARO???+E
JwMQFQE+AFs-osp???+-???/rule???+QAA-rule
name???????+BDJAAARO???+EJwMQFQE+AFs-0?
??+-???/rule???+QAA-rule
name?????+BDJAAARO???+EJwMQFQE+AFs-1???+-???/rule???+QA
A-rule name??????+BDJAAARO???+EJwMQFQE+AFs-5???+-???/rule???+QAA-rule
name????+B
G8AAA-maxclients???+AAAETEEl???+-AFs-12???+-???/rule???+QAA-rule
name??????+BDJA
AARO???+EJwMQFQE+AFs-2???+-???/rule???+QAA-rule
name??????+BDJAAARO???+EJwMQFQE+
AFs-q3dm6???+-???/rule???+QAA-rule
name??????+BDJAAARO???+EJwMQFQE+AFs-Telenet Q
3A OSP CA Server???+-???/rule???+QAA-rule
name??????+BDJAAARO???+EJwMQFQE+AFs-68
???+-???/rule???+QAA-/Rules?????/Query? ??/Q3Plugs.NET?

So this works fine (more or less) and doesn't throw any errors.

So my question: Why does RequestStatus cause an error while RequestInfo does
not.

If you want to view the full sources of the library please visit:
<A HREF="http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/q3plugs/Q3Plugs.NET/">http://cvs.sourceforge.net/cgi-bin/viewcvs.cgi/q3plugs/Q3Plugs.NET/</A>

Thnx,
Timothy P.




---
Outgoing mail is certified Virus Free.
Checked by AVG anti-virus system (<A HREF="http://www.grisoft.com">http://www.grisoft.com</A>).
Version: 6.0.463 / Virus Database: 262 - Release Date: 17/03/2003


---
Outgoing mail is certified Virus Free.
Checked by AVG anti-virus system (<A HREF="http://www.grisoft.com">http://www.grisoft.com</A>).
Version: 6.0.463 / Virus Database: 262 - Release Date: 18/03/2003


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013032.html">[Mono-list] System.Net.Sockets.SocketException
</A></li>
	<LI> Next message: <A HREF="013039.html">[Mono-list] System.Net.Sockets.SocketException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13033">[ date ]</a>
              <a href="thread.html#13033">[ thread ]</a>
              <a href="subject.html#13033">[ subject ]</a>
              <a href="author.html#13033">[ author ]</a>
         </LI>
       </UL>
</body></html>
