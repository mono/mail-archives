<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Rewriting path with an HttpModule
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gonzalo%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="013084.html">
   <LINK REL="Next"  HREF="013103.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Rewriting path with an HttpModule
   </H1>
    <B>Gonzalo Paniagua Javier
    </B> 
    <A HREF="mailto:gonzalo%40ximian.com"
       TITLE="[Mono-list] Rewriting path with an HttpModule">gonzalo@ximian.com
       </A><BR>
    <I>23 Mar 2003 03:12:45 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="013084.html">[Mono-list] Rewriting path with an HttpModule
</A></li>
        <LI> Next message: <A HREF="013103.html">[Mono-list] Rewriting path with an HttpModule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13088">[ date ]</a>
              <a href="thread.html#13088">[ thread ]</a>
              <a href="subject.html#13088">[ subject ]</a>
              <a href="author.html#13088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>El sáb, 22 de 03 de 2003 a las 21:22, Daniel Lopez escribió:
&gt;<i> &gt; &gt; After fixing RewritePath, i'll modify it and send it back to you.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Mmm. Well, as RewritePath is more of a 'hide the real URL' thing, and
</I>&gt;<i> &gt; after some thinking, I bet for adding the ~user stuff in
</I>&gt;<i> &gt; MonoWorkerRequest.
</I>&gt;<i> 
</I>&gt;<i> I think it could be done with
</I>&gt;<i> 
</I>&gt;<i> MonoApplication /~ /home
</I>
No. At least if we want to be compatible with MS runtime...
If /~ is the root virtual directory, /~user is not in that virtual
directory (while /~/user is under that directory).

I think that you can only map it to the / root virtual directory.

&gt;<i> &gt; Why? There's one place where you can fake the real path to the file
</I>&gt;<i> &gt; (MapPath), so you can map &quot;/~gonzalo/&quot; to the file
</I>&gt;<i> &gt; &quot;/home/gonzalo/public_html/index.aspx&quot; or even using a configuration
</I>&gt;<i> &gt; file like the one in the link I put in my previous mail.
</I>&gt;<i> 
</I>&gt;<i> We can modify Request to support user directories, but it may be better to
</I>&gt;<i> create a hook point in MapPath(), that allows you to have arbitrary code
</I>&gt;<i> providing that functionality.
</I>&gt;<i> What I have in mind is a module that runs the mapped path thru Apache API
</I>&gt;<i> and then takes a look at the resulting path_translated filed in the
</I>&gt;<i> request_rec structure. This would allow us to reuse all the existing Apache
</I>&gt;<i> modules that map virtual paths to physical paths, such as mod_userdir or
</I>&gt;<i> mod_rewrite.
</I>&gt;<i> That would require that:
</I>&gt;<i> 
</I>&gt;<i> a) All MapPath functions eventually call Request.MapPath()  (I did some
</I>&gt;<i> greping and think that is the case)
</I>
Yes.

May be we can add a 'MapPathEvent' event to MonoWorkerRequest. Then, in
MapPath we do something like:

	if (MapPathEvent != null) {
		MapPathEventArgs args = new MapPathEventArgs (path);
		MapPathEventHandler [] evts = (MapPathEventHandler)
MapPathEvent.GetInvocationList ();
		foreach (MapPathEventHandler evt in evts) {
			evt (this, args);
			if (args.MappedPath != null)
				return args.MappedPath;
		}
	}
	// Here goes the current code

This way we can register any possible path 'mapper' method adding it to
MapPathEvent. If there is one of those 'mappers' that recognizes the
path and map it to a real path (ie, sets MappedPath), we return that
path.

What do you think?

&gt;<i> b) Other parts of the code do not make assumptions that physical paths are
</I>&gt;<i> rooted in the Application physical path, as for example happens in 
</I>&gt;<i> mcs/class/System.Web/System.Web.Compilation/AspGenerator.cs
</I>&gt;<i> See patch in 
</I>&gt;<i> <A HREF="http://lists.ximian.com/archives/public/mono-list/2003-March/012992.html">http://lists.ximian.com/archives/public/mono-list/2003-March/012992.html</A>
</I>
templatePath should be the absolute virtual directory of the file being
processed. That's not a file system path. It's used to look for other
files referred from the one being processed.

-Gonzalo



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="013084.html">[Mono-list] Rewriting path with an HttpModule
</A></li>
	<LI> Next message: <A HREF="013103.html">[Mono-list] Rewriting path with an HttpModule
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13088">[ date ]</a>
              <a href="thread.html#13088">[ thread ]</a>
              <a href="subject.html#13088">[ subject ]</a>
              <a href="author.html#13088">[ author ]</a>
         </LI>
       </UL>
</body></html>
