<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Bug in Environment.TickCount
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Bug%20in%20Environment.TickCount&In-Reply-To=1184895536.31440.4.camel%40sayao.home">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035722.html">
   <LINK REL="Next"  HREF="035752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Bug in Environment.TickCount</H1>
    <B>Will Murnane</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Bug%20in%20Environment.TickCount&In-Reply-To=1184895536.31440.4.camel%40sayao.home"
       TITLE="[Mono-list] Bug in Environment.TickCount">will.murnane at gmail.com
       </A><BR>
    <I>Fri Jul 20 00:27:35 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="035722.html">[Mono-list] Bug in Environment.TickCount
</A></li>
        <LI>Next message: <A HREF="035752.html">[Mono-list] Bug in Environment.TickCount
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35723">[ date ]</a>
              <a href="thread.html#35723">[ thread ]</a>
              <a href="subject.html#35723">[ subject ]</a>
              <a href="author.html#35723">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There doesn't seem to be a good way to do this on Linux.  The sysctl()
call for 'uptime' only works on *BSD, apparently.  However, that's not
to say there's *no* way to do it:
#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/sysctl.h&gt;
int main(void)
{
/*      int mib[2], uptime;
        mib[0] = CTL_KERN;
        mib[1] = KERN_BOOTTIME;
        size_t len;                             // Note: this doesn't
work on Linux.  Oh well.
        sysctl(mib, 2, &amp;uptime, &amp;len, NULL, 0);
        printf(&quot;Uptime = %lds\n&quot;, uptime); */
        FILE* fd = fopen(&quot;/proc/uptime&quot;, &quot;r&quot;);
        float uptime;
        fscanf(fd, &quot;%f&quot;, &amp;uptime);
        fclose(fd);
        printf(&quot;Uptime = %ld ms\n&quot;, (int)(uptime * 1000));
    return(0);
}

However, note that the precision of the timer that uses is the same as
the timer your kernel uses, so when I run it twenty times as fast as
possible, I get this:
for i in `seq 1 20`; do ./uptime; done
Uptime = 866848750 ms
(five more times, exactly the same time)
Uptime = 866848812 ms
(same time a bunch more)
That tells me that on this system the clock only ticks about 16 times
a second.  Ouch.

You may be able to simulate something higher-res using gettimeofday()
or the DateTime equivalent, but it won't necessarily be monotone.
With network latency and so forth 62ms resolution might be good
enough... but otherwise, you could use time since your program started
as your &quot;uptime&quot;.  Would that suffice?

Will

On 7/19/07, Thiago M. Say&#227;o &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">thiago.sayao at gmail.com</A>&gt; wrote:
&gt;<i> Hello!
</I>&gt;<i>
</I>&gt;<i> Enrironment.TickCount is supposed to return the miliseconds since the
</I>&gt;<i> boot. For my surprise it was returning a negative number which should
</I>&gt;<i> only happen on the 47th day of uptime.
</I>&gt;<i>
</I>&gt;<i> I did i fix (attached) but it doesn't seem 100% correct and i am not
</I>&gt;<i> sure if it would work after some days.
</I>&gt;<i>
</I>&gt;<i> Since i'm coding a msn library and msn p2p protocol uses GetTickCount(),
</I>&gt;<i> it's messing things for me!
</I>&gt;<i>
</I>&gt;<i> Can anyone take a look?
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035722.html">[Mono-list] Bug in Environment.TickCount
</A></li>
	<LI>Next message: <A HREF="035752.html">[Mono-list] Bug in Environment.TickCount
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35723">[ date ]</a>
              <a href="thread.html#35723">[ thread ]</a>
              <a href="subject.html#35723">[ subject ]</a>
              <a href="author.html#35723">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
