<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Trouble with utf-16 marshaling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Trouble%20with%20utf-16%20marshaling&In-Reply-To=f64dju%24540%241%40sea.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035498.html">
   <LINK REL="Next"  HREF="035507.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Trouble with utf-16 marshaling</H1>
    <B>Maser, Dan</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Trouble%20with%20utf-16%20marshaling&In-Reply-To=f64dju%24540%241%40sea.gmane.org"
       TITLE="[Mono-list] Trouble with utf-16 marshaling">Dan.Maser at inin.com
       </A><BR>
    <I>Mon Jul  2 12:15:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="035498.html">[Mono-list] newbie:help connecting with nysql 5.0
</A></li>
        <LI>Next message: <A HREF="035507.html">[Mono-list] Trouble with utf-16 marshaling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35499">[ date ]</a>
              <a href="thread.html#35499">[ thread ]</a>
              <a href="subject.html#35499">[ subject ]</a>
              <a href="author.html#35499">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
  Thanks to the ideas suggested by those who responded, I have a little
more info on this.  I was trying to make a smaller test project that
reproduced this so I could submit a bug and found out that the real
problem is slightly different than I originally reported.  The real
problem isn't with simple marshaling of UTF-16 data using the
UnmanagedType.LPWStr, but rather the problem is with some SWIG code that
uses some function pointer tricks to allow C library functions to return
pointers-to-buffers without leaking memory.

   The trick I refer to is where the C Library has a pointer-to-function
that allocates string data for C# strings.  And the C# stub sends a
delegate function implementation to the C library to use for this - and
thus the string return values are managed by the C# world and not
leaked.

   I've got a very small test project that reproduces this.  I'll create
a bug and attach it shortly.  Two bugs, really.  Because as I created
this small test project I notice that if I compile the project with MS
visual studio it's ok but if I compile with mono the test project
crashes well before the spot I'm trying to test at.

   I'll create two bugs for this and send the links in case any brave
souls would like to take a look.
 

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A>] On Behalf Of Robert Jordan
Sent: Friday, June 29, 2007 9:02 PM
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
Subject: Re: [Mono-list] Trouble with utf-16 marshaling

Hi Dan,

Maser, Dan wrote:

Here are you speaking about &quot;out&quot; marshaling:

&gt;<i>    It works properly in windows with MS .NET, but doesn't work for me
</I>in
&gt;<i> linux with mono.   I've verified in gdb that the C library is
</I>returning
&gt;<i> the correct string, but immediately after the C dll returns and mono
</I>&gt;<i> does the LPWStr marshaling the string is total garbage characters.   I
</I>&gt;<i> am under the impression from previous posts that 2-byte UTF-16 should
</I>&gt;<i> marshal properly to mono with the LPWStr attribute.  In fact it looks
</I>&gt;<i> like some of the gdiplus calls use that same thing and work... any
</I>ideas
&gt;<i> what I can check on because mine doesn't?
</I>
But your sample is about &quot;in&quot; marshaling:

&gt;<i> 
</I>&gt;<i>    For more clarification my C library has a function signature like
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i> void my_function(unsigned short* myArg);
</I>&gt;<i> 
</I>&gt;<i>     And my C# code looks like this:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [DllImport(&quot;myCLib&quot;)]
</I>&gt;<i> public static extern void
</I>my_function([MarshalAs(UnmanagedType.LPWStr)]
&gt;<i> string myArg);
</I>
Please post, or better: file a bug with a self-contained and
compilable sample.

Robert

_______________________________________________
Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035498.html">[Mono-list] newbie:help connecting with nysql 5.0
</A></li>
	<LI>Next message: <A HREF="035507.html">[Mono-list] Trouble with utf-16 marshaling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35499">[ date ]</a>
              <a href="thread.html#35499">[ thread ]</a>
              <a href="subject.html#35499">[ subject ]</a>
              <a href="author.html#35499">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
