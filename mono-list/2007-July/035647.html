<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Need help with DllImport (P/Invoke)	and	UCS-4	unicode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Need%20help%20with%20DllImport%20%28P/Invoke%29%0A%09and%09UCS-4%09unicode&In-Reply-To=f7g1ig%24p10%241%40sea.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035642.html">
   <LINK REL="Next"  HREF="035631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Need help with DllImport (P/Invoke)	and	UCS-4	unicode</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Need%20help%20with%20DllImport%20%28P/Invoke%29%0A%09and%09UCS-4%09unicode&In-Reply-To=f7g1ig%24p10%241%40sea.gmane.org"
       TITLE="[Mono-list] Need help with DllImport (P/Invoke)	and	UCS-4	unicode">jonpryor at vt.edu
       </A><BR>
    <I>Mon Jul 16 12:12:23 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="035642.html">[Mono-list] Need help with DllImport (P/Invoke) and UCS-4	unicode
</A></li>
        <LI>Next message: <A HREF="035631.html">[Mono-list] Compacting Garbage Collector?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35647">[ date ]</a>
              <a href="thread.html#35647">[ thread ]</a>
              <a href="subject.html#35647">[ subject ]</a>
              <a href="author.html#35647">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2007-07-16 at 17:06 +0200, Christian Heimes wrote:
&gt;<i> Your code works like a charm and I got most unit tests running. I'm
</I>&gt;<i> still having a small problem. How can I apply a custom marshaler to the
</I>&gt;<i> return value of a pinvoke? I like to replace some code with the custom
</I>&gt;<i> marshaler.
</I>&gt;<i> 
</I>&gt;<i>     [DllImport(Runtime.dll, CallingConvention = CallingConvention.Cdecl,
</I>&gt;<i>            EntryPoint = &quot;PyUnicodeUCS4_AsUnicode&quot;,
</I>&gt;<i>            ExactSpelling = true)]
</I>&gt;<i>     internal unsafe static extern char*
</I>&gt;<i>     PyUnicode_AsUnicode(IntPtr ob);
</I>&gt;<i> 
</I>&gt;<i>     internal unsafe static string GetManagedString(IntPtr op) {
</I>&gt;<i>         IntPtr type = PyObject_TYPE(op);
</I>&gt;<i> 
</I>&gt;<i>         ...
</I>&gt;<i> 
</I>&gt;<i>         if (type == Runtime.PyUnicodeType) {
</I>&gt;<i>             char *p = Runtime.PyUnicode_AsUnicode(op);
</I>&gt;<i>             int size = Runtime.PyUnicode_GetSize(op);
</I>&gt;<i>             return new String(p, 0, size);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         return null;
</I>&gt;<i>     }
</I>
In theory, you could probably supply a custom marshaler to the return
value, e.g.

	[return:MarshalAs (...)]
	[DllImport (...)]
	internal unsafe static extern char* ...

(The &quot;return:&quot; prefix specifies that the custom attribute applies to the
return value.)

I don't know if this will work though, as I've never tried it before.

I would instead suggest that you use IntPtr for the return type, if for
no other reason that reference types (e.g. string) require that the
unmanaged code use a specific memory allocator as the runtime will free
the memory.  For example, under Win32 PyUnicode_AsUnicode() would need
to allocate its return value with CoTaskMemAlloc(), as .NET will use
CoTaskMemFree() to free the memory returned.  Using IntPtr avoids this
default behavior.  (Of course, Mono on Linux will use a different memory
allocator than the COM task allocator, thus leading to less portable
unmanaged code.)

Furthermore, with your GetManagedString() code above it'll break if
Runtime.PyUnicode_AsUnicode() returns UTF-32 strings, as the `char*'
will still refer to UTF-16 strings.

If the string returned by Runtime.PyUnicode_AsUnicode() is
NULL-terminated, you could do this:

    internal unsafe static string GetManagedString(IntPtr op)
    {
        IntPtr type = PyObject_TYPE(op);

        ...

        if (type == Runtime.PyUnicodeType) {
            IntPtr p = Runtime.PyUnicode_AsUnicode(op);
            return UnixMarshal.PtrToString (p, Encoding.UTF32);
        }

        return null;
    }

This works as UnixMarshal.PtrToString() will look for a UTF-32 NULL
character to terminate the string, do the UTF-32 -&gt; UTF-16 conversion,
and return the resulting string.

 - Jon


</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035642.html">[Mono-list] Need help with DllImport (P/Invoke) and UCS-4	unicode
</A></li>
	<LI>Next message: <A HREF="035631.html">[Mono-list] Compacting Garbage Collector?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35647">[ date ]</a>
              <a href="thread.html#35647">[ thread ]</a>
              <a href="subject.html#35647">[ subject ]</a>
              <a href="author.html#35647">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
