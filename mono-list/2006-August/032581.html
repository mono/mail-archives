<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Parameters &amp; SQLite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Parameters%20%26%20SQLite&In-Reply-To=1157021151.4620.5.camel%40aleph.whitemice.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032565.html">
   <LINK REL="Next"  HREF="032563.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Parameters &amp; SQLite</H1>
    <B>Jay R. Wren</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Parameters%20%26%20SQLite&In-Reply-To=1157021151.4620.5.camel%40aleph.whitemice.org"
       TITLE="[Mono-list] Parameters &amp; SQLite">jrwren at xmtp.net
       </A><BR>
    <I>Thu Aug 31 12:41:03 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="032565.html">[Mono-list] Parameters &amp; SQLite
</A></li>
        <LI>Next message: <A HREF="032563.html">[Mono-list] ASP.net 2 on Mono does not work...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32581">[ date ]</a>
              <a href="thread.html#32581">[ thread ]</a>
              <a href="subject.html#32581">[ subject ]</a>
              <a href="author.html#32581">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Adam Tauno Williams wrote:
&gt;&gt;<i> It is my blog, but take a look anyway. 
</I>&gt;&gt;<i> <A HREF="http://little.xmtp.net/blog/2005/10/21/proper-data-abstraction-in-net-and-mono-applications/">http://little.xmtp.net/blog/2005/10/21/proper-data-abstraction-in-net-and-mono-applications/</A>
</I>&gt;&gt;<i> <A HREF="http://little.xmtp.net/blog/2005/11/22/more-proper-data-abstractions-in-net-and-mono-applications/">http://little.xmtp.net/blog/2005/11/22/more-proper-data-abstractions-in-net-and-mono-applications/</A>
</I>&gt;&gt;<i> The short answer is &quot;yes&quot; parameters are supported.  There are examples
</I>&gt;&gt;<i> at the above URLs.
</I>&gt;&gt;<i> A short example:
</I>&gt;&gt;<i> |IDbCommand idcSelect = conn.CreateCommand();
</I>&gt;&gt;<i> idcSelect.CommandText = &quot;select col from table where othercl=@someting&quot;;
</I>&gt;&gt;<i> ||IDataParameter param = idcSelect.CreateParameter();
</I>&gt;&gt;<i> Cmd.Parameters.Add(param);
</I>&gt;&gt;<i> param.ParameterName = &quot;@someting&quot;;
</I>&gt;&gt;<i> param.DbType = DbType.String;
</I>&gt;&gt;<i> param.Value = &quot;whatever something would equal&quot;;
</I>&gt;&gt;<i> The above is more geared to 1.1, since 2.0 has DbConnection and the
</I>&gt;&gt;<i> ADO2.0 db provider stuff.
</I>&gt;&gt;<i>     
</I>&gt;<i>
</I>&gt;<i> Excellent!
</I>&gt;<i>
</I>&gt;<i> I'm trying to create a routine that automatically stores a Hashtable (a
</I>&gt;<i> result from an expensive RPC) into a database as a cache.  Each key in
</I>&gt;<i> the Hashtable corresponds to a column in the table, which the key
</I>&gt;<i> entityName containing the name of the table.  The routine compiles fine
</I>&gt;<i> but then just hangs when ExecuteNonQuery is called.
</I>&gt;<i>
</I>&gt;<i> ------
</I>&gt;<i> IDbCommand command = connection.CreateCommand();
</I>&gt;<i> int count = 0;
</I>&gt;<i> string columnList = &quot;&quot;;
</I>&gt;<i> string valueList = &quot;&quot;;
</I>&gt;<i> foreach(string key in dictionary.Keys)
</I>&gt;<i> {
</I>&gt;<i>  IDataParameter	parameter;
</I>&gt;<i>   if (count &gt; 0)
</I>&gt;<i>   {
</I>&gt;<i>     columnList = columnList + &quot;, &quot;;
</I>&gt;<i>     valueList = valueList + &quot;, &quot;;
</I>&gt;<i>   }
</I>&gt;<i>   columnList = columnList + key;
</I>&gt;<i>   valueList = valueList + &quot;@&quot; + key;
</I>&gt;<i>   parameter = command.CreateParameter();
</I>&gt;<i>   command.Parameters.Add(parameter);
</I>&gt;<i>   if (dictionary[key].GetType().FullName == &quot;System.String&quot;)
</I>&gt;<i>   {
</I>&gt;<i>     parameter.ParameterName = &quot;@&quot; + key;
</I>&gt;<i>     parameter.DbType = DbType.String;
</I>&gt;<i>     parameter.Value = (string)dictionary[key];
</I>&gt;<i>   } else if (dictionary[key].GetType().FullName == &quot;System.Int32&quot;)
</I>&gt;<i>     {
</I>&gt;<i>       parameter.ParameterName = &quot;@&quot; + key;
</I>&gt;<i>       parameter.DbType = DbType.Int32;
</I>&gt;<i>       parameter.Value = (int)dictionary[key];
</I>&gt;<i>     } else if (dictionary[key].GetType().FullName == &quot;System.DateTime&quot;)
</I>&gt;<i>       {
</I>&gt;<i>         parameter.ParameterName = &quot;@&quot; + key;
</I>&gt;<i>         parameter.DbType = DbType.DateTime;
</I>&gt;<i>         parameter.Value = (DateTime)dictionary[key];
</I>&gt;<i>       } else throw new System.Exception(&quot;Unhandled type in response&quot;);
</I>&gt;<i>   count++;
</I>&gt;<i> }
</I>&gt;<i> command.CommandText = 
</I>&gt;<i>   &quot;INSERT INTO &quot; + (string)dictionary[&quot;entityName&quot;] +
</I>&gt;<i>   &quot;  (&quot; + columnList + &quot;) VALUES (&quot; + valueList + &quot;);&quot;;
</I>&gt;<i> Console.WriteLine(&quot;Dictionary.StoreHash: Executing non-query&quot;);
</I>&gt;<i> command.ExecuteNonQuery();
</I>&gt;<i> Console.WriteLine(&quot;Dictionary.StoreHash: Non-query complete&quot;);
</I>&gt;<i> command.Dispose();
</I>&gt;<i>   
</I>I could not duplicate the error, but I was able to get something which
does this working.  What fixed it for me was to move the
command.Parameters.Add(parameter) to after the parameter object was int
the desired state.  I don't know if Parameter objects are immutable, or
if command.Parameters.Add() makes a copy of the paremeter, or what, but
this fixed it for me.  It may be worth comparing this behavior to the MS
platform and see what happens.

And of course I used command line sqlite3 to create the table, and after
execution did a .dump to verify it worked.  It did.

My connection string in the ProviderFactory string:
                &lt;add key=&quot;test&quot;
value=&quot;factory=Mono.Data.SqliteClient;URI=file:sqlitetest.db,version=3&quot; /&gt;


My (only slightly modified) code:
/*  CREATE TABLE testtable ( int1 int, str1 nvarchar(1000), entityName
nvarchar(1000) );
 */
using System;
using System.Data;
using System.Collections;
using Mono.Data;

class MonoSqlLiteTest
{
        public static void Main(string[] args)
        {
                Hashtable dictionary = new Hashtable();
                dictionary.Add(&quot;str1&quot;,&quot;blah&quot;);
                dictionary.Add(&quot;entityName&quot;,&quot;testtable&quot;);
                dictionary.Add(&quot;int1&quot;,2);


                IDbConnection connection =
ProviderFactory.CreateConnectionFromConfig(&quot;test&quot;);

                IDbCommand command = connection.CreateCommand();
                int count = 0;
                string columnList = &quot;&quot;;
                string valueList = &quot;&quot;;
                foreach(string key in dictionary.Keys)
                {
                  IDataParameter parameter;
                  if (count &gt; 0)
                  {
                    columnList = columnList + &quot;, &quot;;
                    valueList = valueList + &quot;, &quot;;
                  }
                  columnList = columnList + key;
                  valueList = valueList + &quot;@&quot; + key;
                  parameter = command.CreateParameter();
                  if (dictionary[key].GetType().FullName == &quot;System.String&quot;)
                  {
                    parameter.ParameterName = &quot;@&quot; + key;
                    parameter.DbType = DbType.String;
                    parameter.Value = (string)dictionary[key];
                        Console.WriteLine(&quot;string parameter
added:&quot;+key+&quot; &quot;+dictionary[key]);
                  } else if (dictionary[key].GetType().FullName ==
&quot;System.Int32&quot;)
                  {
                    parameter.ParameterName = &quot;@&quot; + key;
                    parameter.DbType = DbType.Int32;
                    parameter.Value = (int)dictionary[key];
                        Console.WriteLine(&quot;int parameter added:&quot;+key+&quot;
&quot;+dictionary[key]);
                  } else if (dictionary[key].GetType().FullName ==
&quot;System.DateTime&quot;)
                  {
                    parameter.ParameterName = &quot;@&quot; + key;
                    parameter.DbType = DbType.DateTime;
                    parameter.Value = (DateTime)dictionary[key];
                        Console.WriteLine(&quot;datetime parameter
added:&quot;+key+&quot; &quot;+dictionary[key]);
                  } else
                        throw new System.Exception(&quot;Unhandled type in
response&quot;);

                  command.Parameters.Add(parameter);
                  count++;
                }
                command.CommandText =
                  &quot;INSERT INTO &quot; + (string)dictionary[&quot;entityName&quot;] +
                  &quot;  (&quot; + columnList + &quot;) VALUES (&quot; + valueList + &quot;)&quot;;
                Console.WriteLine(&quot;Dictionary.StoreHash: Executing
non-query:&quot; + command.CommandText);
                connection.Open();
                command.ExecuteNonQuery();
                connection.Close();
                Console.WriteLine(&quot;Dictionary.StoreHash: Non-query
complete&quot;);
                command.Dispose();
        }
}

--
Jay
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032565.html">[Mono-list] Parameters &amp; SQLite
</A></li>
	<LI>Next message: <A HREF="032563.html">[Mono-list] ASP.net 2 on Mono does not work...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32581">[ date ]</a>
              <a href="thread.html#32581">[ thread ]</a>
              <a href="subject.html#32581">[ subject ]</a>
              <a href="author.html#32581">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
