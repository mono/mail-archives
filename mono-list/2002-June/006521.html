<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] DllImport ... help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="006497.html">
   <LINK REL="Next"  HREF="006454.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] DllImport ... help
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] DllImport ... help">jonpryor@vt.edu
       </A><BR>
    <I>18 Jun 2002 21:39:26 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="006497.html">[Mono-list] DllImport ... help
</A></li>
        <LI> Next message: <A HREF="006454.html">[Mono-list] PATCH: Unary.ResolveOperator
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6521">[ date ]</a>
              <a href="thread.html#6521">[ thread ]</a>
              <a href="subject.html#6521">[ subject ]</a>
              <a href="author.html#6521">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-VoRnMN5LkZQuyrecl6qh
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

What happens if `getname' takes `wchar_t*'?  An
`IndexOutOfBoundsException'!

The exception is due to two things:
  - .NET appears to marshal as `char' by default, not `wchar_t'
  - Because of the above, `wcsncpy' (the logical equivalent to
    `strncpy') winds up copying *way* past the buffer that .NET 
    allocates.

Marshaling is particularly apparent, because if you make the passed
capacity sufficiently small enough that you can *ensure* you won't
over-write your bounds:

	getname(sb, sb.Capacity/8);

when you write it you'll only get the first character of the passed
string.  Try it.  It's very enlightening.

The fix is to attach a `MarshalAs' attribute, specifying that a
wide-character string should be marshalled.

	[DllImport(&quot;native&quot;)]
	private static extern int wgetname(
	    [Out, MarshalAs(UnmanagedType.LPWStr)]
	    StringBuilder sb,
	    uint n);

See the attached example files.

 - Jon

On Mon, 2002-06-17 at 14:05, Paolo Molaro wrote:
    On 06/15/02 Jonathan Pryor wrote:
    &gt; For example, the following works with .NET
    &gt; 
    &gt; 	// native.c
    &gt; 	// Native library
    &gt; 	#include &lt;string.h&gt;
    &gt; 
    &gt; 	#ifdef _MSC_VER
    &gt; 	__declspec(dllexport)
    &gt; 	#endif
    &gt; 	int getname(char* s, unsigned int n)
    &gt; 	{
    &gt; 	    const char m[] = &quot;This is my message.  Isn't it nice?&quot;;
    &gt; 	    strncpy(s, m, n);
    &gt; 	    return 0;
    &gt; 	}
    [...]
    &gt; 	public class ghbn {
    &gt; 	  [DllImport(&quot;native&quot;)]
    &gt; 	  private static extern int getname(
    &gt; 	    StringBuilder sb, 
    &gt; 	    uint len);
    
    What happens if getname() takes a wchar_t? Do you have to specify
    additional information in a MarshalAs attribute?
    
    BTW, if anyone can find the documentation that the class docs calls
    &quot;Data Marshaling Specification&quot; I'll be grateful.
    
    lupus
    
    -- 
    -----------------------------------------------------------------
    <A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
    <A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better
    
    _______________________________________________
    Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
    
    

--=-VoRnMN5LkZQuyrecl6qh
Content-Disposition: attachment; filename=managed.cs
Content-Transfer-Encoding: quoted-printable
Content-Type: text/plain; name=managed.cs; charset=UTF-8

// call the native function...=0D
=0D
using System;=0D
using System.Text;=0D
using System.Runtime.InteropServices;=0D
=0D
public class managed {=0D
    [DllImport(&quot;native&quot;)]=0D
    private static extern int wgetname(=0D
        [Out, MarshalAs(UnmanagedType.LPWStr)]=0D
        StringBuilder sb,=20=0D
        uint n);=0D
=0D
    [DllImport(&quot;native&quot;)]=0D
    private static extern int getname(StringBuilder sb, uint n);=0D
=0D
    public static void Main () {=0D
        StringBuilder sb =3D new StringBuilder (255);=0D
        getname(sb, (uint) sb.Capacity);=0D
        Console.WriteLine(&quot;name: `{0}'&quot;, sb);=0D
=0D
        sb =3D new StringBuilder(1024);=0D
=0D
        wgetname(sb, (uint) sb.Capacity);=0D
        Console.WriteLine(&quot;wide name: `{0}'&quot;, sb);=0D
    }=0D
}=0D
=0D

--=-VoRnMN5LkZQuyrecl6qh
Content-Disposition: attachment; filename=native.c
Content-Transfer-Encoding: quoted-printable
Content-Type: text/x-c; name=native.c; charset=UTF-8

/*=0D
 * Native DLL.=0D
 */=0D
#include &lt;string.h&gt;=0D
#include &lt;stdio.h&gt;=0D
=0D
#ifdef _MSC_VER=0D
#define EXPORT  __declspec(dllexport)=0D
#else=0D
#define EXPORT=0D
#endif=0D
=0D
EXPORT=0D
int=0D
wgetname(__wchar_t* s, unsigned int n)=0D
{=0D
    const wchar_t m[] =3D L&quot;This is my message.  Isn't it nifty?&quot;;=0D
    printf(&quot;Inside wgetname; n=3D%i\n&quot;, n);=0D
    wcsncpy(s, m, n);=0D
    return 0;=0D
}=0D
=0D
EXPORT=0D
int=0D
getname(char* s, unsigned int n)=0D
{=0D
    const char m[] =3D &quot;This is my message.  Isn't it nifty?&quot;;=0D
    printf(&quot;Inside getname; n=3D%i\n&quot;, n);=0D
    strncpy(s, m, n);=0D
    return 0;=0D
}=0D
=0D

--=-VoRnMN5LkZQuyrecl6qh--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="006497.html">[Mono-list] DllImport ... help
</A></li>
	<LI> Next message: <A HREF="006454.html">[Mono-list] PATCH: Unary.ResolveOperator
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6521">[ date ]</a>
              <a href="thread.html#6521">[ thread ]</a>
              <a href="subject.html#6521">[ subject ]</a>
              <a href="author.html#6521">[ author ]</a>
         </LI>
       </UL>
</body></html>
