<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [PATCH] Test case and fix for XML Declaration parsing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dave%40earth.li">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="006262.html">
   <LINK REL="Next"  HREF="006231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [PATCH] Test case and fix for XML Declaration parsing
   </H1>
    <B>David Sheldon
    </B> 
    <A HREF="mailto:dave%40earth.li"
       TITLE="[Mono-list] [PATCH] Test case and fix for XML Declaration parsing">dave@earth.li
       </A><BR>
    <I>Tue, 4 Jun 2002 16:23:32 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="006262.html">[Mono-list] [PATCH] Test case and fix for XML Declaration parsing
</A></li>
        <LI> Next message: <A HREF="006231.html">[Mono-list] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6278">[ date ]</a>
              <a href="thread.html#6278">[ thread ]</a>
              <a href="subject.html#6278">[ subject ]</a>
              <a href="author.html#6278">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--wzJLGUyc3ArbnUjN
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline

On Mon, Jun 03, 2002 at 04:09:58PM -0700, Jason Diamond wrote:
&gt;<i> &gt; Right, my first useful submission. Please let me have feedback so that I
</I>&gt;<i> &gt; can be more useful with future attempts.
</I>&gt;<i> 
</I>&gt;<i> Did you forget to attach your patch?
</I>
That sounds like the first bug in it :)

David

-- 
&quot;Anyone attempting to generate random numbers by deterministic means is, of
course, living in a state of sin.&quot;
-- John Von Neumann

--wzJLGUyc3ArbnUjN
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=&quot;XmlDeclaration.patch&quot;

Index: XmlDeclaration.cs
===================================================================
RCS file: /mono/mcs/class/System.XML/System.Xml/XmlDeclaration.cs,v
retrieving revision 1.9
diff -u -r1.9 XmlDeclaration.cs
--- XmlDeclaration.cs	9 Apr 2002 01:38:59 -0000	1.9
+++ XmlDeclaration.cs	2 Jun 2002 22:31:26 -0000
@@ -98,10 +98,41 @@
 			w.WriteRaw (String.Format (&quot;&lt;?xml {0}?&gt;&quot;, Value));
 		}
 
-		void ParseInput (string input)
-		{			
-			Encoding = input.Split (new char [] { ' ' }) [1].Split (new char [] { '=' }) [1];
-			Standalone = input.Split (new char [] { ' ' }) [2].Split (new char [] { '=' }) [1];
+
+		void ParseInput (string input) 
+		{
+			string [] tokens = input.Split (new char [] { ' ', '\u0009', '\u000d','\u000a' });
+			for (int i=0;i&lt;tokens.Length; i++) 
+			{
+				string token = tokens [i];
+				if (token.StartsWith (&quot;encoding&quot;)) {
+					Encoding=ParseDeclAttribute (tokens, ref i);
+				} else if (token.StartsWith (&quot;standalone&quot;)) {
+					Standalone=ParseDeclAttribute (tokens,ref i);
+				} else if (token.StartsWith (&quot;version&quot;)) {
+					version = ParseDeclAttribute (tokens, ref i);
+					/* TODO: Should we check this is &quot;1.0&quot;? */
+				}
+			}
+		}
+	  
+		private string ParseDeclAttribute (string [] tokens, ref int i) {
+			int quote;
+			string token = tokens [i];
+			while ((quote = Math.Max (token.IndexOf ('&quot;'), token.IndexOf ('\''))) == -1) 
+				token = tokens [++i]; 
+				/* The attribute value in quotes can contain no whitespace */
+			
+			int endQuote = token.IndexOf (token [quote], quote + 1) ;
+			if (endQuote == -1) {
+			/* TODO
+			 * Malformed Declaration, I assume we should throw an 
+			 * exception here */
+				return null;
+			} else {
+				return token.Substring (quote + 1, endQuote - (quote + 1));
+			}
+			/* I assume all these +1s will be optimised somewhere */
 		}
 	}
 }

--wzJLGUyc3ArbnUjN
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=&quot;XmlDeclarationTests.patch&quot;

Index: XmlDeclarationTests.cs
===================================================================
RCS file: /mono/mcs/class/System.XML/Test/XmlDeclarationTests.cs,v
retrieving revision 1.4
diff -u -r1.4 XmlDeclarationTests.cs
--- XmlDeclarationTests.cs	5 May 2002 10:31:13 -0000	1.4
+++ XmlDeclarationTests.cs	2 Jun 2002 22:01:43 -0000
@@ -2,7 +2,7 @@
 // System.Xml.XmlDeclarationTests.cs
 //
 // Author:
-// 	Duncan Mak  (<A HREF="mailto:duncan@ximian.com">duncan@ximian.com</A>)
+//	Duncan Mak  (<A HREF="mailto:duncan@ximian.com">duncan@ximian.com</A>)
 //
 // (C) Ximian, Inc.
 //
@@ -59,7 +59,7 @@
 			AssertEquals (&quot;Value incorrectly cloned&quot;,
 				      original.Value, cloned.Value);
 			
-                        Assert (&quot;Copies, not pointers&quot;, !Object.ReferenceEquals (original,cloned));
+			Assert (&quot;Copies, not pointers&quot;, !Object.ReferenceEquals (original,cloned));
 		}
 
 		public void TestConstructor ()
@@ -108,9 +108,32 @@
 
 		public void TestValueProperty ()
 		{
+			string expected =&quot;version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;&quot; ;
+      
 			XmlDeclaration d = document.CreateXmlDeclaration (&quot;1.0&quot;, &quot;UTF-8&quot;, &quot;yes&quot;);
-			AssertEquals (&quot;Value property&quot;, &quot;version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;&quot;,
-				      d.Value);
+			AssertEquals (&quot;Value property&quot;, expected, d.Value);
+
+			d.Value = expected;
+			AssertEquals(&quot;Value round-trip&quot;, expected, d.Value);
+
+			d.Value=&quot;   &quot;+ expected;
+			AssertEquals(&quot;Value round-trip (padded)&quot;, expected, d.Value);
+      
+			d.Value =&quot;version=\&quot;1.0\&quot;     encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;&quot; ;
+			AssertEquals(&quot;Value round-trip (padded 2)&quot;, expected, d.Value);
+      
+			d.Value =&quot;version=\&quot;1.0\&quot;\tencoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;&quot; ;
+			AssertEquals(&quot;Value round-trip (\\t)&quot;, expected, d.Value);
+      
+			d.Value =&quot;version=\&quot;1.0\&quot;\n    encoding=\&quot;UTF-8\&quot; standalone=\&quot;yes\&quot;&quot; ;
+			AssertEquals(&quot;Value round-trip (\\n)&quot;, expected, d.Value);
+      
+			d.Value =&quot;version=\&quot;1.0\&quot;    encoding	=   \&quot;UTF-8\&quot; standalone = \&quot;yes\&quot;&quot; ;
+			AssertEquals(&quot;Value round-trip (spaces)&quot;, expected, d.Value);
+
+			d.Value =&quot;version='1.0' encoding='UTF-8' standalone='yes'&quot; ;
+			AssertEquals(&quot;Value round-trip ('s)&quot;, expected, d.Value);
+      
 		}
 
 		public void TestXmlCommentCloneNode ()
@@ -123,7 +146,7 @@
 			XmlNode deep = declaration.CloneNode (true); // deep
 			TestXmlNodeBaseProperties (original, deep);
 
-                        AssertEquals (&quot;deep cloning differs from shallow cloning&quot;,
+			AssertEquals (&quot;deep cloning differs from shallow cloning&quot;,
 				      deep.OuterXml, shallow.OuterXml);
 		}
 	}

--wzJLGUyc3ArbnUjN--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="006262.html">[Mono-list] [PATCH] Test case and fix for XML Declaration parsing
</A></li>
	<LI> Next message: <A HREF="006231.html">[Mono-list] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6278">[ date ]</a>
              <a href="thread.html#6278">[ thread ]</a>
              <a href="subject.html#6278">[ subject ]</a>
              <a href="author.html#6278">[ author ]</a>
         </LI>
       </UL>
</body></html>
