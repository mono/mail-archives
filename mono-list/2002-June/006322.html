<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [PATCH] robust mono-handle-d?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dick%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="006321.html">
   <LINK REL="Next"  HREF="006326.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [PATCH] robust mono-handle-d?
   </H1>
    <B>Dick Porter
    </B> 
    <A HREF="mailto:dick%40ximian.com"
       TITLE="[Mono-list] [PATCH] robust mono-handle-d?">dick@ximian.com
       </A><BR>
    <I>Fri, 7 Jun 2002 16:40:53 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="006321.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
        <LI> Next message: <A HREF="006326.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6322">[ date ]</a>
              <a href="thread.html#6322">[ thread ]</a>
              <a href="subject.html#6322">[ subject ]</a>
              <a href="author.html#6322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jun 07, 2002 at 04:35:52PM +0200, Dennis Haney wrote:
&gt;<i> Dick&gt; Not just file handles, there are many sorts.  Please change this
</I>&gt;<i> Dick&gt; wording throughout the doc and the comments.
</I>&gt;<i> 
</I>&gt;<i> I believe that was the only place I was wrong. All other places I talk
</I>&gt;<i> about filehandles I refer to the filehandle of the client-sockets...
</I>
They're called &quot;file descriptors&quot; in Linux :)

&gt;<i> Dick&gt; Some typos here
</I>&gt;<i> 
</I>&gt;<i> All I can see is the Free having a &lt;sp&gt; before instead of
</I>&gt;<i> after. Anymore?
</I>
That was all.

&gt;<i> I now do the check both places. Point was that given a struct like:
</I>&gt;<i> 
</I>&gt;<i> struct p {
</I>&gt;<i>    int a;
</I>&gt;<i>    union b {
</I>&gt;<i>         int c[1000];
</I>&gt;<i>         int d;
</I>&gt;<i>    }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> If the client only fills out d, then it might only send a package
</I>&gt;<i> which is two ints long.
</I>
The sendto is given the sizeof the whole struct, not just one of the
union parts.

&gt;<i> Dick&gt; Please move the Error enum to the top of the list, to be
</I>&gt;<i> Dick&gt; symmetrical with the responses.
</I>&gt;<i> 
</I>&gt;<i> Okay, this breaks binary compat though...
</I>
Yeah, I know, but we only exec the installed binary.  Paolo did suggest
building the daemon into the library and just fork() without execing
anything.  That's a possible fix for any binary compat problems.

&gt;<i> Dick&gt; I prefer to not use default in switch statements like this, so
</I>&gt;<i> Dick&gt; the compiler will remind me when I've forgotten to add a case.
</I>&gt;<i> 
</I>&gt;<i> It is to catch faulty packages...
</I>
OK.

&gt;<i> 
</I>&gt;<i> I just have one question about the daemon... Why does it exist? Isn't
</I>&gt;<i> it better performancewise[2] to just protect the shared area with a
</I>&gt;<i> mutex when allocation a new handle/shared mem segment or changing
</I>&gt;<i> refcnt? It will however be a less resilient to clients that crash (the
</I>&gt;<i> deamon cleans up ref'd handles if socket closes)
</I>
It's precisely because with a mutex the shared memory segment can be left
in a locked state. Also, it's not so easy to clean up shared memory without
it (you can't just mark it deleted when creating it, because you can't
attach any more readers to the same segment after that).

I did some minimal performance testing, and I don't think the daemon is
particularly slow.

&gt;<i> Index: daemon.c
</I>&gt;<i> @@ -120,9 +160,7 @@
</I>&gt;<i>  	}
</I>&gt;<i>  	
</I>&gt;<i>  	if(_wapi_shared_data-&gt;handles[handle].ref==0) {
</I>&gt;<i> -		if (open_handles[handle]!=0) {
</I>&gt;<i> -			g_warning (G_GNUC_PRETTY_FUNCTION &quot;: per-process open_handles mismatch, set to %d, should be 0&quot;, open_handles[handle]);
</I>&gt;<i> -		}
</I>&gt;<i> +	        g_assert(open_handles[handle] == 0);
</I>
This change shouldnt go in.  The daemon shouldn't quit if it's still servicing
clients, and it should clean up when it does quit.

If anything, it should just moan with a g_warning and set
open_handles[handle]=0;

&gt;<i> @@ -314,9 +421,15 @@
</I>&gt;<i>  		process_new (idx, req.u.new.type);
</I>&gt;<i>  		break;
</I>&gt;<i>  	case WapiHandleRequestType_Open:
</I>&gt;<i> +#ifdef DEBUG
</I>&gt;<i> +		g_assert(req.u.open.handle &lt; _WAPI_MAX_HANDLES);
</I>&gt;<i> +#endif
</I>
I'd prefer g_warning()s instead of g_assert()s here, even though it's marked
DEBUG.

&gt;<i>  		process_open (idx, req.u.open.handle);
</I>&gt;<i>  		break;
</I>&gt;<i>  	case WapiHandleRequestType_Close:
</I>&gt;<i> +#ifdef DEBUG
</I>&gt;<i> +		g_assert(req.u.close.handle &lt; _WAPI_MAX_HANDLES);
</I>&gt;<i> +#endif
</I>
And here.

&gt;<i>  		process_close (idx, req.u.close.handle);
</I>&gt;<i>  		break;
</I>&gt;<i>  	case WapiHandleRequestType_Scratch:
</I>

Everything else is fine to commit.

Thanks,

- Dick



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="006321.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
	<LI> Next message: <A HREF="006326.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6322">[ date ]</a>
              <a href="thread.html#6322">[ thread ]</a>
              <a href="subject.html#6322">[ subject ]</a>
              <a href="author.html#6322">[ author ]</a>
         </LI>
       </UL>
</body></html>
