<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [PATCH] robust mono-handle-d?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dick%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="006315.html">
   <LINK REL="Next"  HREF="006321.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [PATCH] robust mono-handle-d?
   </H1>
    <B>Dick Porter
    </B> 
    <A HREF="mailto:dick%40ximian.com"
       TITLE="[Mono-list] [PATCH] robust mono-handle-d?">dick@ximian.com
       </A><BR>
    <I>Fri, 7 Jun 2002 11:06:00 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="006315.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
        <LI> Next message: <A HREF="006321.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6318">[ date ]</a>
              <a href="thread.html#6318">[ thread ]</a>
              <a href="subject.html#6318">[ subject ]</a>
              <a href="author.html#6318">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Jun 06, 2002 at 10:42:38PM +0200, Dennis Haney wrote:
&gt;<i> 
</I>&gt;<i> This is primarily a documentation patch, but it also adds a single
</I>&gt;<i> error check (assert if unref is called with refcnt==0) and many
</I>&gt;<i> g_warning with a exit(-1) right after was changed to g_critical. The
</I>&gt;<i> states a daemon was running in was replaced by an enum to make it more
</I>&gt;<i> clean what is what.
</I>
Mostly OK.  I've commented on some details below.

- Dick


&gt;<i> +
</I>&gt;<i> +The mono_handle_d is a process which takes care of the (de)allocation
</I>&gt;<i> +of scratch shared memory and filehandles and refcounts of the
</I>&gt;<i> +filehandles. It is designed to be run by a user and to be fast, thus
</I>
Not just file handles, there are many sorts.  Please change this wording
throughout the doc and the comments.

&gt;<i> +
</I>&gt;<i> +=head2 How to start the deamon
</I>
Please make sure you've spelled &quot;daemon&quot; correctly throughout (including in
typedefs :) )

&gt;<i> +
</I>&gt;<i> +Deallocate a shared memory area, this must have been allocated before
</I>&gt;<i> +deallocating. A L&lt;WapiHandleResponse&gt; with
</I>&gt;<i> +.type=WapiHandleResponseType_Scratch Freewill be sent back (works just
</I>
Some typos here

&gt;<i> Index: daemon-messages.c
</I>&gt;<i> @@ -71,7 +71,11 @@
</I>&gt;<i>  	int ret;
</I>&gt;<i>  	
</I>&gt;<i>  	ret=recv (fd, req, sizeof(WapiHandleRequest), MSG_NOSIGNAL);
</I>&gt;<i> +	//we cant check ret != sizeof(WapiHandleRequest) because its a
</I>&gt;<i> +	//union
</I>
Please replace the // comments with /* */

&gt;<i>  	
</I>&gt;<i>  	ret=send (fd, resp, sizeof(WapiHandleResponse), MSG_NOSIGNAL);
</I>&gt;<i> -	if(ret==-1) {
</I>&gt;<i>  #ifdef DEBUG
</I>&gt;<i> +	if(ret==-1 || ret != sizeof(WapiHandleResponse)) {
</I>
I don't understand this bit.  Earlier you said you can't use sizeof on a 
union, but here you are doing it.

&gt;<i> Index: daemon-messages.h
</I>&gt;<i> @@ -18,6 +18,7 @@
</I>&gt;<i>  	WapiHandleRequestType_Close,
</I>&gt;<i>  	WapiHandleRequestType_Scratch,
</I>&gt;<i>  	WapiHandleRequestType_ScratchFree,
</I>&gt;<i> +	WapiHandleRequestType_Error,
</I>&gt;<i>  } WapiHandleRequestType;
</I>
Please move the Error enum to the top of the list, to be symmetrical with
the responses.

&gt;<i> Index: daemon.c
</I>&gt;<i> ===================================================================
</I>&gt;<i>  
</I>&gt;<i> +// Array to hold the filehandles we are currently polling
</I>&gt;<i>  static struct pollfd *pollfds=NULL;
</I>
Comments again...

&gt;<i> -static gpointer *handle_refs=NULL;
</I>&gt;<i> +static guint32 **handle_refs=NULL;
</I>
Good catch.

&gt;<i>  static gboolean unref_handle (guint32 idx, guint32 handle)
</I>&gt;<i>  {
</I>&gt;<i>  	guint32 *open_handles=handle_refs[idx];
</I>&gt;<i> @@ -104,6 +137,8 @@
</I>&gt;<i>  		return(FALSE);
</I>&gt;<i>  	}
</I>&gt;<i>  	
</I>&gt;<i> +	g_assert(open_handles[handle] != 0);
</I>&gt;<i> +
</I>
Shouldn't use assert in the daemon.  Just g_warning and ignore the request if
the handle isn't open.

&gt;<i> @@ -325,9 +433,19 @@
</I>&gt;<i>  	case WapiHandleRequestType_ScratchFree:
</I>&gt;<i>  		process_scratch_free (idx, req.u.scratch_free.idx);
</I>&gt;<i>  		break;
</I>&gt;<i> +	case WapiHandleRequestType_Error: /* Falltrough */
</I>&gt;<i> +	default:
</I>&gt;<i> +		/*FIXME: call rem_fd?*/
</I>&gt;<i> +		break;
</I>&gt;<i>  	}
</I>
I prefer to not use default in switch statements like this, so the compiler
will remind me when I've forgotten to add a case.


The rest is fine though.



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="006315.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
	<LI> Next message: <A HREF="006321.html">[Mono-list] [PATCH] robust mono-handle-d?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6318">[ date ]</a>
              <a href="thread.html#6318">[ thread ]</a>
              <a href="subject.html#6318">[ subject ]</a>
              <a href="author.html#6318">[ author ]</a>
         </LI>
       </UL>
</body></html>
