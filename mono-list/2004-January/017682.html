<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] RE: [Mono-devel-list] REGRESSION: StringBuilder
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lupus%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="017678.html">
   <LINK REL="Next"  HREF="017673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] RE: [Mono-devel-list] REGRESSION: StringBuilder
   </H1>
    <B>Paolo Molaro
    </B> 
    <A HREF="mailto:lupus%40ximian.com"
       TITLE="[Mono-list] RE: [Mono-devel-list] REGRESSION: StringBuilder">lupus@ximian.com
       </A><BR>
    <I>Tue, 13 Jan 2004 20:24:11 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="017678.html">[Mono-list] RE: [Mono-devel-list] REGRESSION: StringBuilder
</A></li>
        <LI> Next message: <A HREF="017673.html">[Mono-list] Obfuscator
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17682">[ date ]</a>
              <a href="thread.html#17682">[ thread ]</a>
              <a href="subject.html#17682">[ subject ]</a>
              <a href="author.html#17682">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/14/04 Iain McCoy wrote:
&gt;<i> I get the same problem, on a freshly checked-out-from-anoncvs-and-built
</I>&gt;<i> mcs and mono. I did some digging (just because I could) and I suspect
</I>&gt;<i> the problem is that StringBuilder uses String.InternalStrcpy to move
</I>&gt;<i> everything to the right of the insert point across. From my reading of
</I>&gt;<i> the code, that would go to the method
</I>&gt;<i> ves_icall_System_String_InternalStrcpy_StrN in
</I>&gt;<i> mono/metadata/string-icalls.c. That function's basically a call to
</I>&gt;<i> memcpy, which can't be used on overlapping memory areas (and breaking
</I>&gt;<i> that rule is what causes the regression). I think there's a few options
</I>&gt;<i> to fix it:
</I>&gt;<i> 1 Add a String.InternalStrmov that uses memmove instead of memcpy
</I>&gt;<i> 2 Change String.InternalStrcpy so that it uses memmove
</I>&gt;<i> 
</I>&gt;<i> Both of these options fix the problem. I suspect Option 2 is detrimental
</I>&gt;<i> to performance because it would mean that overlapping buffers were being
</I>&gt;<i> dealt with even when they weren't actually there.
</I>
I committed a change memcpy -&gt; g_memmove, mostly because it's the
smaller change.

&gt;<i> I'm attaching a little patch I wrote that does Option 1. I make no
</I>&gt;<i> claims about this patch, except that it works for me. I didn't look over
</I>&gt;<i> StringBuilder particularly thoroughly, but I think I caught all of the
</I>&gt;<i> cases that needed to be changed. 
</I>&gt;<i> 
</I>&gt;<i> I imagine I have broken 5 rules and 10 guidelines with this patch, but
</I>&gt;<i> oh well - I hope it is useful.
</I>
The patch looks good:-)
Thanks for tracking down the issue.
If we get some real data that shows the memmove to be significantly
slower than the memcpy, we'll go for the added complexity of having the
additional icalls.

Thanks!
lupus

-- 
-----------------------------------------------------------------
<A HREF="mailto:lupus@debian.org">lupus@debian.org</A>                                     debian/rules
<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>                             Monkeys do it better

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="017678.html">[Mono-list] RE: [Mono-devel-list] REGRESSION: StringBuilder
</A></li>
	<LI> Next message: <A HREF="017673.html">[Mono-list] Obfuscator
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17682">[ date ]</a>
              <a href="thread.html#17682">[ thread ]</a>
              <a href="subject.html#17682">[ subject ]</a>
              <a href="author.html#17682">[ author ]</a>
         </LI>
       </UL>
</body></html>
