<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()  - Activator.CreateInstanceFrom()  ---&gt; invalid cast
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jaroslaw.kowalski%40atm.com.pl">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="017935.html">
   <LINK REL="Next"  HREF="017945.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()  - Activator.CreateInstanceFrom()  ---&gt; invalid cast
   </H1>
    <B>Jaroslaw Kowalski
    </B> 
    <A HREF="mailto:jaroslaw.kowalski%40atm.com.pl"
       TITLE="[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()  - Activator.CreateInstanceFrom()  ---&gt; invalid cast">jaroslaw.kowalski@atm.com.pl
       </A><BR>
    <I>Tue, 27 Jan 2004 10:54:21 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="017935.html">[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()  -
 Activator.CreateInstanceFrom()  ---&gt; invalid cast
</A></li>
        <LI> Next message: <A HREF="017945.html">[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()
 - Activator.CreateInstanceFrom()  ---&gt; invalid cast
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17944">[ date ]</a>
              <a href="thread.html#17944">[ thread ]</a>
              <a href="subject.html#17944">[ subject ]</a>
              <a href="author.html#17944">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Timothy,

I found the reason why this isn't working (and solution). This applies to MS
.NET and is related to assembly versioning but I thought it might be
interesting.

Sorry for quite a long post.

REPRODUCING THE PROBLEM:

1. I grabbed &quot;ByteFX.Data&quot; from &quot;mcs&quot; and created a VS.NET 2003 project, and
compiled it (obviously using .NET 1.1.4322).
2. Among other things &quot;ildasm ByteFX.Data.dll&quot; shows a reference to
System.Data that comes with .NET 1.1

.assembly extern System.Data
{
  .publickeytoken = (B7 7A 5C 56 19 34 E0 89 )                         //
.z\V.4..
  .ver 1:0:5000:0
}

3. I created a test file: &quot;test.cs&quot;
---------------
using System;
using System.Reflection;
using System.Data;

public class Class1
{
    public static void Main()
    {
        Assembly DataProvider;
        DataProvider = Assembly.LoadFrom(@&quot;bytefx\ByteFX.Data.dll&quot;);
        object dbConnection =
DataProvider.CreateInstance(&quot;ByteFX.Data.MySqlClient.MySqlConnection&quot;,false)
;
        Console.WriteLine(dbConnection.ToString());
        IDbConnection dbConn = (IDbConnection)dbConnection;
    }
}
---------------
4. I have both MS.NET 1.0 and 1.1 and csc.exe from 1.0.3705 happens to be in
my path. So when I compiled test.cs by:

csc test.cs

it referenced all libraries from .NET 1.0. &quot;ildasm test.exe&quot; shows:

.assembly extern System.Data
{
  .publickeytoken = (B7 7A 5C 56 19 34 E0 89 )                         //
.z\V.4..
  .ver 1:0:3300:0
}

5. When I run test.exe I get invalid cast exception.

HERE'S WHY:

a) IDbConnection in test.cs acually means (using assembly-qualified type
names)
System.Data.IDbConnection, System.Data, Version=1.0.3300.0, Culture=neutral,
PublicKeyToken=b77a5c561934e089, Custom=null
b) IDbConnection in &quot;ByteFX.Data.dll&quot; IDbConnection means:
System.Data.IDbConnection, System.Data, Version=1.0.5000.0, Culture=neutral,
PublicKeyToken=b77a5c561934e089, Custom=null
c) Under .NET 1.0 the types aren't compatible and you have to provide
assembly redirection to get it working.
d) Under .NET 1.1 things have changed, and every time you ask for ANY type
from ANY assembly that shipped with MS.NET 1.1 (regardless of the version)
you always get the one that comes with .NET 1.1.

SOLUTION:

a) Recompile &quot;test.cs&quot; with csc.exe that comes with .NET 1.1. (In general -
use the same compiler for both library and an exe)
OR (when you want to run this on .NET 1.0)
b) Create a config file &quot;test.exe.config&quot;

&lt;configuration&gt;
   &lt;runtime&gt;
      &lt;assemblyBinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;
         &lt;dependentAssembly&gt;
            &lt;assemblyIdentity name=&quot;System.Data&quot;
                              publicKeyToken=&quot;b77a5c561934e089&quot;
                              culture=&quot;neutral&quot; /&gt;
            &lt;bindingRedirect oldVersion=&quot;1.0.5000.0&quot;
                             newVersion=&quot;1.0.3300.0&quot;/&gt;
         &lt;/dependentAssembly&gt;
      &lt;/assemblyBinding&gt;
   &lt;/runtime&gt;
&lt;/configuration&gt;

that will redirect all request to System.Data to version that comes with
.NET 1.0

c) Note that when you compile test.cs for .NET 1.1 you don't need the config
file even if the ByteFX.Data was compiled against .NET 1.0 System.Data.dll
because of the auto-redirection feature from 1.1.

MY ADVICE:

Use Activator.CreateInstance() and pass it the full name of the type you
want to create. Something like:

Activator.CreateInstance(Type.GetType(&quot;ByteFX.Data.MySqlClient.MySqlConnecti
on, ByteFX.Data&quot;))

This works like a charm provided that ByteFX.Data.dll is in your application
directory or in assembly probe path.

Jarek


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="017935.html">[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()  -
 Activator.CreateInstanceFrom()  ---&gt; invalid cast
</A></li>
	<LI> Next message: <A HREF="017945.html">[Mono-list] Assembly.LoadFrom() - Assembly.CreateInstance()
 - Activator.CreateInstanceFrom()  ---&gt; invalid cast
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17944">[ date ]</a>
              <a href="thread.html#17944">[ thread ]</a>
              <a href="subject.html#17944">[ subject ]</a>
              <a href="author.html#17944">[ author ]</a>
         </LI>
       </UL>
</body></html>
