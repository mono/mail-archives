<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Simple app works in .NET 1.1 but not in Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:db%40ke5in.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="025598.html">
   <LINK REL="Next"  HREF="025579.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Simple app works in .NET 1.1 but not in Mono
   </H1>
    <B>Kevin B.
    </B> 
    <A HREF="mailto:db%40ke5in.com"
       TITLE="[Mono-list] Simple app works in .NET 1.1 but not in Mono">db@ke5in.com
       </A><BR>
    <I>Thu, 3 Feb 2005 15:24:03 -0500 (EST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="025598.html">[Mono-list] Bug 72149
</A></li>
        <LI> Next message: <A HREF="025579.html">[Mono-list] Mono, ASP.NET et Javascript push
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25578">[ date ]</a>
              <a href="thread.html#25578">[ thread ]</a>
              <a href="subject.html#25578">[ subject ]</a>
              <a href="author.html#25578">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>------=_20050203152403_50348
Content-Type: text/plain; charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: 8bit

Hi,

Attached is a simple console app that will compile in .NET Framework 1.1
and will run correctly.  It compiles in Mono on fc2 but it &quot;sort of&quot; does
not run correctly.

The code is supposed to download historical data from the yahoo website. 
Under windows it will correctly download all ten items in the array (Item
5 on the list - ATH - is a failure test case).  On my fc2 setup the code
will download only the first two items and then it timeouts for all the
rest.  One of the items (ATH) does not exist on yahoo.  In windows I get a
the expected 404 error but in Mono I still get the timeout.  It does not
matter what I set the time out value to, the Mono version will
consistently time out for the last eight items.   Its very stange that it
works for the first two items.

I'm not sure what to look for at this point.  My guess is that there is
something going on with the WebRequest object.  Maybe I'm not closing
something and the .NET CLR is more forgiving or maybe my fc2 setup is
corrupt?  I reinstalled mono 1.0.5 from the rpms but that did not fix
it....

I'm out of ideas and hope one of you guys can point me the the right
direction.

Thanks in advance for any help.

The attached file will compile and run by doing the following:

mcs Class1.cs
mono Class1.exe

Thanks again,
Kevin
------=_20050203152403_50348
Content-Type: text/x-csharp; name=&quot;Class1.cs&quot;
Content-Transfer-Encoding: 8bit
Content-Disposition: attachment; filename=&quot;Class1.cs&quot;

using System;
using System.Threading;
using System.Collections;
using System.Net;
using System.Text.RegularExpressions;
using System.IO;

namespace ConsoleApplication6
{

	
	
	public class YahooData	
	{
		public YahooData(){}
		public void GetHistoricalDays(string Symbol,DateTime StartDay,DateTime EndDay,ref ArrayList DaysTraded)
		{

			string sURL;

			sURL = &quot;<A HREF="http://table.finance.yahoo.com/table.csv?s="">http://table.finance.yahoo.com/table.csv?s=&quot;</A>
				+Symbol
				+&quot;&amp;d=&quot;+Convert.ToString(EndDay.Month-1)
				+&quot;&amp;e=&quot;+Convert.ToString(EndDay.Day)
				+&quot;&amp;f=&quot;+Convert.ToString(EndDay.Year)
				+&quot;&amp;g=d&quot;
				+&quot;&amp;a=&quot;+Convert.ToString(StartDay.Month-1)
				+&quot;&amp;b=&quot;+Convert.ToString(StartDay.Day)
				+&quot;&amp;c=&quot;+Convert.ToString(StartDay.Year)
				+&quot;&amp;ignore=.csv&quot;; 
			WebRequest wrGETURL;			
			Stream objStream;
			int i = 2;//Globals.WebRetries;
			while(i&gt;-1)
			{
				
				try
				{	
					wrGETURL = WebRequest.Create(sURL);
					wrGETURL.Timeout = 30000;
					//wrGETURL.Proxy = WebProxy.GetDefaultProxy();
					Console.WriteLine(&quot;Trying to get: &quot; + Symbol);
					objStream = wrGETURL.GetResponse().GetResponseStream();
					Console.WriteLine( Symbol + &quot;: No exception occured&quot;);
					
					//Read in the data 
					StreamReader objReader = new StreamReader(objStream);
					string sLine =&quot;&quot;;
					sLine = objReader.ReadLine(); //header
					sLine = objReader.ReadLine(); //first line of data
					while(sLine!=null)
					{
						DaysTraded.Add(sLine);//(new TradeVector(Symbol,sLine));							
						sLine = objReader.ReadLine();
					}
					objReader.Close();
					DaysTraded.Reverse();
					return; //probably not the best way to leave to the try/catch block
					//but outside it there is a retry loop 
				}
				catch(WebException e)
				{ 	
					Console.WriteLine(&quot;Problem: &quot; + e.Message); 
					WebErrorHandler(e,i,Symbol);
				}			
				i--;
			}
			return;
		}

		private void WebErrorHandler(WebException e, int i, string Symbol)
		{
			//ProtocolError handles the case when yahoo, for whatever reason,
			//says that the page is &quot;temporarily&quot; unavailable and gives a NotFound.
			//I'm treating it as a &quot;timeout&quot; in the sense that I use the &quot;i&quot; WebRetries
			//Doing it that way makes it easier then adding another another type of retry
			if(e.Status==WebExceptionStatus.ProtocolError)
			{
				HttpWebResponse response = e.Response as HttpWebResponse;
				if (response != null) 
				{
					//if this is an error other than NotFound then quit with an exception.
					if(response.StatusCode != HttpStatusCode.NotFound)throw(e);
					//this catches the last timeout (in this case 404)
					//if this is a NotFound AND i&lt;1 (i.e. retries is less than 1) 
					//then quit with an exception
					if(i&lt;1)
					{	
						System.Exception e1 = new Exception(&quot;Either Yahoo is not responding or '&quot;+Symbol +&quot;' not a valid ticker symbol&quot;);
						throw(e1);	
					}
					Thread.Sleep(2000); //give yahoo a chance to get things fixed
							

				}
			}
			else
			{
				//this hadles the case of when the yahoo data is &quot;offline&quot; for a while.
				//basically I ignore i WebExceptionStatus.Timeout's 
				if(e.Status!=WebExceptionStatus.Timeout) throw(e);
				if(i&lt;1) throw(e);	//this catches the last timeout 
			}


		}


	}



	public class X
	{	
		public int totalgood = 0;
		public void Update()
		{
		
			YahooData yd = new YahooData();		
			bool good = false;
			DateTime LastDate = new DateTime(2005,1,15);
			Console.WriteLine(&quot;Total good should give you '9' at the end.&quot;);
			Console.WriteLine(&quot;Symbol ATH does not exist.&quot;);
			Console.WriteLine(&quot;ATH was added for to make the test realistic.&quot;);
			Console.WriteLine(&quot;-----------&quot;);

			//Go through each symbol and query yahoo for any days traded after the last day in the securities table
			string[] symbols = new string[10];
			symbols[0] = &quot;Y&quot;;
			symbols[1] = &quot;CAT&quot;;
			symbols[2] = &quot;ITW&quot;;
			symbols[3] = &quot;MKL&quot;;
			symbols[4] = &quot;ATH&quot;;
			symbols[5] = &quot;ALX&quot;;
			symbols[6] = &quot;CME&quot;;
			symbols[7] = &quot;SBZ&quot;;
			symbols[8] = &quot;GOOG&quot;;
			symbols[9] = &quot;MITSY&quot;;

			for(int s=0; s&lt;10;s++)
			{   

				System.Collections.ArrayList al = new ArrayList();
				string symbol = symbols[s];		
		
				try  //query yahoo for data
				{
					good = true;
					Thread.Sleep(1000); //give yahoo a bandwidth break
					yd.GetHistoricalDays(symbol,LastDate, System.DateTime.Now.Date,ref al);
				}
				catch
				{
					//if something happens while getting data from yahoo then
					//mark it as a failed update in the db.
					good = false; 
				}

				if(good) totalgood++;
				Console.WriteLine(symbol + &quot; - &quot; + good + &quot; - &quot; + al.Count);				
			}
			Console.WriteLine(&quot;-----------&quot;);
			Console.WriteLine(&quot;Total Good: &quot; + totalgood.ToString());
	       
		}
	}





	/// &lt;summary&gt;
	/// Summary description for Class1.
	/// &lt;/summary&gt;
	class Class1
	{
		/// &lt;summary&gt;
		/// The main entry point for the application.
		/// &lt;/summary&gt;
		[STAThread]
		static void Main(string[] args)
		{

			X x = new X();
			x.Update();
			//Console.WriteLine(&quot;Press Enter to quit&quot;);
			//Console.ReadLine();
			//
			// TODO: Add code to start application here
			//
		}
	}
}
------=_20050203152403_50348--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="025598.html">[Mono-list] Bug 72149
</A></li>
	<LI> Next message: <A HREF="025579.html">[Mono-list] Mono, ASP.NET et Javascript push
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25578">[ date ]</a>
              <a href="thread.html#25578">[ thread ]</a>
              <a href="subject.html#25578">[ subject ]</a>
              <a href="author.html#25578">[ author ]</a>
         </LI>
       </UL>
</body></html>
