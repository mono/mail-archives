<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Some bugfixes for mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jarek%40atm.com.pl">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="005356.html">
   <LINK REL="Next"  HREF="005363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Some bugfixes for mono
   </H1>
    <B>Jaroslaw Kowalski
    </B> 
    <A HREF="mailto:jarek%40atm.com.pl"
       TITLE="[Mono-list] Some bugfixes for mono">jarek@atm.com.pl
       </A><BR>
    <I>Sun, 28 Apr 2002 22:28:13 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="005356.html">[Mono-list] csvorbis in CVS
</A></li>
        <LI> Next message: <A HREF="005363.html">[Mono-list] Some bugfixes for mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5362">[ date ]</a>
              <a href="thread.html#5362">[ thread ]</a>
              <a href="subject.html#5362">[ subject ]</a>
              <a href="author.html#5362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------=_NextPart_000_000A_01C1EF03.FBBECB50
Content-Type: text/plain;
	charset=&quot;iso-8859-2&quot;
Content-Transfer-Encoding: 7bit

This weekend I've been hacking on socket- and exception- related code:

Here come some patches, I'd like to be introduced in mono (only verified on
RedHat Linux 7.2)

1. Fixed an error where TcpClient returned from
TcpListener::AcceptTcpClient() would return null from GetStream() instead of
correct NetworkStream object.

[patch1.txt]

2. Improved Win32Exception error messages a bit by scanning through source
code looking for WSASetLastError() and adding errors along with their
descriptions to Win32Exception.cs file

[patch2.txt]

3. Attempted to fix a problem where send() to a closed socket resulted in a
signal being raised. Fixed this by including MSG_NOSIGNAL flag in a call to
send(). Also fixed some diagnostics in bind() call.

[patch3.txt]

4. Attempted to fix a problem with assert() being called when an exception
was thrown in a thread (JIT-only). exc_cleanup_id TLS Entry needs to be
filled for newly created threads. I added init_tls() function that is no-op
in MINT code and sets up the required TLS entry in JIT mode.

[patch4.txt]

Hope it helps someone,
Regards,

Jarek

------=_NextPart_000_000A_01C1EF03.FBBECB50
Content-Type: text/plain;
	name=&quot;patch3.txt&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;patch3.txt&quot;

Index: sockets.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mono/mono/io-layer/sockets.c,v=0A=
retrieving revision 1.7=0A=
diff -r1.7 sockets.c=0A=
304a305,309=0A=
&gt;<i> 	=0A=
</I>&gt;<i> 		case EADDRINUSE:=0A=
</I>&gt;<i> 			WSASetLastError(WSAEADDRINUSE);=0A=
</I>&gt;<i> 			break;=0A=
</I>&gt;<i> =0A=
</I>611a617,619=0A=
&gt;<i> #ifdef MSG_NOSIGNAL=0A=
</I>&gt;<i> 	ret=3Dsend(socket_handle-&gt;fd, msg, len, send_flags | MSG_NOSIGNAL);=0A=
</I>&gt;<i> #else=0A=
</I>612a621,622=0A=
&gt;<i> #endif=0A=
</I>&gt;<i> =0A=
</I>
------=_NextPart_000_000A_01C1EF03.FBBECB50
Content-Type: text/plain;
	name=&quot;patch1.txt&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;patch1.txt&quot;

Index: TcpClient.cs=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mcs/class/System/System.Net.Sockets/TcpClient.cs,v=0A=
retrieving revision 1.3=0A=
diff -r1.3 TcpClient.cs=0A=
95c95=0A=
&lt; 			set { client =3D value; } //TODO: should we be able to set the =
socket like this?=0A=
---=0A=
&gt;<i> 			set { client =3D value; }=0A=
</I>106c106,107=0A=
&lt; 			Client =3D s; // client or Client?  They are the same at the moment=0A=
---=0A=
&gt;<i> 			client =3D s;=0A=
</I>&gt;<i> 			stream =3D new NetworkStream(client, true);=0A=
</I>
------=_NextPart_000_000A_01C1EF03.FBBECB50
Content-Type: text/plain;
	name=&quot;patch2.txt&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;patch2.txt&quot;

Index: Win32Exception.cs=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: =
/mono/mcs/class/System/System.ComponentModel/Win32Exception.cs,v=0A=
retrieving revision 1.3=0A=
diff -r1.3 Win32Exception.cs=0A=
74a75,125=0A=
&gt;<i> 			w32_errors.Add(10004,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;interrupted&quot;));=0A=
</I>&gt;<i> =0A=
</I>&gt;<i> 			w32_errors.Add(10013,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEACCES&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(11002,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSATRY_AGAIN&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10022,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Invalid arguments&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10014,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEFAULT&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(11003,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSANO_RECOVERY&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(11004,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSANO_DATA&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10040,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEMSGSIZE&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10024,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEMFILE&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10042,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAENOPROTOOPT&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10050,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Network subsystem is down&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10051,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAENETUNREACH&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10035,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEWOULDBLOCK&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10036,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEINPROGRESS&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10060,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAETIMEDOUT&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10037,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEALREADY&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10061,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Connection refused&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10045,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;WSAEOPNOTSUPP&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10038,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;The descriptor is not a socket&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10055,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Not enough buffer space is available&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10056,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Socket is already connected&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10048,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Address already in use&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10057,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;The socket is not connected&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10058,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;The socket has been shut down&quot;));=0A=
</I>&gt;<i> 			w32_errors.Add(10093,=0A=
</I>&gt;<i> 			    Locale.GetText(&quot;Winsock not initialized&quot;));=0A=
</I>
------=_NextPart_000_000A_01C1EF03.FBBECB50
Content-Type: text/plain;
	name=&quot;patch4.txt&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;patch4.txt&quot;

? metadata/new_threads.c=0A=
? metadata/patches.txt=0A=
Index: metadata/threads.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mono/mono/metadata/threads.c,v=0A=
retrieving revision 1.18=0A=
diff -r1.18 threads.c=0A=
79a80=0A=
&gt;<i> 	init_tls();=0A=
</I>Index: metadata/threads.h=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mono/mono/metadata/threads.h,v=0A=
retrieving revision 1.13=0A=
diff -r1.13 threads.h=0A=
20a21=0A=
&gt;<i> extern void init_tls(void);=0A=
</I>Index: jit/jit.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mono/mono/jit/jit.c,v=0A=
retrieving revision 1.155=0A=
diff -r1.155 jit.c=0A=
3688a3689,3701=0A=
&gt;<i> void thread_unhandled_exception_cleanup(MonoObject *exc)=0A=
</I>&gt;<i> {=0A=
</I>&gt;<i> 	/* fixme: anything more? */=0A=
</I>&gt;<i> 	=0A=
</I>&gt;<i> 	ExitThread(0);=0A=
</I>&gt;<i> }=0A=
</I>&gt;<i> =0A=
</I>&gt;<i> void =0A=
</I>&gt;<i> init_tls()=0A=
</I>&gt;<i> {=0A=
</I>&gt;<i> 	/* this function is called in the context of newly-created thread */=0A=
</I>&gt;<i> 	TlsSetValue (exc_cleanup_id, thread_unhandled_exception_cleanup);=0A=
</I>&gt;<i> }=0A=
</I>Index: interpreter/interp.c=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mono/mono/interpreter/interp.c,v=0A=
retrieving revision 1.172=0A=
diff -r1.172 interp.c=0A=
3986a3987,3992=0A=
&gt;<i> void =0A=
</I>&gt;<i> init_tls()=0A=
</I>&gt;<i> {=0A=
</I>&gt;<i> 	/* this function is called in the context of newly-created thread */=0A=
</I>&gt;<i> }=0A=
</I>&gt;<i> =0A=
</I>
------=_NextPart_000_000A_01C1EF03.FBBECB50--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="005356.html">[Mono-list] csvorbis in CVS
</A></li>
	<LI> Next message: <A HREF="005363.html">[Mono-list] Some bugfixes for mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5362">[ date ]</a>
              <a href="thread.html#5362">[ thread ]</a>
              <a href="subject.html#5362">[ subject ]</a>
              <a href="author.html#5362">[ author ]</a>
         </LI>
       </UL>
</body></html>
