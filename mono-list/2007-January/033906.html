<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Npgsql1.0 Protocol option not supported
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Npgsql1.0%20Protocol%20option%20not%20supported&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033905.html">
   <LINK REL="Next"  HREF="033907.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Npgsql1.0 Protocol option not supported</H1>
    <B>Andrus</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Npgsql1.0%20Protocol%20option%20not%20supported&In-Reply-To="
       TITLE="[Mono-list] Npgsql1.0 Protocol option not supported">kobruleht2 at hot.ee
       </A><BR>
    <I>Sat Jan 13 18:54:12 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="033905.html">[Mono-list] Npgsql1.0 Protocol option not supported
</A></li>
        <LI>Next message: <A HREF="033907.html">[Mono-list] Npgsql1.0 Protocol option not supported
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33906">[ date ]</a>
              <a href="thread.html#33906">[ thread ]</a>
              <a href="subject.html#33906">[ subject ]</a>
              <a href="author.html#33906">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you.

My npgsql code works with MONO a week ago but now it suddenly stops working.

It it not possible to set any option which can cause this error.
It is impossible to connect to npgsql now at all, error occurs in first 
connect.
If I ran same exe file directly (it uses .NET 2 framework in this case), all 
is OK.

I looked to the method in npgsql source code which probably causes this
error but haven't found any idea.
How unsupported protocol option can be passed to npgsql/mono/windows ?
How to search for a string &quot;Protocol option not supported&quot; in MONO source
code in internet or must I unpack it to my hard disk?

npgsql Open() method code where this error occurs is:

public override void Open(NpgsqlConnector context)
        {

            try
            {

                NpgsqlEventLog.LogMethodEnter(LogLevel.Debug, CLASSNAME,
&quot;Open&quot;);

                /*TcpClient tcpc = new TcpClient();
                tcpc.Connect(new IPEndPoint(ResolveIPHost(context.Host),
context.Port));
                Stream stream = tcpc.GetStream();*/

                Socket socket = new
Socket(AddressFamily.InterNetwork,SocketType.Stream,ProtocolType.Tcp);

                /*socket.SetSocketOption (SocketOptionLevel.Socket,
SocketOptionName.SendTimeout, context.ConnectionTimeout*1000);*/

                //socket.Connect(new IPEndPoint(ResolveIPHost(context.Host),
context.Port));

                IAsyncResult result = socket.BeginConnect(new
IPEndPoint(ResolveIPHost(context.Host), context.Port), null, null);

                if
(!result.AsyncWaitHandle.WaitOne(context.ConnectionTimeout*1000, true))
                {
                    socket.Close();
                    throw new
Exception(resman.GetString(&quot;Exception_ConnectionTimeout&quot;));
                }

                try
                {
                    socket.EndConnect(result);
                }
                catch (Exception ex)
                {
                    socket.Close();
                    throw;
                }

                Stream stream = new NetworkStream(socket, true);

                // If the PostgreSQL server has SSL connectors enabled Open
SslClientStream if (response == 'S') {
                if (context.SSL || (context.SslMode == SslMode.Require) ||
(context.SslMode == SslMode.Prefer))
                {
                    PGUtil.WriteInt32(stream, 8);
                    PGUtil.WriteInt32(stream,80877103);
                    // Receive response

                    Char response = (Char)stream.ReadByte();
                    if (response == 'S')
                    {
                        stream = new SslClientStream(
                                    stream,
                                    context.Host,
                                    true,
                                    Mono.Security.Protocol.Tls.SecurityProtocolType.Default
                                );

                        ((SslClientStream)stream).ClientCertSelectionDelegate
= new
CertificateSelectionCallback(context.DefaultCertificateSelectionCallback);
                        ((SslClientStream)stream).ServerCertValidationDelegate
= new
CertificateValidationCallback(context.DefaultCertificateValidationCallback);
                        ((SslClientStream)stream).PrivateKeyCertSelectionDelegate
= new
PrivateKeySelectionCallback(context.DefaultPrivateKeySelectionCallback);
                    }
                    else if (context.SslMode == SslMode.Require)
                        throw new
InvalidOperationException(resman.GetString(&quot;Exception_Ssl_RequestError&quot;));

                }

                context.Stream = new BufferedStream(stream);
                context.Socket = socket;


                NpgsqlEventLog.LogMsg(resman, &quot;Log_ConnectedTo&quot;,
LogLevel.Normal, context.Host, context.Port);
                ChangeState(context, NpgsqlConnectedState.Instance);


            }
            catch (Exception e)
            {
                throw new NpgsqlException(e.Message, e);
            }
        }

    }

}


----- Original Message ----- 
From: &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">atsushi at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list at lists.ximian.com</A>&gt;
Sent: Saturday, January 13, 2007 7:14 PM
Subject: Re: [Mono-list] Npgsql1.0 Protocol option not supported


&gt;<i>I don't have any direct answers, but looks like the error message comes
</I>&gt;<i> from our Win32Exception. So, probably there is either some
</I>&gt;<i> misconfiguration (either in yours or mono's) or some kind of mono bug.
</I>&gt;<i> These days I have been able to connect to pgsql successfully on linux.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>&gt;<i> Andrus wrote:
</I>&gt;&gt;<i> My C# application returns error
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Protocol option not supported
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Error occurs in line
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Connection.Open();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Npgsql1.0 source code and docs does not contain such message.
</I>&gt;&gt;<i> When running under .NET 2 this error does not occur.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any idea how to fix it ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Environment:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Npgsql1.0
</I>&gt;&gt;<i> MONO 1.2  .net 2 profile
</I>&gt;&gt;<i> monocharge-20070112
</I>&gt;&gt;<i> Windows XP
</I>&gt;&gt;<i> VCS 2005 Express
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Code where error occurs is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> public static void CreateConnection(string Server, string Database,
</I>&gt;&gt;<i>        string User, string Password) {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NpgsqlEventLog.Level = LogLevel.Debug;
</I>&gt;&gt;<i> NpgsqlEventLog.LogName = @&quot;c:\NpgsqlLogFile.txt&quot;;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if (Connection != null)
</I>&gt;&gt;<i>     Connection.Close();
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ConnectionString = &quot;ENCODING=UNICODE;&quot; +
</I>&gt;&gt;<i>        &quot;SERVER=&quot; + Server + &quot;;&quot; +
</I>&gt;&gt;<i>        &quot;DATABASE=&quot; + Database + &quot;;&quot; +
</I>&gt;&gt;<i>        &quot;USER ID=&quot; + User + &quot;;&quot; +
</I>&gt;&gt;<i>        &quot;PASSWORD=&quot; + Password + &quot;;&quot;;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Connection = new NpgsqlConnection(ConnectionString);
</I>&gt;&gt;<i> IDbCommand Command = new NpgsqlCommand(@&quot;
</I>&gt;&gt;<i>         SET search_path TO firma1,public;
</I>&gt;&gt;<i>         SELECT sfirmanimi FROM prpalk&quot;,
</I>&gt;&gt;<i>      (NpgsqlConnection)Connection);
</I>&gt;&gt;<i> // Follwing line causes error Protocol Option not supported in MONO
</I>&gt;&gt;<i> Connection.Open();
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Stack trace:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Protocol option not supportedStack trace:   at
</I>&gt;&gt;<i> Npgsql.NpgsqlClosedState.Open
</I>&gt;&gt;<i> (Npgsql.NpgsqlConnector context) [0x00000]
</I>&gt;&gt;<i>   at Npgsql.NpgsqlConnector.Open () [0x00000]
</I>&gt;&gt;<i>   at Npgsql.NpgsqlConnectorPool.GetPooledConnector
</I>&gt;&gt;<i> (Npgsql.NpgsqlConnection
</I>&gt;&gt;<i> Connection) [0x00000]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> npgsql Log file:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug Entering
</I>&gt;&gt;<i> NpgsqlConnection.NpgsqlConnection(NpgsqlConnection())
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug ConnectionString Option: ENCODING =
</I>&gt;&gt;<i> UNICODE
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug ConnectionString Option: SERVER =
</I>&gt;&gt;<i> localhost
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug ConnectionString Option: DATABASE = mydb
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug ConnectionString Option: USER ID = admin
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug ConnectionString Option: PASSWORD = p
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug Entering NpgsqlCommand.NpgsqlCommand()
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug Entering
</I>&gt;&gt;<i> NpgsqlParameterCollection.NpgsqlParameterCollection()
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug Set NpgsqlCommand.Transaction =
</I>&gt;&gt;<i> 13.01.2007 18:12:45 2364 Debug Entering NpgsqlConnection.Open()
</I>&gt;&gt;<i> 13.01.2007 18:12:46 2364 Debug Get NpgsqlClosedState.Instance
</I>&gt;&gt;<i> 13.01.2007 18:12:46 2364 Debug Get NpgsqlClosedState.Instance
</I>&gt;&gt;<i> 13.01.2007 18:12:46 2364 Debug Entering NpgsqlClosedState.Open()
</I>&gt;&gt;<i> 13.01.2007 18:12:46 2364 Debug Get NpgsqlClosedState.Instance
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Andrus.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033905.html">[Mono-list] Npgsql1.0 Protocol option not supported
</A></li>
	<LI>Next message: <A HREF="033907.html">[Mono-list] Npgsql1.0 Protocol option not supported
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33906">[ date ]</a>
              <a href="thread.html#33906">[ thread ]</a>
              <a href="subject.html#33906">[ subject ]</a>
              <a href="author.html#33906">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
