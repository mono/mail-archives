<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Problems Using P/Invoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problems%20Using%20P/Invoke&In-Reply-To=1131637871.9243.17.camel%40reig.blitzware.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029423.html">
   <LINK REL="Next"  HREF="029424.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Problems Using P/Invoke</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Problems%20Using%20P/Invoke&In-Reply-To=1131637871.9243.17.camel%40reig.blitzware.net"
       TITLE="[Mono-list] Problems Using P/Invoke">jonpryor at vt.edu
       </A><BR>
    <I>Thu Nov 10 16:53:22 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="029423.html">[Mono-list] Problems Using P/Invoke
</A></li>
        <LI>Next message: <A HREF="029424.html">[Mono-list] XSP samples
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29427">[ date ]</a>
              <a href="thread.html#29427">[ thread ]</a>
              <a href="subject.html#29427">[ subject ]</a>
              <a href="author.html#29427">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2005-11-10 at 23:51 +0800, Jeremy Tan wrote:
&gt;<i> I am trying to write some C# bindings for the C++ libdar library
</I>&gt;<i> (<A HREF="http://dar.sourceforge.net">http://dar.sourceforge.net</A>)...
</I>&gt;<i> The problem I am having now is that I can't seem to find a way
</I>&gt;<i> to bind this library into C# APIs due to the way the functions are
</I>&gt;<i> declared. I've tried searching the internet but I can't seem to find any
</I>&gt;<i> information on this.
</I>
	<A HREF="http://www.mono-project.com/dllimport">http://www.mono-project.com/dllimport</A>

&gt;<i> I'm stuck at the first function that I'm trying to
</I>&gt;<i> import and I can't go any further from this point as almost all the
</I>&gt;<i> functions in the library are declared this way:
</I>&gt;<i> 
</I>&gt;<i> extern void get_compile_time_features(bool &amp; ea, 
</I>&gt;<i> 	bool &amp; largefile, 
</I>&gt;<i> 	bool &amp; nodump, 
</I>&gt;<i> 	bool &amp; special_alloc, 
</I>&gt;<i> 	U_I &amp; bits, 
</I>&gt;<i> 	bool &amp; thread_safe,
</I>&gt;<i>         bool &amp; libz, 
</I>&gt;<i> 	bool &amp; libbz2, 
</I>&gt;<i> 	bool &amp; libcrypto);
</I>&gt;<i> 
</I>&gt;<i> The problem I have here is the way the parameters are defined. Note that
</I>&gt;<i> the U_I type is just a typedef to unsigned int in libdar. In my source
</I>&gt;<i> file, i declared it like this because I can't seem to find a way to
</I>&gt;<i> specify &quot;&amp;&quot; in the method signature:
</I>
`ref' is an appropriate mapping for `&amp;'.  You have several other
problems...

&gt;<i> [DllImport(library, CallingConvention = CallingConvention.Cdecl)]
</I>&gt;<i>             private unsafe extern static void get_compile_time_features(
</I>&gt;<i>                     ref bool EAttributes,
</I>&gt;<i>                     ref bool LFile,
</I>&gt;<i>                     ref bool NDunp,
</I>&gt;<i>                     ref bool SAllocation,
</I>&gt;<i>                     ref uint bits,
</I>&gt;<i>                     ref bool TSafe,
</I>&gt;<i>                     ref bool LZ,
</I>&gt;<i>                     ref bool LBZ2,
</I>&gt;<i>                     ref bool LCrypto);
</I>
starting with this:

&gt;<i> Unhandled Exception: System.EntryPointNotFoundException:
</I>&gt;<i> get_compile_time_features
</I>&gt;<i> in (wrapper managed-to-native) LibDar.LibDar:get_compile_time_features
</I>&gt;<i> (bool&amp;,bool&amp;,bool&amp;,bool&amp;,uint&amp;,bool&amp;,bool&amp;,bool&amp;,bool&amp;)
</I>&gt;<i> in &lt;0x00054&gt; LibDar.LibDar:GetCompileTimeFeatures ()
</I>&gt;<i> in &lt;0x00026&gt; LibDar.Tester:Main (System.String[] args)
</I>
The problem is C++ name mangling.  For &quot;fun&quot; run the nm(1) command on
your C++ library.  The get_compile_time_features function is actually
the symbol _Z25get_compile_time_featuresRbS_S_S_RjS_S_S_S_ in your
library (or something similarly FUBAR).  Mono/.NET do not understand C++
name mangling conventions (there'd be little point, since each C++
compiler has a different name mangling scheme).

The solution to this is ``extern &quot;C&quot;''.  You'd have to either change the
get_compile_time_features declaration to this:

        extern &quot;C&quot; void get_compile_time_features(bool &amp; ea, 
        	bool &amp; largefile, 
        	bool &amp; nodump, 
        	bool &amp; special_alloc, 
        	U_I &amp; bits, 
        	bool &amp; thread_safe,
                bool &amp; libz, 
        	bool &amp; libbz2, 
        	bool &amp; libcrypto);

or you'd have to write a C wrapper for the C++ function.

The other problem you have is &quot;bool&quot;.  The size of &quot;bool&quot; varies between
compilers, and Mono marshals it as a short, which probably isn't what
the C++ compiler uses.  Thus you have to determine what sizeof(bool) is
for your C++ compiler and use an appropriate type in your C#
declaration.

You may find SWIG to be useful: <A HREF="http://www.swig.org">http://www.swig.org</A>

 - Jon


</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029423.html">[Mono-list] Problems Using P/Invoke
</A></li>
	<LI>Next message: <A HREF="029424.html">[Mono-list] XSP samples
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29427">[ date ]</a>
              <a href="thread.html#29427">[ thread ]</a>
              <a href="subject.html#29427">[ subject ]</a>
              <a href="author.html#29427">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
