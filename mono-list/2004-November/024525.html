<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] I must misunderstand delegates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mike%40digitalnova.co.za">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="024490.html">
   <LINK REL="Next"  HREF="024526.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] I must misunderstand delegates
   </H1>
    <B>Mike Welham
    </B> 
    <A HREF="mailto:mike%40digitalnova.co.za"
       TITLE="[Mono-list] I must misunderstand delegates">mike@digitalnova.co.za
       </A><BR>
    <I>Sat, 20 Nov 2004 15:51:43 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="024490.html">[Mono-list] I must misunderstand delegates
</A></li>
        <LI> Next message: <A HREF="024526.html">[Mono-list] I must misunderstand delegates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24525">[ date ]</a>
              <a href="thread.html#24525">[ thread ]</a>
              <a href="subject.html#24525">[ subject ]</a>
              <a href="author.html#24525">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Kevin,

&gt;<i> I'm writing a simple test (shown below) using an event with the
</I>&gt;<i> accessor methods add/remove.  I am trying in the remove accessor
</I>&gt;<i> method to use Delegate.RemoveAll to get rid of all occurances of
</I>&gt;<i> value.  However, RemoveAll takes 2 delegate parameters, removing all
</I>&gt;<i> occurances of d2's invocation list from d1's invocation list.  That
</I>&gt;<i> doesn't seem to be working when I pass in value as d2.  Also, if I
</I>&gt;<i> create a new Delegate with value as its method reference, and passing
</I>&gt;<i> this new Delegate instance to RemoveAll, it doesn't remove either. :(
</I>
Delegates are unusual in that they're immutable. (Once they're created you
can't modify them.)

So when using Delegate.RemoveAll (or .Combine), the two args you pass in are
not modified, but the method returns a new delegate with the modifications
you've asked for.

So your &quot;remove&quot; should look something like this:

remove
{
  _ageChange = (AgeChangeHandler) Delegate.RemoveAll(_ageChange, value);
}

&gt;<i> What do I put in the add accessor to check if value is already in the
</I>&gt;<i> delegate's invocation list somewhere, and only add if it is not in the
</I>&gt;<i> list?
</I>
Again, the same immutability issue. 

Your &quot;add&quot; (as per your requirement that the same delegate mustn't be added
if it's already there) could look something like this:

add
{
  if((_ageChange == null) ||
    (Array.IndexOf(_ageChange.GetInvocationList(), value) &lt; 0))
  {
    _ageChange = (AgeChangeHandler) Delegate.Combine(_ageChange, value);
  }
}

&gt;<i> if(_ageChange != null)
</I>&gt;<i> {  
</I>&gt;<i>    // invoke the event's delegate
</I>&gt;<i>    _ageChange(_age);
</I>&gt;<i> }
</I>
One more (pedantic) thing, if your events are intended to be thread-safe,
they shouldn't be fired as you have done above.

The problem is that between your null-check and the invocation the
subscribers could unsubscribe from another thread, and you'll get a
NullReferenceException thrown at the invocation.

This can be avoided by doing something like this:

AgeChangeHandler ageChange = ageChange;
if (ageChange != null)
{
  _ageChange(_age);
}

Hope this helps.

Regards

Mike


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="024490.html">[Mono-list] I must misunderstand delegates
</A></li>
	<LI> Next message: <A HREF="024526.html">[Mono-list] I must misunderstand delegates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24525">[ date ]</a>
              <a href="thread.html#24525">[ thread ]</a>
              <a href="subject.html#24525">[ subject ]</a>
              <a href="author.html#24525">[ author ]</a>
         </LI>
       </UL>
</body></html>
