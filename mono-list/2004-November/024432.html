<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Platform invoke for stdarg
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="024409.html">
   <LINK REL="Next"  HREF="024391.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Platform invoke for stdarg
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] Platform invoke for stdarg">jonpryor@vt.edu
       </A><BR>
    <I>Wed, 17 Nov 2004 07:23:43 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="024409.html">[Mono-list] Platform invoke for stdarg
</A></li>
        <LI> Next message: <A HREF="024391.html">[Mono-list] help with MySqlParameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24432">[ date ]</a>
              <a href="thread.html#24432">[ thread ]</a>
              <a href="subject.html#24432">[ subject ]</a>
              <a href="author.html#24432">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 2004-11-16 at 14:13 +0100, Francis Brosnan Blázquez wrote:
&gt;<i> El lun, 15-11-2004 a las 20:54 -0500, Jonathan Pryor escribió:
</I>&gt;<i> &gt; On Mon, 2004-11-15 at 20:24 +0100, Francis Brosnan Blázquez wrote:
</I>&gt;<i> &gt; &gt; Hi,
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; I'm trying to do a P/Invoke call for functions such as 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 	void Test(int value, ...); 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; But I don't get it working. Is it posible to do a platform invoke for c
</I>&gt;<i> &gt; &gt; functions that make use of stdarg api?
</I>
&lt;snip/&gt;

&gt;<i> &gt; However, there are two solutions:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 1.  Standard overloading: If there is a &quot;reasonable&quot; number of
</I>&gt;<i> &gt; parameters you need, you can explicitly specify them as overloads.  
</I>
&lt;snip/&gt;

&gt;<i> &gt; 2.  Get creative, take an object[] array, and generate some
</I>&gt;<i> &gt; System.Reflection.Emit code which accepts the proper number of
</I>&gt;<i> &gt; parameters of the proper type, and invoke the recently generated code.
</I>
&lt;snip/&gt;

It turns out I'm (unfortunately) wrong on both these solutions.  After
talking with lupus on IRC about this, we've determined that these
solutions will work, but only on some platforms.

The solutions above have one thing in common: they rely on an overloaded
function list, where each overload has a fixed number of parameters.
This may be a compile time list (solution 1) or a runtime-generated list
(solution 2), but this list is still present.

The problem is that some platforms, such as AMD64, use a &quot;cookie&quot; as
part of the function call sequence to help prevent buffer overflows and
stack corruption.

Both of the presented solutions don't, and can't, take this cookie into
consideration, and the cookie generated by them will be a value
generated for a fixed number of parameters, not the value required for
the stdarg calling convention.

Platforms which don't have this feature, such as x86 and PPC, will
function with the solutions presented above.

At present, there is NO PORTABLE SOLUTION to calling stdarg functions.
In the future, Mono will support __arglist, which will permit this, but
__arglist will likely be extremely limited, as type marshaling support
may be lacking (which would keep printf(3) from being wrapped, as
strings would need to be marshaled).

A potential workaround would be to create a new C function which accepts
an array instead of &quot;...&quot;, and the C function would call the stdarg
function on your behalf.  However, this solution begins to resemble
solution 1, in that the C function would need to somehow convert the
array into a stdarg calling sequence, which would probably involve a
list of C functions which then call the stdarg function...  Not pretty,
in any event, nor entirely general, as I can't think of a decent way to
wrap printf(3) by doing this, either. :-(

 - Jon



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="024409.html">[Mono-list] Platform invoke for stdarg
</A></li>
	<LI> Next message: <A HREF="024391.html">[Mono-list] help with MySqlParameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24432">[ date ]</a>
              <a href="thread.html#24432">[ thread ]</a>
              <a href="subject.html#24432">[ subject ]</a>
              <a href="author.html#24432">[ author ]</a>
         </LI>
       </UL>
</body></html>
