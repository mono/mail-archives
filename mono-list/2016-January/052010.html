<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Mono, Windows Forms, and Headless operation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Mono%2C%20Windows%20Forms%2C%20and%20Headless%20operation&In-Reply-To=%3CCAPmC0vZr_9-BH6hDy%3DWT26uE54Og%2BOswk%3DxPryoG7Z5zWDQU9g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="052009.html">
   <LINK REL="Next"  HREF="052011.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Mono, Windows Forms, and Headless operation</H1>
    <B>Mladen Mihajlovic</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Mono%2C%20Windows%20Forms%2C%20and%20Headless%20operation&In-Reply-To=%3CCAPmC0vZr_9-BH6hDy%3DWT26uE54Og%2BOswk%3DxPryoG7Z5zWDQU9g%40mail.gmail.com%3E"
       TITLE="[Mono-list] Mono, Windows Forms, and Headless operation">mmihajlovic at gmail.com
       </A><BR>
    <I>Sun Jan 10 06:34:33 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="052009.html">[Mono-list] Mono, Windows Forms, and Headless operation
</A></li>
        <LI>Next message: <A HREF="052011.html">[Mono-list] MSBuild Target for .jay files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52010">[ date ]</a>
              <a href="thread.html#52010">[ thread ]</a>
              <a href="subject.html#52010">[ subject ]</a>
              <a href="author.html#52010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey George

In a couple of places you mention you don't want to see the GUI and only
needed background workers? u think using normal threads will do the trick.
You can do everything and more that the background wonder does. Check
<A HREF="http://www.albahari.com/threading/">http://www.albahari.com/threading/</A> for more help.

Cheers
Mladen

On Saturday, 9 January 2016, George, Glover E ERDC-RDE-ITL-MS &lt;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Glover.E.George at erdc.dren.mil</A>&gt; wrote:

&gt;<i> Thanks Jordan.
</I>&gt;<i>
</I>&gt;<i> It turns out, I may have been conflating two problems into one.  The fact
</I>&gt;<i> that I needed to show the windows form was because I needed a message loop
</I>&gt;<i> to process the BackgroundWorker&#185;s events.  Turns out I can just call
</I>&gt;<i> Application.Run() with no parameter, and it will cause the UI thread to
</I>&gt;<i> start a message loop that works fine.
</I>&gt;<i>
</I>&gt;<i> The real problem is that it still seems as though mono requires X11 for
</I>&gt;<i> Windows Forms apps.  So I created a new project from scratch to test this
</I>&gt;<i> theory.  It is a very simple app.  It&#185;s a simple form with a button
</I>&gt;<i> (runButton) and a progress bar (progressBar1) (Designer code is left out
</I>&gt;<i> due to space).
</I>&gt;<i>
</I>&gt;<i> PROGRAM.CS
</I>&gt;<i> static class Program
</I>&gt;<i>     {
</I>&gt;<i>         /// &lt;summary&gt;
</I>&gt;<i>         /// The main entry point for the application.
</I>&gt;<i>         /// &lt;/summary&gt;
</I>&gt;<i>   [STAThread]
</I>&gt;<i>   static void Main()
</I>&gt;<i>   {
</I>&gt;<i>     // Instantiate the Main Form
</I>&gt;<i>     Form frm = new Form1();
</I>&gt;<i>     Application.Run();
</I>&gt;<i>   }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #FORM1.cs
</I>&gt;<i> public partial class Form1 : Form
</I>&gt;<i>     {
</I>&gt;<i>   public Form1()
</I>&gt;<i>   {
</I>&gt;<i>     InitializeComponent();
</I>&gt;<i>     runButton_Click(this,null);
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>   private void runButton_Click(object sender, EventArgs e)
</I>&gt;<i>   {
</I>&gt;<i>     BackgroundWorker worker = new BackgroundWorker();
</I>&gt;<i>     worker.WorkerReportsProgress = true;
</I>&gt;<i>     worker.DoWork += DoWork;
</I>&gt;<i>     worker.ProgressChanged += ProgressChanged;
</I>&gt;<i>     worker.RunWorkerCompleted += WorkerCompleted;
</I>&gt;<i>     worker.RunWorkerAsync(worker);
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>   public void DoWork(object sender, EventArgs e)
</I>&gt;<i>   {
</I>&gt;<i>     var worker = sender as BackgroundWorker;
</I>&gt;<i>     for (int i = 0; i &lt; 100; i++)
</I>&gt;<i>     {
</I>&gt;<i>       Thread.Sleep(100);
</I>&gt;<i>       worker.ReportProgress(i);
</I>&gt;<i>     }
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>   public void ProgressChanged(object sender, ProgressChangedEventArgs e)
</I>&gt;<i>   {
</I>&gt;<i>     progressBar1.Value = e.ProgressPercentage;
</I>&gt;<i>   }
</I>&gt;<i>
</I>&gt;<i>   public void WorkerCompleted(object sender, EventArgs e)
</I>&gt;<i>   {
</I>&gt;<i>     MessageBox.Show(&quot;I'm done!!!&quot;);
</I>&gt;<i>     Application.Exit();
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This program runs perfectly well without displaying anything so long as
</I>&gt;<i> DISPLAY is set to a valid X11 Display (:0).  However, if I unset DISPLAY
</I>&gt;<i> (export DISPLAY=), then I get the following error.  Note, this is similar
</I>&gt;<i> to the error I previously posted, but the stack trace and error message is
</I>&gt;<i> a bit more detailed (don&#185;t know why yet):
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Unhandled Exception:
</I>&gt;<i> System.TypeInitializationException: The type initializer for
</I>&gt;<i> 'System.Windows.Forms.WindowsFormsSynchronizationContext' threw an
</I>&gt;<i> exception. ---&gt; System.TypeInitializationException: The type initializer
</I>&gt;<i> for 'System.Windows.Forms.XplatUI' threw an exception. ---&gt;
</I>&gt;<i> System.ArgumentNullException: Could not open display (X-Server required.
</I>&gt;<i> Check your DISPLAY environment variable)
</I>&gt;<i> Parameter name: Display
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11.SetDisplay (IntPtr display_handle)
</I>&gt;<i> &lt;0x4100b560 + 0x00b9b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11..ctor () &lt;0x41009890 + 0x001df&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11.GetInstance () &lt;0x410096c0 + 0x0005b&gt;
</I>&gt;<i> in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUI..cctor () &lt;0x41009390 + 0x00137&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   --- End of inner exception stack trace ---
</I>&gt;<i>   at System.Windows.Forms.Theme.get_MenuAccessKeysUnderlined ()
</I>&gt;<i> &lt;0x41009340 + 0x0000b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.SystemInformation.get_MenuAccessKeysUnderlined
</I>&gt;<i> () &lt;0x41004790 + 0x00017&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.Control..ctor () &lt;0x410033b0 + 0x00243&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at (wrapper remoting-invoke-with-check)
</I>&gt;<i> System.Windows.Forms.Control:.ctor ()
</I>&gt;<i>   at System.Windows.Forms.WindowsFormsSynchronizationContext..cctor ()
</I>&gt;<i> &lt;0x410046c0 + 0x0001f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   --- End of inner exception stack trace ---
</I>&gt;<i>   at System.Windows.Forms.Control..ctor () &lt;0x410033b0 + 0x00053&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.ScrollableControl..ctor () &lt;0x41002e40 +
</I>&gt;<i> 0x0000f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.ContainerControl..ctor () &lt;0x41002cb0 + 0x00027&gt;
</I>&gt;<i> in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.Form..ctor () &lt;0x41002430 + 0x000bb&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at test2.Form1..ctor () &lt;0x40ffff90 + 0x0001f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at (wrapper remoting-invoke-with-check) test2.Form1:.ctor ()
</I>&gt;<i>   at test2.Program.Main () &lt;0x40fffd90 + 0x0001b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i> [ERROR] FATAL UNHANDLED EXCEPTION: System.TypeInitializationException: The
</I>&gt;<i> type initializer for
</I>&gt;<i> 'System.Windows.Forms.WindowsFormsSynchronizationContext' threw an
</I>&gt;<i> exception. ---&gt; System.TypeInitializationException: The type initializer
</I>&gt;<i> for 'System.Windows.Forms.XplatUI' threw an exception. ---&gt;
</I>&gt;<i> System.ArgumentNullException: Could not open display (X-Server required.
</I>&gt;<i> Check your DISPLAY environment variable)
</I>&gt;<i> Parameter name: Display
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11.SetDisplay (IntPtr display_handle)
</I>&gt;<i> &lt;0x4100b560 + 0x00b9b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11..ctor () &lt;0x41009890 + 0x001df&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUIX11.GetInstance () &lt;0x410096c0 + 0x0005b&gt;
</I>&gt;<i> in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.XplatUI..cctor () &lt;0x41009390 + 0x00137&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   --- End of inner exception stack trace ---
</I>&gt;<i>   at System.Windows.Forms.Theme.get_MenuAccessKeysUnderlined ()
</I>&gt;<i> &lt;0x41009340 + 0x0000b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.SystemInformation.get_MenuAccessKeysUnderlined
</I>&gt;<i> () &lt;0x41004790 + 0x00017&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.Control..ctor () &lt;0x410033b0 + 0x00243&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at (wrapper remoting-invoke-with-check)
</I>&gt;<i> System.Windows.Forms.Control:.ctor ()
</I>&gt;<i>   at System.Windows.Forms.WindowsFormsSynchronizationContext..cctor ()
</I>&gt;<i> &lt;0x410046c0 + 0x0001f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   --- End of inner exception stack trace ---
</I>&gt;<i>   at System.Windows.Forms.Control..ctor () &lt;0x410033b0 + 0x00053&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.ScrollableControl..ctor () &lt;0x41002e40 +
</I>&gt;<i> 0x0000f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.ContainerControl..ctor () &lt;0x41002cb0 + 0x00027&gt;
</I>&gt;<i> in &lt;filename unknown&gt;:0
</I>&gt;<i>   at System.Windows.Forms.Form..ctor () &lt;0x41002430 + 0x000bb&gt; in
</I>&gt;<i> &lt;filename unknown&gt;:0
</I>&gt;<i>   at test2.Form1..ctor () &lt;0x40ffff90 + 0x0001f&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>   at (wrapper remoting-invoke-with-check) test2.Form1:.ctor ()
</I>&gt;<i>   at test2.Program.Main () &lt;0x40fffd90 + 0x0001b&gt; in &lt;filename unknown&gt;:0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From the looks of that error message, is X truly a requirement for any app
</I>&gt;<i> that is calling Windows Forms controls?  Also note, the project type for
</I>&gt;<i> this project is Console App.  It appears that by dynamically loading (or
</I>&gt;<i> is it the link?) anything from System.Windows.Forms causes mono to require
</I>&gt;<i> X.
</I>&gt;<i> &#8249; &#8249; &#8249;
</I>&gt;<i>
</I>&gt;<i> Glover E. George
</I>&gt;<i> Computer Scientist
</I>&gt;<i> Information Technology Laboratory
</I>&gt;<i> US Army Engineer Research and Development Center
</I>&gt;<i> Vicksburg, MS 39180
</I>&gt;<i> 601-634-4730
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 1/8/16, 10:29 AM, &quot;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A> &lt;javascript:;&gt;
</I>&gt;<i> on behalf of
</I>&gt;<i> Robert Jordan&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list-bounces at lists.ximian.com</A> &lt;javascript:;&gt; on
</I>&gt;<i> behalf of
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">robertj at gmx.net</A> &lt;javascript:;&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;On 07.01.2016 22:24, George, Glover E ERDC-RDE-ITL-MS wrote:
</I>&gt;<i> &gt;&gt; Hi all,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; We&#185;re currently porting a Windows Forms Application to Mono, and have
</I>&gt;<i> &gt;&gt; generally had great success.  However, we have now hit a critical
</I>&gt;<i> &gt;&gt; decision point, and were hoping for some guidance on the best route
</I>&gt;<i> &gt;&gt; forward.   If we don&#185;t have X11, mono fails to run Windows Forms code
</I>&gt;<i> &gt;&gt; with the following error:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; From: System.Windows.Forms, at: Void .ctor(), Error Message: The type
</I>&gt;<i> &gt;&gt; initializer for
</I>&gt;<i> &gt;&gt; 'System.Windows.Forms.WindowsFormsSynchronizationContext' threw an
</I>&gt;<i> &gt;&gt; exception.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Question First: The main question I had for the Mono list is this.
</I>&gt;<i> &gt;&gt; Is it possible to have mono run Windows Forms code without trying to
</I>&gt;<i> &gt;&gt; open X11 (I.e. headless mode)?  What triggers mono to request an X11
</I>&gt;<i> &gt;&gt; display? Is it the project type?  Is it the call to an object that
</I>&gt;<i> &gt;&gt; inherits from a Windows Forms control?  I don&#185;t need to see the form,
</I>&gt;<i> &gt;&gt; but if I&#185;m using BackgroundWorkers, I need the form's event handler,
</I>&gt;<i> &gt;&gt; don&#185;t I?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;BackgroundWorker does not depend upon System.Windows.Forms, i.e.
</I>&gt;<i> &gt;it can use it headless.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;The exception you're experiencing is caused by the synchronization
</I>&gt;<i> &gt;context set and used by WinForms.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Supposing that you don't need any kind of synchronization, you
</I>&gt;<i> &gt;may want to replace the synchronization context with a simple
</I>&gt;<i> &gt;one.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I don't know if the most simple one
</I>&gt;<i> &gt;(System.Threading.SynchronizationContext)
</I>&gt;<i> &gt;would be enough or if you have to subclass it. Have a look
</I>&gt;<i> &gt;at its sources and at
</I>&gt;<i> &gt;System.Windows.Forms.WindowsFormsSynchronizationContext.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Robert
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;_______________________________________________
</I>&gt;<i> &gt;Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A> &lt;javascript:;&gt;
</I>&gt;<i> &gt;<A HREF="Blockedhttp://lists.ximian.com/mailman/listinfo/mono-listBlocked">Blockedhttp://lists.ximian.com/mailman/listinfo/mono-listBlocked</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A> &lt;javascript:;&gt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20160110/4f1b4e27/attachment.html">http://lists.ximian.com/pipermail/mono-list/attachments/20160110/4f1b4e27/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="052009.html">[Mono-list] Mono, Windows Forms, and Headless operation
</A></li>
	<LI>Next message: <A HREF="052011.html">[Mono-list] MSBuild Target for .jay files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52010">[ date ]</a>
              <a href="thread.html#52010">[ thread ]</a>
              <a href="subject.html#52010">[ subject ]</a>
              <a href="author.html#52010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
