<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Page Caching - VaryByParam,
	VaryByCustom (Bug or Feature)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Page%20Caching%20-%20VaryByParam%2C%0A%09VaryByCustom%20%28Bug%20or%20Feature%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028721.html">
   <LINK REL="Next"  HREF="028510.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Page Caching - VaryByParam,
	VaryByCustom (Bug or Feature)</H1>
    <B>Marc DM</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Page%20Caching%20-%20VaryByParam%2C%0A%09VaryByCustom%20%28Bug%20or%20Feature%29&In-Reply-To="
       TITLE="[Mono-list] Page Caching - VaryByParam,
	VaryByCustom (Bug or Feature)">m at phronein.com
       </A><BR>
    <I>Mon Sep 12 01:37:22 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="028721.html">[Mono-list] MonoDevelop 0.7
</A></li>
        <LI>Next message: <A HREF="028510.html">[Mono-list] Mono 1.1.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28509">[ date ]</a>
              <a href="thread.html#28509">[ thread ]</a>
              <a href="subject.html#28509">[ subject ]</a>
              <a href="author.html#28509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After a little bit of research this is what I found out using XSP 1.0.9 :

Two files global.asax and index.aspx. (see below). A simple web 
application to demonstrate what I think is a flaw in the handling of 
the  @OutputCache directive of *.aspx pages.

According to the M$DN documentation :
<A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconcachingversionsofpagebasedoncustomstrings.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconcachingversionsofpagebasedoncustomstrings.asp</A>
 when using VaryByCustom if you do not intend to use VaryByParam you 
should set the attribute value to &quot;None&quot;.

That's ok. But doesn't this mean that I should be able to use it if I 
please?

The example below (taken from the MSDN page) should give me a different 
version for each value of pg on the querystring, as well as change 
depending on browserversion.

However, it would seem as though, the inclusion of the VaryByCustom 
attribute supercedes VaryByParam.

In my tests, I get the same cached version generated by a change in the 
GetVaryByCustomString regardless of what I specify for ?pg=.

A workaround I'm using (see below) is to just include all my cache 
varying parameters as a comma-delimited VaryByCustom string and parse it 
in global.asax to return a string unique to the  requested version of 
the page.

See code below.

My question is, is this behaviour expected (doubt it). Should I fix it, 
or is it something easy for y'all to fix?

Regards,

Marc DM

------------------------------
[global.asax]

    &lt;%@ Application Language=&quot;c#&quot;%&gt;
    &lt;script runat=&quot;server&quot;&gt;
    public override string GetVaryByCustomString(HttpContext context,
    string arg){
      if (arg == &quot;minorversion&quot;)
        return &quot;Version=&quot; + context.Request.Browser.Version.ToString();
      else
        return &quot;NoVersion&quot;;
    }
    &lt;/script&gt;

[/global.asax]

[index.aspx]

    &lt;%@ Page Language=&quot;c#&quot; %&gt;
    &lt;%@ OutputCache Duration=&quot;300&quot; VaryByParam=&quot;pg&quot;
    VaryByCustom=&quot;minorversion&quot; %&gt;
    &lt;Script language=&quot;C#&quot; runat=&quot;server&quot;&gt;
        public void Page_Load(Object sender, EventArgs e) {
            browserversion.InnerHtml = Request.Browser.Version.ToString();
            timestamp.InnerHtml = DateTime.Now.ToString(&quot;r&quot;);
        }
    &lt;/Script&gt;

    Varying output by custom string (BrowserVersion): &lt;B
    id=&quot;browserversion&quot; runat=&quot;server&quot;/&gt;
    &lt;BR&gt;
    Added to the cache: &lt;B id=&quot;timestamp&quot; runat=&quot;server&quot; /&gt;

    &lt;br&gt;
    Click Links below and observe the timestamp on various pages with
    different browsers.
    &lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=1&quot;&gt;index.aspx?pg=1&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=2&quot;&gt;index.aspx?pg=2&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=3&quot;&gt;index.aspx?pg=3&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=4&quot;&gt;index.aspx?pg=4&lt;/a&gt;&lt;br&gt;

[/index.aspx]

---------------------------------------------------

[global.asax - workaround]

    &lt;%@ Application Language=&quot;c#&quot;%&gt;
    public override string GetVaryByCustomString(HttpContext context,
    string arg){
      string[] args = arg.Split(',');
      string ret=&quot;&quot;;
     
      for(int i=0;i&lt;args.Length;i++)
      { 
          if (args[i].Trim() == &quot;browserversion&quot;)
                ret += &quot;BrVer=&quot; +
    context.Request.Browser.Version.ToString() + &quot;;&quot; ;
          if (args[i].Trim() == &quot;pg&quot;)
                ret += &quot;pg=&quot; + Request.QueryString[&quot;pg&quot;] + &quot;;&quot;;    
          /*
          if (args[i].Trim() == &quot;my-other-arg&quot;)
          {
              // perform action to generate string to identify page version
              ret += &quot;Another ID String&quot;  + &quot;;&quot;;
          }
          */
      }
      return ret;
    }
    &lt;/script&gt;

[/global.asax - workaround]

[index.aspx - workaround]

    &lt;%@ Page Language=&quot;c#&quot; %&gt;
    &lt;%@ OutputCache Duration=&quot;300&quot; VaryByParam=&quot;none&quot;
    VaryByCustom=&quot;pg,browserversion&quot; %&gt;
    &lt;Script language=&quot;C#&quot; runat=&quot;server&quot;&gt;
        public void Page_Load(Object sender, EventArgs e) {
            browserversion.InnerHtml = Request.Browser.Version.ToString();
            qs_pg.InnerHtml = Request.QueryString[&quot;pg&quot;];
            timestamp.InnerHtml = DateTime.Now.ToString(&quot;r&quot;);
        }
    &lt;/Script&gt;

    Varying output by custom string (BrowserVersion): &lt;B
    id=&quot;browserversion&quot; runat=&quot;server&quot;/&gt;
    &lt;br&gt;
    Varying output by custom string (Querystring[pg]): &lt;B id=&quot;qs_pg&quot;
    runat=&quot;server&quot;/&gt;
    &lt;br&gt;
    Added to the cache: &lt;B id=&quot;timestamp&quot; runat=&quot;server&quot; /&gt;
    &lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=1&quot;&gt;index.aspx?pg=1&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=2&quot;&gt;index.aspx?pg=2&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=3&quot;&gt;index.aspx?pg=3&lt;/a&gt;&lt;br&gt;
    &lt;a href=&quot;index.aspx?pg=4&quot;&gt;index.aspx?pg=4&lt;/a&gt;&lt;br&gt;

[/index.aspx - workaround]

</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028721.html">[Mono-list] MonoDevelop 0.7
</A></li>
	<LI>Next message: <A HREF="028510.html">[Mono-list] Mono 1.1.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28509">[ date ]</a>
              <a href="thread.html#28509">[ thread ]</a>
              <a href="subject.html#28509">[ subject ]</a>
              <a href="author.html#28509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
