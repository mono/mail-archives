<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] A big (MS created) flaw in DateTime that surfaces in Web Services
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:lluis%40ideary.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="014618.html">
   <LINK REL="Next"  HREF="014620.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] A big (MS created) flaw in DateTime that surfaces in Web Services
   </H1>
    <B>Lluis Sanchez
    </B> 
    <A HREF="mailto:lluis%40ideary.com"
       TITLE="[Mono-list] A big (MS created) flaw in DateTime that surfaces in Web Services">lluis@ideary.com
       </A><BR>
    <I>Fri, 27 Jun 2003 14:35:46 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="014618.html">[Mono-list] A big (MS created) flaw in DateTime that surfaces in Web Services
</A></li>
        <LI> Next message: <A HREF="014620.html">[Mono-list] CVS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14629">[ date ]</a>
              <a href="thread.html#14629">[ thread ]</a>
              <a href="subject.html#14629">[ subject ]</a>
              <a href="author.html#14629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rafael!

&gt;<i> Lluis, how do we handle serializing DateTime over XML (in Remoting and on
</I>&gt;<i> Web Services)?
</I>
In the same way as MS does :-)

&gt;<i> First some background:
</I>&gt;<i>
</I>&gt;<i> The DateTime struct just keeps date and time information without keeping
</I>any
&gt;<i> time zone information, you are supposed to use ToLocalTime() and
</I>&gt;<i> ToUniversalTime() to adjust it by the machine's time zone info.
</I>&gt;<i>
</I>&gt;<i> This is fine for many situations where you can keep a tab on how time zone
</I>&gt;<i> info influences the process.
</I>&gt;<i>
</I>&gt;<i> But this is broken for Web Services, where it is mandatory to use full
</I>time
&gt;<i> information when serializing it to xml and back. As time zone information
</I>&gt;<i> isn't present on DateTime, MS' implementation just gets the machine set
</I>time
&gt;<i> zone and adds it to the data. It even corrects for daylight savings in
</I>&gt;<i> historical data what brings a bunch of problems for itself (at least in
</I>&gt;<i> Brazil daylight savings policies vary wildly from year to year).
</I>&gt;<i>
</I>&gt;<i> At the other end the local time zone is subtracted from it. End result:
</I>&gt;<i> DateTime data that may be totally unrelated to the machines location (and
</I>&gt;<i> therefore time zones) gets displaced in time when transmitted by Web
</I>&gt;<i> Services.
</I>
Hmm. Maybe I'm missing something, but I don't see the problem. For example,
lets say that there is a server A in GMT+1 timezone thats makes a call to a
server B in GMT-6 timezone. The call includes the date 27/6/2003 14:00:00.
The XmlSerializer in server A will format this date as
27/6/2003T14:00:00.0000000+01:00. The server B will deserialize this date as
27/6/2003 07:00:00 (where 7 = 14 - (+1) + (-6)). If this date goes back from
server B to server A, server B will serialize
27/6/2003T07:00:00.0000000-06:00, and server A will get again 27/6/2003
14:00:00 (where 14 = 7 - (-6) + 1)

BTW, this didn't work a couple of days ago, I just commited that fixes it.

In Remoting, there may be a problem, because DateTime is serialized as
ticks, so don't include the UTC offset. When such a date is serialized in
the destination sever there is no way to know the original timezone. But you
can always include the UTC offset as an extra parameter.

&gt;<i>
</I>&gt;<i> I realized this the hard way: in my application part of the historical
</I>data
&gt;<i> available only for workdays started to move to sundays over the wire, and
</I>&gt;<i> oddly, only for the daylight savings period.
</I>&gt;<i>
</I>&gt;<i> Also when using DateTime.MaxValue as a value for parameters in calls,
</I>&gt;<i> exceptions about exceeding the MaxTicks value started to bounce from the
</I>&gt;<i> server.
</I>
Yes, that's another problem. I've partially removed some of this checks to
match MS.NET behavior, and it works better now. However you have to be
careful to use for example DateTime.MinValue as a marker for null dates,
because this value can change if the date is deserialized in a server that
has a different timezone.

&gt;<i> For my application I will just avoid the issue by serializing the Ticks
</I>&gt;<i> member of the DateTime, but this is a larger issue with broader
</I>&gt;<i> implications.
</I>
This does not solve the issue, unless you work always with the same
timezone. Ticks are also relative to the time zone.

&gt;<i>
</I>&gt;<i> Miguel, think of all time-related information being displaced on
</I>SourceGear
&gt;<i> Vault's web services...
</I>&gt;<i>
</I>&gt;<i> I see some possibilities:
</I>&gt;<i>
</I>&gt;<i> 1 - We can talk to ECMA and MS, to expand DateTime, but that would play
</I>&gt;<i> havoc by breaking binary compatibility. Remember, DateTime is a struct and
</I>&gt;<i> as such a value type.
</I>&gt;<i> 2 - We can create Mono.DateTime or propose to ECMA an
</I>&gt;<i> System.UniversalDateTime. But only new or revised code would benefit from
</I>&gt;<i> it.
</I>&gt;<i> 3 - We can serialize DateTime over XML differently: A) we can always
</I>append
&gt;<i> a Z to arbitrarily zone it on GMT or B) as XML Schema cites the time zone
</I>&gt;<i> information as optional we can just leave it out. That may play bad with
</I>&gt;<i> broader interoperability, however.
</I>&gt;<i> 4 - We can give more control of the xml serialization to the programmer.
</I>See
&gt;<i> the DataType member of the Xml{whatever}Attribute family of attributes for
</I>&gt;<i> something almost there. Again only new or revised code would benefit.
</I>
I dont find necessary to extend or change DateTime to include UTC info. It
is enough to include it when a data is serialized. XmlSerializer already
does it, BinaryFormatter does not.

- Lluis


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="014618.html">[Mono-list] A big (MS created) flaw in DateTime that surfaces in Web Services
</A></li>
	<LI> Next message: <A HREF="014620.html">[Mono-list] CVS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14629">[ date ]</a>
              <a href="thread.html#14629">[ thread ]</a>
              <a href="subject.html#14629">[ subject ]</a>
              <a href="author.html#14629">[ author ]</a>
         </LI>
       </UL>
</body></html>
