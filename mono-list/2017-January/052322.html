<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Easy way to deadlock Mono with concurrent HttpWebRequests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.dot.net?Subject=Re%3A%20%5BMono-list%5D%20Easy%20way%20to%20deadlock%20Mono%20with%20concurrent%0A%20HttpWebRequests&In-Reply-To=%3C12921B4A-D34E-4E55-8286-CA593E2B91E0%40microsoft.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052321.html">
   <LINK REL="Next"  HREF="052323.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Easy way to deadlock Mono with concurrent HttpWebRequests</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-list%40lists.dot.net?Subject=Re%3A%20%5BMono-list%5D%20Easy%20way%20to%20deadlock%20Mono%20with%20concurrent%0A%20HttpWebRequests&In-Reply-To=%3C12921B4A-D34E-4E55-8286-CA593E2B91E0%40microsoft.com%3E"
       TITLE="[Mono-list] Easy way to deadlock Mono with concurrent HttpWebRequests">miguel at microsoft.com
       </A><BR>
    <I>Tue Jan 10 21:58:34 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052321.html">[Mono-list] Adding two properties content to string
</A></li>
        <LI>Next message (by thread): <A HREF="052323.html">[Mono-list] Mono 4.6 apache and server side events
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52322">[ date ]</a>
              <a href="thread.html#52322">[ thread ]</a>
              <a href="subject.html#52322">[ subject ]</a>
              <a href="author.html#52322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This works for me, with both stable and master from December 12th.

Miguel.

From: Mono-list &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">mono-list-bounces at lists.dot.net</A>&gt; on behalf of Rubén de Alba &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">rdealba at codicesoftware.com</A>&gt;
Date: Friday, December 23, 2016 at 6:27 AM
To: &quot;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">mono-list at lists.dot.net</A>&quot; &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">mono-list at lists.dot.net</A>&gt;
Cc: &quot;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">psantosl at codicesoftware.com</A>&quot; &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-list">psantosl at codicesoftware.com</A>&gt;
Subject: [Mono-list] Easy way to deadlock Mono with concurrent HttpWebRequests


Hi,

We can deadlock Mono launching a few HttpWebRequests. We can consistently reproduce in our app, but only sometimes happens in the attached program.

We initially detected this on a server pulling data from Azure. It deadlocks and it is unable to handle a single new request (since we rely on Socket.BeginReceive for that, and the callback is never invoked once the deadlock happens).

We suspect it could still be related to this ancient issue: <A HREF="http://www.mono-project.com/archived/articlethreadpool_deadlocks/&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.mono-project.com%2Farchived%2Farticlethreadpool_deadlocks%2F&amp;data=02%7C01%7Cmiguel%40microsoft.com%7C9fa698bca9f44310f44d08d42b26b563%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636180892637291812&amp;sdata=%2BSrNzQ4qjxdxSjyZltlqdwN%2BgfHhZORprCNzkNXdSrk%3D&amp;reserved=0">http://www.mono-project.com/archived/articlethreadpool_deadlocks/&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.mono-project.com%2Farchived%2Farticlethreadpool_deadlocks%2F&amp;data=02%7C01%7Cmiguel%40microsoft.com%7C9fa698bca9f44310f44d08d42b26b563%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636180892637291812&amp;sdata=%2BSrNzQ4qjxdxSjyZltlqdwN%2BgfHhZORprCNzkNXdSrk%3D&amp;reserved=0</A>&gt;

I have attached a small sample application to reproduce the issue. It occasionally deadlocks on Mono 4.6.2.7 (and older) no matter whether the machine has 1 core or 8. What is consistent is that it performs worse than expected and fails. Not sure if this is a hint.

What the app does is:

* It launches 40 HttpWebRequest.GetResponse() in parallel.
* Most of them fail (&quot;The authentication or decryption has failed.&quot;, &quot;The request timed out&quot;) .
* The program retries if they fail - and retries also fail.
* CPU is very high (90% on my test box).
* After a while sometimes the entire program hangs.
* We also tried the HttpClient class using async calls and no threadpool but result wasn't any better.

Some interesting notes:
* The same code works well in .NET/Windows.
* And launching the 40 concurrent requests is super fast there compared to super slow using Mono.


Any hints or workarounds will be greatly appreciated :-P

Thanks!

Rubén,

www.plasticscm.com&lt;<A HREF="https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.plasticscm.com&amp;data=02%7C01%7Cmiguel%40microsoft.com%7C9fa698bca9f44310f44d08d42b26b563%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636180892637291812&amp;sdata=uAyy71WFMUKAVt5eoPImc6LfgarnOrhkX74kRVvRsWI%3D&amp;reserved=0">https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fwww.plasticscm.com&amp;data=02%7C01%7Cmiguel%40microsoft.com%7C9fa698bca9f44310f44d08d42b26b563%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636180892637291812&amp;sdata=uAyy71WFMUKAVt5eoPImc6LfgarnOrhkX74kRVvRsWI%3D&amp;reserved=0</A>&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-list/attachments/20170110/d3b1193c/attachment.html">http://lists.dot.net/pipermail/mono-list/attachments/20170110/d3b1193c/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052321.html">[Mono-list] Adding two properties content to string
</A></li>
	<LI>Next message (by thread): <A HREF="052323.html">[Mono-list] Mono 4.6 apache and server side events
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52322">[ date ]</a>
              <a href="thread.html#52322">[ thread ]</a>
              <a href="subject.html#52322">[ subject ]</a>
              <a href="author.html#52322">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
