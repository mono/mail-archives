<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Mono Socket Server drops clients when it does big	operations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Mono%20Socket%20Server%20drops%20clients%20when%20it%20does%20big%0A%09operations&In-Reply-To=%3C1427017346519-4665670.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="051584.html">
   <LINK REL="Next"  HREF="051585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Mono Socket Server drops clients when it does big	operations</H1>
    <B>acrym</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Mono%20Socket%20Server%20drops%20clients%20when%20it%20does%20big%0A%09operations&In-Reply-To=%3C1427017346519-4665670.post%40n4.nabble.com%3E"
       TITLE="[Mono-list] Mono Socket Server drops clients when it does big	operations">soreric94 at gmail.com
       </A><BR>
    <I>Sun Mar 22 09:42:26 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="051584.html">[Mono-list] Ubuntu user wants do see College videos that only works with Silverlight
</A></li>
        <LI>Next message: <A HREF="051585.html">[Mono-list] Mono-list Digest, Vol 119, Issue 16
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51583">[ date ]</a>
              <a href="thread.html#51583">[ thread ]</a>
              <a href="subject.html#51583">[ subject ]</a>
              <a href="author.html#51583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mono 3.99 
My socket server runs fine in Windows, but on Linux/Mono it drops a socket.
Whenever the server runs an operation longer than a fraction of a second,
the socket is disconnected, but occasionally the client stays connected. The
client is Silverlight 4 and is run from Windows.

More reproducible is when two clients connect. The first connects fine. The
second connects, but when the server runs an operation, my server
disconnects the first client. When this happens, the first client sends
exactly 0 bytes.

I have my clients in a static list so they won't be GC'd, and timeout is set
high. The only thing I can think of is the client might be pinging the
server, and in that window of time when it handles the message, it's not in
a receive state. But that would make sockets extremely fragile.

Is there any reason - Mono-related or otherwise - that could cause this
behavior?

  static void OnBeginAccept(IAsyncResult ar)
    {
        try
        {
            TcpClient _MessageClient =
_MessageListener.EndAcceptTcpClient(ar);
            byte[] _ReceiveBuffer = new byte[8197];
            System.IO.StreamWriter streamW = new
System.IO.StreamWriter(_MessageClient.GetStream());
            ClientDefinition newClient = new ClientDefinition();
            newClient.Socket = _MessageClient.Client;
            newClient.Socket.ReceiveTimeout = 7000;
newClient.Socket.SendTimeout = 7000;
            newClient.username = &quot;undefined&quot; + clients.Count;
            newClient.receiveBuffer = new byte[8197];
            clients.Add(newClient);

            newClient.Socket.BeginReceive(newClient.receiveBuffer, 0, 8196,
SocketFlags.None, new AsyncCallback(OnReceiveComplete), newClient);
            _MessageListener.BeginAcceptTcpClient(new
AsyncCallback(OnBeginAccept), null);
            Console.WriteLine(&quot;new client accepted&quot;);
        }
        catch (Exception ex) { LogError(ex); }
    }


  static void OnReceiveComplete(IAsyncResult ar)
    {
        ClientDefinition fromClient = null; //Wrapper for Socket
        fromClient = (ClientDefinition)ar.AsyncState;
        if (fromClient == null) return;

        try
        {
            if (!fromClient.Socket.Connected)
            {
                Console.WriteLine(&quot;fromclient (&quot; + fromClient.username + &quot;)
not connected&quot;);
                CloseClient(fromClient);
                return;
            }
            int receiveLength = 0;
            receiveLength = fromClient.Socket.EndReceive(ar);
            if (receiveLength == 0)
            {
                Console.WriteLine(&quot;Receivelength == 0&quot;);
                CloseClient(fromClient);
            }


            SocketMessage message = null;
            message =
Serializer.Deserialize&lt;SocketMessage&gt;(fromClient.receiveBuffer);
            System.Array.Clear(fromClient.receiveBuffer, 0, receiveLength);

            /******Here is where I handle the messages. And when doing an
operation that is 'big', a client is closed.*****/

            fromClient.Socket.BeginReceive(fromClient.receiveBuffer, 0,
8196, SocketFlags.None, new                        
AsyncCallback(OnReceiveComplete), fromClient);


        }
        catch (Exception ex)
        {
            Console.WriteLine(&quot;Exception in OnReceiveComplete: &quot; +
ex.Message + ex.StackTrace + &quot;obj: &quot; + ex.Source);
            CloseClient(fromClient);

        }





--
View this message in context: <A HREF="http://mono.1490590.n4.nabble.com/Mono-Socket-Server-drops-clients-when-it-does-big-operations-tp4665670.html">http://mono.1490590.n4.nabble.com/Mono-Socket-Server-drops-clients-when-it-does-big-operations-tp4665670.html</A>
Sent from the Mono - General mailing list archive at Nabble.com.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="051584.html">[Mono-list] Ubuntu user wants do see College videos that only works with Silverlight
</A></li>
	<LI>Next message: <A HREF="051585.html">[Mono-list] Mono-list Digest, Vol 119, Issue 16
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51583">[ date ]</a>
              <a href="thread.html#51583">[ thread ]</a>
              <a href="subject.html#51583">[ subject ]</a>
              <a href="author.html#51583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
