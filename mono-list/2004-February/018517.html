<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Patch for mcs/class/Cscompmgd/Microsoft.CSharp/Compiler.cs
 (Jackson)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:steve%40citygroup.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="018516.html">
   <LINK REL="Next"  HREF="018518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Patch for mcs/class/Cscompmgd/Microsoft.CSharp/Compiler.cs
 (Jackson)
   </H1>
    <B>Steve Deobald
    </B> 
    <A HREF="mailto:steve%40citygroup.ca"
       TITLE="[Mono-list] Patch for mcs/class/Cscompmgd/Microsoft.CSharp/Compiler.cs
 (Jackson)">steve@citygroup.ca
       </A><BR>
    <I>Mon, 23 Feb 2004 05:04:49 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="018516.html">[Mono-list] Socket code.
</A></li>
        <LI> Next message: <A HREF="018518.html">[Mono-list] Socket code.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18517">[ date ]</a>
              <a href="thread.html#18517">[ thread ]</a>
              <a href="subject.html#18517">[ subject ]</a>
              <a href="author.html#18517">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here is a patch I wrote weeks (months?) ago to finish a TODO Jackson
pointed me to. Tonight I cleaned it up so it actually works and tested
it by hand and matched it to the MS Cscompmgd.dll output.

There is no unit test for Cscompmgd that I can see... and I'm not sure
if I'm the person to be writing one. ;) If I should just jump in and
create a test for Cscompmgd, please let me know. Thanks.

.steve

PS: This is the first patch I've ever sent, so I would really appreciate
comments from anyone who has a minute for some constructive criticism.
:<i>)
</I>

---
/usr/src/monocvs/mcs/class/Cscompmgd/Microsoft.CSharp/Compiler.cs	2002-12-12 02:33:43.000000000 -0600
+++ Compiler.cs	2004-02-23 04:41:31.000000000 -0600
@@ -12,6 +12,7 @@
 using System.Collections;
 using System.Diagnostics;
 using System.Text.RegularExpressions;
+using System.Reflection;
 
 namespace Microsoft.CSharp {
 
@@ -21,7 +22,6 @@
 		{
 		}
 
-		[MonoTODO(&quot;Have not implemented bugreports&quot;)]
 		public static CompilerError[] Compile(string[] sourceTexts,
 			string[] sourceTextNames, string target, string[] imports,
    			IDictionary options)
@@ -39,7 +39,8 @@
 				bugreport_path = (string)options[&quot;bugreport&quot;];	
 			
 			if (bugreport_path != null) {
-				bug_report = CreateBugReport (sourceTexts, sourceTextNames,
bugreport_path);
+				bug_report = CreateBugReport (sourceTexts, sourceTextNames,
bugreport_path, 
+					temp_cs_files, target, imports, options);
 			}			
 
 			try {
@@ -203,22 +204,42 @@
 		}
 
 		private static StreamWriter CreateBugReport (string[] source_texts, 
-			string[] source_names, string path)
+			string[] source_names, string path, string[] cs_files,
+			string target, string[] imports, IDictionary options)
 		{
 			StreamWriter bug_report = null;
 
 			try {
 				bug_report = new StreamWriter (path);
+
+				// locate mcs.exe and find version info
+				string mcs_location = Path.GetDirectoryName (typeof
(object).Assembly.Location);
+				mcs_location = mcs_location.Substring(0, 
+					mcs_location.LastIndexOf(Path.DirectorySeparatorChar)+1);
+				mcs_location += &quot;bin&quot; + Path.DirectorySeparatorChar + &quot;mcs.exe&quot;;
+				Assembly mcs_assembly = Assembly.LoadFrom(mcs_location);
+				
 				bug_report.WriteLine (&quot;### C# Compiler Defect Report,&quot; + 
 					&quot; created {0}&quot;, DateTime.Now);
-				// Compiler Version
-				// Runtime
-				// Operating System
-				// Username
+				bug_report.WriteLine (&quot;### Compiler version: {0}.{1}.{2}.{3}&quot;, 
+					mcs_assembly.GetName().Version.Major.ToString(),
+					mcs_assembly.GetName().Version.Minor.ToString(),
+					mcs_assembly.GetName().Version.Build.ToString(),
+					mcs_assembly.GetName().Version.Revision.ToString()
+				);
+				bug_report.WriteLine (&quot;### Common Language Runtime Version: {0}&quot;, 
+					System.Environment.Version);
+				bug_report.WriteLine (&quot;### Operating System: {0}&quot;,
+					System.Environment.OSVersion);
+				bug_report.WriteLine (&quot;### Compiler command line: {0} {1}&quot;,
+					Assembly.GetExecutingAssembly().Location.Substring (
+					Assembly.GetExecutingAssembly().Location.LastIndexOf (
+					Path.DirectorySeparatorChar)+1),
+					BuildArgs (cs_files, target, imports, options));
 				for (int i=0; i&lt;source_texts.Length; i++) {
 					bug_report.WriteLine (&quot;### Source file: '{0}'&quot;,
 						source_names[i]);
-					bug_report.Write (source_texts[i]);
+					bug_report.WriteLine (source_texts[i]);
 				}
 			} catch {
 				if (bug_report != null)



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="018516.html">[Mono-list] Socket code.
</A></li>
	<LI> Next message: <A HREF="018518.html">[Mono-list] Socket code.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18517">[ date ]</a>
              <a href="thread.html#18517">[ thread ]</a>
              <a href="subject.html#18517">[ subject ]</a>
              <a href="author.html#18517">[ author ]</a>
         </LI>
       </UL>
</body></html>
