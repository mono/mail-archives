<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Patch for String.Replace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jackson%40latitudegeo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="015471.html">
   <LINK REL="Next"  HREF="015484.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Patch for String.Replace
   </H1>
    <B>Jackson Harper
    </B> 
    <A HREF="mailto:jackson%40latitudegeo.com"
       TITLE="[Mono-list] Patch for String.Replace">jackson@latitudegeo.com
       </A><BR>
    <I>19 Aug 2003 19:55:15 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="015471.html">[Mono-list] Patch for String.Replace
</A></li>
        <LI> Next message: <A HREF="015484.html">[Mono-list] mono_marshal_get_runtime_invoke (marshal.c)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15512">[ date ]</a>
              <a href="thread.html#15512">[ thread ]</a>
              <a href="subject.html#15512">[ subject ]</a>
              <a href="author.html#15512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-3htak2bg6xRTourU+7XP
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

On Mon, 2003-08-18 at 04:36, Jonathan Pryor wrote:
&gt;<i> Perhaps I'm missing something, but your patch could be much simpler. 
</I>&gt;<i> All you need to do is, before the &quot;ret = mono_string_new_size(...)&quot; line
</I>&gt;<i> (line 351), have this:
</I>&gt;<i> 
</I>&gt;<i> 	if (occur == 0)
</I>&gt;<i> 		return me;
</I>
	The occurr variable is only modified if the string being replaced is
not the same size as the replacement string. 

	I can use your check if the strings are a different size though.
Attached is a new patch.

Jackson

&gt;<i> 
</I>&gt;<i> Since &quot;occur&quot; keeps track of how many times &quot;oldValue&quot; occurs within
</I>&gt;<i> &quot;me&quot;, if occur is 0, you don't need to do any processing at all.  This
</I>&gt;<i> would require no changes to the loop as well.
</I>&gt;<i> 
</I>&gt;<i>  - Jon
</I>&gt;<i> 
</I>&gt;<i> On Mon, 2003-08-18 at 11:30, Jackson Harper wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 	Attached is a patch that changes the behavoir of String.Replace. If the
</I>&gt;<i> &gt; replace method does not alter the string at all it returns a reference
</I>&gt;<i> &gt; to the unaltered string. I have been told on #mono that this is what is
</I>&gt;<i> &gt; happening on MS. Would be great if some more people can confirm this.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 	I've also attached a test case that I will integrate into the unit
</I>&gt;<i> &gt; tests if someone can confirm that this is the same behavoir as MS.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Jackson
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>
--=-3htak2bg6xRTourU+7XP
Content-Disposition: attachment; filename=string-icalls.c.patch
Content-Type: text/x-patch; name=string-icalls.c.patch; charset=
Content-Transfer-Encoding: 7bit

Index: string-icalls.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/string-icalls.c,v
retrieving revision 1.22
diff -u -r1.22 string-icalls.c
--- string-icalls.c	11 May 2003 23:52:40 -0000	1.22
+++ string-icalls.c	20 Aug 2003 03:05:33 -0000
@@ -343,28 +343,36 @@
 		for (i = 0; i &lt;= srclen - oldstrlen; i++)
 			if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2)))
 				occurr++;
-
+                if (occurr == 0)
+                        return me;
 		newsize = srclen + ((newstrlen - oldstrlen) * occurr);
  	} else
 		newsize = srclen;
 
-	ret = mono_string_new_size( mono_domain_get (), newsize);
-	dest = mono_string_chars(ret);
-
+        ret = NULL;
 	i = 0;
 	while (i &lt; srclen) {
 		if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2))) {
+                        if (ret == NULL) {
+                                ret = mono_string_new_size( mono_domain_get (), newsize);
+                                dest = mono_string_chars(ret);
+                                memcpy (dest, src, i * sizeof(gunichar2));
+                        }
 			if (newstrlen &gt; 0) {
 				memcpy(dest + destpos, newstr, newstrlen * sizeof(gunichar2));
 				destpos += newstrlen;
 			}
 			i += oldstrlen;
-		} else {
+                        continue;
+		} else if (ret != NULL) {
 			dest[destpos] = src[i];
+ 		}
 			destpos++;
 			i++;
 		}
-	}
+        
+        if (ret == NULL)
+                return me;
 
 	return ret;
 }

--=-3htak2bg6xRTourU+7XP--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="015471.html">[Mono-list] Patch for String.Replace
</A></li>
	<LI> Next message: <A HREF="015484.html">[Mono-list] mono_marshal_get_runtime_invoke (marshal.c)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15512">[ date ]</a>
              <a href="thread.html#15512">[ thread ]</a>
              <a href="subject.html#15512">[ subject ]</a>
              <a href="author.html#15512">[ author ]</a>
         </LI>
       </UL>
</body></html>
