<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Patch for String.Replace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jackson%40latitudegeo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="015482.html">
   <LINK REL="Next"  HREF="015471.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Patch for String.Replace
   </H1>
    <B>Jackson Harper
    </B> 
    <A HREF="mailto:jackson%40latitudegeo.com"
       TITLE="[Mono-list] Patch for String.Replace">jackson@latitudegeo.com
       </A><BR>
    <I>18 Aug 2003 08:30:41 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="015482.html">[Mono-list] Re: Nant 0.8.2 question
</A></li>
        <LI> Next message: <A HREF="015471.html">[Mono-list] Patch for String.Replace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15461">[ date ]</a>
              <a href="thread.html#15461">[ thread ]</a>
              <a href="subject.html#15461">[ subject ]</a>
              <a href="author.html#15461">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-7ITRduklSmemwJELiz7t
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Hello,

	Attached is a patch that changes the behavoir of String.Replace. If the
replace method does not alter the string at all it returns a reference
to the unaltered string. I have been told on #mono that this is what is
happening on MS. Would be great if some more people can confirm this.

	I've also attached a test case that I will integrate into the unit
tests if someone can confirm that this is the same behavoir as MS.


Jackson



--=-7ITRduklSmemwJELiz7t
Content-Disposition: attachment; filename=string-icalls.c.patch
Content-Type: text/x-patch; name=string-icalls.c.patch; charset=
Content-Transfer-Encoding: 7bit

Index: string-icalls.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/string-icalls.c,v
retrieving revision 1.22
diff -u -r1.22 string-icalls.c
--- string-icalls.c	11 May 2003 23:52:40 -0000	1.22
+++ string-icalls.c	18 Aug 2003 05:05:37 -0000
@@ -348,23 +348,30 @@
  	} else
 		newsize = srclen;
 
-	ret = mono_string_new_size( mono_domain_get (), newsize);
-	dest = mono_string_chars(ret);
-
+        ret = NULL;
 	i = 0;
 	while (i &lt; srclen) {
 		if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2))) {
+                        if (ret == NULL) {
+                                ret = mono_string_new_size( mono_domain_get (), newsize);
+                                dest = mono_string_chars(ret);
+                                memcpy (dest, src, i * sizeof(gunichar2));
+                        }
 			if (newstrlen &gt; 0) {
 				memcpy(dest + destpos, newstr, newstrlen * sizeof(gunichar2));
 				destpos += newstrlen;
 			}
 			i += oldstrlen;
-		} else {
+                        continue;
+		} else if (ret != NULL) {
 			dest[destpos] = src[i];
-			destpos++;
-			i++;
 		}
+                destpos++;
+                i++;
 	}
+
+        if (ret == NULL)
+                return me;
 
 	return ret;
 }

--=-7ITRduklSmemwJELiz7t
Content-Disposition: attachment; filename=string-replace.cs
Content-Type: text/plain; name=string-replace.cs; charset=
Content-Transfer-Encoding: 7bit


using System;

namespace T {

        public class Driver
        {
                public static int Main ()
                {
                        if (TestA () &amp;&amp; TestB ())
                                return 0;
                        return -1;
                }

                private static bool TestA ()
                {
                        string s = &quot;KKKKKKKKKKKKKKKK&quot;;
                        string ss = s.Replace (&quot;n&quot;, &quot;b&quot;);
                        return String.ReferenceEquals (s, ss);
                }

                private static bool TestB ()
                {
                        string s = &quot;KKKKKKKKKKKKKKKK&quot;;
                        string ss = s.Replace (&quot;K&quot;, &quot;A&quot;);
                        return !(String.ReferenceEquals (s, ss));
                }
        }

}


--=-7ITRduklSmemwJELiz7t--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="015482.html">[Mono-list] Re: Nant 0.8.2 question
</A></li>
	<LI> Next message: <A HREF="015471.html">[Mono-list] Patch for String.Replace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15461">[ date ]</a>
              <a href="thread.html#15461">[ thread ]</a>
              <a href="subject.html#15461">[ subject ]</a>
              <a href="author.html#15461">[ author ]</a>
         </LI>
       </UL>
</body></html>
