<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Array.cs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:martin%40gnome.org">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003792.html">
   <LINK REL="Next"  HREF="003810.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Array.cs
   </H1>
    <B>Martin Baulig
    </B> 
    <A HREF="mailto:martin%40gnome.org"
       TITLE="[Mono-list] Array.cs">martin@gnome.org
       </A><BR>
    <I>06 Mar 2002 14:22:04 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="003792.html">[Mono-list] Array.cs
</A></li>
        <LI> Next message: <A HREF="003810.html">[Mono-list] Array.Copy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3798">[ date ]</a>
              <a href="thread.html#3798">[ thread ]</a>
              <a href="subject.html#3798">[ subject ]</a>
              <a href="author.html#3798">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Paolo Molaro &lt;<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>&gt; writes:

&gt;<i> On 03/06/02 Martin Baulig wrote:
</I>&gt;<i> &gt; &gt; Can you post some info about what kind of changes to the array code
</I>&gt;<i> &gt; &gt; you want to do?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; well, several things which are now all in CVS:
</I>&gt;<i> 
</I>&gt;<i> My reason for asking information was to see the changes _before_ they
</I>&gt;<i> went in cvs. I hope I don't sound like a prick, but any change to
</I>&gt;<i> fundamental classes most likely bites me before anyone else, because I
</I>&gt;<i> routinely run the most complex C# app (mcs) with our class library.
</I>&gt;<i> Excuse me if I'm a little paranoid with changes to Array.
</I>&gt;<i> And while a simple bug added may not appear in the test suite or
</I>&gt;<i> may be lost in the noise of hundreds of errors, it is likely to show up
</I>&gt;<i> when running large or complex programs (ie I can't compile).
</I>
Hi,

I'm sorry for this, I got your mail after committing my changes.

&gt;<i> One problem is that the test suite needs to be changed to be more
</I>&gt;<i> fine-grained: a single test method contains many subtests and if the
</I>&gt;<i> first fails, the others are not run. This needs to be fixed.
</I>
Good point, I'll look at this.

&gt;<i> &gt; 2.) Rewrote the Array:Copy implementation so that it can now copy multi-
</I>&gt;<i> &gt;     dimensional arrays.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     I'm also planning to implement this directly in C so that it can use
</I>&gt;<i> &gt;     memcpy() whenever possible.
</I>&gt;<i> 
</I>&gt;<i> See icall.c:ves_icall_System_Array_FastCopy().
</I>
Well, this internall is both unused and incomplete. It needs to check
whether both arrays are of the same type and use the &quot;normal&quot; copy if not.

&gt;<i> &gt; 6.) Made sure that all tests in the test suite pass.
</I>&gt;<i> 
</I>&gt;<i> Several Array test fail for me here after updating to cvs (though they
</I>&gt;<i> likely failed before as well).
</I>
Can you give me a list of which tests fail ?

However, my guess is that this is already fixed in CVS. Before
committing my changes, all Array tests passed. After committing, I
updated my tree, recompiled everything and realized that they do no
longer, but I was too tired to look at the problem. This morning, I
updated and recompiled again and now all of them pass again.

&gt;<i> This is in Array.CopyTo (). Here is the history of this line in the last
</I>&gt;<i> few changes:
</I>&gt;<i> 
</I>&gt;<i> 1.19         (martin   01-Mar-02): 			if (index &gt;= array.GetLength(0))
</I>&gt;<i> 1.20         (lupus    04-Mar-02): 			if (index + this.GetLength(0) &gt; array.GetLength(0))
</I>&gt;<i> 1.21         (martin   05-Mar-02): 			if (index &gt;= array.GetLength(0))
</I>&gt;<i> 
</I>&gt;<i> I.e. I changed that line a couple of days ago, because it broke the
</I>&gt;<i> compiler and you changed it back (broking the compiler again).
</I>&gt;<i> Please, tell me what test case your change fixes that mine wouldn't.
</I>
Ooops, you're right - your version is the correct one. I must have
been confused by the words in the docu and the fact that there was
indeed a test which failed here - but since it no longer does, I guess
that the actual bug was somewhere else.

I'll revert it back later on.

&gt;<i> Here is the test that your change breaks, instead.
</I>&gt;<i> 
</I>&gt;<i> using System;
</I>&gt;<i> 
</I>&gt;<i> namespace Test {
</I>&gt;<i>         public class Test {
</I>&gt;<i>                 public static int Main () {
</I>&gt;<i>                         int[] src = new int [0];
</I>&gt;<i>                         int[] dest = new int [0];
</I>&gt;<i>                         src.CopyTo (dest, 0);
</I>&gt;<i>                         return 0;
</I>&gt;<i>                 }
</I>&gt;<i>         }
</I>&gt;<i> }
</I>
Well, you just found a bug in the documentation. Your code is
incorrect according to the documentation (it says the the exceptio is
thrown if either &quot;index is equal to or greater than the length of
array&quot; or &quot;the number of element in the source array is greater than
the available space from index to the end of the destination array&quot;),
but it works fine with the microsoft runtime.

So according to the docu, both checks must be done - but according to
the implementation, only your check is to be done.

I'll revert this back, add the test to the testsuite and a note to
API-notes.txt.

-- 
Martin Baulig
<A HREF="mailto:martin@gnome.org">martin@gnome.org</A>


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003792.html">[Mono-list] Array.cs
</A></li>
	<LI> Next message: <A HREF="003810.html">[Mono-list] Array.Copy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3798">[ date ]</a>
              <a href="thread.html#3798">[ thread ]</a>
              <a href="subject.html#3798">[ subject ]</a>
              <a href="author.html#3798">[ author ]</a>
         </LI>
       </UL>
</body></html>
