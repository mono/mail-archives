<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] mcs compiles on linux. Now what?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dietmar%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003898.html">
   <LINK REL="Next"  HREF="003905.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] mcs compiles on linux. Now what?
   </H1>
    <B>Dietmar Maurer
    </B> 
    <A HREF="mailto:dietmar%40ximian.com"
       TITLE="[Mono-list] mcs compiles on linux. Now what?">dietmar@ximian.com
       </A><BR>
    <I>08 Mar 2002 14:45:17 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="003898.html">[Mono-list] mcs compiles on linux. Now what?
</A></li>
        <LI> Next message: <A HREF="003905.html">[Mono-list] mcs compiles on linux. Now what?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3899">[ date ]</a>
              <a href="thread.html#3899">[ thread ]</a>
              <a href="subject.html#3899">[ subject ]</a>
              <a href="author.html#3899">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2002-03-08 at 14:39, Piers Haken wrote:
&gt;<i> microsoft's implementation of ValueType.GetHashCode() basically uses
</I>&gt;<i> reflection to find the first non-zero field and returns that [1]. I'm
</I>&gt;<i> not sure what Object's GetHashCode() does. I'll look into it. I have a
</I>&gt;<i> feeling it's internal, though.
</I>&gt;<i> 
</I>
Another solution is to check if a class implements its own GetHashCode
function. If not the runtime can add a unique object id to each
allocated object. This adds 4 additional bytes to some objects, but it
also works with a compacting GC. At first glance it looks easy to
implement:


Index: mono/metadata/class.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/class.c,v
retrieving revision 1.90
diff -u -r1.90 class.c
--- mono/metadata/class.c	2002/03/07 06:39:57	1.90
+++ mono/metadata/class.c	2002/03/08 09:40:33
@@ -327,6 +327,7 @@
 	MonoClass *k, *ic;
 	MonoMethod **vtable = class-&gt;vtable;
 	int i, max_iid, cur_slot = 0;
+	static MonoMethod *default_ghc = NULL;
 
 	g_assert (class);
 
@@ -622,6 +623,23 @@
 						ic-&gt;method.count, ic-&gt;name_space, ic-&gt;name);
 				}
 			}
+		}
+	}
+
+#define GHC_SLOT 2
+
+	if (!default_ghc) {
+		if (class == mono_defaults.object_class) { 
+			default_ghc = vtable [GHC_SLOT];
+			g_assert (!strcmp (default_ghc-&gt;name, &quot;GetHashCode&quot;));
+		}
+	}
+	
+	class-&gt;ghcimpl = 1;
+	if (class != mono_defaults.object_class) { 
+		if (vtable [GHC_SLOT] == default_ghc) {
+			printf (&quot;TEST %s.%s\n&quot;, class-&gt;name_space, class-&gt;name);
+			class-&gt;ghcimpl = 0;
 		}
 	}
 }
Index: mono/metadata/class.h
===================================================================
RCS file: /cvs/public/mono/mono/metadata/class.h,v
retrieving revision 1.41
diff -u -r1.41 class.h
--- mono/metadata/class.h	2002/03/07 06:39:57	1.41
+++ mono/metadata/class.h	2002/03/08 09:40:33
@@ -41,6 +41,7 @@
 	guint inited          : 1;
 	guint valuetype       : 1; /* derives from System.ValueType */
 	guint enumtype        : 1; /* derives from System.Enum */
+	guint ghcimpl         : 1; /* class has its own GetHashCode impl */ 
 	guint min_align       : 4;
 
 	MonoClass  *parent;
Index: mono/metadata/object.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/object.c,v
retrieving revision 1.46
diff -u -r1.46 object.c
--- mono/metadata/object.c	2002/03/08 07:02:28	1.46
+++ mono/metadata/object.c	2002/03/08 09:40:33
@@ -90,13 +90,22 @@
 MonoObject *
 mono_object_new (MonoDomain *domain, MonoClass *klass)
 {
+	static guint32 uoid = 0;
 	MonoObject *o;
 
 	if (!klass-&gt;inited)
 		mono_class_init (klass);
 
-	o = mono_object_allocate (klass-&gt;instance_size);
-	o-&gt;vtable = mono_class_vtable (domain, klass);
+
+	if (klass-&gt;ghcimpl) {
+		o = mono_object_allocate (klass-&gt;instance_size);
+		o-&gt;vtable = mono_class_vtable (domain, klass);
+	} else {
+		o = mono_object_allocate (klass-&gt;instance_size + 4);
+		*((guint32 *)o) = uoid;
+		((char *)o) += 4;
+		o-&gt;vtable = mono_class_vtable (domain, klass);
+	}
 
 	return o;
 }




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003898.html">[Mono-list] mcs compiles on linux. Now what?
</A></li>
	<LI> Next message: <A HREF="003905.html">[Mono-list] mcs compiles on linux. Now what?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3899">[ date ]</a>
              <a href="thread.html#3899">[ thread ]</a>
              <a href="subject.html#3899">[ subject ]</a>
              <a href="author.html#3899">[ author ]</a>
         </LI>
       </UL>
</body></html>
