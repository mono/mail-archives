<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] JIT patch for stabs debugging
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:martin%40gnome.org">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003967.html">
   <LINK REL="Next"  HREF="003973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] JIT patch for stabs debugging
   </H1>
    <B>Martin Baulig
    </B> 
    <A HREF="mailto:martin%40gnome.org"
       TITLE="[Mono-list] JIT patch for stabs debugging">martin@gnome.org
       </A><BR>
    <I>10 Mar 2002 13:45:49 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="003967.html">[Mono-list] JIT patch for stabs debugging
</A></li>
        <LI> Next message: <A HREF="003973.html">[Mono-list] JIT patch for stabs debugging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3971">[ date ]</a>
              <a href="thread.html#3971">[ thread ]</a>
              <a href="subject.html#3971">[ subject ]</a>
              <a href="author.html#3971">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Paolo Molaro &lt;<A HREF="mailto:lupus@ximian.com">lupus@ximian.com</A>&gt; writes:

&gt;<i> On 03/10/02 Martin Baulig wrote:
</I>&gt;<i> &gt; 1.) Puts a NOP instruction at the start of every method.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     If you use `mono --debug Something', this buts a breakpoint
</I>&gt;<i> &gt;     instruction (INT 3) at the start of &quot;Something&quot; - which means
</I>&gt;<i> &gt;     that the address of Something's first instruction changes, but
</I>&gt;<i> &gt;     this address is already hard-coded into the stabs file.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     So without the NOP instructions you need to recreate your stabs
</I>&gt;<i> &gt;     symbol files each time you want to run mono with different --debug
</I>&gt;<i> &gt;     arguments.
</I>&gt;<i> 
</I>&gt;<i> No, this is wrong: if you restart mono, all the infos in the stab file
</I>&gt;<i> are wrong. It may have happened that in two runs the same method was
</I>&gt;<i> assigned the same address by malloc, but you can't rely on it:-)
</I>&gt;<i> I don't know if a recent gdb allows to unload a debug object, if it
</I>&gt;<i> still doesn't, you need to quit and restart gdb as well (and recompile
</I>&gt;<i> the stabs each time you start mono).
</I>
Sure, that's right. The problem is that SIGABRT usually is normally a
deadly signal for a process - so you can't run &quot;mono --stabs --debug&quot;
in a shell. On the other hand, running it in gdb to create the stabs
files is very inconvenient since you must hit enter each time it
reaches a breakpoint.

In most situations, running mono several times with the same stabs
file should work fine as long as the program flow stays the same - for
instance, you have a test case which takes no user input and always
produces the same output. There, being able to restart the program
with different --debug arguments can be very useful.

&gt;<i> &gt; 2.) Uses correct line numbers in the stabs file.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;     In mono_debug_add_method(), `t-&gt;cli_add' is a bytecode offset, but
</I>&gt;<i> &gt;     not a line number in the .il file.
</I>&gt;<i> 
</I>&gt;<i> Thanks for fixing this: I ran out of time to properly implement this
</I>&gt;<i> when I added support for debugging and since stabs format allows lines
</I>&gt;<i> up to 2^16 I planned to switch to the dwarf debug format anyway
</I>&gt;<i> (plus, there is an actual specification for dwarf, &lt;grin&gt;).
</I>
Oooops, really ? There are more than 2^16 lines in corlib.il, but I
only debugged things around line 40774 so far.

&gt;<i> &gt; @@ -201,14 +228,16 @@
</I>&gt;<i> &gt;  mono_debug_add_method (MonoDebugHandle* debug, MonoFlowGraph *cfg)
</I>&gt;<i> &gt;  {
</I>&gt;<i> &gt;  	char *name;
</I>&gt;<i> &gt; -	int line = 0;
</I>&gt;<i> &gt; -	int i;
</I>&gt;<i> &gt; +	int line = 0, line_index = 0;
</I>&gt;<i> &gt; +	int i, print;
</I>&gt;<i> &gt;  	MonoMethod *method = cfg-&gt;method;
</I>&gt;<i> &gt;  	MonoClass *klass = method-&gt;klass;
</I>&gt;<i> &gt;  	MonoMethodSignature *sig = method-&gt;signature;
</I>&gt;<i> &gt;  	char **names = g_new (char*, sig-&gt;param_count);
</I>&gt;<i> &gt;  	AssemblyDebugInfo* info = mono_debug_open_ass (debug, klass-&gt;image);
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; +	print = !strcmp (method-&gt;name, &quot;Parse&quot;) || !strcmp (method-&gt;name, &quot;Main&quot;);
</I>&gt;<i> &gt; +
</I>&gt;<i> ^^^^^^^^^^^^^^^^^^^^^^^
</I>&gt;<i> Leftover from debugging?
</I>
Yes, removed.

&gt;<i> &gt; --- x86.brg	2002/03/08 06:08:46	1.92
</I>&gt;<i> &gt; +++ x86.brg	2002/03/09 21:48:16
</I>&gt;<i> &gt; @@ -816,7 +816,7 @@
</I>&gt;<i> &gt;  	if (tree-&gt;left-&gt;reg1 != X86_EAX)
</I>&gt;<i> &gt;  		x86_mov_reg_reg (s-&gt;code, X86_EAX, tree-&gt;left-&gt;reg1, 4);
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; -	x86_cdq (s-&gt;code);
</I>&gt;<i> &gt; +	x86_mov_reg_imm (s-&gt;code, X86_EDX, 0);
</I>&gt;<i> &gt;  	x86_div_reg (s-&gt;code, tree-&gt;right-&gt;reg1, FALSE);
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt;  	mono_assert (tree-&gt;reg1 == X86_EAX &amp;&amp;
</I>&gt;<i> 
</I>&gt;<i> Use xor %edx, %edx, there.
</I>
There is no x86_xor(), but x86_mov_reg_imm() already emits a XOR if the argument is zero.

Btw., this shouldn't be in the diff, it's another patch which Dietmar already approved.

-- 
Martin Baulig
<A HREF="mailto:martin@gnome.org">martin@gnome.org</A>


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003967.html">[Mono-list] JIT patch for stabs debugging
</A></li>
	<LI> Next message: <A HREF="003973.html">[Mono-list] JIT patch for stabs debugging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3971">[ date ]</a>
              <a href="thread.html#3971">[ thread ]</a>
              <a href="subject.html#3971">[ subject ]</a>
              <a href="author.html#3971">[ author ]</a>
         </LI>
       </UL>
</body></html>
