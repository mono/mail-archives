<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Executing ASP.net page out side IIS  (in apache)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:rmahato%40dacafe.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="004295.html">
   <LINK REL="Next"  HREF="004303.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Executing ASP.net page out side IIS  (in apache)
   </H1>
    <B>rmahato@dacafe.com
    </B> 
    <A HREF="mailto:rmahato%40dacafe.com"
       TITLE="[Mono-list] Executing ASP.net page out side IIS  (in apache)">rmahato@dacafe.com
       </A><BR>
    <I>Tue, 26 Mar 2002 07:40:24 -0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="004295.html">[Mono-list] NET using Java VMs and libs
</A></li>
        <LI> Next message: <A HREF="004303.html">[Mono-list] Executing ASP.net page out side IIS  (in apache)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4301">[ date ]</a>
              <a href="thread.html#4301">[ thread ]</a>
              <a href="subject.html#4301">[ subject ]</a>
              <a href="author.html#4301">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi 
i am  working on developing a ISAPI application for  executing a asp.net 
page  in a apache application

i would like to contibute in the areas for developing asp.net runtime..
any idea where i  can start on.

Raj

==========

regarding what i am doing :

1) and ISAP dll  for ruting .aspx/asmx request  in apache

2) process this request in .net framework 

using system.web.hosting.applicationshost

httpworkerrequest.


i am able to execute the code form am exe
but whe i call the dotnet component form  an ISAPI applicatio it throws 
and exception


The type initializer for &quot;System.Web.HttpRuntime&quot; threw an exception.

=================

.net componet code
==================


using System;
using System.Web;
using System.IO ; 
using System.Web.Hosting; 
using  System.Runtime.InteropServices ;  


namespace ASPNET
{
	/// &lt;summary&gt;
	/// Summary description for Class1.
	/// &lt;/summary&gt;
	/// 
	public class MyExeHost : MarshalByRefObject 
	{
		public void ProcessRequest(string page,ref string Output) 
		{
			try
			{
				MemoryStream ms= new MemoryStream();
				StreamWriter sw = new StreamWriter(ms); 
				//BinaryWriter bw = new BinaryWriter(ms);  
				//HttpContext hc= HttpContext.Current;
				sw.AutoFlush = true; 
				HttpRuntime.ProcessRequest(new SimpleWorkerRequest(page ,null,sw));
				StreamReader sr= new StreamReader(ms); 
				ms.Position =0; 
				Output = sr.ReadToEnd();
			}
			catch(Exception ex)
			{
				Output = ex.Message+page; 
				return;
			}
		}
	
	}

	public interface IMyHost
	{
		 void  ExecutePage(string page,string AppName, string AppDir, ref 
string Output);
	}

	[ClassInterface(ClassInterfaceType.None )]
	public class MyHost :IMyHost
	{				
		public void  ExecutePage(string page,string AppName, string AppDir, 
ref string Output)
		{
			try
			{
				
				MyExeHost  host = 
(MyExeHost)ApplicationHost.CreateApplicationHost(typeof(MyExeHost), 
AppName,AppDir);
				host.ProcessRequest(page, ref Output);
			}
			catch(Exception ex)
			{
				Output = ex.Message +page+&quot; Execute page &quot;+AppName+AppDir; 
			}

		}
	}

}
====================

ISAPI code 

======================

// validate.cpp : Defines the entry point for the DLL application.
//
#include &lt;windows.h&gt;
//#include &quot;compnet.h&quot;
#include &quot;httpext.h&quot;
#include &quot;stdio.h&quot;
#import &quot;aspnetcomp.tlb&quot; 


void WriteContext(EXTENSION_CONTROL_BLOCK *pECB, char *pszFormat, ...);
int ExecPage(BSTR pg ,BSTR ap ,BSTR dr ,BSTR *out) ;

//DLL Entry point
BOOL APIENTRY DllMain(HANDLE hModule, DWORD  ul_reason_for_call, LPVOID 
lpReserved)
{
return TRUE;
}



//Ist Function called by IIS
BOOL WINAPI GetExtensionVersion(HSE_VERSION_INFO *pVer)
{
	pVer-&gt;dwExtensionVersion = HSE_VERSION;
	strncpy(pVer-&gt;lpszExtensionDesc, &quot;Validate ISAPI Extension&quot;, 
HSE_MAX_EXT_DLL_NAME_LEN);
	return TRUE;
}

//start
void StartContext(EXTENSION_CONTROL_BLOCK *pECB)
{
	WriteContext(pECB, &quot;&lt;html&gt;\r\n&lt;body&gt;\r\n&quot;);
}

//end
void EndContext(EXTENSION_CONTROL_BLOCK *pECB)
{
	WriteContext(pECB, &quot;&lt;/body&gt;\r\n&lt;/html&gt;&quot;);
}

//for Writing Data back to client
void WriteContext(EXTENSION_CONTROL_BLOCK *pECB, char *pszFormat, ...)
{
	char szBuffer[1024];
	va_list arg_ptr;
	va_start(arg_ptr, pszFormat); 
	vsprintf(szBuffer, pszFormat, arg_ptr);
	va_end(arg_ptr);
	DWORD dwSize = strlen(szBuffer);
	pECB-&gt;WriteClient(pECB-&gt;ConnID, szBuffer, &amp;dwSize, 0);
}


//Function called for processing the client Request
DWORD WINAPI HttpExtensionProc(EXTENSION_CONTROL_BLOCK *pECB)
{
	StartContext(pECB);
WriteContext(pECB, &quot;&lt;p&gt;&lt;b&gt;&lt;font face='Verdana' color='#008000'&gt;This 
Message is recieved form ISAPI application!&lt;/font&gt;&lt;/b&gt;&lt;/p&gt;&quot;);
WriteContext(pECB, pECB-&gt;lpszQueryString);
	WriteContext(pECB, &quot;&lt;HR&gt;&quot;);
	LPSTR  tt= &quot;test.aspx&quot; ;
	BSTR  pp= (wchar_t *)malloc( sizeof( wchar_t ));
	int ss= mbstowcs( pp, tt, strlen(tt)+1);
	BSTR pg = ::SysAllocString(pp);
	BSTR out =::SysAllocString( L&quot;Invalid output&quot; );
	WriteContext(pECB, &quot;&lt;HR&gt;&quot;);
//	int rc = ExecPage (L&quot;test.aspx&quot;,L&quot;/myapp&quot;,L&quot;E:\\raj\\mypages&quot;, 
&amp;out);
unsigned    int sz = ::SysStringLen (out) ;
char *result = new char [2*sz+1]  ; 
wcstombs(result,out, sz+1);  
WriteContext(pECB,result);
WriteContext(pECB, &quot;&lt;HR&gt;&quot;);
	EndContext(pECB);
	return HSE_STATUS_SUCCESS;
}

//

BOOL WINAPI TerminateExtension(DWORD dwFlags)
{

	//dwFlags=HSE_TERM_MUST_UNLOAD ;

	return TRUE;

}


///////////////////////////////




int ExecPage(BSTR pg ,BSTR ap ,BSTR dr ,BSTR *out) 
{
	using namespace ASPNETComp;

	HRESULT hr;
	int Rc =-1;

	IMyCompHost *hstPtr;

	CoInitialize(NULL);

	hr = CoCreateInstance ( __uuidof(MyComHost), // CLSID of coclass
NULL,                    // not used - 
aggregation
CLSCTX_INPROC_SERVER,    // type of server
__uuidof (IMyCompHost),         // IID of 
interface
(void**) &amp;hstPtr);        // Pointer to our 
interface pointer

if ( SUCCEEDED ( hr ) )
{
// Call methods using pISL here.
		//printf(&quot; \nSuccess in Creating the COM Class&quot;);
		// Long see variant table for codes
		BSTR page= ::SysAllocString (pg);
BSTR app  =::SysAllocString(ap);
		BSTR dir = ::SysAllocString(dr);
	   	//BSTR output = :: SysAllocString( out );
	    hr=hstPtr-&gt;ExecutePage(page,app,dir,out);
	    if ( SUCCEEDED ( hr ) )
		 {
	
			//printf(&quot;Success in calling the method&quot;);
			 unsigned    int sz = ::SysStringLen (*out) ;
			 char *result = new char [sz]  ; 
			 wcstombs(result,*out, sz);  
			// printf(&quot;\nResult :\n\n%s&quot;,result);
			Rc=0;
			
		}
		else
		{
			 //printf(&quot;Failed in calling the method&quot;);
						 Rc=-1;
		}
			
		hstPtr-&gt;Release();
	}
	else
	{
// Couldn't create the COM object.  hr holds the error code.
		//printf(&quot; \nError in Creating The COM Object:&quot;);

		Rc=-1;
		
	}
	
	//Unload comobject
	CoUninitialize();
	return Rc;
}


/*
int ExecPage(BSTR pg ,BSTR ap ,BSTR dr ,BSTR *out) 
{
	using namespace ASPNET;

	HRESULT hr;
	int Rc =-1;

	IMyHost *hstPtr;

	CoInitialize(NULL);

	hr = CoCreateInstance ( __uuidof(MyHost), // CLSID of coclass
NULL,                    // not used - 
aggregation
CLSCTX_INPROC_SERVER,    // type of server
__uuidof (IMyHost),         // IID of 
interface
(void**) &amp;hstPtr);        // Pointer to our 
interface pointer

if ( SUCCEEDED ( hr ) )
{
// Call methods using pISL here.
		//printf(&quot; \nSuccess in Creating the COM Class&quot;);
		// Long see variant table for codes
		BSTR page= ::SysAllocString (pg);
BSTR app  =::SysAllocString(ap);
		BSTR dir = ::SysAllocString(dr);
	   	//BSTR output = :: SysAllocString( out );
	    hr=hstPtr-&gt;ExecutePage(page,app,dir,out);
	    if ( SUCCEEDED ( hr ) )
		 {
	
			//printf(&quot;Success in calling the method&quot;);
			 unsigned    int sz = ::SysStringLen (*out) ;
			 char *result = new char [sz]  ; 
			 wcstombs(result,*out, sz);  
			// printf(&quot;\nResult :\n\n%s&quot;,result);
			Rc=0;
			
		}
		else
		{
			 //printf(&quot;Failed in calling the method&quot;);
						 Rc=-1;
		}
			
		hstPtr-&gt;Release();
	}
	else
	{
// Couldn't create the COM object.  hr holds the error code.
		//printf(&quot; \nError in Creating The COM Object:&quot;);

		Rc=-1;
		
	}
	
	//Unload comobject
	CoUninitialize();
	return Rc;
}*/



//////////comp header 

// Created by Microsoft (R) C/C++ Compiler Version 12.00.8168.0 
(fbe69483).
//
// \\inatpdqml21s\genhfrom tlb\compnet\debug\aspnet.tlh
//
// C++ source equivalent of Win32 type library aspnet.tlb
// compiler-generated file created 03/25/02 at 10:38:40 - DO NOT EDIT!

#pragma once
#pragma pack(push, 8)

#include &lt;comdef.h&gt;

namespace ASPNET {

//
// Forward references and typedefs
//

struct /* coclass */ MyExeHost;
struct __declspec(uuid(&quot;e24d8042-d758-3c0c-9a8c-bbcd6f2b6ba1&quot;))
/* dual interface */ IMyHost;
struct /* coclass */ MyHost;
struct __declspec(uuid(&quot;d7f66457-3a60-3ccb-9f50-12267f756f07&quot;))
/* dual interface */ _MyExeHost;

//
// Smart pointer typedef declarations
//

_COM_SMARTPTR_TYPEDEF(IMyHost, __uuidof(IMyHost));
_COM_SMARTPTR_TYPEDEF(_MyExeHost, __uuidof(_MyExeHost));

//
// Type library items
//

struct __declspec(uuid(&quot;c42ca746-c369-378c-98d6-d800eeb88d10&quot;))
MyExeHost;
// [ default ] interface _MyExeHost
// interface _Object

struct __declspec(uuid(&quot;e24d8042-d758-3c0c-9a8c-bbcd6f2b6ba1&quot;))
IMyHost : IDispatch
{
//
// Wrapper methods for error-handling
//

HRESULT ExecutePage (
_bstr_t page,
_bstr_t AppName,
_bstr_t AppDir,
BSTR * Output );

//
// Raw methods provided by interface
//

virtual HRESULT __stdcall raw_ExecutePage (
BSTR page,
BSTR AppName,
BSTR AppDir,
BSTR * Output ) = 0;
};

struct __declspec(uuid(&quot;5543e24c-9d66-39b0-8507-73a5357e77ba&quot;))
MyHost;
// interface _Object
// [ default ] interface IMyHost

struct __declspec(uuid(&quot;d7f66457-3a60-3ccb-9f50-12267f756f07&quot;))
_MyExeHost : IDispatch
{};

//
// Wrapper method implementations
//

//#include &quot;\\inatpdqml21s\genhfrom tlb\compnet\debug\aspnet.tli&quot;


inline HRESULT IMyHost::ExecutePage ( _bstr_t page, _bstr_t AppName, 
_bstr_t AppDir, BSTR * Output ) {
HRESULT _hr = raw_ExecutePage(page, AppName, AppDir, Output);
if (FAILED(_hr)) _com_issue_errorex(_hr, this, __uuidof(this));
return _hr;
}


} // namespace ASPNET

#pragma pack(pop)
//////////////////





///////

Any help in this regard  ll be great



Raj
_____________________________________________________________




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="004295.html">[Mono-list] NET using Java VMs and libs
</A></li>
	<LI> Next message: <A HREF="004303.html">[Mono-list] Executing ASP.net page out side IIS  (in apache)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4301">[ date ]</a>
              <a href="thread.html#4301">[ thread ]</a>
              <a href="subject.html#4301">[ subject ]</a>
              <a href="author.html#4301">[ author ]</a>
         </LI>
       </UL>
</body></html>
