<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] UnmanagedFunctionPointer as out parameter from native function causes failed assertion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20UnmanagedFunctionPointer%20as%20out%20parameter%20from%20native%0A%20function%20causes%20failed%20assertion&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037408.html">
   <LINK REL="Next"  HREF="037410.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] UnmanagedFunctionPointer as out parameter from native function causes failed assertion</H1>
    <B>Lars Hagstr&#246;m</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20UnmanagedFunctionPointer%20as%20out%20parameter%20from%20native%0A%20function%20causes%20failed%20assertion&In-Reply-To="
       TITLE="[Mono-list] UnmanagedFunctionPointer as out parameter from native function causes failed assertion">lars at update.uu.se
       </A><BR>
    <I>Wed Jan  2 12:20:28 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="037408.html">[Mono-list] List administrator?
</A></li>
        <LI>Next message: <A HREF="037410.html">[Mono-list] Looking for an mplayer (or similar) wrapper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37409">[ date ]</a>
              <a href="thread.html#37409">[ thread ]</a>
              <a href="subject.html#37409">[ subject ]</a>
              <a href="author.html#37409">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm trying to pass a function pointer as an out parameter from a native
shared library. In the attached program there is a small shared library
that has one GetCallback function that returns a callback function, and
one that passes it as an out parameter.

The version that just returns it works fine, but the one that passes by
out parameter fails with this error:

$ mono CallbackTest.exe
** ERROR **: file marshal.c: line 6686 (emit_marshal_object): assertion
failed: (!t-&gt;byref)
aborting...
Stacktrace:


Native stacktrace:

        mono [0x81705fb]
        [0xffffe440]
        /lib/libc.so.6(abort+0x108) [0xb7d528e8]
        /usr/lib/libglib-2.0.so.0(g_logv+0x435) [0xb7ed1f35]
        /usr/lib/libglib-2.0.so.0(g_log+0x29) [0xb7ed1f69]
        /usr/lib/libglib-2.0.so.0(g_assert_warning+0x78) [0xb7ed1fe8]
        mono [0x80b5330]
        mono [0x80b5cb8]
        mono [0x80ba749]
        mono [0x80bb758]
        mono [0x814fed9]
        mono [0x815c253]
        mono [0x815dabb]
        mono [0x815dff1]
        mono(mono_runtime_exec_main+0xb8) [0x80e82b8]
        mono(mono_runtime_run_main+0x1b4) [0x80e9704]
        mono(mono_main+0xf9f) [0x805b5ff]
        mono [0x805a172]
        /lib/libc.so.6(__libc_start_main+0xdc) [0xb7d3dfdc]
        mono [0x805a0c1]

Debug info from gdb:

(no debugging symbols found)
Using host libthread_db library &quot;/lib/libthread_db.so.1&quot;.
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
(no debugging symbols found)
0xffffe410 in __kernel_vsyscall ()


=================================================================
Got a SIGABRT while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries
used by your application.
=================================================================

Aborted


I'm running mono 1.2.6 and gcc 4.1.2 on gentoo-linux.
Note that the line that calls the &quot;offending&quot; version of GetCallback is
commented in the attached code, to show that the other version works well.

Have I done something wrong, or is it a bug in mono? Is there a
workaround (I'd prefer to keep the workaround in the c# code, rather
than changing the native dll).

Happy New Year,
Lars




-------------- next part --------------
A non-text attachment was scrubbed...
Name: mono_callback_test.tar.gz
Type: application/gzip
Size: 886 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20080102/1f4438c8/attachment.bin">http://lists.ximian.com/pipermail/mono-list/attachments/20080102/1f4438c8/attachment.bin</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037408.html">[Mono-list] List administrator?
</A></li>
	<LI>Next message: <A HREF="037410.html">[Mono-list] Looking for an mplayer (or similar) wrapper
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37409">[ date ]</a>
              <a href="thread.html#37409">[ thread ]</a>
              <a href="subject.html#37409">[ subject ]</a>
              <a href="author.html#37409">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
