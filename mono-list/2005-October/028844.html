<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] to wrapp mono with C
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20to%20wrapp%20mono%20with%20C&In-Reply-To=web-2903811%40mailbe05.swip.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028858.html">
   <LINK REL="Next"  HREF="028843.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] to wrapp mono with C</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20to%20wrapp%20mono%20with%20C&In-Reply-To=web-2903811%40mailbe05.swip.net"
       TITLE="[Mono-list] to wrapp mono with C">jonpryor at vt.edu
       </A><BR>
    <I>Sun Oct  2 11:36:57 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="028858.html">[Mono-list] Re: Issue with building mono from sources on Suse 10 -
	part 2
</A></li>
        <LI>Next message: <A HREF="028843.html">[Mono-list] MonoDevelop trouble with task list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28844">[ date ]</a>
              <a href="thread.html#28844">[ thread ]</a>
              <a href="subject.html#28844">[ subject ]</a>
              <a href="author.html#28844">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2005-09-29 at 14:39 +0200, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">pa-alran at tele2.fr</A> wrote:
&gt;<i> I want to use the hash function of openssl with my code in 
</I>&gt;<i> mono.
</I>&gt;<i> 
</I>&gt;<i> The file .h in C is :
</I>&gt;<i> 
</I>&gt;<i> #define SHA_BLOCK	16
</I>&gt;<i> 
</I>&gt;<i> typedef struct SHAstate_st
</I>&gt;<i> {
</I>&gt;<i> 	unsigned long h0,h1,h2,h3,h4;
</I>&gt;<i> 	unsigned long Nl,Nh;
</I>&gt;<i> 	unsigned long data[SHA_LBLOCK];
</I>&gt;<i> 	int num;
</I>&gt;<i> } SHA_CTX;
</I>&gt;<i>
</I>&gt;<i> void SHA1_Init(SHA_CTX *c);
</I>&gt;<i> 
</I>&gt;<i> void SHA1_Update(SHA_CTX *c, unsigned char *data, unsigned 
</I>&gt;<i> long len);
</I>&gt;<i> 
</I>&gt;<i> void SHA1_Final(unsigned char *md, SHA_CTX *c);
</I>
And this is where your first problem shows up.  The size of &quot;unsigned
long&quot; is platform-dependent.  In particular, it will be 32 bits for
32-bit ILP32 platforms, 64-bits for LP64 platforms (anything Unix-like),
and 32-bits for P64 platforms (Win64).

If you plan on sticking to ILP32 platforms or P64 platforms, then using
uint for ``unsigned long'' is correct.  If you ever need to use an LP64
platform, such as SuSE or Fedora Core for AMD64, then this will be
incorrect.  From this you might think that using UIntPtr would work,
since it varies with the size of the pointer, but this would break on
Win64, for which `long' doesn't match the pointer size.

The safest thing you can do is to follow the model of Mono.Posix.dll and
libMonoPosixHelper.so: define an ABI-specific set of functions and
structures to expose from your managed code, and &quot;thunk&quot; to the
platform-specific representation.

&gt;<i> ---------------------------
</I>&gt;<i> 
</I>&gt;<i> I have write my wrapper like this :
</I>&gt;<i> 
</I>&gt;<i> protected int SHA_BLOCK = 16;
</I>&gt;<i> 
</I>&gt;<i> [StructLayout(LayoutKind.Sequential, 
</I>&gt;<i> CharSet=CharSet.Ansi)]
</I>&gt;<i> public struct SHA_CTX
</I>&gt;<i> {
</I>&gt;<i>      public uint h0;
</I>&gt;<i>      public uint h1;
</I>&gt;<i>      public uint h2;
</I>&gt;<i>      public uint h3;
</I>&gt;<i>      public uint h4;
</I>&gt;<i>      public uint Nl;
</I>&gt;<i>      public uint Nh;
</I>&gt;<i>      [MarshalAs(UnmanagedType.ByValArray, SizeConst = 16)]
</I>&gt;<i>      public uint [] data ;
</I>&gt;<i>      public int num;
</I>&gt;<i> } 
</I>&gt;<i> 		
</I>&gt;<i> //chargement de la dll SHA1.so &quot;C&quot;
</I>&gt;<i> [DllImport(&quot;SHA1&quot;)]
</I>&gt;<i> public static extern void SHA1_Init(ref SHA_CTX c);
</I>&gt;<i> //public static extern void SHA1_Init(IntPtr c);
</I>&gt;<i> 
</I>&gt;<i> //chargement de la dll SHA1.dll &quot;C&quot;
</I>&gt;<i> [DllImport(&quot;SHA1&quot;)]
</I>&gt;<i> public static extern void SHA1_Update(ref SHA_CTX c, ref 
</I>&gt;<i> byte [] data, uint len);
</I>
This is incorrect.  `unsigned char*' should be a byte[], not a `ref
byte[]'.  When going from managed to unmanaged code, a [] becomes a *,
and `ref' and `out' become *, and class types add another *.  So:

	Managed                 Unmanaged
	-------                 ---------
	// value type
	byte                    unsigned char
        ref byte                unsigned char*
	byte[]			unsigned char*
	ref byte[]              unsigned char**

	// class type
	string                  const char*
	ref string              const char**
	string[]                const char**
	ref string[]            const char***

I'm not sure `ref string' and `ref string[]' are actually supported by
the marshaler, but if they were the above is what the unmanaged side
would receive.

There is also the (already mentioned) issue that `unsigned long' might
not be a `uint'.

&gt;<i> //public static extern void SHA1_Update(ref SHA_CTX c, 
</I>&gt;<i> IntPtr data, uint len);
</I>&gt;<i> //public static extern void SHA1_Update(ref SHA_CTX c, 
</I>&gt;<i> byte * data, uint len);
</I>
The above two declarations would also be correct (except for the
`unsigned long' -&gt; uint mapping).
		
&gt;<i> //chargement de la dll SHA1.dll &quot;C&quot;
</I>&gt;<i> [DllImport(&quot;SHA1&quot;)]
</I>&gt;<i> public static extern void  SHA1_Final(ref byte [] md, ref 
</I>&gt;<i> SHA_CTX c);
</I>
Again, `md' should be a `byte[]', not a `ref byte[]'.

&gt;<i> //public static extern void  SHA1_Final(IntPtr md, ref 
</I>&gt;<i> SHA_CTX c);
</I>&gt;<i> //public static extern void  SHA1_Final(byte* md, ref 
</I>&gt;<i> SHA_CTX c);
</I>&gt;<i> 		
</I>&gt;<i> -----------------------
</I>&gt;<i> 
</I>&gt;<i> With the structure, i can acces to the array data ?
</I>&gt;<i> 
</I>&gt;<i> And i don't know how to wrapp &quot; unsigned char * &quot; ? my 
</I>&gt;<i> solutions don't work.
</I>
Your solutions didn't work because you had too many pointer
indirections.  One of your commented declarations would have worked, but
would also have required more work in the caller's code to invoke.

As for exposing an ABI-neutral API, you'd have to effectively duplicate
OpenSSL's API, e.g.

	/* unmanaged code: */
	#include &lt;glib.h&gt;
	#define SHA_BLOCK 16
	typedef struct your_sha_state_st {
		guint64 h0,h1,h2,h3,h4;
		guint64 Nl,Nh;
		guint64 data[SHA_BLOCK];
		int num;
	} your_sha_ctx;

	static void
	to_openssl (SHA_CTX *c, your_sha_ctx *y)
	{
		int i;

		/* todo: unsigned long overflow checking */
		c-&gt;h0 = y-&gt;h0;
		c-&gt;h1 = y-&gt;h1;
		c-&gt;h2 = y-&gt;h2;
		c-&gt;h3 = y-&gt;h3;
		c-&gt;h4 = y-&gt;h4;
		c-&gt;Nl = y-&gt;Nl;
		c-&gt;Nh = y-&gt;Nh;
		c-&gt;num = y-&gt;num;
		for (i = 0; i &lt; SHA_BLOCK; ++i)
			c-&gt;data[i] = y-&gt;data [i];
	}

	static void
	from_openssl (your_sha_ctx *y, SHA_CTX *c)
	{
		int i;

		/* todo: unsigned long overflow checking */
		y-&gt;h0 = c-&gt;h0;
		y-&gt;h1 = c-&gt;h1;
		y-&gt;h2 = c-&gt;h2;
		y-&gt;h3 = c-&gt;h3;
		y-&gt;h4 = c-&gt;h4;
		y-&gt;Nl = c-&gt;Nl;
		y-&gt;Nh = c-&gt;Nh;
		y-&gt;num = c-&gt;num;
		for (i = 0; i &lt; SHA_BLOCK; ++i)
			y-&gt;data[i] = c-&gt;data [i];
	}

	void your_sha1_init (your_sha_ctx *c)
	{
		SHA_CTX o;
		SHA1_Init (&amp;o);
		from_openssl (c, &amp;o);
	}

	void your_sha1_update (your_sha_ctx *c, unsigned char* data,
		guint64 len)
	{
		SHA_CTX o;
		to_openssl (&amp;o, c);
		SHA1_Update (&amp;o, data, (unsigned long) len);
		from_openssl (c, &amp;o);
	}

	void your_sha1_final (unsigned char *md, your_sha1_ctx *c)
	{
		SHA_CTX o;
		to_openssl (&amp;o, c);
		SHA1_Final (md, &amp;o);
		from_openssl (c, &amp;o);
	}

	// managed code would use ulong's instead of uints everywhere.

Suffice it to say, it's potentially a lot of work, much of it tedious
and potentially error prone.  It's probably far easier to just use a
managed equivalent, such as the System.Security.Cryptography.SHA1 class.

 - Jon


</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028858.html">[Mono-list] Re: Issue with building mono from sources on Suse 10 -
	part 2
</A></li>
	<LI>Next message: <A HREF="028843.html">[Mono-list] MonoDevelop trouble with task list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28844">[ date ]</a>
              <a href="thread.html#28844">[ thread ]</a>
              <a href="subject.html#28844">[ subject ]</a>
              <a href="author.html#28844">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
