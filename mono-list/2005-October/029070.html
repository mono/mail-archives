<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Why UTF-16 strings in Mono.Unix?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Why%20UTF-16%20strings%20in%20Mono.Unix%3F&In-Reply-To=43543C1A.4070405%40pobox.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029067.html">
   <LINK REL="Next"  HREF="029074.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Why UTF-16 strings in Mono.Unix?</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Why%20UTF-16%20strings%20in%20Mono.Unix%3F&In-Reply-To=43543C1A.4070405%40pobox.com"
       TITLE="[Mono-list] Why UTF-16 strings in Mono.Unix?">jonpryor at vt.edu
       </A><BR>
    <I>Mon Oct 17 20:31:06 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="029067.html">[Mono-list] Why UTF-16 strings in Mono.Unix?
</A></li>
        <LI>Next message: <A HREF="029074.html">[Mono-list] Why UTF-16 strings in Mono.Unix?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29070">[ date ]</a>
              <a href="thread.html#29070">[ thread ]</a>
              <a href="subject.html#29070">[ subject ]</a>
              <a href="author.html#29070">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2005-10-17 at 17:04 -0700, Brion Vibber wrote:
&gt;<i> Jonathan Pryor wrote:
</I>&gt;<i> &gt; On Mon, 2005-10-17 at 19:03 +0200, Florian Weimer wrote:
</I>&gt;<i> &gt;&gt;Why are UTF-16 strings used in Mono.Unix?  Doesn't this mean that some
</I>&gt;<i> &gt;&gt;resources are inaccessible to programs running under Mono in a
</I>&gt;<i> &gt;&gt;multibyte localeq (such as one using UTF-8)?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Care to elaborate?  System.String is always used to represent strings in
</I>&gt;<i> &gt; Mono.Unix and Mono.Unix.Native, but Mono's marshaler will convert the
</I>&gt;<i> &gt; strings to UTF-8 for the P/Invoke call.
</I>&gt;<i> 
</I>&gt;<i> A peek at Mono.Unix/UnixMarshal.cs hints that managed strings are
</I>&gt;<i> marshalled to/from the locale encoding (assuming Encoding.Default is the
</I>&gt;<i> locale encoding); so locales other than UTF-8 ought to also work.
</I>
Having written that code, I can assure you it's meaningless. :-)

In particular, there are functions in UnixMarshal to convert managed
strings to null-terminated byte strings in a given encoding
(StringToAlloc, and vice versa, PtrToString), but nothing else in
Mono.Posix.dll makes use of those facilities.  Furthermore, those
methods were added only recently, and thus aren't part of any shipping
Mono distribution.

In short, if you call Syscall.open() or Stdlib.fopen(), you'll be
calling (nearly) directly into the unmanaged function, meaning you'll be
using Mono's default string marshaler, which at this point in time only
converts strings to UTF-8.

Strings coming back into managed code (such as Syscall.getgrent()) will
be converted using UnixMarshal.PtrToString(), which previously was a
thin wrapper over Marshal.PtrToStringAnsi() (thus on mono it decoded
UTF-8 strings).  The recent changes to UnixMarshal change this to decode
using Encoding.Default (the default encoding), which may be an
improvement...or not.  I'd love some feedback on that decision.

Finally, a question: would it be useful to duplicate all Syscall and
Stdlib string-using APIs to have an overload taking an Encoding, to
allow explicit specification of which encoding to marshal strings as?
This would nearly double the API size, so I'm not sure it's worthwhile,
but I'd love some advice.

 - Jon


</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029067.html">[Mono-list] Why UTF-16 strings in Mono.Unix?
</A></li>
	<LI>Next message: <A HREF="029074.html">[Mono-list] Why UTF-16 strings in Mono.Unix?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29070">[ date ]</a>
              <a href="thread.html#29070">[ thread ]</a>
              <a href="subject.html#29070">[ subject ]</a>
              <a href="author.html#29070">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
