<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Possible bug in ConvertTimeToUtc(DateTime,	TimeZoneInfo)?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Possible%20bug%20in%20ConvertTimeToUtc%28DateTime%2C%0A%09TimeZoneInfo%29%3F&In-Reply-To=48C604D7.9050804%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039524.html">
   <LINK REL="Next"  HREF="039526.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Possible bug in ConvertTimeToUtc(DateTime,	TimeZoneInfo)?</H1>
    <B>Kevin Reay</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Possible%20bug%20in%20ConvertTimeToUtc%28DateTime%2C%0A%09TimeZoneInfo%29%3F&In-Reply-To=48C604D7.9050804%40ximian.com"
       TITLE="[Mono-list] Possible bug in ConvertTimeToUtc(DateTime,	TimeZoneInfo)?">kevintreay at gmail.com
       </A><BR>
    <I>Tue Sep  9 01:15:13 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="039524.html">[Mono-list] Possible bug in ConvertTimeToUtc(DateTime,	TimeZoneInfo)?
</A></li>
        <LI>Next message: <A HREF="039526.html">[Mono-list] xsp2 crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39525">[ date ]</a>
              <a href="thread.html#39525">[ thread ]</a>
              <a href="subject.html#39525">[ subject ]</a>
              <a href="author.html#39525">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'll throw together a NUnit test tomorrow. Also, I have a tweaked
version of my original patch (a little cleaner, fixes some function
flow that doesn't effect the final outcome) that I'll send as well.

Thanks!

Kevin Reay

On Mon, Sep 8, 2008 at 11:08 PM, Atsushi Eno &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">atsushi at ximian.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> (I was reviewing old emails and found it left as is.)
</I>&gt;<i>
</I>&gt;<i> Thanks for the patch. Can you please add a NUnit test case as well?
</I>&gt;<i> Then I'll check in the patch.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> KevinReay wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ok, I tested the proposed changes locally (with changes/corrections) and
</I>&gt;&gt;<i> they
</I>&gt;&gt;<i> seem to work, at least for me.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've attached a (unified) diff for the changes I made, if anyone is
</I>&gt;&gt;<i> interested (also attached inline). Diff seems to solve problem described
</I>&gt;&gt;<i> above, and includes minor spelling/grammar tweak.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks, Kevin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --- TimeZoneInfo.cs.old 2008-07-25 10:48:16.000000000 -0500
</I>&gt;&gt;<i> +++ TimeZoneInfo.cs     2008-07-25 10:53:07.000000000 -0500
</I>&gt;&gt;<i> @@ -222,10 +222,7 @@
</I>&gt;&gt;<i>                                throw new ArgumentNullException
</I>&gt;&gt;<i> (&quot;sourceTimeZone&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                        if (dateTime.Kind == DateTimeKind.Utc &amp;&amp;
</I>&gt;&gt;<i> sourceTimeZone != TimeZoneInfo.Utc)
</I>&gt;&gt;<i> -                               throw new ArgumentException (&quot;Kind propery
</I>&gt;&gt;<i> of dateTime is Utc but the sourceTimeZone does not equal
</I>&gt;&gt;<i> TimeZoneInfo.Utc&quot;);
</I>&gt;&gt;<i> -
</I>&gt;&gt;<i> -                       if (dateTime.Kind == DateTimeKind.Local &amp;&amp;
</I>&gt;&gt;<i> sourceTimeZone != TimeZoneInfo.Local)
</I>&gt;&gt;<i> -                               throw new ArgumentException (&quot;Kind propery
</I>&gt;&gt;<i> of dateTime is Local but the sourceTimeZone does not equal
</I>&gt;&gt;<i> TimeZoneInfo.Local&quot;);
</I>&gt;&gt;<i> +                               throw new ArgumentException (&quot;dateTime
</I>&gt;&gt;<i> Kind
</I>&gt;&gt;<i> value is Utc but sourceTimeZone is not Utc&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                        if (sourceTimeZone.IsInvalidTime (dateTime))
</I>&gt;&gt;<i>                                throw new ArgumentException (&quot;dateTime
</I>&gt;&gt;<i> parameter is an invalid time&quot;);
</I>&gt;&gt;<i> @@ -236,7 +233,7 @@
</I>&gt;&gt;<i>                        if (dateTime.Kind == DateTimeKind.Utc)
</I>&gt;&gt;<i>                                return dateTime;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -                       if (dateTime.Kind == DateTimeKind.Local)
</I>&gt;&gt;<i> +                       if (dateTime.Kind == DateTimeKind.Local &amp;&amp;
</I>&gt;&gt;<i> sourceTimeZone == TimeZoneInfo.Utc)
</I>&gt;&gt;<i>                                return ConvertTimeToUtc (dateTime);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                        if (sourceTimeZone.IsAmbiguousTime (dateTime) ||
</I>&gt;&gt;<i> !sourceTimeZone.IsDaylightSavingTime (dateTime))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://www.nabble.com/file/p18658416/TimeZoneInfo.cs.diff">http://www.nabble.com/file/p18658416/TimeZoneInfo.cs.diff</A>
</I>&gt;&gt;<i> TimeZoneInfo.cs.diff
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> KevinReay wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi everyone,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think I may have spotted a bug in the
</I>&gt;&gt;&gt;<i> System.TimeZoneInfo.ConvertTimeToUtc(DateTime, TimeZoneInfo) method. I
</I>&gt;&gt;&gt;<i> could, of course, be wrong (clue-stick appreciated!).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The following check appears to be wrong:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> if (dateTime.Kind == DateTimeKind.Local &amp;&amp; sourceTimeZone !=
</I>&gt;&gt;&gt;<i> TimeZoneInfo.Local)
</I>&gt;&gt;&gt;<i>        throw new ArgumentException (&quot;Kind propery of dateTime is Local
</I>&gt;&gt;&gt;<i> but the
</I>&gt;&gt;&gt;<i> sourceTimeZone does not equal TimeZoneInfo.Local&quot;);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Shouldn't this code only check that if sourceTimeZone ==
</I>&gt;&gt;&gt;<i> TimeZoneInfo.Utc,
</I>&gt;&gt;&gt;<i> as the sourceTimeZone could be represent a local timezone while still not
</I>&gt;&gt;&gt;<i> being equal to TimeZoneInfo.Local (The system's local timezone)?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As an example, the following code runs as expected under .Net/Windows:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  TimeZoneInfo _SpecifiedTimezone =
</I>&gt;&gt;&gt;<i> TimeZoneInfo.FindSystemTimeZoneById(SpecifiedTimeZone);
</I>&gt;&gt;&gt;<i>  _NewMeeting.DateBegin =
</I>&gt;&gt;&gt;<i> TimeZoneInfo.ConvertTimeToUtc(DateTime.Parse(SpecifiedDate),
</I>&gt;&gt;&gt;<i> _SpecifiedTimezone);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But fails with the following exception when run under mono:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;Kind propery of dateTime is Local but the sourceTimeZone does not equal
</I>&gt;&gt;&gt;<i> TimeZoneInfo.Local&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i> Kevin
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039524.html">[Mono-list] Possible bug in ConvertTimeToUtc(DateTime,	TimeZoneInfo)?
</A></li>
	<LI>Next message: <A HREF="039526.html">[Mono-list] xsp2 crashes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39525">[ date ]</a>
              <a href="thread.html#39525">[ thread ]</a>
              <a href="subject.html#39525">[ subject ]</a>
              <a href="author.html#39525">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
