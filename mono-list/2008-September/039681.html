<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] OutOfMemoryException after scale transform a	Region
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20OutOfMemoryException%20after%20scale%20transform%20a%09Region&In-Reply-To=19610028.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039677.html">
   <LINK REL="Next"  HREF="039692.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] OutOfMemoryException after scale transform a	Region</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20OutOfMemoryException%20after%20scale%20transform%20a%09Region&In-Reply-To=19610028.post%40talk.nabble.com"
       TITLE="[Mono-list] OutOfMemoryException after scale transform a	Region">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Mon Sep 22 13:42:50 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="039677.html">[Mono-list]  OutOfMemoryException after scale transform a Region
</A></li>
        <LI>Next message: <A HREF="039692.html">[Mono-list] OutOfMemoryException after scale transform a	Region
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39681">[ date ]</a>
              <a href="thread.html#39681">[ thread ]</a>
              <a href="subject.html#39681">[ subject ]</a>
              <a href="author.html#39681">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Pablo,

On Mon, 2008-09-22 at 08:46 -0700, Pablo Lecea wrote:
&gt;<i> Hello there,
</I>&gt;<i> I have an application which takes two Regions and gets the intersection
</I>&gt;<i> between both in order to get the closest point... Before the intersect
</I>&gt;<i> operation is figured out I'm scaling the regions to avoid roundings. But
</I>&gt;<i> after the regions are scaled (100) any operation against the regions can be
</I>&gt;<i> done without get a OutOfMemoryException.
</I>
The region stuff can be *very* complex and libgdiplus took a few
shortcuts to get things working.

A long time ago (well about 2.5 year ago) only region with rectangle
shapes were supported inside libgdiplus. This was a big limitation but
was much simpler to implement (first shortcut).

To get around this libgdiplus implements binary operations on
non-rectangular regions using a (1bbp) bitmap. This (second shortcut)
works very well unless you (a) need more than pixel accuracy or (b) have
very large regions.

Your example that have a region of 2936 x 3647 pixels (see WARNING)
which exceed the amount of memory that libgdiplus is willing to allocate
to compute the region - problem (b). This would (probably) work without
scaling but then you loose your &quot;hacked&quot; accuracy - problem (a).

&gt;<i>  This is happening just on Mac OS, I
</I>&gt;<i> tested on Windows XP via mono and it works fine.
</I>
This is because Mono use MS GDI+ on Windows. Your code would not be
working on Linux, Solaris or anywhere else (but Windows).

&gt;<i> The exception message is : 
</I>&gt;<i> ** (/Users/pablolecea/closest/closest/bin/Debug/closest.exe:604): WARNING
</I>&gt;<i> **: Path conversion requested 42830368 bytes (2936 x 3647). Maximum size is
</I>&gt;<i> 8388608 bytes.
</I>&gt;<i> 
</I>&gt;<i> Unhandled Exception: System.OutOfMemoryException: Not enough memory to
</I>&gt;<i> complete operation [GDI+ status: OutOfMemory]
</I>&gt;<i>   at System.Drawing.GDIPlus.CheckStatus (Status status) [0x000be] in
</I>&gt;<i> /private/tmp/monobuild/build/BUILD/mono-1.9.1/mcs/class/System.Drawing/System.Drawing/gdipFunctions.cs:222 
</I>&gt;<i>   at System.Drawing.Region.Intersect (System.Drawing.Region region)
</I>&gt;<i> [0x00024] in
</I>&gt;<i> /private/tmp/monobuild/build/BUILD/mono-1.9.1/mcs/class/System.Drawing/System.Drawing/Region.cs:148 
</I>&gt;<i>   at (wrapper remoting-invoke-with-check) System.Drawing.Region:Intersect
</I>&gt;<i> (System.Drawing.Region)
</I>&gt;<i>   at closest.MainClass.GetClosestPoint () [0x00030] in
</I>&gt;<i> /Users/pablolecea/closest/closest/Main.cs:171 
</I>&gt;<i>   at closest.MainClass.Main (System.String[] args) [0x00000] in
</I>&gt;<i> /Users/pablolecea/closest/closest/Main.cs:154 
</I>&gt;<i> 
</I>&gt;<i> Here the code:
</I>&gt;<i> 
</I>&gt;<i> static void Main(string[] args)
</I>&gt;<i>         {
</I>&gt;<i>             GetClosestPoint();
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> private static void GetClosestPoint()
</I>&gt;<i>         {
</I>&gt;<i>             //get the regions
</I>&gt;<i>             Region firstRegion = CreateFirstRegion();
</I>&gt;<i>             Region secondRegion = CreateSecondRegion();
</I>&gt;<i> 
</I>&gt;<i>             //This scaling is done to avoid rounding in bounds values
</I>&gt;<i>             Matrix matrix = new Matrix();
</I>&gt;<i>             matrix.Scale(100, 100);
</I>&gt;<i>             firstRegion.Transform(matrix);
</I>&gt;<i>             secondRegion.Transform(matrix);
</I>&gt;<i> 
</I>&gt;<i>             //intersect the regions
</I>&gt;<i>             firstRegion.Intersect(secondRegion); //an OutOfMemoryException
</I>&gt;<i> is thrown on mac OS
</I>&gt;<i> 
</I>&gt;<i>             System.Windows.Forms.Control control = new
</I>&gt;<i> System.Windows.Forms.Control();
</I>&gt;<i>             System.Drawing.Graphics graph = control.CreateGraphics();
</I>&gt;<i>             graph.PageUnit = GraphicsUnit.Pixel;
</I>&gt;<i>             System.Drawing.RectangleF bounds = firstRegion.GetBounds(graph);
</I>&gt;<i> 
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i> private static Region CreateFirstRegion()
</I>&gt;<i>         {
</I>&gt;<i>             GraphicsPath gp = new GraphicsPath();
</I>&gt;<i> 
</I>&gt;<i>             gp.StartFigure();
</I>&gt;<i>             gp.AddLine(new PointF(193.24475f, 189.1613f), new
</I>&gt;<i> PointF(221.7687f, 225.011f));
</I>&gt;<i>             gp.AddLine(new PointF(221.7687f, 225.011f), new
</I>&gt;<i> PointF(222.5512f, 224.38869f));
</I>&gt;<i>             gp.AddLine(new PointF(222.5512f, 224.38869f), new
</I>&gt;<i> PointF(194.0272f, 188.53869f));
</I>&gt;<i>             gp.CloseFigure();
</I>&gt;<i> 
</I>&gt;<i>             Region result = new Region(gp);
</I>&gt;<i>             return result;
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         private static Region CreateSecondRegion()
</I>&gt;<i>         {
</I>&gt;<i>             GraphicsPath gp = new GraphicsPath();
</I>&gt;<i>             string text = &quot;Cl&quot;;
</I>&gt;<i>             int platformStyle = (int)System.Drawing.FontStyle.Regular;
</I>&gt;<i>             float fontSize = 12;
</I>&gt;<i>             string fontName = &quot;Times New Roman&quot;;
</I>&gt;<i> 
</I>&gt;<i>             System.Drawing.Font platformFont = new
</I>&gt;<i> System.Drawing.Font(fontName, fontSize, System.Drawing.FontStyle.Regular,
</I>&gt;<i> GraphicsUnit.Pixel);
</I>&gt;<i>             gp.AddString(text, platformFont.FontFamily, platformStyle,
</I>&gt;<i> platformFont.Size, new System.Drawing.Rectangle(),
</I>&gt;<i> StringFormat.GenericTypographic);
</I>&gt;<i> 
</I>&gt;<i>             Matrix translationMatrix = new Matrix();
</I>&gt;<i>             translationMatrix.Translate(187.222f, 182.8066f);
</I>&gt;<i>             gp.Transform(translationMatrix);
</I>&gt;<i> 
</I>&gt;<i>             Region result = new Region(gp);
</I>&gt;<i>             return result;
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i> Can you help me to figure out what is happening.
</I>&gt;<i> Thanks, 
</I>&gt;<i> Pablo
</I>&gt;<i> -- 
</I>&gt;<i> View this message in context: <A HREF="http://www.nabble.com/OutOfMemoryException-after-scale-transform-a-Region-tp19610028p19610028.html">http://www.nabble.com/OutOfMemoryException-after-scale-transform-a-Region-tp19610028p19610028.html</A>
</I>&gt;<i> Sent from the Mono - General mailing list archive at Nabble.com.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>
</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039677.html">[Mono-list]  OutOfMemoryException after scale transform a Region
</A></li>
	<LI>Next message: <A HREF="039692.html">[Mono-list] OutOfMemoryException after scale transform a	Region
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39681">[ date ]</a>
              <a href="thread.html#39681">[ thread ]</a>
              <a href="subject.html#39681">[ subject ]</a>
              <a href="author.html#39681">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
