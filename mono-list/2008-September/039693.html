<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] OutOfMemoryException after scale transform a	Region
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20OutOfMemoryException%20after%20scale%20transform%20a%09Region&In-Reply-To=19615239.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039692.html">
   <LINK REL="Next"  HREF="039678.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] OutOfMemoryException after scale transform a	Region</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20OutOfMemoryException%20after%20scale%20transform%20a%09Region&In-Reply-To=19615239.post%40talk.nabble.com"
       TITLE="[Mono-list] OutOfMemoryException after scale transform a	Region">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Mon Sep 22 16:12:42 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="039692.html">[Mono-list] OutOfMemoryException after scale transform a	Region
</A></li>
        <LI>Next message: <A HREF="039678.html">[Mono-list] Reliable OS identification on Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39693">[ date ]</a>
              <a href="thread.html#39693">[ thread ]</a>
              <a href="subject.html#39693">[ subject ]</a>
              <a href="author.html#39693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Pablo,

On Mon, 2008-09-22 at 12:50 -0700, Pablo Lecea wrote:
&gt;<i> Hello Sebastien,
</I>&gt;<i>  
</I>&gt;<i> First to all, thanks for your answer. 
</I>&gt;<i> Our application works with this kind of regions all the time, for that
</I>&gt;<i> reason we need to figth with both issues, more than pixel accuracy and very
</I>&gt;<i> large regions. Do you have any idea to proceed? I mean, do you know some
</I>&gt;<i> other way to work around this problem?
</I>
With both requirements I suggest you look at other alternatives (than
libgdiplus) and I guess the next question will be &quot;with what?&quot; so...

It's been quite a while (the same 2.5 years ;-) since I looked at what
was available, so the situation could have improved, but there was
nothing that I could reuse (license-compatible) inside libgdiplus.

That being said the one that impressed me the most, back then, was
GPC[1] (enough that I remember its name ;-). It's not free software but
can be used in non-commercial projects and has .NET bindings (but I
never looked at them).

Otherwise there is a lot of code (either to work on specific problems,
or &quot;attempts&quot; at larger goals) that did not do everything libgdiplus
needed, but could be enough for you. Google will be your
(over-enthusiastic) friend to look at them.

Sebastien

&#65279;p.s. If/when you find something interesting (applicable to libgdiplus
or not) please let us know!

&#65279;[1] <A HREF="http://www.cs.man.ac.uk/~toby/alan/software/">http://www.cs.man.ac.uk/~toby/alan/software/</A>

&gt;<i> Pablo
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Sebastien Pouliot-2 wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Hello Pablo,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Mon, 2008-09-22 at 08:46 -0700, Pablo Lecea wrote:
</I>&gt;<i> &gt;&gt; Hello there,
</I>&gt;<i> &gt;&gt; I have an application which takes two Regions and gets the intersection
</I>&gt;<i> &gt;&gt; between both in order to get the closest point... Before the intersect
</I>&gt;<i> &gt;&gt; operation is figured out I'm scaling the regions to avoid roundings. But
</I>&gt;<i> &gt;&gt; after the regions are scaled (100) any operation against the regions can
</I>&gt;<i> &gt;&gt; be
</I>&gt;<i> &gt;&gt; done without get a OutOfMemoryException.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The region stuff can be *very* complex and libgdiplus took a few
</I>&gt;<i> &gt; shortcuts to get things working.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; A long time ago (well about 2.5 year ago) only region with rectangle
</I>&gt;<i> &gt; shapes were supported inside libgdiplus. This was a big limitation but
</I>&gt;<i> &gt; was much simpler to implement (first shortcut).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; To get around this libgdiplus implements binary operations on
</I>&gt;<i> &gt; non-rectangular regions using a (1bbp) bitmap. This (second shortcut)
</I>&gt;<i> &gt; works very well unless you (a) need more than pixel accuracy or (b) have
</I>&gt;<i> &gt; very large regions.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Your example that have a region of 2936 x 3647 pixels (see WARNING)
</I>&gt;<i> &gt; which exceed the amount of memory that libgdiplus is willing to allocate
</I>&gt;<i> &gt; to compute the region - problem (b). This would (probably) work without
</I>&gt;<i> &gt; scaling but then you loose your &quot;hacked&quot; accuracy - problem (a).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt;  This is happening just on Mac OS, I
</I>&gt;<i> &gt;&gt; tested on Windows XP via mono and it works fine.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; This is because Mono use MS GDI+ on Windows. Your code would not be
</I>&gt;<i> &gt; working on Linux, Solaris or anywhere else (but Windows).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; The exception message is : 
</I>&gt;<i> &gt;&gt; ** (/Users/pablolecea/closest/closest/bin/Debug/closest.exe:604): WARNING
</I>&gt;<i> &gt;&gt; **: Path conversion requested 42830368 bytes (2936 x 3647). Maximum size
</I>&gt;<i> &gt;&gt; is
</I>&gt;<i> &gt;&gt; 8388608 bytes.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Unhandled Exception: System.OutOfMemoryException: Not enough memory to
</I>&gt;<i> &gt;&gt; complete operation [GDI+ status: OutOfMemory]
</I>&gt;<i> &gt;&gt;   at System.Drawing.GDIPlus.CheckStatus (Status status) [0x000be] in
</I>&gt;<i> &gt;&gt; /private/tmp/monobuild/build/BUILD/mono-1.9.1/mcs/class/System.Drawing/System.Drawing/gdipFunctions.cs:222 
</I>&gt;<i> &gt;&gt;   at System.Drawing.Region.Intersect (System.Drawing.Region region)
</I>&gt;<i> &gt;&gt; [0x00024] in
</I>&gt;<i> &gt;&gt; /private/tmp/monobuild/build/BUILD/mono-1.9.1/mcs/class/System.Drawing/System.Drawing/Region.cs:148 
</I>&gt;<i> &gt;&gt;   at (wrapper remoting-invoke-with-check) System.Drawing.Region:Intersect
</I>&gt;<i> &gt;&gt; (System.Drawing.Region)
</I>&gt;<i> &gt;&gt;   at closest.MainClass.GetClosestPoint () [0x00030] in
</I>&gt;<i> &gt;&gt; /Users/pablolecea/closest/closest/Main.cs:171 
</I>&gt;<i> &gt;&gt;   at closest.MainClass.Main (System.String[] args) [0x00000] in
</I>&gt;<i> &gt;&gt; /Users/pablolecea/closest/closest/Main.cs:154 
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Here the code:
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; static void Main(string[] args)
</I>&gt;<i> &gt;&gt;         {
</I>&gt;<i> &gt;&gt;             GetClosestPoint();
</I>&gt;<i> &gt;&gt;         }
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; private static void GetClosestPoint()
</I>&gt;<i> &gt;&gt;         {
</I>&gt;<i> &gt;&gt;             //get the regions
</I>&gt;<i> &gt;&gt;             Region firstRegion = CreateFirstRegion();
</I>&gt;<i> &gt;&gt;             Region secondRegion = CreateSecondRegion();
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             //This scaling is done to avoid rounding in bounds values
</I>&gt;<i> &gt;&gt;             Matrix matrix = new Matrix();
</I>&gt;<i> &gt;&gt;             matrix.Scale(100, 100);
</I>&gt;<i> &gt;&gt;             firstRegion.Transform(matrix);
</I>&gt;<i> &gt;&gt;             secondRegion.Transform(matrix);
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             //intersect the regions
</I>&gt;<i> &gt;&gt;             firstRegion.Intersect(secondRegion); //an
</I>&gt;<i> &gt;&gt; OutOfMemoryException
</I>&gt;<i> &gt;&gt; is thrown on mac OS
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             System.Windows.Forms.Control control = new
</I>&gt;<i> &gt;&gt; System.Windows.Forms.Control();
</I>&gt;<i> &gt;&gt;             System.Drawing.Graphics graph = control.CreateGraphics();
</I>&gt;<i> &gt;&gt;             graph.PageUnit = GraphicsUnit.Pixel;
</I>&gt;<i> &gt;&gt;             System.Drawing.RectangleF bounds =
</I>&gt;<i> &gt;&gt; firstRegion.GetBounds(graph);
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;         }
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; private static Region CreateFirstRegion()
</I>&gt;<i> &gt;&gt;         {
</I>&gt;<i> &gt;&gt;             GraphicsPath gp = new GraphicsPath();
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             gp.StartFigure();
</I>&gt;<i> &gt;&gt;             gp.AddLine(new PointF(193.24475f, 189.1613f), new
</I>&gt;<i> &gt;&gt; PointF(221.7687f, 225.011f));
</I>&gt;<i> &gt;&gt;             gp.AddLine(new PointF(221.7687f, 225.011f), new
</I>&gt;<i> &gt;&gt; PointF(222.5512f, 224.38869f));
</I>&gt;<i> &gt;&gt;             gp.AddLine(new PointF(222.5512f, 224.38869f), new
</I>&gt;<i> &gt;&gt; PointF(194.0272f, 188.53869f));
</I>&gt;<i> &gt;&gt;             gp.CloseFigure();
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             Region result = new Region(gp);
</I>&gt;<i> &gt;&gt;             return result;
</I>&gt;<i> &gt;&gt;         }
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;         private static Region CreateSecondRegion()
</I>&gt;<i> &gt;&gt;         {
</I>&gt;<i> &gt;&gt;             GraphicsPath gp = new GraphicsPath();
</I>&gt;<i> &gt;&gt;             string text = &quot;Cl&quot;;
</I>&gt;<i> &gt;&gt;             int platformStyle = (int)System.Drawing.FontStyle.Regular;
</I>&gt;<i> &gt;&gt;             float fontSize = 12;
</I>&gt;<i> &gt;&gt;             string fontName = &quot;Times New Roman&quot;;
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             System.Drawing.Font platformFont = new
</I>&gt;<i> &gt;&gt; System.Drawing.Font(fontName, fontSize, System.Drawing.FontStyle.Regular,
</I>&gt;<i> &gt;&gt; GraphicsUnit.Pixel);
</I>&gt;<i> &gt;&gt;             gp.AddString(text, platformFont.FontFamily, platformStyle,
</I>&gt;<i> &gt;&gt; platformFont.Size, new System.Drawing.Rectangle(),
</I>&gt;<i> &gt;&gt; StringFormat.GenericTypographic);
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             Matrix translationMatrix = new Matrix();
</I>&gt;<i> &gt;&gt;             translationMatrix.Translate(187.222f, 182.8066f);
</I>&gt;<i> &gt;&gt;             gp.Transform(translationMatrix);
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt;             Region result = new Region(gp);
</I>&gt;<i> &gt;&gt;             return result;
</I>&gt;<i> &gt;&gt;         }
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Can you help me to figure out what is happening.
</I>&gt;<i> &gt;&gt; Thanks, 
</I>&gt;<i> &gt;&gt; Pablo
</I>&gt;<i> &gt;&gt; -- 
</I>&gt;<i> &gt;&gt; View this message in context:
</I>&gt;<i> &gt;&gt; <A HREF="http://www.nabble.com/OutOfMemoryException-after-scale-transform-a-Region-tp19610028p19610028.html">http://www.nabble.com/OutOfMemoryException-after-scale-transform-a-Region-tp19610028p19610028.html</A>
</I>&gt;<i> &gt;&gt; Sent from the Mono - General mailing list archive at Nabble.com.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039692.html">[Mono-list] OutOfMemoryException after scale transform a	Region
</A></li>
	<LI>Next message: <A HREF="039678.html">[Mono-list] Reliable OS identification on Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39693">[ date ]</a>
              <a href="thread.html#39693">[ thread ]</a>
              <a href="subject.html#39693">[ subject ]</a>
              <a href="author.html#39693">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
