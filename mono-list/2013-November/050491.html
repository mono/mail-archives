<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Failing%20dlopen%20on%20Linux%20via%20DllImport%20with%20error%0A%20message%20%27dlopen%3A%20invalid%20caller%27&In-Reply-To=%3C9657E5F32D0E5F4599B08172DA6CE8810C95F6C5%40exmbx02-cdc.nexus.csiro.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="050492.html">
   <LINK REL="Next"  HREF="050501.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'</H1>
    <B>Jean-Michel.Perraud at csiro.au</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Failing%20dlopen%20on%20Linux%20via%20DllImport%20with%20error%0A%20message%20%27dlopen%3A%20invalid%20caller%27&In-Reply-To=%3C9657E5F32D0E5F4599B08172DA6CE8810C95F6C5%40exmbx02-cdc.nexus.csiro.au%3E"
       TITLE="[Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'">Jean-Michel.Perraud at csiro.au
       </A><BR>
    <I>Tue Nov 26 00:34:15 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="050492.html">[Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'
</A></li>
        <LI>Next message: <A HREF="050501.html">[Mono-list] Mono builds that works in major linux distros
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50491">[ date ]</a>
              <a href="thread.html#50491">[ thread ]</a>
              <a href="subject.html#50491">[ subject ]</a>
              <a href="author.html#50491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the best practice advice; I'll fix this.

Regarding the dlopen failure, this does seem to occur deep in glibc, <A HREF="http://code.woboq.org/userspace/glibc/elf/dl-open.c.html,">http://code.woboq.org/userspace/glibc/elf/dl-open.c.html,</A> way in where this is unintelligible to me. 
  /* Check whether _dl_open() has been called from a valid DSO.  */
193	  if (__check_caller (args-&gt;caller_dl_open,
194			      allow_libc|allow_libdl|allow_ldso) != 0)
195	    _dl_signal_error (0, &quot;dlopen&quot;, NULL, N_(&quot;invalid caller&quot;));

J-M

-----Original Message-----
From: Jonathan Pryor [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">jonpryor at vt.edu</A>] 
Sent: Tuesday, 26 November 2013 11:21 AM
To: Perraud, Jean-Michel (CLW, Black Mountain)
Cc: mono-list
Subject: Re: [Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'

On Nov 25, 2013, at 5:47 PM, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Jean-Michel.Perraud at csiro.au</A> wrote:
&gt;<i>      [DllImport(&quot;libdl&quot;)]
</I>&gt;<i>      [return: MarshalAs(UnmanagedType.LPStr)]
</I>&gt;<i>      private static extern string dlerror();
</I>
You should (almost?) never use `string` (or any other reference type) as the return type in a P/Invoke method:

	<A HREF="http://mono-project.com/DllImport#Classes_and_Structures_as_Return_Values">http://mono-project.com/DllImport#Classes_and_Structures_as_Return_Values</A>
&gt;<i> The CLI assumes that all memory that is passed between the CLI/unmanaged code boundary is allocated via a common memory allocator. The developer does not get a choice in which memory allocator is used. For managed code, the Marshal.AllocCoTaskMem method can be used to allocate memory, Marshal.FreeCoTaskMem is used to free the memory allocated by Marshal.AllocCoTaskMem, andMarshal.ReAllocCoTaskMem is used to resize a memory region originally allocated by Marshal.AllocCoTaskMem.
</I>&gt;<i> 
</I>&gt;<i> Since classes are passed by reference, a pointer is returned, and the runtime assumes that it must free this memory to avoid a memory leak.
</I>
You should instead use IntPtr as the return type, then use Marshal.PtrToStringAnsi() to convert the IntPtr into a string.

 - Jon

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="050492.html">[Mono-list] Failing dlopen on Linux via DllImport with error message 'dlopen: invalid caller'
</A></li>
	<LI>Next message: <A HREF="050501.html">[Mono-list] Mono builds that works in major linux distros
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50491">[ date ]</a>
              <a href="thread.html#50491">[ thread ]</a>
              <a href="subject.html#50491">[ subject ]</a>
              <a href="author.html#50491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
