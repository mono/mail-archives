<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Interop%20problem%3A%20%2A%2A%20ERROR%20%2A%2A%3A%20Type%0A%20System.MarshalByRefObject%20which%20is%20passed%20to%20unmanaged%20code%20must%20have%20a%0A%20StructLayout%20attribute&In-Reply-To=45E0A8CD.3030709%40ugent.be">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034357.html">
   <LINK REL="Next"  HREF="034378.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Interop%20problem%3A%20%2A%2A%20ERROR%20%2A%2A%3A%20Type%0A%20System.MarshalByRefObject%20which%20is%20passed%20to%20unmanaged%20code%20must%20have%20a%0A%20StructLayout%20attribute&In-Reply-To=45E0A8CD.3030709%40ugent.be"
       TITLE="[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute">robertj at gmx.net
       </A><BR>
    <I>Mon Feb 26 04:12:13 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="034357.html">[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute
</A></li>
        <LI>Next message: <A HREF="034378.html">[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34362">[ date ]</a>
              <a href="thread.html#34362">[ thread ]</a>
              <a href="subject.html#34362">[ subject ]</a>
              <a href="author.html#34362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Frederik Carlier wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I have, unfortunately, another Interop problem with Mono. Using a struct
</I>&gt;<i> like this:
</I>&gt;<i> 
</I>&gt;<i>     [StructLayout(LayoutKind.Sequential)]
</I>&gt;<i>     internal struct StreamSource
</I>&gt;<i>     {
</I>&gt;<i>         private TidyBuffer buffer;
</I>&gt;<i>         private Stream stream;
</I>&gt;<i>     }
</I>&gt;<i> , I have the following code:
</I>&gt;<i> 
</I>&gt;<i>             StreamSource data = new StreamSource();
</I>&gt;<i>             data.stream = stream;
</I>&gt;<i>             IntPtr ptr = Marshal.AllocHGlobal(Marshal.SizeOf(data));
</I>&gt;<i>             Marshal.StructureToPtr(data, ptr, true);
</I>&gt;<i> 
</I>&gt;<i> which runs fine on Windows and Microsoft .NET, but crashes badly on Mono:
</I>&gt;<i> 
</I>&gt;<i> ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged
</I>&gt;<i> code must have a StructLayout attribute
</I>&gt;<i> aborting...
</I>&gt;<i> Stacktrace:
</I>&gt;<i> 
</I>&gt;<i>   at (wrapper managed-to-native)
</I>&gt;<i> System.Runtime.InteropServices.Marshal.StructureToPtr
</I>&gt;<i> (object,intptr,bool) &lt;0x00004&gt;
</I>&gt;<i>   at (wrapper managed-to-native)
</I>&gt;<i> System.Runtime.InteropServices.Marshal.StructureToPtr
</I>&gt;<i> (object,intptr,bool) &lt;0xffffffff&gt;
</I>&gt;<i>   at (...)
</I>&gt;<i> 
</I>&gt;<i> So, obviously, the question is: what am I doing wrong, if anything?
</I>
Your struct is containing a Stream object which can't be
safely passed to unmanaged code. MS.NET 2.0 doesn't seem to
care in this case (1.1 does), but the code will definitely break
if you're relying on the stream being marshaled back correctly
(MS.NET has a moving/compacting GC).

Please file a bug for the ** ERROR ** on the 2.0 profile
with a compilable test case, but also consider changing the
struct because it's definitely not suitable for p/invoke.

Robert

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034357.html">[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute
</A></li>
	<LI>Next message: <A HREF="034378.html">[Mono-list] Interop problem: ** ERROR **: Type System.MarshalByRefObject which is passed to unmanaged code must have a StructLayout attribute
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34362">[ date ]</a>
              <a href="thread.html#34362">[ thread ]</a>
              <a href="subject.html#34362">[ subject ]</a>
              <a href="author.html#34362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
