<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&gt;<br>
&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Trouble&nbsp;with&nbsp;utf-16&nbsp;marshaling&lt;/TITLE&gt;<br>
&lt;META&nbsp;http-equiv=Content-Type&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;META&nbsp;content=&quot;MSHTML&nbsp;6.00.6000.16481&quot;&nbsp;name=GENERATOR&gt;&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;color=#0000ff&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;If&nbsp;the&nbsp;string&nbsp;argument&nbsp;is&nbsp;mutable&nbsp;then&nbsp;I&nbsp;believe&nbsp;one&nbsp;should&nbsp;use&nbsp;a&nbsp;<br>
StringBuilder&nbsp;--&nbsp;with&nbsp;its&nbsp;capacity&nbsp;set,&nbsp;and&nbsp;that&nbsp;length&nbsp;passed&nbsp;to&nbsp;the&nbsp;native&nbsp;<br>
function&nbsp;too.&amp;nbsp;&nbsp;And&nbsp;if&nbsp;the&nbsp;native&nbsp;method&nbsp;writes&nbsp;more&nbsp;chars&nbsp;than&nbsp;allocated&nbsp;<br>
then&nbsp;the&nbsp;heap&nbsp;will&nbsp;be&nbsp;corrupted.&nbsp;:-(&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;So&nbsp;with&nbsp;native&nbsp;method:&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;void&nbsp;my_function(unsigned&nbsp;short*&nbsp;myArg,&nbsp;int&nbsp;maxLen);&nbsp;<br>
&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;Do&nbsp;&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&gt;&lt;FONT&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;/SPAN&gt;[DllImport(&quot;myCLib&quot;&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;,&nbsp;<br>
CharSet=CharSet.Unicode&lt;/SPAN&gt;)]&lt;BR&gt;&lt;/FONT&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&gt;&lt;FONT&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
class=718271123-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//&nbsp;I&nbsp;think&nbsp;&amp;lt;CharSet&amp;gt;&nbsp;on&nbsp;that&nbsp;<br>
attr&nbsp;is&nbsp;enough,&nbsp;no&nbsp;need&nbsp;for&nbsp;MarshalAs&nbsp;on&nbsp;the&nbsp;param...&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
p&lt;/SPAN&gt;ublic&nbsp;static&nbsp;extern&nbsp;void&nbsp;my_function(&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;S&lt;/SPAN&gt;tring&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;Builder&lt;/SPAN&gt;&nbsp;myArg&lt;SPAN&nbsp;class=687455022-29062007&gt;,&nbsp;<br>
int&nbsp;maxLength&lt;/SPAN&gt;);&nbsp;&lt;BR&gt;&lt;/FONT&gt;&lt;/FONT&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;<br>
face=Arial&nbsp;size=2&gt;...&lt;BR&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/SPAN&gt;&lt;SPAN&nbsp;<br>
class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
StringBuilder&nbsp;bldr&nbsp;=&nbsp;new&nbsp;StringBuilder(256);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
NativeMethods.my_function(bldr,&nbsp;bldr.Capacity);&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;See&nbsp;a&nbsp;similar&nbsp;sample&nbsp;<br>
at&nbsp;&lt;/FONT&gt;&lt;A&nbsp;<br>
href=&quot;http://msdn2.microsoft.com/en-us/library/x3txb6xc(vs.80).aspx&quot;&gt;&lt;FONT&nbsp;<br>
face=Arial&nbsp;<br>
size=2&gt;http://msdn2.microsoft.com/en-us/library/x3txb6xc(vs.80).aspx&lt;/FONT&gt;&lt;/A&gt;&lt;FONT&nbsp;<br>
face=Arial&nbsp;size=2&gt;,&nbsp;and&nbsp;reference&nbsp;material&nbsp;at&nbsp;&lt;/FONT&gt;&lt;A&nbsp;<br>
href=&quot;http://msdn2.microsoft.com/en-us/library/s9ts558h(VS.80).aspx&quot;&gt;&lt;FONT&nbsp;<br>
face=Arial&nbsp;<br>
size=2&gt;http://msdn2.microsoft.com/en-us/library/s9ts558h(VS.80).aspx&lt;/FONT&gt;&lt;/A&gt;&lt;FONT&nbsp;<br>
face=Arial&nbsp;size=2&gt;&amp;nbsp;etc.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&gt;&lt;FONT&nbsp;size=2&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;Unless&nbsp;I'm&nbsp;much&nbsp;<br>
confused&nbsp;it&nbsp;shouldn't&nbsp;work&nbsp;(at&nbsp;least&nbsp;isn't&nbsp;guaranteed&nbsp;to)&nbsp;on&nbsp;MSFT&nbsp;either:&nbsp;<br>
&lt;/SPAN&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&quot;Platform&nbsp;invoke&nbsp;copies&nbsp;string&nbsp;arguments,&nbsp;<br>
converting&nbsp;from&nbsp;the&nbsp;.NET&nbsp;Framework&nbsp;format&nbsp;(Unicode)&nbsp;to&nbsp;the&nbsp;platform&nbsp;unmanaged&nbsp;<br>
format.&nbsp;Strings&nbsp;are&nbsp;immutable&nbsp;and&nbsp;are&nbsp;not&nbsp;copied&nbsp;back&nbsp;from&nbsp;unmanaged&nbsp;memory&nbsp;to&nbsp;<br>
managed&nbsp;memory&nbsp;when&nbsp;the&nbsp;call&nbsp;returns.&quot;&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/FONT&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;I&nbsp;suppose&nbsp;since&nbsp;it&nbsp;is&nbsp;<br>
Unicode&nbsp;on&nbsp;both&nbsp;sides&nbsp;the&nbsp;MSFT&nbsp;CLR&nbsp;skips&nbsp;the&nbsp;copy&nbsp;and&nbsp;just&nbsp;passed&nbsp;the&nbsp;address&nbsp;of&nbsp;<br>
the&nbsp;String's&nbsp;content.&amp;nbsp;&nbsp;Whereas&nbsp;Mono&nbsp;doesn't&nbsp;have&nbsp;that&nbsp;optimisation&nbsp;<br>
perhaps.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;Does&nbsp;that&nbsp;solve&nbsp;it,&nbsp;or&nbsp;<br>
is&nbsp;something&nbsp;else&nbsp;the&nbsp;problem?&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;SPAN&nbsp;class=687455022-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;Andy&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/P&gt;&lt;/DIV&gt;&lt;/FONT&gt;&lt;/DIV&gt;&lt;BR&gt;<br>
&lt;BLOCKQUOTE&nbsp;dir=ltr&nbsp;<br>
style=&quot;PADDING-LEFT:&nbsp;5px;&nbsp;MARGIN-LEFT:&nbsp;5px;&nbsp;BORDER-LEFT:&nbsp;#0000ff&nbsp;2px&nbsp;solid;&nbsp;MARGIN-RIGHT:&nbsp;0px&quot;&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;class=OutlookMessageHeader&nbsp;lang=en-us&nbsp;dir=ltr&nbsp;align=left&gt;<br>
&nbsp;&nbsp;&lt;HR&nbsp;tabIndex=-1&gt;<br>
&nbsp;&nbsp;&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;From:&lt;/B&gt;&nbsp;mono-list-bounces@lists.ximian.com&nbsp;<br>
&nbsp;&nbsp;[mailto:mono-list-bounces@lists.ximian.com]&nbsp;&lt;B&gt;On&nbsp;Behalf&nbsp;Of&nbsp;&lt;/B&gt;Maser,&nbsp;<br>
&nbsp;&nbsp;Dan&lt;BR&gt;&lt;B&gt;Sent:&lt;/B&gt;&nbsp;29&nbsp;June&nbsp;2007&nbsp;23:23&lt;BR&gt;&lt;B&gt;To:&lt;/B&gt;&nbsp;Maser,&nbsp;Dan;&nbsp;<br>
&nbsp;&nbsp;mono-list@lists.ximian.com&lt;BR&gt;&lt;B&gt;Subject:&lt;/B&gt;&nbsp;Re:&nbsp;[Mono-list]&nbsp;Trouble&nbsp;with&nbsp;<br>
&nbsp;&nbsp;utf-16&nbsp;marshaling&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&nbsp;I&nbsp;have&nbsp;debugged&nbsp;this&nbsp;some&nbsp;more,&nbsp;and&nbsp;<br>
&nbsp;&nbsp;found&nbsp;this.&amp;nbsp;&nbsp;(I'm&nbsp;not&nbsp;yet&nbsp;sure&nbsp;how&nbsp;to&nbsp;convert&nbsp;this&nbsp;information&nbsp;into&nbsp;<br>
&nbsp;&nbsp;something&nbsp;actionable).&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;I&nbsp;was&nbsp;browsing&nbsp;some&nbsp;of&nbsp;the&nbsp;mono&nbsp;source&nbsp;code&nbsp;and&nbsp;found&nbsp;<br>
&nbsp;&nbsp;this&nbsp;function&nbsp;(and&nbsp;its&nbsp;sisters):&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoString*&nbsp;<br>
&nbsp;&nbsp;mono_string_new_utf16&nbsp;(MonoDomain&nbsp;*domain,&nbsp;const&nbsp;guint16&nbsp;*text,&nbsp;gint32&nbsp;<br>
&nbsp;&nbsp;len);&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;which&nbsp;seem&nbsp;to&nbsp;be&nbsp;the&nbsp;function(s)&nbsp;that&nbsp;initialize&nbsp;<br>
&nbsp;&nbsp;internal&nbsp;C#&nbsp;strings&nbsp;from&nbsp;C&nbsp;data.&amp;nbsp;&nbsp;This&nbsp;one&nbsp;in&nbsp;particular&nbsp;appears&nbsp;to&nbsp;be&nbsp;<br>
&nbsp;&nbsp;invoked&nbsp;when&nbsp;internal&nbsp;C#&nbsp;strings&nbsp;are&nbsp;created&nbsp;from&nbsp;UTF-16&nbsp;&quot;C&quot;&nbsp;data.&amp;nbsp;&amp;nbsp;&nbsp;<br>
&nbsp;&nbsp;I&nbsp;hacked&nbsp;in&nbsp;a&nbsp;simple&nbsp;loop&nbsp;that&nbsp;printf'd&nbsp;the&nbsp;hex&nbsp;values&nbsp;of&nbsp;the&nbsp;UTF-16&nbsp;data&nbsp;(the&nbsp;<br>
&nbsp;&nbsp;'text'&nbsp;parameter).&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&nbsp;What&nbsp;I&nbsp;see&nbsp;in&nbsp;my&nbsp;console&nbsp;window&nbsp;is&nbsp;<br>
&nbsp;&nbsp;interesting.&amp;nbsp;&nbsp;(After&nbsp;a&nbsp;bunch&nbsp;of&nbsp;unrelated&nbsp;stuff)&nbsp;I&nbsp;see&nbsp;my&nbsp;C&nbsp;library&nbsp;<br>
&nbsp;&nbsp;returning&nbsp;a&nbsp;UTF-16&nbsp;string&nbsp;that&nbsp;gets&nbsp;correctly&nbsp;interpreted&nbsp;<br>
&nbsp;&nbsp;as&amp;nbsp;MonoString:&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;DBG:&nbsp;invocation&nbsp;of&nbsp;<br>
&nbsp;&nbsp;mono_string_new_utf16&nbsp;with&nbsp;data:&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&nbsp;&nbsp;002f&amp;nbsp;&nbsp;00&lt;STRONG&gt;68&lt;/STRONG&gt;&amp;nbsp;&nbsp;006f&amp;nbsp;&nbsp;00&lt;STRONG&gt;6d&lt;/STRONG&gt;&amp;nbsp;&nbsp;<br>
&nbsp;&nbsp;0065&amp;nbsp;&nbsp;00&lt;STRONG&gt;2f&lt;/STRONG&gt;&amp;nbsp;&nbsp;0064&nbsp;&amp;nbsp;00&lt;STRONG&gt;61&lt;/STRONG&gt;&nbsp;<br>
&nbsp;&nbsp;&amp;nbsp;006e&nbsp;&amp;nbsp;00&lt;STRONG&gt;6d&lt;/STRONG&gt;&nbsp;&amp;nbsp;002f&amp;nbsp;&nbsp;00&lt;STRONG&gt;69&lt;/STRONG&gt;&nbsp;<br>
&nbsp;&nbsp;&amp;nbsp;006e&amp;nbsp;&nbsp;00&lt;STRONG&gt;74&lt;/STRONG&gt;&nbsp;...&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;which&nbsp;is&nbsp;the&nbsp;correct&nbsp;string.&amp;nbsp;&nbsp;The&nbsp;next&nbsp;thing&nbsp;I&nbsp;<br>
&nbsp;&nbsp;see&nbsp;in&nbsp;the&nbsp;console&nbsp;window&nbsp;is&nbsp;this:&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
class=329470722-29062007&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;DBG:&nbsp;invocation&nbsp;of&nbsp;<br>
&nbsp;&nbsp;mono_string_new_utf16&nbsp;with&nbsp;data:&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;<br>
&nbsp;&nbsp;&lt;STRONG&gt;68&lt;/STRONG&gt;2f&amp;nbsp;&nbsp;&lt;STRONG&gt;6d&lt;/STRONG&gt;6f&nbsp;&amp;nbsp;&lt;STRONG&gt;2f&lt;/STRONG&gt;65&nbsp;<br>
&nbsp;&nbsp;&amp;nbsp;&lt;STRONG&gt;61&lt;/STRONG&gt;64&nbsp;&amp;nbsp;&lt;STRONG&gt;6d&lt;/STRONG&gt;6e&nbsp;<br>
&nbsp;&nbsp;&amp;nbsp;&lt;STRONG&gt;69&lt;/STRONG&gt;2f&amp;nbsp;&nbsp;&lt;STRONG&gt;74&lt;/STRONG&gt;6e''&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;Notice&nbsp;that&nbsp;this&nbsp;second&nbsp;data&nbsp;is&nbsp;similiar&nbsp;to&nbsp;the&nbsp;first&nbsp;<br>
&nbsp;&nbsp;where&nbsp;each&nbsp;2-bytes&nbsp;in&nbsp;the&nbsp;second&nbsp;string&nbsp;is&nbsp;the&nbsp;corresponding&nbsp;*4*&nbsp;bytes&nbsp;of&nbsp;the&nbsp;<br>
&nbsp;&nbsp;first&nbsp;string&nbsp;and&nbsp;re-ordered&nbsp;as&nbsp;if&nbsp;there&nbsp;were&nbsp;some&nbsp;endian&nbsp;issue.&amp;nbsp;&nbsp;Clearly&nbsp;<br>
&nbsp;&nbsp;this&nbsp;second&nbsp;string&nbsp;is&nbsp;supposed&nbsp;to&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;first&nbsp;string&nbsp;but&nbsp;it's&nbsp;<br>
&nbsp;&nbsp;been&nbsp;damaged&nbsp;by&nbsp;some&nbsp;translation&nbsp;process.&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&nbsp;Does&nbsp;that&nbsp;information&nbsp;mean&nbsp;anything&nbsp;to&nbsp;<br>
&nbsp;&nbsp;anyone?&amp;nbsp;&amp;nbsp;&nbsp;As&nbsp;always,&nbsp;thanks&nbsp;for&nbsp;any&nbsp;help.&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;SPAN&nbsp;<br>
&nbsp;&nbsp;class=329470722-29062007&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Dan&nbsp;<br>
&nbsp;&nbsp;Maser.&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/FONT&gt;&lt;/DIV&gt;&lt;/DIV&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#0000ff&nbsp;<br>
&nbsp;&nbsp;size=2&gt;&lt;/FONT&gt;&lt;BR&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;class=OutlookMessageHeader&nbsp;lang=en-us&nbsp;dir=ltr&nbsp;align=left&gt;<br>
&nbsp;&nbsp;&lt;HR&nbsp;tabIndex=-1&gt;<br>
&nbsp;&nbsp;&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;From:&lt;/B&gt;&nbsp;Maser,&nbsp;Dan&nbsp;&lt;BR&gt;&lt;B&gt;Sent:&lt;/B&gt;&nbsp;Friday,&nbsp;June&nbsp;<br>
&nbsp;&nbsp;29,&nbsp;2007&nbsp;1:10&nbsp;PM&lt;BR&gt;&lt;B&gt;To:&lt;/B&gt;&nbsp;Maser,&nbsp;Dan;&nbsp;<br>
&nbsp;&nbsp;'mono-list@lists.ximian.com'&lt;BR&gt;&lt;B&gt;Subject:&lt;/B&gt;&nbsp;RE:&nbsp;[Mono-list]&nbsp;Trouble&nbsp;with&nbsp;<br>
&nbsp;&nbsp;utf-16&nbsp;marshaling&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Furthermore,&nbsp;I&nbsp;see&nbsp;in&nbsp;the&nbsp;mono&nbsp;source&nbsp;code&nbsp;<br>
&nbsp;&nbsp;that&nbsp;there&nbsp;is&nbsp;a&nbsp;test&nbsp;function&nbsp;in&nbsp;the&nbsp;<br>
&nbsp;&nbsp;mono/mono/tests/libtest.c&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;STDCALL&nbsp;unsigned&nbsp;short*&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;test_lpwstr_marshal&nbsp;(unsigned&nbsp;short*&nbsp;chars,&nbsp;long&nbsp;<br>
&nbsp;&nbsp;length)&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;{&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;...&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;}&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;color=#0000ff&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Which&nbsp;is&nbsp;basically&nbsp;the&nbsp;same&nbsp;thing&nbsp;I'm&nbsp;doing;&nbsp;<br>
&nbsp;&nbsp;further&nbsp;indicating&nbsp;that&nbsp;this&nbsp;should&nbsp;work.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;&lt;BR&gt;<br>
&nbsp;&nbsp;&lt;DIV&nbsp;class=OutlookMessageHeader&nbsp;lang=en-us&nbsp;dir=ltr&nbsp;align=left&gt;<br>
&nbsp;&nbsp;&lt;HR&nbsp;tabIndex=-1&gt;<br>
&nbsp;&nbsp;&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;From:&lt;/B&gt;&nbsp;mono-list-bounces@lists.ximian.com&nbsp;<br>
&nbsp;&nbsp;[mailto:mono-list-bounces@lists.ximian.com]&nbsp;&lt;B&gt;On&nbsp;Behalf&nbsp;Of&nbsp;&lt;/B&gt;Maser,&nbsp;<br>
&nbsp;&nbsp;Dan&lt;BR&gt;&lt;B&gt;Sent:&lt;/B&gt;&nbsp;Friday,&nbsp;June&nbsp;29,&nbsp;2007&nbsp;9:13&nbsp;AM&lt;BR&gt;&lt;B&gt;To:&lt;/B&gt;&nbsp;<br>
&nbsp;&nbsp;mono-list@lists.ximian.com&lt;BR&gt;&lt;B&gt;Subject:&lt;/B&gt;&nbsp;[Mono-list]&nbsp;Trouble&nbsp;with&nbsp;utf-16&nbsp;<br>
&nbsp;&nbsp;marshaling&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&nbsp;&nbsp;&lt;DIV&gt;&lt;/DIV&gt;&lt;!--&nbsp;Converted&nbsp;from&nbsp;text/rtf&nbsp;format&nbsp;--&gt;&lt;BR&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;My&nbsp;situation&nbsp;is&nbsp;this:&amp;nbsp;&nbsp;I've&nbsp;got&nbsp;a&nbsp;<br>
&nbsp;&nbsp;C&nbsp;library&nbsp;that&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;UTF-16&nbsp;inputs&nbsp;and&nbsp;outputs.&amp;nbsp;&nbsp;The&nbsp;C&nbsp;type&nbsp;is&nbsp;<br>
&nbsp;&nbsp;always&nbsp;&quot;unsigned&nbsp;short*&quot;&nbsp;or&nbsp;&quot;const&nbsp;unsigned&nbsp;short*&quot;&nbsp;(because&nbsp;clearly&nbsp;wchar_t*&nbsp;<br>
&nbsp;&nbsp;isn't&nbsp;portable&nbsp;because&nbsp;it's&nbsp;4&nbsp;bytes&nbsp;on&nbsp;linux).&amp;nbsp;&amp;nbsp;&nbsp;All&nbsp;of&nbsp;my&nbsp;C#&nbsp;code&nbsp;<br>
&nbsp;&nbsp;has&nbsp;the&nbsp;&quot;[MarshalAs(UnsignedType.LPWStr)]&quot;&nbsp;attribute&nbsp;specified.&lt;/FONT&gt;&lt;/P&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;It&nbsp;works&nbsp;properly&nbsp;in&nbsp;windows&nbsp;with&nbsp;MS&nbsp;<br>
&nbsp;&nbsp;.NET,&nbsp;but&nbsp;doesn't&nbsp;work&nbsp;for&nbsp;me&nbsp;in&nbsp;linux&nbsp;with&nbsp;mono.&amp;nbsp;&amp;nbsp;&nbsp;I've&nbsp;verified&nbsp;in&nbsp;<br>
&nbsp;&nbsp;gdb&nbsp;that&nbsp;the&nbsp;C&nbsp;library&nbsp;is&nbsp;returning&nbsp;the&nbsp;correct&nbsp;string,&nbsp;but&nbsp;immediately&nbsp;after&nbsp;<br>
&nbsp;&nbsp;the&nbsp;C&nbsp;dll&nbsp;returns&nbsp;and&nbsp;mono&nbsp;does&nbsp;the&nbsp;LPWStr&nbsp;marshaling&nbsp;the&nbsp;string&nbsp;is&nbsp;total&nbsp;<br>
&nbsp;&nbsp;garbage&nbsp;characters.&amp;nbsp;&amp;nbsp;&nbsp;I&nbsp;am&nbsp;under&nbsp;the&nbsp;impression&nbsp;from&nbsp;previous&nbsp;posts&nbsp;<br>
&nbsp;&nbsp;that&nbsp;2-byte&nbsp;UTF-16&nbsp;should&nbsp;marshal&nbsp;properly&nbsp;to&nbsp;mono&nbsp;with&nbsp;the&nbsp;LPWStr&nbsp;<br>
&nbsp;&nbsp;attribute.&amp;nbsp;&nbsp;In&nbsp;fact&nbsp;it&nbsp;looks&nbsp;like&nbsp;some&nbsp;of&nbsp;the&nbsp;gdiplus&nbsp;calls&nbsp;use&nbsp;that&nbsp;same&nbsp;<br>
&nbsp;&nbsp;thing&nbsp;and&nbsp;work&amp;#8230;&nbsp;any&nbsp;ideas&nbsp;what&nbsp;I&nbsp;can&nbsp;check&nbsp;on&nbsp;because&nbsp;mine&nbsp;doesn't?&lt;/FONT&gt;&lt;/P&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;For&nbsp;more&nbsp;clarification&nbsp;my&nbsp;C&nbsp;library&nbsp;<br>
&nbsp;&nbsp;has&nbsp;a&nbsp;function&nbsp;signature&nbsp;like&nbsp;this:&lt;/FONT&gt;&nbsp;&lt;/P&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;void&nbsp;my_function(unsigned&nbsp;short*&nbsp;myArg);&lt;/FONT&gt;&nbsp;<br>
&lt;/P&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;And&nbsp;my&nbsp;C#&nbsp;code&nbsp;looks&nbsp;like&nbsp;<br>
&nbsp;&nbsp;this:&lt;/FONT&gt;&nbsp;&lt;/P&gt;&lt;BR&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;[DllImport(&quot;myCLib&quot;)]&lt;/FONT&gt;&nbsp;&lt;BR&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;size=2&gt;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;my_function([MarshalAs(UnmanagedType.LPWStr)]&nbsp;<br>
&nbsp;&nbsp;string&nbsp;myArg);&lt;/FONT&gt;&nbsp;&lt;/P&gt;<br>
&nbsp;&nbsp;&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;ideas&nbsp;on&nbsp;<br>
&nbsp;&nbsp;what&nbsp;to&nbsp;check!&lt;/FONT&gt;&nbsp;&lt;BR&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
&nbsp;&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Dan&nbsp;Maser&lt;/FONT&gt;&nbsp;<br>
&lt;/P&gt;&lt;/BLOCKQUOTE&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>

</tt>
