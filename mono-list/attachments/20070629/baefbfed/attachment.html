<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;3.2//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;META&nbsp;NAME=&quot;Generator&quot;&nbsp;CONTENT=&quot;MS&nbsp;Exchange&nbsp;Server&nbsp;version&nbsp;6.5.7652.24&quot;&gt;<br>
&lt;TITLE&gt;Trouble&nbsp;with&nbsp;utf-16&nbsp;marshaling&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;!--&nbsp;Converted&nbsp;from&nbsp;text/rtf&nbsp;format&nbsp;--&gt;<br>
&lt;BR&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&nbsp;My&nbsp;situation&nbsp;is&nbsp;this:&amp;nbsp;&nbsp;I've&nbsp;got&nbsp;a&nbsp;C&nbsp;library&nbsp;that&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;UTF-16&nbsp;inputs&nbsp;and&nbsp;outputs.&amp;nbsp;&nbsp;The&nbsp;C&nbsp;type&nbsp;is&nbsp;always&nbsp;&amp;quot;unsigned&nbsp;short*&amp;quot;&nbsp;or&nbsp;&amp;quot;const&nbsp;unsigned&nbsp;short*&amp;quot;&nbsp;(because&nbsp;clearly&nbsp;wchar_t*&nbsp;isn't&nbsp;portable&nbsp;because&nbsp;it's&nbsp;4&nbsp;bytes&nbsp;on&nbsp;linux).&amp;nbsp;&amp;nbsp;&nbsp;All&nbsp;of&nbsp;my&nbsp;C#&nbsp;code&nbsp;has&nbsp;the&nbsp;&amp;quot;[MarshalAs(UnsignedType.LPWStr)]&amp;quot;&nbsp;attribute&nbsp;specified.&lt;/FONT&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&nbsp;It&nbsp;works&nbsp;properly&nbsp;in&nbsp;windows&nbsp;with&nbsp;MS&nbsp;.NET,&nbsp;but&nbsp;doesn't&nbsp;work&nbsp;for&nbsp;me&nbsp;in&nbsp;linux&nbsp;with&nbsp;mono.&amp;nbsp;&amp;nbsp;&nbsp;I've&nbsp;verified&nbsp;in&nbsp;gdb&nbsp;that&nbsp;the&nbsp;C&nbsp;library&nbsp;is&nbsp;returning&nbsp;the&nbsp;correct&nbsp;string,&nbsp;but&nbsp;immediately&nbsp;after&nbsp;the&nbsp;C&nbsp;dll&nbsp;returns&nbsp;and&nbsp;mono&nbsp;does&nbsp;the&nbsp;LPWStr&nbsp;marshaling&nbsp;the&nbsp;string&nbsp;is&nbsp;total&nbsp;garbage&nbsp;characters.&amp;nbsp;&amp;nbsp;&nbsp;I&nbsp;am&nbsp;under&nbsp;the&nbsp;impression&nbsp;from&nbsp;previous&nbsp;posts&nbsp;that&nbsp;2-byte&nbsp;UTF-16&nbsp;should&nbsp;marshal&nbsp;properly&nbsp;to&nbsp;mono&nbsp;with&nbsp;the&nbsp;LPWStr&nbsp;attribute.&amp;nbsp;&nbsp;In&nbsp;fact&nbsp;it&nbsp;looks&nbsp;like&nbsp;some&nbsp;of&nbsp;the&nbsp;gdiplus&nbsp;calls&nbsp;use&nbsp;that&nbsp;same&nbsp;thing&nbsp;and&nbsp;work&amp;#8230;&nbsp;any&nbsp;ideas&nbsp;what&nbsp;I&nbsp;can&nbsp;check&nbsp;on&nbsp;because&nbsp;mine&nbsp;doesn't?&lt;/FONT&gt;&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&nbsp;For&nbsp;more&nbsp;clarification&nbsp;my&nbsp;C&nbsp;library&nbsp;has&nbsp;a&nbsp;function&nbsp;signature&nbsp;like&nbsp;this:&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;void&nbsp;my_function(unsigned&nbsp;short*&nbsp;myArg);&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;And&nbsp;my&nbsp;C#&nbsp;code&nbsp;looks&nbsp;like&nbsp;this:&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
&lt;BR&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;[DllImport(&amp;quot;myCLib&amp;quot;)]&lt;/FONT&gt;<br>
<br>
&lt;BR&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;my_function([MarshalAs(UnmanagedType.LPWStr)]&nbsp;string&nbsp;myArg);&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&nbsp;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;ideas&nbsp;on&nbsp;what&nbsp;to&nbsp;check!&lt;/FONT&gt;<br>
<br>
&lt;BR&gt;&lt;FONT&nbsp;SIZE=2&nbsp;FACE=&quot;Arial&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Dan&nbsp;Maser&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;
</tt>
