<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.0&nbsp;Transitional//EN&quot;&gt;<br>
&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Trouble&nbsp;with&nbsp;utf-16&nbsp;marshaling&lt;/TITLE&gt;<br>
&lt;META&nbsp;http-equiv=Content-Type&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;<br>
&lt;META&nbsp;content=&quot;MSHTML&nbsp;6.00.2900.3059&quot;&nbsp;name=GENERATOR&gt;&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Furthermore,&nbsp;I&nbsp;see&nbsp;in&nbsp;the&nbsp;mono&nbsp;source&nbsp;code&nbsp;<br>
that&nbsp;there&nbsp;is&nbsp;a&nbsp;test&nbsp;function&nbsp;in&nbsp;the&nbsp;<br>
mono/mono/tests/libtest.c&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;STDCALL&nbsp;unsigned&nbsp;short*&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;test_lpwstr_marshal&nbsp;(unsigned&nbsp;short*&nbsp;chars,&nbsp;long&nbsp;<br>
length)&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;{&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;...&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;}&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;&lt;/FONT&gt;&lt;/SPAN&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;SPAN&nbsp;class=090580718-29062007&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
color=#0000ff&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Which&nbsp;is&nbsp;basically&nbsp;the&nbsp;same&nbsp;thing&nbsp;I'm&nbsp;doing;&nbsp;<br>
further&nbsp;indicating&nbsp;that&nbsp;this&nbsp;should&nbsp;work.&lt;/FONT&gt;&lt;/SPAN&gt;&lt;/DIV&gt;&lt;BR&gt;<br>
&lt;DIV&nbsp;class=OutlookMessageHeader&nbsp;lang=en-us&nbsp;dir=ltr&nbsp;align=left&gt;<br>
&lt;HR&nbsp;tabIndex=-1&gt;<br>
&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;From:&lt;/B&gt;&nbsp;mono-list-bounces@lists.ximian.com&nbsp;<br>
[mailto:mono-list-bounces@lists.ximian.com]&nbsp;&lt;B&gt;On&nbsp;Behalf&nbsp;Of&nbsp;&lt;/B&gt;Maser,&nbsp;<br>
Dan&lt;BR&gt;&lt;B&gt;Sent:&lt;/B&gt;&nbsp;Friday,&nbsp;June&nbsp;29,&nbsp;2007&nbsp;9:13&nbsp;AM&lt;BR&gt;&lt;B&gt;To:&lt;/B&gt;&nbsp;<br>
mono-list@lists.ximian.com&lt;BR&gt;&lt;B&gt;Subject:&lt;/B&gt;&nbsp;[Mono-list]&nbsp;Trouble&nbsp;with&nbsp;utf-16&nbsp;<br>
marshaling&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;/DIV&gt;&lt;!--&nbsp;Converted&nbsp;from&nbsp;text/rtf&nbsp;format&nbsp;--&gt;&lt;BR&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;My&nbsp;situation&nbsp;is&nbsp;this:&amp;nbsp;&nbsp;I've&nbsp;got&nbsp;a&nbsp;C&nbsp;<br>
library&nbsp;that&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;UTF-16&nbsp;inputs&nbsp;and&nbsp;outputs.&amp;nbsp;&nbsp;The&nbsp;C&nbsp;type&nbsp;is&nbsp;always&nbsp;<br>
&quot;unsigned&nbsp;short*&quot;&nbsp;or&nbsp;&quot;const&nbsp;unsigned&nbsp;short*&quot;&nbsp;(because&nbsp;clearly&nbsp;wchar_t*&nbsp;isn't&nbsp;<br>
portable&nbsp;because&nbsp;it's&nbsp;4&nbsp;bytes&nbsp;on&nbsp;linux).&amp;nbsp;&amp;nbsp;&nbsp;All&nbsp;of&nbsp;my&nbsp;C#&nbsp;code&nbsp;has&nbsp;the&nbsp;<br>
&quot;[MarshalAs(UnsignedType.LPWStr)]&quot;&nbsp;attribute&nbsp;specified.&lt;/FONT&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;It&nbsp;works&nbsp;properly&nbsp;in&nbsp;windows&nbsp;with&nbsp;MS&nbsp;<br>
.NET,&nbsp;but&nbsp;doesn't&nbsp;work&nbsp;for&nbsp;me&nbsp;in&nbsp;linux&nbsp;with&nbsp;mono.&amp;nbsp;&amp;nbsp;&nbsp;I've&nbsp;verified&nbsp;in&nbsp;<br>
gdb&nbsp;that&nbsp;the&nbsp;C&nbsp;library&nbsp;is&nbsp;returning&nbsp;the&nbsp;correct&nbsp;string,&nbsp;but&nbsp;immediately&nbsp;after&nbsp;<br>
the&nbsp;C&nbsp;dll&nbsp;returns&nbsp;and&nbsp;mono&nbsp;does&nbsp;the&nbsp;LPWStr&nbsp;marshaling&nbsp;the&nbsp;string&nbsp;is&nbsp;total&nbsp;<br>
garbage&nbsp;characters.&amp;nbsp;&amp;nbsp;&nbsp;I&nbsp;am&nbsp;under&nbsp;the&nbsp;impression&nbsp;from&nbsp;previous&nbsp;posts&nbsp;<br>
that&nbsp;2-byte&nbsp;UTF-16&nbsp;should&nbsp;marshal&nbsp;properly&nbsp;to&nbsp;mono&nbsp;with&nbsp;the&nbsp;LPWStr&nbsp;<br>
attribute.&amp;nbsp;&nbsp;In&nbsp;fact&nbsp;it&nbsp;looks&nbsp;like&nbsp;some&nbsp;of&nbsp;the&nbsp;gdiplus&nbsp;calls&nbsp;use&nbsp;that&nbsp;same&nbsp;<br>
thing&nbsp;and&nbsp;work&amp;#8230;&nbsp;any&nbsp;ideas&nbsp;what&nbsp;I&nbsp;can&nbsp;check&nbsp;on&nbsp;because&nbsp;mine&nbsp;doesn't?&lt;/FONT&gt;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;For&nbsp;more&nbsp;clarification&nbsp;my&nbsp;C&nbsp;library&nbsp;has&nbsp;<br>
a&nbsp;function&nbsp;signature&nbsp;like&nbsp;this:&lt;/FONT&gt;&nbsp;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;void&nbsp;my_function(unsigned&nbsp;short*&nbsp;myArg);&lt;/FONT&gt;&nbsp;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;And&nbsp;my&nbsp;C#&nbsp;code&nbsp;looks&nbsp;like&nbsp;<br>
this:&lt;/FONT&gt;&nbsp;&lt;/P&gt;&lt;BR&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;[DllImport(&quot;myCLib&quot;)]&lt;/FONT&gt;&nbsp;&lt;BR&gt;&lt;FONT&nbsp;face=Arial&nbsp;<br>
size=2&gt;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;my_function([MarshalAs(UnmanagedType.LPWStr)]&nbsp;<br>
string&nbsp;myArg);&lt;/FONT&gt;&nbsp;&lt;/P&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&nbsp;Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;any&nbsp;ideas&nbsp;on&nbsp;what&nbsp;<br>
to&nbsp;check!&lt;/FONT&gt;&nbsp;&lt;BR&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Dan&nbsp;<br>
Maser&lt;/FONT&gt;&nbsp;&lt;/P&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>

</tt>
