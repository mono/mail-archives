<tt>
&lt;DIV&gt;<br>
&lt;DIV&gt;Hello&nbsp;all,&lt;/DIV&gt;<br>
&lt;DIV&gt;I&nbsp;am&nbsp;restating&nbsp;my&nbsp;problem.&lt;/DIV&gt;<br>
&lt;DIV&gt;My&nbsp;problem&nbsp;:&nbsp;isolating&nbsp;faults&nbsp;caused&nbsp;by&nbsp;unmanaged&nbsp;code.&nbsp;To&nbsp;achieve&nbsp;this&nbsp;I&nbsp;am&nbsp;not&nbsp;allowing&nbsp;the&nbsp;unmanaged&nbsp;code&nbsp;to&nbsp;&quot;modify&nbsp;managed&nbsp;memory&quot;.&lt;/DIV&gt;<br>
&lt;DIV&gt;I&nbsp;am&nbsp;doing&nbsp;this&nbsp;in&nbsp;two&nbsp;stages.&lt;BR&gt;1)&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;unmanaged&nbsp;C&nbsp;code&nbsp;does&nbsp;not&nbsp;modify&nbsp;any&nbsp;managegd&nbsp;memory.&nbsp;This&nbsp;I&nbsp;am&nbsp;doing&nbsp;by&nbsp;modifying&nbsp;the&nbsp;ASSEMBLY&nbsp;code&nbsp;of&nbsp;the&nbsp;unmanaged&nbsp;program&nbsp;and&nbsp;sandboxing&nbsp;it&nbsp;so&nbsp;that&nbsp;all&nbsp;the&nbsp;&quot;write&nbsp;&quot;&nbsp;instructions&nbsp;dont&nbsp;write&nbsp;to&nbsp;managed&nbsp;memory.&lt;/DIV&gt;<br>
&lt;DIV&gt;2)&nbsp;If&nbsp;an&nbsp;argument&nbsp;is&nbsp;passed&nbsp;by&nbsp;reference,&nbsp;I&nbsp;have&nbsp;make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;object&nbsp;in&nbsp;unmanaged&nbsp;memory&nbsp;and&nbsp;pass&nbsp;this&nbsp;reference&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;code.&nbsp;So&nbsp;the&nbsp;program&nbsp;will&nbsp;get&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;and&nbsp;not&nbsp;managed&nbsp;memory.&lt;/DIV&gt;<br>
&lt;DIV&gt;By&nbsp;these&nbsp;two&nbsp;stages,&amp;nbsp;&nbsp;I&nbsp;am&nbsp;ensuring&nbsp;that&nbsp;the&nbsp;managed&nbsp;memory&nbsp;is&nbsp;not&nbsp;at&nbsp;any&nbsp;time&nbsp;being&nbsp;corrupted&nbsp;by&nbsp;unmanaged&nbsp;code.&nbsp;(the&nbsp;results,&nbsp;the&nbsp;final&nbsp;updated&nbsp;unmanaged&nbsp;meory&nbsp;object&nbsp;will&nbsp;be&nbsp;passed&nbsp;back&nbsp;by&nbsp;another&nbsp;mechanism,&nbsp;have&nbsp;to&nbsp;yet&nbsp;work&nbsp;on&nbsp;this&nbsp;)&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;BR&gt;I&nbsp;am&nbsp;tryingto&nbsp;do&nbsp;the&nbsp;second&nbsp;part&nbsp;described&nbsp;above&nbsp;as&nbsp;follows:&lt;/DIV&gt;<br>
&lt;DIV&gt;1)&nbsp;I&nbsp;figured&nbsp;that&nbsp;marshal.c&nbsp;is&nbsp;the&nbsp;place&nbsp;where&nbsp;IL&nbsp;code&nbsp;is&nbsp;being&nbsp;emitted&nbsp;to&nbsp;push&nbsp;the&nbsp;arguments&nbsp;before&nbsp;the&nbsp;call.&lt;/DIV&gt;<br>
&lt;DIV&gt;2)&nbsp;so,&nbsp;if&nbsp;an&nbsp;argument&nbsp;is&nbsp;passed&nbsp;by&nbsp;reference,&nbsp;am&nbsp;emitting&nbsp;IL&nbsp;code&nbsp;to&nbsp;make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;object&nbsp;in&nbsp;unmanaged&nbsp;memory&nbsp;and&nbsp;pass&nbsp;this.&lt;/DIV&gt;<br>
&lt;DIV&gt;I&nbsp;wrote&nbsp;code&nbsp;to&nbsp;emit&nbsp;IL&nbsp;code&nbsp;to&nbsp;achieve&nbsp;this&nbsp;and&nbsp;it&nbsp;errors&nbsp;out&nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;**&nbsp;(pinvref.exe:15147):&nbsp;WARNING&nbsp;**:&nbsp;implement&nbsp;me&nbsp;0x77&lt;/DIV&gt;<br>
&lt;DIV&gt;**&nbsp;ERROR&nbsp;**:&nbsp;file&nbsp;class.c:&nbsp;line&nbsp;2812&nbsp;(mono_class_from_mono_type):&nbsp;should&nbsp;not&nbsp;be&nbsp;reached&lt;BR&gt;aborting...&lt;BR&gt;Aborted&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;BR&gt;I&nbsp;am&nbsp;sending&nbsp;the&nbsp;code&nbsp;that&nbsp;I&nbsp;wrote.&nbsp;Can&nbsp;anyone&nbsp;tell&nbsp;me&nbsp;what&nbsp;I&nbsp;am&nbsp;doing&nbsp;wrong??&lt;/DIV&gt;<br>
&lt;DIV&gt;Here&nbsp;is&nbsp;the&nbsp;C&nbsp;code&nbsp;to&nbsp;emit&nbsp;IL&nbsp;code&nbsp;:&amp;nbsp;&nbsp;(&nbsp;for&nbsp;testing&nbsp;purposes,&nbsp;I&nbsp;directly&nbsp;did&nbsp;a&nbsp;g_malloc,to&nbsp;allocate&nbsp;unmanaged&nbsp;memory,&nbsp;instead&nbsp;of&nbsp;emitting&nbsp;a&nbsp;call&nbsp;to&nbsp;&quot;AllocCoTaskMem&quot;,&nbsp;which&nbsp;I&nbsp;have&nbsp;commented&nbsp;out&nbsp;.&nbsp;The&nbsp;emit_managed_call&nbsp;does&nbsp;work&nbsp;when&nbsp;I&nbsp;inspected&nbsp;the&nbsp;trace&nbsp;of&nbsp;execution&nbsp;)&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;BR&gt;&amp;nbsp;MonoType&nbsp;*t&nbsp;=&nbsp;sig-&amp;gt;params[argnum];&lt;BR&gt;&amp;nbsp;MonoClass&nbsp;*pclasee&nbsp;=&nbsp;mono_class_from_mono_type(t);&lt;BR&gt;&amp;nbsp;inst_size&nbsp;=&nbsp;pclass-&amp;gt;instance_size;&amp;nbsp;&amp;nbsp;&nbsp;/&nbsp;*&nbsp;not&nbsp;sure&nbsp;if&nbsp;i&nbsp;should&nbsp;use&nbsp;this&nbsp;or&nbsp;mono_class_value_size&nbsp;(klass,&nbsp;NULL)&nbsp;,&nbsp;have&nbsp;tried&nbsp;both!!&amp;nbsp;&nbsp;*/&lt;BR&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;um_mem&nbsp;=&nbsp;(MonoType&nbsp;*)g_malloc(inst_size);&lt;/DIV&gt;<br>
&lt;DIV&gt;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;EMITTING&nbsp;MEMORY&nbsp;ALLOC&nbsp;CALL&nbsp;:&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;pushing&nbsp;the&nbsp;alloc_size&nbsp;on&nbsp;stack&nbsp;for&nbsp;use&nbsp;by&nbsp;AllocCoTaskMem&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_LDC_I4_S);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;inst_size);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;klassAllocCoTaskMem=&nbsp;mono_class_from_name(mono_defaults.corlib,&quot;System.Runtime.InteropServices&quot;,&nbsp;&quot;Marshal&quot;);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;methodAllocCoTaskMem&nbsp;=&nbsp;mono_class_get_method_from_name(klassAllocCoTaskMem,&quot;AllocCoTaskMem&quot;,&nbsp;-1);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_managed_call(mb,methodAllocCoTaskMem,NULL);&amp;nbsp;&nbsp;*/&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;dest&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_icon(mb,um_mem);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;src*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_ldarg(mb,&nbsp;argnum);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte(mb,&nbsp;CEE_LDIND_REF);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&lt;BR&gt;&amp;nbsp;mono_mb_emit_byte(mb,&nbsp;CEE_STIND_REF);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;/*&nbsp;emit&nbsp;the&nbsp;call&nbsp;to&nbsp;push&nbsp;the&nbsp;NEW&nbsp;REFERENCE&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;emit_marshal&nbsp;(m,&nbsp;argnum,&nbsp;um_mem,&nbsp;spec,&nbsp;conv_arg,&nbsp;NULL,&nbsp;MARSHAL_ACTION_PUSH);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;ALSO&nbsp;tried&nbsp;the&nbsp;followng&nbsp;way&lt;BR&gt;&amp;nbsp;/*&nbsp;destination&nbsp;addr&nbsp;on&nbsp;stack&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_icon(mb,um_mem);&lt;BR&gt;&amp;nbsp;&lt;BR&gt;&amp;nbsp;/*&nbsp;source&nbsp;address&nbsp;*/&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_ldarg(mb,&nbsp;argnum);&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_icon&nbsp;(mb,&nbsp;inst_size);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_PREFIX1);&lt;BR&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_CPBLK);&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&gt;Thanks&nbsp;a&nbsp;lot&nbsp;for&nbsp;your&nbsp;time,&lt;/DIV&gt;<br>
&lt;DIV&gt;S&lt;/DIV&gt;&lt;/DIV&gt;&lt;p&gt;<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;hr&nbsp;size=1&gt;&nbsp;&lt;a&nbsp;href=&quot;http://us.lrd.yahoo.com/_ylc=X3oDMTFqODRtdXQ4BF9TAzMyOTc1MDIEX3MDOTY2ODgxNjkEcG9zAzEEc2VjA21haWwtZm9vdGVyBHNsawNmYw--/SIG=110oav78o/**http%3a//farechase.yahoo.com/&quot;&gt;Yahoo!&nbsp;FareChase&nbsp;-&nbsp;Search&nbsp;multiple&nbsp;travel&nbsp;sites&nbsp;in&nbsp;one&nbsp;click.&lt;/a&gt;<br>
<br>
&nbsp;<br>
<br>
&nbsp;
</tt>
