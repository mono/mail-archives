<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] cpblk?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jarek%40atm.com.pl">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="005973.html">
   <LINK REL="Next"  HREF="005977.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] cpblk?
   </H1>
    <B>Jaroslaw Kowalski
    </B> 
    <A HREF="mailto:jarek%40atm.com.pl"
       TITLE="[Mono-list] cpblk?">jarek@atm.com.pl
       </A><BR>
    <I>Sat, 25 May 2002 21:19:34 +0200 (CEST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="005973.html">[Mono-list] cpblk?
</A></li>
        <LI> Next message: <A HREF="005977.html">[Mono-list] cpblk?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5974">[ date ]</a>
              <a href="thread.html#5974">[ thread ]</a>
              <a href="subject.html#5974">[ subject ]</a>
              <a href="author.html#5974">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

It's not trivial to achieve maximum possible performance for such a
trivial task as memory block transfer. 

From my experience with game programming I can tell you that it's
generally best to completelly unroll copying for small data blocks of
constant size, that is to use a series of (interleaved) &quot;mov&quot;. 

When you have small data blocks to be moved (but the size isn't known
at compile time) it's generally best to &quot;rep movsb&quot; without any additional
logic. When you have larger blocks, it really pays off to optimize for
things like DWORD/QWORD alignment, cache prefetching (available in most
modern CPU architectures). Ideally you have specialized copy/move routines
for different architecures (Pentium, K6, Athlon, MMX, SSE, SSE2, etc.) and
just call (or emit the call to) the appropriate one. The cost of
&quot;call/ret&quot; is not relevant for new processors.

So when the size isn't known at compile time I suggest a simple compare
of the block size against some threshold and either &quot;rep movsb&quot; or call to
memmove() optimized for current processor architecture. 

If the size is known at compile time and it is small, just unroll the
loop. If the size is above some threshold, just call memmove().

Just my $0.05 ;-)

Jarek

On 25 May 2002, Miguel de Icaza wrote:

&gt;<i> &gt; &gt; memcpy already takes care of copying in the fastest way posible.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; That's right, but we still have a call, a ret, and a conditional or two ;-)
</I>&gt;<i> 
</I>&gt;<i> I was going to say exactly that ;-)
</I>&gt;<i> 
</I>&gt;<i> &gt; By inlining we can get rid of these things (especially if size is known up-front).
</I>&gt;<i> &gt; Moreover, due to JIT's dynamic nature it's possible to generate faster code at run-time.
</I>&gt;<i> &gt; For example, the following (generic) memcpy is faster on pre-Pentium x86s (Intel syntax):
</I>&gt;<i> &gt;   mov esi, $src
</I>&gt;<i> &gt;   mov ecx, $size
</I>&gt;<i> &gt;   mov edi, $dest
</I>&gt;<i> &gt;   shr ecx,1
</I>&gt;<i> &gt;   rep movsw
</I>&gt;<i> &gt;   adc cl,cl
</I>&gt;<i> &gt;   rep movsb
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; For const size==1 we could just mov al, [src]; mov [dest],al
</I>&gt;<i> &gt; etc.etc.
</I>&gt;<i> &gt; BTW, MS JIT uses similar optimizations for cpblk/initblk.
</I>&gt;<i> 
</I>&gt;<i> Exactly.  The same logic that lives in memmove() for the data size
</I>&gt;<i> quantum can be inlined by the JIT engine trivially.  
</I>&gt;<i> 
</I>&gt;<i> However, how often does this happen?  Until a couple of days ago we did
</I>&gt;<i> not have cpblk, so my guess is that measuring the performance impact
</I>&gt;<i> might not be immediately noticeable. 
</I>&gt;<i> 
</I>&gt;<i> I would very much like to see this at some point.
</I>&gt;<i> 
</I>&gt;<i> Miguel.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> 
</I>


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="005973.html">[Mono-list] cpblk?
</A></li>
	<LI> Next message: <A HREF="005977.html">[Mono-list] cpblk?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5974">[ date ]</a>
              <a href="thread.html#5974">[ thread ]</a>
              <a href="subject.html#5974">[ subject ]</a>
              <a href="author.html#5974">[ author ]</a>
         </LI>
       </UL>
</body></html>
