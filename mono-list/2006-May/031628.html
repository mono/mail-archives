<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Bug (?) in SqliteDataReader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Bug%20%28%3F%29%20in%20SqliteDataReader&In-Reply-To=VA.000027ce.00cdec6e%40trumphurst.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031626.html">
   <LINK REL="Next"  HREF="031630.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Bug (?) in SqliteDataReader</H1>
    <B>Joshua Tauberer</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Bug%20%28%3F%29%20in%20SqliteDataReader&In-Reply-To=VA.000027ce.00cdec6e%40trumphurst.com"
       TITLE="[Mono-list] Bug (?) in SqliteDataReader">tauberer at for.net
       </A><BR>
    <I>Mon May 15 08:33:06 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="031626.html">[Mono-list] Bug (?) in SqliteDataReader
</A></li>
        <LI>Next message: <A HREF="031630.html">[Mono-list] Bug (?) in SqliteDataReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31628">[ date ]</a>
              <a href="thread.html#31628">[ thread ]</a>
              <a href="subject.html#31628">[ subject ]</a>
              <a href="author.html#31628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Nikki,

Nikki Locke wrote:
&gt;<i> I use the Sqlite database under both Windows and Linux. Under Windows, if I 
</I>&gt;<i> have a date or datetime field, then row data returned from a query on that 
</I>&gt;<i> field is returned as a DateTime. Under Linux, it is returned as a string. 
</I>
Are you sure you have the same version of mono (esp.
Mono.Data.SqliteClient) *and* Sqlite (the native library) on both
systems?  The way DateTimes are handled depends on a lot, unfortunately,
because Sqlite doesn't have a way of storing datetimes natively.  The
recommended way of using DateTimes with Sqlite is to encode/decode them
yourself in a natural way either to/from a long or some particular
string format that you decide.

There are two versions of Sqlite.  Sqlite2 only has strings internally,
which is probably what you're seeing in Linux.  The DateTimes are being
coerced into a string at some point, and it's choosing a
culture-sensitive format.  When reading back the data, there's no way to
know that it was originally a DateTime and not a string, so it returns
the string.  Using Sqlite2, you really can't use DateTimes without
encoding them yourself.

Sqlite3 has string, integer, and real internal storage types, but that
doesn't help when reading to determine that a value was originally a
datetime.  But Sqlite3 also provides the names of the types of the
columns as the table was created with.  If a column is declared as a
DATE or DATETIME, SqliteDataReader will try to turn the value back into
a DateTime.  This is probably what you're seeing in Windows.  If it
finds an integer value, it uses DateTime.FromFileTime, which is the
reverse of how it encodes DateTimes if you insert a DateTime via
parameters.  If it finds a string value, it uses DateTime.Parse -- but
note that this is a very slow operation.  So with Sqlite3, DateTimes
should be put into DATE or DATETIME columns in the database either
through parameters or by turning it into a long with ToFileTime
yourself, and then they will be read back as DateTimes.

&gt;<i> This appears to be a bug in SqliteDataReader.GetSchemaTable, which sets 
</I>&gt;<i> schemaRow[&quot;DataType&quot;] to typeof(string) for every field, regardless.
</I>
For Sqlite2, that's correct because everything goes in and comes back as
a string.  For Sqlite3, it's impossible to know what kind of values are
actually going to be encountered in a column (e.g. DATETIME columns can
have float values), so strings is the best guess.  It might be possible
to do some guessing for GetSchemaTable, but I don't know the purpose of
that method so I don't want to play around with it (unless someone
explains it to me).

&gt;<i> I have copied the entire 
</I>&gt;<i> mcs/class/Mono.Data.SqliteClient/Mono.Data.SqliteClient diretory into my 
</I>&gt;<i> project, applied the fix below, and recompiled, and it now works as I would 
</I>&gt;<i> expect.
</I>
I'd want to understand more about how you're putting the values into the
database and how you're reading them before looking more into the patch.
 Also, in Windows, are you using the Mono runtime or MS?  I'm just not
sure where the bug really is, in Mono.Data.SqliteClient or elsewhere.

-- 
- Joshua Tauberer

<A HREF="http://taubz.for.net">http://taubz.for.net</A>

&quot;Unfortunately, we're having this discussion. It's too bad,
because guess who listens to the discussion: the enemy.&quot;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031626.html">[Mono-list] Bug (?) in SqliteDataReader
</A></li>
	<LI>Next message: <A HREF="031630.html">[Mono-list] Bug (?) in SqliteDataReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31628">[ date ]</a>
              <a href="thread.html#31628">[ thread ]</a>
              <a href="subject.html#31628">[ subject ]</a>
              <a href="author.html#31628">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
