<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Memory Allocation in unmanaged code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jfehlig%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="023200.html">
   <LINK REL="Next"  HREF="023205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Memory Allocation in unmanaged code
   </H1>
    <B>Jim Fehlig
    </B> 
    <A HREF="mailto:jfehlig%40novell.com"
       TITLE="[Mono-list] Memory Allocation in unmanaged code">jfehlig@novell.com
       </A><BR>
    <I>Wed, 08 Sep 2004 15:43:48 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="023200.html">[Mono-list] Documentation tool
</A></li>
        <LI> Next message: <A HREF="023205.html">[Mono-list] Memory Allocation in unmanaged code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23180">[ date ]</a>
              <a href="thread.html#23180">[ thread ]</a>
              <a href="subject.html#23180">[ subject ]</a>
              <a href="author.html#23180">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a MIME message. If you are reading this text, you may want to 
consider changing to a mail reader or gateway that understands how to 
properly handle MIME multipart messages.

--=__Part6F4F1C04.0__=
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit

&gt;&gt;&gt;<i>Jonathan Pryor &lt;<A HREF="mailto:jonpryor@vt.edu">jonpryor@vt.edu</A>&gt; 09/06/04 4:57 pm &gt;&gt;&gt; 
</I> 
&gt;<i>Correctness depends upon the ListLocalPrinters() documentation.  What
</I>is 
&gt;<i>`printerList' supposed to be?  Just a pointer to a 
</I>&gt;<i>CupsPrinterListStruct*?  Or should it be an array of pointers?  How
</I>many 
&gt;<i>elements will be addressed? 
</I> 
Thanks for your insights and observations - very informative.  As you 
deduced, printerList is a pointer to a CupsPrinterListStruct*.  I 
modified the wrapper implementation to use unsafe code but still 
unsuccessful in retrieving properties from the C# structure below. 
The unmanaged ListLocalPrinters is returning a list containing 1 
element yet the loop in PrintLibWrapper.ListLocalPrinters is executed 
twice, throwing a NullReferenceException when printer =
printer-&gt;nextElement 
is executed on the second pass.  Further, a NullReferenceException is 
thrown on the first iteration through the loop by simply invoking 
Console.WriteLine(PrinterInfo: {0}, {1}, pl.Name, pl.Uri). 
I have tried several attributes on the structure elements with no change

in behavior.  I believe the problem is in the marshalling attributes,
but 
I have yet to discover how to examine the memory in mono on linux. 
Installing/configuring a windows client and running/debugging there 
may be the easiest path. 
 
Thanks again for the help. 
Jim 
 
// interop struct 
[ StructLayout(LayoutKind.Sequential) ] 
private*unsafe*struct*InternalPrinterList 
{ 
   [MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, SizeConst=1024)] 
   public string printerUri; 
 
   [MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, SizeConst=1024)] 
   public string printerCupsUri; 
 
   [MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, SizeConst=1024)] 
   public string printerName; 
 
   [MarshalAs(UnmanagedType.ByValTStr/*LPStr*/,SizeConst=81)] 
   public*string*printerMakeModel; 
 
   [MarshalAs(UnmanagedType.U4)] 
   public InternalPrinterList *nextElement; 
} 
 
// Convert linked list constructed by unmanaged code to 
// array of user-visible PrinterList objects. 
public static unsafe PrinterList[] ListLocalPrinters() 
{ 
   IntPtr list = IntPtr.Zero; 
   try 
   { 
      ListLocalPrinters(ref list); 
      InternalPrinterList* printer = (InternalPrinterList *)list; 
      ArrayList printers = new ArrayList(); 
      while (printer != null) 
      { 
         PrinterList pl = new PrinterList(); 
         pl.Uri = printer-&gt;printerUri; 
         pl.CupsUri = printer-&gt;printerCupsUri; 
         pl.Name = printer-&gt;printerName; 
         pl.MakeModel = printer-&gt;printerMakeModel; 
         // throws NullReferenceException 
         Console.WriteLine(PrinterInfo: {0}, {1}, pl.Name, pl.Uri); 
 
         printers.Add(pl); 
         // Something not right here as we will go through again 
         // even when list contains only 1 element. 
         printer = printer-&gt;nextElement; 
       } 
       PrinterList[] rval = new PrinterList[printers.Count]; 
       printers.CopyTo(rval); 
       return rval; 
   } 
   catch (Exception e) 
   { 
       return new PrinterList[0]; 
   } 
   finally 
   { 
      if (list != IntPtr.Zero) 
         FreeLocalPrinterList(list); 
   } 
} 


--=__Part6F4F1C04.0__=
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: quoted-printable

&lt;html&gt;
  &lt;head&gt;
   =20
  &lt;/head&gt;
  &lt;body style=3D&quot;margin-bottom: 1px; margin-right: 4px; margin-left: 4px; =
margin-top: 4px&quot;&gt;
  &lt;DIV&gt;    &amp;gt;&amp;gt;&amp;gt;Jonathan Pryor &amp;lt;<A HREF="mailto:jonpryor@vt.edu">jonpryor@vt.edu</A>&amp;gt; 09/06/04 =
4:57 pm &amp;gt;&amp;gt;&amp;gt;

    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;    &amp;gt;Correctness depends upon the ListLocalPrinters() =
documentation.&amp;#160;&amp;nbsp;What is
    &lt;DIV&gt;&amp;gt;`printerList' supposed to be?&amp;#160;&amp;nbsp;Just a pointer to a
    &lt;DIV&gt;&amp;gt;CupsPrinterListStruct*?&amp;#160;&amp;nbsp;Or should it be an array =
of pointers?&amp;#160;&amp;nbsp;How many
    &lt;DIV&gt;&amp;gt;elements will be addressed?

    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      Thanks for your insights and observations - very informative. =
&amp;nbsp;As you
    &lt;/DIV&gt;
    &lt;DIV&gt;
      deduced, &amp;quot;printerList&amp;quot; is a pointer to a CupsPrinterListStr=
uct*. &amp;nbsp;I
    &lt;/DIV&gt;
    &lt;DIV&gt;
      modified the wrapper implementation to use &amp;quot;unsafe&amp;quot; code =
but still
    &lt;/DIV&gt;
    &lt;DIV&gt;
      unsuccessful in retrieving properties from the C# structure below.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      The unmanaged ListLocalPrinters is returning a list containing 1
    &lt;/DIV&gt;
    &lt;DIV&gt;
      element yet the loop in PrintLibWrapper.ListLocalPrinters is =
executed
    &lt;/DIV&gt;
    &lt;DIV&gt;
      twice, throwing a NullReferenceException when &amp;quot;printer =3D =
printer-&amp;gt;nextElement&amp;quot;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      is executed on the second pass. &amp;nbsp;Further, a NullReferenceExcepti=
on is
    &lt;/DIV&gt;
    &lt;DIV&gt;
      thrown on the first iteration through the loop by simply invoking
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;quot;Console.WriteLine(&amp;quot;PrinterInfo: {0}, {1}&amp;quot;, pl.Name, =
pl.Uri)&amp;quot;.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      I have tried several attributes on the structure elements with no =
change
    &lt;/DIV&gt;
    &lt;DIV&gt;
      in behavior. &amp;nbsp;I believe the problem is in the marshalling =
attributes, but
    &lt;/DIV&gt;
    &lt;DIV&gt;
      I have yet to discover how to examine the memory in mono on linux.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      Installing/configuring a windows client and running/debugging there
    &lt;/DIV&gt;
    &lt;DIV&gt;
      may be the easiest path.
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      Thanks again for the help.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      Jim
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      // interop struct
    &lt;/DIV&gt;
    &lt;DIV&gt;
      [ StructLayout(LayoutKind.Sequential) ]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      private&amp;#65533;unsafe&amp;#65533;struct&amp;#65533;InternalPrinterList
    &lt;/DIV&gt;
    &lt;DIV&gt;
      {
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, =
SizeConst=3D1024)]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public string printerUri;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, =
SizeConst=3D1024)]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public string printerCupsUri;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[MarshalAs(UnmanagedType.ByValTStr/*LPStr*/, =
SizeConst=3D1024)]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public string printerName;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[MarshalAs(UnmanagedType.ByValTStr/*LPStr*/,SizeCon=
st=3D81)]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public&amp;#65533;string&amp;#65533;printerMakeModel;
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;[MarshalAs(UnmanagedType.U4)]
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;public InternalPrinterList *nextElement;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      }
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      // Convert linked list constructed by unmanaged code to
    &lt;/DIV&gt;
    &lt;DIV&gt;
      // array of user-visible PrinterList objects.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      public static unsafe PrinterList[] ListLocalPrinters()
    &lt;/DIV&gt;
    &lt;DIV&gt;
      {
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;IntPtr list =3D IntPtr.Zero;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;try
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ListLocalPrinters(ref list);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;InternalPrinterList* printer =3D =
(InternalPrinterList *)list;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;ArrayList printers =3D new =
ArrayList();
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;while (printer !=3D null)
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;PrinterList pl =
=3D new PrinterList();
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pl.Uri =3D =
printer-&amp;gt;printerUri;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pl.CupsUri =3D =
printer-&amp;gt;printerCupsUri;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pl.Name =3D =
printer-&amp;gt;printerName;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;pl.MakeModel =
=3D printer-&amp;gt;printerMakeModel;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// throws =
NullReferenceException=20
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Console.WriteLi=
ne(&amp;quot;PrinterInfo: {0}, {1}&amp;quot;, pl.Name, pl.Uri);
    &lt;/DIV&gt;
    &lt;DIV&gt;&amp;nbsp;&lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printers.Add(pl=
);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// Something =
not right here as we will go through again
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;// even when =
list contains only 1 element.
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printer =3D =
printer-&amp;gt;nextElement;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;PrinterList[] rval =3D new =
PrinterList[printers.Count];
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;printers.CopyTo(rval);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return rval;
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;catch (Exception e)
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return new PrinterList[0];
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;finally
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;{
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;if (list !=3D IntPtr.Zero)
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;FreeLocalPrinte=
rList(list);
    &lt;/DIV&gt;
    &lt;DIV&gt;
      &amp;nbsp;&amp;nbsp;&amp;nbsp;}
    &lt;/DIV&gt;
    &lt;DIV&gt;
      }
    &lt;/DIV&gt;
  &lt;/body&gt;
&lt;/html&gt;

--=__Part6F4F1C04.0__=--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="023200.html">[Mono-list] Documentation tool
</A></li>
	<LI> Next message: <A HREF="023205.html">[Mono-list] Memory Allocation in unmanaged code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23180">[ date ]</a>
              <a href="thread.html#23180">[ thread ]</a>
              <a href="subject.html#23180">[ subject ]</a>
              <a href="author.html#23180">[ author ]</a>
         </LI>
       </UL>
</body></html>
