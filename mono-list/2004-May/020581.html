<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] InteropServices: DllNotFoundException...?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="020477.html">
   <LINK REL="Next"  HREF="020585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] InteropServices: DllNotFoundException...?
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] InteropServices: DllNotFoundException...?">jonpryor@vt.edu
       </A><BR>
    <I>Sun, 23 May 2004 00:01:32 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="020477.html">[Mono-list] InteropServices: DllNotFoundException...?
</A></li>
        <LI> Next message: <A HREF="020585.html">[Mono-list] InteropServices: DllNotFoundException...?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20581">[ date ]</a>
              <a href="thread.html#20581">[ thread ]</a>
              <a href="subject.html#20581">[ subject ]</a>
              <a href="author.html#20581">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2004-05-20 at 17:47, Simon Ask Ulsnes wrote:
&lt;snip/&gt;
&gt;<i> Of course, I'm using InteropServices to interact with a C library. I 
</I>&gt;<i> made a few wrapper functions in the library, and the basic ones (such as 
</I>&gt;<i> checking the library version and such) work well. But after I added the 
</I>&gt;<i> latest (GetKeyNames and GetKeyXML), loading the library starts shouting 
</I>&gt;<i> Exceptions - namely DllNotFoundException. Yes, the library is in place.
</I>
So, it worked at one point, but when you wrapped GetKeyNames and
GetKeyXML, *then* it started to fail?  Is this correct?

What's possible is that you're encountering the mix of two issues.  The
first issue is that, IIRC, when DllNotFoundException is thrown it only
contains the *initial* library that the runtime attempted to load, *not*
the actual library which couldn't found.

Meaning if libA.so depends on libB.so, libA.so is present but libB.so
isn't, DllNotFoundException will give the error stating that libA.so
couldn't be found.

I believe this will be fixed in the next release of Mono.

The second issue is basically the first: one of the dependent libraries
likely can't be found.

Run &quot;ldd libsector.so&quot;, and make sure that *all* dependent libraries can
be found.

&gt;<i> I'm think I'm making a mistake in writing the C library part properly, 
</I>&gt;<i> but what exactly is it I'm doing wrong?
</I>
I'm not entirely sure why you're seeing DllNotFoundException; see above
for a possible explanation.

However, there is another issue present: strings.  Your DllImport
declarations specify that System.String is the return type.  This will
cause the runtime to attempt to free the strings returned by those
functions.  IIRC, Mono will use g_free() to free that memory.  If those
strings weren't allocated by g_malloc(), this could lead to heap
corruption.

Even worse, it's not portable.  .NET uses CoTaskMemAlloc() and
CoTaskMemFree() to handle memory returned in this fashion, which I
assume GPGME won't be using.

The solution is simple: don't use strings.  Use System.IntPtr and use
System.Runtime.InteropServices.Marshal.PtrToStringAnsi():

	[DllImport(&quot;libsecstor.so&quot;)]
	private static extern IntPtr GetKeyNames();

	private static string RealGetKeyNames ()
	{
		IntPtr r = GetKeyNames ();
		string s = Marshal.PtrToStringAnsi (r);
		// Free `r' as appropriate
	}

If the string returned by GetKeyNames() is in UTF-8, you may need
alternate processing.  Seeing how Gtk# does this would be useful.

See <A HREF="http://www.jprl.com/~jon/interop.html">http://www.jprl.com/~jon/interop.html</A> for more information.

 - Jon



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="020477.html">[Mono-list] InteropServices: DllNotFoundException...?
</A></li>
	<LI> Next message: <A HREF="020585.html">[Mono-list] InteropServices: DllNotFoundException...?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20581">[ date ]</a>
              <a href="thread.html#20581">[ thread ]</a>
              <a href="subject.html#20581">[ subject ]</a>
              <a href="author.html#20581">[ author ]</a>
         </LI>
       </UL>
</body></html>
