<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] mod_mono stability problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20mod_mono%20stability%20problems&In-Reply-To=BA656526-68CC-44D8-814B-6B15E7AF5892%40usefulbits.nl">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038542.html">
   <LINK REL="Next"  HREF="038553.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] mod_mono stability problems</H1>
    <B>Micha&#322; Ziemski</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20mod_mono%20stability%20problems&In-Reply-To=BA656526-68CC-44D8-814B-6B15E7AF5892%40usefulbits.nl"
       TITLE="[Mono-list] mod_mono stability problems">rook at roo.k.pl
       </A><BR>
    <I>Fri May 16 04:47:42 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="038542.html">[Mono-list]  mod_mono stability problems
</A></li>
        <LI>Next message: <A HREF="038553.html">[Mono-list] mod_mono stability problems (some supposition)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38543">[ date ]</a>
              <a href="thread.html#38543">[ thread ]</a>
              <a href="subject.html#38543">[ subject ]</a>
              <a href="author.html#38543">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

1,5 gb ram after 800 requests? Seems like you are not releasing your 
objects properly.
Maybe try running with HeapShot (<A HREF="http://www.mono-project.com/HeapShot">http://www.mono-project.com/HeapShot</A>) 
to diagnose the problem.

I have a site running mod_mono serving ~1k requests/day and have not yet 
seen it allocate more than 100mb.

I can confirm the existence of the latter problem (problem with restart 
- apache returning 503).

Best regards!
Micha&#322; Ziemski

Oscar van Tol pisze:
&gt;<i> Hi there and thanks for the advice,
</I>&gt;<i>
</I>&gt;<i>  &gt; &gt; For the past two months we've been hosting a webservice  
</I>&gt;<i> application on
</I>&gt;<i>  &gt; &gt; apache2 and mod_mono.
</I>&gt;<i>  &gt; &gt; Since this week we have some real traffic, and stability issues
</I>&gt;<i>  &gt; &gt; started. We now have about 30.000 requests a day, these make the  
</I>&gt;<i> mono
</I>&gt;<i>  &gt; &gt; process grow in memory usage to about 2gigs. and the response  
</I>&gt;<i> becomes
</I>&gt;<i>  &gt; &gt; really bad.
</I>&gt;<i>  &gt; You might want to increase the thread pool size by setting the  
</I>&gt;<i> MONO_THREADS_PER_CPU
</I>&gt;<i>  &gt; environment variable to a value higher than the default 5 (the  
</I>&gt;<i> formula for
</I>&gt;<i>  &gt; calculating the number of threads in the pool is 20 +  
</I>&gt;<i> ($MONO_THREADS_PER_CPU *
</I>&gt;<i>  &gt; number_of_cpus)
</I>&gt;<i> The application feels a bit faster now, but with a lot of traffic it  
</I>&gt;<i> still sometimes does not come back after the autorestart
</I>&gt;<i>  &gt; &gt; The memory problem is probably cause by the none compacting garbage
</I>&gt;<i>  &gt; &gt; collector, I solved the performance issue by doing an autorestart
</I>&gt;<i>  &gt; &gt; every 400 requests. This works great for a while but after a few  
</I>&gt;<i> auto-
</I>&gt;<i>  &gt; That sounds quite often - I think 1000 would be quite enough in  
</I>&gt;<i> your case.
</I>&gt;<i> With about 800 requests it uses 1.5gb of ram and the performance  
</I>&gt;<i> decreases..
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  &gt; &gt; restarts it lookes live apache failes to spawn a new mod-mono- 
</I>&gt;<i> server.
</I>&gt;<i>  &gt; &gt; Apache respondes with a 503, when I kill the (old still running)   
</I>&gt;<i> mono
</I>&gt;<i>  &gt; &gt; process and restart apache it's back.
</I>&gt;<i>  &gt; &gt;
</I>&gt;<i>  &gt; &gt; Suggestions?
</I>&gt;<i>  &gt; It's hard to determine what it is just from the description - it  
</I>&gt;<i> might be a
</I>&gt;<i>  &gt; deadlock, might be a memory issue with shared memory. Please  
</I>&gt;<i> compile mod_mono with
</I>&gt;<i>  &gt; - --enable-debug and post apache logs when the 503 happens - that  
</I>&gt;<i> should make it
</I>&gt;<i>  &gt; easier to diagnose what's going on.
</I>&gt;<i> I recompiled on debug, it looks like a deadlock:
</I>&gt;<i> [Thu May 15 23:53:40 2008] [warn] No backend found, will start a new  
</I>&gt;<i> copy.
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Socket file name /tmp/ 
</I>&gt;<i> mod_mono_server_global
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] try_connect: -1
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] After setup_socket
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] No backend found, will start a new  
</I>&gt;<i> copy.
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Acquiring the /tmp/ 
</I>&gt;<i> mod_mono_dashboard_XXGLOBAL_1.lock lock for bac
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Socket file name /tmp/ 
</I>&gt;<i> mod_mono_server_global
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] try_connect: -1
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] forking XXGLOBAL
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Applications: (null)
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Config file: (null)
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Config dir.: /etc/mono-server2
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Listen port: (null)
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Listen address: (null)
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] child started
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] PATH: /usr/local/bin:/usr/bin:/bin
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] serverdir: /opt/mono-1.9/bin
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] PATH after: /opt/mono-1.9/bin:/usr/ 
</I>&gt;<i> local/bin:/usr/bin:/bin
</I>&gt;<i> [Thu May 15 23:53:42 2008] [warn] Started new backend, sleeping 2s to  
</I>&gt;<i> let it configure
</I>&gt;<i> [Thu May 15 23:53:44 2008] [warn] Socket file name /tmp/ 
</I>&gt;<i> mod_mono_server_global
</I>&gt;<i> [Thu May 15 23:53:44 2008] [warn] try_connect: -1
</I>&gt;<i> [Thu May 15 23:53:44 2008] [warn] After setup_socket
</I>&gt;<i> [Thu May 15 23:53:44 2008] [warn] No backend found, will start a new  
</I>&gt;<i> copy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>   
</I>
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038542.html">[Mono-list]  mod_mono stability problems
</A></li>
	<LI>Next message: <A HREF="038553.html">[Mono-list] mod_mono stability problems (some supposition)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38543">[ date ]</a>
              <a href="thread.html#38543">[ thread ]</a>
              <a href="subject.html#38543">[ subject ]</a>
              <a href="author.html#38543">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
