<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Unit tests load a different configuration file	under mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Unit%20tests%20load%20a%20different%20configuration%20file%0A%09under%20mono&In-Reply-To=%3C88D74E98-E96E-48E5-8099-DAEAEFC6DA2F%40asme.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="050183.html">
   <LINK REL="Next"  HREF="050181.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Unit tests load a different configuration file	under mono</H1>
    <B>David Curylo</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-list%5D%20Unit%20tests%20load%20a%20different%20configuration%20file%0A%09under%20mono&In-Reply-To=%3C88D74E98-E96E-48E5-8099-DAEAEFC6DA2F%40asme.org%3E"
       TITLE="[Mono-list] Unit tests load a different configuration file	under mono">curylod at asme.org
       </A><BR>
    <I>Mon Aug 12 22:22:26 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="050183.html">[Mono-list] Unit tests load a different configuration file	under mono
</A></li>
        <LI>Next message: <A HREF="050181.html">[Mono-list] Mono image scaling quality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50184">[ date ]</a>
              <a href="thread.html#50184">[ thread ]</a>
              <a href="subject.html#50184">[ subject ]</a>
              <a href="author.html#50184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've looked quite a bit more into this today.  It can be reproduced simply with this (nothing to do with unit tests or shadow copies as you said, just happens when something in System.Web tries to read the configuration):

	class MainClass
	{
		public static void Main (string[] args)
		{
			var dom1 = AppDomain.CreateDomain (&quot;dom1&quot;);
			var myCls = dom1.CreateInstanceAndUnwrap (&quot;ConfigTesting&quot;, &quot;ConfigTesting.MyClass&quot;) as MyClass;
			myCls.ReadConfigSettingWeb();
		}
	}
	class MyClass : MarshalByRefObject
	{
		public void ReadConfigSettingWeb() {
			var c = System.Web.Util.HttpEncoder.Current;
			var connStr = ConfigurationManager.ConnectionStrings[&quot;myconn&quot;];
			if(connStr == null)
				throw new ConfigurationErrorsException(&quot;myconn is not found&quot;);
		}

	}

The statement &quot;var c = System.Web.Util.HttpEncoder.Current&quot; forces it to load the configuration, which works fine in the root AppDomain, but fails when run in a second AppDomain.  After staring at profiler output all day and comparing with source, I am looking in the direction of the WebConfigurationHost.InitForConfiguration method.  I suspect something here is redirecting the configuration when in an app domain like it would if it were in an ASP.NET virtual application, and if it can't find a config file in whatever path it's looking (erroneously) it will fallback on the machine.config.  I haven't been able to get the runtime setup so I can step through all of this, but will do that soon.

On Aug 10, 2013, at 4:42 AM, Andr&#233;s G. Aragoneses &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">knocte at gmail.com</A>&gt; wrote:

&gt;<i> On 10/08/13 10:40, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;<i> 
</I>&gt;<i> Wrong URL, I meant this one: <A HREF="https://github.com/mono/mono/pull/643">https://github.com/mono/mono/pull/643</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="050183.html">[Mono-list] Unit tests load a different configuration file	under mono
</A></li>
	<LI>Next message: <A HREF="050181.html">[Mono-list] Mono image scaling quality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50184">[ date ]</a>
              <a href="thread.html#50184">[ thread ]</a>
              <a href="subject.html#50184">[ subject ]</a>
              <a href="author.html#50184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
