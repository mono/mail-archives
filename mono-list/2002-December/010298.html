<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Patch for &lt;remove/&gt; support in .config files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="010297.html">
   <LINK REL="Next"  HREF="010299.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Patch for &lt;remove/&gt; support in .config files
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Mono-list] Patch for &lt;remove/&gt; support in .config files">jonpryor@vt.edu
       </A><BR>
    <I>12 Dec 2002 21:07:34 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="010297.html">[Mono-list] Mono wallpapers
</A></li>
        <LI> Next message: <A HREF="010299.html">[Mono-list] Problems with reads being non-blocking in Mono?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10298">[ date ]</a>
              <a href="thread.html#10298">[ thread ]</a>
              <a href="subject.html#10298">[ subject ]</a>
              <a href="author.html#10298">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-25FBwe9m5oyQx7t2vtCy
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Attached is a patch to fix &lt;remove/&gt; support in .config files.

The problem, in summary, is that the test against `removedMark' is
incorrect.  The stored factory object isn't set to `removedMark' until
after the test (ConfigurationSettings.cs:380), so a section could never
be set to `removedMark' under the current code.

Also attached is a .config file sample program I'm working on that
illustrates proper behavior.  With the patch applied the programs
completes.  Without the patch a `ConfigurationException' is generated
from the &lt;remove/&gt; statement in the .config file.

Should I apply this?

 - Jon


--=-25FBwe9m5oyQx7t2vtCy
Content-Disposition: attachment; filename=config-settings.diff
Content-Type: text/x-patch; name=config-settings.diff; charset=UTF-8
Content-Transfer-Encoding: 7bit

Index: mcs/class/System/System.Configuration/ConfigurationSettings.cs
===================================================================
RCS file: /cvs/public/mcs/class/System/System.Configuration/ConfigurationSettings.cs,v
retrieving revision 1.16
diff -u -r1.16 ConfigurationSettings.cs
--- mcs/class/System/System.Configuration/ConfigurationSettings.cs	4 Nov 2002 23:49:25 -0000	1.16
+++ mcs/class/System/System.Configuration/ConfigurationSettings.cs	13 Dec 2002 02:01:32 -0000
@@ -374,7 +374,7 @@
 				removeValue = sectionName + '/' + removeValue;
 
 			object o = LookForFactory (removeValue);
-			if (o != null &amp;&amp; o != removedMark)
+			if (o != null &amp;&amp; o == removedMark)
 				ThrowException (&quot;No factory for &quot; + removeValue, reader);
 
 			factories [removeValue] = removedMark;

--=-25FBwe9m5oyQx7t2vtCy
Content-Disposition: attachment; filename=switch-test.exe.config
Content-Type: text/plain; name=switch-test.exe.config; charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;configuration&gt;
  &lt;configSections&gt;
    &lt;section name=&quot;remove-me&quot;
      type=&quot;System.Configuration.IgnoreSectionHandler&quot;/&gt;
    &lt;remove name=&quot;remove-me&quot;/&gt;
  &lt;/configSections&gt;
&lt;/configuration&gt;


--=-25FBwe9m5oyQx7t2vtCy
Content-Disposition: attachment; filename=switch-test.cs
Content-Type: text/plain; name=switch-test.cs; charset=UTF-8
Content-Transfer-Encoding: 7bit

// Test switches...

using System;
using System.Diagnostics;
using System.Configuration;
using System.Collections;

public class SwitchTest {
  private static BooleanSwitch bs = new BooleanSwitch (&quot;bool-switch&quot;, &quot;This is a boolean switch&quot;);
  private static TraceSwitch ts = new TraceSwitch (&quot;trace-switch&quot;, &quot;This is a trace switch&quot;);

  private static void PrintDictionary (int indent, IDictionary d) {
    string s = new string (' ', indent);
    foreach (DictionaryEntry e in d) {
      Console.WriteLine (&quot;{0}{1}={2}&quot;, s, e.Key, e.Value);
      IDictionary ed = e.Value as IDictionary;
      if (ed != null) {
        PrintDictionary (indent+1, ed);
      }
    }
  }

  private static void GetConfigSection (string s, int indent) {
    Console.WriteLine (&quot;getting section: &quot; + s);
    object o = ConfigurationSettings.GetConfig (s);
    if (o != null) {
      Console.WriteLine (&quot; typeof(GetConfig(\&quot;{0}\&quot;))=&quot;, s, o);
      IDictionary d = o as IDictionary;
      if (d != null)
        PrintDictionary (indent, (IDictionary) o);
    }
    else {
      Console.WriteLine (&quot; cannot open section: {0}&quot;, s);
    }
  }

  public static void Main () {
    // Test the switches...
    /*
    Type t = typeof (TextWriterTraceListener);
    Console.WriteLine (&quot;type='{0}'&quot;, t.AssemblyQualifiedName);
     */
    Console.WriteLine (&quot;bs level: &quot; + bs.Enabled);
    Console.WriteLine (&quot;ts level: &quot; + ts.Level);

    Console.WriteLine (&quot;-system.diagnostics configuration section-&quot;);
    GetConfigSection (&quot;system.diagnostics&quot;, 0);

    Console.WriteLine (&quot;-appSettings configuration section-&quot;);
    System.Collections.Specialized.NameValueCollection nvc = ConfigurationSettings.AppSettings;
    foreach (string s in nvc)
      Console.WriteLine (&quot;{0}={1}&quot;, s, nvc[s]);

    Console.WriteLine (&quot;-custom sections-&quot;);
    // this must be kept in sync with the .config file
    string[] sections = {&quot;sample-section&quot;, &quot;another-section&quot;, &quot;group/section&quot;};
    foreach (string s in sections) {
      GetConfigSection (s, 1);
    }
  }
}


--=-25FBwe9m5oyQx7t2vtCy--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="010297.html">[Mono-list] Mono wallpapers
</A></li>
	<LI> Next message: <A HREF="010299.html">[Mono-list] Problems with reads being non-blocking in Mono?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10298">[ date ]</a>
              <a href="thread.html#10298">[ thread ]</a>
              <a href="subject.html#10298">[ subject ]</a>
              <a href="author.html#10298">[ author ]</a>
         </LI>
       </UL>
</body></html>
