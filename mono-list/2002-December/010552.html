<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Mono/.NET delegate incompatibility
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:piersh%40friskit.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="010551.html">
   <LINK REL="Next"  HREF="010553.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Mono/.NET delegate incompatibility
   </H1>
    <B>Piers Haken
    </B> 
    <A HREF="mailto:piersh%40friskit.com"
       TITLE="[Mono-list] Mono/.NET delegate incompatibility">piersh@friskit.com
       </A><BR>
    <I>Thu, 19 Dec 2002 14:25:23 -0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="010551.html">[Mono-list] void* conversion from IntPtr
</A></li>
        <LI> Next message: <A HREF="010553.html">[Mono-list] CreateChildControls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10552">[ date ]</a>
              <a href="thread.html#10552">[ thread ]</a>
              <a href="subject.html#10552">[ subject ]</a>
              <a href="author.html#10552">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------_=_NextPart_001_01C2A7AD.85C5DB74
Content-Type: text/plain;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

you're right, in order to remain compatible, mono should use stdcall
convention by default on win32. (existing code, etc...)

piers.

-----Original Message-----
From: J. Perkins [mailto:<A HREF="mailto:jason@379.com">jason@379.com</A>]
Sent: Thursday, December 19, 2002 11:42 AM
To: J. Perkins
Cc: 'Mono-L'
Subject: RE: [Mono-list] Mono/.NET delegate incompatibility


Hang on a minute, I answered this too soon. I'm not talking about
calling a DLL function. [DllImport] works just fine on both Windows and
Linux. I am talking about a callback function, from unmanaged -&gt; managed
code. That is, a C# delegate passed to and called from unmanaged code
via a function pointer. Here's a usenet thread on the subject:

 <A HREF="http://makeashorterlink.com/?C417214D2">http://makeashorterlink.com/?C417214D2</A>

The problem described in this thread is reversed for Mono: the callback
must use the cdecl convention. Because of this, there is no way to write
a C function that can call a delegate under both .NET and Mono. If I do
this:

  int SomeCFunction(int (__stdcall *callback)(int, int, int))
  {  return callback(1,2,3); }

...it will corrupt the stack when run under Mono on Windows. If I use
cdecl instead:

  int SomeCFunction(int (*callback)(int, int, int))
  { return callback(1,2,3); }

...it will corrupt the stack when run under .NET. Maybe I'm missing
something (quite possible), but it appears that Mono must use __stdcall
for delegates on Windows.

I'll give you guys a chance to sanity check my rambling. If it holds up
I will file a bug.=20

Jason
379


&gt;<i> &gt; I guess the default calling convention in mono is cdecl.  According
</I>to
&gt;<i> &gt; MSDN, the default calling convention for dllimport should be stdcall
</I>&gt;<i> &gt; (which IMHO really only makes sense on windows).
</I>&gt;<i> &gt;=20
</I>&gt;<i> &gt; You could try setting the CallingConvention property on the
</I>DllImport to
&gt;<i> &gt; cdecl.
</I>



_______________________________________________
Mono-list maillist  -  <A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>

------_=_NextPart_001_01C2A7AD.85C5DB74
Content-Type: text/html;
	charset=&quot;iso-8859-1&quot;
Content-Transfer-Encoding: quoted-printable

&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 3.2//EN&quot;&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;META HTTP-EQUIV=3D&quot;Content-Type&quot; CONTENT=3D&quot;text/html; =
charset=3Diso-8859-1&quot;&gt;
&lt;META NAME=3D&quot;Generator&quot; CONTENT=3D&quot;MS Exchange Server version =
6.0.4417.0&quot;&gt;
&lt;TITLE&gt;RE: [Mono-list] Mono/.NET delegate incompatibility&lt;/TITLE&gt;
&lt;/HEAD&gt;
&lt;BODY&gt;
&lt;!-- Converted from text/plain format --&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;you're right, in order to remain compatible, mono =
should use stdcall convention by default on win32. (existing code, =
etc...)&lt;/FONT&gt;&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;piers.&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;-----Original Message-----&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;From: J. Perkins [&lt;A =
HREF=3D&quot;mailto:<A HREF="mailto:jason@379.com">jason@379.com</A>&quot;&gt;mailto:<A HREF="mailto:jason@379.com">jason@379.com</A>&lt;/A&gt;]&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;Sent: Thursday, December 19, 2002 11:42 AM&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;To: J. Perkins&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;Cc: 'Mono-L'&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;Subject: RE: [Mono-list] Mono/.NET delegate =
incompatibility&lt;/FONT&gt;
&lt;/P&gt;
&lt;BR&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;Hang on a minute, I answered this too soon. I'm not =
talking about&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;calling a DLL function. [DllImport] works just fine =
on both Windows and&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;Linux. I am talking about a callback function, from =
unmanaged -&amp;gt; managed&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;code. That is, a C# delegate passed to and called =
from unmanaged code&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;via a function pointer. Here's a usenet thread on the =
subject:&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;&amp;nbsp;&lt;A =
HREF=3D&quot;<A HREF="http://makeashorterlink.com/?C417214D2"">http://makeashorterlink.com/?C417214D2&quot;</A>&gt;<A HREF="http://makeashorterlink.c=">http://makeashorterlink.c=</A>
om/?C417214D2&lt;/A&gt;&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;The problem described in this thread is reversed for =
Mono: the callback&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;must use the cdecl convention. Because of this, there =
is no way to write&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;a C function that can call a delegate under both .NET =
and Mono. If I do&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;this:&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;&amp;nbsp; int SomeCFunction(int (__stdcall =
*callback)(int, int, int))&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;nbsp; {&amp;nbsp; return callback(1,2,3); }&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;...it will corrupt the stack when run under Mono on =
Windows. If I use&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;cdecl instead:&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;&amp;nbsp; int SomeCFunction(int (*callback)(int, int, =
int))&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;nbsp; { return callback(1,2,3); }&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;...it will corrupt the stack when run under .NET. =
Maybe I'm missing&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;something (quite possible), but it appears that Mono =
must use __stdcall&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;for delegates on Windows.&lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;I'll give you guys a chance to sanity check my =
rambling. If it holds up&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;I will file a bug. &lt;/FONT&gt;
&lt;/P&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;Jason&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;379&lt;/FONT&gt;
&lt;/P&gt;
&lt;BR&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; I guess the default calling convention in =
mono is cdecl.&amp;nbsp; According to&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; MSDN, the default calling convention for =
dllimport should be stdcall&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; (which IMHO really only makes sense on =
windows).&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; &lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; You could try setting the CallingConvention =
property on the DllImport to&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&amp;gt; &amp;gt; cdecl.&lt;/FONT&gt;
&lt;/P&gt;
&lt;BR&gt;
&lt;BR&gt;
&lt;BR&gt;

&lt;P&gt;&lt;FONT SIZE=3D2&gt;_______________________________________________&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;Mono-list maillist&amp;nbsp; -&amp;nbsp; =
<A HREF="mailto:Mono-list@ximian.com">Mono-list@ximian.com</A>&lt;/FONT&gt;

&lt;BR&gt;&lt;FONT SIZE=3D2&gt;&lt;A =
HREF=3D&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list"">http://lists.ximian.com/mailman/listinfo/mono-list&quot;</A>&gt;<A HREF="http://lists.=">http://lists.=</A>
ximian.com/mailman/listinfo/mono-list&lt;/A&gt;&lt;/FONT&gt;
&lt;/P&gt;

&lt;/BODY&gt;
&lt;/HTML&gt;
------_=_NextPart_001_01C2A7AD.85C5DB74--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="010551.html">[Mono-list] void* conversion from IntPtr
</A></li>
	<LI> Next message: <A HREF="010553.html">[Mono-list] CreateChildControls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10552">[ date ]</a>
              <a href="thread.html#10552">[ thread ]</a>
              <a href="subject.html#10552">[ subject ]</a>
              <a href="author.html#10552">[ author ]</a>
         </LI>
       </UL>
</body></html>
