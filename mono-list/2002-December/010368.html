<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [PATCH] &quot;protected internal&quot; semantics
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jarek%40atm.com.pl">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="010373.html">
   <LINK REL="Next"  HREF="010400.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [PATCH] &quot;protected internal&quot; semantics
   </H1>
    <B>Jaroslaw Kowalski
    </B> 
    <A HREF="mailto:jarek%40atm.com.pl"
       TITLE="[Mono-list] [PATCH] &quot;protected internal&quot; semantics">jarek@atm.com.pl
       </A><BR>
    <I>Sat, 14 Dec 2002 19:38:17 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="010373.html">[Mono-list] More Good Press
</A></li>
        <LI> Next message: <A HREF="010400.html">[Mono-list] [PATCH] &quot;protected internal&quot; semantics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10368">[ date ]</a>
              <a href="thread.html#10368">[ thread ]</a>
              <a href="subject.html#10368">[ subject ]</a>
              <a href="author.html#10368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

------=_NextPart_000_000B_01C2A3A8.59A56540
Content-Type: text/plain;
	charset=&quot;iso-8859-2&quot;
Content-Transfer-Encoding: 7bit

Hi!

Today I've reported an MCS error where it wasn't possible to override
&quot;protected internal&quot; method with method declared as &quot;protected&quot; in another
assembly.

Here's my attempt to fix it: I've added some conditions in &quot;decl.cs&quot; (patch
included) and some mini test to check this functionality (second and fourth
compilations should fail under both mcs and csc)

Can you please verify the patch and commit if it's ok (I'm using read-only
CVS access)

Jarek

PS. Yes, the tests are very ugly but I couldn't come up with anything simple
to do the job.

------=_NextPart_000_000B_01C2A3A8.59A56540
Content-Type: application/octet-stream;
	name=&quot;protected_internal.patch&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment;
	filename=&quot;protected_internal.patch&quot;

Index: ChangeLog=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mcs/mcs/ChangeLog,v=0A=
retrieving revision 1.915=0A=
diff -u -r1.915 ChangeLog=0A=
--- ChangeLog	13 Dec 2002 09:46:54 -0000	1.915=0A=
+++ ChangeLog	14 Dec 2002 18:29:08 -0000=0A=
@@ -1,3 +1,8 @@=0A=
+2002-12-14  Jaroslaw Kowalski &lt;<A HREF="mailto:jarek@atm.com.pl">jarek@atm.com.pl</A>&gt;=0A=
+=0A=
+	* decl.cs: Added special case to allow overrides on &quot;protected=0A=
+	internal&quot; methods=0A=
+=0A=
 2002-12-13  Gonzalo Paniagua Javier &lt;<A HREF="mailto:gonzalo@ximian.com">gonzalo@ximian.com</A>&gt;=0A=
 =0A=
 	* namespace.cs: fixed bug #35489.=0A=
Index: decl.cs=0A=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=0A=
RCS file: /mono/mcs/mcs/decl.cs,v=0A=
retrieving revision 1.47=0A=
diff -u -r1.47 decl.cs=0A=
--- decl.cs	27 Nov 2002 17:17:19 -0000	1.47=0A=
+++ decl.cs	14 Dec 2002 18:29:09 -0000=0A=
@@ -94,16 +94,67 @@=0A=
 						      &quot;' because it is sealed.&quot;);=0A=
 					ok =3D false;=0A=
 				}=0A=
-=0A=
 				//=0A=
 				// Check that the permissions are not being changed=0A=
 				//=0A=
 				MethodAttributes thisp =3D my_attrs &amp; =
MethodAttributes.MemberAccessMask;=0A=
 				MethodAttributes parentp =3D mb.Attributes &amp; =
MethodAttributes.MemberAccessMask;=0A=
 =0A=
-				if (thisp !=3D parentp){=0A=
-					Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
-					ok =3D false;=0A=
+				//=0A=
+				// special case for &quot;protected internal&quot;=0A=
+				//=0A=
+=0A=
+				if ((parentp &amp; MethodAttributes.FamORAssem) =3D=3D =
MethodAttributes.FamORAssem)=0A=
+				{=0A=
+					// when overriding protected internal, the method can be declared=0A=
+					// protected internal only within the same assembly=0A=
+=0A=
+					if ((thisp &amp; MethodAttributes.FamORAssem) =3D=3D =
MethodAttributes.FamORAssem)=0A=
+					{=0A=
+						if (parent.TypeBuilder.Assembly !=3D mb.DeclaringType.Assembly)=0A=
+						{=0A=
+							// assemblies differ - report an error=0A=
+							=0A=
+							Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+						    ok =3D false;=0A=
+						}=0A=
+						else if (thisp !=3D parentp)=0A=
+						{=0A=
+							// same assembly, but other attributes differ - report an error=0A=
+=0A=
+							Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+							ok =3D false;=0A=
+						};=0A=
+					}=0A=
+					else if ((thisp &amp; MethodAttributes.Family) !=3D =
MethodAttributes.Family)=0A=
+					{=0A=
+						// if it's not &quot;protected internal&quot;, it must be &quot;protected&quot;=0A=
+=0A=
+						Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+					    ok =3D false;=0A=
+					}=0A=
+					else if (parent.TypeBuilder.Assembly =3D=3D =
mb.DeclaringType.Assembly)=0A=
+					{=0A=
+						// protected within the same assembly - an error=0A=
+						Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+						ok =3D false;=0A=
+					}=0A=
+=0A=
+					else if ((thisp &amp; ~(MethodAttributes.Family | =
MethodAttributes.FamORAssem))=0A=
+							!=3D (parentp &amp; ~(MethodAttributes.Family | =
MethodAttributes.FamORAssem)))=0A=
+					{=0A=
+						// protected ok, but other attributes differ - report an error=0A=
+=0A=
+						Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+						ok =3D false;=0A=
+					}=0A=
+				}=0A=
+				else=0A=
+				{=0A=
+					if (thisp !=3D parentp){=0A=
+						Error_CannotChangeAccessModifiers (parent, mb, name);=0A=
+						ok =3D false;=0A=
+					}=0A=
 				}=0A=
 			}=0A=
 =0A=

------=_NextPart_000_000B_01C2A3A8.59A56540
Content-Type: application/x-gzip;
	name=&quot;test.tar.gz&quot;
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
	filename=&quot;test.tar.gz&quot;

H4sIANp2+z0AA+2YTW/CIBiAe7XJ/gNHd1GgtCTutO28227LDvQjhqQWA2iyLP730dZZjR9zM223
+T4HMeUtNMXn5UWbGTv22gVjhjkPXYtdi3faNR7mIY8iHgTld4LDiHkobPm5KhbGCo2QN1OFOhX3
Vf8fxZbrH+NRYtqbw60njhg7vv6cf64/pVHk4gmjoYdwe4/UcOXrP1/EuUxQkgtj0ANBE3Tvv/uD
uVY2S2yWIrXMtJZphpZKpujZ/VzI8NYfuJiVv/L7fnzgQmr/Sa/+E4K3/GeV/+4S+N8Bu/7jff9l
YTNdiBwSwb+k8l/06z/l0cb/gNF6/yfgfxes/RexsVokdp0IjuWATdh2DrhzofUo7lVa11SdT0IW
Qxcti+nLKxJ6appk4R+e9fG71QdknYup/e+3/g9wU//j8nq5/4P/nfDL/T+z+oBE8FMq/8uPUTJL
W5qj9J+Hx///oYQ19X95FiDUAf53QWISNC5UrqYKje0kl7EW+g1VO8KNf6yX7PfqibsnzfPtuPjA
KAfj6vH6fhfXyMZ/aVub42v/m/M/q+p/iimc/zvhlP8n9T/T/jPlB/cBAAAAAAAAAAAAoEU+ABkc
+oQAKAAA

------=_NextPart_000_000B_01C2A3A8.59A56540--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="010373.html">[Mono-list] More Good Press
</A></li>
	<LI> Next message: <A HREF="010400.html">[Mono-list] [PATCH] &quot;protected internal&quot; semantics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10368">[ date ]</a>
              <a href="thread.html#10368">[ thread ]</a>
              <a href="subject.html#10368">[ subject ]</a>
              <a href="author.html#10368">[ author ]</a>
         </LI>
       </UL>
</body></html>
