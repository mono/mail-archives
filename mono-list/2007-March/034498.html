<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Adding Solaris/amd64 support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Adding%20Solaris/amd64%20support&In-Reply-To=CD20F6F2-EED5-4291-BE32-A1EAD543DB59%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034496.html">
   <LINK REL="Next"  HREF="034497.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Adding Solaris/amd64 support</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Adding%20Solaris/amd64%20support&In-Reply-To=CD20F6F2-EED5-4291-BE32-A1EAD543DB59%40web.de"
       TITLE="[Mono-list] Adding Solaris/amd64 support">andreas.faerber at web.de
       </A><BR>
    <I>Wed Mar  7 13:39:31 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="034496.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
        <LI>Next message: <A HREF="034497.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34498">[ date ]</a>
              <a href="thread.html#34498">[ thread ]</a>
              <a href="subject.html#34498">[ subject ]</a>
              <a href="author.html#34498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;&gt;<i> This is where the explanation I gave you is important: the routine in
</I>&gt;&gt;<i> question basically needs to understand the generated code and
</I>&gt;&gt;<i> modify it
</I>&gt;&gt;<i> on the flight.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So you need to look at the code and see why it would generate the
</I>&gt;&gt;<i> exception, the address to disassemble is precisely the one that it
</I>&gt;&gt;<i> will
</I>&gt;&gt;<i> try to decode and its failing to.
</I>&gt;<i>
</I>&gt;<i> So given the code in amd64_patch:
</I>&gt;<i> <A HREF="http://svn.myrealbox.com/source/trunk/mono/mono/mini/mini-amd64.c">http://svn.myrealbox.com/source/trunk/mono/mono/mini/mini-amd64.c</A>
</I>&gt;<i> Would this be disp, code or target? That was my question. Through
</I>&gt;<i> printf(&quot;%x\n&quot;, ) I could then look at the value.
</I>
I've done code and target as follows (disp didn't make sense on  
second thoughts).

Adding:

printf(&quot;code=%p\ntarget=%p\ndisp=%#tx\n&quot;, code, target, disp);

prints:

TYPE: 1
code=fffffd7ffe3f077b
target=4e53e4
disp=0x280020f4c69

Program received signal SIGTRAP, Trace/breakpoint trap.
amd64_patch (_field_data=0xfffffd7ffe3f077b &quot;[...]&quot;, her=0x4e53e4)
     at mini-amd64.c:183
183                     x86_patch (code, (unsigned char*)target);


(non-ASCII characters not copied)

gdb output:

(gdb) x/20i 0xfffffd7ffe3f077b
0xfffffd7ffe3f077b:     callq  0xfffffd7ffdd04a90
0xfffffd7ffe3f0780:     mov    %r12,%rax
0xfffffd7ffe3f0783:     jmp    0xfffffd7ffe3f0785
0xfffffd7ffe3f0785:     mov    0xfffffffffffffff8(%rbp),%r12
0xfffffd7ffe3f0789:     leaveq
0xfffffd7ffe3f078a:     retq
0xfffffd7ffe3f078b:     add    %al,(%rax)
0xfffffd7ffe3f078d:     add    %al,(%rax)
0xfffffd7ffe3f078f:     add    %al,(%rax)
0xfffffd7ffe3f0791:     add    %al,(%rax)
0xfffffd7ffe3f0793:     add    %al,(%rax)
0xfffffd7ffe3f0795:     add    %al,(%rax)
0xfffffd7ffe3f0797:     add    %al,(%rax)
0xfffffd7ffe3f0799:     add    %al,(%rax)
0xfffffd7ffe3f079b:     add    %al,(%rax)
0xfffffd7ffe3f079d:     add    %al,(%rax)
0xfffffd7ffe3f079f:     add    %al,(%rax)
0xfffffd7ffe3f07a1:     add    %al,(%rax)
0xfffffd7ffe3f07a3:     add    %al,(%rax)
0xfffffd7ffe3f07a5:     add    %al,(%rax)



(gdb) x/20i 0x4e53e4
0x4e53e4 &lt;ves_icall_System_Threading_Thread_ResetAbort&gt;:         
push   %rbp
0x4e53e5 &lt;ves_icall_System_Threading_Thread_ResetAbort+1&gt;:
     mov    %rsp,%rbp
0x4e53e8 &lt;ves_icall_System_Threading_Thread_ResetAbort+4&gt;:       
push   %rbx
0x4e53e9 &lt;ves_icall_System_Threading_Thread_ResetAbort+5&gt;:
     sub    $0x8,%rsp
0x4e53ed &lt;ves_icall_System_Threading_Thread_ResetAbort+9&gt;:
     callq  0x4e481a &lt;mono_thread_current&gt;
0x4e53f2 &lt;ves_icall_System_Threading_Thread_ResetAbort+14&gt;:
     mov    %rax,%rbx
0x4e53f5 &lt;ves_icall_System_Threading_Thread_ResetAbort+17&gt;:
     mov    0xc8(%rax),%rdi
0x4e53fc &lt;ves_icall_System_Threading_Thread_ResetAbort+24&gt;:
     callq  0x4e3651 &lt;mono_monitor_enter&gt;
0x4e5401 &lt;ves_icall_System_Threading_Thread_ResetAbort+29&gt;:
     andl   $0xffffff7f,0x44(%rbx)
0x4e5408 &lt;ves_icall_System_Threading_Thread_ResetAbort+36&gt;:
     cmpq   $0x0,0x48(%rbx)
0x4e540d &lt;ves_icall_System_Threading_Thread_ResetAbort+41&gt;:
     jne    0x4e542f &lt;ves_icall_System_Threading_Thread_ResetAbort+75&gt;
0x4e540f &lt;ves_icall_System_Threading_Thread_ResetAbort+43&gt;:
     mov    0xc8(%rbx),%rdi
0x4e5416 &lt;ves_icall_System_Threading_Thread_ResetAbort+50&gt;:
---Type &lt;return&gt; to continue, or q &lt;return&gt; to quit---
     callq  0x4e3688 &lt;mono_monitor_exit&gt;
0x4e541b &lt;ves_icall_System_Threading_Thread_ResetAbort+55&gt;:
     mov    $0x619030,%edi
0x4e5420 &lt;ves_icall_System_Threading_Thread_ResetAbort+60&gt;:
     callq  0x4ed27a &lt;mono_get_exception_thread_state&gt;
0x4e5425 &lt;ves_icall_System_Threading_Thread_ResetAbort+65&gt;:
     mov    %rax,%rdi
0x4e5428 &lt;ves_icall_System_Threading_Thread_ResetAbort+68&gt;:
     callq  0x4b84bc &lt;mono_raise_exception&gt;
0x4e542d &lt;ves_icall_System_Threading_Thread_ResetAbort+73&gt;:
     jmp    0x4e543f &lt;ves_icall_System_Threading_Thread_ResetAbort+91&gt;
0x4e542f &lt;ves_icall_System_Threading_Thread_ResetAbort+75&gt;:
     movq   $0x0,0x48(%rbx)
0x4e5437 &lt;ves_icall_System_Threading_Thread_ResetAbort+83&gt;:
     movq   $0x0,0x50(%rbx)


Andreas
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034496.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
	<LI>Next message: <A HREF="034497.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34498">[ date ]</a>
              <a href="thread.html#34498">[ thread ]</a>
              <a href="subject.html#34498">[ subject ]</a>
              <a href="author.html#34498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
