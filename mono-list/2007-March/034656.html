<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] List.FindAll method implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20List.FindAll%20method%20implementation&In-Reply-To=c3b5f930703191727g247e4cc9k7fdd2502b22ce858%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034668.html">
   <LINK REL="Next"  HREF="034660.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] List.FindAll method implementation</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20List.FindAll%20method%20implementation&In-Reply-To=c3b5f930703191727g247e4cc9k7fdd2502b22ce858%40mail.gmail.com"
       TITLE="[Mono-list] List.FindAll method implementation">miguel at novell.com
       </A><BR>
    <I>Tue Mar 20 10:24:18 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="034668.html">[Mono-list] Exception of Metadata
</A></li>
        <LI>Next message: <A HREF="034660.html">[Mono-list] List.FindAll method implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34656">[ date ]</a>
              <a href="thread.html#34656">[ thread ]</a>
              <a href="subject.html#34656">[ subject ]</a>
              <a href="author.html#34656">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i> 
</I>&gt;<i> I think the &quot;heap bit&quot; method is not that good :)
</I>
But it only becomes slower with ten million elements.

Also, when you run your tests, you might want to run multiple
iterations, so the times are larger (without all the zeros in the
prefix :)

&gt;<i> JCO
</I>&gt;<i> 
</I>&gt;<i> On 3/19/07, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">miguel at novell.com</A>&gt; wrote:
</I>&gt;<i>         Hey!
</I>&gt;<i>         
</I>&gt;<i>         &gt; is that really better than user a uint[] array? I have
</I>&gt;<i>         thinked in
</I>&gt;<i>         &gt; other solutions... I will test them later.
</I>&gt;<i>         
</I>&gt;<i>         Well, basically you could use the same code path
</I>&gt;<i>         FindAllStackBits, but
</I>&gt;<i>         you would have to change it like this: 
</I>&gt;<i>         
</I>&gt;<i>                 List &lt;T&gt; FindAllStackBits (uint *bits, Predicate &lt;T&gt;
</I>&gt;<i>         match)
</I>&gt;<i>         
</I>&gt;<i>         And you would have to pre-allocate bits in the caller:
</I>&gt;<i>         
</I>&gt;<i>                 if (size &lt; 8*8*1024)
</I>&gt;<i>                         bits = stackalloc uint [n]; 
</I>&gt;<i>                 else
</I>&gt;<i>                         bits = (uint *) Marshal.AllocHGlobal (...);
</I>&gt;<i>         
</I>&gt;<i>         That way it always uses a fast path, the only difference is
</I>&gt;<i>         that for
</I>&gt;<i>         large memory blocks we use memory on the heap instead of using
</I>&gt;<i>         stack 
</I>&gt;<i>         memory.
</I>&gt;<i>         
</I>&gt;<i>         Miguel
</I>&gt;<i>         &gt; JCO
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; On 3/19/07, Miguel de Icaza &lt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">miguel at novell.com</A>&gt; wrote:
</I>&gt;<i>         &gt;         Hello Juan,
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;         &gt; Because there's no way to know the size of the
</I>&gt;<i>         stack in any 
</I>&gt;<i>         &gt;         moment in
</I>&gt;<i>         &gt;         &gt; time, Miguel suggested me to limit this new method
</I>&gt;<i>         to use
</I>&gt;<i>         &gt;         only 8KB of
</I>&gt;<i>         &gt;         &gt; the stack... so it will be useful for list with 8
</I>&gt;<i>         * 1024 * 8
</I>&gt;<i>         &gt;         elements 
</I>&gt;<i>         &gt;         &gt; or less. Bigger lists will use the old algorithm.
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;         I just had an idea: if the memory to be allocated is
</I>&gt;<i>         too
</I>&gt;<i>         &gt;         large, instead
</I>&gt;<i>         &gt;         of using stackalloc, you could use: 
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;                 using System.Runtime.InteropServices ;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;                 IntPtr Marshal.AllocHGlobal (size);
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;         and release it with:
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;                 Marshal.FreeHGGlobal (IntPtr p);
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;         That way we could always use the fast mechanisms.
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;         &gt; It also includes few testcases.
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt; Juan C. Olivares
</I>&gt;<i>         &gt;         &gt; www.juancri.com
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt; On 3/18/07, Juan C. Olivares &lt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">juancri at gmail.com</A>&gt;
</I>&gt;<i>         wrote:
</I>&gt;<i>         &gt;         &gt;         I'll check... 
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;         Juan Crist&#243;bal Olivares
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;         www.juancri.com
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;         On 3/18/07, Miguel de Icaza &lt;
</I>&gt;<i>         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">miguel at novell.com</A>&gt;
</I>&gt;<i>         &gt;         wrote:
</I>&gt;<i>         &gt;         &gt;                 Hello,
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                     I feel a bit strange that the
</I>&gt;<i>         bools are 
</I>&gt;<i>         &gt;         allocated
</I>&gt;<i>         &gt;         &gt;                 using
</I>&gt;<i>         &gt;         &gt;                 numbers.Count but the loop uses
</I>&gt;<i>         this._items.
</I>&gt;<i>         &gt;         I
</I>&gt;<i>         &gt;         &gt;                 rather keep them in 
</I>&gt;<i>         &gt;         &gt;                 parallel.
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                     Also, another idea might be to
</I>&gt;<i>         use three
</I>&gt;<i>         &gt;         code
</I>&gt;<i>         &gt;         &gt;                 paths depending on the 
</I>&gt;<i>         &gt;         &gt;                 number of items:
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                         * [0,N] use bools.
</I>&gt;<i>         &gt;         &gt;                         * [N,M] use bitbools.
</I>&gt;<i>         &gt;         &gt;                         * [M,infinity] use the old
</I>&gt;<i>         method. 
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                     Thread stacks could not be
</I>&gt;<i>         very large,
</I>&gt;<i>         &gt;         and you
</I>&gt;<i>         &gt;         &gt;                 would like to avoid a
</I>&gt;<i>         &gt;         &gt;                 crash in that condition.
</I>&gt;<i>         Actually, I 
</I>&gt;<i>         &gt;         wonder if
</I>&gt;<i>         &gt;         &gt;                 stackalloc returns a
</I>&gt;<i>         &gt;         &gt;                 null if the requested size is
</I>&gt;<i>         larger than
</I>&gt;<i>         &gt;         the
</I>&gt;<i>         &gt;         &gt;                 available stack. 
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                 Miguel.
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt; Attached.
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt; Juan C. Olivares 
</I>&gt;<i>         &gt;         &gt;                 &gt; www.juancri.com
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt; On 3/18/07, Miguel de Icaza &lt;
</I>&gt;<i>         &gt;         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">miguel at novell.com</A>&gt;
</I>&gt;<i>         &gt;         &gt;                 wrote:
</I>&gt;<i>         &gt;         &gt;                 &gt;         Hello,
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; 
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; Do you have any
</I>&gt;<i>         comment?. I
</I>&gt;<i>         &gt;         could send a
</I>&gt;<i>         &gt;         &gt;                 patch...
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt;         These numbers look
</I>&gt;<i>         fantastic.   We 
</I>&gt;<i>         &gt;         would
</I>&gt;<i>         &gt;         &gt;                 love to see a patch.
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; best regards
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; 
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; Juan C. Olivares
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; www.juancri.com
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; 
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         _______________________________________________ 
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; Mono-list
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i>         &gt;         &gt;                 &gt;         &gt; 
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         &gt;                 &gt; 
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         _______________________________________________
</I>&gt;<i>         &gt;         &gt;                 &gt; Mono-list maillist  -
</I>&gt;<i>         &gt;         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i>         &gt;         &gt;                 &gt;
</I>&gt;<i>         &gt;         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>         &gt;         &gt; 
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;         &gt;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; 
</I>&gt;<i>         &gt; --
</I>&gt;<i>         &gt; Juan Crist&#243;bal Olivares
</I>&gt;<i>         
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Juan Crist&#243;bal Olivares
</I>
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034668.html">[Mono-list] Exception of Metadata
</A></li>
	<LI>Next message: <A HREF="034660.html">[Mono-list] List.FindAll method implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34656">[ date ]</a>
              <a href="thread.html#34656">[ thread ]</a>
              <a href="subject.html#34656">[ subject ]</a>
              <a href="author.html#34656">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
