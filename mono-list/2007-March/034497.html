<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Adding Solaris/amd64 support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Adding%20Solaris/amd64%20support&In-Reply-To=81D1A09B-63CA-4250-B906-3B8AADBF56AB%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034498.html">
   <LINK REL="Next"  HREF="034501.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Adding Solaris/amd64 support</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Adding%20Solaris/amd64%20support&In-Reply-To=81D1A09B-63CA-4250-B906-3B8AADBF56AB%40web.de"
       TITLE="[Mono-list] Adding Solaris/amd64 support">lupus at ximian.com
       </A><BR>
    <I>Wed Mar  7 11:59:13 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="034498.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
        <LI>Next message: <A HREF="034501.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34497">[ date ]</a>
              <a href="thread.html#34497">[ thread ]</a>
              <a href="subject.html#34497">[ subject ]</a>
              <a href="author.html#34497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/05/07 Andreas F&#228;rber wrote:
&gt;<i> With or without this patch, compiled 32-bit or 64-bit, on the amd64  
</I>&gt;<i> system I get the following warning in mono at runtime:
</I>&gt;<i> 
</I>&gt;<i> GC Warning: Large stack limit(10485760): only scanning 8 MB
</I>
This should likely be investigated, since I don't think we use stacks of
that size anywhere.

&gt;<i> During compilation for amd64, mono (r73669, with and without GC) then  
</I>&gt;<i> outputs the following:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> TYPE: 1
</I>&gt;<i> 
</I>&gt;<i> ** ERROR **: file mini-amd64.c: line 180 (amd64_patch): assertion  
</I>&gt;<i> failed: (amd64_is_imm32 (disp))
</I>[...]
&gt;<i> According to bug #79271 the above assertion failure was supposed to  
</I>&gt;<i> be fixed:
</I>&gt;<i> <A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=79271">http://bugzilla.ximian.com/show_bug.cgi?id=79271</A>
</I>&gt;<i> 
</I>&gt;<i> Might I need to patch anything else for Solaris/amd64? Or should I  
</I>&gt;<i> reopen that bug?
</I>
The amd64 code assumes in many places that executable code is reachable
within +/- 2 GB, because that allows using a faster code sequence.
On Linux the code we produce is stored in pages allocated with the
MAP_32BIT mmap option and this usually makes the above assumption be
true (there are still issues possible even with this option).
So as a first thing, you should check if solaris/amd64 has a similar
mmap() option: you should reserve the memory from the lower 32 bit
virtual memory space. The code is in utils/mono-mmap.c and
mono-codeman.c (grep for 32BIT).

If this solution is not available or it is not working, the real fix
will need to be implemented in utils/mono-codeman.c: at startup a large
chunk of virtual memory needs to be reserved and instead of using
mono_valloc directly, chunks from this memory area are taken. This
ensures all the generated code is within the memory bounds reachable
from the call instruction. Additionally the memory would need to be
reserved close to the address space where the program and shared
libraries are loaded (or the jit code must be changed to always call
native code with an indirect instruction).

This last solution is what I have in my todo list as a way to speedup
the generated code for architectures where a call instruction can't
reach all the address space (basically anything but x86). I have no idea
when I'll actually get to that todo item...

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034498.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
	<LI>Next message: <A HREF="034501.html">[Mono-list] Adding Solaris/amd64 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34497">[ date ]</a>
              <a href="thread.html#34497">[ thread ]</a>
              <a href="subject.html#34497">[ subject ]</a>
              <a href="author.html#34497">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
