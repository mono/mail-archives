<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Mono.Unix.Native.Syscall.readlink%20memory%20corruption&In-Reply-To=BAY22-DAV8C39D24E661E421551950A3E10%40phx.gbl">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030949.html">
   <LINK REL="Next"  HREF="030951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Mono.Unix.Native.Syscall.readlink%20memory%20corruption&In-Reply-To=BAY22-DAV8C39D24E661E421551950A3E10%40phx.gbl"
       TITLE="[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption">andreas.faerber at web.de
       </A><BR>
    <I>Tue Mar 14 07:48:41 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="030949.html">[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption
</A></li>
        <LI>Next message: <A HREF="030951.html">[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30950">[ date ]</a>
              <a href="thread.html#30950">[ thread ]</a>
              <a href="subject.html#30950">[ subject ]</a>
              <a href="author.html#30950">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Korn&#233;l P&#225;l schrieb:
&gt;&gt;&gt;&gt;<i> On a related note:  if a C function mallocs some memory and returns a
</I>&gt;&gt;&gt;&gt;<i> pointer
</I>&gt;&gt;&gt;&gt;<i> to that memory, does p/invoke free the memory once marshalling is
</I>&gt;&gt;&gt;&gt;<i> complete?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> No. There is simply no way to automatically determine whether it
</I>&gt;&gt;&gt;<i> should be
</I>&gt;&gt;&gt;<i> freed and there is even less chance to determine how (using what
</I>&gt;&gt;&gt;<i> function)
</I>&gt;&gt;&gt;<i> it should be freed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you want to do so you have to use an IntPtr that you can free
</I>&gt;&gt;&gt;<i> manually.
</I>&gt;&gt;&gt;<i> Note that you can alternatively use a custom marshaler but you have
</I>&gt;&gt;&gt;<i> to do
</I>&gt;&gt;&gt;<i> the same with a more complex and probably more proper design.
</I>&gt;&gt;<i> This is not entirely true. A returned string is actually automatically
</I>&gt;&gt;<i> freed when marshalled as string (as opposed to IntPtr). In that case
</I>&gt;&gt;<i> Mono does not determine whether it should be freed, it simply frees it.
</I>&gt;<i>
</I>&gt;<i> I don't think so. If you pass a buffer (that can be StringBuilder as
</I>&gt;<i> well)
</I>&gt;<i> the runtime will free any temporary allocated buffer and the GC will free
</I>&gt;<i> the managed buffer. But that buffer is allocated by the caller so it
</I>&gt;<i> can be
</I>&gt;<i> freed easily. The buffer in question however is allocated by the
</I>&gt;<i> callee and
</I>&gt;<i> returned to caller. In this case the runtime will not free the buffer.
</I>&gt;<i> You
</I>&gt;<i> have to free it manually using the function mentioned in the
</I>&gt;<i> documentation
</I>&gt;<i> of the function that return the buffer becuase calling free() may not
</I>&gt;<i> work
</I>&gt;<i> as the buffer may come from other source. Also note that the returned
</I>&gt;<i> buffer
</I>&gt;<i> may come from some shared source so you should not free or modify it at.
</I>&gt;<i> This latter case is unsafe but can provide better performance.
</I>&gt;<i>
</I>&gt;<i> I hope now you uderstand what kind of buffer are we talking about and
</I>&gt;<i> why is
</I>&gt;<i> it impossible for the runtime to free it automatically.
</I>&gt;<i>
</I>&gt;<i> Korn&#233;l
</I>&gt;<i>
</I>I was answering the very general question quoted at the top of my post.
That is not about a StringBuffer but about malloc and free in general,
so that your answer was correct in the specific case of passing a
StringBuffer as an argument (I did read that) but not in general to the
question of whether Mono frees unmanaged pointers:

char* unmanagedfunc() {
    return malloc(5);
}

will alloc 5 bytes,

extern static string unmanagedfunc();
string s = unmanagedfunc();

will marshal the string and free the unmanaged pointer.

I confirmed that Mono cannot determine whether a pointer is in use by
unmanaged code and complemented your answer with an exception where a
pointer is in fact freed by the runtime, which has caused some severe
problems for me in the past; don't know whether it is a bug or a feature
but it was observed in Mono 1.1.13 on OS X. If you don't think so then
test it yourself.

Andreas
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030949.html">[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption
</A></li>
	<LI>Next message: <A HREF="030951.html">[Mono-list] Mono.Unix.Native.Syscall.readlink memory corruption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30950">[ date ]</a>
              <a href="thread.html#30950">[ thread ]</a>
              <a href="subject.html#30950">[ subject ]</a>
              <a href="author.html#30950">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
