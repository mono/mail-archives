<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] HTTPS: 'Invalid certificate received from server.' and mozroots
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HTTPS%3A%20%27Invalid%20certificate%20received%20from%20server.%27%0A%20and%20mozroots&In-Reply-To=AANLkTi%3DROp5H9-jPmBineBEqBvK4sCUfvoXAGG3q6S0q%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046443.html">
   <LINK REL="Next"  HREF="046483.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] HTTPS: 'Invalid certificate received from server.' and mozroots</H1>
    <B>Brent Hamilton</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HTTPS%3A%20%27Invalid%20certificate%20received%20from%20server.%27%0A%20and%20mozroots&In-Reply-To=AANLkTi%3DROp5H9-jPmBineBEqBvK4sCUfvoXAGG3q6S0q%40mail.gmail.com"
       TITLE="[Mono-list] HTTPS: 'Invalid certificate received from server.' and mozroots">devup at live.com
       </A><BR>
    <I>Fri Jan 21 13:37:43 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="046443.html">[Mono-list] HTTPS: 'Invalid certificate received from server.' and	mozroots
</A></li>
        <LI>Next message: <A HREF="046483.html">[Mono-list] HTTPS: 'Invalid certificate received from server.'	and mozroots
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46462">[ date ]</a>
              <a href="thread.html#46462">[ thread ]</a>
              <a href="subject.html#46462">[ subject ]</a>
              <a href="author.html#46462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Tymek,
I believe there may be an outstanding issue with trying to import certificates using mozroots at the MACHINE level.
In my experience, the following command worked when run as the USER that will run the application:
[PATH]/bin/mono [PATH]/mozroots.exe --import --sync
Regards,
DevUp!
Date: Thu, 20 Jan 2011 12:34:50 +0800
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">tym.majewski at nearmap.com</A>
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">mono-list at lists.ximian.com</A>
Subject: [Mono-list] HTTPS: 'Invalid certificate received from server.' and	mozroots

Hello gurus,

This is Mono 2.6.7 Ubuntu 

Problem:
    I 
cannot connect to https pages (using HttpWebRequest) from MONO ASP and I
 cannot (well, maybe I'm not doing it right) display installed x509 
certs.


Error message:
    Failed to submit to encrypted.google.com
 form System.Net.WebException: Error getting response stream (Write: The
 authentication or decryption has failed.): SendFailure ---&gt; 
System.IO.IOException: The authentication or decryption has failed. 
---&gt; Mono.Security.Protocol.Tls.TlsException: Invalid certificate received from server. Error code: 0xffffffff800b010a


Extra info:
1. I restarted mono several times. 
2. If I provide my own ServicePointManager.ServerCertificateValidationCallback validator and return true, the handshake goes through.
3. Connecting to example pages (paypal, google etc) from my Firefox doesn't show any issues.


4. Connecting to various pages with http:// (not s) works fine.
5. I imported the std root certs with mozroots:

          $sudo mozroots --import --machine --sync
          Mozilla Roots Importer - version 2.6.7.0


          Download and import trusted root certificates from Mozilla's LXR.
          Copyright 2002, 2003 Motus Technologies. Copyright 2004-2008 Novell. BSD licensed.
          
          Downloading from '<A HREF="http://lxr.mozilla.org/seamonkey/source/security/nss/lib/ckfw/builtins/certdata.txt'...">http://lxr.mozilla.org/seamonkey/source/security/nss/lib/ckfw/builtins/certdata.txt'...</A>


          Importing certificates into machine store...
          140 new root certificates were added to your trust store.
          Import process completed.

I can see the certs are there:
          $ls /usr/share/.mono/certs/Trust | wc -l


          140


I tried to look at the installed certs but I always get Count = 0:

            X509Store storeMachine = new X509Store(StoreLocation.LocalMachine);
//I also tried StoreLocation.CurrentUser also with no success. 
            storeMachine.Open(OpenFlags.ReadOnly);
//BTW. Is this necessary at all?
 
            X509Certificate2Collection storecollection2 = (X509Certificate2Collection)storeMachine.Certificates;

            Console.WriteLine(&quot;Number of X509 certs Machine: {0}&quot;, storecollection2.Count);

            foreach (X509Certificate2 x509 in storecollection2)

            {

                Console.WriteLine(&quot;certificate name: {0}&quot;, x509.Subject);

            }


Thanks in advance for any help
-- 
Tymek Majewski
Software Developer
NearMap.com



_______________________________________________
Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A> 		 	   		  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20110121/3944023c/attachment.html">http://lists.ximian.com/pipermail/mono-list/attachments/20110121/3944023c/attachment.html</A> 
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046443.html">[Mono-list] HTTPS: 'Invalid certificate received from server.' and	mozroots
</A></li>
	<LI>Next message: <A HREF="046483.html">[Mono-list] HTTPS: 'Invalid certificate received from server.'	and mozroots
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46462">[ date ]</a>
              <a href="thread.html#46462">[ thread ]</a>
              <a href="subject.html#46462">[ subject ]</a>
              <a href="author.html#46462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
