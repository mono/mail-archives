<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Heap-Shot with no GUI.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Heap-Shot%20with%20no%20GUI.&In-Reply-To=9A9DAF522D579B4F9050AAB674DFDE600264E4823C91%40svex.intern.rantek.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046025.html">
   <LINK REL="Next"  HREF="046060.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Heap-Shot with no GUI.</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20Heap-Shot%20with%20no%20GUI.&In-Reply-To=9A9DAF522D579B4F9050AAB674DFDE600264E4823C91%40svex.intern.rantek.dk"
       TITLE="[Mono-list] Heap-Shot with no GUI.">lupus at ximian.com
       </A><BR>
    <I>Thu Nov 11 11:10:06 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="046025.html">[Mono-list] Heap-Shot with no GUI.
</A></li>
        <LI>Next message: <A HREF="046060.html">[Mono-list] Heap-Shot with no GUI.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46056">[ date ]</a>
              <a href="thread.html#46056">[ thread ]</a>
              <a href="subject.html#46056">[ subject ]</a>
              <a href="author.html#46056">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/05/10 Esben Laursen wrote:
&gt;<i> I did a install of the complete Heap-Shot and libs. I can start the
</I>&gt;<i> profiling okay and I can do a &quot;kill -PROF &lt;pid&gt;&quot; and get the output file,
</I>&gt;<i> however my program stalls before it comes to the part where I suspect a
</I>&gt;<i> leak (also happens if I do not do a kill -PROF). It uses quite a lot of
</I>&gt;<i> processes and time to load all the different settings which is normal,
</I>&gt;<i> but I can see once I start my analyzer threads it stops and nothing
</I>&gt;<i> happens. If I run with no --profile option it works as it should..
</I>&gt;<i> 
</I>&gt;<i> Any ideas? Anyone?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; If there are other ways to debug this problem please let me know.
</I>&gt;<i> 
</I>&gt;<i> Can it be that Heap-Shot is the _only_ memory profiling tool out there
</I>&gt;<i> for mono? It does not seem that stable (had a shit load of issues getting
</I>&gt;<i> the GUI stuff to work)
</I>
Heap-Shot has a number of issues, since its codebase has several
dependencies on unsafe behaviour, so we have been working on a better
implementation.

The new profiler is now in git and it is able to perform heapshots
when running with the sgen garbage collector.
You basically run your program with:

	mono-sgen --profile=log:heapshot yourprogram.exe

and then generate a report from the profile data with:

	mprof-report output.mlpd

To generate a heapshot roughtly every 5 seconds use:

	mono-sgen --profile=log:heapshot,hsmode=5000ms yourprogram.exe

More documentation is available here: <A HREF="http://www.mono-project.com/Profiler">http://www.mono-project.com/Profiler</A>
or in the mprof-report manpage.
It should work on most linux systems and OSX, it's currently untested on
windows.

As an example, this is some of the output you can get (with mprof-report
--traces on the profile data for an asp.net app):

        Heap shot 5 at 14.518 secs: size: 43684432, object count: 562907, class count: 543
             Bytes      Count  Average Class name
          10506984      87373      120 System.Collections.Hashtable.Slot[] (bytes: +1939272, count: +16161)
                87346 references from: System.Collections.Hashtable
           8130304      87486       92 System.Int32[] (bytes: +1706912, count: +16164)
                87346 references from: System.Collections.Hashtable
                40 references from: System.Collections.Generic.Dictionary&lt;System.String,System.Int32&gt;
                30 references from: System.Globalization.NumberFormatInfo
           6846000      57050      120 System.Web.Caching.CacheItem (bytes: +1232880, count: +10274)
           4891432      87347       56 System.Collections.Hashtable (bytes: +904176, count: +16146)
                28526 references from: System.Web.HttpStaticObjectsCollection
                28525 references from: System.Threading.ReaderWriterLock
                28524 references from: System.Web.SessionState.SessionStateItemCollection
           1597344      28524       56 System.Web.SessionState.InProcSessionItem (bytes: +287672, count: +5137)
                28524 references from: System.Web.Caching.CacheItem
           1597344      28524       56 System.Web.SessionState.SessionStateItemCollection (bytes: +287616, count: +5136)
                28524 references from: System.Web.SessionState.InProcSessionItem

This heapshot was taken 14.518 seconds after application startup, at the
time there were 562907 objects in the heap, of 543 different types,
using about 43 MB of memory.

As the data inside parens shows, since the previous heapshot, a lot of
hash tables are kept around referenced mostly from
HttpStaticObjectsCollection, ReaderWriterLock and
SessionStateItemCollection objects.
Following the data, SessionStateItemCollection objects are kept alive by
InProcSessionItem which are themselves kept alive from CacheItem
objects. The issue here is that some cached objects are never expired
from the cache.

Hope this helps.
(Yes, someone is developing a GUI so the above data will be easier to
understand).

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046025.html">[Mono-list] Heap-Shot with no GUI.
</A></li>
	<LI>Next message: <A HREF="046060.html">[Mono-list] Heap-Shot with no GUI.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46056">[ date ]</a>
              <a href="thread.html#46056">[ thread ]</a>
              <a href="subject.html#46056">[ subject ]</a>
              <a href="author.html#46056">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
