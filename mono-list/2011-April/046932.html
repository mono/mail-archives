<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] SSL Negotiation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20SSL%20Negotiation&In-Reply-To=1303916859.10717.37.camel%40mizar.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046931.html">
   <LINK REL="Next"  HREF="046933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] SSL Negotiation</H1>
    <B>Chuck Budzeak</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20SSL%20Negotiation&In-Reply-To=1303916859.10717.37.camel%40mizar.site"
       TITLE="[Mono-list] SSL Negotiation">crbudzeak at gmail.com
       </A><BR>
    <I>Wed Apr 27 12:09:16 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="046931.html">[Mono-list] SSL Negotiation
</A></li>
        <LI>Next message: <A HREF="046933.html">[Mono-list] Mono 2.10.2 doesn't seem to work for building MCS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46932">[ date ]</a>
              <a href="thread.html#46932">[ thread ]</a>
              <a href="subject.html#46932">[ subject ]</a>
              <a href="author.html#46932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sebastien,

Thank you for the detailed information. I was definitely over-thinking the
problem an trying to shoe-horn in an unnecessary solution. I have the code
working now, authenticating the server and client as a result of loading the
correct p12 key as you said.

Originally it seemed as if no p12 would load via X509Certificate2 because it
kept throwing an undefined length not supported exception. Which then I
recoded the p12 to a defined length cert which then would throw an index out
of range exception. And I sat in that loop for awhile yesterday while
picking away at XSP internals to try to figure out where I went wrong.

The issue was at that time I was using a p12 that was generated for me from
a co-worker (via a win32 program) instead of the mono makecert utility. When
I generated new certificates this morning with makecert, I was still going
down the path that the p12 would not work in the X509Certificate2 ctor. So I
simply failed to try that.

Once I did, based on your suggestion, everything worked as it should have in
the first place with no other changes to the code.

Thank you again for the phenomenal support! I have been on the mono-list for
a few days now and the responses are always on point. Not only did your
suggestion solve my (admittedly silly oversight) problem, but you also gave
me a couple other avenues that would also work.

Chuck

On Wed, Apr 27, 2011 at 11:07 AM, Sebastien Pouliot &lt;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">sebastien.pouliot at gmail.com</A>&gt; wrote:

&gt;<i> Hello Chuck,
</I>&gt;<i>
</I>&gt;<i> As stated in
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.mono-project.com/FAQ:_Security#Are_SSL_client_certificates_supported_.3F">http://www.mono-project.com/FAQ:_Security#Are_SSL_client_certificates_supported_.3F</A>
</I>&gt;<i>
</I>&gt;<i> client certificates are working with the older API (SslServerStream,
</I>&gt;<i> back from 1.2 beta days) that is present in Mono.Security.dll. You can
</I>&gt;<i> see examples in
</I>&gt;<i> <A HREF="http://www.mono-project.com/UsingClientCertificatesWithXSP">http://www.mono-project.com/UsingClientCertificatesWithXSP</A>
</I>&gt;<i> and look at xsp source code.
</I>&gt;<i>
</I>&gt;<i> SslStream is newer than this (2.0 API) and is reusing the older code
</I>&gt;<i> (Ssl[Client|Server]Stream). I do not recall if client certificates are
</I>&gt;<i> supported (I did not write the SslStream layer code).
</I>&gt;<i>
</I>&gt;<i> Further comments inline...
</I>&gt;<i>
</I>&gt;<i> On Wed, 2011-04-27 at 10:32 -0400, Chuck Budzeak wrote:
</I>&gt;<i> &gt; Greetings all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have an SSL Server written for mono which needs to mutually
</I>&gt;<i> &gt; authenticate with the clients that connect. As soon as a client
</I>&gt;<i> &gt; connects I get:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; System.IO.IOException: The authentication or decryption has failed.
</I>&gt;<i> &gt; ---&gt; Mono.Security.Protocol.Tls.TlsException: Server certificate
</I>&gt;<i> &gt; Private Key unavailable.
</I>&gt;<i> &gt;   at
</I>&gt;<i> &gt;
</I>&gt;<i> Mono.Security.Protocol.Tls.Handshake.Server.TlsClientKeyExchange.ProcessAsTls1
</I>&gt;<i> () [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> &gt;   at Mono.Security.Protocol.Tls.Handshake.HandshakeMessage.Process ()
</I>&gt;<i> &gt; [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> &gt;   at (wrapper remoting-invoke-with-check)
</I>&gt;<i> &gt; Mono.Security.Protocol.Tls.Handshake.HandshakeMessage:Process ()
</I>&gt;<i> &gt;   at
</I>&gt;<i> &gt; Mono.Security.Protocol.Tls.ServerRecordProtocol.ProcessHandshakeMessage
</I>&gt;<i> (Mono.Security.Protocol.Tls.TlsStream handMsg) [0x00000] in &lt;filename
</I>&gt;<i> unknown&gt;:0
</I>&gt;<i> &gt;   at
</I>&gt;<i> &gt; Mono.Security.Protocol.Tls.RecordProtocol.InternalReceiveRecordCallback
</I>&gt;<i> (IAsyncResult asyncResult) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> &gt;   --- End of inner exception stack trace ---
</I>&gt;<i> &gt;   at Mono.Security.Protocol.Tls.SslStreamBase.AsyncHandshakeCallback
</I>&gt;<i> &gt; (IAsyncResult asyncResult) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  I have been at this for a couple days and have read
</I>&gt;<i> &gt; through <A HREF="http://www.mono-project.com/Cryptography">http://www.mono-project.com/Cryptography</A>
</I>&gt;<i> &gt; and <A HREF="http://www.mono-project.com/FAQ:_Security">http://www.mono-project.com/FAQ:_Security</A> a dozen times.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here is my code:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; TcpClient tcpClient = this.tcpListener.AcceptTcpClient();
</I>&gt;<i> &gt; SslStream sslStream = new SslStream(tcpClient.GetStream(), true, new
</I>&gt;<i> &gt; RemoteCertificateValidationCallback(Validator), new
</I>&gt;<i> &gt; LocalCertificateSelectionCallback(SelectLocalCertificate));
</I>&gt;<i> &gt; X509Certificate2 serverCert = new X509Certificate2(&quot;root.cer&quot;);
</I>&gt;<i>
</I>&gt;<i> That won't work. A .cer file contains only a certificate, no private key
</I>&gt;<i> so it won't be able to decrypt anything (which means the server won't
</I>&gt;<i> work, client certs or not).
</I>&gt;<i>
</I>&gt;<i> You should load a PKCS12 file (which includes both the certificate and
</I>&gt;<i> the private key) using the appropriate X509Certificate2 ctor.
</I>&gt;<i>
</I>&gt;<i> Are you able to make your SSL server code working without client
</I>&gt;<i> certificates ? (i.e. one problem at the time ;-)
</I>&gt;<i>
</I>&gt;<i> &gt; sslStream.AuthenticateAsServer(serverCert, true, SslProtocols.Tls,
</I>&gt;<i> &gt; true);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It is failing during the RemoteCertificateValidationCallback, which it
</I>&gt;<i> &gt; doesn't find the private key.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have tried importing the p12 with the private key every way i could
</I>&gt;<i> &gt; google with no result.
</I>&gt;<i>
</I>&gt;<i> You're not telling where you tried this and  I assume 'no result' likely
</I>&gt;<i> means 'no change' ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If I try to manually add the p12 with X509Certificate2 cert = new
</I>&gt;<i> &gt; X509Certificate2(&quot;foo.p12&quot;,&quot;pass&quot;) inside the remote callback, it will
</I>&gt;<i> &gt; load the file fine, but then I don't know what to do with it.
</I>&gt;<i>
</I>&gt;<i> If loaded properly then there should be nothing else to to (assuming
</I>&gt;<i> SslStream supports client certificates properly).
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If i try to add it to the chain, (which is apparently not what I want
</I>&gt;<i> &gt; to do) i get:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; System.IO.IOException: The authentication or decryption has failed.
</I>&gt;<i> &gt; ---&gt; System.NullReferenceException: Object reference not set to an
</I>&gt;<i> &gt; instance of an object
</I>&gt;<i> &gt; at Test.Validator (System.Object sender,
</I>&gt;<i> &gt; System.Security.Cryptography.X509Certificates.X509Certificate
</I>&gt;<i> &gt; certificate, System.Security.Cryptography.X509Certificates.X509Chain
</I>&gt;<i> &gt; chain, SslPolicyErrors sslPolicyErrors) [0x00000] in &lt;filename
</I>&gt;<i> &gt; unknown&gt;:0
</I>&gt;<i> &gt; at System.Net.Security.SslStream
</I>&gt;<i> &gt; +&lt;BeginAuthenticateAsServer&gt;c__AnonStorey8.&lt;&gt;m__B
</I>&gt;<i> &gt; (System.Security.Cryptography.X509Certificates.X509Certificate cert,
</I>&gt;<i> &gt; System.Int32[] certErrors) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i>
</I>&gt;<i> when reporting errors / exceptions always compile with debug and execute
</I>&gt;<i> mono with --debug so we'll get file names and line numbers
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The box it is running on is an openSUSE 11.3 with Mono 2.6.4 (which
</I>&gt;<i> &gt; probably doesn't matter, but I am trying to give as much detail as
</I>&gt;<i> &gt; possible).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have the exact opposite working as part of this server which makes
</I>&gt;<i> &gt; an SSL/TLS connection to another server (AuthenticateAsClient) and it
</I>&gt;<i> &gt; works great. There is just something in this process I am not
</I>&gt;<i> &gt; getting...and it is probably really simple.
</I>&gt;<i>
</I>&gt;<i> Client-side is a very different code path - which is why the original
</I>&gt;<i> design used 2 (client/server) classes.
</I>&gt;<i>
</I>&gt;<i> You do not need to worry about keys (unless you use client certificates
</I>&gt;<i> - and even then the server must _require_ them) when doing client access
</I>&gt;<i> to SSL.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I made the certificate with makecert (as detailed in the links above),
</I>&gt;<i> &gt; added it to the trust with certmgr (ditto), and am at a wall.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any help would be greatly appreciated!
</I>&gt;<i>
</I>&gt;<i> If you're still having issues then please open a bug report (with a
</I>&gt;<i> self-contained test case) and I'll have a look at it.
</I>&gt;<i>
</I>&gt;<i> Sebastien
</I>&gt;<i>
</I>&gt;<i> p.s. an alternative is using the older, tested, API just like XSP
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-list/attachments/20110427/28820854/attachment-0001.html">http://lists.ximian.com/pipermail/mono-list/attachments/20110427/28820854/attachment-0001.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046931.html">[Mono-list] SSL Negotiation
</A></li>
	<LI>Next message: <A HREF="046933.html">[Mono-list] Mono 2.10.2 doesn't seem to work for building MCS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46932">[ date ]</a>
              <a href="thread.html#46932">[ thread ]</a>
              <a href="subject.html#46932">[ subject ]</a>
              <a href="author.html#46932">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
