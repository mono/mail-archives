<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> Overlapped IO was Re: [Mono-list] threads and Async Socket methods
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:boykin%40pobox.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="019787.html">
   <LINK REL="Next"  HREF="019827.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Overlapped IO was Re: [Mono-list] threads and Async Socket methods
   </H1>
    <B>P Oscar Boykin
    </B> 
    <A HREF="mailto:boykin%40pobox.com"
       TITLE="Overlapped IO was Re: [Mono-list] threads and Async Socket methods">boykin@pobox.com
       </A><BR>
    <I>Wed, 28 Apr 2004 14:15:18 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="019787.html">[Mono-list] threads and Async Socket methods
</A></li>
        <LI> Next message: <A HREF="019827.html">Overlapped IO was Re: [Mono-list] threads and Async Socket
 methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19808">[ date ]</a>
              <a href="thread.html#19808">[ thread ]</a>
              <a href="subject.html#19808">[ subject ]</a>
              <a href="author.html#19808">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--5oH/S/bF6lOfqCQb
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Sorry for replying to myself, but I thought some other people might
benefit from seeing a few references.

It seems what I am interested in is the following question:

Does Mono support overlapped IO on the asynchronous socket calls.
Winsock does support this.  It seems the .Net framework is supposed to
support this.  When I put a server under heavily load, this fails on
mono 0.31 on debian unstable.

Any Mono guru's out there care to comment on Overlapped IO on Sockets in
mono?

I have found some background links discussing various issues with
overlapped IO and unix:

Wine has had to deal with this:
<A HREF="http://www.winehq.org/hypermail/wine-devel/2001/11/0020.html">http://www.winehq.org/hypermail/wine-devel/2001/11/0020.html</A>
<A HREF="http://www.kerneltraffic.org/wine/wn20020726_130.html#3">http://www.kerneltraffic.org/wine/wn20020726_130.html#3</A>

Here is a discussion about IO models in winsock programming which sings
the praises of overlapped IO:
<A HREF="http://tangentsoft.net/wskfaq/articles/io-strategies.html">http://tangentsoft.net/wskfaq/articles/io-strategies.html</A>

I am having a hard time writing a test case only using sockets which can
expose (what a believe to be) the bug.  In my code, I have ~50 sockets
which are created with a lot of data being copied between the sockets.
At that point, I start to see sockets which just stop working.  For
instance, BeginSend methods stop calling the callback function, and the
socket basically gets stuck (some internal deadlock maybe?)

I looked at the code for the System.Net.Sockets.Socket class.  It seems
to implement the BeginSend and BeginReceive methods just using a Worker
without any attempt at any kind of thread safety (which I can imagine
would cause problems if you call interleaved BeginSend and BeginRead).

Best,
Oscar

On Tue, Apr 27, 2004 at 05:33:04PM -0700, P Oscar Boykin wrote:
&gt;<i> Hello All,
</I>&gt;<i>=20
</I>&gt;<i> I have some code that does asynchronous Socket.BeginSend and
</I>&gt;<i> Socket.BeginReceive calls.
</I>&gt;<i>=20
</I>&gt;<i> My question is the following:
</I>&gt;<i>=20
</I>&gt;<i> 1) The documentation (in monodoc) says that no instance members of
</I>&gt;<i> Socket are guaranteed to be thread safe.
</I>&gt;<i>=20
</I>&gt;<i> 2) Given the above, is it safe to have a BeginSend call active while a
</I>&gt;<i> BeginReceive call is also active?  Given that the &quot;under the hood&quot; it
</I>&gt;<i> appears that these methods are implemented with threads.
</I>&gt;<i>=20
</I>&gt;<i> So, to make it clear, if I have code like:
</I>&gt;<i>=20
</I>&gt;<i> --------------
</I>&gt;<i> BeginSend()
</I>&gt;<i> BeginReceive()
</I>&gt;<i>=20
</I>&gt;<i> [ other stuff here ]
</I>&gt;<i>=20
</I>&gt;<i> EndReceive()
</I>&gt;<i> EndSend()
</I>&gt;<i> -------------
</I>&gt;<i>=20
</I>&gt;<i> is this safe?  To me, it would seem like it would not be safe if none of
</I>&gt;<i> the members are guaranteed to be thread safe, but on the other hand, I
</I>&gt;<i> have a C# networking book that has examples such as this.
</I>&gt;<i>=20
</I>&gt;<i> The reason I ask is that I have some code that (on mono 0.31) appears
</I>&gt;<i> that *SOMETIMES* the BeginSend never calls the callback function to
</I>&gt;<i> indicate that it finished (and the other side never gets the data).
</I>&gt;<i> This is happening while a BeginReceive() is active.
</I>&gt;<i>=20
</I>&gt;<i> When I see bugs that happen only sometimes, it usually makes me worry
</I>&gt;<i> about thread safety.  It would be nice if the Begin* methods were
</I>&gt;<i> designed such that there could be more than one of them active at a time
</I>&gt;<i> (particularly, it would be nice to have a send going on while a receive
</I>&gt;<i> was also active).
</I>&gt;<i>=20
</I>&gt;<i> Am I expecting too much here?
</I>&gt;<i>=20
</I>&gt;<i> Thanks,
</I>&gt;<i> Oscar
</I>&gt;<i> --=20
</I>&gt;<i> <A HREF="mailto:boykin@pobox.com">boykin@pobox.com</A>    <A HREF="http://pobox.com/~boykin">http://pobox.com/~boykin</A>    jabber: <A HREF="mailto:johnynek@jabber.o">johnynek@jabber.o</A>=
</I>rg
&gt;<i> fingerprint=3DD250 4AD9 4544 B7D2 A17C  911D D608 D387 6718 D75F
</I>&gt;<i> Hague Convention is Bad News: <A HREF="http://www.gnu.org/philosophy/hague.html">http://www.gnu.org/philosophy/hague.html</A>
</I>


--=20
<A HREF="mailto:boykin@pobox.com">boykin@pobox.com</A>    <A HREF="http://pobox.com/~boykin">http://pobox.com/~boykin</A>    jabber: <A HREF="mailto:johnynek@jabber.org">johnynek@jabber.org</A>
fingerprint=3DD250 4AD9 4544 B7D2 A17C  911D D608 D387 6718 D75F
Read about net freedom: <A HREF="http://www.politechbot.com/">http://www.politechbot.com/</A>

--5oH/S/bF6lOfqCQb
Content-Type: application/pgp-signature; name=&quot;signature.asc&quot;
Content-Description: Digital signature
Content-Disposition: inline

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.4 (GNU/Linux)

iD8DBQFAkB7m1gjTh2cY118RAkp6AJ9206JKjyEt86Hr+wLK7/n6wAizVQCfYZ1m
rlkC00b3hULMFtCu6LOI4YE=
=9oS2
-----END PGP SIGNATURE-----

--5oH/S/bF6lOfqCQb--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="019787.html">[Mono-list] threads and Async Socket methods
</A></li>
	<LI> Next message: <A HREF="019827.html">Overlapped IO was Re: [Mono-list] threads and Async Socket
 methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19808">[ date ]</a>
              <a href="thread.html#19808">[ thread ]</a>
              <a href="subject.html#19808">[ subject ]</a>
              <a href="author.html#19808">[ author ]</a>
         </LI>
       </UL>
</body></html>
