<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] [PATCH] Hard coded System.Environment.OSVersion...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:spouliot%40videotron.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019694.html">
   <LINK REL="Next"  HREF="019745.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] [PATCH] Hard coded System.Environment.OSVersion...
   </H1>
    <B>Sebastien Pouliot
    </B> 
    <A HREF="mailto:spouliot%40videotron.ca"
       TITLE="[Mono-list] [PATCH] Hard coded System.Environment.OSVersion...">spouliot@videotron.ca
       </A><BR>
    <I>Fri, 23 Apr 2004 16:40:22 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="019694.html">[Mono-list] Hard coded System.Environment.OSVersion...
</A></li>
        <LI> Next message: <A HREF="019745.html">[Mono-list] [PATCH] Hard coded System.Environment.OSVersion...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19718">[ date ]</a>
              <a href="thread.html#19718">[ thread ]</a>
              <a href="subject.html#19718">[ subject ]</a>
              <a href="author.html#19718">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.

--Boundary_(ID_Jw6ius2t0DS40/mOqn2pBg)
Content-type: text/plain; charset=us-ascii
Content-transfer-encoding: 7BIT

Here's the patches. There may be a better way on Linux to get a version...

The following code...

static void Main(string[] args)
{
	Console.WriteLine (Environment.OSVersion.ToString ());
	Console.WriteLine (Environment.OSVersion.Platform);
	Console.WriteLine (Environment.OSVersion.Version);
}

Should display on Linux...

[<A HREF="mailto:poupou@rh9">poupou@rh9</A> poupou]$ mono version.exe
Unix 2.4.20.8
128
2.4.20.8

[<A HREF="mailto:poupou@rh9">poupou@rh9</A> poupou]$ uname -r
2.4.20-8smp

and on Windows XP SP1...

<A HREF="mailto:spouliot@farscape">spouliot@farscape</A> ~/cvs/mcs/class/corlib
$ mono version.exe
Microsoft Windows NT 5.1.2600.0
Win32NT
5.1.2600.0

<A HREF="mailto:spouliot@farscape">spouliot@farscape</A> ~/cvs/mcs/class/corlib
$ version.exe
Microsoft Windows NT 5.1.2600.0
Win32NT
5.1.2600.0


Sebastien Pouliot
<A HREF="http://pages.infinit.net/ctech/poupou.html">http://pages.infinit.net/ctech/poupou.html</A>

-----Original Message-----
From: <A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>
[mailto:<A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>]On Behalf Of Sebastien Pouliot
Sent: 22 avril 2004 07:33
To: <A HREF="mailto:jonathan.cooper@syntegra.com">jonathan.cooper@syntegra.com</A>; <A HREF="mailto:mark.easton@blinksoftware.co.uk">mark.easton@blinksoftware.co.uk</A>
Cc: <A HREF="mailto:mono-list@lists.ximian.com">mono-list@lists.ximian.com</A>
Subject: RE: [Mono-list] Hard coded System.Environment.OSVersion...


I have a (local) patch that returns the true version number on Windows and
the value of &quot;uname -r&quot; on Linux.
I'll clean it up and sent it for review.

Sebastien Pouliot
<A HREF="http://pages.infinit.net/ctech/poupou.html">http://pages.infinit.net/ctech/poupou.html</A>


-----Original Message-----
From: <A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>
[mailto:<A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>]On Behalf Of
<A HREF="mailto:jonathan.cooper@syntegra.com">jonathan.cooper@syntegra.com</A>
Sent: 22 avril 2004 04:54
To: <A HREF="mailto:mark.easton@blinksoftware.co.uk">mark.easton@blinksoftware.co.uk</A>
Cc: <A HREF="mailto:mono-list@lists.ximian.com">mono-list@lists.ximian.com</A>
Subject: RE: [Mono-list] Hard coded System.Environment.OSVersion...


5.1.2600.0 was the original build number of Windows XP, and I suspect is a
placeholder until the required functionality is completed (very much like
the
class which returns the system drives is currently hard coded to &quot;c:&quot; and
&quot;a:&quot; for windows for now)

Jon

-----Original Message-----
From: <A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>
[mailto:<A HREF="mailto:mono-list-admin@lists.ximian.com">mono-list-admin@lists.ximian.com</A>] On Behalf Of Mark Easton
Sent: Wednesday, April 21, 2004 11:45 AM
To: <A HREF="mailto:mono-list@lists.ximian.com">mono-list@lists.ximian.com</A>
Subject: [Mono-list] Hard coded System.Environment.OSVersion...

Okay, it's been a bit of a while since I pestered the list, so here I am
with
another pesky question.

I know the System.Environment.OSVersion property is hard coded to 5.1.2600.0
(which PNET have copied) but I don't have a complete understanding of why
this is.

I was thinking that some OSes like GNU/Linux don't have definitive version
numbers (although I guess the kernel build gets close), but since a number
of
OSes do have definitive version numbers, and I right in assuming the value
might be retrieved from an internal call in due course?

Cheers,

Mark

_______________________________________________
Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>



********************************************************************

This email may contain information which is privileged or confidential. If
you are not the intended recipient of this email, please notify the sender
immediately and delete it without reading, copying, storing, forwarding or
disclosing its contents to any other person
Thank you

Check us out at <A HREF="http://www.btsyntegra.com">http://www.btsyntegra.com</A>

********************************************************************

_______________________________________________
Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>

_______________________________________________
Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>

--Boundary_(ID_Jw6ius2t0DS40/mOqn2pBg)
Content-type: application/octet-stream; name=version.diff
Content-transfer-encoding: 7bit
Content-disposition: attachment; filename=version.diff

? Environment.diff
? version.diff
Index: ChangeLog
===================================================================
RCS file: /cvs/public/mcs/class/corlib/System/ChangeLog,v
retrieving revision 1.758
diff -u -r1.758 ChangeLog
--- ChangeLog	23 Apr 2004 15:02:26 -0000	1.758
+++ ChangeLog	23 Apr 2004 19:58:43 -0000
@@ -1,3 +1,9 @@
+2004-04-xx  Sebastien Pouliot  &lt;<A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>&gt;
+
+	* Environment.cs: Completed OSVersion property.
+	* Version.cs: Added internal CreateFromString() to &quot;try&quot; to build the
+	best version number form the specified string.
+
 2004-04-23  Sebastien Pouliot  &lt;<A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>&gt;
 
 	* Environment.cs: Better support for GetFolderPath (same results as MS 
Index: Environment.cs
===================================================================
RCS file: /cvs/public/mcs/class/corlib/System/Environment.cs,v
retrieving revision 1.63
diff -u -r1.63 Environment.cs
--- Environment.cs	23 Apr 2004 15:02:26 -0000	1.63
+++ Environment.cs	23 Apr 2004 19:58:43 -0000
@@ -151,15 +151,18 @@
 			get;
 		}
 
+		[MethodImplAttribute (MethodImplOptions.InternalCall)]
+		internal static extern string GetOSVersionString ();
+
 		/// &lt;summary&gt;
 		/// Gets the current OS version information
 		/// &lt;/summary&gt;
-		[MonoTODO(&quot;Correct version&quot;)]
 		public static OperatingSystem OSVersion {
 			get {
-				if (os == null)
-					os = new OperatingSystem (Platform, new Version (5,1,2600,0));
-
+				if (os == null) {
+					Version v = Version.CreateFromString (GetOSVersionString ());
+					os = new OperatingSystem (Platform, v);
+				}
 				return os;
 			}
 		}
Index: Version.cs
===================================================================
RCS file: /cvs/public/mcs/class/corlib/System/Version.cs,v
retrieving revision 1.13
diff -u -r1.13 Version.cs
--- Version.cs	8 Mar 2004 19:42:28 -0000	1.13
+++ Version.cs	23 Apr 2004 19:58:43 -0000
@@ -267,5 +267,52 @@
 		{
 			return v1.CompareTo (v2) &lt;= 0;
 		}
+
+		// a very gentle way to construct a Version object which takes 
+		// the first four numbers in a string as the version
+		internal static Version CreateFromString (string info)
+		{
+			int major = 0;
+			int minor = 0;
+			int build = 0;
+			int revision = 0;
+			int state = 1;
+			int number = UNDEFINED; // string may not begin with a digit
+
+			for (int i=0; i &lt; info.Length; i++) {
+				char c = info [i];
+				if (Char.IsDigit (c)) {
+					if (number &lt; 0) {
+						number = (c - '0');
+					}
+					else {
+						number = (number * 10) + (c - '0');
+					}
+				}
+				else if (number &gt;= 0) {
+					// assign
+					switch (state) {
+					case 1:
+						major = number;
+						break;
+					case 2:
+						minor = number;
+						break;
+					case 3:
+						build = number;
+						break;
+					case 4:
+						revision = number;
+						break;
+					}
+					number = -1;
+					state ++;
+				}
+				// ignore end of string
+				if (state == 5)
+					break;
+			}
+			return new Version (major, minor, build, revision);
+		}
 	}
 }

--Boundary_(ID_Jw6ius2t0DS40/mOqn2pBg)
Content-type: application/octet-stream; name=runtime.diff
Content-transfer-encoding: quoted-printable
Content-disposition: attachment; filename=runtime.diff

Index: mono/metadata/environment.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/mono/mono/metadata/environment.c,v
retrieving revision 1.1
diff -u -r1.1 environment.c
--- mono/metadata/environment.c	23 Jan 2003 17:46:25 -0000	1.1
+++ mono/metadata/environment.c	23 Apr 2004 20:00:01 -0000
@@ -1,16 +1,24 @@
 /*
  * environment.c: System.Environment support internal calls
  *
- * Author:
+ * Authors:
  *	Dick Porter (<A HREF="mailto:dick@ximian.com">dick@ximian.com</A>)
+ *	Sebastien Pouliot (<A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>)
  *
  * (C) 2002 Ximian, Inc.
+ * (C) 2004 Novell (<A HREF="http://www.novell.com">http://www.novell.com</A>)
  */
=20
 #include &lt;config.h&gt;
 #include &lt;glib.h&gt;
=20
+#include &lt;mono/metadata/appdomain.h&gt;
 #include &lt;mono/metadata/environment.h&gt;
+#include &lt;mono/metadata/exception.h&gt;
+
+#ifndef PLATFORM_WIN32
+#include &lt;sys/utsname.h&gt;
+#endif
=20
 static gint32 exitcode=3D0;
=20
@@ -22,4 +30,36 @@
 void mono_environment_exitcode_set (gint32 value)
 {
 	exitcode=3Dvalue;
+}
+
+/* note: we better manipulate the string in managed code (easier and =
safer) */
+MonoString*
+ves_icall_System_Environment_GetOSVersionString (void)
+{
+#ifdef PLATFORM_WIN32
+	OSVERSIONINFO verinfo;
+
+	MONO_ARCH_SAVE_REGS;
+
+	verinfo.dwOSVersionInfoSize =3D sizeof (OSVERSIONINFO);
+	if (GetVersionEx (&amp;verinfo)) {
+		char version [64];
+		// maximum string length is 35 bytes
+		// 3 x 10 bytes per number, 1 byte for 0, 3 x 1 byte for dots, 1 for =
NULL
+		sprintf (version, &quot;%ld.%ld.%ld.0&quot;,=20
+			verinfo.dwMajorVersion,
+			verinfo.dwMinorVersion,
+			verinfo.dwBuildNumber);
+		return mono_string_new (mono_domain_get (), version);
+	}
+#else
+	struct utsname name;
+
+	MONO_ARCH_SAVE_REGS;
+
+	if (uname (&amp;name) =3D=3D 0) {
+		return mono_string_new (mono_domain_get (), name.release);
+	}
+#endif
+	return mono_string_new (mono_domain_get (), &quot;0.0.0.0&quot;);
 }
Index: mono/metadata/environment.h
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/mono/mono/metadata/environment.h,v
retrieving revision 1.1
diff -u -r1.1 environment.h
--- mono/metadata/environment.h	23 Jan 2003 17:46:25 -0000	1.1
+++ mono/metadata/environment.h	23 Apr 2004 20:00:01 -0000
@@ -13,4 +13,6 @@
 extern gint32 mono_environment_exitcode_get (void);
 extern void mono_environment_exitcode_set (gint32 value);
=20
+extern MonoString* ves_icall_System_Environment_GetOSVersionString =
(void);
+
 #endif /* _MONO_METADATA_ENVIRONMENT_H_ */
Index: mono/metadata/icall.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/mono/mono/metadata/icall.c,v
retrieving revision 1.466
diff -u -r1.466 icall.c
--- mono/metadata/icall.c	23 Apr 2004 14:58:44 -0000	1.466
+++ mono/metadata/icall.c	23 Apr 2004 20:00:02 -0000
@@ -4959,7 +4959,8 @@
 	{&quot;GetCommandLineArgs&quot;, mono_runtime_get_main_args},
 	{&quot;GetEnvironmentVariable&quot;, =
ves_icall_System_Environment_GetEnvironmentVariable},
 	{&quot;GetEnvironmentVariableNames&quot;, =
ves_icall_System_Environment_GetEnvironmentVariableNames},
-	{&quot;GetMachineConfigPath&quot;,	=
ves_icall_System_Configuration_DefaultConfig_get_machine_config_path},
+	{&quot;GetMachineConfigPath&quot;, =
ves_icall_System_Configuration_DefaultConfig_get_machine_config_path},
+	{&quot;GetOSVersionString&quot;, =
ves_icall_System_Environment_GetOSVersionString},
 	{&quot;GetWindowsFolderPath&quot;, =
ves_icall_System_Environment_GetWindowsFolderPath},
 	{&quot;get_ExitCode&quot;, mono_environment_exitcode_get},
 	{&quot;get_HasShutdownStarted&quot;, =
ves_icall_System_Environment_get_HasShutdownStarted},

--Boundary_(ID_Jw6ius2t0DS40/mOqn2pBg)--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="019694.html">[Mono-list] Hard coded System.Environment.OSVersion...
</A></li>
	<LI> Next message: <A HREF="019745.html">[Mono-list] [PATCH] Hard coded System.Environment.OSVersion...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19718">[ date ]</a>
              <a href="thread.html#19718">[ thread ]</a>
              <a href="subject.html#19718">[ subject ]</a>
              <a href="author.html#19718">[ author ]</a>
         </LI>
       </UL>
</body></html>
