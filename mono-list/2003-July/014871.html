<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] Dispose method is never called
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gius.greco%40bluewin.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="014870.html">
   <LINK REL="Next"  HREF="014873.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] Dispose method is never called
   </H1>
    <B>Giuseppe Greco
    </B> 
    <A HREF="mailto:gius.greco%40bluewin.ch"
       TITLE="[Mono-list] Dispose method is never called">gius.greco@bluewin.ch
       </A><BR>
    <I>Tue, 8 Jul 2003 07:30:55 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="014870.html">[Mono-list] Dispose method is never called
</A></li>
        <LI> Next message: <A HREF="014873.html">[Mono-list] Dispose method is never called
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14871">[ date ]</a>
              <a href="thread.html#14871">[ thread ]</a>
              <a href="subject.html#14871">[ subject ]</a>
              <a href="author.html#14871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>-- Original Message --
</I>&gt;<i>From: &quot;Giuseppe Greco&quot; &lt;<A HREF="mailto:gius.greco@bluewin.ch">gius.greco@bluewin.ch</A>&gt;
</I>&gt;<i>Subject: Re: [Mono-list] Dispose method is never called
</I>&gt;<i>To: <A HREF="mailto:mono-list@lists.ximian.com">mono-list@lists.ximian.com</A>
</I>&gt;<i>Cc: <A HREF="mailto:normri@samc.com">normri@samc.com</A>
</I>&gt;<i>Date: Tue, 8 Jul 2003 06:30:54 +0200
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>-- Original Message --
</I>&gt;&gt;<i>From: &quot;Giuseppe Greco&quot; &lt;<A HREF="mailto:gius.greco@bluewin.ch">gius.greco@bluewin.ch</A>&gt;
</I>&gt;&gt;<i>Subject: Re: [Mono-list] Dispose method is never called
</I>&gt;&gt;<i>To: <A HREF="mailto:mono-list@lists.ximian.com">mono-list@lists.ximian.com</A>
</I>&gt;&gt;<i>Cc: <A HREF="mailto:normri@samc.com">normri@samc.com</A>
</I>&gt;&gt;<i>Date: Tue, 8 Jul 2003 06:25:33 +0200
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Well, in the class above, the Dispose() method is never
</I>&gt;&gt;&gt;&gt;<i> called. This is a problem if one needs to wait until the
</I>&gt;&gt;&gt;&gt;<i> thread has finished its work -- Thread.Join() should block
</I>&gt;&gt;&gt;&gt;<i> until then.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The destructor -- ~MyClass() -- is never called.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Is it called under windows? I think it's not because MyThreadMethod is
</I>&gt;&gt;&gt;<i> accessing isDisposed field, which belongs to the class instance.
</I>&gt;&gt;&gt;<i> That's
</I>&gt;&gt;&gt;<i> why it's never disposed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I've also  tried an empty thread function like this
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>private void MyThreadMethod()
</I>&gt;&gt;<i>{
</I>&gt;&gt;<i>  while (true) {
</I>&gt;&gt;<i>    Thread.Sleep(100);
</I>&gt;&gt;<i>  {
</I>&gt;&gt;<i>}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>... but the class is still never disposed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Gius_.
</I>&gt;<i>
</I>&gt;<i>Some additional information
</I>
Sorry, I've accidentally pressed the &quot;send&quot; button...

By the way, here below is my original code:


protected virtual void Dispose(bool disposing)
{
  if (!isDisposed) {
    isDisposed = true;

    if (disposing) {
      listener.Join();
      listener = null;

      socket.Close();
      socket = null;
    }
  }
}

private void Listen()
{
  AsyncToken token = null;
  EndPoint endPoint = null;

  while (!isDisposed) {
    if (socket.Poll(PollTimeOut, SelectMode.SelectRead)) {
      token = new AsyncToken(socket, new byte[socket.Available]);
      endPoint = (EndPoint) localEndPoint;
      socket.BeginReceiveFrom(
        (byte[]) token.Data,
        0,
        ((byte[]) token.Data).Length,
        SocketFlags.None,
        ref endPoint,
        new AsyncCallback(AsyncReceive),
        token);
    }
  }
}

As you can see, Dispose set isDisposed to false, letting
the Listen thread function stop and exit. So, the fact that
the thread function uses an instance field should not be a
problem at all. Furthermore, this works with .NET.

As I've written in my previous email, even if the thread
method doesn't refer instance fields, the destructor
(or Finalize method if you prefer) is never called.

The Listen method above continuously call the Poll()
method to see if new data is available... but since the
class is just dropped without finalizing, it can occur
that Poll() is interrupted brutally (and that's why I
often get a SocketException containing the message
&quot;Interrupted&quot;).

Gius_.

&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -Gonzalo
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;<i>Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
</I>&gt;&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Mono-list maillist  -  <A HREF="mailto:Mono-list@lists.ximian.com">Mono-list@lists.ximian.com</A>
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="014870.html">[Mono-list] Dispose method is never called
</A></li>
	<LI> Next message: <A HREF="014873.html">[Mono-list] Dispose method is never called
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14871">[ date ]</a>
              <a href="thread.html#14871">[ thread ]</a>
              <a href="subject.html#14871">[ subject ]</a>
              <a href="author.html#14871">[ author ]</a>
         </LI>
       </UL>
</body></html>
