<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] UDP Broadcast Socket.ReceiveFrom Anomalies
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mdfranz%40io.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="019260.html">
   <LINK REL="Next"  HREF="019249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] UDP Broadcast Socket.ReceiveFrom Anomalies
   </H1>
    <B>Matthew Franz
    </B> 
    <A HREF="mailto:mdfranz%40io.com"
       TITLE="[Mono-list] UDP Broadcast Socket.ReceiveFrom Anomalies">mdfranz@io.com
       </A><BR>
    <I>Wed, 24 Mar 2004 23:37:14 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="019260.html">[Mono-list] I broke XSP
</A></li>
        <LI> Next message: <A HREF="019249.html">[Mono-list] I broke XSP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19248">[ date ]</a>
              <a href="thread.html#19248">[ thread ]</a>
              <a href="subject.html#19248">[ subject ]</a>
              <a href="author.html#19248">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm writing (actually trying to simulate) a simple UDP client and I've noticed some anomalies between Mono 0.31 and .NET in terms of
the handling the messages. I'm assuming because the replies from the server are broadcasts.

1) C: 1.1.1.1 -&gt; 1.1.1.2 (or 1.1.1.255) S:
2) S: 1.1.1.2 -&gt; 1.1.1.255 C:

With mono, the client only gets the data from the server if the message 1 is sent to the server's broadcast address. The client
ignores the data if it was sent to the server's unicast address. With .NET it receives the data regardless of the destination address 
of message 1. Whether or not the socket option is set to broadcast doesn't make any difference.

In both cases the server is responding the same (verified with tcpdump) and there isn't anything weird (like non-Ethernet II frames)  
at the datalink layer. There is also a discrepancy between the value returned by s.Available. Mono returns just the length of the
next message but .NET returns the length of all the responses.

And I've seen <A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=45959">http://bugzilla.ximian.com/show_bug.cgi?id=45959</A>

Any ideas? I'm assuming I made a simple mistake, and .NET is more forgiving?

= mdf

================================================================

IPEndPoint ep = new IPEndPoint(ip,dport);  //remote
IPEndPoint lep = new IPEndPoint(IPAddress.Any,sport); //local
		
Socket s = new Socket(AddressFamily.InterNetwork,SocketType.Dgram,ProtocolType.Udp);

if (dstbcast) {
	s.SetSocketOption(SocketOptionLevel.Socket, SocketOptionName.Broadcast,1);
}

s.Bind(lep);
		
try {
	s.SendTo(Message1, ep);
}
catch (Exception e) {
	Console.WriteLine(e.ToString());
}

byte[] rBuffer = new byte[1500];

IPEndPoint sender = new IPEndPoint(IPAddress.Any,0);
EndPoint target = (EndPoint)sender;

System.Console.WriteLine(&quot;{0} bytes in the buffer&quot;,s.Available);

while (s.Available &gt; 0) {

	int recv_bytes = s.ReceiveFrom(rBuffer, ref target);
			
	// For some reason we are getting our own message with ReceiveFrom
	// and this doesn't work for multihomed
			
	if (target == sender) {
		continue;
	}

	System.Console.Write (&quot;{0} bytes &quot;,recv_bytes);
	System.Console.WriteLine(&quot;Received from:&quot;+((IPEndPoint)target).Address.ToString()+&quot;\n&quot; );

	for (int i=0; i&lt;recv_bytes; i++) {
		Console.Write(&quot;{0:X} &quot;,rBuffer[i]);
	}
	Console.WriteLine(&quot;\n&quot;);
}

s.Close();



-- 
|<i> Matthew Franz                              <A HREF="mailto:mdfranz@io.com">mdfranz@io.com</A> |
</I>|<i>              <A HREF="http://www.io.com/~mdfranz">http://www.io.com/~mdfranz</A>                   |
</I>
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="019260.html">[Mono-list] I broke XSP
</A></li>
	<LI> Next message: <A HREF="019249.html">[Mono-list] I broke XSP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19248">[ date ]</a>
              <a href="thread.html#19248">[ thread ]</a>
              <a href="subject.html#19248">[ subject ]</a>
              <a href="author.html#19248">[ author ]</a>
         </LI>
       </UL>
</body></html>
