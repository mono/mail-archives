<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20P/Invoke%2C%20Mono%2C%20.NET%20and%20Windows%20XP%20funny%20platform&In-Reply-To=1118402968.27380.30.camel%40melchior">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027428.html">
   <LINK REL="Next"  HREF="027470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform</H1>
    <B>Francis Brosnan Bl&#225;zquez</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20P/Invoke%2C%20Mono%2C%20.NET%20and%20Windows%20XP%20funny%20platform&In-Reply-To=1118402968.27380.30.camel%40melchior"
       TITLE="[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform">francis at aspl.es
       </A><BR>
    <I>Mon Jun 13 10:30:10 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="027428.html">[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform
</A></li>
        <LI>Next message: <A HREF="027470.html">[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27458">[ date ]</a>
              <a href="thread.html#27458">[ thread ]</a>
              <a href="subject.html#27458">[ subject ]</a>
              <a href="author.html#27458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First of all, thanks for your reply. It have been really productive.

Some issues about your reply:

&gt;<i>Your fundamental problem is that you're targeting Windows XP.
</I>&gt;<i>
</I>&gt;<i>Ha ha only serious.  (A colloquialism for &quot;that's funny, but I'm serious
</I>&gt;<i>too...&quot;)
</I>&gt;<i>
</I>&gt;<i>The slightly longer explanation is here:
</I>&gt;<i>
</I>&gt;<i>	<A HREF="http://www.mono-project.com/Interop_with_Native_Libraries#Windows_DLL_Search_Path">http://www.mono-project.com/Interop_with_Native_Libraries#Windows_DLL_Search_Path</A>
</I>&gt;<i>
</I>&gt;<i>The real explanation is that Win32 is broken when it comes to supporting
</I>&gt;<i>multiple different versions of the &quot;same&quot; library.  Absolutely,
</I>&gt;<i>fundamentally, *broken*.  More to the point, it doesn't support this AT
</I>&gt;<i>ALL -- you can only have ONE version of any given library in use at any
</I>&gt;<i>point in time.
</I>&gt;<i>
</I>&gt;<i>Win32 has three issues you're running into:
</I>&gt;<i>
</I>&gt;<i> 1. No built-in versioning support for libraries, as noted above.
</I>&gt;<i>    Which is to say, if you load C:\Windows\System32\OLE32.dll, you 
</I>&gt;<i>    can't say that you want version 1 or version 2 of that library, 
</I>&gt;<i>    you get whichever version is at C:\Windows\System32\OLE32.dll.
</I>&gt;<i>
</I>&gt;<i> 2. This doesn't mean you can't have multiple different versions 
</I>&gt;<i>    installed.  It just means that each different version needs to 
</I>&gt;<i>    reside in a different directory, which leaves you the option of
</I>&gt;<i>    (a) always specifying a full (or relative) directory for your
</I>&gt;<i>    library, or (b) accepting the default path and placing your library
</I>&gt;<i>    into an appropriate location.
</I>&gt;<i>
</I>&gt;<i>    So if you didn't like Microsoft's OLE32.DLL, you could place a copy
</I>&gt;<i>    into your application's directory, and *that* one would get loaded.
</I>&gt;<i>
</I>&gt;<i>    Alas, this means you can have the scenario you're describing, where
</I>&gt;<i>    both mono and your app bundle glib.  This is unfortunate, because of
</I>&gt;<i>    issue (3).
</I>&gt;<i>
</I>&gt;<i> 3. Win32 doesn't keep track of the full path name to a library.  It 
</I>&gt;<i>    only remembers the basename of the library.
</I>&gt;<i>
</I>&gt;<i>    Translation:  If you LoadLibrary() C:\mono\glib.dll, Win32 will know
</I>&gt;<i>    that it's loaded &quot;glib.dll&quot;.  If you then LoadLibrary() 
</I>&gt;<i>    C:\yourapp\glib.dll, Win32 will hand you back a handle to 
</I>&gt;<i>    C:\mono\glib.dll, because they both share the same basename 
</I>&gt;<i>    (glib.dll) -- C:\yourapp\glib.dll is NOT loaded.
</I>&gt;<i>
</I>&gt;<i>    Win32 doesn't operate on full paths.  This is a feature (in certain 
</I>&gt;<i>    contexts, anyway -- it's what allows you to provide your own version
</I>&gt;<i>    of OLE32.dll, or any other system library, and have it be used).
</I>&gt;<i>
</I>&gt;<i>So, to answer your questions...
</I>&gt;<i>
</I>&gt;<i>On Thu, 2005-06-09 at 19:23 +0200, Francis Brosnan Bl&#225;zquez wrote:
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>* Any application which p/invokes libraries that are also provided by
</I>&gt;&gt;<i>mono must compile its native dll versions against the mono dll or it
</I>&gt;&gt;<i>is posible to compile these ones against, for example, a glib not
</I>&gt;&gt;<i>provided by the mono installer?
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Is it possible?  Yes.  But to use your version of glib and not mono's
</I>&gt;<i>version, you'd need to alter the library search order for mono to ensure
</I>&gt;<i>it loads your version of glib and not mono's.
</I>&gt;<i>
</I>&gt;<i>This probably is bad, because it will effect every application started
</I>&gt;<i>with mono, and your glib might not be compatible with mono's glib, which
</I>&gt;<i>would (likely) kill mono instantly.
</I>&gt;<i>
</I>&gt;<i>So it's possible, but it's not advisable. :-)
</I>&gt;<i>
</I>&gt;<i>Plus, it'll use extra disk space, so it would be nicer to use mono's
</I>&gt;<i>glib anyway...
</I>&gt;<i>  
</I>&gt;<i>
</I>The space impact that may have including several libraries using 
different names don't
worry us. But setting a dependency against the mono libraries, such as 
libglib-2.0, force
us to run over Mono and only over it. As you pointed following, the 
library renaming
could be a solution to be able to run on top of Mono and microsoft .NET 
runtime.

&gt;<i>Alternatively, name your glib.dll with a different basename, e.g. af-
</I>&gt;<i>arch-glib.dll, and rebuild all your libraries against this basename.
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>About the library renaming issue.

Renaming library basename could help us to find a solution to build 
application that can run
on top of mono and .NET runtime ensuring the libraries the af-arch 
framework relies on will
allways be loaded using the dll version we have used (appending the 
&quot;af-arch-&quot;)
on develop stage.

My question is: Could this confuse the windows dinamic library loading 
to load a library
called glib.dll and another one called af-arch-glib.dll both exporting 
the same symbols?

In other words, while running applications using .NET and doing P/Invoke 
over the
af-arch-glib.dll the LoadLibrary will find it with no problem as well the
Mono enviroment will do but, in the case of Mono, it have the glib.dll 
already loaded
exporting the same (or mostly) symbols leading to have loaded into 
memory two
version for the same entry point.

Using as follow [DllImport(&quot;af-arch-glib&quot;)] will ensure the .NET runtime 
as well as Mono to
load the af-arch-glib.dll library. But will this also guide both 
runtimes to differenciate the symbols
exported from glib.dll and those ones from af-arch-glib.dll?


&gt;&gt;<i>* What happens if the mono runtime detects a P/Invoke over a library
</I>&gt;&gt;<i>A.dll which depends on B.dll and then another P/Invoke over the
</I>&gt;&gt;<i>library C.dll which depends on B'.dll knowing that B.dll and B'.dll
</I>&gt;&gt;<i>are the same library but not the same file?
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Mono isn't in control of library loading, Win32 is.  (Mono uses GLib's
</I>&gt;<i>g_module API, which in turn uses LoadLibrary().)
</I>&gt;<i>
</I>&gt;<i>So, what would Win32 do?  It would load A.dll (as found through the
</I>&gt;<i>normal DLL search path), would look for and load B.dll (ditto), and when
</I>&gt;<i>C.dll was loaded it would see that B.dll was already loaded, and not
</I>&gt;<i>load a new one, so C.dll would get the *first* B.dll that was ever
</I>&gt;<i>loaded.
</I>&gt;<i>
</I>&gt;<i>In short, don't do that. :-)
</I>&gt;<i>
</I>&gt;<i>(I'm not entirely sure why this works for you on Linux either, unless
</I>&gt;<i>you depend on a different version of glib than mono does, in which case
</I>&gt;<i>you'd bring in a different .so-name.  However, given that Linux/ELF
</I>&gt;<i>doesn't require a symbol to come from a given library, and instead
</I>&gt;<i>matches a symbol reference to ANY MATCHING SYMBOL within the address
</I>&gt;<i>space, I fail to see how, if B.so.2 is already loaded, when C.so.1 is
</I>&gt;<i>loaded and brings in B.so.3, you could ensure that C.so.1 actually uses
</I>&gt;<i>the functions in B.so.3 and not B.so.2, since the dynamic linker should
</I>&gt;<i>find the B.so.2 symbols first...  Madness, I say. :-)
</I>&gt;<i>  
</I>&gt;<i>
</I>Well, what is happening is that we use Debian ;-). As other Linux 
distributions, the libraries dependecy
is handled by the package system avoid you lot of problems. Libraries 
dependencies are set to the
same for both mono and af-arch, but, libglib and libxml are not bundle 
as part of the mono package as
opposed to windows platform.

&gt;<i> - Jon
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>Thanks Jon,

- Francis

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027428.html">[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform
</A></li>
	<LI>Next message: <A HREF="027470.html">[Mono-list] P/Invoke, Mono, .NET and Windows XP funny platform
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27458">[ date ]</a>
              <a href="thread.html#27458">[ thread ]</a>
              <a href="subject.html#27458">[ subject ]</a>
              <a href="author.html#27458">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
