<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] HttpHandler for *.jpg
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HttpHandler%20for%20%2A.jpg&In-Reply-To=1119281106.25466.117.camel%40localhost">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027550.html">
   <LINK REL="Next"  HREF="027537.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] HttpHandler for *.jpg</H1>
    <B>Martin Hinks</B> 
    <A HREF="mailto:mono-list%40lists.ximian.com?Subject=%5BMono-list%5D%20HttpHandler%20for%20%2A.jpg&In-Reply-To=1119281106.25466.117.camel%40localhost"
       TITLE="[Mono-list] HttpHandler for *.jpg">mhinks at gmail.com
       </A><BR>
    <I>Mon Jun 20 11:35:33 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="027550.html">[Mono-list] HttpHandler for *.jpg
</A></li>
        <LI>Next message: <A HREF="027537.html">[Mono-list] HttpHandler for *.jpg
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27551">[ date ]</a>
              <a href="thread.html#27551">[ thread ]</a>
              <a href="subject.html#27551">[ subject ]</a>
              <a href="author.html#27551">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Seems like a bug with passing the QS through to the handler, maybe
file a BugZilla report unless anyone else has more info....

Martin

On 6/20/05, Marc DM &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">m at phronein.com</A>&gt; wrote:
&gt;<i> After a little bit of debugging,
</I>&gt;<i> I have discovered that when there are QueryString parameters, passed
</I>&gt;<i> such as /images/pic1.jpg?thumb=1 the ProcessRequest method of the
</I>&gt;<i> Handler doesn't get called.
</I>&gt;<i> 
</I>&gt;<i> I added a line to the ProcessRequest medhod to write a log to a text
</I>&gt;<i> file for each iteration of the method. I also added log statements to
</I>&gt;<i> various places in the code.
</I>&gt;<i> 
</I>&gt;<i> After browsing a couple of pages, I realize that every entry in the log
</I>&gt;<i> is an entry for which there is no querystring.
</I>&gt;<i> 
</I>&gt;<i> Below is the code I put in the handler :
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;       public class ImageHandler:IHttpHandler
</I>&gt;<i> &gt;       {
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;               HttpResponse Response;
</I>&gt;<i> &gt;               HttpRequest Request;
</I>&gt;<i> &gt;               HttpServerUtility Server;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;               #region IHttpHandler Members
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;               public void ProcessRequest(HttpContext context)
</I>&gt;<i> &gt;               {
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                       //Set global context objects
</I>&gt;<i> &gt;                       Server = context.Server;
</I>&gt;<i> &gt;                       Response = context.Response;
</I>&gt;<i> &gt;                       Request = context.Request;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                       //Do the image stuff
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ///DEBUG
</I>&gt;<i> &gt;                       Log(&quot;Beginning image output [QS=&quot; + Request.QueryString.Count.ToString() + &quot;] = &quot; + Request.RawUrl);
</I>&gt;<i> &gt; ///DEBUG
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                       RequestImage();
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;               }
</I>&gt;<i> &gt;               public bool IsReusable
</I>&gt;<i> &gt;               {
</I>&gt;<i> &gt;                       get{ return true;
</I>&gt;<i> &gt;               }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [... rest of the handler code ...]
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> And the Logger.
</I>&gt;<i> 
</I>&gt;<i> &gt; //debugging logger
</I>&gt;<i> &gt;     public static void Log (String logMessage)
</I>&gt;<i> &gt;     {
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;       StreamWriter w = File.AppendText(&quot;/home/gary/www/mysite/www/images/hih_cache/hih_log.txt&quot;);
</I>&gt;<i> &gt;         w.Write(&quot;\r\nLog Entry : &quot;);
</I>&gt;<i> &gt;         w.WriteLine(&quot;{0} {1}&quot;, DateTime.Now.ToLongTimeString(),
</I>&gt;<i> &gt;             DateTime.Now.ToLongDateString());
</I>&gt;<i> &gt;         w.WriteLine(&quot;  :{0}&quot;, logMessage);
</I>&gt;<i> &gt;         w.WriteLine (&quot;-------------------------------&quot;);
</I>&gt;<i> &gt;         // Update the underlying file.
</I>&gt;<i> &gt;         w.Flush();
</I>&gt;<i> &gt;         w.Close();
</I>&gt;<i> &gt;     }
</I>&gt;<i> 
</I>&gt;<i> Records in the log file were like :
</I>&gt;<i> 
</I>&gt;<i> &gt; Log Entry : 10:02:52 AM Monday, June 20, 2005
</I>&gt;<i> &gt;   :Beginning image output [QS=0] = /images/banner_c1.jpg
</I>&gt;<i> &gt; -------------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Anyone else having this kinda fun?
</I>&gt;<i> 
</I>&gt;<i> Marc DM
</I>&gt;<i> 
</I>&gt;<i> ---------------
</I>&gt;<i> 
</I>&gt;<i> On Mon, 2005-06-20 at 08:58 +0100, Martin Hinks wrote:
</I>&gt;<i> &gt; What part of the app is failing?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is the handler for .jpg types being called but the querystring is blank?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Have you traced through the application? If you can find exactly what
</I>&gt;<i> &gt; is failing we can file BugZilla reports.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; If the handler is working post some source and I'll take a look later.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; To find out what's going on add &quot;response.writeline&quot; statements at
</I>&gt;<i> &gt; various points in your code - or try Mono Debugger - although I dont
</I>&gt;<i> &gt; know how advanced it is...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Martin
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 6/20/05, Marc DM &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">m at phronein.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; (*falling asleep as I type this*)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I have a HttpHandler that works on .NET but not on Mono. I need some
</I>&gt;<i> &gt; &gt; help to sort it out.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It is a HttpHandler to allow me to use a url like :
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;    <A HREF="http://mysite/images/Beach12/DCS001.JPG?w=200">http://mysite/images/Beach12/DCS001.JPG?w=200</A>
</I>&gt;<i> &gt; &gt;    to give me the image at the specified url, but proportionately
</I>&gt;<i> &gt; &gt; resized to 200px wide.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;    <A HREF="http://mysite/images/Beach12/DCS001.JPG?thumb=1">http://mysite/images/Beach12/DCS001.JPG?thumb=1</A>
</I>&gt;<i> &gt; &gt;    to give me the image at the specified url, resized to a pre-defined
</I>&gt;<i> &gt; &gt; thumbnail size
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; etc...
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I have the HttpHandler, written in c#, it compiles on mono (had to
</I>&gt;<i> &gt; &gt; change Response.TransmitFile to Response.WriteFile); no errors.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It compiles on Windows. No Problem.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; using Microsoft .NET Framework 1.1 when I access
</I>&gt;<i> &gt; &gt; <A HREF="http://mysite/images/Beach12/DCS001.JPG?thumb=1">http://mysite/images/Beach12/DCS001.JPG?thumb=1</A> from my browser, a
</I>&gt;<i> &gt; &gt; thumbnailed version of the photo is created in the cache directory (if
</I>&gt;<i> &gt; &gt; it doesn't already exist, within the site), and then returned to the
</I>&gt;<i> &gt; &gt; browser. It works.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; on Apache/2.0.54 (Debian GNU/Linux) mod_mono/1.0.9
</I>&gt;<i> &gt; &gt; Everything else in the application works beautifully.  But a call to
</I>&gt;<i> &gt; &gt; <A HREF="http://mysite/images/Beach12/DCS001.JPG?thumb=1">http://mysite/images/Beach12/DCS001.JPG?thumb=1</A> returns the full size
</I>&gt;<i> &gt; &gt; image and the QueryString is seemingly ignored.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; My Apache config, mono webapp file,web.config are attached below.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Can someone clue me in? How can I tell what's happening here.
</I>&gt;<i> &gt; &gt; Thanks.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Marc DM
</I>&gt;<i> &gt; &gt; -----------------APACHE CONFIG---------------------
</I>&gt;<i> &gt; &gt; ---------------------/etc/apache2/sites-available/mysite----------
</I>&gt;<i> &gt; &gt; NameVirtualHost *:80
</I>&gt;<i> &gt; &gt; &lt;VirtualHost *:80&gt;
</I>&gt;<i> &gt; &gt;        ServerName mysite
</I>&gt;<i> &gt; &gt;        ServerAdmin <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">webmaster at mysite</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;        DocumentRoot /home/gary/www/mysite/www/
</I>&gt;<i> &gt; &gt;        AddHandler mono .aspx .ascx .jpg
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;        DirectoryIndex default.aspx index.aspx default.html index.html
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;        &lt;Directory /home/gary/www/mysite/www/&gt;
</I>&gt;<i> &gt; &gt;                Options FollowSymLinks MultiViews
</I>&gt;<i> &gt; &gt;                Order allow,deny
</I>&gt;<i> &gt; &gt;                allow from all
</I>&gt;<i> &gt; &gt;        &lt;/Directory&gt;
</I>&gt;<i> &gt; &gt; &lt;/VirtualHost&gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; ---------------------/etc/apache2/ mods-available/mono.conf----------
</I>&gt;<i> &gt; &gt;  MonoUnixSocket /tmp/mod_mono_server
</I>&gt;<i> &gt; &gt;  MonoRunXSP true
</I>&gt;<i> &gt; &gt;  MonoApplicationsConfigDir /etc/apache2/mod-mono-applications
</I>&gt;<i> &gt; &gt;  MonoDebug true
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; -----------------web.config---------------------
</I>&gt;<i> &gt; &gt;  &lt;system.web&gt;
</I>&gt;<i> &gt; &gt;    ...
</I>&gt;<i> &gt; &gt;    ...
</I>&gt;<i> &gt; &gt;    &lt;httpHandlers&gt;
</I>&gt;<i> &gt; &gt;      &lt;add verb=&quot;*&quot; path=&quot;*.jpg&quot;
</I>&gt;<i> &gt; &gt; type=&quot;Mynamespace.HttpHandlers.ImageHandler,HolmokImageHandler /&gt;
</I>&gt;<i> &gt; &gt; &lt;/httpHandlers&gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; ---------------------------------------------------------------
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Mono-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">Mono-list at lists.ximian.com</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-list">http://lists.ximian.com/mailman/listinfo/mono-list</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>

-- 
Martin Hinks
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027550.html">[Mono-list] HttpHandler for *.jpg
</A></li>
	<LI>Next message: <A HREF="027537.html">[Mono-list] HttpHandler for *.jpg
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27551">[ date ]</a>
              <a href="thread.html#27551">[ thread ]</a>
              <a href="subject.html#27551">[ subject ]</a>
              <a href="author.html#27551">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-list">More information about the Mono-list
mailing list</a><br>
</body></html>
