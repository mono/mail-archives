<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-list] PInvoke:TNG
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:fjh%40cs.mu.oz.au">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000940.html">
   <LINK REL="Next"  HREF="000944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-list] PInvoke:TNG
   </H1>
    <B>Fergus Henderson
    </B> 
    <A HREF="mailto:fjh%40cs.mu.oz.au"
       TITLE="[Mono-list] PInvoke:TNG">fjh@cs.mu.oz.au
       </A><BR>
    <I>Fri, 27 Jul 2001 16:57:57 +1000</I>
    <P><UL>
        <LI> Previous message: <A HREF="000940.html">[Mono-list] PInvoke:TNG
</A></li>
        <LI> Next message: <A HREF="000944.html">[Mono-list] PInvoke:TNG
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#942">[ date ]</a>
              <a href="thread.html#942">[ thread ]</a>
              <a href="subject.html#942">[ subject ]</a>
              <a href="author.html#942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--IJpNTDwzlM2Ie8A6
Content-Type: text/plain; charset=us-ascii

I wrote:

&gt;<i> The other approach is to write wrappers in C.
</I>&gt;<i> Then you don't need any #ifdefs.
</I>
To make that a little more concrete, here's how you could wrap stat().
First, you write a little wrapper in C, that use types with known
sizes and layouts:

	struct my_stat {
		int64_t uid;
		int64_t gid;
		/* etc. */
	}

	int64_t my_stat (const char *filename, struct my_stat *mystat)
	{
		struct stat s;
		int result;

		result = stat(filename, &amp;s);

		mystat-&gt;uid = s-&gt;st_uid;
		mystat-&gt;gid = s-&gt;st_gid;
		/* etc. */

		return result;
	}

You then compile this file to say `libwrappers.so'.

In the C# code, you can defining a matching interface,
and you can import the C wrapper in a straight-forward manner:

	struct my_stat {
		long uid;
		long gid;
		// etc.
	}

	[DllImport(&quot;libwrappers&quot;)]
	public static long stat(byte *filename, my_stat *ms)

-- 
Fergus Henderson &lt;<A HREF="mailto:fjh@cs.mu.oz.au">fjh@cs.mu.oz.au</A>&gt;  |  &quot;I have always known that the pursuit
The University of Melbourne         |  of excellence is a lethal habit&quot;
WWW: &lt;<A HREF="http://www.cs.mu.oz.au/~fjh">http://www.cs.mu.oz.au/~fjh</A>&gt;  |     -- the last words of T. S. Garp.

--IJpNTDwzlM2Ie8A6
Content-Type: text/plain; charset=us-ascii
Content-Disposition: attachment; filename=&quot;posix.stat.m&quot;

%------------------------------------------------------------------------------%
% Copyright (C) 2001 The University of Melbourne.
% This file may only be copied under the terms of the GNU Library General
% Public License - see the file COPYING.LIB in the Mercury distribution.
%------------------------------------------------------------------------------%
%
% module: posix__stat.m
% main author: Michael Day &lt;<A HREF="mailto:miked@lendtech.com.au">miked@lendtech.com.au</A>&gt;
%
%------------------------------------------------------------------------------%
:<i>- module posix__stat.
</I>
:<i>- interface.
</I>
:<i>- import_module int, string, time.
</I>
:<i>- type file_type
</I>    ---&gt;    file
    ;	    directory
    ;	    symbolic_link
    ;	    character_device
    ;	    block_device
    ;	    fifo
    ;	    unknown
    .

:<i>- type stat.
</I>
:<i>- func dev(stat) = dev_t.
</I>:<i>- func ino(stat) = ino_t.
</I>:<i>- func mode(stat) = mode_t.
</I>:<i>- func file_type(stat) = file_type.
</I>:<i>- func nlink(stat) = int.
</I>:<i>- func uid(stat) = uid_t.
</I>:<i>- func gid(stat) = gid_t.
</I>:<i>- func rdev(stat) = dev_t.
</I>:<i>- func size(stat) = int.
</I>:<i>- func blksize(stat) = int.
</I>:<i>- func blocks(stat) = int.
</I>:<i>- func atime(stat) = time_t.
</I>:<i>- func mtime(stat) = time_t.
</I>:<i>- func ctime(stat) = time_t.
</I>
:<i>- pred stat(string, posix__result(stat), io__state, io__state).
</I>:<i>- mode stat(in, out, di, uo) is det.
</I>
%------------------------------------------------------------------------------%

:<i>- implementation.
</I>
:<i>- pragma c_header_code(&quot;
</I>	#include &lt;sys/types.h&gt;
	#include &lt;sys/stat.h&gt;
	#include &lt;unistd.h&gt;
&quot;).

%------------------------------------------------------------------------------%

:<i>- type stat ---&gt; stat(c_pointer).
</I>
stat(Path, Result) --&gt;
	stat0(Path, Res, Stat),
	( if { Res = 0 } then
		{ Result = ok(Stat) }
	else
		errno(Err),
		{ Result = error(Err) }
	).				    

:<i>- pred stat0(string, int, stat, io__state, io__state).
</I>:<i>- mode stat0(in, out, out, di, uo) is det.
</I>
:<i>- pragma c_code(stat0(Path::in, Res::out, Stat::out, IO0::di, IO::uo),
</I>		[will_not_call_mercury, thread_safe], &quot;{
	Stat = (MR_Word) MR_GC_NEW(struct stat);
	Res = stat(Path, (struct stat *)Stat);
	IO = IO0;
}&quot;).

file_type(Stat) =
	( if is_slnk(Mode) then symbolic_link
	else if is_reg(Mode) then file
	else if is_dir(Mode) then directory
	else if is_chr(Mode) then character_device
	else if is_blk(Mode) then block_device
	else if is_fifo(Mode) then fifo
	else unknown ) :- Mode = Stat ^ (mode).

:<i>- pred is_slnk(mode_t).
</I>:<i>- mode is_slnk(in) is semidet.
</I>
:<i>- pragma c_code(is_slnk(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISLNK(Mode); &quot;).

:<i>- pred is_reg(mode_t).
</I>:<i>- mode is_reg(in) is semidet.
</I>
:<i>- pragma c_code(is_reg(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISREG(Mode); &quot;).

:<i>- pred is_dir(mode_t).
</I>:<i>- mode is_dir(in) is semidet.
</I>
:<i>- pragma c_code(is_dir(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISDIR(Mode); &quot;).

:<i>- pred is_chr(mode_t).
</I>:<i>- mode is_chr(in) is semidet.
</I>
:<i>- pragma c_code(is_chr(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISCHR(Mode); &quot;).

:<i>- pred is_blk(mode_t).
</I>:<i>- mode is_blk(in) is semidet.
</I>
:<i>- pragma c_code(is_blk(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISBLK(Mode); &quot;).

:<i>- pred is_fifo(mode_t).
</I>:<i>- mode is_fifo(in) is semidet.
</I>
:<i>- pragma c_code(is_fifo(Mode::in), [will_not_call_mercury, thread_safe], &quot;
</I>	SUCCESS_INDICATOR = S_ISFIFO(Mode); &quot;).

:<i>- pragma c_code(dev(S::in) = (Dev::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Dev = ((struct stat *)S)-&gt;st_dev; &quot;).

:<i>- pragma c_code(ino(S::in) = (Ino::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Ino = ((struct stat *)S)-&gt;st_ino; &quot;).

:<i>- pragma c_code(mode(S::in) = (Mode::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Mode = ((struct stat *)S)-&gt;st_mode; &quot;).

:<i>- pragma c_code(nlink(S::in) = (Nlink::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Nlink = ((struct stat *)S)-&gt;st_nlink; &quot;).

:<i>- pragma c_code(uid(S::in) = (Uid::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Uid = ((struct stat *)S)-&gt;st_uid; &quot;).

:<i>- pragma c_code(gid(S::in) = (Gid::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Gid = ((struct stat *)S)-&gt;st_gid; &quot;).

:<i>- pragma c_code(rdev(S::in) = (Rdev::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Rdev = ((struct stat *)S)-&gt;st_rdev; &quot;).

:<i>- pragma c_code(size(S::in) = (Size::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Size = ((struct stat *)S)-&gt;st_size; &quot;).

:<i>- pragma c_code(blksize(S::in) = (Blksize::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Blksize = ((struct stat *)S)-&gt;st_blksize; &quot;).

:<i>- pragma c_code(blocks(S::in) = (Blocks::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Blocks = ((struct stat *)S)-&gt;st_blocks; &quot;).

:<i>- pragma c_code(atime(S::in) = (Atime::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Atime = ((struct stat *)S)-&gt;st_atime; &quot;).

:<i>- pragma c_code(mtime(S::in) = (Mtime::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Mtime = ((struct stat*)S)-&gt;st_mtime; &quot;).

:<i>- pragma c_code(ctime(S::in) = (Ctime::out),
</I>	[will_not_call_mercury, thread_safe],
	&quot;Ctime = ((struct stat *)S)-&gt;st_ctime; &quot;).

%------------------------------------------------------------------------------%


--IJpNTDwzlM2Ie8A6--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000940.html">[Mono-list] PInvoke:TNG
</A></li>
	<LI> Next message: <A HREF="000944.html">[Mono-list] PInvoke:TNG
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#942">[ date ]</a>
              <a href="thread.html#942">[ thread ]</a>
              <a href="subject.html#942">[ subject ]</a>
              <a href="author.html#942">[ author ]</a>
         </LI>
       </UL>
</body></html>
