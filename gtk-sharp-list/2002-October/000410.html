<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] patch for simple pointer types (broken)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:vladimir%40pobox.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000406.html">
   <LINK REL="Next"  HREF="000440.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] patch for simple pointer types (broken)
   </H1>
    <B>Vladimir Vukicevic
    </B> 
    <A HREF="mailto:vladimir%40pobox.com"
       TITLE="[Gtk-sharp-list] patch for simple pointer types (broken)">vladimir@pobox.com
       </A><BR>
    <I>08 Oct 2002 01:22:32 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="000406.html">[Gtk-sharp-list] patch for GtkStyle
</A></li>
        <LI> Next message: <A HREF="000440.html">[Gtk-sharp-list] patch for simple pointer types (broken)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#410">[ date ]</a>
              <a href="thread.html#410">[ thread ]</a>
              <a href="subject.html#410">[ subject ]</a>
              <a href="author.html#410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-e4bjs1cv4wnovWlkpsDP
Content-Type: text/plain
Content-Transfer-Encoding: 7bit


So, this started out as me needing to get gdk_drawable_get_size()
working [*].  Its prototype is:

void gdk_drawable_get_size (GdkDrawable *d, int *width, int *height);

So, with only a vague understanding of how the whole generator system
worked, I plunged in, assuming that all such things tend to be written
in similar ways, so it Can't Be That Hard (tm).  I split up simple_types
into native_types and simple_types -- native_types being things that
have a direct 1-1 mapping between C and C# types, such as gint -&gt; int.

The attached patch sort-of works.  gdk_drawable_get_size does indeed
become &quot;Gdk.Drawable.GetSize (out int width, out int height)&quot;, with the
appropriate bindings to C Generated.  However, there's a number of
(broken) side effects:

1) It doesn't (and can't) distinguish between out params and input array
params.  It would be /really/ nice if the C api writers forced
themselves to use &quot;gint stuff[]&quot; for input array values and &quot;gint
*stuff&quot; for an output of one gint.  However, in this respect, things
aren't any more broken than they were previously.

2) Signals that have basic pointer types get horribly broken.  You end
up with stuff like:

	object[] _args = new object[1];
	_args[0] = out pixels;
	_managed ((out byte) _args[0]);

3) A few functions for which bindings were generated before don't get
generated.  I'm not sure why this is.

4) Stuff like:

-		static extern unsafe bool gdk_pixbuf_loader_write(IntPtr raw, byte[]
buf, uint count, out IntPtr error);
+		static extern unsafe bool gdk_pixbuf_loader_write(IntPtr raw, out
byte[] buf, uint count, out IntPtr error);
 
 		/// &lt;summary&gt; Write Method &lt;/summary&gt;
 		/// &lt;remarks&gt; To be completed &lt;/remarks&gt;
-		public unsafe bool Write(byte[] buf, uint count) {
+		public unsafe bool Write(out byte[] buf, uint count) {

(- is old, + is with the patch)

i.e. it's munging stuff that has attributes applied to it from the
metadata (in this case that param has the array attribute applied).

So, it's fairly broken.  I'm only sending it along in case someone is
interested :)

	- Vlad

* I abandoned gdk_drawable_get_size and used the widget's allocation
instead, which has much saner getters/setters.

-- 
Vladimir Vukicevic &lt;<A HREF="mailto:vladimir@pobox.com">vladimir@pobox.com</A>&gt;

--=-e4bjs1cv4wnovWlkpsDP
Content-Disposition: attachment; filename=generator.patch
Content-Transfer-Encoding: quoted-printable
Content-Type: text/x-patch; name=generator.patch; charset=ANSI_X3.4-1968

Index: SymbolTable.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/SymbolTable.cs,v
retrieving revision 1.40
diff -u -w -u -w -r1.40 SymbolTable.cs
--- SymbolTable.cs	1 Sep 2002 04:46:37 -0000	1.40
+++ SymbolTable.cs	8 Oct 2002 09:07:50 -0000
@@ -14,50 +14,60 @@
 		private static Hashtable alias =3D new Hashtable ();
 		private static Hashtable complex_types =3D new Hashtable ();
 		private static Hashtable simple_types;
+                private static Hashtable native_types;
 		private static Hashtable manually_wrapped_types;
 	=09
 		static SymbolTable ()
 		{
+                        native_types =3D new Hashtable ();
+			native_types.Add (&quot;gboolean&quot;, &quot;bool&quot;);
+			native_types.Add (&quot;gint&quot;, &quot;int&quot;);
+			native_types.Add (&quot;guint&quot;, &quot;uint&quot;);
+			native_types.Add (&quot;glong&quot;, &quot;long&quot;);
+			native_types.Add (&quot;gshort&quot;, &quot;short&quot;);
+			native_types.Add (&quot;gushort&quot;, &quot;ushort&quot;);
+			native_types.Add (&quot;guint32&quot;, &quot;uint&quot;);
+                        native_types.Add (&quot;guint64&quot;, &quot;ulong&quot;);
+                        native_types.Add (&quot;const-gchar&quot;, &quot;sbyte&quot;);
+                        native_types.Add (&quot;const-char&quot;, &quot;sbyte&quot;);
+                        native_types.Add (&quot;char&quot;, &quot;sbyte&quot;);
+			native_types.Add (&quot;gfloat&quot;, &quot;float&quot;);
+			native_types.Add (&quot;gdouble&quot;, &quot;double&quot;);
+			native_types.Add (&quot;gint8&quot;, &quot;byte&quot;);
+			native_types.Add (&quot;guint8&quot;, &quot;byte&quot;);
+			native_types.Add (&quot;gint16&quot;, &quot;short&quot;);
+			native_types.Add (&quot;gint32&quot;, &quot;int&quot;);
+                        native_types.Add (&quot;gint64&quot;, &quot;long&quot;);
+			native_types.Add (&quot;guint16&quot;, &quot;ushort&quot;);
+			native_types.Add (&quot;guint1&quot;, &quot;bool&quot;);
+			native_types.Add (&quot;guchar&quot;, &quot;byte&quot;);
+			native_types.Add (&quot;long&quot;, &quot;long&quot;);
+			native_types.Add (&quot;gulong&quot;, &quot;ulong&quot;);
+			native_types.Add (&quot;GQuark&quot;, &quot;int&quot;);
+			native_types.Add (&quot;int&quot;, &quot;int&quot;);
+			native_types.Add (&quot;double&quot;, &quot;double&quot;);
+			native_types.Add (&quot;float&quot;, &quot;float&quot;);
+			native_types.Add (&quot;gunichar&quot;, &quot;char&quot;);
+			native_types.Add (&quot;GType&quot;, &quot;int&quot;);
+			native_types.Add (&quot;uint1&quot;, &quot;bool&quot;);
+			// gsize is a system-specific typedef in glibconfig.h,
+			// but this should work for now
+			native_types.Add (&quot;gsize&quot;, &quot;uint&quot;);
+			native_types.Add (&quot;gssize&quot;, &quot;int&quot;);
+			native_types.Add (&quot;size_t&quot;, &quot;int&quot;);
+
 			simple_types =3D new Hashtable ();
 			simple_types.Add (&quot;void&quot;, &quot;void&quot;);
-			simple_types.Add (&quot;gboolean&quot;, &quot;bool&quot;);
-			simple_types.Add (&quot;gint&quot;, &quot;int&quot;);
-			simple_types.Add (&quot;guint&quot;, &quot;uint&quot;);
-			simple_types.Add (&quot;glong&quot;, &quot;long&quot;);
-			simple_types.Add (&quot;gshort&quot;, &quot;short&quot;);
-			simple_types.Add (&quot;gushort&quot;, &quot;ushort&quot;);
-			simple_types.Add (&quot;guint32&quot;, &quot;uint&quot;);
+                        simple_types.Add (&quot;char&quot;, &quot;string&quot;);
+			simple_types.Add (&quot;const-void&quot;, &quot;System.IntPtr&quot;);
 			simple_types.Add (&quot;const-gchar&quot;, &quot;string&quot;);
 			simple_types.Add (&quot;const-char&quot;, &quot;string&quot;);
 			simple_types.Add (&quot;gchar&quot;, &quot;string&quot;);
 			simple_types.Add (&quot;GObject&quot;, &quot;GLib.Object&quot;);
-			simple_types.Add (&quot;gfloat&quot;, &quot;float&quot;);
-			simple_types.Add (&quot;gdouble&quot;, &quot;double&quot;);
-			simple_types.Add (&quot;gint8&quot;, &quot;byte&quot;);
-			simple_types.Add (&quot;guint8&quot;, &quot;byte&quot;);
-			simple_types.Add (&quot;gint16&quot;, &quot;short&quot;);
-			simple_types.Add (&quot;gint32&quot;, &quot;int&quot;);
-			simple_types.Add (&quot;guint16&quot;, &quot;ushort&quot;);
-			simple_types.Add (&quot;guint1&quot;, &quot;bool&quot;);
 			simple_types.Add (&quot;gpointer&quot;, &quot;System.IntPtr&quot;);
-			simple_types.Add (&quot;guchar&quot;, &quot;byte&quot;);
-			simple_types.Add (&quot;long&quot;, &quot;long&quot;);
-			simple_types.Add (&quot;gulong&quot;, &quot;ulong&quot;);
-			simple_types.Add (&quot;GQuark&quot;, &quot;int&quot;);
-			simple_types.Add (&quot;int&quot;, &quot;int&quot;);
-			simple_types.Add (&quot;char&quot;, &quot;string&quot;);
-			simple_types.Add (&quot;double&quot;, &quot;double&quot;);
-			simple_types.Add (&quot;float&quot;, &quot;float&quot;);
 			simple_types.Add (&quot;gunichar&quot;, &quot;string&quot;);
-			simple_types.Add (&quot;uint1&quot;, &quot;bool&quot;);
 			simple_types.Add (&quot;GPtrArray&quot;, &quot;System.IntPtr[]&quot;);
-			simple_types.Add (&quot;GType&quot;, &quot;int&quot;);
 			simple_types.Add (&quot;GError&quot;, &quot;IntPtr&quot;);
-			// gsize is a system-specific typedef in glibconfig.h,
-			// but this should work for now
-			simple_types.Add (&quot;gsize&quot;, &quot;uint&quot;);
-			simple_types.Add (&quot;gssize&quot;, &quot;int&quot;);
-			simple_types.Add (&quot;size_t&quot;, &quot;int&quot;);
 		=09
 			// FIXME: These ought to be handled properly.
 			simple_types.Add (&quot;GMemChunk&quot;, &quot;System.IntPtr&quot;);
@@ -88,6 +98,11 @@
 			complex_types [gen.CName] =3D gen;
 		}
 	=09
+                public static void AddNativeType (string cname, string nam=
e)
+                {
+                        native_types.Add (cname, name);
+                }
+
 		public static void AddSimpleType (string cname, string name)
 		{
 			simple_types.Add (cname, name);
@@ -113,15 +128,16 @@
 	=09
 		private static string Trim(string type)
 		{
-			// HACK: If we don't detect this here, there is no
-			// way of indicating it in the symbol table
-			if (type =3D=3D &quot;void*&quot; || type =3D=3D &quot;const-void*&quot;) return &quot;gpointer&quot;=
;
-
 			string trim_type =3D type.TrimEnd('*');
 			if (trim_type.StartsWith(&quot;const-&quot;)) return trim_type.Substring(6);
 			return trim_type;
 		}
=20
+                private static string TrimPointer(string type)
+                {
+                        return type.TrimEnd('*');
+                }
+
 		private static string DeAlias (string type)
 		{
 			while (alias.ContainsKey(type))
@@ -140,12 +156,18 @@
 			return FromNative (c_type, val, false);
 		}
=20
-		public static string FromNative(string c_type, string val, bool ret)
+		public static string FromNative(string c_type_in, string val, bool ret)
 		{
-			c_type =3D Trim(c_type);
-			c_type =3D DeAlias(c_type);
+			string trimmed_type =3D Trim(c_type_in);
+			string c_type =3D DeAlias(trimmed_type);
 			if (simple_types.ContainsKey(c_type)) {
 				return val;
+                        } else if (native_types.ContainsKey(trimmed_type))=
 {
+                                if (IsPointer (c_type_in)) {
+                                        return &quot;out &quot; + val;
+                                } else {
+                                        return val;
+                                }
 			} else if (complex_types.ContainsKey(c_type)) {
 				IGeneratable gen =3D (IGeneratable) complex_types[c_type];
 				if (ret)
@@ -160,12 +182,28 @@
 			}
 		}
 	=09
-		public static string GetCSType(string c_type)
+                public static string GetCSType(string c_type_in)
 		{
-			c_type =3D Trim(c_type);
-			c_type =3D DeAlias(c_type);
+                        return GetCSType (c_type_in, false);
+                }
+
+		public static string GetCSType(string c_type_in, bool ret)
+		{
+			string trimmed_type =3D Trim(c_type_in);
+			string c_type =3D DeAlias(trimmed_type);
+                       =20
 			if (simple_types.ContainsKey(c_type)) {
 				return (string) simple_types[c_type];
+                        } else if (native_types.ContainsKey(trimmed_type))=
 {
+                                if (IsPointer (c_type_in)) {
+                                        if (ret) {
+                                                return &quot;IntPtr&quot;;
+                                        } else {
+                                                return &quot;out &quot; + (string) n=
ative_types[c_type];
+                                        }
+                                } else {
+                                        return (string) native_types[c_typ=
e];
+                                }
 			} else if (complex_types.ContainsKey(c_type)) {
 				IGeneratable gen =3D (IGeneratable) complex_types[c_type];
 				return gen.QualifiedName;
@@ -176,10 +214,10 @@
 			}
 		}
 	=09
-		public static string GetName(string c_type)
+		public static string GetName(string c_type_in)
 		{
-			c_type =3D Trim(c_type);
-			c_type =3D DeAlias(c_type);
+			string trimmed_type =3D Trim(c_type_in);
+			string c_type =3D DeAlias(trimmed_type);
 			if (simple_types.ContainsKey(c_type) || manually_wrapped_types.Contains=
Key(c_type)) {
 				string stype;
 				if (simple_types.ContainsKey(c_type))
@@ -192,6 +230,8 @@
 				} else {
 					return stype.Substring(dotidx+1);
 				}
+			} else if (native_types.ContainsKey(c_type)) {
+                                return (string) native_types[c_type];
 			} else if (complex_types.ContainsKey(c_type)) {
 				IGeneratable gen =3D (IGeneratable) complex_types[c_type];
 				return gen.Name;
@@ -210,12 +250,22 @@
 			return GetMarshalType (c_type, false);
 		}
 	=09
-		public static string GetMarshalType(string c_type, bool ret)
+		public static string GetMarshalType(string c_type_in, bool ret)
 		{
-			c_type =3D Trim(c_type);
-			c_type =3D DeAlias(c_type);
+			string trimmed_type =3D Trim(c_type_in);
+			string c_type =3D DeAlias(trimmed_type);
 			if (simple_types.ContainsKey(c_type)) {
 				return (string) simple_types[c_type];
+			} else if (native_types.ContainsKey(c_type)) {
+                                if (IsPointer (c_type_in)) {
+                                        if (ret) {
+                                                return &quot;IntPtr&quot;;
+                                        } else {
+                                                return &quot;out &quot; + (string) n=
ative_types[c_type];
+                                        }
+                                } else {
+                                        return (string) native_types[c_typ=
e];
+                                }
 			} else if (manually_wrapped_types.ContainsKey(c_type)) {
 				return &quot;IntPtr&quot;;
 			} else if (complex_types.ContainsKey(c_type)) {
@@ -229,12 +279,18 @@
 			}
 		}
 	=09
-		public static string CallByName(string c_type, string var_name)
+		public static string CallByName(string c_type_in, string var_name)
 		{
-			c_type =3D Trim(c_type);
-			c_type =3D DeAlias(c_type);
+			string trimmed_type =3D Trim(c_type_in);
+			string c_type =3D DeAlias(trimmed_type);
 			if (simple_types.ContainsKey(c_type)) {
 				return var_name;
+			} else if (native_types.ContainsKey(c_type)) {
+                                if (IsPointer (c_type_in)) {
+                                        return &quot;out &quot; + var_name;
+                                } else {
+                                        return var_name;
+                                }
 			} else if (manually_wrapped_types.ContainsKey(c_type)) {
 				return var_name + &quot;.Handle&quot;;
 			} else if (complex_types.ContainsKey(c_type)) {
@@ -321,6 +377,14 @@
 			return false;
 		}
 	=09
+                public static bool IsPointer(string type)
+                {
+                        // return true only if it's a simple pointer
+                        if (type.EndsWith(&quot;*&quot;) &amp;&amp; !type.EndsWith(&quot;**&quot;))
+                                return true;
+                        return false;
+                }
+
 		public static ClassBase GetClassGen(string c_type)
 		{
 			c_type =3D Trim(c_type);

--=-e4bjs1cv4wnovWlkpsDP--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000406.html">[Gtk-sharp-list] patch for GtkStyle
</A></li>
	<LI> Next message: <A HREF="000440.html">[Gtk-sharp-list] patch for simple pointer types (broken)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#410">[ date ]</a>
              <a href="thread.html#410">[ thread ]</a>
              <a href="subject.html#410">[ subject ]</a>
              <a href="author.html#410">[ author ]</a>
         </LI>
       </UL>
</body></html>
