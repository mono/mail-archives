<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Problem with Semi-Transparent Window
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Problem%20with%20Semi-Transparent%20Window&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008028.html">
   <LINK REL="Next"  HREF="008029.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Problem with Semi-Transparent Window</H1>
    <B>Arno N&#252;hm</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Problem%20with%20Semi-Transparent%20Window&In-Reply-To="
       TITLE="[Gtk-sharp-list] Problem with Semi-Transparent Window">informatik4u at web.de
       </A><BR>
    <I>Fri May  4 08:46:07 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="008028.html">[Gtk-sharp-list] Unhandled Exception: System.Exception: Unknown type
</A></li>
        <LI>Next message: <A HREF="008029.html">[Gtk-sharp-list] Stetic oddity or normal Gtk-ness?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8035">[ date ]</a>
              <a href="thread.html#8035">[ thread ]</a>
              <a href="subject.html#8035">[ subject ]</a>
              <a href="author.html#8035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
i have a non-decorated (borderless) and dragable Gtk.Window with a semi-transparent PNG image in the background and a label above. The progrmm will be used as a desktop widget and should be transparent (by copying the desktop background).

That works so far, but i have the following problem:
When another window is above my programm and the window is moved or minimized, it draws some lines on my programm. Sometimes even the text of my label will be ereased.

Does somebody knows where's the problem here?

Here is a example code and a example semi-transparent PNG image:

<A HREF="http://img339.imageshack.us/img339/7640/backgroundtransgn8.png">http://img339.imageshack.us/img339/7640/backgroundtransgn8.png</A>


using System;
using Gtk;
using Gdk;

public class TransparentWindow : Gtk.Window
{	
	double offsetX;
	double offsetY;
			
	public TransparentWindow (String title) : base (Gtk.WindowType.Toplevel)
	{
		this.Events |= Gdk.EventMask.ButtonPressMask;
		this.Events |= Gdk.EventMask.ButtonReleaseMask;
		this.Events |= Gdk.EventMask.ButtonMotionMask;
		this.DeleteEvent += new DeleteEventHandler (OnSkinWindowDelete);
		this.ButtonPressEvent += new ButtonPressEventHandler(OnButtonPressEvent);
		this.ButtonReleaseEvent += new ButtonReleaseEventHandler(OnButtonReleaseEvent);
		this.MotionNotifyEvent += new MotionNotifyEventHandler(OnButtonMotionEvent);
		
		this.Title = title;
		this.Stick();
		this.Decorated = false;
		
		// transparent Background image 
		Gdk.Pixbuf pixbufBg = new Pixbuf(&quot;backgroundtrans.png&quot;);
		Gtk.Image backgroundImage = new Gtk.Image(pixbufBg);
		
		// Label
		Gtk.Label label = new Gtk.Label();
		label.Text = &quot;&lt;span color=\&quot;black\&quot; weight=\&quot;bold\&quot;&gt;test test test test test test test test &lt;/span&gt;&quot;;
		label.UseMarkup = true;
		
		// Container to add Widgets with fixed positions
		Gtk.Fixed fixedContainer = new Gtk.Fixed();
		fixedContainer.Add(backgroundImage);
		fixedContainer.Put(label, 6, 5);
		
		// add fixed Container to window
		this.Add(fixedContainer);
		
		this.ShowAll ();
	}
			
	// drag methods
	private void OnButtonPressEvent(object o, ButtonPressEventArgs a)
	{			
		this.offsetX = a.Event.X;
		this.offsetY = a.Event.Y;
	}
	
	private void OnButtonMotionEvent(object o, MotionNotifyEventArgs a)
	{
			
		int x = (int)(a.Event.XRoot - this.offsetX);
		int y = (int)(a.Event.YRoot - this.offsetY);
		this.Move(x,y);
		}
	
	private void OnButtonReleaseEvent(object o, ButtonReleaseEventArgs a)
	{			
		QueueDraw();
	}
		
	// transparency methods
	void MakeTransparent (Widget widget)
        {
            if (0 &lt; (int) (widget.WidgetFlags &amp; WidgetFlags.NoWindow)) {
                return;
            }

            widget.AppPaintable = true;
            widget.DoubleBuffered = false;
            widget.GdkWindow.SetBackPixmap (null, true);
            widget.ExposeEvent += OnChildExpose;
            widget.StyleSet += MakeTransparentAgain;

        }
        
         void MakeTransparentAgain (object obj, StyleSetArgs args)
        {
            (obj as Widget).GdkWindow.SetBackPixmap (null, true);
        }	
		        
        protected override void OnAdded (Widget widget)
        {
            widget.Realized += OnChildRealized;
            base.OnAdded (widget);
        }
		
		protected override void OnRealized ()
        {
            base.OnRealized ();
            MakeTransparent (this);
        }
        
		[GLib.ConnectBefore]
        void OnChildRealized (object obj, EventArgs args)
        {
            MakeTransparent (obj as Widget);
        }
        
        [GLib.ConnectBefore]
        void OnChildExpose (object obj, ExposeEventArgs args)
        {
            (obj as Widget).GdkWindow.ClearArea (args.Event.Area.X,
                                                 args.Event.Area.Y,
                                                 args.Event.Area.Width,
                                                 args.Event.Area.Height);
            args.RetVal = false;
        }
        
        // quit
        void OnSkinWindowDelete (object sender, DeleteEventArgs a)
	{
		Application.Quit ();
		a.RetVal = true;
	} 
		
	public static void Main (string[] args)
	{
		Application.Init ();
		TransparentWindow win = new TransparentWindow (&quot;TestWindow&quot;);
		win.Show ();
		Application.Run ();
	}
}


Thanks in advance!

--
Christian
_______________________________________________________________
SMS schreiben mit WEB.DE FreeMail - einfach, schnell und
kostenguenstig. Jetzt gleich testen! <A HREF="http://f.web.de/?mc=021192">http://f.web.de/?mc=021192</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008028.html">[Gtk-sharp-list] Unhandled Exception: System.Exception: Unknown type
</A></li>
	<LI>Next message: <A HREF="008029.html">[Gtk-sharp-list] Stetic oddity or normal Gtk-ness?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8035">[ date ]</a>
              <a href="thread.html#8035">[ thread ]</a>
              <a href="subject.html#8035">[ subject ]</a>
              <a href="author.html#8035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
