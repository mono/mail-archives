<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Complex bug/issue in Gtk.Clipboard
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:spamfrommailing%40freax.org">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="002173.html">
   <LINK REL="Next"  HREF="002179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Complex bug/issue in Gtk.Clipboard
   </H1>
    <B>Philip Van Hoof
    </B> 
    <A HREF="mailto:spamfrommailing%40freax.org"
       TITLE="[Gtk-sharp-list] Complex bug/issue in Gtk.Clipboard">spamfrommailing@freax.org
       </A><BR>
    <I>17 Jul 2003 22:36:58 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="002173.html">[Gtk-sharp-list] Glade, C# and internaltionalization
</A></li>
        <LI> Next message: <A HREF="002179.html">[Gtk-sharp-list] Complex bug/issue in Gtk.Clipboard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2178">[ date ]</a>
              <a href="thread.html#2178">[ thread ]</a>
              <a href="subject.html#2178">[ subject ]</a>
              <a href="author.html#2178">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-OZppqfyg4Qk44waynRLg
Content-Type: text/plain
Content-Transfer-Encoding: 7bit


Hi there,

During the rewrite of my clipboard manager code (which is written in C
using the plain C API of Gtk+) I spotted some very complex bugs in
gtk-sharp.


The most important one is that setting a clipboard does not work. 

To set a clipboard, one must do this :

Clipboard.Set (targets, new Gtk.ClipboardGetFunc(GetFunc), new
Gtk.ClipboardClearFunc(ClearFunc), null))


Get GetFunc will be called when another Xclient requests the clipboard
and the ClearFunc will be called when the application calling this has
lost the ownership of the clipboard. (Since you guys -the ones on
gtk-sharp- are all GNOME developers I am pretty sure you all know this)

Those events work. So thats good, I guess.. However, it looks like there
is something wrong with the parameter &quot;selection_data&quot; that gets passed
by reference

This is the description of such a GetFunc-method :

void GetFunc(Clipboard clipboard, ref SelectionData selection_data, uint
info, object o)


First, selection_data is not always not null, which is wierd. Second
when you should in this method convert the data of the clipboard that
you want to give to the requesting XClient to the format it asked for,
it does not work.

If I read the gtk-sharp sources I understand one could do this using

selection_data.Text = &quot;test&quot;; This would make the XClient who requests
the clipboard paste &quot;test&quot;, right? Well this does not work.

I did some detailled analysis using my old clipboard manager. It looks
like something actually does get set. But only targets like TIMESTAMP
and MULTIPLE convert the data to something different than NULL.

The UTF8_STRING, COMPOUND_TEXT, .. atoms all result in NULL being
received at the requesting XClient.

I have like .. turned the gtk-sharp code upside down in files like
GtkClipboardGetFuncNative, SelectionData.custom, retried, recompiled
gtk-sharp, debugged etc etc etc .. nothing got it actually working.

I also tried very very simple examples (I attached one) which also don't
work.


IMHO this is a serious showstopper as this disables setting the
clipboard to somthing else than some stupid plain text clipboard in
gtk-sharp.


Note that I have also tried calling the C-api of gtk+ directly just like
how gtk-sharp does it. In the attached example I am also doing this for
one particular function (else I cannot cast Atom to uint, maybe the Raw
member of all gtk-sharp objects should not be private for such advanced
casting to be possible)


ps. I am (always) using what is currently in CVS


Note that if you see a error in my example, and if you get it working :)
then this is nolonger a bugreport but my mistake. But I fear that it's a
gtk-sharp bug .. (again, I can be wrong).



-- 
Philip Van Hoof, Software Developer @ Cronos
home: me at freax dot org
work: Philip dot VanHoof at cronos dot be
<A HREF="http://www.freax.be,">http://www.freax.be,</A> <A HREF="http://www.freax.eu.org">http://www.freax.eu.org</A>

--=-OZppqfyg4Qk44waynRLg
Content-Disposition: attachment; filename=test.cs
Content-Type: text/plain; name=test.cs; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

using Gtk;
using Gdk;
using Gnome;
using GtkSharp;
using System;
using System.Threading;
using System.Runtime.InteropServices;
using GLibSharp;
using GLib;

public class Test
{
	[DllImport(&quot;libgdk-win32-2.0-0.dll&quot;)]
	static extern IntPtr gdk_atom_intern(string atom_name, bool only_if_exists);

	public Test ()
	{
		TargetEntry [] targets = new TargetEntry[1];
		targets[0].target = &quot;COMPOUND_TEXT&quot;;
		targets[0].info = 0;
		targets[0].flags = (uint) gdk_atom_intern (&quot;COMPOUND_TEXT&quot;, false);
		Gtk.Clipboard clipboard = Gtk.Clipboard.Get (Atom.Intern(&quot;CLIPBOARD&quot;, false));

		clipboard.Set (targets, new Gtk.ClipboardGetFunc(GetFunc), new Gtk.ClipboardClearFunc(ClearFunc), null);
		Console.WriteLine (&quot;I now own the clipboardownership, waiting for a clipboard request&quot;);
	}

	public void GetFunc(Clipboard clipboard, ref SelectionData selection_data, uint info, object o)
	{
		Console.WriteLine (&quot;Somebody wants me to give the clipboard&quot;);
		selection_data.Text = &quot;test&quot;;
	}

	public void ClearFunc (Clipboard clipboard, object o)
	{
		Console.WriteLine (&quot;I lost the clipboard ownership&quot;);
	}

	static public void Main (string[] args)
	{
		Program deamon = new Program (&quot;Deamon&quot;, &quot;0.1&quot;, Modules.UI, args);
		Application.Init ();
		Test t = new Test ();
		Application.Run ();
	}
}

--=-OZppqfyg4Qk44waynRLg--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="002173.html">[Gtk-sharp-list] Glade, C# and internaltionalization
</A></li>
	<LI> Next message: <A HREF="002179.html">[Gtk-sharp-list] Complex bug/issue in Gtk.Clipboard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2178">[ date ]</a>
              <a href="thread.html#2178">[ thread ]</a>
              <a href="subject.html#2178">[ subject ]</a>
              <a href="author.html#2178">[ author ]</a>
         </LI>
       </UL>
</body></html>
