<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] PATCH: speed up treeview and managed values
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mkestner%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003383.html">
   <LINK REL="Next"  HREF="003378.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] PATCH: speed up treeview and managed values
   </H1>
    <B>Mike Kestner
    </B> 
    <A HREF="mailto:mkestner%40ximian.com"
       TITLE="[Gtk-sharp-list] PATCH: speed up treeview and managed values">mkestner@ximian.com
       </A><BR>
    <I>Sun, 15 Feb 2004 10:00:11 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="003383.html">[Gtk-sharp-list] PATCH: speed up treeview and managed values
</A></li>
        <LI> Next message: <A HREF="003378.html">[Gtk-sharp-list] PATCH: speed up treeview and managed values
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3376">[ date ]</a>
              <a href="thread.html#3376">[ thread ]</a>
              <a href="subject.html#3376">[ subject ]</a>
              <a href="author.html#3376">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ben,

Thanks for the patch.  

The following comments are intended not only as direct feedback on the
patch, but also an attempt to develop some standards for
performance-related patch submissions in the future.

I take code complexity seriously.  Before I'll approve an increase in
complexity over working existing code on performance reasons, I will
need to see more definitive information on the performance gained.

Specific comments below.

On Sun, 2004-02-15 at 00:05, Ben Maurer wrote:

&gt;<i> These two patches reduce the cost by quite a bit, over 50%. Also, the
</I>&gt;<i> memory allocation is way down.
</I>
Please don't do two things in one patch.  Especially in a performance
improvement patch.  It just makes it harder to review the patch.  Also,
as jluke mentioned, please attach patches instead of providing links to
them.

&gt;<i> The first one implements ManagedValue using GCHandles. The bulk of this
</I>&gt;<i> code is now implemented in C to avoid some overhead (before, we were
</I>&gt;<i> accessing a hashtable by an intptr which caused boxing). Also, this
</I>&gt;<i> avoids the cost of invoking a C# delegate from C.
</I>
A couple of things on this part of the patch.  One, I don't think I
really want to add a lot of glue code and complexity to the ManagedValue
implementation, since it will be deprecated as soon as the NodeStore is
completed. 

Second, this part of the patch is not written in a style consistent with
the type declaration conventions in Gtk+.  For example, methods that
return a GType are named my_type_name_get_type.  _init functions are
used to initialize instances of a type. 

&gt;<i> The second patch avoids the allocation of Glib.Value's by implementing
</I>&gt;<i> the code in C where the values are stored on the stack.
</I>
This is just a brute force attack.  I would prefer the brute force
behind GValues be buried inside GLib.Value instead of duplicated in
every API that uses GValues.  Did you consider caching and block
allocation of GLib.Value wrappers if allocation is the issue?  

&gt;<i> Overall, this made a noticable difference when loading a large project
</I>&gt;<i> (in this case, the MCS compiler) in MonoDevelop. The time improved and
</I>&gt;<i> memory was down by a few MB (according to top).
</I>
Noticeable differences aren't the standard with performance issues. 
Measurable differences are.  Time improved, but by how much?  &quot;It seems
faster&quot; isn't a performance gain.  The memory gain seems to imply leaks
to me, since GLib.Values are transient.  Did you attempt to identify
where the leaks are?

Which part of the patch improved time?  Which part of the patch improved
memory?  By combining two different &quot;fixes&quot; in one patch like this, it
is hard to understand if/why both parts are necessary.

So, in summary, on performance improvement patches like this that add
code complexity in order to improve performance, I will first need to
see clear instrumented evidence of the problem.  I'm talking numeric
profiled evidence, not &quot;tree view seems slow.&quot;  Also, I need to see
measurements of the improvement, and by this I don't mean &quot;50%
improvement&quot;.  I mean &quot;the profile prior to the patch showed 10% of
execution time in GetValue, now it's 5%.&quot;  Finally, the above
measurements should be made on atomic changes, not an aggregation of
loosely related changes.

Thanks,
-- 
Mike Kestner &lt;<A HREF="mailto:mkestner@ximian.com">mkestner@ximian.com</A>&gt;


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003383.html">[Gtk-sharp-list] PATCH: speed up treeview and managed values
</A></li>
	<LI> Next message: <A HREF="003378.html">[Gtk-sharp-list] PATCH: speed up treeview and managed values
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3376">[ date ]</a>
              <a href="thread.html#3376">[ thread ]</a>
              <a href="subject.html#3376">[ subject ]</a>
              <a href="author.html#3376">[ author ]</a>
         </LI>
       </UL>
</body></html>
