<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Gtk.DrawingArea not thread-agnostic on Win32?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Gtk.DrawingArea%20not%20thread-agnostic%20on%20Win32%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009059.html">
   <LINK REL="Next"  HREF="009034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Gtk.DrawingArea not thread-agnostic on Win32?</H1>
    <B>Sam Hocevar</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Gtk.DrawingArea%20not%20thread-agnostic%20on%20Win32%3F&In-Reply-To="
       TITLE="[Gtk-sharp-list] Gtk.DrawingArea not thread-agnostic on Win32?">sam at zoy.org
       </A><BR>
    <I>Tue Sep 23 06:00:09 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="009059.html">[Gtk-sharp-list] Updating of a window not done right away
</A></li>
        <LI>Next message: <A HREF="009034.html">[Gtk-sharp-list] Gtk.DrawingArea not thread-agnostic on Win32?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9033">[ date ]</a>
              <a href="thread.html#9033">[ thread ]</a>
              <a href="subject.html#9033">[ subject ]</a>
              <a href="author.html#9033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>   I have a threaded GTK# application that creates widgets in several
threads (all with proper synchronisation, of course). It works perfectly
on Linux, but it hangs on Win32 when using Gtk.DrawingArea objects.

   Attached is a sample program which does the following:
     - thread #1 creates a Gtk.Window
     - thread #1 spawns thread #2
     - thread #2 creates a Gtk.DrawingArea object
     - thread #1 attaches the DrawingArea to the Window
     - thread #1 waits for user input
     - thread #2 destroys the Gtk.DrawingArea object
     - thread #1 joins thread #2
     - thread #1 exits

   Everything goes well on Linux. On Win32, the program hangs during the
Gtk.DrawingArea destruction.

   It should be noted that using Gtk.Button instead of Gtk.DrawingArea
makes everything work properly on both Linux and Windows.

   Any ideas on what may be wrong?

Cheers,
-- 
Sam.
-------------- next part --------------

using System;
using System.Threading;
using Gtk;
using Gdk;

namespace Program
{
    class My
    {
        public static void Debug(object msg)
        {
            Console.WriteLine(&quot;Thread [{1}]: {0}&quot;, msg,
                  System.Threading.Thread.CurrentThread.GetHashCode());
        }
    }


    class Draw : Gtk.DrawingArea
    {
        public Draw()
        {
             My.Debug(&quot;creating DrawingArea&quot;);
        }


        protected override bool OnDeleteEvent(Event evnt)
        {
            My.Debug(&quot;DrawingArea deleted (should never be called)&quot;);
            return base.OnDeleteEvent(evnt);
        }


        protected override void OnDestroyed()
        {
            My.Debug(&quot;DrawingArea destroyed&quot;);
            base.OnDestroyed();
        }
    }


    class Win : Gtk.Window
    {
        private Draw _darea = null;
        private Thread _thread;
        private bool _running = false;


        public Win(string title) : base(title)
        {
            My.Debug(&quot;creating Window&quot;);

            // Launch the parallel thread
            Gdk.Threads.Leave();
            _thread = new Thread(threadFunc);
            _thread.Start();
            Gdk.Threads.Enter();

            // Wait until the object is created
            while(_darea == null)
            {
                Gdk.Threads.Leave();
                My.Debug(&quot;waiting for DrawingArea creation&quot;);
                Thread.Sleep(5);
                Gdk.Threads.Enter();
            }

            Gtk.VBox box = new VBox();

            My.Debug(&quot;attaching DrawingArea&quot;);
            box.Add(_darea);

            Gtk.Button quit = new Gtk.Button(&quot;Quit&quot;);
            quit.Clicked += ClickQuit;
            box.Add(quit);

            Add(box);
        }


        private void threadFunc()
        {
            My.Debug(&quot;thread started&quot;);

            Gdk.Threads.Enter();
            _darea = new Draw();
            _darea.SetSizeRequest(400, 300);
            _running = true;
            Gdk.Threads.Leave();

            My.Debug(&quot;sleeping&quot;);

            while(_running)
            {
                Thread.Sleep(10);
            }

            My.Debug(&quot;destroying DrawingArea&quot;);

            Gdk.Threads.Enter();
            _darea.Destroy();
            Gdk.Threads.Leave();

            My.Debug(&quot;thread ended&quot;);
        }


        private void Quit()
        {
            _running = false;
            Gdk.Threads.Leave();
            _thread.Join();
            Gdk.Threads.Enter();

            My.Debug(&quot;quitting application&quot;);
            Application.Quit();
        }


        private void ClickQuit(object o, EventArgs e)
        {
            My.Debug(&quot;quit clicked&quot;);
            Quit();
        }


        protected override bool OnDeleteEvent(Event evnt)
        {
            My.Debug(&quot;Window deleted&quot;);
            Quit();
            return base.OnDeleteEvent(evnt);
        }


        protected override void OnDestroyed()
        {
            My.Debug(&quot;Window destroyed&quot;);
            base.OnDestroyed();
        }
    }

    public class Program
    {
        public static int Main(string[] args)
        {
            My.Debug(&quot;starting program&quot;);

            if (!GLib.Thread.Supported)
                GLib.Thread.Init();
            Gdk.Threads.Init();
            Gdk.Threads.Enter();

            Application.Init();
            Win win = new Win(&quot;Program&quot;);
            win.ShowAll();

            My.Debug(&quot;entering GTK loop&quot;);
            Application.Run();

            Gdk.Threads.Leave();

            My.Debug(&quot;ending program&quot;);
            return 0;
        }
    }
}

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009059.html">[Gtk-sharp-list] Updating of a window not done right away
</A></li>
	<LI>Next message: <A HREF="009034.html">[Gtk-sharp-list] Gtk.DrawingArea not thread-agnostic on Win32?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9033">[ date ]</a>
              <a href="thread.html#9033">[ thread ]</a>
              <a href="subject.html#9033">[ subject ]</a>
              <a href="author.html#9033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
