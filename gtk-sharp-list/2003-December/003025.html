<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Gtk.Idle support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:martorella%40sssup.it">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003024.html">
   <LINK REL="Next"  HREF="003036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Gtk.Idle support
   </H1>
    <B>Luciano
    </B> 
    <A HREF="mailto:martorella%40sssup.it"
       TITLE="[Gtk-sharp-list] Gtk.Idle support">martorella@sssup.it
       </A><BR>
    <I>Fri, 19 Dec 2003 21:09:04 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="003024.html">[Gtk-sharp-list] NUnit front end
</A></li>
        <LI> Next message: <A HREF="003036.html">[Gtk-sharp-list] Need Help installing GTK# on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3025">[ date ]</a>
              <a href="thread.html#3025">[ thread ]</a>
              <a href="subject.html#3025">[ subject ]</a>
              <a href="author.html#3025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.
--------------060206090602060206040908
Content-Type: text/plain; charset=us-ascii; format=flowed
Content-Transfer-Encoding: 7bit


  Hi!

  I want to start a brief discussion on &quot;Idle&quot; support on gtk.
  The class &quot;Gtk.Idle&quot; autogenerated from the API work well, but the 
class is removed (hidden) from the metadata. I think for style reasons.

  I have improved myself for testing around in C#, and i have wroted a 
small piece of code what implements Idle events from Gtk.Application. 
This is more &quot;c sharp&quot; and more aligned with glib signals schema, i think.
  To reflect the priority associated with every idle callback (like in 
GTK+), i wrote an attribute to associate with the target of delegate. I 
explain myself with an example:


   [IdlePriority (IdlePriorityEnum.High)]
   void OnIdle (object o, EventArgs args)
   {
      .. some code ..
   }

     ..
     Application.Idle += new EventHandler (OnIdle);


  The piece of code included with this mail work fine, but i don't 
succeed to read the attribute from the target of delegate.

  Everyone interested to complete the work? For typical OpenGL apps with 
animation, the idle loop is very useful...

  Thanks a lot!

  P.S. After vacancies my lab offer english course to researcher... i 
want to partecipate... :)

------------------------
-| Luciano Martorella  \-
---------------------------------
<A HREF="http://net.supereva.it/noinetcorp">http://net.supereva.it/noinetcorp</A>
---------------------------------

--------------060206090602060206040908
Content-Type: text/plain;
 name=&quot;Application.diff&quot;
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename=&quot;Application.diff&quot;

Index: Application.cs
===================================================================
RCS file: /mono/gtk-sharp/gtk/Application.cs,v
retrieving revision 1.11
diff -u -p -r1.11 Application.cs
--- Application.cs	25 Mar 2003 16:57:05 -0000	1.11
+++ Application.cs	19 Dec 2003 19:47:50 -0000
@@ -9,6 +9,7 @@ namespace Gtk {
 	using System;
 	using System.Runtime.InteropServices;
 	using Gdk;
+	using GtkSharp;
 
 	public class Application {
 
@@ -173,5 +174,77 @@ namespace Gtk {
 				return null;
 			}
 		}
+		
+
+
+
+
+
+
+
+
+
+		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
+		static extern void gtk_idle_remove (uint idle_handler_id);
+		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
+		static extern uint gtk_idle_add_priority (int priority, GtkSharp.FunctionNative function, IntPtr data);
+
+		class _IdleCallback 
+		{
+			public uint			id;
+			public Delegate 	handler;
+		}			
+		
+		// Hashtable of callbacks (grouped by priority)
+		static Collections.Hashtable 	_IdleInstances = new Collections.Hashtable ();
+	
+		// The low level callback 
+		private static bool 		IdleCallback (IntPtr context)
+		{
+			int priority = (int)context;
+			_IdleCallback cb = _IdleInstances[priority] as _IdleCallback;
+			if (cb == null)
+				throw new Exception (&quot;wrong context in IdleCallback&quot;);
+			EventHandler handler = (EventHandler) cb.handler;
+			handler (null, new EventArgs ());
+			return true;
+		}
+
+		static private int GetIdlePriority (Delegate f)
+		{
+			IdlePriorityAttribute attr = Attribute.GetCustomAttribute (f.Method.GetType(), typeof (IdlePriorityAttribute)) as IdlePriorityAttribute;
+			if (attr != null)
+				return attr.Priority;
+			return (int)IdlePriorityEnum.Redraw;
+		}
+	
+		static public event EventHandler Idle {
+			add {
+				int priority = GetIdlePriority (value);					
+				Console.WriteLine (&quot;Add: Priority {0}&quot;, priority);
+				_IdleCallback cb = _IdleInstances [priority] as _IdleCallback;
+				if (cb == null) {
+					cb = new _IdleCallback ();
+					cb.id = gtk_idle_add_priority (priority, 
+												   new GtkSharp.FunctionNative (IdleCallback), 
+												   (IntPtr)priority);
+					cb.handler = value;
+					_IdleInstances[priority] = cb; 
+				}
+				else
+					cb.handler = Delegate.Combine (cb.handler, value);
+			}
+			remove {
+				int priority = GetIdlePriority (value);					
+				Console.WriteLine (&quot;Remove: Priority {0}&quot;, priority);
+				_IdleCallback cb = _IdleInstances [priority] as _IdleCallback;
+				cb.handler = Delegate.Remove (cb.handler, value);
+				if (cb.handler == null) {
+					gtk_idle_remove (cb.id);
+					_IdleInstances.Remove (priority);
+				}
+			}
+		}
 	}
 }
+

--------------060206090602060206040908
Content-Type: text/plain;
 name=&quot;IdlePriority.cs&quot;
Content-Transfer-Encoding: 7bit
Content-Disposition: inline;
 filename=&quot;IdlePriority.cs&quot;


// GTK.IdlePriority.cs - GTK Priority attribute of Idle callback implementation
//
// Author: Luciano Martorella &lt;<A HREF="mailto:mad_lux_it@users.sourceforge.net">mad_lux_it@users.sourceforge.net</A>&gt;
//
// (c) 2003 Luciano Martorella


using System;

namespace GtkSharp {

	public enum IdlePriorityEnum
	{
		High = -100,
		Default = 0,
		HighIdle = 100,
		Resize = 110,
		Redraw = 120,
		DefaultIdle = 200,
		Low = 300
	}

	[AttributeUsage (AttributeTargets.Method)]
	public class IdlePriorityAttribute : Attribute 
	{
		private int priority;
		
		public IdlePriorityAttribute (IdlePriorityEnum e, int modifier)
		{
			priority = (int)e + modifier;
		} 
		public IdlePriorityAttribute (IdlePriorityEnum e)
		{
			priority = (int)e;
		} 
		public int Priority
		{
			get { return priority; }
		}
	} 

}

--------------060206090602060206040908--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003024.html">[Gtk-sharp-list] NUnit front end
</A></li>
	<LI> Next message: <A HREF="003036.html">[Gtk-sharp-list] Need Help installing GTK# on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3025">[ date ]</a>
              <a href="thread.html#3025">[ thread ]</a>
              <a href="subject.html#3025">[ subject ]</a>
              <a href="author.html#3025">[ author ]</a>
         </LI>
       </UL>
</body></html>
