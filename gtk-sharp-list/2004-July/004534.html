<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Embedding Gtk-Sharp Programs into C
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pyroman%40ninjapanda.org">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="004527.html">
   <LINK REL="Next"  HREF="004513.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Embedding Gtk-Sharp Programs into C
   </H1>
    <B>Pyroman[FO]
    </B> 
    <A HREF="mailto:pyroman%40ninjapanda.org"
       TITLE="[Gtk-sharp-list] Embedding Gtk-Sharp Programs into C">pyroman@ninjapanda.org
       </A><BR>
    <I>Mon, 26 Jul 2004 13:59:51 -0400</I>
    <P><UL>
        <LI> Previous message: <A HREF="004527.html">[Gtk-sharp-list] Embedding Gtk-Sharp Programs into C
</A></li>
        <LI> Next message: <A HREF="004513.html">[Gtk-sharp-list] Gtk Widgets from glade files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4534">[ date ]</a>
              <a href="thread.html#4534">[ thread ]</a>
              <a href="subject.html#4534">[ subject ]</a>
              <a href="author.html#4534">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This worked like a charm, for anybody wanting to know the actual code,
here's my example, MonoTest.  It creates a Frame in C, then passes the
pointer to a C# function, which creates a C# frame and manipulates it.
These changes are reflected in the original C frame.

Thanks Mikkel, this'll do what I need it to.  However I was still having
problems getting it linked when it was a C++ program using GtkMM.  I
kept getting undefined reference errors for every mono function I called
in C++ and GtkMM, when the exact same code using C and GTK+ worked fine.

monotest.c &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
#include &lt;gtk/gtk.h&gt;
#include &lt;mono/jit/jit.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;mono/metadata/debug-helpers.h&gt;
#include &lt;mono/metadata/threads.h&gt;
#include &lt;mono/metadata/assembly.h&gt;
#include &lt;mono/metadata/environment.h&gt;
int main(int argc, char *argv[])  {

	GtkWidget *window;

	gtk_init (&amp;argc, &amp;argv);

	window = gtk_window_new (GTK_WINDOW_TOPLEVEL);	

	MonoDomain *domain;
	MonoAssembly *assembly;
	MonoClass *monoclass;
	MonoMethodDesc *desc;
	MonoMethod *method,*m;
	MonoImage *image;
	MonoObject *obj;
	GtkWidget *widget;
	gpointer iter;

	printf(&quot;mono jit init\n&quot;);
	domain = mono_jit_init(&quot;monotest.exe&quot;);
	if (!domain) printf(&quot;FAIL\n&quot;);
	printf(&quot;mono thread attach\n&quot;);
	mono_thread_attach(domain);
	printf(&quot;mono domain assembly open\n&quot;);
	assembly = mono_domain_assembly_open(domain, &quot;monotest.exe&quot;);
	if (!assembly) printf(&quot;FAIL\n&quot;);
	printf(&quot;mono jit exec\n&quot;);
	mono_jit_exec(domain,assembly,argc-1,argv+1);
	printf(&quot;mono assembly get image\n&quot;);
	image = mono_assembly_get_image(assembly);
	if (!image) printf(&quot;FAIL\n&quot;);
	printf(&quot;mono class from name\n&quot;);
	monoclass = mono_class_from_name (image, &quot;MonoTestSpace&quot;, &quot;MonoTest&quot;);
	if (!monoclass) printf(&quot;FAIL\n&quot;);
	printf(&quot;get method\n&quot;);
	iter = NULL;
	while ((m = mono_class_get_methods (monoclass, &amp;iter)))
		if (strcmp (mono_method_get_name (m), &quot;Test&quot;) == 0)
			method = m;		
	if (!method) printf(&quot;FAIL\n&quot;);

	printf(&quot;mono object new\n&quot;);
	obj = mono_object_new(domain,monoclass);
	if (!obj) printf(&quot;FAIL\n&quot;);
	printf(&quot;mono runtime object init\n&quot;);
	mono_runtime_object_init(obj);
	gpointer args[1];
	widget = gtk_frame_new(0);
	args[0] = &amp;widget; 	
	printf(&quot;mono runtime invoke\n&quot;);
	mono_runtime_invoke(method,obj,args,NULL);
	gtk_container_add(GTK_CONTAINER(window),widget);

	gtk_widget_show_all(window);

	gtk_main ();
return 0;
}

monotest.cs &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;
namespace MonoTestSpace
{
	using Gtk;
	using GtkSharp;
	using System;
	class MonoTest
	{
		public void Test (IntPtr raw)
		{	
			Gtk.Frame frame = new Gtk.Frame(raw);
			frame.Label = &quot;In C#&quot;;
		}
		static void Main()
		{
		}
	}
}

Allen Cook


Mikkel Kruse Johnsen wrote:
&gt;<i> Hi Pyroman
</I>&gt;<i> 
</I>&gt;<i> I don't think that will work, but try. I would make the GtkFrame in C
</I>&gt;<i> like this and have C# add to it.
</I>&gt;<i> 
</I>&gt;<i> GtkFrame *frame;
</I>&gt;<i> 
</I>&gt;<i> frame = gtk_frame_new ();
</I>&gt;<i> args[0] = &amp;frame;
</I>&gt;<i> mono_runtime_invoke (method, object, args, NULL);
</I>&gt;<i> 
</I>&gt;<i> and in C# do:
</I>&gt;<i> 
</I>&gt;<i> namespace TestApp
</I>&gt;<i> {
</I>&gt;<i> 	class Plugin : Gtk.Frame
</I>&gt;<i> 	{
</I>&gt;<i> 		public Plugin (IntPtr raw) : base(raw)	
</I>&gt;<i> 		{
</I>&gt;<i> 			this.Add (new Gtk.Button(&quot;Hello World&quot;);
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	class Test
</I>&gt;<i> 	{
</I>&gt;<i> 		public void Init (IntPtr raw)
</I>&gt;<i> 		{
</I>&gt;<i> 			new Plugin (raw);
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> /Mikkel
</I>&gt;<i> 
</I>&gt;<i> On Fri, 2004-07-23 at 16:12, Pyroman[FO] wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>So if I create in C#
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Gtk.Frame frame;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Then in the Test.Init function do
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>raw = frame
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Then resulting C program can then use widget as a valid GtkWidget pointer?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Allen Cook
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Mikkel Kruse Johnsen wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Hi Pyroman
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Yes, it is possible.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I'm myself embedding bonobo componets written in gtk-sharp (C#) into my
</I>&gt;&gt;&gt;<i>C program. It is where possible to return Gtk.Widget, I don't do that
</I>&gt;&gt;&gt;<i>myself, but im passing a Gtk.Container to the C# code and the adding
</I>&gt;&gt;&gt;<i>stuff to that.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Just do this in the C program:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>	domain = mono_jit_init (PACKAGE);
</I>&gt;&gt;&gt;<i>	mono_config_parse (&quot;/etc/mono/machine.config&quot;);
</I>&gt;&gt;&gt;<i>	mono_config_parse (&quot;/etc/mono/config&quot;);
</I>&gt;&gt;&gt;<i>	mono_thread_attach (domain);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>and then:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>	MonoDomain 	 	 		*domain;
</I>&gt;&gt;&gt;<i>	MonoAssembly 	 		*assembly;	
</I>&gt;&gt;&gt;<i>	MonoClass				*class;
</I>&gt;&gt;&gt;<i>	MonoImage				*image;
</I>&gt;&gt;&gt;<i>	MonoMethod	 	*method;
</I>&gt;&gt;&gt;<i>	MonoObject 		*object;
</I>&gt;&gt;&gt;<i>	MonoMethodDesc 	*desc;
</I>&gt;&gt;&gt;<i>	gpointer 		 args[1];
</I>&gt;&gt;&gt;<i>	GtkWidget	*widget;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>	domain = mono_domain_get ();
</I>&gt;&gt;&gt;<i>	assembly = mono_domain_assembly_open (domain, &quot;test.dll&quot;);
</I>&gt;&gt;&gt;<i>	image = mono_assembly_get_image (assembly);
</I>&gt;&gt;&gt;<i>	class = mono_class_from_name (image, &quot;TestApp&quot;, &quot;Test&quot;);
</I>&gt;&gt;&gt;<i>	desc = mono_method_desc_new (&quot;TestApp.Test:Init&quot;, TRUE);
</I>&gt;&gt;&gt;<i>	method = mono_method_desc_search_in_class (desc, class);
</I>&gt;&gt;&gt;<i>	mono_method_desc_free (desc);
</I>&gt;&gt;&gt;<i>	object = mono_object_new (domain, class);
</I>&gt;&gt;&gt;<i>	mono_runtime_object_init (object);
</I>&gt;&gt;&gt;<i>	args[0] = &amp;widget;
</I>&gt;&gt;&gt;<i>	mono_runtime_invoke (method, object, args, NULL);
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>C#
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>namespace TestApp
</I>&gt;&gt;&gt;<i>{
</I>&gt;&gt;&gt;<i>	class Test
</I>&gt;&gt;&gt;<i>	{
</I>&gt;&gt;&gt;<i>		public void Init (IntPtr raw)
</I>&gt;&gt;&gt;<i>		{	
</I>&gt;&gt;&gt;<i>		}
</I>&gt;&gt;&gt;<i>	}
</I>&gt;&gt;&gt;<i>}
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>This is just a rough paste, but should work somewhat.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>/Mikkel
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>On Thu, 2004-07-22 at 19:29, Pyroman[FO] wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>I was wondering if there was a way to embed a Gtk-Sharp application in a 
</I>&gt;&gt;&gt;&gt;<i>C program.  I know you can do this with Mono, however what I'm worried 
</I>&gt;&gt;&gt;&gt;<i>about is the ability to return Gtk Widgets, Containers, ect. to the 
</I>&gt;&gt;&gt;&gt;<i>parent C program and use them with GTK or GTKmm code.  Our program has a 
</I>&gt;&gt;&gt;&gt;<i>plugin structure, and we call the plugin to return the main GTK frame 
</I>&gt;&gt;&gt;&gt;<i>for the plugin, which we then display in the parent program.  I am 
</I>&gt;&gt;&gt;&gt;<i>looking for a way to embed the Mono runtime and use mono plugins for 
</I>&gt;&gt;&gt;&gt;<i>this.  Is it possible?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>Allen Cook
</I>&gt;&gt;&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;&gt;&gt;<i>Gtk-sharp-list maillist  -  <A HREF="mailto:Gtk-sharp-list@lists.ximian.com">Gtk-sharp-list@lists.ximian.com</A>
</I>&gt;&gt;&gt;&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-lis">http://lists.ximian.com/mailman/listinfo/gtk-sharp-lis</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>t
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;<i>Gtk-sharp-list maillist  -  <A HREF="mailto:Gtk-sharp-list@lists.ximian.com">Gtk-sharp-list@lists.ximian.com</A>
</I>&gt;&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-lis">http://lists.ximian.com/mailman/listinfo/gtk-sharp-lis</A>
</I>&gt;<i> 
</I>&gt;<i> t
</I>

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="004527.html">[Gtk-sharp-list] Embedding Gtk-Sharp Programs into C
</A></li>
	<LI> Next message: <A HREF="004513.html">[Gtk-sharp-list] Gtk Widgets from glade files?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4534">[ date ]</a>
              <a href="thread.html#4534">[ thread ]</a>
              <a href="subject.html#4534">[ subject ]</a>
              <a href="author.html#4534">[ author ]</a>
         </LI>
       </UL>
</body></html>
