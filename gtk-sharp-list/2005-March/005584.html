<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Memory leakage in Expose?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:muell_muell_%40gmx.net">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="005586.html">
   <LINK REL="Next"  HREF="005585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Memory leakage in Expose?
   </H1>
    <B>muell_muell_@gmx.net
    </B> 
    <A HREF="mailto:muell_muell_%40gmx.net"
       TITLE="[Gtk-sharp-list] Memory leakage in Expose?">muell_muell_@gmx.net
       </A><BR>
    <I>Thu, 24 Mar 2005 13:57:22 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="005586.html">[Gtk-sharp-list] Mono 1.1.5 crash with Glade.XML.Autoconnect()
</A></li>
        <LI> Next message: <A HREF="005585.html">[Gtk-sharp-list] Memory leakage in Expose?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5584">[ date ]</a>
              <a href="thread.html#5584">[ thread ]</a>
              <a href="subject.html#5584">[ subject ]</a>
              <a href="author.html#5584">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a multi-part message in MIME format.
--------------030505010002020005000407
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit

Hi *,
i have written an gtk-sharp application in c# and everything works fine.
My main window is filled with a Gtk.Fixed and on this, there will be
other widgets placed.

The problem: since the first widget is placed on the Gtk.Fixed the
program takes up to 90% of cpu usage and the used memory is slowly
growing up to infinity. During debugging i explored, that there are 2
exposed functions, which are always called:
the exposed function of the gtk.Fixed:
        public void rahmen_ExposeEvent(object o, Gtk.ExposeEventArgs args) {
            Gdk.Color c_inaktiv = new Gdk.Color(0, 0, 0);
            Gdk.Color c_aktiv = new Gdk.Color(255, 0, 0);
            foreach (Verbinder verb in this.verbindungen) {
                int x1, y1, x2, y2;
                verb.Von.TranslateCoordinates(this.bk, 0, 0, out x1, out
y1);
                verb.Bis.TranslateCoordinates(this.bk, 0, 0, out x2, out
y2);

                Gtk.Requisition r1 = verb.Von.SizeRequest();
                x1 += r1.Width;
                y1 +=
((verb.Von.kastenrahmen.kastenwidget.SizeRequest().Height/verb.Von.kastenrahmen.buttons_ausgabe.Count)/2);

                // Linien-Ziel-Koordinaten berechnen
                y2 +=
((verb.Bis.kastenrahmen.kastenwidget.SizeRequest().Height/verb.Bis.kastenrahmen.buttons_eingabe.Count)/2);

                if (verb.VerbindungAktiv) {
                    this.ModifyBase(Gtk.StateType.Normal, c_aktiv);
                } else {
                    this.ModifyBase(Gtk.StateType.Normal, c_inaktiv);
                }
               
this.GdkWindow.DrawLine(this.Style.BaseGC(Gtk.StateType.Normal), x1, y1,
x2, y2);
            }
        }
it runs checks a special ArrayList and calculating coordinates of a view
widgets ans draw lines between them.

the exposed funktion of the widget on the gtk.fixed:
void Kasten_ExposeEvent(object o, Gtk.ExposeEventArgs args) {
            kasten_groesse = this.SizeRequest();
            Gdk.Color c_hintergrund = new Gdk.Color(255, 255, 255);
            Gdk.Color c_rahmen = new Gdk.Color(0, 0, 0);
            Gdk.Color c_selected = new Gdk.Color(255, 0, 0);

            this.ModifyBase(Gtk.StateType.Normal, c_hintergrund);
            Gdk.GC gc = this.Style.BaseGC(Gtk.StateType.Normal);
            this.GdkWindow.DrawRectangle(gc, true, 0, 0,
this.kasten_groesse.Width, this.kasten_groesse.Height);
            this.ModifyBase(Gtk.StateType.Normal, c_rahmen);
            if (Angeklickt) {
                this.ModifyBase(Gtk.StateType.Normal, c_selected);
            }
           
this.GdkWindow.DrawRectangle(this.Style.BaseGC(Gtk.StateType.Normal),
false, 0, 0, this.kasten_groesse.Width - 1, this.kasten_groesse.Height - 1);
           
this.GdkWindow.DrawRectangle(this.Style.BaseGC(Gtk.StateType.Normal),
false, 1, 1, this.kasten_groesse.Width - 3, this.kasten_groesse.Height - 3);
           
this.GdkWindow.DrawRectangle(this.Style.BaseGC(Gtk.StateType.Normal),
false, 2, 2, this.kasten_groesse.Width - 5, this.kasten_groesse.Height - 5);

            int w,h;
            layout.GetPixelSize(out w, out h);
           
this.GdkWindow.DrawLayout(this.Style.TextGC(StateType.Normal),
((kasten_groesse.Width / 2) - (w / 2)), ((kasten_groesse.Height / 2) -
(h / 2)), layout);
        }

i think the sourcecode of the exposed functions are correct. i will be
gratefully for any solution why the program using so much memory and cpu.
thanks
Thomas Zühlke

--------------030505010002020005000407
Content-Type: text/html; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta content=&quot;text/html;charset=ISO-8859-1&quot; http-equiv=&quot;Content-Type&quot;&gt;
  &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;
Hi *,&lt;br&gt;
i have written an &lt;span&gt;gtk&lt;/span&gt;-sharp application in c# and
everything works fine. My main window is filled with a &lt;span&gt;Gtk&lt;/span&gt;.Fixed
and on this, there will be other widgets placed.&lt;br&gt;
&lt;br&gt;
The problem: since the first widget is placed on the &lt;span&gt;Gtk&lt;/span&gt;.Fixed
the program takes up to 90% of &lt;span&gt;cpu&lt;/span&gt; usage and the used
memory is slowly growing up to infinity. During debugging i explored,
that there are 2 exposed functions, which are always called:&lt;br&gt;
the exposed function of the &lt;span&gt;gtk&lt;/span&gt;.Fixed:&lt;br&gt;
&lt;small&gt;&lt;font face=&quot;Courier New, Courier, monospace&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; public void
rahmen_ExposeEvent(object o, &lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;ExposeEventArgs&lt;/span&gt;
&lt;span&gt;args&lt;/span&gt;) {&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gdk&lt;/span&gt;.Color c_inaktiv = new &lt;span&gt;Gdk&lt;/span&gt;.Color(0,
0, 0);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gdk&lt;/span&gt;.Color c_aktiv = new &lt;span&gt;Gdk&lt;/span&gt;.Color(255,
0, 0);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;foreach&lt;/span&gt; (&lt;span&gt;Verbinder&lt;/span&gt; verb in this.&lt;span&gt;verbindungen&lt;/span&gt;)
{&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; int x1, y1, x2, y2;&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; verb.Von.&lt;span&gt;TranslateCoordinates&lt;/span&gt;(this.bk, 0,
0, out x1, out y1);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; verb.Bis.&lt;span&gt;TranslateCoordinates&lt;/span&gt;(this.bk, 0,
0, out x2, out y2);&lt;br&gt;
&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gtk&lt;/span&gt;.Requisition r1 = verb.Von.&lt;span&gt;SizeRequest&lt;/span&gt;();&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; x1 += r1.Width;&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; y1 += ((verb.Von.kastenrahmen.kastenwidget.&lt;span&gt;SizeRequest&lt;/span&gt;().Height/verb.Von.&lt;span&gt;kastenrahmen&lt;/span&gt;.buttons_ausgabe.Count)/2);&lt;br&gt;
&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; // &lt;span&gt;Linien&lt;/span&gt;-&lt;span&gt;Ziel&lt;/span&gt;-&lt;span&gt;Koordinaten&lt;/span&gt;
&lt;span&gt;berechnen&lt;/span&gt;&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; y2 += ((verb.Bis.kastenrahmen.kastenwidget.&lt;span&gt;SizeRequest&lt;/span&gt;().Height/verb.Bis.&lt;span&gt;kastenrahmen&lt;/span&gt;.buttons_eingabe.Count)/2);&lt;br&gt;
&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; if (verb.&lt;span&gt;VerbindungAktiv&lt;/span&gt;) {&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.&lt;span&gt;ModifyBase&lt;/span&gt;(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal,
c_aktiv);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; } else {&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.&lt;span&gt;ModifyBase&lt;/span&gt;(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal,
c_inaktiv);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.&lt;span&gt;GdkWindow&lt;/span&gt;.&lt;span&gt;DrawLine&lt;/span&gt;(this.Style.&lt;span&gt;BaseGC&lt;/span&gt;(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal),
x1, y1, x2, y2);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;
&lt;/font&gt;&lt;/small&gt;it runs checks a special &lt;span&gt;ArrayList&lt;/span&gt; and
calculating coordinates of a view widgets ans draw lines between them.&lt;br&gt;
&lt;br&gt;
the exposed &lt;span&gt;funktion&lt;/span&gt; of the widget on the &lt;span&gt;gtk&lt;/span&gt;.fixed:&lt;br&gt;
&lt;small&gt;&lt;font face=&quot;Courier New, Courier, monospace&quot;&gt;void
Kasten_ExposeEvent(object o, &lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;ExposeEventArgs&lt;/span&gt;
&lt;span&gt;args&lt;/span&gt;) {&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; kasten_groesse = this.&lt;span&gt;SizeRequest&lt;/span&gt;();&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gdk&lt;/span&gt;.Color c_hintergrund = new &lt;span&gt;Gdk&lt;/span&gt;.Color(255,
255, 255);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gdk&lt;/span&gt;.Color c_rahmen = new &lt;span&gt;Gdk&lt;/span&gt;.Color(0,
0, 0);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &lt;span&gt;Gdk&lt;/span&gt;.Color c_selected = new &lt;span&gt;Gdk&lt;/span&gt;.Color(255,
0, 0);&lt;br&gt;
&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.&lt;span&gt;ModifyBase&lt;/span&gt;(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal,
c_hintergrund);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; Gdk.GC gc = this.Style.BaseGC(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.GdkWindow.DrawRectangle(&lt;span&gt;gc&lt;/span&gt;, true, 0, 0,
this.kasten_groesse.Width, this.kasten_groesse.Height);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.ModifyBase(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal,
c_rahmen);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; if (&lt;span&gt;Angeklickt&lt;/span&gt;) {&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.ModifyBase(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal,
c_selected);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.GdkWindow.DrawRectangle(this.Style.BaseGC(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal),
false, 0, 0, this.kasten_groesse.Width - 1, this.kasten_groesse.Height
- 1);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.GdkWindow.DrawRectangle(this.Style.BaseGC(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal),
false, 1, 1, this.kasten_groesse.Width - 3, this.kasten_groesse.Height
- 3);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.GdkWindow.DrawRectangle(this.Style.BaseGC(&lt;span&gt;Gtk&lt;/span&gt;.&lt;span&gt;StateType&lt;/span&gt;.Normal),
false, 2, 2, this.kasten_groesse.Width - 5, this.kasten_groesse.Height
- 5);&lt;br&gt;
&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; int w,h;&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; layout.&lt;span&gt;GetPixelSize&lt;/span&gt;(out w, out h);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; this.GdkWindow.DrawLayout(this.Style.TextGC(&lt;span&gt;StateType&lt;/span&gt;.Normal),
((kasten_groesse.Width / 2) - (w / 2)), ((kasten_groesse.Height / 2) -
(h / 2)), layout);&lt;br&gt;
&amp;nbsp;&amp;nbsp;&amp;nbsp; &amp;nbsp;&amp;nbsp;&amp;nbsp; }&lt;/font&gt;&lt;/small&gt;&lt;br&gt;
&lt;br&gt;
i think the &lt;span&gt;sourcecode&lt;/span&gt; of the exposed functions are
correct. i will be gratefully for any solution why the program using so
much memory and &lt;span&gt;cpu&lt;/span&gt;.&lt;br&gt;
thanks&lt;br&gt;
Thomas &lt;span&gt;Z&amp;uuml;hlke&lt;/span&gt;
&lt;/body&gt;
&lt;/html&gt;

--------------030505010002020005000407--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="005586.html">[Gtk-sharp-list] Mono 1.1.5 crash with Glade.XML.Autoconnect()
</A></li>
	<LI> Next message: <A HREF="005585.html">[Gtk-sharp-list] Memory leakage in Expose?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5584">[ date ]</a>
              <a href="thread.html#5584">[ thread ]</a>
              <a href="subject.html#5584">[ subject ]</a>
              <a href="author.html#5584">[ author ]</a>
         </LI>
       </UL>
</body></html>
