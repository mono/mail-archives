<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] PATCH: TextIter usage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:hestilow%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000086.html">
   <LINK REL="Next"  HREF="000088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] PATCH: TextIter usage
   </H1>
    <B>Rachel Hestilow
    </B> 
    <A HREF="mailto:hestilow%40ximian.com"
       TITLE="[Gtk-sharp-list] PATCH: TextIter usage">hestilow@ximian.com
       </A><BR>
    <I>09 Jun 2002 03:54:28 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="000086.html">[Gtk-sharp-list] Bugs - past, present, and future
</A></li>
        <LI> Next message: <A HREF="000088.html">[Gtk-sharp-list] PATCH: TextIter usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87">[ date ]</a>
              <a href="thread.html#87">[ thread ]</a>
              <a href="subject.html#87">[ subject ]</a>
              <a href="author.html#87">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-aVpYgBEomaDJ/XfCSZTc
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

I've been playing with the idea of an interactive LOGO console using
Gtk#, and I ran into problems with the text widget - namely, &quot;out&quot;
parameters (as TextIter is often used) are not supported. Additionally,
code needed to be added to allocate TextIter on the heap, not the stack
as is usually the case with GtkTextIter. The attached patch makes the
following changes:

* Add support for metadata in the xml generator. Additional properties
  for given methods will be loaded from &lt;namespace&gt;.metadata.
  This exposed a bug in LibXML. It has been fixed in CVS, so you will
  need to use that if you want to regenerate gtkapi.xml.
* Add a textiter constructor to the glue library.
* Check for .custom files for all generatable targets, and include
  a TextIter.custom that calls the glue constructor.
* Check for a new parameter attribute, &quot;pass_as&quot;, to indicate if
  the parameter should be passed as &quot;out.&quot; As an additional niceity,
  if the method is named Get* and has only the one out parameter, 
  generate an accessor instead of the method.

With these changes, an application author can simply call
         buf.Insert (buf.EndIter, txt, txt.Length);
to append text to a buffer.

May I commit this and the regenerated gtkapi.xml?

-- Rachel

--=-aVpYgBEomaDJ/XfCSZTc
Content-Disposition: inline; filename=textiter.patch
Content-Transfer-Encoding: quoted-printable
Content-Type: text/x-patch; name=textiter.patch; charset=ISO-8859-1

Index: ChangeLog
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/ChangeLog,v
retrieving revision 1.94
diff -u -r1.94 ChangeLog
--- ChangeLog	6 Jun 2002 23:17:10 -0000	1.94
+++ ChangeLog	9 Jun 2002 04:56:33 -0000
@@ -1,3 +1,21 @@
+2002-06-09  Rachel Hestilow  &lt;<A HREF="mailto:hestilow@ximian.com">hestilow@ximian.com</A>&gt;
+
+	* generator/GenBase.cs: new method AppendCustom, moved from ObjectGen.
+	* generator/BoxedGen.cs, EnumGen.cs, ObjectGen.cs, StructGen.cs:
+	Call AppendCustom in Generate ();
+	* generator/Method.cs, Parameters.cs: Add support for &quot;out&quot;
+	parameters. Additionally, output an accessor instead of a
+	regular method if it is an accessor-style function (ie GetStartIter).
+	* generator/Property.cs: Add additional cast to Boxed, if necessary.
+	* glue/textiter.c: New constructor for GtkTextIter.
+	* glue/Makefile.am: Add textiter.c, build with Gtk+ cflags.
+	* configure.in: Check for Gtk+ cflags.
+	* parser/Metadata.pm, Gtk.metadata: Added.
+	* parser/gapi2xml.pl: Call Metadata::fixup on the document.
+	Also work around gtk's screwy boxed type name registration
+	(GtkFoo -&gt; GtkTypeFoo).
+	* gtk/TextIter.custom: Added.
+=09
 2002-06-06  Mike Kestner &lt;<A HREF="mailto:mkestner@speakeasy.net">mkestner@speakeasy.net</A>&gt;
=20
 	* glib/Timeout.cs : new Timeout class with Add() and=20
Index: configure.in
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/configure.in,v
retrieving revision 1.2
diff -u -r1.2 configure.in
--- configure.in	2 May 2002 21:57:40 -0000	1.2
+++ configure.in	9 Jun 2002 04:56:33 -0000
@@ -39,10 +39,10 @@
=20
 dnl for use on the build system
 dnl pkg-config is stupid
-BUILD_GLIB_CFLAGS=3D`$PKG_CONFIG --cflags glib-2.0`
-BUILD_GLIB_LIBS=3D`$PKG_CONFIG --libs glib-2.0`
-AC_SUBST(BUILD_GLIB_CFLAGS)
-AC_SUBST(BUILD_GLIB_LIBS)
+BUILD_GTK_CFLAGS=3D`$PKG_CONFIG --cflags gtk+-2.0`
+BUILD_GTK_LIBS=3D`$PKG_CONFIG --libs gtk+-2.0`
+AC_SUBST(BUILD_GTK_CFLAGS)
+AC_SUBST(BUILD_GTK_LIBS)
=20
 PKG_PATH=3D
 AC_ARG_WITH(crosspkgdir, [  --with-crosspkgdir=3D/path/to/pkg-config/dir],
@@ -58,17 +58,17 @@
 )
=20
 ## Versions of dependencies
-GLIB_REQUIRED_VERSION=3D2.0.0
+GTK_REQUIRED_VERSION=3D2.0.0
=20
-PKG_CHECK_MODULES(BASE_DEPENDENCIES, glib-2.0 &gt;=3D $GLIB_REQUIRED_VERSION)
+PKG_CHECK_MODULES(BASE_DEPENDENCIES, gtk+-2.0 &gt;=3D $GTK_REQUIRED_VERSION)
=20
-GLIB_CFLAGS=3D`$PKG_CONFIG --cflags glib-2.0`
-GLIB_LIBS=3D`$PKG_CONFIG --libs glib-2.0`
+GTK_CFLAGS=3D`$PKG_CONFIG --cflags gtk+-2.0`
+GTK_LIBS=3D`$PKG_CONFIG --libs gtk+-2.0`
 GMODULE_CFLAGS=3D`$PKG_CONFIG --cflags gmodule-2.0`
 GMODULE_LIBS=3D`$PKG_CONFIG --libs gmodule-2.0`
=20
-AC_SUBST(GLIB_CFLAGS)
-AC_SUBST(GLIB_LIBS)
+AC_SUBST(GTK_CFLAGS)
+AC_SUBST(GTK_LIBS)
 AC_SUBST(GMODULE_CFLAGS)
 AC_SUBST(GMODULE_LIBS)
=20
Index: generator/BoxedGen.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/BoxedGen.cs,v
retrieving revision 1.10
diff -u -r1.10 BoxedGen.cs
--- generator/BoxedGen.cs	23 May 2002 23:43:24 -0000	1.10
+++ generator/BoxedGen.cs	9 Jun 2002 04:56:33 -0000
@@ -97,6 +97,7 @@
 				}	=09=0D
 			}=0D
 		=09=0D
+			GenBase.AppendCustom(ns, Name, sw);=0D
 			sw.WriteLine (&quot;\t}&quot;);=0D
 			sw.WriteLine ();=0D
 			sw.WriteLine (&quot;}&quot;);=0D
Index: generator/EnumGen.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/EnumGen.cs,v
retrieving revision 1.9
diff -u -r1.9 EnumGen.cs
--- generator/EnumGen.cs	23 May 2002 23:43:24 -0000	1.9
+++ generator/EnumGen.cs	9 Jun 2002 04:56:33 -0000
@@ -33,6 +33,8 @@
 	=09=0D
 		public void Generate ()=0D
 		{=0D
+			if (Name.IndexOf (',') !=3D -1)=0D
+				return;=0D
 			StreamWriter sw =3D CreateWriter ();=0D
=20=0D
 			if (Elem.GetAttribute(&quot;type&quot;) =3D=3D &quot;flags&quot;) {=0D
Index: generator/GenBase.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/GenBase.cs,v
retrieving revision 1.1
diff -u -r1.1 GenBase.cs
--- generator/GenBase.cs	23 May 2002 23:43:24 -0000	1.1
+++ generator/GenBase.cs	9 Jun 2002 04:56:33 -0000
@@ -59,6 +59,7 @@
 				Directory.CreateDirectory(dir);=0D
 			}=0D
 			String filename =3D dir + sep + Name + &quot;.cs&quot;;=0D
+			Console.WriteLine (&quot;creating &quot; + filename);=0D
 		=09=0D
 			FileStream stream =3D new FileStream (filename, FileMode.Create, FileAc=
cess.Write);=0D
 			StreamWriter sw =3D new StreamWriter (stream);=0D
@@ -80,6 +81,17 @@
 			sw.Close();=0D
 		}=0D
 	=09=0D
+		public static void AppendCustom (string ns, string name, StreamWriter sw=
)=0D
+		{=0D
+			char sep =3D Path.DirectorySeparatorChar;=0D
+			string custom =3D &quot;..&quot; + sep + ns.ToLower() + sep + name + &quot;.custom&quot;;=0D
+			if (File.Exists(custom)) {=0D
+				FileStream custstream =3D new FileStream(custom, FileMode.Open, FileAc=
cess.Read);=0D
+				StreamReader sr =3D new StreamReader(custstream);=0D
+				sw.WriteLine (sr.ReadToEnd ());=0D
+				sr.Close ();=0D
+			}=0D
+		}=0D
 	}=0D
 }=0D
=20=0D
Index: generator/Method.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/Method.cs,v
retrieving revision 1.1
diff -u -r1.1 Method.cs
--- generator/Method.cs	23 May 2002 23:43:24 -0000	1.1
+++ generator/Method.cs	9 Jun 2002 04:56:33 -0000
@@ -103,7 +103,7 @@
 		public void Generate (StreamWriter sw)=0D
 		{=0D
 			string sig, isig, call;=0D
-=0D
+		=09=0D
 			if (parms !=3D null) {=0D
 				sig =3D &quot;(&quot; + parms.Signature + &quot;)&quot;;=0D
 				isig =3D &quot;(IntPtr raw, &quot; + parms.ImportSig + &quot;);&quot;;=0D
@@ -130,18 +130,37 @@
 			sw.WriteLine();=0D
=20=0D
 			sw.Write(&quot;\t\tpublic &quot;);=0D
-			if (elem.HasAttribute(&quot;new_flag&quot;))=0D
-				sw.Write(&quot;new &quot;);=0D
-			sw.WriteLine(s_ret + &quot; &quot; + Name + sig);=0D
+			bool is_get =3D (parms !=3D null &amp;&amp; parms.IsAccessor &amp;&amp; Name.Substring(=
0, 3) =3D=3D &quot;Get&quot;);=0D
+			if (is_get) {=0D
+				s_ret =3D parms.AccessorReturnType;=0D
+				sw.Write(s_ret);=0D
+				sw.Write(&quot; &quot;);=0D
+				sw.Write(Name.Substring (3));=0D
+				sw.Write(&quot; { get&quot;);=0D
+			} else {=0D
+				if (elem.HasAttribute(&quot;new_flag&quot;))=0D
+					sw.Write(&quot;new &quot;);=0D
+				sw.WriteLine(s_ret + &quot; &quot; + Name + sig);=0D
+			}=0D
 			sw.WriteLine(&quot;\t\t{&quot;);=0D
+			if (parms !=3D null)=0D
+				parms.Initialize(sw, is_get);=0D
 			sw.Write(&quot;\t\t\t&quot;);=0D
-			if (m_ret =3D=3D &quot;void&quot;) {=0D
+			if (is_get || m_ret =3D=3D &quot;void&quot;) {=0D
 				sw.WriteLine(cname + call + &quot;;&quot;);=0D
 			} else {=0D
 				sw.WriteLine(&quot;return &quot; + SymbolTable.FromNative(rettype, cname + call)=
 + &quot;;&quot;);=0D
 			}=0D
+		=09=0D
+			if (is_get)=20=0D
+				sw.WriteLine (&quot;\t\t\treturn &quot; + parms.AccessorName + &quot;;&quot;);=20=0D
=20=0D
-			sw.WriteLine(&quot;\t\t}&quot;);=0D
+=0D
+			sw.Write(&quot;\t\t}&quot;);=0D
+			if (is_get)=0D
+				sw.Write(&quot; }&quot;);=0D
+		=09=0D
+			sw.WriteLine();=0D
 			sw.WriteLine();=0D
=20=0D
 			Statistics.MethodCount++;=0D
Index: generator/ObjectGen.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/ObjectGen.cs,v
retrieving revision 1.22
diff -u -r1.22 ObjectGen.cs
--- generator/ObjectGen.cs	23 May 2002 23:43:24 -0000	1.22
+++ generator/ObjectGen.cs	9 Jun 2002 04:56:33 -0000
@@ -96,15 +96,7 @@
 			GenProperties (sw);=0D
 			GenSignals (sw);=0D
 			GenMethods (sw);=0D
-=0D
-			char sep =3D Path.DirectorySeparatorChar;=0D
-			string custom =3D &quot;..&quot; + sep + Namespace.ToLower() + sep + Name + &quot;.cus=
tom&quot;;=0D
-			if (File.Exists(custom)) {=0D
-				FileStream custstream =3D new FileStream (custom, FileMode.Open, FileA=
ccess.Read);=0D
-				StreamReader sr =3D new StreamReader (custstream);=0D
-				sw.WriteLine (sr.ReadToEnd ());=0D
-				sr.Close ();=0D
-			}=0D
+			AppendCustom(Namespace, Name, sw);=0D
=20=0D
 			sw.WriteLine (&quot;\t}&quot;);=0D
=20=0D
Index: generator/Parameters.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/Parameters.cs,v
retrieving revision 1.1
diff -u -r1.1 Parameters.cs
--- generator/Parameters.cs	23 May 2002 23:43:24 -0000	1.1
+++ generator/Parameters.cs	9 Jun 2002 04:56:33 -0000
@@ -7,6 +7,7 @@
 namespace GtkSharp.Generation {=0D
=20=0D
 	using System;=0D
+	using System.IO;=0D
 	using System.Xml;=0D
=20=0D
 	public class Parameters  {=0D
@@ -83,6 +84,10 @@
 					need_sep =3D true;=0D
 				}=0D
=20=0D
+				if (p_elem.HasAttribute(&quot;pass_as&quot;)) {=0D
+					signature +=3D p_elem.GetAttribute(&quot;pass_as&quot;) + &quot; &quot;;=0D
+				}=0D
+=0D
 				signature +=3D (cs_type + &quot; &quot; + name);=0D
 				signature_types +=3D cs_type;=0D
 				call_string +=3D call_parm;=0D
@@ -91,7 +96,74 @@
 		=09=0D
 			return true;=0D
 		}=0D
-	=09=0D
+=0D
+		public void Initialize (StreamWriter sw, bool is_get)=0D
+		{=0D
+			foreach (XmlNode parm in elem.ChildNodes) {=0D
+				if (parm.Name !=3D &quot;parameter&quot;) {=0D
+					continue;=0D
+				}=0D
+=0D
+				XmlElement p_elem =3D (XmlElement) parm;=0D
+=0D
+				string type =3D SymbolTable.GetCSType(p_elem.GetAttribute (&quot;type&quot;));=0D
+				string name =3D MangleName(p_elem.GetAttribute(&quot;name&quot;));=0D
+				if (is_get) {=0D
+					sw.WriteLine (&quot;\t\t\t&quot; + type + &quot; &quot; + name + &quot;;&quot;);=0D
+				}=0D
+=0D
+				if (is_get || (p_elem.HasAttribute(&quot;pass_as&quot;) &amp;&amp; p_elem.GetAttribute (=
&quot;pass_as&quot;) =3D=3D &quot;out&quot;)) {=0D
+					sw.WriteLine(&quot;\t\t\t&quot; + name + &quot; =3D new &quot; + type + &quot;();&quot;);=20=0D
+				}=0D
+			}=0D
+		=09=0D
+		}=0D
+=0D
+		public bool IsAccessor {=0D
+			get {=0D
+				int length =3D 0;=0D
+				string pass_as;=0D
+				foreach (XmlNode parm in elem.ChildNodes) {=0D
+					if (parm.Name !=3D &quot;parameter&quot;) {=0D
+						continue;=0D
+					}=0D
+=09=0D
+					XmlElement p_elem =3D (XmlElement) parm;=0D
+					length++;=0D
+					if (length &gt; 1)=0D
+						return false;=0D
+					if (p_elem.HasAttribute(&quot;pass_as&quot;))=0D
+						pass_as =3D p_elem.GetAttribute(&quot;pass_as&quot;);=0D
+				}=0D
+=0D
+				return (length =3D=3D 1 &amp;&amp; pass_as =3D=3D &quot;out&quot;);=0D
+			}=0D
+		}=0D
+=0D
+		public string AccessorReturnType {=0D
+			get {=0D
+				foreach (XmlNode parm in elem.ChildNodes) {=0D
+					if (parm.Name !=3D &quot;parameter&quot;)=20=0D
+						continue;=0D
+					XmlElement p_elem =3D (XmlElement) parm;=0D
+					return SymbolTable.GetCSType(p_elem.GetAttribute (&quot;type&quot;));=0D
+				}=0D
+				return null;=0D
+			}=0D
+		}=0D
+=0D
+		public string AccessorName {=0D
+			get {=0D
+				foreach (XmlNode parm in elem.ChildNodes) {=0D
+					if (parm.Name !=3D &quot;parameter&quot;)=20=0D
+						continue;=0D
+					XmlElement p_elem =3D (XmlElement) parm;=0D
+					return MangleName (p_elem.GetAttribute(&quot;name&quot;));=0D
+				}=0D
+				return null;=0D
+			}=0D
+		}=0D
+=0D
 		private string MangleName(string name)=0D
 		{=0D
 			switch (name) {=0D
Index: generator/Property.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/Property.cs,v
retrieving revision 1.2
diff -u -r1.2 Property.cs
--- generator/Property.cs	5 Jun 2002 21:59:10 -0000	1.2
+++ generator/Property.cs	9 Jun 2002 04:56:33 -0000
@@ -63,6 +63,8 @@
 				return;=0D
 			} else if (SymbolTable.IsObject(c_type)) {=0D
 				v_type =3D &quot;GLib.Object&quot;;=0D
+			} else if (SymbolTable.IsBoxed (c_type)) {=0D
+				v_type =3D &quot;GLib.Boxed&quot;;=0D
 			}=0D
=20=0D
 			if (elem.HasAttribute(&quot;construct-only&quot;) &amp;&amp; !elem.HasAttribute(&quot;readable=
&quot;)) {=0D
Index: generator/StructGen.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/generator/StructGen.cs,v
retrieving revision 1.10
diff -u -r1.10 StructGen.cs
--- generator/StructGen.cs	23 May 2002 23:43:25 -0000	1.10
+++ generator/StructGen.cs	9 Jun 2002 04:56:33 -0000
@@ -87,6 +87,8 @@
 				}	=09=0D
 			}=0D
 		=09=0D
+			GenBase.AppendCustom(ns, Name, sw);=0D
+		=09=0D
 			sw.WriteLine (&quot;\t}&quot;);=0D
 			sw.WriteLine ();=0D
 			sw.WriteLine (&quot;}&quot;);=0D
Index: glue/Makefile.am
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/glue/Makefile.am,v
retrieving revision 1.1
diff -u -r1.1 Makefile.am
--- glue/Makefile.am	25 Apr 2002 09:17:54 -0000	1.1
+++ glue/Makefile.am	9 Jun 2002 04:56:33 -0000
@@ -1,9 +1,10 @@
 lib_LTLIBRARIES =3D libgtksharpglue.la
=20
-INCLUDES =3D $(GLIB_CFLAGS) -I$(top_srcdir)
+INCLUDES =3D $(GTK_CFLAGS) -I$(top_srcdir)
=20
 libgtksharpglue_la_SOURCES =3D 	\
 	value.c			\
+	textiter.c		\
 	#
=20
 libgtksharpglue.dll: $(libgtksharpglue_la_OBJECTS) libgtksharpglue.rc libg=
tksharpglue.def
Index: glue/textiter.c
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: glue/textiter.c
diff -N glue/textiter.c
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ glue/textiter.c	9 Jun 2002 04:56:33 -0000
@@ -0,0 +1,17 @@
+/* textiter.c : Glue to allocate GtkTextIters on the heap.
+ *
+ * Author: Rachel Hestilow  &lt;<A HREF="mailto:hestilow@ximian.com">hestilow@ximian.com</A>&gt;
+ *
+ * &lt;c&gt; 2002 Rachel Hestilow, Mike Kestner
+ */
+
+#include &lt;gtk/gtktextiter.h&gt;
+
+GtkTextIter*
+gtksharp_text_iter_create (void)
+{
+	GtkTextIter *iter =3D g_new0 (GtkTextIter, 1);
+	return iter;
+}
+
+
Index: gtk/TextIter.custom
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: gtk/TextIter.custom
diff -N gtk/TextIter.custom
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ gtk/TextIter.custom	9 Jun 2002 04:56:33 -0000
@@ -0,0 +1,30 @@
+// Gtk.TextIter.custom - Gtk TextIter class customizations
+//
+// Author: Rachel Hestilow &lt;<A HREF="mailto:hestilow@ximian.com">hestilow@ximian.com</A>&gt;=20
+//
+// (c) 2001 Mike Kestner, 2002 Rachel Hestilow
+//
+// This code is inserted after the automatically generated code.
+
+
+		/// &lt;summary&gt;
+		///	TextIter Constructor
+		/// &lt;/summary&gt;
+		///=20
+		/// &lt;remarks&gt;
+		///	Constructs a new TextIter.
+
+		[DllImport(&quot;gtksharpglue&quot;)]
+		static extern IntPtr gtksharp_text_iter_create();
+		public TextIter () : this (gtksharp_text_iter_create ())=20
+		{
+		}
+	=09
+		[DllImport(&quot;glib-2.0&quot;)]
+		static extern void g_free (IntPtr mem);
+
+		~TextIter ()
+		{
+			g_free (Handle);
+		}
+
Index: parser/Gtk.metadata
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: parser/Gtk.metadata
diff -N parser/Gtk.metadata
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ parser/Gtk.metadata	9 Jun 2002 04:56:33 -0000
@@ -0,0 +1,31 @@
+&lt;?xml version=3D&quot;1.0&quot;?&gt;
+&lt;metadata&gt;
+&lt;rule&gt;
+  &lt;class name=3D&quot;GtkTextBuffer&quot;&gt;
+    &lt;method&gt;GetIterAtLineOffset&lt;/method&gt;
+    &lt;method&gt;GetIterAtLineIndex&lt;/method&gt;
+    &lt;method&gt;GetIterAtOffset&lt;/method&gt;
+    &lt;method&gt;GetIterAtLine&lt;/method&gt;
+    &lt;method&gt;GetStartIter&lt;/method&gt;
+    &lt;method&gt;GetEndIter&lt;/method&gt;
+    &lt;method&gt;GetBounds&lt;/method&gt;
+    &lt;method&gt;GetIterAtMark&lt;/method&gt;
+    &lt;method&gt;GetIterAtChildAnchor&lt;/method&gt;
+    &lt;method&gt;GetSelectionBounds&lt;/method&gt;
+  &lt;/class&gt;
+  &lt;class name=3D&quot;GtkTextLayout&quot;&gt;
+    &lt;method&gt;GetIterAtLine&lt;/method&gt;
+  &lt;/class&gt;
+  &lt;class name=3D&quot;GtkTextView&quot;&gt;
+    &lt;method&gt;GetIterAtLocation&lt;/method&gt;
+    &lt;method&gt;GetLineAtY&lt;/method&gt;
+  &lt;/class&gt;
+  &lt;data&gt;
+    &lt;attribute target=3D&quot;param&quot;&gt;
+      &lt;filter level=3D&quot;type&quot;&gt;GtkTextIter*&lt;/filter&gt;
+      &lt;name&gt;pass_as&lt;/name&gt;
+      &lt;value&gt;out&lt;/value&gt;
+    &lt;/attribute&gt;
+  &lt;/data&gt;
+&lt;/rule&gt;
+&lt;/metadata&gt;
Index: parser/Metadata.pm
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: parser/Metadata.pm
diff -N parser/Metadata.pm
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ parser/Metadata.pm	9 Jun 2002 04:56:33 -0000
@@ -0,0 +1,190 @@
+#
+# Metadata.pm: Adds additional properties to a GApi tree.=20
+#
+# Author: Rachel Hestilow  &lt;<A HREF="mailto:hestilow@ximian.com">hestilow@ximian.com</A>&gt;=20
+#
+# &lt;c&gt; 2002 Rachel Hestilow
+##############################################################
+
+package Metadata;
+
+use XML::LibXML;
+
+sub new {
+	my $namespace =3D $_[1];
+	my $file =3D &quot;$namespace.metadata&quot;;
+	my $self =3D {};
+	@{$self-&gt;{rules}} =3D ();
+	$self-&gt;{metadata} =3D $namespace;
+	bless $self;
+	$self-&gt;load ($file);
+	return $self;
+}
+
+sub parseClass {
+	my ($node, $classes) =3D @_;
+	my %methods =3D ();
+	my @attrs =3D $node-&gt;attributes;
+	my $class_name =3D $attrs[0]-&gt;value;
+	${$classes}{$class_name} =3D \%methods;
+
+	for ($method_node =3D $node-&gt;firstChild; $method_node !=3D undef; $method=
_node =3D $method_node-&gt;nextSibling ()) {
+		next if $method_node-&gt;nodeName ne &quot;method&quot;;
+		$methods{$method_node-&gt;firstChild-&gt;nodeValue} =3D 1;
+	}
+}
+
+sub parseData {
+	my $node =3D $_[0];
+	my @data =3D ();
+	for ($data_node =3D $node-&gt;firstChild; $data_node !=3D undef; $data_node =
=3D $data_node-&gt;nextSibling ()) {
+		next if $data_node-&gt;nodeName ne &quot;attribute&quot;;
+		my @attrs =3D $data_node-&gt;attributes;
+		my $target =3D $attrs[0]-&gt;value;
+		my ($filter_level, $filter_value, $attr_name, $attr_value);
+		for ($attr_node =3D $data_node-&gt;firstChild; $attr_node !=3D undef; $attr=
_node =3D $attr_node-&gt;nextSibling ()) {
+			if ($attr_node-&gt;nodeName eq &quot;filter&quot;) {
+				my @filter_attrs =3D $attr_node-&gt;attributes;
+				$filter_level =3D $filter_attrs[0]-&gt;value;
+				$filter_value =3D $attr_node-&gt;firstChild-&gt;nodeValue;
+			} elsif ($attr_node-&gt;nodeName eq &quot;name&quot;) {
+				$attr_name =3D $attr_node-&gt;firstChild-&gt;nodeValue;
+			} elsif ($attr_node-&gt;nodeName eq &quot;value&quot;) {
+				$attr_value =3D $attr_node-&gt;firstChild-&gt;nodeValue;
+			}
+		}
+		my @data_attr =3D (&quot;attribute&quot;, $target, &quot;filter&quot;, $filter_level, $filte=
r_value, $attr_name, $attr_value);
+		push @data, \@data_attr;
+	}
+
+	return @data;
+}
+			=09
+sub load {
+	my ($self, $file) =3D @_;
+	my $parser =3D new XML::LibXML;
+	my $doc =3D $parser-&gt;parse_file($file);
+	my $root =3D $doc-&gt;documentElement;
+	for ($rule_node =3D $root-&gt;firstChild; $rule_node !=3D undef; $rule_node =
=3D $rule_node-&gt;nextSibling ()) {
+		next if $rule_node-&gt;nodeName ne &quot;rule&quot;;
+		my %classes =3D ();
+		my @data;
+		for ($node =3D $rule_node-&gt;firstChild; $node !=3D undef; $node =3D $node=
-&gt;nextSibling ()) {
+			if ($node-&gt;nodeName eq &quot;class&quot;) {
+				parseClass ($node, \%classes);
+			} elsif ($node-&gt;nodeName eq &quot;data&quot;) {
+				@data =3D parseData ($node);=09
+			}
+		}
+		=09
+		push @{$self-&gt;{rules}}, [\%classes, \@data];
+	}
+}
+
+sub fixupParams {
+	my ($method_node, $data_list_ref) =3D @_;
+	my ($params_node, $node);
+	for ($node =3D $method_node-&gt;firstChild; $node; $node =3D $node-&gt;nextSibl=
ing ()) {
+		if ($node-&gt;nodeName eq &quot;parameters&quot;) {
+			$params_node =3D $node;
+			last;
+		}
+	}
+	return if not $params_node;
+	for ($node =3D $params_node-&gt;firstChild; $node; $node =3D $node-&gt;nextSibl=
ing ()) {
+		my $param_type;
+		foreach $attr ($node-&gt;attributes) {
+			if ($attr-&gt;name eq &quot;type&quot;) {
+				$param_type =3D $attr-&gt;value;
+				last;
+			}
+		}
+
+		foreach $data (@$data_list_ref) {
+			if ($param_type eq $$data[4]) {
+				$node-&gt;setAttribute ($$data[5], $$data[6]);
+			}
+		}
+	}
+}
+
+sub fixupNamespace {
+	my ($self, $ns_node) =3D @_;
+	my $node;
+	foreach $rule (@{$self-&gt;{rules}}) {
+		my ($classes_ref, $data_list_ref) =3D @$rule;
+		for ($node =3D $ns_node-&gt;firstChild; $node; $node =3D $node-&gt;nextSibling=
 ()) {
+			next if $node-&gt;nodeName ne &quot;object&quot;;
+			my $class, $methods_ref, $attr;
+			foreach $attr ($node-&gt;attributes) {
+				if ($attr-&gt;name eq &quot;cname&quot;) {
+					$class =3D $attr-&gt;value;
+					last;
+				}
+			}
+
+			my %classes =3D %$classes_ref;
+			$methods_ref =3D $classes{$class};
+			next if not $methods_ref;
+
+			for ($method_node =3D $node-&gt;firstChild; $method_node; $method_node =3D=
 $method_node-&gt;nextSibling ()) {
+				next if $method_node-&gt;nodeName ne &quot;method&quot;;
+				my $method;
+				foreach $attr ($method_node-&gt;attributes) {
+					if ($attr-&gt;name eq &quot;name&quot;) {
+						$method =3D $attr-&gt;value;
+						last;
+					}
+				}
+				next if not ${$methods_ref}{$method};
+				fixupParams ($method_node, $data_list_ref);
+			}
+		}
+	}
+}
+
+sub fixup {
+	my $doc =3D $_[0];
+	my ($api_node, $ns_node);
+	my $metadata =3D undef;
+
+	$api_node =3D $doc-&gt;documentElement;
+	return if not ($api_node and $api_node-&gt;nodeName eq &quot;api&quot;);
+	for ($ns_node =3D $api_node-&gt;firstChild; $ns_node; $ns_node =3D $ns_node-=
&gt;<i>nextSibling ()) {
</I>+		next if $ns_node-&gt;nodeName ne &quot;namespace&quot;;
+		next if not ($ns_node-&gt;attributes and (scalar (@{$ns_node-&gt;attributes}))=
 + 1);
+		my @attrs =3D $ns_node-&gt;attributes;
+		my $namespace =3D $attrs[0]-&gt;value;
+		if (-f &quot;$namespace.metadata&quot;) {
+			if (not ($metadata and $metadata-&gt;{namespace} eq $namespace)) {
+				$metadata =3D new Metadata ($namespace);
+			}
+			$metadata-&gt;fixupNamespace ($ns_node);
+		}
+	}
+}
+
+sub output {
+	my $self =3D $_[0];
+	$rule_num =3D 0;
+	foreach $rule (@{$self-&gt;{rules}}) {
+		print &quot;Rule #$rule_num:\n&quot;;
+		my ($classes_ref, $data_list_ref) =3D @$rule;
+		my %classes =3D %$classes_ref;
+		my @data_list =3D @$data_list_ref;
+		foreach $class (keys (%classes)) {
+			print &quot;\tClass $class:\n&quot;;
+			foreach $method (keys %{$classes{$class}}) {
+				print &quot;\t\tMethod $method\n&quot;;
+			}
+		}
+		print &quot;\tData:\n&quot;;
+		foreach $data (@data_list) {
+			printf &quot;\t\tAdd an %s to all %s of %s %s: %s=3D%s\n&quot;,
+			       $$data[0], $$data[1], $$data[3], $$data[4], $$data[5], $$data[6]=
;
+		}
+		$rule_num++;
+	}
+}
+
+1;
Index: parser/gapi2xml.pl
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
RCS file: /cvs/public/gtk-sharp/parser/gapi2xml.pl,v
retrieving revision 1.12
diff -u -r1.12 gapi2xml.pl
--- parser/gapi2xml.pl	17 Feb 2002 20:54:54 -0000	1.12
+++ parser/gapi2xml.pl	9 Jun 2002 04:56:34 -0000
@@ -10,6 +10,7 @@
 $debug=3D1;
=20
 use XML::LibXML;
+use Metadata;
=20
 if (!$ARGV[0]) {
 	die &quot;Usage: gapi_pp.pl &lt;srcdir&gt; | gapi2xml.pl &lt;namespace&gt; &lt;outfile&gt;\n&quot;;
@@ -96,7 +97,9 @@
 		}
 		$boxdef =3D~ s/\n\s*//g;
 		$boxdef =3D~ /\(\&quot;(\w+)\&quot;/;
-		$boxdefs{$1} =3D $boxdef;
+		my $boxtype =3D $1;
+		$boxtype =3D~ s/($ns)Type(\w+)/$ns$2/;
+		$boxdefs{$boxtype} =3D $boxdef;
 	} elsif ($line =3D~ /^(const|G_CONST_RETURN)?\s*\w+\s*\**\s*(\w+)\s*\(/) =
{
 		$fname =3D $2;
 		$fdef =3D &quot;&quot;;
@@ -298,6 +301,10 @@
 	addFieldElems($struct_el, split(/;/, $1));
 	addFuncElems($struct_el, $key);
 }
+##############################################################
+# Add metadata
+##############################################################
+Metadata::fixup $doc;
=20
 ##############################################################
 # Output the tree

--=-aVpYgBEomaDJ/XfCSZTc--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000086.html">[Gtk-sharp-list] Bugs - past, present, and future
</A></li>
	<LI> Next message: <A HREF="000088.html">[Gtk-sharp-list] PATCH: TextIter usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87">[ date ]</a>
              <a href="thread.html#87">[ thread ]</a>
              <a href="subject.html#87">[ subject ]</a>
              <a href="author.html#87">[ author ]</a>
         </LI>
       </UL>
</body></html>
