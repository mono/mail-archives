<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Access Violations with Mono.Cairo on Windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Access%20Violations%20with%20Mono.Cairo%20on%20Windows&In-Reply-To=aec34c770912301246p3d8c3819g40876e4b107a57f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010020.html">
   <LINK REL="Next"  HREF="010022.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Access Violations with Mono.Cairo on Windows</H1>
    <B>Andy Selvig</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Access%20Violations%20with%20Mono.Cairo%20on%20Windows&In-Reply-To=aec34c770912301246p3d8c3819g40876e4b107a57f%40mail.gmail.com"
       TITLE="[Gtk-sharp-list] Access Violations with Mono.Cairo on Windows">ajselvig at gmail.com
       </A><BR>
    <I>Wed Dec 30 16:36:44 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="010020.html">[Gtk-sharp-list] Access Violations with Mono.Cairo on Windows
</A></li>
        <LI>Next message: <A HREF="010022.html">[Gtk-sharp-list] Few questions about how to use TreeView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10021">[ date ]</a>
              <a href="thread.html#10021">[ thread ]</a>
              <a href="subject.html#10021">[ subject ]</a>
              <a href="author.html#10021">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> You should probably use a GCHandle to pin the byte[]:
</I>&gt;<i> var gch = new GCHandle (imageData, GCHandleType.Pinned);
</I>&gt;<i> and make sure you gch.Free() when you dispose the surface.
</I>
Thanks, Michael. That was it. Just a small syntax note for others that might
be reading this, the gc handle is created with:

gch = GCHandle.Alloc(imageData, GCHandleType.Pinned);

But, yeah, that fixed it. Works great now.

&gt;<i> Alternatively, you could modify Mono.Cairo to:
</I>&gt;<i> * use Marshal.AllocHGlobal to malloc some unmanaged memory, and get an
</I>&gt;<i> IntPtr to it
</I>&gt;<i> * use Marshal.Copy to mcpy the byte[] to the new memory
</I>&gt;<i> * change the p/invoke signature to use a IntPtr instead of a byte[]
</I>&gt;<i> * use Marshal.FreeHGlobal to free the memory when the surface is disposed
</I>
I guess I don't have any fundamental problems with modifying Mono.Cairo, but
it seems like it's more likely that there's something wrong with me setup. I
can't be the only one who is using ImageSurfaces on Windows. There must be
an ImageSurface in MonoDevelop somewhere, right?

Plus, I'm still troubled by the fact that the API is different for my
Windows version of Mono.Cairo while the versions seem to be the same. I'll
have to look further into that.

But, yes, if this is really what you have to do for image surfaces in
Mono.Cairo on Windows, then it's a bug and should be fixed IN Mono.Cairo. It
is unreasonable to expect users of a managed library (even if it's just a
wrapper to an unmanaged one) to have to manage their own memory.

If no one else out there can confirm that I'm doing something wrong (using
an old version of the library, have some sort of version mismatch between
the managed and unmanaged dll's, etc) then I'll file a bug.

Thanks again.

On Wed, Dec 30, 2009 at 2:46 PM, Michael Hutchinson &lt;
<A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">m.j.hutchinson at gmail.com</A>&gt; wrote:

&gt;<i> On Wed, Dec 30, 2009 at 9:21 AM, Andy Selvig &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">ajselvig at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; It is marked as obsolete (at least it is in whatever version I'm using on
</I>&gt;<i> &gt; Linux), but from the code you linked to it simply calls the valid
</I>&gt;<i> &gt; constructor anyway, so it should do the exact same thing.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Plus, it does work initially. It takes a couple seconds to fail, but
</I>&gt;<i> before
</I>&gt;<i> &gt; that, it renders exactly the way it should.
</I>&gt;<i>
</I>&gt;<i> Ah, I missed the base call.
</I>&gt;<i>
</I>&gt;<i> OK, so the likely problem here is that the underlying native code of
</I>&gt;<i> the imagesurface expects to keep a reference to the  byte[] that's
</I>&gt;<i> passed to it. The delay implies that it's marshalled as a pointer
</I>&gt;<i> directly into the managed byte[], and .NET's compacting GC is moving
</I>&gt;<i> the byte[] afterwards. Things that you pass into p/invokes are pinned
</I>&gt;<i> for the duration of the call, but not afterwards.
</I>&gt;<i>
</I>&gt;<i> You should probably use a GCHandle to pin the byte[]:
</I>&gt;<i> var gch = new GCHandle (imageData, GCHandleType.Pinned);
</I>&gt;<i> and make sure you gch.Free() when you dispose the surface.
</I>&gt;<i>
</I>&gt;<i> Alternatively, you could modify Mono.Cairo to:
</I>&gt;<i> * use Marshal.AllocHGlobal to malloc some unmanaged memory, and get an
</I>&gt;<i> IntPtr to it
</I>&gt;<i> * use Marshal.Copy to mcpy the byte[] to the new memory
</I>&gt;<i> * change the p/invoke signature to use a IntPtr instead of a byte[]
</I>&gt;<i> * use Marshal.FreeHGlobal to free the memory when the surface is disposed
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Michael Hutchinson
</I>&gt;<i> <A HREF="http://mjhutchinson.com">http://mjhutchinson.com</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/gtk-sharp-list/attachments/20091230/d1e70a4d/attachment.html">http://lists.ximian.com/pipermail/gtk-sharp-list/attachments/20091230/d1e70a4d/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010020.html">[Gtk-sharp-list] Access Violations with Mono.Cairo on Windows
</A></li>
	<LI>Next message: <A HREF="010022.html">[Gtk-sharp-list] Few questions about how to use TreeView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10021">[ date ]</a>
              <a href="thread.html#10021">[ thread ]</a>
              <a href="subject.html#10021">[ subject ]</a>
              <a href="author.html#10021">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
