<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Thread-safe GUI update
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Thread-safe%20GUI%20update&In-Reply-To=4602E7B3.4040600%40ntlworld.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007929.html">
   <LINK REL="Next"  HREF="007933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Thread-safe GUI update</H1>
    <B>Michael Hutchinson</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Thread-safe%20GUI%20update&In-Reply-To=4602E7B3.4040600%40ntlworld.com"
       TITLE="[Gtk-sharp-list] Thread-safe GUI update">m.j.hutchinson at gmail.com
       </A><BR>
    <I>Thu Mar 22 17:36:02 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="007929.html">[Gtk-sharp-list] Thread-safe GUI update
</A></li>
        <LI>Next message: <A HREF="007933.html">[Gtk-sharp-list] Thread-safe GUI update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7930">[ date ]</a>
              <a href="thread.html#7930">[ thread ]</a>
              <a href="subject.html#7930">[ subject ]</a>
              <a href="author.html#7930">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/22/07, Leon Stringer &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">leon.stringer at ntlworld.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm updating a list (TreeView with TreeStore) from a thread when
</I>&gt;<i> processing some items, something like:
</I>&gt;<i>
</I>&gt;<i> while (Messages.Count &gt; 0) {
</I>&gt;<i>         msg = (Message) Messages.Dequeue();
</I>&gt;<i>         send(msg);
</I>&gt;<i>
</I>&gt;<i>          Gtk.Application.Invoke(delegate {
</I>&gt;<i>                 treeStore.AppendAvalues(msg.To, msg.Text);
</I>&gt;<i>         });
</I>&gt;<i>
</I>&gt;<i>         Thread.Sleep(0);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> There's another thread adding messages to the message queue.
</I>&gt;<i>
</I>&gt;<i> The problem is that sometimes the Gtk.Application.Invoke() is executed
</I>&gt;<i> after I've dequeued the next message so the wrong item is added to the
</I>&gt;<i> list. I could stick a greater value in Thread.Sleep() but this would be
</I>&gt;<i> a kludge. Is there any thread-safe way to do this?
</I>
The problem lies in using an anonymous delegate. The compiler compiles
the anonymous delegate to a private method, which gets access to
variables in the &quot;parent&quot; method's scope via a private shared object
in the parent class. Your code is changing the shared variables before
Gtk.Application.Invoke gets fired.

However, it may be possible to do it with Gtk.Application.Invoke
(object sender, System.EventArgs args, System.EventHandler d).

Alternatively you could create a queue object at the class level and
put the messages in that. You'd need to lock it (on the SyncRoot
property) when you add and remove objects, or you could use the build
in sychronisation wrapper to make it thread safe:
<A HREF="http://msdn2.microsoft.com/en-gb/library/system.collections.queue.issynchronized.aspx">http://msdn2.microsoft.com/en-gb/library/system.collections.queue.issynchronized.aspx</A>

-- 
Michael Hutchinson
<A HREF="http://mjhutchinson.com">http://mjhutchinson.com</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007929.html">[Gtk-sharp-list] Thread-safe GUI update
</A></li>
	<LI>Next message: <A HREF="007933.html">[Gtk-sharp-list] Thread-safe GUI update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7930">[ date ]</a>
              <a href="thread.html#7930">[ thread ]</a>
              <a href="subject.html#7930">[ subject ]</a>
              <a href="author.html#7930">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
