<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] ColorSelection fixes/custom
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gnome%40fonicmonkey.net">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001542.html">
   <LINK REL="Next"  HREF="001529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] ColorSelection fixes/custom
   </H1>
    <B>Lee Mallabone
    </B> 
    <A HREF="mailto:gnome%40fonicmonkey.net"
       TITLE="[Gtk-sharp-list] ColorSelection fixes/custom">gnome@fonicmonkey.net
       </A><BR>
    <I>26 Mar 2003 09:15:52 +0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="001542.html">[Gtk-sharp-list] [Patch, etc] minimal pkgconfig support
</A></li>
        <LI> Next message: <A HREF="001529.html">[Gtk-sharp-list] Windows Gtk# Appearance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1520">[ date ]</a>
              <a href="thread.html#1520">[ thread ]</a>
              <a href="subject.html#1520">[ subject ]</a>
              <a href="author.html#1520">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-dH3EyKFLbKazoFUb5ojY
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Hi all,

As report in bug #38672, a couple of methods in ColorSelection are
broken.

I've tried to fix them with the attached patch - PaletteToString now
work as expected.

However, PaletteFromString crashes with a NullReferenceException. I
assume this is something to do with the way I've wrapped the C method
signature:

gboolean    gtk_color_selection_palette_from_string
                                     (const gchar *str,
                                      GdkColor **colors,
                                      gint *n_colors);
as this:

[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
static extern bool gtk_color_selection_palette_from_string(string str, out Gdk.Color[] colors, out int n_colors);

I've attached my new ColorSelection.custom file, and a sample that crashes on the PaletteFromString method... Does anyone have any insight?

I assume it's crashing because the output 'colors' can not be allocated by the C library. However, I'm unsure how to fix it further, so any help would be appreciated.

I've also attached the metadata changes needed to suppress the default generation for these methods.

Regards,

Lee.


--=-dH3EyKFLbKazoFUb5ojY
Content-Disposition: attachment; filename=ColorSelection.custom
Content-Type: text/plain; name=ColorSelection.custom; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

// Gtk.ColorSelection.custom - customizations and corrections for ColorSelection
// Author: Lee Mallabone &lt;<A HREF="mailto:gnome@fonicmonkey.net">gnome@fonicmonkey.net</A>&gt;

		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern string gtk_color_selection_palette_to_string(Gdk.Color[] colors, int n_colors);

		/// &lt;summary&gt; PaletteToString Method &lt;/summary&gt;
		public static string PaletteToString(Gdk.Color[] colors) {
			int n_colors = colors.Length;
			string raw_ret = gtk_color_selection_palette_to_string(colors, n_colors);
			string ret = raw_ret;
			return ret;
		}
		
		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern bool gtk_color_selection_palette_from_string(string str, out Gdk.Color[] colors, out int n_colors);

		/// &lt;summary&gt; PaletteFromString Method &lt;/summary&gt;
		public static Gdk.Color[] PaletteFromString(string str) {
			Gdk.Color[] parsedColors;
			int n_colors;
			bool raw_ret = gtk_color_selection_palette_from_string(str, out parsedColors, out n_colors);
			
			// If things failed, return silently
			if (!raw_ret)
			{
				return null;
			}
			return parsedColors;
		}

--=-dH3EyKFLbKazoFUb5ojY
Content-Disposition: attachment; filename=ColorSample.cs
Content-Type: text/plain; name=ColorSample.cs; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

using Gtk;
using Gdk;
using System;

public class ColorSample {
	public static void Main()
	{
		Gtk.Application.Init();
		
		// Setup simple colors
		Gdk.Color black = new Gdk.Color(0x00, 0x00, 0x00);
		Gdk.Color white = new Gdk.Color(0xFF, 0xFF, 0xFF);
		Gdk.Color[] colors = new Gdk.Color[] { black, white };
		
		Console.WriteLine(&quot;------ PaletteToString test ------&quot;);
		
		string parsedPalette = ColorSelection.PaletteToString(colors);
		Console.WriteLine(&quot;Got palette as: &quot; + parsedPalette);

		Console.WriteLine(&quot;------ PaletteFromString test ------&quot;);
		Gdk.Color[] parsedColors = ColorSelection.PaletteFromString(parsedPalette);
		if (parsedColors == null)
		{
			Console.WriteLine(&quot;Parsed palette array is null&quot;);
		}
		else
		{
			Console.WriteLine(&quot;Parsed palette array is: &quot; + parsedColors);
		}
	}
}

--=-dH3EyKFLbKazoFUb5ojY
Content-Disposition: attachment; filename=colorsel.diff
Content-Type: text/x-patch; name=colorsel.diff; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

Index: Gtk.metadata
===================================================================
RCS file: /cvs/public/gtk-sharp/sources/Gtk.metadata,v
retrieving revision 1.46
diff -u -r1.46 Gtk.metadata
--- Gtk.metadata	25 Mar 2003 19:05:40 -0000	1.46
+++ Gtk.metadata	26 Mar 2003 09:22:11 -0000
@@ -1508,6 +1508,18 @@
   &lt;/data&gt;
 &lt;/rule&gt;
 &lt;rule&gt;
+  &lt;class name=&quot;GtkColorSelection&quot;&gt;
+    &lt;method&gt;PaletteToString&lt;/method&gt;
+	&lt;method&gt;PaletteFromString&lt;/method&gt;
+  &lt;/class&gt;
+  &lt;data&gt;
+    &lt;attribute target=&quot;method&quot;&gt;
+	  &lt;name&gt;hidden&lt;/name&gt;
+	  &lt;value&gt;1&lt;/value&gt;
+	&lt;/attribute&gt;
+  &lt;/data&gt;
+&lt;/rule&gt;
+&lt;rule&gt;
   &lt;class name=&quot;GtkWidget&quot;&gt;
     &lt;method&gt;ListAccelClosures&lt;/method&gt;
   &lt;/class&gt;


--=-dH3EyKFLbKazoFUb5ojY--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001542.html">[Gtk-sharp-list] [Patch, etc] minimal pkgconfig support
</A></li>
	<LI> Next message: <A HREF="001529.html">[Gtk-sharp-list] Windows Gtk# Appearance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1520">[ date ]</a>
              <a href="thread.html#1520">[ thread ]</a>
              <a href="subject.html#1520">[ subject ]</a>
              <a href="author.html#1520">[ author ]</a>
         </LI>
       </UL>
</body></html>
