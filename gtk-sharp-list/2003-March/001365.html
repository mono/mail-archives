<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Returning Gdk.Events
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jonpryor%40vt.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001361.html">
   <LINK REL="Next"  HREF="001366.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Returning Gdk.Events
   </H1>
    <B>Jonathan Pryor
    </B> 
    <A HREF="mailto:jonpryor%40vt.edu"
       TITLE="[Gtk-sharp-list] Returning Gdk.Events">jonpryor@vt.edu
       </A><BR>
    <I>11 Mar 2003 15:25:35 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001361.html">[Gtk-sharp-list] Returning Gdk.Events
</A></li>
        <LI> Next message: <A HREF="001366.html">[Gtk-sharp-list] Returning Gdk.Events
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1365">[ date ]</a>
              <a href="thread.html#1365">[ thread ]</a>
              <a href="subject.html#1365">[ subject ]</a>
              <a href="author.html#1365">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-YXJwgzpvJSyoaDths0by
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

It sounds like the problem is that the GTK+ API is using unions.  If
that's the underlying problem, then why don't we just use unions in C#? 
It's still possible, though it uses a syntax only a mother could love
(the StructLayout and FieldOffset attributes).

See the attached file for an example.

The basic idea is to have an internal class/struct which acts as a union
of all supported GTK+ event types.  The Gdk.Event class then holds an
instance of the union and exposes properties to get at (1) the actual
type (GdkEventType) and (2) the event information held in the union.

In the attached file I throw exceptions if an illegal event is
referenced, but that might not be a good idea.  It's just a demo,
anyway...

The benefit to doing this is that we would avoid boxing/unboxing
penalties.  Alas, we lose the ability to use &quot;is&quot; on the returned type
for a EventButton vs. EventScroll...

 - Jon

On Tue, 2003-03-11 at 14:12, Miguel de Icaza wrote:
&gt;<i> Hello!
</I>&gt;<i> 
</I>&gt;<i> &gt; My suggested solution is to use something like:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;  		public static Gdk.Event CurrrentEvent {
</I>&gt;<i> &gt;  			IntPtr handle = gtk_get_current_event ();
</I>&gt;<i> &gt; 			GdkEventType type;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 			type = (GdkEventType)Marshal.Read32 (handle);
</I>&gt;<i> &gt; 			switch (type) {
</I>&gt;<i> &gt; 			case GdkEventType.Expose:
</I>&gt;<i> &gt; 				return (Gdk.Event)Marshal.PtrToStructure (handle, typeof (Gdk.EventExpose));
</I>&gt;<i> &gt; 			case GdkEventType.ButtonPress:
</I>&gt;<i> &gt; 				return (Gdk.Event)Marshal.PtrToStructure (handle, typeof (Gdk.ButtonPress));
</I>&gt;<i> &gt; 			...
</I>&gt;<i> &gt; 			}
</I>&gt;<i> &gt;  		}
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Modulo some small details, it should work nicely.
</I>&gt;<i> 
</I>&gt;<i> There is only one problem here: Gdk.Event is a class, and the various
</I>&gt;<i> Gdk.EventXXXX are structures that do not share a common base class.
</I>&gt;<i> 
</I>&gt;<i> I could change the signature to return an `object' instead of a
</I>&gt;<i> Gdk.Event, and it would be up to the user to do an `is' compare on the
</I>&gt;<i> result.
</I>&gt;<i> 
</I>&gt;<i> Miguel
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Gtk-sharp-list maillist  -  <A HREF="mailto:Gtk-sharp-list@lists.ximian.com">Gtk-sharp-list@lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">http://lists.ximian.com/mailman/listinfo/gtk-sharp-list</A>
</I>
--=-YXJwgzpvJSyoaDths0by
Content-Disposition: attachment; filename=union.cs
Content-Type: text/plain; name=union.cs; charset=UTF-8
Content-Transfer-Encoding: 7bit

// Faking Unions in C#

using System;
using System.Runtime.InteropServices;

public enum EventTypes {Foo, Bar}

public struct FooEvent {public int n;}
public struct BarEvent {public long m;}

[StructLayout(LayoutKind.Explicit)]
internal struct EventInfo {
  [FieldOffset(0)] internal FooEvent f;
  [FieldOffset(0)] internal BarEvent b;
}

public class Event {
  private EventTypes type;
  public EventTypes EventType {
    get {return type;}
  }

  private EventInfo _event;

  public Event (FooEvent f) {
    _event.f = f;
    type = EventTypes.Foo;
  }

  public Event (BarEvent b) {
    _event.b = b;
    type = EventTypes.Bar;
  }

  public FooEvent FooEvent {
    get {
      if (type != EventTypes.Foo)
        throw new Exception (&quot;invalid type&quot;);
      return _event.f;
    }
  }

  public BarEvent BarEvent {
    get {
      if (type != EventTypes.Bar)
        throw new Exception (&quot;invalid type&quot;);
      return _event.b;
    }
  }
}

class R {
  public static void Main () {
    FooEvent f;
    f.n = 42;
    Event e = new Event (f);
    Console.WriteLine (&quot;valid use: {0}&quot;, e.FooEvent);
    Console.WriteLine (&quot;invalid use: {0}&quot;, e.BarEvent);
  }
}


--=-YXJwgzpvJSyoaDths0by--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001361.html">[Gtk-sharp-list] Returning Gdk.Events
</A></li>
	<LI> Next message: <A HREF="001366.html">[Gtk-sharp-list] Returning Gdk.Events
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1365">[ date ]</a>
              <a href="thread.html#1365">[ thread ]</a>
              <a href="subject.html#1365">[ subject ]</a>
              <a href="author.html#1365">[ author ]</a>
         </LI>
       </UL>
</body></html>
