<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> SV: [Gtk-sharp-list] IDisposable
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:steinar.herland%40gecko.no">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000289.html">
   <LINK REL="Next"  HREF="000297.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>SV: [Gtk-sharp-list] IDisposable
   </H1>
    <B>Steinar Herland
    </B> 
    <A HREF="mailto:steinar.herland%40gecko.no"
       TITLE="SV: [Gtk-sharp-list] IDisposable">steinar.herland@gecko.no
       </A><BR>
    <I>Wed, 4 Sep 2002 20:14:11 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="000289.html">[Gtk-sharp-list] IDisposable
</A></li>
        <LI> Next message: <A HREF="000297.html">SV: [Gtk-sharp-list] IDisposable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#296">[ date ]</a>
              <a href="thread.html#296">[ thread ]</a>
              <a href="subject.html#296">[ subject ]</a>
              <a href="author.html#296">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In short you are missing the call to GC.SuppressFinalize(this);

Copied from (watch out for line-breaks):
<A HREF="http://msdn.microsoft.com/library/en-us/cpguide/html/cpconimplementingdi">http://msdn.microsoft.com/library/en-us/cpguide/html/cpconimplementingdi</A>
sposemethod.asp?frame=true


[C#]
// Design pattern for the base class.
// By implementing IDisposable, you are announcing that instances
// of this type allocate scarce resources.
public class BaseResource: IDisposable
{
   // Pointer to an external unmanaged resource.
   private IntPtr handle;
   // Other managed resource this class uses.
   private Component Components;
   // Track whether Dispose has been called.
   private bool disposed = false;

   // Constructor for the BaseResource Object.
   public BaseResource()
   {
      // Insert appropriate constructor code here.
   }

   // Implement Idisposable.
   // Do not make this method virtual.
   // A derived class should not be able to override this method.
   public void Dispose()
   {
      Dispose(true);
      // Take yourself off of the Finalization queue 
      // to prevent finalization code for this object
      // from executing a second time.
      GC.SuppressFinalize(this);
   }

   // Dispose(bool disposing) executes in two distinct scenarios.
   // If disposing equals true, the method has been called directly
   // or indirectly by a user's code. Managed and unmanaged resources
   // can be disposed.
   // If disposing equals false, the method has been called by the 
   // runtime from inside the finalizer and you should not reference 
   // other objects. Only unmanaged resources can be disposed.
   protected virtual void Dispose(bool disposing)
   {
      // Check to see if Dispose has already been called.
      if(!this.disposed)
      {
         // If disposing equals true, dispose all managed 
         // and unmanaged resources.
         if(disposing)
         {
            // Dispose managed resources.
            Components.Dispose();
         }
         // Release unmanaged resources. If disposing is false, 
         // only the following code is executed.
         CloseHandle(handle);
         handle = IntPtr.Zero;
         // Note that this is not thread safe.
         // Another thread could start disposing the object
         // after the managed resources are disposed,
         // but before the disposed flag is set to true.
      }
      disposed = true;         
   }

   // Use C# destructor syntax for finalization code.
   // This destructor will run only if the Dispose method 
   // does not get called.
   // It gives your base class the opportunity to finalize.
   // Do not provide destructors in types derived from this class.
   ~BaseResource()      
   {
      // Do not re-create Dispose clean-up code here.
      // Calling Dispose(false)is optimal in terms of
      // readability and maintainability.
      Dispose(false);
   }

   // Allow your Dispose method to be called multiple times,
   // but throw an exception if the object has been disposed.
   // Whenever you do something with this class, 
   // check to see if it has been disposed.
   public void DoSomething()
   {
      if(this.disposed)
      {
         throw new ObjectDisposedException();
      }
   }
}

-----Opprinnelig melding-----
Fra: adam treat [mailto:<A HREF="mailto:manyoso@yahoo.com">manyoso@yahoo.com</A>] 
Sendt: 4. september 2002 19:51
Til: Miguel de Icaza
Kopi: Mike Kestner; <A HREF="mailto:gtk-sharp-list@ximian.com">gtk-sharp-list@ximian.com</A>
Emne: Re: [Gtk-sharp-list] IDisposable

Ok, we tried to have the Dispose method unregister the objects in the
hash, but there was a
problem with Monitor locking and the GC:

  ~Pixbuf ()
  {
    Dispose ();
  }

  Dispose ()
  {
    UnregisterObject ();
  }

This should work, but when the program thread tries to access the hash
for introspection and the
GC also tries to access the hash, the program freezes, regardless
whether it is lock()ed in both
threads.

--- Miguel de Icaza &lt;<A HREF="mailto:miguel@ximian.com">miguel@ximian.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> &gt; Right, but Dispose will never be called if the object is in the hash
</I>;-)
&gt;<i> 
</I>&gt;<i> Dispose is called by users of IDisposable, manually.
</I>&gt;<i> 
</I>&gt;<i> So I do things like:
</I>&gt;<i> 
</I>&gt;<i> 	Pixbuf p = new Pixbuf (&quot;a.png&quot;);
</I>&gt;<i> 	p.RenderToDrawable (...);
</I>&gt;<i> 	p.Dispose ();
</I>&gt;<i> 
</I>&gt;<i> You are thinking about ~Pixbuf () which is indeed never called if you
</I>&gt;<i> are not stored in a WeakReference
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Miguel
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Gtk-sharp-list maillist  -  <A HREF="mailto:Gtk-sharp-list@ximian.com">Gtk-sharp-list@ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">http://lists.ximian.com/mailman/listinfo/gtk-sharp-list</A>
</I>

__________________________________________________
Do You Yahoo!?
Yahoo! Finance - Get real-time stock quotes
<A HREF="http://finance.yahoo.com">http://finance.yahoo.com</A>

_______________________________________________
Gtk-sharp-list maillist  -  <A HREF="mailto:Gtk-sharp-list@ximian.com">Gtk-sharp-list@ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">http://lists.ximian.com/mailman/listinfo/gtk-sharp-list</A>


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000289.html">[Gtk-sharp-list] IDisposable
</A></li>
	<LI> Next message: <A HREF="000297.html">SV: [Gtk-sharp-list] IDisposable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#296">[ date ]</a>
              <a href="thread.html#296">[ thread ]</a>
              <a href="subject.html#296">[ subject ]</a>
              <a href="author.html#296">[ author ]</a>
         </LI>
       </UL>
</body></html>
