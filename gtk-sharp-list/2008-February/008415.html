<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Handling errors when generating binding code for	asynchronous APIs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Handling%20errors%20when%20generating%20binding%20code%20for%0A%09asynchronous%20APIs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008432.html">
   <LINK REL="Next"  HREF="008416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Handling errors when generating binding code for	asynchronous APIs</H1>
    <B>Philip Van Hoof</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Handling%20errors%20when%20generating%20binding%20code%20for%0A%09asynchronous%20APIs&In-Reply-To="
       TITLE="[Gtk-sharp-list] Handling errors when generating binding code for	asynchronous APIs">spam at pvanhoof.be
       </A><BR>
    <I>Sun Feb 10 09:27:51 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008432.html">[Gtk-sharp-list] Help, textview
</A></li>
        <LI>Next message: <A HREF="008416.html">[Gtk-sharp-list] Handling errors when generating binding	code	for asynchronous APIs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8415">[ date ]</a>
              <a href="thread.html#8415">[ thread ]</a>
              <a href="subject.html#8415">[ subject ]</a>
              <a href="author.html#8415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi there,

I'm trying to make GtkSharp's GAPI generate the typical asynchronous
GObject style C API to something that looks a bit like the Asynchronous
Pattern often used in .NET.

My plan is not to achieve an exact version of the Asynchronous pattern,
but nonetheless something workable.

Some pointers:
<A HREF="http://msdn2.microsoft.com/en-us/library/wewwczdw.aspx">http://msdn2.microsoft.com/en-us/library/wewwczdw.aspx</A>
<A HREF="http://msdn2.microsoft.com/en-us/library/aa719595(VS.71">http://msdn2.microsoft.com/en-us/library/aa719595(VS.71</A>).aspx

Versus, for example, this one:
<A HREF="http://tinymail.org/API/libtinymail-1.0/libtinymail-tny-folder.html#tny-folder-get-msg-async">http://tinymail.org/API/libtinymail-1.0/libtinymail-tny-folder.html#tny-folder-get-msg-async</A>
<A HREF="http://tinymail.org/API/libtinymail-1.0/libtinymail-tny-shared.html#TnyGetMsgCallback">http://tinymail.org/API/libtinymail-1.0/libtinymail-tny-shared.html#TnyGetMsgCallback</A>

It's actually awesome about GtkSharp's GAPI, but not surprisingly did
GAPI do a splendid job already. There's however one big problem:

The GError based error being passed to the callback (which in C is a
function pointer typedeffed as TnyGetMsgCallback) is not being converted
to an Exception type.

My goal is to wrap the &quot;IntPtr err&quot; (which is the GError pointer in C)
with a factory's Create method that will create me the right managed
exception:

public class Tny.ExceptionFactory
{
	static Tny.TException Create (IntPtr gerror) {
		// Pseudo, to get the type I'll indeed need to make
		// a small piece of glue code in C ...
		if (gerror-&gt;type == TNY_ERROR_THIS)
			return new Tny.ThisException (gerror);
		if (gerror-&gt;type == TNY_ERROR_THAT)
			return new Tny.ThatException (gerror);
		...
	}
}

That way can my application developer use the error being reported in
the callback using his normal exception handling methods.

For example:

- private void GetMsgCallBack (Tny.Folder folder, bool cancel, Tny.Msg msg, IntPtr err)
+ private void GetMsgCallBack (Tny.Folder folder, bool cancel, Tny.Msg msg, Tny.TException err)
{
-	if (err != IntPtr.Zero) {
-		Exception ex = new Tny.TException (err);
-		Console.WriteLine (ex.Message);
+	if (err != null)
+		throw err; // Or do whatever with Exceptions
	} else {
		if (msg != null &amp;&amp; !cancel)
			this.msg_view.Msg = msg;
	}
}

Note that throwing it is not necessarily what the application developer
will want to do with the exception. In that callback he'll typically
want to show an error dialog to the user with the err.Message displayed.

To achieve this, after doing some analysis on Gapi's generator, this is
my conclusion:

Parameter needs a new property Wrapper that looks a lot like its Scope parameter (gets it from the XML file)
Signature::ToString() needs to recognise parameters that are to be wrapped (change the type)
CallbackGen::Generate(GenerationInfo) needs to be verified that sig.ToString() does the right thing
CallbackGen::GenWrapper(GenerationInfo) at line 227 needs to wrap the parameter with p.Wrapper


## This

&lt;callback name=&quot;FolderCallback&quot; cname=&quot;TnyFolderCallback&quot;&gt;
  &lt;return-type type=&quot;void&quot; /&gt;
  &lt;parameters&gt;
    &lt;parameter type=&quot;TnyFolder*&quot; name=&quot;self&quot; /&gt;
    &lt;parameter type=&quot;gboolean&quot; name=&quot;cancelled&quot; /&gt;
    &lt;parameter type=&quot;GError*&quot; name=&quot;err&quot; /&gt;
    &lt;parameter type=&quot;gpointer&quot; name=&quot;user_data&quot; /&gt;
  &lt;/parameters&gt;
&lt;/callback&gt;


## Would become

&lt;callback name=&quot;FolderCallback&quot; cname=&quot;TnyFolderCallback&quot;&gt;
  &lt;return-type type=&quot;void&quot; /&gt;
  &lt;parameters&gt;
    &lt;parameter type=&quot;TnyFolder*&quot; name=&quot;self&quot; /&gt;
    &lt;parameter type=&quot;gboolean&quot; name=&quot;cancelled&quot; /&gt;
    &lt;parameter type=&quot;GError*&quot; name=&quot;err&quot; wrapper_type=&quot;Tny.TException&quot; wrapper=&quot;Tny.ExceptionFactory.Create ({0})&quot; /&gt;
    &lt;parameter type=&quot;gpointer&quot; name=&quot;user_data&quot; /&gt;
  &lt;/parameters&gt;
&lt;/callback&gt;


## This

namespace Tny {

	using System;

	public delegate void FolderCallback(Tny.Folder self, bool cancelled, IntPtr err);

}


## Would become (err's type comes from the XML above)

namespace Tny {

	using System;

	public delegate void FolderCallback(Tny.Folder self, bool cancelled, Tny.TException err);

}

## This

internal class FolderCallbackWrapper {
	public void NativeCallback (IntPtr self, bool cancelled, IntPtr err, IntPtr user_data)
	{
		try {
			Tny.Folder _arg0 = Tny.FolderAdapter.GetObject (self, false);
			bool _arg1 = cancelled;
			IntPtr _arg2 = err;
			managed ( _arg0,  _arg1,  _arg2);
			if (release_on_call)
				gch.Free ();
		} catch (Exception e) {
			GLib.ExceptionManager.RaiseUnhandledException (e, false);
		}
	}
	...
}


## Would become (arg2 wrap comes from the XML above)

internal class FolderCallbackWrapper {
	public void NativeCallback (IntPtr self, bool cancelled, IntPtr err, IntPtr user_data)
	{
		try {
			Tny.Folder _arg0 = Tny.FolderAdapter.GetObject (self, false);
			bool _arg1 = cancelled;
			IntPtr _arg2 = err;
			managed ( _arg0,  _arg1,  Tny.ExceptionFactory.Create (_arg2));
			if (release_on_call)
				gch.Free ();
		} catch (Exception e) {
			GLib.ExceptionManager.RaiseUnhandledException (e, false);
		}
	}
	...
}


-- 
Philip Van Hoof, freelance software developer
home: me at pvanhoof dot be 
gnome: pvanhoof at gnome dot org 
<A HREF="http://pvanhoof.be/blog">http://pvanhoof.be/blog</A>
<A HREF="http://codeminded.be">http://codeminded.be</A>

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008432.html">[Gtk-sharp-list] Help, textview
</A></li>
	<LI>Next message: <A HREF="008416.html">[Gtk-sharp-list] Handling errors when generating binding	code	for asynchronous APIs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8415">[ date ]</a>
              <a href="thread.html#8415">[ thread ]</a>
              <a href="subject.html#8415">[ subject ]</a>
              <a href="author.html#8415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
