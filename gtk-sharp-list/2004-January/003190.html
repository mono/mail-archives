<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Re: ButtonPressEvent in 0.15
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:ecmel%40ercansoy.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003188.html">
   <LINK REL="Next"  HREF="003192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Re: ButtonPressEvent in 0.15
   </H1>
    <B>Ecmel Ercan
    </B> 
    <A HREF="mailto:ecmel%40ercansoy.com"
       TITLE="[Gtk-sharp-list] Re: ButtonPressEvent in 0.15">ecmel@ercansoy.com
       </A><BR>
    <I>Fri, 16 Jan 2004 11:07:30 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="003188.html">[Gtk-sharp-list] ButtonPressEvent in 0.15
</A></li>
        <LI> Next message: <A HREF="003192.html">[Gtk-sharp-list] Re: ButtonPressEvent in 0.15
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3190">[ date ]</a>
              <a href="thread.html#3190">[ thread ]</a>
              <a href="subject.html#3190">[ subject ]</a>
              <a href="author.html#3190">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> I am developing an application and now I can't do context menus :(
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please help,
</I>

Hi,

I made a workaround using 0.15 hope helps:

using System;
using System.Collections;
using Gtk;
using GtkSharp;
using System.Runtime.InteropServices;

public class ProjectTree : TreeView
{
    static GLib.GType gtype = GLib.GType.Invalid;
    public static new GLib.GType GType {
        get
        {
            if (gtype == GLib.GType.Invalid)
                gtype = RegisterGType (typeof (ProjectTree));
            return gtype;
        }
    }

    public ProjectTree () : base (GType)
    {

    }

    /* This segfaults
    protected override bool OnButtonPressEvent (ref Gdk.EventButton evnt)
    {
        Console.WriteLine (&quot;Hello&quot;);
        base.OnButtonPressEvent (ref evnt);
        return false;
    }
    */

    //
    // CONNECT_AFTER WORKAROUND
    // This Works

    private Hashtable Signals = new Hashtable();

    [GLib.Signal(&quot;button_press_event&quot;)]
    public new event ButtonPressEventHandler ButtonPressEvent
    {
        add
        {
            if (EventList[&quot;button_press_event&quot;] == null)
                Signals[&quot;button_press_event&quot;] = new boolObjectEventButtonSignal(this, Handle, &quot;button_press_event&quot;, value, System.Type.GetType(&quot;GtkSharp.ButtonPressEventArgs,gtk-sharp&quot;));
            else
                ((GtkSharp.SignalCallback) Signals [&quot;button_press_event&quot;]).AddDelegate (value);

            EventList.AddHandler(&quot;button_press_event&quot;, value);
        }
        remove
        {
            EventList.RemoveHandler(&quot;button_press_event&quot;, value);
            GtkSharp.SignalCallback cb = Signals [&quot;button_press_event&quot;] as GtkSharp.SignalCallback;
            if (cb == null)
                return;

            cb.RemoveDelegate (value);

            if (EventList[&quot;button_press_event&quot;] == null)
            {
                Signals.Remove(&quot;button_press_event&quot;);
                cb.Dispose ();
            }
        }
    }

    private delegate bool boolObjectEventButtonDelegate(IntPtr arg0, ref Gdk.EventButton arg1, int key);

    private class boolObjectEventButtonSignal : SignalCallback
    {
        private static boolObjectEventButtonDelegate _Delegate;

        private IntPtr _raw;
        private uint _HandlerID;

        private static bool boolObjectEventButtonCallback(IntPtr arg0, ref Gdk.EventButton arg1, int key)
        {
            if (!_Instances.Contains(key))
                throw new Exception(&quot;Unexpected signal key &quot; + key);

            boolObjectEventButtonSignal inst = (boolObjectEventButtonSignal) _Instances[key];
            SignalArgs args = (SignalArgs) Activator.CreateInstance (inst._argstype);
            args.Args = new object[1];
            args.Args[0] = arg1;
            object[] argv = new object[2];
            argv[0] = inst._obj;
            argv[1] = args;
            inst._handler.DynamicInvoke(argv);
            if (args.RetVal == null)
                return false;
            return (bool) ((bool)args.RetVal);
        }

        [DllImport(&quot;libgobject-2.0-0.dll&quot;)]
        static extern uint g_signal_connect_data(IntPtr obj, String name, boolObjectEventButtonDelegate cb, int key, IntPtr p, int flags);

        public boolObjectEventButtonSignal(GLib.Object obj, IntPtr raw, String name, Delegate eh, Type argstype) : base(obj, eh, argstype)
        {
            if (_Delegate == null)
            {
                _Delegate = new boolObjectEventButtonDelegate(boolObjectEventButtonCallback);
            }
            _raw = raw;
            _HandlerID = g_signal_connect_data(raw, name, _Delegate, _key, new IntPtr(0), 0);
        }

        [DllImport(&quot;libgobject-2.0-0.dll&quot;)]
        static extern void g_signal_handler_disconnect (IntPtr instance, uint handler);

        [DllImport(&quot;libgobject-2.0-0.dll&quot;)]
        static extern bool g_signal_handler_is_connected (IntPtr instance, uint handler);

        protected override void Dispose (bool disposing)
        {
            _Instances.Remove(_key);
            if(_Instances.Count == 0)
                _Delegate = null;

            if (g_signal_handler_is_connected (_raw, _HandlerID))
                g_signal_handler_disconnect (_raw, _HandlerID);
            base.Dispose (disposing);
        }
    }

}






</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003188.html">[Gtk-sharp-list] ButtonPressEvent in 0.15
</A></li>
	<LI> Next message: <A HREF="003192.html">[Gtk-sharp-list] Re: ButtonPressEvent in 0.15
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3190">[ date ]</a>
              <a href="thread.html#3190">[ thread ]</a>
              <a href="subject.html#3190">[ subject ]</a>
              <a href="author.html#3190">[ author ]</a>
         </LI>
       </UL>
</body></html>
