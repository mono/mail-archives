<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Gtk# audit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:hestilow%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000723.html">
   <LINK REL="Next"  HREF="000725.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Gtk# audit
   </H1>
    <B>Rachel Hestilow
    </B> 
    <A HREF="mailto:hestilow%40ximian.com"
       TITLE="[Gtk-sharp-list] Gtk# audit">hestilow@ximian.com
       </A><BR>
    <I>24 Dec 2002 02:53:19 -0600</I>
    <P><UL>
        <LI> Previous message: <A HREF="000723.html">[Gtk-sharp-list] using gtk# with ms .net framework
</A></li>
        <LI> Next message: <A HREF="000725.html">[Gtk-sharp-list] GType registration for subclassing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-xU4xFh+KKVYkqArtcBXt
Content-Type: multipart/mixed; boundary=&quot;=-nmkq0FbJMpLT2uK7BT4g&quot;


--=-nmkq0FbJMpLT2uK7BT4g
Content-Type: text/plain
Content-Transfer-Encoding: quoted-printable

So, this is mainly for Duncan's benefit, who wanted to do this while he
was on vacation. Basically, I've written up a set of guidelines for
auditing the correctness of the Gtk# API. This is an easy way to
contribute to Gtk#, that doesn't really require anything in the way of
coding. If you're interested in contributing, you probably will want to
coordinate over the list or IRC as to what classes you will be tackling,
lest you duplicate someone else's work...although for auditing,
duplication of effort sometimes helps, rather than hinders. Be sure to
post any metadata patches to the list, and if you have any questions,
feel free to ask.

Thanks!
Rachel



--=-nmkq0FbJMpLT2uK7BT4g
Content-Disposition: inline; filename=gtksharp-audit.txt
Content-Type: text/plain; name=gtksharp-audit.txt; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: quoted-printable

Auditing the Gtk# sources
-------------------------

For the most part, the Gtk# generator is capable of generating correct .NET
APIs without any help at all. However, sometimes there are certain semantic=
s
that it is incapable of inferring from the C sources. In these cases,
metadata is required.

The best way to audit Gtk# is to go through it, class-by-class, and compare
the C# source with the C source and with the C documentation. For each
method in the class, apply the following criteria. If you find the method
needs a metadata addition, either add the metadata before you go on to the
next, or write down the details of what you have found, and then add the
metadata later. Metadata files live in sources/, and are divided up
according to namespace. For example, metadata additions to the Gtk
namespace should go into sources/Gtk.metadata. Remember, many methods are
reexpressed in Gtk# as properties. If you see a property calling a
DllImported method, the same criteria apply to it as for a method.

Things that need metadata
-------------------------

* Array parameters and return values
 =20
  These are often indistinguishable from pointers. One hint that it may
  be an array is that it is a double-pointer (**). However,
  some struct arrays may only have one pointer (*). The best way to find
  out is to check the documentation.

  To tag an array parameter, insert the following metadata rule:
 =20
  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;param&quot;&gt;
        &lt;filter level=3D&quot;name&quot;&gt;PARAMETERNAME&lt;/filter&gt;
        &lt;name&gt;array&lt;/name&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;

  To tag an array return value, insert the following metadata rule:

  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;return&quot;&gt;
        &lt;name&gt;array&lt;/name&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;

* GList and GSList return values.

  These are easy to identify: Their C type will be either GList* or GSList*=
.
  To marshal these, the generator must know what type of data the list
  is holding. For parameters, the generator can infer the types
  automatically. However, the generator cannot know what type of data
  the list is holding if it is a return value. Check the documentation
  and sources to determine the data type.

  If the list is holding a GObject (or anything derived from a GObject),
  Gtk# can infer the type automatically even for return values, and
  no metadata is required. However, for structs and basic types,
  you need to explicitly specify the equivalent C# type. This should be
  a fully qualified typename, including the namespace if it is a class.
  For example, a list of PangoLayoutLine* has an element_type of
  Pango.LayoutLine, while a list of ints has an element_type of int.

  To tag a list return value, insert the following metadata rule:

  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;return&quot;&gt;
        &lt;name&gt;element_type&lt;/name&gt;
        &lt;value&gt;CSHARPTYPE&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;

* Ref-counting return values

  Sometimes, methods return GObjects without first increasing their
  reference count. This will break Gtk#'s garbage collection. In order
  to work around this, Gtk# must manually increase the reference count.

  It's difficult to determine whether or not a method needs an extra
  reference count. Sometimes the documentation will mention who owns the
  returned value. The best indicator is if a method returns the object
  directly from a struct field. For example, the source code for
  gtk_widget_get_style is as follows:

  GtkStyle*
  gtk_widget_get_style (GtkWidget *widget)
  {
    g_return_val_if_fail (GTK_IS_WIDGET (widget), NULL);
     =20
    return widget-&gt;style;
  }

  The reference count is not increased on the returned style, so it
  needs a metadata directive.
 =20
  To tag a return value for reference counting, insert the following
  metadata rule:

  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;return&quot;&gt;
        &lt;name&gt;needs_ref&lt;/name&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;

* Parameters where NULL pointers are allowed

  Sometimes, a method allows a parameter to be NULL. Usually it has
  a special significance that cannot be worked around. The best way
  to determine if a method allows a specific parameter is to make sure
  it is not checking for it with a g_return_if_fail or g_return_val_if_fail=
.

  For example, if a function checks a parameter like this:
   g_return_if_fail (foo !=3D NULL);

  Or like this:
   g_return_if_fail (GTK_IS_FOO (foo));

  Then NULL is NOT allowed, and the default Gtk# behavior is fine. But if
  the documentation says NULL is allowed, or if Gtk+ doesn't check for
  it, it's probably allowed.

  To tag a parameter as allowing NULL, insert the following
  metadata rule:

  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;param&quot;&gt;
        &lt;filter level=3D&quot;name&quot;&gt;PARAMETERNAME&lt;/filter&gt;
        &lt;name&gt;null_ok&lt;/name&gt;
        &lt;value&gt;1&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;

* &quot;Out&quot; parameters

  If a C function needs to return multiple values, or if it wants to
  return a struct without having to allocate the struct itself, it
  will use pointer arguments as return values. These often have the
  same signatures as array parameters. Check the documentation, or
  check the sources to see if the parameter is being deferenced
  and assigned to.
 =20
  To tag an out parameter, insert the following metadata rule.

  &lt;rule&gt;
    &lt;class name=3D&quot;CLASSNAME&quot;&gt;
      &lt;method&gt;METHODNAME&lt;/method&gt;
    &lt;/class&gt;
    &lt;data&gt;
      &lt;attribute target=3D&quot;param&quot;&gt;
        &lt;filter level=3D&quot;name&quot;&gt;PARAMETERNAME&lt;/filter&gt;
        &lt;name&gt;pass_as&lt;/name&gt;
        &lt;value&gt;out&lt;/value&gt;
      &lt;/attribute&gt;
    &lt;/data&gt;
  &lt;/rule&gt;



--=-nmkq0FbJMpLT2uK7BT4g--

--=-xU4xFh+KKVYkqArtcBXt
Content-Type: application/pgp-signature; name=signature.asc
Content-Description: This is a digitally signed message part

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.0.6 (GNU/Linux)
Comment: For info see <A HREF="http://www.gnupg.org">http://www.gnupg.org</A>

iD8DBQA+CCB/apOJdUj74F4RAug0AJ9P6lQtWXl5iZQhP8gLPAbBw9JqiACfULMv
HvILX2iN2D5SJD0+EBums+k=
=lzWq
-----END PGP SIGNATURE-----

--=-xU4xFh+KKVYkqArtcBXt--



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000723.html">[Gtk-sharp-list] using gtk# with ms .net framework
</A></li>
	<LI> Next message: <A HREF="000725.html">[Gtk-sharp-list] GType registration for subclassing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>
</body></html>
