using System;
using Gtk;
using Gnome;

class PrintSample
{
	TextView tv;
			public static double H=2.82;
			public static double W=2.82;
			public static int TOP=832;
				
	static void Main ()
	{
		new PrintSample ();
	}
	
	PrintSample ()
	{
		Application.Init ();
		Gtk.Window win = new Gtk.Window ("Print sample");
		win.SetDefaultSize (400, 300);
		win.DeleteEvent += new DeleteEventHandler (OnWinDelete);
		
		VBox vbox = new VBox (false, 0);
		win.Add (vbox);
		
		tv = new TextView ();
		tv.Buffer.Text = "Hello World";
		vbox.PackStart (tv, true, true, 0);

		Button print = new Button (Gtk.Stock.Print);
		print.Clicked += new EventHandler (OnPrintClicked);
		vbox.PackStart (print, false, true, 0);	
		
		win.ShowAll ();
		Application.Run ();
	}
	
	void MyPrint (PrintContext gpc)
	{
		gpc.BeginPage ("demo");
		gpc.MoveTo (1, 700);
		gpc.Show (tv.Buffer.Text);
		Square(gpc,30,30,100,100);
		
		 Gnome.Font fontBold =  Gnome.Font.FindClosest("Times New Roman",/*Gnome::Print::FONT_BOLD,FALSE,*/ 10);
		 if(fontBold!=null)
			gpc.SetFont(fontBold);
		
		gpc.ShowPage ();
	}


		public void Square(PrintContext gpc,double x,double y,double w,double h) {
		  int x1,x2;
		  int y1,y2;
		  x1=(int)(x*W);
		  y1=TOP-(int)(y*H);
		  x2=(int)((x+w)*W);
		  y2=TOP-(int)((y+h)*H);
			
		  gpc.SaveGraphicState();
		  gpc.NewPath();
		  gpc.MoveTo(x1, y1);
		  gpc.LineTo(x2, y1);
		  gpc.LineTo(x2, y2);
		  gpc.LineTo(x1, y2);
		  gpc.LineTo(x1, y1);
		  gpc.Stroke();
		  gpc.RestoreGraphicState();

			}	

	void OnPrintClicked (object o, EventArgs args)
	{
		PrintJob pj = new PrintJob (PrintConfig.Default ());
		PrintDialog dialog = new PrintDialog (pj, "Print Test", 0);
		int response = dialog.Run ();
		Console.WriteLine ("response: " + response);
		
		if (response == (int) PrintButtons.Cancel) {
			Console.WriteLine ("Canceled");
			dialog.Hide ();
			dialog.Dispose ();
			return;
		}

		PrintContext ctx = pj.Context;
		MyPrint (ctx); 

		pj.Close ();
		
		switch (response) {
		case (int) PrintButtons.Print: 
			pj.Print (); 
			break;
		case (int) PrintButtons.Preview:
			new PrintJobPreview (pj, "Print Test").Show ();
			break;
		}

		dialog.Hide ();
		dialog.Dispose ();
	}
	
	void OnWinDelete (object o, DeleteEventArgs args)
	{
		Application.Quit ();
	}
}
