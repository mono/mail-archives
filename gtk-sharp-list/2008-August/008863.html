<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Fwd: Dragging Floating windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Fwd%3A%20Dragging%20Floating%20windows&In-Reply-To=acc1ad140807230554j36014f43m64c19a310bc0ba6c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008872.html">
   <LINK REL="Next"  HREF="008864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Fwd: Dragging Floating windows</H1>
    <B>Andy Selvig</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20Fwd%3A%20Dragging%20Floating%20windows&In-Reply-To=acc1ad140807230554j36014f43m64c19a310bc0ba6c%40mail.gmail.com"
       TITLE="[Gtk-sharp-list] Fwd: Dragging Floating windows">ajselvig at gmail.com
       </A><BR>
    <I>Sun Aug  3 11:28:17 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008872.html">[Gtk-sharp-list] Change background of widget using theme colors
</A></li>
        <LI>Next message: <A HREF="008864.html">[Gtk-sharp-list] Fwd: Dragging Floating windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8863">[ date ]</a>
              <a href="thread.html#8863">[ thread ]</a>
              <a href="subject.html#8863">[ subject ]</a>
              <a href="author.html#8863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi-

I sent the e-mail below a couple weeks ago and haven't gotten any
response. I'm not sure if it just didn't go through or what the deal
is. Anyway, if anyone has any idea how to help it would be
appreciated, otherwise some direction as to where else to go for help
would be great.

Thanks.


---------- Forwarded message ----------
From: Andy Selvig &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">ajselvig at gmail.com</A>&gt;
Date: Wed, Jul 23, 2008 at 7:54 AM
Subject: Dragging Floating windows
To: <A HREF="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">gtk-sharp-list at lists.ximian.com</A>


Hello All-

I'm having some trouble with dragging a floating, decoration-less
window around the screen. I have written a small (tried to keep it
under 100 lines but failed) app that demonstrates the problem.

The main window simply contains a button. When the user clicks on the
button, the button reparents itself to a floating window and the user
can then drag the window around the screen. The problem is that, after
the user clicks the button but BEFORE they let go of the mouse button,
the dragging doesn't seem to behave quite right. If the mouse is moved
slowly enough, it works fine, but at a certain speed the floating
window will stop tracking it. The strange thing is that if the user
lets go and clicks on the button again, the dragging will work
perfectly, no matter what the speed. It basically just doesn't seem to
be receiving the mouse events properly after the reparent.

I tried looking through the C source for HandleBox, but couldn't find
what makes it not behave this way. My source code is attached. Any
help would be greatly appreciated.

Thanks.

-Andy





&#65279;using System;



namespace FloatDraggingTest

{

	/// &lt;summary&gt;

	/// Main window.

	/// &lt;/summary&gt;

	class MainWindow : Gtk.Window

	{

		/// &lt;summary&gt;

		/// Application entry point.

		/// &lt;/summary&gt;

		public static void Main(string[] args)

		{

			Gtk.Application.Init();

			MainWindow win = new MainWindow();

			win.ShowAll();

			Gtk.Application.Run();

		}





		/// &lt;summary&gt;

		/// Main window default constructor.

		/// &lt;/summary&gt;

		public MainWindow()

			: base(Gtk.WindowType.Toplevel)

		{

			floatWidget = new FloatWidget(&quot;Click Me&quot;);

			Add(floatWidget);



			DeleteEvent += OnDeleteEvent;

		}



		/// &lt;summary&gt;

		/// Called when the window is deleted, stops the application.

		/// &lt;/summary&gt;

		/// &lt;param name=&quot;o&quot;&gt;&lt;/param&gt;

		/// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt;

		void OnDeleteEvent(object o, Gtk.DeleteEventArgs args)

		{

			Gtk.Application.Quit();

		}





		private FloatWidget floatWidget;



	}





	/// &lt;summary&gt;

	/// A widget that you can grab and drag around.

	/// &lt;/summary&gt;

	class FloatWidget : Gtk.Button

	{



		/// &lt;summary&gt;

		/// Default constructor.

		/// &lt;/summary&gt;

		/// &lt;param name=&quot;text&quot;&gt; Text to display on the widget.&lt;/param&gt;

		public FloatWidget(string text)

			: base(new Gtk.Label(text))

		{

			// create the float window

			floatWindow = new Gtk.Window(Gtk.WindowType.Toplevel);

			floatWindow.Decorated = false;



			AddEvents((int)Gdk.EventMask.AllEventsMask); // add all events

		}



		private Gtk.Window floatWindow;



		private bool grabbed = false;



		private Gdk.Point grabPoint;



		protected override bool OnButtonPressEvent(Gdk.EventButton evnt)

		{

			grabbed = true;

			int grabX, grabY;

			GetPointer(out grabX, out grabY);

			grabPoint = new Gdk.Point(grabX, grabY);

			return true;

		}



		protected override bool OnButtonReleaseEvent(Gdk.EventButton evnt)

		{

			grabbed = false;

			return true;

		}



		protected override bool OnMotionNotifyEvent(Gdk.EventMotion evnt)

		{

			if (grabbed) // the window has been grabbed

			{

				if (Parent != floatWindow) // it isn't floating yet, float it

				{

					Reparent(floatWindow);

					floatWindow.ShowAll();

				}

				MoveToCursor();

			}



			return true;

		}



		protected override bool OnLeaveNotifyEvent(Gdk.EventCrossing evnt)

		{

			if (grabbed)

				MoveToCursor();

			return true;

		}



		/// &lt;summary&gt;

		/// Moves the floating window to the cursor.

		/// &lt;/summary&gt;

		protected void MoveToCursor()

		{

			int cursorX, cursorY, windowX, windowY;

			GetPointer(out cursorX, out cursorY);

			GdkWindow.GetPosition(out windowX, out windowY);

			floatWindow.GdkWindow.Move(windowX + cursorX - grabPoint.X, windowY
+ cursorY - grabPoint.Y);

			Display.Sync();

		}



	}





}
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008872.html">[Gtk-sharp-list] Change background of widget using theme colors
</A></li>
	<LI>Next message: <A HREF="008864.html">[Gtk-sharp-list] Fwd: Dragging Floating windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8863">[ date ]</a>
              <a href="thread.html#8863">[ thread ]</a>
              <a href="subject.html#8863">[ subject ]</a>
              <a href="author.html#8863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
