<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] Best way to continuously update a Gtk.Image (V4L)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:scut%40nb.in-berlin.de">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="003876.html">
   <LINK REL="Next"  HREF="003879.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] Best way to continuously update a Gtk.Image (V4L)
   </H1>
    <B>Sebastian
    </B> 
    <A HREF="mailto:scut%40nb.in-berlin.de"
       TITLE="[Gtk-sharp-list] Best way to continuously update a Gtk.Image (V4L)">scut@nb.in-berlin.de
       </A><BR>
    <I>Sun, 18 Apr 2004 15:35:00 +0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="003876.html">[Gtk-sharp-list] Best way to continuously update a Gtk.Image (V4L)
</A></li>
        <LI> Next message: <A HREF="003879.html">[Gtk-sharp-list] GStreamer bindings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3885">[ date ]</a>
              <a href="thread.html#3885">[ thread ]</a>
              <a href="subject.html#3885">[ subject ]</a>
              <a href="author.html#3885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi *,


I hope to have solved all of my problems. Below is a summary for the
archives, as other people might face similar problems :)


On Sat, Apr 17, 2004 at 12:47:37PM +0800, Sebastian wrote:

&gt;<i>  1. Is just overwriting the Pixbuf byte array and queuing a redraw the
</I>&gt;<i>     proper way or may this pointer change somehow?
</I>
Seems to work.


&gt;<i>  2. How to call this from the Gtk# main loop? There is no main loop at the
</I>&gt;<i>     moment, and if I try to close the window, I get this message:
</I>&gt;<i> 
</I>&gt;<i> 	(&lt;unknown&gt;:1970): Gtk-CRITICAL **: file gtkmain.c: line 1151
</I>&gt;<i> 		(gtk_main_quit): assertion `main_loops != NULL' failed
</I>&gt;<i> 
</I>&gt;<i>     I do not want the user to have to click a start-button or the like.
</I>
I now use one main GTK loop plus Gdk.Threads.Enter/Leave calls.
See <A HREF="http://bobi.ifs.hr/ifs/razno/doc/gtk/gtkfaq-5.html#ss5.2">http://bobi.ifs.hr/ifs/razno/doc/gtk/gtkfaq-5.html#ss5.2</A> and
<A HREF="http://www.ijon.de/comp/tutorials/threads/gdkgtk.html">http://www.ijon.de/comp/tutorials/threads/gdkgtk.html</A> (german).


...
using System.Threading;
...

public class V4lGtk
{
	private static Thread capture = null;

	public static void Main (string[] args)
	{
		Gdk.Threads.Init ();
		Application.Init ();

		V4lGtk vg = new V4lGtk ();
		vg.Test ();
	}

	public void Test ()
	{
		Window win = new Window (&quot;V4L GTK# test&quot;);
		win.DeleteEvent += new DeleteEventHandler (Window_Delete);

		Video4Linux vl = new Video4Linux ();
		vl.Open ();
		vl.SetCaptureSize (320, 240);
		vl.PrepareCapture ();

		Gdk.Pixbuf pb = new Gdk.Pixbuf (Gdk.Colorspace.Rgb, false,
			8, vl.FrameWidth, vl.FrameHeight);

		Image img = new Image (pb);
		win.Add (img);
		win.ShowAll ();

		CaptureThread cth = new CaptureThread (vl, pb, img);
		ThreadStart captureSt = new ThreadStart (cth.Start);
		capture = new Thread (captureSt);
		capture.Start ();

		Console.WriteLine (&quot;main GTK thread&quot;);

		// The main loop, wrapped within .Enter and .Leave
		Gdk.Threads.Enter ();
		Application.Run ();
		Gdk.Threads.Leave ();
	}

	static void Window_Delete (object obj, DeleteEventArgs args)
	{
		capture.Abort ();
		Application.Quit ();
		args.RetVal = true;
	}
}

class CaptureThread
{
	private CaptureThread ()
	{
	}

	Video4Linux vl;
	Gdk.Pixbuf pb;
	Image img;

	public CaptureThread (Video4Linux vl, Gdk.Pixbuf pb, Image img)
	{
		this.vl = vl;
		this.pb = pb;
		this.img = img;
	}

	public void Start ()
	{
		GdkPixbufConverter conv = new GdkPixbufConverter (vl, pb);
		vl.StartCapture ();

		while (true) {
			vl.GetFrame ();
			conv.ConvertCurrentFrame ();

			// Wrapped inside Enter/Leave to not confuse GTK
			Gdk.Threads.Enter ();
			img.QueueDraw ();
			Gdk.Threads.Leave ();

			vl.FreeFrame ();
		}
	}
}

...


Is this the right way (I think so), or did I miss something?


ciao,
Sebastian

-- 
   |\      _,,,--,,_  ,)  <A HREF="mailto:scut@nb.in-berlin.de">scut@nb.in-berlin.de</A>, <A HREF="http://segfault.net/~scut/pgp">http://segfault.net/~scut/pgp</A>
   /,`.-'`'   -,  ;-;;'   5453 AC95 1E02 FDA7 50D2 A42D 427E 6DEF 745A 8E07
_ |,4-  ) )-,_ ) /\__________________________________________________________
~'---''(_/--' (_/-'~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="003876.html">[Gtk-sharp-list] Best way to continuously update a Gtk.Image (V4L)
</A></li>
	<LI> Next message: <A HREF="003879.html">[Gtk-sharp-list] GStreamer bindings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3885">[ date ]</a>
              <a href="thread.html#3885">[ thread ]</a>
              <a href="subject.html#3885">[ subject ]</a>
              <a href="author.html#3885">[ author ]</a>
         </LI>
       </UL>
</body></html>
