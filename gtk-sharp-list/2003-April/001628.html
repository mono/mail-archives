<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> ColorSelection bug fixes (was Re: [Gtk-sharp-list] problem
 marshalling struct data)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gnome%40fonicmonkey.net">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001621.html">
   <LINK REL="Next"  HREF="001643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>ColorSelection bug fixes (was Re: [Gtk-sharp-list] problem
 marshalling struct data)
   </H1>
    <B>Lee Mallabone
    </B> 
    <A HREF="mailto:gnome%40fonicmonkey.net"
       TITLE="ColorSelection bug fixes (was Re: [Gtk-sharp-list] problem
 marshalling struct data)">gnome@fonicmonkey.net
       </A><BR>
    <I>12 Apr 2003 14:08:40 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="001621.html">[Gtk-sharp-list] problem marshalling struct data
</A></li>
        <LI> Next message: <A HREF="001643.html">ColorSelection bug fixes (was Re: [Gtk-sharp-list] problem
 marshalling struct data)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1628">[ date ]</a>
              <a href="thread.html#1628">[ thread ]</a>
              <a href="subject.html#1628">[ subject ]</a>
              <a href="author.html#1628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-Jj/UTi/kOgmPMd1dCbUO
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

On Sat, 2003-04-12 at 03:24, Mike Kestner wrote:

&gt;<i> Only thing I can think of is to return an IntPtr, and in a .custom,
</I>&gt;<i> increment the pointer while iterating on n_color using Gdk.Color.New to
</I>&gt;<i> marshal the individual Colors. May need to go into unsafe mode to
</I>&gt;<i> increment the IntPtr, but I'm not sure off the top of my head.
</I>
I was trying to do that originally, but in a way that didn't actually
manipulate the IntPtr, so it didn't work.

It works now (though PaletteFromString is unsafe).

I've attached patches that fix up bugs in ColorSelection. They make
PaletteFromString() and PaletteToString have good method signatures as
well as making PreviousColor a single property. This resolves bugs
#27835 &amp; #38672.

Okay to commit?

I've also attached ColorSample.cs which is actually a visual test that
things work. I could probably turn this into an NUnit test without too
much trouble. Does Gtk# have a framework/suite setup for NUnit tests? If
not, is this worth putting on cvs anywhere, (it crashes without my
patches, works correctly with them).

Regards,

Lee.


--=-Jj/UTi/kOgmPMd1dCbUO
Content-Disposition: attachment; filename=ColorSelection.custom
Content-Type: text/plain; name=ColorSelection.custom; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

// Gtk.ColorSelection.custom - customizations and corrections for ColorSelection
// Author: Lee Mallabone &lt;<A HREF="mailto:gnome@fonicmonkey.net">gnome@fonicmonkey.net</A>&gt;
// Author: Justin Malcolm

		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern string gtk_color_selection_palette_to_string(Gdk.Color[] colors, int n_colors);

		/// &lt;summary&gt; PaletteToString Method &lt;/summary&gt;
		public static string PaletteToString(Gdk.Color[] colors) {
			int n_colors = colors.Length;
			string raw_ret = gtk_color_selection_palette_to_string(colors, n_colors);
			string ret = raw_ret;
			return ret;
		}
		
		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern bool gtk_color_selection_palette_from_string(string str, out IntPtr colors, out int n_colors);

		public unsafe static Gdk.Color[] PaletteFromString(string str) {
			IntPtr parsedColors;
			int n_colors;
			bool raw_ret = gtk_color_selection_palette_from_string(str, out parsedColors, out n_colors);
			
			// If things failed, return silently
			if (!raw_ret)
			{
				return null;
			}
			System.Console.WriteLine(&quot;Raw call finished, making &quot; + n_colors + &quot; actual colors&quot;);
			Gdk.Color[] colors = new Gdk.Color[n_colors];
			for (int i=0; i &lt; n_colors; i++)
			{
				colors[i] = Gdk.Color.New(parsedColors);
				parsedColors = (IntPtr) ((int)parsedColors + sizeof(Gdk.Color));
			}
			return colors;
		}

		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern void gtk_color_selection_set_previous_color(IntPtr raw, ref Gdk.Color color);

		[DllImport(&quot;libgtk-win32-2.0-0.dll&quot;)]
		static extern void gtk_color_selection_get_previous_color(IntPtr raw, out Gdk.Color color);

		// Create Gtk# property to replace two Gtk+ functions
		public Gdk.Color PreviousColor
		{
			get
			{
				Gdk.Color returnColor;
				gtk_color_selection_get_previous_color(Handle, out returnColor);	
				return returnColor;
			}
			set
			{
				gtk_color_selection_set_previous_color(Handle, ref value);
			}
		}


--=-Jj/UTi/kOgmPMd1dCbUO
Content-Disposition: attachment; filename=colorsel.diff
Content-Type: text/x-patch; name=colorsel.diff; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

Index: sources/Gtk.metadata
===================================================================
RCS file: /cvs/public/gtk-sharp/sources/Gtk.metadata,v
retrieving revision 1.48
diff -u -r1.48 Gtk.metadata
--- sources/Gtk.metadata	2 Apr 2003 08:26:36 -0000	1.48
+++ sources/Gtk.metadata	12 Apr 2003 12:16:11 -0000
@@ -1606,6 +1606,20 @@
   &lt;/data&gt;
 &lt;/rule&gt;
 &lt;rule&gt;
+  &lt;class name=&quot;GtkColorSelection&quot;&gt;
+    &lt;method&gt;PaletteToString&lt;/method&gt;
+    &lt;method&gt;PaletteFromString&lt;/method&gt;
+    &lt;method&gt;GetPreviousColor&lt;/method&gt;
+    &lt;method&gt;SetPreviousColor&lt;/method&gt;
+  &lt;/class&gt;
+  &lt;data&gt;
+    &lt;attribute target=&quot;method&quot;&gt;
+      &lt;name&gt;hidden&lt;/name&gt;
+      &lt;value&gt;1&lt;/value&gt;
+    &lt;/attribute&gt;
+  &lt;/data&gt;
+&lt;/rule&gt;
+&lt;rule&gt;
   &lt;class name=&quot;GtkWidget&quot;&gt;
     &lt;method&gt;ListAccelClosures&lt;/method&gt;
   &lt;/class&gt;
Index: api/gtk-api.xml
===================================================================
RCS file: /cvs/public/gtk-sharp/api/gtk-api.xml,v
retrieving revision 1.30
diff -u -r1.30 gtk-api.xml
--- api/gtk-api.xml	2 Apr 2003 08:26:36 -0000	1.30
+++ api/gtk-api.xml	12 Apr 2003 12:16:15 -0000
@@ -2152,7 +2152,7 @@
       &lt;method name=&quot;GetPreviousAlpha&quot; cname=&quot;gtk_color_selection_get_previous_alpha&quot;&gt;
         &lt;return-type type=&quot;guint16&quot;/&gt;
       &lt;/method&gt;
-      &lt;method name=&quot;GetPreviousColor&quot; cname=&quot;gtk_color_selection_get_previous_color&quot;&gt;
+      &lt;method name=&quot;GetPreviousColor&quot; cname=&quot;gtk_color_selection_get_previous_color&quot; hidden=&quot;1&quot;&gt;
         &lt;return-type type=&quot;void&quot;/&gt;
         &lt;parameters&gt;
           &lt;parameter type=&quot;GdkColor*&quot; name=&quot;color&quot;/&gt;
@@ -2165,7 +2165,7 @@
         &lt;return-type type=&quot;gboolean&quot;/&gt;
       &lt;/method&gt;
       &lt;constructor cname=&quot;gtk_color_selection_new&quot;/&gt;
-      &lt;method name=&quot;PaletteFromString&quot; cname=&quot;gtk_color_selection_palette_from_string&quot; shared=&quot;true&quot;&gt;
+      &lt;method name=&quot;PaletteFromString&quot; cname=&quot;gtk_color_selection_palette_from_string&quot; shared=&quot;true&quot; hidden=&quot;1&quot;&gt;
         &lt;return-type type=&quot;gboolean&quot;/&gt;
         &lt;parameters&gt;
           &lt;parameter type=&quot;const-gchar*&quot; name=&quot;str&quot;/&gt;
@@ -2173,7 +2173,7 @@
           &lt;parameter type=&quot;gint*&quot; name=&quot;n_colors&quot;/&gt;
         &lt;/parameters&gt;
       &lt;/method&gt;
-      &lt;method name=&quot;PaletteToString&quot; cname=&quot;gtk_color_selection_palette_to_string&quot; shared=&quot;true&quot;&gt;
+      &lt;method name=&quot;PaletteToString&quot; cname=&quot;gtk_color_selection_palette_to_string&quot; shared=&quot;true&quot; hidden=&quot;1&quot;&gt;
         &lt;return-type type=&quot;gchar*&quot;/&gt;
         &lt;parameters&gt;
           &lt;parameter type=&quot;const-GdkColor*&quot; name=&quot;colors&quot;/&gt;
@@ -2216,7 +2216,7 @@
           &lt;parameter type=&quot;guint16&quot; name=&quot;alpha&quot;/&gt;
         &lt;/parameters&gt;
       &lt;/method&gt;
-      &lt;method name=&quot;SetPreviousColor&quot; cname=&quot;gtk_color_selection_set_previous_color&quot;&gt;
+      &lt;method name=&quot;SetPreviousColor&quot; cname=&quot;gtk_color_selection_set_previous_color&quot; hidden=&quot;1&quot;&gt;
         &lt;return-type type=&quot;void&quot;/&gt;
         &lt;parameters&gt;
           &lt;parameter type=&quot;GdkColor*&quot; name=&quot;color&quot;/&gt;

--=-Jj/UTi/kOgmPMd1dCbUO
Content-Disposition: attachment; filename=ColorSample.cs
Content-Type: text/plain; name=ColorSample.cs; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

using Gtk;
using Gdk;
using System;

public class ColorSample {
	public static void Main()
	{
		Gtk.Application.Init();
		
		// Setup simple colors
		Gdk.Color black = new Gdk.Color(0x00, 0x00, 0x00);
		Gdk.Color white = new Gdk.Color(0xFF, 0xFF, 0xFF);
		Gdk.Color[] colors = new Gdk.Color[] { black, white };
		
		Console.WriteLine(&quot;------ PaletteToString test ------&quot;);
		
		string parsedPalette = ColorSelection.PaletteToString(colors);
		Console.WriteLine(&quot;Got palette as: &quot; + parsedPalette);

		Console.WriteLine(&quot;------ PaletteFromString test ------&quot;);
		Gdk.Color[] parsedColors = ColorSelection.PaletteFromString(parsedPalette);
		if (parsedColors == null)
		{
			Console.WriteLine(&quot;Parsed palette array is null&quot;);
		}
		else
		{
			Console.WriteLine(&quot;Parsed palette array is: &quot;);
			foreach (Gdk.Color col in parsedColors)
			{
				Console.WriteLine(col.ToString());
			}
		}

		colors[1] = parsedColors[1];	
		Console.WriteLine(&quot;------ PaletteToString test ------&quot;);
		
		parsedPalette = ColorSelection.PaletteToString(colors);
		Console.WriteLine(&quot;Got palette as: &quot; + parsedPalette);




	}
}

--=-Jj/UTi/kOgmPMd1dCbUO--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001621.html">[Gtk-sharp-list] problem marshalling struct data
</A></li>
	<LI> Next message: <A HREF="001643.html">ColorSelection bug fixes (was Re: [Gtk-sharp-list] problem
 marshalling struct data)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1628">[ date ]</a>
              <a href="thread.html#1628">[ thread ]</a>
              <a href="subject.html#1628">[ subject ]</a>
              <a href="author.html#1628">[ author ]</a>
         </LI>
       </UL>
</body></html>
