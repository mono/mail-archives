<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Gtk-sharp-list] widget destruction
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20widget%20destruction&In-Reply-To=AANLkTinRjjMiAPkV754xWc%3Dk9JMYQ%3DThH_M1Eu4vuqQm%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010661.html">
   <LINK REL="Next"  HREF="010652.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Gtk-sharp-list] widget destruction</H1>
    <B>Christopher David Howie</B> 
    <A HREF="mailto:gtk-sharp-list%40lists.ximian.com?Subject=%5BGtk-sharp-list%5D%20widget%20destruction&In-Reply-To=AANLkTinRjjMiAPkV754xWc%3Dk9JMYQ%3DThH_M1Eu4vuqQm%40mail.gmail.com"
       TITLE="[Gtk-sharp-list] widget destruction">me at chrishowie.com
       </A><BR>
    <I>Tue Mar  8 18:22:29 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="010661.html">[Gtk-sharp-list] widget destruction
</A></li>
        <LI>Next message: <A HREF="010652.html">[Gtk-sharp-list] widget destruction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10650">[ date ]</a>
              <a href="thread.html#10650">[ thread ]</a>
              <a href="subject.html#10650">[ subject ]</a>
              <a href="author.html#10650">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> On Mon, 7 Mar 2011 19:14:40 -0600, Mike Kestner wrote:
&gt;<i> seeing as I'm the
</I>&gt;<i> only one who seems to think Dispose and Destroy actually mean two
</I>&gt;<i> different things in the context of a C# binding to GObject. &#160;It makes
</I>&gt;<i> more sense to me that Destroy call Dispose, not vice-versa, and the
</I>&gt;<i> using (FooDialog) pattern isn't all that compelling to me.
</I>
 I mostly agree with Lluis, but wanted to elaborate on a point and call 
 out another.

 Most people, AIUI, expect IDisposable.Dispose to release and destroy 
 all native resources held by an object.  Therefore it seems 
 counter-intuitive to me that Dispose() on a Gtk# widget would release 
 only the managed object and allow the unmanaged one to continue to live. 
 The only place where this makes sense, IMO, is when a managed object is 
 created to wrap a previously-created unmanaged object.  For people 
 familiar with .NET, they are going to expect &quot;using(var foo = new 
 FooDialog())&quot; to properly release all resources held by the new instance 
 of FooDialog, but in Gtk# 2 this is not the case.  IMO this is an API 
 design defect.

 As far as syntax goes, I find it hard to believe that you don't see 
 much difference between

 -----------------------8&lt;-----------------------
     using (var foo = new FooDialog())
         foo.Run();
 -----------------------8&lt;-----------------------

 And

 -----------------------8&lt;-----------------------
     FooDialog d;
     try {
         d = new FooDialog();
         d.Run();
     } finally {
         if (d != null) {
             d.Destroy();
             d.Dispose();
         }
     }
 -----------------------8&lt;-----------------------

 I know which one I would rather write...

 One compromise might be to have something hacky like this:

 -----------------------8&lt;-----------------------
     public static class GtkObjectCoda
     {
         public static ObjectDestroyer&lt;T&gt; Destroyer&lt;T&gt;(this T self)
             where T : Gtk.Object
         {
             if (self == null)
                 throw new ArgumentNullException(&quot;self&quot;);

             return new ObjectDestroyer(self);
         }

         public struct ObjectDestroyer&lt;T&gt; : IDisposable
             where T : Gtk.Object
         {
             private T gtkObject;

             public T Object
             {
                 get
                 {
                     var obj = gtkObject;

                     if (obj == null)
                         throw new 
 ObjectDisposedException(GetType().FullName);

                     return obj;
                 }
             }

             internal ObjectDestroyer(T obj)
             {
                 Object = obj;
             }

             public void Dispose()
             {
                 var obj = Interlocked.Exchange(ref gtkObject, null);

                 if (obj == null)
                     throw new 
 ObjectDisposedException(GetType().FullName);

                 obj.Destroy();
                 obj.Dispose();
             }
         }
     }
 -----------------------8&lt;-----------------------

 Then, on Gtk# 2:

 -----------------------8&lt;-----------------------
     using (var foo = new FooDialog().Destroyer())
         foo.Object.Run();
 -----------------------8&lt;-----------------------

 Meh.  It's not terrible, but having Dispose() do The Right Thing would 
 be better.

-- 
 Chris Howie
 <A HREF="http://www.chrishowie.com">http://www.chrishowie.com</A>
 <A HREF="http://en.wikipedia.org/wiki/User:Crazycomputers">http://en.wikipedia.org/wiki/User:Crazycomputers</A>

 If you correspond with me on a regular basis, please read this 
 document: <A HREF="http://www.chrishowie.com/email-preferences/">http://www.chrishowie.com/email-preferences/</A>

 PGP fingerprint: 2B7A B280 8B12 21CC 260A DF65 6FCE 505A CF83 38F5

 ------------------------------------------------------------------------
                     IMPORTANT INFORMATION/DISCLAIMER

 This document should be read only by those persons to whom it is 
 addressed.  If you have received this message it was obviously addressed 
 to you and therefore you can read it.

 Additionally, by sending an email to ANY of my addresses or to ANY 
 mailing lists to which I am subscribed, whether intentionally or 
 accidentally, you are agreeing that I am &quot;the intended recipient,&quot; and 
 that I may do whatever I wish with the contents of any message received 
 from you, unless a pre-existing agreement prohibits me from so doing.

 This overrides any disclaimer or statement of confidentiality that may 
 be included on your message.
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010661.html">[Gtk-sharp-list] widget destruction
</A></li>
	<LI>Next message: <A HREF="010652.html">[Gtk-sharp-list] widget destruction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10650">[ date ]</a>
              <a href="thread.html#10650">[ thread ]</a>
              <a href="subject.html#10650">[ subject ]</a>
              <a href="author.html#10650">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/gtk-sharp-list">More information about the Gtk-sharp-list
mailing list</a><br>
</body></html>
