<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-vb]  Mono and .NET using Console.ReadKey()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20%20Mono%20and%20.NET%20using%20Console.ReadKey%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000831.html">
   <LINK REL="Next"  HREF="000836.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-vb]  Mono and .NET using Console.ReadKey()</H1>
    <B>Paebbels</B> 
    <A HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20%20Mono%20and%20.NET%20using%20Console.ReadKey%28%29&In-Reply-To="
       TITLE="[mono-vb]  Mono and .NET using Console.ReadKey()">Paebbels at gmail.com
       </A><BR>
    <I>Wed Nov 19 16:48:07 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000831.html">[mono-vb] Compiling VS Solutions using VBNC
</A></li>
        <LI>Next message: <A HREF="000836.html">[mono-vb]  Mono-Ported VB Program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#834">[ date ]</a>
              <a href="thread.html#834">[ thread ]</a>
              <a href="subject.html#834">[ subject ]</a>
              <a href="author.html#834">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,

I programmed a console application in VB .NET with VS08 which uses
cmd-InputBuffer to display an history of old commands in my application.

After porting this application to Mono (Debian, v1.9.1) my application has
no history feature (my shell is bash).

Then I decided to uses Console.ReadKey() instead of ReadLine().
I usesd the Microsoft MSDN example to display the KeyChars, KeyCodes and
Modifiers

--------------------
[...]
Console.TreatControlCAsInput = True
            Console.WriteLine(m1)
            Do
                Console.WriteLine(m2)
                sb.Length = 0
                cki = Console.ReadKey(True)
                sb.Append(m3)
                If cki.Modifiers &lt;&gt; 0 Then
                    If (cki.Modifiers And ConsoleModifiers.Alt) &lt;&gt; 0 Then
                        sb.Append(&quot;ALT+&quot;)
                    End If
                    If (cki.Modifiers And ConsoleModifiers.Shift) &lt;&gt; 0 Then
                        sb.Append(&quot;SHIFT+&quot;)
                    End If
                    If (cki.Modifiers And ConsoleModifiers.Control) &lt;&gt; 0
Then
                        sb.Append(&quot;CTL+&quot;)
                    End If
                End If
                sb.Append(cki.Key.ToString())
                sb.AppendFormat(m4, cki.KeyChar,
Convert.ToInt32(cki.KeyChar))
                sb.AppendLine().AppendLine()
                Console.WriteLine(sb.ToString())
            Loop While cki.Key &lt;&gt; ConsoleKey.Escape
--------------------

My ConsoleExtended Class has a mask with all allowd keys assoziated with an
delegate e.g. AddCharToBuffer for normal alphanumeric-chars.


Compiled on Windows this application does what it should do ^^
After porting it to Mono some ConsoleKeyInfo-Instances have an abnormal
value ...

Enter returns ConsoleKey.Enter which has ASCII Char 13 on Windows, on Mono
it has 10 (I know the differnet behavior of \n und \r\n ....)
Home returns on Windows ConsoleKey.Home, on Mono ConsoleKey.Esc with ASCII
Char 27 (also: End, Delete)
Backspace returns on Windows ConsoleKey.Backspace ASCII Char 8, on Mono
ConsoleKey.Backspace with ASCII Char 0

After some experiments I noticed that Console.In has differnet Encodings.
After setting them to UTF-8 nothing changed. 


Why is there a differnet behavior?
What ConsoleKeyInfo-Values are used in Mono?
How to use spezial Keys like Home, End, Delete, Backspace, ...


Here are some code fragments:
--------------------------
        Public Sub New()
            With OutputBufferSize
                .Width = Console.BufferWidth
                .Height = Console.BufferHeight
            End With

            Dim DefaultMask As New Dictionary(Of ConsoleKeyInfo,
InputAction)
            KeyMasks.Add(DefaultMaskName, DefaultMask)
            CurrentKeyMask = DefaultMask

            AddKeyToMask(&quot;rtn&quot;, DefaultMaskName, Function() False)
            AddKeyToMask(&quot;esc&quot;, DefaultMaskName, AddressOf ClearInputBuffer)
            AddKeyToMask(&quot;del&quot;, DefaultMaskName, AddressOf
DeleteAtInputBufferPos)
            AddKeyToMask(&quot;bsp&quot;, DefaultMaskName, AddressOf
DeleteBeforeInputBufferPos)
            AddKeyToMask(&quot;home&quot;, DefaultMaskName, AddressOf
InputBufferPosHome)
            AddKeyToMask(&quot;end&quot;, DefaultMaskName, AddressOf
InputBufferPosEnd)
            AddKeyToMask(&quot;left&quot;, DefaultMaskName, AddressOf
InputBufferPosLeft)
            AddKeyToMask(&quot;right&quot;, DefaultMaskName, AddressOf
InputBufferPosRight)
            AddKeyToMask(&quot;up&quot;, DefaultMaskName, AddressOf HistoryBack)
            AddKeyToMask(&quot;down&quot;, DefaultMaskName, AddressOf HistoryNext)
            AllowAlphaNumForMask(DefaultMaskName)
            AllowSpezialCharsForMask(DefaultMaskName)

        End Sub


        Public Sub AddKeyToMask(ByVal KeyName As String, ByVal MaskName As
String, ByVal KeyAction As Action)
            If KeyMasks.ContainsKey(MaskName) Then
                Select Case KeyName
                    Case &quot;a&quot;
                        KeyMasks(MaskName).Add(New ConsoleKeyInfo(&quot;a&quot;c,
ConsoleKey.A, False, False, False), New InputAction With {.DisplayChar =
&quot;a&quot;, .BufferChar = &quot;a&quot;, .Action = KeyAction})
                    Case &quot;b&quot;
                        KeyMasks(MaskName).Add(New ConsoleKeyInfo(&quot;b&quot;c,
ConsoleKey.B, False, False, False), New InputAction With {.DisplayChar =
&quot;b&quot;, .BufferChar = &quot;b&quot;, .Action = KeyAction})
                    Case &quot;c&quot;
                        KeyMasks(MaskName).Add(New ConsoleKeyInfo(&quot;c&quot;c,
ConsoleKey.C, False, False, False), New InputAction With {.DisplayChar =
&quot;c&quot;, .BufferChar = &quot;c&quot;, .Action = KeyAction})
[...]
Case &quot;rtn&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(13), ConsoleKey.Enter, False, False, False),
New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;esc&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(27), ConsoleKey.Escape, False, False, False),
New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;del&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.Delete, False, False, False),
New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;bsp&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(8), ConsoleKey.Backspace, False, False,
False), New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;home&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.Home, False, False, False), New
InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action = KeyAction})
                    Case &quot;end&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.End, False, False, False), New
InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action = KeyAction})
                    Case &quot;left&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.LeftArrow, False, False,
False), New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;right&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.RightArrow, False, False,
False), New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;up&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.UpArrow, False, False, False),
New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case &quot;down&quot;
                        KeyMasks(MaskName).Add(New
ConsoleKeyInfo(Convert.ToChar(0), ConsoleKey.DownArrow, False, False,
False), New InputAction With {.DisplayChar = &quot;&quot;, .BufferChar = &quot;&quot;, .Action =
KeyAction})
                    Case Else
                        Throw New Exception(&quot;Unknown Key&quot;)
                End Select
            End If
        End Sub


        Public Sub AllowLowerAlphaForMask(ByVal MaskName)
            If KeyMasks.ContainsKey(MaskName) Then
                For Each LowerAlpha As String In
&quot;abcdefghijklmnopqrstuvwxyz&quot;
                    AddKeyToMask(LowerAlpha, MaskName, AddressOf
AddToInputBuffer)
                Next
            End If
        End Sub


        Private Function AddToInputBuffer(ByVal Key As ConsoleKeyInfo, ByVal
InputAction As InputAction) As Boolean
            If InputBufferPos = InputBuffer.Length Then
                InputBuffer &amp;= InputAction.BufferChar
                InputBufferPos += 1

                Console.Write(InputAction.DisplayChar)
                OutputBufferPos.Left += 1
            ElseIf InputBufferPos &lt; InputBuffer.Length Then
                InputBuffer = InputBuffer.Insert(InputBufferPos,
InputAction.BufferChar)
                InputBufferPos += 1

                Console.Write(InputAction.DisplayChar)
                OutputBufferPos.Left += 1
                Console.Write(InputBuffer.Substring(InputBufferPos,
InputBuffer.Length - InputBufferPos))
                Console.CursorLeft = OutputBufferPos.Left
            Else
                Throw New OverflowException(&quot;BufferPos behind last Buffer
element.&quot;)
            End If

            Return True
        End Function


        Public Function ReadExended() As String
            InputBuffer = &quot;&quot;
            InputBufferPos = 0

            With OutputBufferPos
                .Left = Console.CursorLeft
                .Top = Console.CursorTop
            End With

            ReadLineRootPoint = OutputBufferPos

            While (True)
                Dim Key As ConsoleKeyInfo = Console.ReadKey(True)

                Try
                    Dim IA As InputAction = CurrentKeyMask(Key)
                    Dim IAR As Boolean = IA.Action.Invoke(Key, IA)

                    If IAR = False Then Exit While
                Catch ex As Exception
                    Console.WriteLine()
                    Console.WriteLine(&quot;nicht gefunden - {0}&quot;, ex.ToString())
                    Console.WriteLine(&quot;Key: {0}, KeyChar: {1}, KeyCharCHR:
{2}, Modifier: {3}&quot;, Key.Key.ToString(), Key.KeyChar.ToString(),
Convert.ToInt32(Key.KeyChar).ToString(), Key.Modifiers.ToString())
                End Try
            End While

            If _EnableHistory = True Then
                InputBufferHistory.Enqueue(InputBuffer)
            End If

            Return InputBuffer
        End Function

<A HREF="http://www.nabble.com/file/p20589984/ExtendedConsole.vb">http://www.nabble.com/file/p20589984/ExtendedConsole.vb</A> ExtendedConsole.vb 
-- 
View this message in context: <A HREF="http://www.nabble.com/Mono-and-.NET-using-Console.ReadKey%28%29-tp20589984p20589984.html">http://www.nabble.com/Mono-and-.NET-using-Console.ReadKey%28%29-tp20589984p20589984.html</A>
Sent from the Mono - VB mailing list archive at Nabble.com.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000831.html">[mono-vb] Compiling VS Solutions using VBNC
</A></li>
	<LI>Next message: <A HREF="000836.html">[mono-vb]  Mono-Ported VB Program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#834">[ date ]</a>
              <a href="thread.html#834">[ thread ]</a>
              <a href="subject.html#834">[ subject ]</a>
              <a href="author.html#834">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-vb">More information about the Mono-vb
mailing list</a><br>
</body></html>
