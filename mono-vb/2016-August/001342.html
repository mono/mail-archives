<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-vb] VBNC crasch when using marshalAs on arrays in struct
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-vb%40lists.dot.net?Subject=Re%3A%20%5Bmono-vb%5D%20VBNC%20crasch%20when%20using%20marshalAs%20on%20arrays%20in%20struct&In-Reply-To=%3C863479d8-c134-8414-f668-d94d0cab511e%40vtab.se%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="001343.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-vb] VBNC crasch when using marshalAs on arrays in struct</H1>
    <B>Lars Lindholm</B> 
    <A HREF="mailto:mono-vb%40lists.dot.net?Subject=Re%3A%20%5Bmono-vb%5D%20VBNC%20crasch%20when%20using%20marshalAs%20on%20arrays%20in%20struct&In-Reply-To=%3C863479d8-c134-8414-f668-d94d0cab511e%40vtab.se%3E"
       TITLE="[mono-vb] VBNC crasch when using marshalAs on arrays in struct">lars.lindholm at vtab.se
       </A><BR>
    <I>Thu Aug 11 08:56:03 UTC 2016</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="001343.html">[mono-vb] VBNC crasch when using marshalAs on arrays in struct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1342">[ date ]</a>
              <a href="thread.html#1342">[ thread ]</a>
              <a href="subject.html#1342">[ subject ]</a>
              <a href="author.html#1342">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have a structure I need to apply to an byte array. To do this I have a 
VB Structure with marshaling commands to enforce proper packing and 
ensure correct interpretation.

This have worked in a vs environment before and now I'm trying to move 
over to a monodevelop environment. I have tried with the latest 
mono-basic compiler from the github repo(Mono 4.6 - master/c93133d).

When trying to compile I get: vbnc : Command line : error VBNC99999: 
Unexpected error: Specified cast is not valid.

This might be related to this bug: 
<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=2867">https://bugzilla.xamarin.com/show_bug.cgi?id=2867</A>

I'm attaching a complete output and source for a minimal example where 
commenting away the marshal command makes it compile and leaving it in 
makes it crasch.

Best regards

Lars Lindholm


-------------- next part --------------

Building Solution: Mono-Basic-Crasch (Debug|x86)

Building: Mono-Basic-Crasch (Debug|x86)

Build started 7/28/2016 3:38:32 PM.
__________________________________________________
Project &quot;/home/larlin/Projects/Mono-Basic-Crasch/Mono-Basic-Crasch/Mono-Basic-Crasch.vbproj&quot; (Build target(s)):
	
	Target PrepareForBuild:
		Configuration: Debug Platform: x86
	
	Target GenerateSatelliteAssemblies:
	No input files were specified for target GenerateSatelliteAssemblies, skipping.
	
	Target CoreCompile:
		Tool /usr/lib/mono/4.5/vbnc.exe execution started with arguments: /noconfig /debug+ /out:obj/x86/Debug/Mono-Basic-Crasch.exe Application.vb AssemblyInfo.vb /target:exe /define:&quot;CONFIG=\&quot;Debug\&quot;,PLATFORM=\&quot;x86\&quot;&quot; /reference:/usr/lib/mono/4.0-api/System.dll /reference:/usr/lib/mono/4.0-api/System.Core.dll /rootnamespace:MonoBasicCrasch
		Visual Basic.Net Compiler version 0.0.0.5943 (Mono 4.6 - master/c93133d)
		Copyright (C) 2004-2010 Rolf Bjarne Kvinge. All rights reserved.
		vbnc : Command line : error VBNC99999: Unexpected error: Specified cast is not valid.
		at Mono.Cecil.SignatureWriter.WriteMarshalInfo (Mono.Cecil.MarshalInfo marshal_info) &lt;0x40da50d0 + 0x0016e&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.GetMarshalInfoSignature (IMarshalInfoProvider owner) &lt;0x40da4fe0 + 0x00043&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddMarshalInfo (IMarshalInfoProvider owner) &lt;0x40da4eb0 + 0x0004b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddField (Mono.Cecil.FieldDefinition field) &lt;0x40da4680 + 0x00153&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddFields (Mono.Cecil.TypeDefinition type) &lt;0x40da4600 + 0x0004b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddType (Mono.Cecil.TypeDefinition type) &lt;0x40d9c5f0 + 0x00193&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddNestedTypes (Mono.Cecil.TypeDefinition type) &lt;0x40da4030 + 0x00077&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddType (Mono.Cecil.TypeDefinition type) &lt;0x40d9c5f0 + 0x0023b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.AddTypeDefs () &lt;0x40d9c570 + 0x0004b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.BuildTypes () &lt;0x40d9b550 + 0x00033&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.BuildModule () &lt;0x40d98bd0 + 0x000e3&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.MetadataBuilder.BuildMetadata () &lt;0x40d98b80 + 0x0000f&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.ModuleWriter.BuildMetadata (Mono.Cecil.ModuleDefinition module, Mono.Cecil.MetadataBuilder metadata) &lt;0x40d98aa0 + 0x0002b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.ModuleWriter.WriteModuleTo (Mono.Cecil.ModuleDefinition module, System.IO.Stream stream, Mono.Cecil.WriterParameters parameters) &lt;0x40d93930 + 0x001b3&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.ModuleDefinition.Write (System.IO.Stream stream, Mono.Cecil.WriterParameters parameters) &lt;0x40d93840 + 0x00067&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.ModuleDefinition.Write (System.String fileName, Mono.Cecil.WriterParameters parameters) &lt;0x40d937b0 + 0x0004b&gt; in &lt;filename unknown&gt;:0
		at Mono.Cecil.AssemblyDefinition.Write (System.String fileName, Mono.Cecil.WriterParameters parameters) &lt;0x40d93770 + 0x0002f&gt; in &lt;filename unknown&gt;:0
		at vbnc.Compiler.Compile () &lt;0x40c75df0 + 0x01057&gt; in &lt;filename unknown&gt;:0
		Compilation took 00:00:00.6815140
/usr/lib/mono/4.5/Microsoft.VisualBasic.targets: error : Compiler crashed with code: 255.
	Task &quot;Vbc&quot; execution -- FAILED
	Done building target &quot;CoreCompile&quot; in project &quot;/home/larlin/Projects/Mono-Basic-Crasch/Mono-Basic-Crasch/Mono-Basic-Crasch.vbproj&quot;.-- FAILED
	
Done building project &quot;/home/larlin/Projects/Mono-Basic-Crasch/Mono-Basic-Crasch/Mono-Basic-Crasch.vbproj&quot;.-- FAILED

Build FAILED.
Errors:

---------------------- Done ----------------------

Build: 1 error, 0 warnings

-------------- next part --------------
ï»¿Imports System.Runtime.InteropServices

Public Class Application

  &lt;StructLayout(LayoutKind.Sequential, Pack:=1, CharSet:=CharSet.Ansi)&gt; _
  Public Structure CONFIG
    Public Position As Byte
    ' Comment the line below to make the example compile
    &lt;MarshalAs(UnmanagedType.ByValArray, SizeConst:=32)&gt; _
    Public Name() As Byte
  End Structure

	Public Shared Sub Main()
		System.Console.WriteLine(&quot;Hello world!&quot;)
	End Sub
End Class

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="001343.html">[mono-vb] VBNC crasch when using marshalAs on arrays in struct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1342">[ date ]</a>
              <a href="thread.html#1342">[ thread ]</a>
              <a href="subject.html#1342">[ subject ]</a>
              <a href="author.html#1342">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-vb">More information about the Mono-vb
mailing list</a><br>
</body></html>
