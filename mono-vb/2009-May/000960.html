<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-vb] VBNC30390 Compile Error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20VBNC30390%20Compile%20Error&In-Reply-To=4A0E43B1.4060205%40math.uiuc.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000959.html">
   <LINK REL="Next"  HREF="000975.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-vb] VBNC30390 Compile Error</H1>
    <B>John Lenz</B> 
    <A HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20VBNC30390%20Compile%20Error&In-Reply-To=4A0E43B1.4060205%40math.uiuc.edu"
       TITLE="[mono-vb] VBNC30390 Compile Error">jlenz2 at math.uiuc.edu
       </A><BR>
    <I>Sat May 16 01:22:16 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000959.html">[mono-vb] VBNC30390 Compile Error
</A></li>
        <LI>Next message: <A HREF="000975.html">[mono-vb] VBNC30390 Compile Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#960">[ date ]</a>
              <a href="thread.html#960">[ thread ]</a>
              <a href="subject.html#960">[ subject ]</a>
              <a href="author.html#960">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/15/2009 11:40 PM, John Lenz wrote:
&gt;<i> On 04/17/2009 09:25 AM, John Lenz wrote:
</I>&gt;&gt;<i> On 04/17/2009 03:09 AM, Rolf Bjarne Kvinge wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> When attempting to compile a large vb.net project here at work with
</I>&gt;&gt;&gt;&gt;<i> mono, I got a really weird error.  I was able to strip it down to the
</I>&gt;&gt;&gt;&gt;<i> attached file, the error comes about when there are two private
</I>&gt;&gt;&gt;&gt;<i> subclasses of some class.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I am using the mono-basic code from Mono 2.4, and I get the following
</I>&gt;&gt;&gt;&gt;<i> error.   The file compiles without errors in Visual Studio.  As I
</I>&gt;&gt;&gt;&gt;<i> mention
</I>&gt;&gt;&gt;&gt;<i> in the comment, changing Bar to a public class makes the file compile
</I>&gt;&gt;&gt;&gt;<i> without any errors.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Visual Basic.Net Compiler version 0.0.0.5914 (Mono 2.4 - r) Copyright
</I>&gt;&gt;&gt;&gt;<i> (C) 2004-2008 Rolf Bjarne Kvinge. All rights reserved.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> /home/john/test.vb (28,26) : Error VBNC30390: 'Bar.Testing' is not
</I>&gt;&gt;&gt;<i> accessible because it is 'Public'.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes, this is really weird.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> However you seem to have forgotten to attach the file ;-)
</I>&gt;&gt;&gt;<i>
</I>&gt;<i> The following patch against mono-basic-2.4 fixes the problem for me.
</I>&gt;<i> 
</I>
The patch I just sent introduces a new error for code like

Public Class Foo
   Public Class Bar
      Private Structure Baz
        Public Member As Integer
      End Structure

      Public Sub Test()
         Dim b As New Baz
         b.Member = 12
      End Sub
   End Class
End Class

(it needs three levels of nesting).  I introduced the error because
moving the check for IsNestedPrivate inside the loop removed the initial
check since the hierarchy starts at CallerType.DeclaringType instead of
CallerType.

The following patch fixes the original problem and still works for the
above example.

Index: mono-basic-2.4/vbnc/vbnc/source/General/Helper.vb
===================================================================
--- mono-basic-2.4.orig/vbnc/vbnc/source/General/Helper.vb	2009-05-16 00:04:57.000000000 -0500
+++ mono-basic-2.4/vbnc/vbnc/source/General/Helper.vb	2009-05-16 00:20:51.000000000 -0500
@@ -1981,8 +1981,14 @@

         'If the called type is not a nested type it is accessible.
         If CalledType.DeclaringType Is Nothing Then Return True
-        'If the called type is a private nested type it is inaccessible
-        If CalledType.IsNestedPrivate Then Return Helper.CompareType(CalledType.DeclaringType, CallerType)
+
+        'The caller can descend once into a private type, check if that is the case
+        If CalledType.IsNestedPrivate Then
+            'don't fail here, because could be the private nesting is further up the hierarchy
+            If Helper.CompareType(CalledType.DeclaringType, CallerType) Then
+                Return True
+            End If
+        End If

         'Add all the surrounding types of the caller type to a list.
         Dim callerHierarchy As New Generic.List(Of Type)
@@ -1996,6 +2002,10 @@
         Do Until tmpCaller Is Nothing
             If callerHierarchy.Contains(tmpCaller) Then
                 'We've reached a common surrounding type.
+
+                'The caller can descend once into a private type, check that here.
+                If CalledType.IsNestedPrivate Then Return Helper.CompareType(CalledType.DeclaringType, tmpCaller)
+
                 'No matter what accessibility level this type has
                 'it is accessible.
                 Return True
@@ -2007,6 +2017,9 @@
             tmpCaller = tmpCaller.DeclaringType
         Loop

+        'If the called type is a private nested type and the above checks failed, it is inaccessible
+        If CalledType.IsNestedPrivate Then Return Helper.CompareType(CalledType.DeclaringType, CallerType)
+
         'There is no common surrounding type, and the access level of all
         'surrounding types of the called types are non-private, so the type
         'is accessible.
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000959.html">[mono-vb] VBNC30390 Compile Error
</A></li>
	<LI>Next message: <A HREF="000975.html">[mono-vb] VBNC30390 Compile Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#960">[ date ]</a>
              <a href="thread.html#960">[ thread ]</a>
              <a href="subject.html#960">[ subject ]</a>
              <a href="author.html#960">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-vb">More information about the Mono-vb
mailing list</a><br>
</body></html>
