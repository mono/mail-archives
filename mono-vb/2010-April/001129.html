<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-vb] Default Indexers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20Default%20Indexers&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001130.html">
   <LINK REL="Next"  HREF="001131.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-vb] Default Indexers</H1>
    <B>John Lenz</B> 
    <A HREF="mailto:mono-vb%40lists.ximian.com?Subject=%5Bmono-vb%5D%20Default%20Indexers&In-Reply-To="
       TITLE="[mono-vb] Default Indexers">jlenz2 at math.uiuc.edu
       </A><BR>
    <I>Thu Apr  8 14:31:31 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="001130.html">[mono-vb] Multi-dim arrays of structures
</A></li>
        <LI>Next message: <A HREF="001131.html">[mono-vb] Default Indexers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

The following code gives me VBNC30471 while MS.NET compiles it fine.

Imports System.Data

Public Class Main

   Public Shared Sub Main()
       Dim reader As IDataReader
       Dim a As Object

       a = reader(0)
   End Sub

End Class


I traced the problem down to Helper.vb line 1560:

System.Attribute.GetCustomAttribute(Type, GetType(DefaultMemberAttribute), True)

When Type is System.Data.IDataReader this call returns Nothing.  The issue is that the default 
indexer is actually declared on IDataRecord, see

<A HREF="http://anonsvn.mono-project.com/viewvc/trunk/mcs/class/System.Data/System.Data/IDataReader.cs">http://anonsvn.mono-project.com/viewvc/trunk/mcs/class/System.Data/System.Data/IDataReader.cs</A>

<A HREF="http://anonsvn.mono-project.com/viewvc/trunk/mcs/class/System.Data/System.Data/IDataRecord.cs">http://anonsvn.mono-project.com/viewvc/trunk/mcs/class/System.Data/System.Data/IDataRecord.cs</A>

The problem is that if you look at the code for GetCustomAttribute it does not check base classes 
for the DefaultMemberAttribute even though you pass True.  (The inherit flag is reset to false in 
MonoCustomAttrs.cs::GetCustomAttributes() because the attribute does not have the 
AttributeUsage.Inherited flag).  Therefore when searching for the DefaultMemberAttribute on 
IDataReader nothing is found.

I looked at what gmcs does and the closest thing I could find is in expression.cs line 8411

<A HREF="http://anonsvn.mono-project.com/viewvc/trunk/mcs/mcs/expression.cs?revision=152858#l8411">http://anonsvn.mono-project.com/viewvc/trunk/mcs/mcs/expression.cs?revision=152858#l8411</A>

<A HREF="http://anonsvn.mono-project.com/viewvc/trunk/mcs/mcs/typemanager.cs?revision=152808#l2354">http://anonsvn.mono-project.com/viewvc/trunk/mcs/mcs/typemanager.cs?revision=152808#l2354</A>

Looking at the IndexerPropertyName() function in typemanager.cs, it seems like gmcs just uses a name 
of &quot;Item&quot; if it can't find anything.  I am not sure if that is the correct behavior for VB.
Perhaps we should just manually check base classes for DefaultMemberAttribute since 
GetCustomAttribute does not do it.  Something like

Dim defAttr  As Type = GetType(DefaultMemberAttribute)
attr = Attribute.GetCustomAttribute(Type, defAttr)

If attr Is Nothing Then

   For Each t As Type in Type.GetInterfaces()
      attr = Attribute.GetCustomAttribute(t, defAttr)
      If attr IsNot Nothing Then Exit For
   Next

End If

What do you think?

John
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001130.html">[mono-vb] Multi-dim arrays of structures
</A></li>
	<LI>Next message: <A HREF="001131.html">[mono-vb] Default Indexers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1129">[ date ]</a>
              <a href="thread.html#1129">[ thread ]</a>
              <a href="subject.html#1129">[ subject ]</a>
              <a href="author.html#1129">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-vb">More information about the Mono-vb
mailing list</a><br>
</body></html>
