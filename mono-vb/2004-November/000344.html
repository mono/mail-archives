<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> Fwd: [mono-vb] A few fixes for Visual Basic Class
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:kjambunathan%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000342.html">
   <LINK REL="Next"  HREF="000345.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Fwd: [mono-vb] A few fixes for Visual Basic Class
   </H1>
    <B>Jambunathan Jambunathan
    </B> 
    <A HREF="mailto:kjambunathan%40novell.com"
       TITLE="Fwd: [mono-vb] A few fixes for Visual Basic Class">kjambunathan@novell.com
       </A><BR>
    <I>Sat, 06 Nov 2004 04:29:50 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="000342.html">AW: [mono-vb] Test results
</A></li>
        <LI> Next message: <A HREF="000345.html">[mono-vb] Implementing
 Runtime.CompilerServices.LateBinding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#344">[ date ]</a>
              <a href="thread.html#344">[ thread ]</a>
              <a href="subject.html#344">[ subject ]</a>
              <a href="author.html#344">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ryan

My comments are in line -

&gt;<i> Index:
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/Conversion.cs
&gt;<i> ===================================================================
</I>&gt;<i> RCS file:
</I>/mono/mcs/class/Microsoft.VisualBasic/Microsoft.VisualBasic/Conversion.cs,v
&gt;<i> retrieving revision 1.12
</I>&gt;<i> diff -u -r1.12 Conversion.cs
</I>&gt;<i> ---
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/Conversion.cs	6
Sep 2004 11:23:11 -0000	1.12
&gt;<i> +++
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/Conversion.cs	27
Oct 2004 11:17:33 -0000
&gt;<i> @@ -700,7 +700,13 @@
</I>&gt;<i>  				throw new ArgumentNullException
</I>(&quot;Expression&quot;, 
&gt;<i>  					&quot;Value cannot be null&quot;);
</I>&gt;<i>  			}
</I>&gt;<i> -		
</I>&gt;<i> +			TypeCode TC = Type.GetTypeCode
</I>(Expression.GetType()); 
&gt;<i> +			if (TC != TypeCode.String) {
</I>&gt;<i> +				throw new ArgumentException(
</I>&gt;<i> +				&quot;Type of argument 'Expression' is '&quot; + 
</I>&gt;<i> +				Expression.GetType().FullName + 
</I>&gt;<i> +				&quot;', which can nt be converted to
</I>numeric.&quot;);			
&gt;<i> +			}
</I>&gt;<i>  			try {
</I>&gt;<i>  				return Val (CastToString (Expression));
</I>
&gt;<i>  			} 
</I>

This is wrong. Why are you checking that expression is of type string
? The documentation says &quot;If Expression is of type Object, its value
must be convertible to String or an ArgumentException error occurs.&quot;

With this fix, the following throws an exception in mono.

Dim I As Integer = 100
Dim D  As Double = Val (I)

&gt;<i> Index:
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/DateAndTime.cs
&gt;<i> ===================================================================
</I>&gt;<i> RCS file:
</I>/mono/mcs/class/Microsoft.VisualBasic/Microsoft.VisualBasic/DateAndTime.cs,v
&gt;<i> retrieving revision 1.13
</I>&gt;<i> diff -u -r1.13 DateAndTime.cs
</I>&gt;<i> ---
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/DateAndTime.cs	6
Sep 2004 13:47:44 -0000	1.13
&gt;<i> +++
</I>class/Microsoft.VisualBasic/Microsoft.VisualBasic/DateAndTime.cs	27
Oct 2004 11:17:33 -0000
&gt;<i> @@ -509,10 +509,11 @@
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public static System.DateTime TimeValue (string
</I>StringTime) 
&gt;<i> -		{ 
</I>&gt;<i> -			try {
</I>&gt;<i> -				return DateTime.MinValue +
</I>DateTime.Parse(StringTime).TimeOfDay;
&gt;<i> -			} catch (FormatException exception) {
</I>&gt;<i> +		{ 					
</I>&gt;<i> +			try {				
</I>&gt;<i> +				return DateTime.MinValue.Date +
</I>DateTime.Parse(StringTime).TimeOfDay;
&gt;<i> +			} 
</I>&gt;<i> +			catch (FormatException exception) {
</I>&gt;<i>  				throw new InvalidCastException(null,
</I>exception);
&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i> @@ -576,9 +577,9 @@
</I>&gt;<i>  			if (Weekday &lt; 1 || Weekday &gt; 7) {
</I>&gt;<i>  				throw new ArgumentException();
</I>&gt;<i>  			}
</I>&gt;<i> -			Weekday += (int)FirstDayOfWeekValue;
</I>&gt;<i> +			Weekday = Weekday -1  +
</I>(int)FirstDayOfWeekValue;
&gt;<i>  			if (Weekday &gt; 7) {
</I>&gt;<i> -				Weekday -= 7;
</I>&gt;<i> +				Weekday = Weekday -7;
</I>&gt;<i>  			}
</I>&gt;<i>  			if (Abbreviate) {
</I>&gt;<i>  				return
</I>CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedDayName((DayOfWeek)Weekday);


The above fix for WeekdayName is wrong. It either bahves badly or
throws exception in mono ! Try:

Console.WriteLine (&quot;6 th day of week starting with Tuesday is {0}&quot;,
WeekdayName (6,,FirstDayOfWeek.Tuesday))
Console.WriteLine (&quot;5 th day of week starting with Tuesday is  {0}&quot;,
WeekdayName (5,, FirstDayOfWeek.Tuesday))


&gt;<i> Index:
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/ConversionTest.cs
&gt;<i> ===================================================================
</I>&gt;<i> RCS file:
</I>/mono/mcs/class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/ConversionTest.cs,v
&gt;<i> retrieving revision 1.2
</I>&gt;<i> diff -u -r1.2 ConversionTest.cs
</I>&gt;<i> ---
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/ConversionTest.cs	24
Jun 2004 14:06:50 -0000	1.2
&gt;<i> +++
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/ConversionTest.cs	27
Oct 2004 11:17:34 -0000
&gt;<i> @@ -684,19 +684,24 @@
</I>&gt;<i>  				AssertEquals(&quot;#V06&quot;,
</I>typeof(OverflowException), e.GetType());
&gt;<i>  				caughtException = true;
</I>&gt;<i>  			}
</I>&gt;<i> -
</I>&gt;<i> -			AssertEquals(&quot;#V07&quot;, true, caughtException);
</I>&gt;<i> +			finally {
</I>&gt;<i> +				AssertEquals(&quot;#V07&quot;, true,
</I>caughtException);
&gt;<i> +			}
</I>&gt;<i>  
</I>&gt;<i>  			caughtException = false;
</I>&gt;<i>  
</I>&gt;<i>  			try {
</I>&gt;<i>  				Conversion.Val(typeof(int));
</I>&gt;<i>  			}
</I>&gt;<i> -			catch (Exception e) {
</I>&gt;<i> -				AssertEquals(&quot;#V08&quot;,
</I>typeof(ArgumentException), e.GetType());
&gt;<i> +			catch (Exception e) {
</I>&gt;<i>  				caughtException = true;
</I>&gt;<i> +				AssertEquals(&quot;#V08&quot;,
</I>typeof(ArgumentException), e.GetType());
&gt;<i> +								
</I>&gt;<i> +			}
</I>&gt;<i> +			finally {
</I>&gt;<i> +				AssertEquals(&quot;#V09&quot;, true,
</I>caughtException);
&gt;<i>  			}
</I>&gt;<i> -			AssertEquals(&quot;#V09&quot;, true, caughtException);
</I>&gt;<i> +			
</I>&gt;<i>  		}
</I>&gt;<i>  	}
</I>&gt;<i>  }
</I>

Will it not be more cleaner to use NUnit's [ExpectedException] ? 


&gt;<i> Index:
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/DateAndTimeTest.cs
&gt;<i> ===================================================================
</I>&gt;<i> RCS file:
</I>/mono/mcs/class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/DateAndTimeTest.cs,v
&gt;<i> retrieving revision 1.5
</I>&gt;<i> diff -u -r1.5 DateAndTimeTest.cs
</I>&gt;<i> ---
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/DateAndTimeTest.cs	24
Jun 2004 14:06:50 -0000	1.5
&gt;<i> +++
</I>class/Microsoft.VisualBasic/Test/Microsoft.VisualBasic/DateAndTimeTest.cs	27
Oct 2004 11:17:34 -0000
&gt;<i> @@ -129,12 +129,16 @@
</I>&gt;<i>  		public void TimeString() 
</I>&gt;<i>  		{
</I>&gt;<i>  			DateTime dtNow = DateTime.Now;
</I>&gt;<i> +			System.Threading.Thread.Sleep((int) 2);
</I>&gt;<i>  			TimeSpan tsNow = new TimeSpan(dtNow.Hour,
</I>dtNow.Minute, dtNow.Second);
&gt;<i> +			System.Threading.Thread.Sleep((int) 2);
</I>&gt;<i>  			string s = DateAndTime.TimeString;
</I>&gt;<i>  			DateTime dtTest = DateTime.Parse(s);
</I>&gt;<i>  			TimeSpan tsTest = new TimeSpan(dtTest.Hour,
</I>dtTest.Minute, dtTest.Second);
&gt;<i>  			DateTime dtNow2 = DateTime.Now;
</I>&gt;<i> +			System.Threading.Thread.Sleep((int) 2);
</I>&gt;<i>  			TimeSpan tsNow2 = new TimeSpan(dtNow2.Hour,
</I>dtNow2.Minute, dtNow2.Second);
&gt;<i> +			System.Threading.Thread.Sleep((int) 2);
</I>&gt;<i>  			
</I>&gt;<i>  			Assert(&quot;#TS01&quot;, tsTest.Ticks &gt;= tsNow.Ticks);
</I>&gt;<i>  			Assert(&quot;#TS02&quot;, tsNow2.Ticks &gt;= tsTest.Ticks);
</I>&gt;<i> @@ -286,12 +290,12 @@
</I>&gt;<i>  				DateAndTime.TimeSerial(0, -1440, -1);
</I>&gt;<i>  			}
</I>&gt;<i>  			catch (Exception e) {
</I>&gt;<i> -				AssertEquals(&quot;#TS01&quot;, e.GetType(),
</I>typeof(ArgumentOutOfRangeException));
&gt;<i> +				AssertEquals(&quot;#TSL01&quot;,
</I>typeof(ArgumentOutOfRangeException),  e.GetType());
&gt;<i>  				caughtException = true;
</I>&gt;<i>  			}
</I>&gt;<i> -			AssertEquals(&quot;#TS02&quot;, true, caughtException);
</I>&gt;<i> +			AssertEquals(&quot;#TSL02&quot;, true, caughtException);
</I>&gt;<i>  
</I>&gt;<i> -			AssertEquals(&quot;#TS03&quot;, new DateTime(1, 1, 1, 1,
</I>1, 1), DateAndTime.TimeSerial(1, 1, 1));
&gt;<i> +			AssertEquals(&quot;#TSL03&quot;, new DateTime(1, 1, 1, 1,
</I>1, 1), DateAndTime.TimeSerial(1, 1, 1));
&gt;<i>  				
</I>&gt;<i>  		}
</I>
By sleeping for a brief period aren't you making  the test less
stringent ?

&gt;<i>  		[Test]
</I>&gt;<i> @@ -415,9 +436,9 @@
</I>&gt;<i>  		{
</I>&gt;<i>  			DateTime jan1 = new DateTime(2001, 1, 1, 1, 1,
</I>1);
&gt;<i>  			AssertEquals(&quot;#WN01&quot;, &quot;Tue&quot;,
</I>&gt;<i>
</I>-				DateAndTime.WeekdayName((int)jan1.DayOfWeek
+ 1, true, FirstDayOfWeek.Monday));
&gt;<i> +				DateAndTime.WeekdayName(1, true,
</I>FirstDayOfWeek.Monday));
&gt;<i>  			AssertEquals(&quot;#WN02&quot;, &quot;Tuesday&quot;,
</I>&gt;<i>
</I>-				DateAndTime.WeekdayName((int)jan1.DayOfWeek
+ 1, false, FirstDayOfWeek.Monday));
&gt;<i> +				DateAndTime.WeekdayName(1, false,
</I>FirstDayOfWeek.Monday));
&gt;<i>  
</I>&gt;<i>  			bool caughtException = false;
</I>&gt;<i>  
</I>&gt;<i> @@ -441,7 +462,7 @@
</I>&gt;<i>  			}
</I>&gt;<i>  			AssertEquals(&quot;#WN06&quot;, true, caughtException);
</I>&gt;<i>  
</I>&gt;<i> -			AssertEquals(&quot;#WN07&quot;, &quot;Tuesday&quot;,
</I>DateAndTime.WeekdayName((int)jan1.DayOfWeek + 1, false,
FirstDayOfWeek.Monday));
&gt;<i> +			AssertEquals(&quot;#WN07&quot;, &quot;Tuesday&quot;,
</I>DateAndTime.WeekdayName((int)jan1.DayOfWeek + 1, false,
FirstDayOfWeek.Sunday));
&gt;<i>  		}
</I>&gt;<i>  	}
</I>&gt;<i>  }
</I>

The first test case is wrong.Shouldn't it assert for Monday ?

On the formatting front:

1) If you are editing the file on a Windows box make sure you do a
    dos2unix before submitting the file.

2) Always include a ChangeLog entry when you submit patches. It
    will help us understand what you have done in the patch.

Please repost the refined patch.

The next time you submit a patch make sure you verify the
correctness. It will save us a lot of time :-)

Regards,
Jambunathan K.

&gt;&gt;&gt;<i> &quot;Ryan L. Faircloth&quot; &lt;<A HREF="mailto:ryan@dss-i.com">ryan@dss-i.com</A>&gt; 10/27/04 4:51 PM &gt;&gt;&gt;
</I>
Some fixes were code some were test case issues. 

Let me know how these look if its the way you need them I will work on
more.



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000342.html">AW: [mono-vb] Test results
</A></li>
	<LI> Next message: <A HREF="000345.html">[mono-vb] Implementing
 Runtime.CompilerServices.LateBinding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#344">[ date ]</a>
              <a href="thread.html#344">[ thread ]</a>
              <a href="subject.html#344">[ subject ]</a>
              <a href="author.html#344">[ author ]</a>
         </LI>
       </UL>
</body></html>
