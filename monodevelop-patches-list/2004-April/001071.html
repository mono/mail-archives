<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r1464 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1464%20-%20trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001070.html">
   <LINK REL="Next"  HREF="001072.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r1464 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1464%20-%20trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r1464 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Thu Apr 15 19:02:26 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="001070.html">[Monodevelop-patches-list] r1463 - trunk/MonoDevelop/docs
</A></li>
        <LI>Next message: <A HREF="001072.html">[Monodevelop-patches-list] r1465 - in trunk/MonoDevelop: gdldock/sources/gdl src/AddIns/DisplayBindings/SourceEditor/CodeCompletion src/AddIns/DisplayBindings/SourceEditor/Gui src/Libraries/SharpRefactory/src/Parser/AST
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1071">[ date ]</a>
              <a href="thread.html#1071">[ thread ]</a>
              <a href="subject.html#1071">[ subject ]</a>
              <a href="author.html#1071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pawel
Date: 2004-04-15 19:02:26 -0400 (Thu, 15 Apr 2004)
New Revision: 1464

Modified:
   trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog
   trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs
Log:
NemerleBindingCompilerServices use Process.StandardOutput now


Modified: trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog
===================================================================
--- trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog	2004-04-15 01:15:32 UTC (rev 1463)
+++ trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog	2004-04-15 23:02:26 UTC (rev 1464)
@@ -1,3 +1,8 @@
+2004-04-16  Pawel Rozanski &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tokugawa at afn.no-ip.org</A>&gt;
+
+	* NemerleBindingCompilerServices.cs: without temp files now,
+	Process.StandardOutput based interface
+
 2004-04-14  Pawel Rozanski &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tokugawa at afn.no-ip.org</A>&gt;
 
 	* NemerleBindingCompilerServices.cs: uses the StatusBarService

Modified: trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs
===================================================================
--- trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs	2004-04-15 01:15:32 UTC (rev 1463)
+++ trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs	2004-04-15 23:02:26 UTC (rev 1464)
@@ -2,6 +2,7 @@
 using System.Diagnostics;
 using System.IO;
 using System.CodeDom.Compiler;
+using System.Threading;
 
 using MonoDevelop.Core.Services;
 using MonoDevelop.Internal.Project;
@@ -11,13 +12,64 @@
 namespace NemerleBinding
 {
 	public class NemerleBindingCompilerServices
-	{	
+	{
+		class CompilerResultsParser : CompilerResults
+		{
+			public CompilerResultsParser() : base (new TempFileCollection ())
+			{
+			}
+
+			public void Parse(string l)
+			{
+				if ((l.IndexOf(&quot;.n:&quot;) &lt; 0) &amp;&amp;
+					(l.IndexOf(&quot;:0:0:&quot;) &lt; 0))
+					return;				
+
+				CompilerError error = new CompilerError();
+
+				int s1 = l.IndexOf(':')+1;
+				int s2 = l.IndexOf(':',s1)+1;
+				int s3 = l.IndexOf(':',s2)+1;
+				int s4 = l.IndexOf(':',s3)+1;
+
+				error.FileName  = l.Substring(0, s1-1);
+				error.Line   	= Int32.Parse(l.Substring(s1, s2-s1-1));
+				error.Column    = Int32.Parse(l.Substring(s2, s3-s2-1));
+				error.ErrorNumber = String.Empty;
+				error.ErrorText = &quot;&quot;;
+				switch(l.Substring(s3+1, s4-s3-2))
+				{
+					case &quot;error&quot;:
+						error.IsWarning = false;
+						break;
+						case &quot;warning&quot;:
+						error.IsWarning = true;
+						break;
+					case &quot;hint&quot;:
+						error.IsWarning = true;
+						error.ErrorText = &quot;hint: &quot;;
+						break;
+					default:
+						error.IsWarning = false;
+						error.ErrorText = &quot;unknown: &quot;;
+						break;
+				}
+				error.ErrorText += l.Substring(s4+1);
+				Errors.Add(error);
+			}
+
+			public ICompilerResult GetResult()
+			{
+				return new DefaultCompilerResult(this, &quot;&quot;);
+			} 
+		}
+	
 		FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		static string ncc = &quot;ncc -q -no-color&quot;;
-		
+		static string ncc = &quot;ncc&quot;;
+
 		private string GetOptionsString(NemerleParameters cp)
 		{
-			string options = &quot;&quot;;
+			string options = &quot; -q -no-color&quot;;
 			if (cp.Nostdmacros)
 				options += &quot; -no-stdmacros&quot;;
 			if (cp.Nostdlib)
@@ -81,94 +133,69 @@
 			if (!Directory.Exists(cp.OutputPath))
 				Directory.CreateDirectory(cp.OutputPath);
 			
-			string outstr = ncc + GetOptionsString(cp) + references + files  + &quot; -o &quot; + GetCompiledOutputName(project);
-			string output = &quot;&quot;;
-			string error  = &quot;&quot;;
-			TempFileCollection  tf = new TempFileCollection ();		
-//			Executor.ExecWaitWithCapture(outstr, tf, ref error , ref output);
-			DoCompilation (outstr, tf, ref output, ref error);			
-			ICompilerResult cr = ParseOutput (tf, output);			
-			File.Delete(output);
-			File.Delete(error);
-			return cr;
+			string args = GetOptionsString(cp) + references + files  + &quot; -o &quot; + GetCompiledOutputName(project);
+			return DoCompilation (args);
 		}
 		
-		private void DoCompilation(string outstr, TempFileCollection tf, ref string output, ref string error)
+		// This enables check if we have output without blocking 
+		class VProcess : Process
 		{
-			output = Path.GetTempFileName();
-			error = Path.GetTempFileName();
-			
-			string arguments = outstr + &quot; &gt; &quot; + output + &quot; 2&gt; &quot; + error;
-			string command = arguments;
-			ProcessStartInfo si = new ProcessStartInfo(&quot;/bin/sh -c \&quot;&quot; + command + &quot;\&quot;&quot;);
+			Thread t = null;
+			public void thr()
+			{
+				while (StandardOutput.Peek() == -1){};
+			}
+			public void OutWatch()
+			{
+				t = new Thread(new ThreadStart(thr));
+				t.Start();
+			}
+			public bool HasNoOut()
+			{
+				return t.IsAlive;
+			} 
+		}
+		
+		private ICompilerResult DoCompilation(string arguments)
+		{
+			string l;
+			ProcessStartInfo si = new ProcessStartInfo(&quot;/bin/sh -c \&quot;&quot; + ncc + arguments + &quot;\&quot;&quot;);
 			si.RedirectStandardOutput = true;
 			si.RedirectStandardError = true;
 			si.UseShellExecute = false;
-			Process p = new Process();
+			VProcess p = new VProcess();
 			p.StartInfo = si;
 			p.Start();
 
 			IStatusBarService sbs = (IStatusBarService)ServiceManager.Services.GetService (typeof (IStatusBarService));
-			sbs.SetMessage (&quot;Compiling...&quot;); 
-			while (!p.HasExited) {
+			sbs.SetMessage (&quot;Compiling...&quot;);
+			
+			p.OutWatch();
+			while ((!p.HasExited) &amp;&amp; p.HasNoOut())
+//			while ((!p.HasExited) &amp;&amp; (p.StandardOutput.Peek() == -1)) // this could eliminate VProcess outgrowth
+			{
 				((SdStatusBar)sbs.ProgressMonitor).Pulse();
 				while (Gtk.Application.EventsPending ())
 					Gtk.Application.RunIteration ();
 				System.Threading.Thread.Sleep (100);
 			}
+			
+			CompilerResultsParser cr = new CompilerResultsParser();			
+			while ((l = p.StandardOutput.ReadLine()) != null)
+			{
+				((SdStatusBar)sbs.ProgressMonitor).Pulse();
+				while (Gtk.Application.EventsPending ())
+					Gtk.Application.RunIteration ();
+				cr.Parse(l);
+			}
 			((SdStatusBar)sbs.ProgressMonitor).Done();
-		}
-		
-		ICompilerResult ParseOutput(TempFileCollection tf, string file)
-		{
-			string compilerOutput = &quot;&quot;;
-			string l;		
-			StreamReader sr = new StreamReader(file, System.Text.Encoding.Default);
-			CompilerResults cr = new CompilerResults(tf);
 			
-			while ((l = sr.ReadLine())!=null) 
+			if  ((l = p.StandardError.ReadLine()) != null)
 			{
-				compilerOutput += l + &quot;\n&quot;;
-
-				if ((l.IndexOf(&quot;.n:&quot;) &lt; 0) &amp;&amp;
-					(l.IndexOf(&quot;:0:0:&quot;) &lt; 0))
-					continue;				
-
-				CompilerError error = new CompilerError();
-				
-				int s1 = l.IndexOf(':')+1;
-				int s2 = l.IndexOf(':',s1)+1;
-				int s3 = l.IndexOf(':',s2)+1;
-				int s4 = l.IndexOf(':',s3)+1;
-				
-				error.FileName  = l.Substring(0, s1-1);
-				error.Line   	= Int32.Parse(l.Substring(s1, s2-s1-1));
-				error.Column    = Int32.Parse(l.Substring(s2, s3-s2-1));
-				error.ErrorNumber = String.Empty;
-				error.ErrorText = &quot;&quot;;
-				switch(l.Substring(s3+1, s4-s3-2))
-				{
-					case &quot;error&quot;:
-						error.IsWarning = false;
-						break;
-					case &quot;warning&quot;:
-						error.IsWarning = true;
-						break;
-					case &quot;hint&quot;:
-						error.IsWarning = true;
-						error.ErrorText = &quot;hint: &quot;;
-						break;
-					default:
-						error.IsWarning = false;
-						error.ErrorText = &quot;unknown: &quot;;
-						break;
-				}
-				error.ErrorText += l.Substring(s4+1);
-				
-				cr.Errors.Add(error);
+				cr.Parse(&quot;:0:0: error: &quot; + ncc + &quot; execution problem&quot;);
 			}
-			sr.Close();			
-			return new DefaultCompilerResult(cr, compilerOutput);
+			
+			return cr.GetResult();
 		}
 	}
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001070.html">[Monodevelop-patches-list] r1463 - trunk/MonoDevelop/docs
</A></li>
	<LI>Next message: <A HREF="001072.html">[Monodevelop-patches-list] r1465 - in trunk/MonoDevelop: gdldock/sources/gdl src/AddIns/DisplayBindings/SourceEditor/CodeCompletion src/AddIns/DisplayBindings/SourceEditor/Gui src/Libraries/SharpRefactory/src/Parser/AST
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1071">[ date ]</a>
              <a href="thread.html#1071">[ thread ]</a>
              <a href="subject.html#1071">[ subject ]</a>
              <a href="author.html#1071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
