<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r1834 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1834%20-%20trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001440.html">
   <LINK REL="Next"  HREF="001442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r1834 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1834%20-%20trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r1834 - trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Fri Jun 25 20:43:13 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="001440.html">[Monodevelop-patches-list] r1833 - in trunk/MonoDevelop/src/Main/Base: . Services/Project
</A></li>
        <LI>Next message: <A HREF="001442.html">[Monodevelop-patches-list] r1835 - in trunk/md-website: . sonata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1441">[ date ]</a>
              <a href="thread.html#1441">[ thread ]</a>
              <a href="subject.html#1441">[ subject ]</a>
              <a href="author.html#1441">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pawel
Date: 2004-06-25 20:43:13 -0400 (Fri, 25 Jun 2004)
New Revision: 1834

Modified:
   trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog
   trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs
   trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleLanguageBinding.cs
Log:
Generate makefiles for Nemerle projects.


Modified: trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog
===================================================================
--- trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog	2004-06-26 00:06:14 UTC (rev 1833)
+++ trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/ChangeLog	2004-06-26 00:43:13 UTC (rev 1834)
@@ -1,3 +1,8 @@
+2004-06-26  Pawel Rozanski  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tokugawa at afn.no-ip.org</A>&gt;
+
+	* NemerleBindingCompilerServices.cs: add GenerateMakefile method.
+	* NemerleLanguageBinding.cs: runs GenerateMakefile
+
 2004-06-23  Pawel Rozanski  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tokugawa at afn.no-ip.org</A>&gt;
 
 	* NemerleBindingCompilerServices.cs: one line fix for ProcessStartInfo.

Modified: trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs
===================================================================
--- trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs	2004-06-26 00:06:14 UTC (rev 1833)
+++ trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleBindingCompilerServices.cs	2004-06-26 00:43:13 UTC (rev 1834)
@@ -1,4 +1,5 @@
 using System;
+using System.Collections;
 using System.Diagnostics;
 using System.IO;
 using System.CodeDom.Compiler;
@@ -81,7 +82,7 @@
 
 		private string GetOptionsString(NemerleParameters cp)
 		{
-			string options = &quot; -q -no-color&quot;;
+			string options = &quot; &quot;;
 			if (cp.Nostdmacros)
 				options += &quot; -no-stdmacros&quot;;
 			if (cp.Nostdlib)
@@ -99,17 +100,17 @@
 				
 			return options;			
 		}
-		
+
 		public bool CanCompile(string fileName)
 		{
 			return Path.GetExtension(fileName) == &quot;.n&quot;;
 		} 
-		
+
 		public ICompilerResult CompileFile(string fileName)
 		{
 			throw new ApplicationException(&quot;No CompileFile&quot;);
 		}
-		
+
 		public string GetCompiledOutputName(string fileName)
 		{
 			throw new ApplicationException(&quot;No CompileFile&quot;);
@@ -122,7 +123,7 @@
 			return fileUtilityService.GetDirectoryNameWithSeparator(cp.OutputDirectory)
 					+ cp.OutputAssembly + ((int)cp.Target == 0?&quot;.exe&quot;:&quot;.dll&quot;);
 		}
-		
+
 		public ICompilerResult CompileProject(IProject project)
 		{
 			NemerleParameters cp = (NemerleParameters)project.ActiveConfiguration;
@@ -145,7 +146,7 @@
 			if (!Directory.Exists(cp.OutputDirectory))
 				Directory.CreateDirectory(cp.OutputDirectory);
 			
-			string args = GetOptionsString(cp) + references + files  + &quot; -o &quot; + GetCompiledOutputName(project);
+			string args = &quot;-q -no-color &quot; + GetOptionsString(cp) + references + files  + &quot; -o &quot; + GetCompiledOutputName(project);
 			return DoCompilation (args);
 		}
 		
@@ -209,5 +210,214 @@
 			
 			return cr.GetResult();
 		}
+
+		public void GenerateMakefile (IProject project, Combine parentCombine)
+		{
+			StreamWriter stream = new StreamWriter (Path.Combine (project.BaseDirectory, &quot;Makefile.&quot; + project.Name.Replace (&quot; &quot;, &quot;&quot;)));
+
+			NemerleProject p = (NemerleProject)project;
+			NemerleParameters cp =(NemerleParameters)p.ActiveConfiguration;
+			
+			string outputName = Path.GetFileName(GetCompiledOutputName(project));
+
+			string relativeOutputDir = fileUtilityService.AbsoluteToRelativePath (project.BaseDirectory, parentCombine.OutputDirectory);
+
+			ArrayList compile_files = new ArrayList ();
+			ArrayList pkg_references = new ArrayList ();
+			ArrayList assembly_references = new ArrayList ();
+			ArrayList project_references = new ArrayList ();
+			ArrayList system_references = new ArrayList ();
+			
+			foreach (ProjectFile finfo in project.ProjectFiles) {
+				if (finfo.Subtype != Subtype.Directory) {
+					switch (finfo.BuildAction) {
+					case BuildAction.Compile:
+						string rel_path = fileUtilityService.AbsoluteToRelativePath (project.BaseDirectory, Path.GetDirectoryName (finfo.Name));
+						if (CanCompile (finfo.Name));
+						compile_files.Add (Path.Combine (rel_path, Path.GetFileName (finfo.Name)));
+						break;
+					}
+				}
+			}
+
+			SystemAssemblyService sas = (SystemAssemblyService)ServiceManager.GetService (typeof (SystemAssemblyService));
+			foreach (ProjectReference lib in project.ProjectReferences) {
+				switch (lib.ReferenceType) {
+				case ReferenceType.Gac:
+					string pkg = sas.GetPackageFromFullName (lib.Reference);
+					if (pkg == &quot;MONO-SYSTEM&quot;) {
+						system_references.Add (Path.GetFileName (lib.GetReferencedFileName (project)));
+					} else if (!pkg_references.Contains (pkg)) {
+						pkg_references.Add (pkg);
+					}
+					break;
+				case ReferenceType.Assembly:
+					string assembly_fileName = lib.GetReferencedFileName (project);
+					string rel_path_to = fileUtilityService.AbsoluteToRelativePath (project.BaseDirectory, Path.GetDirectoryName (assembly_fileName));
+					assembly_references.Add (Path.Combine (rel_path_to, Path.GetFileName (assembly_fileName)));
+					break;
+				case ReferenceType.Project:
+					string project_fileName = lib.GetReferencedFileName (project);
+					IProjectService prjService = (IProjectService)ServiceManager.GetService (typeof (IProjectService));
+					ArrayList allProjects = Combine.GetAllProjects(prjService.CurrentOpenCombine);
+					
+					foreach (ProjectCombineEntry projectEntry in allProjects) {
+						if (projectEntry.Project.Name == lib.Reference) {
+							string project_base_dir = fileUtilityService.AbsoluteToRelativePath (project.BaseDirectory, projectEntry.Project.BaseDirectory);
+							
+							string project_output_fileName = prjService.GetOutputAssemblyName (projectEntry.Project);
+							project_references.Add (Path.Combine (project_base_dir, Path.GetFileName (project_output_fileName)));
+						}
+					}
+					break;
+				}
+			}
+
+			stream.WriteLine (&quot;# This makefile is autogenerated by MonoDevelop&quot;);
+			stream.WriteLine (&quot;# Do not modify this file&quot;);
+			stream.WriteLine ();
+			stream.WriteLine (&quot;SOURCES = \\&quot;);
+			for (int i = 0; i &lt; compile_files.Count; i++) {
+				stream.Write (((string)compile_files[i]).Replace (&quot; &quot;, &quot;\\ &quot;));
+				if (i != compile_files.Count - 1)
+					stream.WriteLine (&quot; \\&quot;);
+				else
+					stream.WriteLine ();
+			}
+			stream.WriteLine ();
+
+			if (pkg_references.Count &gt; 0) {
+				stream.WriteLine (&quot;PKG_REFERENCES = \\&quot;);
+				for (int i = 0; i &lt; pkg_references.Count; i++) {
+					stream.Write (pkg_references[i]);
+					if (i != pkg_references.Count - 1)
+						stream.WriteLine (&quot; \\&quot;);
+					else
+						stream.WriteLine ();
+				}
+				
+				stream.WriteLine ();
+				stream.WriteLine (&quot;PKG_REFERENCES_BUILD = $(addprefix -pkg:, $(PKG_REFERENCES))&quot;);
+				stream.WriteLine ();
+				stream.WriteLine (&quot;PKG_REFERENCES_CHECK = $(addsuffix .pkgcheck, $(PKG_REFERENCES))&quot;);
+				stream.WriteLine ();
+			}
+			
+			if (system_references.Count &gt; 0) {
+				stream.WriteLine (&quot;SYSTEM_REFERENCES = \\&quot;);
+				for (int i = 0; i &lt; system_references.Count; i++) {
+					stream.Write (system_references[i]);
+					if (i != system_references.Count - 1)
+						stream.WriteLine (&quot; \\&quot;);
+					else
+						stream.WriteLine ();
+				}
+				stream.WriteLine ();
+				stream.WriteLine (&quot;SYSTEM_REFERENCES_BUILD = $(addprefix -r:, $(SYSTEM_REFERENCES))&quot;);
+				stream.WriteLine ();
+				stream.WriteLine (&quot;SYSTEM_REFERENCES_CHECK = $(addsuffix .check, $(SYSTEM_REFERENCES))&quot;);
+				stream.WriteLine ();
+			}
+
+			if (assembly_references.Count &gt; 0) {
+				stream.WriteLine (&quot;ASSEMBLY_REFERENCES = \\&quot;);
+				for (int i = 0; i &lt; assembly_references.Count; i++) {
+					stream.Write (&quot;\&quot;&quot; + assembly_references[i] + &quot;\&quot;&quot;);
+					if (i != assembly_references.Count - 1)
+						stream.WriteLine (&quot; \\&quot;);
+					else
+						stream.WriteLine ();
+				}
+				
+				stream.WriteLine ();
+				stream.WriteLine (&quot;ASSEMBLY_REFERENCES_BUILD = $(addprefix -r:, $(ASSEMBLY_REFERENCES))&quot;);
+				stream.WriteLine ();
+			}
+
+			if (project_references.Count &gt; 0) {
+				stream.WriteLine (&quot;PROJECT_REFERENCES = \\&quot;);
+				for (int i = 0; i &lt; project_references.Count; i++) {
+					stream.Write (&quot;\&quot;&quot; + project_references[i] + &quot;\&quot;&quot;);
+					if (i != project_references.Count - 1)
+						stream.WriteLine (&quot; \\&quot;);
+					else
+						stream.WriteLine ();
+				}
+				
+				stream.WriteLine ();
+				stream.WriteLine (&quot;PROJECT_REFERENCES_BUILD = $(addprefix -r:, $(PROJECT_REFERENCES))&quot;);
+				stream.WriteLine ();
+			}
+
+			stream.Write (&quot;NCC_OPTIONS = &quot; + GetOptionsString(cp));
+
+			stream.WriteLine ();
+			stream.WriteLine ();
+
+			stream.WriteLine (&quot;all: &quot; + outputName);
+			stream.WriteLine ();
+			
+			stream.WriteLine(outputName + &quot;: $(SOURCES)&quot;);
+			
+			stream.Write (&quot;\t{0} $(NCC_OPTIONS) -out:\&quot;{1}\&quot;&quot;, ncc, outputName);
+			if (pkg_references.Count &gt; 0) {
+				stream.Write (&quot; $(PKG_REFERENCES_BUILD)&quot;);
+			}
+			if (assembly_references.Count &gt; 0) {
+				stream.Write (&quot; $(ASSEMBLY_REFERENCES_BUILD)&quot;);
+			}
+			if (project_references.Count &gt; 0) {
+				stream.Write (&quot; $(PROJECT_REFERENCES_BUILD)&quot;);
+			}
+			if (system_references.Count &gt; 0) {
+				stream.Write (&quot; $(SYSTEM_REFERENCES_BUILD)&quot;);
+			}
+			stream.WriteLine (&quot; $(SOURCES) \\&quot;);
+			stream.WriteLine (&quot;\t&amp;&amp; cp \&quot;{0}\&quot; {1}/.&quot;, outputName, relativeOutputDir);
+			
+			stream.WriteLine ();
+			stream.WriteLine (&quot;clean:&quot;);
+			stream.WriteLine (&quot;\trm -f {0}&quot;, outputName);
+			stream.WriteLine ();
+			
+			stream.Write (&quot;depcheck: &quot;);
+			if (pkg_references.Count &gt; 0) {
+				stream.Write (&quot;PKG_depcheck &quot;);
+			}
+			if (system_references.Count &gt; 0) {
+				stream.Write (&quot;SYSTEM_depcheck&quot;);
+			}
+			stream.WriteLine ();
+			stream.WriteLine ();
+			if (pkg_references.Count &gt; 0) {
+				stream.WriteLine (&quot;PKG_depcheck: $(PKG_REFERENCES_CHECK)&quot;);
+				stream.WriteLine ();
+				stream.WriteLine (&quot;%.pkgcheck:&quot;);
+				stream.WriteLine (&quot;\<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">t at echo</A> -n Checking for package $(subst .pkgcheck,,$@)...&quot;);
+				stream.WriteLine (&quot;\<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">t at if</A> pkg-config --libs $(subst .pkgcheck,,$@) &amp;&gt; /dev/null; then \\&quot;);
+				stream.WriteLine (&quot;\t\techo yes; \\&quot;);
+				stream.WriteLine (&quot;\telse \\&quot;);
+				stream.WriteLine (&quot;\t\techo no; \\&quot;);
+				stream.WriteLine (&quot;\t\texit 1; \\&quot;);
+				stream.WriteLine (&quot;\tfi&quot;);
+				stream.WriteLine ();
+			}
+
+			if (system_references.Count &gt; 0) {
+				stream.WriteLine (&quot;SYSTEM_depcheck: $(SYSTEM_REFERENCES_CHECK)&quot;);
+				stream.WriteLine ();
+				stream.WriteLine (&quot;%.check:&quot;);
+				stream.WriteLine (&quot;\<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">t at echo</A> -n Checking for $(subst .check,,$@)...&quot;);
+				stream.WriteLine (&quot;\<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">t at if</A> [ ! -e `pkg-config --variable=libdir mono`/mono/1.0/$(subst .check,,$@) ]; then \\&quot;);
+				stream.WriteLine (&quot;\t\techo no; \\&quot;);
+				stream.WriteLine (&quot;\t\texit 1; \\&quot;);
+				stream.WriteLine (&quot;\telse \\&quot;);
+				stream.WriteLine (&quot;\t\techo yes; \\&quot;);
+				stream.WriteLine (&quot;\tfi&quot;);
+			}
+			
+			stream.Flush ();
+			stream.Close ();
+		}		
 	}
 }

Modified: trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleLanguageBinding.cs
===================================================================
--- trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleLanguageBinding.cs	2004-06-26 00:06:14 UTC (rev 1833)
+++ trunk/MonoDevelop/src/AddIns/BackendBindings/NemerleBinding/NemerleLanguageBinding.cs	2004-06-26 00:43:13 UTC (rev 1834)
@@ -78,7 +78,7 @@
 
 		public void GenerateMakefile (IProject project, Combine parentCombine)
 		{
-			throw new NotImplementedException ();
+			compilerServices.GenerateMakefile(project, parentCombine);
 		}
 	}
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001440.html">[Monodevelop-patches-list] r1833 - in trunk/MonoDevelop/src/Main/Base: . Services/Project
</A></li>
	<LI>Next message: <A HREF="001442.html">[Monodevelop-patches-list] r1835 - in trunk/md-website: . sonata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1441">[ date ]</a>
              <a href="thread.html#1441">[ thread ]</a>
              <a href="subject.html#1441">[ subject ]</a>
              <a href="author.html#1441">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
