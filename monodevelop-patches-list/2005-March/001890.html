<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2288 - in trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn: . Gui
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2288%20-%20in%20trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn%3A%20.%20Gui&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001889.html">
   <LINK REL="Next"  HREF="001891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2288 - in trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn: . Gui</H1>
    <B>Chris Toshok</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2288%20-%20in%20trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn%3A%20.%20Gui&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2288 - in trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn: . Gui">toshok at mono-cvs.ximian.com
       </A><BR>
    <I>Wed Mar  2 23:06:27 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001889.html">[Monodevelop-patches-list] r2287 - trunk/MonoDevelop/Unused/Gdl
</A></li>
        <LI>Next message: <A HREF="001891.html">[Monodevelop-patches-list] r2289 - trunk/MonoDevelop/Unused/Gdl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1890">[ date ]</a>
              <a href="thread.html#1890">[ thread ]</a>
              <a href="subject.html#1890">[ subject ]</a>
              <a href="author.html#1890">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: toshok
Date: 2005-03-02 23:06:27 -0500 (Wed, 02 Mar 2005)
New Revision: 2288

Modified:
   trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/ChangeLog
   trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/Gui/DebuggerVariablePad.cs
Log:
2005-03-02  Chris Toshok  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">toshok at ximian.com</A>&gt;

        * Gui/DebuggerVariablePad.cs (DebuggerVariablePad.ctor): add a
        field to the tree store so we can tell if a particular row
        expansion is for the Raw View.  Also, reorder the tree columns so
        that they're Name, Value, and Type.
        (DebuggerVariablePad.add_member): pass false for @raw_view in both
        add_class and add_struct.
        (DebuggerVariablePad.add_struct): add handling for
        DebuggerTypeProxyAttribute here.  we currently create the proxy
        object in the inferior, but I'm not sure if we should be doing
        that or create it in the debugger's address space.  Also only do
        the debugger proxy stuff if @raw_view == false.  if it's == true,
        expand as usual. When creating the Raw View row, set it's
        RAW_VIEW_COL to true.
        (DebuggerVariablePad.test_expand_row): get the value from
        RAW_VIEW_COL and pass that along to add_struct/add_class.
        (DebuggerVariablePad.GetDebuggerTypeProxyAttribute): new function.
        (DebuggerVariablePad.add_object): deal with a null ITargetObject.
        Also, use ITargetObject.PrintObject to call the object's
        ToString() method if a DebuggerDisplay attribute isn't specified
        - this doesn't work yet, as the mono debugger backend has it
        stubbed out.



Modified: trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/ChangeLog	2005-03-03 02:13:46 UTC (rev 2287)
+++ trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/ChangeLog	2005-03-03 04:06:27 UTC (rev 2288)
@@ -1,3 +1,27 @@
+2005-03-02  Chris Toshok  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">toshok at ximian.com</A>&gt;
+
+	* Gui/DebuggerVariablePad.cs (DebuggerVariablePad.ctor): add a
+	field to the tree store so we can tell if a particular row
+	expansion is for the Raw View.  Also, reorder the tree columns so
+	that they're Name, Value, and Type.
+	(DebuggerVariablePad.add_member): pass false for @raw_view in both
+	add_class and add_struct.
+	(DebuggerVariablePad.add_struct): add handling for
+	DebuggerTypeProxyAttribute here.  we currently create the proxy
+	object in the inferior, but I'm not sure if we should be doing
+	that or create it in the debugger's address space.  Also only do
+	the debugger proxy stuff if @raw_view == false.  if it's == true,
+	expand as usual. When creating the Raw View row, set it's
+	RAW_VIEW_COL to true.
+	(DebuggerVariablePad.test_expand_row): get the value from
+	RAW_VIEW_COL and pass that along to add_struct/add_class.
+	(DebuggerVariablePad.GetDebuggerTypeProxyAttribute): new function.
+	(DebuggerVariablePad.add_object): deal with a null ITargetObject.
+	Also, use ITargetObject.PrintObject to call the object's
+	ToString() method if a DebuggerDisplay attribute isn't specified
+	- this doesn't work yet, as the mono debugger backend has it
+	stubbed out.
+
 2005-03-01  Chris Toshok  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">toshok at ximian.com</A>&gt;
 
 	* Gui/DebuggerVariablePad.cs (DebuggerVariablePad.add_member):

Modified: trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/Gui/DebuggerVariablePad.cs
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/Gui/DebuggerVariablePad.cs	2005-03-03 02:13:46 UTC (rev 2287)
+++ trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn/Gui/DebuggerVariablePad.cs	2005-03-03 04:06:27 UTC (rev 2288)
@@ -26,6 +26,11 @@
 		Gtk.TreeStore store;
 		bool is_locals_display;
 
+		const int NAME_COL = 0;
+		const int VALUE_COL = 1;
+		const int TYPE_COL = 2;
+		const int RAW_VIEW_COL = 3;
+
 		public DebuggerVariablePad (bool is_locals_display)
 		{
 			this.ShadowType = ShadowType.In;
@@ -34,7 +39,8 @@
 
 			store = new TreeStore (typeof (string),
 					       typeof (string),
-			                       typeof (string));
+			                       typeof (string),
+					       typeof (bool));
 
 			tree = new TreeView (store);
 			tree.RulesHint = true;
@@ -44,29 +50,29 @@
 			CellRenderer NameRenderer = new CellRendererText ();
 			NameCol.Title = &quot;Name&quot;;
 			NameCol.PackStart (NameRenderer, true);
-			NameCol.AddAttribute (NameRenderer, &quot;text&quot;, 0);
+			NameCol.AddAttribute (NameRenderer, &quot;text&quot;, NAME_COL);
 			NameCol.Resizable = true;
 			NameCol.Alignment = 0.0f;
 			tree.AppendColumn (NameCol);
 
+			TreeViewColumn ValueCol = new TreeViewColumn ();
+			CellRenderer ValueRenderer = new CellRendererText ();
+			ValueCol.Title = &quot;Value&quot;;
+			ValueCol.PackStart (ValueRenderer, true);
+			ValueCol.AddAttribute (ValueRenderer, &quot;text&quot;, VALUE_COL);
+			ValueCol.Resizable = true;
+			NameCol.Alignment = 0.0f;
+			tree.AppendColumn (ValueCol);
+
 			TreeViewColumn TypeCol = new TreeViewColumn ();
 			CellRenderer TypeRenderer = new CellRendererText ();
 			TypeCol.Title = &quot;Type&quot;;
 			TypeCol.PackStart (TypeRenderer, true);
-			TypeCol.AddAttribute (TypeRenderer, &quot;text&quot;, 1);
+			TypeCol.AddAttribute (TypeRenderer, &quot;text&quot;, TYPE_COL);
 			TypeCol.Resizable = true;
 			NameCol.Alignment = 0.0f;
 			tree.AppendColumn (TypeCol);
 
-			TreeViewColumn ValueCol = new TreeViewColumn ();
-			CellRenderer ValueRenderer = new CellRendererText ();
-			ValueCol.Title = &quot;Value&quot;;
-			ValueCol.PackStart (ValueRenderer, true);
-			ValueCol.AddAttribute (ValueRenderer, &quot;text&quot;, 2);
-			ValueCol.Resizable = true;
-			NameCol.Alignment = 0.0f;
-			tree.AppendColumn (ValueCol);
-
 			tree.TestExpandRow += new TestExpandRowHandler (test_expand_row);
 
 			Add (tree);
@@ -143,7 +149,7 @@
 							break;
 						case TargetObjectKind.Class:
 							try {
-								add_class (parent, (ITargetClassObject)member_obj);
+								add_class (parent, (ITargetClassObject)member_obj, false);
 								inserted = true;
 							}
 							catch {
@@ -153,7 +159,7 @@
 							break;
 						case TargetObjectKind.Struct:
 							try {
-								add_struct (parent, (ITargetStructObject)member_obj);
+								add_struct (parent, (ITargetStructObject)member_obj, false);
 								inserted = true;
 							}
 							catch {
@@ -178,10 +184,56 @@
 			return inserted;
 		}
 
-		bool add_struct (TreeIter parent, ITargetStructObject sobj)
+		bool add_struct (TreeIter parent, ITargetStructObject sobj, bool raw_view)
 		{
 			bool inserted = false;
 
+#if NET_2_0
+			if (!raw_view) {
+				DebuggerTypeProxyAttribute pattr = GetDebuggerTypeProxyAttribute (sobj);
+				if (pattr != null) {
+					DebuggingService dbgr = (DebuggingService)ServiceManager.GetService (typeof (DebuggingService));
+					Mono.Debugger.StackFrame frame = dbgr.MainThread.CurrentFrame;
+	 				ITargetStructType proxy_type = frame.Language.LookupType (frame, pattr.ProxyTypeName) as ITargetStructType;
+					if (proxy_type == null)
+						proxy_type = frame.Language.LookupType (frame,
+											sobj.Type.Name + &quot;+&quot; + pattr.ProxyTypeName) as ITargetStructType;
+					if (proxy_type != null) {
+						string name = String.Format (&quot;.ctor({0})&quot;, sobj.Type.Name);
+						ITargetMethodInfo method = null;
+
+						foreach (ITargetMethodInfo m in proxy_type.Constructors) {
+							Console.WriteLine (&quot;   &quot; + m.FullName);
+							if (m.FullName == name)
+								method = m;
+						}
+
+						if (method != null) {
+							ITargetFunctionObject ctor = proxy_type.GetConstructor (frame, method.Index);
+							ITargetObject[] args = new ITargetObject[1];
+							args[0] = sobj;
+
+							ITargetStructObject proxy_obj = ctor.Type.InvokeStatic (frame, args, false) as ITargetStructObject;
+
+							if (proxy_obj != null) {
+								foreach (ITargetPropertyInfo prop in proxy_obj.Type.Properties) {
+									if (add_member (parent, proxy_obj, prop, false))
+										inserted = true;
+								}
+
+								TreeIter iter = store.Append (parent);
+								store.SetValue (iter, NAME_COL, new GLib.Value (&quot;Raw View&quot;));
+								store.SetValue (iter, RAW_VIEW_COL, new GLib.Value (true));
+								add_data (sobj, iter);
+
+								return true;
+							}
+						}
+					}
+				}
+			}
+#endif
+
 			foreach (ITargetFieldInfo field in sobj.Type.Fields) {
 				if (add_member (parent, sobj, field, true))
 					inserted = true;
@@ -195,7 +247,7 @@
 			return inserted;
 		}
 
-		bool add_class (TreeIter parent, ITargetClassObject sobj)
+		bool add_class (TreeIter parent, ITargetClassObject sobj, bool raw_view)
 		{
 			bool inserted = false;
 
@@ -205,7 +257,7 @@
 				inserted = true;
 			}
 
-			if (add_struct (parent, sobj))
+			if (add_struct (parent, sobj, raw_view))
 				inserted = true;
 
 			return inserted;
@@ -220,7 +272,7 @@
 			}
 
 			TreeIter iter = store.Append (parent);
-			store.SetValue (iter, 2, new GLib.Value (message));
+			store.SetValue (iter, VALUE_COL, new GLib.Value (message));
 		}
 
 		void test_expand_row (object o, TestExpandRowArgs args)
@@ -256,8 +308,10 @@
 			case TargetObjectKind.Class:
 				ITargetClassObject cobj = (ITargetClassObject) obj;
 				try {
-					inserted = add_class (args.Iter, cobj);
-				} catch {
+					bool raw_view = (bool)store.GetValue (args.Iter, RAW_VIEW_COL);
+					inserted = add_class (args.Iter, cobj, raw_view);
+				} catch (Exception e) {
+				  Console.WriteLine (e);
 					add_message (args.Iter, &quot;&lt;can't display class&gt;&quot;);
 					inserted = true;
 				}
@@ -268,7 +322,8 @@
 			case TargetObjectKind.Struct:
 				ITargetStructObject sobj = (ITargetStructObject) obj;
 				try {
-					inserted = add_struct (args.Iter, sobj);
+					bool raw_view = (bool)store.GetValue (args.Iter, RAW_VIEW_COL);
+					inserted = add_struct (args.Iter, sobj, raw_view);
 				} catch {
 					add_message (args.Iter, &quot;&lt;can't display struct&gt;&quot;);
 					inserted = true;
@@ -303,6 +358,19 @@
 			return null;
 		}
 
+		DebuggerTypeProxyAttribute GetDebuggerTypeProxyAttribute (ITargetObject obj)
+		{
+			if (obj.TypeInfo.Type.TypeHandle != null &amp;&amp; obj.TypeInfo.Type.TypeHandle is Type) {
+				Type t = (Type)obj.TypeInfo.Type.TypeHandle;
+				object[] attrs = t.GetCustomAttributes (typeof (DebuggerTypeProxyAttribute), false);
+
+				if (attrs != null &amp;&amp; attrs.Length &gt; 0)
+					return (DebuggerTypeProxyAttribute)attrs[0];
+			}
+
+			return null;
+		}
+
 		DebuggerDisplayAttribute GetDebuggerDisplayAttribute (ITargetObject obj)
 		{
 			if (obj.TypeInfo.Type.TypeHandle != null &amp;&amp; obj.TypeInfo.Type.TypeHandle is Type) {
@@ -390,25 +458,43 @@
 		void add_object (ITargetObject obj, string name, TreeIter iter)
 		{
 			AmbienceService amb = (AmbienceService)MonoDevelop.Core.Services.ServiceManager.GetService (typeof (AmbienceService));
-			store.SetValue (iter, 0, new GLib.Value (name));
-			store.SetValue (iter, 1, new GLib.Value (amb.CurrentAmbience.GetIntrinsicTypeName (obj.TypeInfo.Type.Name)));
 
+			store.SetValue (iter, NAME_COL, new GLib.Value (name));
+			if (obj == null) {
+				store.SetValue (iter, VALUE_COL, new GLib.Value (&quot;null&quot;));
+				return;
+			}
+			store.SetValue (iter, TYPE_COL, new GLib.Value (amb.CurrentAmbience.GetIntrinsicTypeName (obj.TypeInfo.Type.Name)));
+
 			switch (obj.TypeInfo.Type.Kind) {
 			case TargetObjectKind.Fundamental:
 				object contents = ((ITargetFundamentalObject) obj).Object;
-				store.SetValue (iter, 2, new GLib.Value (contents.ToString ()));
+				store.SetValue (iter, VALUE_COL, new GLib.Value (contents.ToString ()));
 				break;
-
 			case TargetObjectKind.Array:
 				add_data (obj, iter);
 				break;
 			case TargetObjectKind.Struct:
 			case TargetObjectKind.Class:
 #if NET_2_0
-				DebuggerDisplayAttribute dattr = GetDebuggerDisplayAttribute (obj);
-				if (dattr != null)
-					store.SetValue (iter, 2,
-							new GLib.Value (EvaluateDebuggerDisplay (obj, dattr.Value)));
+				try {
+					DebuggerDisplayAttribute dattr = GetDebuggerDisplayAttribute (obj);
+					if (dattr != null) {
+						store.SetValue (iter, VALUE_COL,
+								new GLib.Value (EvaluateDebuggerDisplay (obj, dattr.Value)));
+					}
+					else {
+						// call the object's ToString() method and stuff that in the Value field
+						store.SetValue (iter, VALUE_COL,
+								new GLib.Value (((ITargetStructObject)obj).PrintObject()));
+					}
+				}
+				catch (Exception e) {
+					Console.WriteLine (&quot;getting object value failed: {0}&quot;, e);
+
+					store.SetValue (iter, VALUE_COL,
+							new GLib.Value (&quot;&quot;));
+				}
 #endif
 				add_data (obj, iter);
 				break;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001889.html">[Monodevelop-patches-list] r2287 - trunk/MonoDevelop/Unused/Gdl
</A></li>
	<LI>Next message: <A HREF="001891.html">[Monodevelop-patches-list] r2289 - trunk/MonoDevelop/Unused/Gdl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1890">[ date ]</a>
              <a href="thread.html#1890">[ thread ]</a>
              <a href="subject.html#1890">[ subject ]</a>
              <a href="author.html#1890">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
