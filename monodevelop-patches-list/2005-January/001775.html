<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2171 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Gui Gui/Workbench Internal/Templates/ProjectTemplates Services/File Services/Project
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2171%20-%20in%20trunk/MonoDevelop/Core/src/MonoDevelop.Base%3A%20.%20Gui%20Gui/Workbench%20Internal/Templates/ProjectTemplates%20Services/File%20Services/Project&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001774.html">
   <LINK REL="Next"  HREF="001776.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2171 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Gui Gui/Workbench Internal/Templates/ProjectTemplates Services/File Services/Project</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2171%20-%20in%20trunk/MonoDevelop/Core/src/MonoDevelop.Base%3A%20.%20Gui%20Gui/Workbench%20Internal/Templates/ProjectTemplates%20Services/File%20Services/Project&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2171 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Gui Gui/Workbench Internal/Templates/ProjectTemplates Services/File Services/Project">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Wed Jan 26 19:33:22 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001774.html">[Monodevelop-patches-list] r2170 - in trunk/MonoDevelop/Core/src/MonoDevelop.Gui.Widgets: . Tree
</A></li>
        <LI>Next message: <A HREF="001776.html">[Monodevelop-patches-list] r2172 - in trunk/MonoDevelop: . Core/src/AddIns/DisplayBindings/SourceEditor Core/src/AddIns/DisplayBindings/SourceEditor/Gui Core/src/MonoDevelop.Base Core/src/MonoDevelop.Base/Gui/BrowserDisplayBinding Core/src/MonoDevelop.Base/Services/DisplayBinding Core/src/MonoDevelop.Base/Services/File Core/src/MonoDevelop.Gui.Utils Core/src/MonoDevelop.Gui.Widgets Core/src/MonoDevelop.Gui.Widgets/FileBrowser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1775">[ date ]</a>
              <a href="thread.html#1775">[ thread ]</a>
              <a href="subject.html#1775">[ subject ]</a>
              <a href="author.html#1775">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: lluis
Date: 2005-01-26 19:33:22 -0500 (Wed, 26 Jan 2005)
New Revision: 2171

Modified:
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Templates/ProjectTemplates/ProjectTemplate.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/DefaultProjectService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs
Log:
2005-01-27  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;

	* Gui/IWorkbench.cs:
	* Gui/Workbench/DefaultWorkbench.cs:
	* Services/File/IFileService.cs: 
	* Services/File/DefaultFileService.cs: Added BringToFront parameter
	in OpenFile.
	
	* IProjectService.cs:
	* Services/Project/DefaultProjectService.cs: Return IAsyncOperation
	in OpenCombine, so the load operation can be controlled.
	Use the new BringToFront parameter set to false when opening the
	files of a combine. No more window dances.
	
	* Internal/Templates/ProjectTemplates/ProjectTemplate.cs: Wait for
	the combine to be completely loaded before opening the project
	files. This fixes #61028.



Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog	2005-01-27 00:33:22 UTC (rev 2171)
@@ -1,3 +1,21 @@
+2005-01-27  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
+
+	* Gui/IWorkbench.cs:
+	* Gui/Workbench/DefaultWorkbench.cs:
+	* Services/File/IFileService.cs: 
+	* Services/File/DefaultFileService.cs: Added BringToFront parameter
+	in OpenFile.
+	
+	* IProjectService.cs:
+	* Services/Project/DefaultProjectService.cs: Return IAsyncOperation
+	in OpenCombine, so the load operation can be controlled.
+	Use the new BringToFront parameter set to false when opening the
+	files of a combine. No more window dances.
+	
+	* Internal/Templates/ProjectTemplates/ProjectTemplate.cs: Wait for
+	the combine to be completely loaded before opening the project
+	files. This fixes #61028.
+
 2005-01-26  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
 
 	* Services/Tasks/StatusProgressMonitor.cs: Forgot to save the

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -58,7 +58,7 @@
 		/// &lt;summary&gt;
 		/// Inserts a new &lt;see cref=&quot;IViewContent&quot;/&gt; object in the workspace.
 		/// &lt;/summary&gt;
-		void ShowView(IViewContent content);
+		void ShowView (IViewContent content, bool bringToFront);
 		
 		/// &lt;summary&gt;
 		/// Inserts a new &lt;see cref=&quot;IPadContent&quot;/&gt; object in the workspace.

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -267,7 +267,7 @@
 			}
 		}
 		
-		public virtual void ShowView(IViewContent content)
+		public virtual void ShowView (IViewContent content, bool bringToFront)
 		{
 			Debug.Assert(layout != null);
 			ViewContentCollection.Add(content);
@@ -284,7 +284,9 @@
 			
 			layout.ShowView(content);
 			
-			content.WorkbenchWindow.SelectWindow();
+			if (bringToFront)
+				content.WorkbenchWindow.SelectWindow();
+
 			ShowAll ();
 			RedrawAllComponents ();
 		}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Templates/ProjectTemplates/ProjectTemplate.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Templates/ProjectTemplates/ProjectTemplate.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Templates/ProjectTemplates/ProjectTemplate.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -194,10 +194,11 @@
 		
 		public void OpenCreatedCombine()
 		{
-			Runtime.ProjectService.OpenCombine(lastCombine);
-			
-			foreach (OpenFileAction action in actions) {
-				action.Run(projectCreateInformation);
+			IAsyncOperation op = Runtime.ProjectService.OpenCombine (lastCombine);
+			op.WaitForCompleted ();
+			if (op.Success) {
+				foreach (OpenFileAction action in actions)
+					action.Run(projectCreateInformation);
 			}
 		}
 

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -29,6 +29,7 @@
 		{
 			public FileOpeningFinished OnFileOpened;
 			public string FileName;
+			public bool BringToFront;
 		}
 		
 		public RecentOpen RecentOpen {
@@ -52,14 +53,17 @@
 		{
 			IDisplayBinding binding;
 			Project project;
+			bool select;
 			
-			public LoadFileWrapper(IDisplayBinding binding)
+			public LoadFileWrapper(IDisplayBinding binding, bool select)
 			{
+				this.select = select;
 				this.binding = binding;
 			}
 			
-			public LoadFileWrapper(IDisplayBinding binding, Project project)
+			public LoadFileWrapper(IDisplayBinding binding, Project project, bool select)
 			{
+				this.select = select;
 				this.binding = binding;
 				this.project = project;
 			}
@@ -72,23 +76,34 @@
 					newContent.HasProject = true;
 					newContent.Project = project;
 				}
-				WorkbenchSingleton.Workbench.ShowView(newContent);
+				WorkbenchSingleton.Workbench.ShowView (newContent, select);
 				Runtime.Gui.DisplayBindings.AttachSubWindows(newContent.WorkbenchWindow);
 			}
 		}
 		
 		public void OpenFile (string fileName)
 		{
+			OpenFile (fileName, true);
+		}
+		
+		public void OpenFile (string fileName, bool bringToFront)
+		{
 			FileInformation openFileInfo=new FileInformation();
 			openFileInfo.OnFileOpened=null;
 			openFileInfo.FileName=fileName;
+			openFileInfo.BringToFront = bringToFront;
 			Runtime.DispatchService.GuiDispatch (new StatefulMessageHandler (realOpenFile), openFileInfo);
 		}
 
-		public void OpenFile (string fileName, FileOpeningFinished OnFileOpened){
+		public void OpenFile (string fileName, FileOpeningFinished OnFileOpened) {
+			OpenFile (fileName, true, OnFileOpened);
+		}
+		
+		public void OpenFile (string fileName, bool bringToFront, FileOpeningFinished OnFileOpened){
 			FileInformation openFileInfo=new FileInformation();
 			openFileInfo.OnFileOpened=OnFileOpened;
 			openFileInfo.FileName=fileName;
+			openFileInfo.BringToFront = bringToFront;
 			Runtime.DispatchService.GuiDispatch (new StatefulMessageHandler (realOpenFile), openFileInfo);
 		}
 		
@@ -154,13 +169,13 @@
 				
 				if (combine != null &amp;&amp; project != null)
 				{
-					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate(new LoadFileWrapper(binding, project).Invoke), fileName) == FileOperationResult.OK) {
+					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate(new LoadFileWrapper(binding, project, oFileInfo.BringToFront).Invoke), fileName) == FileOperationResult.OK) {
 						Runtime.FileService.RecentOpen.AddLastFile (fileName, project.Name);
 					}
 				}
 				else
 				{
-					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate(new LoadFileWrapper(binding, null).Invoke), fileName) == FileOperationResult.OK) {
+					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate(new LoadFileWrapper(binding, null, oFileInfo.BringToFront).Invoke), fileName) == FileOperationResult.OK) {
 						Runtime.FileService.RecentOpen.AddLastFile (fileName, null);
 					}
 				}
@@ -174,7 +189,7 @@
 						Gnome.Url.Show (&quot;<A HREF="file://&quot;">file://&quot;</A> + fileName);
 					}
 				} catch {
-					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate (new LoadFileWrapper (Runtime.Gui.DisplayBindings.LastBinding, null).Invoke), fileName) == FileOperationResult.OK) {
+					if (Runtime.FileUtilityService.ObservedLoad(new NamedFileOperationDelegate (new LoadFileWrapper (Runtime.Gui.DisplayBindings.LastBinding, null, oFileInfo.BringToFront).Invoke), fileName) == FileOperationResult.OK) {
 						Runtime.FileService.RecentOpen.AddLastFile (fileName, null);
 					}
 				}
@@ -208,7 +223,7 @@
 				}
 				newContent.UntitledName = defaultName;
 				newContent.IsDirty      = false;
-				WorkbenchSingleton.Workbench.ShowView(newContent);
+				WorkbenchSingleton.Workbench.ShowView(newContent, true);
 				
 				Runtime.Gui.DisplayBindings.AttachSubWindows(newContent.WorkbenchWindow);
 			} else {

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -33,10 +33,11 @@
 		/// Opens the file fileName in SharpDevelop (shows the file in
 		/// the workbench window)
 		/// &lt;/remarks&gt;
-		void OpenFile(string fileName);
+		void OpenFile (string fileName);
+		void OpenFile (string fileName, bool bringToFront);
+		void OpenFile (string fileName, FileOpeningFinished onFileOpened);
+		void OpenFile (string fileName, bool bringToFront, FileOpeningFinished onFileOpened);
 		
-		void OpenFile(string fileName, FileOpeningFinished onFileOpened);
-		
 		/// &lt;remarks&gt;
 		/// Opens a new file with a given name, language and file content
 		/// in the workbench window.

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/DefaultProjectService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/DefaultProjectService.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/DefaultProjectService.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -205,7 +205,7 @@
 			return format != null;
 		}
 		
-		public void OpenCombine(string filename)
+		public IAsyncOperation OpenCombine(string filename)
 		{
 			if (openCombine != null) {
 				SaveCombine();
@@ -215,25 +215,32 @@
 			if (filename.StartsWith (&quot;<A HREF="file://&quot;">file://&quot;</A>))
 				filename = filename.Substring (7);
 
-			Runtime.DispatchService.BackgroundDispatch (new StatefulMessageHandler (backgroundLoadCombine), filename);
+			IProgressMonitor monitor = Runtime.TaskService.GetLoadProgressMonitor ();
+			
+			object[] data = new object[] { filename, monitor };
+			Runtime.DispatchService.BackgroundDispatch (new StatefulMessageHandler (backgroundLoadCombine), data);
+			return monitor.AsyncOperation;
 		}
-
+		
 		void backgroundLoadCombine (object arg)
 		{
-			string filename = arg as string;
-			if (!fileUtilityService.TestFileExists(filename)) {
-				return;
-			}
+			object[] data = (object[]) arg;
+			string filename = data[0] as string;
+			IProgressMonitor monitor = data [1] as IProgressMonitor;
 			
-			string validcombine = Path.ChangeExtension (filename, &quot;.cmbx&quot;);
+			try {
+				if (!fileUtilityService.TestFileExists(filename)) {
+					monitor.ReportError (string.Format (GettextCatalog.GetString (&quot;File not found: {0}&quot;), filename), null);
+					return;
+				}
+				
+				string validcombine = Path.ChangeExtension (filename, &quot;.cmbx&quot;);
+				
+				if (Path.GetExtension (filename).ToLower() != &quot;.cmbx&quot;) {
+					if (File.Exists (validcombine))
+						filename = validcombine;
+				}
 			
-			if (Path.GetExtension (filename).ToLower() != &quot;.cmbx&quot;) {
-				if (File.Exists (validcombine))
-					filename = validcombine;
-			}
-			
-			IProgressMonitor monitor = Runtime.TaskService.GetLoadProgressMonitor ();
-			try {
 				CombineEntry entry = ReadFile (filename, monitor);
 				if (!(entry is Combine)) {
 					Combine loadingCombine = new Combine();
@@ -669,7 +676,7 @@
 					foreach (XmlElement el in root[&quot;Files&quot;].ChildNodes) {
 						string fileName = fileUtilityService.RelativeToAbsolutePath(combinepath, el.Attributes[&quot;filename&quot;].InnerText);
 						if (File.Exists(fileName)) {
-							Runtime.FileService.OpenFile (fileName);
+							Runtime.FileService.OpenFile (fileName, false);
 						}
 					}
 				}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs	2005-01-26 23:54:31 UTC (rev 2170)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs	2005-01-27 00:33:22 UTC (rev 2171)
@@ -121,7 +121,7 @@
 		/// &lt;remarks&gt;
 		/// Opens a new root combine, closes the old root combine automatically.
 		/// &lt;/remarks&gt;
-		void OpenCombine(string filename);
+		IAsyncOperation OpenCombine (string filename);
 		
 		/// &lt;remarks&gt;
 		/// Saves the whole root combine.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001774.html">[Monodevelop-patches-list] r2170 - in trunk/MonoDevelop/Core/src/MonoDevelop.Gui.Widgets: . Tree
</A></li>
	<LI>Next message: <A HREF="001776.html">[Monodevelop-patches-list] r2172 - in trunk/MonoDevelop: . Core/src/AddIns/DisplayBindings/SourceEditor Core/src/AddIns/DisplayBindings/SourceEditor/Gui Core/src/MonoDevelop.Base Core/src/MonoDevelop.Base/Gui/BrowserDisplayBinding Core/src/MonoDevelop.Base/Services/DisplayBinding Core/src/MonoDevelop.Base/Services/File Core/src/MonoDevelop.Gui.Utils Core/src/MonoDevelop.Gui.Widgets Core/src/MonoDevelop.Gui.Widgets/FileBrowser
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1775">[ date ]</a>
              <a href="thread.html#1775">[ thread ]</a>
              <a href="subject.html#1775">[ subject ]</a>
              <a href="author.html#1775">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
