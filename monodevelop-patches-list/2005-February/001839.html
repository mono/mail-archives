<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2235 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2235%20-%20trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001838.html">
   <LINK REL="Next"  HREF="001840.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2235 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2235%20-%20trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2235 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Sat Feb  5 18:44:29 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001838.html">[Monodevelop-patches-list] r2234 - in trunk/MonoDevelop/Core/src/AddIns/BackendBindings/CSharpBinding: . Gui
</A></li>
        <LI>Next message: <A HREF="001840.html">[Monodevelop-patches-list] r2236 - trunk/MonoDevelop/Core/docs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1839">[ date ]</a>
              <a href="thread.html#1839">[ thread ]</a>
              <a href="subject.html#1839">[ subject ]</a>
              <a href="author.html#1839">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jluke
Date: 2005-02-05 18:44:29 -0500 (Sat, 05 Feb 2005)
New Revision: 2235

Modified:
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ChangeLog
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmCompilerManager.cs
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmLanguageBinding.cs
Log:
update ilasm binding and add some error parsing


Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ChangeLog	2005-02-05 19:33:39 UTC (rev 2234)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ChangeLog	2005-02-05 23:44:29 UTC (rev 2235)
@@ -1,5 +1,10 @@
 2005-01-24  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
 
+	* ILAsmCompilerManager.cs: update to work like CSharpBinding
+	and add some primitive error parsing
+
+2005-01-24  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
+
 	* ILAsmCompilerManager.cs: remove unused lines and fix 2 warnings
 
 2005-01-24  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmCompilerManager.cs
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmCompilerManager.cs	2005-02-05 19:33:39 UTC (rev 2234)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmCompilerManager.cs	2005-02-05 23:44:29 UTC (rev 2235)
@@ -31,22 +31,30 @@
 		
 		public bool CanCompile(string fileName)
 		{
-			return Path.GetExtension(fileName).ToUpper() == &quot;.IL&quot;;
+			return Path.GetExtension (fileName).ToLower () == &quot;.il&quot;;
 		}
 		
-		ICompilerResult Compile (DotNetProjectConfiguration configuration, string[] fileNames)
+		public ICompilerResult Compile (ProjectFileCollection projectFiles, ProjectReferenceCollection references, DotNetProjectConfiguration configuration, IProgressMonitor monitor)
 		{
-			// TODO: No response file possible ? @FILENAME seems not to work.
+			// FIXME: response file?
 			StringBuilder parameters = new StringBuilder();
-			foreach (string fileName in fileNames) {
-				parameters.Append('&quot;');
-				parameters.Append(Path.GetFullPath(fileName));
-				parameters.Append(&quot;\&quot; &quot;);
+			foreach (ProjectFile finfo in projectFiles) {
+				if (finfo.Subtype != Subtype.Directory) {
+					switch (finfo.BuildAction) {
+						case BuildAction.Compile:
+							if (CanCompile (finfo.Name)) {
+								parameters.Append (finfo.Name);
+								parameters.Append (&quot; &quot;);
+							}
+							break;
+						default:
+							break;
+					}
+				}
 			}
 			
-			string outputFile = configuration.CompiledOutputName;
-			Console.WriteLine (outputFile);
-			parameters.Append(&quot;/out:&quot; + outputFile);
+			parameters.Append(&quot;/out:&quot;);
+			parameters.Append(configuration.CompiledOutputName);
 			parameters.Append(&quot; &quot;);
 			
 			switch (configuration.CompileTarget) {
@@ -61,22 +69,28 @@
 			}
 			
 			if (configuration.DebugMode)
-				parameters.Append(&quot;/DEBUG &quot;);
+				parameters.Append(&quot;/debug &quot;);
 				
-			string outstr = parameters.ToString();
-			
+			string output = String.Empty;
+			string error = String.Empty;
 			TempFileCollection tf = new TempFileCollection();
-			StreamReader output;
-			StreamReader error;
-			DoCompilation (outstr, tf, out output, out error);
-			ICompilerResult result = ParseOutput(tf, output);
+			DoCompilation (parameters.ToString (), tf, ref output, ref error);
+			ICompilerResult result = ParseOutput(tf, output, error);
+			if (result.CompilerOutput.Trim () != &quot;&quot;)
+				monitor.Log.WriteLine (result.CompilerOutput);
 			
+			File.Delete(output);
+			File.Delete(error);
 			return result;
 		}
 
-		private void DoCompilation (string outstr, TempFileCollection tf, out StreamReader output, out StreamReader error)
+		private void DoCompilation (string outstr, TempFileCollection tf, ref string output, ref string error)
 		{
-			ProcessStartInfo si = new ProcessStartInfo (GetCompilerName (), outstr);
+			output = Path.GetTempFileName ();
+			error = Path.GetTempFileName ();
+
+			string arguments = String.Format (&quot;-c \&quot;{0} {1} &gt; {2} 2&gt; {3}\&quot;&quot;, GetCompilerName (), outstr, output, error);
+			ProcessStartInfo si = new ProcessStartInfo (&quot;/bin/sh&quot;, arguments);
 			si.RedirectStandardOutput = true;
 			si.RedirectStandardError = true;
 			si.UseShellExecute = false;
@@ -84,93 +98,73 @@
 			p.StartInfo = si;
 			p.Start ();
 			p.WaitForExit ();
-
-			// FIXME: avoid having a full buffer
-			// perhaps read one line and append parsed output
-			// and then return cr at end 
-			output = p.StandardOutput;
-			error = p.StandardError;
         }
 		
-		public ICompilerResult Compile (ProjectFileCollection projectFiles, ProjectReferenceCollection references, DotNetProjectConfiguration configuration, IProgressMonitor monitor)
+		string GetCompilerName ()
 		{
-			ArrayList fileNames = new ArrayList();
-			
-			foreach (ProjectFile finfo in projectFiles) {
-				if (finfo.Subtype != Subtype.Directory) {
-					switch (finfo.BuildAction) {
-						case BuildAction.Compile:
-							fileNames.Add(finfo.Name);
-							break;
-//				TODO : Embedded resources ?		
-//						case BuildAction.EmbedAsResource:
-//							writer.WriteLine(&quot;\&quot;/res:&quot; + finfo.Name + &quot;\&quot;&quot;);
-//							break;
-					}
-				}
-			}
-			
-			return Compile (configuration, (string[])fileNames.ToArray(typeof(string)));
-		}
-		
-		string GetCompilerName()
-		{
 			return &quot;ilasm&quot;;
 		}
 		
-		ICompilerResult ParseOutput(TempFileCollection tf, StreamReader sr)
+		ICompilerResult ParseOutput (TempFileCollection tf, string stdout, string stderr)
 		{
-			StringBuilder compilerOutput = new StringBuilder();
+			StringBuilder compilerOutput = new StringBuilder ();
+			CompilerResults cr = new CompilerResults (tf);
 			
-			//StreamReader sr = File.OpenText(file);
-			
-			// skip fist whitespace line
-			sr.ReadLine();
-			
-			CompilerResults cr = new CompilerResults(tf);
-			
-			while (true) {
-				string curLine = sr.ReadLine();
-				compilerOutput.Append(curLine);
-				compilerOutput.Append('\n');
-				if (curLine == null) {
-					break;
-				}
-				// TODO : PARSE ERROR OUTPUT.
+			foreach (string s in new string[] { stdout, stderr })
+			{
+				StreamReader sr = File.OpenText (s);
+				while (true) {
+					string curLine = sr.ReadLine ();
+					compilerOutput.Append (curLine);
+					compilerOutput.Append ('\n');
+
+					if (curLine == null)
+						break;
+
+					curLine = curLine.Trim ();
+
+					if (curLine.Length == 0)
+						continue;
 				
-//				curLine = curLine.Trim();
-//				if (curLine.Length == 0) {
-//					continue;
-//				}
-//				
-//				CompilerError error = new CompilerError();
-//				
-//				// try to match standard errors
-//				Match match = normalError.Match(curLine);
-//				if (match.Success) {
-//					error.Column      = Int32.Parse(match.Result(&quot;${column}&quot;));
-//					error.Line        = Int32.Parse(match.Result(&quot;${line}&quot;));
-//					error.FileName    = Path.GetFullPath(match.Result(&quot;${file}&quot;));
-//					error.IsWarning   = match.Result(&quot;${error}&quot;) == &quot;warning&quot;; 
-//					error.ErrorNumber = match.Result(&quot;${number}&quot;);
-//					error.ErrorText   = match.Result(&quot;${message}&quot;);
-//				} else {
-//					match = generalError.Match(curLine); // try to match general csc errors
-//					if (match.Success) {
-//						error.IsWarning   = match.Result(&quot;${error}&quot;) == &quot;warning&quot;; 
-//						error.ErrorNumber = match.Result(&quot;${number}&quot;);
-//						error.ErrorText   = match.Result(&quot;${message}&quot;);
-//					} else { // give up and skip the line
-//						continue;
-////						error.IsWarning = false;
-////						error.ErrorText = curLine;
-//					}
-//				}
-//				
-//				cr.Errors.Add(error);
+					CompilerError error = CreateErrorFromString (curLine);
+					
+					if (error != null)
+						cr.Errors.Add (error);
+				}
+				sr.Close ();
 			}
-			sr.Close();
-			return new DefaultCompilerResult(cr, compilerOutput.ToString());
+			return new DefaultCompilerResult (cr, compilerOutput.ToString ());
 		}
+
+		private static string efile, etext = String.Empty;
+		// FIXME: ilasm seems to use &gt; 1 line per error
+		private static CompilerError CreateErrorFromString (string error)
+		{
+			if (error.StartsWith (&quot;Assembling &quot;)) {
+				int start = error.IndexOf ('\'');
+				int length = error.IndexOf ('\'', start + 1) - start;
+				efile = error.Substring (start, length);
+			}
+			if (error.StartsWith (&quot;syntax error, &quot;)) {
+				etext = error;
+			}
+			if (error.StartsWith (&quot;Error at: &quot;)) {
+				string[] info = error.Substring (&quot;Error at: &quot;.Length).Split (' ');
+				CompilerError cerror = new CompilerError();
+				int col = 0;
+				int line = 0;
+				try {
+					line = int.Parse (info[1].Trim ('(', ')'));
+					col = int.Parse (info[3].Trim ('(', ')'));
+				} catch {}
+				cerror.Line = line;
+				cerror.Column = col;
+				cerror.ErrorText = etext;
+				cerror.FileName = efile;
+				return cerror;
+			}
+			return null;
+		}
 	}
 }
+

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmLanguageBinding.cs
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmLanguageBinding.cs	2005-02-05 19:33:39 UTC (rev 2234)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/ILAsmBinding/ILAsmLanguageBinding.cs	2005-02-05 23:44:29 UTC (rev 2235)
@@ -62,7 +62,6 @@
 			return new ILAsmCompilerParameters();
 		}
 		
-		// source: irc
 		public string CommentTag
 		{
 			get { return &quot;//&quot;; }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001838.html">[Monodevelop-patches-list] r2234 - in trunk/MonoDevelop/Core/src/AddIns/BackendBindings/CSharpBinding: . Gui
</A></li>
	<LI>Next message: <A HREF="001840.html">[Monodevelop-patches-list] r2236 - trunk/MonoDevelop/Core/docs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1839">[ date ]</a>
              <a href="thread.html#1839">[ thread ]</a>
              <a href="subject.html#1839">[ subject ]</a>
              <a href="author.html#1839">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
