<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2237 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2237%20-%20trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001840.html">
   <LINK REL="Next"  HREF="001842.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2237 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2237%20-%20trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2237 - trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Sat Feb  5 20:36:17 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001840.html">[Monodevelop-patches-list] r2236 - trunk/MonoDevelop/Core/docs
</A></li>
        <LI>Next message: <A HREF="001842.html">[Monodevelop-patches-list] r2238 - trunk/md-website/tutorials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1841">[ date ]</a>
              <a href="thread.html#1841">[ thread ]</a>
              <a href="subject.html#1841">[ subject ]</a>
              <a href="author.html#1841">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jluke
Date: 2005-02-05 20:36:17 -0500 (Sat, 05 Feb 2005)
New Revision: 2237

Removed:
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/ProjectTreeBuilder/
Modified:
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/ChangeLog
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBinding.addin.xml
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBindingCompilerServices.cs
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/Makefile.am
   trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/TODO
Log:
update java binding


Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/ChangeLog	2005-02-06 01:29:45 UTC (rev 2236)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/ChangeLog	2005-02-06 01:36:17 UTC (rev 2237)
@@ -1,3 +1,14 @@
+2005-02-05  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
+
+	* Makefile.am
+	* JavaBinding.addin.xml: remove custom node builder
+	* ProjectTreeBuilder/JavaNodeBuilder.cs: remove custom
+	node builder in favor of using the default so references
+	can be added (ikvm projects need IKVM.GNU.Classpath.dll and
+	IKVM.Runtime.dll)
+	* JavaBindingCompilerServices.cs: work like the C# bindings,
+	error parsing is broken but Im pretty sure it already was
+
 2005-01-24  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
 
 	* JavaBindingCompilerServices.cs: 

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBinding.addin.xml
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBinding.addin.xml	2005-02-06 01:29:45 UTC (rev 2236)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBinding.addin.xml	2005-02-06 01:36:17 UTC (rev 2237)
@@ -73,10 +73,4 @@
                      class = &quot;JavaBinding.JavaLanguageBinding&quot; /&gt;
   &lt;/Extension&gt;
 
-  &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/NodeBuilders&quot;&gt;
-    &lt;Class id = &quot;JavaNodeBuilder&quot;
-           insertbefore = &quot;DefaultBuilder&quot;
-           class = &quot;JavaBinding.JavaNodeBuilder&quot;/&gt;
-  &lt;/Extension&gt;
-
 &lt;/AddIn&gt;

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBindingCompilerServices.cs
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBindingCompilerServices.cs	2005-02-06 01:29:45 UTC (rev 2236)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/JavaBindingCompilerServices.cs	2005-02-06 01:36:17 UTC (rev 2237)
@@ -9,6 +9,7 @@
 using System.Diagnostics;
 using System.IO;
 using System.CodeDom.Compiler;
+using System.Text;
 
 using MonoDevelop.Gui.Components;
 using MonoDevelop.Services;
@@ -24,14 +25,10 @@
 			return Path.GetExtension(fileName) == &quot;.java&quot;;
 		}
 		
-		FileUtilityService fileUtilityService = (FileUtilityService) ServiceManager.GetService(typeof(FileUtilityService));
-
 		string GetCompilerName (JavaCompilerParameters cp)
 		{
 			if (cp.Compiler == JavaCompiler.Gcj)
-			{
 				return &quot;gcj&quot;;
-			}
 
 			return &quot;javac&quot;;
 		}
@@ -39,7 +36,8 @@
 		public ICompilerResult Compile (ProjectFileCollection projectFiles, ProjectReferenceCollection references, DotNetProjectConfiguration configuration, IProgressMonitor monitor)
 		{
 			JavaCompilerParameters compilerparameters = (JavaCompilerParameters) configuration.CompilationParameters;
-			if (compilerparameters == null) compilerparameters = new JavaCompilerParameters ();
+			if (compilerparameters == null)
+				compilerparameters = new JavaCompilerParameters ();
 			
 			string outdir = configuration.OutputDirectory;
 			string options = &quot;&quot;;
@@ -77,7 +75,6 @@
 				}
 			}
 
-			TempFileCollection  tf = new TempFileCollection ();			
 			string args = &quot;&quot;;
 			
 			if (compilerparameters.Compiler == JavaCompiler.Gcj)
@@ -92,20 +89,27 @@
 			}
 			//Console.WriteLine (args);
 
-			StreamReader output;
-			StreamReader error;
-			DoCompilation (monitor, compiler, args, tf, configuration, compilerparameters, out output, out error);
-			ICompilerResult cr = ParseOutput (tf, error);			
-			
+			string output = String.Empty;
+			string error = String.Empty;
+			TempFileCollection  tf = new TempFileCollection ();			
+			DoCompilation (monitor, compiler, args, tf, configuration, compilerparameters, ref output, ref error);
+			ICompilerResult cr = ParseOutput (tf, output, error);			
+			File.Delete (output);
+			File.Delete (error);
 			return cr;
 		}
 
-		private void DoCompilation (IProgressMonitor monitor, string compiler, string args, TempFileCollection tf, DotNetProjectConfiguration configuration, JavaCompilerParameters compilerparameters, out StreamReader output, out StreamReader error)
+		private void DoCompilation (IProgressMonitor monitor, string compiler, string args, TempFileCollection tf, DotNetProjectConfiguration configuration, JavaCompilerParameters compilerparameters, ref string output, ref string error)
 		{
+			output = Path.GetTempFileName ();
+			error = Path.GetTempFileName ();
+
 			try {
 				monitor.BeginTask (null, 2);
 				monitor.Log.WriteLine (&quot;Compiling Java source code ...&quot;);
-				ProcessStartInfo si = new ProcessStartInfo (compiler, args);
+				string arguments = String.Format (&quot;-c \&quot;{0} {1} &gt; {2} 2&gt; {3}\&quot;&quot;, compiler, args, output, error);
+				ProcessStartInfo si = new ProcessStartInfo (&quot;/bin/sh&quot;, arguments);
+				//Console.WriteLine (&quot;{0} {1}&quot;, si.FileName, si.Arguments);
 				si.RedirectStandardOutput = true;
 				si.RedirectStandardError = true;
 				si.UseShellExecute = false;
@@ -116,27 +120,22 @@
 				
 				monitor.Step (1);
 				monitor.Log.WriteLine (&quot;Generating assembly ...&quot;);
-				CompileToAssembly (configuration, compilerparameters);
-			
-				// FIXME: avoid having a full buffer
-				// perhaps read one line and append parsed output
-				// and then return cr at end 
-				output = p.StandardOutput;
-				error = p.StandardError;
+				CompileToAssembly (configuration, compilerparameters, output, error);
 			} finally {
 				monitor.EndTask ();
 			}
         }
 
-		void CompileToAssembly (DotNetProjectConfiguration configuration, JavaCompilerParameters compilerparameters)
+		void CompileToAssembly (DotNetProjectConfiguration configuration, JavaCompilerParameters compilerparameters, string output, string error)
 		{
 			string outdir = configuration.OutputDirectory;
 			string outclass = Path.Combine (outdir, configuration.OutputAssembly + &quot;.class&quot;);
 			string asm = Path.GetFileNameWithoutExtension (outclass);
 		
 			// sadly I dont think we can specify the output .class name
-			string args = String.Format (&quot;{0} -assembly:{1}&quot;, &quot;*.class&quot;, asm);
-            ProcessStartInfo si = new ProcessStartInfo (&quot;ikvmc&quot;, args);
+			string args = String.Format (&quot;-c \&quot;ikvmc {0} -assembly:{1} &gt; {2} 2&gt; {3}\&quot;&quot;, &quot;*.class&quot;, asm, output, error);
+            ProcessStartInfo si = new ProcessStartInfo (&quot;/bin/sh&quot;, args);
+			//Console.WriteLine (&quot;{0} {1}&quot;, si.FileName, si.Arguments);
             si.WorkingDirectory = outdir;
 			si.RedirectStandardOutput = true;
             si.RedirectStandardError = true;
@@ -147,48 +146,72 @@
 			p.WaitForExit ();
 		}
 		
-		ICompilerResult ParseOutput (TempFileCollection tf, StreamReader errorStream)
+		ICompilerResult ParseOutput (TempFileCollection tf, string stdout, string stderr)
 		{
-			string compilerOutput = &quot;&quot;;		
-			StreamReader sr = errorStream;
+			StringBuilder compilerOutput = new StringBuilder ();
 			CompilerResults cr = new CompilerResults (tf);
 			
-			while (true) 
+			foreach (string s in new string[] { stdout, stderr })
 			{
-				string next = sr.ReadLine ();
+				StreamReader sr = File.OpenText (s);
+				while (true) 
+				{
+					string next = sr.ReadLine ();
 				
-				if (next == null)
-					break;
+					if (next == null)
+						break;
 
-				CompilerError error = new CompilerError ();
+					CompilerError error = CreateErrorFromString (next);
 
-				int errorCol = 0;
-				string col = next.Trim ();
-				if (col.Length == 1 &amp;&amp; col == &quot;^&quot;)
-					errorCol = next.IndexOf (&quot;^&quot;);
+					if (error != null)
+						cr.Errors.Add (error);
+				}
+				sr.Close ();
+			}
+			return new DefaultCompilerResult (cr, compilerOutput.ToString ());
+		}
 
-				compilerOutput += next + &quot;\n&quot;;
+		// FIXME: the various java compilers will probably need to be parse on
+		// their own and then ikvmc would need one as well
+		private static CompilerError CreateErrorFromString (string error)
+		{
+			if (error.StartsWith (&quot;Note&quot;) || error.StartsWith (&quot;Warning&quot;))
+				return null;
+			string trimmed = error.Trim ();
+			if (trimmed.StartsWith (&quot;(to avoid this warning add&quot;))
+				return null;
+			//Console.WriteLine (&quot;error: {0}&quot;, error);
 
-				int index1 = next.IndexOf (&quot;.java:&quot;);
-				if (index1 &lt; 0)
-					continue;				
+			CompilerError cerror = new CompilerError ();
+			cerror.ErrorText = error;
+			return cerror;
+		}
+/* old javac parser
+					CompilerError error = new CompilerError ();
+
+					int errorCol = 0;
+					string col = next.Trim ();
+					if (col.Length == 1 &amp;&amp; col == &quot;^&quot;)
+						errorCol = next.IndexOf (&quot;^&quot;);
+
+					compilerOutput.Append (next);
+					compilerOutput.Append (&quot;\n&quot;);
+
+					int index1 = next.IndexOf (&quot;.java:&quot;);
+					if (index1 &lt; 0)
+						continue;				
 				
-				//string s1 = next.Substring (0, index1);
-				string s2 = next.Substring (index1 + 6);									
-				int index2  = s2.IndexOf (&quot;:&quot;);				
-				int line = Int32.Parse (next.Substring (index1 + 6, index2));
-				//error.IsWarning   = what[0] == &quot;warning&quot;;
-				//error.ErrorNumber = what[what.Length - 1];
+					//string s1 = next.Substring (0, index1);
+					string s2 = next.Substring (index1 + 6);									
+					int index2  = s2.IndexOf (&quot;:&quot;);				
+					int line = Int32.Parse (next.Substring (index1 + 6, index2));
+					//error.IsWarning   = what[0] == &quot;warning&quot;;
+					//error.ErrorNumber = what[what.Length - 1];
 								
-				error.Column = errorCol;
-				error.Line = line;
-				error.ErrorText = next.Substring (index1 + index2 + 7);
-				error.FileName = Path.GetFullPath (next.Substring (0, index1) + &quot;.java&quot;); //Path.GetFileName(filename);
-				cr.Errors.Add (error);
-			}
-
-			sr.Close ();			
-			return new DefaultCompilerResult (cr, compilerOutput);
-		}
+					error.Column = errorCol;
+					error.Line = line;
+					error.ErrorText = next.Substring (index1 + index2 + 7);
+					error.FileName = Path.GetFullPath (next.Substring (0, index1) + &quot;.java&quot;); //Path.GetFileName(filename);
+*/
 	}
 }

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/Makefile.am
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/Makefile.am	2005-02-06 01:29:45 UTC (rev 2236)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/Makefile.am	2005-02-06 01:36:17 UTC (rev 2237)
@@ -13,8 +13,7 @@
 Project/JavaCompilerParameters.cs \
 JavaBindingCompilerServices.cs \
 JavaCompiler.cs \
-JavaLanguageBinding.cs \
-ProjectTreeBuilder/JavaNodeBuilder.cs
+JavaLanguageBinding.cs
 
 TEMPLATES = \
 templates/EmptyJavaFile.xft.xml \

Modified: trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/TODO
===================================================================
--- trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/TODO	2005-02-06 01:29:45 UTC (rev 2236)
+++ trunk/MonoDevelop/Core/src/AddIns/BackendBindings/JavaBinding/TODO	2005-02-06 01:36:17 UTC (rev 2237)
@@ -1,4 +1,4 @@
- - fix execution from MD
+ - fix regluar java templates
  - make classpath handling better
  - support turning a jar to a dll simply
  - support more java compilers (like ecj)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001840.html">[Monodevelop-patches-list] r2236 - trunk/MonoDevelop/Core/docs
</A></li>
	<LI>Next message: <A HREF="001842.html">[Monodevelop-patches-list] r2238 - trunk/md-website/tutorials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1841">[ date ]</a>
              <a href="thread.html#1841">[ thread ]</a>
              <a href="subject.html#1841">[ subject ]</a>
              <a href="author.html#1841">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
