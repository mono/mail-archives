<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r1237 - in trunk/MonoDevelop/src: Libraries/MonoDevelop.Gui.Utils Libraries/MonoDevelop.Gui.Utils/VFS Main/Base Main/Base/Services/File
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1237%20-%20in%20trunk/MonoDevelop/src%3A%20Libraries/MonoDevelop.Gui.Utils%20Libraries/MonoDevelop.Gui.Utils/VFS%20Main/Base%20Main/Base/Services/File&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000843.html">
   <LINK REL="Next"  HREF="000845.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r1237 - in trunk/MonoDevelop/src: Libraries/MonoDevelop.Gui.Utils Libraries/MonoDevelop.Gui.Utils/VFS Main/Base Main/Base/Services/File</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1237%20-%20in%20trunk/MonoDevelop/src%3A%20Libraries/MonoDevelop.Gui.Utils%20Libraries/MonoDevelop.Gui.Utils/VFS%20Main/Base%20Main/Base/Services/File&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r1237 - in trunk/MonoDevelop/src: Libraries/MonoDevelop.Gui.Utils Libraries/MonoDevelop.Gui.Utils/VFS Main/Base Main/Base/Services/File">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Thu Mar 25 00:16:46 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000843.html">[Monodevelop-patches-list] r1236 - trunk/MonoDevelop/docs
</A></li>
        <LI>Next message: <A HREF="000845.html">[Monodevelop-patches-list] r1238 - in trunk/MonoDevelop/src: AddIns/DebuggerAddIn AddIns/DisplayBindings/SourceEditor AddIns/Misc/StartPage Libraries/MonoDevelop.Core Libraries/MonoDevelop.Gui.Utils Libraries/MonoDevelop.Gui.Widgets Main/Base Main/StartUp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#844">[ date ]</a>
              <a href="thread.html#844">[ thread ]</a>
              <a href="subject.html#844">[ subject ]</a>
              <a href="author.html#844">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: tberman
Date: 2004-03-25 00:16:45 -0500 (Thu, 25 Mar 2004)
New Revision: 1237

Added:
   trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/ChangeLog
Modified:
   trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/VFS/Vfs.cs
   trunk/MonoDevelop/src/Main/Base/ChangeLog
   trunk/MonoDevelop/src/Main/Base/Services/File/DefaultFileService.cs
Log:
new mime-type file loading junk to work around broken gnome issues.


Added: trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/ChangeLog
===================================================================
--- trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/ChangeLog	2004-03-24 18:33:30 UTC (rev 1236)
+++ trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/ChangeLog	2004-03-25 05:16:45 UTC (rev 1237)
@@ -0,0 +1,4 @@
+2004-03-25  Todd Berman  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tberman at sevenl.net</A>&gt;
+
+	* VFS/Vfs.cs: Added new code from Dashboard to provide a different
+	external app identification mechanism.

Modified: trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/VFS/Vfs.cs
===================================================================
--- trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/VFS/Vfs.cs	2004-03-24 18:33:30 UTC (rev 1236)
+++ trunk/MonoDevelop/src/Libraries/MonoDevelop.Gui.Utils/VFS/Vfs.cs	2004-03-25 05:16:45 UTC (rev 1237)
@@ -71,4 +71,54 @@
 			get { return gnome_vfs_init (); }
 		}
 	}
+
+	public class MimeApplication {
+		[Flags]
+		public enum ArgumentType {
+			URIS,
+			PATHS,
+			URIS_FOR_NON_FILES,
+		}
+		[StructLayout(LayoutKind.Sequential)]
+		public class Info {
+			public string id;
+			public string name;
+			public string command;
+			public bool can_open_multiple_files;
+			public ArgumentType expects_uris;
+			public IntPtr supported_uri_schemes;
+			public bool requires_terminal;
+
+			public IntPtr reserved1;
+			public IntPtr reserved2;
+		}
+
+		[DllImport (&quot;libgnomevfs-2&quot;)]
+			extern static Info gnome_vfs_mime_get_default_application ( string mime_type );
+		[DllImport (&quot;libgnomevfs-2&quot;)]
+			extern static void gnome_vfs_mime_application_free ( Info info );
+
+		public static void Exec (string mime_type, string uri)
+		{
+			Info info;
+			info = gnome_vfs_mime_get_default_application (mime_type);
+			if (info == null)
+			{
+				// Can we please stop hard coding Nautilus!?
+				System.Diagnostics.ProcessStartInfo psi = new System.Diagnostics.ProcessStartInfo (&quot;nautilus&quot;, &quot;\&quot;&quot; + uri + &quot;\&quot;&quot;);
+				psi.UseShellExecute = false;
+				
+				System.Diagnostics.Process.Start (psi);
+			} else {
+				System.Diagnostics.ProcessStartInfo psi = new System.Diagnostics.ProcessStartInfo (info.command, &quot;\&quot;&quot; + uri + &quot;\&quot;&quot;);
+				psi.UseShellExecute = false;
+				System.Diagnostics.Process.Start (psi);
+			}
+//FIXME:  Memory leak, causes crashes, dunno why...needs fixed
+//			gnome_vfs_mime_application_free (info);
+		}
+
+	}
+
+
 }

Modified: trunk/MonoDevelop/src/Main/Base/ChangeLog
===================================================================
--- trunk/MonoDevelop/src/Main/Base/ChangeLog	2004-03-24 18:33:30 UTC (rev 1236)
+++ trunk/MonoDevelop/src/Main/Base/ChangeLog	2004-03-25 05:16:45 UTC (rev 1237)
@@ -1,5 +1,11 @@
-2003-03-21  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">jluke at cfl.rr.com</A>&gt;
+2004-03-25  Todd Berman  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">tberman at sevenl.net</A>&gt;
 
+	* Services/File/DefaultFileService.cs: adding a new method of external
+	app launching based on gnome vfs stuff, works around broken gnome
+	installs.
+
+2004-03-21  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">jluke at cfl.rr.com</A>&gt;
+
 	* Commands/ProjectBrowserCommands/FolderNodeCommands.cs:
 	set the default of the FileSelector to ~/MonoDevelopProjects
 	closes bug #55188

Modified: trunk/MonoDevelop/src/Main/Base/Services/File/DefaultFileService.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Services/File/DefaultFileService.cs	2004-03-24 18:33:30 UTC (rev 1236)
+++ trunk/MonoDevelop/src/Main/Base/Services/File/DefaultFileService.cs	2004-03-25 05:16:45 UTC (rev 1237)
@@ -19,6 +19,8 @@
 using MonoDevelop.Gui;
 using MonoDevelop.Core.AddIns.Codons;
 
+using MonoDevelop.Gui.Utils;
+
 namespace MonoDevelop.Services
 {
 	public class DefaultFileService : AbstractService, IFileService
@@ -136,7 +138,13 @@
 				}
 			} else {
 				try {
-					Gnome.Url.Show (&quot;<A HREF="file://&quot;">file://&quot;</A> + fileName);
+					string mimetype = Vfs.GetMimeType (fileName);
+					Console.WriteLine (&quot;About to MimeApp.Exec on mimetype: &quot; + mimetype);
+					if (mimetype != null) {
+						MimeApplication.Exec (mimetype, fileName);
+					} else {
+						Gnome.Url.Show (&quot;<A HREF="file://&quot;">file://&quot;</A> + fileName);
+					}
 				} catch {
 					if (fileUtilityService.ObservedLoad(new NamedFileOperationDelegate (new LoadFileWrapper (displayBindingService.LastBinding, null, null).Invoke), fileName) == FileOperationResult.OK) {
 						fileService.RecentOpen.AddLastFile (fileName);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000843.html">[Monodevelop-patches-list] r1236 - trunk/MonoDevelop/docs
</A></li>
	<LI>Next message: <A HREF="000845.html">[Monodevelop-patches-list] r1238 - in trunk/MonoDevelop/src: AddIns/DebuggerAddIn AddIns/DisplayBindings/SourceEditor AddIns/Misc/StartPage Libraries/MonoDevelop.Core Libraries/MonoDevelop.Gui.Utils Libraries/MonoDevelop.Gui.Widgets Main/Base Main/StartUp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#844">[ date ]</a>
              <a href="thread.html#844">[ thread ]</a>
              <a href="subject.html#844">[ subject ]</a>
              <a href="author.html#844">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
