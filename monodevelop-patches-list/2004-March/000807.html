<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r1200 - in trunk/MonoDevelop: . build/AddIns data/resources/glade gdldock/gdl src/Main/Base src/Main/Base/Commands src/Main/Base/Gui src/Main/Base/Gui/Dialogs src/Main/Base/Gui/Workbench/Layouts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1200%20-%20in%20trunk/MonoDevelop%3A%20.%20build/AddIns%20data/resources/glade%20gdldock/gdl%20src/Main/Base%20src/Main/Base/Commands%20src/Main/Base/Gui%20src/Main/Base/Gui/Dialogs%20src/Main/Base/Gui/Workbench/Layouts&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000806.html">
   <LINK REL="Next"  HREF="000808.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r1200 - in trunk/MonoDevelop: . build/AddIns data/resources/glade gdldock/gdl src/Main/Base src/Main/Base/Commands src/Main/Base/Gui src/Main/Base/Gui/Dialogs src/Main/Base/Gui/Workbench/Layouts</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1200%20-%20in%20trunk/MonoDevelop%3A%20.%20build/AddIns%20data/resources/glade%20gdldock/gdl%20src/Main/Base%20src/Main/Base/Commands%20src/Main/Base/Gui%20src/Main/Base/Gui/Dialogs%20src/Main/Base/Gui/Workbench/Layouts&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r1200 - in trunk/MonoDevelop: . build/AddIns data/resources/glade gdldock/gdl src/Main/Base src/Main/Base/Commands src/Main/Base/Gui src/Main/Base/Gui/Dialogs src/Main/Base/Gui/Workbench/Layouts">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Sat Mar 20 00:17:14 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000806.html">[Monodevelop-patches-list] r1199 - in trunk/MonoDevelop: . src/Libraries/MonoDevelop.Core/Services src/Main/Base/Commands src/Main/Base/Services
</A></li>
        <LI>Next message: <A HREF="000808.html">[Monodevelop-patches-list] r1201 - in trunk/MonoDevelop: . gdldock/gdl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#807">[ date ]</a>
              <a href="thread.html#807">[ thread ]</a>
              <a href="subject.html#807">[ subject ]</a>
              <a href="author.html#807">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: ggiraldez
Date: 2004-03-20 00:17:14 -0500 (Sat, 20 Mar 2004)
New Revision: 1200

Added:
   trunk/MonoDevelop/gdldock/gdl/DockLayout.custom
   trunk/MonoDevelop/src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs
Modified:
   trunk/MonoDevelop/ChangeLog
   trunk/MonoDevelop/build/AddIns/SharpDevelopCore.addin
   trunk/MonoDevelop/data/resources/glade/Base.glade
   trunk/MonoDevelop/gdldock/gdl/Gdl.metadata
   trunk/MonoDevelop/gdldock/gdl/Makefile.am
   trunk/MonoDevelop/src/Main/Base/Commands/MenuItemBuilders.cs
   trunk/MonoDevelop/src/Main/Base/Commands/ToolsCommands.cs
   trunk/MonoDevelop/src/Main/Base/Gui/IWorkbenchLayout.cs
   trunk/MonoDevelop/src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs
   trunk/MonoDevelop/src/Main/Base/Makefile.am
Log:
2004-03-20  Gustavo Gir?\195?\161ldez  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">gustavo.giraldez at gmx.net</A>&gt;

	* gdldock/gdl/Makefile.am: 
	* gdldock/gdl/Gdl.metadata: 
	* gdldock/gdl/DockLayout.custom: Provide a customized GetLayouts
	to return a string[] instead of a GLib.List.
	* src/Main/Base/Gui/IWorkbenchLayout.cs:
	* src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs:
	Support for different sets of layouts depending on the workbench
	context.  Implement Layouts property.  Layouts are saved to the
	xml file with fully qualified names such as &quot;Context.Layout
	name&quot;.  CurrentLayout hides the context prefix, so the value
	set/retrieved is just the layout name.
	* data/resources/glade/Base.glade:
	* src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs: New dialog used to
	retrieve the name of the layout being created.
	* src/Main/Base/Makefile.am: Add NewLayoutDialog.cs to the build.
	* build/AddIns/SharpDevelopCore.addin:
	* src/Main/Base/Commands/ToolsCommands.cs:
	* src/Main/Base/Commands/MenuItemBuilders.cs: Add layouts menu.



Modified: trunk/MonoDevelop/ChangeLog
===================================================================
--- trunk/MonoDevelop/ChangeLog	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/ChangeLog	2004-03-20 05:17:14 UTC (rev 1200)
@@ -1,3 +1,24 @@
+2004-03-20  Gustavo Gir&#225;ldez  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">gustavo.giraldez at gmx.net</A>&gt;
+
+	* gdldock/gdl/Makefile.am: 
+	* gdldock/gdl/Gdl.metadata: 
+	* gdldock/gdl/DockLayout.custom: Provide a customized GetLayouts
+	to return a string[] instead of a GLib.List.
+	* src/Main/Base/Gui/IWorkbenchLayout.cs:
+	* src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs:
+	Support for different sets of layouts depending on the workbench
+	context.  Implement Layouts property.  Layouts are saved to the
+	xml file with fully qualified names such as &quot;Context.Layout
+	name&quot;.  CurrentLayout hides the context prefix, so the value
+	set/retrieved is just the layout name.
+	* data/resources/glade/Base.glade:
+	* src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs: New dialog used to
+	retrieve the name of the layout being created.
+	* src/Main/Base/Makefile.am: Add NewLayoutDialog.cs to the build.
+	* build/AddIns/SharpDevelopCore.addin:
+	* src/Main/Base/Commands/ToolsCommands.cs:
+	* src/Main/Base/Commands/MenuItemBuilders.cs: Add layouts menu.
+
 2004-03-20	John BouAntoun  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">jba-mono at optusnet.com.au</A>&gt;
 
 	* src/Main/Base/Commands/MenuItemBuilders.cs : made it prompt 

Modified: trunk/MonoDevelop/build/AddIns/SharpDevelopCore.addin
===================================================================
--- trunk/MonoDevelop/build/AddIns/SharpDevelopCore.addin	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/build/AddIns/SharpDevelopCore.addin	2004-03-20 05:17:14 UTC (rev 1200)
@@ -712,7 +712,13 @@
 	        
 	        &lt;MenuItem id = &quot;View&quot; label = &quot;${res:XML.MainMenu.ViewMenu}&quot;&gt;
 	                &lt;MenuItem id = &quot;ViewBuilder&quot; label = &quot;&quot; class = &quot;MonoDevelop.Commands.ViewMenuBuilder&quot; /&gt;
-	                &lt;MenuItem id = &quot;ViewItemsSeparator&quot; label = &quot;-&quot; /&gt; 
+	                &lt;MenuItem id = &quot;ViewItemsSeparator&quot; label = &quot;-&quot; /&gt;
+			&lt;MenuItem id = &quot;ViewLayouts&quot; label = &quot;Layouts&quot;&gt;
+				  &lt;MenuItem id = &quot;ViewLayoutsBuilder&quot; label = &quot;&quot; class = &quot;MonoDevelop.Commands.LayoutsMenuBuilder&quot; /&gt;
+				  &lt;MenuItem id = &quot;ViewLayoutsSeparator&quot; label = &quot;-&quot; /&gt;
+				  &lt;MenuItem id = &quot;ViewLayoutsNew&quot; label = &quot;New&quot; class = &quot;MonoDevelop.Commands.NewLayoutCommand&quot; /&gt;
+			&lt;/MenuItem&gt;
+	                &lt;MenuItem id = &quot;ViewItemsSeparator2&quot; label = &quot;-&quot; /&gt;
 			&lt;MenuItem id = &quot;FullScreen&quot;
 	                          label = &quot;${res:XML.MainMenu.ViewMenu.FullScreen}&quot; 
 	                          icon = &quot;Icons.16x16.FullScreen&quot; 

Modified: trunk/MonoDevelop/data/resources/glade/Base.glade
===================================================================
--- trunk/MonoDevelop/data/resources/glade/Base.glade	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/data/resources/glade/Base.glade	2004-03-20 05:17:14 UTC (rev 1200)
@@ -4380,4 +4380,116 @@
   &lt;/child&gt;
 &lt;/widget&gt;
 
+&lt;widget class=&quot;GtkDialog&quot; id=&quot;newLayoutDialog&quot;&gt;
+  &lt;property name=&quot;border_width&quot;&gt;6&lt;/property&gt;
+  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+  &lt;property name=&quot;title&quot; translatable=&quot;yes&quot;&gt;New layout&lt;/property&gt;
+  &lt;property name=&quot;type&quot;&gt;GTK_WINDOW_TOPLEVEL&lt;/property&gt;
+  &lt;property name=&quot;window_position&quot;&gt;GTK_WIN_POS_NONE&lt;/property&gt;
+  &lt;property name=&quot;modal&quot;&gt;False&lt;/property&gt;
+  &lt;property name=&quot;resizable&quot;&gt;False&lt;/property&gt;
+  &lt;property name=&quot;destroy_with_parent&quot;&gt;False&lt;/property&gt;
+  &lt;property name=&quot;has_separator&quot;&gt;False&lt;/property&gt;
+
+  &lt;child internal-child=&quot;vbox&quot;&gt;
+    &lt;widget class=&quot;GtkVBox&quot; id=&quot;dialog-vbox4&quot;&gt;
+      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+      &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+      &lt;property name=&quot;spacing&quot;&gt;6&lt;/property&gt;
+
+      &lt;child internal-child=&quot;action_area&quot;&gt;
+	&lt;widget class=&quot;GtkHButtonBox&quot; id=&quot;dialog-action_area4&quot;&gt;
+	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	  &lt;property name=&quot;layout_style&quot;&gt;GTK_BUTTONBOX_END&lt;/property&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkButton&quot; id=&quot;cancelButton&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;label&quot;&gt;gtk-cancel&lt;/property&gt;
+	      &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
+	      &lt;property name=&quot;response_id&quot;&gt;-6&lt;/property&gt;
+	    &lt;/widget&gt;
+	  &lt;/child&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkButton&quot; id=&quot;newButton&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_default&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;has_default&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;label&quot;&gt;gtk-new&lt;/property&gt;
+	      &lt;property name=&quot;use_stock&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;relief&quot;&gt;GTK_RELIEF_NORMAL&lt;/property&gt;
+	      &lt;property name=&quot;response_id&quot;&gt;-5&lt;/property&gt;
+	    &lt;/widget&gt;
+	  &lt;/child&gt;
+	&lt;/widget&gt;
+	&lt;packing&gt;
+	  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	  &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+	  &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+	  &lt;property name=&quot;pack_type&quot;&gt;GTK_PACK_END&lt;/property&gt;
+	&lt;/packing&gt;
+      &lt;/child&gt;
+
+      &lt;child&gt;
+	&lt;widget class=&quot;GtkHBox&quot; id=&quot;hbox45&quot;&gt;
+	  &lt;property name=&quot;border_width&quot;&gt;6&lt;/property&gt;
+	  &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	  &lt;property name=&quot;homogeneous&quot;&gt;False&lt;/property&gt;
+	  &lt;property name=&quot;spacing&quot;&gt;6&lt;/property&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkLabel&quot; id=&quot;label72&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;label&quot; translatable=&quot;yes&quot;&gt;Layout name:&lt;/property&gt;
+	      &lt;property name=&quot;use_underline&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;use_markup&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;justify&quot;&gt;GTK_JUSTIFY_LEFT&lt;/property&gt;
+	      &lt;property name=&quot;wrap&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;selectable&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;xalign&quot;&gt;0.5&lt;/property&gt;
+	      &lt;property name=&quot;yalign&quot;&gt;0.5&lt;/property&gt;
+	      &lt;property name=&quot;xpad&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;ypad&quot;&gt;0&lt;/property&gt;
+	    &lt;/widget&gt;
+	    &lt;packing&gt;
+	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;expand&quot;&gt;False&lt;/property&gt;
+	      &lt;property name=&quot;fill&quot;&gt;False&lt;/property&gt;
+	    &lt;/packing&gt;
+	  &lt;/child&gt;
+
+	  &lt;child&gt;
+	    &lt;widget class=&quot;GtkEntry&quot; id=&quot;layoutName&quot;&gt;
+	      &lt;property name=&quot;visible&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;can_focus&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;editable&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;visibility&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;max_length&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;text&quot; translatable=&quot;yes&quot;&gt;&lt;/property&gt;
+	      &lt;property name=&quot;has_frame&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;invisible_char&quot; translatable=&quot;yes&quot;&gt;*&lt;/property&gt;
+	      &lt;property name=&quot;activates_default&quot;&gt;True&lt;/property&gt;
+	    &lt;/widget&gt;
+	    &lt;packing&gt;
+	      &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	      &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+	      &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+	    &lt;/packing&gt;
+	  &lt;/child&gt;
+	&lt;/widget&gt;
+	&lt;packing&gt;
+	  &lt;property name=&quot;padding&quot;&gt;0&lt;/property&gt;
+	  &lt;property name=&quot;expand&quot;&gt;True&lt;/property&gt;
+	  &lt;property name=&quot;fill&quot;&gt;True&lt;/property&gt;
+	&lt;/packing&gt;
+      &lt;/child&gt;
+    &lt;/widget&gt;
+  &lt;/child&gt;
+&lt;/widget&gt;
+
 &lt;/glade-interface&gt;

Added: trunk/MonoDevelop/gdldock/gdl/DockLayout.custom
===================================================================
--- trunk/MonoDevelop/gdldock/gdl/DockLayout.custom	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/gdldock/gdl/DockLayout.custom	2004-03-20 05:17:14 UTC (rev 1200)
@@ -0,0 +1,18 @@
+// DockLayout.custom - customizations to Gdl.DockLayout
+//
+// Authors: Gustavo Gir&#225;ldez  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">gustavo.giraldez at gmx.net</A>&gt;
+
+[DllImport(&quot;gdldock&quot;)]
+static extern IntPtr gdl_dock_layout_get_layouts(IntPtr raw, bool include_default);
+
+public string[] GetLayouts(bool include_default) {
+	IntPtr list_ptr = gdl_dock_layout_get_layouts(Handle, include_default);
+	GLib.List list = new GLib.List (list_ptr, typeof (string));
+
+	// FIXME: list elements are leaked
+	string[] result = new string [list.Count];
+	for (int i = 0; i &lt; list.Count; i++)
+		result [i] = list [i] as string;
+	
+	return result;
+}

Modified: trunk/MonoDevelop/gdldock/gdl/Gdl.metadata
===================================================================
--- trunk/MonoDevelop/gdldock/gdl/Gdl.metadata	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/gdldock/gdl/Gdl.metadata	2004-03-20 05:17:14 UTC (rev 1200)
@@ -1,6 +1,7 @@
 &lt;metadata&gt;
   &lt;attr path=&quot;/api/namespace/object[@cname='GdlDockObject']/signal[@name='Detach']&quot; name=&quot;name&quot;&gt;Detached&lt;/attr&gt;
   &lt;attr path=&quot;/api/namespace/object[@cname='GdlDockObject']/signal[@name='Dock']&quot; name=&quot;name&quot;&gt;Docked&lt;/attr&gt;
+  &lt;attr path=&quot;/api/namespace/object[@cname='GdlDockLayout']/method[@name='GetLayouts']&quot; name=&quot;hidden&quot;&gt;1&lt;/attr&gt;
   &lt;attr path=&quot;/api/namespace/enum[@cname='GdlDockItemFlags']&quot; name=&quot;hidden&quot;&gt;1&lt;/attr&gt;
   &lt;attr path=&quot;/api/namespace/enum[@cname='GdlDockParamFlags']&quot; name=&quot;hidden&quot;&gt;1&lt;/attr&gt;
 &lt;/metadata&gt;

Modified: trunk/MonoDevelop/gdldock/gdl/Makefile.am
===================================================================
--- trunk/MonoDevelop/gdldock/gdl/Makefile.am	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/gdldock/gdl/Makefile.am	2004-03-20 05:17:14 UTC (rev 1200)
@@ -6,17 +6,17 @@
 	@gtksharp_prefix@/share/gapi/gdk-api.xml \
 	@gtksharp_prefix@/share/gapi/gtk-api.xml \
 	@gtksharp_prefix@/share/gapi/atk-api.xml
-	
+
 all: $(ASSEMBLY)
 
-gdl-api.xml:
+gdl-api.xml: $(srcdir)/gdl-api.raw $(srcdir)/Gdl.metadata
 	cp $(srcdir)/gdl-api.raw gdl-api.xml
 	chmod u+w gdl-api.xml
 	gapi-fixup --api=gdl-api.xml --metadata=$(srcdir)/Gdl.metadata
 
 generated-stamp: gdl-api.xml
 	gapi-codegen --generate gdl-api.xml --include $(INCLUDE_APIS) --outdir=generated --customdir=$(srcdir) --assembly-name=gdl-sharp &amp;&amp; touch generated-stamp
- 
+
 $(ASSEMBLY): generated-stamp ../../build/bin
 	$(MCS) --unsafe --target library \
 	-r glib-sharp -r gtk-sharp -r gdk-sharp \
@@ -28,7 +28,7 @@
 
 gdldocklibdir = $(prefix)/lib/monodevelop/bin
 gdldocklib_DATA = $(ASSEMBLY)
- 
+
 clean:
 	rm -f $(ASSEMBLY)
 	rm -f generated-stamp
@@ -36,5 +36,5 @@
 
 CLEANFILES=$(ASSEMBLY) generated-stamp generated/* gdl-api.xml
 
-EXTRA_DIST = gdl-api.raw Gdl.metadata DockItemFlags.cs DockParamFlags.cs
+EXTRA_DIST = gdl-api.raw Gdl.metadata DockItemFlags.cs DockParamFlags.cs DockLayout.custom
 

Modified: trunk/MonoDevelop/src/Main/Base/Commands/MenuItemBuilders.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Commands/MenuItemBuilders.cs	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Commands/MenuItemBuilders.cs	2004-03-20 05:17:14 UTC (rev 1200)
@@ -377,4 +377,50 @@
 			return (Gtk.MenuItem[])items.ToArray(typeof(Gtk.MenuItem));
 		}
 	}
+
+	public class LayoutsMenuBuilder : ISubmenuBuilder
+	{
+		class MyMenuItem : SdMenuCheckBox
+		{
+			string layoutName;
+			
+			bool IsCurrentLayout {
+				get {
+					return (WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout == layoutName);
+				}
+			}
+			
+			public MyMenuItem (string name) : base (null, null, name)
+			{
+				this.layoutName = name;
+				Active = IsCurrentLayout;
+				Toggled += new EventHandler (OnClick);
+			}
+			
+			protected new void OnClick(object o, EventArgs e)
+			{
+				WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout = layoutName;
+			}
+			public override  void UpdateStatus()
+			{
+				base.UpdateStatus();
+			}
+		}
+		
+		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
+		{
+			ArrayList items = new ArrayList();
+			IWorkbench wb = WorkbenchSingleton.Workbench;
+			if (wb.WorkbenchLayout != null)
+			{
+				string[] layouts = wb.WorkbenchLayout.Layouts;
+				Array.Sort (layouts);
+				foreach (string layout in layouts) {
+					items.Add (new MyMenuItem (layout));
+				}
+			}
+			
+			return (Gtk.MenuItem[]) items.ToArray (typeof (Gtk.MenuItem));
+		}
+	}
 }

Modified: trunk/MonoDevelop/src/Main/Base/Commands/ToolsCommands.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Commands/ToolsCommands.cs	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Commands/ToolsCommands.cs	2004-03-20 05:17:14 UTC (rev 1200)
@@ -43,5 +43,12 @@
 		}
 	}
 	
-	
+	public class NewLayoutCommand : AbstractMenuCommand
+	{
+		public override void Run()
+		{
+			NewLayoutDialog dlg = new NewLayoutDialog ();
+			dlg.Run ();
+		}
+	}
 }

Added: trunk/MonoDevelop/src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Gui/Dialogs/NewLayoutDialog.cs	2004-03-20 05:17:14 UTC (rev 1200)
@@ -0,0 +1,60 @@
+// NewLayoutDialog.cs
+//
+// Authors: Gustavo Gir&#225;ldez  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">gustavo.giraldez at gmx.net</A>&gt;
+
+using System;
+
+using Gtk;
+
+using MonoDevelop.Gui;
+
+namespace MonoDevelop.Gui.Dialogs
+{
+	public class NewLayoutDialog
+	{
+		IWorkbenchLayout wbLayout = WorkbenchSingleton.Workbench.WorkbenchLayout;
+		string[] existentLayouts;
+
+		[Glade.Widget] Entry layoutName;
+		[Glade.Widget] Button cancelButton;
+		[Glade.Widget] Button newButton;
+		[Glade.Widget] Dialog newLayoutDialog;
+
+		public NewLayoutDialog ()
+		{
+			Glade.XML xml = new Glade.XML (null, &quot;Base.glade&quot;,
+			                               &quot;newLayoutDialog&quot;, null);
+			xml.Autoconnect (this);
+			
+			newButton.Sensitive = false;
+			newButton.GrabDefault ();
+			
+			layoutName.Changed += new EventHandler (OnNameChanged);
+
+			if (wbLayout != null)
+				existentLayouts = wbLayout.Layouts;
+		}
+
+		void OnNameChanged (object obj, EventArgs args)
+		{
+			newButton.Sensitive = (layoutName.Text != &quot;&quot; &amp;&amp;
+			                       Array.IndexOf (existentLayouts, layoutName.Text) == -1);
+		}
+
+		public void Run ()
+		{
+			if (wbLayout == null)
+				return;
+			
+			ResponseType response = (ResponseType) newLayoutDialog.Run ();
+			switch (response)
+			{
+			case ResponseType.Ok:
+				wbLayout.CurrentLayout = layoutName.Text;
+				break;
+			}
+
+			newLayoutDialog.Destroy ();
+		}
+	}
+}

Modified: trunk/MonoDevelop/src/Main/Base/Gui/IWorkbenchLayout.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Gui/IWorkbenchLayout.cs	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Gui/IWorkbenchLayout.cs	2004-03-20 05:17:14 UTC (rev 1200)
@@ -29,12 +29,22 @@
 			get;
 		}
 
+		/// &lt;summary&gt;
+		/// The name of the active layout.
+		/// &lt;/summary&gt;
 		string CurrentLayout {
 			get;
 			set;
 		}
-		
+
 		/// &lt;summary&gt;
+		/// A list of the currently available layouts for the current workbench context.
+		/// &lt;/summary&gt;
+		string[] Layouts {
+			get;
+		}
+
+		/// &lt;summary&gt;
 		/// Attaches this layout manager to a workbench object.
 		/// &lt;/summary&gt;
 		void Attach(IWorkbench workbench);

Modified: trunk/MonoDevelop/src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs	2004-03-20 05:17:14 UTC (rev 1200)
@@ -29,9 +29,17 @@
 	{
 		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
 		static string configFile = propertyService.ConfigDirectory + &quot;DefaultEditingLayout.xml&quot;;
-		private string currentLayout = &quot;&quot;;
 
+		// contains the fully qualified name of the current layout (ie. Edit.Default)
+		string currentLayout = &quot;&quot;;
+		// list of layout names for the current context, without the context prefix
+		ArrayList layouts = new ArrayList ();
+
 		private IWorkbench workbench;
+
+		// current workbench context
+		WorkbenchContext workbenchContext;
+		
 		Window wbWindow;
 		Container rootWidget;
 		Container toolbarContainer;
@@ -114,6 +122,7 @@
 				dock.AddItem (item, DockPlacement.Left);
 			}
 			// by default, the active pad collection is the full set
+			// will be overriden in CreateDefaultLayout() below
 			activePadCollection = workbench.PadContentCollection;
 
 			// FIXME: GTKize
@@ -129,13 +138,13 @@
 
 		void onContextChanged (object o, EventArgs e)
 		{
-			WorkbenchContext ctxt = workbench.Context;
-			Console.WriteLine (&quot;Workbench changed context to &quot; + ctxt);
-			SwitchContext (ctxt);
+			SwitchContext (workbench.Context);
 		}
 
 		void SwitchContext (WorkbenchContext ctxt)
 		{
+			PropertyService propertyService =
+				(PropertyService) ServiceManager.Services.GetService (typeof (PropertyService));
 			PadContentCollection old = activePadCollection;
 			
 			// switch pad collections
@@ -145,19 +154,23 @@
 				// this is so, for unkwown contexts, we get the full set of pads
 				activePadCollection = workbench.PadContentCollection;
 
-			switch (ctxt)
-			{
-			case WorkbenchContext.Debug:
-				CurrentLayout = &quot;Debug&quot;;
-				break;
+			workbenchContext = ctxt;
+			
+			// get the list of layouts
+			string ctxtPrefix = ctxt.ToString () + &quot;.&quot;;
+			string[] list = dockLayout.GetLayouts (false);
 
-			default:
-			case WorkbenchContext.Edit:
-				CurrentLayout = &quot;Default&quot;;
-				break;
-
+			layouts.Clear ();
+			foreach (string name in list) {
+				if (name.StartsWith (ctxtPrefix)) {
+					layouts.Add (name.Substring (ctxtPrefix.Length));
+				}
 			}
 			
+			// get the default layout for the new context from the property service
+			CurrentLayout = propertyService.GetProperty
+				(&quot;MonoDevelop.Gui.SdiWorkbenchLayout.&quot; + ctxt.ToString (), &quot;Default&quot;);
+			
 			// make sure invalid pads for the new context are not visible
 			foreach (IPadContent content in old)
 			{
@@ -175,24 +188,51 @@
 		}
 		
 		public string CurrentLayout {
-			get
-			{
-				return currentLayout;
+			get {
+				return currentLayout.Substring (currentLayout.IndexOf (&quot;.&quot;) + 1);
 			}
-			set
-			{
+			set {
+				// save previous layout first
 				if (currentLayout != &quot;&quot;)
 					dockLayout.SaveLayout (currentLayout);
 				
-				currentLayout = value;
+				string newLayout = workbench.Context.ToString () + &quot;.&quot; + value;
 
-				if (!dockLayout.LoadLayout (value))
-					// if the &quot;Default&quot; layout doesn't exists, load the real default
-					// so old layout xml files work smoothly
-					dockLayout.LoadLayout (null);
+				if (layouts.Contains (value))
+				{
+					dockLayout.LoadLayout (newLayout);
+				}
+				else
+				{
+					if (currentLayout == &quot;&quot;)
+						// if the layout doesn't exists and we need to
+						// load a layout (ie.  we've just been
+						// created), load the default so old layout
+						// xml files work smoothly
+						dockLayout.LoadLayout (null);
+					
+					// the layout didn't exist, so save it and add it to our list
+					dockLayout.SaveLayout (newLayout);
+					layouts.Add (value);
+				}
+				currentLayout = newLayout;
+
+				// persist the selected layout for the current context
+				PropertyService propertyService =
+					(PropertyService) ServiceManager.Services.GetService (typeof (PropertyService));
+				propertyService.SetProperty (&quot;MonoDevelop.Gui.SdiWorkbenchLayout.&quot; +
+				                             workbenchContext.ToString (), value);
 			}
 		}
 
+		public string[] Layouts {
+			get {
+				string[] result = new string [layouts.Count];
+				layouts.CopyTo (result);
+				return result;
+			}
+		}
+
 		// pad collection for the current workbench context
 		PadContentCollection activePadCollection;
 

Modified: trunk/MonoDevelop/src/Main/Base/Makefile.am
===================================================================
--- trunk/MonoDevelop/src/Main/Base/Makefile.am	2004-03-20 04:28:51 UTC (rev 1199)
+++ trunk/MonoDevelop/src/Main/Base/Makefile.am	2004-03-20 05:17:14 UTC (rev 1200)
@@ -106,6 +106,7 @@
 ./Gui/Dialogs/InputBox.cs \
 ./Gui/Dialogs/NewFileDialog.cs \
 ./Gui/Dialogs/ProjectOptionsDialog.cs \
+./Gui/Dialogs/NewLayoutDialog.cs \
 ./Gui/ContentInterfaces/IBookmarkOperations.cs \
 ./Gui/ContentInterfaces/IClipboardHandler.cs \
 ./Gui/ContentInterfaces/IPrintable.cs \


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000806.html">[Monodevelop-patches-list] r1199 - in trunk/MonoDevelop: . src/Libraries/MonoDevelop.Core/Services src/Main/Base/Commands src/Main/Base/Services
</A></li>
	<LI>Next message: <A HREF="000808.html">[Monodevelop-patches-list] r1201 - in trunk/MonoDevelop: . gdldock/gdl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#807">[ date ]</a>
              <a href="thread.html#807">[ thread ]</a>
              <a href="subject.html#807">[ subject ]</a>
              <a href="author.html#807">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
