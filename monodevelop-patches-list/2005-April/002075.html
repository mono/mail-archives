<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2474 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Commands Gui Gui/Components Gui/Dialogs Gui/Pads/ClassPad Gui/Pads/ProjectPad Gui/Pads/SolutionPad Gui/Workbench Gui/Workbench/Layouts Internal/Codons Internal/Codons/Commands Internal/Codons/Pads Internal/Conditions Internal/Project/Combine Internal/Project/Project Services Services/File Services/Project
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2474%20-%20in%20trunk/MonoDevelop/Core/src/MonoDevelop.Base%3A%20.%20Commands%20Gui%20Gui/Components%20Gui/Dialogs%20Gui/Pads/ClassPad%20Gui/Pads/ProjectPad%20Gui/Pads/SolutionPad%20Gui/Workbench%20Gui/Workbench/Layouts%20Internal/Codons%20Internal/Codons/Commands%20Internal/Codons/Pads%20Internal/Conditions%20Internal/Project/Combine%20Internal/Project/Project%20Services%20Services/File%20Services/Project&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002074.html">
   <LINK REL="Next"  HREF="002076.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2474 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Commands Gui Gui/Components Gui/Dialogs Gui/Pads/ClassPad Gui/Pads/ProjectPad Gui/Pads/SolutionPad Gui/Workbench Gui/Workbench/Layouts Internal/Codons Internal/Codons/Commands Internal/Codons/Pads Internal/Conditions Internal/Project/Combine Internal/Project/Project Services Services/File Services/Project</H1>
    <B>Lluis Sanchez &lt;lluis@ximian.com&gt;</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2474%20-%20in%20trunk/MonoDevelop/Core/src/MonoDevelop.Base%3A%20.%20Commands%20Gui%20Gui/Components%20Gui/Dialogs%20Gui/Pads/ClassPad%20Gui/Pads/ProjectPad%20Gui/Pads/SolutionPad%20Gui/Workbench%20Gui/Workbench/Layouts%20Internal/Codons%20Internal/Codons/Commands%20Internal/Codons/Pads%20Internal/Conditions%20Internal/Project/Combine%20Internal/Project/Project%20Services%20Services/File%20Services/Project&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2474 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Commands Gui Gui/Components Gui/Dialogs Gui/Pads/ClassPad Gui/Pads/ProjectPad Gui/Pads/SolutionPad Gui/Workbench Gui/Workbench/Layouts Internal/Codons Internal/Codons/Commands Internal/Codons/Pads Internal/Conditions Internal/Project/Combine Internal/Project/Project Services Services/File Services/Project">lluis at mono-cvs.ximian.com
       </A><BR>
    <I>Mon Apr 25 16:35:12 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002074.html">[Monodevelop-patches-list] r2473 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Gui/Dialogs
</A></li>
        <LI>Next message: <A HREF="002076.html">[Monodevelop-patches-list] r2475 - in trunk/MonoDevelop/Core/src/AddIns/DisplayBindings/SourceEditor: . Commands Gui Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2075">[ date ]</a>
              <a href="thread.html#2075">[ thread ]</a>
              <a href="subject.html#2075">[ subject ]</a>
              <a href="author.html#2075">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: lluis
Date: 2005-04-25 16:35:11 -0400 (Mon, 25 Apr 2005)
New Revision: 2474

Added:
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ViewCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/CommandService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectSolutionPad.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/ViewCommandHandlers.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandCodon.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandItemCodon.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/ItemSetCodon.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/LinkItemCodon.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/SeparatorItemCodon.cs
Removed:
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ClassBrowserCommands/
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/MenuItemBuilders.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ProjectBrowserCommands/
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/RunCommands.cs
Modified:
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/EditCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/FileCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/HelpCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ProjectCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ToolsCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/WindowCommands.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Components/SdMenu.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewFileDialog.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewProjectDialog.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/TreeViewOptions.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/GuiService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ClassPad/ProjectNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/CombineNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/FolderNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFileNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFolderNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceFolderNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ResourceFolderNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ShowAllFilesBuilderExtension.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/SystemFileNodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeBuilder.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeCommandHandler.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/SolutionPad.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/TreeViewPad.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceWindow.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Pads/SolutionPadCodon.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Conditions/WorkbenchContextCondition.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Combine/Combine.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Project/DotNetProject.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Makefile.am
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/MonoDevelopCore.addin.xml
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/IDebuggerService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs
   trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/ProjectService.cs
Log:
2005-04-25  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;

	* Commands/MenuItemBuilders.cs: Removed. Menu builders are now
	implemented as command arrays and handled in the following files.
	* Commands/RunCommands.cs: Removed. Moved to ProjectCommands.
	* Commands/EditCommands.cs: Most of code moved to 
	MonoDevelop.Gui.ViewCommandHandlers.
	
	* Commands/ClassBrowserCommands/ClassBrowserCommands.cs
	* ProjectBrowserCommands/*:
	Removed. Handlers for tree commands are handled by NodeCommandHandler
	objects.
	
	* Commands/FileCommands.cs:
	* ProjectCommands.cs:
	* WindowCommands.cs:
	* HelpCommands.cs:
	* ViewCommands.cs:
	Added enums with IDs for the commands.
	Use the new CommandHandler base class for global commands.
	Removed commands that are not global.
	
	* Gui/ViewCommandHandlers.cs: Implements edit commands for workspace
	windows.
	
	* Services/File/IFileService.cs:
	* Services/File/DefaultFileService.cs: Moved here the code that shows
	the UI for saving files.
	
	* Services/IDebuggerService.cs: The Run method now takes a progress
	monitor, and will (should) stop if the monitor notifies a cancel request.
	
	* Services/Project/IProjectService.cs:
	* Services/Project/ProjectService.cs:
	Factorized the Build* methods into a single Build method which takes
	as parameter what you want to build. The same for Execute* methods.
	Moved here several operations previously implemeted in commands, to
	make it easier to reuse code. This includes: Debug(), Deploy(),
	ShowOptions(), CreateProject(), CreateCombine(),
	AddCombineEntry(), CreateProjectFile(), AddReferenceToProject().
	
	* Gui/Dialogs/NewFileDialog.cs:
	* Gui/Dialogs/NewProjectDialog.cs: Added Run method to show the window
	as a modal dialog.
	
	* Gui/Workbench/Layouts/SdiWorkspaceLayout.cs:
	* Gui/IWorkbench.cs:
	* Gui/Dialogs/TreeViewOptions.cs: Removed old menu code.
	
	* Gui/Workbench/Layouts/SdiWorkspaceWindow.cs: Removed obsolete code.
	Plug the handler class for generic Edit commands into the window.
	
	* Gui/Workbench/DefaultWorkbench.cs: Use the new command service.
	
	* Gui/Components/SdMenu.cs: Moved here the ISubmenuItem interface, 
	which was implemented in MenuItemBuilders.cs.
	
	* Gui/Pads/SolutionPad/NodeCommandHandler.cs:
	* Gui/Pads/SolutionPad/TreeViewPad.cs: Plug node command handlers into
	the new command system.

	* Gui/Pads/SolutionPad/NodeBuilder.cs: Don't reuse command handlers
	since they may store command state information.
	* Gui/Pads/SolutionPad/SolutionPad.cs: Made OnOpenCombine and
	OnCloseCombine virtual.
	* Gui/Pads/ProjectPad/ProjectSolutionPad.cs: Subclass of SolutionPad
	which keeps track of the current selected project.
	
	* Gui/Pads/ProjectPad/*:
	Moved here the handlers for commands previously implemented in
	MonoDevelop.Commands.
	
	* Gui/CommandService.cs:
	* Gui/GuiService.cs: Added the new command service.
	
	* Internal/Codons/Pads/SolutionPadCodon.cs: Subclasses of SolutionPad
	can now be specified in the &quot;class&quot; attribute.
	
	* Internal/Project/Project/DotNetProject.cs: Made the Debug method
	synchronous.
	
	* Internal/Conditions/WorkbenchContextCondition.cs: Set the correct
	class name.
	
	* Internal/Codons/Commands/*: Codons for the new command infrastructure.
	
	* MonoDevelopCore.addin.xml: Defined the new menu and toolbar
	structure.



Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/ChangeLog	2005-04-25 20:35:11 UTC (rev 2474)
@@ -1,3 +1,92 @@
+2005-04-25  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
+
+	* Commands/MenuItemBuilders.cs: Removed. Menu builders are now
+	implemented as command arrays and handled in the following files.
+	* Commands/RunCommands.cs: Removed. Moved to ProjectCommands.
+	* Commands/EditCommands.cs: Most of code moved to 
+	MonoDevelop.Gui.ViewCommandHandlers.
+	
+	* Commands/ClassBrowserCommands/ClassBrowserCommands.cs
+	* ProjectBrowserCommands/*:
+	Removed. Handlers for tree commands are handled by NodeCommandHandler
+	objects.
+	
+	* Commands/FileCommands.cs:
+	* ProjectCommands.cs:
+	* WindowCommands.cs:
+	* HelpCommands.cs:
+	* ViewCommands.cs:
+	Added enums with IDs for the commands.
+	Use the new CommandHandler base class for global commands.
+	Removed commands that are not global.
+	
+	* Gui/ViewCommandHandlers.cs: Implements edit commands for workspace
+	windows.
+	
+	* Services/File/IFileService.cs:
+	* Services/File/DefaultFileService.cs: Moved here the code that shows
+	the UI for saving files.
+	
+	* Services/IDebuggerService.cs: The Run method now takes a progress
+	monitor, and will (should) stop if the monitor notifies a cancel request.
+	
+	* Services/Project/IProjectService.cs:
+	* Services/Project/ProjectService.cs:
+	Factorized the Build* methods into a single Build method which takes
+	as parameter what you want to build. The same for Execute* methods.
+	Moved here several operations previously implemeted in commands, to
+	make it easier to reuse code. This includes: Debug(), Deploy(),
+	ShowOptions(), CreateProject(), CreateCombine(),
+	AddCombineEntry(), CreateProjectFile(), AddReferenceToProject().
+	
+	* Gui/Dialogs/NewFileDialog.cs:
+	* Gui/Dialogs/NewProjectDialog.cs: Added Run method to show the window
+	as a modal dialog.
+	
+	* Gui/Workbench/Layouts/SdiWorkspaceLayout.cs:
+	* Gui/IWorkbench.cs:
+	* Gui/Dialogs/TreeViewOptions.cs: Removed old menu code.
+	
+	* Gui/Workbench/Layouts/SdiWorkspaceWindow.cs: Removed obsolete code.
+	Plug the handler class for generic Edit commands into the window.
+	
+	* Gui/Workbench/DefaultWorkbench.cs: Use the new command service.
+	
+	* Gui/Components/SdMenu.cs: Moved here the ISubmenuItem interface, 
+	which was implemented in MenuItemBuilders.cs.
+	
+	* Gui/Pads/SolutionPad/NodeCommandHandler.cs:
+	* Gui/Pads/SolutionPad/TreeViewPad.cs: Plug node command handlers into
+	the new command system.
+
+	* Gui/Pads/SolutionPad/NodeBuilder.cs: Don't reuse command handlers
+	since they may store command state information.
+	* Gui/Pads/SolutionPad/SolutionPad.cs: Made OnOpenCombine and
+	OnCloseCombine virtual.
+	* Gui/Pads/ProjectPad/ProjectSolutionPad.cs: Subclass of SolutionPad
+	which keeps track of the current selected project.
+	
+	* Gui/Pads/ProjectPad/*:
+	Moved here the handlers for commands previously implemented in
+	MonoDevelop.Commands.
+	
+	* Gui/CommandService.cs:
+	* Gui/GuiService.cs: Added the new command service.
+	
+	* Internal/Codons/Pads/SolutionPadCodon.cs: Subclasses of SolutionPad
+	can now be specified in the &quot;class&quot; attribute.
+	
+	* Internal/Project/Project/DotNetProject.cs: Made the Debug method
+	synchronous.
+	
+	* Internal/Conditions/WorkbenchContextCondition.cs: Set the correct
+	class name.
+	
+	* Internal/Codons/Commands/*: Codons for the new command infrastructure.
+	
+	* MonoDevelopCore.addin.xml: Defined the new menu and toolbar
+	structure.
+
 2005-04-25	John Luke	&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
 
 	* Gui/Dialogs/NewProjectDialog.cs

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/EditCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/EditCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/EditCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -1,274 +1,36 @@
-// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt&quot;/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt&quot;/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Kr&#252;ger&quot; email=&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">mike at icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
 
 using System;
-using System.IO;
-using System.Threading;
-using System.Drawing;
-using System.Drawing.Printing;
-using System.Collections;
-using System.ComponentModel;
-using System.Diagnostics;
-
+using MonoDevelop.Gui.Dialogs;
+using MonoDevelop.Services;
+using MonoDevelop.Core.Properties;
 using MonoDevelop.Core.AddIns;
 
-using MonoDevelop.Core.Properties;
-using MonoDevelop.Core.AddIns.Codons;
-
-using MonoDevelop.Gui;
-using MonoDevelop.Gui.Dialogs;
-
 namespace MonoDevelop.Commands
 {
-	public class Undo : AbstractMenuCommand
+	public enum EditCommands
 	{
-		public override void Run()
-		{
-			IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-			if (editable != null) {
-				editable.Undo();
-			}
-		}
+		Copy,
+		Cut,
+		Paste,
+		Delete,
+		Rename,
+		Undo,
+		Redo,
+		SelectAll,
+		CommentCode,
+		UncommentCode,
+		IndentSelection,
+		UnIndentSelection,
+		WordCount,
+		MonodevelopPreferences
 	}
 	
-	public class Redo : AbstractMenuCommand
+	public class MonodevelopPreferencesHandler: CommandHandler
 	{
-		public override void Run()
+		protected override void Run ()
 		{
-			IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-			if (editable != null) {
-				editable.Redo();
-			}
+			new TreeViewOptions((IProperties)Runtime.Properties.GetProperty(&quot;MonoDevelop.TextEditor.Document.Document.DefaultDocumentAggregatorProperties&quot;, new DefaultProperties()),
+			                                                           AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Dialogs/OptionsDialog&quot;));
 		}
 	}
-
-	public class Cut : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return editable.ClipboardHandler.EnableCut;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-			if (IsEnabled) {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					editable.ClipboardHandler.Cut(null, null);
-				}
-			}
-		}
-	}
-	
-	public class Copy : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return editable.ClipboardHandler.EnableCopy;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-			if (IsEnabled) {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					editable.ClipboardHandler.Copy(null, null);
-				}
-			}
-		}
-	}
-	
-	public class Paste : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return editable.ClipboardHandler.EnablePaste;
-				}
-				return false;
-			}
-		}
-		public override void Run()
-		{
-			if (IsEnabled) {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					editable.ClipboardHandler.Paste(null, null);
-				}
-			}
-		}
-	}
-	
-	public class Delete : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return editable.ClipboardHandler.EnableDelete;
-				}
-				return false;
-			}
-		}
-		public override void Run()
-		{
-			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			
-			if (window != null &amp;&amp; window.ViewContent is IEditable) {
-				if (((IEditable)window.ViewContent).ClipboardHandler != null) {
-					((IEditable)window.ViewContent).ClipboardHandler.Delete(null, null);
-				}
-			}
-		}
-	}
-	
-	public class SelectAll : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return editable.ClipboardHandler.EnableSelectAll;
-				}
-				return false;
-			}
-		}
-		public override void Run()
-		{
-			if (IsEnabled) {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					editable.ClipboardHandler.SelectAll(null, null);
-				}
-			}
-		}
-	}
-
-	public class WordCount : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			WordCountDialog wcd = new WordCountDialog ();
-			wcd.Run ();
-			wcd.Hide ();
-		}
-	}
-	
-	public class CommentCode : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return true;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				ICodeStyleOperations  styling = window != null ? window.ActiveViewContent as ICodeStyleOperations : null;
-				if (styling != null) {
-					styling.CommentCode ();
-				}
-		}
-	}
-	
-	public class UncommentCode : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return true;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				ICodeStyleOperations  styling = window != null ? window.ActiveViewContent as ICodeStyleOperations : null;
-				if (styling != null) {
-					styling.UncommentCode ();
-				}
-		}
-	}
-	
-	public class IndentSelection : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return true;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				ICodeStyleOperations  styling = window != null ? window.ActiveViewContent as ICodeStyleOperations : null;
-				if (styling != null) {
-					styling.IndentSelection ();
-				}
-		}
-	}
-	
-	public class UnIndentSelection : AbstractMenuCommand
-	{
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IEditable        editable = window != null ? window.ActiveViewContent as IEditable : null;
-				if (editable != null) {
-					return true;
-				}
-				return false;
-			}
-		}
-		
-		public override void Run()
-		{
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				ICodeStyleOperations  styling = window != null ? window.ActiveViewContent as ICodeStyleOperations : null;
-				if (styling != null) {
-					styling.UnIndentSelection ();
-				}
-		}
-	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/FileCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/FileCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/FileCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -19,178 +19,62 @@
 using MonoDevelop.Gui.Widgets;
 using MonoDevelop.Gui.Dialogs;
 using MonoDevelop.Gui.ErrorHandlers;
+using Freedesktop.RecentFiles;
 
 namespace MonoDevelop.Commands
 {
-	public class CreateNewProject : AbstractMenuCommand
+	public enum FileCommands
 	{
-		public override void Run ()
-		{
-			new NewProjectDialog (true);
-		}
+		OpenFile,
+		NewFile,
+		NewProject,
+		CloseFile,
+		CloseAllFiles,
+		CloseCombine,
+		ReloadFile,
+		Save,
+		SaveAll,
+		SaveAs,
+		RecentFileList,
+		ClearRecentFiles,
+		RecentProjectList,
+		ClearRecentProjects,
+		Exit,
+		ClearCombine
 	}
 	
-	public class CreateNewFile : AbstractMenuCommand
+	public class NewProjectHandler : CommandHandler
 	{
-		public override void Run ()
+		protected override void Run ()
 		{
-			new NewFileDialog ();
+			NewProjectDialog pd = new NewProjectDialog (true);
+			pd.Run ();
 		}
 	}
 	
-	public class CloseFile : AbstractMenuCommand
+	public class NewFileHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run ()
 		{
-			if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
-				WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.CloseWindow(false, true, 0);
-			}
+			NewFileDialog fd = new NewFileDialog ();
+			fd.Run ();
 		}
 	}
 	
-	public class CloseAllFiles : AbstractMenuCommand
+	public class CloseAllFilesHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{
 			if ( WorkbenchSingleton.Workbench != null ) {
 				WorkbenchSingleton.Workbench.CloseAllViews();
 			}
 		}
 	}
-
-	public class SaveFile : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			if (window != null) {
-				if (window.ViewContent.IsViewOnly) {
-					return;
-				}
-				
-				if (window.ViewContent.ContentName == null) {
-					SaveFileAs sfa = new SaveFileAs();
-					sfa.Run();
-				} else {
-					FileAttributes attr = FileAttributes.ReadOnly | FileAttributes.Directory | FileAttributes.Offline | FileAttributes.System;
-					// FIXME
-					// bug #59731 is if the file is moved out from under us, we were crashing
-					// I changed it to make it ask for a new
-					// filename instead, but maybe we should
-					// detect the move and update the reference
-					// to the name instead
-					if (!File.Exists (window.ViewContent.ContentName) || (File.GetAttributes(window.ViewContent.ContentName) &amp; attr) != 0) {
-						SaveFileAs sfa = new SaveFileAs();
-						sfa.Run();
-					} else {						
-						Runtime.ProjectService.MarkFileDirty(window.ViewContent.ContentName);
-						string fileName = window.ViewContent.ContentName;
-						// save backup first						
-						if((bool) Runtime.Properties.GetProperty (&quot;SharpDevelop.CreateBackupCopy&quot;, false)) {
-							Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), fileName + &quot;~&quot;);
-						}
-						Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), fileName);
-					}
-				}
-			}
-		}
-		
-		public override bool IsEnabled {
-			get {
-				IWorkbenchWindow window   = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-				IViewContent content = window != null ? window.ActiveViewContent as IViewContent : null;
-				if (content != null) {
-					return content.IsDirty;
-				}
-				return false;
-			}
-		}
-	} 
-
-	public class ReloadFile : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			
-			if (window != null &amp;&amp; window.ViewContent.ContentName != null &amp;&amp; !window.ViewContent.IsViewOnly) {
-				if (Runtime.MessageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure that you want to reload the file?&quot;))) {
-					IXmlConvertable memento = null;
-					if (window.ViewContent is IMementoCapable) {
-						memento = ((IMementoCapable)window.ViewContent).CreateMemento();
-					}
-					window.ViewContent.Load(window.ViewContent.ContentName);
-					if (memento != null) {
-						((IMementoCapable)window.ViewContent).SetMemento(memento);
-					}
-				}
-			}
-		}
-	}
 	
-	public class SaveFileAs : AbstractMenuCommand
+	public class SaveAllHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{
-			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
-			
-			if (window != null) {
-				if (window.ViewContent.IsViewOnly) {
-					return;
-				}
-				if (window.ViewContent is ICustomizedCommands) {
-					if (((ICustomizedCommands)window.ViewContent).SaveAsCommand()) {
-						return;
-					}
-				}
-				/*
-				using (SaveFileDialog fdiag = new SaveFileDialog()) {
-					fdiag.OverwritePrompt = true;
-					fdiag.AddExtension    = true;
-					
-					string[] fileFilters  = (string[])(AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/FileFilter&quot;).BuildChildItems(this)).ToArray(typeof(string));
-					fdiag.Filter          = String.Join(&quot;|&quot;, fileFilters);
-					for (int i = 0; i &lt; fileFilters.Length; ++i) {
-						if (fileFilters[i].IndexOf(Path.GetExtension(window.ViewContent.ContentName == null ? window.ViewContent.UntitledName : window.ViewContent.ContentName)) &gt;= 0) {
-							fdiag.FilterIndex = i + 1;
-							break;
-						}
-					}*/
-					FileSelector fdiag = new FileSelector (GettextCatalog.GetString (&quot;Save as...&quot;), Gtk.FileChooserAction.Save);
-					fdiag.SetFilename (window.ViewContent.ContentName);
-					int response = fdiag.Run ();
-					string filename = fdiag.Filename;
-					fdiag.Hide ();
-				
-					if (response == (int)Gtk.ResponseType.Ok) {
-						if (!Runtime.FileUtilityService.IsValidFileName (filename)) {
-							Runtime.MessageService.ShowMessage(String.Format (GettextCatalog.GetString (&quot;File name {0} is invalid&quot;), filename));
-							return;
-						}
-						// detect preexisting file
-						if(File.Exists(filename)){
-							if(!Runtime.MessageService.AskQuestion(String.Format (GettextCatalog.GetString (&quot;File {0} already exists.  Overwrite?&quot;), filename))){
-								return;
-							}
-						}
-					// save backup first
-					if((bool) Runtime.Properties.GetProperty (&quot;SharpDevelop.CreateBackupCopy&quot;, false)) {
-						Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), filename + &quot;~&quot;);
-					}
-					
-					// do actual save
-					if (Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), filename) == FileOperationResult.OK) {
-						Runtime.FileService.RecentOpen.AddLastFile (filename, null);
-					}
-				}
-			}
-		}
-	}
-	
-	public class SaveAllFiles : AbstractMenuCommand
-	{
-		public override void Run()
-		{
 			foreach (IViewContent content in WorkbenchSingleton.Workbench.ViewContentCollection) {
 				if (content.IsViewOnly) {
 					continue;
@@ -226,42 +110,12 @@
 				}
 			}
 		}
-	}
+	}	
 	
-	public class OpenCombine : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			using (FileSelector fs = new FileSelector (GettextCatalog.GetString (&quot;File to Open&quot;))) {
-				int response = fs.Run ();
-				string name = fs.Filename;
-				fs.Hide ();
 
-				if (response == (int)Gtk.ResponseType.Ok) {
-					switch (Path.GetExtension(name).ToUpper()) {
-						case &quot;.CMBX&quot;: // Don't forget the 'recent' projects if you chance something here
-						case &quot;.PRJX&quot;:
-						case &quot;.MDP&quot;:
-						case &quot;.MDS&quot;:
-							try {
-								//Runtime.ProjectService.OpenCombine(name);
-								Runtime.FileService.OpenFile(name);
-							} catch (Exception ex) {
-								CombineLoadError.HandleError(ex, name);
-							}
-							break;
-						default:
-							Runtime.MessageService.ShowError(String.Format (GettextCatalog.GetString (&quot;Can't open file {0} as project&quot;), name));
-							break;
-					}
-				}
-			}
-		}
-	}
-	
-	public class OpenFile : AbstractMenuCommand
+	public class OpenFileHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{
 			//string[] fileFilters  = (string[])(AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/FileFilter&quot;).BuildChildItems(this)).ToArray(typeof(string));
 			//bool foundFilter      = false;
@@ -307,17 +161,22 @@
 		}
 	}
 	
-	public class ClearCombine : AbstractMenuCommand
+	public class CloseCombineHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{
 			Runtime.ProjectService.CloseCombine();
 		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			info.Enabled = (Runtime.ProjectService.CurrentOpenCombine != null);
+		}
 	}
 		
-	public class ExitWorkbenchCommand : AbstractMenuCommand
+	public class ExitHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{			
 			if (((DefaultWorkbench)WorkbenchSingleton.Workbench).Close()) {
 				Gtk.Application.Quit();
@@ -325,9 +184,10 @@
 		}
 	}
 	
-	public class Print : AbstractMenuCommand
+	
+	public class PrintHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{/*
 			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
 			
@@ -354,9 +214,9 @@
 		}
 	}
 	
-	public class PrintPreview : AbstractMenuCommand
+	public class PrintPreviewHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{
 		/*	try {
 				IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
@@ -382,9 +242,9 @@
 		}
 	}
 	
-	public class ClearRecentFiles : AbstractMenuCommand
+	public class ClearRecentFilesHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{			
 			try {
 				if (Runtime.FileService.RecentOpen.RecentFile != null &amp;&amp; Runtime.FileService.RecentOpen.RecentFile.Length &gt; 0 &amp;&amp; Runtime.MessageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent files list?&quot;), GettextCatalog.GetString (&quot;Clear recent files&quot;)))
@@ -393,11 +253,17 @@
 				}
 			} catch {}
 		}
+	
+		protected override void Update (CommandInfo info)
+		{
+			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
+			info.Enabled = (recentOpen.RecentFile != null &amp;&amp; recentOpen.RecentFile.Length &gt; 0);
+		}
 	}
 	
-	public class ClearRecentProjects : AbstractMenuCommand
+	public class ClearRecentProjectsHandler : CommandHandler
 	{
-		public override void Run()
+		protected override void Run()
 		{			
 			try {
 				if (Runtime.FileService.RecentOpen.RecentProject != null &amp;&amp; Runtime.FileService.RecentOpen.RecentProject.Length &gt; 0 &amp;&amp; Runtime.MessageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent projects list?&quot;), GettextCatalog.GetString (&quot;Clear recent projects&quot;)))
@@ -406,5 +272,64 @@
 				}
 			} catch {}
 		}
+	
+		protected override void Update (CommandInfo info)
+		{
+			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
+			info.Enabled = (recentOpen.RecentProject != null &amp;&amp; recentOpen.RecentProject.Length &gt; 0);
+		}
 	}
+
+	public class RecentFileListHandler : CommandHandler
+	{
+		protected override void Update (CommandArrayInfo info)
+		{
+			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
+			if (recentOpen.RecentFile != null &amp;&amp; recentOpen.RecentFile.Length &gt; 0) {
+				for (int i = 0; i &lt; recentOpen.RecentFile.Length; ++i) {
+					string accelaratorKeyPrefix = i &lt; 10 ? &quot;_&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
+					RecentItem ri = recentOpen.RecentFile[i];
+					string label = ((ri.Private == null || ri.Private.Length &lt; 1) ? Path.GetFileName (ri.ToString ()) : ri.Private);
+					CommandInfo cmd = new CommandInfo (accelaratorKeyPrefix + label.Replace (&quot;_&quot;, &quot;__&quot;));
+					info.Add (cmd, ri);
+				}
+			}
+		}
+		
+		protected override void Run (object dataItem)
+		{
+			Runtime.FileService.OpenFile (dataItem.ToString());
+		}
+	}
+
+	public class RecentProjectListHandler : CommandHandler
+	{
+		protected override void Update (CommandArrayInfo info)
+		{
+			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
+			if (recentOpen.RecentProject != null &amp;&amp; recentOpen.RecentProject.Length &gt; 0) {
+				for (int i = 0; i &lt; recentOpen.RecentProject.Length; ++i) {
+					string accelaratorKeyPrefix = i &lt; 10 ? &quot;_&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
+					RecentItem ri = recentOpen.RecentProject[i];
+					string label = ((ri.Private == null || ri.Private.Length &lt; 1) ? Path.GetFileNameWithoutExtension (ri.ToString ()) : ri.Private);
+					CommandInfo cmd = new CommandInfo (accelaratorKeyPrefix + label.Replace (&quot;_&quot;, &quot;__&quot;));
+					cmd.Description = String.Format (GettextCatalog.GetString (&quot;load solution {0}&quot;), ri.ToString ());
+					info.Add (cmd, ri);
+				}
+			}
+		}
+		
+		protected override void Run (object dataItem)
+		{
+			//FIXME:THIS IS BROKEN!!
+			
+			string filename = dataItem.ToString();
+			
+			try {
+				Runtime.ProjectService.OpenCombine(filename);
+			} catch (Exception ex) {
+				CombineLoadError.HandleError(ex, filename);
+			}
+		}
+	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/HelpCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/HelpCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/HelpCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -20,20 +20,31 @@
 
 namespace MonoDevelop.Commands
 {
-	public class ShowHelp : AbstractMenuCommand
+	public enum HelpCommands
 	{
-		public override void Run()
+		TipOfTheDay,
+		About
+	}
+	
+	public class TipOfTheDayHandler: CommandHandler
+	{
+		protected override void Run ()
 		{
-/*			string fileName = Runtime.FileUtilityService.SharpDevelopRootPath + 
-			              Path.DirectorySeparatorChar + &quot;doc&quot; +
-			              Path.DirectorySeparatorChar + &quot;help&quot; +
-			              Path.DirectorySeparatorChar + &quot;sharpdevelop.chm&quot;;
-			//if (fileUtilityService.TestFileExists(fileName)) {
-			//	Help.ShowHelp((Gtk.Window)WorkbenchSingleton.Workbench, fileName);
-			//}
-*/
+			TipOfTheDayWindow totdw = new TipOfTheDayWindow ();
+			totdw.Show ();
 		}
 	}
+		
+	public class AboutHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			using (CommonAboutDialog ad = new CommonAboutDialog ()) {
+				ad.Run ();
+				ad.Hide ();
+			}
+		}
+	}
 	
 	public class GotoWebSite : AbstractMenuCommand
 	{
@@ -70,24 +81,4 @@
 			}
 		}
 	}
-	
-	public class ViewTipOfTheDay : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			TipOfTheDayWindow totdw = new TipOfTheDayWindow ();
-			totdw.Show ();
-		}
-	}
-	
-	public class AboutSharpDevelop : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			using (CommonAboutDialog ad = new CommonAboutDialog ()) {
-				ad.Run ();
-				ad.Hide ();
-			}
-		}
-	}
 }

Deleted: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/MenuItemBuilders.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/MenuItemBuilders.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/MenuItemBuilders.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -1,440 +0,0 @@
-// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt&quot;/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt&quot;/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Kr&#252;ger&quot; email=&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">mike at icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using System.Diagnostics;
-using System.IO;
-using System.Collections;
-
-using MonoDevelop.Core.AddIns;
-using MonoDevelop.Core.AddIns.Codons;
-using MonoDevelop.Core.AddIns.Conditions;
-using MonoDevelop.Core.Properties;
-using MonoDevelop.Core.Services;
-using MonoDevelop.Services;
-using MonoDevelop.Gui;
-using MonoDevelop.Gui.Components;
-using MonoDevelop.Gui.ErrorHandlers;
-using MonoDevelop.Gui.Dialogs;
-using MonoDevelop.Internal.Project;
-using MonoDevelop.Internal.ExternalTool;
-using MonoDevelop.Gui.Pads;
-
-using Freedesktop.RecentFiles;
-
-namespace MonoDevelop.Commands
-{
-
-	public interface ISubmenuItem
-	{
-	}
-	
-	public class RecentFilesMenuBuilder : ISubmenuBuilder
-	{
-
-		class RFMItem : SdMenuCommand, ISubmenuItem {
-			public RFMItem (ConditionCollection a, object b, string c) : base (a, b, c) {
-			}
-			public RFMItem (ConditionCollection a, object b, string c, EventHandler d) : base (a, b, c, d) {
-			}
-		}
-		
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
-			
-			if (recentOpen.RecentFile != null &amp;&amp; recentOpen.RecentFile.Length &gt; 0) {
-				RFMItem[] items = new RFMItem[recentOpen.RecentFile.Length];
-				
-				for (int i = 0; i &lt; recentOpen.RecentFile.Length; ++i) {
-					string accelaratorKeyPrefix = i &lt; 10 ? &quot;&amp;&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
-					RecentItem ri = recentOpen.RecentFile[i];
-					string label = ((ri.Private == null || ri.Private.Length &lt; 1) ? Path.GetFileName (ri.ToString ()) : ri.Private);
-					items[i] = new RFMItem (null, null, accelaratorKeyPrefix + label.Replace (&quot;_&quot;, &quot;__&quot;), new EventHandler (LoadRecentFile));
-					items[i].Tag = ri.ToString ();
-				}
-				return items;
-			}
-			
-			RFMItem defaultMenu = new RFMItem(null, null, GettextCatalog.GetString(&quot;recent files&quot;));
-			defaultMenu.Sensitive = false;
-			
-			return new RFMItem[] { defaultMenu };
-		}
-		
-		void LoadRecentFile(object sender, EventArgs e)
-		{
-			SdMenuCommand item = (SdMenuCommand)sender;
-			Runtime.FileService.OpenFile (item.Tag.ToString());
-		}
-	}
-	
-	public class RecentProjectsMenuBuilder : ISubmenuBuilder
-	{
-		class RPMItem : SdMenuCommand, ISubmenuItem {
-			public RPMItem (ConditionCollection a, object b, string c) : base (a, b, c) {
-			}
-			public RPMItem (ConditionCollection a, object b, string c, EventHandler d) : base (a, b, c, d) {
-			}
-		}
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			RecentOpen recentOpen = Runtime.FileService.RecentOpen;
-			
-			if (recentOpen.RecentProject != null &amp;&amp; recentOpen.RecentProject.Length &gt; 0) {
-				RPMItem[] items = new RPMItem[recentOpen.RecentProject.Length];
-				for (int i = 0; i &lt; recentOpen.RecentProject.Length; ++i) {
-					string accelaratorKeyPrefix = i &lt; 10 ? &quot;&amp;&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
-					RecentItem ri = recentOpen.RecentProject[i];
-					string label = ((ri.Private == null || ri.Private.Length &lt; 1) ? Path.GetFileNameWithoutExtension (ri.ToString ()) : ri.Private);
-					items[i] = new RPMItem(null, null, accelaratorKeyPrefix + label.Replace (&quot;_&quot;, &quot;__&quot;), new EventHandler(LoadRecentProject));
-					items[i].Tag = ri.ToString ();
-					items[i].Description = String.Format (GettextCatalog.GetString (&quot;load solution {0}&quot;), ri.ToString ());
-				}
-				return items;
-			}
-			
-			RPMItem defaultMenu = new RPMItem(null, null, GettextCatalog.GetString (&quot;recent solutions&quot;));
-			defaultMenu.Sensitive = false;
-			
-			return new RPMItem[] { defaultMenu };
-		}
-		void LoadRecentProject(object sender, EventArgs e)
-		{
-			SdMenuCommand item = (SdMenuCommand)sender;
-			
-			//FIXME:THIS IS BROKEN!!
-			
-			string filename = item.Tag.ToString();
-			
-			try {
-				Runtime.ProjectService.OpenCombine(filename);
-			} catch (Exception ex) {
-				CombineLoadError.HandleError(ex, filename);
-			}
-		}		
-	}
-	
-	public class ToolMenuBuilder : ISubmenuBuilder
-	{
-		class TMItem : SdMenuCommand, ISubmenuItem {
-			public TMItem (ConditionCollection a, object b, string c, EventHandler d) : base (a, b, c, d) {
-			}
-		}
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			//			IconMenuStyle iconMenuStyle = (IconMenuStyle)propertyService.GetProperty(&quot;IconMenuItem.IconMenuStyle&quot;, IconMenuStyle.VSNet);
-			TMItem[] items = new TMItem[ToolLoader.Tool.Count];
-			for (int i = 0; i &lt; ToolLoader.Tool.Count; ++i) {
-				TMItem item = new TMItem(null, null, ToolLoader.Tool[i].ToString(), new EventHandler(ToolEvt));
-				item.Description = GettextCatalog.GetString (&quot;Start tool&quot;) + &quot; &quot; + String.Join(String.Empty, ToolLoader.Tool[i].ToString().Split('&amp;'));
-				items[i] = item;
-			}
-			return items;
-		}
-		
-		void ToolEvt(object sender, EventArgs e)
-		{
-			SdMenuCommand item = (SdMenuCommand)sender;
-			
-			for (int i = 0; i &lt; ToolLoader.Tool.Count; ++i) {
-				if (item.Text == ToolLoader.Tool[i].ToString()) {
-					ExternalTool tool = (ExternalTool)ToolLoader.Tool[i];
-					Runtime.DispatchService.BackgroundDispatch (new StatefulMessageHandler (RunTool), tool);
-					break;
-				}
-			}
-		}
-		
-		private void RunTool (object ob)
-		{
-			StringParserService stringParserService = Runtime.StringParserService;
-			ExternalTool tool = (ExternalTool) ob;
-			
-			// set the command
-			string command = tool.Command;
-			// set the args
-			string args = stringParserService.Parse(tool.Arguments);
-			// prompt for args if needed
-			if (tool.PromptForArguments) {
-				args = Runtime.MessageService.GetTextResponse(String.Format (GettextCatalog.GetString (&quot;Enter any arguments you want to use while launching tool, {0}:&quot;), tool.MenuCommand), String.Format (GettextCatalog.GetString (&quot;Command Arguments for {0}&quot;), tool.MenuCommand), args);
-					
-				// if user selected cancel string will be null
-				if (args == null) {
-					args = stringParserService.Parse(tool.Arguments);
-				}
-			}
-			
-			// debug command and args
-			Runtime.LoggingService.Info(&quot;command : &quot; + command);
-			Runtime.LoggingService.Info(&quot;args    : &quot; + args);
-			
-			// create the process
-			IProgressMonitor monitor = Runtime.TaskService.GetRunProgressMonitor ();
-			monitor.Log.WriteLine (&quot;Running: {0} {1} ...&quot;, command, args);
-			monitor.Log.WriteLine ();
-			
-			try {
-				ProcessWrapper p;
-				string workingDirectory = stringParserService.Parse(tool.InitialDirectory);
-				if (tool.UseOutputPad)
-					p = Runtime.ProcessService.StartProcess (command, args, workingDirectory, monitor.Log, monitor.Log, null);
-				else
-					p = Runtime.ProcessService.StartProcess (command, args, workingDirectory, null);
-
-				p.WaitForOutput ();
-				Runtime.LoggingService.Info (&quot;DONE&quot;);
-				
-				monitor.Log.WriteLine ();
-				if (p.ExitCode == 0) {
-					monitor.Log.WriteLine (&quot;Process '{0}' has completed succesfully.&quot;, p.ProcessName); 
-				} else {
-					monitor.Log.WriteLine (&quot;Process '{0}' has exited with errorcode {1}.&quot;, p.ProcessName, p.ExitCode);
-				}
-				
-			} catch (Exception ex) {
-				monitor.ReportError (String.Format (GettextCatalog.GetString (&quot;External program execution failed.\nError while starting:\n '{0} {1}'&quot;), command, args), ex);
-			} finally {
-				monitor.Dispose ();
-			}
-		}
-	}
-	
-	public class OpenContentsMenuBuilder : ISubmenuBuilder
-	{
-				
-		class MyMenuItem : SdMenuCheckBox, ISubmenuItem
-		{
-			public MyMenuItem(string name) : base(null, null, name)
-			{
-			}
-			
-			protected override void OnToggled ()
-			{
-				base.OnToggled ();
-				((IWorkbenchWindow)Tag).SelectWindow();
-				Active = true;
-			}
-		}
-
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			int contentCount = WorkbenchSingleton.Workbench.ViewContentCollection.Count;
-			if (contentCount == 0) {
-				return new Gtk.MenuItem[] {};
-			}
-			Gtk.MenuItem[] items = new Gtk.MenuItem[contentCount];
-			for (int i = 0; i &lt; contentCount; ++i) {
-				IViewContent content = (IViewContent)WorkbenchSingleton.Workbench.ViewContentCollection[i];
-				
-				MyMenuItem item = null;
-				if (content.WorkbenchWindow.ShowNotification) {
-					item = new MyMenuItem(&quot;&lt;span foreground=\&quot;blue\&quot;&gt;&quot; + content.WorkbenchWindow.Title + &quot;&lt;/span&gt;&quot;);
-				} else {
-					item = new MyMenuItem (content.WorkbenchWindow.Title);
-				}
-				item.Tag = content.WorkbenchWindow;
-				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow == content.WorkbenchWindow) {
-					item.Active = true;
-				} else {
-					item.Active = false;
-				}
-				item.Description = GettextCatalog.GetString (&quot;Activate this window&quot;);
-				if (i + 1 &lt;= 9) {
-					string accel_path = &quot;&lt;MonoDevelop&gt;/MainWindow/OpenContents_&quot; + (i + 1).ToString ();
-					if (!Gtk.AccelMap.LookupEntry (accel_path, new Gtk.AccelKey ())) {
-						Gtk.AccelMap.AddEntry (accel_path, Gdk.Keyval.FromName ((i + 1).ToString ()), Gdk.ModifierType.Mod1Mask);
-					} else {
-						Gtk.AccelMap.ChangeEntry (accel_path, Gdk.Keyval.FromName ((i + 1).ToString()), Gdk.ModifierType.Mod1Mask, true);
-					}
-					item.AccelPath = accel_path;
-				}
-				items[i] = item;
-			}
-			return items;
-		}
-	}
-	
-	public class IncludeFilesBuilder : ISubmenuBuilder
-	{
-		public SolutionPad browser;
-		
-		SdMenuCheckBox includeInCompileItem;
-		SdMenuCheckBox includeInDeployItem;
-		
-		class MyMenuItem : SdMenuCheckBox, ISubmenuItem
-		{
-			public MyMenuItem(string name) : base(null, null, name)
-			{
-			}
-		}
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			browser = (SolutionPad) owner;
-			ITreeNavigator nav = browser.GetSelectedNode ();
-			if (nav == null) return new Gtk.MenuItem[0];
-
-			ProjectFile finfo = nav.DataItem as ProjectFile;
-			if (finfo == null) return new Gtk.MenuItem[0];
-			
-			Project project = (Project) nav.GetParentDataItem (typeof(Project), false);
-
-			includeInCompileItem = new MyMenuItem (GettextCatalog.GetString (&quot;Compile&quot;));
-			includeInDeployItem  = new MyMenuItem (GettextCatalog.GetString (&quot;Deploy&quot;));
-			
-			includeInCompileItem.Active = finfo.BuildAction == BuildAction.Compile;
-			includeInDeployItem.Active  = !project.DeployInformation.IsFileExcluded (finfo.Name);
-			
-			includeInCompileItem.Toggled += new EventHandler (ChangeCompileInclude);
-			includeInDeployItem.Toggled += new EventHandler (ChangeDeployInclude);
-			
-			return new Gtk.MenuItem[] {
-				includeInCompileItem,
-				includeInDeployItem
-			};
-			
-		}
-		void ChangeCompileInclude (object sender, EventArgs e)
-		{
-			ITreeNavigator nav = browser.GetSelectedNode ();
-			if (nav == null) return;
-			
-			ProjectFile finfo = nav.DataItem as ProjectFile;
-			if (finfo != null) {
-				if (finfo.BuildAction == BuildAction.Compile) {
-					finfo.BuildAction = BuildAction.Nothing;
-				} else {
-					finfo.BuildAction = BuildAction.Compile;
-				}
-			}
-			Runtime.ProjectService.SaveCombine();
-		}
-		
-		void ChangeDeployInclude(object sender, EventArgs e)
-		{
-			ITreeNavigator nav = browser.GetSelectedNode ();
-			if (nav == null) return;
-			
-			ProjectFile finfo = nav.DataItem as ProjectFile;
-			if (finfo != null) {
-				Project project = (Project) nav.GetParentDataItem (typeof(Project), false);
-				if (project.DeployInformation.IsFileExcluded (finfo.Name)) {
-					project.DeployInformation.RemoveExcludedFile (finfo.Name);
-				} else {
-					project.DeployInformation.AddExcludedFile (finfo.Name);
-				}
-			}
-			Runtime.ProjectService.SaveCombine();
-		}
-	}
-	
-	
-	public class ViewMenuBuilder : ISubmenuBuilder
-	{
-		class MyMenuItem : SdMenuCheckBox, ISubmenuItem
-		{
-			IPadContent padContent;
-			
-			bool IsPadVisible {
-				get {
-					return WorkbenchSingleton.Workbench.WorkbenchLayout.IsVisible(padContent); 
-				}
-			}
-			
-			public MyMenuItem(IPadContent padContent) : base(null, null, padContent.Title)
-			{
-				Active = WorkbenchSingleton.Workbench.WorkbenchLayout.IsVisible (padContent);
-				this.padContent = padContent;
-			}
-			
-			protected override void OnToggled ()
-			{
-				base.OnToggled ();
-				if (padContent == null) return;
-				
-				if (IsPadVisible) {
-					WorkbenchSingleton.Workbench.WorkbenchLayout.HidePad(padContent);
-				} else {
-					WorkbenchSingleton.Workbench.WorkbenchLayout.ShowPad(padContent);
-				}
-				Active = IsPadVisible;
-			}
-			
-			public override  void UpdateStatus()
-			{
-				base.UpdateStatus();
-			}
-		}
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			ArrayList items = new ArrayList();
-			IWorkbench wb = WorkbenchSingleton.Workbench;
-			if (wb.WorkbenchLayout != null)
-			{
-				PadContentCollection pads = wb.WorkbenchLayout.PadContentCollection;
-				foreach (IPadContent padContent in pads) {
-					items.Add(new MyMenuItem(padContent));
-				}
-			}
-			
-			return (MyMenuItem[])items.ToArray(typeof(MyMenuItem));
-		}
-	}
-
-	public class LayoutsMenuBuilder : ISubmenuBuilder
-	{
-		class MyMenuItem : SdMenuCheckBox, ISubmenuItem
-		{
-			string layoutName;
-			
-			bool IsCurrentLayout {
-				get {
-					return (WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout == layoutName);
-				}
-			}
-			
-			public MyMenuItem (string name) : base (null, null, name)
-			{
-				Active = WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout == layoutName;
-				this.layoutName = name;
-			}
-			
-			protected override void OnToggled ()
-			{
-				base.OnToggled ();
-				if (layoutName != null)
-					WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout = layoutName;
-			}
-			
-			public override  void UpdateStatus()
-			{
-				base.UpdateStatus();
-			}
-		}
-		
-		public Gtk.MenuItem[] BuildSubmenu(ConditionCollection conditionCollection, object owner)
-		{
-			ArrayList items = new ArrayList();
-			IWorkbench wb = WorkbenchSingleton.Workbench;
-			if (wb.WorkbenchLayout != null)
-			{
-				string[] layouts = wb.WorkbenchLayout.Layouts;
-				Array.Sort (layouts);
-				foreach (string layout in layouts) {
-					items.Add (new MyMenuItem (layout));
-				}
-			}
-			
-			return (MyMenuItem[]) items.ToArray (typeof (MyMenuItem));
-		}
-	}
-}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ProjectCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ProjectCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ProjectCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -6,82 +6,210 @@
 // &lt;/file&gt;
 
 using System;
+using System.IO;
 using System.Diagnostics;
-using System.IO;
-using System.Collections;
-
-using MonoDevelop.Core.AddIns;
-using MonoDevelop.Core.Properties;
-using MonoDevelop.Core.AddIns.Codons;
-using MonoDevelop.Core.Services;
 using MonoDevelop.Services;
 using MonoDevelop.Gui;
-using MonoDevelop.Gui.Dialogs;
 using MonoDevelop.Internal.Project;
 
 namespace MonoDevelop.Commands
 {
-	public class RunTestsInProject : AbstractMenuCommand
+	public enum ProjectCommands
 	{
-		public override void Run()
+		Compile,
+		AddNewProject,
+		AddNewCombine,
+		AddProject,
+		AddCombine,
+		RemoveFromProject,
+		Options,
+		AddResource,
+		AddReference,
+		AddNewFiles,
+		AddFiles,
+		NewFolder,
+		IncludeToProject,
+		Build,
+		Rebuild,
+		SetAsStartupProject,
+		GenerateMakefiles,
+		Run,
+		IncludeInBuild,
+		IncludeInDeploy,
+		Deploy,
+		ConfigurationSelector,
+		Debug,
+		Stop
+	}
+	
+	public class CompileHandler: CommandHandler
+	{
+		protected override void Run ()
 		{
-			if (Runtime.ProjectService.CurrentSelectedProject != null) {
-				string assembly = Runtime.ProjectService.CurrentSelectedProject.GetOutputFileName ();
-				
-				if (!File.Exists(assembly)) {
-					Runtime.MessageService.ShowError (GettextCatalog.GetString (&quot;Assembly not Found (Compile the project first)&quot;));
-				} else {
-					string command = Runtime.FileUtilityService.SharpDevelopRootPath + 
-					                 Path.DirectorySeparatorChar + &quot;bin&quot; + 
-					                 Path.DirectorySeparatorChar + &quot;nunit&quot; + 
-					                 Path.DirectorySeparatorChar + &quot;nunit-gui.exe&quot;;
-					string args = '&quot;'  + assembly + '&quot;';
-					Process.Start(command, args);
-				}
+			IProjectService projectService = Runtime.ProjectService;
+			if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
+				Runtime.FileService.SaveFile (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow);
+				projectService.BuildFile (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName);
 			}
 		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			info.Enabled = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null;
+		}
 	}
 	
-	public class ViewProjectOptions : AbstractMenuCommand
+	public class RunHandler: CommandHandler
 	{
-		public override void Run()
+		CombineEntry entry;
+		string file;
+		
+		protected override void Run ()
 		{
-			Project selectedProject = Runtime.ProjectService.CurrentSelectedProject;
-			if (selectedProject == null) {
-				return;
+			if (Runtime.ProjectService.CurrentOpenCombine != null) {
+				entry = Runtime.ProjectService.CurrentSelectedCombineEntry;
+				if (entry != null) {
+					IAsyncOperation op = Runtime.ProjectService.Build (entry);
+					op.Completed += new OperationHandler (ExecuteCombine);
+				}
+			} else {
+				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
+					file = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName;
+					IAsyncOperation op = Runtime.ProjectService.ExecuteFile (file);
+					op.Completed += new OperationHandler (ExecuteFile);
+				}
 			}
-			
-			IAddInTreeNode generalOptionsNode          = AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/ProjectOptions/GeneralOptions&quot;);
-			IAddInTreeNode configurationPropertiesNode = AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/ProjectOptions/ConfigurationProperties&quot;);
-			
-			ProjectOptionsDialog optionsDialog = new ProjectOptionsDialog(selectedProject, generalOptionsNode, configurationPropertiesNode);
-			if (optionsDialog.Run() == (int)Gtk.ResponseType.Ok) {
-					Runtime.ProjectService.CurrentSelectedProject.NeedsBuilding = true;
+		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			if (Runtime.ProjectService.CurrentOpenCombine != null) {
+				info.Enabled = Runtime.ProjectService.CurrentSelectedCombineEntry != null &amp;&amp; 
+								Runtime.ProjectService.CurrentRunOperation.IsCompleted;
+			} else {
+				info.Enabled = (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null);
 			}
-			
-			Runtime.ProjectService.SaveCombine();
 		}
+		
+		void ExecuteCombine (IAsyncOperation op)
+		{
+			if (op.Success)
+				Runtime.ProjectService.Execute (entry);
+		}
+		
+		void ExecuteFile (IAsyncOperation op)
+		{
+			if (op.Success)
+				Runtime.ProjectService.ExecuteFile (file);
+		}
 	}
 	
-	public class DeployProject : AbstractMenuCommand
+	public class DebugHandler: CommandHandler
 	{
-		public override void Run()
+		CombineEntry entry;
+		string file;
+		
+		protected override void Run ()
 		{
-			foreach (IViewContent viewContent in WorkbenchSingleton.Workbench.ViewContentCollection) {
-				if (viewContent.IsDirty) {
-					viewContent.Save();
+			if (Runtime.ProjectService.CurrentOpenCombine != null) {
+				entry = Runtime.ProjectService.CurrentSelectedCombineEntry;
+				if (entry != null) {
+					IAsyncOperation op = Runtime.ProjectService.Build (entry);
+					op.Completed += new OperationHandler (ExecuteCombine);
 				}
+			} else {
+				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
+					file = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName;
+					IAsyncOperation op = Runtime.ProjectService.ExecuteFile (file);
+					op.Completed += new OperationHandler (ExecuteFile);
+				}
 			}
-			if (Runtime.ProjectService.CurrentSelectedProject != null) {
-				DeployInformation.Deploy (Runtime.ProjectService.CurrentSelectedProject);
+		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			if (Runtime.ProjectService.CurrentOpenCombine != null) {
+				info.Enabled = Runtime.ProjectService.CurrentSelectedCombineEntry != null &amp;&amp; 
+								Runtime.ProjectService.CurrentRunOperation.IsCompleted;
+			} else {
+				info.Enabled = (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null);
 			}
 		}
+		
+		void ExecuteCombine (IAsyncOperation op)
+		{
+			if (op.Success)
+				Runtime.ProjectService.Debug (entry);
+		}
+		
+		void ExecuteFile (IAsyncOperation op)
+		{
+			if (op.Success)
+				Runtime.ProjectService.DebugFile (file);
+		}
 	}
 	
-	public class GenerateProjectDocumentation : AbstractMenuCommand
+	public class BuildHandler: CommandHandler
 	{
-		public override void Run()
+		protected override void Run ()
 		{
+			if (Runtime.ProjectService.CurrentSelectedCombineEntry != null)
+				Runtime.ProjectService.Build (Runtime.ProjectService.CurrentSelectedCombineEntry);
+		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			info.Enabled = Runtime.ProjectService.CurrentBuildOperation.IsCompleted &amp;&amp;
+							(Runtime.ProjectService.CurrentSelectedCombineEntry != null);
+		}
+	}
+	
+	public class RebuildHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			if (Runtime.ProjectService.CurrentSelectedCombineEntry != null)
+				Runtime.ProjectService.Rebuild (Runtime.ProjectService.CurrentSelectedCombineEntry);
+		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			info.Enabled = Runtime.ProjectService.CurrentBuildOperation.IsCompleted &amp;&amp;
+							(Runtime.ProjectService.CurrentSelectedCombineEntry != null);
+		}
+	}
+	
+	public class StopHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			if (!Runtime.ProjectService.CurrentBuildOperation.IsCompleted)
+				Runtime.ProjectService.CurrentBuildOperation.Cancel ();
+			if (!Runtime.ProjectService.CurrentRunOperation.IsCompleted)
+				Runtime.ProjectService.CurrentRunOperation.Cancel ();
+		}
+		
+		protected override void Update (CommandInfo info)
+		{
+			info.Enabled = !Runtime.ProjectService.CurrentBuildOperation.IsCompleted ||
+							!Runtime.ProjectService.CurrentRunOperation.IsCompleted;
+		}
+	}
+	
+	public class GenerateMakefilesHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			if (Runtime.ProjectService.CurrentOpenCombine != null) {
+				Runtime.ProjectService.CurrentOpenCombine.GenerateMakefiles ();
+			}
+		}
+	}
+
+	public class GenerateProjectDocumentation : CommandHandler
+	{
+		protected override void Run ()
+		{
 			try {
 				if (Runtime.ProjectService.CurrentSelectedProject != null) {
 					string assembly    = Runtime.ProjectService.CurrentSelectedProject.GetOutputFileName ();

Deleted: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/RunCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/RunCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/RunCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -1,121 +0,0 @@
-// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt&quot;/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt&quot;/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Kr&#252;ger&quot; email=&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">mike at icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-//
-//
-// FIX ME
-// We need to do the compile in the background
-//
-
-using System;
-using System.IO;
-using System.Threading;
-using System.Drawing;
-using System.Drawing.Printing;
-using System.Collections;
-using Gtk;
-using System.Diagnostics;
-
-using MonoDevelop.Core.AddIns;
-
-using MonoDevelop.Core.Properties;
-using MonoDevelop.Core.AddIns.Codons;
-using System.CodeDom.Compiler;
-
-using MonoDevelop.Gui;
-using MonoDevelop.Internal.Project;
-using MonoDevelop.Gui.Dialogs;
-using MonoDevelop.Services;
-
-namespace MonoDevelop.Commands
-{
-	public class Compile : AbstractMenuCommand
-	{
-		public override void Run()
-		{ 
-			IProjectService projectService = Runtime.ProjectService;
-			if (projectService.CurrentOpenCombine != null) {
-				projectService.BuildActiveCombine ();
-			} else {
-				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
-					new SaveFile().Run();
-					projectService.BuildFile (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName);
-				}
-			}
-		}
-	}
-	
-	public class CompileAll : AbstractMenuCommand
-	{
-		public override void Run()
-		{ 
-			IProjectService projectService = Runtime.ProjectService;
-			if (projectService.CurrentOpenCombine != null) {
-				projectService.RebuildActiveCombine ();
-			} else {
-				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
-					new SaveFile().Run();
-					projectService.BuildFile (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName);
-				}
-			}
-		}
-	}
-	
-	public class RunCommand : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			if (Runtime.ProjectService.CurrentOpenCombine != null) {
-				IAsyncOperation op = Runtime.ProjectService.BuildActiveCombine ();
-				op.Completed += new OperationHandler (ExecuteCombine);
-			} else {
-				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
-					IAsyncOperation op = Runtime.ProjectService.ExecuteFile (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.ViewContent.ContentName);
-					op.Completed += new OperationHandler (ExecuteFile);
-				}
-			}
-		}
-		
-		void ExecuteCombine (IAsyncOperation op)
-		{
-			if (op.Success)
-				Runtime.ProjectService.ExecuteActiveCombine ();
-		}
-		
-		void ExecuteFile (IAsyncOperation op)
-		{
-			if (op.Success)
-				Runtime.ProjectService.ExecuteActiveCombine ();
-		}
-	}
-	
-	public class BuildCurrentProject : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			Runtime.ProjectService.BuildActiveProject ();
-		}
-	}
-	
-	public class RebuildCurrentProject : AbstractMenuCommand
-	{
-		public override void Run()
-		{
-			Runtime.ProjectService.RebuildActiveProject ();
-		}
-	}
-
-	public class GenerateMakefiles : AbstractMenuCommand {
-		
-		public override void Run () 
-		{
-			if (Runtime.ProjectService.CurrentOpenCombine != null) {
-				Runtime.ProjectService.CurrentOpenCombine.GenerateMakefiles ();
-			}
-		}
-	}
-}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ToolsCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ToolsCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ToolsCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -13,36 +13,85 @@
 using MonoDevelop.Core.AddIns;
 using MonoDevelop.Core.Properties;
 using MonoDevelop.Core.AddIns.Codons;
+using MonoDevelop.Core.Services;
 
 using MonoDevelop.Gui;
-using MonoDevelop.Gui.Dialogs;
+using MonoDevelop.Internal.ExternalTool;
 
 namespace MonoDevelop.Commands
 {
-	public class OptionsCommand : AbstractMenuCommand
+	public enum ToolCommands
 	{
-		public override void Run()
-		{
-			new TreeViewOptions((IProperties)Runtime.Properties.GetProperty(&quot;MonoDevelop.TextEditor.Document.Document.DefaultDocumentAggregatorProperties&quot;, new DefaultProperties()),
-			                                                           AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Dialogs/OptionsDialog&quot;));
-		}
+		ToolList
 	}
 	
-	public class ToggleFullscreenCommand : AbstractMenuCommand
+	public class ToolListHandler: CommandHandler
 	{
-		public override void Run()
+		protected override void Update (CommandArrayInfo info)
 		{
-			((DefaultWorkbench)WorkbenchSingleton.Workbench).FullScreen = !((DefaultWorkbench)WorkbenchSingleton.Workbench).FullScreen;
+			for (int i = 0; i &lt; ToolLoader.Tool.Count; ++i) {
+				CommandInfo cmd = new CommandInfo (ToolLoader.Tool[i].ToString());
+				cmd.Description = GettextCatalog.GetString (&quot;Start tool&quot;) + &quot; &quot; + String.Join(String.Empty, ToolLoader.Tool[i].ToString().Split('&amp;'));
+				info.Add (cmd, ToolLoader.Tool[i]);
+			}
 		}
-	}
-	
-	public class NewLayoutCommand : AbstractMenuCommand
-	{
-		public override void Run()
+		
+		protected override void Run (object tool)
 		{
-			using (NewLayoutDialog dlg = new NewLayoutDialog ()) {
-				dlg.Run ();
+			Runtime.DispatchService.BackgroundDispatch (new StatefulMessageHandler (RunTool), tool);
+		}
+
+		private void RunTool (object ob)
+		{
+			StringParserService stringParserService = Runtime.StringParserService;
+			ExternalTool tool = (ExternalTool) ob;
+			
+			// set the command
+			string command = tool.Command;
+			// set the args
+			string args = stringParserService.Parse(tool.Arguments);
+			// prompt for args if needed
+			if (tool.PromptForArguments) {
+				args = Runtime.MessageService.GetTextResponse(String.Format (GettextCatalog.GetString (&quot;Enter any arguments you want to use while launching tool, {0}:&quot;), tool.MenuCommand), String.Format (GettextCatalog.GetString (&quot;Command Arguments for {0}&quot;), tool.MenuCommand), args);
+					
+				// if user selected cancel string will be null
+				if (args == null) {
+					args = stringParserService.Parse(tool.Arguments);
+				}
 			}
+			
+			// debug command and args
+			Runtime.LoggingService.Info(&quot;command : &quot; + command);
+			Runtime.LoggingService.Info(&quot;args    : &quot; + args);
+			
+			// create the process
+			IProgressMonitor monitor = Runtime.TaskService.GetRunProgressMonitor ();
+			monitor.Log.WriteLine (&quot;Running: {0} {1} ...&quot;, command, args);
+			monitor.Log.WriteLine ();
+			
+			try {
+				ProcessWrapper p;
+				string workingDirectory = stringParserService.Parse(tool.InitialDirectory);
+				if (tool.UseOutputPad)
+					p = Runtime.ProcessService.StartProcess (command, args, workingDirectory, monitor.Log, monitor.Log, null);
+				else
+					p = Runtime.ProcessService.StartProcess (command, args, workingDirectory, null);
+
+				p.WaitForOutput ();
+				Runtime.LoggingService.Info (&quot;DONE&quot;);
+				
+				monitor.Log.WriteLine ();
+				if (p.ExitCode == 0) {
+					monitor.Log.WriteLine (&quot;Process '{0}' has completed succesfully.&quot;, p.ProcessName); 
+				} else {
+					monitor.Log.WriteLine (&quot;Process '{0}' has exited with errorcode {1}.&quot;, p.ProcessName, p.ExitCode);
+				}
+				
+			} catch (Exception ex) {
+				monitor.ReportError (String.Format (GettextCatalog.GetString (&quot;External program execution failed.\nError while starting:\n '{0} {1}'&quot;), command, args), ex);
+			} finally {
+				monitor.Dispose ();
+			}
 		}
 	}
 }

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ViewCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ViewCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/ViewCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,98 @@
+// &lt;file&gt;
+//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt&quot;/">prj:///doc/copyright.txt&quot;/</A>&gt;
+//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt&quot;/">prj:///doc/license.txt&quot;/</A>&gt;
+//     &lt;owner name=&quot;Mike Kr&#252;ger&quot; email=&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">mike at icsharpcode.net</A>&quot;/&gt;
+//     &lt;version value=&quot;$version&quot;/&gt;
+// &lt;/file&gt;
+
+using System;
+using System.Collections;
+using System.CodeDom.Compiler;
+
+using MonoDevelop.Services;
+using MonoDevelop.Core.AddIns;
+using MonoDevelop.Core.Properties;
+using MonoDevelop.Core.AddIns.Codons;
+
+using MonoDevelop.Gui;
+using MonoDevelop.Gui.Dialogs;
+
+namespace MonoDevelop.Commands
+{
+	public enum ViewCommands
+	{
+		ViewList,
+		LayoutList,
+		NewLayout,
+		FullScreen,
+		Open,
+		TreeDisplayOptionList,
+		ResetTreeDisplayOptions
+	}
+	
+	public class FullScreenHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			((DefaultWorkbench)WorkbenchSingleton.Workbench).FullScreen = !((DefaultWorkbench)WorkbenchSingleton.Workbench).FullScreen;
+		}
+	}
+	
+	public class NewLayoutHandler: CommandHandler
+	{
+		protected override void Run ()
+		{
+			using (NewLayoutDialog dlg = new NewLayoutDialog ()) {
+				dlg.Run ();
+			}
+		}
+	}
+	
+	public class ViewListHandler: CommandHandler
+	{
+		protected override void Update (CommandArrayInfo info)
+		{
+			IWorkbench wb = WorkbenchSingleton.Workbench;
+			if (wb.WorkbenchLayout != null) {
+				PadContentCollection pads = wb.WorkbenchLayout.PadContentCollection;
+				foreach (IPadContent padContent in pads) {
+					CommandInfo cmd = new CommandInfo (padContent.Title);
+					cmd.Checked = WorkbenchSingleton.Workbench.WorkbenchLayout.IsVisible (padContent);
+					info.Add (cmd, padContent);
+				}
+			}
+		}
+		
+		protected override void Run (object ob)
+		{
+			IPadContent padContent = (IPadContent) ob;
+			if (WorkbenchSingleton.Workbench.WorkbenchLayout.IsVisible (padContent)) {
+				WorkbenchSingleton.Workbench.WorkbenchLayout.HidePad (padContent);
+			} else {
+				WorkbenchSingleton.Workbench.WorkbenchLayout.ShowPad (padContent);
+			}
+		}
+	}
+	
+	public class LayoutListHandler: CommandHandler
+	{
+		protected override void Update (CommandArrayInfo info)
+		{
+			IWorkbench wb = WorkbenchSingleton.Workbench;
+			if (wb.WorkbenchLayout != null) {
+				string[] layouts = wb.WorkbenchLayout.Layouts;
+				Array.Sort (layouts);
+				foreach (string layout in layouts) {
+					CommandInfo cmd = new CommandInfo (layout);
+					cmd.Checked = (layout == wb.WorkbenchLayout.CurrentLayout);
+					info.Add (cmd, layout);
+				}
+			}
+		}
+		
+		protected override void Run (object layout)
+		{
+			WorkbenchSingleton.Workbench.WorkbenchLayout.CurrentLayout = (string) layout;
+		}
+	}
+}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/WindowCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/WindowCommands.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Commands/WindowCommands.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -11,12 +11,20 @@
 using MonoDevelop.Core.Properties;
 using MonoDevelop.Core.AddIns.Codons;
 using MonoDevelop.Gui;
+using MonoDevelop.Services;
 
 namespace MonoDevelop.Commands
 {
-	public class SelectNextWindow : AbstractMenuCommand
+	public enum WindowCommands
 	{
-		public override void Run()
+		NextWindow,
+		PrevWindow,
+		OpenWindowList
+	}
+	
+	public class NextWindowHandler: CommandHandler
+	{
+		protected override void Run ()
 		{
 			if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow == null) {
 				return;
@@ -26,9 +34,9 @@
 		}
 	}
 	
-	public class SelectPrevWindow : AbstractMenuCommand
+	public class PrevWindowHandler: CommandHandler
 	{
-		public override void Run()
+		protected override void Run ()
 		{
 			if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow == null) {
 				return;
@@ -38,12 +46,37 @@
 		}
 	}
 	
-	public class CloseAllWindows : AbstractMenuCommand
+	public class OpenWindowListHandler: CommandHandler
 	{
-		public override void Run()
+		protected override void Update (CommandArrayInfo info)
 		{
-			WorkbenchSingleton.Workbench.CloseAllViews();
+			int contentCount = WorkbenchSingleton.Workbench.ViewContentCollection.Count;
+			if (contentCount == 0) return;
+			
+			for (int i = 0; i &lt; contentCount; ++i) {
+				IViewContent content = (IViewContent)WorkbenchSingleton.Workbench.ViewContentCollection[i];
+				
+				CommandInfo item = null;
+				if (content.WorkbenchWindow.ShowNotification) {
+					item = new CommandInfo (&quot;&lt;span foreground=\&quot;blue\&quot;&gt;&quot; + content.WorkbenchWindow.Title + &quot;&lt;/span&gt;&quot;);
+					item.UseMarkup = true;
+				} else {
+					item = new CommandInfo (content.WorkbenchWindow.Title);
+				}
+				
+				item.Checked = (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow == content.WorkbenchWindow);
+				item.Description = GettextCatalog.GetString (&quot;Activate this window&quot;);
+				
+				if (i + 1 &lt;= 9)
+					item.AccelKey = &quot;Alt|&quot; + (i+1);
+				
+				info.Add (item, content.WorkbenchWindow);
+			}
 		}
+		
+		protected override void Run (object window)
+		{
+			((IWorkbenchWindow)window).SelectWindow();
+		}
 	}
-	
 }

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/CommandService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/CommandService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/CommandService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,113 @@
+//
+// CommandService.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+using System;
+using System.Xml;
+using System.Collections;
+
+using MonoDevelop.Core.Services;
+using MonoDevelop.Commands;
+using MonoDevelop.Core.AddIns;
+using MonoDevelop.Gui;
+
+namespace MonoDevelop.Services
+{
+	public class CommandService : AbstractService
+	{
+		CommandManager manager = new CommandManager ();
+		
+		public override void InitializeService()
+		{
+			base.InitializeService();
+			
+			ArrayList commandCodons = AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Commands&quot;).BuildChildItems (null);
+			foreach (Command cmd in commandCodons)
+				manager.RegisterCommand (cmd, null);
+		}
+		
+		public void SetRootWindow (Gtk.Window root)
+		{
+			manager.SetRootWindow (root);
+		}
+		
+		public void RegisterGlobalHandler (object handler)
+		{
+			manager.RegisterGlobalHandler (handler);
+		}
+		
+		public void UnregisterGlobalHandler (object handler)
+		{
+			manager.UnregisterGlobalHandler (handler);
+		}
+		
+		public Gtk.MenuBar CreateMenuBar (string addinPath)
+		{
+			CommandEntrySet cset = CreateCommandEntrySet (addinPath);
+			return manager.CreateMenuBar (addinPath, cset);
+		}
+		
+		public Gtk.Toolbar[] CreateToolbarSet (string addinPath)
+		{
+			ArrayList bars = new ArrayList ();
+			
+			CommandEntrySet cset = CreateCommandEntrySet (addinPath);
+			foreach (CommandEntry ce in cset) {
+				CommandEntrySet ces = ce as CommandEntrySet;
+				if (ces != null)
+					bars.Add (manager.CreateToolbar (addinPath + &quot;/&quot; + ces.Name, ces));
+			}
+			return (Gtk.Toolbar[]) bars.ToArray (typeof(Gtk.Toolbar));
+		}
+		
+		public Gtk.Toolbar CreateToolbar (string addinPath)
+		{
+			CommandEntrySet cset = CreateCommandEntrySet (addinPath);
+			return manager.CreateToolbar (addinPath, cset);
+		}
+		
+		public Gtk.Menu CreateMenu (string addinPath)
+		{
+			CommandEntrySet cset = CreateCommandEntrySet (addinPath);
+			return manager.CreateMenu (cset);
+		}
+		
+		public Gtk.Menu CreateMenu (CommandEntrySet cset)
+		{
+			return manager.CreateMenu (cset);
+		}
+		
+		public CommandEntrySet CreateCommandEntrySet (string addinPath)
+		{
+			CommandEntrySet cset = new CommandEntrySet ();
+			ArrayList items = AddInTreeSingleton.AddInTree.GetTreeNode (addinPath).BuildChildItems (null);
+			foreach (CommandEntry e in items)
+				cset.Add (e);
+			return cset;
+		}
+	}
+}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Components/SdMenu.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Components/SdMenu.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Components/SdMenu.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -26,6 +26,10 @@
 		void UpdateStatus();
 	}
 	
+	public interface ISubmenuItem
+	{
+	}
+	
 	public class SdMenu : Gtk.ImageMenuItem, IStatusUpdate
 	{
 		ConditionCollection conditionCollection;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewFileDialog.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewFileDialog.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewFileDialog.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -49,7 +49,7 @@
 			this.BorderWidth = 6;
 			this.HasSeparator = false;
 			
-			Runtime.DispatchService.BackgroundDispatch (new MessageHandler (InitializeTemplates));
+			InitializeTemplates ();
 		}
 		
 		void InitializeView()
@@ -132,7 +132,7 @@
 				}
 				alltemplates.Add(titem);
 			}
-			Runtime.DispatchService.GuiDispatch (new MessageHandler (InitializeComponents));
+			InitializeComponents ();
 		}
 		
 		// tree view event handlers
@@ -208,12 +208,13 @@
 					}
 				}
 				
-				Destroy ();
 				if (WorkbenchSingleton.Workbench.ActiveWorkbenchWindow != null) {
 					WorkbenchSingleton.Workbench.ActiveWorkbenchWindow.SelectWindow();
 				}
 				if (OnOked != null)
 					OnOked (null, null);
+				Respond (Gtk.ResponseType.Ok);
+				Destroy ();
 			}
 		}
 

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewProjectDialog.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewProjectDialog.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/NewProjectDialog.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -59,9 +59,14 @@
 			new Glade.XML (null, &quot;Base.glade&quot;, &quot;NewProjectDialog&quot;, null).Autoconnect (this);
 			dialog.TransientFor = (Window) WorkbenchSingleton.Workbench;			
 
-			Runtime.DispatchService.BackgroundDispatch (new MessageHandler (InitializeTemplates));
+			InitializeTemplates ();
 		}
 		
+		public int Run ()
+		{
+			return dialog.Run ();
+		}
+		
 		void InitializeView()
 		{
 			InsertCategories (TreeIter.Zero, categories);
@@ -113,7 +118,7 @@
 				//	titem.Selected = true;
 				alltemplates.Add(titem);
 			}
-			Runtime.DispatchService.GuiDispatch (new MessageHandler (InitializeComponents));
+			InitializeComponents ();
 		}
 		
 		void CategoryChange(object sender, EventArgs e)

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/TreeViewOptions.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/TreeViewOptions.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Dialogs/TreeViewOptions.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -55,7 +55,6 @@
 				if (!pane.ReceiveDialogMessage (DialogMessage.OK))
 					return;
 			}
-			WorkbenchSingleton.Workbench.UpdateMenu (null, null);
 			TreeViewOptionDialog.Hide ();
 		}
 	
@@ -176,7 +175,6 @@
 		
 		private void CancelEvent (object o, EventArgs args)
 		{
-			WorkbenchSingleton.Workbench.UpdateMenu (null, null);
 			TreeViewOptionDialog.Hide ();
 		}
 		

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/GuiService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/GuiService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/GuiService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -13,6 +13,7 @@
 		IconService icons;
 		ResourceService resourceService;
 		IStatusBarService statusBarService;
+		CommandService commandService;
 		
 		public IWorkbench Workbench {
 			get { return MonoDevelop.Gui.WorkbenchSingleton.Workbench; }
@@ -65,5 +66,13 @@
 				return icons;
 			}
 		}
+	
+		public CommandService CommandService {
+			get {
+				if (commandService == null)
+					commandService = (CommandService) ServiceManager.GetService (typeof(CommandService));
+				return commandService;
+			}
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/IWorkbench.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -114,9 +114,6 @@
 		/// &lt;/summary&gt;
 		void RedrawAllComponents();
 
-		void UpdateMenu (object o, EventArgs e);
-		
-		
 		/// &lt;summary&gt;
 		/// Is called, when the workbench window which the user has into
 		/// the foreground (e.g. editable) changed to a new one.
@@ -128,6 +125,7 @@
 		/// &lt;/summary&gt;
 		WorkbenchContext Context {
 			get;
+			set;
 		}
 		
 		/// &lt;summary&gt;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ClassPad/ProjectNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ClassPad/ProjectNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ClassPad/ProjectNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -118,12 +118,6 @@
 			return true;
 		}
 		
-		void OnRenameFile (object sender, ProjectFileRenamedEventArgs e)
-		{
-			ITreeBuilder tb = Context.GetTreeBuilder (e.ProjectFile);
-			if (tb != null) tb.Update ();
-		}
-		
 		void OnProjectRenamed (object sender, CombineEntryRenamedEventArgs e)
 		{
 			ITreeBuilder tb = Context.GetTreeBuilder (e.CombineEntry);

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/CombineNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/CombineNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/CombineNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -31,6 +31,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -160,8 +161,23 @@
 			Runtime.ProjectService.SaveCombine();
 		}
 		
-		public override void RemoveItem ()
+		public override DragOperation CanDragNode ()
 		{
+			return DragOperation.Move;
+		}
+		
+		public override bool CanDropNode (object dataObject, DragOperation operation)
+		{
+			return dataObject is CombineEntry;
+		}
+		
+		public override void OnNodeDrop (object dataObject, DragOperation operation)
+		{
+		}
+		
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
+		{
 			Combine combine = CurrentNode.DataItem as Combine;
 			Combine parent = CurrentNode.GetParentDataItem (typeof(Combine), false) as Combine;
 			if (parent == null) return;
@@ -173,18 +189,56 @@
 			}
 		}
 		
-		public override DragOperation CanDragNode ()
+		[CommandHandler (ProjectCommands.AddNewProject)]
+		public void AddNewProjectToCombine()
 		{
-			return DragOperation.Move;
+			Combine combine = (Combine) CurrentNode.DataItem;
+			CombineEntry ce = Runtime.ProjectService.CreateProject (combine);
+			if (ce == null) return;
+			Tree.AddNodeInsertCallback (ce, new TreeNodeCallback (OnEntryInserted));
+			CurrentNode.Expanded = true;
 		}
 		
-		public override bool CanDropNode (object dataObject, DragOperation operation)
+		[CommandHandler (ProjectCommands.AddProject)]
+		public void AddProjectToCombine()
 		{
-			return dataObject is CombineEntry;
+			Combine combine = (Combine) CurrentNode.DataItem;
+			CombineEntry ce = Runtime.ProjectService.AddCombineEntry (combine);
+			if (ce == null) return;
+			Tree.AddNodeInsertCallback (ce, new TreeNodeCallback (OnEntryInserted));
+			CurrentNode.Expanded = true;
 		}
 		
-		public override void OnNodeDrop (object dataObject, DragOperation operation)
+		[CommandHandler (ProjectCommands.AddNewCombine)]
+		public void AddNewCombineToCombine()
 		{
+			Combine combine = (Combine) CurrentNode.DataItem;
+			CombineEntry ce = Runtime.ProjectService.CreateCombine (combine);
+			if (ce == null) return;
+			Tree.AddNodeInsertCallback (ce, new TreeNodeCallback (OnEntryInserted));
+			CurrentNode.Expanded = true;
 		}
+		
+		[CommandHandler (ProjectCommands.AddCombine)]
+		public void AddCombineToCombine()
+		{
+			Combine combine = (Combine) CurrentNode.DataItem;
+			CombineEntry ce = Runtime.ProjectService.AddCombineEntry (combine);
+			if (ce == null) return;
+			Tree.AddNodeInsertCallback (ce, new TreeNodeCallback (OnEntryInserted));
+			CurrentNode.Expanded = true;
+		}
+		
+		void OnEntryInserted (ITreeNavigator nav)
+		{
+			nav.Selected = true;
+			nav.Expanded = true;
+		}
+		
+		[CommandHandler (ProjectCommands.Options)]
+		public void OnCombineOptions ()
+		{
+			Runtime.ProjectService.ShowOptions ((Combine) CurrentNode.DataItem);
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/FolderNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/FolderNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/FolderNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -30,9 +30,12 @@
 using System.IO;
 using System.Collections;
 using System.Text;
+using Gtk;
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
+using MonoDevelop.Gui.Widgets;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -174,5 +177,123 @@
 			}
 			Runtime.ProjectService.SaveCombine();
 		}
+		
+		[CommandHandler (ProjectCommands.AddFiles)]
+		public void AddFilesToProject()
+		{
+			Project project = CurrentNode.GetParentDataItem (typeof(Project), true) as Project;
+			
+			using (FileSelector fdiag  = new FileSelector (GettextCatalog.GetString (&quot;Add files&quot;))) {
+				fdiag.SelectMultiple = true;
+				
+				int result = fdiag.Run ();
+				try {
+					if (result != (int) ResponseType.Ok)
+						return;
+					
+					foreach (string file in fdiag.Filenames) {
+						if (file.StartsWith (project.BaseDirectory)) {
+							MoveCopyFile (project, CurrentNode, file, true, true);
+						} else {
+							using (MessageDialog md = new MessageDialog (
+																		 (Window) WorkbenchSingleton.Workbench,
+																		 DialogFlags.Modal | DialogFlags.DestroyWithParent,
+																		 MessageType.Question, ButtonsType.None,
+																		 String.Format (GettextCatalog.GetString (&quot;{0} is outside the project directory, what should I do?&quot;), file))) {
+								md.AddButton (Gtk.Stock.Copy, 1);
+								md.AddButton (GettextCatalog.GetString (&quot;_Move&quot;), 2);
+								md.AddButton (Gtk.Stock.Cancel, ResponseType.Cancel);
+								
+								int ret = md.Run ();
+								md.Hide ();
+								
+								if (ret &lt; 0)
+									return;
+
+								try {
+									MoveCopyFile (project, CurrentNode, file, ret == 2, false);
+								}
+								catch {
+									Runtime.MessageService.ShowError (GettextCatalog.GetString (&quot;An error occurred while attempt to move/copy that file. Please check your permissions.&quot;));
+								}
+							}
+						}
+					}
+				} finally {
+					fdiag.Hide ();
+				}
+			}
+		}
+		
+		public static void MoveCopyFile (Project project, ITreeNavigator nav, string filename, bool move, bool alreadyInPlace)
+		{
+			if (Runtime.FileUtilityService.IsDirectory (filename))
+			    return;
+
+			ProjectFolder folder = nav.GetParentDataItem (typeof(ProjectFolder), true) as ProjectFolder;
+			
+			string name = System.IO.Path.GetFileName (filename);
+			string baseDirectory = folder != null ? folder.Path : project.BaseDirectory;
+			string newfilename = alreadyInPlace ? filename : Path.Combine (baseDirectory, name);
+
+			if (filename != newfilename) {
+				File.Copy (filename, newfilename);
+				if (move)
+					Runtime.FileService.RemoveFile (filename);
+			}
+			
+			if (project.IsCompileable (newfilename)) {
+				project.AddFile (newfilename, BuildAction.Compile);
+			} else {
+				project.AddFile (newfilename, BuildAction.Nothing);
+			}
+
+			Runtime.ProjectService.SaveCombine();
+		}		
+
+		[CommandHandler (ProjectCommands.AddNewFiles)]
+		public void AddNewFileToProject()
+		{
+			Project project = CurrentNode.GetParentDataItem (typeof(Project), true) as Project;
+			ProjectFile file = Runtime.ProjectService.CreateProjectFile (project, GetFolderPath (CurrentNode.DataItem));
+			if (file != null) {
+				Runtime.ProjectService.SaveCombine();
+				CurrentNode.Expanded = true;
+				Tree.AddNodeInsertCallback (file, new TreeNodeCallback (OnFileInserted));
+			}
+		}
+		
+		void OnFileInserted (ITreeNavigator nav)
+		{
+			Tree.StealFocus ();
+			nav.Selected = true;
+			Tree.StartLabelEdit ();
+		}
+		
+		[CommandHandler (ProjectCommands.NewFolder)]
+		public void AddNewFolder ()
+		{
+			Project project = CurrentNode.GetParentDataItem (typeof(Project), true) as Project;
+			
+			string baseFolderPath = GetFolderPath (CurrentNode.DataItem);
+			string directoryName = Path.Combine (baseFolderPath, GettextCatalog.GetString(&quot;New Folder&quot;));
+			int index = -1;
+
+			if (Directory.Exists(directoryName)) {
+				while (Directory.Exists(directoryName + (++index + 1))) ;
+			}
+			
+			if (index &gt;= 0) {
+				directoryName += index + 1;
+			}
+			
+			Directory.CreateDirectory (directoryName);
+			
+			ProjectFile newFolder = new ProjectFile (directoryName);
+			newFolder.Subtype = Subtype.Directory;
+			project.ProjectFiles.Add (newFolder);
+
+			Tree.AddNodeInsertCallback (newFolder, new TreeNodeCallback (OnFileInserted));
+		}
 	}	
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFileNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFileNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFileNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -103,8 +104,23 @@
 			Runtime.FileService.OpenFile (file.FilePath);
 		}
 		
-		public override void RemoveItem ()
+		public override DragOperation CanDragNode ()
 		{
+			return DragOperation.Copy | DragOperation.Move;
+		}
+		
+		public override bool CanDropNode (object dataObject, DragOperation operation)
+		{
+			return dataObject is CombineEntry;
+		}
+		
+		public override void OnNodeDrop (object dataObject, DragOperation operation)
+		{
+		}
+		
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
+		{
 			ProjectFile file = CurrentNode.DataItem as ProjectFile;
 			Project project = CurrentNode.GetParentDataItem (typeof(Project), false) as Project;
 			
@@ -123,18 +139,45 @@
 			Runtime.ProjectService.SaveCombine();
 		}
 		
-		public override DragOperation CanDragNode ()
+		[CommandUpdateHandler (ProjectCommands.IncludeInBuild)]
+		public void OnUpdateIncludeInBuild (CommandInfo info)
 		{
-			return DragOperation.Copy | DragOperation.Move;
+			ProjectFile file = CurrentNode.DataItem as ProjectFile;
+			info.Checked = (file.BuildAction == BuildAction.Compile);
 		}
 		
-		public override bool CanDropNode (object dataObject, DragOperation operation)
+		[CommandHandler (ProjectCommands.IncludeInBuild)]
+		public void OnIncludeInBuild ()
 		{
-			return dataObject is CombineEntry;
+			ProjectFile finfo = CurrentNode.DataItem as ProjectFile;
+			if (finfo.BuildAction == BuildAction.Compile) {
+				finfo.BuildAction = BuildAction.Nothing;
+			} else {
+				finfo.BuildAction = BuildAction.Compile;
+			}
+			Runtime.ProjectService.SaveCombine();
 		}
 		
-		public override void OnNodeDrop (object dataObject, DragOperation operation)
+		[CommandUpdateHandler (ProjectCommands.IncludeInDeploy)]
+		public void OnUpdateIncludeInDeploy (CommandInfo info)
 		{
+			Project project = (Project) CurrentNode.GetParentDataItem (typeof(Project), false);
+			ProjectFile finfo = CurrentNode.DataItem as ProjectFile;
+			info.Checked = !project.DeployInformation.IsFileExcluded (finfo.Name);
 		}
+		
+		[CommandHandler (ProjectCommands.IncludeInDeploy)]
+		public void OnIncludeInDeploy ()
+		{
+			ProjectFile finfo = CurrentNode.DataItem as ProjectFile;
+			Project project = (Project) CurrentNode.GetParentDataItem (typeof(Project), false);
+
+			if (project.DeployInformation.IsFileExcluded (finfo.Name)) {
+				project.DeployInformation.RemoveExcludedFile (finfo.Name);
+			} else {
+				project.DeployInformation.AddExcludedFile (finfo.Name);
+			}
+			Runtime.ProjectService.SaveCombine();
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFolderNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFolderNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectFolderNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -150,7 +151,8 @@
 			}
 		}
 		
-		public override void RemoveItem ()
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
 		{
 			ProjectFolder folder = (ProjectFolder) CurrentNode.DataItem as ProjectFolder;
 			

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -254,8 +255,34 @@
 		{
 		}
 		
-		public override void RemoveItem ()
+		[CommandHandler (ProjectCommands.Options)]
+		public void OnProjectOptions ()
 		{
+			Project selectedProject = CurrentNode.DataItem as Project;
+			Runtime.ProjectService.ShowOptions (selectedProject);
+		}
+		
+		[CommandHandler (ProjectCommands.Deploy)]
+		public void OnProjectDeploy ()
+		{
+			Project selectedProject = CurrentNode.DataItem as Project;
+			Runtime.ProjectService.Deploy (selectedProject);
+		}
+		
+		[CommandHandler (ProjectCommands.SetAsStartupProject)]
+		public void SetAsStartupProject ()
+		{
+			Project project = CurrentNode.DataItem as Project;
+			Combine combine = CurrentNode.GetParentDataItem (typeof(Combine), false) as Combine;
+			
+			combine.StartupEntry = project;
+			combine.SingleStartupProject = true;
+			Runtime.ProjectService.SaveCombine ();
+		}
+		
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
+		{
 			Combine cmb = CurrentNode.GetParentDataItem (typeof(Combine), false) as Combine;;
 			Project prj = CurrentNode.DataItem as Project;
 			
@@ -266,6 +293,14 @@
 			}
 		}
 		
+		[CommandHandler (ProjectCommands.AddReference)]
+		public void AddReferenceToProject ()
+		{
+			Project p = (Project) CurrentNode.DataItem;
+			if (Runtime.ProjectService.AddReferenceToProject (p))
+				Runtime.ProjectService.SaveCombine();
+		}
+		
 		public override DragOperation CanDragNode ()
 		{
 			return DragOperation.Copy | DragOperation.Move;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceFolderNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceFolderNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceFolderNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -31,6 +31,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -146,5 +147,15 @@
 			}
 			Runtime.ProjectService.SaveCombine();
 		}
+		
+		[CommandHandler (ProjectCommands.AddReference)]
+		public void AddReferenceToProject ()
+		{
+			Project p = (Project) CurrentNode.GetParentDataItem (typeof(Project), false);
+			if (Runtime.ProjectService.AddReferenceToProject (p)) {
+				Runtime.ProjectService.SaveCombine();
+				CurrentNode.Expanded = true;
+			}
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectReferenceNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -86,7 +87,8 @@
 	
 	public class ProjectReferenceNodeCommandHandler: NodeCommandHandler
 	{
-		public override void RemoveItem ()
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
 		{
 			ProjectReference pref = (ProjectReference) CurrentNode.DataItem;
 			Project project = CurrentNode.GetParentDataItem (typeof(Project), false) as Project;

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectSolutionPad.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectSolutionPad.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ProjectSolutionPad.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,60 @@
+//
+// ProjectSolutionPad.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+using System;
+using System.Resources;
+
+using MonoDevelop.Internal.Project;
+using MonoDevelop.Services;
+using MonoDevelop.Core.Properties;
+
+namespace MonoDevelop.Gui.Pads.ProjectPad
+{
+	public class ProjectSolutionPad: SolutionPad
+	{
+		protected override void OnSelectionChanged (object sender, EventArgs args)
+		{
+			base.OnSelectionChanged (sender, args);
+			ITreeNavigator nav = GetSelectedNode ();
+			if (nav != null) {
+				Project p = (Project) nav.GetParentDataItem (typeof(Project), true);
+				Runtime.ProjectService.CurrentSelectedProject = p;
+				Combine c = (Combine) nav.GetParentDataItem (typeof(Combine), true);
+				Runtime.ProjectService.CurrentSelectedCombine = c;
+			}
+		}
+		
+		protected override void OnCloseCombine (object sender, CombineEventArgs e)
+		{
+			base.OnCloseCombine (sender, e);
+			Runtime.ProjectService.CurrentSelectedProject = null;
+			Runtime.ProjectService.CurrentSelectedCombine = null;
+		}
+	}
+}
+

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ResourceFolderNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ResourceFolderNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ResourceFolderNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,8 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
+using MonoDevelop.Gui.Widgets;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -47,6 +49,10 @@
 			return &quot;Resources&quot;;
 		}
 		
+		public override Type CommandHandlerType {
+			get { return typeof(ResourceFolderNodeCommandHandler); }
+		}
+		
 		public override string ContextMenuAddinPath {
 			get { return &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ResourceFolderNode&quot;; }
 		}
@@ -83,4 +89,54 @@
 					builder.AddChild (file);
 		}
 	}
+	
+	public class ResourceFolderNodeCommandHandler: NodeCommandHandler
+	{
+		[CommandHandler (ProjectCommands.AddResource)]
+		public void AddResourceToProject ()
+		{
+			Project project = CurrentNode.GetParentDataItem (typeof(Project), true) as Project;
+			if (project == null) return;
+			
+			string [] files;
+			do {
+				files = AskFiles (project);
+				if (files == null) return;
+			}
+			while (!CheckFiles (files));
+			
+			CurrentNode.Expanded = true;
+		
+			foreach (string fileName in files)
+				project.AddFile (fileName, BuildAction.EmbedAsResource);
+			Runtime.ProjectService.SaveCombine ();
+		}
+		
+		string[] AskFiles (Project project)
+		{
+			using (FileSelector fs = new FileSelector (GettextCatalog.GetString (&quot;File to Open&quot;))) {
+				fs.SelectMultiple = true;
+				fs.SetFilename (project.BaseDirectory);
+				int response = fs.Run ();
+				string [] files = fs.Filenames;
+				fs.Hide ();
+
+				if (response != (int)Gtk.ResponseType.Ok)
+					return null;
+				else
+					return files;
+			}
+		}
+		
+		bool CheckFiles (string[] files)
+		{
+			foreach (string file in files) {
+				if (!System.IO.File.Exists (file)) {
+					Runtime.MessageService.ShowError (String.Format (GettextCatalog.GetString (&quot;Resource file '{0}' does not exist&quot;), file));
+					return false;
+				}
+			}
+			return true;
+		}
+	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ShowAllFilesBuilderExtension.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ShowAllFilesBuilderExtension.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/ShowAllFilesBuilderExtension.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -205,20 +205,6 @@
 			}
 		}
 		
-		bool RemoveFile (string file, Project project)
-		{
-			ITreeBuilder tb = Context.GetTreeBuilder (new SystemFile (file, project));
-			if (tb != null) {
-				tb.Remove (true);
-				while (tb.DataItem is ProjectFolder) {
-					tb.Update ();
-					tb.MoveToParent ();
-				}
-				return true;
-			}
-			return false;
-		}
-		
 		ITreeBuilder FindParentFolderNode (string path, Project project, out string lastChildPath)
 		{
 			lastChildPath = path;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/SystemFileNodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/SystemFileNodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/ProjectPad/SystemFileNodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -32,6 +32,7 @@
 
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Services;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads.ProjectPad
 {
@@ -108,7 +109,8 @@
 			Runtime.FileService.OpenFile (file.Path);
 		}
 		
-		public override void RemoveItem ()
+		[CommandHandler (EditCommands.Delete)]
+		public void RemoveItem ()
 		{
 			SystemFile file = CurrentNode.DataItem as SystemFile;
 			
@@ -126,5 +128,17 @@
 		{
 			return DragOperation.Copy | DragOperation.Move;
 		}
+		
+		[CommandHandler (ProjectCommands.IncludeToProject)]
+		public void IncludeFileToProject ()
+		{
+			Project project = CurrentNode.GetParentDataItem (typeof(Project), true) as Project;
+			SystemFile file = (SystemFile) CurrentNode.DataItem;
+			
+			if (project.IsCompileable (file.Path))
+				project.AddFile (file.Path, BuildAction.Compile);
+			else
+				project.AddFile (file.Path, BuildAction.Nothing);
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeBuilder.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeBuilder.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeBuilder.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -47,8 +47,10 @@
 		
 		internal NodeCommandHandler CommandHandler {
 			get {
-				if (commandHandler == null)
+//				if (commandHandler == null) {
 					commandHandler = (NodeCommandHandler) Activator.CreateInstance (CommandHandlerType);
+					commandHandler.Initialize (context.Tree);
+//				}
 				return commandHandler;
 			}
 		}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeCommandHandler.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeCommandHandler.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/NodeCommandHandler.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -27,22 +27,44 @@
 //
 
 using System;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads
 {
-	public class NodeCommandHandler
+	public class NodeCommandHandler: ICommandRouter
 	{
 		ITreeNavigator currentNode;
+		TreeViewPad tree;
+		object nextTarget;
 		
+		internal void Initialize (TreeViewPad tree)
+		{
+			this.tree = tree;
+		}
+		
 		internal void SetCurrentNode (ITreeNavigator currentNode)
 		{
 			this.currentNode = currentNode;
 		}
 		
+		internal void SetNextTarget (object nextTarget)
+		{
+			this.nextTarget = nextTarget;
+		}
+		
+		object ICommandRouter.GetNextCommandTarget ()
+		{
+			return nextTarget;
+		}
+		
 		protected ITreeNavigator CurrentNode {
 			get { return currentNode; }
 		}
 		
+		protected TreeViewPad Tree {
+			get { return tree; }
+		}
+		
 		public virtual void RenameItem (string newName)
 		{
 		}
@@ -51,10 +73,6 @@
 		{
 		}
 		
-		public virtual void RemoveItem ()
-		{
-		}
-		
 		public virtual DragOperation CanDragNode ()
 		{
 			return DragOperation.None;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/SolutionPad.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/SolutionPad.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/SolutionPad.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -37,10 +37,10 @@
 {
 	public class SolutionPad : TreeViewPad
 	{
-		public SolutionPad (string label, string icon, NodeBuilder[] builders, TreePadOption[] options): base (label, icon, builders, options)
+		public SolutionPad ()
 		{
-			Runtime.ProjectService.CombineOpened += (CombineEventHandler) Runtime.DispatchService.GuiDispatch (new CombineEventHandler (OpenCombine));
-			Runtime.ProjectService.CombineClosed += (CombineEventHandler) Runtime.DispatchService.GuiDispatch (new CombineEventHandler (CloseCombine));
+			Runtime.ProjectService.CombineOpened += (CombineEventHandler) Runtime.DispatchService.GuiDispatch (new CombineEventHandler (OnOpenCombine));
+			Runtime.ProjectService.CombineClosed += (CombineEventHandler) Runtime.DispatchService.GuiDispatch (new CombineEventHandler (OnCloseCombine));
 			WorkbenchSingleton.Workbench.ActiveWorkbenchWindowChanged += new EventHandler(ActiveWindowChanged);
 			Runtime.Properties.PropertyChanged += (PropertyEventHandler) Runtime.DispatchService.GuiDispatch (new PropertyEventHandler (TrackPropertyChange));
 		}
@@ -60,12 +60,12 @@
 			}
 		}
 
-		void OpenCombine(object sender, CombineEventArgs e)
+		protected virtual void OnOpenCombine (object sender, CombineEventArgs e)
 		{
 			LoadTree (e.Combine);
 		}
 
-		void CloseCombine(object sender, CombineEventArgs e)
+		protected virtual void OnCloseCombine (object sender, CombineEventArgs e)
 		{
 			Clear ();
 		}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/TreeViewPad.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/TreeViewPad.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Pads/SolutionPad/TreeViewPad.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -46,13 +46,14 @@
 using MonoDevelop.Gui.Dialogs;
 using MonoDevelop.Services;
 using MonoDevelop.Gui.Widgets;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui.Pads
 {
 	/// &lt;summary&gt;
 	/// This class implements a project browser.
 	/// &lt;/summary&gt;
-	public class TreeViewPad : IPadContent, IMementoCapable
+	public class TreeViewPad : IPadContent, IMementoCapable, ICommandRouter
 	{
 		string title;
 		string icon;
@@ -89,7 +90,7 @@
 		object copyObject;
 		DragOperation currentTransferOperation;
 
-		Gtk.Frame contentPanel = new Gtk.Frame();
+		Gtk.Frame contentPanel;
 
 		private static Gtk.TargetEntry [] target_table = new Gtk.TargetEntry [] {
 			new Gtk.TargetEntry (&quot;text/uri-list&quot;, 0, 11 ),
@@ -131,8 +132,17 @@
 		{
 		}
 		
+		public TreeViewPad ()
+		{
+		}
+		
 		public TreeViewPad (string label, string icon, NodeBuilder[] builders, TreePadOption[] options)
 		{
+			Initialize (label, icon, builders, options);
+		}
+		
+		public virtual void Initialize (string label, string icon, NodeBuilder[] builders, TreePadOption[] options)
+		{
 			// Create default options
 			
 			this.options = options;
@@ -206,7 +216,7 @@
 			
 			Gtk.ScrolledWindow sw = new Gtk.ScrolledWindow ();
 			sw.Add(tree);
-			contentPanel = new Gtk.Frame();
+			contentPanel = new TreeFrame (this);
 			contentPanel.Add(sw);
 			
 			tree.TestExpandRow += new Gtk.TestExpandRowHandler (OnTestExpandRow);
@@ -227,9 +237,10 @@
 			tree.DragDrop += new Gtk.DragDropHandler (OnDragDrop);
 			tree.DragEnd += new Gtk.DragEndHandler (OnDragEnd);
 			tree.DragMotion += new Gtk.DragMotionHandler (OnDragMotion);
+			
+			tree.CursorChanged += new EventHandler (OnSelectionChanged);
 		}
 
-
 		void OnDragBegin (object o, Gtk.DragBeginArgs arg)
 		{
 			ITreeNavigator nav = GetSelectedNode ();
@@ -291,11 +302,12 @@
 			DragOperation oper = ctx.Action == Gdk.DragAction.Copy ? DragOperation.Copy : DragOperation.Move;
 			
 			foreach (NodeBuilder nb in chain) {
-				nb.CommandHandler.SetCurrentNode (nav);
-				if (nb.CommandHandler.CanDropNode (obj, oper)) {
+				NodeCommandHandler handler = nb.CommandHandler;
+				handler.SetCurrentNode (nav);
+				if (handler.CanDropNode (obj, oper)) {
 					foundHandler = true;
 					if (drop)
-						nb.CommandHandler.OnNodeDrop (obj, oper);
+						handler.OnNodeDrop (obj, oper);
 				}
 			}
 			return foundHandler;
@@ -389,40 +401,53 @@
 			}
 		}
 		
-		public void ActivateCurrentItem ()
+		object ICommandRouter.GetNextCommandTarget ()
 		{
 			TreeNodeNavigator node = (TreeNodeNavigator) GetSelectedNode ();
 			if (node != null) {
 				NodeBuilder[] chain = node.NodeBuilderChain;
-				NodePosition pos = node.CurrentPosition;
-				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					b.CommandHandler.ActivateItem ();
-					node.MoveToPosition (pos);
+				if (chain.Length &gt; 0) {
+					NodeCommandHandler[] handlers = new NodeCommandHandler [chain.Length];
+					for (int n=0; n&lt;chain.Length; n++)
+						handlers [n] = chain [n].CommandHandler;
+					
+					for (int n=0; n&lt;handlers.Length; n++) {
+						handlers [n].SetCurrentNode (node);
+						if (n &lt; chain.Length - 1)
+							handlers [n].SetNextTarget (handlers [n+1]);
+						else
+							handlers [n].SetNextTarget (contentPanel.Parent);
+					}
+					return handlers [0];
 				}
 			}
+			return contentPanel.Parent;
 		}
 
-		public void RemoveCurrentItem ()
+		[CommandHandler (ViewCommands.Open)]
+		public void ActivateCurrentItem ()
 		{
 			TreeNodeNavigator node = (TreeNodeNavigator) GetSelectedNode ();
 			if (node != null) {
 				NodeBuilder[] chain = node.NodeBuilderChain;
 				NodePosition pos = node.CurrentPosition;
 				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					b.CommandHandler.RemoveItem ();
+					NodeCommandHandler handler = b.CommandHandler;
+					handler.SetCurrentNode (node);
+					handler.ActivateItem ();
 					node.MoveToPosition (pos);
 				}
 			}
 		}
 
+		[CommandHandler (EditCommands.Copy)]
 		public void CopyCurrentItem ()
 		{
 			CancelTransfer ();
 			TransferCurrentItem (DragOperation.Copy);
 		}
 
+		[CommandHandler (EditCommands.Cut)]
 		public void CutCurrentItem ()
 		{
 			CancelTransfer ();
@@ -435,14 +460,16 @@
 			}
 		}
 		
-		public bool CanCopyCurrentItem ()
+		[CommandUpdateHandler (EditCommands.Copy)]
+		protected void UpdateCopyCurrentItem (CommandInfo info)
 		{
-			return CanTransferCurrentItem (DragOperation.Copy);
+			info.Enabled = CanTransferCurrentItem (DragOperation.Copy);
 		}
 
-		public bool CanCutCurrentItem ()
+		[CommandUpdateHandler (EditCommands.Cut)]
+		protected void UpdateCutCurrentItem (CommandInfo info)
 		{
-			return CanTransferCurrentItem (DragOperation.Move);
+			info.Enabled = CanTransferCurrentItem (DragOperation.Move);
 		}
 		
 		void TransferCurrentItem (DragOperation oper)
@@ -452,8 +479,9 @@
 				NodeBuilder[] chain = node.NodeBuilderChain;
 				NodePosition pos = node.CurrentPosition;
 				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					if ((b.CommandHandler.CanDragNode () &amp; oper) != 0) {
+					NodeCommandHandler handler = b.CommandHandler;
+					handler.SetCurrentNode (node);
+					if ((handler.CanDragNode () &amp; oper) != 0) {
 						node.MoveToPosition (pos);
 						copyObject = node.DataItem;
 						currentTransferOperation = oper;
@@ -471,8 +499,9 @@
 				NodeBuilder[] chain = node.NodeBuilderChain;
 				NodePosition pos = node.CurrentPosition;
 				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					if ((b.CommandHandler.CanDragNode () &amp; oper) != 0)
+					NodeCommandHandler handler = b.CommandHandler;
+					handler.SetCurrentNode (node);
+					if ((handler.CanDragNode () &amp; oper) != 0)
 						return true;
 					node.MoveToPosition (pos);
 				}
@@ -480,6 +509,7 @@
 			return false;
 		}
 		
+		[CommandHandler (EditCommands.Paste)]
 		public void PasteToCurrentItem ()
 		{
 			if (copyObject == null) return;
@@ -489,10 +519,11 @@
 				NodeBuilder[] chain = node.NodeBuilderChain;
 				NodePosition pos = node.CurrentPosition;
 				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					if (b.CommandHandler.CanDropNode (copyObject, currentTransferOperation)) {
+					NodeCommandHandler handler = b.CommandHandler;
+					handler.SetCurrentNode (node);
+					if (handler.CanDropNode (copyObject, currentTransferOperation)) {
 						node.MoveToPosition (pos);
-						b.CommandHandler.OnNodeDrop (copyObject, currentTransferOperation);
+						handler.OnNodeDrop (copyObject, currentTransferOperation);
 					}
 					node.MoveToPosition (pos);
 				}
@@ -500,22 +531,26 @@
 			CancelTransfer ();
 		}
 
-		public bool CanPasteToCurrentItem ()
+		[CommandUpdateHandler (EditCommands.Paste)]
+		protected void UpdatePasteToCurrentItem (CommandInfo info)
 		{
-			if (copyObject == null) return false;
-			
-			TreeNodeNavigator node = (TreeNodeNavigator) GetSelectedNode ();
-			if (node != null) {
-				NodeBuilder[] chain = node.NodeBuilderChain;
-				NodePosition pos = node.CurrentPosition;
-				foreach (NodeBuilder b in chain) {
-					b.CommandHandler.SetCurrentNode (node);
-					if (b.CommandHandler.CanDropNode (copyObject, currentTransferOperation))
-						return true;
-					node.MoveToPosition (pos);
+			if (copyObject != null) {
+				TreeNodeNavigator node = (TreeNodeNavigator) GetSelectedNode ();
+				if (node != null) {
+					NodeBuilder[] chain = node.NodeBuilderChain;
+					NodePosition pos = node.CurrentPosition;
+					foreach (NodeBuilder b in chain) {
+						NodeCommandHandler handler = b.CommandHandler;
+						handler.SetCurrentNode (node);
+						if (handler.CanDropNode (copyObject, currentTransferOperation)) {
+							info.Enabled = true;
+							return;
+						}
+						node.MoveToPosition (pos);
+					}
 				}
 			}
-			return false;
+			info.Enabled = false;
 		}
 
 		void CancelTransfer ()
@@ -536,6 +571,7 @@
 		/// call this method, instead of using the LabelEdit Property and the BeginEdit
 		/// Method directly.
 		/// &lt;/summary&gt;
+		[CommandHandler (EditCommands.Rename)]
 		public void StartLabelEdit()
 		{
 			Gtk.TreeModel foo;
@@ -566,8 +602,9 @@
 
 			NodeBuilder[] chain = (NodeBuilder[]) store.GetValue (iter, BuilderChainColumn);
 			foreach (NodeBuilder b in chain) {
-				b.CommandHandler.SetCurrentNode (nav);
-				b.CommandHandler.RenameItem (e.NewText);
+				NodeCommandHandler handler = b.CommandHandler;
+				handler.SetCurrentNode (nav);
+				handler.RenameItem (e.NewText);
 				nav.MoveToPosition (pos);
 			}
 		}
@@ -869,63 +906,54 @@
 		void ShowPopup ()
 		{
 			ITreeNavigator tnav = GetSelectedNode ();
-			Runtime.ProjectService.CurrentSelectedProject = tnav.GetParentDataItem (typeof(Project), true) as Project;
-			Runtime.ProjectService.CurrentSelectedCombine = tnav.GetParentDataItem (typeof(Combine), true) as Combine;
-			
 			TypeNodeBuilder nb = GetTypeNodeBuilder (tnav.CurrentPosition._iter);
 			if (nb == null || nb.ContextMenuAddinPath == null) {
-				if (options.Length &gt; 0)
-					Runtime.Gui.Menus.ShowContextMenu (BuildTreeOptionsMenu (tnav));
-			} else {
-				Gtk.Menu menu = Runtime.Gui.Menus.CreateContextMenu (this, nb.ContextMenuAddinPath);
 				if (options.Length &gt; 0) {
-					Gtk.MenuItem mi = new Gtk.SeparatorMenuItem ();
-					mi.Show ();
-					menu.Append (mi);
-					
-					mi = new Gtk.MenuItem (GettextCatalog.GetString (&quot;Display Options&quot;));
-					menu.Append (mi);
-					mi.Submenu = BuildTreeOptionsMenu (tnav);
-					mi.Show ();
+					CommandEntrySet opset = new CommandEntrySet ();
+					opset.AddItem (ViewCommands.TreeDisplayOptionList);
+					opset.AddItem (Command.Separator);
+					opset.AddItem (ViewCommands.ResetTreeDisplayOptions);
+					Gtk.Menu menu = Runtime.Gui.CommandService.CreateMenu (opset);
+					Runtime.Gui.Menus.ShowContextMenu (menu);
 				}
+			} else {
+				CommandEntrySet eset = Runtime.Gui.CommandService.CreateCommandEntrySet (nb.ContextMenuAddinPath);
+				eset.AddItem (Command.Separator);
+				CommandEntrySet opset = eset.AddItemSet (GettextCatalog.GetString (&quot;Display Options&quot;));
+				opset.AddItem (ViewCommands.TreeDisplayOptionList);
+				opset.AddItem (Command.Separator);
+				opset.AddItem (ViewCommands.ResetTreeDisplayOptions);
+				Gtk.Menu menu = Runtime.Gui.CommandService.CreateMenu (eset);
 				Runtime.Gui.Menus.ShowContextMenu (menu);
 			}
 		}
 		
-		Gtk.Menu BuildTreeOptionsMenu (ITreeNavigator tnav)
+		[CommandUpdateHandler (ViewCommands.TreeDisplayOptionList)]
+		void BuildTreeOptionsMenu (CommandArrayInfo info)
 		{
+			ITreeNavigator tnav = GetSelectedNode ();
 			ITreeOptions currentOptions = tnav.Options;
-			Gtk.Menu omenu = new Gtk.Menu ();
-
 			foreach (TreePadOption op in options) {
-				PadCheckMenuItem cmi = new PadCheckMenuItem (op.Label, op.Id);
-				cmi.Active = currentOptions [op.Id];
-				omenu.Append (cmi);
-				cmi.Toggled += new EventHandler (OptionToggled);
+				CommandInfo ci = new CommandInfo (op.Label);
+				ci.Checked = currentOptions [op.Id];
+				info.Add (ci, op.Id);
 			}
-			
-			omenu.Append (new Gtk.SeparatorMenuItem ());
-			
-			Gtk.MenuItem mi = new Gtk.MenuItem (GettextCatalog.GetString (&quot;Reset Options&quot;));
-			mi.Activated += new EventHandler (ResetOptions);
-			omenu.Append (mi);
-			omenu.ShowAll ();
-			
-			return omenu;
 		}
 		
-		void OptionToggled (object sender, EventArgs args)
+		[CommandHandler (ViewCommands.TreeDisplayOptionList)]
+		void OptionToggled (string optionId)
 		{
 			Gtk.TreeModel foo;
 			Gtk.TreeIter iter;
 			if (!tree.Selection.GetSelected (out foo, out iter))
 				return;
 
-			PadCheckMenuItem mi = (PadCheckMenuItem) sender;
-			GetOptions (iter, true) [mi.Id] = mi.Active;
+			TreeOptions ops = GetOptions (iter, true);
+			ops [optionId] = !ops [optionId];
 		}
 		
-		void ResetOptions (object sender, EventArgs args)
+		[CommandHandler (ViewCommands.ResetTreeDisplayOptions)]
+		void ResetOptions ()
 		{
 			Gtk.TreeModel foo;
 			Gtk.TreeIter iter;
@@ -950,11 +978,15 @@
 			}
 		}
 
-		private void OnNodeActivated (object sender, Gtk.RowActivatedArgs args)
+		protected virtual void OnNodeActivated (object sender, Gtk.RowActivatedArgs args)
 		{
 			ActivateCurrentItem ();
 		}
 		
+		protected virtual void OnSelectionChanged (object sender, EventArgs args)
+		{
+		}
+		
 		public IXmlConvertable CreateMemento ()
 		{
 			return new TreeViewPadMemento (this);
@@ -1650,5 +1682,20 @@
 		}
 	}
 	
+	class TreeFrame: Gtk.Frame, ICommandRouter
+	{
+		object nextTarget;
+		
+		public TreeFrame (object nextTarget)
+		{
+			this.nextTarget = nextTarget;
+		}
+		
+		object ICommandRouter.GetNextCommandTarget ()
+		{
+			return nextTarget;
+		}
+	}
+	
 	public delegate void TreeNodeCallback (ITreeNavigator nav);
 }

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/ViewCommandHandlers.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/ViewCommandHandlers.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/ViewCommandHandlers.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,266 @@
+
+using System;
+using System.Collections;
+using System.IO;
+using Gtk;
+
+using Gdl;
+
+using MonoDevelop.Core.Services;
+using MonoDevelop.Services;
+
+using MonoDevelop.Gui.Utils;
+using MonoDevelop.Gui.Widgets;
+using MonoDevelop.Gui.Dialogs;
+using MonoDevelop.Core.Properties;
+using MonoDevelop.Core.AddIns;
+using MonoDevelop.Commands;
+
+namespace MonoDevelop.Gui
+{
+	public class ViewCommandHandlers: ICommandRouter
+	{
+		IWorkbenchWindow window;
+		object nextTarget;
+
+		public ViewCommandHandlers (IWorkbenchWindow window)
+		{
+			this.window = window;
+		}
+		
+		object ICommandRouter.GetNextCommandTarget ()
+		{
+			return nextTarget;
+		}
+		
+		public void SetNextCommandTarget (object nextTarget)
+		{
+			this.nextTarget = nextTarget;
+		}
+		
+		[CommandHandler (FileCommands.CloseFile)]
+		protected void OnCloseFile ()
+		{
+			window.CloseWindow (false, true, 0);
+		}
+		
+		[CommandHandler (FileCommands.Save)]
+		protected void OnSaveFile ()
+		{
+			Runtime.FileService.SaveFile (window);
+		}
+		
+		[CommandUpdateHandler (FileCommands.Save)]
+		protected void OnUpdateSaveFile (CommandInfo info)
+		{
+			if (window.ViewContent.IsViewOnly) {
+				info.Enabled = false;
+				return;
+			}
+			
+			IViewContent content = window.ActiveViewContent as IViewContent;
+			if (content != null)
+				info.Enabled = content.IsDirty;
+			else
+				info.Enabled = false;
+		}
+
+		[CommandHandler (FileCommands.SaveAs)]
+		protected void OnSaveFileAs ()
+		{
+			Runtime.FileService.SaveFileAs (window);
+		}
+		
+		[CommandHandler (FileCommands.ReloadFile)]
+		protected void OnReloadFile ()
+		{
+			if (Runtime.MessageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure that you want to reload the file?&quot;))) {
+				IXmlConvertable memento = null;
+				if (window.ViewContent is IMementoCapable) {
+					memento = ((IMementoCapable)window.ViewContent).CreateMemento();
+				}
+				window.ViewContent.Load(window.ViewContent.ContentName);
+				if (memento != null) {
+					((IMementoCapable)window.ViewContent).SetMemento(memento);
+				}
+			}
+		}
+		
+		[CommandUpdateHandler (FileCommands.ReloadFile)]
+		protected void OnUpdateReloadFile (CommandInfo info)
+		{
+			info.Enabled = window.ViewContent.ContentName != null &amp;&amp; !window.ViewContent.IsViewOnly;
+		}
+		
+		
+		/*** Edit commands ***/
+		
+		[CommandHandler (EditCommands.Undo)]
+		protected void OnUndo ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.Undo();
+		}
+		
+		[CommandUpdateHandler (EditCommands.Undo)]
+		protected void OnUpdateUndo (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is IEditable;
+		}
+		
+		[CommandHandler (EditCommands.Redo)]
+		protected void OnRedo ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null) {
+				editable.Redo();
+			}
+		}
+		
+		[CommandUpdateHandler (EditCommands.Redo)]
+		protected void OnUpdateRedo (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is IEditable;
+		}
+		
+		[CommandHandler (EditCommands.Cut)]
+		protected void OnCut ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.ClipboardHandler.Cut(null, null);
+		}
+		
+		[CommandUpdateHandler (EditCommands.Cut)]
+		protected void OnUpdateCut (CommandInfo info)
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			info.Enabled = editable != null &amp;&amp; editable.ClipboardHandler.EnableCut;
+		}
+		
+		[CommandHandler (EditCommands.Copy)]
+		protected void OnCopy ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.ClipboardHandler.Copy(null, null);
+		}
+		
+		[CommandUpdateHandler (EditCommands.Copy)]
+		protected void OnUpdateCopy (CommandInfo info)
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			info.Enabled = editable != null &amp;&amp; editable.ClipboardHandler.EnableCopy;
+		}
+		
+		[CommandHandler (EditCommands.Paste)]
+		protected void OnPaste ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.ClipboardHandler.Paste(null, null);
+		}
+		
+		[CommandUpdateHandler (EditCommands.Paste)]
+		protected void OnUpdatePaste (CommandInfo info)
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			info.Enabled = editable != null &amp;&amp; editable.ClipboardHandler.EnablePaste;
+		}
+		
+		[CommandHandler (EditCommands.Delete)]
+		protected void OnDelete ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.ClipboardHandler.Delete(null, null);
+		}
+		
+		[CommandUpdateHandler (EditCommands.Delete)]
+		protected void OnUpdateDelete (CommandInfo info)
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			info.Enabled = editable != null &amp;&amp; editable.ClipboardHandler.EnableDelete;
+		}
+		
+		[CommandHandler (EditCommands.SelectAll)]
+		protected void OnSelectAll ()
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			if (editable != null)
+				editable.ClipboardHandler.SelectAll(null, null);
+		}
+		
+		[CommandUpdateHandler (EditCommands.SelectAll)]
+		protected void OnUpdateSelectAll (CommandInfo info)
+		{
+			IEditable editable = window.ActiveViewContent as IEditable;
+			info.Enabled = editable != null &amp;&amp; editable.ClipboardHandler.EnableSelectAll;
+		}
+		
+		[CommandHandler (EditCommands.WordCount)]
+		protected void OnWordCount()
+		{
+			WordCountDialog wcd = new WordCountDialog ();
+			wcd.Run ();
+			wcd.Hide ();
+		}
+		
+		[CommandHandler (EditCommands.CommentCode)]
+		public void OnCommentCode()
+		{
+			ICodeStyleOperations  styling = window.ActiveViewContent as ICodeStyleOperations;
+			if (styling != null)
+				styling.CommentCode ();
+		}
+		
+		[CommandUpdateHandler (EditCommands.CommentCode)]
+		protected void OnUpdateCommentCode (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is ICodeStyleOperations;
+		}
+		
+		[CommandHandler (EditCommands.UncommentCode)]
+		public void OnUncommentCode()
+		{
+			ICodeStyleOperations  styling = window.ActiveViewContent as ICodeStyleOperations;
+			if (styling != null)
+				styling.UncommentCode ();
+		}
+		
+		[CommandUpdateHandler (EditCommands.UncommentCode)]
+		protected void OnUpdateUncommentCode (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is ICodeStyleOperations;
+		}
+		
+		[CommandHandler (EditCommands.IndentSelection)]
+		public void OnIndentSelection()
+		{
+			ICodeStyleOperations  styling = window.ActiveViewContent as ICodeStyleOperations;
+			if (styling != null)
+				styling.IndentSelection ();
+		}
+		
+		[CommandUpdateHandler (EditCommands.IndentSelection)]
+		protected void OnUpdateIndentSelection (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is ICodeStyleOperations;
+		}
+		
+		[CommandHandler (EditCommands.UnIndentSelection)]
+		public void OnUnIndentSelection()
+		{
+			ICodeStyleOperations  styling = window.ActiveViewContent as ICodeStyleOperations;
+			if (styling != null)
+				styling.UnIndentSelection ();
+		}
+		
+		[CommandUpdateHandler (EditCommands.UnIndentSelection)]
+		protected void OnUpdateUnIndentSelection (CommandInfo info)
+		{
+			info.Enabled = window.ActiveViewContent is ICodeStyleOperations;
+		}
+	}
+}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/DefaultWorkbench.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -36,6 +36,7 @@
 	{
 		readonly static string mainMenuPath    = &quot;/SharpDevelop/Workbench/MainMenu&quot;;
 		readonly static string viewContentPath = &quot;/SharpDevelop/Workbench/Pads&quot;;
+		readonly static string toolbarsPath = &quot;/SharpDevelop/Workbench/ToolBar&quot;;
 		
 		PadContentCollection viewContentCollection       = new PadContentCollection();
 		ViewContentCollection workbenchContentCollection = new ViewContentCollection();
@@ -53,6 +54,7 @@
 		static GType gtype;
 		
 		public Gtk.MenuBar TopMenu = null;
+		private Gtk.Toolbar[] toolbars = null;
 		
 		enum TargetList {
 			UriList = 100
@@ -147,7 +149,6 @@
 
 			IDebuggingService dbgr = Runtime.DebuggingService;
 			if (dbgr != null) {
-				dbgr.StartedEvent += new EventHandler (onDebuggerStarted);
 				dbgr.PausedEvent += new EventHandler (onDebuggerPaused);
 				dbgr.ResumedEvent += new EventHandler (onDebuggerResumed);		
 				dbgr.StoppedEvent += new EventHandler (onDebuggerStopped);
@@ -155,12 +156,13 @@
 
 			Gtk.Drag.DestSet (this, Gtk.DestDefaults.Motion | Gtk.DestDefaults.Highlight | Gtk.DestDefaults.Drop, targetEntryTypes, Gdk.DragAction.Copy);
 			DragDataReceived += new Gtk.DragDataReceivedHandler (onDragDataRec);
+			
+			Runtime.Gui.CommandService.SetRootWindow (this);
 		}
 
 		void onDebuggerStarted (object o, EventArgs e)
 		{
-			context = WorkbenchContext.Debug;
-			ContextChanged (this, new EventArgs());
+			Context = WorkbenchContext.Debug;
 		}
 
 		void onDragDataRec (object o, Gtk.DragDataReceivedArgs args)
@@ -218,17 +220,12 @@
 					break;
 				}
 			}
-			context = WorkbenchContext.Edit;
-			ContextChanged (this, new EventArgs());
 		}
 		
 		public void InitializeWorkspace()
 		{
 			// FIXME: GTKize
-			ActiveWorkbenchWindowChanged += new EventHandler(UpdateMenu);
-			
 			Runtime.ProjectService.CurrentProjectChanged += (ProjectEventHandler) Runtime.DispatchService.GuiDispatch (new ProjectEventHandler(SetProjectTitle));
-			Runtime.ProjectService.CombineOpened         += (CombineEventHandler) Runtime.DispatchService.GuiDispatch (new CombineEventHandler(CombineOpened));
 
 			Runtime.FileService.FileRemoved += new FileEventHandler(CheckRemovedFile);
 			Runtime.FileService.FileRenamed += new FileEventHandler(CheckRenamedFile);
@@ -239,8 +236,8 @@
 //			TopMenu.Selected   += new CommandHandler(OnTopMenuSelected);
 //			TopMenu.Deselected += new CommandHandler(OnTopMenuDeselected);
 
-			CreateToolBars();
-			CreateMainMenu();
+			TopMenu = Runtime.Gui.CommandService.CreateMenuBar (mainMenuPath);
+			toolbars = Runtime.Gui.CommandService.CreateToolbarSet (toolbarsPath);
 		}
 				
 		public void CloseContent(IViewContent content)
@@ -302,8 +299,6 @@
 		
 		public void RedrawAllComponents()
 		{
-			UpdateMenu(null, null);
-			
 			foreach (IViewContent content in workbenchContentCollection) {
 				content.RedrawContent();
 			}
@@ -494,14 +489,8 @@
 			return true;
 		}
 		
-		void CombineOpened(object sender, CombineEventArgs e)
-		{
-			UpdateMenu(null, null);			
-		}
-		
 		void SetProjectTitle(object sender, ProjectEventArgs e)
 		{
-			UpdateMenu(null, null);
 			if (e.Project != null) {
 				Title = String.Concat(e.Project.Name, &quot; - &quot;, &quot;MonoDevelop&quot;);
 			} else {
@@ -521,14 +510,8 @@
 			}
 		}
 
-		private Gtk.Toolbar[] toolbars = null;
 		public Gtk.Toolbar[] ToolBars {
-			get {
-				return toolbars;
-			}
-			set {
-				toolbars = value;
-			}
+			get { return toolbars; }
 		}
 		
 		public IPadContent GetPad(Type type)
@@ -540,47 +523,7 @@
 			}
 			return null;
 		}
-		void CreateMainMenu()
-		{
-			TopMenu = new Gtk.MenuBar ();
-			object[] items = (object[])(AddInTreeSingleton.AddInTree.GetTreeNode(mainMenuPath).BuildChildItems(this)).ToArray(typeof(object));
-			foreach (object item in items) {
-				TopMenu.Append ((Gtk.Widget)item);
-			}
-			UpdateMenu (null, null);
-		}
 		
-		public void UpdateMenu(object sender, EventArgs e)
-		{
-			// update menu
-			foreach (object o in TopMenu.Children) {
-				if (o is SdMenu) {
-					((SdMenu)o).OnDropDown(null, null);
-				}
-			}
-			
-			UpdateToolbars();
-		}
-		
-		public void UpdateToolbars()
-		{
-			foreach (Gtk.Toolbar toolbar in ToolBars) {
-				foreach (object item in toolbar.Children) {
-					if (item is IStatusUpdate) {
-						((IStatusUpdate)item).UpdateStatus();
-					}
-				}
-			}
-		}
-		
-		void CreateToolBars()
-		{
-			if (ToolBars == null) {
-				Gtk.Toolbar[] toolBars = Runtime.Gui.Toolbars.CreateToolbars();
-				ToolBars = toolBars;
-			}
-		}
-		
 		public void UpdateViews(object sender, EventArgs e)
 		{
 			PadCodon[] padCodons = (PadCodon[])(AddInTreeSingleton.AddInTree.GetTreeNode(viewContentPath).BuildChildItems(this)).ToArray(typeof(PadCodon));
@@ -597,8 +540,11 @@
 		WorkbenchContext context = WorkbenchContext.Edit;
 		
 		public WorkbenchContext Context {
-			get {
-				return context;
+			get { return context; }
+			set {
+				context = value;
+				if (ContextChanged != null)
+					ContextChanged (this, new EventArgs());
 			}
 		}
 

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceLayout.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -144,7 +144,6 @@
 		void OnContextChanged (object o, EventArgs e)
 		{
 			SwitchContext (workbench.Context);
-			workbench.UpdateMenu (null, null);
 		}
 
 		void SwitchContext (WorkbenchContext ctxt)

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceWindow.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceWindow.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Gui/Workbench/Layouts/SdiWorkspaceWindow.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -17,10 +17,11 @@
 
 using MonoDevelop.Gui.Utils;
 using MonoDevelop.Gui.Widgets;
+using MonoDevelop.Commands;
 
 namespace MonoDevelop.Gui
 {
-	public class SdiWorkspaceWindow : Frame, IWorkbenchWindow
+	public class SdiWorkspaceWindow : Frame, IWorkbenchWindow, ICommandRouter
 	{
 		Notebook   viewTabControl = null;
 		IViewContent content;
@@ -37,6 +38,8 @@
 
 		bool show_notification = false;
 		
+		ViewCommandHandlers commandHandler;
+		
 		public Widget TabPage {
 			get {
 				return tabPage;
@@ -90,16 +93,6 @@
 			}
 		}
 		
-		void ThreadSafeSelectWindow()
-		{
-			foreach (IViewContent viewContent in WorkbenchSingleton.Workbench.ViewContentCollection) {
-				if (viewContent != this.content) {
-					viewContent.WorkbenchWindow.OnWindowDeselected(EventArgs.Empty);
-				}
-			}
-			OnWindowSelected(EventArgs.Empty);
-		}
-		
 		public void SwitchView(int viewNumber)
 		{
 			if (viewTabControl != null) {
@@ -131,6 +124,8 @@
 			content.Control.ShowAll ();
 			ShowAll ();
 			SetTitleEvent(null, null);
+
+			commandHandler = new ViewCommandHandlers (this);
 		}
 		
 		void BeforeSave(object sender, EventArgs e)
@@ -141,11 +136,6 @@
 			}
 		}
 		
-		void LeaveTabPage(object sender, EventArgs e)
-		{
-			OnWindowDeselected(EventArgs.Empty);
-		}
-		
 		public IViewContent ViewContent {
 			get {
 				return content;
@@ -220,7 +210,7 @@
 				if (save) {
 					if (content.ContentName == null) {
 						while (true) {
-							new MonoDevelop.Commands.SaveFileAs().Run();
+							Runtime.FileService.SaveFileAs (this);
 							if (ViewContent.IsDirty) {
 								if (Runtime.MessageService.AskQuestion(GettextCatalog.GetString (&quot;Do you really want to discard your changes ?&quot;))) {
 									break;
@@ -277,6 +267,7 @@
 			OnContentChanged (null, null);*/
 		}
 		
+		
 		int oldIndex = -1;
 		void viewTabControlIndexChanged(object sender, EventArgs e)
 		{
@@ -296,6 +287,12 @@
 			oldIndex = viewTabControl.CurrentPage;
 		}
 		
+		object ICommandRouter.GetNextCommandTarget ()
+		{
+			commandHandler.SetNextCommandTarget (Parent); 
+			return commandHandler;
+		}
+		
 		protected virtual void OnTitleChanged(EventArgs e)
 		{
 			if (show_notification) {

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,176 @@
+//
+// CommandCodon.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+
+using System;
+using System.Collections;
+using MonoDevelop.Core.AddIns.Conditions;
+using MonoDevelop.Commands;
+using MonoDevelop.Core.Services;
+using MonoDevelop.Services;
+
+namespace MonoDevelop.Core.AddIns.Codons
+{
+	[CodonNameAttribute (&quot;Command&quot;)]
+	public class CommandCodon : AbstractCodon
+	{
+		[XmlMemberAttribute (&quot;_label&quot;, IsRequired=true)]
+		string label;
+		
+		[XmlMemberAttribute (&quot;description&quot;)]
+		string description;
+		
+		[XmlMemberAttribute (&quot;shortcut&quot;)]
+		string shortcut;
+		
+		[XmlMemberAttribute(&quot;icon&quot;)]
+		string icon;
+		
+		[XmlMemberAttribute(&quot;disabledVisible&quot;)]
+		bool disabledVisible = true;
+		
+		[XmlMemberAttribute(&quot;type&quot;)]
+		string type = &quot;normal&quot;;
+		
+		[XmlMemberAttribute(&quot;widget&quot;)]
+		string widget = null;
+		
+		[XmlMemberAttribute(&quot;defaultHandler&quot;)]
+		string defaultHandler;
+		
+		public override object BuildItem (object owner, ArrayList subItems, ConditionCollection conditions)
+		{
+			ActionType ct = ActionType.Normal;
+			bool isArray = false;
+			bool custom = false;
+			bool isAction = false;
+
+			foreach (string p in type.Split ('|')) {
+				switch (p) {
+					case &quot;check&quot;:
+						ct = ActionType.Check;
+						if (isAction)
+							throw new InvalidOperationException (&quot;Action type specified twice.&quot;);
+						isAction = true;
+						break;
+
+					case &quot;radio&quot;:
+						ct = ActionType.Radio;
+						if (isAction)
+							throw new InvalidOperationException (&quot;Action type specified twice.&quot;);
+						isAction = true;
+						break;
+
+					case &quot;normal&quot;:
+						ct = ActionType.Normal;
+						if (isAction)
+							throw new InvalidOperationException (&quot;Action type specified twice.&quot;);
+						isAction = true;
+						break;
+
+					case &quot;custom&quot;:
+						if (widget == null)
+							throw new InvalidOperationException (&quot;Widget type not specified in custom command.&quot;);
+						custom = true;
+						break;
+						
+					case &quot;array&quot;:
+						isArray = true;
+						break;
+						
+					default:
+						throw new InvalidOperationException (&quot;Unknown command type: &quot; + p);
+				}
+			}
+			
+			if (isAction &amp;&amp; custom)
+				throw new InvalidOperationException (&quot;Invalid command type combination: &quot; + type);
+
+			Command cmd;
+
+			if (custom) {
+				if (isArray)
+					throw new InvalidOperationException (&quot;Array custom commands are not allowed.&quot;);
+					
+				CustomCommand ccmd = new CustomCommand ();
+				ccmd.WidgetType = AddIn.GetType (widget);
+				if (ccmd.WidgetType == null)
+					throw new InvalidOperationException (&quot;Could not find command type '&quot; + widget + &quot;'.&quot;);
+				cmd = ccmd;
+			} else {
+				if (widget != null)
+					throw new InvalidOperationException (&quot;Widget type can only be specified for custom commands.&quot;);
+					
+				ActionCommand acmd = new ActionCommand ();
+				acmd.ActionType = ct;
+				acmd.CommandArray = isArray;
+				
+				if (defaultHandler != null) {
+					acmd.DefaultHandlerType = AddIn.GetType (defaultHandler);
+					if (acmd.DefaultHandlerType == null)
+						throw new InvalidOperationException (&quot;Could not find handler type '&quot; + defaultHandler + &quot;' for command &quot; + ID);
+				}
+				
+				cmd = acmd;
+			}
+			
+			cmd.Id = ParseCommandId (this);
+			cmd.Text = Runtime.StringParserService.Parse (GettextCatalog.GetString (label));
+			cmd.Description = GettextCatalog.GetString (description);
+			if (icon != null)
+				cmd.Icon = ResourceService.GetStockId (icon);
+			cmd.AccelKey = shortcut;
+			cmd.DisabledVisible = disabledVisible;
+			
+			return cmd;
+		}
+		
+		internal static object ParseCommandId (ICodon codon)
+		{
+			string id = codon.ID;
+			Type enumType = null;
+			int i = id.LastIndexOf (&quot;.&quot;);
+			if (i != -1)
+				enumType = codon.AddIn.GetType (id.Substring (0,i));
+				
+			if (enumType == null)
+				enumType = Type.GetType (id.Substring (0,i));
+
+			if (enumType == null || !enumType.IsEnum)
+				throw new InvalidOperationException (&quot;Could not find an enum type for the command '&quot; + id + &quot;'.&quot;);
+				
+			try {
+				return Enum.Parse (enumType, id.Substring (i+1));
+			} catch {
+				throw new InvalidOperationException (&quot;Could not find an enum value for the command '&quot; + id + &quot;'.&quot;);
+			}
+		}
+	}
+}

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandItemCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandItemCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/CommandItemCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,48 @@
+//
+// CommandItemCodon.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+
+using System;
+using System.Collections;
+using MonoDevelop.Core.AddIns.Conditions;
+using MonoDevelop.Commands;
+
+namespace MonoDevelop.Core.AddIns.Codons
+{
+	[CodonNameAttribute (&quot;CommandItem&quot;)]
+	public class CommandItemCodon : AbstractCodon
+	{
+		public override object BuildItem (object owner, ArrayList subItems, ConditionCollection conditions)
+		{
+			object id = CommandCodon.ParseCommandId (this);
+			return new CommandEntry (id);
+		}
+	}
+}

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/ItemSetCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/ItemSetCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/ItemSetCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,67 @@
+//
+// ItemSetCodon.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+
+using System;
+using System.Collections;
+using MonoDevelop.Core.AddIns.Conditions;
+using MonoDevelop.Commands;
+using MonoDevelop.Core.Services;
+using MonoDevelop.Services;
+
+namespace MonoDevelop.Core.AddIns.Codons
+{
+	[CodonNameAttribute (&quot;ItemSet&quot;)]
+	public class ItemSetCodon : AbstractCodon
+	{
+		[XmlMemberAttribute (&quot;_label&quot;)]
+		string label;
+		
+		[XmlMemberAttribute(&quot;icon&quot;)]
+		string icon;
+		
+		public override object BuildItem (object owner, ArrayList subItems, ConditionCollection conditions)
+		{
+			if (label == null) label = ID;
+
+			label = Runtime.StringParserService.Parse (GettextCatalog.GetString (label));
+			if (icon != null) icon = ResourceService.GetStockId (icon);
+			CommandEntrySet cset = new CommandEntrySet (label, icon);
+			foreach (object e in subItems) {
+				CommandEntry ce = e as CommandEntry;
+				if (ce != null)
+					cset.Add (ce);
+				else
+					throw new InvalidOperationException (&quot;Invalid ItemSet child: &quot; + e);
+			}
+			return cset;
+		}
+	}
+}

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/LinkItemCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/LinkItemCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/LinkItemCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,58 @@
+//
+// LinkItemCodon.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+
+using System;
+using System.Collections;
+using MonoDevelop.Core.AddIns.Conditions;
+using MonoDevelop.Commands;
+using MonoDevelop.Services;
+using MonoDevelop.Core.Services;
+
+namespace MonoDevelop.Core.AddIns.Codons
+{
+	[CodonNameAttribute (&quot;LinkItem&quot;)]
+	public class LinkItemCodon : AbstractCodon
+	{
+		[XmlMemberAttribute (&quot;_label&quot;)]
+		string label;
+		
+		[XmlMemberAttribute(&quot;link&quot;)]
+		string link;
+		
+		[XmlMemberAttribute(&quot;description&quot;)]
+		string description;
+		
+		public override object BuildItem (object owner, ArrayList subItems, ConditionCollection conditions)
+		{
+			return new LinkCommandEntry (label, link, ResourceService.GetStockId (&quot;Icons.16x16.WebSearchIcon&quot;));
+		}
+	}
+}

Added: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/SeparatorItemCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/SeparatorItemCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Commands/SeparatorItemCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -0,0 +1,47 @@
+//
+// SeparatorItemCodon.cs
+//
+// Author:
+//   Lluis Sanchez Gual
+//
+
+//
+// Copyright (C) 2005 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+// 
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+// 
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+
+using System;
+using System.Collections;
+using MonoDevelop.Core.AddIns.Conditions;
+using MonoDevelop.Commands;
+
+namespace MonoDevelop.Core.AddIns.Codons
+{
+	[CodonNameAttribute (&quot;SeparatorItem&quot;)]
+	public class SeparatorItemCodon : AbstractCodon
+	{
+		public override object BuildItem (object owner, ArrayList subItems, ConditionCollection conditions)
+		{
+			return new CommandEntry (Command.Separator);
+		}
+	}
+}

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Pads/SolutionPadCodon.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Pads/SolutionPadCodon.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Codons/Pads/SolutionPadCodon.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -90,7 +90,16 @@
 		
 		protected override IPadContent CreatePad ()
 		{
-			SolutionPad pad = new SolutionPad (label, icon, builders, options);
+			TreeViewPad pad;
+			if (Class != null) {
+				object ob = AddIn.CreateObject (Class);
+				if (!(ob is TreeViewPad))
+					throw new InvalidOperationException (&quot;'&quot; + Class + &quot;' is not a subclass of TreeViewPad.&quot;);
+				pad = (TreeViewPad) ob;
+			} else
+				pad = new SolutionPad ();
+
+			pad.Initialize (label, icon, builders, options);
 			pad.DefaultPlacement = placement;
 			pad.Id = ID;
 			return pad;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Conditions/WorkbenchContextCondition.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Conditions/WorkbenchContextCondition.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Conditions/WorkbenchContextCondition.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -7,7 +7,7 @@
 namespace MonoDevelop.Core.AddIns
 {
 	[ConditionAttribute()]
-		public class WorkbenchContext : AbstractCondition
+		public class WorkbenchContextCondition : AbstractCondition
 	{
 		[XmlMemberAttribute(&quot;context&quot;, IsRequired = true)]
 			string context;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Combine/Combine.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Combine/Combine.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Combine/Combine.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -328,6 +328,40 @@
 			public CombineEntry Entry;
 		}
 		
+		public string[] GetAllConfigurations ()
+		{
+			ArrayList names = new ArrayList ();
+			GetAllConfigurations (this, names);
+			return (string[]) names.ToArray (typeof(string));
+		}
+		
+		void GetAllConfigurations (CombineEntry entry, ArrayList names)
+		{
+			foreach (IConfiguration conf in Configurations)
+				if (!names.Contains (conf.Name))
+					names.Add (conf.Name);
+
+			if (entry is Combine) {
+				foreach (CombineEntry ce in ((Combine)entry).Entries)
+					GetAllConfigurations (ce, names);
+			}
+		}
+			
+		public void SetAllConfigurations (string configName)
+		{
+			IConfiguration conf = GetConfiguration (configName);
+			if (conf != null) ActiveConfiguration = conf;
+				
+			foreach (CombineEntry ce in Entries) {
+				if (ce is Combine)
+					((Combine)ce).SetAllConfigurations (configName);
+				else {
+					conf = ce.GetConfiguration (configName);
+					if (conf != null) ce.ActiveConfiguration = conf;
+				}
+			}
+		}
+		
 		/// &lt;remarks&gt;
 		/// Returns an ArrayList containing all ProjectEntries in this combine and 
 		/// undercombines
@@ -424,6 +458,9 @@
 				int failedBuilds = 0;
 				
 				foreach (Project entry in allProjects) {
+					if (monitor.IsCancelRequested)
+						break;
+
 					ICompilerResult res = entry.Build (monitor);
 					builds++;
 					cres.Errors.AddRange (res.CompilerResults.Errors);

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Project/DotNetProject.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Project/DotNetProject.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Internal/Project/Project/DotNetProject.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -9,6 +9,7 @@
 using System.IO;
 using System.Diagnostics;
 using System.Xml;
+using System.Threading;
 using MonoDevelop.Internal.Serialization;
 using MonoDevelop.Internal.Templates;
 using MonoDevelop.Services;
@@ -21,6 +22,8 @@
 		[ItemProperty]
 		string language;
 		
+		object debugStopEvent = new object ();
+		
 		ILanguageBinding languageBinding;
 		
 		public override string ProjectType {
@@ -124,12 +127,27 @@
 		
 		public override void Debug (IProgressMonitor monitor)
 		{
-			if (Runtime.TaskService.Errors != 0) return;
-
 			DotNetProjectConfiguration configuration = (DotNetProjectConfiguration) ActiveConfiguration;
-			if (Runtime.DebuggingService != null)
-				Runtime.DebuggingService.Run (new string[] { configuration.CompiledOutputName } );
+			if (Runtime.DebuggingService != null) {
+				Runtime.DebuggingService.StoppedEvent += new EventHandler (OnStopDebug);
+				lock (debugStopEvent) {
+					try {
+						Runtime.DebuggingService.Run (monitor, new string[] { configuration.CompiledOutputName } );
+						Monitor.Wait (debugStopEvent);
+					} catch (Exception ex) {
+						monitor.ReportError (null, ex);
+					}
+				}
+				Runtime.DebuggingService.StoppedEvent -= new EventHandler (OnStopDebug);
+			}
 		}
+		
+		void OnStopDebug (object sender, EventArgs e)
+		{
+			lock (debugStopEvent) {
+				Monitor.PulseAll (debugStopEvent);
+			}
+		}
 
 		protected override void DoExecute (IProgressMonitor monitor)
 		{
@@ -168,13 +186,18 @@
 							string.Format (&quot;-c \&quot;{0} {1}\&quot;&quot;, runtimeStarter, args),
 							Path.GetDirectoryName (configuration.CompiledOutputName), 
 							false, false, null);
-						
+				
+				monitor.CancelRequested += new MonitorHandler (new ProcessStopper (p).OnStopExecution);
 				p.WaitForOutput ();
 				monitor.Log.WriteLine (&quot;The application exited with code: {0}&quot;, p.ExitCode);
 			} catch (Exception ex) {
 				monitor.ReportError (&quot;Can not execute &quot; + &quot;\&quot;&quot; + configuration.CompiledOutputName + &quot;\&quot;&quot;, ex);
 			}
 		}
+		
+		void OnStopExecution (IProgressMonitor monitor)
+		{
+		}
 
 		public override void GenerateMakefiles (Combine parentCombine)
 		{
@@ -186,5 +209,20 @@
 		{
 			return languageBinding.CanCompile(fileName);
 		}
+		
+		class ProcessStopper
+		{
+			Process p;
+			
+			public ProcessStopper (Process p)
+			{
+				this.p = p;
+			}
+			
+			public void OnStopExecution (IProgressMonitor monitor)
+			{
+				p.Kill ();
+			}
+		}
 	}
 }

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Makefile.am
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Makefile.am	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Makefile.am	2005-04-25 20:35:11 UTC (rev 2474)
@@ -47,6 +47,7 @@
 Gui/Pads/ProjectPad/ProjectNodeBuilder.cs \
 Gui/Pads/ProjectPad/ProjectReferenceFolderNodeBuilder.cs \
 Gui/Pads/ProjectPad/ProjectReferenceNodeBuilder.cs \
+Gui/Pads/ProjectPad/ProjectSolutionPad.cs \
 Gui/Pads/ProjectPad/ResourceFolder.cs \
 Gui/Pads/ProjectPad/ResourceFolderNodeBuilder.cs \
 Gui/Pads/ProjectPad/ShowAllFilesBuilderExtension.cs \
@@ -72,6 +73,7 @@
 Gui/IViewContent.cs \
 Gui/AbstractViewContent.cs \
 Gui/GuiService.cs \
+Gui/CommandService.cs \
 Gui/Components/SdMenuSeparator.cs \
 Gui/Components/StatusBar/SdStatusBar.cs \
 Gui/Components/StatusBar/IStatusIcon.cs \
@@ -150,6 +152,7 @@
 Gui/PixbufList.cs \
 Gui/AbstractSecondaryViewContent.cs \
 Gui/ViewContentCollection.cs \
+Gui/ViewCommandHandlers.cs \
 Gui/IWorkbenchWindow.cs \
 Gui/HtmlControl/IHTMLDocument2.cs \
 Gui/HtmlControl/IHTMLElement.cs \
@@ -159,17 +162,9 @@
 Gui/Workbench/Layouts/SdiWorkspaceLayout.cs \
 Gui/Workbench/WorkbenchMemento.cs \
 Gui/Workbench/DefaultWorkbench.cs \
-Commands/ClassBrowserCommands/ClassBrowserCommands.cs \
 Commands/FileCommands.cs \
 Commands/HelpCommands.cs \
 Commands/CustomStringTagProvider.cs \
-Commands/RunCommands.cs \
-Commands/ProjectBrowserCommands/FolderNodeCommands.cs \
-Commands/ProjectBrowserCommands/ReferenceFolderNodeCommands.cs \
-Commands/ProjectBrowserCommands/GeneralNodeCommands.cs \
-Commands/ProjectBrowserCommands/CombineNodeCommands.cs \
-Commands/ProjectBrowserCommands/ResourceFolderNodeCommands.cs \
-Commands/ProjectBrowserCommands/ProjectNodeCommands.cs \
 Commands/ProjectCommands.cs \
 Commands/VBConverter/ConvertProject.cs \
 Commands/VBConverter/ConvertBuffer.cs \
@@ -178,7 +173,7 @@
 Commands/WindowCommands.cs \
 Commands/AutostartCommands.cs \
 Commands/ToolsCommands.cs \
-Commands/MenuItemBuilders.cs \
+Commands/ViewCommands.cs \
 Services/File/IFileService.cs \
 Services/File/DefaultFileService.cs \
 Services/File/FileEventArgs.cs \
@@ -258,6 +253,11 @@
 Internal/Conditions/CombineOpenCondition.cs \
 Internal/Conditions/ProjectOpenCondition.cs \
 Internal/Conditions/WorkbenchContextCondition.cs \
+Internal/Codons/Commands/CommandCodon.cs \
+Internal/Codons/Commands/CommandItemCodon.cs \
+Internal/Codons/Commands/ItemSetCodon.cs \
+Internal/Codons/Commands/LinkItemCodon.cs \
+Internal/Codons/Commands/SeparatorItemCodon.cs \
 Internal/Codons/DisplayBinding/IDisplayBinding.cs \
 Internal/Codons/DisplayBinding/ISubDisplayBinding.cs \
 Internal/Codons/DisplayBinding/DisplayBindingCodon.cs \

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/MonoDevelopCore.addin.xml
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/MonoDevelopCore.addin.xml	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/MonoDevelopCore.addin.xml	2005-04-25 20:35:11 UTC (rev 2474)
@@ -62,6 +62,8 @@
 		       class = &quot;MonoDevelop.Services.MenuService&quot;/&gt;
 		&lt;Class id    = &quot;ProcessService&quot;
 		       class = &quot;MonoDevelop.Services.ProcessService&quot;/&gt;
+		&lt;Class id    = &quot;CommandService&quot;
+		       class = &quot;MonoDevelop.Services.CommandService&quot;/&gt;
 	&lt;/Extension&gt;
 	
 	&lt;Extension path = &quot;/SharpDevelop/Workbench/ProjectBindings&quot;&gt;
@@ -92,306 +94,406 @@
                           _label = &quot;ExportSignature&quot; 
                           class = &quot;MonoDevelop.Commands.ClassScoutCommands.ExportClassSignature&quot;/&gt;
 	&lt;/Extension&gt;
+
+
+	&lt;Extension path = &quot;/SharpDevelop/Commands&quot;&gt;
 	
-	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/CombineBrowserNode&quot;&gt;
-                &lt;MenuItem id = &quot;Compile&quot;
-                          _label = &quot;Compile&quot; 
-                          class = &quot;MonoDevelop.Commands.Compile&quot;/&gt;
-                &lt;MenuItem id = &quot;CompileAll&quot;
-                          _label = &quot;Rebuild _Solution&quot; 
-                          class = &quot;MonoDevelop.Commands.CompileAll&quot;/&gt;
-                &lt;MenuItem id = &quot;CombineBuildGroupSeparator&quot; _label = &quot;-&quot; /&gt;
-                
-                &lt;MenuItem id = &quot;CombineAddMenu&quot; _label = &quot;Add&quot; &gt;
-	                &lt;MenuItem id = &quot;AddNewProject&quot;
-		                  _label = &quot;Add New Project...&quot;
-		                  icon  = &quot;Icons.16x16.NewProjectIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddNewProjectToCombine&quot;/&gt;
-	                &lt;MenuItem id = &quot;AddNewCombine&quot;
-		                  _label = &quot;Add New Solution...&quot; 
-		                  icon  = &quot;Icons.16x16.NewProjectIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddNewCombineToCombine&quot;/&gt;
-		        &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;          
-	                &lt;MenuItem id = &quot;AddProject&quot;
-		                  _label = &quot;Add existing _Project&quot; 
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddProjectToCombine&quot;/&gt;
-	                &lt;MenuItem id = &quot;AddCombine&quot;
-		                  _label = &quot;Add existing Solution&quot; 
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddCombineToCombine&quot;/&gt;
-                &lt;/MenuItem&gt;
-		&lt;MenuItem id = &quot;RemoveCombine&quot;
-	                  _label = &quot;_Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
+		&lt;!-- EditCommands --&gt;
+				
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot;
+				_label = &quot;_Copy&quot;
+				icon = &quot;Icons.16x16.CopyIcon&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.Copy.Description}&quot; 
+				shortcut = &quot;Control|C&quot;/&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot;
+				_label = &quot;Cu_t&quot;
+				icon = &quot;Icons.16x16.CutIcon&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.Cut.Description}&quot; 
+				shortcut = &quot;Control|X&quot;/&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot;
+				_label = &quot;_Paste&quot; 
+				icon = &quot;Icons.16x16.PasteIcon&quot;
+				shortcut = &quot;Control|V&quot;/&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot;
+				_label = &quot;_Delete&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.Delete.Description}&quot;
+				icon  = &quot;Icons.16x16.DeleteIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot;
+				_label    = &quot;Re_name&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Undo&quot;
+				_label = &quot;_Undo&quot; 
+				icon = &quot;Icons.16x16.UndoIcon&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.Undo.Description}&quot; 
+				shortcut = &quot;Control|Z&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.Redo&quot; 
+				_label = &quot;_Redo&quot; 
+				icon = &quot;Icons.16x16.RedoIcon&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.Redo.Description}&quot; 
+				shortcut = &quot;Control|Y&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.SelectAll&quot; 
+				_label = &quot;Select _All&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.SelectAll.Description}&quot; 
+				shortcut = &quot;Control|A&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.CommentCode&quot;
+				shortcut = &quot;Control|Alt|C&quot;
+				_label = &quot;C_omment Line(s)&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.UncommentCode&quot;
+				shortcut = &quot;Control|Alt|U&quot;
+				_label = &quot;_Uncomment Line(s)&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.IndentSelection&quot;
+				shortcut = &quot;Control|Alt|Home&quot;
+				_label = &quot;_Indent Selection&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.UnIndentSelection&quot;
+				shortcut = &quot;Control|Alt|End&quot;
+				_label = &quot;_Unindent Selection&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.WordCount&quot;
+				_label = &quot;_Word Count...&quot; 
+				description = &quot;${res:XML.MainMenu.EditMenu.WordCount.Description}&quot;/&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.EditCommands.MonodevelopPreferences&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.MonodevelopPreferencesHandler&quot;
+				_label = &quot;_Preferences&quot;
+				icon = &quot;Icons.16x16.Options&quot;
+				description = &quot;${res:XML.MainMenu.ToolMenu.Options.Description}&quot; /&gt;
+				
+		&lt;!-- ProjectCommands --&gt;
+				
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Compile&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.CompileHandler&quot;
+				description = &quot;Compile&quot;
+				_label = &quot;_Compile&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewProject&quot;
+				_label = &quot;Add New Project...&quot;
+				description = &quot;Add a new project to the selected solution&quot;
+				icon  = &quot;Icons.16x16.NewProjectIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewCombine&quot;
+				_label = &quot;Add New Solution...&quot; 
+				description = &quot;Add a new solution to the selected solution&quot;
+				icon  = &quot;Icons.16x16.NewProjectIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddProject&quot;
+				description = &quot;Add a project to the selected solution&quot;
+				_label = &quot;Add existing _Project&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddCombine&quot;
+				description = &quot;Add a solution to the selected solution&quot;
+				_label = &quot;Add existing Solution&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.RemoveFromProject&quot;
+				_label = &quot;_Remove From Project&quot; 
+				icon  = &quot;Icons.16x16.DeleteIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Options&quot;
+				_label = &quot;Options&quot; 
+				description = &quot;Show options window&quot;
+				icon  = &quot;Icons.16x16.PropertiesIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddResource&quot;
+				_label = &quot;Add Resource&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddReference&quot;
+				_label = &quot;Edit References&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewFiles&quot;
+				_label = &quot;New _File&quot; 
+				icon  = &quot;Icons.16x16.NewDocumentIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.AddFiles&quot;
+				_label = &quot;Add Files&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.NewFolder&quot;
+				_label = &quot;New Folder&quot; 
+				icon  = &quot;Icons.16x16.NewFolderIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeToProject&quot;
+				_label = &quot;Include To Project&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Build&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.BuildHandler&quot;
+				_label = &quot;Buil_d&quot; 
+				shortcut = &quot;F8&quot;
+				icon  = &quot;Icons.16x16.BuildCurrentSelectedProject&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Rebuild&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.RebuildHandler&quot;
+				_label = &quot;Rebuild&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.SetAsStartupProject&quot;
+				_label = &quot;Set As Startup Project&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Run&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.RunHandler&quot;
+				icon = &quot;Icons.16x16.RunProgramIcon&quot;
+				shortcut = &quot;F5&quot;
+				_label = &quot;Run&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Debug&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.DebugHandler&quot;
+				icon = &quot;Icons.16x16.RunProgramIcon&quot;
+				shortcut = &quot;Control|F5&quot;
+				_label = &quot;Debug&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeInBuild&quot;
+				type=&quot;check&quot;
+				_label = &quot;Build&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeInDeploy&quot;
+				type=&quot;check&quot;
+				_label = &quot;Deploy&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.Stop&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.StopHandler&quot;
+				icon = &quot;gtk-stop&quot;
+				shortcut = &quot;Shift|F5&quot;
+				description = &quot;Stop current build or application execution&quot;
+				_label = &quot;Stop&quot; /&gt;
+&lt;!--		&lt;Command id = &quot;MonoDevelop.Commands.ProjectCommands.ConfigurationSelector&quot;
+				type = &quot;custom&quot;
+				widget = &quot;MonoDevelop.Gui.ConfigurationComboBox&quot;
+				_label = &quot;Configuration Box&quot; /&gt;
+--&gt;
 
-                &lt;MenuItem id = &quot;RenameCombine&quot;
-	                  _label    = &quot;Re_name&quot; 
-	                  shortcut = &quot;F2&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-	                  
-	        &lt;MenuItem id = &quot;CombineOptionsSeparator&quot; _label = &quot;-&quot; /&gt;          
-	        
-                &lt;MenuItem id = &quot;CombineOptions&quot;
-	                  _label = &quot;Solution Options&quot; 
-	                  icon  = &quot;Icons.16x16.PropertiesIcon&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.CombineOptions&quot;/&gt;
+		&lt;!-- FileCommands --&gt;
+		
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.OpenFile&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.OpenFileHandler&quot;
+				_label = &quot;O_pen&quot; 
+				shortcut = &quot;Control|O&quot;
+				icon  = &quot;Icons.16x16.OpenFileIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.NewFile&quot; 
+				defaultHandler = &quot;MonoDevelop.Commands.NewFileHandler&quot;
+				_label = &quot;New File&quot;
+				shortcut = &quot;Control|N&quot;
+				description = &quot;${res:XML.MainMenu.FileMenu.New.File.Description}&quot; 
+				icon = &quot;Icons.16x16.NewDocumentIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.Save&quot; 
+				icon = &quot;Icons.16x16.SaveIcon&quot; 
+				shortcut = &quot;Control|S&quot;
+				_label = &quot;Save&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.SaveAll&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.SaveAllHandler&quot;
+				icon = &quot;Icons.16x16.SaveAllIcon&quot; 
+				_label = &quot;Save All&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.NewProject&quot; 
+				defaultHandler = &quot;MonoDevelop.Commands.NewProjectHandler&quot;
+				_label = &quot;N_ew Solution/Project...&quot; 
+				icon = &quot;Icons.16x16.NewProjectIcon&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.New.Project.Description}&quot; 
+				shortcut = &quot;Control|Shift|N&quot;  /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.CloseFile&quot;
+				_label = &quot;_Close File&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.Close.File.Desription}&quot;
+				icon = &quot;Icons.16x16.CloseIcon&quot;
+				shortcut = &quot;Control|W&quot;/&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.CloseAllFiles&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.CloseAllFilesHandler&quot;
+				_label = &quot;Close All&quot;
+				description = &quot;Close All Files&quot;
+				icon = &quot;Icons.16x16.CloseIcon&quot;
+				shortcut = &quot;Control|Shift|W&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.CloseCombine&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.CloseCombineHandler&quot;
+				_label = &quot;Close Sol_ution&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.Close.Project.Desription}&quot;
+				icon = &quot;Icons.16x16.CloseCombineIcon&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.ReloadFile&quot;
+				_label = &quot;_Reload File&quot; 
+				shortcut = &quot;Control|U&quot;
+				description = &quot;${res:XML.MainMenu.FileMenu.Reload.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.SaveAs&quot;
+				_label = &quot;Save _As...&quot;
+				icon = &quot;Icons.16x16.SaveAsIcon&quot;
+				shortcut = &quot;Control|Shift|S&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.SaveAs.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.RecentFileList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.RecentFileListHandler&quot;
+				type=&quot;array&quot;
+				_label = &quot;Recent Files&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.ClearRecentFiles&quot; 
+				defaultHandler = &quot;MonoDevelop.Commands.ClearRecentFilesHandler&quot;
+				_label = &quot;_Clear Recent Files&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.ClearRecentFiles.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.RecentProjectList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.RecentProjectListHandler&quot;
+				type=&quot;array&quot;
+				_label = &quot;Recent Projects&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.ClearRecentProjects&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.ClearRecentProjectsHandler&quot;
+				_label = &quot;_Clear Recent Solutions&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.ClearRecentProjects.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.FileCommands.Exit&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.ExitHandler&quot;
+				_label = &quot;_Quit&quot; 
+				icon = &quot;Icons.16x16.QuitIcon&quot; 
+				description = &quot;${res:XML.MainMenu.FileMenu.Exit.Description}&quot;
+				shortcut = &quot;Control|Q&quot; /&gt;
+				
+		&lt;!-- ViewCommands --&gt;
+		
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.ViewList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.ViewListHandler&quot;
+				type=&quot;check|array&quot;
+				_label = &quot;View List&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.LayoutList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.LayoutListHandler&quot;
+				type=&quot;radio|array&quot;
+				_label = &quot;Layout List&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.NewLayout&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.NewLayoutHandler&quot;
+				_label = &quot;_New Layout&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.FullScreen&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.FullScreenHandler&quot;
+				_label = &quot;_Full Screen&quot; 
+				icon = &quot;Icons.16x16.FullScreen&quot; 
+				shortcut = &quot;F11&quot;
+				description = &quot;${res:XML.MainMenu.ViewMenu.FullScreen.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.Open&quot;
+				_label = &quot;Open&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.TreeDisplayOptionList&quot;
+				type = &quot;array|check&quot;
+				_label = &quot;Display Options List&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.ViewCommands.ResetTreeDisplayOptions&quot;
+				_label = &quot;Reset Options&quot; /&gt;
+
+		&lt;!-- ToolCommands --&gt;
+		
+		&lt;Command id = &quot;MonoDevelop.Commands.ToolCommands.ToolList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.ToolListHandler&quot;
+				type=&quot;array&quot;
+				_label = &quot;Tool List&quot; /&gt;
+				
+		&lt;!-- WindowCommands --&gt;
+		
+		&lt;Command id  = &quot;MonoDevelop.Commands.WindowCommands.NextWindow&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.NextWindowHandler&quot;
+				_label = &quot;_Next Window&quot;
+				icon = &quot;Icons.16x16.NextWindowIcon&quot;
+				description = &quot;${res:XML.MainMenu.WindowMenu.NxtWindow.Description}&quot; 
+				shortcut = &quot;Control|Page_Down&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.WindowCommands.PrevWindow&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.PrevWindowHandler&quot;
+				_label = &quot;_Previous Window&quot;
+				icon = &quot;Icons.16x16.PrevWindowIcon&quot;
+				description = &quot;${res:XML.MainMenu.WindowMenu.PrvWindow.Description}&quot;
+				shortcut = &quot;Control|Page_Up&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.WindowCommands.OpenWindowList&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.OpenWindowListHandler&quot;
+				type=&quot;radio|array&quot;
+				_label = &quot;Window List&quot; /&gt;
+				
+		&lt;!-- HelpCommands --&gt;
+		
+		&lt;Command id = &quot;MonoDevelop.Commands.HelpCommands.TipOfTheDay&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.TipOfTheDayHandler&quot;
+				_label = &quot;_Tip of the Day...&quot; 
+				icon = &quot;Icons.16x16.TipOfTheDay&quot; 
+				description = &quot;${res:XML.MainMenu.HelpMenu.Tips.Description}&quot; /&gt;
+		&lt;Command id = &quot;MonoDevelop.Commands.HelpCommands.About&quot;
+				defaultHandler = &quot;MonoDevelop.Commands.AboutHandler&quot;
+				_label = &quot;_About&quot; 
+				icon = &quot;Icons.16x16.AboutIcon&quot; 
+				description = &quot;${res:XML.MainMenu.HelpMenu.About.Description}&quot; /&gt;
 	&lt;/Extension&gt;
+
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/CombineBrowserNode&quot;&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Build&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Rebuild&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CombineBuildGroupSeparator&quot; /&gt;
+		&lt;ItemSet id = &quot;CombineAddMenu&quot; _label = &quot;Add&quot; &gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewProject&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewCombine&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddProject&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddCombine&quot; /&gt;
+		&lt;/ItemSet&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CombineOptionsSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Options&quot; /&gt;
+	&lt;/Extension&gt;
 	
 	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ResourceFolderNode&quot;&gt;
-                &lt;MenuItem id = &quot;AddResource&quot;
-	                  _label = &quot;Add Resource&quot; 
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddResourceToProject&quot;/&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddResource&quot; /&gt;
 	&lt;/Extension&gt;
-	
+
 	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ReferenceFolderNode&quot;&gt;
-                &lt;MenuItem id = &quot;AddReference&quot;
-	                  _label = &quot;Edit References&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddReferenceToProject&quot;/&gt;
-				&lt;MenuItem id = &quot;Paste&quot;
-							  _label = &quot;_Paste&quot; 
-							  icon = &quot;Icons.16x16.PasteIcon&quot; 
-							  shortcut = &quot;Control|V&quot;
-							  class = &quot;MonoDevelop.Commands.ProjectBrowser.PasteNodeCommand&quot;/&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddReference&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot; /&gt;
 	&lt;/Extension&gt;
 	
 	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ReferenceNode&quot;&gt;
-		&lt;MenuItem id = &quot;OpenFile&quot;
-		          _label = &quot;O_pen&quot; 
-		          icon  = &quot;Icons.16x16.OpenFileIcon&quot;
-		          class = &quot;MonoDevelop.Commands.ProjectBrowser.OpenFileEvent&quot;/&gt;
-		&lt;MenuItem id = &quot;OpenSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Copy&quot;
-	                  _label = &quot;_Copy&quot; 
-					  icon = &quot;Icons.16x16.CopyIcon&quot; 
-					  shortcut = &quot;Control|C&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-		&lt;MenuItem id = &quot;Remove&quot;
-	                  _label = &quot;_Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.Open&quot; /&gt;
+		&lt;SeparatorItem id = &quot;OpenSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
 	&lt;/Extension&gt;
         
-        &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/DefaultFileNode&quot;&gt;
-		&lt;MenuItem id = &quot;OpenFile&quot;
-		          _label = &quot;O_pen&quot; 
-		          icon  = &quot;Icons.16x16.OpenFileIcon&quot;
-		          class = &quot;MonoDevelop.Commands.ProjectBrowser.OpenFileEvent&quot;/&gt;
-		&lt;MenuItem id = &quot;OpenSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Copy&quot;
-	                  _label = &quot;_Copy&quot; 
-					  icon = &quot;Icons.16x16.CopyIcon&quot; 
-					  shortcut = &quot;Control|C&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-		&lt;MenuItem id = &quot;Cut&quot;
-				  _label = &quot;_Cut&quot; 
-				  icon = &quot;Icons.16x16.CutIcon&quot; 
-				  shortcut = &quot;Control|X&quot;
-				  class = &quot;MonoDevelop.Commands.ProjectBrowser.CutNodeCommand&quot;/&gt;
-		&lt;MenuItem id = &quot;CutSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Remove&quot;
-	                  _label = &quot;_Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
-                &lt;MenuItem id = &quot;Rename&quot;
-	                  _label    = &quot;Re_name&quot; 
-	                  shortcut = &quot;F2&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-        &lt;/Extension&gt;
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/DefaultFileNode&quot;&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.Open&quot; /&gt;
+		&lt;SeparatorItem id = &quot;OpenSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
+	&lt;/Extension&gt;
 
-        &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ProjectFileNode&quot;&gt;
-		&lt;MenuItem id = &quot;OpenFile&quot;
-		          _label = &quot;O_pen&quot; 
-		          icon  = &quot;Icons.16x16.OpenFileIcon&quot;
-		          class = &quot;MonoDevelop.Commands.ProjectBrowser.OpenFileEvent&quot;/&gt;
-		&lt;MenuItem id = &quot;OpenSeparator&quot; _label = &quot;-&quot; /&gt;
-                &lt;MenuItem id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
-        		&lt;MenuItem id = &quot;NewFiles&quot;
-		                  _label = &quot;New _File&quot; 
-		                  icon  = &quot;Icons.16x16.NewDocumentIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddNewFileEvent&quot;/&gt;
-        		&lt;MenuItem id = &quot;AddFiles&quot;
-		                  _label = &quot;Add Files&quot; 
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddFilesToProject&quot;/&gt;
-			&lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-        		&lt;MenuItem id = &quot;NewFolder&quot;
-		                  _label = &quot;New Folder&quot; 
-		                  icon  = &quot;Icons.16x16.NewFolderIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.NewFolderEvent&quot;/&gt;
-        	&lt;/MenuItem&gt;
-		&lt;MenuItem id = &quot;Include&quot; _label = &quot;Include&quot;&gt;
-			&lt;MenuItem id = &quot;IncludeFileIn&quot; _label = &quot;bogus_label&quot;
-			          class = &quot;MonoDevelop.Commands.IncludeFilesBuilder&quot; /&gt;
-			&lt;/MenuItem&gt;
-		&lt;MenuItem id = &quot;IncludeSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Copy&quot;
-	                  _label = &quot;_Copy&quot; 
-					  icon = &quot;Icons.16x16.CopyIcon&quot; 
-					  shortcut = &quot;Control|C&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-		&lt;MenuItem id = &quot;Cut&quot;
-				  _label = &quot;_Cut&quot; 
-				  icon = &quot;Icons.16x16.CutIcon&quot; 
-				  shortcut = &quot;Control|X&quot;
-				  class = &quot;MonoDevelop.Commands.ProjectBrowser.CutNodeCommand&quot;/&gt;
-		&lt;MenuItem id = &quot;CutSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Remove&quot;
-	                  _label = &quot;Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
-                &lt;MenuItem id = &quot;Rename&quot;
-	                  _label    = &quot;Rename&quot; 
-	                  shortcut = &quot;F2&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-        &lt;/Extension&gt;
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ProjectFileNode&quot;&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.Open&quot; /&gt;
+		&lt;SeparatorItem id = &quot;OpenSeparator&quot; /&gt;
+		&lt;ItemSet id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewFiles&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddFiles&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.NewFolder&quot; /&gt;
+		&lt;/ItemSet&gt;
+		&lt;ItemSet id = &quot;Include&quot; _label = &quot;Include&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeInBuild&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeInDeploy&quot; /&gt;
+		&lt;/ItemSet&gt;
+		&lt;SeparatorItem id = &quot;IncludeSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
+	&lt;/Extension&gt;
 		
-        &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/SystemFileNode&quot;&gt;
-			&lt;MenuItem id = &quot;OpenFile&quot;
-					_label = &quot;O_pen&quot; 
-					icon  = &quot;Icons.16x16.OpenFileIcon&quot;
-					class = &quot;MonoDevelop.Commands.ProjectBrowser.OpenFileEvent&quot;/&gt;
-			&lt;MenuItem id = &quot;IncludeToProject&quot;
-					_label = &quot;Include To Project&quot; 
-					class = &quot;MonoDevelop.Commands.ProjectBrowser.IncludeFileToProject&quot;/&gt;
-			&lt;MenuItem id = &quot;IncludeToProjectSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;Copy&quot;
-						  _label = &quot;_Copy&quot; 
-						  icon = &quot;Icons.16x16.CopyIcon&quot; 
-						  shortcut = &quot;Control|C&quot;
-						  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;Cut&quot;
-					  _label = &quot;_Cut&quot; 
-					  icon = &quot;Icons.16x16.CutIcon&quot; 
-					  shortcut = &quot;Control|X&quot;
-					  class = &quot;MonoDevelop.Commands.ProjectBrowser.CutNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;CutSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;Remove&quot;
-					_label = &quot;Remove&quot; 
-					icon  = &quot;Icons.16x16.DeleteIcon&quot;
-					class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
-			&lt;MenuItem id = &quot;Rename&quot;
-					_label    = &quot;Rename&quot; 
-					shortcut = &quot;F2&quot;
-					class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-        &lt;/Extension&gt;
-        
-        &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/DefaultDirectoryNode&quot;&gt;
-                &lt;MenuItem id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
-        		&lt;MenuItem id = &quot;NewFiles&quot;
-		                  _label = &quot;Add New File&quot; 
-		                  icon  = &quot;Icons.16x16.NewDocumentIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddNewFileEvent&quot;/&gt;
-        		&lt;MenuItem id = &quot;AddFiles&quot;
-		                  _label = &quot;Add Files&quot; 
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddFilesToProject&quot;/&gt;
-			&lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-        		&lt;MenuItem id = &quot;NewFolder&quot;
-		                  _label = &quot;Add New Folder&quot; 
-		                  icon  = &quot;Icons.16x16.NewFolderIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.NewFolderEvent&quot;/&gt;
-        	&lt;/MenuItem&gt;
-		&lt;MenuItem id = &quot;AddSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;Copy&quot;
-						  _label = &quot;_Copy&quot; 
-						  icon = &quot;Icons.16x16.CopyIcon&quot; 
-						  shortcut = &quot;Control|C&quot;
-						  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;Cut&quot;
-					  _label = &quot;_Cut&quot; 
-					  icon = &quot;Icons.16x16.CutIcon&quot; 
-					  shortcut = &quot;Control|X&quot;
-					  class = &quot;MonoDevelop.Commands.ProjectBrowser.CutNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;Paste&quot;
-					  _label = &quot;_Paste&quot; 
-					  icon = &quot;Icons.16x16.PasteIcon&quot; 
-					  shortcut = &quot;Control|V&quot;
-					  class = &quot;MonoDevelop.Commands.ProjectBrowser.PasteNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;CutSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Remove&quot;
-	                  _label = &quot;_Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
-                &lt;MenuItem id = &quot;Rename&quot;
-	                  _label    = &quot;Re_name&quot; 
-	                  shortcut = &quot;F2&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-        &lt;/Extension&gt;
-        
-        &lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ProjectBrowserNode&quot;&gt;
-                &lt;MenuItem id = &quot;BuildProject&quot;
-                          _label = &quot;Buil_d Project&quot; 
-		          icon  = &quot;Icons.16x16.BuildCurrentSelectedProject&quot;
-                          class = &quot;MonoDevelop.Commands.BuildCurrentProject&quot;/&gt;
-                &lt;MenuItem id = &quot;RebuildProject&quot;
-                          _label = &quot;Rebuild Project&quot; 
-                          class = &quot;MonoDevelop.Commands.RebuildCurrentProject&quot;/&gt;
-                &lt;MenuItem id = &quot;BuildGroupSeparator&quot; _label = &quot;-&quot; /&gt;
-                &lt;MenuItem id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
-        		&lt;MenuItem id = &quot;NewFiles&quot;
-		                  _label = &quot;Add New File&quot; 
-		                  icon  = &quot;Icons.16x16.NewDocumentIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddNewFileEvent&quot;/&gt;
-        		&lt;MenuItem id = &quot;AddFiles&quot;
-		                  _label = &quot;Add Files&quot; 
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.AddFilesToProject&quot;/&gt;
-			&lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-        		&lt;MenuItem id = &quot;NewFolder&quot;
-		                  _label = &quot;Add New Folder&quot; 
-		                  icon  = &quot;Icons.16x16.NewFolderIcon&quot;
-		                  class = &quot;MonoDevelop.Commands.ProjectBrowser.NewFolderEvent&quot;/&gt;
-        	&lt;/MenuItem&gt;
-		&lt;MenuItem id = &quot;AddSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;Copy&quot;
-						  _label = &quot;_Copy&quot; 
-						  icon = &quot;Icons.16x16.CopyIcon&quot; 
-						  shortcut = &quot;Control|C&quot;
-						  class = &quot;MonoDevelop.Commands.ProjectBrowser.CopyNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;Cut&quot;
-					  _label = &quot;_Cut&quot; 
-					  icon = &quot;Icons.16x16.CutIcon&quot; 
-					  shortcut = &quot;Control|X&quot;
-					  class = &quot;MonoDevelop.Commands.ProjectBrowser.CutNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;Paste&quot;
-					  _label = &quot;_Paste&quot; 
-					  icon = &quot;Icons.16x16.PasteIcon&quot; 
-					  shortcut = &quot;Control|V&quot;
-					  class = &quot;MonoDevelop.Commands.ProjectBrowser.PasteNodeCommand&quot;/&gt;
-			&lt;MenuItem id = &quot;CutSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;Remove&quot;
-	                  _label = &quot;_Remove&quot; 
-	                  icon  = &quot;Icons.16x16.DeleteIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.RemoveEntryEvent&quot;/&gt;
-                &lt;MenuItem id = &quot;Rename&quot;
-	                  _label    = &quot;Re_name&quot; 
-	                  shortcut = &quot;F2&quot;
-	                  class    = &quot;MonoDevelop.Commands.ProjectBrowser.RenameEntryEvent&quot;/&gt;
-		&lt;!-- &lt;MenuItem id = &quot;RemoveRenameSeparator&quot; _label = &quot;-&quot; /&gt; --&gt;
-		&lt;!-- &lt;MenuItem id = &quot;RunTests&quot;
-	                  _label = &quot;${res:ProjectComponent.ContextMenu.RunTests}&quot; 
-	                  class = &quot;MonoDevelop.Commands.RunTestsInProject&quot;/&gt;
-		&lt;MenuItem id = &quot;Deploy&quot;
-	                  _label = &quot;${res:ProjectComponent.ContextMenu.Deploy}&quot; /&gt;
-		&lt;MenuItem id = &quot;TestsDeploySeparator&quot; _label = &quot;-&quot; /&gt; --&gt;
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/SystemFileNode&quot;&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.Open&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.IncludeToProject&quot; /&gt;
+		&lt;SeparatorItem id = &quot;IncludeToProjectSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
+	&lt;/Extension&gt;
 
-&lt;!-- 	      	&lt;MenuItem id = &quot;ViewDocumentation&quot;
-	                  _label = &quot;${res:ProjectComponent.ContextMenu.ViewDocumentation}&quot; 
-	                  class = &quot;MonoDevelop.Commands.ViewProjectDocumentation&quot;/&gt; --&gt;
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/DefaultDirectoryNode&quot;&gt;
+		&lt;ItemSet id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewFiles&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddFiles&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.NewFolder&quot; /&gt;
+		&lt;/ItemSet&gt;
+		&lt;SeparatorItem id = &quot;AddSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
+	&lt;/Extension&gt;
+
+	&lt;Extension path = &quot;/SharpDevelop/Views/ProjectBrowser/ContextMenu/ProjectBrowserNode&quot;&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Build&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Rebuild&quot;/&gt;
+		&lt;SeparatorItem id = &quot;BuildGroupSeparator&quot; /&gt;
+		&lt;ItemSet id = &quot;Add&quot; _label = &quot;Add&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddNewFiles&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.AddFiles&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.NewFolder&quot; /&gt;
+		&lt;/ItemSet&gt;
+
+		&lt;SeparatorItem id = &quot;AddSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot; /&gt;
+		&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Rename&quot; /&gt;
 		
-		&lt;!-- &lt;MenuItem id = &quot;GenerateDocumentation&quot;
-	                  _label = &quot;${res:ProjectComponent.ContextMenu.GenerateDocumentation}&quot; 
-	                  class = &quot;MonoDevelop.Commands.GenerateProjectDocumentation&quot;/&gt; --&gt;
+		&lt;SeparatorItem id = &quot;SetAsStartupProjectSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.SetAsStartupProject&quot; /&gt;
 		
-		&lt;MenuItem id = &quot;SetAsStartupProjectSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;SetAsStartupProject&quot;
-	                  _label = &quot;Set As Startup Project&quot; 
-	                  class = &quot;MonoDevelop.Commands.ProjectBrowser.SetAsStartupProject&quot;/&gt;
-		
-		&lt;MenuItem id = &quot;OptionsSeparator&quot; _label = &quot;-&quot; /&gt;
-		&lt;MenuItem id = &quot;ProjectOptions&quot;
-	                  _label = &quot;Project _Options&quot; 
-	                  icon  = &quot;Icons.16x16.PropertiesIcon&quot;
-	                  class = &quot;MonoDevelop.Commands.ViewProjectOptions&quot;/&gt;
-        &lt;/Extension&gt;
+		&lt;SeparatorItem id = &quot;OptionsSeparator&quot; /&gt;
+		&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Options&quot; /&gt;
+	&lt;/Extension&gt;
 	
+
 	&lt;Extension path = &quot;/SharpDevelop/Workbench/ProjectOptions/ConfigNodeMenu&quot;&gt;
                 &lt;MenuItem id = &quot;Add&quot; 
                           _label = &quot;Add&quot;
@@ -502,7 +604,7 @@
 		&lt;Pad id = &quot;MonoDevelop.Gui.Pads.OpenTaskView&quot; class = &quot;MonoDevelop.Gui.Pads.OpenTaskView&quot;/&gt;
 		&lt;Pad id = &quot;MonoDevelop.Gui.Pads.HelpTree&quot; class = &quot;MonoDevelop.Gui.Pads.HelpTree&quot;/&gt;
 
-		&lt;SolutionPad id = &quot;MonoDevelop.Gui.Pads.ProjectPad&quot; defaultPlacement = &quot;Left&quot; _label = &quot;Solution&quot; icon = &quot;md-combine-icon&quot;&gt;
+		&lt;SolutionPad id = &quot;MonoDevelop.Gui.Pads.ProjectPad&quot; defaultPlacement = &quot;Left&quot; _label = &quot;Solution&quot; icon = &quot;md-combine-icon&quot; class = &quot;MonoDevelop.Gui.Pads.ProjectPad.ProjectSolutionPad&quot;&gt;
 			&lt;PadOption id = &quot;ShowAllFiles&quot; _label = &quot;Show All Files&quot; defaultValue = &quot;False&quot; /&gt;
 			&lt;NodeBuilder id = &quot;Combine&quot; class = &quot;MonoDevelop.Gui.Pads.ProjectPad.CombineNodeBuilder&quot;/&gt;
 			&lt;NodeBuilder id = &quot;Project&quot; class = &quot;MonoDevelop.Gui.Pads.ProjectPad.ProjectNodeBuilder&quot;/&gt;
@@ -601,504 +703,141 @@
 		            extensions = &quot;*.*&quot;/&gt;
 	&lt;/Extension&gt;
 	
+	&lt;!-- Main Toolbar --&gt;
+	
 	&lt;Extension path = &quot;/SharpDevelop/Workbench/ToolBar&quot;&gt;
-		&lt;ToolbarItem id = &quot;Standard&quot;&gt;
-			&lt;ToolbarItem id = &quot;New&quot; 
-			             icon = &quot;Icons.16x16.NewDocumentIcon&quot; 
-			             _tooltip = &quot;New File&quot;
-			             class = &quot;MonoDevelop.Commands.CreateNewFile&quot;/&gt;
-			&lt;ToolbarItem id = &quot;Open&quot; 
-			             icon = &quot;Icons.16x16.OpenFileIcon&quot; 
-			             _tooltip = &quot;Open File&quot;
-			             class = &quot;MonoDevelop.Commands.OpenFile&quot;/&gt;
-			&lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-				&lt;ToolbarItem id = &quot;Save&quot; 
-				             icon = &quot;Icons.16x16.SaveIcon&quot; 
-				             _tooltip = &quot;Save&quot;
-				             class = &quot;MonoDevelop.Commands.SaveFile&quot;/&gt;
-				             
-		                &lt;ToolbarItem id = &quot;SaveAll&quot;
-			                     icon = &quot;Icons.16x16.SaveAllIcon&quot; 
-		                             _tooltip = &quot;Save All&quot;
-		                             class = &quot;MonoDevelop.Commands.SaveAllFiles&quot;/&gt;
-			&lt;/Conditional&gt;
-			&lt;ToolbarItem id = &quot;Separator1&quot; _tooltip = &quot;-&quot;/&gt;
-	                &lt;!-- &lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;--&gt;
-				&lt;ToolbarItem id = &quot;Cut&quot; 
-				             icon = &quot;Icons.16x16.CutIcon&quot; 
-				             _tooltip = &quot;Cut&quot;
-				             class = &quot;MonoDevelop.Commands.Cut&quot;/&gt;
-				&lt;ToolbarItem id = &quot;Copy&quot; 
-				             icon = &quot;Icons.16x16.CopyIcon&quot; 
-				             _tooltip = &quot;Copy&quot;
-				             class = &quot;MonoDevelop.Commands.Copy&quot;/&gt;
-				&lt;ToolbarItem id = &quot;Paste&quot; 
-				             icon = &quot;Icons.16x16.PasteIcon&quot; 
-				             _tooltip = &quot;Paste&quot;
-				             class = &quot;MonoDevelop.Commands.Paste&quot;/&gt;
-				&lt;ToolbarItem id = &quot;Delete&quot;
-				             icon = &quot;Icons.16x16.DeleteIcon&quot; 
-				             _tooltip = &quot;Delete&quot;
-				             class = &quot;MonoDevelop.Commands.Delete&quot;/&gt;
-			&lt;!-- &lt;/Conditional&gt;--&gt;
-			&lt;ToolbarItem id = &quot;CutSeparator&quot; insertafter =&quot;Delete&quot; insertbefore =&quot;Find&quot; _tooltip = &quot;-&quot;/&gt;
-	                &lt;!-- &lt;Conditional action=&quot;Disable&quot;&gt;
-	                	&lt;Or&gt;
-	                		&lt;Condition activewindow=&quot;MonoDevelop.DefaultEditor.Gui.Editor.ITextAreaControlProvider&quot;/&gt;
-	                		&lt;Condition iscombineopen=&quot;True&quot;/&gt;
-	                	&lt;/Or&gt;
-			&lt;/Conditional&gt; --&gt;
-			
-			&lt;ToolbarItem id = &quot;CompileSeparator&quot; insertafter = &quot;ClearBookmarks&quot; _tooltip = &quot;-&quot;/&gt;
-	                &lt;Conditional action=&quot;Disable&quot;&gt;
-	                	&lt;Or&gt;
-	                		&lt;Condition activewindow=&quot;MonoDevelop.DefaultEditor.Gui.Editor.ITextAreaControlProvider&quot;/&gt;
-	                		&lt;Condition iscombineopen=&quot;True&quot;/&gt;
-	                	&lt;/Or&gt;
-		                &lt;ToolbarItem id = &quot;Compile&quot;
-				             icon  = &quot;Icons.16x16.BuildCombine&quot;
-				             _tooltip = &quot;Compile&quot;
-				             class = &quot;MonoDevelop.Commands.Compile&quot;/&gt;
-			
-				&lt;ToolbarItem id = &quot;BuildProject&quot;
-				             icon  = &quot;Icons.16x16.BuildCurrentSelectedProject&quot;
-				             _tooltip = &quot;Build Project&quot;
-				             class = &quot;MonoDevelop.Commands.BuildCurrentProject&quot;/&gt;
-				&lt;ToolbarItem id = &quot;Run&quot;
-				             icon = &quot;Icons.16x16.RunProgramIcon&quot;
-				             _tooltip = &quot;Run&quot;
-				             class = &quot;MonoDevelop.Commands.RunCommand&quot;/&gt;
-			&lt;/Conditional&gt;
-		&lt;/ToolbarItem&gt;
+		&lt;ItemSet id = &quot;Standard&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.NewFile&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.OpenFile&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.Save&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.SaveAll&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
+			&lt;SeparatorItem id = &quot;CutSeparator&quot; /&gt;
+			&lt;SeparatorItem id = &quot;CompileSeparator&quot; /&gt;
+&lt;!--			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.ConfigurationSelector&quot; /&gt;--&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Build&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Run&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Stop&quot; /&gt;
+		&lt;/ItemSet&gt;
 	&lt;/Extension&gt;
 
-	&lt;Extension path = &quot;/SharpDevelop/Workbench/MainMenu&quot;&gt;
-	        &lt;MenuItem id = &quot;File&quot; _label = &quot;_File&quot;&gt;
-	                        &lt;MenuItem id          = &quot;File&quot; 
-	                                  _label       = &quot;_New File...&quot; 
-	                                  icon        = &quot;Icons.16x16.NewDocumentIcon&quot; 
-	                                  description = &quot;${res:XML.MainMenu.FileMenu.New.File.Description}&quot; 
-	                                  shortcut    = &quot;Control|N&quot; 
-	                                  class = &quot;MonoDevelop.Commands.CreateNewFile&quot;/&gt;
-	                                  
-	                        &lt;MenuItem id = &quot;Project&quot; 
-	                                  _label = &quot;N_ew Solution/Project...&quot; 
-	                                  icon = &quot;Icons.16x16.NewProjectIcon&quot; 
-	                                  description = &quot;${res:XML.MainMenu.FileMenu.New.Project.Description}&quot; 
-	                                  shortcut = &quot;Control|Shift|N&quot; 
-	                                  class = &quot;MonoDevelop.Commands.CreateNewProject&quot;/&gt;
-	                
-	                &lt;!-- &lt;MenuItem id = &quot;Open&quot; _label = &quot;_Open&quot;&gt;
-	                        &lt;MenuItem id = &quot;File&quot; 
-	                                  _label = &quot;File...&quot; 
-	                                  icon = &quot;Icons.16x16.OpenFileIcon&quot;  
-	                                  description = &quot;${res:XML.MainMenu.FileMenu.Open.File.Description}&quot; 
-	                                  shortcut = &quot;Control|O&quot; 
-	                                  class = &quot;MonoDevelop.Commands.OpenFile&quot;/&gt;
-	                                  
-	                        &lt;MenuItem id = &quot;Project&quot; 
-	                                  _label = &quot;Solution/Project...&quot; 
-	                                  icon = &quot;Icons.16x16.OpenProjectIcon&quot; 
-	                                  description = &quot;${res:XML.MainMenu.FileMenu.Open.Project.Description}&quot; 
-	                                  shortcut = &quot;Control|Shift|O&quot; 
-	                                  class = &quot;MonoDevelop.Commands.OpenCombine&quot;/&gt;
-	                &lt;/MenuItem&gt; --&gt;
+	&lt;!-- Main Menu --&gt;
 
-			&lt;MenuItem id = &quot;Open&quot; _label = &quot;_Open...&quot;
-			          icon = &quot;Icons.16x16.OpenFileIcon&quot;
-			          shortcut = &quot;Control|O&quot;
-			          class = &quot;MonoDevelop.Commands.OpenFile&quot;/&gt;
-
-			&lt;MenuItem id = &quot;OpenSep&quot; _label = &quot;-&quot;/&gt;
-	                
-	                        &lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-		                        &lt;MenuItem id = &quot;CloseFile&quot;
-		                                  _label = &quot;_Close File&quot; 
-		                                  description = &quot;${res:XML.MainMenu.FileMenu.Close.File.Desription}&quot;
-		                                  icon = &quot;Icons.16x16.CloseIcon&quot;
-		                                  shortcut = &quot;Control|W&quot;
-		                                  class =&quot;MonoDevelop.Commands.CloseFile&quot;/&gt;
-		                        &lt;MenuItem id = &quot;CloseAllFiles&quot;
-		                                  _label = &quot;Close All&quot;
-		                                  description = &quot;Close All Files&quot;
-		                                  icon = &quot;Icons.16x16.CloseIcon&quot;
-		                                  shortcut = &quot;Control|Shift|W&quot;
-		                                  class = &quot;MonoDevelop.Commands.CloseAllFiles&quot;/&gt;
-	                        &lt;/Conditional&gt;
-	                        &lt;Conditional iscombineopen=&quot;True&quot; action=&quot;Disable&quot;&gt;
-		                        &lt;MenuItem id = &quot;CloseCombine&quot;
-		                                  _label = &quot;Close Sol_ution&quot; 
-		                                  description = &quot;${res:XML.MainMenu.FileMenu.Close.Project.Desription}&quot;
-		                                  icon = &quot;Icons.16x16.CloseCombineIcon&quot;
-		                                  class = &quot;MonoDevelop.Commands.ClearCombine&quot;/&gt;
-		                &lt;/Conditional&gt;
-	                
-			&lt;MenuItem id = &quot;ReloadSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;Reloadfile&quot;
-				  _label = &quot;_Reload File&quot; 
-				  shortcut = &quot;Control|U&quot;
-				  description = &quot;${res:XML.MainMenu.FileMenu.Reload.Description}&quot;
-	                          class = &quot;MonoDevelop.Commands.ReloadFile&quot; /&gt;
+	&lt;Extension path = &quot;/SharpDevelop/Workbench/MainMenu&quot;&gt;
+		&lt;ItemSet id = &quot;File&quot; _label = &quot;_File&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.NewFile&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.NewProject&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.OpenFile&quot; /&gt;
+			&lt;SeparatorItem id = &quot;OpenSep&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.Save&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.SaveAs&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.SaveAll&quot; /&gt;
+			&lt;SeparatorItem id = &quot;SaveSeparator&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.CloseFile&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.CloseAllFiles&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.CloseCombine&quot; /&gt;
+			&lt;SeparatorItem id = &quot;ReloadSeparator&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.ReloadFile&quot; /&gt;
 			
-			&lt;MenuItem id = &quot;SaveSeparator&quot; _label = &quot;-&quot; /&gt;
+			&lt;SeparatorItem id = &quot;RecentSeparator&quot; /&gt;
+			&lt;ItemSet id = &quot;RecentFiles&quot; _label = &quot;Recent _Files&quot;&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.RecentFileList&quot; /&gt;
+				&lt;SeparatorItem id = &quot;RecentFilesSeparator&quot; /&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.ClearRecentFiles&quot; /&gt;
+			&lt;/ItemSet&gt;
 	                
-			&lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-		                &lt;MenuItem id = &quot;_Save&quot;
-		                          _label = &quot;_Save&quot; 
-		                          icon = &quot;Icons.16x16.SaveIcon&quot; 
-		                          description = &quot;${res:XML.MainMenu.FileMenu.Save.Description}&quot; 
-		                          shortcut = &quot;Control|S&quot;
-		                          class = &quot;MonoDevelop.Commands.SaveFile&quot;/&gt;
-		                &lt;MenuItem id = &quot;SaveAs&quot;
-		                          _label = &quot;Save _As...&quot;
-		                          icon = &quot;Icons.16x16.SaveAsIcon&quot;
-		                          description = &quot;${res:XML.MainMenu.FileMenu.SaveAs.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.SaveFileAs&quot;/&gt;
-		                &lt;MenuItem id = &quot;SaveAll&quot;
-		                          _label = &quot;Save A_ll&quot; 
-		                          icon = &quot;Icons.16x16.SaveAllIcon&quot; 
-		                          shortcut = &quot;Control|Shift|S&quot; 
-		                          description = &quot;${res:XML.MainMenu.FileMenu.SaveAll.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.SaveAllFiles&quot;/&gt;
-			&lt;/Conditional&gt;
-			&lt;!--
-			&lt;MenuItem id = &quot;PrintSeparator&quot; _label = &quot;-&quot; /&gt;
-	                &lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-		                &lt;MenuItem id = &quot;Print&quot;
-		                          _label = &quot;${res:XML.MainMenu.FileMenu.Print}&quot; 
-		                          icon = &quot;Icons.16x16.Print&quot; 
-		                          description = &quot;${res:XML.MainMenu.FileMenu.Print.Description}&quot; 
-		                          shortcut = &quot;Control|P&quot;
-		                          class = &quot;MonoDevelop.Commands.Print&quot;/&gt;
-		                &lt;MenuItem id = &quot;PrintPreview&quot;
-		                          _label = &quot;${res:XML.MainMenu.FileMenu.PrintPreview}&quot; 
-		                          icon = &quot;Icons.16x16.PreView&quot; 
-		                          description = &quot;${res:XML.MainMenu.FileMenu.PrintPreview.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.PrintPreview&quot;/&gt;
-	                &lt;/Conditional&gt;
-			--&gt;
-	                &lt;MenuItem id = &quot;RecentSeparator&quot;  _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;RecentFiles&quot;    attribute = &quot;RecentFiles&quot; _label = &quot;Recent _Files&quot;&gt;
-	                	&lt;MenuItem id = &quot;RecentFilesBuilder&quot; _label = &quot;bogus_label&quot; class = &quot;MonoDevelop.Commands.RecentFilesMenuBuilder&quot; /&gt;
-	                	&lt;MenuItem id = &quot;RecentFilesSeparator&quot; _label = &quot;-&quot; /&gt;
-	                	&lt;MenuItem id = &quot;ClearRecentFiles&quot; 
-	                	          _label = &quot;_Clear Recent Files&quot; 
-	                	          description = &quot;${res:XML.MainMenu.FileMenu.ClearRecentFiles.Description}&quot;
-	                	          class = &quot;MonoDevelop.Commands.ClearRecentFiles&quot; /&gt;
-	                &lt;/MenuItem&gt;
-	                
-	                &lt;MenuItem id = &quot;RecentProjects&quot; attribute = &quot;RecentProjects&quot; _label = &quot;Recent Solu_tions&quot;&gt;
-	                	&lt;MenuItem id = &quot;RecentProjectsBuilder&quot; _label = &quot;bogus_label&quot; class = &quot;MonoDevelop.Commands.RecentProjectsMenuBuilder&quot; /&gt;
-	                	&lt;MenuItem id = &quot;RecentProjectsSeparator&quot; _label = &quot;-&quot; /&gt;
-	                	&lt;MenuItem id = &quot;ClearRecentFiles&quot; 
-	                	          _label = &quot;_Clear Recent Solutions&quot; 
-	                	          description = &quot;${res:XML.MainMenu.FileMenu.ClearRecentProjects.Description}&quot;
-	                	          class = &quot;MonoDevelop.Commands.ClearRecentProjects&quot; /&gt;
-	                &lt;/MenuItem&gt;
-	                
-	                &lt;MenuItem id = &quot;ExitSeparator&quot; _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;Exit&quot;
-	                          _label = &quot;_Quit&quot; 
-	                          icon = &quot;Icons.16x16.QuitIcon&quot; 
-	                          description = &quot;${res:XML.MainMenu.FileMenu.Exit.Description}&quot;
-				  shortcut = &quot;Control|Q&quot;
-	                          class = &quot;MonoDevelop.Commands.ExitWorkbenchCommand&quot; /&gt;
-	        &lt;/MenuItem&gt;
+			&lt;ItemSet id = &quot;RecentProjects&quot; _label = &quot;Recent Solu_tions&quot;&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.RecentProjectList&quot; /&gt;
+				&lt;SeparatorItem id = &quot;RecentProjectsSeparator&quot; /&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.ClearRecentProjects&quot; /&gt;
+			&lt;/ItemSet&gt;
+			
+			&lt;SeparatorItem id = &quot;ExitSeparator&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.Exit&quot; /&gt;
+		&lt;/ItemSet&gt;
 	        
-	        &lt;MenuItem id = &quot;Edit&quot; _label = &quot;_Edit&quot;&gt;
-	                &lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-		                &lt;MenuItem id = &quot;Undo&quot;
-		                          _label = &quot;_Undo&quot; 
-		                          icon = &quot;Icons.16x16.UndoIcon&quot; 
-		                          description = &quot;${res:XML.MainMenu.EditMenu.Undo.Description}&quot; 
-		                          shortcut = &quot;Control|Z&quot;
-		                          class = &quot;MonoDevelop.Commands.Undo&quot;/&gt;
-		                &lt;MenuItem id = &quot;Redo&quot; 
-		                          _label = &quot;_Redo&quot; 
-		                          icon = &quot;Icons.16x16.RedoIcon&quot; 
-		                          description = &quot;${res:XML.MainMenu.EditMenu.Redo.Description}&quot; 
-		                          shortcut = &quot;Control|Y&quot;
-		                          class = &quot;MonoDevelop.Commands.Redo&quot;/&gt;
-		        &lt;/Conditional&gt;
-	                &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-	                &lt;Conditional activewindow=&quot;*&quot; action=&quot;Disable&quot;&gt;
-					&lt;MenuItem id = &quot;Cut&quot; 
-						  _label = &quot;Cu_t&quot; 
-						  icon = &quot;Icons.16x16.CutIcon&quot; 
-						  description = &quot;${res:XML.MainMenu.EditMenu.Cut.Description}&quot; 
-						  shortcut = &quot;Control|X&quot;
-						  class = &quot;MonoDevelop.Commands.Cut&quot;/&gt;
-					&lt;MenuItem id = &quot;Copy&quot; 
-						  _label = &quot;_Copy&quot; 
-						  icon = &quot;Icons.16x16.CopyIcon&quot; 
-						  description = &quot;${res:XML.MainMenu.EditMenu.Copy.Description}&quot; 
-						  shortcut = &quot;Control|C&quot;
-						  class = &quot;MonoDevelop.Commands.Copy&quot;/&gt;
-					&lt;MenuItem id = &quot;Paste&quot; 
-						  _label = &quot;_Paste&quot; 
-						  icon = &quot;Icons.16x16.PasteIcon&quot;  
-						  description = &quot;${res:XML.MainMenu.EditMenu.Paste.Description}&quot; 
-						  shortcut = &quot;Control|V&quot; 
-						  class = &quot;MonoDevelop.Commands.Paste&quot;/&gt;
-					&lt;MenuItem id = &quot;Delete&quot;
-						  _label = &quot;_Delete&quot; 
-						  icon = &quot;Icons.16x16.DeleteIcon&quot; 
-						  description = &quot;${res:XML.MainMenu.EditMenu.Delete.Description}&quot;
-						  class = &quot;MonoDevelop.Commands.Delete&quot;/&gt;
-					&lt;MenuItem id = &quot;SelectAll&quot; 
-						  _label = &quot;Select _All&quot; 
-						  description = &quot;${res:XML.MainMenu.EditMenu.SelectAll.Description}&quot; 
-						  shortcut = &quot;Control|A&quot;
-						  class = &quot;MonoDevelop.Commands.SelectAll&quot;/&gt;
-			                &lt;MenuItem id = &quot;Separator4&quot; _label = &quot;-&quot; /&gt;
-					&lt;MenuItem id = &quot;CommentCode&quot;
-						shortcut = &quot;Control|Alt|C&quot;
-						_label = &quot;C_omment Line(s)&quot;
-						class = &quot;MonoDevelop.Commands.CommentCode&quot;/&gt;
-					&lt;MenuItem id = &quot;UncommentCode&quot;
-						shortcut = &quot;Control|Alt|U&quot;
-						_label = &quot;_Uncomment Line(s)&quot;
-						class = &quot;MonoDevelop.Commands.UncommentCode&quot;/&gt;
-					&lt;MenuItem id = &quot;IndentSelection&quot;
-						shortcut = &quot;Control|Alt|Home&quot;
-						_label = &quot;_Indent Selection&quot;
-						class = &quot;MonoDevelop.Commands.IndentSelection&quot;/&gt;
-					&lt;MenuItem id = &quot;UnIndentSelection&quot;
-						shortcut = &quot;Control|Alt|End&quot;
-						_label = &quot;_Unindent Selection&quot;
-						class = &quot;MonoDevelop.Commands.UnIndentSelection&quot;/&gt;
-		        &lt;/Conditional&gt;
-	                &lt;MenuItem id = &quot;Separator5&quot; _label = &quot;-&quot; /&gt;
-	                &lt;Conditional action=&quot;Disable&quot;&gt;
-		                &lt;Or&gt;
-		                	&lt;Condition activewindow=&quot;*&quot;/&gt;
-		                	&lt;Condition iscombineopen=&quot;True&quot;/&gt;
-		                &lt;/Or&gt;
-		                &lt;MenuItem id = &quot;WordCount&quot;
-		                          _label = &quot;_Word Count...&quot; 
-		                          description = &quot;${res:XML.MainMenu.EditMenu.WordCount.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.WordCount&quot;/&gt;
-		        &lt;/Conditional&gt;
-			&lt;MenuItem id = &quot;optionssep5&quot; _label = &quot;-&quot; /&gt;
-                        &lt;MenuItem id = &quot;Options&quot;
-                                  _label = &quot;_Preferences&quot;
-                                  icon = &quot;Icons.16x16.Options&quot;
-                                  description = &quot;${res:XML.MainMenu.ToolMenu.Options.Description}&quot;
-                                  class = &quot;MonoDevelop.Commands.OptionsCommand&quot;/&gt;
+		&lt;ItemSet id = &quot;Edit&quot; _label = &quot;_Edit&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Undo&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Redo&quot; /&gt;
+			
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Cut&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Copy&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Paste&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.Delete&quot; /&gt;
 
-	        &lt;/MenuItem&gt;
-	        
-	        &lt;MenuItem id = &quot;View&quot; _label = &quot;_View&quot;&gt;
-	                &lt;MenuItem id = &quot;ViewBuilder&quot; _label = &quot;&quot; class = &quot;MonoDevelop.Commands.ViewMenuBuilder&quot; /&gt;
-	                &lt;MenuItem id = &quot;ViewItemsSeparator&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;ViewLayouts&quot; _label = &quot;_Layouts&quot;&gt;
-				  &lt;MenuItem id = &quot;ViewLayoutsBuilder&quot; _label = &quot;&quot; class = &quot;MonoDevelop.Commands.LayoutsMenuBuilder&quot; /&gt;
-				  &lt;MenuItem id = &quot;ViewLayoutsSeparator&quot; _label = &quot;-&quot; /&gt;
-				  &lt;MenuItem id = &quot;ViewLayoutsNew&quot; _label = &quot;_New&quot; class = &quot;MonoDevelop.Commands.NewLayoutCommand&quot; /&gt;
-			&lt;/MenuItem&gt;
-	                &lt;MenuItem id = &quot;ViewItemsSeparator2&quot; _label = &quot;-&quot; /&gt;
-			&lt;MenuItem id = &quot;FullScreen&quot;
-	                          _label = &quot;_Full Screen&quot; 
-	                          icon = &quot;Icons.16x16.FullScreen&quot; 
-				  shortcut = &quot;F11&quot;
-	                          description = &quot;${res:XML.MainMenu.ViewMenu.FullScreen.Description}&quot; 
-	                          class = &quot;MonoDevelop.Commands.ToggleFullscreenCommand&quot; /&gt;
-	        &lt;/MenuItem&gt;
+			&lt;SeparatorItem id = &quot;Separator2&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.SelectAll&quot; /&gt;
+			
+			&lt;SeparatorItem id = &quot;Separator4&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.CommentCode&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.UncommentCode&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.IndentSelection&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.UnIndentSelection&quot; /&gt;
+			
+			&lt;SeparatorItem id = &quot;Separator5&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.WordCount&quot; /&gt;
+			
+			&lt;SeparatorItem id = &quot;optionssep5&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.EditCommands.MonodevelopPreferences&quot; /&gt;
+		&lt;/ItemSet&gt;
 		
-		&lt;!-- &lt;Conditional iscombineopen=&quot;True&quot;&gt;
-			&lt;MenuItem id = &quot;Project&quot; _label = &quot;${res:XML.MainMenu.ProjectMenu}&quot;&gt;
-				&lt;Conditional activeproject=&quot;*&quot; action=&quot;Disable&quot;&gt;
-					&lt;MenuItem id = &quot;RunTests&quot;
-					          _label = &quot;${res:XML.MainMenu.ProjectMenu.RunTests}&quot; 
-					          description = &quot;${res:XML.MainMenu.ProjectMenu.RunTests.Description}&quot;
-					          class = &quot;MonoDevelop.Commands.RunTestsInProject&quot;/&gt;
-			                          
-					&lt;MenuItem id = &quot;Deploy&quot; 
-			                   _label = &quot;${res:XML.MainMenu.ProjectMenu.Deploy}&quot; 
-			                          description = &quot;${res:XML.MainMenu.ProjectMenu.Deploy.Description}&quot; 
-			                          class = &quot;MonoDevelop.Commands.DeployProject&quot;/&gt;
-				        &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-					&lt;MenuItem id = &quot;ViewDocumentation&quot;
-				                  _label = &quot;${res:ProjectComponent.ContextMenu.ViewDocumentation}&quot;
-				                  class = &quot;MonoDevelop.Commands.ViewProjectDocumentation&quot;/&gt; 
-
-			                &lt;MenuItem id = &quot;GenerateDocumentation&quot;
-			                          _label = &quot;${res:ProjectComponent.ContextMenu.GenerateDocumentation}&quot;
-			                          class = &quot;MonoDevelop.Commands.GenerateProjectDocumentation&quot;/&gt;
-					
-					&lt;MenuItem id = &quot;Separator2&quot; _label = &quot;-&quot; /&gt;
-			                &lt;MenuItem id = &quot;Options&quot;
-			                          _label = &quot;${res:XML.MainMenu.ProjectMenu.Options}&quot; 
-			                          description = &quot;${res:XML.MainMenu.ProjectMenu.Options.Description}&quot; 
-			                          class = &quot;MonoDevelop.Commands.ViewProjectOptions&quot;/&gt;
-				&lt;/Conditional&gt;
-			&lt;/MenuItem&gt;
-		&lt;/Conditional&gt; --&gt;
+		&lt;ItemSet id = &quot;View&quot; _label = &quot;_View&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.ViewList&quot; /&gt;
+			&lt;SeparatorItem id = &quot;ViewItemsSeparator&quot; /&gt;
+			&lt;ItemSet id = &quot;ViewLayouts&quot; _label = &quot;_Layouts&quot;&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.LayoutList&quot; /&gt;
+				&lt;SeparatorItem id = &quot;ViewItemsSeparator&quot; /&gt;
+				&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.NewLayout&quot; /&gt;
+			&lt;/ItemSet&gt;
+			&lt;SeparatorItem id = &quot;ViewItemsSeparator2&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ViewCommands.FullScreen&quot; /&gt;
+		&lt;/ItemSet&gt;
 		
-	        &lt;MenuItem id = &quot;Run&quot; _label = &quot;_Run&quot;&gt;
-	                &lt;Conditional action=&quot;Disable&quot;&gt;
-	                	&lt;Or&gt;
-	                		&lt;Condition activewindow=&quot;MonoDevelop.SourceEditor.Gui.SourceEditorDisplayBindingWrapper&quot;/&gt;
-	                		&lt;Condition iscombineopen=&quot;True&quot;/&gt;
-	                	&lt;/Or&gt;
-	                	
-		                &lt;MenuItem id = &quot;Compile&quot;
-		                          _label = &quot;_Compile&quot; 
-		                          description = &quot;${res:XML.MainMenu.RunMenu.Compile.Description}&quot; 
-		                          shortcut = &quot;F8&quot;
-		                          icon  = &quot;Icons.16x16.BuildCombine&quot;
-		                          class = &quot;MonoDevelop.Commands.Compile&quot;/&gt;
-		                &lt;MenuItem id = &quot;CompileAll&quot;
-		                          _label = &quot;Compile _All&quot; 
-		                          description = &quot;${res:XML.MainMenu.RunMenu.CompileAll.Description}&quot; 
-		                          shortcut = &quot;Control|F8&quot;
-		                          class = &quot;MonoDevelop.Commands.CompileAll&quot;/&gt;
-		                &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-			                &lt;!-- &lt;Conditional activeproject=&quot;*&quot;&gt;
-				                &lt;MenuItem id = &quot;BuildProject&quot;
-				                          _label = &quot;${res:XML.MainMenu.RunMenu.BuildProject}&quot; 
-				                          description = &quot;${res:XML.MainMenu.RunMenu.BuildProject.Description}&quot; 
-				                          shortcut = &quot;F9&quot;
-				                          icon  = &quot;Icons.16x16.BuildCurrentSelectedProject&quot;
-				                          class = &quot;MonoDevelop.Commands.BuildCurrentProject&quot;/&gt;
-				                &lt;MenuItem id = &quot;RebuildProject&quot;
-				                          _label = &quot;${res:XML.MainMenu.RunMenu.RebuildProject}&quot; 
-				                          description = &quot;${res:XML.MainMenu.RunMenu.RebuildProject.Description}&quot; 
-				                          shortcut = &quot;Alt|F9&quot;
-				                          class = &quot;MonoDevelop.Commands.RebuildCurrentProject&quot;/&gt;
-				                &lt;MenuItem id = &quot;Separator2&quot; _label = &quot;-&quot; /&gt;
-			                &lt;/Conditional&gt; --&gt;
-		                &lt;MenuItem id = &quot;Run&quot;
-		                          _label = &quot;_Run&quot; 
-		                          icon = &quot;Icons.16x16.RunProgramIcon&quot; 
-		                          description = &quot;${res:XML.MainMenu.RunMenu.Run.Description}&quot; 
-		                          shortcut = &quot;F5&quot;
-		                          class = &quot;MonoDevelop.Commands.RunCommand&quot;/&gt;
-				&lt;!-- &lt;MenuItem id = &quot;GenerateMakefiles&quot;
-				          _label = &quot;Generate Makefiles&quot;
-				          class = &quot;MonoDevelop.Commands.GenerateMakefiles&quot;/&gt;--&gt;
-
-			&lt;/Conditional&gt; 
-	        &lt;/MenuItem&gt;
+		&lt;ItemSet id = &quot;Run&quot; _label = &quot;_Run&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Compile&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Build&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Rebuild&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator1&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Run&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Debug&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator2&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ProjectCommands.Stop&quot; /&gt;
+		&lt;/ItemSet&gt;
         
-	        &lt;MenuItem id = &quot;Tools&quot; 
-	                  _label = &quot;Tools&quot;&gt;
-	                &lt;MenuItem id = &quot;ToolBuilder&quot; _label = &quot;bogus_label&quot; class = &quot;MonoDevelop.Commands.ToolMenuBuilder&quot; /&gt;
-	                &lt;!-- &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt; --&gt;
-	                
-	                &lt;!-- &lt;MenuItem id = &quot;Separator4&quot; _label = &quot;-&quot; /&gt; --&gt;
-			&lt;!-- &lt;Conditional action = &quot;Disable&quot;&gt;
-				&lt;Or&gt;
-					&lt;Condition activewindow=&quot;MonoDevelop.FormDesigner.FormDesignerDisplayBindingWrapper&quot;/&gt;
-					&lt;Condition activewindow=&quot;MonoDevelop.FormDesigner.CSharpDesignerDisplayBindingWrapper&quot;/&gt;
-	                		&lt;Condition activewindow=&quot;MonoDevelop.DefaultEditor.Gui.Editor.TextEditorDisplayBindingWrapper&quot;/&gt;
-				&lt;/Or&gt;
-				&lt;MenuItem id = &quot;ConvertBuffer&quot;
-		                          _label = &quot;${res:XML.MainMenu.ToolMenu.ConvertBufferToVBNET}&quot; 
-		                          description = &quot;${res:XML.MainMenu.ToolMenu.ConvertBufferToVBNET.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.VBConvertBuffer&quot;/&gt;
-			&lt;/Conditional&gt; --&gt;
-
-	&lt;!-- ORIGINAL #D COMMENT &lt;MenuItem id = &quot;ConvertProject&quot;
-	                          _label = &quot;Convert C# Project to VB.NET&quot; 
-	                          description = &quot;Converts the current selected C# project to VB.NET&quot;
-	                          class = &quot;MonoDevelop.Commands.VBConvertProject&quot;/&gt;--&gt;
-
-	                &lt;!-- &lt;MenuItem id = &quot;Separator5&quot; _label = &quot;-&quot; /&gt; --&gt;
-	               
-	        &lt;/MenuItem&gt;
+		&lt;ItemSet id = &quot;Tools&quot; _label = &quot;Tools&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.ToolCommands.ToolList&quot; /&gt;
+        &lt;/ItemSet&gt;
 	        
-&lt;!-- ORIGINAL #D COMMENT	        &lt;MenuItem id = &quot;AddIns&quot; _label = &quot;${res:XML.MainMenu.PluginMenu}&quot;&gt;
-	                &lt;MenuItem _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem _label = &quot;${res:XML.MainMenu.PluginMenu.Manager}&quot; description = &quot;${res:XML.MainMenu.PluginMenu.Manager.Description}&quot; class = &quot;SharpDevelop.Actions.Edit.ShowPlugInManager&quot;/&gt; 
-	        &lt;/MenuItem&gt;--&gt;
+		&lt;ItemSet id = &quot;Window&quot; _label = &quot;_Window&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.WindowCommands.NextWindow&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.WindowCommands.PrevWindow&quot; /&gt;
+			&lt;SeparatorItem id =&quot;NxtPrvSeparator&quot; /&gt; 
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.FileCommands.CloseAllFiles&quot; /&gt;
+			&lt;SeparatorItem id = &quot;contentSep&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.WindowCommands.OpenWindowList&quot; /&gt;
+		&lt;/ItemSet&gt; 
 
-	        &lt;MenuItem id = &quot;Window&quot; _label = &quot;_Window&quot;&gt;
-	                &lt;Conditional action=&quot;Disable&quot;&gt;
-				&lt;Condition activewindow=&quot;*&quot; /&gt;
-	                &lt;MenuItem id  = &quot;NextWindow&quot;
-			          _label = &quot;_Next Window&quot;
-			          icon = &quot;Icons.16x16.NextWindowIcon&quot;
-				  description = &quot;${res:XML.MainMenu.WindowMenu.NxtWindow.Description}&quot; 
-				  shortcut = &quot;Control|Page_Down&quot;
-				  class = &quot;MonoDevelop.Commands.SelectNextWindow&quot; /&gt;
-	                &lt;MenuItem id = &quot;PrevWindow&quot;
-			          _label = &quot;_Previous Window&quot;
-			          icon = &quot;Icons.16x16.PrevWindowIcon&quot;
-				  description = &quot;${res:XML.MainMenu.WindowMenu.PrvWindow.Description}&quot;
-				  shortcut = &quot;Control|Page_Up&quot;
-				  class = &quot;MonoDevelop.Commands.SelectPrevWindow&quot; /&gt;
-	                &lt;MenuItem id =&quot;NxtPrvSeparator&quot; _label = &quot;-&quot; /&gt; 
-		                &lt;MenuItem id    = &quot;CloseAll&quot;
-		                          _label = &quot;_Close All&quot; 
-		                          icon  = &quot;Icons.16x16.CloseAllDocuments&quot; 
-		                          description = &quot;${res:XML.MainMenu.FileMenu.CloseAll.Description}&quot;
-		                          class = &quot;MonoDevelop.Commands.CloseAllWindows&quot; /&gt;
-					&lt;/Conditional&gt;
-&lt;MenuItem id = &quot;contentSep&quot; _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;ContentBuilder&quot; _label = &quot;bogus_label&quot; class=&quot;MonoDevelop.Commands.OpenContentsMenuBuilder&quot;/&gt;
-	        &lt;/MenuItem&gt; 
-	        
-	        &lt;MenuItem id = &quot;Help&quot; _label = &quot;_Help&quot;&gt;
-	                &lt;!--&lt;MenuItem id = &quot;Help&quot;
-	                          _label = &quot;_Help...&quot; 
-	                          icon = &quot;Icons.16x16.HelpIcon&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.Topics.Description}&quot; 
-	                          shortcut = &quot;Alt|F1&quot; 
-	                          class = &quot;MonoDevelop.Commands.ShowHelp&quot;/&gt;--&gt;
-	                &lt;MenuItem id = &quot;TipOfTheDay&quot;
-	                          _label = &quot;_Tip of the Day...&quot; 
-	                          icon = &quot;Icons.16x16.TipOfTheDay&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.Tips.Description}&quot; 
-	                          class = &quot;MonoDevelop.Commands.ViewTipOfTheDay&quot; /&gt;
-	                
-&lt;!--	                &lt;MenuItem id = &quot;Separator1&quot; _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;ViewGPL&quot;
-	                          _label = &quot;${res:XML.MainMenu.HelpMenu.GPL}&quot; 
-	                          icon = &quot;Icons.16x16.CopyLeftIcon&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.GPL.Description}&quot; 
-	                          class = &quot;MonoDevelop.Commands.ViewGPL&quot; /&gt; --&gt;
-	                          
-	              &lt;!--  &lt;MenuItem id = &quot;ViewReadme&quot;
-	                          _label       = &quot;${res:XML.MainMenu.HelpMenu.ReadMe}&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.ReadMe.Description}&quot; 
-	                          link        = &quot;<A HREF="home://../doc/ReadMe.html&quot;">home://../doc/ReadMe.html&quot;</A> /&gt;
-	                &lt;MenuItem id = &quot;ViewStyleguide&quot;
-	                          _label = &quot;${res:XML.MainMenu.HelpMenu.StyleGuide}&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.StyleGuide.Description}&quot; 
-	                          link = &quot;<A HREF="home://../doc/CodingStyleGuide.pdf&quot;">home://../doc/CodingStyleGuide.pdf&quot;</A> /&gt; --&gt;
-	                &lt;MenuItem id = &quot;Separator2&quot; _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;Web&quot; _label = &quot;_Web&quot;&gt;
-	                        &lt;!-- &lt;MenuItem id = &quot;ASP&quot; _label = &quot;&amp;amp;AlphaSierraPapa&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;Visit my sponsors&quot; link = &quot;<A HREF="http://www.alphasierrapapa.com/&quot;">http://www.alphasierrapapa.com/&quot;</A> /&gt; --&gt;
-	                        &lt;MenuItem id = &quot;MonoDevelop&quot; _label = &quot;MonoDevelop&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.monodevelop.com&quot;">http://www.monodevelop.com&quot;</A> /&gt;
-				&lt;!-- &lt;MenuItem id = &quot;SharpDevelop&quot; _label = &quot;SharpDevelop&quot;&gt;
-	                        	&lt;MenuItem id = &quot;Downloads&quot; _label = &quot;Downloads&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.icsharpcode.net/opensource/sd/download/&quot;">http://www.icsharpcode.net/opensource/sd/download/&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;Forum&quot; _label = &quot;Community Forums&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.icsharpcode.net/opensource/sd/forum/&quot;">http://www.icsharpcode.net/opensource/sd/forum/&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;Announcement&quot; _label = &quot;Announcement List&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.icsharpcode.net/opensource/sd/announcementlist.asp&quot;">http://www.icsharpcode.net/opensource/sd/announcementlist.asp&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;Mail&quot; _label = &quot;Send Us a Mail&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.icsharpcode.net/opensource/sd/ContactUs.asp&quot;">http://www.icsharpcode.net/opensource/sd/ContactUs.asp&quot;</A> /&gt;
-	                        &lt;/MenuItem&gt; --&gt;
-	                        &lt;MenuItem id = &quot;C#&quot; _label = &quot;C#&quot;&gt;
-	                        	&lt;MenuItem id = &quot;cshrp.net&quot; _label = &quot;cshrp.net&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.cshrp.net/&quot;">http://www.cshrp.net/&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;C# Help&quot; _label = &quot;C# Help&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.csharphelp.com&quot;">http://www.csharphelp.com&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;C# Corner&quot; _label = &quot;C# Corner&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; link = &quot;<A HREF="http://www.c-sharpcorner.com&quot;">http://www.c-sharpcorner.com&quot;</A> /&gt;
-		                        &lt;MenuItem id = &quot;GotDotNet&quot; _label = &quot;GotDotNet&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;Visit one of the best NET sites on the web&quot; link = &quot;<A HREF="http://www.gotdotnet.com/&quot;">http://www.gotdotnet.com/&quot;</A> /&gt;
-	                        &lt;/MenuItem&gt;
-	                        &lt;!-- &lt;MenuItem id = &quot;IntegratedProjects&quot; _label = &quot;Integrated Projects&quot;&gt;
-	                        	&lt;MenuItem id = &quot;Magic Library&quot; _label = &quot;Magic Library&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;One of the best .NET control libraries around.&quot; link = &quot;<A HREF="http://www.dotnetmagic.com&quot;">http://www.dotnetmagic.com&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;NAnt&quot; _label = &quot;NAnt&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;THE .NET building tool.&quot; link = &quot;<A HREF="http://nant.sourceforge.net/&quot;">http://nant.sourceforge.net/&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;NDoc&quot; _label = &quot;NDoc&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;I used the NDoc as the SharpDevelop documentation generator. Look out it is cool.&quot; link = &quot;<A HREF="http://ndoc.sourceforge.net/&quot;">http://ndoc.sourceforge.net/&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;#ZipLib&quot; _label = &quot;#ZipLib&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;I used the NDoc as the SharpDevelop documentation generator. Look out it is cool.&quot; link = &quot;<A HREF="http://www.icsharpcode.net/OpenSource/NZipLib&quot;">http://www.icsharpcode.net/OpenSource/NZipLib&quot;</A> /&gt;
-	                        	&lt;MenuItem id = &quot;#CvsLib&quot; _label = &quot;#CvsLib&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;I used the NDoc as the SharpDevelop documentation generator. Look out it is cool.&quot; link = &quot;<A HREF="http://www.icsharpcode.net/OpenSource/NetCvsLib&quot;">http://www.icsharpcode.net/OpenSource/NetCvsLib&quot;</A> /&gt;
-	                        &lt;/MenuItem&gt; --&gt;
-		                &lt;MenuItem id = &quot;Mono&quot;    _label = &quot;Mono Project&quot; icon = &quot;Icons.16x16.WebSearchIcon&quot; description = &quot;A free .NET implementation effort, worth visiting&quot; link = &quot;<A HREF="http://www.go-mono.com&quot;">http://www.go-mono.com&quot;</A> /&gt;
-	                &lt;/MenuItem&gt;
-	                &lt;MenuItem id = &quot;Separator3&quot; _label = &quot;-&quot; /&gt;
-	                &lt;MenuItem id = &quot;About&quot;
-	                          _label = &quot;_About&quot; 
-	                          icon = &quot;Icons.16x16.AboutIcon&quot; 
-	                          description = &quot;${res:XML.MainMenu.HelpMenu.About.Description}&quot; 
-	                          class = &quot;MonoDevelop.Commands.AboutSharpDevelop&quot; /&gt;
-	        &lt;/MenuItem&gt;
+		&lt;ItemSet id = &quot;Help&quot; _label = &quot;_Help&quot;&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.HelpCommands.TipOfTheDay&quot; /&gt;
+			&lt;SeparatorItem id = &quot;Separator2&quot; /&gt;
+			&lt;ItemSet id = &quot;Web&quot; _label = &quot;_Web&quot;&gt;
+				&lt;LinkItem id = &quot;MonoDevelop&quot; _label = &quot;MonoDevelop&quot; link = &quot;<A HREF="http://www.monodevelop.com&quot;">http://www.monodevelop.com&quot;</A> /&gt;
+				&lt;ItemSet id = &quot;C#&quot; _label = &quot;C#&quot;&gt;
+					&lt;LinkItem id = &quot;cshrp.net&quot; _label = &quot;cshrp.net&quot; link = &quot;<A HREF="http://www.cshrp.net/&quot;">http://www.cshrp.net/&quot;</A> /&gt;
+					&lt;LinkItem id = &quot;C# Help&quot; _label = &quot;C# Help&quot; link = &quot;<A HREF="http://www.csharphelp.com&quot;">http://www.csharphelp.com&quot;</A> /&gt;
+					&lt;LinkItem id = &quot;C# Corner&quot; _label = &quot;C# Corner&quot; link = &quot;<A HREF="http://www.c-sharpcorner.com&quot;">http://www.c-sharpcorner.com&quot;</A> /&gt;
+					&lt;LinkItem id = &quot;GotDotNet&quot; _label = &quot;GotDotNet&quot; description = &quot;Visit one of the best NET sites on the web&quot; link = &quot;<A HREF="http://www.gotdotnet.com/&quot;">http://www.gotdotnet.com/&quot;</A> /&gt;
+				&lt;/ItemSet&gt;
+				&lt;LinkItem id = &quot;Mono&quot; _label = &quot;Mono Project&quot; description = &quot;A free .NET implementation effort, worth visiting&quot; link = &quot;<A HREF="http://www.mono-project.com&quot;">http://www.mono-project.com&quot;</A> /&gt;
+			&lt;/ItemSet&gt;
+			&lt;SeparatorItem id = &quot;Separator3&quot; /&gt;
+			&lt;CommandItem id = &quot;MonoDevelop.Commands.HelpCommands.About&quot; /&gt;
+		&lt;/ItemSet&gt;
 	&lt;/Extension&gt;	
 
 

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/DefaultFileService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -15,6 +15,7 @@
 using MonoDevelop.Core.Services;
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Gui;
+using MonoDevelop.Gui.Widgets;
 using MonoDevelop.Core.AddIns.Codons;
 using MonoDevelop.Gui.Utils;
 
@@ -297,7 +298,70 @@
 			Directory.CreateDirectory (path);
 			OnFileCreated (new FileEventArgs (path, true));
 		}
-
+		
+		public void SaveFile (IWorkbenchWindow window)
+		{
+			if (window.ViewContent.ContentName == null) {
+				SaveFileAs (window);
+			} else {
+				FileAttributes attr = FileAttributes.ReadOnly | FileAttributes.Directory | FileAttributes.Offline | FileAttributes.System;
+				// FIXME
+				// bug #59731 is if the file is moved out from under us, we were crashing
+				// I changed it to make it ask for a new
+				// filename instead, but maybe we should
+				// detect the move and update the reference
+				// to the name instead
+				if (!File.Exists (window.ViewContent.ContentName) || (File.GetAttributes(window.ViewContent.ContentName) &amp; attr) != 0) {
+					SaveFileAs (window);
+				} else {						
+					Runtime.ProjectService.MarkFileDirty (window.ViewContent.ContentName);
+					string fileName = window.ViewContent.ContentName;
+					// save backup first						
+					if((bool) Runtime.Properties.GetProperty (&quot;SharpDevelop.CreateBackupCopy&quot;, false)) {
+						Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), fileName + &quot;~&quot;);
+					}
+					Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), fileName);
+				}
+			}
+		}
+		
+		public void SaveFileAs (IWorkbenchWindow window)
+		{
+			if (window.ViewContent is ICustomizedCommands) {
+				if (((ICustomizedCommands)window.ViewContent).SaveAsCommand()) {
+					return;
+				}
+			}
+			
+			FileSelector fdiag = new FileSelector (GettextCatalog.GetString (&quot;Save as...&quot;), Gtk.FileChooserAction.Save);
+			fdiag.SetFilename (window.ViewContent.ContentName);
+			int response = fdiag.Run ();
+			string filename = fdiag.Filename;
+			fdiag.Hide ();
+		
+			if (response == (int)Gtk.ResponseType.Ok) {
+				if (!Runtime.FileUtilityService.IsValidFileName (filename)) {
+					Runtime.MessageService.ShowMessage(String.Format (GettextCatalog.GetString (&quot;File name {0} is invalid&quot;), filename));
+					return;
+				}
+				// detect preexisting file
+				if(File.Exists(filename)){
+					if(!Runtime.MessageService.AskQuestion(String.Format (GettextCatalog.GetString (&quot;File {0} already exists.  Overwrite?&quot;), filename))){
+						return;
+					}
+				}
+				// save backup first
+				if((bool) Runtime.Properties.GetProperty (&quot;SharpDevelop.CreateBackupCopy&quot;, false)) {
+					Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), filename + &quot;~&quot;);
+				}
+				
+				// do actual save
+				if (Runtime.FileUtilityService.ObservedSave (new NamedFileOperationDelegate(window.ViewContent.Save), filename) == FileOperationResult.OK) {
+					Runtime.FileService.RecentOpen.AddLastFile (filename, null);
+				}
+			}
+		}
+		
 		protected virtual void OnFileCreated (FileEventArgs e)
 		{
 			if (FileCreated != null) {

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/File/IFileService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -47,6 +47,9 @@
 		/// &lt;/remarks&gt;
 		IWorkbenchWindow GetOpenFile(string fileName);
 		
+		void SaveFile (IWorkbenchWindow window);
+		void SaveFileAs (IWorkbenchWindow window);
+	
 		/// &lt;remarks&gt;
 		/// Removes a file physically
 		/// CAUTION : Use only this file for a remove operation, because it is important

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/IDebuggerService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/IDebuggerService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/IDebuggerService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -28,7 +28,7 @@
 
 		void Pause ();
 		void Resume ();
-		void Run (string[] args);
+		void Run (IProgressMonitor monitor, string[] args);
 		void Stop ();
 
 		void StepInto ();

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/IProjectService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -41,12 +41,23 @@
 		}
 		
 		/// &lt;remarks&gt;
+		/// Gets the current selected combine or project.
+		/// &lt;/remarks&gt;
+		CombineEntry CurrentSelectedCombineEntry {
+			get;
+		}
+		
+		/// &lt;remarks&gt;
 		/// Gets the root combine, if no combine is open it returns null. 
 		/// &lt;/remarks&gt;
 		Combine CurrentOpenCombine {
 			get;
 		}
 		
+		IAsyncOperation CurrentBuildOperation { get; }
+		
+		IAsyncOperation CurrentRunOperation { get; }
+		
 		bool IsCombineEntryFile (string filename);
 		
 		/// &lt;remarks&gt;
@@ -81,43 +92,34 @@
 		void CloseCombine(bool saveCombinePreferencies);
 		
 		/// &lt;remarks&gt;
-		/// Compile the root combine.
+		/// Builds the provided project or combine
 		/// &lt;/remarks&gt;
-		IAsyncOperation BuildActiveCombine();
+		IAsyncOperation Build (CombineEntry entry);
 		
 		/// &lt;remarks&gt;
-		/// Compile the root combine. Forces Recompile for all projects.
+		/// Rebuilds the provided project or combine
 		/// &lt;/remarks&gt;
-		IAsyncOperation RebuildActiveCombine();
+		IAsyncOperation Rebuild (CombineEntry entry);
 		
-		/// &lt;remarks&gt;
-		/// Compiles the active project, if the project isn't dirty this
-		/// method does nothing
-		/// &lt;/remarks&gt;
-		IAsyncOperation BuildActiveProject ();
+		IAsyncOperation BuildFile (string file);
 		
-		/// &lt;remarks&gt;
-		/// Compiles the active project (forced!)
-		/// &lt;/remarks&gt;
-		IAsyncOperation RebuildActiveProject ();
+		IAsyncOperation Execute (CombineEntry entry);
+		IAsyncOperation ExecuteFile (string sourceFile);
 		
-		/// &lt;remarks&gt;
-		/// Compiles a specific project, if the project isn't dirty this
-		/// method does nothing
-		/// &lt;/remarks&gt;
-		IAsyncOperation BuildProject (Project project);
+		IAsyncOperation Debug (CombineEntry entry);
+		IAsyncOperation DebugFile (string sourceFile);
 		
-		/// &lt;remarks&gt;
-		/// Compiles a specific project (forced!)
-		/// &lt;/remarks&gt;
-		IAsyncOperation RebuildProject (Project project);
+		void Deploy (Project project);
 		
-		IAsyncOperation BuildFile (string file);
+		void ShowOptions (CombineEntry entry);
 		
-		IAsyncOperation ExecuteActiveCombine ();
-		IAsyncOperation ExecuteProject (Project project);
-		IAsyncOperation ExecuteFile (string sourceFile);
+		CombineEntry CreateProject (Combine parentCombine);
+		CombineEntry CreateCombine (Combine parentCombine);
+		CombineEntry AddCombineEntry (Combine parentCombine);
 		
+		ProjectFile CreateProjectFile (Project parentProject, string basePath);
+		bool AddReferenceToProject (Project project);
+		
 		/// &lt;remarks&gt;
 		/// Opens a new root combine, closes the old root combine automatically.
 		/// &lt;/remarks&gt;

Modified: trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/ProjectService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/ProjectService.cs	2005-04-25 17:50:19 UTC (rev 2473)
+++ trunk/MonoDevelop/Core/src/MonoDevelop.Base/Services/Project/ProjectService.cs	2005-04-25 20:35:11 UTC (rev 2474)
@@ -14,6 +14,8 @@
 using System.Threading;
 
 using MonoDevelop.Gui;
+using MonoDevelop.Gui.Dialogs;
+using MonoDevelop.Gui.Widgets;
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Internal.Serialization;
 
@@ -40,8 +42,8 @@
 		DataContext dataContext = new DataContext ();
 		ProjectBindingCodon[] projectBindings;
 		
-		IAsyncOperation currentBuildOperation;
-		IAsyncOperation currentRunOperation;
+		IAsyncOperation currentBuildOperation = NullAsyncOperation.Success;
+		IAsyncOperation currentRunOperation = NullAsyncOperation.Success;
 		
 		FileFormatManager formatManager = new FileFormatManager ();
 		IFileFormat defaultProjectFormat = new MdpFileFormat ();
@@ -54,7 +56,7 @@
 				return currentProject;
 			}
 			set {
-				Debug.Assert(openCombine != null);
+				System.Diagnostics.Debug.Assert(openCombine != null);
 				currentProject = value;
 				OnCurrentProjectChanged(new ProjectEventArgs(currentProject));
 			}
@@ -65,12 +67,29 @@
 				return currentCombine;
 			}
 			set {
-				Debug.Assert(openCombine != null);
+				System.Diagnostics.Debug.Assert(openCombine != null);
 				currentCombine = value;
 				OnCurrentSelectedCombineChanged(new CombineEventArgs(currentCombine));
 			}
 		}
 		
+		public CombineEntry CurrentSelectedCombineEntry {
+			get {
+				if (currentProject != null)
+					return currentProject;
+				else
+					return currentCombine;
+			}
+		}
+		
+		public IAsyncOperation CurrentBuildOperation {
+			get { return currentBuildOperation; }
+		}
+		
+		public IAsyncOperation CurrentRunOperation {
+			get { return currentRunOperation; }
+		}
+		
 		public Combine CurrentOpenCombine {
 			get {
 				return openCombine;
@@ -313,52 +332,80 @@
 			}
 		}
 
-		public IAsyncOperation ExecuteActiveCombine ()
+		public IAsyncOperation Execute (CombineEntry entry)
 		{
 			if (openCombine == null) return NullAsyncOperation.Success;
 			if (currentRunOperation != null &amp;&amp; !currentRunOperation.IsCompleted) return currentRunOperation;
+
 			IProgressMonitor monitor = new NullProgressMonitor ();
-			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (ExecuteActiveCombineAsync), monitor);
+			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (ExecuteCombineEntryAsync), new object[] {entry, monitor});
 			currentRunOperation = monitor.AsyncOperation;
 			return currentRunOperation;
 		}
 		
-		void ExecuteActiveCombineAsync (object ob)
+		void ExecuteCombineEntryAsync (object ob)
 		{
-			IProgressMonitor monitor = (IProgressMonitor) ob;
-
+			object[] data = (object[]) ob;
+			CombineEntry entry = (CombineEntry) data[0];
+			IProgressMonitor monitor = (IProgressMonitor) data[1];
 			OnBeforeStartProject ();
 			try {
-				openCombine.Execute (monitor);
+				entry.Execute (monitor);
 			} catch (Exception ex) {
 				monitor.ReportError (GettextCatalog.GetString (&quot;Execution failed.&quot;), ex);
 			} finally {
 				monitor.Dispose ();
 			}
 		}
+		
+		public IAsyncOperation Debug (CombineEntry entry)
+		{
+			if (openCombine == null) return NullAsyncOperation.Success;
+			if (currentRunOperation != null &amp;&amp; !currentRunOperation.IsCompleted) return currentRunOperation;
+			
+			WorkbenchSingleton.Workbench.Context = WorkbenchContext.Debug;
 
-		public IAsyncOperation ExecuteProject (Project project)
-		{
 			IProgressMonitor monitor = new NullProgressMonitor ();
-			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (ExecuteProjectAsync), new object[] {project, monitor});
-			return monitor.AsyncOperation;
+			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (DebugCombineEntryAsync), new object[] {entry, monitor});
+			currentRunOperation = monitor.AsyncOperation;
+			return currentRunOperation;
 		}
 		
-		void ExecuteProjectAsync (object ob)
+		void DebugCombineEntryAsync (object ob)
 		{
 			object[] data = (object[]) ob;
-			Project project = (Project) data[0];
+			CombineEntry entry = (CombineEntry) data[0];
 			IProgressMonitor monitor = (IProgressMonitor) data[1];
-			OnBeforeStartProject ();
 			try {
-				project.Execute (monitor);
+				entry.Debug (monitor);
 			} catch (Exception ex) {
 				monitor.ReportError (GettextCatalog.GetString (&quot;Execution failed.&quot;), ex);
 			} finally {
 				monitor.Dispose ();
 			}
+			Runtime.DispatchService.GuiDispatch (new MessageHandler (RestoreWorkbenchContext));
 		}
 		
+		void RestoreWorkbenchContext ()
+		{
+			WorkbenchSingleton.Workbench.Context = WorkbenchContext.Edit;
+		}
+		
+		public IAsyncOperation DebugFile (string file)
+		{
+			Project tempProject = CreateSingleFileProject (file);
+			if (tempProject != null) {
+				IAsyncOperation aop = Debug (tempProject);
+				ProjectOperationHandler h = new ProjectOperationHandler ();
+				h.Project = tempProject;
+				aop.Completed += new OperationHandler (h.Run);
+				return aop;
+			} else {
+				Runtime.MessageService.ShowError(GettextCatalog.GetString (&quot;No runnable executable found.&quot;));
+				return NullAsyncOperation.Failure;
+			}
+		}
+		
 		class ProjectOperationHandler {
 			public Project Project;
 			public void Run (IAsyncOperation op) { Project.Dispose (); }
@@ -368,7 +415,7 @@
 		{
 			Project tempProject = CreateSingleFileProject (file);
 			if (tempProject != null) {
-				IAsyncOperation aop = BuildProject (tempProject);
+				IAsyncOperation aop = Build (tempProject);
 				ProjectOperationHandler h = new ProjectOperationHandler ();
 				h.Project = tempProject;
 				aop.Completed += new OperationHandler (h.Run);
@@ -383,7 +430,7 @@
 		{
 			Project tempProject = CreateSingleFileProject (file);
 			if (tempProject != null) {
-				IAsyncOperation aop = ExecuteProject (tempProject);
+				IAsyncOperation aop = Execute (tempProject);
 				ProjectOperationHandler h = new ProjectOperationHandler ();
 				h.Project = tempProject;
 				aop.Completed += new OperationHandler (h.Run);
@@ -394,72 +441,37 @@
 			}
 		}
 	
-		public IAsyncOperation BuildActiveCombine ()
+		public IAsyncOperation Rebuild (CombineEntry entry)
 		{
 			if (openCombine == null) return NullAsyncOperation.Success;
 			if (currentBuildOperation != null &amp;&amp; !currentBuildOperation.IsCompleted) return currentBuildOperation;
-			
-			DoBeforeCompileAction();
-			
-			IProgressMonitor monitor = Runtime.TaskService.GetBuildProgressMonitor ();			
-			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (BuildActiveCombineAsync), monitor);
-			currentBuildOperation = monitor.AsyncOperation;
-			return currentBuildOperation;
+
+			entry.Clean ();
+			return Build (entry);
 		}
 		
-		void BuildActiveCombineAsync (object ob)
+		public IAsyncOperation Build (CombineEntry entry)
 		{
-			IProgressMonitor monitor = (IProgressMonitor) ob;
-			try {
-				BeginBuild ();
-				ICompilerResult result = openCombine.Build (monitor);
-				BuildDone (monitor, result);
-			} catch (Exception ex) {
-				monitor.ReportError (GettextCatalog.GetString (&quot;Build failed.&quot;), ex);
-			} finally {
-				monitor.Dispose ();
-			}
-		}
-		
-		public IAsyncOperation RebuildActiveCombine()
-		{
 			if (openCombine == null) return NullAsyncOperation.Success;
-			openCombine.Clean ();
-			return BuildActiveCombine ();
-		}
-		
-		public IAsyncOperation BuildActiveProject ()
-		{
-			if (CurrentSelectedProject == null) {
-				Runtime.MessageService.ShowError (GettextCatalog.GetString (&quot;Active project not set.&quot;));
-				return NullAsyncOperation.Failure;
-			}
+			if (currentBuildOperation != null &amp;&amp; !currentBuildOperation.IsCompleted) return currentBuildOperation;
+			
+			BeforeCompile (entry);
 				
-			return BuildProject (CurrentSelectedProject);
-		}
-		
-		public IAsyncOperation RebuildActiveProject ()
-		{
-			return RebuildProject (CurrentSelectedProject);
-		}
-		
-		public IAsyncOperation BuildProject (Project project)
-		{
-			BeforeCompile (project);
 			IProgressMonitor monitor = Runtime.TaskService.GetBuildProgressMonitor ();
-			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (BuildProjectAsync), new object[] {project, monitor});
-			return monitor.AsyncOperation;
+			Runtime.DispatchService.ThreadDispatch (new StatefulMessageHandler (BuildCombineEntryAsync), new object[] {entry, monitor});
+			currentBuildOperation = monitor.AsyncOperation;
+			return currentBuildOperation;
 		}
 		
-		public void BuildProjectAsync (object ob)
+		public void BuildCombineEntryAsync (object ob)
 		{
 			object[] data = (object[]) ob;
-			Project project = (Project) data [0];
+			CombineEntry entry = (CombineEntry) data [0];
 			IProgressMonitor monitor = (IProgressMonitor) data [1];
 			ICompilerResult result = null;
 			try {
 				BeginBuild ();
-				result = project.Build (monitor);
+				result = entry.Build (monitor);
 				BuildDone (monitor, result);
 			} catch (Exception ex) {
 				monitor.ReportError (GettextCatalog.GetString (&quot;Build failed.&quot;), ex);
@@ -468,12 +480,6 @@
 			}
 		}
 		
-		public IAsyncOperation RebuildProject (Project project)
-		{
-			project.Clean ();
-			return BuildProject (project);
-		}
-		
 		void BeginBuild ()
 		{
 			Runtime.TaskService.ClearTasks();
@@ -503,21 +509,24 @@
 			OnEndBuild (lastResult.FailedBuildCount == 0);
 		}
 		
-		void BeforeCompile (Project project)
+		void BeforeCompile (CombineEntry entry)
 		{
 			DoBeforeCompileAction();
 			
-			// cut&amp;pasted from CombineEntry.cs
-			Runtime.StringParserService.Properties[&quot;Project&quot;] = project.Name;
-			
-			string outputDir = ((AbstractProjectConfiguration)project.ActiveConfiguration).OutputDirectory;
-			try {
-				DirectoryInfo directoryInfo = new DirectoryInfo(outputDir);
-				if (!directoryInfo.Exists) {
-					directoryInfo.Create();
+			if (entry is Project) {
+				Project project = (Project) entry;
+				
+				Runtime.StringParserService.Properties[&quot;Project&quot;] = project.Name;
+				
+				string outputDir = ((AbstractProjectConfiguration)project.ActiveConfiguration).OutputDirectory;
+				try {
+					DirectoryInfo directoryInfo = new DirectoryInfo(outputDir);
+					if (!directoryInfo.Exists) {
+						directoryInfo.Create();
+					}
+				} catch (Exception e) {
+					throw new ApplicationException(&quot;Can't create project output directory &quot; + outputDir + &quot; original exception:\n&quot; + e.ToString());
 				}
-			} catch (Exception e) {
-				throw new ApplicationException(&quot;Can't create project output directory &quot; + outputDir + &quot; original exception:\n&quot; + e.ToString());
 			}
 		}
 		
@@ -553,7 +562,7 @@
 					}
 					break;
 				default:
-					Debug.Assert(false);
+					System.Diagnostics.Debug.Assert(false);
 					break;
 			}
 		}
@@ -633,7 +642,7 @@
 
 		void CheckFileRename(object sender, FileEventArgs e)
 		{
-			Debug.Assert(e.SourceFile != e.TargetFile);
+			System.Diagnostics.Debug.Assert(e.SourceFile != e.TargetFile);
 			if (openCombine != null) {
 				if (e.IsDirectory) {
 					RenameDirectoryInAllProjects(e.SourceFile, e.TargetFile);
@@ -643,6 +652,165 @@
 			}
 		}
 		
+		public void Deploy (Project project)
+		{
+			foreach (IViewContent viewContent in WorkbenchSingleton.Workbench.ViewContentCollection) {
+				if (viewContent.IsDirty) {
+					viewContent.Save();
+				}
+			}
+			DeployInformation.Deploy (project);
+		}
+
+		public void ShowOptions (CombineEntry entry)
+		{
+			if (entry is Project) {
+				Project selectedProject = (Project) entry;
+				
+				IAddInTreeNode generalOptionsNode          = AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/ProjectOptions/GeneralOptions&quot;);
+				IAddInTreeNode configurationPropertiesNode = AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/ProjectOptions/ConfigurationProperties&quot;);
+				
+				ProjectOptionsDialog optionsDialog = new ProjectOptionsDialog(selectedProject, generalOptionsNode, configurationPropertiesNode);
+				if (optionsDialog.Run() == (int)Gtk.ResponseType.Ok) {
+					selectedProject.NeedsBuilding = true;
+				}
+			} else if (entry is Combine) {
+				Combine combine = (Combine) entry;
+				
+				DefaultProperties defaultProperties = new DefaultProperties();
+				defaultProperties.SetProperty (&quot;Combine&quot;, combine);
+				TreeViewOptions optionsDialog = new TreeViewOptions (defaultProperties,
+																		   AddInTreeSingleton.AddInTree.GetTreeNode(&quot;/SharpDevelop/Workbench/CombineOptions&quot;));
+			//		optionsDialog.SetDefaultSize = new Size(700, 450);
+			//		optionsDialog.FormBorderStyle = FormBorderStyle.FixedDialog;
+			//				
+			//		optionsDialog.TransientFor = (Gtk.Window)WorkbenchSingleton.Workbench;
+					optionsDialog.Run ();
+			//		optionsDialog.Hide ();
+			}
+			
+			SaveCombine ();
+		}
+		
+		public CombineEntry CreateProject (Combine parentCombine)
+		{
+			return CreateCombineEntry (parentCombine, false);
+		}
+		
+		public CombineEntry CreateCombine (Combine parentCombine)
+		{
+			return CreateCombineEntry (parentCombine, true);
+		}
+		
+		CombineEntry CreateCombineEntry (Combine parentCombine, bool createCombine)
+		{
+			CombineEntry res = null;
+			NewProjectDialog npdlg = new NewProjectDialog (createCombine);
+			if (npdlg.Run () == (int) Gtk.ResponseType.Ok) {
+				IProgressMonitor monitor = Runtime.TaskService.GetLoadProgressMonitor ();
+				try {
+					if (createCombine)
+						res = parentCombine.AddEntry (npdlg.NewCombineLocation, monitor);
+					else
+						res = parentCombine.AddEntry (npdlg.NewProjectLocation, monitor);
+				}
+				catch {
+					Runtime.MessageService.ShowError (string.Format (GettextCatalog.GetString (&quot;The file '{0}' could not be loaded.&quot;), npdlg.NewProjectLocation));
+					res = null;
+				}
+				monitor.Dispose ();
+			}
+			
+			npdlg = null;
+
+			if (res != null)
+				SaveCombine ();
+
+			return res;
+		}
+
+		public CombineEntry AddCombineEntry (Combine parentCombine)
+		{
+			CombineEntry res = null;
+			
+			using (FileSelector fdiag = new FileSelector (GettextCatalog.GetString (&quot;Add to Solution&quot;))) {
+				fdiag.SelectMultiple = false;
+				if (fdiag.Run () == (int) Gtk.ResponseType.Ok) {
+					try {
+						using (IProgressMonitor monitor = Runtime.TaskService.GetLoadProgressMonitor ()) {
+							res = parentCombine.AddEntry (fdiag.Filename, monitor);
+						}
+					}
+					catch {
+						Runtime.MessageService.ShowError (string.Format (GettextCatalog.GetString (&quot;The file '{0}' could not be loaded.&quot;), fdiag.Filename));
+					}
+				}
+
+				fdiag.Hide ();
+			}
+			if (res != null)
+				SaveCombine ();
+
+			return res;
+		}
+		
+		public ProjectFile CreateProjectFile (Project parentProject, string basePath)
+		{
+			NewFileDialog nfd = new NewFileDialog ();
+			int res = nfd.Run ();
+			nfd.Dispose ();
+			if (res != (int) Gtk.ResponseType.Ok) return null;
+			
+			IWorkbenchWindow window = WorkbenchSingleton.Workbench.ActiveWorkbenchWindow;
+			int count = 1;
+				
+			string baseName  = Path.GetFileNameWithoutExtension(window.ViewContent.UntitledName);
+			string extension = Path.GetExtension(window.ViewContent.UntitledName);
+				
+			// first try the default untitled name of the viewcontent filename
+			string fileName = Path.Combine (basePath, baseName +  extension);
+				
+			// if it is already in the project, or it does exists we try to get a name that is
+			// untitledName + Numer + extension
+			while (parentProject.IsFileInProject (fileName) || System.IO.File.Exists (fileName)) {
+				fileName = Path.Combine (basePath, baseName + count.ToString() + extension);
+				++count;
+			}
+
+			// now we have a valid filename which we could use
+			window.ViewContent.Save (fileName);
+				
+			ProjectFile newFileInformation = new ProjectFile(fileName, BuildAction.Compile);
+			parentProject.ProjectFiles.Add (newFileInformation);
+			return newFileInformation;
+		}
+
+		public bool AddReferenceToProject (Project project)
+		{
+			bool res = false;
+			
+			SelectReferenceDialog selDialog = new SelectReferenceDialog(project);
+			if (selDialog.Run() == (int)Gtk.ResponseType.Ok) {
+				ProjectReferenceCollection newRefs = selDialog.ReferenceInformations;
+				
+				ArrayList toDelete = new ArrayList ();
+				foreach (ProjectReference refInfo in project.ProjectReferences)
+					if (!newRefs.Contains (refInfo))
+						toDelete.Add (refInfo);
+				
+				foreach (ProjectReference refInfo in toDelete)
+						project.ProjectReferences.Remove (refInfo);
+
+				foreach (ProjectReference refInfo in selDialog.ReferenceInformations)
+					if (!project.ProjectReferences.Contains (refInfo))
+						project.ProjectReferences.Add(refInfo);
+				
+				res = true;
+			}
+			selDialog.Hide ();
+			return res;
+		}
+		
 		public override void InitializeService()
 		{
 			base.InitializeService();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002074.html">[Monodevelop-patches-list] r2473 - in trunk/MonoDevelop/Core/src/MonoDevelop.Base: . Gui/Dialogs
</A></li>
	<LI>Next message: <A HREF="002076.html">[Monodevelop-patches-list] r2475 - in trunk/MonoDevelop/Core/src/AddIns/DisplayBindings/SourceEditor: . Commands Gui Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2075">[ date ]</a>
              <a href="thread.html#2075">[ thread ]</a>
              <a href="subject.html#2075">[ subject ]</a>
              <a href="author.html#2075">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
