<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2435 - trunk/MonoDevelop/Extras/MonoDeveloperExtensions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2435%20-%20trunk/MonoDevelop/Extras/MonoDeveloperExtensions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002035.html">
   <LINK REL="Next"  HREF="002037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2435 - trunk/MonoDevelop/Extras/MonoDeveloperExtensions</H1>
    <B>Lluis Sanchez &lt;lluis@ximian.com&gt;</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2435%20-%20trunk/MonoDevelop/Extras/MonoDeveloperExtensions&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2435 - trunk/MonoDevelop/Extras/MonoDeveloperExtensions">lluis at mono-cvs.ximian.com
       </A><BR>
    <I>Wed Apr  6 20:09:39 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002035.html">[Monodevelop-patches-list] r2434 - in trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn: . Gui
</A></li>
        <LI>Next message: <A HREF="002037.html">[Monodevelop-patches-list] r2436 - trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2036">[ date ]</a>
              <a href="thread.html#2036">[ thread ]</a>
              <a href="subject.html#2036">[ subject ]</a>
              <a href="author.html#2036">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: lluis
Date: 2005-04-06 20:09:39 -0400 (Wed, 06 Apr 2005)
New Revision: 2435

Modified:
   trunk/MonoDevelop/Extras/MonoDeveloperExtensions/ChangeLog
   trunk/MonoDevelop/Extras/MonoDeveloperExtensions/MonoProject.cs
Log:
2005-05-07  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;

	* MonoProject.cs: Update the sources file when files are renamed.
	Don't add the ChangeLog file to the project for now, it's too slow
	to look for it.



Modified: trunk/MonoDevelop/Extras/MonoDeveloperExtensions/ChangeLog
===================================================================
--- trunk/MonoDevelop/Extras/MonoDeveloperExtensions/ChangeLog	2005-04-07 00:08:56 UTC (rev 2434)
+++ trunk/MonoDevelop/Extras/MonoDeveloperExtensions/ChangeLog	2005-04-07 00:09:39 UTC (rev 2435)
@@ -1,3 +1,9 @@
+2005-05-07  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
+
+	* MonoProject.cs: Update the sources file when files are renamed.
+	Don't add the ChangeLog file to the project for now, it's too slow
+	to look for it.
+
 2005-02-12  Lluis Sanchez Gual  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">lluis at novell.com</A>&gt;
 
 	* MonoProject.cs: Don't try to parse errors from the stdout, only

Modified: trunk/MonoDevelop/Extras/MonoDeveloperExtensions/MonoProject.cs
===================================================================
--- trunk/MonoDevelop/Extras/MonoDeveloperExtensions/MonoProject.cs	2005-04-07 00:08:56 UTC (rev 2434)
+++ trunk/MonoDevelop/Extras/MonoDeveloperExtensions/MonoProject.cs	2005-04-07 00:09:39 UTC (rev 2435)
@@ -86,11 +86,11 @@
 			
 			sr.Close ();
 			
-			ArrayList files = new ArrayList ();
+/*			ArrayList files = new ArrayList ();
 			FindFiles (basePath, &quot;ChangeLog&quot;, files);
 			foreach (string file in files)
 				ProjectFiles.Add (new ProjectFile (file, BuildAction.Exclude));
-			
+*/			
 			// Project references
 			string refs = mkfile.GetVariable (&quot;LIB_MCS_FLAGS&quot;);
 			if (refs == null || refs == &quot;&quot;) refs = mkfile.GetVariable (&quot;LOCAL_MCS_FLAGS&quot;);
@@ -216,7 +216,35 @@
 			
 			if (e.ProjectFile.BuildAction != BuildAction.Compile)
 				return;
+			
+			AddSourceFile (e.ProjectFile.Name);
+		}
+		
+		protected override void OnFileRemovedFromProject (ProjectFileEventArgs e)
+		{
+			base.OnFileRemovedFromProject (e);
+			if (loading) return;
+			
+			if (e.ProjectFile.BuildAction != BuildAction.Compile)
+				return;
 
+			RemoveSourceFile (e.ProjectFile.Name);
+		}
+		
+ 		protected override void OnFileRenamedInProject (ProjectFileRenamedEventArgs e)
+		{
+			base.OnFileRenamedInProject (e);
+			
+			if (loading) return;
+			if (e.ProjectFile.BuildAction != BuildAction.Compile)
+				return;
+				
+			if (RemoveSourceFile (e.OldName))
+				AddSourceFile (e.NewName);
+		}
+
+		void AddSourceFile (string sourceFile)
+		{
 			StreamReader sr = null;
 			StreamWriter sw = null;
 			
@@ -224,7 +252,7 @@
 				sr = new StreamReader (outFile + &quot;.sources&quot;);
 				sw = new StreamWriter (outFile + &quot;.sources.new&quot;);
 
-				string newFile = GetRelativeChildPath (e.ProjectFile.Name);
+				string newFile = GetRelativeChildPath (sourceFile);
 				if (newFile.StartsWith (&quot;./&quot;)) newFile = newFile.Substring (2);
 				
 				string line;
@@ -246,22 +274,17 @@
 			File.Move (outFile + &quot;.sources.new&quot;, outFile + &quot;.sources&quot;);
 		}
 		
-		protected override void OnFileRemovedFromProject (ProjectFileEventArgs e)
+		bool RemoveSourceFile (string sourceFile)
 		{
-			base.OnFileRemovedFromProject (e);
-			if (loading) return;
-			
-			if (e.ProjectFile.BuildAction != BuildAction.Compile)
-				return;
-
 			StreamReader sr = null;
 			StreamWriter sw = null;
-			
+			bool found = false;
+
 			try {
 				sr = new StreamReader (outFile + &quot;.sources&quot;);
 				sw = new StreamWriter (outFile + &quot;.sources.new&quot;);
 
-				string oldFile = GetRelativeChildPath (e.ProjectFile.Name);
+				string oldFile = GetRelativeChildPath (sourceFile);
 				if (oldFile.StartsWith (&quot;./&quot;)) oldFile = oldFile.Substring (2);
 				
 				string line;
@@ -269,13 +292,18 @@
 					string file = line.Trim (' ','\t');
 					if (oldFile != file)
 						sw.WriteLine (line);
+					else
+						found = true;
 				}
 			} finally {
 				if (sr != null) sr.Close ();
 				if (sw != null) sw.Close ();
 			}
-			File.Delete (outFile + &quot;.sources&quot;);
-			File.Move (outFile + &quot;.sources.new&quot;, outFile + &quot;.sources&quot;);
+			if (found) {
+				File.Delete (outFile + &quot;.sources&quot;);
+				File.Move (outFile + &quot;.sources.new&quot;, outFile + &quot;.sources&quot;);
+			}
+			return found;
 		}
 		
 		public override void GenerateMakefiles (Combine parentCombine)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002035.html">[Monodevelop-patches-list] r2434 - in trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn: . Gui
</A></li>
	<LI>Next message: <A HREF="002037.html">[Monodevelop-patches-list] r2436 - trunk/MonoDevelop/Core/src/AddIns/DebuggerAddIn
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2036">[ date ]</a>
              <a href="thread.html#2036">[ thread ]</a>
              <a href="subject.html#2036">[ subject ]</a>
              <a href="author.html#2036">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
