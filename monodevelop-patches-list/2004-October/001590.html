<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r1986 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File Services/Project
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1986%20-%20in%20trunk/MonoDevelop/Core/src/Main/Base%3A%20.%20Commands%20Services/File%20Services/Project&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001589.html">
   <LINK REL="Next"  HREF="001591.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r1986 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File Services/Project</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r1986%20-%20in%20trunk/MonoDevelop/Core/src/Main/Base%3A%20.%20Commands%20Services/File%20Services/Project&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r1986 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File Services/Project">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Wed Oct 20 21:27:58 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="001589.html">[Monodevelop-patches-list] r1985 - in trunk/MonoDevelop/Core/src/Main/Base: . Services/File
</A></li>
        <LI>Next message: <A HREF="001591.html">[Monodevelop-patches-list] r1987 - trunk/MonoDevelop/Core/src/AddIns/Misc/StartPage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1590">[ date ]</a>
              <a href="thread.html#1590">[ thread ]</a>
              <a href="subject.html#1590">[ subject ]</a>
              <a href="author.html#1590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jluke
Date: 2004-10-20 21:27:57 -0400 (Wed, 20 Oct 2004)
New Revision: 1986

Modified:
   trunk/MonoDevelop/Core/src/Main/Base/ChangeLog
   trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs
   trunk/MonoDevelop/Core/src/Main/Base/Commands/FileCommands.cs
   trunk/MonoDevelop/Core/src/Main/Base/Commands/MenuItemBuilders.cs
   trunk/MonoDevelop/Core/src/Main/Base/Services/File/DefaultFileService.cs
   trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs
   trunk/MonoDevelop/Core/src/Main/Base/Services/Project/DefaultProjectService.cs
Log:
2004-10-20  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;

        * Commands/MenuItemBuilders.cs:
        * Commands/FileCommands.cs:
        * Commands/AutostartCommands.cs:
        * Services/File/RecentOpen.cs:
        * Services/File/DefaultFileService.cs:
        * Services/Project/DefaultProjectService.cs: enable new Recent Files stuff,
        and small adjustments for it.



Modified: trunk/MonoDevelop/Core/src/Main/Base/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/ChangeLog	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/ChangeLog	2004-10-21 01:27:57 UTC (rev 1986)
@@ -1,5 +1,15 @@
 2004-10-20  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
 
+	* Commands/MenuItemBuilders.cs:
+	* Commands/FileCommands.cs:
+	* Commands/AutostartCommands.cs:
+	* Services/File/RecentOpen.cs:
+	* Services/File/DefaultFileService.cs:
+	* Services/Project/DefaultProjectService.cs: enable new Recent Files stuff,
+	and small adjustments for it.
+
+2004-10-20  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
+
 	* Services/File/RecentFiles.cs: fix a bunch of bugs
 
 2004-10-20  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;

Modified: trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -62,7 +62,7 @@
 				object recentOpenObj = propertyService.GetProperty(&quot;MonoDevelop.Gui.MainWindow.RecentOpen&quot;);
 				if (recentOpenObj is MonoDevelop.Services.RecentOpen) {
 					MonoDevelop.Services.RecentOpen recOpen = (MonoDevelop.Services.RecentOpen)recentOpenObj;
-					if (recOpen.RecentProject.Count &gt; 0) { 
+					if (recOpen.RecentProject != null &amp;&amp; recOpen.RecentProject.Length &gt; 0) { 
 						projectService.OpenCombine(recOpen.RecentProject[0].ToString());
 					}
 				}

Modified: trunk/MonoDevelop/Core/src/Main/Base/Commands/FileCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Commands/FileCommands.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Commands/FileCommands.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -395,7 +395,7 @@
 				IFileService fileService = (IFileService)MonoDevelop.Core.Services.ServiceManager.GetService(typeof(IFileService));
 				IMessageService messageService = (IMessageService) MonoDevelop.Core.Services.ServiceManager.GetService(typeof(IMessageService));
 				
-				if (fileService.RecentOpen.RecentFile != null &amp;&amp; fileService.RecentOpen.RecentFile.Count &gt; 0 &amp;&amp; messageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent files list?&quot;), GettextCatalog.GetString (&quot;Clear recent files&quot;)))
+				if (fileService.RecentOpen.RecentFile != null &amp;&amp; fileService.RecentOpen.RecentFile.Length &gt; 0 &amp;&amp; messageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent files list?&quot;), GettextCatalog.GetString (&quot;Clear recent files&quot;)))
 				{
 					fileService.RecentOpen.ClearRecentFiles();
 				}
@@ -411,7 +411,7 @@
 				IFileService fileService = (IFileService)MonoDevelop.Core.Services.ServiceManager.GetService(typeof(IFileService));
 				IMessageService messageService = (IMessageService) MonoDevelop.Core.Services.ServiceManager.GetService(typeof(IMessageService));
 				
-				if (fileService.RecentOpen.RecentProject != null &amp;&amp; fileService.RecentOpen.RecentProject.Count &gt; 0 &amp;&amp; messageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent projects list?&quot;), GettextCatalog.GetString (&quot;Clear recent projects&quot;)))
+				if (fileService.RecentOpen.RecentProject != null &amp;&amp; fileService.RecentOpen.RecentProject.Length &gt; 0 &amp;&amp; messageService.AskQuestion(GettextCatalog.GetString (&quot;Are you sure you want to clear recent projects list?&quot;), GettextCatalog.GetString (&quot;Clear recent projects&quot;)))
 				{
 					fileService.RecentOpen.ClearRecentProjects();
 				}

Modified: trunk/MonoDevelop/Core/src/Main/Base/Commands/MenuItemBuilders.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Commands/MenuItemBuilders.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Commands/MenuItemBuilders.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -52,10 +52,10 @@
 			
 			RecentOpen recentOpen = fileService.RecentOpen;
 			
-			if (recentOpen.RecentFile.Count &gt; 0) {
-				RFMItem[] items = new RFMItem[recentOpen.RecentFile.Count];
+			if (recentOpen.RecentFile != null &amp;&amp; recentOpen.RecentFile.Length &gt; 0) {
+				RFMItem[] items = new RFMItem[recentOpen.RecentFile.Length];
 				
-				for (int i = 0; i &lt; recentOpen.RecentFile.Count; ++i) {
+				for (int i = 0; i &lt; recentOpen.RecentFile.Length; ++i) {
 					string accelaratorKeyPrefix = i &lt; 10 ? &quot;&amp;&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
 					items[i] = new RFMItem(null, null, accelaratorKeyPrefix + recentOpen.RecentFile[i].ToString().Replace (&quot;_&quot;, &quot;__&quot;), new EventHandler(LoadRecentFile));
 					items[i].Tag = recentOpen.RecentFile[i].ToString();
@@ -93,9 +93,9 @@
 			
 			RecentOpen recentOpen = fileService.RecentOpen;
 			
-			if (recentOpen.RecentProject.Count &gt; 0) {
-				RPMItem[] items = new RPMItem[recentOpen.RecentProject.Count];
-				for (int i = 0; i &lt; recentOpen.RecentProject.Count; ++i) {
+			if (recentOpen.RecentProject != null &amp;&amp; recentOpen.RecentProject.Length &gt; 0) {
+				RPMItem[] items = new RPMItem[recentOpen.RecentProject.Length];
+				for (int i = 0; i &lt; recentOpen.RecentProject.Length; ++i) {
 					string accelaratorKeyPrefix = i &lt; 10 ? &quot;&amp;&quot; + ((i + 1) % 10).ToString() + &quot; &quot; : &quot;&quot;;
 					items[i] = new RPMItem(null, null, accelaratorKeyPrefix + recentOpen.RecentProject[i].ToString().Replace (&quot;_&quot;, &quot;__&quot;), new EventHandler(LoadRecentProject));
 					items[i].Tag = recentOpen.RecentProject[i].ToString();

Modified: trunk/MonoDevelop/Core/src/Main/Base/Services/File/DefaultFileService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Services/File/DefaultFileService.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Services/File/DefaultFileService.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -12,13 +12,10 @@
 using System.Xml;
 
 using MonoDevelop.Core.AddIns;
-
 using MonoDevelop.Core.Services;
-
 using MonoDevelop.Internal.Project;
 using MonoDevelop.Gui;
 using MonoDevelop.Core.AddIns.Codons;
-
 using MonoDevelop.Gui.Utils;
 
 namespace MonoDevelop.Services
@@ -37,10 +34,8 @@
 		
 		public RecentOpen RecentOpen {
 			get {
-				if (recentOpen == null) {
-					PropertyService propertyService = (PropertyService)ServiceManager.GetService(typeof(PropertyService));
-					recentOpen = (RecentOpen)propertyService.GetProperty(&quot;MonoDevelop.Gui.MainWindow.RecentOpen&quot;, new RecentOpen());
-				}
+				if (recentOpen == null)
+					recentOpen = new RecentOpen ();
 				return recentOpen;
 			}
 		}
@@ -116,6 +111,10 @@
 				return;
 
 			string origName = fileName;
+
+			if (fileName.StartsWith (&quot;<A HREF="file://&quot;">file://&quot;</A>))
+				fileName = fileName.Substring (7);
+
 			if (!fileName.StartsWith (&quot;<A HREF="http://&quot;">http://&quot;</A>))
 				fileName = System.IO.Path.GetFullPath (fileName);
 			

Modified: trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -12,38 +12,38 @@
 using System.IO;
 
 using MonoDevelop.Core.Properties;
-
+using MonoDevelop.Gui.Utils;
 using MonoDevelop.Services;
+using Freedesktop.RecentFiles;
 
 namespace MonoDevelop.Services
 {
 	/// &lt;summary&gt;
-	/// This class handles the recent open files and the recent open project files of SharpDevelop
-	/// it checks, if the files exists at every creation, and if not it doesn't list them in the 
-	/// recent files, and they'll not be saved during the next option save.
+	/// This class handles the recent open files and the recent open project files of MonoDevelop
 	/// &lt;/summary&gt;
-	public class RecentOpen : IXmlConvertable
+	public class RecentOpen
 	{
 		/// &lt;summary&gt;
 		/// This variable is the maximal length of lastfile/lastopen entries
 		/// must be &gt; 0
 		/// &lt;/summary&gt;
-		int MAX_LENGTH = 10;
+		const int MAX_LENGTH = 10;
 		
-		ArrayList lastfile    = new ArrayList();
-		ArrayList lastproject = new ArrayList();
+		RecentItem[] lastfile;
+		RecentItem[] lastproject;
+		RecentFiles recentFiles;
 		
 		public event EventHandler RecentFileChanged;
 		public event EventHandler RecentProjectChanged;
 		
-		public ArrayList RecentFile {
+		public RecentItem[] RecentFile {
 			get {
 				Debug.Assert(lastfile != null, &quot;RecentOpen : set string[] LastFile (value == null)&quot;);
 				return lastfile;
 			}
 		}
 
-		public ArrayList RecentProject {
+		public RecentItem[] RecentProject {
 			get {
 				Debug.Assert(lastproject != null, &quot;RecentOpen : set string[] LastProject (value == null)&quot;);
 				return lastproject;
@@ -66,134 +66,84 @@
 
 		public RecentOpen()
 		{
+			recentFiles = RecentFiles.GetInstance ();
+			UpdateLastFile ();
+			UpdateLastProject ();
 		}
 		
-		public RecentOpen(XmlElement element)
+		public void AddLastFile (string name)
 		{
-			XmlNodeList nodes = element[&quot;FILES&quot;].ChildNodes;
-			
-			for (int i = 0; i &lt; nodes.Count; ++i) {
-				if (File.Exists(nodes[i].InnerText)) {
-					lastfile.Add(nodes[i].InnerText);
+			if (lastfile != null &amp;&amp; lastfile.Length &gt;= MAX_LENGTH)
+			{
+				RecentItem oldestItem = lastfile[0];
+				for (int i = 1; i &lt; lastfile.Length - 1; i ++)
+				{
+					// the lowest number is the oldest
+					if (lastfile[i].Timestamp &lt; oldestItem.Timestamp)
+						oldestItem = lastfile[i];
 				}
+				recentFiles.RemoveItem (oldestItem);
 			}
-			
-			nodes  = element[&quot;PROJECTS&quot;].ChildNodes;
-			
-			for (int i = 0; i &lt; nodes.Count; ++i) {
-				if (File.Exists(nodes[i].InnerText)) {
-					lastproject.Add(nodes[i].InnerText);
-				}
-			}
+
+			recentFiles.AddItem (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Files&quot;));
+			UpdateLastFile ();
 		}
 		
-		public void AddLastFile(string name) // TODO : improve 
-		{
-			for (int i = 0; i &lt; lastfile.Count; ++i) {
-				if (lastfile[i].ToString() == name) {
-					lastfile.RemoveAt(i);
-				}
-			}
-			
-			while (lastfile.Count &gt;= MAX_LENGTH) {
-				lastfile.RemoveAt(lastfile.Count - 1);
-			}
-			
-			if (lastfile.Count &gt; 0) {
-				lastfile.Insert(0, name);
-			} else {
-				lastfile.Add(name);
-			}
-			
-			OnRecentFileChange();
-		}
-		
 		public void ClearRecentFiles()
 		{
-			lastfile.Clear();
-			
+			lastfile = null;
+			recentFiles.ClearGroup (&quot;MonoDevelop Files&quot;);
 			OnRecentFileChange();
 		}
 		
 		public void ClearRecentProjects()
 		{
-			lastproject.Clear();
-			
+			lastproject = null;
+			recentFiles.ClearGroup (&quot;MonoDevelop Projects&quot;);
 			OnRecentProjectChange();
 		}
 		
-		public void AddLastProject(string name) // TODO : improve
+		public void AddLastProject (string name)
 		{
-			for (int i = 0; i &lt; lastproject.Count; ++i) {
-				if (lastproject[i].ToString() == name) {
-					lastproject.RemoveAt(i);
+			if (lastproject != null &amp;&amp; lastproject.Length &gt;= MAX_LENGTH)
+			{
+				RecentItem oldestItem = lastproject[0];
+				for (int i = 1; i &lt; lastproject.Length; i ++)
+				{
+					// the lowest number is the oldest
+					if (lastproject[i].Timestamp &lt; oldestItem.Timestamp)
+						oldestItem = lastproject[i];
 				}
+				recentFiles.RemoveItem (oldestItem);
 			}
-			
-			while (lastproject.Count &gt;= MAX_LENGTH) {
-				lastproject.RemoveAt(lastproject.Count - 1);
-			}
-			
-			if (lastproject.Count &gt; 0) {
-				lastproject.Insert(0, name);
-			} else {
-				lastproject.Add(name);			
-			}
-			OnRecentProjectChange();
+
+			recentFiles.AddItem (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Projects&quot;));
+			UpdateLastProject ();
 		}
 		
-		public object FromXmlElement(XmlElement element)
+		public void FileRemoved(object sender, FileEventArgs e)
 		{
-			return new RecentOpen(element);
+			recentFiles.RemoveItem (new Uri (e.FileName));
+			UpdateLastFile ();
 		}
 		
-		public XmlElement ToXmlElement(XmlDocument doc)
+		public void FileRenamed(object sender, FileEventArgs e)
 		{
-			XmlElement recent = doc.CreateElement(&quot;RECENT&quot;);
-			
-			XmlElement lastfiles = doc.CreateElement(&quot;FILES&quot;);
-			foreach (string file in lastfile) {
-				XmlElement element = doc.CreateElement(&quot;FILE&quot;);
-				element.InnerText  = file;
-				lastfiles.AppendChild(element);
-			}
-			
-			XmlElement lastprojects = doc.CreateElement(&quot;PROJECTS&quot;);
-			foreach (string project in lastproject) {
-				XmlElement element = doc.CreateElement(&quot;PROJECT&quot;);
-				element.InnerText = project;
-				lastprojects.AppendChild(element);
-			}
-			
-			recent.AppendChild(lastfiles);
-			recent.AppendChild(lastprojects);
-			
-			return recent;
+			recentFiles.RenameItem (new Uri (e.FileName), new Uri (e.TargetFile));
+			UpdateLastFile ();
 		}
-		
-		public void FileRemoved(object sender, FileEventArgs e)
+
+		void UpdateLastFile ()
 		{
-			for (int i = 0; i &lt; lastfile.Count; ++i) {
-				string file = lastfile[i].ToString();
-				if (e.FileName == file) {
-					lastfile.RemoveAt(i);
-					OnRecentFileChange();
-					break;
-				}
-			}
+			lastfile = recentFiles.GetItemsInGroup (&quot;MonoDevelop Files&quot;);
+			OnRecentFileChange();
 		}
-		
-		public void FileRenamed(object sender, FileEventArgs e)
+
+		void UpdateLastProject ()
 		{
-			for (int i = 0; i &lt; lastfile.Count; ++i) {
-				string file = lastfile[i].ToString();
-				if (e.SourceFile == file) {
-					lastfile.RemoveAt(i);
-					lastfile.Insert(i, e.TargetFile);
-					OnRecentFileChange();
-					break;
-				}
-			}
+			lastproject = recentFiles.GetItemsInGroup (&quot;MonoDevelop Projects&quot;);
+			OnRecentFileChange();
 		}
 	}
 }
+

Modified: trunk/MonoDevelop/Core/src/Main/Base/Services/Project/DefaultProjectService.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Services/Project/DefaultProjectService.cs	2004-10-20 18:45:32 UTC (rev 1985)
+++ trunk/MonoDevelop/Core/src/Main/Base/Services/Project/DefaultProjectService.cs	2004-10-21 01:27:57 UTC (rev 1986)
@@ -128,6 +128,9 @@
 				SaveCombine();
 				CloseCombine();
 			}
+
+			if (filename.StartsWith (&quot;<A HREF="file://&quot;">file://&quot;</A>))
+				filename = filename.Substring (7);
 				
 			if (!fileUtilityService.TestFileExists(filename)) {
 				return;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001589.html">[Monodevelop-patches-list] r1985 - in trunk/MonoDevelop/Core/src/Main/Base: . Services/File
</A></li>
	<LI>Next message: <A HREF="001591.html">[Monodevelop-patches-list] r1987 - trunk/MonoDevelop/Core/src/AddIns/Misc/StartPage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1590">[ date ]</a>
              <a href="thread.html#1590">[ thread ]</a>
              <a href="subject.html#1590">[ subject ]</a>
              <a href="author.html#1590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
