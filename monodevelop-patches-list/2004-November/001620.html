<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-patches-list] r2016 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2016%20-%20in%20trunk/MonoDevelop/Core/src/Main/Base%3A%20.%20Commands%20Services/File&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001619.html">
   <LINK REL="Next"  HREF="001621.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-patches-list] r2016 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File</H1>
    <B>commit-watcher at mono-cvs.ximian.com</B> 
    <A HREF="mailto:monodevelop-patches-list%40lists.ximian.com?Subject=%5BMonodevelop-patches-list%5D%20r2016%20-%20in%20trunk/MonoDevelop/Core/src/Main/Base%3A%20.%20Commands%20Services/File&In-Reply-To="
       TITLE="[Monodevelop-patches-list] r2016 - in trunk/MonoDevelop/Core/src/Main/Base: . Commands Services/File">commit-watcher at mono-cvs.ximian.com
       </A><BR>
    <I>Tue Nov  2 15:06:23 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="001619.html">[Monodevelop-patches-list] r2015 - in trunk/MonoDevelop/Core/src/Main/Base: . Internal/Parser/SharpAssemblyLayer
</A></li>
        <LI>Next message: <A HREF="001621.html">[Monodevelop-patches-list] r2017 - trunk/MonoDevelop/Core/src/Main/Base/Services/File
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: jluke
Date: 2004-11-02 15:06:23 -0500 (Tue, 02 Nov 2004)
New Revision: 2016

Modified:
   trunk/MonoDevelop/Core/src/Main/Base/ChangeLog
   trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs
   trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentFiles.cs
   trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs
Log:
2004-11-02  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;

        * Services/File/RecentOpen.cs: use simpler RecentFiles AddWithLimit
        * Services/File/RecentFiles.cs: sort and return items in the right order
        among some other incremental improvements, should also fix bug #68999
        * Commands/AutoStartCommands.cs: revert Todds workaround from yesterday



Modified: trunk/MonoDevelop/Core/src/Main/Base/ChangeLog
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/ChangeLog	2004-11-02 03:02:12 UTC (rev 2015)
+++ trunk/MonoDevelop/Core/src/Main/Base/ChangeLog	2004-11-02 20:06:23 UTC (rev 2016)
@@ -1,3 +1,10 @@
+2004-11-02  John Luke  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">john.luke at gmail.com</A>&gt;
+
+	* Services/File/RecentOpen.cs: use simpler RecentFiles AddWithLimit
+	* Services/File/RecentFiles.cs: sort and return items in the right order
+	among some other incremental improvements, should also fix bug #68999
+	* Commands/AutoStartCommands.cs: revert Todds workaround from yesterday
+
 2004-11-01	Fawad Halim  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">fawad at fawad.net</A>&gt;
 
 	* Internal/Parser/SharpAssemblyLayer/SharpAssemblyParameter.cs

Modified: trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs	2004-11-02 03:02:12 UTC (rev 2015)
+++ trunk/MonoDevelop/Core/src/Main/Base/Commands/AutostartCommands.cs	2004-11-02 20:06:23 UTC (rev 2016)
@@ -62,7 +62,7 @@
 	                        RecentOpen recentOpen = ((IFileService)MonoDevelop.Core.Services.ServiceManager.GetService (typeof (IFileService))).RecentOpen;
 
 				if (recentOpen.RecentProject != null &amp;&amp; recentOpen.RecentProject.Length &gt; 0) { 
-					projectService.OpenCombine(recentOpen.RecentProject[recentOpen.RecentProject.Length - 1].ToString());
+					projectService.OpenCombine(recentOpen.RecentProject[0].ToString());
 				}
 			}
 			

Modified: trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentFiles.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentFiles.cs	2004-11-02 03:02:12 UTC (rev 2015)
+++ trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentFiles.cs	2004-11-02 20:06:23 UTC (rev 2016)
@@ -30,6 +30,10 @@
 // implementation of the freedesktop.org Recent Files spec
 // <A HREF="http://freedesktop.org/Standards/recent-file-spec/recent-file-spec-0.2.html">http://freedesktop.org/Standards/recent-file-spec/recent-file-spec-0.2.html</A>
 
+// Note: the file may not exist, apps should account for that themselves
+
+// Lets keep things sorted as we go, and reverse before saving it.
+
 namespace Freedesktop.RecentFiles
 {
 	// Currently using XmlSerializer to read/write the recent files list
@@ -59,7 +63,6 @@
         [XmlElement (&quot;RecentItem&quot;)]
         public RecentItem[] RecentItems;
 
-		// FIXME: maybe not write until Save () is called manually
 		public void AddItem (RecentItem item)
 		{
 			if (RecentItems == null)
@@ -96,6 +99,26 @@
 			Save ();
 		}
 
+		// ensure that that only max items are kept in group 
+		public void AddWithLimit (RecentItem item, string group, int max)
+		{
+			if (max &lt; 1)
+				throw new ArgumentException (&quot;max must be &gt; 0&quot;);
+
+			// we add it first in case the Uri is already there
+			AddItem (item);
+
+			// then we adjust for the limit
+			RecentItem[] inGroup = GetItemsInGroup (group);
+			if (inGroup.Length &gt; max)
+			{
+				while (inGroup.Length &gt; max) {
+					RemoveItem (GetOldestItem (inGroup));
+					inGroup = GetItemsInGroup (group);
+				}
+			}
+		}
+
 		public void Clear ()
 		{
 			RecentItems = null;
@@ -130,26 +153,6 @@
 			Save ();
 		}
 
-/*
-		private void ClearMissing ()
-		{
-			ArrayList list = new ArrayList ();
-			foreach (RecentItem ri in RecentItems)
-			{
-				// we cant test !file:// Uris can we?
-				if (!ri.Uri.StartsWith (&quot;<A HREF="file://&quot;">file://&quot;</A>))
-					list.Add (ri);
-				else if (File.Exists (ri.Uri.Substring (7)))
-					list.Add (ri);
-			}
-
-			RecentItem[] items = new RecentItem [list.Count];
-			list.CopyTo (items);
-			RecentItems = items;
-			Save ();
-		}
-*/
-
 		private void EmitChangedEvent ()
 		{
 			if (Changed != null)
@@ -163,6 +166,7 @@
 				XmlTextReader reader = new XmlTextReader (RecentFileStore);
 				RecentFiles rf = (RecentFiles) serializer.Deserialize (reader);
 				reader.Close ();
+				rf.Sort ();
 				return rf;
 			}
 			catch (IOException e)
@@ -183,9 +187,6 @@
 			if (RecentItems == null)
 				return null;
 
-			// disable for now
-			// ClearMissing ();
-
 			ArrayList list = new ArrayList ();
 			foreach (RecentItem ri in RecentItems)
 			{
@@ -201,17 +202,49 @@
 			return items;
 		}
 
+		public RecentItem[] GetMostRecentInGroup (int count, string group)
+		{
+			if (count &lt; 1)
+				throw new ArgumentException (&quot;count must be &gt; 0&quot;);
+
+			RecentItem[] inGroup = GetItemsInGroup (group);
+			return GetMostRecent (count, inGroup);
+		}
+
+		public RecentItem[] GetMostRecent (int count)
+		{
+			if (count &lt; 1)
+				throw new ArgumentException (&quot;count must be &gt; 0&quot;);
+
+			return GetMostRecent (count, RecentItems);
+		}
+
+		// return the last X items in newest to oldest order
+		private RecentItem[] GetMostRecent (int count, RecentItem[] items)
+		{
+			if (count &gt;= items.Length)
+			{
+				return items;
+			}
+			else
+			{
+				RecentItem[] countedItems = new RecentItem[count];
+				// get the last count items
+				Array.Copy (items, items.Length - count - 1, countedItems, 0, count);
+
+				return countedItems;
+			}
+		}
+
+		public static RecentItem GetOldestItem (RecentItem[] items)
+		{
+			return items[items.Length - 1];
+		}
+
 		public RecentItem OldestItem
 		{
 			get {
-				RecentItem item = RecentItems[0];
-				for (int i = 1; i &lt; RecentItems.Length; i ++)
-				{
-					// the lowest number is the oldest
-					if (RecentItems[i].Timestamp &lt; item.Timestamp)
-						item = RecentItems[i];
-				}
-				return item;
+				return RecentItems[0];
 			}
 		}
 
@@ -229,10 +262,16 @@
 				}
 				else if (ri.Uri == item.Uri)
 				{
-					// remove the groups
-					foreach (string g in item.Groups)
-						ri.RemoveGroup (g);
-					l.Add (ri);
+					if (ri.Groups != null)
+					{
+						// remove the groups
+						if (item.Groups != null)
+						{
+							foreach (string g in item.Groups)
+								ri.RemoveGroup (g);
+						}
+						l.Add (ri);
+					}
 				}
 				else
 				{
@@ -277,9 +316,15 @@
 			}
 		}
 
+		// FIXME: only append new items, instead of re-writing
 		// Save implies EmitChangedEvent (otherwise why would we save?)
 		private void Save ()
 		{
+			// make sure we are in order
+			this.Sort ();
+			// but we need to write in oldest-to-newest order
+			Array.Reverse (RecentItems);
+
 			// if we specifically set Encoding UTF 8 here it writes the BOM
 			// which confuses others (egg-recent-files) I guess
 			XmlTextWriter writer = new XmlTextWriter (new StreamWriter (RecentFileStore));
@@ -287,8 +332,18 @@
 			serializer.Serialize (writer, this);
 			writer.Close ();
 			EmitChangedEvent ();
+
+			// back to normal
+			this.Sort ();
 		}
 
+		// this gives us the items in newest-to-oldest order
+		public void Sort ()
+		{
+			if (RecentItems != null)
+				Array.Sort (RecentItems);
+		}
+
 		public override string ToString ()
 		{
 			if (RecentItems == null)
@@ -310,7 +365,7 @@
 		}
     }
 
-    public class RecentItem
+    public class RecentItem : IComparable
 	{
         [XmlElement (&quot;URI&quot;)]
         public string Uri;
@@ -380,6 +435,21 @@
 				AddGroup (s);
 		}
 
+		// we want newer items first
+		public int CompareTo (object item)
+		{
+			RecentItem other = item as RecentItem;
+			if (other == null)
+				throw new ArgumentException (&quot;item is not of type &quot; + typeof (RecentItem));
+
+			if (this.Timestamp == other.Timestamp)
+				return 0;
+			else if (this.Timestamp &lt; other.Timestamp)
+				return 1; // older
+			else
+				return -1; // newer
+		}
+
 		public static int NewTimestamp
 		{
 			get {

Modified: trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs
===================================================================
--- trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs	2004-11-02 03:02:12 UTC (rev 2015)
+++ trunk/MonoDevelop/Core/src/Main/Base/Services/File/RecentOpen.cs	2004-11-02 20:06:23 UTC (rev 2016)
@@ -73,19 +73,7 @@
 		
 		public void AddLastFile (string name)
 		{
-			if (lastfile != null &amp;&amp; lastfile.Length &gt;= MAX_LENGTH)
-			{
-				RecentItem oldestItem = lastfile[0];
-				for (int i = 1; i &lt; lastfile.Length - 1; i ++)
-				{
-					// the lowest number is the oldest
-					if (lastfile[i].Timestamp &lt; oldestItem.Timestamp)
-						oldestItem = lastfile[i];
-				}
-				recentFiles.RemoveItem (oldestItem);
-			}
-
-			recentFiles.AddItem (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Files&quot;));
+			recentFiles.AddWithLimit (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Files&quot;), &quot;MonoDevelop Files&quot;, MAX_LENGTH);
 			UpdateLastFile ();
 		}
 		
@@ -105,19 +93,7 @@
 		
 		public void AddLastProject (string name)
 		{
-			if (lastproject != null &amp;&amp; lastproject.Length &gt;= MAX_LENGTH)
-			{
-				RecentItem oldestItem = lastproject[0];
-				for (int i = 1; i &lt; lastproject.Length; i ++)
-				{
-					// the lowest number is the oldest
-					if (lastproject[i].Timestamp &lt; oldestItem.Timestamp)
-						oldestItem = lastproject[i];
-				}
-				recentFiles.RemoveItem (oldestItem);
-			}
-
-			recentFiles.AddItem (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Projects&quot;));
+			recentFiles.AddWithLimit (new RecentItem (new Uri (name), Vfs.GetMimeType (name), &quot;MonoDevelop Projects&quot;), &quot;MonoDevelop Projects&quot;, MAX_LENGTH);
 			UpdateLastProject ();
 		}
 		


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001619.html">[Monodevelop-patches-list] r2015 - in trunk/MonoDevelop/Core/src/Main/Base: . Internal/Parser/SharpAssemblyLayer
</A></li>
	<LI>Next message: <A HREF="001621.html">[Monodevelop-patches-list] r2017 - trunk/MonoDevelop/Core/src/Main/Base/Services/File
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1620">[ date ]</a>
              <a href="thread.html#1620">[ thread ]</a>
              <a href="subject.html#1620">[ subject ]</a>
              <a href="author.html#1620">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-patches-list">More information about the Monodevelop-patches-list
mailing list</a><br>
</body></html>
