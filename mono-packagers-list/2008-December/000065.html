<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-packagers] The $(prefix)/lib vs $(libdir) argument
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-packagers-list%40lists.ximian.com?Subject=%5Bmono-packagers%5D%20The%20%24%28prefix%29/lib%20vs%20%24%28libdir%29%20argument&In-Reply-To=295e750a0811290903u53d9b07ci813e84626ac5f642%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000066.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-packagers] The $(prefix)/lib vs $(libdir) argument</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-packagers-list%40lists.ximian.com?Subject=%5Bmono-packagers%5D%20The%20%24%28prefix%29/lib%20vs%20%24%28libdir%29%20argument&In-Reply-To=295e750a0811290903u53d9b07ci813e84626ac5f642%40mail.gmail.com"
       TITLE="[mono-packagers] The $(prefix)/lib vs $(libdir) argument">jonpryor at vt.edu
       </A><BR>
    <I>Mon Dec  1 15:44:01 EST 2008</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000066.html">[mono-packagers] The $(prefix)/usr vs $(libdir) argument
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65">[ date ]</a>
              <a href="thread.html#65">[ thread ]</a>
              <a href="subject.html#65">[ subject ]</a>
              <a href="author.html#65">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So, to further muddy the waters...

CIL (as produced by vbnc, gmcs, booc, etc.) as located within .dll
and .exe files are *conceptually* platform-independent.  In theory, it
is fully platform independent, except for the minor issue of P/Invokes
(below).  This is what miguel was likely referring to with suggesting
that IL code should be in $prefix/share, which I would normally agree
with.

The JIT is a complete non-sequitur here, as the JIT produces code at
runtime.  Specifically, if we did install IL into /usr/share, you could
have *both* mono32 and mono64 programs running the same IL code.  The
JIT isn't a problem.

The problems are twofold:

1. P/Invokes: P/Invoke methods &amp; classes/structures used by P/Invokes
usually refer to fixed-size data types.  This is often fine, e.g.
getpid(2) is unlikely to return anything other than a 32-bit integer on
platforms we care about.  This *can* be problematic with anything
dealing with C/C++ variably sized types such as `long` (which is 32-bits
on ILP32 platforms like Linux &amp; Win32, 64-bits on LP64 platforms like
Linux &amp; most Unix platforms, and 32-bits on P64 platforms like Win64).

It is possible to write platform-agnostic IL that uses P/Invokes, but it
is also very easy to make a mistake, e.g. by declaring fseek(3) to use
an `int offset' parameter, thus tying it to 32-bit platforms.

If code is properly written, this shouldn't be an impediment to placing
IL into /usr/share.

2. Ahead-Of-Time code (`mono --aot`).  The JIT can pre-compile IL into
native machine code, and (obviously) this native code is specific to the
target machine.  Furthermore:

i. the generated native code (a .so file) is placed into the same
directory as the &quot;source&quot; IL.

ii. The .so filename does NOT currently have any architecture
information encoded within it.

Thus, the use of AOT functionality should nix the idea of /usr/share, as
e.g. /usr/share/mono/2.0/mscorlib.dll.so could only be for a single
architecture.

However, this likely could be fixed (e.g. by placing the .so files for
GAC'd assemblies within $(libdir)), and no one (afaik) uses --aot for
the mono-provided assemblies anyway, so this concern is as theoretical
as the P/Invoke issue. :-)

So, the waters sufficiently muddied, I don't see any reason why mono
packages for .dll files could not be .noarch, AS LONG AS --aot is not
used with them (which usually isn't the case).

The case-in-point example for this is openSUSE, where on 64-bit
platforms the mono-core package provides /usr/lib/mono/2.0/mscorlib.dll
(and the platform /usr/bin/mono and /usr/lib64/libmono.so) and a
mono-core-32bit package provides /usr/bin/mono32 and /usr/lib/libmono.so
(and hardly anything else):

        <A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">jon at lina</A>:tmp$ rpm -ql mono-core-32bit
        /usr/bin/mono32
        /usr/lib/libMonoPosixHelper.so
        /usr/lib/libikvm-native.so
        /usr/lib/libmono.so
        /usr/lib/libmono.so.0
        /usr/lib/libmono.so.0.0.0

Now, for this platform there would be no impediment to placing the .dll
files into /usr/share (aside from inertia and time), as it's ~no
different from always placing .dll files into $prefix/lib -- there will
only ever be one set of .dll files, ever, and NOT one set per mono JIT
architecture.

(Obviously, if you change the requirements things will change -- if AOT
were actually used, openSUSE may then require two sets of .dll files,
one per architecture, or (preferrably?) a better AOT setup so that AOT
files aren't placed in the same directory as the &quot;source&quot; IL code...)

 - Jon

On Sat, 2008-11-29 at 18:03 +0100, Zoltan Varga wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i>   I have no idea whenever $(prefix)/lib or $(libdir) is the correct
</I>&gt;<i> approach, but the assemblies
</I>&gt;<i> shipped with mono _are_ platform independent, whenever they are
</I>&gt;<i> 'built' using a JIT or
</I>&gt;<i> not. For proof, they can be copied to any other architecture supported
</I>&gt;<i> by mono, like arm
</I>&gt;<i> or itanium, or even windows, and they will run just fine there.
</I>&gt;<i> 
</I>&gt;<i>                              Zoltan
</I>&gt;<i> 
</I>&gt;<i> On Sat, Nov 29, 2008 at 3:21 PM, Paul &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">paul at all-the-johnsons.co.uk</A>&gt; wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I know this argument has been going on for a while, but I feel it's now
</I>&gt;<i> &gt; something that really needs to be resolved across all of the mono stack
</I>&gt;<i> &gt; (and dependencies).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Many many moons ago, Miguel said that as CIL is completely agnostic as
</I>&gt;<i> &gt; to what it is on, that everything mono related should really be
</I>&gt;<i> &gt; in /usr/share. Noises were made, but nothing really much happened. There
</I>&gt;<i> &gt; is logic in using /usr/share, but nothing completely overwhelming.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There is then the argument that all mono packages should be .noarch.
</I>&gt;<i> &gt; This really is a non-starter, I'll explain below.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The current situation is that by default, mono is installed to
</I>&gt;<i> &gt; $(prefix)/lib with scripts from $(prefix)/bin pointing to the CIL
</I>&gt;<i> &gt; binaries or libraries. The only problem is that if you're compiling
</I>&gt;<i> &gt; using JIT, then binaries (and libraries) are targetting a particular
</I>&gt;<i> &gt; architecture (albeit x86, PPC, PPC64, x86_64 or any other processor
</I>&gt;<i> &gt; type) and are therefore incorrectly polluting the /usr/lib directory
</I>&gt;<i> &gt; which on non-x86 platforms is there for *purely* 32 bit libs.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This means that for mono to be correctly packaged for non-x86 platforms,
</I>&gt;<i> &gt; all of the makefiles, .pc files and anything else like that has to
</I>&gt;<i> &gt; patched to use $(libdir) rather than $(prefix)/lib. Okay, it probably
</I>&gt;<i> &gt; doesn't seem like much, but given the size of mono (and associated
</I>&gt;<i> &gt; packages), patching becomes a major ball ache!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; While I understand that not every distro builds the JIT compiler, using
</I>&gt;<i> &gt; $(libdir) would mean that for the sake of argument, files are correctly
</I>&gt;<i> &gt; installed to the correct libdir. I also don't know how Windows is
</I>&gt;<i> &gt; handled with respect to this.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Using JIT also makes anything built using it a non-noarch package.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There is the flipside in that there is currently no fixed guideline of
</I>&gt;<i> &gt; where to place files for mono. Some mono packages use $(libdir) in the
</I>&gt;<i> &gt; makefiles (mono-basic is an example of this), some mix and match (makes
</I>&gt;<i> &gt; a bloody awful mess of things) and some just use $(prefix)/lib.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have a whole raft of patches available if we go over to $(libdir) - I
</I>&gt;<i> &gt; mean lots of them, probably coming up to 100k worth, but we certainly
</I>&gt;<i> &gt; need to get this sorted as it's starting to get ridiculous.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; TTFN
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Paul
</I>&gt;<i> &gt; (long time mono user and mono packager for Fedora)
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; &#65279;Sie k&#246;nnen mich aufreizen und wirklich hei&#223; machen!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; mono-packagers-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">mono-packagers-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">http://lists.ximian.com/mailman/listinfo/mono-packagers-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> mono-packagers-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">mono-packagers-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">http://lists.ximian.com/mailman/listinfo/mono-packagers-list</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000066.html">[mono-packagers] The $(prefix)/usr vs $(libdir) argument
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65">[ date ]</a>
              <a href="thread.html#65">[ thread ]</a>
              <a href="subject.html#65">[ subject ]</a>
              <a href="author.html#65">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-packagers-list">More information about the mono-packagers-list
mailing list</a><br>
</body></html>
