<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Cocoa-sharp] RFC: buildNew.sh
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:adhamh%40apple.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000189.html">
   <LINK REL="Next"  HREF="000191.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cocoa-sharp] RFC: buildNew.sh
   </H1>
    <B>Adhamh Findlay
    </B> 
    <A HREF="mailto:adhamh%40apple.com"
       TITLE="[Cocoa-sharp] RFC: buildNew.sh">adhamh@apple.com
       </A><BR>
    <I>Wed, 14 Jul 2004 09:32:41 -0700</I>
    <P><UL>
        <LI> Previous message: <A HREF="000189.html">[Cocoa-sharp] HELP! glib build problem
</A></li>
        <LI> Next message: <A HREF="000191.html">[Cocoa-sharp] OT: ModMono/XSP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#190">[ date ]</a>
              <a href="thread.html#190">[ thread ]</a>
              <a href="subject.html#190">[ subject ]</a>
              <a href="author.html#190">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--Apple-Mail-15--153588065
Content-Transfer-Encoding: 7bit
Content-Type: text/plain;
	charset=US-ASCII;
	format=flowed

Hi guys,

Here's the new build script.   Please send me your comments on it.

A few notes:
	1.  Some function names need to change like buildDepNew
	2.  It does not currently create the links the /usr/bin.  This is 
because the postflight script of the pkg will do that.  I will add 
package creation to the script next.

Adhamh


--Apple-Mail-15--153588065
Content-Transfer-Encoding: 7bit
Content-Type: application/text;
	x-mac-type=54455854;
	x-unix-mode=0775;
	name=&quot;buildNew.sh&quot;
Content-Disposition: attachment;
	filename=buildNew.sh

#!/bin/sh -x

#Complete rewrite by Adhamh Findlay &lt;<A HREF="mailto:mono@adhamh.com">mono@adhamh.com</A>&gt; 7-14-04
#now compiles gettext, pkgconfig, icu, glib, and mono into frameworks
#more extensible so that other projects can be built into frameworks as well.
#this script can't build from CVS because it uses curl to download releases
#possible improvements
#	add function to get source from cvs
#	add function to create pkg from build products
#	add some real functionality to the cleanup function
#	improve the initial directory creation and add option to remove framework directories
#		that will force a rebuild of the frameworks

# this horrid little script updates a mono revision
# Author: Andy Satori &lt;<A HREF="mailto:dru@satori-assoc.com">dru@satori-assoc.com</A>&gt;
# Modifications: kangaroo
# Changes June 10/2004
#  - Updated for beta3 0.96
# Changes June 2/2004
#  - Updated for beta2 0.95
#  - Updated to boehm.gc.a6
#  - Updated to glib-2.4.1

set -e 

BUILDROOT=&quot;/Users/Shared&quot;
VERSION=&quot;1.0&quot;
BASEPREFIX=&quot;/Library/Frameworks&quot;
PREFIX=&quot;&quot;
MONOURL=&quot;<A HREF="http://www.go-mono.com/archive/1.0/mono-1.0.tar.gz"">http://www.go-mono.com/archive/1.0/mono-1.0.tar.gz&quot;</A>
REMOVE=&quot;NO&quot;
CLEAN=&quot;NO&quot;

usage()
{
# 		-p &lt;prefix for builds&gt; #default is /Library/Frameworks/Mono.framework/Versions/\$VERSION
# 		-v &lt;version of Mono&gt;
# 		-i &lt;dependencies dir&gt; #location for mono deps
# 		-m &lt;mono url&gt; #url to use for Mono source
echo &quot;Proper usage is as follows&quot;
cat &lt;&lt;EOF
	buildNew.sh
		-g remove gz files (default no)
		-c make clean (default no)
		-h this message
EOF
}

cleanup()
{
	#Cleans up if the script is interupted.
	echo
	echo &quot;Interupted cleaning&quot;
}

creatDirs()
{

	if [ ! -d &quot;$BUILDROOT/Dependancies&quot; ]; then
		mkdir $BUILDROOT/Dependancies
	fi
	
}

createFramework()
{	
	cd $BASEPREFIX/$1/Versions
	if [ -e &quot;$BASEPREFIX/$FRAMEWORKNAME/Versions/Current&quot; ]; then
		rm Current
	fi
	
	ln -sf $2 Current
	echo &quot;Creating framework links&quot;
	cd $BASEPREFIX/$1
	if [ $FRAMEWORKNAME != &quot;PkgConfig.framework&quot; ]; then
		ln -sf Versions/Current/lib Libraries
		ln -sf Versions/Current/include Headers
	fi
	ln -sf Versions/Current/bin Commands
}

icuSpecificBuild()
{
    PREFIX=$1
    
	if [ ! -d $BUILDROOT/Dependancies/icu ]; then
		echo &quot;Downloading icu-2.8&quot;
		curl -s -O $2 $3
		gnutar xzf $4
	fi
	if [ $REMOVE == &quot;YES&quot; ]; then rm $3; fi

    cd icu/source
	if [ ! -f ./Makefile ]; then
		./runConfigureICU MacOSX --with-data-packaging=library --prefix=$PREFIX --libdir=$PREFIX/lib/ 
	fi
	echo $PWD
	if [ $CLEAN == &quot;YES&quot; ]; then make clean; fi
    gnumake
    make install
    #make clean
    
    cd $PREFIX/lib
    
    # libicudata
    install_name_tool -id $PREFIX/lib/libicudata.dylib.28 libicudata.dylib.28.0
    
    # libicui18n
    install_name_tool -id $PREFIX/lib/libicui18n.dylib.28 libicui18n.dylib.28.0
    install_name_tool -change libicuuc.dylib.28 $PREFIX/lib/libicuuc.dylib.28 libicui18n.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libicui18n.dylib.28.0
    
    # libicuio
    install_name_tool -id $PREFIX/lib/libicuio.dylib.28 libicuio.dylib.28.0
    install_name_tool -change libicuuc.dylib.28 $PREFIX/lib/libicuuc.dylib.28 libicuio.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libicuio.dylib.28.0
    install_name_tool -change libicui18n.dylib.28 $PREFIX/lib/libicui18n.dylib.28 libicuio.dylib.28.0
    
    # libicule
    install_name_tool -id $PREFIX/lib/libicule.dylib.28 libicule.dylib.28.0
    install_name_tool -change libicuuc.dylib.28 $PREFIX/lib/libicuuc.dylib.28 libicule.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libicule.dylib.28.0

    # libiculx
    install_name_tool -id $PREFIX/lib/libiculx.dylib.28 libiculx.dylib.28.0
    install_name_tool -change libicuuc.dylib.28 $PREFIX/lib/libicuuc.dylib.28 libiculx.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libiculx.dylib.28.0
    install_name_tool -change libicule.dylib.28 $PREFIX/lib/libicule.dylib.28 libiculx.dylib.28.0

    # libicutoolutil
    install_name_tool -id $PREFIX/lib/libicutoolutil.dylib.28 libicutoolutil.dylib.28.0
    install_name_tool -change libicuuc.dylib.28 $PREFIX/lib/libicuuc.dylib.28 libicutoolutil.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libicutoolutil.dylib.28.0

    # libicuuc
    install_name_tool -id $PREFIX/lib/libicuuc.dylib.28 libicuuc.dylib.28.0
    install_name_tool -change libicudata.dylib.28 $PREFIX/lib/libicudata.dylib.28 libicuuc.dylib.28.0

}

buildDepNew()
{
	#buildDepNew FRAMEWORKNAME FRAMEWORKVERSION URL TARBALL DIR
	#FRAMEWORKNAME = PkgConfig.Framework | Gnome.framework/Framewoks/Glib2.framework
	cd $BUILDROOT/Dependancies
	FRAMEWORKNAME=$1
	FRAMEWORKVERSION=$2
	URL=$3
	TARBALL=$4
	DIR=$5
	PREFIX=&quot;$BASEPREFIX/$FRAMEWORKNAME/Versions/$FRAMEWORKVERSION&quot;

	#sets the build env.  
	export PATH=$PREFIX/bin:/usr/X11R6/bin:$PATH
	export ACLOCAL_FLAGS=&quot;-I $PREFIX/share/aclocal/&quot;
	export C_INCLUDE_PATH=$C_INCLUDE_PATH:$PREFIX/include
	export LDFLAGS=&quot;-L$PREFIX/lib $LDFLAGS&quot;
	export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:/usr/X11R6/lib:$PREFIX/lib

	# Check to see if pkg-config is present, needs to be dled, and/or installed
	if [ ! -d &quot;$BASEPREFIX/$FRAMEWORKNAME/Versions/$FRAMEWORKVERSION&quot; ]; then
	
		echo &quot;Creating $BASEPREFIX/$FRAMEWORKNAME&quot;
		
		mkdir -p $PREFIX
		
		if [ $FRAMEWORKNAME = &quot;Mono.framework/Frameworks/Icu.framework&quot; ]; then
			icuSpecificBuild $PREFIX $URL $TARBALL
		else
			if [ ! -d $BUILDROOT/Dependancies/$DIR ]; then
				echo &quot;Downloading $DIR&quot;
				curl -s -O $URL
				gnutar xzf $TARBALL
			fi
			if [ $REMOVE == &quot;YES&quot; ]; then rm $TARBALL; fi
			
			cd $DIR
			echo &quot;Building $FRAMEWORKNAME&quot;
			#CLEAN must be YES if the --prefix has changed
			if [ $CLEAN == &quot;YES&quot; ]; then 
				make clean
				./configure --prefix=$PREFIX
			fi
			make
			make install
		fi
		createFramework $FRAMEWORKNAME $FRAMEWORKVERSION
		cd $BUILDROOT/Dependancies	
	fi
}

trap cleanup 2

#get the options passed in on the command line.  doing this instead
#of a case because these are optional args.
while getopts hv:p:i:m:c: option
	do
# 		if [ $option == &quot;v&quot; ]; then
# 			VERSION=$OPTARG	
# 		fi
# 		if [ $option == &quot;p&quot; ]; then
# 			PREFIX=$OPTARG	
# 		fi
# 		if [ $option == &quot;i&quot; ]; then
# 			DEPSDIR=$OPTARG	
# 		fi
# 		if [ $option == &quot;m&quot; ]; then
# 			MONOURL=$OPTARG	
# 		fi
		if [ $option == &quot;c&quot; ]; then
			CLEAN=$OPTARG	
		fi
		if [ $option == &quot;g&quot; ]; then
			REMOVE=$OPTARG	
		fi
		if [ $option == &quot;h&quot; ]; then
			usage
		fi
done

export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/X11R6/lib/pkgconfig

creatDirs

#Build the /Library/Frameworks/PkgConfig.framework
buildDepNew PkgConfig.framework 0.15 \
	<A HREF="http://www.freedesktop.org/software/pkgconfig/releases/pkgconfig-0.15.0.tar.gz">http://www.freedesktop.org/software/pkgconfig/releases/pkgconfig-0.15.0.tar.gz</A> \
	pkgconfig-0.15.0.tar.gz pkgconfig-0.15.0
#Build the /Library/Frameworks/GetText.framework
buildDepNew GetText.framework 0.14.1 \
	<A HREF="http://ftp.gnu.org/pub/gnu/gettext/gettext-0.14.1.tar.gz">http://ftp.gnu.org/pub/gnu/gettext/gettext-0.14.1.tar.gz</A> \
	gettext-0.14.1.tar.gz gettext-0.14.1
#Build the /Library/Frameworks/Gnome.framework/Frameworks/Glib2.framework
#this is don to provide a means to add more Gnome code later
buildDepNew Gnome.framework/Frameworks/Glib2.framework 2.4.1 \
	<A HREF="ftp://ftp.gtk.org/pub/gtk/v2.4/glib-2.4.1.tar.gz">ftp://ftp.gtk.org/pub/gtk/v2.4/glib-2.4.1.tar.gz</A> \
	glib-2.4.1.tar.gz glib-2.4.1
#Build the /Library/Frameworks/Mono.framwork/Frameworks/Icu.framework
#icu is only used by mono so it should be placed inside the mono framework
buildDepNew Mono.framework/Frameworks/Icu.framework 2.8 \
	&quot;--disable-epsv <A HREF="ftp://www-126.ibm.com/pub/icu/2.8/icu-2.8.tgz"">ftp://www-126.ibm.com/pub/icu/2.8/icu-2.8.tgz&quot;</A> \
	icu-2.8.tgz icu 
	
#Build the /Library/Frameworks/Mono.framework

# if test ! -d &quot;/Library/Frameworks/Mono.framework&quot;; then
# 	mkdir -p /Library/Frameworks/Mono.framework/Versions
# fi
# 
# if test ! -d &quot;/Library/Frameworks/Mono.framework/Versions/$VERSION&quot;; then
# 	mkdir -p /Library/Frameworks/Mono.framework/Versions/$VERSION
# fi

buildDepNew Mono.framework 1.0 \
	<A HREF="http://www.go-mono.com/archive/1.0/mono-1.0.tar.gz">http://www.go-mono.com/archive/1.0/mono-1.0.tar.gz</A> \
	mono-1.0.tar.gz mono-1.0 

echo &quot;build completed&quot;

--Apple-Mail-15--153588065--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000189.html">[Cocoa-sharp] HELP! glib build problem
</A></li>
	<LI> Next message: <A HREF="000191.html">[Cocoa-sharp] OT: ModMono/XSP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#190">[ date ]</a>
              <a href="thread.html#190">[ thread ]</a>
              <a href="subject.html#190">[ subject ]</a>
              <a href="author.html#190">[ author ]</a>
         </LI>
       </UL>
</body></html>
