<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Cocoa-sharp] ObjectiveC.SendMessage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20ObjectiveC.SendMessage&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000756.html">
   <LINK REL="Next"  HREF="000758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cocoa-sharp] ObjectiveC.SendMessage</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20ObjectiveC.SendMessage&In-Reply-To="
       TITLE="[Cocoa-sharp] ObjectiveC.SendMessage">andreas.faerber at web.de
       </A><BR>
    <I>Wed Jan  4 19:48:49 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000756.html">[Cocoa-sharp] Objective-C Memory Hooks
</A></li>
        <LI>Next message: <A HREF="000758.html">[Cocoa-sharp] ObjectiveC.SendMessage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#757">[ date ]</a>
              <a href="thread.html#757">[ thread ]</a>
              <a href="subject.html#757">[ subject ]</a>
              <a href="author.html#757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I've tried to rewrite the ObjCMessaging (see attached), attempting to 
simplify the arguments passed and to remove the dependency on 
Reflection.Emit by using &quot;params&quot; arrays for P/Invoke as well - is that 
not possible and thus the reason for the current implementation? It 
appears to be working when I do [[[NSObject alloc] init] release]; when 
I do [[[NSBox alloc] initWithFrame:] release] or [[NSString 
stringWithUTF8String:] release] it appears to be working on first sight 
but [obj cString] or new Cocoa.String(obj).ToString() does not return 
anything (see example). Is the CLR attempting to marshal the object[] 
array itself somehow as an array instead of marshalling its contents as 
vararg parameters as specified by &quot;params&quot;? I have already set 
CharSet.Auto and tried Winapi and Cdecl calling conventions, where 
Microsoft says about Cdecl: &quot;This enables calling functions with 
*varargs*, which makes it appropriate to use for methods that accept a 
variable number of parameters, such as *Printf*.&quot; Yet below in an 
example they write C# did not support varargs and all arguments would 
have to be defined explicitly. If that is the problem, might an 
ICustomMarshaler class for object[] do the trick?

Apart from the above I have also added try-finally blocks to avoid 
memory leaks and some renaming and avoiding code duplication.

Thoughts?

Andreas


P.S. When doing this type of development (or unit tests in the future), 
it is annoying that the (command line) application does not exit - I'd 
guess this is because the Mach exception handler thread is still alive?
-------------- next part --------------
using System;
using Cocoa;
using Cocoa.Interop;

class Test {
	static void Main() {
		Application.Init();

		IntPtr obj = (IntPtr)ObjectiveC.SendMessage((IntPtr)Cocoa.Object.NativeClasses[typeof(Cocoa.Object)], &quot;alloc&quot;, typeof(IntPtr));
		obj = (IntPtr)ObjectiveC.SendMessage(obj, &quot;init&quot;, typeof(IntPtr));
		ObjectiveC.SendMessage(obj, &quot;release&quot;, typeof(void));

		new Box(new Rect()); //init Box
		obj = (IntPtr)ObjectiveC.SendMessage((IntPtr)Cocoa.Object.NativeClasses[typeof(Cocoa.Box)], &quot;alloc&quot;, typeof(IntPtr));
		obj = (IntPtr)ObjectiveC.SendMessage(obj, &quot;initWithFrame:&quot;, typeof(IntPtr), new Rect(0,0,100,25));
		ObjectiveC.SendMessage(obj, &quot;release&quot;, typeof(void));

		Console.WriteLine(new Cocoa.String(&quot;test&quot;)); //init String
		obj = (IntPtr)ObjectiveC.SendMessage((IntPtr)Cocoa.Object.NativeClasses[typeof(Cocoa.String)], &quot;stringWithUTF8String:&quot;, typeof(IntPtr), &quot;hello&quot;);
		Console.WriteLine(new Cocoa.String(obj).ToString());
		Console.WriteLine(ObjectiveC.SendMessage(obj, &quot;cString&quot;, typeof(string)));
		ObjectiveC.SendMessage(obj, &quot;release&quot;, typeof(void));

		Console.WriteLine(&quot;Test end.&quot;);
	}
}
-------------- next part --------------
//
// ObjectiveC.cs: Objective-C interop
//
// Authors:
//   Geoff Norton (<A HREF="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">gnorton at customerdna.com</A>)
//   Andreas Faerber (<A HREF="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">andreas.faerber at web.de</A>)
//

using System;
using System.Reflection;
using System.Runtime.InteropServices;

namespace Cocoa.Interop {
	public class ObjectiveC {
		static MethodInfo msgSend;
		static MethodInfo msgSend_stret;
		static MethodInfo msgSendSuper;
		static MethodInfo msgSendSuper_stret;

		static ObjectiveC()
		{
			Type type = typeof (ObjectiveC);
			BindingFlags flags = BindingFlags.Static | BindingFlags.NonPublic;
			if ((msgSend            = type.GetMethod (&quot;objc_msgSend&quot;,            flags, null, new Type [] { typeof (IntPtr), typeof (IntPtr), typeof (object []) }, null)) == null)
				throw new Exception();
			if ((msgSend_stret      = type.GetMethod (&quot;objc_msgSend_stret&quot;,      flags, null, new Type [] { typeof (IntPtr), typeof (IntPtr), typeof (IntPtr), typeof (object []) }, null)) == null)
				throw new Exception();
			if ((msgSendSuper       = type.GetMethod (&quot;objc_msgSendSuper&quot;,       flags, null, new Type [] { typeof (IntPtr), typeof (IntPtr), typeof (object []) }, null)) == null)
				throw new Exception();
			if ((msgSendSuper_stret = type.GetMethod (&quot;objc_msgSendSuper_stret&quot;, flags, null, new Type [] { typeof (IntPtr), typeof (IntPtr), typeof (IntPtr), typeof (object []) }, null)) == null)
				throw new Exception();
		}

		private ObjectiveC()
		{
		}

		public static object SendMessage (IntPtr receiver, string selector, Type returnType, params object [] args)
		{
			Type retType = GetReturnType (returnType);
			args = ConvertArguments (args);
			object ret;
			if (IsStretNeeded (retType)) {
				IntPtr ptr = Marshal.AllocHGlobal (Marshal.SizeOf (retType));
				try {
					msgSend_stret.Invoke (null, new object [] { ptr, receiver, sel_registerName (selector), args });
					ret = Marshal.PtrToStructure (ptr, retType);
				} finally {
					Marshal.FreeHGlobal (ptr);
				}
			} else ret = ToReturnType ((IntPtr)msgSend.Invoke (null, new object [] { receiver, sel_registerName (selector), args }), returnType);
			return ret;
		}

		public static object SendMessageToSuper (IntPtr receiver, IntPtr superclass, string selector, Type returnType, params object [] args)
		{
			Type retType = GetReturnType (returnType);
			args = ConvertArguments (args);
			object ret;
			IntPtr superContext = Marshal.AllocHGlobal (Marshal.SizeOf (typeof (objc_super)));
			try {
				Marshal.StructureToPtr (new objc_super (receiver, superclass), superContext, true);
				if (IsStretNeeded (retType)) {
					IntPtr ptr = Marshal.AllocHGlobal (Marshal.SizeOf (retType));
					try {
						msgSendSuper_stret.Invoke (null, new object [] { ptr, superContext, sel_registerName (selector), args });
						ret = Marshal.PtrToStructure (ptr, retType);
					} finally {
						Marshal.FreeHGlobal (ptr);
					}
				} else ret = ToReturnType ((IntPtr)msgSendSuper.Invoke (null, new object [] { superContext, sel_registerName (selector), args }), returnType);
			} finally {
				Marshal.FreeHGlobal (superContext);
			}
			return ret;
		}

		private static bool IsStretNeeded (Type returnType)
		{
			return returnType.IsValueType &amp;&amp; (returnType.Namespace != &quot;System&quot;);
		}

		private static object [] ConvertArguments (object [] args)
		{
			object [] arguments = (object []) args.Clone ();
			for (int i = 0; i &lt; arguments.Length; i++) {
				if (arguments [i].GetType ().IsEnum) {
					arguments [i] = Convert.ChangeType (arguments [i], Enum.GetUnderlyingType (arguments [i].GetType ()));
				} //else if (arguments [i].GetType () == typeof (string))
					//arguments [i] = Marshal.StringToHGlobalAuto((string)arguments [i]);
			}
			return arguments;
		}

		private static Type GetReturnType (Type type)
		{
			if (type == null)
				return typeof (void);
			if (type == typeof (string))
				return typeof (IntPtr);
			return type;
		}

		private static object ToReturnType (IntPtr ret, Type type)
		{
			if (type == typeof (string))
				return Marshal.PtrToStringAuto (ret);
			if (type == typeof (void))
				return null;
			return ret;
		}

		[DllImport (&quot;libobjc.dylib&quot;, CharSet=CharSet.Auto, CallingConvention=CallingConvention.Cdecl)]
		private extern static IntPtr objc_msgSend (IntPtr receiver, IntPtr selector, params object [] args);

		[DllImport (&quot;libobjc.dylib&quot;, CharSet=CharSet.Auto, CallingConvention=CallingConvention.Cdecl)]
		private extern static IntPtr objc_msgSend_stret (IntPtr stretAddr, IntPtr receiver, IntPtr selector, params object [] args);

		[DllImport (&quot;libobjc.dylib&quot;, CharSet=CharSet.Auto, CallingConvention=CallingConvention.Cdecl)]
		private extern static IntPtr objc_msgSendSuper (IntPtr superContext, IntPtr selector, params object[] args);

		[DllImport (&quot;libobjc.dylib&quot;, CharSet=CharSet.Auto, CallingConvention=CallingConvention.Cdecl)]
		private extern static IntPtr objc_msgSendSuper_stret (IntPtr stretAddr, IntPtr superContext, IntPtr selector, params object [] args);

		[DllImport (&quot;libobjc.dylib&quot;, CharSet=CharSet.Auto, CallingConvention=CallingConvention.Cdecl)]
		private static extern IntPtr sel_registerName (string selectorName);
	}

	internal struct objc_super {
		internal IntPtr receiver;
		internal IntPtr superclass;

		internal objc_super(IntPtr receiver, IntPtr superclass) {
			this.receiver = receiver;
			this.superclass = superclass;
		}
	}
}
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000756.html">[Cocoa-sharp] Objective-C Memory Hooks
</A></li>
	<LI>Next message: <A HREF="000758.html">[Cocoa-sharp] ObjectiveC.SendMessage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#757">[ date ]</a>
              <a href="thread.html#757">[ thread ]</a>
              <a href="subject.html#757">[ subject ]</a>
              <a href="author.html#757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">More information about the Cocoa-sharp
mailing list</a><br>
</body></html>
