<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Cocoa-sharp] [PATCH] nunit-console2 replacement
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20%5BPATCH%5D%20nunit-console2%20replacement&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001245.html">
   <LINK REL="Next"  HREF="001247.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cocoa-sharp] [PATCH] nunit-console2 replacement</H1>
    <B>Jesse Jones</B> 
    <A HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20%5BPATCH%5D%20nunit-console2%20replacement&In-Reply-To="
       TITLE="[Cocoa-sharp] [PATCH] nunit-console2 replacement">jesjones at mindspring.com
       </A><BR>
    <I>Fri May 23 21:02:27 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001245.html">[Cocoa-sharp] Web site
</A></li>
        <LI>Next message: <A HREF="001247.html">[Cocoa-sharp] [PATCH] IntPtr and bool marshalling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1246">[ date ]</a>
              <a href="thread.html#1246">[ thread ]</a>
              <a href="subject.html#1246">[ subject ]</a>
              <a href="author.html#1246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>nunit crashes when running tests on a PPC. It also crashes (sometimes  
anyway) on Intel. Until we can track down and fix the problem I have a  
little app that can run nunit tests in a dll:

diff --git a/Makefile b/Makefile
index a6c9a59..3a2b6d6 100644
--- a/Makefile
+++ b/Makefile
@@ -1,4 +1,16 @@
  all:
  	cd src &amp;&amp; make
  	cd test &amp;&amp; make
+	cd test2 &amp;&amp; make
+	cd test2 &amp;&amp; make run
+
+nunit:
+	cd src &amp;&amp; make
+	cd test &amp;&amp; make
  	cd test &amp;&amp; make run

test2/Makefile
all:
	gmcs *.cs -pkg:mono-nunit -out:../test/test2.exe -target:exe

run:
	cd ../test &amp;&amp; mono --debug test2.exe

test2/Test.cs
// TODO: This is used to run the unit tests outside of nunit. When we  
run them inside
// of nunit they tend to crash. We really need to figure out why this  
is happening and
// whether it's a problem with nunit or a bug on our side which nunit  
is exposing.

using NUnit.Framework;
using System;
using System.Collections.Generic;
using System.Reflection;

public static class Program
{
	public static void Main()
	{ 		
		Assembly assembly = Assembly.LoadFile(&quot;objc2-sharp-tests.dll&quot;);
		Dictionary&lt;Type, MethodInfo[]&gt; tests = DoFindTests(assembly);
		DoRunTests(tests);
	}
	
	private static void DoRunTests(Dictionary&lt;Type, MethodInfo[]&gt; tests)
	{
		int numTests = 0, numFailed = 0;
		bool collected = true;						// TODO: set this to false
		
		foreach (KeyValuePair&lt;Type, MethodInfo[]&gt; entry in tests)
		{
			object instance = Activator.CreateInstance(entry.Key);
			
			foreach (MethodInfo minfo in entry.Value)
			{
				try
				{
					if (!collected)
					{
						GC.Collect(); 						// TODO: get a crash (apprently in our  
delegate when we do this)				
						System.Threading.Thread.Sleep(200);	// give the finalizer enough  
time to run
						collected = true;					// TODO: we should always collect before a  
test
					}
		
					++numTests;
					minfo.Invoke(instance, null);
				}
				catch (TargetInvocationException e)
				{
					if (e.InnerException != null &amp;&amp; e.InnerException.GetType() ==  
typeof(AssertionException))
					{
						++numFailed;
						Console.Write(&quot;{0}&quot;, minfo);
						Console.WriteLine(e.InnerException.Message);
					}
					else
						throw;
				}
			}
		}
		
		if (numFailed == 0)
			Console.WriteLine(&quot;passed: ran {0} tests with no failures&quot;,  
numTests);
		else if (numFailed == 1)
			Console.WriteLine(&quot;FAILED: ran {0} tests with one failure&quot;,  
numTests);
		else
			Console.WriteLine(&quot;FAILED: ran {0} tests with {1} failures&quot;,  
numTests, numFailed);
	}
	
	private static Dictionary&lt;Type, MethodInfo[]&gt; DoFindTests(Assembly  
assembly)
	{
		Dictionary&lt;Type, MethodInfo[]&gt; tests = new Dictionary&lt;Type,  
MethodInfo[]&gt;();
		
		foreach (Type type in assembly.GetTypes())
		{
			if (type.GetCustomAttributes(typeof(TestFixtureAttribute),  
false).Length &gt; 0)
			{
				List&lt;MethodInfo&gt; methods = new List&lt;MethodInfo&gt;();
				
				foreach (MethodInfo minfo in  
type.GetMethods(BindingFlags.DeclaredOnly | BindingFlags.Public |  
BindingFlags.Instance))
				{
					if (Attribute.GetCustomAttribute(minfo, typeof(TestAttribute)) !=  
null)
					{
						methods.Add(minfo);
					}
				}
				
				if (methods.Count &gt; 0)
					tests.Add(type, methods.ToArray());
			}
		}
		
		return tests;
	}
}

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001245.html">[Cocoa-sharp] Web site
</A></li>
	<LI>Next message: <A HREF="001247.html">[Cocoa-sharp] [PATCH] IntPtr and bool marshalling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1246">[ date ]</a>
              <a href="thread.html#1246">[ thread ]</a>
              <a href="subject.html#1246">[ subject ]</a>
              <a href="author.html#1246">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">More information about the Cocoa-sharp
mailing list</a><br>
</body></html>
