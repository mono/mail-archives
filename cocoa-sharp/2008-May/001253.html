<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Cocoa-sharp] [PATCH] IntPtr and bool marshalling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20%5BPATCH%5D%20IntPtr%20and%20bool%20marshalling&In-Reply-To=F58A55B1-5144-4476-8319-BDEF9A051CE4%40mindspring.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001250.html">
   <LINK REL="Next"  HREF="001254.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cocoa-sharp] [PATCH] IntPtr and bool marshalling</H1>
    <B>Geoff Norton</B> 
    <A HREF="mailto:cocoa-sharp%40lists.ximian.com?Subject=%5BCocoa-sharp%5D%20%5BPATCH%5D%20IntPtr%20and%20bool%20marshalling&In-Reply-To=F58A55B1-5144-4476-8319-BDEF9A051CE4%40mindspring.com"
       TITLE="[Cocoa-sharp] [PATCH] IntPtr and bool marshalling">gnorton at novell.com
       </A><BR>
    <I>Tue May 27 17:59:54 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001250.html">[Cocoa-sharp] [PATCH] IntPtr and bool marshalling
</A></li>
        <LI>Next message: <A HREF="001254.html">[Cocoa-sharp] NSAutoreleasePool
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1253">[ date ]</a>
              <a href="thread.html#1253">[ thread ]</a>
              <a href="subject.html#1253">[ subject ]</a>
              <a href="author.html#1253">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This one is ok too.

Same as before, ChangeLog + commit.

Thanks for the patches!

-g

On Tue, 2008-05-27 at 14:57 -0700, Jesse Jones wrote:
&gt;<i> As per IRC here's an updated patch for the PPC marshaling problems.  
</I>&gt;<i> The differences from the original patch are 1) &quot;c&quot; is used instead of  
</I>&gt;<i> &quot;rc&quot; when typing System.Boolean and 2) System.Char is not typed at all  
</I>&gt;<i> (original code used 'c' which is now used for bool, and was wrong  
</I>&gt;<i> anyway because we should map to unichar which is an unsigned short).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> diff --git a/src/Messaging.cs b/src/Messaging.cs
</I>&gt;<i> index b564a1f..6289c19 100644
</I>&gt;<i> --- a/src/Messaging.cs
</I>&gt;<i> +++ b/src/Messaging.cs
</I>&gt;<i> @@ -9,7 +9,7 @@ namespace ObjC2 {
</I>&gt;<i> 		[DllImport (&quot;/usr/lib/libobjc.dylib&quot;)]
</I>&gt;<i> 		internal extern static IntPtr objc_msgSend (IntPtr cls, IntPtr sel,  
</I>&gt;<i> IntPtr arg);
</I>&gt;<i> 		[DllImport (&quot;/usr/lib/libobjc.dylib&quot;)]
</I>&gt;<i> -		internal extern static IntPtr objc_msgSend (IntPtr cls, IntPtr sel,  
</I>&gt;<i> ref bool arg);
</I>&gt;<i> +		internal extern static IntPtr objc_msgSend (IntPtr cls, IntPtr sel,  
</I>&gt;<i> [MarshalAs(UnmanagedType.U1)] ref bool arg);
</I>&gt;<i> 		[DllImport (&quot;/usr/lib/libobjc.dylib&quot;)]
</I>&gt;<i> 		internal extern static IntPtr objc_msgSend (IntPtr cls, IntPtr sel,  
</I>&gt;<i> ref IntPtr arg);
</I>&gt;<i> 		[DllImport (&quot;/usr/lib/libobjc.dylib&quot;)]
</I>&gt;<i> 
</I>&gt;<i> diff --git a/src/Method.cs b/src/Method.cs
</I>&gt;<i> index bad9286..5fb5af7 100644
</I>&gt;<i> --- a/src/Method.cs
</I>&gt;<i> +++ b/src/Method.cs
</I>&gt;<i> @@ -40,7 +40,7 @@ namespace ObjC2 {
</I>&gt;<i> 
</I>&gt;<i> 			selector = new Selector (export.Selector == null ? minfo.Name :  
</I>&gt;<i> export.Selector);
</I>&gt;<i> 
</I>&gt;<i> -			signature = TypeConverter.ToNative (minfo.ReturnType).ToString ();
</I>&gt;<i> +			signature = TypeConverter.ToNative (minfo.ReturnType);
</I>&gt;<i> 			signature += &quot;@:&quot;;
</I>&gt;<i> 			foreach (ParameterInfo param in minfo.GetParameters ()) {
</I>&gt;<i> 				if (param.ParameterType == typeof (Object) ||  
</I>&gt;<i> param.ParameterType.IsSubclassOf (typeof (Object)))
</I>&gt;<i> 
</I>&gt;<i> diff --git a/src/TypeConverter.cs b/src/TypeConverter.cs
</I>&gt;<i> index 07dc685..bc68fe6 100644
</I>&gt;<i> --- a/src/TypeConverter.cs
</I>&gt;<i> +++ b/src/TypeConverter.cs
</I>&gt;<i> @@ -11,7 +11,7 @@ namespace ObjC2 {
</I>&gt;<i> 		internal static Type ToManaged (string type) {
</I>&gt;<i> 			switch (type) {
</I>&gt;<i> 				case &quot;c&quot;:
</I>&gt;<i> -					return typeof (char);
</I>&gt;<i> +					return typeof (bool);
</I>&gt;<i> 				case &quot;i&quot;:
</I>&gt;<i> 					return typeof (Int32);
</I>&gt;<i> 				case &quot;s&quot;:
</I>&gt;<i> @@ -32,8 +32,6 @@ namespace ObjC2 {
</I>&gt;<i> 					return typeof (float);
</I>&gt;<i> 				case &quot;d&quot;:
</I>&gt;<i> 					return typeof (double);
</I>&gt;<i> -				case &quot;B&quot;:
</I>&gt;<i> -					return typeof (bool);
</I>&gt;<i> 				case &quot;*&quot;:
</I>&gt;<i> 					return typeof (string);
</I>&gt;<i> 				case &quot;v&quot;: case &quot;Vv&quot;:
</I>&gt;<i> @@ -58,36 +56,36 @@ namespace ObjC2 {
</I>&gt;<i> 		 *
</I>&gt;<i> 		 * <A HREF="http://developer.apple.com/documentation/DeveloperTools/gcc-4.0.1/gcc/Type-encoding.html">http://developer.apple.com/documentation/DeveloperTools/gcc-4.0.1/gcc/Type-encoding.html</A>
</I>&gt;<i> 		 */
</I>&gt;<i> -		internal static char ToNative (Type type) {
</I>&gt;<i> -			if (type == typeof (char))
</I>&gt;<i> -				return 'c';
</I>&gt;<i> +		internal static string ToNative (Type type) {
</I>&gt;<i> +			if (type == typeof (bool))
</I>&gt;<i> +				return &quot;c&quot;;
</I>&gt;<i> 			if (type == typeof (Int32))
</I>&gt;<i> -				return 'i';
</I>&gt;<i> +				return &quot;i&quot;;
</I>&gt;<i> +			if (type == typeof (IntPtr) || type == typeof (UIntPtr))
</I>&gt;<i> +				return &quot;^v&quot;;
</I>&gt;<i> 			if (type == typeof (short))
</I>&gt;<i> -				return 's';
</I>&gt;<i> +				return &quot;s&quot;;
</I>&gt;<i> 			if (type == typeof (long))
</I>&gt;<i> -				return 'l';
</I>&gt;<i> +				return &quot;l&quot;;
</I>&gt;<i> 			if (type == typeof (Int64))
</I>&gt;<i> -				return 'q';
</I>&gt;<i> +				return &quot;q&quot;;
</I>&gt;<i> 			if (type == typeof (UInt32))
</I>&gt;<i> -				return 'I';
</I>&gt;<i> +				return &quot;I&quot;;
</I>&gt;<i> 			if (type == typeof (ushort))
</I>&gt;<i> -				return 'S';
</I>&gt;<i> +				return &quot;S&quot;;
</I>&gt;<i> 			if (type == typeof (ulong))
</I>&gt;<i> -				return 'L';
</I>&gt;<i> +				return &quot;L&quot;;
</I>&gt;<i> 			if (type == typeof (UInt64))
</I>&gt;<i> -				return 'Q';
</I>&gt;<i> +				return &quot;Q&quot;;
</I>&gt;<i> 			if (type == typeof (float))
</I>&gt;<i> -				return 'f';
</I>&gt;<i> +				return &quot;f&quot;;
</I>&gt;<i> 			if (type == typeof (double))
</I>&gt;<i> -				return 'd';
</I>&gt;<i> -			if (type == typeof (bool))
</I>&gt;<i> -				return 'B';
</I>&gt;<i> +				return &quot;d&quot;;
</I>&gt;<i> 			if (type == typeof (string))
</I>&gt;<i> -				return '*';
</I>&gt;<i> +				return &quot;*&quot;;
</I>&gt;<i> 			if (type == typeof (void))
</I>&gt;<i> -				return 'v';
</I>&gt;<i> -			return '@';
</I>&gt;<i> +				return &quot;v&quot;;
</I>&gt;<i> +			return &quot;@&quot;;
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> }
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Cocoa-sharp mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">Cocoa-sharp at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">http://lists.ximian.com/mailman/listinfo/cocoa-sharp</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001250.html">[Cocoa-sharp] [PATCH] IntPtr and bool marshalling
</A></li>
	<LI>Next message: <A HREF="001254.html">[Cocoa-sharp] NSAutoreleasePool
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1253">[ date ]</a>
              <a href="thread.html#1253">[ thread ]</a>
              <a href="subject.html#1253">[ subject ]</a>
              <a href="author.html#1253">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/cocoa-sharp">More information about the Cocoa-sharp
mailing list</a><br>
</body></html>
