<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Cocoa-sharp] Added history to monodoc...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pcbeard%40mac.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000443.html">
   <LINK REL="Next"  HREF="000445.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cocoa-sharp] Added history to monodoc...
   </H1>
    <B>Patrick Beard
    </B> 
    <A HREF="mailto:pcbeard%40mac.com"
       TITLE="[Cocoa-sharp] Added history to monodoc...">pcbeard@mac.com
       </A><BR>
    <I>Thu, 17 Mar 2005 12:08:01 -0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="000443.html">[Cocoa-sharp] Working C# IDE for the Mac
</A></li>
        <LI> Next message: <A HREF="000445.html">[Cocoa-sharp] Added history to monodoc...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#444">[ date ]</a>
              <a href="thread.html#444">[ thread ]</a>
              <a href="subject.html#444">[ subject ]</a>
              <a href="author.html#444">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I hooked up a simple history mechanism for monodoc. Presumably this 
could just use C# collections to hold the objects, instead of 
WebHistoryItem objects in the web view's backForwardList, but this was 
my first stab. To use this, you also need to patch the nib file, adding 
outlets to the Controller class, NSMenuItem backMenuItem, and 
forwardMenuItem objects.

I can commit this if you all approve.

- Patrick

Index: browser.cs
===================================================================
--- browser.cs	(revision 41952)
+++ browser.cs	(working copy)
@@ -100,6 +100,10 @@
  	public NSSearchField searchBox;
  	[Connect]
  	public NSBrowser indexBrowser;
+	[Connect]
+	public NSMenuItem backMenuItem;
+	[Connect]
+	public NSMenuItem forwardMenuItem;

  	static RootTree help_tree;

@@ -122,11 +126,19 @@
  		indexBrowser.doubleAction = &quot;browserdoubleAction&quot;;
  		outlineView.target = this;
  		outlineView.doubleAction = &quot;doubleAction&quot;;
+		// use history.
+		webView.maintainsBackForwardList = true;
+		webView.backForwardList.capacity = 100;
+		forwardMenuItem.target = this;
+		forwardMenuItem.action = &quot;goForward:&quot;;
+		backMenuItem.target = this;
+		backMenuItem.action = &quot;goBack:&quot;;
  		Node match;
  		string content = help_tree.RenderUrl(&quot;root:&quot;, out match);
  		content=content.Replace(&quot;a href='&quot;, &quot;a href='<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  		content=content.Replace(&quot;a href=\&quot;&quot;, &quot;a 
href=\&quot;<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  		((WebFrame)webView.mainFrame).loadHTMLString_baseURL(content, null);
+		addHistoryItem(&quot;root:&quot;);
  	}
  	
  	[Export(&quot;browserdoubleAction&quot;)]
@@ -139,6 +151,7 @@
  			content=content.Replace(&quot;a href='&quot;, &quot;a href='<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  			content=content.Replace(&quot;a href=\&quot;&quot;, &quot;a 
href=\&quot;<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  			((WebFrame)webView.mainFrame).loadHTMLString_baseURL(content, null);
+			addHistoryItem(t.Url);
  		}
  	}
  	[Export(&quot;doubleAction&quot;)]
@@ -157,6 +170,7 @@
  				content=content.Replace(&quot;a href='&quot;, &quot;a 
href='<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  				content=content.Replace(&quot;a href=\&quot;&quot;, &quot;a 
href=\&quot;<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  				((WebFrame)webView.mainFrame).loadHTMLString_baseURL(content, 
null);
+				addHistoryItem(bi.node.URL);

  				outlineView.expandItem(bi);

@@ -181,12 +195,61 @@
  				content=content.Replace(&quot;a href=\&quot;&quot;, &quot;a 
href=\&quot;<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
  Console.WriteLine(&quot;DEBUG: {0}&quot;, content);
  				((WebFrame)webView.mainFrame).loadHTMLString_baseURL(content, 
null);
+				addHistoryItem(url);
  			}
  			return null;
  		}
  		return initialRequest;
  	}
-
+	
+	private void addHistoryItem(string url) {
+		webView.backForwardList.addItem(new WebHistoryItem(url, &quot;&quot;, 0));
+	}
+	
+	private void loadHistoryItem(WebHistoryItem item) {
+		string url = item.urlString;
+		string content = &quot;&quot;;
+		Node n;
+		try {
+			content = help_tree.RenderUrl(url, out n);
+		} catch (Exception e) {
+			content = &quot;Exception Rendering the requested URL: &quot; + e;
+		}
+		if (content != null &amp;&amp; !content.Equals(&quot;&quot;)) {
+			content=content.Replace(&quot;a href='&quot;, &quot;a href='<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
+			content=content.Replace(&quot;a href=\&quot;&quot;, &quot;a 
href=\&quot;<A HREF="http://monodoc/load?"">http://monodoc/load?&quot;</A>);
+			webView.mainFrame.loadHTMLString_baseURL(content, null);
+		}
+	}
+	
+	[Export(&quot;validateMenuItem:&quot;)]
+	public bool validateMenuItem(object sender) {
+		NSMenuItem item = (NSMenuItem) sender;
+		if (item.action.Equals(&quot;goBack:&quot;)) return webView.canGoBack;
+		if (item.action.Equals(&quot;goForward:&quot;)) return webView.canGoForward;
+		return true;
+	}
+	
+	[Export(&quot;goBack:&quot;)]
+	public void goBack(object sender) {
+		WebBackForwardList history = webView.backForwardList;
+		Console.WriteLine(&quot;webView.canGoBack = &quot; + webView.canGoBack);
+		Console.WriteLine(&quot;webView.backForwardList.backListCount = &quot; + 
history.backListCount);
+		if (history.backListCount &gt; 0) {
+			history.goBack();
+			loadHistoryItem(history.currentItem);
+		}
+	}
+	
+	[Export(&quot;goForward:&quot;)]
+	public void goForward(object sender) {
+		Console.WriteLine(&quot;goForward:&quot;);
+		WebBackForwardList history = webView.backForwardList;
+		if (history.forwardListCount &gt; 0) {
+			history.goForward();
+			loadHistoryItem(history.currentItem);
+		}
+	}
  }

  class Browser {


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000443.html">[Cocoa-sharp] Working C# IDE for the Mac
</A></li>
	<LI> Next message: <A HREF="000445.html">[Cocoa-sharp] Added history to monodoc...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#444">[ date ]</a>
              <a href="thread.html#444">[ thread ]</a>
              <a href="subject.html#444">[ subject ]</a>
              <a href="author.html#444">[ author ]</a>
         </LI>
       </UL>
</body></html>
