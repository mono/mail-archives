<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Terminal config for mono csharp shell?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Terminal%20config%20for%20mono%20csharp%20shell%3F&In-Reply-To=%3C20756DB4-6DD1-4017-9A4F-B9504EF947E5%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043093.html">
   <LINK REL="Next"  HREF="043105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Terminal config for mono csharp shell?</H1>
    <B>Cyd Haselton</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Terminal%20config%20for%20mono%20csharp%20shell%3F&In-Reply-To=%3C20756DB4-6DD1-4017-9A4F-B9504EF947E5%40gmail.com%3E"
       TITLE="[Mono-dev] Terminal config for mono csharp shell?">chaselton at gmail.com
       </A><BR>
    <I>Fri Jun 12 09:43:19 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043093.html">[Mono-dev] Terminal config for mono csharp shell?
</A></li>
        <LI>Next message: <A HREF="043105.html">[Mono-dev] Terminal config for mono csharp shell?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43102">[ date ]</a>
              <a href="thread.html#43102">[ thread ]</a>
              <a href="subject.html#43102">[ subject ]</a>
              <a href="author.html#43102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>No need to apologize...busy here too.

I was wrong about asm/ioctl.h BTW.  Right now i'm going through console-unix.c  to figure out what is causing the crash.  Slow work, as i'm not familiar with signal handling at all.

Here's the rest of the strace output, just in case it is helpful. 

27045 00:02:27 --- SIGWINCH (Window changed) @ 0 (0) ---                             27045 00:02:27 ioctl(0, TIOCGWINSZ, {ws_row=59, ws_col=85, ws_xpixel=0, ws_ypixel=0}) = 0
27045 00:02:27 --- SIGSEGV (Segmentation fault) @ 0 (0) ---                          27045 00:02:27 open(&quot;/data/data/jackpal.androidterm/kbox2/dev/log/main&quot;, O_WRONLY|O_LARGEFILE|0x80000) = 4                                                                27045 00:02:27 open(&quot;/data/data/jackpal.androidterm/kbox2/dev/log/radio&quot;, O_WRONLY|O_LARGEFILE|0x80000) = 5                                                               27045 00:02:27 open(&quot;/data/data/jackpal.androidterm/kbox2/dev/log/events&quot;, O_WRONLY|O_LARGEFILE|0x80000) = 6                                                              27045 00:02:27 open(&quot;/data/data/jackpal.androidterm/kbox2/dev/log/system&quot;, O_WRONLY|O_LARGEFILE|0x80000) = 7                                                              27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;Stacktrace:\n\n\0&quot;, 14}], 3) = 23                                                                                27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at
&lt;unknown&gt; &lt;0xffffffff&gt;\n\0&quot;, 29}], 3) = 38                                                                  27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at (wrapper managed-to-native) System.IO.MonoIO.Read (intptr,byte[],int,int,System.IO.MonoIOError&amp;) &lt;0xffffffff&gt;\n\0&quot;, 116}], 3) = 125
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.MonoIO.Read (System.Runtime.InteropServices.SafeHandle,byte[],int,int,System.IO.MonoIOError&amp;) &lt;0x0006f&gt;\n\0&quot;, 120}], 3) = 129                                                          27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.FileStream.ReadData (System.Runtime.InteropServices.SafeHandle,byte[],int,int) &lt;0x00047&gt;\n\0&quot;, 105}], 3) = 114                                                                         27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.FileStream.ReadInternal (byte[],int,int) &lt;0x00087&gt;\n\0&quot;, 67}], 3) = 76                            27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.FileStream.Read (byte[],int,int) &lt;0x000ef&gt;\n\0&quot;, 59}], 3) = 68                                    27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.StreamReader.ReadBuffer () &lt;0x0035f&gt;\n\0&quot;, 53}], 3) = 62                   
                      27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.IO.StreamReader.Read () &lt;0x0005f&gt;\n\0&quot;, 47}], 3) = 56                                                27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.TermInfoDriver.ReadKeyInternal (bool&amp;) &lt;0x00113&gt;\n\0&quot;, 62}], 3) = 71                                 27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.TermInfoDriver.ReadKey (bool) &lt;0x0002b&gt;\n\0&quot;, 53}], 3) = 62                                          27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.ConsoleDriver.ReadKey (bool) &lt;0x00037&gt;\n\0&quot;, 52}], 3) = 61                                           27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at System.Console.ReadKey (bool) &lt;0x0001b&gt;\n\0&quot;, 46}], 3) = 55
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.Terminal.LineEditor.EditLoop () &lt;0x0006b&gt;\n\0&quot;, 53}], 3) = 62
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.Terminal.LineEditor.Edit (string,string) &lt;0x00157&gt;\n\0&quot;, 62}], 3) = 71
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.CSharpShell.GetLine (bool) &lt;0x00093&gt;\n\0&quot;, 48}], 3) = 57
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.CSharpShell.ReadEvalPrintLoopWith (Mono.CSharpShell/ReadLiner) &lt;0x0002f&gt;\n\0&quot;, 84}], 3) = 93
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.CSharpShell.ReadEvalPrintLoop () &lt;0x001a7&gt;\n\0&quot;, 54}], 3) = 63
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.CSharpShell.Run (string[]) &lt;0x00033&gt;\n\0&quot;, 48}], 3) = 57
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at Mono.Driver.Main (string[]) &lt;0x0041f&gt;\n\0&quot;, 44}], 3) = 53
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;  at (wrapper runtime-invoke) &lt;Module&gt;.runtime_invoke_int_object (object,intptr,intptr,intptr) &lt;0xffffffff&gt;\n\0&quot;, 109}], 3) = 118
27045 00:02:27 writev(4, [{&quot;\6&quot;, 1}, {&quot;mono-rt\0&quot;, 8}, {&quot;\n=================================================================\nGot a SIGSEGV while executing native code. This usually indicates\na fatal error in the mono runtime or one of the native libraries \nused by your application.\n=================================================================\n\n\0&quot;, 293}], 3) = 302
27045 00:02:27 sigaction(SIGABRT, {SIG_DFL}, NULL, 0x15980b8) = 0

**snip**

On June 12, 2015 1:02:49 AM CDT, Robert N &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sushihangover at outlook.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>Sorry, been swamped... I'm not sure about the outclass.h, I'll have to
</I>&gt;<i>take a look... I do know that resizing the csharp repo on os-x's
</I>&gt;<i>terminal causes havoc on the its output and the input/output cursor is
</I>&gt;<i>incorrectly moved, that that point it is taking input and sending out
</I>&gt;<i>to the wrong line of the window, but it does not crash as in your case.
</I>&gt;<i>
</I>&gt;&gt;<i> Date: Wed, 10 Jun 2015 11:20:46 -0500
</I>&gt;&gt;<i> Subject: Re: [Mono-dev] Terminal config for mono csharp shell?
</I>&gt;&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">chaselton at gmail.com</A>
</I>&gt;&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sushihangover at outlook.com</A>
</I>&gt;&gt;<i> CC: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'm revisiting this because I uncovered a larger, possibly related,
</I>&gt;&gt;<i> problem with running the newly built csharp REPL.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> When resizing the terminal, csharp exits unexpectedly.  Running
</I>&gt;<i>strace
</I>&gt;&gt;<i> in a separate terminal and attaching it to the csharp PID shows the
</I>&gt;&gt;<i> csharp REPL segfaulting when the terminal is resized (at
</I>&gt;&gt;<i> SIGWINCH...specifically right after the following line is
</I>&gt;&gt;<i> called/executed:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ioctl(0, TIOCGWINSZ, {ws_row=59, ws_col=85, ws_xpixel=0,
</I>&gt;<i>ws_ypixel=0}) = 0
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> My sysroot has an asm/ioctls.h...I'm guessing that it needs to be
</I>&gt;&gt;<i> added to console-unix.c or console-io.c...possibly both.  Am I in the
</I>&gt;&gt;<i> right ballpark?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Sat, Jun 6, 2015 at 10:41 PM, Robert N &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sushihangover at outlook.com</A>&gt;
</I>&gt;<i>wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; stty sane make sense in terms of a TERM=linux and either a messed
</I>&gt;<i>up/missing termcap and/or missing capabilities during autogen/configure
</I>&gt;<i>and shell that is not quite right...
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The fact that the console.unix.c works across all the std linux
</I>&gt;<i>flavors and os-x would suggest that something in your environment is
</I>&gt;<i>different. Not sure what your 'droid dev environment is like, but if
</I>&gt;<i>you can build/debug mono, you can look at how it is init &amp; exiting in
</I>&gt;<i>the app-domain.c/console-io.c/console-unix.c routines.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; It should 'just work', but that requires a very clean environment
</I>&gt;<i>as Mono does an very generic (iffy IMHO) job of tty exiting (also
</I>&gt;<i>init'ing).  If you look at the ConsoleDriver the extent of the tty
</I>&gt;<i>exit/teardown is 'string' that is sent is a hardcoded DC1 signal (0x11)
</I>&gt;<i>which is Ctrl-Q (XON). You can browse the native driver function in
</I>&gt;<i>console-unix.c, it is running on a gc'd thread, the std c lib function
</I>&gt;<i>atexit is called with the tty teardown function and it does a very
</I>&gt;<i>generic teardown (flushing the pipes and setting the ECHO env to true).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Is this right or wrong? Depends upon who you ask ;-) Programs
</I>&gt;<i>written in python have this this issue all the time with using no echo
</I>&gt;<i>tty mode and properly exiting, it is usually a threading issue, but
</I>&gt;<i>hard to prevent. A lot of P-coders just place an os.system('stty sane')
</I>&gt;<i>in their exit code, perl coders place system(&quot;stty sane&quot;);  curses
</I>&gt;<i>users should always use endwin(); reset(); to clean things up, etc...
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The fact that the console.unix.c works across all the std linux
</I>&gt;<i>flavors and os-x would suggest that something in your environment is
</I>&gt;<i>different. Not sure what your 'droid dev environment is like, but if
</I>&gt;<i>you can build/debug mono, you can look at how it is init &amp; exiting in
</I>&gt;<i>the app-domain.c/console-io.c/console-unix.c routines.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ________________________________
</I>&gt;&gt;<i> &gt; From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">chaselton at gmail.com</A>
</I>&gt;&gt;<i> &gt; Date: Sat, 6 Jun 2015 19:39:16 -0500
</I>&gt;&gt;<i> &gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt; Subject: Re: [Mono-dev] Terminal config for mono csharp shell?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Additionally, running 'stty sane' after exiting the REPL solves the
</I>&gt;<i>problem. Maybe there is a way to set the REPL to run a command on
</I>&gt;<i>quitting?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On June 6, 2015 8:04:47 AM CDT, Cyd Haselton &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">chaselton at gmail.com</A>&gt;
</I>&gt;<i>wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Are there any special terminal and/or shell settings I should set
</I>&gt;<i>for the csharp shell?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; csharp works okay...minus some cursor jumping...but after quitting
</I>&gt;<i>the console shell behaves oddly until I exit it and re-enter.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Example:
</I>&gt;&gt;<i> &gt; /home/kbox $ csharp
</I>&gt;&gt;<i> &gt; Mono C# Shell, type &quot;help;&quot; for help
</I>&gt;&gt;<i> &gt; Enter statements below.
</I>&gt;&gt;<i> &gt; csharp&gt; DateTime.Now 06/06/2015 13:00:31
</I>&gt;&gt;<i> &gt; csharp&gt; help &quot;Static methods:
</I>&gt;&gt;<i> &gt; Describe (object); - Describes the object's type
</I>&gt;&gt;<i> &gt; LoadPackage (package); - Loads the given Package (like -pkg:FILE)
</I>&gt;&gt;<i> &gt; LoadAssembly (assembly); - Loads the given assembly (like
</I>&gt;<i>-r:ASSEMBLY)
</I>&gt;&gt;<i> &gt; ShowVars (); - Shows defined local variables.
</I>&gt;&gt;<i> &gt; ShowUsing (); - Show active using declarations.
</I>&gt;&gt;<i> &gt; Prompt - The prompt used by the C# shell
</I>&gt;&gt;<i> &gt; ContinuationPrompt - The prompt for partial input
</I>&gt;&gt;<i> &gt; Time (() =&gt; { }); - Times the specified code
</I>&gt;&gt;<i> &gt; print (obj); - Shorthand for Console.WriteLine
</I>&gt;&gt;<i> &gt; quit; - You'll never believe it - this quits the repl!
</I>&gt;&gt;<i> &gt; help; - This help text
</I>&gt;&gt;<i> &gt; TabAtStartCompletes - Whether tab will complete even on empty lines
</I>&gt;&gt;<i> &gt; &quot;
</I>&gt;&gt;<i> &gt; csharp&gt; quit
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Environment shell after quitting:
</I>&gt;&gt;<i> &gt; /home/kbox $ /home/kbox $ /home/kbox $ /home/kbox $ /home/kbox $
</I>&gt;<i>/home/kbox $ /home/kbox $ &gt;
</I>&gt;<i>/data/data/jackpal.androidterm/kbox2/bin/bash: \: not found
</I>&gt;&gt;<i> &gt; /home/kbox $ /home/kbox $ /home/kbox $ /home/kbox $ /home/kbox $
</I>&gt;<i>/home/kbox $
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; After exiting environment shell...you can't see the 'exit' command
</I>&gt;<i>I typed:
</I>&gt;&gt;<i> &gt; /home/kbox $ 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;&gt;<i> &gt; 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;&gt;<i> &gt; 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;&gt;<i> &gt; 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;&gt;<i> &gt; 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Re-entering the environment shell:
</I>&gt;&gt;<i> &gt; 127|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">u0_a186 at altev</A>:/ $
</I>&gt;<i>/data/data/jackpal.androidterm/kbox2/bin/kbox_shell
</I>&gt;&gt;<i> &gt; /home/kbox $
</I>&gt;&gt;<i> &gt; /home/kbox $
</I>&gt;&gt;<i> &gt; /home/kbox $
</I>&gt;&gt;<i> &gt; /home/kbox $
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; --
</I>&gt;&gt;<i> &gt; Sent from my Android device with K-9 Mail. Please excuse my
</I>&gt;<i>brevity.
</I>&gt;&gt;<i> &gt; _______________________________________________ Mono-devel-list
</I>&gt;<i>mailing list <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 		 	   		  
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043093.html">[Mono-dev] Terminal config for mono csharp shell?
</A></li>
	<LI>Next message: <A HREF="043105.html">[Mono-dev] Terminal config for mono csharp shell?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43102">[ date ]</a>
              <a href="thread.html#43102">[ thread ]</a>
              <a href="subject.html#43102">[ subject ]</a>
              <a href="author.html#43102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
