<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] New profiler (work in progress)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20profiler%20%28work%20in%20progress%29&In-Reply-To=1192137378.3610.41.camel%40Matrix.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025243.html">
   <LINK REL="Next"  HREF="025244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] New profiler (work in progress)</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20profiler%20%28work%20in%20progress%29&In-Reply-To=1192137378.3610.41.camel%40Matrix.ximian.com"
       TITLE="[Mono-dev] New profiler (work in progress)">lupus at ximian.com
       </A><BR>
    <I>Fri Oct 12 12:57:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025243.html">[Mono-dev] New profiler (work in progress)
</A></li>
        <LI>Next message: <A HREF="025244.html">[Mono-dev] New profiler (work in progress)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25245">[ date ]</a>
              <a href="thread.html#25245">[ thread ]</a>
              <a href="subject.html#25245">[ subject ]</a>
              <a href="author.html#25245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/11/07 Massimiliano Mantione wrote:
&gt;<i> Motivations:
</I>&gt;<i> 
</I>&gt;<i> The main issues the current profiler has:
</I>[...]
&gt;<i> - Since it stores everything in memory, its memory usage grows
</I>&gt;<i>   with time.
</I>
Memory usage is not an issue in the old profiler, it uses very little
memory, likely less than this new profiler will.

&gt;<i> Output file format
</I>&gt;<i> 
</I>&gt;<i> We'll describe each block as a sequence of fields, where
</I>&gt;<i> three data types are allowed:
</I>&gt;<i> - BYTE (used only for block codes),
</I>&gt;<i> - INT, and
</I>&gt;<i> - STRING.
</I>&gt;<i> We write strings as null terminated ASCII strings.
</I>
Should be 0 terminated utf8 strings.

&gt;<i> We store integers one byte at a time, seven bits per byte,
</I>&gt;<i> starting from the least significant bits.
</I>&gt;<i> We put the eight bit in the byte to 1 when we write the
</I>&gt;<i> last byte.
</I>
There must be also a int type that is always output as 4 bytes in
little endian.

&gt;<i> Here is the description of the various blocks:
</I>
Note that each block must have a size field (using a 4 byte int)
along with the block code. Also, since blocks are not frequent,
use at least 2 bytes for the block code, for future expansion.
The size will include the size of the header plus any possible data
belonging to the block following the header. This way readers can easily
skip blocks they don't care about or don't recognize. It will also allow
readers to easily check if the profiled program has completed writing
a block by simply comparing the size and they can load the entire block
in a single read, which allows simpler and faster parsing of the data.

&gt;<i> Event block, for common &quot;per thread&quot; events:
</I>&gt;<i> BYTE: block code = 6.
</I>&gt;<i> INTEGER: start counter value.
</I>&gt;<i> INTEGER: thread id.
</I>&gt;<i> INTEGER: base counter value. # All counter values in events are deltas
</I>&gt;<i> # A sequence of the following (events):
</I>&gt;<i> BYTE: event code.
</I>&gt;<i> INTEGER: main event value.
</I>&gt;<i> INTEGER: secondary event value.
</I>
We need to optimize the space used for 3 very common events:
method entry and exit and object allocation, so I suggest the following
encoding.
The 2 low bits of the first byte will encode a type:
	0 method enter
	1 method exit
	2 object allocation
	3 further event type in the upper 6 bits

For the first 3 types, the 6 upper bits will be part of the main event
value, giving 6+7= 13 bits, so up to 8191 methods/classes can be encoded in 2
bytes, while that would require 3 with your encoding (and just 127 could
be stored in 2 bytes, which is too low).

All the other event types can fit into the 64 different values that
remain in the first byte. One of these values should be reserved for the
event type LAST_METHOD_EXITED, which won't emit the method id,
saving more space.

For allocations it is likely worth it to use one of the upper bits in
the first byte for variable-sized vs fixed-size allocations. The first
type of event will have the class id followed by the size. The second
type will omit the size (which will need to be stored in the ID mapping
table or somewhere else). This will save further space in the files.

&gt;<i> # And finally, a 0, which is the end because no event code can be 0.
</I>&gt;<i> BYTE: 0.
</I>
It's better not to waste a value here: we'll have already the size
stored in the block header.

Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025243.html">[Mono-dev] New profiler (work in progress)
</A></li>
	<LI>Next message: <A HREF="025244.html">[Mono-dev] New profiler (work in progress)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25245">[ date ]</a>
              <a href="thread.html#25245">[ thread ]</a>
              <a href="subject.html#25245">[ subject ]</a>
              <a href="author.html#25245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
