<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mcs math performance enhancement
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20math%20performance%20enhancement&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025352.html">
   <LINK REL="Next"  HREF="025357.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mcs math performance enhancement</H1>
    <B>Jaroslav Hajek</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20math%20performance%20enhancement&In-Reply-To="
       TITLE="[Mono-dev] mcs math performance enhancement">highegg at gmail.com
       </A><BR>
    <I>Sat Oct 20 05:01:12 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025352.html">[Mono-dev] AutoResetEvent
</A></li>
        <LI>Next message: <A HREF="025357.html">[Mono-dev] mcs math performance enhancement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25353">[ date ]</a>
              <a href="thread.html#25353">[ thread ]</a>
              <a href="subject.html#25353">[ subject ]</a>
              <a href="author.html#25353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

problem:
As C# does not have an exponentiation operato, programmers will
typically use the
expression &quot;x*x&quot; to get a square of x. There is Math.Pow, but only for
doubles and likely
to be inefficient for this simple case. This is a fairly common idiom
even for C/C++ math programmers who can use pow(T,int).
Mcs (1.2.5.1 release) does not recognize this special case, and emits
two loads for the variable (or struct or class field, which is
longer), instead of the obvious dup-mul sequence (which can easily
identify the &quot;calculate square&quot; idiom for JIT)

solution:
the attached tiny patch for source file mcs/mcs/expression.cs resolves
the problem.
also attached is a testcase that verifies that the optimization works correctly
(this must be, however, compiled against .NET 2.0, i.e. with gmcs, to
be able to acces the method body at runtime).

This is my first contribution to any OS project; therefore, I
apologize if I'm (unknowingly) not following some normal conventions.

Q: Can I build just the C# compiler without building the runtime (i.e.
against the existing installation)? I couldn't figure out a simple
way.

best,

-- 
Jaroslav Hajek
research engineer
Aeronautical Research and Test Institute (VZLU)
Prague, Czech Republic
-------------- next part --------------
A non-text attachment was scrubbed...
Name: patch_sqr_optimization
Type: application/octet-stream
Size: 208 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071020/71554e8b/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071020/71554e8b/attachment.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test_sqr_optimization.cs
Type: text/x-csharp
Size: 1800 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071020/71554e8b/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071020/71554e8b/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025352.html">[Mono-dev] AutoResetEvent
</A></li>
	<LI>Next message: <A HREF="025357.html">[Mono-dev] mcs math performance enhancement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25353">[ date ]</a>
              <a href="thread.html#25353">[ thread ]</a>
              <a href="subject.html#25353">[ subject ]</a>
              <a href="author.html#25353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
