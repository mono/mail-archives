<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono:MIPS patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%3AMIPS%20patch&In-Reply-To=u3aw9i78w.wl%25nakayama%40pixela.co.jp">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025312.html">
   <LINK REL="Next"  HREF="025372.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono:MIPS patch</H1>
    <B>Yoichi NAKAYAMA</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%3AMIPS%20patch&In-Reply-To=u3aw9i78w.wl%25nakayama%40pixela.co.jp"
       TITLE="[Mono-dev] Mono:MIPS patch">nakayama at pixela.co.jp
       </A><BR>
    <I>Fri Oct 19 04:11:05 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025312.html">[Mono-dev] Mono:MIPS patch
</A></li>
        <LI>Next message: <A HREF="025372.html">[Mono-dev] Mono:MIPS patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25343">[ date ]</a>
              <a href="thread.html#25343">[ thread ]</a>
              <a href="subject.html#25343">[ subject ]</a>
              <a href="author.html#25343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

At Thu, 18 Oct 2007 09:41:51 +0900,
Yoichi NAKAYAMA wrote:
&gt;<i> With those changes, I've checked that &quot;mono --regression basic-long.exe&quot;
</I>&gt;<i> passes except test_0_conv_to_r4 (tested on Debian-MIPS on qemu).
</I>
Then I've investigated test_0_conv_to_r4 failure.
Dump of __emul_lconv_to_r4 generated by &quot;mono -v -v&quot; is:

  00000000 &lt;System_Object___icall_wrapper___emul_lconv_to_r4&gt;:
  ...snip...
    e8:   8fc20154        lw      v0,340(s8)
    ec:   8fc30150        lw      v1,336(s8)
    f0:   00602020        add     a0,v1,zero
    f4:   00402820        add     a1,v0,zero
    f8:   3c190056        lui     t9,0x56
    fc:   27392f44        addiu   t9,t9,12100
   100:   0320f809        jalr    t9              # 0x562F44 == mono_lconv_to_r4
   104:   00000000        nop
   108:   462004a0        cvt.s.d $f18,$f0
   10c:   e7d20020        swc1    $f18,32(s8)
   110:   c7c00020        lwc1    $f0,32(s8)
   114:   46000021        cvt.d.s $f0,$f0
   118:   f7c00028        sdc1    $f0,40(s8)
  ...snip...

At 108, it assumes return value of mono_lconv_to_r4 is stored
on f0 as double precision float. Although, it is stored as single
precision float, then wrong value seems to be returned.

% objdump -r -d jit-icalls.o 
  00000234 &lt;mono_lconv_to_r4&gt;:
       234:       3c1c0000        lui     gp,0x0
                          234: R_MIPS_HI16        _gp_disp
       238:       279c0000        addiu   gp,gp,0
                          238: R_MIPS_LO16        _gp_disp
       23c:       0399e021        addu    gp,gp,t9
       240:       27bdffe0        addiu   sp,sp,-32
       244:       afbf0018        sw      ra,24(sp)
       248:       afbc0010        sw      gp,16(sp)
       24c:       8f990000        lw      t9,0(gp)
                          24c: R_MIPS_CALL16      __floatdisf
       250:       00000000        nop
       254:       0320f809        jalr    t9
       258:       00000000        nop
       25c:       8fbc0010        lw      gp,16(sp)
       260:       8fbf0018        lw      ra,24(sp)
       264:       00000000        nop
       268:       03e00008        jr      ra
       26c:       27bd0020        addiu   sp,sp,32

I've changed mono_lconv_to_r4's return type to double,
and confirmed that mono passes test_0_conv_to_r4 on MIPS.

Is it a correct fix? I wonder why this was not a problem on
other platforms (arm, hppa, ppc, s390 and sparc where
MONO_ARCH_EMULATE_LCONV_TO_R4 is defined).

Regards,
-- 
Yoichi NAKAYAMA
Pixela Corporation
-------------- next part --------------
A non-text attachment was scrubbed...
Name: mono_lconv_to_r4.patch
Type: application/octet-stream
Size: 1429 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071019/69ac4c81/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20071019/69ac4c81/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025312.html">[Mono-dev] Mono:MIPS patch
</A></li>
	<LI>Next message: <A HREF="025372.html">[Mono-dev] Mono:MIPS patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25343">[ date ]</a>
              <a href="thread.html#25343">[ thread ]</a>
              <a href="subject.html#25343">[ subject ]</a>
              <a href="author.html#25343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
