<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] String.Split() broken behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20String.Split%28%29%20broken%20behavior&In-Reply-To=4708A985.8000804%40tlarson.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025221.html">
   <LINK REL="Next"  HREF="025316.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] String.Split() broken behavior</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20String.Split%28%29%20broken%20behavior&In-Reply-To=4708A985.8000804%40tlarson.com"
       TITLE="[Mono-dev] [PATCH] String.Split() broken behavior">lupus at ximian.com
       </A><BR>
    <I>Fri Oct 12 14:36:51 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025221.html">[Mono-dev] [PATCH] String.Split() broken behavior
</A></li>
        <LI>Next message: <A HREF="025316.html">[Mono-dev] [PATCH] String.Split() broken behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25246">[ date ]</a>
              <a href="thread.html#25246">[ thread ]</a>
              <a href="subject.html#25246">[ subject ]</a>
              <a href="author.html#25246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/07/07 Tyler Larson wrote:
&gt;<i> Attached is a revised patch to the String.Split problem. This patch now 
</I>&gt;<i> includes code cleanup to bring it in conformance with the published coding 
</I>&gt;<i> standards as well as unit tests relevant to the changes I made.
</I>
I guess this is the patch that Joel committed to svn.
I had to revert it, mostly because it broke the build: the same tests
it introduces were failing and it wasn't reviewed and approved.
There are other issues with the patch that I'll point out below.

&gt;<i> --- mcs/class/corlib/System/String.cs	(revision 87045)
</I>&gt;<i> +++ mcs/class/corlib/System/String.cs	(working copy)
</I>&gt;<i> @@ -216,12 +216,11 @@
</I>&gt;<i>  			if (count == 1) 
</I>&gt;<i>  				return new String[1] { ToString() };
</I>&gt;<i>  
</I>&gt;<i> -			return InternalSplit (separator, count);
</I>&gt;<i> +			return InternalSplit (separator, count, 0);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  #if NET_2_0
</I>&gt;<i>  		[ComVisible (false)]
</I>&gt;<i> -		[MonoDocumentationNote (&quot;optimization&quot;)]
</I>
Since the code is not optimized, please don't remove this.

&gt;<i> @@ -2461,7 +2441,7 @@
</I>&gt;<i>  		private extern void InternalCopyTo (int sIndex, char[] dest, int destIndex, int count);
</I>&gt;<i>  
</I>&gt;<i>  		[MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i> -		private extern String[] InternalSplit (char[] separator, int count);
</I>&gt;<i> +		private extern String[] InternalSplit (char[] separator, int count, int options);
</I>
A change in an icall signature requires a change to the corlib internal
version.

&gt;<i> --- mcs/class/corlib/Test/System/StringTest.cs	(revision 87045)
</I>&gt;<i> +++ mcs/class/corlib/Test/System/StringTest.cs	(working copy)
</I>&gt;<i> @@ -1898,6 +1898,68 @@
</I>&gt;<i>  		AssertEquals (&quot;B&quot;, res [1]);
</I>&gt;<i>  		AssertEquals (&quot;C&quot;, res [2]);
</I>&gt;<i>  	}
</I>&gt;<i> +	
</I>&gt;<i> +	[Test]
</I>&gt;<i> +	public void SplitStringChars()
</I>&gt;<i> +	{
</I>&gt;<i> +		String[] res;
</I>&gt;<i> +
</I>&gt;<i> +		// count == 0
</I>&gt;<i> +		res = &quot;..A..B..&quot;.Split (new Char[] { '.' }, 0, StringSplitOptions.None);
</I>&gt;<i> +		AssertEquals (&quot;#01-01&quot;, 0, res.Length);
</I>&gt;<i> +
</I>&gt;<i> +		// count == 1
</I>&gt;<i> +		res = &quot;..A..B..&quot;.Split (new Char[] { '.' }, 1, StringSplitOptions.None);
</I>&gt;<i> +		AssertEquals (&quot;#02-01&quot;, 1, res.Length);
</I>&gt;<i> +		AssertEquals (&quot;#02-02&quot;, &quot;..A..B..&quot;, res[0]);
</I>&gt;<i> +
</I>&gt;<i> +		// count == 1 + RemoveEmpty
</I>&gt;<i> +		res = &quot;..A..B..&quot;.Split (new Char[] { '.' }, 1, StringSplitOptions.RemoveEmptyEntries);
</I>&gt;<i> +		AssertEquals (&quot;#03-01&quot;, 1, res.Length);
</I>
I think it was this test failing. You can check by running
	make run-test PROFILE=net_2_0
in mcs/class/corlib.

&gt;<i> Index: mono/mono/metadata/string-icalls.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/metadata/string-icalls.c	(revision 87045)
</I>&gt;<i> +++ mono/mono/metadata/string-icalls.c	(working copy)
</I>&gt;<i> @@ -97,8 +97,14 @@
</I>&gt;<i>  	memcpy(destptr, src + sindex, sizeof(gunichar2) * count);
</I>&gt;<i>  }
</I>&gt;<i>  
</I>&gt;<i> +/* System.StringSplitOptions */
</I>&gt;<i> +typedef enum {
</I>&gt;<i> +	STRINGSPLITOPTIONS_NONE = 0,
</I>&gt;<i> +	STRINGSPLITOPTIONS_REMOVE_EMPTY_ENTRIES = 1
</I>&gt;<i> +} StringSplitOptions;
</I>&gt;<i> +
</I>&gt;<i>  MonoArray * 
</I>&gt;<i> -ves_icall_System_String_InternalSplit (MonoString *me, MonoArray *separator, gint32 count)
</I>&gt;<i> +ves_icall_System_String_InternalSplit (MonoString *me, MonoArray *separator, gint32 count, gint32 options)
</I>&gt;<i>  {
</I>&gt;<i>  	MonoString * tmpstr;
</I>&gt;<i>  	MonoArray * retarr;
</I>&gt;<i> @@ -106,65 +112,143 @@
</I>&gt;<i>  	gint32 arrsize, srcsize, splitsize;
</I>&gt;<i>  	gint32 i, lastpos, arrpos;
</I>&gt;<i>  	gint32 tmpstrsize;
</I>&gt;<i> +	gint32 remempty;
</I>&gt;<i> +	gint32 flag;
</I>&gt;<i>  	gunichar2 *tmpstrptr;
</I>&gt;<i>  
</I>&gt;<i>  	gunichar2 cmpchar;
</I>&gt;<i>  
</I>&gt;<i>  	MONO_ARCH_SAVE_REGS;
</I>&gt;<i>  
</I>&gt;<i> -	src = mono_string_chars(me);
</I>&gt;<i> -	srcsize = mono_string_length(me);
</I>&gt;<i> -	arrsize = mono_array_length(separator);
</I>&gt;<i> +	remempty = options &amp; STRINGSPLITOPTIONS_REMOVE_EMPTY_ENTRIES;
</I>&gt;<i> +	src = mono_string_chars (me);
</I>&gt;<i> +	srcsize = mono_string_length (me);
</I>&gt;<i> +	arrsize = mono_array_length (separator);
</I>&gt;<i>  
</I>&gt;<i> -	cmpchar = mono_array_get(separator, gunichar2, 0);
</I>&gt;<i> +	splitsize = 1;
</I>&gt;<i> +	/* Count the number of elements we will return. Note that this operation
</I>&gt;<i> +	 * guarantees that we will return exactly splitsize elements, and we will
</I>&gt;<i> +	 * have enough data to fill each. This allows us to skip some checks later on.
</I>&gt;<i> +	 */
</I>&gt;<i> +	if (remempty == 0) {
</I>&gt;<i> +		for (i = 0; i != srcsize &amp;&amp; splitsize &lt; count; i++) 
</I>&gt;<i> +			if (string_icall_is_in_array (separator, arrsize, src[i]))
</I>
You need a space before square brackets.

&gt;<i> +				splitsize++;
</I>&gt;<i> +	}
</I>&gt;<i> +	else {
</I>
This needs to go into a sinfle line.

&gt;<i> +		/* Require pattern &quot;Nondelim + Delim + Nondelim&quot; to increment counter.
</I>&gt;<i> +		 * Lastpos != 0 means first nondelim found.
</I>&gt;<i> +		 * Flag = 0 means last char was delim.
</I>&gt;<i> +		 * Efficient, though perhaps confusing.
</I>&gt;<i> +		 */
</I>&gt;<i> +		lastpos = 0;
</I>&gt;<i> +		flag = 0;
</I>&gt;<i> +		for (i = 0; i != srcsize &amp;&amp; splitsize &lt; count; i++) {
</I>&gt;<i> +			if (string_icall_is_in_array (separator, arrsize, src[i]))
</I>&gt;<i> +				flag = 0;
</I>&gt;<i> +			else if (flag == 0) {
</I>
If you introduce parens, use them in all the branches of an if/else
sequence.

&gt;<i> +				if (lastpos == 1)
</I>&gt;<i> +					splitsize++;
</I>&gt;<i> +				flag = 1;
</I>&gt;<i> +				lastpos = 1;
</I>&gt;<i> +			}
</I>&gt;<i> +		}
</I>&gt;<i>  
</I>&gt;<i> -	splitsize = 0;
</I>&gt;<i> -	for (i = 0; i != srcsize &amp;&amp; splitsize &lt; count; i++) {
</I>&gt;<i> -		if (string_icall_is_in_array(separator, arrsize, src[i]))
</I>&gt;<i> -			splitsize++;
</I>&gt;<i> +		/* Nothing but separators */
</I>&gt;<i> +		if (lastpos == 0)
</I>&gt;<i> +		{
</I>
The open curly brace goes in the same line as the if.

&gt;<i> +	if (splitsize == 1) {
</I>&gt;<i> +		if (remempty == 0 || count == 1)
</I>&gt;<i> +		{
</I>
Same.

&gt;<i> +			/* Copy the whole string */
</I>&gt;<i> +			retarr = mono_array_new (mono_domain_get(), mono_get_string_class (), 1);
</I>&gt;<i> +			mono_array_setref (retarr, 0, me);
</I>&gt;<i> +		}
</I>&gt;<i> +		else 
</I>&gt;<i> +		{
</I>
Wrong formatting, it should be &quot; } else {&quot; in one line.

&gt;<i> +			/* otherwise we have to filter out leading &amp; trailing delims */
</I>&gt;<i>  
</I>&gt;<i> +			/* find first non-delim char */
</I>&gt;<i> +			for ( ; srcsize != 0; srcsize--, src++)
</I>&gt;<i> +				if (!string_icall_is_in_array (separator, arrsize, src[0]))
</I>&gt;<i> +					break;
</I>
Non trivial for loops should have curly braces. A space is needed before
brackets. Some of the same style issues are all over the place,I won't
list them all.

When the changes are made and the tests actually pass, since this is
runtime code we need either an explicit signoff that the code is
contributed under the X11 license or a copyright assignment.

Sorry it took so long for the patch review.

Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025221.html">[Mono-dev] [PATCH] String.Split() broken behavior
</A></li>
	<LI>Next message: <A HREF="025316.html">[Mono-dev] [PATCH] String.Split() broken behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25246">[ date ]</a>
              <a href="thread.html#25246">[ thread ]</a>
              <a href="subject.html#25246">[ subject ]</a>
              <a href="author.html#25246">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
