<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Replicating System.Web.Script.Serialization bugs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replicating%20System.Web.Script.Serialization%20bugs&In-Reply-To=7BBDA1BF-B864-40B3-B14A-BF046778834F%40monkeypox.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025250.html">
   <LINK REL="Next"  HREF="025256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Replicating System.Web.Script.Serialization bugs</H1>
    <B>Konstantin Triger</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replicating%20System.Web.Script.Serialization%20bugs&In-Reply-To=7BBDA1BF-B864-40B3-B14A-BF046778834F%40monkeypox.org"
       TITLE="[Mono-dev] Replicating System.Web.Script.Serialization bugs">kostat at mainsoft.com
       </A><BR>
    <I>Mon Oct 15 05:14:20 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025250.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
        <LI>Next message: <A HREF="025256.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25254">[ date ]</a>
              <a href="thread.html#25254">[ thread ]</a>
              <a href="subject.html#25254">[ subject ]</a>
              <a href="author.html#25254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Tyler,

1. Your code must come AFTER 'if (type == null)' for obvious reasons.
The best place would be just before 'return Convert.ChangeType (obj,
type);' at the end of the function.

2. Please add the following test cases (passing on MS .Net):
 Converting to Nullable&lt;&gt; from empty and non-empty strings.

3. Please commit the code below for performance reasons.
a. 'is' and casting are much cheaper.
b. don't need to create an instance, returning null should be OK, isn't?

+                       /*
+                        * Take care of the special case whereas in JSON
an empty string (&quot;&quot;) really means 
+                        * an empty value 
+                        * (see:
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=328836">https://bugzilla.novell.com/show_bug.cgi?id=328836</A>)
+                        */
+                       if ( (type.IsGenericType) &amp;&amp;
(type.GetGenericTypeDefinition() == typeof(Nullable&lt;&gt;)) )
+                       {
+                               if ( (obj is String) &amp;&amp;
(((String)obj).Length == 0) )
+                               {
+                                       return null;
+                               }
+                       }
+

Regards,
Konstantin Triger

&gt;<i> -----Original Message-----
</I>&gt;<i> From: R. Tyler Ballance [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tyler at monkeypox.org</A>]
</I>&gt;<i> Sent: Sunday, October 14, 2007 7:13 AM
</I>&gt;<i> To: Adar Wesley
</I>&gt;<i> Cc: Konstantin Triger; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-dev] Replicating System.Web.Script.Serialization
</I>bugs
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Oct 1, 2007, at 10:17 AM, Adar Wesley wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi Kosta and Tyler,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Having worked on this code with Kosta and following this thread a
</I>&gt;<i> &gt; couple of questions come to my mind.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. Are there any other types that need special care, besides
</I>&gt;<i> &gt; Nullable?  How about generic types?
</I>&gt;<i> &gt;     As far as I remember, we don't have any tests with generics.
</I>&gt;<i> &gt; Are we missing anything else?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2. I was trying to think of a good strategy for implementing this,
</I>&gt;<i> &gt; and havn't made up my mind yet.
</I>&gt;<i> &gt;     I agree with Kosta that the try, catch approach is not the best
</I>&gt;<i> &gt; way.  I think something a bit more fine grained
</I>&gt;<i> &gt;     should be used.  What would happen if the value is &quot;xxx&quot; and
</I>&gt;<i> &gt; the type is &quot;int?&quot;?  This should probably
</I>&gt;<i> &gt;     throw the error and not silently assign the null value.
</I>&gt;<i> &gt; (Requires a test with MS code...)
</I>&gt;<i> 
</I>&gt;<i> Coming back to this, since I'm hacking on it right now. A value of
</I>&gt;<i> &quot;xxx&quot;  _will_ throw an InvalidCastException, whereas an empty string
</I>&gt;<i> will not.
</I>&gt;<i> 
</I>&gt;<i> I think I might be overcomplicating this, the only possible valid
</I>&gt;<i> JSON syntax for an empty value seems to be &quot;&quot;, I've got the following
</I>&gt;<i> patch that I'm waiting on &quot;peer-review&quot; to commit.
</I>&gt;<i> 
</I>&gt;<i> It handles the case in <A HREF="https://bugzilla.novell.com/show_bug.cgi?">https://bugzilla.novell.com/show_bug.cgi?</A>
</I>&gt;<i> id=328836 with regards to mimicking the .NET behavior for empty JSON
</I>&gt;<i> values with regards to Nullable types. It'll still throw on &quot;xxx&quot;
</I>&gt;<i> values that are attempting to be converted to long/int/etc.
</I>&gt;<i> 
</I>&gt;<i> Konstantin, just say the word and it'll be committed, otherwise, I'm
</I>&gt;<i> at a lose for solutions to handle this :-P
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> -R. Tyler Ballance
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025250.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
	<LI>Next message: <A HREF="025256.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25254">[ date ]</a>
              <a href="thread.html#25254">[ thread ]</a>
              <a href="subject.html#25254">[ subject ]</a>
              <a href="author.html#25254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
