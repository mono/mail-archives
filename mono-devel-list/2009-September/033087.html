<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20hangs%20on%20shutdown%20when%20/dev/ttySx%20ports%20were%0A%09opened.&In-Reply-To=295e750a0909210503m6da7dbbex55b542e6d3ba351b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033072.html">
   <LINK REL="Next"  HREF="033088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.</H1>
    <B>Leszek Ciesielski</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20hangs%20on%20shutdown%20when%20/dev/ttySx%20ports%20were%0A%09opened.&In-Reply-To=295e750a0909210503m6da7dbbex55b542e6d3ba351b%40mail.gmail.com"
       TITLE="[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.">skolima at gmail.com
       </A><BR>
    <I>Tue Sep 22 05:35:08 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033072.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
        <LI>Next message: <A HREF="033088.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33087">[ date ]</a>
              <a href="thread.html#33087">[ thread ]</a>
              <a href="subject.html#33087">[ subject ]</a>
              <a href="author.html#33087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'll repeat my question if you'll excuse me:

Zoltan (or anyone else knowing how this works) could you please
explain how the mono/mono/support/*.c code should execute native
blocking calls so that the runtime can shutdown correctly? From
reading into threads.c I am now guessing that the runtime does not
signal the native threads in any way, it just waits for a managed
thread switch to inject ThreadAbortException - is this a correct
assumption? If yes, then the blocking native calls should return every
few seconds (or probably even more often) and force the managed thread
switch with Thread.Sleep() so as to give the runtime the opportunity
to terminate them in an orderly manner. I think I can fix the serial.c
code, I just have to understand better how it should behave to avoid
locking.

Regards,

skolima

On Mon, Sep 21, 2009 at 2:03 PM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> &#160; This is very tricky problem. The runtime waits for all application threads
</I>&gt;<i> to finish before exiting in order to have a predictable shutdown and to be
</I>&gt;<i> compatible with ms.net. If we didn't
</I>&gt;<i> wait for them, and started to free up the runtime data structures, then one
</I>&gt;<i> of the running threads could&#160; access the freed data and crash/misbehave. You
</I>&gt;<i> might want to try to
</I>&gt;<i> close the file descriptor the thread is waiting on, that might break the
</I>&gt;<i> wait.
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Zoltan
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 21, 2009 at 10:07 AM, Christian Hoff &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">christian_hoff at gmx.net</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Leszek Ciesielski wrote:
</I>&gt;&gt;<i> &gt; I am experiencing Mono hangup when my application should terminate.
</I>&gt;&gt;<i> &gt; The application opens multiple serial ports, but the bug has also
</I>&gt;&gt;<i> &gt; manifested when network sockets were hanging on reads or writes - it
</I>&gt;&gt;<i> &gt; seems to be related to a pending I/O operation, asynchronous
</I>&gt;&gt;<i> &gt; networking helps somewhat. Anyway, the managed code exits, Mono CPU
</I>&gt;&gt;<i> &gt; usage jumps to 100%, /proc/PID/status shows 4 threads and the
</I>&gt;&gt;<i> &gt; application never exits.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> Great to see that this issue is being actively worked on! I'm
</I>&gt;&gt;<i> experiencing the same problem with my application which uses serial
</I>&gt;&gt;<i> ports. The workaround I'm using so far is to set the read timeout to
</I>&gt;&gt;<i> something about 500.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As you have probably figured out already, the problem seems to be that
</I>&gt;&gt;<i> Mono does not abort calls to native API. SerialPort.ReadByte pinvokes a
</I>&gt;&gt;<i> blocking function in MonoPosixHelper.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not sure if native API calls should be aborted by the Mono runtime.
</I>&gt;&gt;<i> Maybe the best solution here is to see how the func is implemented in
</I>&gt;&gt;<i> MonoPosixHelper and see if we possibly avoid the blocking native call.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Christian
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033072.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
	<LI>Next message: <A HREF="033088.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33087">[ date ]</a>
              <a href="thread.html#33087">[ thread ]</a>
              <a href="subject.html#33087">[ subject ]</a>
              <a href="author.html#33087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
