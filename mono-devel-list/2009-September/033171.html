<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Garbage collection breaks Oracle client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Garbage%20collection%20breaks%20Oracle%20client&In-Reply-To=7FC245ECC3E43243B415E1610AD617FD5FA9C5%40mail1.dundee.realtimeworlds.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033169.html">
   <LINK REL="Next"  HREF="033170.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Garbage collection breaks Oracle client</H1>
    <B>Veerapuram Varadhan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Garbage%20collection%20breaks%20Oracle%20client&In-Reply-To=7FC245ECC3E43243B415E1610AD617FD5FA9C5%40mail1.dundee.realtimeworlds.com"
       TITLE="[Mono-dev] Garbage collection breaks Oracle client">vvaradhan at novell.com
       </A><BR>
    <I>Wed Sep 30 12:09:52 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033169.html">[Mono-dev] Garbage collection breaks Oracle client
</A></li>
        <LI>Next message: <A HREF="033170.html">[Mono-dev] Will a Mono 2.6 build for OS X become available	 in	the preview ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33171">[ date ]</a>
              <a href="thread.html#33171">[ thread ]</a>
              <a href="subject.html#33171">[ subject ]</a>
              <a href="author.html#33171">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Warren,

Attached patch works fine for the test program.  Can you apply this
patch and try once?  If things go fine, would you mind filing a bug - so
that I can commit the patch to other branches as well.

TIA,

V. Varadhan

On Wed, 2009-09-30 at 15:05 +0100, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">warren.puziewicz at realtimeworlds.com</A>
wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> We are building an application on Mono with an Oracle database.  We
</I>&gt;<i> are currently using Mono 2.5 built from source in June.  We recently
</I>&gt;<i> started testing the most recent build from source, and have discovered
</I>&gt;<i> an issue between garbage collection and the Oracle client.   After a
</I>&gt;<i> number of operations, a bind parameter will have a few extra bytes of
</I>&gt;<i> garbage appended.  This does not happen on the earlier build.  It can
</I>&gt;<i> be prevented on the latest build if the environment variable
</I>&gt;<i> GC_DONT_GC is set.  Below is information on our environment, a section
</I>&gt;<i> of an Oracle client side trace file with the bad data highlighted,
</I>&gt;<i> code to reproduce the error.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Our platform is:
</I>&gt;<i> 
</I>&gt;<i> $ uname -s -r -v -p -i -o
</I>&gt;<i> 
</I>&gt;<i> Linux 2.6.18-92.1.13.el5 #1 SMP Wed Sep 24 19:32:05 EDT 2008 x86_64
</I>&gt;<i> x86_64 GNU/Linux
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> (Failure occurs on this version of Mono)
</I>&gt;<i> 
</I>&gt;<i> $ mono -V
</I>&gt;<i> 
</I>&gt;<i> Mono JIT compiler version 2.5 (/trunk/mono r142988 Wed Sep 30 13:19:23
</I>&gt;<i> BST 2009)
</I>&gt;<i> 
</I>&gt;<i> Copyright (C) 2002-2008 Novell, Inc and Contributors.
</I>&gt;<i> www.mono-project.com
</I>&gt;<i> 
</I>&gt;<i>         TLS:           __thread
</I>&gt;<i> 
</I>&gt;<i>         GC:            Included Boehm (with typed GC and Parallel
</I>&gt;<i> Mark)
</I>&gt;<i> 
</I>&gt;<i>         SIGSEGV:       altstack
</I>&gt;<i> 
</I>&gt;<i>         Notifications: epoll
</I>&gt;<i> 
</I>&gt;<i>         Architecture:  amd64
</I>&gt;<i> 
</I>&gt;<i>         Disabled:      none
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> (Works fine on this version of Mono)
</I>&gt;<i> 
</I>&gt;<i> $ mono -V
</I>&gt;<i> 
</I>&gt;<i> Mono JIT compiler version 2.5 (/trunk/mono r137147 Tue Jun 30 14:46:43
</I>&gt;<i> BST 2009)
</I>&gt;<i> 
</I>&gt;<i> Copyright (C) 2002-2008 Novell, Inc and Contributors.
</I>&gt;<i> www.mono-project.com
</I>&gt;<i> 
</I>&gt;<i>         TLS:           __thread
</I>&gt;<i> 
</I>&gt;<i>         GC:            Included Boehm (with typed GC and Parallel
</I>&gt;<i> Mark)
</I>&gt;<i> 
</I>&gt;<i>         SIGSEGV:       altstack
</I>&gt;<i> 
</I>&gt;<i>         Notifications: epoll
</I>&gt;<i> 
</I>&gt;<i>         Architecture:  amd64
</I>&gt;<i> 
</I>&gt;<i>         Disabled:      none
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Oracle client libraries are: Instant Client 11.1.0.7.0 (x64)
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ==== The exception generated ====
</I>&gt;<i> 
</I>&gt;<i> Unhandled Exception: System.Data.OracleClient.OracleException:
</I>&gt;<i> ORA-01722: invalid number
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>   at System.Data.OracleClient.Oci.OciStatementHandle.Execute (Boolean
</I>&gt;<i> nonQuery, Boolean useAutoCommit, Boolean schemaOnly) [0x00000]
</I>&gt;<i> 
</I>&gt;<i>   at System.Data.OracleClient.Oci.OciStatementHandle.ExecuteNonQuery
</I>&gt;<i> (Boolean useAutoCommit) [0x00000]
</I>&gt;<i> 
</I>&gt;<i>   at System.Data.OracleClient.OracleCommand.ExecuteNonQueryInternal
</I>&gt;<i> (System.Data.OracleClient.Oci.OciStatementHandle statement, Boolean
</I>&gt;<i> useAutoCommit) [0x00000]
</I>&gt;<i> 
</I>&gt;<i>   at System.Data.OracleClient.OracleCommand.ExecuteNonQuery ()
</I>&gt;<i> [0x00000]
</I>&gt;<i> 
</I>&gt;<i>   at (wrapper remoting-invoke-with-check)
</I>&gt;<i> System.Data.OracleClient.OracleCommand:ExecuteNonQuery ()
</I>&gt;<i> 
</I>&gt;<i>   at ADOTest.Program.ExecSQLTest2 (Int32 numRows) [0x00000]
</I>&gt;<i> 
</I>&gt;<i>   at ADOTest.Program.Main (System.String[] args) [0x00000]
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ==== Snippet from Oracle client trace file ====
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013678 : nsbasic_bsd:00 00 00 00 FE 40 49 4E
</I>&gt;<i> |....&#254;@IN|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013696 : nsbasic_bsd:53 45 52 54 20 49 4E 54  |
</I>&gt;<i> SERT.INT|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013723 : nsbasic_bsd:4F 20 64 61 74 61 5F 74  |
</I>&gt;<i> O.data_t|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013742 : nsbasic_bsd:65 73 74 20 28 63 6F 6C  |
</I>&gt;<i> est.(col|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013770 : nsbasic_bsd:5F 6F 6E 65 2C 20 63 6F  |
</I>&gt;<i> _one,.co|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013788 : nsbasic_bsd:6C 5F 74 77 6F 2C 20 63  |
</I>&gt;<i> l_two,.c|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013806 : nsbasic_bsd:6F 6C 5F 74 68 72 65 65  |
</I>&gt;<i> ol_three|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013824 : nsbasic_bsd:29 20 56 41 4C 55 45 53
</I>&gt;<i> |).VALUES|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013842 : nsbasic_bsd:20 28 3A 70 31 2C 0A 20
</I>&gt;<i> |.(:p1,..|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013860 : nsbasic_bsd:3A 70 32 2C 20 3A 70 33
</I>&gt;<i> |:p2,.:p3|
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.013878 : nsbasic_bsd:29 00 01 00 00 00 01 00
</I>&gt;<i> |).......|
</I>&gt;<i> 
</I>&gt;<i> [snipped]
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.014297 : nsbasic_bsd:00 07 03 31 32 33 04 34
</I>&gt;<i> |...123.4|  &lt;= length of bind var includes the bad byte
</I>&gt;<i> 
</I>&gt;<i> 2009-09-30 14:28:30.014315 : nsbasic_bsd:35 36 16 03 37 38 39     |
</I>&gt;<i> 56..789 |  &lt;= extra byte of garbage data
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Starting at the 3rd byte of the next to last line:
</I>&gt;<i> 
</I>&gt;<i> &#8220;03 31 32 33&#8221; = 3 bytes, values &#8220;123&#8221;
</I>&gt;<i> 
</I>&gt;<i> &#8220;04 34 35 36 16&#8221; = 4 bytes, values &#8220;456&#8221; + 1 garbage byte
</I>&gt;<i> 
</I>&gt;<i> &#8220;37 38 39&#8221; = 3 bytes, values &#8220;789&#8221;
</I>&gt;<i> 
</I>&gt;<i> In this case, the second parameter (value &#8216;456&#8217;) had an extra byte
</I>&gt;<i> (0x16) appended.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ==== To reproduce ====
</I>&gt;<i> 
</I>&gt;<i> using System;
</I>&gt;<i> 
</I>&gt;<i> using System.Data.OracleClient;
</I>&gt;<i> 
</I>&gt;<i> /*  Inserts requested number of rows into a table.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> CREATE TABLE data_test (
</I>&gt;<i> 
</I>&gt;<i>   col_one NUMBER(10,0),
</I>&gt;<i> 
</I>&gt;<i>   col_two NUMBER(10,0),
</I>&gt;<i> 
</I>&gt;<i>   col_three NUMBER(10,0)
</I>&gt;<i> 
</I>&gt;<i> )
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Compiled with:
</I>&gt;<i> 
</I>&gt;<i>  mcs program.cs -r:System.Data.OracleClient
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Execute (fail):
</I>&gt;<i> 
</I>&gt;<i>  mono program.exe 500
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Execute (succeed):
</I>&gt;<i> 
</I>&gt;<i>  GC_DONT_GC=YES mono program.exe 500
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> */
</I>&gt;<i> 
</I>&gt;<i> namespace ADOTest
</I>&gt;<i> 
</I>&gt;<i> {
</I>&gt;<i> 
</I>&gt;<i>     class Program
</I>&gt;<i> 
</I>&gt;<i>     {
</I>&gt;<i> 
</I>&gt;<i>         private const string ConnStr = &quot;SERVER=dev;User
</I>&gt;<i> ID=testuser;Password=testuser;&quot;;
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>         static void ExecSQLTest2(int numRows)
</I>&gt;<i> 
</I>&gt;<i>         {
</I>&gt;<i> 
</I>&gt;<i>             OracleConnection conn = new OracleConnection(ConnStr);
</I>&gt;<i> 
</I>&gt;<i>             conn.Open();
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>             for (int i = 0; i &lt; numRows; i++)
</I>&gt;<i> 
</I>&gt;<i>             {
</I>&gt;<i> 
</I>&gt;<i>                 if ((i % 100) == 0)
</I>&gt;<i> 
</I>&gt;<i>                 {
</I>&gt;<i> 
</I>&gt;<i>                   Console.Write(&quot;.&quot;);
</I>&gt;<i> 
</I>&gt;<i>                 }
</I>&gt;<i> 
</I>&gt;<i>                 OracleCommand cmd = conn.CreateCommand();
</I>&gt;<i> 
</I>&gt;<i>                 cmd.CommandText = &quot;INSERT INTO data_test (col_one,
</I>&gt;<i> col_two, col_three) VALUES (:p1, :p2, :p3)&quot;;
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>                 OracleParameter p1 = new OracleParameter(&quot;p1&quot;,
</I>&gt;<i> OracleType.Number);
</I>&gt;<i> 
</I>&gt;<i>                 OracleParameter p2 = new OracleParameter(&quot;p2&quot;,
</I>&gt;<i> OracleType.Number);
</I>&gt;<i> 
</I>&gt;<i>                 OracleParameter p3 = new OracleParameter(&quot;p3&quot;,
</I>&gt;<i> OracleType.Number);
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>                 p1.Value = 1;
</I>&gt;<i> 
</I>&gt;<i>                 p2.Value = 1;
</I>&gt;<i> 
</I>&gt;<i>                 p3.Value = 1;
</I>&gt;<i> 
</I>&gt;<i>                 cmd.Parameters.Add(p1);
</I>&gt;<i> 
</I>&gt;<i>                 cmd.Parameters.Add(p2);
</I>&gt;<i> 
</I>&gt;<i>                 cmd.Parameters.Add(p3);
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>                 cmd.ExecuteNonQuery();
</I>&gt;<i> 
</I>&gt;<i>             }
</I>&gt;<i> 
</I>&gt;<i>             conn.Close();
</I>&gt;<i> 
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>         static void Main(string[] args)
</I>&gt;<i> 
</I>&gt;<i>         {
</I>&gt;<i> 
</I>&gt;<i>             int numRows =  System.Convert.ToInt16(args[0]);
</I>&gt;<i> 
</I>&gt;<i>             ExecSQLTest2(numRows);
</I>&gt;<i> 
</I>&gt;<i>             Console.WriteLine(&quot;Done.&quot;);
</I>&gt;<i> 
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Warren Puziewicz
</I>&gt;<i> 
</I>&gt;<i> Database Architect
</I>&gt;<i> 
</I>&gt;<i> Realtime Worlds, Ltd
</I>&gt;<i> 
</I>&gt;<i> 152 West Marketgait
</I>&gt;<i> 
</I>&gt;<i> Dundee DD1 1NJ
</I>&gt;<i> 
</I>&gt;<i> +44 (0) 01382 202821
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ____________________________________________________________________
</I>&gt;<i> Check out NEoN, a ground-breaking digital arts festival taking place
</I>&gt;<i> in Dundee on 13th-14th November 2009
</I>&gt;<i> <A HREF="http://www.northeastofnorth.ning.com">http://www.northeastofnorth.ning.com</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> DISCLAIMER
</I>&gt;<i> 
</I>&gt;<i> This message and any attachments contain privileged and confidential
</I>&gt;<i> information intended for the use of the addressee named above. If you
</I>&gt;<i> are not the intended recipient of this message, you are hereby
</I>&gt;<i> notified that any use, dissemination, distribution or reproduction of
</I>&gt;<i> this message is prohibited. Please note that we cannot guarantee that
</I>&gt;<i> this message or any attachment is virus free or that it has not been
</I>&gt;<i> intercepted and amended. The views of the author may not necessarily
</I>&gt;<i> reflect those of Realtime Worlds Ltd.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Realtime Worlds Ltd is registered in Scotland, number 225628.
</I>&gt;<i> Registered Office: 152 West Marketgait, Dundee, DD1 1NJ.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: bind-corrupt-gc.fix
Type: text/x-patch
Size: 689 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090930/cbc4ad85/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090930/cbc4ad85/attachment.bin</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033169.html">[Mono-dev] Garbage collection breaks Oracle client
</A></li>
	<LI>Next message: <A HREF="033170.html">[Mono-dev] Will a Mono 2.6 build for OS X become available	 in	the preview ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33171">[ date ]</a>
              <a href="thread.html#33171">[ thread ]</a>
              <a href="subject.html#33171">[ subject ]</a>
              <a href="author.html#33171">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
