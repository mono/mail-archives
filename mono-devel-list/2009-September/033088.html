<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20hangs%20on%20shutdown%20when%20/dev/ttySx%20ports%20were%0A%09opened.&In-Reply-To=23a15590909220235h15514a7bt28c445912612a900%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033087.html">
   <LINK REL="Next"  HREF="033093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20hangs%20on%20shutdown%20when%20/dev/ttySx%20ports%20were%0A%09opened.&In-Reply-To=23a15590909220235h15514a7bt28c445912612a900%40mail.gmail.com"
       TITLE="[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.">vargaz at gmail.com
       </A><BR>
    <I>Tue Sep 22 06:36:31 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033087.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
        <LI>Next message: <A HREF="033093.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33088">[ date ]</a>
              <a href="thread.html#33088">[ thread ]</a>
              <a href="subject.html#33088">[ subject ]</a>
              <a href="author.html#33088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

  Yes the runtime only aborts threads which execute native code when they
return to
managed code.

                  Zoltan

On Tue, Sep 22, 2009 at 11:35 AM, Leszek Ciesielski &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">skolima at gmail.com</A>&gt;wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'll repeat my question if you'll excuse me:
</I>&gt;<i>
</I>&gt;<i> Zoltan (or anyone else knowing how this works) could you please
</I>&gt;<i> explain how the mono/mono/support/*.c code should execute native
</I>&gt;<i> blocking calls so that the runtime can shutdown correctly? From
</I>&gt;<i> reading into threads.c I am now guessing that the runtime does not
</I>&gt;<i> signal the native threads in any way, it just waits for a managed
</I>&gt;<i> thread switch to inject ThreadAbortException - is this a correct
</I>&gt;<i> assumption? If yes, then the blocking native calls should return every
</I>&gt;<i> few seconds (or probably even more often) and force the managed thread
</I>&gt;<i> switch with Thread.Sleep() so as to give the runtime the opportunity
</I>&gt;<i> to terminate them in an orderly manner. I think I can fix the serial.c
</I>&gt;<i> code, I just have to understand better how it should behave to avoid
</I>&gt;<i> locking.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> skolima
</I>&gt;<i>
</I>&gt;<i> On Mon, Sep 21, 2009 at 2:03 PM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   This is very tricky problem. The runtime waits for all application
</I>&gt;<i> threads
</I>&gt;<i> &gt; to finish before exiting in order to have a predictable shutdown and to
</I>&gt;<i> be
</I>&gt;<i> &gt; compatible with ms.net. If we didn't
</I>&gt;<i> &gt; wait for them, and started to free up the runtime data structures, then
</I>&gt;<i> one
</I>&gt;<i> &gt; of the running threads could  access the freed data and crash/misbehave.
</I>&gt;<i> You
</I>&gt;<i> &gt; might want to try to
</I>&gt;<i> &gt; close the file descriptor the thread is waiting on, that might break the
</I>&gt;<i> &gt; wait.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                               Zoltan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Mon, Sep 21, 2009 at 10:07 AM, Christian Hoff &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">christian_hoff at gmx.net</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Leszek Ciesielski wrote:
</I>&gt;<i> &gt;&gt; &gt; I am experiencing Mono hangup when my application should terminate.
</I>&gt;<i> &gt;&gt; &gt; The application opens multiple serial ports, but the bug has also
</I>&gt;<i> &gt;&gt; &gt; manifested when network sockets were hanging on reads or writes - it
</I>&gt;<i> &gt;&gt; &gt; seems to be related to a pending I/O operation, asynchronous
</I>&gt;<i> &gt;&gt; &gt; networking helps somewhat. Anyway, the managed code exits, Mono CPU
</I>&gt;<i> &gt;&gt; &gt; usage jumps to 100%, /proc/PID/status shows 4 threads and the
</I>&gt;<i> &gt;&gt; &gt; application never exits.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; Great to see that this issue is being actively worked on! I'm
</I>&gt;<i> &gt;&gt; experiencing the same problem with my application which uses serial
</I>&gt;<i> &gt;&gt; ports. The workaround I'm using so far is to set the read timeout to
</I>&gt;<i> &gt;&gt; something about 500.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; As you have probably figured out already, the problem seems to be that
</I>&gt;<i> &gt;&gt; Mono does not abort calls to native API. SerialPort.ReadByte pinvokes a
</I>&gt;<i> &gt;&gt; blocking function in MonoPosixHelper.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I'm not sure if native API calls should be aborted by the Mono runtime.
</I>&gt;<i> &gt;&gt; Maybe the best solution here is to see how the func is implemented in
</I>&gt;<i> &gt;&gt; MonoPosixHelper and see if we possibly avoid the blocking native call.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Christian
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mono-devel-list mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090922/8d0067bd/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090922/8d0067bd/attachment.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033087.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
	<LI>Next message: <A HREF="033093.html">[Mono-dev] Mono hangs on shutdown when /dev/ttySx ports were	opened.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33088">[ date ]</a>
              <a href="thread.html#33088">[ thread ]</a>
              <a href="subject.html#33088">[ subject ]</a>
              <a href="author.html#33088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
