<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Getting rid of String.InternalSetLength
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Getting%20rid%20of%20String.InternalSetLength&In-Reply-To=f54ff3e80912031002s4a65c581wc61a794c839ba8ed%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033637.html">
   <LINK REL="Next"  HREF="033647.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Getting rid of String.InternalSetLength</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Getting%20rid%20of%20String.InternalSetLength&In-Reply-To=f54ff3e80912031002s4a65c581wc61a794c839ba8ed%40mail.gmail.com"
       TITLE="[Mono-dev] Getting rid of String.InternalSetLength">lupus at ximian.com
       </A><BR>
    <I>Fri Dec  4 10:28:02 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033637.html">[Mono-dev] Getting rid of String.InternalSetLength
</A></li>
        <LI>Next message: <A HREF="033647.html">[Mono-dev] Getting rid of String.InternalSetLength
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33646">[ date ]</a>
              <a href="thread.html#33646">[ thread ]</a>
              <a href="subject.html#33646">[ subject ]</a>
              <a href="author.html#33646">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/09 Mark Probst wrote:
&gt;<i> SGen, our new garbage collector, doesn't explicitly store an object's
</I>&gt;<i> size but determines it via the object's vtable and, in the case of
</I>&gt;<i> arrays and strings, via the length field.  String.InternalSetLength
</I>&gt;<i> changes that length field, which means that, from SGen's view, the
</I>&gt;<i> string's size changes.  That's a problem because depending on an
</I>&gt;<i> object's size it is either stored in a regular heap section or, if it
</I>&gt;<i> is larger than a certain threshold, in the large object section (LOS).
</I>&gt;<i>  SGen depends on being able to distinguish between the two, so it must
</I>&gt;<i> not happen that an object changes size, i.e. we have to get rid of
</I>&gt;<i> String.InternalSetLength, which is used by StringBuilder.
</I>&gt;<i> 
</I>&gt;<i> The attached patch fixes this problem, but of course it has to do more
</I>&gt;<i> copying.  Does anybody object to this?  Any alternatives?
</I>
Good catch for this issue.
I think we should keep the optimization. To fix it it should be enough
to add a check for the problematic case: if setting the new length would
change the storage space, the copy codepath is taken instead.

Let's have this in String.cs:

	static readonly int LOS_length = GetLOSLength (); // icall optimized by the jit to a constant.

and then you can have:

&gt;<i> --- System.Text/StringBuilder.cs	(revision 147553)
</I>&gt;<i> +++ System.Text/StringBuilder.cs	(working copy)
</I>&gt;<i> @@ -207,8 +207,7 @@
</I>&gt;<i>  			if (null != _cached_str)
</I>&gt;<i>  				return _cached_str;
</I>&gt;<i>  
</I>&gt;<i> -			// If we only have a half-full buffer we return a new string.
</I>&gt;<i> -			if (_length &lt; (_str.Length &gt;&gt; 1)) 
</I>&gt;<i> +			if (_length &lt; (_str.Length &gt;&gt; 1) || (_str.Length &gt;= string.LOS_length &amp;&amp; _length &lt; string.LOS_length))
</I>&gt;<i>  			{
</I>&gt;<i>  				// use String.SubstringUnchecked instead of String.Substring
</I>&gt;<i>  				// as the former is guaranteed to create a new string object
</I>
lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033637.html">[Mono-dev] Getting rid of String.InternalSetLength
</A></li>
	<LI>Next message: <A HREF="033647.html">[Mono-dev] Getting rid of String.InternalSetLength
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33646">[ date ]</a>
              <a href="thread.html#33646">[ thread ]</a>
              <a href="subject.html#33646">[ subject ]</a>
              <a href="author.html#33646">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
