<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for Processes.c on Mac OSX
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20Processes.c%20on%20Mac%20OSX&In-Reply-To=1259798580.4513.626.camel%40erandi.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033624.html">
   <LINK REL="Next"  HREF="033609.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for Processes.c on Mac OSX</H1>
    <B>Tom Philpot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20Processes.c%20on%20Mac%20OSX&In-Reply-To=1259798580.4513.626.camel%40erandi.site"
       TITLE="[Mono-dev] Patch for Processes.c on Mac OSX">tom.philpot at logos.com
       </A><BR>
    <I>Wed Dec  2 19:46:27 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033624.html">[Mono-dev] Patch for Processes.c on Mac OSX
</A></li>
        <LI>Next message: <A HREF="033609.html">[Mono-dev] [patch] Fixing the &#171;crazy inheritance chain walking&#187; for parameters custom attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33627">[ date ]</a>
              <a href="thread.html#33627">[ thread ]</a>
              <a href="subject.html#33627">[ subject ]</a>
              <a href="author.html#33627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The purpose of the loop is because if sysctl fails to alloc enough space in
the second call, proclength is set to the length of data returned, not to
the length of the data that could/should have been returned, so we have to
start over again by passing NULL to sysctl to determine how big proclength
should have been and try again.

Tom

On 12/2/09 4:03 PM, &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at novell.com</A>&gt; wrote:

&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;&gt;<i> The overall patch looks good, but some small changes must be done
</I>&gt;&gt;<i> before the patch can be committed:
</I>&gt;<i> 
</I>&gt;<i> In addition to these comments, I fail to see the point of the do/while
</I>&gt;<i> loop, it seems to not be used at all.   Can you explain the reason for
</I>&gt;<i> it?   I might be missing something important.
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> @@ -1489,8 +1489,73 @@
</I>&gt;&gt;<i>  }
</I>&gt;&gt;<i>  #endif /* UNUSED_CODE */
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> +#ifdef PLATFORM_MACOSX
</I>&gt;&gt;<i> +#include &lt;sys/sysctl.h&gt;
</I>&gt;&gt;<i> +#include &lt;sys/proc.h&gt;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> Move header declarations to the top of the file. It doesn't matter we have
</I>&gt;&gt;<i> other
</I>&gt;&gt;<i> place with this, let's not make it worse.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> +  if (err == 0) {
</I>&gt;&gt;<i> +   result = g_malloc (proclength);
</I>&gt;&gt;<i> +   if (result == NULL) {
</I>&gt;&gt;<i> +    err = ENOMEM;
</I>&gt;&gt;<i> +   }
</I>&gt;&gt;<i> +  }
</I>&gt;&gt;<i> No need to guard against allocation failure with g_malloc as glib asserts on
</I>&gt;&gt;<i> failure.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The same applies to the loop around allocation failure.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> + free (result);
</I>&gt;&gt;<i> + result = NULL;
</I>&gt;&gt;<i> + *needed = j * sizeof(guint32);
</I>&gt;&gt;<i> You must use g_free paired with g_malloc.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I believe the code in process_open_compare is not optimal for OSX as
</I>&gt;&gt;<i> it wastes time following the
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> linux path. Please rework it to be something saner:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #if defined(PLATFORM_MACOSX)
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> #elif defined (PLATFORM_SOLARIS)
</I>&gt;&gt;<i> #else
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> #endif
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks for the patch,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Rodrigo
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033624.html">[Mono-dev] Patch for Processes.c on Mac OSX
</A></li>
	<LI>Next message: <A HREF="033609.html">[Mono-dev] [patch] Fixing the &#171;crazy inheritance chain walking&#187; for parameters custom attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33627">[ date ]</a>
              <a href="thread.html#33627">[ thread ]</a>
              <a href="subject.html#33627">[ subject ]</a>
              <a href="author.html#33627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
