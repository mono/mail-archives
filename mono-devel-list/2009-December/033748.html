<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] XSP server patches that solve HTTP 400 Bad Request Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20XSP%20server%20patches%20that%20solve%20HTTP%20400%20Bad%20Request%20Issue&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033746.html">
   <LINK REL="Next"  HREF="033749.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] XSP server patches that solve HTTP 400 Bad Request Issue</H1>
    <B>Vadym Stetsiak</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20XSP%20server%20patches%20that%20solve%20HTTP%20400%20Bad%20Request%20Issue&In-Reply-To="
       TITLE="[Mono-dev] XSP server patches that solve HTTP 400 Bad Request Issue">vadmyst at gmail.com
       </A><BR>
    <I>Fri Dec 18 12:16:12 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033746.html">[Mono-dev] ReaderWriterLockSlim implementation
</A></li>
        <LI>Next message: <A HREF="033749.html">[Mono-dev] Announcing DbLinq 0.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33748">[ date ]</a>
              <a href="thread.html#33748">[ thread ]</a>
              <a href="subject.html#33748">[ subject ]</a>
              <a href="author.html#33748">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Under moderate load XSP server starts corrupting incoming HTTP
requests. This results in 400 Bad Request responses from XSP server.
The reason is in HTTP header parsing code that does not correctly
handle situations when HTTP request data is received in small chunks.

Here are two patches for &quot;/trunk/xsp/src/Mono.WebServer/XSPWorkerRequest.cs&quot;

Index: XSPWorkerRequest.cs
===================================================================
--- XSPWorkerRequest.cs	(revision 148762)
+++ XSPWorkerRequest.cs	(working copy)
@@ -265,7 +265,8 @@
 				if (count &gt;= 8192 || count + text.Length &gt;= 8192)
 					throw new InvalidOperationException (&quot;Line too long.&quot;);

-				if (count &lt;= 0) {
+				if (count &lt;= 0 &amp;&amp; b != '\r')
+                {
 					position = i + 1;
 					break;
 				}
@@ -275,7 +276,7 @@

 				if (i &gt;= inputLength) {
 					b = inputBuffer [inputLength - 1];
-					if (b != '\r' &amp;&amp; b != '\n')
+					if (/*b != '\r' &amp;&amp;*/ b != '\n')
 						continue;
 				}
 				break;


And the second one for /trunk/xsp/src/Mono.WebServer/InitialWorkerRequest.cs
Index: InitialWorkerRequest.cs
===================================================================
--- InitialWorkerRequest.cs	(revision 148762)
+++ InitialWorkerRequest.cs	(working copy)
@@ -173,17 +173,18 @@
 				if (count &gt;= 8192 || count + text.Length &gt;= 8192)
 					throw new InvalidOperationException (&quot;Line too long.&quot;);

-				if (count &lt;= 0) {
-					position = i + 1;
-					break;
-				}
+                if (count &lt;= 0 &amp;&amp; b != '\r')
+                {
+                    position = i + 1;
+                    break;
+                }

 				text.Append (encoding.GetString (inputBuffer, position, count));
 				position = i + 1;

 				if (i &gt;= inputLength) {
 					b = inputBuffer [inputLength - 1];
-					if (b != '\r' &amp;&amp; b != '\n')
+					if (/*b != '\r' &amp;&amp;*/ b != '\n')
 						continue;
 				}
 				break;


-- 
Vadym Stetsiak
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033746.html">[Mono-dev] ReaderWriterLockSlim implementation
</A></li>
	<LI>Next message: <A HREF="033749.html">[Mono-dev] Announcing DbLinq 0.19
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33748">[ date ]</a>
              <a href="thread.html#33748">[ thread ]</a>
              <a href="subject.html#33748">[ subject ]</a>
              <a href="author.html#33748">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
