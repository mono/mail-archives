<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] A question about passing string-parameters when	calling a Dll writing in C using p/invoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20A%20question%20about%20passing%20string-parameters%20when%0A%09calling%20a%20Dll%20writing%20in%20C%20using%20p/invoke&In-Reply-To=%3CDE2F2906-270A-43A5-8662-FFF916FEFCC3%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041268.html">
   <LINK REL="Next"  HREF="041269.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] A question about passing string-parameters when	calling a Dll writing in C using p/invoke</H1>
    <B>Brandon Perry</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20A%20question%20about%20passing%20string-parameters%20when%0A%09calling%20a%20Dll%20writing%20in%20C%20using%20p/invoke&In-Reply-To=%3CDE2F2906-270A-43A5-8662-FFF916FEFCC3%40gmail.com%3E"
       TITLE="[Mono-dev] A question about passing string-parameters when	calling a Dll writing in C using p/invoke">bperry.volatile at gmail.com
       </A><BR>
    <I>Tue Mar 18 17:38:24 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041268.html">[Mono-dev] A question about passing string-parameters when calling a Dll writing in C using p/invoke
</A></li>
        <LI>Next message: <A HREF="041269.html">[Mono-dev] Inconsistent value in System.Diagnostics.DefaultTraceListener.AssertUiEnabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41271">[ date ]</a>
              <a href="thread.html#41271">[ thread ]</a>
              <a href="subject.html#41271">[ subject ]</a>
              <a href="author.html#41271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dont use CharSet.Ansi. Try CharSet.Unicode.

Sent from a computer

&gt;<i> On Mar 11, 2014, at 7:55 AM, &quot;Wang Jiteng&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">imwjt at 163.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Nowadays I'm working on a project in which I need to call encryption and decryption  functions. These functions are written in C and have been compiled into a DLL under windows(visual studio 2010). 
</I>&gt;<i> 
</I>&gt;<i> The functions in the DLL(which is called Cypher.dll) are:
</I>&gt;<i> unsigned long decrypt(unsigned char *reval, const char *in, unsigned long len )
</I>&gt;<i> 
</I>&gt;<i> and
</I>&gt;<i> unsigned long encrypt(char *out, const unsigned char *data, unsigned long len)
</I>&gt;<i> 
</I>&gt;<i> In my C# codes, I re-write these two functions with :
</I>&gt;<i>     [DllImport(&quot;Cypher.dll&quot;, CharSet=CharSet.Ansi, CallingConvention=CallingConvention.Cdecl, EntryPoint = &quot;decrypt&quot;)]   
</I>&gt;<i>         public  extern static uint decrypt([Out] ref byte reval,ref byte c,uint len);
</I>&gt;<i> /*
</I>&gt;<i> reval: the decrypted text 
</I>&gt;<i> c: the cypher text to be decrypted.
</I>&gt;<i> len: text length (the fellow who gave me the dll said this parameter can be assigned by any value,so I usually assigned it by c.Length)
</I>&gt;<i> */
</I>&gt;<i>     [DllImport(&quot;Cypher.dll&quot;, CharSet=CharSet.Ansi,CallingConvention=CallingConvention.Cdecl, EntryPoint = &quot;encrypt&quot;)]
</I>&gt;<i>         public  extern static uint encrypt(ref byte ou,ref byte data, uint len);
</I>&gt;<i> /*
</I>&gt;<i> out: the encrypted cypher text
</I>&gt;<i> data:the text to be encrypted, which usually is a path like &quot;C:\\Users\\downtown\\Desktop\\something\\test&quot; or &quot;C:\\Users\\downtown\\Desktop\\&#27979;&#35797;&#38598;\\test&quot; (I)
</I>&gt;<i> len: text length
</I>&gt;<i> */
</I>&gt;<i> 
</I>&gt;<i> Compared with calling the Cypher.dll direclty in C codes, the &quot;encrypt&quot; function always works correctly. The &quot;decrypt&quot; function works fine if the input parameter &quot;data&quot; in &quot;encrypt&quot; are standard ASCII charaters. 
</I>&gt;<i> But when I add some CHINESE characters(I'm a Chinese progammer btw. Forgive my poor English :P ) like &quot;C:\\Users\\downtown\\Desktop\\&#27979;&#35797;&#38598;\\test&quot;. 
</I>&gt;<i> The &quot;decrypt&quot; result goes wrong, which is &quot;C:\\Users\\downtown\\Desktop\\&#27979;&#35797;&#38598;\\t&quot; (some characters in the end of the string are cut off).
</I>&gt;<i> 
</I>&gt;<i> if I input &quot;C:\\Users\\downtown\\Desktop\\&#27979;&#35797;\\test&quot;, the &quot;decrypt&quot; is &quot;C:\\Users\\downtown\\Desktop\\&#27979;&#35797;\\te&quot;
</I>&gt;<i> 
</I>&gt;<i> It is interesting because each Chinese character takes two byte (in ANSI or UTF8). But the &quot;decrypt&quot; function seems retain just one byte for each Chinese character.
</I>&gt;<i> So When 3 Chinese characters(&#27979;&#35797;&#38598;) exists in the string, after decrypted, they &quot;eat&quot; 3 bytes('e','s' and 't') at the of the string.
</I>&gt;<i> When 2 Chinese characters(&#27979;&#35797;) exists in the string, after decrypted, they &quot;eat&quot; 2 bytes('s' and 't') at the of the string.
</I>&gt;<i> 
</I>&gt;<i> Dose anybody knows why that happens???
</I>&gt;<i> 
</I>&gt;<i> and the codes to call these fuctions above are:
</I>&gt;<i> //Encrypt function;
</I>&gt;<i>       public string EncryptParameters(string args)
</I>&gt;<i>       {
</I>&gt;<i>         byte[] plainBytes = System.Text.Encoding.Default.GetBytes(args);
</I>&gt;<i>         int cypher_maxlen = args.Length*2+16;
</I>&gt;<i> //prepare the cypher text byte array
</I>&gt;<i>         byte[] c = new byte[cypher_maxlen];
</I>&gt;<i>         int i=0;
</I>&gt;<i> 
</I>&gt;<i>         CFunction.encrypt(ref c[0],ref plainBytes[0], (uint)args.Length);
</I>&gt;<i> 
</I>&gt;<i>         for(i=0;c[i]!=0 &amp;&amp; i&lt;cypher_maxlen;i++)//;
</I>&gt;<i>                 Console.Write(c[i]+&quot; &quot;);
</I>&gt;<i> 
</I>&gt;<i>         string cypher_str = System.Text.Encoding.Default.GetString(c, 0, i);
</I>&gt;<i>         return cypher_str;
</I>&gt;<i>       }
</I>&gt;<i> 
</I>&gt;<i> //Decrypt Function
</I>&gt;<i>       public string DecryptParameters(string args)
</I>&gt;<i>       {
</I>&gt;<i>         int plain_maxlen = args.Length;
</I>&gt;<i> 
</I>&gt;<i> //add a '\0' to the end, or the &quot;decrypt&quot; function goes wrong sometime.
</I>&gt;<i>         string args_with_end = args + &quot;\0&quot;;
</I>&gt;<i>         byte[] cypherBytes = System.Text.Encoding.Default.GetBytes(args_with_end);
</I>&gt;<i>         int i=0;
</I>&gt;<i> 
</I>&gt;<i> //prepare the byte array of decrypted text
</I>&gt;<i>         byte[] p = new byte[plain_maxlen];
</I>&gt;<i>         CFunction.decrypt(p,cypherBytes,(uint)cypherBytes.Length);
</I>&gt;<i> 
</I>&gt;<i>         for(i=0;p[i]!=0 &amp;&amp; i&lt;plain_maxlen;i++);
</I>&gt;<i>         string plain_str = System.Text.Encoding.Default.GetString(p, 0, i);
</I>&gt;<i>         return plain_str;
</I>&gt;<i>       }
</I>&gt;<i> 
</I>&gt;<i> and I call these two functions above like:
</I>&gt;<i>          string cypher_args = EncryptParaments(init_args);
</I>&gt;<i>          string plain_args = DecryptParaments(cypher_args);
</I>&gt;<i> and the string plain_args are not always correct as I mentioned. 
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140318/e75d2a2e/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140318/e75d2a2e/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041268.html">[Mono-dev] A question about passing string-parameters when calling a Dll writing in C using p/invoke
</A></li>
	<LI>Next message: <A HREF="041269.html">[Mono-dev] Inconsistent value in System.Diagnostics.DefaultTraceListener.AssertUiEnabled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41271">[ date ]</a>
              <a href="thread.html#41271">[ thread ]</a>
              <a href="subject.html#41271">[ subject ]</a>
              <a href="author.html#41271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
