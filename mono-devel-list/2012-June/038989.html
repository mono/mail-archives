<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Fix for a 5 year old bug - not yet submitted - opinions	welcome
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Fix%20for%20a%205%20year%20old%20bug%20-%20not%20yet%20submitted%20-%20opinions%0A%09welcome&In-Reply-To=%3C4FCEB9FF.3090808%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038983.html">
   <LINK REL="Next"  HREF="038990.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Fix for a 5 year old bug - not yet submitted - opinions	welcome</H1>
    <B>Rob Wilkens</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Fix%20for%20a%205%20year%20old%20bug%20-%20not%20yet%20submitted%20-%20opinions%0A%09welcome&In-Reply-To=%3C4FCEB9FF.3090808%40gmail.com%3E"
       TITLE="[Mono-dev] Fix for a 5 year old bug - not yet submitted - opinions	welcome">robwilkens at gmail.com
       </A><BR>
    <I>Wed Jun  6 02:01:35 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038983.html">[Mono-dev] I'm probably extending the delay on my pull request by doing this, but..
</A></li>
        <LI>Next message: <A HREF="038990.html">[Mono-dev] DataGrid.cs and multiple branches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38989">[ date ]</a>
              <a href="thread.html#38989">[ thread ]</a>
              <a href="subject.html#38989">[ subject ]</a>
              <a href="author.html#38989">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I still have to clean up the code, and create a branch, and submit it, 
but i just fixed a 5 year old bug and if anyone has issues with how i 
did it here is a summary....

the problem report is here:
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=323154">https://bugzilla.novell.com/show_bug.cgi?id=323154</A>

I found by deduction that the repaint wasn't cancelling the active edit 
box after the row was deleted ..  So while the table updated, the edit 
box with the old value didn't go away...  The repaint was from an 
Invalidate call which stack trace looked something like this:

System.Windows.Forms.DataGrid.CalcAreasAndInvalidate()
    at System.Windows.Forms.DataGrid.RecreateDataGridRows(Boolean recalc)
    at 
System.Windows.Forms.DataGrid.OnListManagerItemChanged(System.Object 
sender, System.Windows.Forms.ItemChangedEventArgs e)
    at 
System.Windows.Forms.CurrencyManager.OnItemChanged(System.Windows.Forms.ItemChangedEventArgs 
e)
    at System.Windows.Forms.CurrencyManager.UpdateIsBinding()
    at 
System.Windows.Forms.CurrencyManager.ListChangedHandler(System.Object 
sender, System.ComponentModel.ListChangedEventArgs e)
    at 
System.Data.DataView.OnListChanged(System.ComponentModel.ListChangedEventArgs 
e)
    at System.Data.DataView.OnRowDeleted(System.Object sender, 
System.Data.DataRowChangeEventArgs args)
    at 
System.Data.DataTable.OnRowDeleted(System.Data.DataRowChangeEventArgs e)
    at System.Data.DataTable.DeletedDataRow(System.Data.DataRow dr, 
DataRowAction action)
    at System.Data.DataRow.Delete()
    at System.Data.DataView.Delete(Int32 index)
    at System.Data.DataRowView.Delete()
    at grid.ProcessCmdKey(Message ByRef msg, Keys keyData)
(etc)

ProcessCmdKey is from user code in sample in bug report...

After the delete, the first thing the DataGrid gets back is an 
OnListManagerItemChanged (as can be seen in stack above)...

Before that would call RecreateDataGridRows(), if it was going to do 
that, i inserted a check to see if we're editing, and if so, i cancel 
the edit, here is a summary of what my patch will look like in 
ONListManagerItemChanged in DataGrid.cs in System.Windows.Forms directory:

                                 if (rows == null || RowsCount != 
rows.Length - (ShowEditRow ? 1 : 0))
+                             {
+                                        if (is_editing)
+                                                CancelEditing ();
                                          RecreateDataGridRows (true);
+                             }

This solved the problem reported.  It is now identical to windows .net 
behavior from what i can see.

I've got to clean up my debug code, and again create a github branch and 
put this change in it, unit tests ran and seem unchanged by this..I 
can't imagine a unit test for this necessarily because it's a 
visual/click-required kind of thing.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120605/1bd47cce/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120605/1bd47cce/attachment-0001.html</A>&gt;
</PRE>















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038983.html">[Mono-dev] I'm probably extending the delay on my pull request by doing this, but..
</A></li>
	<LI>Next message: <A HREF="038990.html">[Mono-dev] DataGrid.cs and multiple branches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38989">[ date ]</a>
              <a href="thread.html#38989">[ thread ]</a>
              <a href="subject.html#38989">[ subject ]</a>
              <a href="author.html#38989">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
