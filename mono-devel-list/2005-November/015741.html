<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Optimization to System.Collections.Generic.List
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Optimization%20to%20System.Collections.Generic.List&In-Reply-To=1131822025.22460.63.camel%40omega.res.cmu.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015737.html">
   <LINK REL="Next"  HREF="015735.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Optimization to System.Collections.Generic.List</H1>
    <B>Laurent Debacker</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Optimization%20to%20System.Collections.Generic.List&In-Reply-To=1131822025.22460.63.camel%40omega.res.cmu.edu"
       TITLE="[Mono-dev] [PATCH] Optimization to System.Collections.Generic.List">debackerl at gmail.com
       </A><BR>
    <I>Sat Nov 12 15:28:53 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015737.html">[Mono-dev] [PATCH] Optimization to System.Collections.Generic.List
</A></li>
        <LI>Next message: <A HREF="015735.html">[Mono-dev] DatePicker ASP.NET control
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15741">[ date ]</a>
              <a href="thread.html#15741">[ thread ]</a>
              <a href="subject.html#15741">[ subject ]</a>
              <a href="author.html#15741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Oops yeah I saw the problem with my while, and thank you for the
explaination about structs.

List.patch1 includes the optimization with a for loop.
List.patch2 includes the above patch plus a little optimization to the
enumerator.

If you want exact results on an Intel P3 Mobile 750Mhz running MS .NET
2.0 (20000 iterations with 10000 elements)
MS's List.ForEach: 5.61 secs
Mono's List.ForEach: 15.20 secs
My List.ForEach: 4.63 secs

MS's foreach loop: 7.24 secs
Mono's foreach loop: 11.24 secs
My foreach loop: 10.74 secs

Laurent.

On 11/12/05, Ben Maurer &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt; wrote:
&gt;<i> On Sat, 2005-11-12 at 19:13 +0100, Laurent Debacker wrote:
</I>&gt;<i> &gt; Hi!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The file is a modified version of
</I>&gt;<i> &gt; mcs/class/corlib/System.Collections.Generic/List.cs revision 52947.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've modified the ForEach method so that it no longer uses the
</I>&gt;<i> &gt; enumerator. This avoids a lot of method calls to Enumerator (and the
</I>&gt;<i> &gt; creation of yet another Enumerator object).
</I>&gt;<i>
</I>&gt;<i> The Enumerator is a struct, it is allocated on the stack. So, your patch
</I>&gt;<i> just inlines the methods. With our current jit, this is probably faster,
</I>&gt;<i> first we aren't doing inlining, second even if we did inline, the struct
</I>&gt;<i> would always be on the stack, with int variables, we can keep it in a
</I>&gt;<i> register. We'd need something to decompose the struct into variables so
</I>&gt;<i> that we could do register allocation on it. I'd rather focus on making
</I>&gt;<i> foreach () on a List&lt;T&gt; be nearly as fast as manual iteration than
</I>&gt;<i> replacing things with manual loops blindly.
</I>&gt;<i>
</I>&gt;<i> However, it looks like that is besides the point. MSFT does not do
</I>&gt;<i> failfast behavior (ie, it doesn't error out on modifications to the
</I>&gt;<i> list), as you commented in the method. I believe this is a bug (we
</I>&gt;<i> should file it with them), because modifying the collection will make
</I>&gt;<i> the enumeration meaningless. However, we should emulate the behavior for
</I>&gt;<i> now.
</I>&gt;<i>
</I>&gt;<i> Please rewrite using a for loop rather than a while loop and submit a
</I>&gt;<i> patch (svn diff).
</I>&gt;<i>
</I>&gt;<i> -- Ben
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: List.path1
Type: application/octet-stream
Size: 1421 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051112/6d940201/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051112/6d940201/attachment.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: List.path2
Type: application/octet-stream
Size: 2324 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051112/6d940201/attachment-0001.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051112/6d940201/attachment-0001.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015737.html">[Mono-dev] [PATCH] Optimization to System.Collections.Generic.List
</A></li>
	<LI>Next message: <A HREF="015735.html">[Mono-dev] DatePicker ASP.NET control
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15741">[ date ]</a>
              <a href="thread.html#15741">[ thread ]</a>
              <a href="subject.html#15741">[ subject ]</a>
              <a href="author.html#15741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
