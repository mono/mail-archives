<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20A%20%22fastpath%22%20dead%20code%20elimination&In-Reply-To=1132085644.6972.360.camel%40linux.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015817.html">
   <LINK REL="Next"  HREF="015822.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20A%20%22fastpath%22%20dead%20code%20elimination&In-Reply-To=1132085644.6972.360.camel%40linux.site"
       TITLE="[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination">massi at ximian.com
       </A><BR>
    <I>Tue Nov 15 16:02:34 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015817.html">[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination
</A></li>
        <LI>Next message: <A HREF="015822.html">[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15821">[ date ]</a>
              <a href="thread.html#15821">[ thread ]</a>
              <a href="subject.html#15821">[ subject ]</a>
              <a href="author.html#15821">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Tue, 2005-11-15 at 15:14 -0500, Miguel de Icaza wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> &gt; The alias analysis pass has O(n) complexity (n = code size), it is
</I>&gt;<i> &gt; just a linear sweep on the list of instructions.
</I>&gt;<i> &gt; Then, deadce operates one BB at a time, scanning the code linearly
</I>&gt;<i> &gt; and using the liveness bits as start/end conditions (so it is O(n)
</I>&gt;<i> &gt; as well).
</I>&gt;<i> 
</I>&gt;<i> Is there is a threshold that will disable the optimization from running?
</I>
Of course :-)
If you do not provide the &quot;deadce&quot; flag, it will not be used.
And even if we'll decide to enable it by default, it will be enough
to specify &quot;-O=-deadce&quot; to switch it off.

I didn't explain much of how the patch is coded, and/or how it can
be used, so here are some more details.



With this patch applied, -O=deadce activates fastpath deadce, unless
some other flag (for now either &quot;ssapre&quot; or &quot;abcrem&quot;) required ssa.
In this case, the &quot;traditional&quot; ssa deadce is used.
However, I added one new flag: &quot;ssa&quot;, which forces ssa construction.
If this is used, then &quot;deadce&quot; will default to the ssa one.
Note, however, that if &quot;deadce&quot; has been specified, and &quot;ssa&quot; is in
some way required (at least one of &quot;ssapre&quot;, &quot;abcrem&quot; or &quot;ssa&quot; was
specified), it can *still* happen that some method will fall back to
use fastpath deadce: this happens if ssa was disabled because of
aliasing.

Now, I *know* this sounds confusing at first.
Here's the rationale: the idea is that the JIT should do what the
user &quot;means&quot; with the flags.
So, if the user asks &quot;deadce&quot;, the JIT does its best to do deadce.
This is the same thing that happens now for consprop and copyprop,
which have both ssa and &quot;fast&quot; versions, which are not equally
effective but are called the same.
And as soon as I'll commit the HSSA patch, there will be one &quot;hssa&quot;
flag as well (at least it works so in my tree).
So one will be able to choose betwen &quot;fastpath&quot;, &quot;ssa&quot; and &quot;hssa&quot;
deadce, using &quot;-O=deadce&quot;, &quot;-O=ssa,deadce&quot; or &quot;-O=hssa,deadce&quot;.
Of course in the long run ssa will go away and will be replaced
by hssa, but at least for testing in between this can work.

The alternative would be having one different flag for each &quot;kind&quot;
of optimization, like &quot;fastdeadce&quot;, &quot;hssadeadce&quot;...
However, this way the number of flags will get too high (and also
ugly) with hssa.
And consprop and copyprop already work this way (we use the same
flags for the ssa and &quot;fast&quot; versions), so I decided go go on with
the same philosophy.



About the implementation... there's not much to say, the algorithms
are &quot;classical&quot;, no rocket science here ;-)

I tried not too mess up too much the liveness code, which is for
sure the more impacted by this patch.
I made so that the same code works both with and without aliasing
information.
When aliasing has been computed, it is possible to obtain one list
of &quot;affected variables&quot; for each MonoInst, and liveness uses that
to understand the effect of the inst on each variable.
On the other hand, without aliasing info, the code relied on the
presence of MONO_SSA_* flags to see what each instruction was doing
and each instruction could have effect on just *one* local.
In this case I decided to keep one list node as local variable, and
use it to build a &quot;one element&quot; list of &quot;affected variables&quot;.
This way all the &quot;logic&quot; of liveness has been transformed to use
those &quot;affected variables&quot; lists, and a small preamble takes the
real list if aliasing has been computed, or builds the &quot;one element&quot;
list otherwise.
So the patch is a bit hard to read, but it's not so terrible IMHO.
And yes, I know that I'm slowing liveness computation a bit this
way, but it's just a bit, and we have the advantage of not &quot;forking&quot;
the liveness code!

If anything isn't clear, just ask ;-)

Ciao,
  Massi



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015817.html">[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination
</A></li>
	<LI>Next message: <A HREF="015822.html">[Mono-dev] [PATCH] A &quot;fastpath&quot; dead code elimination
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15821">[ date ]</a>
              <a href="thread.html#15821">[ thread ]</a>
              <a href="subject.html#15821">[ subject ]</a>
              <a href="author.html#15821">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
