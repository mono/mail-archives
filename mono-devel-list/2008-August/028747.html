<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] BitVector32 patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BitVector32%20patch&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028746.html">
   <LINK REL="Next"  HREF="028748.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] BitVector32 patch</H1>
    <B>Scott Peterson</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BitVector32%20patch&In-Reply-To="
       TITLE="[Mono-dev] BitVector32 patch">lunchtimemama at gmail.com
       </A><BR>
    <I>Tue Aug  5 22:42:23 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028746.html">[Mono-dev] [PATCH] Cross-compiling mono for Windows on Linux, using Mingw
</A></li>
        <LI>Next message: <A HREF="028748.html">[Mono-dev] BitVector32 patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28747">[ date ]</a>
              <a href="thread.html#28747">[ thread ]</a>
              <a href="subject.html#28747">[ subject ]</a>
              <a href="author.html#28747">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I happened across a mention of the BitVector32 class the yesterday and it
piqued my interest. I thought I'd take a look at Mono's implementation and
ended up spending some time giving the type a once-over. I made several
minor changes (style issues, removing duplicate code between the
Section.ToString overrides, simplified Section.GetHashCode, code sharing
between the BitVector32 constructors, &amp;c.), I got rid of the NumberOfSetBits
since it is only every being used on bit masks which are always one less
than a power of two so HighestSetBit can be used instead, and lastly I
changed the HighestSetBit algorithm to something simpler. Patch is attached
and inline. Notes are welcome.

Index: class/System/System.Collections.Specialized/ChangeLog
===================================================================
--- class/System/System.Collections.Specialized/ChangeLog    (revision
109665)
+++ class/System/System.Collections.Specialized/ChangeLog    (working copy)
@@ -1,3 +1,9 @@
+2008-08-06  Scott Peterson  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lunchtimemama at gmail.com</A>&gt;
+
+    * BitVector32.cs: Cleanup and improved a number of things. Simpler
+    HighestSetBit algorithm, got rid of NumberOfSetBits (using
+    HighestSetBit works just fine) and some misc. other stuff.
+
 2008-07-31  Jb Evain  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jbevain at novell.com</A>&gt;

     * StringDictionary.cs: remove ComponentModel bits for NET_2_1.
Index: class/System/System.Collections.Specialized/BitVector32.cs
===================================================================
--- class/System/System.Collections.Specialized/BitVector32.cs    (revision
109665)
+++ class/System/System.Collections.Specialized/BitVector32.cs    (working
copy)
@@ -34,10 +34,10 @@

 namespace System.Collections.Specialized {

-    public struct BitVector32 {
-        int bits;
-
-        public struct Section {
+    public struct BitVector32
+    {
+        public struct Section
+        {
             private short mask;
             private short offset;

@@ -74,7 +74,7 @@
 #endif
             public override bool Equals (object o)
             {
-                if (! (o is Section))
+                if (!(o is Section))
                     return false;

                 Section section = (Section) o;
@@ -84,14 +84,12 @@

             public override int GetHashCode ()
             {
-                return (((Int16) mask).GetHashCode () &lt;&lt; 16) +
-                       ((Int16) offset).GetHashCode ();
+                return mask &lt;&lt; offset;
             }

             public override string ToString ()
             {
-                return &quot;Section{0x&quot; + Convert.ToString(mask, 16) +
-                       &quot;, 0x&quot; + Convert.ToString(offset, 16) + &quot;}&quot;;
+                return ToString(this);
             }

             public static string ToString (Section value)
@@ -106,12 +104,14 @@
                 return b.ToString ();
             }
         }
+
+        int bits;

         // Constructors

         public BitVector32 (BitVector32 source)
+            : this (source.bits)
         {
-            bits = source.bits;
         }

         public BitVector32 (int init)
@@ -184,9 +184,8 @@
             if (maxValue &lt; 1)
                 throw new ArgumentException (&quot;maxValue&quot;);

-            int bit = HighestSetBit(maxValue) + 1;
-            int mask = (1 &lt;&lt; bit) - 1;
-            int offset = previous.Offset + NumberOfSetBits (previous.Mask);
+            int mask = (1 &lt;&lt; HighestSetBit(maxValue)) - 1;
+            int offset = previous.Offset + HighestSetBit(previous.Mask);

             if (offset &gt; 32) {
                 throw new ArgumentException (&quot;Sections cannot exceed 32
bits in total&quot;);
@@ -197,10 +196,7 @@

         public override bool Equals (object o)
         {
-            if (!(o is BitVector32))
-                return false;
-
-            return bits == ((BitVector32) o).bits;
+            return (o is BitVector32) &amp;&amp; bits == ((BitVector32) o).bits;
         }

         public override int GetHashCode ()
@@ -218,7 +214,7 @@
             StringBuilder b = new StringBuilder ();
             b.Append (&quot;BitVector32{&quot;);
             long mask = (long) 0x80000000;
-            while (mask &gt; 0) {
+            while (mask != 0) {
                 b.Append (((value.bits &amp; mask) == 0) ? '0' : '1');
                 mask &gt;&gt;= 1;
             }
@@ -227,27 +223,12 @@
         }

         // Private utilities
-        private static int NumberOfSetBits (int i)
+        private static int HighestSetBit (int i)
         {
             int count = 0;
-            for (int bit = 0; bit &lt; 32; bit++) {
-                int mask = 1 &lt;&lt; bit;
-                if ((i &amp; mask) != 0)
-                    count++;
-            }
+            while(i &gt;&gt; count != 0)
+                count++;
             return count;
         }
-
-        private static int HighestSetBit (int i)
-        {
-            for (int bit = 31; bit &gt;= 0; bit--) {
-                int mask = 1 &lt;&lt; bit;
-                if ((mask &amp; i) != 0) {
-                    return bit;
-                }
-            }
-
-            return -1;
-        }
     }
 }
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080806/3dbe2a2c/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080806/3dbe2a2c/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: bitvector32.patch
Type: text/x-diff
Size: 3622 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080806/3dbe2a2c/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080806/3dbe2a2c/attachment-0001.bin</A> 
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028746.html">[Mono-dev] [PATCH] Cross-compiling mono for Windows on Linux, using Mingw
</A></li>
	<LI>Next message: <A HREF="028748.html">[Mono-dev] BitVector32 patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28747">[ date ]</a>
              <a href="thread.html#28747">[ thread ]</a>
              <a href="subject.html#28747">[ subject ]</a>
              <a href="author.html#28747">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
