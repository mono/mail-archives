<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] When passing managed array of COM object references	(Marshaled as	UnmanagedType.LPArray) to native Code,	expected native COM ptrs are invalid.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20When%20passing%20managed%20array%20of%20COM%20object%20references%0A%09%28Marshaled%20as%09UnmanagedType.LPArray%29%20to%20native%20Code%2C%0A%09expected%20native%20COM%20ptrs%20are%20invalid.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028930.html">
   <LINK REL="Next"  HREF="028857.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] When passing managed array of COM object references	(Marshaled as	UnmanagedType.LPArray) to native Code,	expected native COM ptrs are invalid.</H1>
    <B>Tom Hindle</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20When%20passing%20managed%20array%20of%20COM%20object%20references%0A%09%28Marshaled%20as%09UnmanagedType.LPArray%29%20to%20native%20Code%2C%0A%09expected%20native%20COM%20ptrs%20are%20invalid.&In-Reply-To="
       TITLE="[Mono-dev] When passing managed array of COM object references	(Marshaled as	UnmanagedType.LPArray) to native Code,	expected native COM ptrs are invalid.">tom_hindle at sil.org
       </A><BR>
    <I>Thu Aug 14 20:43:31 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028930.html">[Mono-dev] mono-curses = Can I join the project? Library	needs	some work!
</A></li>
        <LI>Next message: <A HREF="028857.html">[Mono-dev] When passing managed array of COM object references	(Marshaled as UnmanagedType.LPArray) to native Code,	expected native COM ptrs are invalid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28850">[ date ]</a>
              <a href="thread.html#28850">[ thread ]</a>
              <a href="subject.html#28850">[ subject ]</a>
              <a href="author.html#28850">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

When passing managed array of COM object references (Marshaled as
UnmanagedType.LPArray) to native Code, expected native COM ptrs are
invalid. This same technique works when running on MS .Net. 

1. I'm running on Linux (Hardy), using mono build from svn.

2. I have created 2 C++ COM objects using libCom.

3. I have created a c# Interop to call/create these COM objects.

relevant line in Interop is:

[MethodImpl(MethodImplOptions.InternalCall,MethodCodeType=MethodCodeType.Runtime)]
public virtual extern void PassComArray(
int length, 
[MarshalAs(UnmanagedType.LPArray, SizeParamIndex=0]
INativeCreatedObject[] a);

4. I create an instance of the COM object in c#
   I use that to return a Naively created COM object to c#.
   I can use this COM object in c#.
   However passing this COM object ref as an array back to native
doesn't work.

IE:

Test t = new Test(); // Create Com object Test
INativeCreatedObject i;
t.CreateNativeObject(out i); // return another Com object created
naively. // prints address as 0x83cbd50

i.DoSomething(); // Works fine.

// Create managed array 
INativeCreatedObject[] array = new INativeCreatedObject[10];
array[0] = i;

t.PassComArray(1, array); // address of array element 0 is 0x60d80 not
0x83cbd50 which means using the COM object ptr will crash.

5. This Marshaling technique works in mono when passing int's. 

IE:
				MethodImpl(MethodImplOptions.InternalCall,
MethodCodeType=MethodCodeType.Runtime)]
public virtual extern void
PassIntArray([MarshalAs(UnmanagedType.LPArray, SizeParamIndex=0)]
 int length, int[] a);

6. after gdb-ing mono I suspect the problem with the CIL that is
generated for the marshaling (is it called the Runtime Callable
Wrapper?) However I can't verify this as I can't program in any
Assembler :(

I have a work around using a custom marshaler, but I would rather use
the same interops on both Windows and Linux.

Thanks in advance for any advice.
Tom




</PRE>
































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028930.html">[Mono-dev] mono-curses = Can I join the project? Library	needs	some work!
</A></li>
	<LI>Next message: <A HREF="028857.html">[Mono-dev] When passing managed array of COM object references	(Marshaled as UnmanagedType.LPArray) to native Code,	expected native COM ptrs are invalid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28850">[ date ]</a>
              <a href="thread.html#28850">[ thread ]</a>
              <a href="subject.html#28850">[ subject ]</a>
              <a href="author.html#28850">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
