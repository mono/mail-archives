<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono preview 2.0 binary and DTrace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20preview%202.0%20binary%20and%20DTrace&In-Reply-To=1217917400.4829.131.camel%40Matrix.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028739.html">
   <LINK REL="Next"  HREF="028745.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono preview 2.0 binary and DTrace</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20preview%202.0%20binary%20and%20DTrace&In-Reply-To=1217917400.4829.131.camel%40Matrix.site"
       TITLE="[Mono-dev] Mono preview 2.0 binary and DTrace">andreas.faerber at web.de
       </A><BR>
    <I>Tue Aug  5 06:26:40 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028739.html">[Mono-dev] Mono preview 2.0 binary and DTrace
</A></li>
        <LI>Next message: <A HREF="028745.html">[Mono-dev] Mono preview 2.0 binary and DTrace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28743">[ date ]</a>
              <a href="thread.html#28743">[ thread ]</a>
              <a href="subject.html#28743">[ subject ]</a>
              <a href="author.html#28743">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ciao Massi,

Am 05.08.2008 um 08:23 schrieb Massimiliano Mantione:

&gt;<i>
</I>&gt;<i> On Sun, 2008-08-03 at 21:57 +0200, Andreas F&#228;rber wrote:
</I>&gt;&gt;<i> What I will be looking into next is method-enter/method-exit probes
</I>&gt;&gt;<i> for tracing managed function flow, but it seems more complicated (the
</I>&gt;&gt;<i> JIT would need to always emit a call to a helper function, supplying
</I>&gt;&gt;<i> it the data to conditionally pass out - otherwise the dynamic part of
</I>&gt;&gt;<i> DTrace wouldn't work) and thus cannot be on by default for  
</I>&gt;&gt;<i> performance
</I>&gt;&gt;<i> reasons, just like in Java.
</I>&gt;<i>
</I>&gt;<i> IMO, the correct way of doing this would be to implement it in a
</I>&gt;<i> profiler module, and it's amazingly easy doing so.
</I>
Although not really familiar with it, I am aware of the existing cross- 
platform tracing and profiling mechanisms in Mono. (The JIT profiling  
DTrace probes mostly match Mono's own hooks except that I reported  
some profiler hooks were missing for generic sharing and when some  
optimizations were not run - I got no reply to that, maybe you want to  
check on that.)

DTrace is a different paradigm...

&gt;<i> But actually the logging profiler does just that if you invoke it with
</I>&gt;<i> the &quot;c&quot; option: it logs all method enter and exit events.
</I>&gt;<i> It uses per-thread buffers (periodically flushed) to minimize overhead
</I>&gt;<i> and locking, each event takes between 2 and 5 bytes in the log file
</I>&gt;<i> (including the full timestamp!), and even this way the overhead is
</I>&gt;<i> really high.
</I>&gt;<i> I doubt dtrace could be any faster... but if it is I'd like to know  
</I>&gt;<i> how
</I>&gt;<i> it does it :-)
</I>
...currently, having to start mono with the DTrace tool as documented  
is an intermediate step - the final goal is to deploy a runtime with  
DTrace compiled in, no probes activated at startup. Then when  
something goes wrong, e.g. while running ASP.NET with mod_mono, you  
connect to the mono pid (or to all running mono instances) and see  
what's going on.

What DTrace is doing afaik is it pre-compiles the D script to bytecode  
and it has per-CPU buffers. Unless I activate a certain probe, no data  
gets collected for it. Even if activated (i.e., called and data passed  
into), the script can use predicates to minimize the data collected to  
that of interest (e.g., only profile compilation of method starting  
with A), and built-in aggregation functions can further reduce the  
amount of data actually kept (e.g., a histogram). So this means that  
the actual &quot;if (enabled)&quot; needs to be different, and I wouldn't want  
to mess with the semantics of the cross-platform mechanism.

Personally, I have used DTrace for my thesis on H.264 SVC streaming,  
and being under great time pressure DTrace has allowed me to get the  
statistics I wanted with a minimum of work - for absolute numbers I  
got histograms directly in GNUplot format, for a cumulative  
distribution function I postprocessed the output with an existing Mono  
tool of mine (probably there's an easier way too but I'm no expert).
<A HREF="http://www.informatik.uni-mannheim.de/pi4/publications/Faerber2008a">http://www.informatik.uni-mannheim.de/pi4/publications/Faerber2008a</A>  
(pp. 14ff)

Anyway, believing that DTrace will be slightly faster, I have taken  
care to place the DTrace probes enclosed by Mono's hooks (e.g., start  
profiler hook, start DTrace probe, whatever, end DTrace probe, end  
profiler hook) and would ask that we stick with this order. It should  
not have any influence when DTrace is not compiled in (e.g., Linux) as  
my macros become no-op then.

I don't wish to replace or belittle your profiler work. I think the  
two have different scopes and different use cases and can live side by  
side, even benefitting from increased review.

Andreas

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028739.html">[Mono-dev] Mono preview 2.0 binary and DTrace
</A></li>
	<LI>Next message: <A HREF="028745.html">[Mono-dev] Mono preview 2.0 binary and DTrace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28743">[ date ]</a>
              <a href="thread.html#28743">[ thread ]</a>
              <a href="subject.html#28743">[ subject ]</a>
              <a href="author.html#28743">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
