<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Fix Type.Equals to support user defined	types (required by vbnc)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20Type.Equals%20to%20support%20user%20defined%0A%09types%20%28required%20by%20vbnc%29&In-Reply-To=002001c6fb85%24fb440940%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021139.html">
   <LINK REL="Next"  HREF="021140.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Fix Type.Equals to support user defined	types (required by vbnc)</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20Type.Equals%20to%20support%20user%20defined%0A%09types%20%28required%20by%20vbnc%29&In-Reply-To=002001c6fb85%24fb440940%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] Fix Type.Equals to support user defined	types (required by vbnc)">lupus at ximian.com
       </A><BR>
    <I>Tue Oct 31 06:26:05 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021139.html">[Mono-dev] [PATCH] Fix Type.Equals to support user defined	types (required by vbnc)
</A></li>
        <LI>Next message: <A HREF="021140.html">[Mono-dev] VBNC uses too much CPU and RAM on Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21193">[ date ]</a>
              <a href="thread.html#21193">[ thread ]</a>
              <a href="subject.html#21193">[ subject ]</a>
              <a href="author.html#21193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/29/06 Korn&#233;l P&#225;l wrote:
&gt;<i> I forgot to attach the diff file.:)
</I>
You also forgot the nunit tests that are required to be able to commit
a change so deep in the runtime a few days before a major release:)
Also, please don't post patches marked as octect-stream, they are text
files, post them as such.

&gt;<i> Index: mcs/class/corlib/System/Type.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/class/corlib/System/Type.cs	(revision 67080)
</I>&gt;<i> +++ mcs/class/corlib/System/Type.cs	(working copy)
</I>&gt;<i> @@ -411,20 +411,26 @@
</I>&gt;<i>  
</I>&gt;<i>  		public override bool Equals (object o)
</I>&gt;<i>  		{
</I>&gt;<i> +			return Equals (o as Type);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		[MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i> +		internal static extern bool type_equals (Type type1, Type type2);
</I>&gt;<i> +
</I>&gt;<i> +		public bool Equals (Type o)
</I>&gt;<i> +		{
</I>&gt;<i>  			if (o == null)
</I>&gt;<i>  				return false;
</I>&gt;<i> -			
</I>&gt;<i> -			// TODO: return UnderlyingSystemType == o.UnderlyingSystemType;
</I>&gt;<i> -			Type cmp = o as Type;
</I>&gt;<i> -			if (cmp == null)
</I>&gt;<i> -				return false;
</I>&gt;<i> -			return Equals (cmp);
</I>&gt;<i> +
</I>&gt;<i> +			// User defined types depend on this behavior
</I>&gt;<i> +			Type type1 = UnderlyingSystemType;
</I>&gt;<i> +			Type type2 = o.UnderlyingSystemType;
</I>
Can two user-defined types that are reference-equal not match in Equals()?
It doesn't look possible, so the fast check should be placed first.

&gt;<i> +			return type1 == type2 ||
</I>&gt;<i> +				(type1 != null &amp;&amp; type2 != null &amp;&amp; type1.IsSystemType &amp;&amp; type2.IsSystemType &amp;&amp; type_equals (type1, type2));
</I>
It looks like you're optimizing for the case of user-defined types, by
moving several checks from the icall to here where the common case is to
perform the icall in any case. The rule to follow, instead, is:
	never speedup the usage of user-defined types if it means
	slowing down the types that every sane person uses

A 1% speedup of common types is worth a 10x slowdown of user-defined
types.

&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		[MethodImplAttribute(MethodImplOptions.InternalCall)]
</I>&gt;<i> -		public extern bool Equals (Type type);
</I>&gt;<i> -		
</I>&gt;<i> -		[MethodImplAttribute(MethodImplOptions.InternalCall)]
</I>&gt;<i>  		private static extern Type internal_from_handle (IntPtr handle);
</I>&gt;<i>  		
</I>&gt;<i>  		[MethodImplAttribute(MethodImplOptions.InternalCall)]
</I>&gt;<i> @@ -690,7 +696,13 @@
</I>&gt;<i>  		
</I>&gt;<i>  		public override int GetHashCode()
</I>&gt;<i>  		{
</I>&gt;<i> -			return (int)_impl.Value;
</I>&gt;<i> +			// User defined types depend on this behavior
</I>
For every such comment you put in the sources we need at least a nunit test.

&gt;<i> +			Type type = UnderlyingSystemType;
</I>&gt;<i> +
</I>&gt;<i> +			if (type != this)
</I>&gt;<i> +				return type.GetHashCode ();
</I>
In the above code you check for UnderlyingSystemType being null:
if it's the case here, too, you'll cause a nullref exception.

&gt;<i> +
</I>&gt;<i> +			return base.GetHashCode ();
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public MemberInfo[] GetMember (string name)
</I>&gt;<i> Index: mcs/class/corlib/System/MonoType.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/class/corlib/System/MonoType.cs	(revision 67080)
</I>&gt;<i> +++ mcs/class/corlib/System/MonoType.cs	(working copy)
</I>&gt;<i> @@ -565,8 +565,23 @@
</I>&gt;<i>  			UnitySerializationHolder.GetTypeData (this, info, context);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		public override string ToString()
</I>&gt;<i> +		public override bool Equals (object o)
</I>&gt;<i>  		{
</I>&gt;<i> +			if (o == this)
</I>&gt;<i> +				return true;
</I>&gt;<i> +
</I>&gt;<i> +			Type type = o as Type;
</I>&gt;<i> +
</I>&gt;<i> +			return type != null &amp;&amp; type.IsSystemType &amp;&amp; type_equals (this, type);
</I>
Same comment about optimizing for the user-defined types.

&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		public override int GetHashCode ()
</I>&gt;<i> +		{
</I>&gt;<i> +			return (int) _impl.Value;
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		public override string ToString ()
</I>&gt;<i> +		{
</I>&gt;<i>  			return getFullName (false, false);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> Index: mono/mono/metadata/icall-def.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/metadata/icall-def.h	(revision 67080)
</I>&gt;<i> +++ mono/mono/metadata/icall-def.h	(working copy)
</I>&gt;<i> @@ -797,26 +797,26 @@
</I>&gt;<i>  ICALL(WAITH_3, &quot;WaitOne_internal&quot;, ves_icall_System_Threading_WaitHandle_WaitOne_internal)
</I>&gt;<i>  
</I>&gt;<i>  ICALL_TYPE(TYPE, &quot;System.Type&quot;, TYPE_1)
</I>&gt;<i> -ICALL(TYPE_1, &quot;Equals&quot;, ves_icall_type_Equals)
</I>
As the comment at the start of this file says, do not do useless renames
of all the entries, there is no larger diff competition going on.
Besides you can just name the method EqualsInternal and have the
enums still ordered (which doesn't mean anything, the names can be
anything).
Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021139.html">[Mono-dev] [PATCH] Fix Type.Equals to support user defined	types (required by vbnc)
</A></li>
	<LI>Next message: <A HREF="021140.html">[Mono-dev] VBNC uses too much CPU and RAM on Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21193">[ date ]</a>
              <a href="thread.html#21193">[ thread ]</a>
              <a href="subject.html#21193">[ subject ]</a>
              <a href="author.html#21193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
