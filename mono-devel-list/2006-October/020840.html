<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Replacing/Removing I18N
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replacing/Removing%20I18N&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020839.html">
   <LINK REL="Next"  HREF="020841.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Replacing/Removing I18N</H1>
    <B>Andreas Nahr</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replacing/Removing%20I18N&In-Reply-To="
       TITLE="[Mono-dev] Replacing/Removing I18N">ClassDevelopment at A-SoftTech.com
       </A><BR>
    <I>Mon Oct  9 17:43:15 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020839.html">[Mono-dev] new parser for C#
</A></li>
        <LI>Next message: <A HREF="020841.html">[Mono-dev] Replacing/Removing I18N
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20840">[ date ]</a>
              <a href="thread.html#20840">[ thread ]</a>
              <a href="subject.html#20840">[ subject ]</a>
              <a href="author.html#20840">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi *,

I've been looking into this topic for quite some time now. However my 
knowledge (especially of the internals of the VM) is potentially not enough, 
so please correct me if I make wrong statements or assumptions:

Current situation:
I18N is located in multiple separate assemblies that contain encoding 
classes that are autogenerated. The single-byte encodings (my current focus) 
use a potentially big CASE-Structure to compute the output.

Problems:
* I18N is loaded through Reflection-Mechanisms, which triggers a HUGE amount 
of other code, so Mono loads/jits and instatiates a considerable portion of 
the entire corelib when I18N is used.
* Initializing the I18N is slow and creates a huge amount of objects.
* (At least on windows) I18N is basically ALWAYS used, because a single 
access to Console (which even the corelib contains a lot for debug output) 
is enough to instantiate it. I'm assuming this doesn't happen on Linux?
* The I18N classes themselves consist of considerable amount of IL-Code 
making them slow to JIT and using a considerable amount of memory to hold 
the IL and produced native code.
* The I18N classes are potentially slow (especially when assuming that 
optimization is probably sub-optimal because of the often huge IL-size).
* Pressure on the GC because of big number of generated objects.

Considerations for change:
* Data must not be in private memory but shared as much as possible 
(currently most is shareable)
* If possible avoid internal-calls and other direct runtime-support 
(currently does not need any)

Goals:
* Drop additional libraries
* Use less memory
* Make instantiation faster
* Try to limit the needed JITted code to a reasonable amount
* Possibly make encoding faster

I started with the single-byte encodings, because these are the most simple 
ones and the most numerous:

The idea is to only use a single class for all single-byte encodings that is 
instantiated with lookuptables suited for the relevant codepage.
The lookuptables would be binary data that should be shared. A solution 
seems to be embedding these as resource-files into corelib and then getting 
a pointer to the binary data through Assembly.GetManifestResourceStream. The 
data would be uncompressed and complete for maximum performance and minimal 
code requirement (about 65kb per encoding). The data should already be 
memmaped is embedded as a resource (how big would be one of the pages??).

Some ballpark figures as rationale (See the attached text-files which show 
an app using only I18N, one with String and Globalization and one without 
all):
For String and Globalization Mono uses about 15kb memory for code and 7kb 
for data in 246 objects.
With I18N mono uses (Codepage 1250) &gt; 140kb for code and 81kb for private 
data in 1800 objects (potentially putting pressure on the GC)
So the 65kb (how much could be saved because of memmapping - ALL single-byte 
encodings do not use a part of the unicode-range?) we need for an encoding 
is actually far less than the current overhead for I18N (obviously that may 
not hold true if a lot of different encodings are used). And obviously the 
lookup would be faster and we would not need any time spent in the JIT.

Open questions:
* Creating the binary data should be simple when generating from a .Net VM. 
Would it be allowed to gernerate directly from MS.Net? From Portable.Net? 
(obviously from Mono is no problem, but would not allow to ADD data)
* Size of a memmaped page?
* Growth in *file*size for corelib acceptable? Altogether probably 5-10MB
* Other sideeffects possible?


Greetings
Andreas 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: With String&amp;Globalization.txt
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment.txt">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment.txt</A> 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: With I18N.txt
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment-0001.txt">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment-0001.txt</A> 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: Without all.txt
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment-0002.txt">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061009/5b2b6da7/attachment-0002.txt</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020839.html">[Mono-dev] new parser for C#
</A></li>
	<LI>Next message: <A HREF="020841.html">[Mono-dev] Replacing/Removing I18N
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20840">[ date ]</a>
              <a href="thread.html#20840">[ thread ]</a>
              <a href="subject.html#20840">[ subject ]</a>
              <a href="author.html#20840">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
