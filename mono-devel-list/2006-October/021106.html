<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] OS X MACHINE_THREAD_STATE patch for newer 10.4u	SDK
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20OS%20X%20MACHINE_THREAD_STATE%20patch%20for%20newer%2010.4u%0A%09SDK&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021102.html">
   <LINK REL="Next"  HREF="021107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] OS X MACHINE_THREAD_STATE patch for newer 10.4u	SDK</H1>
    <B>Allan Hsu</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20OS%20X%20MACHINE_THREAD_STATE%20patch%20for%20newer%2010.4u%0A%09SDK&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] OS X MACHINE_THREAD_STATE patch for newer 10.4u	SDK">allan at counterpop.net
       </A><BR>
    <I>Wed Oct 25 23:22:32 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021102.html">[Mono-dev] [PATCH] Optimize Encoding.GetByteCount
</A></li>
        <LI>Next message: <A HREF="021107.html">[Mono-dev] XScale?,  Mono-devel-list Digest, Vol 18, Issue 62
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21106">[ date ]</a>
              <a href="thread.html#21106">[ thread ]</a>
              <a href="subject.html#21106">[ subject ]</a>
              <a href="author.html#21106">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This patch fixes problems with building mono for i386 using the new
10.4u SDK that ships with Xcode 2.4. Current SVN builds for i386 under
the new SDK, but does not run properly due to changes in
MACHINE_THREAD_STATE. It looks like the breakage in source compatibility
is intentional on Apple's part and future headers will be similarly
broken.

I will be submitting the same patch to libgc upstream.

	-Allan
-- 
Allan Hsu &lt;allan at counterpop dot net&gt;
1E64 E20F 34D9 CBA7 1300 1457 AC37 CBBB 0E92 C779
-------------- next part --------------
Index: libgc/darwin_stop_world.c
===================================================================
--- libgc/darwin_stop_world.c	(revision 66738)
+++ libgc/darwin_stop_world.c	(working copy)
@@ -75,12 +75,14 @@
   ptr_t lo, hi;
 #if defined(POWERPC)
   ppc_thread_state_t state;
+  mach_msg_type_number_t thread_state_count = PPC_THREAD_STATE_COUNT;
 #elif defined(I386)
   i386_thread_state_t state;
+  mach_msg_type_number_t thread_state_count = i386_THREAD_STATE_COUNT;
 #else
 # error FIXME for non-x86 || ppc architectures
+  mach_msg_type_number_t thread_state_count = MACHINE_THREAD_STATE_COUNT;
 #endif
-  mach_msg_type_number_t thread_state_count = MACHINE_THREAD_STATE_COUNT;
   
   me = pthread_self();
   if (!GC_thr_initialized) GC_thr_init();
@@ -94,7 +96,7 @@
 	/* Get the thread state (registers, etc) */
 	r = thread_get_state(
 			     p-&gt;stop_info.mach_thread,
-			     MACHINE_THREAD_STATE,
+			     GC_MACH_THREAD_STATE_FLAVOR,
 			     (natural_t*)&amp;state,
 			     &amp;thread_state_count);
 	if(r != KERN_SUCCESS) ABORT(&quot;thread_get_state failed&quot;);
@@ -193,7 +195,7 @@
 	ppc_thread_state64_t info;
 #      endif
 	mach_msg_type_number_t outCount = THREAD_STATE_MAX;
-	r = thread_get_state(thread, MACHINE_THREAD_STATE,
+	r = thread_get_state(thread, GC_MACH_THREAD_STATE_FLAVOR,
 			     (natural_t *)&amp;info, &amp;outCount);
 	if(r != KERN_SUCCESS) continue;
 
@@ -236,7 +238,7 @@
 	WARN(&quot;This is completely untested and likely will not work\n&quot;, 0);
 	i386_thread_state_t info;
 	mach_msg_type_number_t outCount = THREAD_STATE_MAX;
-	r = thread_get_state(thread, MACHINE_THREAD_STATE,
+	r = thread_get_state(thread, GC_MACH_THREAD_STATE_FLAVOR,
 			     (natural_t *)&amp;info, &amp;outCount);
 	if(r != KERN_SUCCESS) continue;
 
Index: libgc/include/private/gc_priv.h
===================================================================
--- libgc/include/private/gc_priv.h	(revision 66738)
+++ libgc/include/private/gc_priv.h	(working copy)
@@ -366,6 +366,16 @@
 #   define BZERO(x,n) bzero((char *)(x),(int)(n))
 # endif
 
+#if defined(DARWIN)
+#	if defined(POWERPC)
+#		define GC_MACH_THREAD_STATE_FLAVOR PPC_THREAD_STATE
+#	elif defined(I386)
+#		define GC_MACH_THREAD_STATE_FLAVOR i386_THREAD_STATE
+#	else
+#		define GC_MACH_THREAD_STATE_FLAVOR MACHINE_THREAD_STATE
+#	endif
+#endif
+
 /* Delay any interrupts or signals that may abort this thread.  Data	*/
 /* structures are in a consistent state outside this pair of calls.	*/
 /* ANSI C allows both to be empty (though the standard isn't very	*/
Index: libgc/os_dep.c
===================================================================
--- libgc/os_dep.c	(revision 66738)
+++ libgc/os_dep.c	(working copy)
@@ -3702,7 +3702,7 @@
         mask,
         GC_ports.exception,
         EXCEPTION_DEFAULT,
-        MACHINE_THREAD_STATE
+        GC_MACH_THREAD_STATE_FLAVOR
     );
     if(r != KERN_SUCCESS) ABORT(&quot;task_set_exception_ports failed&quot;);
 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021102.html">[Mono-dev] [PATCH] Optimize Encoding.GetByteCount
</A></li>
	<LI>Next message: <A HREF="021107.html">[Mono-dev] XScale?,  Mono-devel-list Digest, Vol 18, Issue 62
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21106">[ date ]</a>
              <a href="thread.html#21106">[ thread ]</a>
              <a href="subject.html#21106">[ subject ]</a>
              <a href="author.html#21106">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
