<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Support for runtime configuration of	assembly	loading path - related to bug #81446
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Support%20for%20runtime%20configuration%20of%0A%09assembly%09loading%20path%20-%20related%20to%20bug%20%2381446&In-Reply-To=20070823012938.0b3d3d31%40quantum.thanes.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024647.html">
   <LINK REL="Next"  HREF="024664.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Support for runtime configuration of	assembly	loading path - related to bug #81446</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Support%20for%20runtime%20configuration%20of%0A%09assembly%09loading%20path%20-%20related%20to%20bug%20%2381446&In-Reply-To=20070823012938.0b3d3d31%40quantum.thanes.org"
       TITLE="[Mono-dev] Support for runtime configuration of	assembly	loading path - related to bug #81446">lupus at ximian.com
       </A><BR>
    <I>Thu Aug 23 08:58:20 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024647.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
        <LI>Next message: <A HREF="024664.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24662">[ date ]</a>
              <a href="thread.html#24662">[ thread ]</a>
              <a href="subject.html#24662">[ subject ]</a>
              <a href="author.html#24662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/23/07 Marek Habersack wrote:
&gt;<i> &lt;?xml version=&quot;1.0&quot;?&gt;
</I>&gt;<i> &lt;configuration&gt;
</I>&gt;<i>     	&lt;runtime&gt;
</I>&gt;<i>         	&lt;assemblyBinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;
</I>&gt;<i> 			&lt;probing privatePath=&quot;test:libraries&quot; /&gt;
</I>&gt;<i> 		&lt;/assemblyBinding&gt; 
</I>&gt;<i> 	&lt;/runtime&gt;
</I>&gt;<i> &lt;/configuration&gt;
</I>
&gt;<i> Index: mono/metadata/appdomain.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/metadata/appdomain.c	(revision 84664)
</I>&gt;<i> +++ mono/metadata/appdomain.c	(working copy)
</I>[...]
&gt;<i>  static gunichar2 process_guid [36];
</I>&gt;<i> @@ -484,6 +491,114 @@
</I>&gt;<i>  	return root-&gt;domain;
</I>&gt;<i>  }
</I>&gt;<i>  
</I>&gt;<i> +static
</I>&gt;<i> +char* get_attribute_value (const gchar **attribute_names, 
</I>
static char*
get_attribute_value (...)

&gt;<i> +			   const gchar **attribute_values, 
</I>&gt;<i> +			   const char *att_name)
</I>&gt;<i> +{
</I>&gt;<i> +	int n;
</I>&gt;<i> +	for (n=0; attribute_names[n] != NULL; n++) {
</I>
You need spaces around = and before an opening paren.

&gt;<i> +		if (strcmp (attribute_names[n], att_name) == 0)
</I>&gt;<i> +			return g_strdup (attribute_values[n]);
</I>&gt;<i> +	}
</I>&gt;<i> +	return NULL;
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +static void start_element (GMarkupParseContext *context, 
</I>
static void on its own line.

&gt;<i> +                           const gchar         *element_name,
</I>&gt;<i> +			   const gchar        **attribute_names,
</I>
The args are aligned with random amounts of tabs and spaces.

&gt;<i> +			   const gchar        **attribute_values,
</I>&gt;<i> +			   gpointer             user_data,
</I>&gt;<i> +			   GError             **error)
</I>&gt;<i> +{
</I>&gt;<i> +	RuntimeConfig *runtime_config = (RuntimeConfig*) user_data;
</I>
Remove the useless cast.

&gt;<i> +	if (strcmp (element_name, &quot;runtime&quot;) == 0) {
</I>&gt;<i> +		runtime_config-&gt;runtime_count++;
</I>&gt;<i> +		return;
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i> +	if (strcmp (element_name, &quot;assemblyBinding&quot;) == 0) {
</I>&gt;<i> +		runtime_config-&gt;assemblybinding_count++;
</I>&gt;<i> +		return;
</I>&gt;<i> +	}
</I>&gt;<i> +	
</I>&gt;<i> +	if (runtime_config-&gt;runtime_count != 1 || runtime_config-&gt;assemblybinding_count != 1)
</I>&gt;<i> +		return;
</I>&gt;<i> +
</I>&gt;<i> +	if (strcmp (element_name, &quot;probing&quot;) != 0)
</I>&gt;<i> +		return;
</I>&gt;<i> +
</I>&gt;<i> +	runtime_config-&gt;domain-&gt;private_bin_path = get_attribute_value (attribute_names, attribute_values, &quot;privatePath&quot;);
</I>
If private_bin_path had a value it is leaked.

&gt;<i> +static void
</I>&gt;<i> +mono_set_private_bin_path_from_config (MonoDomain *domain)
</I>&gt;<i> +{
</I>&gt;<i> +	gchar *config_file, *text, *runtime_start;
</I>&gt;<i> +	gsize len;
</I>&gt;<i> +	struct stat sbuf;
</I>&gt;<i> +	GMarkupParseContext *context;
</I>&gt;<i> +	RuntimeConfig *runtime_config;
</I>&gt;<i> +	
</I>&gt;<i> +	if (!domain || !domain-&gt;setup || !domain-&gt;setup-&gt;configuration_file)
</I>&gt;<i> +		return;
</I>&gt;<i> +
</I>&gt;<i> +	config_file = mono_string_to_utf8 (domain-&gt;setup-&gt;configuration_file);
</I>&gt;<i> +	if (stat (config_file, &amp;sbuf) != 0) {
</I>&gt;<i> +		g_free (config_file);
</I>&gt;<i> +		return;
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i> +	if (!g_file_get_contents (config_file, &amp;text, &amp;len, NULL)) {
</I>&gt;<i> +		g_free (config_file);
</I>&gt;<i> +		return;
</I>&gt;<i> +	}
</I>&gt;<i> +	g_free (config_file);
</I>&gt;<i> +
</I>&gt;<i> +	runtime_start = strstr (text, &quot;&lt;runtime&gt;&quot;);
</I>&gt;<i> +	if (!runtime_start) {
</I>&gt;<i> +		g_free (text);
</I>&gt;<i> +		return;
</I>&gt;<i> +	}
</I>
Please remove this questionable (because it is buggy) hack.

&gt;<i> +	runtime_config = g_new0 (RuntimeConfig, 1);
</I>
No need to alloc/free this struct, just put it in the stack as a local var.

&gt;<i> +	runtime_config-&gt;domain = domain;
</I>&gt;<i> +	
</I>&gt;<i> +	context = g_markup_parse_context_new (&amp;mono_parser, 0, runtime_config, NULL);
</I>&gt;<i> +	if (g_markup_parse_context_parse (context, runtime_start, len - (runtime_start - text), NULL))
</I>&gt;<i> +		g_markup_parse_context_end_parse (context, NULL);
</I>
XML files need to parsed from the start, not from a ranom spot.
Please also make sure no new warning are added to the compilation and
that the test case actually runs.

Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024647.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
	<LI>Next message: <A HREF="024664.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24662">[ date ]</a>
              <a href="thread.html#24662">[ thread ]</a>
              <a href="subject.html#24662">[ subject ]</a>
              <a href="author.html#24662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
