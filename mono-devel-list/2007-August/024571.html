<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]System.IO.File.Replace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5DSystem.IO.File.Replace&In-Reply-To=37c5788d0708151508x377d5044rb6682133836c4b8%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024570.html">
   <LINK REL="Next"  HREF="024582.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]System.IO.File.Replace</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5DSystem.IO.File.Replace&In-Reply-To=37c5788d0708151508x377d5044rb6682133836c4b8%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH]System.IO.File.Replace">lupus at ximian.com
       </A><BR>
    <I>Thu Aug 16 12:17:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024570.html">[Mono-dev] [PATCH]System.IO.File.Replace
</A></li>
        <LI>Next message: <A HREF="024582.html">[Mono-dev] [PATCH]System.IO.File.Replace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24571">[ date ]</a>
              <a href="thread.html#24571">[ thread ]</a>
              <a href="subject.html#24571">[ subject ]</a>
              <a href="author.html#24571">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/15/07 Bill Holmes wrote:
&gt;<i> Attached is a patch that implements the 2.0 method File.IO.File.Replace.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://msdn2.microsoft.com/en-us/library/9etk7xw2.aspx">http://msdn2.microsoft.com/en-us/library/9etk7xw2.aspx</A>
</I>
Please mark your patch attachments as text files instead of as binary
blobs, thanks!

&gt;<i> Index: mono/mono/metadata/file-io.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/metadata/file-io.c	(revision 84157)
</I>&gt;<i> +++ mono/mono/metadata/file-io.c	(working copy)
</I>&gt;<i> @@ -10,6 +10,11 @@
</I>&gt;<i>   */
</I>&gt;<i>  
</I>&gt;<i>  #include &lt;config.h&gt;
</I>&gt;<i> +
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +#define _WIN32_WINNT 0x0500
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i>  #include &lt;glib.h&gt;
</I>&gt;<i>  #include &lt;string.h&gt;
</I>&gt;<i>  #include &lt;errno.h&gt;
</I>&gt;<i> @@ -384,6 +389,40 @@
</I>&gt;<i>  }
</I>&gt;<i>  
</I>&gt;<i>  MonoBoolean
</I>&gt;<i> +ves_icall_System_IO_MonoIO_ReplaceFile (MonoString *sourceFileName, MonoString *destinationFileName,
</I>&gt;<i> +					MonoString *destinationBackupFileName, MonoBoolean ignoreMetadataErrors,
</I>&gt;<i> +					gint32 *error)
</I>&gt;<i> +{
</I>&gt;<i> +	gboolean ret;
</I>&gt;<i> +	gunichar2 *utf16_sourceFileName=NULL, *utf16_destinationFileName=NULL, *utf16_destinationBackupFileName=NULL;
</I>&gt;<i> +	guint32 replaceFlags = REPLACEFILE_WRITE_THROUGH;
</I>&gt;<i> +	
</I>&gt;<i> +	MONO_ARCH_SAVE_REGS;
</I>&gt;<i> +
</I>&gt;<i> +	if(sourceFileName)
</I>&gt;<i> +		utf16_sourceFileName = mono_string_chars (sourceFileName);
</I>&gt;<i> +
</I>&gt;<i> +	if(destinationFileName)
</I>&gt;<i> +		utf16_destinationFileName = mono_string_chars (destinationFileName);
</I>&gt;<i> +
</I>&gt;<i> +	if(destinationBackupFileName)
</I>&gt;<i> +		utf16_destinationBackupFileName = mono_string_chars (destinationBackupFileName);
</I>&gt;<i> +
</I>&gt;<i> +	*error=ERROR_SUCCESS;
</I>
Please make new code follow the mono coding conventions: space before
parens, spaces around operators like = etc.

&gt;<i>  #endif /* _MONO_METADATA_FILEIO_H_ */
</I>&gt;<i> Index: mono/mono/metadata/icall-def.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/metadata/icall-def.h	(revision 84157)
</I>&gt;<i> +++ mono/mono/metadata/icall-def.h	(working copy)
</I>&gt;<i> @@ -270,22 +270,25 @@
</I>&gt;<i>  ICALL(MONOIO_16, &quot;Open(string,System.IO.FileMode,System.IO.FileAccess,System.IO.FileShare,System.IO.FileOptions,System.IO.MonoIOError&amp;)&quot;, ves_icall_System_IO_MonoIO_Open)
</I>&gt;<i>  ICALL(MONOIO_17, &quot;Read(intptr,byte[],int,int,System.IO.MonoIOError&amp;)&quot;, ves_icall_System_IO_MonoIO_Read)
</I>&gt;<i>  ICALL(MONOIO_18, &quot;RemoveDirectory(string,System.IO.MonoIOError&amp;)&quot;, ves_icall_System_IO_MonoIO_RemoveDirectory)
</I>&gt;<i> -ICALL(MONOIO_19, &quot;Seek(intptr,long,System.IO.SeekOrigin,System.IO.MonoIOError&amp;)&quot;, ves_icall_System_IO_MonoIO_Seek)
</I>
As written at the beginning of this file, do not rename all the entries,
just add the icall in the correctly sorted place. The sequential name is
meanlingless, you could use MONOIO_18M or MONOIO_185 in this case.

&gt;<i> +ICALL(MONOIO_31, &quot;get_DirectorySeparatorChar&quot;, ves_icall_System_IO_MonoIO_get_DirectorySeparatorChar)
</I>&gt;<i> +ICALL(MONOIO_32, &quot;get_InvalidPathChars&quot;, ves_icall_System_IO_MonoIO_get_InvalidPathChars)
</I>&gt;<i> +ICALL(MONOIO_33, &quot;get_PathSeparator&quot;, ves_icall_System_IO_MonoIO_get_PathSeparator)
</I>&gt;<i> +ICALL(MONOIO_34, &quot;get_VolumeSeparatorChar&quot;, ves_icall_System_IO_MonoIO_get_VolumeSeparatorChar)
</I>&gt;<i>  
</I>&gt;<i> +
</I>&gt;<i> +
</I>
Please don't add random withspace to the code.

&gt;<i> Index: mono/mono/io-layer/io.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/io-layer/io.c	(revision 84157)
</I>&gt;<i> +++ mono/mono/io-layer/io.c	(working copy)
</I>&gt;<i> @@ -1835,6 +1835,51 @@
</I>&gt;<i>  	return(ret);
</I>&gt;<i>  }
</I>&gt;<i>  
</I>&gt;<i> +gboolean write_file (int src_fd, int dest_fd, struct stat *st_src, gboolean report_errors)
</I>&gt;<i> +{
</I>&gt;<i> +	int remain, n;
</I>&gt;<i> +	int buf_size = st_src-&gt;st_blksize;
</I>&gt;<i> +	char *buf = (char *) alloca (buf_size);
</I>&gt;<i> +
</I>&gt;<i> +	for (;;) {
</I>&gt;<i> +		remain = read (src_fd, buf, buf_size);
</I>&gt;<i> +		
</I>&gt;<i> +		if (remain &lt; 0) {
</I>&gt;<i> +			if (errno == EINTR &amp;&amp; !_wapi_thread_cur_apc_pending ()) {
</I>&gt;<i> +				continue;
</I>&gt;<i> +			}
</I>&gt;<i> +			
</I>&gt;<i> +			if (report_errors)
</I>&gt;<i> +				_wapi_set_last_error_from_errno ();
</I>&gt;<i> +			
</I>&gt;<i> +			return(FALSE);
</I>&gt;<i> +		}
</I>&gt;<i> +		
</I>&gt;<i> +		if (remain == 0) {
</I>&gt;<i> +			break;
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		while (remain &gt; 0) {
</I>&gt;<i> +			if ((n = write (dest_fd, buf, remain)) &lt; 0) {
</I>&gt;<i> +				if (errno == EINTR &amp;&amp; !_wapi_thread_cur_apc_pending ())
</I>&gt;<i> +					continue;
</I>&gt;<i> +
</I>&gt;<i> +				if (report_errors)
</I>&gt;<i> +					_wapi_set_last_error_from_errno ();
</I>&gt;<i> +#ifdef DEBUG
</I>&gt;<i> +				g_message (&quot;%s: write failed.&quot;, __func__);
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> +				return (FALSE);
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			remain -= n;
</I>&gt;<i> +		}
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i> +	return (TRUE);
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i>  /**
</I>&gt;<i>   * CopyFile:
</I>&gt;<i>   * @name: a pointer to a NULL-terminated unicode string, that names
</I>&gt;<i> @@ -1852,9 +1897,6 @@
</I>&gt;<i>  {
</I>&gt;<i>  	gchar *utf8_src, *utf8_dest;
</I>&gt;<i>  	int src_fd, dest_fd;
</I>&gt;<i> -	int buf_size;
</I>&gt;<i> -	char *buf;
</I>&gt;<i> -	int remain, n;
</I>&gt;<i>  	struct stat st;
</I>&gt;<i>  	
</I>&gt;<i>  	if(name==NULL) {
</I>&gt;<i> @@ -1949,58 +1991,132 @@
</I>&gt;<i>  		return(FALSE);
</I>&gt;<i>  	}
</I>&gt;<i>  	
</I>&gt;<i> -	buf_size = st.st_blksize;
</I>&gt;<i> -	buf = (char *) alloca (buf_size);
</I>&gt;<i> +	if (!write_file (src_fd, dest_fd, &amp;st, TRUE)) {
</I>&gt;<i> +		g_free (utf8_src);
</I>&gt;<i> +		g_free (utf8_dest);
</I>&gt;<i> +		close (src_fd);
</I>&gt;<i> +		close (dest_fd);
</I>&gt;<i> +
</I>&gt;<i> +		return(FALSE);
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i> +	g_free (utf8_src);
</I>&gt;<i> +	g_free (utf8_dest);
</I>&gt;<i> +	close (src_fd);
</I>&gt;<i> +	close (dest_fd);
</I>&gt;<i> +
</I>&gt;<i> +	return(TRUE);
</I>
Use a local var to keep the result of write_file ():

	ret = write_file (...);
	// cleanup
	return ret;

This avoids needlessly duplicating all that code.

&gt;<i> +gboolean ReplaceFile (const gunichar2 *replacedFileName, const gunichar2 *replacementFileName,
</I>&gt;<i> +		      const gunichar2 *backupFileName, guint32 replaceFlags, 
</I>&gt;<i> +		      gpointer exclude, gpointer reserved)
</I>&gt;<i> +{
</I>[...]
&gt;<i> +		if (result == -1) {
</I>&gt;<i> +			_wapi_set_last_path_error_from_errno (NULL, utf8_backupFileName);
</I>&gt;<i> +			g_free (utf8_replacedFileName);
</I>&gt;<i> +			g_free (utf8_replacementFileName);
</I>&gt;<i> +			g_free (utf8_backupFileName);
</I>&gt;<i> +			close (backup_fd);
</I>&gt;<i> +			return(FALSE);
</I>&gt;<i> +		}	
</I>[...]
&gt;<i> +			if(replaced_fd == -1) {
</I>&gt;<i> +				g_free (utf8_replacedFileName);
</I>&gt;<i> +				g_free (utf8_replacementFileName);
</I>&gt;<i> +				g_free (utf8_backupFileName);
</I>&gt;<i> +				close (backup_fd);
</I>&gt;<i> +
</I>&gt;<i> +				return(FALSE);
</I>&gt;<i> +			}
</I>[...]
&gt;<i> +		g_free (utf8_replacedFileName);
</I>&gt;<i> +		g_free (utf8_replacementFileName);
</I>&gt;<i> +		g_free (utf8_backupFileName);
</I>&gt;<i> +		close (backup_fd);
</I>&gt;<i> +		close (replaced_fd);
</I>&gt;<i> +		return(FALSE);
</I>[...]
&gt;<i> +	g_free (utf8_replacedFileName);
</I>&gt;<i> +	g_free (utf8_replacementFileName);
</I>&gt;<i> +	g_free (utf8_backupFileName);
</I>&gt;<i> +	close (backup_fd);
</I>&gt;<i> +	
</I>&gt;<i>  	return(TRUE);
</I>
The cleanup code is replicated 4 times. In these cases it's better to
use a non-elegant but much more maintainable goto statement.

Thanks!
lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024570.html">[Mono-dev] [PATCH]System.IO.File.Replace
</A></li>
	<LI>Next message: <A HREF="024582.html">[Mono-dev] [PATCH]System.IO.File.Replace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24571">[ date ]</a>
              <a href="thread.html#24571">[ thread ]</a>
              <a href="subject.html#24571">[ subject ]</a>
              <a href="author.html#24571">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
