<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Support%20for%20runtime%20configuration%20of%20assembly%0A%20loading%20path%20-%20related%20to%20bug%20%2381446&In-Reply-To=20070823125820.GY1101%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024662.html">
   <LINK REL="Next"  HREF="024682.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Support%20for%20runtime%20configuration%20of%20assembly%0A%20loading%20path%20-%20related%20to%20bug%20%2381446&In-Reply-To=20070823125820.GY1101%40debian.org"
       TITLE="[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446">grendello at gmail.com
       </A><BR>
    <I>Thu Aug 23 09:26:25 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024662.html">[Mono-dev] Support for runtime configuration of	assembly	loading path - related to bug #81446
</A></li>
        <LI>Next message: <A HREF="024682.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24664">[ date ]</a>
              <a href="thread.html#24664">[ thread ]</a>
              <a href="subject.html#24664">[ subject ]</a>
              <a href="author.html#24664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 23 Aug 2007 14:58:20 +0200, Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; scribbled:

Updated patch attached.

regards,

marek

&gt;<i> On 08/23/07 Marek Habersack wrote:
</I>&gt;<i> &gt; &lt;?xml version=&quot;1.0&quot;?&gt;
</I>&gt;<i> &gt; &lt;configuration&gt;
</I>&gt;<i> &gt;     	&lt;runtime&gt;
</I>&gt;<i> &gt;         	&lt;assemblyBinding xmlns=&quot;urn:schemas-microsoft-com:asm.v1&quot;&gt;
</I>&gt;<i> &gt; 			&lt;probing privatePath=&quot;test:libraries&quot; /&gt;
</I>&gt;<i> &gt; 		&lt;/assemblyBinding&gt; 
</I>&gt;<i> &gt; 	&lt;/runtime&gt;
</I>&gt;<i> &gt; &lt;/configuration&gt;
</I>&gt;<i> 
</I>&gt;<i> &gt; Index: mono/metadata/appdomain.c
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- mono/metadata/appdomain.c	(revision 84664)
</I>&gt;<i> &gt; +++ mono/metadata/appdomain.c	(working copy)
</I>&gt;<i> [...]
</I>&gt;<i> &gt;  static gunichar2 process_guid [36];
</I>&gt;<i> &gt; @@ -484,6 +491,114 @@
</I>&gt;<i> &gt;  	return root-&gt;domain;
</I>&gt;<i> &gt;  }
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; +static
</I>&gt;<i> &gt; +char* get_attribute_value (const gchar **attribute_names, 
</I>&gt;<i> 
</I>&gt;<i> static char*
</I>&gt;<i> get_attribute_value (...)
</I>&gt;<i> 
</I>&gt;<i> &gt; +			   const gchar **attribute_values, 
</I>&gt;<i> &gt; +			   const char *att_name)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +	int n;
</I>&gt;<i> &gt; +	for (n=0; attribute_names[n] != NULL; n++) {
</I>&gt;<i> 
</I>&gt;<i> You need spaces around = and before an opening paren.
</I>&gt;<i> 
</I>&gt;<i> &gt; +		if (strcmp (attribute_names[n], att_name) == 0)
</I>&gt;<i> &gt; +			return g_strdup (attribute_values[n]);
</I>&gt;<i> &gt; +	}
</I>&gt;<i> &gt; +	return NULL;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static void start_element (GMarkupParseContext *context, 
</I>&gt;<i> 
</I>&gt;<i> static void on its own line.
</I>&gt;<i> 
</I>&gt;<i> &gt; +                           const gchar         *element_name,
</I>&gt;<i> &gt; +			   const gchar        **attribute_names,
</I>&gt;<i> 
</I>&gt;<i> The args are aligned with random amounts of tabs and spaces.
</I>&gt;<i> 
</I>&gt;<i> &gt; +			   const gchar        **attribute_values,
</I>&gt;<i> &gt; +			   gpointer             user_data,
</I>&gt;<i> &gt; +			   GError             **error)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +	RuntimeConfig *runtime_config = (RuntimeConfig*) user_data;
</I>&gt;<i> 
</I>&gt;<i> Remove the useless cast.
</I>&gt;<i> 
</I>&gt;<i> &gt; +	if (strcmp (element_name, &quot;runtime&quot;) == 0) {
</I>&gt;<i> &gt; +		runtime_config-&gt;runtime_count++;
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +	}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	if (strcmp (element_name, &quot;assemblyBinding&quot;) == 0) {
</I>&gt;<i> &gt; +		runtime_config-&gt;assemblybinding_count++;
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +	}
</I>&gt;<i> &gt; +	
</I>&gt;<i> &gt; +	if (runtime_config-&gt;runtime_count != 1 ||
</I>&gt;<i> &gt; runtime_config-&gt;assemblybinding_count != 1)
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	if (strcmp (element_name, &quot;probing&quot;) != 0)
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	runtime_config-&gt;domain-&gt;private_bin_path = get_attribute_value
</I>&gt;<i> &gt; (attribute_names, attribute_values, &quot;privatePath&quot;);
</I>&gt;<i> 
</I>&gt;<i> If private_bin_path had a value it is leaked.
</I>&gt;<i> 
</I>&gt;<i> &gt; +static void
</I>&gt;<i> &gt; +mono_set_private_bin_path_from_config (MonoDomain *domain)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +	gchar *config_file, *text, *runtime_start;
</I>&gt;<i> &gt; +	gsize len;
</I>&gt;<i> &gt; +	struct stat sbuf;
</I>&gt;<i> &gt; +	GMarkupParseContext *context;
</I>&gt;<i> &gt; +	RuntimeConfig *runtime_config;
</I>&gt;<i> &gt; +	
</I>&gt;<i> &gt; +	if (!domain || !domain-&gt;setup
</I>&gt;<i> &gt; || !domain-&gt;setup-&gt;configuration_file)
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	config_file = mono_string_to_utf8
</I>&gt;<i> &gt; (domain-&gt;setup-&gt;configuration_file);
</I>&gt;<i> &gt; +	if (stat (config_file, &amp;sbuf) != 0) {
</I>&gt;<i> &gt; +		g_free (config_file);
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +	}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	if (!g_file_get_contents (config_file, &amp;text, &amp;len, NULL)) {
</I>&gt;<i> &gt; +		g_free (config_file);
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +	}
</I>&gt;<i> &gt; +	g_free (config_file);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	runtime_start = strstr (text, &quot;&lt;runtime&gt;&quot;);
</I>&gt;<i> &gt; +	if (!runtime_start) {
</I>&gt;<i> &gt; +		g_free (text);
</I>&gt;<i> &gt; +		return;
</I>&gt;<i> &gt; +	}
</I>&gt;<i> 
</I>&gt;<i> Please remove this questionable (because it is buggy) hack.
</I>&gt;<i> 
</I>&gt;<i> &gt; +	runtime_config = g_new0 (RuntimeConfig, 1);
</I>&gt;<i> 
</I>&gt;<i> No need to alloc/free this struct, just put it in the stack as a local var.
</I>&gt;<i> 
</I>&gt;<i> &gt; +	runtime_config-&gt;domain = domain;
</I>&gt;<i> &gt; +	
</I>&gt;<i> &gt; +	context = g_markup_parse_context_new (&amp;mono_parser, 0,
</I>&gt;<i> &gt; runtime_config, NULL);
</I>&gt;<i> &gt; +	if (g_markup_parse_context_parse (context, runtime_start, len -
</I>&gt;<i> &gt; (runtime_start - text), NULL))
</I>&gt;<i> &gt; +		g_markup_parse_context_end_parse (context, NULL);
</I>&gt;<i> 
</I>&gt;<i> XML files need to parsed from the start, not from a ranom spot.
</I>&gt;<i> Please also make sure no new warning are added to the compilation and
</I>&gt;<i> that the test case actually runs.
</I>&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> lupus
</I>&gt;<i> 
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Bug57612.diff
Type: text/x-patch
Size: 6289 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070823/1a5d37d0/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070823/1a5d37d0/attachment.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 194 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070823/1a5d37d0/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070823/1a5d37d0/attachment-0001.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024662.html">[Mono-dev] Support for runtime configuration of	assembly	loading path - related to bug #81446
</A></li>
	<LI>Next message: <A HREF="024682.html">[Mono-dev] Support for runtime configuration of assembly loading path - related to bug #81446
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24664">[ date ]</a>
              <a href="thread.html#24664">[ thread ]</a>
              <a href="subject.html#24664">[ subject ]</a>
              <a href="author.html#24664">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
