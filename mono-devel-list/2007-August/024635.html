<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Cecil improvement
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Cecil%20improvement&In-Reply-To=018c01c7e409%2432da14a0%24988e3de0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024628.html">
   <LINK REL="Next"  HREF="024639.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Cecil improvement</H1>
    <B>Roei Erez</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Cecil%20improvement&In-Reply-To=018c01c7e409%2432da14a0%24988e3de0%24%40com"
       TITLE="[Mono-dev] Cecil improvement">roeie at mainsoft.com
       </A><BR>
    <I>Wed Aug 22 03:00:20 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024628.html">[Mono-dev] Cecil improvement
</A></li>
        <LI>Next message: <A HREF="024639.html">[Mono-dev] Cecil improvement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24635">[ date ]</a>
              <a href="thread.html#24635">[ thread ]</a>
              <a href="subject.html#24635">[ subject ]</a>
              <a href="author.html#24635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think we should differentiate between two types of users, those who
only want to read and explore the assembly and those who use cecil to
write the assembly.
When writing an assembly a user needs to build the full object model, so
I don't think there is a lot of room for improvement at this area.
This is not the case when reading an assembly, which is a common case,
and especially when the user is interested only in part of the assembly.

I agree that cecil should expose an interface to load an assembly as
'Read Only', where the optimizations should be activated, and by that
save the worrying of the changes to the assembly writing part.
I have played with the code a little bit and saw that when loading some
assemblies in a total size of 25M the memory usage has reached 250M.
When I have omitted the building of the object model the memory was
reduced to 120M, and the loading time was improved enormously.
I really like the idea that the object model will access the raw tables
directly and in lazy way.
This idea will work only if the access to the raw table will be fast,
and in order to do so, the code needs to build more relations between
these tables.
We can take the CustomAttributes table for example, each raw at this
table has the 'RID' of the owner element, and the TokenType of the
owner, and in order for a 'Field', for example, to load its
CustomAttibutes lazily, it needs that opposite relation, from its 'RID'
to its CustomAttributes, will exist.

I basically want to suggest the following:
The methods of the ReflectionReader will be changed, and instead of
building an object model, they will only build the desired relations
between elements (Methods-&gt;Types, Fields-&gt;Constants,
Fields-&gt;InitialValues ...)
The higher object model classes (TypeDefinition, MethodDefinition,
FieldDefinition ...), will have their properties access lazily those
built relations in order to fetch the data on first access.
My favorite solution is to write a 'ReadOnlyReflectionReader' that will
contain the above changes, and leave the current implementation as is
for writing purposes.
I think we should also consider removing the 'sealed' modifier from the
higher level object model classes (like TypeDefinition, MethodDefinition
...), by that give the used ReflectionReader full control over the
object model implementation, building its own read-only one.

Now is a good time for us to start such a process, and I would really
want to push things forward.
What do you think about the suggestion?
If you think about major issues that the above solution will encounter,
I would be happy to hear about them. 

Regares, 
Roei Erez

-----Original Message-----
From: Rolf Bjarne Kvinge [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">rolflists at ya.com</A>] 
Sent: Tuesday, August 21, 2007 5:38 PM
To: 'Jb Evain'; Roei Erez
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: RE: [Mono-dev] Cecil improvement



&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
</I>[mailto:mono-devel-list-
&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bounces at lists.ximian.com</A>] On Behalf Of Jb Evain
</I>&gt;<i> Sent: martes, 21 de agosto de 2007 17:08
</I>&gt;<i> To: Roei Erez
</I>&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-dev] Cecil improvement
</I>&gt;<i> 
</I>&gt;<i> Hey,
</I>&gt;<i> 
</I>&gt;<i> On 8/21/07, Roei Erez &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">roeie at mainsoft.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As you may know we, at mainsoft, use cecil library.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have made some analysis for the performance and found that
</I>loading
&gt;<i> &gt; assemblies with cecil has a lot of memory consuming impact.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Investigating this thing more had shown that the code creates a full
</I>&gt;<i> object
</I>&gt;<i> &gt; model on top of the assembly row tables.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We understand that for writing/creating assembly using cecil ,
</I>&gt;<i> building a
</I>&gt;<i> &gt; full object model  might be unavoidable, but for a lot of users that
</I>&gt;<i> only
</I>&gt;<i> &gt; wants to read an assembly, and event interested only in part of the
</I>&gt;<i> assembly
</I>&gt;<i> &gt; it might be not necessary.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We believe that improving this area will give theses users a better
</I>&gt;<i> &gt; experience that will be realized in less memory consumption and
</I>&gt;<i> faster
</I>&gt;<i> &gt; loading time.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nowadays, we are looking for ways to improve cecil in this area.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I will be happy to know what you think, and whether you have had
</I>&gt;<i> thoughts
</I>&gt;<i> &gt; about this issue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any thoughts, suggestions and questions are welcome.
</I>&gt;<i> 
</I>&gt;<i> I'm also interested in improving Cecil's memory usage, and assembly
</I>&gt;<i> load time, as it affects basically every user.
</I>&gt;<i> 
</I>&gt;<i> The easier way I can think of right now, to save some memory, is to
</I>&gt;<i> discard the Cecil's representation of the table heap after an assembly
</I>&gt;<i> is loaded, as it is not need afterwards. But that won't improve the
</I>&gt;<i> load time.
</I>&gt;<i> 
</I>&gt;<i> A real and full optimization would be to read Cecil's higher level
</I>&gt;<i> object model straight from the raw bytes. But that requires quite a
</I>&gt;<i> big amount of work. And extra work to keep the assembly writing part
</I>&gt;<i> working.
</I>&gt;<i> 
</I>
Maybe an option to load an assembly read-only would make sense, as well
as
an option to not load anything until requested (a compiler for instance,
would only need the names of all the types when loading the assembly, no
need to load type members until the type is actually referenced in code
somehow).

Rolf 

&gt;<i> There's also a few people using only the Mono.Cecil.Binary part, to
</I>&gt;<i> only read the PE file. So there are quite a few things to take into
</I>&gt;<i> consideration before doing anything.
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Jb Evain  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jb at nurv.fr</A>&gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> No virus found in this incoming message.
</I>&gt;<i> Checked by AVG Free Edition.
</I>&gt;<i> Version: 7.5.484 / Virus Database: 269.12.1/963 - Release Date:
</I>&gt;<i> 20/08/2007 17:44
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024628.html">[Mono-dev] Cecil improvement
</A></li>
	<LI>Next message: <A HREF="024639.html">[Mono-dev] Cecil improvement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24635">[ date ]</a>
              <a href="thread.html#24635">[ thread ]</a>
              <a href="subject.html#24635">[ subject ]</a>
              <a href="author.html#24635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
