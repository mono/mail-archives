<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono AOT for 64-bit Windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Mono%20AOT%20for%2064-bit%20Windows&In-Reply-To=%3C1372353554.55747.YahooMailNeo%40web5704.biz.mail.ne1.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040570.html">
   <LINK REL="Next"  HREF="040573.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono AOT for 64-bit Windows</H1>
    <B>Gavin Dodd</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Mono%20AOT%20for%2064-bit%20Windows&In-Reply-To=%3C1372353554.55747.YahooMailNeo%40web5704.biz.mail.ne1.yahoo.com%3E"
       TITLE="[Mono-dev] Mono AOT for 64-bit Windows">admin at wholesalealgorithms.com
       </A><BR>
    <I>Thu Jun 27 17:19:14 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040570.html">[Mono-dev] Mono AOT for 64-bit Windows
</A></li>
        <LI>Next message: <A HREF="040573.html">[Mono-dev] Mono AOT for 64-bit Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40577">[ date ]</a>
              <a href="thread.html#40577">[ thread ]</a>
              <a href="subject.html#40577">[ subject ]</a>
              <a href="author.html#40577">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just dealt with AOT cross compiling from win64 to freebsd/amd64 and had something like this

mono_marshal_get_icall_wrapper emits the address of the function to call at the time of compilation.


As I was only concerned with AOT I just changed

mono_mb_emit_native_call (mb, csig2, (gpointer) func);

to

mono_mb_emit_byte (mb, MONO_CUSTOM_PREFIX);
mono_mb_emit_op (mb, CEE_MONO_ICALL, func);

I'm sure there was another case that also emitted the wrong address in the same way but can't find it at the moment.

Another issue that probably doesn't apply to you, but caused huge problems, was alignment of data structures between different compilers.
The mono vm compiled on freebsd had different alignment for bitfields than the compiler built with msvc.

Gavin




________________________________
 From: voldemarz &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">voldemarz at gmail.com</A>&gt;
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A> 
Sent: Thursday, June 27, 2013 9:52 AM
Subject: Re: [Mono-dev] Mono AOT for 64-bit Windows
 

Thanks for input. By seasoned you mean someone who has good knowledge of Mono
internals or generally a guy with low level experience on various
platforms/architectures?

I slightly modified ASM generation 
- wrapped .type and .size within .def/.endef directives
- removed local symbol emission
- removed underscore in front of global symbols 

Now I can generate AOT images and runtime seems to find all data structures
it needs. In few first runs surprisingly some simple tests worked
successfully in aot and full-aot mode - console output, simple calculations,
events, catching exceptions, allocating bunch of objects and invoking
garbage collection.

Then I regenerated AOT image of mscorlib and it doesn't work any more.
Trying to figure out issues now. In full-aot mode it crashes after a jump to
a non-executable memory region from function
wrapper_managed_to_native_object___icall_wrapper_mono_object_new_ptrfree_box_intptr

The first few ops after the function prolog look like this (full function
asm&#160; here &lt;<A HREF="http://pastebin.com/GfTLeN1e">http://pastebin.com/GfTLeN1e</A>&gt;&#160; ):
mov&#160; &#160; &#160; &#160;  rax,7FACDFD19E0h
mov&#160; &#160; &#160; &#160;  rcx,qword ptr [rbp-70h]
sub&#160; &#160; &#160; &#160;  rsp,20h
mov&#160; &#160; &#160; &#160; qword ptr [rbp-38h],rsp
call&#160; &#160; &#160; &#160;  rax

The address loaded into rax looks very suspicios. As far I can see that
function is compiled from IL. Haven't tracked down were is it coming from?
Could someone point me to it? What is it attempting call internally?



--
View this message in context: <A HREF="http://mono.1490590.n4.nabble.com/Mono-AOT-for-64-bit-Windows-tp4659926p4660049.html">http://mono.1490590.n4.nabble.com/Mono-AOT-for-64-bit-Windows-tp4659926p4660049.html</A>
Sent from the Mono - Dev mailing list archive at Nabble.com.
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130627/0456adea/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130627/0456adea/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040570.html">[Mono-dev] Mono AOT for 64-bit Windows
</A></li>
	<LI>Next message: <A HREF="040573.html">[Mono-dev] Mono AOT for 64-bit Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40577">[ date ]</a>
              <a href="thread.html#40577">[ thread ]</a>
              <a href="subject.html#40577">[ subject ]</a>
              <a href="author.html#40577">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
