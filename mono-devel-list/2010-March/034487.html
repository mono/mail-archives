<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Two%20patches%20to%20make%20SGen%20work%20on%20Darwin/x86&In-Reply-To=f54ff3e81003241510w39424d97nc3cb91ad07301896%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034485.html">
   <LINK REL="Next"  HREF="034473.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Two%20patches%20to%20make%20SGen%20work%20on%20Darwin/x86&In-Reply-To=f54ff3e81003241510w39424d97nc3cb91ad07301896%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86">lupus at ximian.com
       </A><BR>
    <I>Thu Mar 25 06:07:48 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034485.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
        <LI>Next message: <A HREF="034473.html">[Mono-dev] Mono.Security - ssl certificate datetime parsing causes	crash on some cultures. (patch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34487">[ date ]</a>
              <a href="thread.html#34487">[ thread ]</a>
              <a href="subject.html#34487">[ subject ]</a>
              <a href="author.html#34487">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/24/10 Mark Probst wrote:
&gt;<i> Here's an updated patch that fixes this problem, both for mono-ehash
</I>&gt;<i> as well as for mono-hash.
</I>

&gt;<i> --- a/mono/metadata/boehm-gc.c
</I>&gt;<i> +++ b/mono/metadata/boehm-gc.c
</I>&gt;<i> @@ -932,5 +932,11 @@ mono_gc_get_write_barrier (void)
</I>&gt;<i>  
</I>&gt;<i>  #endif
</I>&gt;<i>  
</I>&gt;<i> +void
</I>&gt;<i> +mono_gc_invoke_without_moving (void (*func) (void*), void *data)
</I>&gt;<i> +{
</I>&gt;<i> +	func (data);
</I>&gt;<i> +}
</I>&gt;<i> +
</I>
Please introduce a typedef for the function pointer type.
I think the naming here is misleading, since the issue is not just about
moving the objects, but also about them being collected.
Moreover, I think the feature should be actually implemented in Boehm
since it's provided by the library and it can be useful for other cases,
too.

&gt;<i> --- a/mono/metadata/sgen-gc.c
</I>&gt;<i> +++ b/mono/metadata/sgen-gc.c
</I>&gt;<i> @@ -597,6 +597,7 @@ safe_object_get_size (MonoObject* o)
</I>&gt;<i>   * ######################################################################
</I>&gt;<i>   */
</I>&gt;<i>  static LOCK_DECLARE (gc_mutex);
</I>&gt;<i> +static LOCK_DECLARE (interruption_mutex);
</I>
It may be better to put the declaration of the mutexes far from each
other so that there are more chances they'll end up in separate
cachelines and hence provide an effective advantage wrt using a single
mutex.

&gt;<i>  static int gc_disabled = 0;
</I>&gt;<i>  static int num_minor_gcs = 0;
</I>&gt;<i>  static int num_major_gcs = 0;
</I>&gt;<i> @@ -3337,6 +3338,8 @@ collect_nursery (size_t requested_size)
</I>&gt;<i>  	TV_DECLARE (atv);
</I>&gt;<i>  	TV_DECLARE (btv);
</I>&gt;<i>  
</I>&gt;<i> +	LOCK_INTERRUPTION;
</I>
You need to put the lock acquisition at the start of
stop_world(), here it can cause a deadlock, since a thread may be
stopped while holding interruption_mutex and this call here
will wait indefinitely.
Also, to prepare for the future changes, introduce two functions:
void acquire_gc_locks (void) and void release_gc_locks (void) and
call them in stop_world()/restart().

The rest looks ok to me.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034485.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
	<LI>Next message: <A HREF="034473.html">[Mono-dev] Mono.Security - ssl certificate datetime parsing causes	crash on some cultures. (patch)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34487">[ date ]</a>
              <a href="thread.html#34487">[ thread ]</a>
              <a href="subject.html#34487">[ subject ]</a>
              <a href="author.html#34487">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
