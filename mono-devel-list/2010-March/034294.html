<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Fix Sparc/Linux build.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20Sparc/Linux%20build.&In-Reply-To=20100304.031402.212580173.davem%40davemloft.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034286.html">
   <LINK REL="Next"  HREF="034287.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Fix Sparc/Linux build.</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20Sparc/Linux%20build.&In-Reply-To=20100304.031402.212580173.davem%40davemloft.net"
       TITLE="[Mono-dev] [PATCH] Fix Sparc/Linux build.">vargaz at gmail.com
       </A><BR>
    <I>Fri Mar  5 09:24:01 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034286.html">[Mono-dev] [PATCH] Fix Sparc/Linux build.
</A></li>
        <LI>Next message: <A HREF="034287.html">[Mono-dev] System.Threading.Monitor::Exit fails in latest trees
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34294">[ date ]</a>
              <a href="thread.html#34294">[ thread ]</a>
              <a href="subject.html#34294">[ subject ]</a>
              <a href="author.html#34294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

  Applied to SVN HEAD/2.6 branch.

         thanks

                   Zoltan

On Thu, Mar 4, 2010 at 12:14 PM, David Miller &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at davemloft.net</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> This was the minimal set of changes I needed to get mainline
</I>&gt;<i> to build for me.
</I>&gt;<i>
</I>&gt;<i> libgc/
</I>&gt;<i>
</I>&gt;<i> 2010-03-04  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at davemloft.net</A>&gt;
</I>&gt;<i>
</I>&gt;<i>        * include/private/gc_locks.h: Add SPARC implementations of
</I>&gt;<i>        GC_compare_and_exchange and GC_memory_barrier.
</I>&gt;<i>
</I>&gt;<i> mono/mini/
</I>&gt;<i>
</I>&gt;<i> 2010-03-04  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at davemloft.net</A>&gt;
</I>&gt;<i>
</I>&gt;<i>        * mini-sparc.h: Always use MONO_ARCH_USE_SIGACTION.  Linux kernels
</I>&gt;<i>        that don't provide the siginfo in the second signal handler argument
</I>&gt;<i>        are buggy, and this has been fixed for years.
</I>&gt;<i>        * mini.h (GET_CONTEXT): Remove __sparc__ special case.
</I>&gt;<i>        (SIG_HANDLER_SIGNATURE, SIG_HANDLER_PARMS): Likewise.
</I>&gt;<i>
</I>&gt;<i> diff --git a/libgc/include/private/gc_locks.h
</I>&gt;<i> b/libgc/include/private/gc_locks.h
</I>&gt;<i> index 23a506a..1cbcbd6 100644
</I>&gt;<i> --- a/libgc/include/private/gc_locks.h
</I>&gt;<i> +++ b/libgc/include/private/gc_locks.h
</I>&gt;<i> @@ -500,6 +500,51 @@
</I>&gt;<i>         }
</I>&gt;<i>  #     endif /* POWERPC */
</I>&gt;<i>
</I>&gt;<i> +#     if defined(SPARC)
</I>&gt;<i> +#      if !defined(GENERIC_COMPARE_AND_SWAP)
</I>&gt;<i> +#       if CPP_WORDSZ == 64
</I>&gt;<i> +        /* Returns TRUE if the comparison succeeded. */
</I>&gt;<i> +        inline static GC_bool GC_compare_and_exchange(volatile GC_word
</I>&gt;<i> *addr,
</I>&gt;<i> +            GC_word old, GC_word new_val)
</I>&gt;<i> +        {
</I>&gt;<i> +            unsigned long result;
</I>&gt;<i> +            __asm__ __volatile__(
</I>&gt;<i> +               &quot;casx [%2], %3, %0&quot;
</I>&gt;<i> +                :  &quot;=r&quot; (result)
</I>&gt;<i> +                :  &quot;0&quot; (new_val), &quot;r&quot; (addr), &quot;r&quot; (old)
</I>&gt;<i> +                : &quot;memory&quot;);
</I>&gt;<i> +            return (GC_bool) (result == old);
</I>&gt;<i> +        }
</I>&gt;<i> +#       else
</I>&gt;<i> +        /* Returns TRUE if the comparison succeeded. */
</I>&gt;<i> +        inline static GC_bool GC_compare_and_exchange(volatile GC_word
</I>&gt;<i> *_addr,
</I>&gt;<i> +            GC_word _old, GC_word _new_val)
</I>&gt;<i> +        {
</I>&gt;<i> +           register unsigned long result asm(&quot;o0&quot;);
</I>&gt;<i> +           register unsigned long old asm(&quot;o1&quot;);
</I>&gt;<i> +           register volatile GC_word *addr asm(&quot;o2&quot;);
</I>&gt;<i> +           result = _new_val;
</I>&gt;<i> +           old = _old;
</I>&gt;<i> +           addr = _addr;
</I>&gt;<i> +            __asm__ __volatile__(
</I>&gt;<i> +               /* We encode the instruction directly so that it
</I>&gt;<i> +                  doesn't taint the whole binary as v9-only.  */
</I>&gt;<i> +               &quot;.word 0xd1e29009&quot; /* cas [%o2], %o1, %o0 */
</I>&gt;<i> +                :  &quot;=r&quot; (result)
</I>&gt;<i> +                :  &quot;0&quot; (result), &quot;r&quot; (addr), &quot;r&quot;(old)
</I>&gt;<i> +                : &quot;memory&quot;);
</I>&gt;<i> +            return (GC_bool) (result == old);
</I>&gt;<i> +        }
</I>&gt;<i> +#       endif
</I>&gt;<i> +#      endif /* !GENERIC_COMPARE_AND_SWAP */
</I>&gt;<i> +        inline static void GC_memory_barrier()
</I>&gt;<i> +        {
</I>&gt;<i> +           /* All sparc v9 chips provice procesor consistent ordering. */
</I>&gt;<i> +           /* Thus a compiler barrier should suffice.                  */
</I>&gt;<i> +            __asm__ __volatile__(&quot;&quot; : : : &quot;memory&quot;);
</I>&gt;<i> +        }
</I>&gt;<i> +#     endif /* SPARC */
</I>&gt;<i> +
</I>&gt;<i>  #     if defined(IA64)
</I>&gt;<i>  #      if !defined(GENERIC_COMPARE_AND_SWAP)
</I>&gt;<i>          inline static GC_bool GC_compare_and_exchange(volatile GC_word
</I>&gt;<i> *addr,
</I>&gt;<i> diff --git a/mono/mini/mini-sparc.h b/mono/mini/mini-sparc.h
</I>&gt;<i> index 5cc2ec4..3f3eefd 100644
</I>&gt;<i> --- a/mono/mini/mini-sparc.h
</I>&gt;<i> +++ b/mono/mini/mini-sparc.h
</I>&gt;<i> @@ -100,14 +100,7 @@ typedef struct MonoCompileArch {
</I>&gt;<i>                MONO_CONTEXT_SET_SP ((ctx), __builtin_frame_address (0));
</I>&gt;<i>     \
</I>&gt;<i>        } while (0)
</I>&gt;<i>
</I>&gt;<i> -#ifndef __linux__
</I>&gt;<i> -/*
</I>&gt;<i> - * Can't use sigaction on sparc/linux, since it doesn't support
</I>&gt;<i> SA_SIGINFO. Instead, we
</I>&gt;<i> - * have to use the obsolete sigcontext parameter:
</I>&gt;<i> - * <A HREF="http://www.ussg.iu.edu/hypermail/linux/kernel/0110.3/1531.html.">http://www.ussg.iu.edu/hypermail/linux/kernel/0110.3/1531.html.</A>
</I>&gt;<i> - */
</I>&gt;<i>  #define MONO_ARCH_USE_SIGACTION 1
</I>&gt;<i> -#endif
</I>&gt;<i>
</I>&gt;<i>  #ifdef HAVE_WORKING_SIGALTSTACK
</I>&gt;<i>  /*#define MONO_ARCH_SIGSEGV_ON_ALTSTACK*/
</I>&gt;<i> diff --git a/mono/mini/mini.h b/mono/mini/mini.h
</I>&gt;<i> index 2410f7b..17432be 100644
</I>&gt;<i> --- a/mono/mini/mini.h
</I>&gt;<i> +++ b/mono/mini/mini.h
</I>&gt;<i> @@ -2061,9 +2061,6 @@ gboolean mono_gdb_render_native_backtraces (void)
</I>&gt;<i> MONO_INTERNAL;
</I>&gt;<i>  #ifdef MONO_ARCH_USE_SIGACTION
</I>&gt;<i>  #define GET_CONTEXT \
</I>&gt;<i>     void *ctx = context;
</I>&gt;<i> -#elif defined(__sparc__)
</I>&gt;<i> -#define GET_CONTEXT \
</I>&gt;<i> -    void *ctx = sigctx;
</I>&gt;<i>  #else
</I>&gt;<i>  #define GET_CONTEXT \
</I>&gt;<i>        void **_p = (void **)&amp;_dummy; \
</I>&gt;<i> @@ -2078,9 +2075,6 @@ gboolean mono_gdb_render_native_backtraces (void)
</I>&gt;<i> MONO_INTERNAL;
</I>&gt;<i>  #elif defined(HOST_WIN32)
</I>&gt;<i>  #define SIG_HANDLER_SIGNATURE(ftn) ftn (int _dummy, EXCEPTION_RECORD
</I>&gt;<i> *info, void *context)
</I>&gt;<i>  #define SIG_HANDLER_PARAMS _dummy, info, context
</I>&gt;<i> -#elif defined(__sparc__)
</I>&gt;<i> -#define SIG_HANDLER_SIGNATURE(ftn) ftn (int _dummy, void *sigctx)
</I>&gt;<i> -#define SIG_HANDLER_PARAMS _dummy, sigctx
</I>&gt;<i>  #else
</I>&gt;<i>  #define SIG_HANDLER_SIGNATURE(ftn) ftn (int _dummy)
</I>&gt;<i>  #define SIG_HANDLER_PARAMS _dummy
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100305/f697b1e1/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100305/f697b1e1/attachment-0001.html</A> 
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034286.html">[Mono-dev] [PATCH] Fix Sparc/Linux build.
</A></li>
	<LI>Next message: <A HREF="034287.html">[Mono-dev] System.Threading.Monitor::Exit fails in latest trees
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34294">[ date ]</a>
              <a href="thread.html#34294">[ thread ]</a>
              <a href="subject.html#34294">[ subject ]</a>
              <a href="author.html#34294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
