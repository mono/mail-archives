<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Implement guarded finally blocks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Implement%20guarded%20finally%20blocks&In-Reply-To=20100326154951.GB4259%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034518.html">
   <LINK REL="Next"  HREF="034489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Implement guarded finally blocks</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Implement%20guarded%20finally%20blocks&In-Reply-To=20100326154951.GB4259%40debian.org"
       TITLE="[Mono-dev] [PATCH] Implement guarded finally blocks">kumpera at gmail.com
       </A><BR>
    <I>Mon Mar 29 18:42:02 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034518.html">[Mono-dev] [PATCH] Implement guarded finally blocks
</A></li>
        <LI>Next message: <A HREF="034489.html">[Mono-dev] Threading parameters? Fill a DataGridView via Invoke	very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34533">[ date ]</a>
              <a href="thread.html#34533">[ thread ]</a>
              <a href="subject.html#34533">[ subject ]</a>
              <a href="author.html#34533">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Mar 26, 2010 at 12:49 PM, Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; wrote:

&gt;<i> On 03/24/10 Rodrigo Kumpera wrote:
</I>&gt;<i> &gt; --- a/mono/mini/mini-exceptions.c
</I>&gt;<i> &gt; +++ b/mono/mini/mini-exceptions.c
</I>&gt;<i> [...]
</I>&gt;<i> &gt; +static gboolean
</I>&gt;<i> &gt; +find_last_handler_block (MonoDomain *domain, MonoContext *ctx,
</I>&gt;<i> MonoJitInfo *ji, gpointer data)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +     int i;
</I>&gt;<i> &gt; +     gpointer ip;
</I>&gt;<i> &gt; +     FindHandlerBlockData *pdata = data;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     if (ji-&gt;method-&gt;wrapper_type)
</I>&gt;<i> &gt; +             return FALSE;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     ip = MONO_CONTEXT_GET_IP (ctx);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     for (i = 0; i &lt; ji-&gt;num_clauses; ++i) {
</I>&gt;<i> &gt; +             MonoJitExceptionInfo *ei = ji-&gt;clauses + i;
</I>&gt;<i> &gt; +             if (ei-&gt;flags != MONO_EXCEPTION_CLAUSE_FINALLY)
</I>&gt;<i> &gt; +                     continue;
</I>&gt;<i> &gt; +             /*If ip points to the first instruction it means the
</I>&gt;<i> handler block didn't start
</I>&gt;<i> &gt; +              so we can leave its execution to the EH machinery*/
</I>&gt;<i> &gt; +             if (ei-&gt;handler_start &lt; ip &amp;&amp; ip &lt; ei-&gt;data.handler_end) {
</I>&gt;<i> &gt; +                     pdata-&gt;ji = ji;
</I>&gt;<i> &gt; +                     pdata-&gt;ei = ei;
</I>&gt;<i> &gt; +                     pdata-&gt;ctx = *ctx;
</I>&gt;<i> &gt; +                     break;
</I>&gt;<i>
</I>&gt;<i> Shouldn't the stack walk be interrupted here once we found the finally
</I>&gt;<i> clause?
</I>&gt;<i>
</I>
No, we must guard around the botton finally clause. Since we can only do
stackwalks in one direction this requires us to walk the whole stack. This
could
be fixed by walking from bottom to top, but it's a significantly complex
change for
something that is not performance critical AFAICT.

The protection works across all usual suspects such as runtime invokes and
x-domain
calls, so the only criteria I could come up with is that is that has to be
the bottom one.



&gt;<i>
</I>&gt;<i> &gt; --- a/mono/mini/mini-posix.c
</I>&gt;<i> &gt; +++ b/mono/mini/mini-posix.c
</I>&gt;<i> &gt; @@ -189,7 +190,15 @@ SIG_HANDLER_SIGNATURE (sigusr1_signal_handler)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;       if (mono_debugger_agent_thread_interrupt (ctx, ji))
</I>&gt;<i> &gt;               return;
</I>&gt;<i> &gt; -
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     /* We can't do handler block checking from metadata since it
</I>&gt;<i> requires doing
</I>&gt;<i> &gt; +      * a stack walk with context.
</I>&gt;<i> &gt; +      */
</I>&gt;<i> &gt; +     mono_arch_sigctx_to_monoctx (ctx, &amp;mctx);
</I>&gt;<i> &gt; +     if (mono_install_handler_block_guard (thread, &amp;mctx)) {
</I>&gt;<i> &gt; +             return;
</I>&gt;<i> &gt; +     }
</I>&gt;<i> &gt; +#
</I>&gt;<i>
</I>&gt;<i> Leftover here.
</I>&gt;<i>
</I>
Fixed.


&gt;<i>
</I>&gt;<i> &gt; --- a/mono/mini/mini-x86.c
</I>&gt;<i> &gt; +++ b/mono/mini/mini-x86.c
</I>&gt;<i> &gt; @@ -5809,6 +5809,70 @@ mono_arch_decompose_long_opts (MonoCompile *cfg,
</I>&gt;<i> MonoInst *long_ins)
</I>&gt;<i> &gt;  #endif /* MONO_ARCH_SIMD_INTRINSICS */
</I>&gt;<i> &gt;  }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; +/*MONO_ARCH_HAVE_HANDLER_BLOCK_GUARD*/
</I>&gt;<i> &gt; +gpointer
</I>&gt;<i> &gt; +mono_arch_install_handler_block_guard (MonoJitInfo *ji, MonoContext
</I>&gt;<i> *ctx, gpointer new_value)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +     int i;
</I>&gt;<i> &gt; +     int offset;
</I>&gt;<i> &gt; +     MonoJitExceptionInfo *clause = NULL;
</I>&gt;<i> &gt; +     gpointer ip, *sp, old_value;
</I>&gt;<i> &gt; +     char *bp;
</I>&gt;<i> &gt; +     const unsigned char *handler;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     ip = MONO_CONTEXT_GET_IP (ctx);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     for (i = 0; i &lt; ji-&gt;num_clauses; ++i) {
</I>&gt;<i> &gt; +             clause = &amp;ji-&gt;clauses [i];
</I>&gt;<i> &gt; +             if (clause-&gt;flags != MONO_EXCEPTION_CLAUSE_FINALLY)
</I>&gt;<i> &gt; +                     continue;
</I>&gt;<i> &gt; +             if (clause-&gt;handler_start &lt; ip &amp;&amp; clause-&gt;data.handler_end
</I>&gt;<i> &gt; ip)
</I>&gt;<i> &gt; +                     break;
</I>&gt;<i> &gt; +     }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     /*no matching finally */
</I>&gt;<i> &gt; +     if (i == ji-&gt;num_clauses)
</I>&gt;<i> &gt; +             return NULL;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +     /*If we stopped on the instruction right before the try, we haven't
</I>&gt;<i> actually started executing it*/
</I>&gt;<i> &gt; +     if (ip == clause-&gt;handler_start)
</I>&gt;<i> &gt; +             return NULL;
</I>&gt;<i> &gt; +
</I>&gt;<i>
</I>&gt;<i> Up to here there is nothing that is arch-specific. All this code should
</I>&gt;<i> be moved to the caller.
</I>

Fixed.


&gt;<i>
</I>&gt;<i> The rest of the changes look fine to me.
</I>&gt;<i> You might need to disable this code with aot, since I'm not sure the
</I>&gt;<i> complete clause data is saved in that case for this to work: did you
</I>&gt;<i> test it already? Or the aot changes would need to be implemented, anyway
</I>&gt;<i>
</I>
The current code doesn't work under full-aot as we don't save the
trampolines, I'll follow with Zoltan on this.
I just tested under AOT and a pair of issues arose. Both fixed now.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100329/3092efbe/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100329/3092efbe/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: handler_block_guard_2.patch
Type: text/x-patch
Size: 19138 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100329/3092efbe/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100329/3092efbe/attachment-0001.bin</A> 
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034518.html">[Mono-dev] [PATCH] Implement guarded finally blocks
</A></li>
	<LI>Next message: <A HREF="034489.html">[Mono-dev] Threading parameters? Fill a DataGridView via Invoke	very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34533">[ date ]</a>
              <a href="thread.html#34533">[ thread ]</a>
              <a href="subject.html#34533">[ subject ]</a>
              <a href="author.html#34533">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
