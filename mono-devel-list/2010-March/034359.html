<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Issues with System.Random
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Issues%20with%20System.Random&In-Reply-To=006501cac4ea%240024e610%24006eb230%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034357.html">
   <LINK REL="Next"  HREF="034367.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Issues with System.Random</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Issues%20with%20System.Random&In-Reply-To=006501cac4ea%240024e610%24006eb230%24%40com"
       TITLE="[Mono-dev] Issues with System.Random">kornelpal at gmail.com
       </A><BR>
    <I>Tue Mar 16 06:16:20 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034357.html">[Mono-dev] Issues with System.Random
</A></li>
        <LI>Next message: <A HREF="034367.html">[Mono-dev] Issues with System.Random
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34359">[ date ]</a>
              <a href="thread.html#34359">[ thread ]</a>
              <a href="subject.html#34359">[ subject ]</a>
              <a href="author.html#34359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Also note that this patch seems to break serialization compatibility 
that might be a problem for some applications.

Korn&#233;l

Andreas Nahr wrote:
&gt;<i> I won't comment on the algorithm itself (keep in mind that the existing one
</I>&gt;<i> already was replaced once with a &quot;better&quot; one which failed miserably in real
</I>&gt;<i> world apps, so had to be reverted).
</I>&gt;<i> Also a newsgroup as source doesn't sound reliable at all.
</I>&gt;<i> 
</I>&gt;<i> But your patch adds errors for exceptions (which were mostly correct
</I>&gt;<i> before). And the unit-tests are no &quot;unit-tests&quot;. They don't test the
</I>&gt;<i> implementation against the specification, they test the implementation
</I>&gt;<i> against the implementation which is useless. And moreover you removed ALL
</I>&gt;<i> Random() constructor tests which most likely are the only of relevance to
</I>&gt;<i> real-world applications.
</I>&gt;<i> 
</I>&gt;<i> Greetings
</I>&gt;<i> Andreas
</I>&gt;<i> 
</I>&gt;<i> -----Urspr&#252;ngliche Nachricht-----
</I>&gt;<i> Von: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
</I>&gt;<i> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] Im Auftrag von Adrian
</I>&gt;<i> Willenb&#252;cher
</I>&gt;<i> Gesendet: Montag, 15. M&#228;rz 2010 23:33
</I>&gt;<i> An: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Betreff: [Mono-dev] Issues with System.Random
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I noticed that the implementation of System.Random has a couple of flaws:
</I>&gt;<i> 1.) The algorithm for the random data fails miserably in some of the Diehard
</I>&gt;<i> tests (<A HREF="http://i.cs.hku.hk/~diehard/">http://i.cs.hku.hk/~diehard/</A>), even 
</I>&gt;<i> if it is slightly changed in order to generate full 32-bit random values.
</I>&gt;<i> 2.) It might return a negative value:
</I>&gt;<i> &quot;if (retVal &lt; 0) retVal += MBIG;&quot;
</I>&gt;<i> results in -1 for retVal == int.MinValue, which is forbidden.
</I>&gt;<i> 3.) The use of floating-point arithmetic introduces numerical errors since
</I>&gt;<i> int.MaxValue is not a power of two (so 
</I>&gt;<i> 1.0/int.MaxValue is not representable without errors).
</I>&gt;<i> 
</I>&gt;<i> I reimplemented the class using the xorshift algorithm by George Marsaglia,
</I>&gt;<i> which he posted on comp.lang.c 
</I>&gt;<i> (<A HREF="http://groups.google.com/group/comp.lang.c/browse_thread/thread/a9915080a44">http://groups.google.com/group/comp.lang.c/browse_thread/thread/a9915080a44</A>
</I>&gt;<i> 24068/), and tested it with the Diehard 
</I>&gt;<i> battery of tests (it passed); it avoids any FP arithmetic where it is not
</I>&gt;<i> needed.
</I>&gt;<i> 
</I>&gt;<i> The interface of the class is still pretty screwed up, but sadly we can't
</I>&gt;<i> change that.
</I>&gt;<i> 
</I>&gt;<i> I also completely rewrote the unit tests; they are stricter and more precise
</I>&gt;<i> now. The expected values were produced by 
</I>&gt;<i> running the C-code given by George Marsaglia.
</I>&gt;<i> 
</I>&gt;<i> The patches for the two files can be found below.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Adrian
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Index: mcs/class/corlib/System/Random.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/class/corlib/System/Random.cs	(revision 153607)
</I>&gt;<i> +++ mcs/class/corlib/System/Random.cs	(working copy)
</I>&gt;<i> @@ -4,12 +4,11 @@
</I>&gt;<i>   // Authors:
</I>&gt;<i>   //   Bob Smith (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bob at thestuff.net</A>)
</I>&gt;<i>   //   Ben Maurer (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at users.sourceforge.net</A>)
</I>&gt;<i> +//   Adrian Willenb&#252;cher (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">AWillenbuecher at gmx.de</A>)
</I>&gt;<i>   //
</I>&gt;<i>   // (C) 2001 Bob Smith.  <A HREF="http://www.thestuff.net">http://www.thestuff.net</A>
</I>&gt;<i>   // (C) 2003 Ben Maurer
</I>&gt;<i>   //
</I>&gt;<i> -
</I>&gt;<i> -//
</I>&gt;<i>   // Copyright (C) 2004 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
</I>&gt;<i>   //
</I>&gt;<i>   // Permission is hereby granted, free of charge, to any person obtaining
</I>&gt;<i> @@ -39,104 +38,98 @@
</I>&gt;<i>   	[ComVisible (true)]
</I>&gt;<i>   	public class Random
</I>&gt;<i>   	{
</I>&gt;<i> -		const int MBIG = int.MaxValue;
</I>&gt;<i> -		const int MSEED = 161803398;
</I>&gt;<i> +		private uint [] state = new uint [5];
</I>&gt;<i> 
</I>&gt;<i> -		int inext, inextp;
</I>&gt;<i> -		int [] SeedArray = new int [56];
</I>&gt;<i> -
</I>&gt;<i> -		public Random ()
</I>&gt;<i> -			: this (Environment.TickCount)
</I>&gt;<i> +		public Random () : this(Environment.TickCount)
</I>&gt;<i>   		{
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		public Random (int Seed)
</I>&gt;<i>   		{
</I>&gt;<i> -			int ii;
</I>&gt;<i> -			int mj, mk;
</I>&gt;<i> -
</I>&gt;<i> -			// Numerical Recipes in C online @
</I>&gt;<i> <A HREF="http://www.library.cornell.edu/nr/bookcpdf/c7-1.pdf">http://www.library.cornell.edu/nr/bookcpdf/c7-1.pdf</A>
</I>&gt;<i> -			mj = MSEED - Math.Abs (Seed);
</I>&gt;<i> -			SeedArray [55] = mj;
</I>&gt;<i> -			mk = 1;
</I>&gt;<i> -			for (int i = 1; i &lt; 55; i++) {  //  [1, 55] is
</I>&gt;<i> special (Knuth)
</I>&gt;<i> -				ii = (21 * i) % 55;
</I>&gt;<i> -				SeedArray [ii] = mk;
</I>&gt;<i> -				mk = mj - mk;
</I>&gt;<i> -				if (mk &lt; 0)
</I>&gt;<i> -					mk += MBIG;
</I>&gt;<i> -				mj = SeedArray [ii];
</I>&gt;<i> -			}
</I>&gt;<i> -			for (int k = 1; k &lt; 5; k++) {
</I>&gt;<i> -				for (int i = 1; i &lt; 56; i++) {
</I>&gt;<i> -					SeedArray [i] -= SeedArray [1 + (i +
</I>&gt;<i> 30) % 55];
</I>&gt;<i> -					if (SeedArray [i] &lt; 0)
</I>&gt;<i> -						SeedArray [i] += MBIG;
</I>&gt;<i> -				}
</I>&gt;<i> -			}
</I>&gt;<i> -			inext = 0;
</I>&gt;<i> -			inextp = 31;
</I>&gt;<i> +			state [0] = 123456789 ^ (uint)Seed;
</I>&gt;<i> +			state [1] = 362436069;
</I>&gt;<i> +			state [2] = 521288629;
</I>&gt;<i> +			state [3] = 88675123;
</I>&gt;<i> +			state [4] = 886756453;
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i> -		protected virtual double Sample ()
</I>&gt;<i> +		/* Uses the xorshift algorithm by George Marsaglia on:
</I>&gt;<i> +		 *
</I>&gt;<i> <A HREF="http://groups.google.com/group/comp.lang.c/browse_thread/thread/a9915080a442">http://groups.google.com/group/comp.lang.c/browse_thread/thread/a9915080a442</A>
</I>&gt;<i> 4068/
</I>&gt;<i> +		 */
</I>&gt;<i> +		private uint NextUInt32 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			int retVal;
</I>&gt;<i> +			var temp = state [0] ^ (state [0] &gt;&gt; 7);
</I>&gt;<i> +			temp = temp ^ (temp &lt;&lt; 13);
</I>&gt;<i> 
</I>&gt;<i> -			if (++inext  &gt;= 56) inext  = 1;
</I>&gt;<i> -			if (++inextp &gt;= 56) inextp = 1;
</I>&gt;<i> +			for (var i = 0; i &lt; 4; ++i)
</I>&gt;<i> +				state [i] = state [i + 1];
</I>&gt;<i> +
</I>&gt;<i> +			state [4] = (state [4] ^ (state [4] &lt;&lt; 6)) ^ temp;
</I>&gt;<i> +
</I>&gt;<i> +			return (2 * state [1] + 1) * state [4];
</I>&gt;<i> +		}
</I>&gt;<i> 
</I>&gt;<i> -			retVal = SeedArray [inext] - SeedArray [inextp];
</I>&gt;<i> +		private uint NextUInt32 (uint maxValue)
</I>&gt;<i> +		{
</I>&gt;<i> +			if (maxValue == 0)
</I>&gt;<i> +				return 0;
</I>&gt;<i> 
</I>&gt;<i> -			if (retVal &lt; 0)
</I>&gt;<i> -				retVal += MBIG;
</I>&gt;<i> +			// Mask for all bits beneath and including most
</I>&gt;<i> significant bit
</I>&gt;<i> +			var mask = maxValue;
</I>&gt;<i> +			mask = mask | (mask &gt;&gt; 1);
</I>&gt;<i> +			mask = mask | (mask &gt;&gt; 2);
</I>&gt;<i> +			mask = mask | (mask &gt;&gt; 4);
</I>&gt;<i> +			mask = mask | (mask &gt;&gt; 8);
</I>&gt;<i> +			mask = mask | (mask &gt;&gt; 16);
</I>&gt;<i> +
</I>&gt;<i> +			uint x;
</I>&gt;<i> +			do {
</I>&gt;<i> +				x = NextUInt32 () &amp; mask;
</I>&gt;<i> +			} while (x &gt;= maxValue);
</I>&gt;<i> +
</I>&gt;<i> +			return x;
</I>&gt;<i> +		}
</I>&gt;<i> 
</I>&gt;<i> -			SeedArray [inext] = retVal;
</I>&gt;<i> +		protected virtual double Sample ()
</I>&gt;<i> +		{
</I>&gt;<i> +			return NextUInt32 () * (1.0 / 4294967296.0);
</I>&gt;<i> +		}
</I>&gt;<i> 
</I>&gt;<i> -			return retVal * (1.0 / MBIG);
</I>&gt;<i> +		public virtual double NextDouble ()
</I>&gt;<i> +		{
</I>&gt;<i> +			return Sample ();
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		public virtual int Next ()
</I>&gt;<i>   		{
</I>&gt;<i> -			return (int)(Sample () * int.MaxValue);
</I>&gt;<i> +			const uint cutoff = 2147483648u;
</I>&gt;<i> +			var x = NextUInt32 ();
</I>&gt;<i> +			return x &gt;= cutoff ? (int)(x - cutoff) : (int)x;
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		public virtual int Next (int maxValue)
</I>&gt;<i>   		{
</I>&gt;<i>   			if (maxValue &lt; 0)
</I>&gt;<i> -				throw new
</I>&gt;<i> ArgumentOutOfRangeException(Locale.GetText (
</I>&gt;<i> -					&quot;Max value is less than min
</I>&gt;<i> value.&quot;));
</I>&gt;<i> +				throw new ArgumentOutOfRangeException
</I>&gt;<i> (&quot;maxValue is less than minValue.&quot;);
</I>&gt;<i> 
</I>&gt;<i> -			return (int)(Sample () * maxValue);
</I>&gt;<i> +			return (int)NextUInt32 ((uint)maxValue);
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		public virtual int Next (int minValue, int maxValue)
</I>&gt;<i>   		{
</I>&gt;<i>   			if (minValue &gt; maxValue)
</I>&gt;<i> -				throw new ArgumentOutOfRangeException
</I>&gt;<i> (Locale.GetText (
</I>&gt;<i> -					&quot;Min value is greater than max
</I>&gt;<i> value.&quot;));
</I>&gt;<i> +				throw new ArgumentOutOfRangeException
</I>&gt;<i> (&quot;minValue is greater than maxValue.&quot;);
</I>&gt;<i> 
</I>&gt;<i> -			// special case: a difference of one (or less) will
</I>&gt;<i> always return the minimum
</I>&gt;<i> -			// e.g. -1,-1 or -1,0 will always return -1
</I>&gt;<i> -			uint diff = (uint) (maxValue - minValue);
</I>&gt;<i> -			if (diff &lt;= 1)
</I>&gt;<i> -				return minValue;
</I>&gt;<i> -
</I>&gt;<i> -			return (int)((uint)(Sample () * diff) + minValue);
</I>&gt;<i> +			return (int)NextUInt32 ((uint)(maxValue - minValue))
</I>&gt;<i> + minValue;
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		public virtual void NextBytes (byte [] buffer)
</I>&gt;<i>   		{
</I>&gt;<i>   			if (buffer == null)
</I>&gt;<i> -				throw new ArgumentNullException (&quot;buffer&quot;);
</I>&gt;<i> +				throw new ArgumentNullException (&quot;buffer is
</I>&gt;<i> null.&quot;);
</I>&gt;<i> 
</I>&gt;<i> -			for (int i = 0; i &lt; buffer.Length; i++) {
</I>&gt;<i> -				buffer [i] = (byte)(Sample () *
</I>&gt;<i> (byte.MaxValue + 1));
</I>&gt;<i> -			}
</I>&gt;<i> +			for (var i = 0; i &lt; buffer.Length; ++i)
</I>&gt;<i> +				buffer [i] = (byte)NextUInt32 ();
</I>&gt;<i>   		}
</I>&gt;<i> -
</I>&gt;<i> -		public virtual double NextDouble ()
</I>&gt;<i> -		{
</I>&gt;<i> -			return this.Sample ();
</I>&gt;<i> -		}
</I>&gt;<i>   	}
</I>&gt;<i>   }
</I>&gt;<i> 
</I>&gt;<i> Index: mcs/class/corlib/Test/System/RandomTest.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/class/corlib/Test/System/RandomTest.cs	(revision 153607)
</I>&gt;<i> +++ mcs/class/corlib/Test/System/RandomTest.cs	(working copy)
</I>&gt;<i> @@ -2,8 +2,7 @@
</I>&gt;<i>   // System.Random Test Cases
</I>&gt;<i>   //
</I>&gt;<i>   // Authors:
</I>&gt;<i> -//	Bob Smith &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bob at thestuff.net</A>&gt;
</I>&gt;<i> -//	Sebastien Pouliot  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien at ximian.com</A>&gt;
</I>&gt;<i> +//  Adrian Willenb&#252;cher &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">AWillenbuecher at gmx.de</A>&gt;
</I>&gt;<i>   //
</I>&gt;<i>   // Copyright (C) 2004 Novell, Inc (<A HREF="http://www.novell.com">http://www.novell.com</A>)
</I>&gt;<i>   //
</I>&gt;<i> @@ -28,104 +27,159 @@
</I>&gt;<i>   //
</I>&gt;<i> 
</I>&gt;<i>   using NUnit.Framework;
</I>&gt;<i> +using NUnit.Framework.SyntaxHelpers;
</I>&gt;<i>   using System;
</I>&gt;<i> 
</I>&gt;<i>   namespace MonoTests.System {
</I>&gt;<i> 
</I>&gt;<i>   	[TestFixture]
</I>&gt;<i>   	public class RandomTest  {
</I>&gt;<i> +#region Next ()
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void SeededSequence1 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			int [] expected = { 256171686, 924759460,
</I>&gt;<i> 1326063082, 1748505655, 770391478, 893875434, 1927233845,
</I>&gt;<i> +				1915141213, 1304416967, 1040106214,
</I>&gt;<i> 1413028753, 517287625, 164449503, 484347407, 134543290, 1497001777,
</I>&gt;<i> +				1437568641, 1805630818, 442001507, 276608167
</I>&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> -#if false
</I>&gt;<i> -		//
</I>&gt;<i> -		// This test will fail, given enough runs.
</I>&gt;<i> -		//
</I>&gt;<i> -		// It is an ad-hoc test for distribution, and does not work
</I>&gt;<i> -		// 100% of the time.
</I>&gt;<i> -		//
</I>&gt;<i> +			var rng = new Random (-1234);
</I>&gt;<i> +
</I>&gt;<i> +			foreach (var x in expected)
</I>&gt;<i> +				Assert.That (x, Is.EqualTo (rng.Next ()),
</I>&gt;<i> &quot;#A01&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void NextDouble ()
</I>&gt;<i> +		public void SeededSequence2 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			Random r = new Random ();
</I>&gt;<i> -			int i;
</I>&gt;<i> -			double c=0;
</I>&gt;<i> -			for (i=0; i&lt;20; i++)
</I>&gt;<i> -				c += r.NextDouble ();
</I>&gt;<i> -			c/=i;
</I>&gt;<i> -			Assert.IsTrue (c.ToString () + &quot; is out of range.&quot;,
</I>&gt;<i> c &lt; .7 &amp;&amp; c &gt; .3);
</I>&gt;<i> +			int [] expected = { 545630734, 1871987772, 32100770,
</I>&gt;<i> 2055383023, 588683182, 770534463, 129782961, 1446710564,
</I>&gt;<i> +				1212431109, 342542925, 1688944563,
</I>&gt;<i> 631123534, 1233995261, 1977968768, 1785858814, 375605933, 1274134403,
</I>&gt;<i> +				2089187981, 919781722, 1124065708 };
</I>&gt;<i> +
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +
</I>&gt;<i> +			foreach (var x in expected)
</I>&gt;<i> +				Assert.That (x, Is.EqualTo (rng.Next ()),
</I>&gt;<i> &quot;#A02&quot;);
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i> -#endif
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void SeededSequence3 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			int [] expected = { 428190222, 177488956,
</I>&gt;<i> 1323946402, 2139269103, 1846974382, 2037083199, 817648817,
</I>&gt;<i> +				341642532, 1854421765, 726977101,
</I>&gt;<i> 2110569395, 1682606670, 414270973, 582707328, 2058012414, 664397541,
</I>&gt;<i> +				735971203, 1192835725, 373417658, 1356677716
</I>&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> +			var rng = new Random (int.MaxValue);
</I>&gt;<i> +
</I>&gt;<i> +			foreach (var e in expected)
</I>&gt;<i> +				Assert.That (rng.Next (), Is.EqualTo (e),
</I>&gt;<i> &quot;#A03&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +#endregion
</I>&gt;<i> +
</I>&gt;<i> +#region Next (int)
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void CompareStreamWithSameSeed ()
</I>&gt;<i> +		public void NextMax1 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			Random r = new Random (42);
</I>&gt;<i> -			Random r2 = new Random (42);
</I>&gt;<i> -			double c=0, c2=0;
</I>&gt;<i> -			for (int i=0; i&lt;20; i++) {
</I>&gt;<i> -				c += r.NextDouble ();
</I>&gt;<i> -				c2 += r2.NextDouble ();
</I>&gt;<i> -			}
</I>&gt;<i> -			Assert.AreEqual (c, c2, &quot;Compare&quot;);
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			Assert.That (rng.Next (0), Is.EqualTo (0), &quot;#B01&quot;);
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void Next ()
</I>&gt;<i> +		public void NextMax2 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			Random r = new Random ();
</I>&gt;<i> -			for (int i=0; i&lt;20; i++) {
</I>&gt;<i> -				long c = r.Next ();
</I>&gt;<i> -				Assert.IsTrue (c &lt; Int32.MaxValue &amp;&amp; c &gt;= 0,
</I>&gt;<i> &quot;Next(&quot; + i + &quot;)&quot;);
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			int [] maxValues = { 1, 2, 3, 8, 9, 10, 11, 12, 13,
</I>&gt;<i> 14, 15, 16 };
</I>&gt;<i> +			foreach (var maxValue in maxValues) {
</I>&gt;<i> +				for (var i = 0; i &lt; 100; ++i) {
</I>&gt;<i> +					var x = rng.Next (maxValue);
</I>&gt;<i> +					Assert.That (x,
</I>&gt;<i> Is.GreaterThanOrEqualTo (0), &quot;#B02a&quot;);
</I>&gt;<i> +					Assert.That (x, Is.LessThan
</I>&gt;<i> (maxValue), &quot;#B02b&quot;);
</I>&gt;<i> +				}
</I>&gt;<i>   			}
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void NextMax()
</I>&gt;<i> +		[ExpectedException (&quot;System.ArgumentOutOfRangeException&quot;,
</I>&gt;<i> UserMessage=&quot;#B03&quot;)]
</I>&gt;<i> +		public void NextMax3 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			Random r = new Random();
</I>&gt;<i> -			for (int i=0; i&lt;20; i++) {
</I>&gt;<i> -				long c = r.Next (10);
</I>&gt;<i> -				Assert.IsTrue (c &lt; 10 &amp;&amp; c &gt;= 0, &quot;NextMax(&quot;
</I>&gt;<i> + i + &quot;)&quot;);
</I>&gt;<i> -			}
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			rng.Next (-1);
</I>&gt;<i>   		}
</I>&gt;<i> +#endregion
</I>&gt;<i> 
</I>&gt;<i> +#region Next (int, int)
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void NextMinMax()
</I>&gt;<i> +		public void NextMinMax1 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			Random r = new Random ();
</I>&gt;<i> -			Assert.AreEqual (42, r.Next (42, 42), &quot;#1 Failed
</I>&gt;<i> where min == max&quot;);
</I>&gt;<i> -			Assert.AreEqual (Int32.MaxValue, r.Next
</I>&gt;<i> (Int32.MaxValue, Int32.MaxValue), &quot;#2 Failed where min == max&quot;);
</I>&gt;<i> -			Assert.AreEqual (Int32.MinValue, r.Next
</I>&gt;<i> (Int32.MinValue, Int32.MinValue), &quot;#3 Failed where min == max&quot;);
</I>&gt;<i> -			Assert.AreEqual (0, r.Next (0, 0), &quot;#4 Failed where
</I>&gt;<i> min == max&quot;);
</I>&gt;<i> -			for (int i = 1; i &lt;= Int32.MaxValue / 2; i *= 2) {
</I>&gt;<i> -				long c = r.Next (i, i * 2);
</I>&gt;<i> -				Assert.IsTrue (c &lt; i * 2, &quot;At i=&quot; + i + &quot; c
</I>&gt;<i> &lt; i*2 failed&quot;);
</I>&gt;<i> -				Assert.IsTrue (c &gt;= i, &quot;At i=&quot; + i + &quot; c &gt;=
</I>&gt;<i> i failed&quot;);
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			Assert.That (rng.Next (-50, -50), Is.EqualTo (-50),
</I>&gt;<i> &quot;#C01&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void NextMinMax2 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			int [] minValues = { -4, -3, -2, 0, 4, 5, 6, 7, 8,
</I>&gt;<i> 0, int.MinValue, int.MinValue };
</I>&gt;<i> +			int [] maxValues = { -3, 0, 10, 1, 5, 7, 7, 15, 16,
</I>&gt;<i> int.MaxValue, 0, int.MaxValue };
</I>&gt;<i> +			for (var i = 0; i &lt; minValues.Length; ++i) {
</I>&gt;<i> +				var minValue = minValues [i];
</I>&gt;<i> +				var maxValue = maxValues [i];
</I>&gt;<i> +				for (var j = 0; j &lt; 100; ++j) {
</I>&gt;<i> +					var x = rng.Next (minValue,
</I>&gt;<i> maxValue);
</I>&gt;<i> +					Assert.That (x,
</I>&gt;<i> Is.GreaterThanOrEqualTo (minValue), &quot;#C02a&quot;);
</I>&gt;<i> +					Assert.That (x, Is.LessThan
</I>&gt;<i> (maxValue), &quot;#C02b&quot;);
</I>&gt;<i> +				}
</I>&gt;<i>   			}
</I>&gt;<i> -			for (int i = -1; i &gt;= Int32.MinValue / 2; i *= 2) {
</I>&gt;<i> -				long c = r.Next (i * 2, i);
</I>&gt;<i> -				Assert.IsTrue (c &lt; i, &quot;At i=&quot; + i + &quot; c &lt;
</I>&gt;<i> i*2 failed&quot;);
</I>&gt;<i> -				Assert.IsTrue (c &gt;= i * 2, &quot;At i=&quot; + i + &quot; c
</I>&gt;&gt;<i> = i failed&quot;);
</I>&gt;<i> -			}
</I>&gt;<i>   		}
</I>&gt;<i> 
</I>&gt;<i> -/* Mono implementation is now compatible with Knuth (not MS) implementation
</I>&gt;<i> (choice of constants)
</I>&gt;<i>   		[Test]
</I>&gt;<i> -		public void CompareWithMS ()
</I>&gt;<i> +		[ExpectedException(&quot;System.ArgumentOutOfRangeException&quot;,
</I>&gt;<i> UserMessage = &quot;#C03&quot;)]
</I>&gt;<i> +		public void NextMinMax3 ()
</I>&gt;<i>   		{
</I>&gt;<i> -			string[] r = new string [4];
</I>&gt;<i> -			byte[] buffer = new byte [8];
</I>&gt;<i> -			int x = 4;
</I>&gt;<i> -			while (x-- &gt; 0) {
</I>&gt;<i> -				int seed = (x &lt;&lt; x);
</I>&gt;<i> -				Random random = new Random (seed);
</I>&gt;<i> -				random.NextBytes (buffer);
</I>&gt;<i> -				r [x] = BitConverter.ToString (buffer);
</I>&gt;<i> -			}
</I>&gt;<i> -			Assert.AreEqual (&quot;43-DB-8B-AE-0A-88-A8-7B&quot;, r [3],
</I>&gt;<i> &quot;Seed(24)&quot;);
</I>&gt;<i> -			Assert.AreEqual (&quot;E7-2A-5C-44-D1-8C-7D-74&quot;, r [2],
</I>&gt;<i> &quot;Seed(8)&quot;);
</I>&gt;<i> -			Assert.AreEqual (&quot;C5-67-2A-FC-1B-4E-CD-72&quot;, r [1],
</I>&gt;<i> &quot;Seed(2)&quot;);
</I>&gt;<i> -			Assert.AreEqual (&quot;B9-D1-C4-8E-34-8F-E7-71&quot;, r [0],
</I>&gt;<i> &quot;Seed(0)&quot;);
</I>&gt;<i> -		}*/
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			rng.Next (11, 10);
</I>&gt;<i> +		}
</I>&gt;<i> +#endregion
</I>&gt;<i> +
</I>&gt;<i> +#region NextBytes (byte [])
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void NextBytes1 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			var rng = new Random (-1);
</I>&gt;<i> +
</I>&gt;<i> +			byte [] expected = { 14, 60, 162, 239, 174, 63, 177,
</I>&gt;<i> 36, 5, 77, 179, 78, 253, 128, 254, 157, 131, 141, 26 };
</I>&gt;<i> +			byte [] values = new byte [expected.Length];
</I>&gt;<i> +
</I>&gt;<i> +			rng.NextBytes (values);
</I>&gt;<i> +			Assert.That (values, Is.EqualTo (expected), &quot;#D01&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		[ExpectedException(&quot;System.ArgumentNullException&quot;,
</I>&gt;<i> UserMessage = &quot;#D02&quot;)]
</I>&gt;<i> +		public void NextBytes2 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			var rng = new Random (-1);
</I>&gt;<i> +			rng.NextBytes (null);
</I>&gt;<i> +		}
</I>&gt;<i> +#endregion
</I>&gt;<i> +
</I>&gt;<i> +#region NextDouble ()
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void NextDouble1 ()
</I>&gt;<i> +		{
</I>&gt;<i> +			double [] expected = {
</I>&gt;<i> 0.62703955499455332756042480468750, 0.43585611786693334579467773437500,
</I>&gt;<i> +				0.00747404294088482856750488281250,
</I>&gt;<i> 0.97855615220032632350921630859375,
</I>&gt;<i> +				0.13706348417326807975769042968750,
</I>&gt;<i> 0.17940403497777879238128662109375,
</I>&gt;<i> +				0.03021745034493505954742431640625,
</I>&gt;<i> 0.33683855179697275161743164062500,
</I>&gt;<i> +				0.78229111549444496631622314453125,
</I>&gt;<i> 0.57975448970682919025421142578125,
</I>&gt;<i> +				0.39323804969899356365203857421875,
</I>&gt;<i> 0.64694489864632487297058105468750,
</I>&gt;<i> +				0.28731191088445484638214111328125,
</I>&gt;<i> 0.96053174138069152832031250000000,
</I>&gt;<i> +				0.41580265713855624198913574218750,
</I>&gt;<i> 0.58745257114060223102569580078125,
</I>&gt;<i> +				0.29665753315202891826629638671875,
</I>&gt;<i> 0.98642698233015835285186767578125,
</I>&gt;<i> +				0.71415337035432457923889160156250,
</I>&gt;<i> 0.76171694230288267135620117187500 };
</I>&gt;<i> +			var rng = new Random (0);
</I>&gt;<i> +			foreach (var e in expected)
</I>&gt;<i> +				Assert.That(rng.NextDouble(),
</I>&gt;<i> Is.EqualTo(e).Within(1e-28));
</I>&gt;<i> +		}
</I>&gt;<i> +#endregion
</I>&gt;<i>   	}
</I>&gt;<i>   }
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I></PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034357.html">[Mono-dev] Issues with System.Random
</A></li>
	<LI>Next message: <A HREF="034367.html">[Mono-dev] Issues with System.Random
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34359">[ date ]</a>
              <a href="thread.html#34359">[ thread ]</a>
              <a href="subject.html#34359">[ subject ]</a>
              <a href="author.html#34359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
