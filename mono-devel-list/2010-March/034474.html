<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Two%20patches%20to%20make%20SGen%20work%20on%20Darwin/x86&In-Reply-To=f54ff3e81003231959m3c05b310g8f8d8fdfcf8b63cf%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034468.html">
   <LINK REL="Next"  HREF="034485.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Two%20patches%20to%20make%20SGen%20work%20on%20Darwin/x86&In-Reply-To=f54ff3e81003231959m3c05b310g8f8d8fdfcf8b63cf%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86">lupus at ximian.com
       </A><BR>
    <I>Wed Mar 24 06:37:24 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034468.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
        <LI>Next message: <A HREF="034485.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34474">[ date ]</a>
              <a href="thread.html#34474">[ thread ]</a>
              <a href="subject.html#34474">[ subject ]</a>
              <a href="author.html#34474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/24/10 Mark Probst wrote:
&gt;<i> The first patch make mono-ehash SGen-aware, the second implements
</I>&gt;<i> CEE_MONO_TLS on Darwin/x86.
</I>
&gt;<i> --- a/mono/utils/mono-ehash.c
</I>&gt;<i> +++ b/mono/utils/mono-ehash.c
</I>[...]
&gt;<i> +#ifdef HAVE_SGEN_GC
</I>&gt;<i> +	if (type &lt; 0 || type &gt; MONO_HASH_KEY_VALUE_GC)
</I>&gt;<i> +		g_error (&quot;wrong type for gc hashtable&quot;);
</I>&gt;<i> +	/*
</I>&gt;<i> +	 * We use a user defined marking function to avoid having to register a GC root for
</I>&gt;<i> +	 * each hash node.
</I>&gt;<i> +	 */
</I>&gt;<i> +	if (!hash_descr)
</I>&gt;<i> +		hash_descr = mono_gc_make_root_descr_user (mono_g_hash_mark);
</I>&gt;<i> +	if (type != MONO_HASH_CONSERVATIVE_GC)
</I>&gt;<i> +		mono_gc_register_root_wbarrier ((char*)hash, sizeof (MonoGHashTable), hash_descr);
</I>&gt;<i> +#endif
</I>
Uhm, when Zoltan changed the code in mono-hash.c to use this
mono_g_hash_mark root descriptor I had the gut feeling it wasn't
correct. Seeing the change again helped me focus on the bug this
introduces.

Look at do_rehash in mono-ehash.c (mono-hash.c has a similar issue)
and imagine what happens when a GC occours just after these two lines:
	table = hash-&gt;table;
	hash-&gt;table = mg_new0 (Slot *, hash-&gt;table_size);

All the entries are reachable from table, but the GC can only see
from hash-&gt;table, which contains no hash table entries. This means the
objects me be deallocated or moved but their pointer in the hash won't
be updated, leading to crashes.

One solution is to introduce a function similar to
GC_call_with_alloc_lock() in the Boehm GC, so that the unsafe table
manipulation can be done without risk of interruption from the GC.
Another one is to expose the critical region enter/exit code from
sgen-gc.c. In both cases we must take care that no GC allocation can be
done inside the protected regions (the GC lock is not recursive and it
must stay that way).

The TLS change looks fine to me.
Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034468.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
	<LI>Next message: <A HREF="034485.html">[Mono-dev] [PATCH] Two patches to make SGen work on Darwin/x86
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34474">[ date ]</a>
              <a href="thread.html#34474">[ thread ]</a>
              <a href="subject.html#34474">[ subject ]</a>
              <a href="author.html#34474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
