<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH 06/12] Handle lack of SA_SIGINFO
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%2006/12%5D%20Handle%20lack%20of%20SA_SIGINFO&In-Reply-To=1269610205-1087-7-git-send-email-andreas.faerber%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034506.html">
   <LINK REL="Next"  HREF="034505.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH 06/12] Handle lack of SA_SIGINFO</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%2006/12%5D%20Handle%20lack%20of%20SA_SIGINFO&In-Reply-To=1269610205-1087-7-git-send-email-andreas.faerber%40web.de"
       TITLE="[Mono-dev] [PATCH 06/12] Handle lack of SA_SIGINFO">miguel at novell.com
       </A><BR>
    <I>Fri Mar 26 12:15:11 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034506.html">[Mono-dev] [PATCH 06/12] Handle lack of SA_SIGINFO
</A></li>
        <LI>Next message: <A HREF="034505.html">[Mono-dev] [RFC 07/12] io-layer: Define makedev for Haiku
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34524">[ date ]</a>
              <a href="thread.html#34524">[ thread ]</a>
              <a href="subject.html#34524">[ subject ]</a>
              <a href="author.html#34524">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

     In general, if we have code that belongs in a function, it should
be in a function, not hidden as a macro.

     I was going to raise this issue recently with some
MONO_TLS_FOO_BAR that was committed, but figured &quot;This is not likely
going to happen every day&quot;.    But since it seems like it is happening
every day, we need to move away from this.   Uppercase defines should
be constants, and only with a few exceptions be bits of code.

Miguel

On Fri, Mar 26, 2010 at 9:29 AM, Andreas F&#228;rber &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt; wrote:
&gt;<i> SA_SIGINFO-style signals are part of the optional POSIX XSI (formerly
</I>&gt;<i> Real Time Signals, RTS) feature. Haiku does not implement it (yet) and
</I>&gt;<i> goes so far as to not define SA_SIGINFO to indicate lack thereof.
</I>&gt;<i>
</I>&gt;<i> In mini, there's MONO_ARCH_USE_SIGACTION for this but it doesn't cover
</I>&gt;<i> all uses of SA_SIGINFO; deal with the theoretical case of SA_SIGINFO being
</I>&gt;<i> defined but MONO_ARCH_USE_SIGACTION undefined.
</I>&gt;<i>
</I>&gt;<i> Fix typo in comment.
</I>&gt;<i>
</I>&gt;<i> v2 -&gt; v3:
</I>&gt;<i> * Rework signature macros to match mini.
</I>&gt;<i>
</I>&gt;<i> v1 -&gt; v2:
</I>&gt;<i> * Introduce helper macros, suggested by Paolo Molaro.
</I>&gt;<i>
</I>&gt;<i> This commit is licensed under the MIT X11 license.
</I>&gt;<i> ---
</I>&gt;<i> &#160;mono/metadata/ChangeLog &#160; &#160; &#160;| &#160; &#160;6 ++++++
</I>&gt;<i> &#160;mono/metadata/console-unix.c | &#160; 36 ++++++++++++++++++++++++++----------
</I>&gt;<i> &#160;mono/mini/ChangeLog &#160; &#160; &#160; &#160; &#160;| &#160; &#160;6 ++++++
</I>&gt;<i> &#160;mono/mini/mini-posix.c &#160; &#160; &#160; | &#160; 15 +++++++++++++--
</I>&gt;<i> &#160;4 files changed, 51 insertions(+), 12 deletions(-)
</I>&gt;<i>
</I>&gt;<i> diff --git a/mono/metadata/ChangeLog b/mono/metadata/ChangeLog
</I>&gt;<i> index 243cc51..4c8dd51 100644
</I>&gt;<i> --- a/mono/metadata/ChangeLog
</I>&gt;<i> +++ b/mono/metadata/ChangeLog
</I>&gt;<i> @@ -1,3 +1,9 @@
</I>&gt;<i> +2010-03-26 &#160;Andreas F&#228;rber &#160;&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> + &#160; &#160; &#160; * console-unix.c (sigcont_handler, sigwinch_handler): Don't assume
</I>&gt;<i> + &#160; &#160; &#160; SA_SIGINFO-style signals, fix the build on platforms without (Haiku).
</I>&gt;<i> +
</I>&gt;<i> + &#160; &#160; &#160; Code is contributed under MIT/X11 license.
</I>&gt;<i>
</I>&gt;<i> &#160;Fri Mar 26 11:33:17 CET 2010 Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i> diff --git a/mono/metadata/console-unix.c b/mono/metadata/console-unix.c
</I>&gt;<i> index 99e0754..7280b6f 100644
</I>&gt;<i> --- a/mono/metadata/console-unix.c
</I>&gt;<i> +++ b/mono/metadata/console-unix.c
</I>&gt;<i> @@ -262,10 +262,32 @@ sigint_handler (int signo)
</I>&gt;<i> &#160; &#160; &#160; &#160;in_sigint = FALSE;
</I>&gt;<i> &#160;}
</I>&gt;<i>
</I>&gt;<i> +#define SIGHANDLER_VALID(sigh) \
</I>&gt;<i> + &#160; &#160; &#160; ((sigh) != NULL &amp;&amp; \
</I>&gt;<i> + &#160; &#160; &#160; &#160;(sigh) != (void *)SIG_DFL &amp;&amp; \
</I>&gt;<i> + &#160; &#160; &#160; &#160;(sigh) != (void *)SIG_IGN)
</I>&gt;<i> +
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> +#define SIG_HANDLER_SIGNATURE(ftn) ftn (int signo, void *the_siginfo, void *data)
</I>&gt;<i> +#define INVOKE_SIGHANDLER_IF_VALID(siga) G_STMT_START \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; if ((siga).sa_flags &amp; SA_SIGINFO) { \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if (SIGHANDLER_VALID((siga).sa_sigaction)) \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (*(siga).sa_sigaction) (signo, the_siginfo, data); \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; } else if (SIGHANDLER_VALID((siga).sa_handler)) \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (*(siga).sa_handler) (signo); \
</I>&gt;<i> + &#160; &#160; &#160; G_STMT_END
</I>&gt;<i> +#else
</I>&gt;<i> +#define SIG_HANDLER_SIGNATURE(ftn) ftn (int signo)
</I>&gt;<i> +#define INVOKE_SIGHANDLER_IF_VALID(siga) G_STMT_START \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; if (SIGHANDLER_VALID((siga).sa_handler)) \
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; (*(siga).sa_handler) (signo); \
</I>&gt;<i> + &#160; &#160; &#160; G_STMT_END
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> &#160;static struct sigaction save_sigcont, save_sigint, save_sigwinch;
</I>&gt;<i>
</I>&gt;<i> &#160;static void
</I>&gt;<i> -sigcont_handler (int signo, void *the_siginfo, void *data)
</I>&gt;<i> +SIG_HANDLER_SIGNATURE (sigcont_handler)
</I>&gt;<i> &#160;{
</I>&gt;<i> &#160; &#160; &#160; &#160;// Ignore error, there is not much we can do in the sigcont handler.
</I>&gt;<i> &#160; &#160; &#160; &#160;tcsetattr (STDIN_FILENO, TCSANOW, &amp;mono_attr);
</I>&gt;<i> @@ -274,24 +296,18 @@ sigcont_handler (int signo, void *the_siginfo, void *data)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;write (STDOUT_FILENO, keypad_xmit_str, strlen (keypad_xmit_str));
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;// Call previous handler
</I>&gt;<i> - &#160; &#160; &#160; if (save_sigcont.sa_sigaction != NULL &amp;&amp;
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; save_sigcont.sa_sigaction != (void *)SIG_DFL &amp;&amp;
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; save_sigcont.sa_sigaction != (void *)SIG_IGN)
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; &#160; &#160; (*save_sigcont.sa_sigaction) (signo, the_siginfo, data);
</I>&gt;<i> + &#160; &#160; &#160; INVOKE_SIGHANDLER_IF_VALID (save_sigcont);
</I>&gt;<i> &#160;}
</I>&gt;<i>
</I>&gt;<i> &#160;static void
</I>&gt;<i> -sigwinch_handler (int signo, void *the_siginfo, void *data)
</I>&gt;<i> +SIG_HANDLER_SIGNATURE (sigwinch_handler)
</I>&gt;<i> &#160;{
</I>&gt;<i> &#160; &#160; &#160; &#160;int dims = terminal_get_dimensions ();
</I>&gt;<i> &#160; &#160; &#160; &#160;if (dims != -1)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;cols_and_lines = dims;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;// Call previous handler
</I>&gt;<i> - &#160; &#160; &#160; if (save_sigwinch.sa_sigaction != NULL &amp;&amp;
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; save_sigwinch.sa_sigaction != (void *)SIG_DFL &amp;&amp;
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; save_sigwinch.sa_sigaction != (void *)SIG_IGN)
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; &#160; &#160; (*save_sigwinch.sa_sigaction) (signo, the_siginfo, data);
</I>&gt;<i> + &#160; &#160; &#160; INVOKE_SIGHANDLER_IF_VALID (save_sigwinch);
</I>&gt;<i> &#160;}
</I>&gt;<i>
</I>&gt;<i> &#160;void
</I>&gt;<i> diff --git a/mono/mini/ChangeLog b/mono/mini/ChangeLog
</I>&gt;<i> index 6bea591..fe45481 100755
</I>&gt;<i> --- a/mono/mini/ChangeLog
</I>&gt;<i> +++ b/mono/mini/ChangeLog
</I>&gt;<i> @@ -1,5 +1,11 @@
</I>&gt;<i> &#160;2010-03-26 &#160;Andreas Faerber &#160;&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt;
</I>&gt;<i>
</I>&gt;<i> + &#160; &#160; &#160; * mini-posix.c: Fix the build on platforms without SA_SIGINFO (Haiku).
</I>&gt;<i> +
</I>&gt;<i> + &#160; &#160; &#160; Code is contributed under MIT/X11 license.
</I>&gt;<i> +
</I>&gt;<i> +2010-03-26 &#160;Andreas Faerber &#160;&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> &#160; &#160; &#160; &#160;* mini-x86.c (mono_arch_is_single_step_event,
</I>&gt;<i> &#160; &#160; &#160; &#160;mono_arch_is_breakpoint_event): New define HAVE_SIG_INFO,
</I>&gt;<i> &#160; &#160; &#160; &#160;restrict it to MONO_ARCH_USE_SIGACTION to fix build on Haiku.
</I>&gt;<i> diff --git a/mono/mini/mini-posix.c b/mono/mini/mini-posix.c
</I>&gt;<i> index 823d93b..f53a850 100644
</I>&gt;<i> --- a/mono/mini/mini-posix.c
</I>&gt;<i> +++ b/mono/mini/mini-posix.c
</I>&gt;<i> @@ -82,13 +82,17 @@ save_old_signal_handler (int signo, struct sigaction *old_action)
</I>&gt;<i> &#160; &#160; &#160; &#160;mono_trace (G_LOG_LEVEL_DEBUG, MONO_TRACE_CONFIG,
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&quot;Saving old signal handler for signal %d.&quot;, signo);
</I>&gt;<i>
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> &#160; &#160; &#160; &#160;if (! (old_action-&gt;sa_flags &amp; SA_SIGINFO)) {
</I>&gt;<i> +#endif
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;handler_to_save-&gt;sa_handler = old_action-&gt;sa_handler;
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> &#160; &#160; &#160; &#160;} else {
</I>&gt;<i> &#160;#ifdef MONO_ARCH_USE_SIGACTION
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;handler_to_save-&gt;sa_sigaction = old_action-&gt;sa_sigaction;
</I>&gt;<i> &#160;#endif /* MONO_ARCH_USE_SIGACTION */
</I>&gt;<i> &#160; &#160; &#160; &#160;}
</I>&gt;<i> +#endif
</I>&gt;<i> &#160; &#160; &#160; &#160;handler_to_save-&gt;sa_mask = old_action-&gt;sa_mask;
</I>&gt;<i> &#160; &#160; &#160; &#160;handler_to_save-&gt;sa_flags = old_action-&gt;sa_flags;
</I>&gt;<i>
</I>&gt;<i> @@ -129,13 +133,17 @@ SIG_HANDLER_SIGNATURE (mono_chain_signal)
</I>&gt;<i> &#160; &#160; &#160; &#160;GET_CONTEXT;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;if (saved_handler) {
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if (!(saved_handler-&gt;sa_flags &amp; SA_SIGINFO)) {
</I>&gt;<i> +#endif
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;saved_handler-&gt;sa_handler (signal);
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;} else {
</I>&gt;<i> &#160;#ifdef MONO_ARCH_USE_SIGACTION
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;saved_handler-&gt;sa_sigaction (signal, info, ctx);
</I>&gt;<i> &#160;#endif /* MONO_ARCH_USE_SIGACTION */
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}
</I>&gt;<i> +#endif
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;return TRUE;
</I>&gt;<i> &#160; &#160; &#160; &#160;}
</I>&gt;<i> &#160; &#160; &#160; &#160;return FALSE;
</I>&gt;<i> @@ -381,9 +389,12 @@ add_signal_handler (int signo, gpointer handler)
</I>&gt;<i> &#160; &#160; &#160; &#160;g_assert (sigaction (signo, &amp;sa, &amp;previous_sa) != -1);
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;/* if there was already a handler in place for this signal, store it */
</I>&gt;<i> - &#160; &#160; &#160; if (! (previous_sa.sa_flags &amp; SA_SIGINFO) &amp;&amp;
</I>&gt;<i> + &#160; &#160; &#160; if (
</I>&gt;<i> +#ifdef SA_SIGINFO
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; ! (previous_sa.sa_flags &amp; SA_SIGINFO) &amp;&amp;
</I>&gt;<i> +#endif
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;(SIG_DFL == previous_sa.sa_handler)) {
</I>&gt;<i> - &#160; &#160; &#160; &#160; &#160; &#160; &#160; /* it there is no sa_sigaction function and the sa_handler is default, we can safely ignore this */
</I>&gt;<i> + &#160; &#160; &#160; &#160; &#160; &#160; &#160; /* if there is no sa_sigaction function and the sa_handler is default, we can safely ignore this */
</I>&gt;<i> &#160; &#160; &#160; &#160;} else {
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;if (mono_do_signal_chaining)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;save_old_signal_handler (signo, &amp;previous_sa);
</I>&gt;<i> --
</I>&gt;<i> 1.6.5.3
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034506.html">[Mono-dev] [PATCH 06/12] Handle lack of SA_SIGINFO
</A></li>
	<LI>Next message: <A HREF="034505.html">[Mono-dev] [RFC 07/12] io-layer: Define makedev for Haiku
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34524">[ date ]</a>
              <a href="thread.html#34524">[ thread ]</a>
              <a href="subject.html#34524">[ subject ]</a>
              <a href="author.html#34524">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
