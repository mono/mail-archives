<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono generates inefficient vectorized code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20generates%20inefficient%20vectorized%20code&In-Reply-To=19e4cfaf1003111522n6f0476b1ybc471f12266e5ea7%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034677.html">
   <LINK REL="Next"  HREF="034324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono generates inefficient vectorized code</H1>
    <B>Sergei Dyshel</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20generates%20inefficient%20vectorized%20code&In-Reply-To=19e4cfaf1003111522n6f0476b1ybc471f12266e5ea7%40mail.gmail.com"
       TITLE="[Mono-dev] Mono generates inefficient vectorized code">qyron.private at gmail.com
       </A><BR>
    <I>Thu Mar 11 18:30:04 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034677.html">[Mono-dev] Windows Identity Foundation
</A></li>
        <LI>Next message: <A HREF="034324.html">[Mono-dev] Mono generates inefficient vectorized code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34323">[ date ]</a>
              <a href="thread.html#34323">[ thread ]</a>
              <a href="subject.html#34323">[ subject ]</a>
              <a href="author.html#34323">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
I'm doing some research on vectorization using Mono. I've noticed that
code generated by Mono's JIT contains many unnecessary memory loads
and stores. Here is simple example, the full code is attached:

public static unsafe int sum(int* a, int size) {
&#160;Vector4i temp = new Vector4i();
&#160;Vector4i* p = (Vector4i*) a;
&#160;for (int i = 0; i &lt; size/4; i++) {
&#160; &#160;temp += *p;
&#160; &#160;p += 1;
&#160;}
&#160;return temp.X + temp.Y + temp.Z + temp.W;
}

Here we have simple 'sum' function which sums up a given array of
integers by splitting it into 4-int vectors. Temporary 'temp' is used
as accumulator in the loop and finally the sum of it's components is
returned. Trivially, inside the loop 'temp' should be stored in vector
registered and &quot;leave&quot; it only in the end of the function. Now, let's
concentrate on loop's iteration. Here is result of CIL-&gt;IR translation
(obtained with -v), I'm showing only the relevant part:

AFTER METHOD-TO-IR 3: [IN: &#160;BB0(0), OUT: &#160;BB2(0) ]
&#160;xzero R11 &lt;- &#160; &#160; &#160; &#160; &#160; &#160; &#160;&lt;============ initialize 'temp' with null value
&#160;iconst R12 &lt;- [0]
&#160;iconst R13 &lt;- [0]

AFTER METHOD-TO-IR 2: [IN: &#160;BB3(0), OUT: &#160;BB4(0) ]
&#160;xzero R11 &lt;- &#160; &#160; &#160; &#160; &#160; &lt;============= unnecessary but no critical
(we're outside of the loop)
&#160;move R14 &lt;- R9
&#160;move R12 &lt;- R14
&#160;iconst R13 &lt;- [0]
&#160;br [B4]

AFTER METHOD-TO-IR 5: [IN: &#160;BB4(0), OUT: &#160;BB4(0) ]
&#160;xmove R16 &lt;- R11 &lt;============= unnecessary, R16 isn't used anymore,
should be removed in future passes
&#160;move R17 &lt;- R12
&#160;loadx_membase R18 &lt;- [R17 + 0x0] &lt;========== loading of the next quadruple
&#160;paddd R19 &lt;- R11 R18 clobbers: 1 &lt;============ summation
&#160;xmove R11 &lt;- R19 &lt;============= R11 still holds 'temp'
&#160;move R20 &lt;- R12
&#160;nop
&#160;int_add_imm R22 &lt;- R20 [16] clobbers: 1
&#160;move R12 &lt;- R22
&#160;move R23 &lt;- R13
&#160;nop
&#160;int_add_imm R25 &lt;- R23 [1] clobbers: 1
&#160;move R13 &lt;- R25

AFTER METHOD-TO-IR 4: [IN: &#160;BB2(0) BB5(0), OUT: &#160;BB5(0) BB6(0) ]
&#160;move R26 &lt;- R13
&#160;move R27 &lt;- R10
&#160;nop
&#160;int_div_imm R29 &lt;- R27 clobbers: d
&#160;icompare R26 R29
&#160;int_blt [B5B6]

Here we see some unnecessary instructions but obviously they should be
removed in subsequent passes (to be safe we are JITting with -O=all).
Now, the final part - the assembly and a big dissappointment:

&lt;BB&gt;:5
&#160;28: &#160; 0f 10 0e &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;movups (%esi),%xmm1
&lt;====== OK, loading next quadruple
&#160;2b: &#160; 0f 10 45 d8 &#160; &#160; &#160; &#160; &#160; &#160; movups 0xffffffd8(%ebp),%xmm0 &#160;&lt;======
superfluous load
&#160;2f: &#160; 66 0f fe c1 &#160; &#160; &#160; &#160; &#160; &#160; paddd &#160;%xmm1,%xmm0
&#160;33: &#160; 0f 11 45 d8 &#160; &#160; &#160; &#160; &#160; &#160; movups %xmm0,0xffffffd8(%ebp) &#160;&lt;======
superfluous store
&#160;37: &#160; 8d 46 10 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;lea &#160; &#160;0x10(%esi),%eax
&#160;3a: &#160; 43 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;inc &#160; &#160;%ebx
&#160;3b: &#160; 8b f0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; mov &#160; &#160;%eax,%esi
&lt;BB&gt;:4
&#160;3d: &#160; 8b c7 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; mov &#160; &#160;%edi,%eax
&#160;3f: &#160; c1 f8 1f &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;sar &#160; &#160;$0x1f,%eax
&#160;42: &#160; c1 e8 1e &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;shr &#160; &#160;$0x1e,%eax
&#160;45: &#160; 03 c7 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; add &#160; &#160;%edi,%eax
&#160;47: &#160; c1 f8 02 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;sar &#160; &#160;$0x2,%eax
&#160;4a: &#160; 3b d8 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cmp &#160; &#160;%eax,%ebx
&#160;4c: &#160; 7c da &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; jl &#160; &#160; 28 &lt;Test_sum+0x28&gt; &lt;======= end of loop
BB&gt;:6
&#160;4e: &#160; 8b 45 d8 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;mov &#160; &#160;0xffffffd8(%ebp),%eax
&#160;51: &#160; 8b 4d dc &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;mov &#160; &#160;0xffffffdc(%ebp),%ecx
&#160;54: &#160; 03 c1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; add &#160; &#160;%ecx,%eax
&#160;56: &#160; 8b 4d e0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;mov &#160; &#160;0xffffffe0(%ebp),%ecx
&#160;59: &#160; 03 c1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; add &#160; &#160;%ecx,%eax
&#160;5b: &#160; 8b 4d e4 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;mov &#160; &#160;0xffffffe4(%ebp),%ecx
&#160;5e: &#160; 03 c1 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; add &#160; &#160;%ecx,%eax

Here we got 'temp' saved and restored in each iteration. This is very
inefficient and generally should be avoided. Can someone of Mono JIT
gurus explain this behavior? Any help will be greatly appreciated!

I'm attaching all the intermediate results of &#160;compilation. Anyway,
you can recreate them using:
mcs -unsafe -reference:Mono.Simd.dll cs-sum.cs
mono -O=all -v -v -v cs-sum.exe

--
Regards,
Sergei Dyshel
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cs-sum.cil
Type: application/octet-stream
Size: 6905 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0003.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0003.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cs-sum.cs
Type: application/octet-stream
Size: 599 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0004.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0004.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cs-sum
Type: application/octet-stream
Size: 4096 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0005.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0005.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cs-sum.zip
Type: application/zip
Size: 5068 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0001.zip">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100312/34e4b0c8/attachment-0001.zip</A> 
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034677.html">[Mono-dev] Windows Identity Foundation
</A></li>
	<LI>Next message: <A HREF="034324.html">[Mono-dev] Mono generates inefficient vectorized code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34323">[ date ]</a>
              <a href="thread.html#34323">[ thread ]</a>
              <a href="subject.html#34323">[ subject ]</a>
              <a href="author.html#34323">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
