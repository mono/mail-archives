<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20mixed-mode%20assembly%20support%20on%20Windows%0A%09%28now%20build%20with%20cygwin%20as%20well%29&In-Reply-To=002a01c8a70b%2405540390%243c43ee55%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027668.html">
   <LINK REL="Next"  HREF="027687.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20mixed-mode%20assembly%20support%20on%20Windows%0A%09%28now%20build%20with%20cygwin%20as%20well%29&In-Reply-To=002a01c8a70b%2405540390%243c43ee55%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)">vargaz at gmail.com
       </A><BR>
    <I>Mon Apr 28 03:34:15 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027668.html">[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)
</A></li>
        <LI>Next message: <A HREF="027687.html">[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27686">[ date ]</a>
              <a href="thread.html#27686">[ thread ]</a>
              <a href="subject.html#27686">[ subject ]</a>
              <a href="author.html#27686">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>         Hi,

&gt;<i> &gt; - image.c: mono_cli_rva_image_map is part of our public api, so its
</I>&gt;<i> signature
</I>&gt;<i> &gt;  cannot be changed, you can rename it to mono_cli_rva_image_map_internal,
</I>&gt;<i> and
</I>&gt;<i> &gt;  change the signature of that.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>  I had a look at &quot;C:\Program Files\Mono\include&quot; and it doesn't contain any
</I>&gt;<i> declaration. Is this public for sure? If it is I'll do what you suggested.
</I>&gt;<i>
</I>
I was wrong, this isn't a public header file after all.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - The usage of 'raw_data' is a bit confusing: sometimes it is used as an
</I>&gt;<i> address
</I>&gt;<i> &gt;  (like in mono_cli_rva_image_map), sometimes it is used as a handle
</I>&gt;<i> (everywhere
</I>&gt;<i> &gt;  else). Which is correct ?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>  HMODULE is the actual pointer to the base address (position of the DOS
</I>&gt;<i> header) of the module. Also note that there is no such thing as HINSTANCE it
</I>&gt;<i> is a heritage of the Win16 shared address space and HMODULE and HINSTANCE
</I>&gt;<i> are the same in Win32. In Win32s (Win32 API on Win16 that is not really
</I>&gt;<i> Win32 compatible) HMODULE is definitely not the base address but someting
</I>&gt;<i> else that may be a handle. So raw_data is actually the raw_data but unlike
</I>&gt;<i> the current implementation sections are mapped to the actual virtual
</I>&gt;<i> addresses. Even checks in map functions could be omitted but I didn't remove
</I>&gt;<i> them to ensure that the image is correct.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - cil-coff.h: Please don't declare constants in the middle of a a
</I>&gt;<i> &gt;  structure definition.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>  OK. I actually tried to follow what seemed to me being the coding
</I>&gt;<i> convention of that file.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; - gc.c: The comment about mono_thread_attach () might be incorrect, but
</I>&gt;<i> the
</I>&gt;<i> &gt;  thread_started_event stuff is definitely needed to avoid races when
</I>&gt;<i> &gt;  the runtime is
</I>&gt;<i> &gt;  shut down before the finalizer thread can start. So I don't think we
</I>&gt;<i> &gt;  can remove this.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>  As I see there can be no race because there only are &quot;mono_thread_current
</I>&gt;<i> () == gc_thread&quot; checks. Even if &quot;mono_thread_current ()&quot; returns NULL (that
</I>&gt;<i> is unlikely I think) nothing will happen on the thread if the finalizer
</I>&gt;<i> thread in not initialized yet. Actual work is only done by
</I>&gt;<i> &quot;finalizer_thread&quot; that is being executed only in the finalizer thread. If
</I>&gt;<i> for some reason &quot;mono_gc_cleanup ()&quot; is called before the finalizer thread
</I>&gt;<i> is initialized &quot;WaitForSingleObjectEx&quot; will wait for two seconds for the
</I>&gt;<i> finalizers and thus for the finalizer thread being initialized. If it fails
</I>&gt;<i> to initialize within two seconds finalizers won't run of course but the same
</I>&gt;<i> is true for finalizers that werent processed in two seconds so I see no big
</I>&gt;<i> difference. If really need &quot;WaitForSingleObjectEx (thread_started_event,
</I>&gt;<i> INFINITE, FALSE);&quot; can be moved just before &quot;WaitForSingleObjectEx
</I>&gt;<i> (shutdown_event, 2000, FALSE)&quot; but I don't see any reason to do so. If I'm
</I>&gt;<i> wrong please let me know.
</I>&gt;<i>
</I>
I'm still not sure about this, so if this is really needed on win32,
then lets try keeping
the original code, but putting the Wait inside an #ifndef PLATFORM_WIN32 +
adding a comment about why it is inside the #ifndef.

Other than that, I think the patch is ok to check in. One thing that
is missing is
tests. Since the patch changes so many places in the runtime, if there are no
automated tests, the functionality will probably get broken by changes
since people
have no way of noticing when they broke it.

                       Zoltan

&gt;<i>  Korn&#233;l
</I>&gt;<i>
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027668.html">[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)
</A></li>
	<LI>Next message: <A HREF="027687.html">[Mono-dev] [PATCH] Add mixed-mode assembly support on Windows	(now build with cygwin as well)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27686">[ date ]</a>
              <a href="thread.html#27686">[ thread ]</a>
              <a href="subject.html#27686">[ subject ]</a>
              <a href="author.html#27686">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
