<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Embedding Mono + SWIG string return values leads to bad	free
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Embedding%20Mono%20%2B%20SWIG%20string%20return%20values%20leads%20to%20bad%0A%09free&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027602.html">
   <LINK REL="Next"  HREF="027620.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Embedding Mono + SWIG string return values leads to bad	free</H1>
    <B>Ewen Cheslack-Postava</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Embedding%20Mono%20%2B%20SWIG%20string%20return%20values%20leads%20to%20bad%0A%09free&In-Reply-To="
       TITLE="[Mono-dev] Embedding Mono + SWIG string return values leads to bad	free">ewencp at cs.stanford.edu
       </A><BR>
    <I>Mon Apr 21 17:36:02 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027602.html">[Mono-dev] Searching the GAC w/ the embedded API
</A></li>
        <LI>Next message: <A HREF="027620.html">[Mono-dev] Embedding Mono + SWIG string return values leads to	bad free
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27604">[ date ]</a>
              <a href="thread.html#27604">[ thread ]</a>
              <a href="subject.html#27604">[ subject ]</a>
              <a href="author.html#27604">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm embedding Mono and using SWIG to wrap a few simple C++ objects.
They use PInvoke to wrap these objects and for string/char* return
values they use a C# delegate in order to obtain a string owned by the
GC so it can safely be returned.  They use a simple C# static method
where the string is passed in and immediately returned to do this.  I
assume the magic that's happening there is that the marshalling for
the inputs causes a copy of the string to be created and that same one
is returned.

This seems to work well on Linux and Mac OS X, but on Windows it
causes an exception when the GC tries to free that same memory.  I've
verified that I do in fact get a new copy of the string out at a
different address from the original.  It looks like maybe the string
is just being double freed.  The specific error I get (only in the
Visual Studio debugger) is:

HEAP[x.exe]: Invalid Address specified to RtlFreeHeap( 01E00000, 00166C78 )

and that address is in fact the address of the new string that was
allocated.  I ran under valgrind in linux and it didn't complain about
any double deletes, which is why I assume this is working ok there.

Any ideas on how to resolve this?  I've even tried changing the method
they use to create yet a new copy of the string (and careful not to
just use clone which just returns this) and its still causing the
problem.  I know another option is the method described in the mono
pinvoke docs to return an intptr and then convert in c#, but I was
hoping to avoid major modifications to swig.

Thanks,
Ewen
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027602.html">[Mono-dev] Searching the GAC w/ the embedded API
</A></li>
	<LI>Next message: <A HREF="027620.html">[Mono-dev] Embedding Mono + SWIG string return values leads to	bad free
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27604">[ date ]</a>
              <a href="thread.html#27604">[ thread ]</a>
              <a href="subject.html#27604">[ subject ]</a>
              <a href="author.html#27604">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
