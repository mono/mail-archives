<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Use Unicode argv on Windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Use%20Unicode%20argv%20on%20Windows&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="027337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Use Unicode argv on Windows</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Use%20Unicode%20argv%20on%20Windows&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Use Unicode argv on Windows">kornelpal at gmail.com
       </A><BR>
    <I>Tue Apr  1 04:31:27 EDT 2008</I>
    <P><UL>
        
        <LI>Next message: <A HREF="027337.html">[Mono-dev] Unit tests for WCF
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27334">[ date ]</a>
              <a href="thread.html#27334">[ thread ]</a>
              <a href="subject.html#27334">[ subject ]</a>
              <a href="author.html#27334">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

The main problem is that Windows and Linux too two different ways on 
implementing Unicode support.

Windows has two set of APIs. Unicode (UTF-16, originally before Windows 2000 
it was UCS-2) and ANSI (using system default code page that only can 
represent a subset of Unicode and is usually different from the OEM (DOS) 
code page).

Linux on the other hand tends to use UTF-8 instead of old code pages but has 
less restrictions on code page being used.

If you use char* on Linux you will get full Unicode support using UTF-8 and 
if you are aware that other encodings may be used as well (like the case for 
Mono) you may try to convert them to UTF-8 like mono_utf8_from_external 
does.

The problem is that Windows (NT kernel) uses UTF-16 internally and ANSI APIs 
are only wrappers around Unicode APIs. If you use ANSI APIs you won't get 
the original data as char* but you will get the Unicode data converted to 
the system default ANSI code page. This means a lot of Unicode character 
will probably be lost. And because Mono later converts this back to UTF-16 I 
see no reason to lose characters in encoding round-trip.

Ideally Mono should use UTF-16 on Windows but that would need a lot of code 
changes. Using UTF-8 no character loss will occur. UTF-8 - UTF-16 round-trip 
causes a little performance overhead but I think Mono's main target is 
Linux.

glib takes UTF-8 on Windows and passes it as UTF-16 to Windows API that 
makes Mono Unicode-aware on Windows as well.

Note however that libc (CRT) functions like fopen use ANSI code page on 
Windows so Mono should not use then and should prefer glib.

Also note that the on Linux the main assembly is loaded using the char* 
specified in argv without any conversions but aguments of icalls are 
converted to UTF-8 and they load assembles using UTF-8. Among with some 
other encoding inconsistencies this causes encoding conversion bugs in Mono 
on both Linux and Windows.

I think using using UTF-8 for char* would be the solution. Input data (argv) 
should be converted to UTF-8 and output data (file names) should be 
converted to MONO_EXTERNAL_ENCODINGS on Linux and UTF-16 on Windows.

Korn&#233;l

----- Original Message ----- 
From: &quot;Robert Jordan&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Tuesday, April 01, 2008 12:55 AM
Subject: Re: [Mono-dev] [PATCH] Use Unicode argv on Windows


Hi Korn&#233;l,

I understand why you fixed it this way, but I think that &quot;fixing&quot;
strenc.c would produce less #ifdef clutter and it also has the
nice side effect of not breaking the embedding API :)

It's just a matter of setting MONO_EXTERNAL_ENCODINGS=default_locale
either with g_setenv or SetEnvironmentVariable in mini.c:mini_init()
for PLATFORM_WIN32.

Robert

Korn&#233;l P&#225;l wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Currently mono.exe uses ANSI arguments that are encoded using system
</I>&gt;<i> default code page (ACP). Mono however uses UTF-8 and tries to convert
</I>&gt;<i> them using MONO_EXTERNAL_ENCODINGS.
</I>&gt;<i>
</I>&gt;<i> This patch takes the Unicode (UTF-16) command line arguments and
</I>&gt;<i> converts them to UTF-8. This way there is no need to modify other code
</I>&gt;<i> to use UTF-16 and the arguments still are in Unicode.
</I>&gt;<i>
</I>&gt;<i> I also made strenc.c non-Windows in this patch because
</I>&gt;<i> MONO_EXTERNAL_ENCODINGS should not be used on Windows at all as it uses
</I>&gt;<i> UTF-16 internally and if we really need UTF-8 then we should convert
</I>&gt;<i> from UTF-16 rather than from ACP.
</I>&gt;<i>
</I>&gt;<i> I would prefer to move argument conversion using mono_utf8_from_external
</I>&gt;<i> to main.c as well that would make code more clean but that would require
</I>&gt;<i> mono_runtime_run_main being called with UTF-8 arguments. If that is
</I>&gt;<i> acceptable I'll include that modification in the patch as well.
</I>&gt;<i>
</I>&gt;<i> Korn&#233;l Index: mono/mono/metadata/object.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/metadata/object.c    (revision 99452)
</I>&gt;<i> +++ mono/mono/metadata/object.c    (working copy)
</I>&gt;<i> @@ -2671,6 +2671,9 @@
</I>&gt;<i>                             basename,
</I>&gt;<i>                             NULL);
</I>&gt;<i>
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +        utf8_fullpath = fullpath;
</I>&gt;<i> +#else
</I>&gt;<i>         utf8_fullpath = mono_utf8_from_external (fullpath);
</I>&gt;<i>         if(utf8_fullpath == NULL) {
</I>&gt;<i>             /* Printing the arg text will cause glib to
</I>&gt;<i> @@ -2684,19 +2687,27 @@
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         g_free (fullpath);
</I>&gt;<i> +#endif
</I>&gt;<i>         g_free (basename);
</I>&gt;<i>     } else {
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +        utf8_fullpath = g_strdup (argv [0]);
</I>&gt;<i> +#else
</I>&gt;<i>         utf8_fullpath = mono_utf8_from_external (argv[0]);
</I>&gt;<i>         if(utf8_fullpath == NULL) {
</I>&gt;<i>             g_print (&quot;\nCannot determine the text encoding for the
</I>&gt;<i> assembly location: %s\n&quot;, argv[0]);
</I>&gt;<i>             g_print (&quot;Please add the correct encoding to
</I>&gt;<i> MONO_EXTERNAL_ENCODINGS and try again.\n&quot;);
</I>&gt;<i>             exit (-1);
</I>&gt;<i>         }
</I>&gt;<i> +#endif
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     main_args [0] = utf8_fullpath;
</I>&gt;<i>
</I>&gt;<i>     for (i = 1; i &lt; argc; ++i) {
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +        main_args [i] = g_strdup (argv [i]);
</I>&gt;<i> +#else
</I>&gt;<i>         gchar *utf8_arg;
</I>&gt;<i>
</I>&gt;<i>         utf8_arg=mono_utf8_from_external (argv[i]);
</I>&gt;<i> @@ -2708,20 +2719,27 @@
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         main_args [i] = utf8_arg;
</I>&gt;<i> +#endif
</I>&gt;<i>     }
</I>&gt;<i>     argc--;
</I>&gt;<i>     argv++;
</I>&gt;<i>     if (mono_method_signature (method)-&gt;param_count) {
</I>&gt;<i>         args = (MonoArray*)mono_array_new (domain,
</I>&gt;<i> mono_defaults.string_class, argc);
</I>&gt;<i>         for (i = 0; i &lt; argc; ++i) {
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +            gchar *str = argv [i];
</I>&gt;<i> +#else
</I>&gt;<i>             /* The encodings should all work, given that
</I>&gt;<i>              * we've checked all these args for the
</I>&gt;<i>              * main_args array.
</I>&gt;<i>              */
</I>&gt;<i>             gchar *str = mono_utf8_from_external (argv [i]);
</I>&gt;<i> +#endif
</I>&gt;<i>             MonoString *arg = mono_string_new (domain, str);
</I>&gt;<i>             mono_array_setref (args, i, arg);
</I>&gt;<i> +#ifndef PLATFORM_WIN32
</I>&gt;<i>             g_free (str);
</I>&gt;<i> +#endif
</I>&gt;<i>         }
</I>&gt;<i>     } else {
</I>&gt;<i>         args = (MonoArray*)mono_array_new (domain,
</I>&gt;<i> mono_defaults.string_class, 0);
</I>&gt;<i> Index: mono/mono/mini/main.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/mini/main.c    (revision 99452)
</I>&gt;<i> +++ mono/mono/mini/main.c    (working copy)
</I>&gt;<i> @@ -1,8 +1,30 @@
</I>&gt;<i> #include &quot;mini.h&quot;
</I>&gt;<i>
</I>&gt;<i> +#ifdef PLATFORM_WIN32
</I>&gt;<i> +
</I>&gt;<i> int
</I>&gt;<i> +main ()
</I>&gt;<i> +{
</I>&gt;<i> +    int argc;
</I>&gt;<i> +    wchar_t** wargv = CommandLineToArgvW (GetCommandLine (), &amp;argc);
</I>&gt;<i> +    char** argv = g_new0 (char*, argc);
</I>&gt;<i> +    int i;
</I>&gt;<i> +
</I>&gt;<i> +    for (i = 0; i &lt; argc; ++i)
</I>&gt;<i> +        argv [i] = g_utf16_to_utf8 (wargv [i], -1, NULL, NULL, NULL);
</I>&gt;<i> +
</I>&gt;<i> +    LocalFree (wargv);
</I>&gt;<i> +
</I>&gt;<i> +    return mono_main (argc, argv);
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +#else
</I>&gt;<i> +
</I>&gt;<i> +int
</I>&gt;<i> main (int argc, char* argv[])
</I>&gt;<i> {
</I>&gt;<i>     return mono_main (argc, argv);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> Index: mono/mono/utils/strenc.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/utils/strenc.c    (revision 99452)
</I>&gt;<i> +++ mono/mono/utils/strenc.c    (working copy)
</I>&gt;<i> @@ -7,6 +7,9 @@
</I>&gt;<i>  * (C) 2003 Ximian, Inc.
</I>&gt;<i>  */
</I>&gt;<i>
</I>&gt;<i> +/* These methods should not be used on Windows as it uses UTF-16
</I>&gt;<i> internally. */
</I>&gt;<i> +#ifndef PLATFORM_WIN32
</I>&gt;<i> +
</I>&gt;<i> #include &lt;config.h&gt;
</I>&gt;<i> #include &lt;glib.h&gt;
</I>&gt;<i> #include &lt;string.h&gt;
</I>&gt;<i> @@ -214,3 +217,5 @@
</I>&gt;<i>     return(utf8);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> Index: mono/msvc/mono.def
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/msvc/mono.def    (revision 99452)
</I>&gt;<i> +++ mono/msvc/mono.def    (working copy)
</I>&gt;<i> @@ -711,10 +711,7 @@
</I>&gt;<i> mono_type_stack_size
</I>&gt;<i> mono_type_to_unmanaged
</I>&gt;<i> mono_unhandled_exception
</I>&gt;<i> -mono_unicode_from_external
</I>&gt;<i> -mono_unicode_to_external
</I>&gt;<i> mono_upgrade_remote_class_wrapper
</I>&gt;<i> -mono_utf8_from_external
</I>&gt;<i> mono_valloc
</I>&gt;<i> mono_value_box
</I>&gt;<i> mono_value_copy
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A> 

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="027337.html">[Mono-dev] Unit tests for WCF
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27334">[ date ]</a>
              <a href="thread.html#27334">[ thread ]</a>
              <a href="subject.html#27334">[ subject ]</a>
              <a href="author.html#27334">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
