<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Re: Assembly Unloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Assembly%20Unloading&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012114.html">
   <LINK REL="Next"  HREF="012096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Re: Assembly Unloading</H1>
    <B>Jim Purbrick</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Assembly%20Unloading&In-Reply-To="
       TITLE="[Mono-devel-list] Re: Assembly Unloading">jimpurbrick at yahoo.co.uk
       </A><BR>
    <I>Wed May 25 12:47:45 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012114.html">[Mono-devel-list] Pb with Session.Abandon();
</A></li>
        <LI>Next message: <A HREF="012096.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12094">[ date ]</a>
              <a href="thread.html#12094">[ thread ]</a>
              <a href="subject.html#12094">[ subject ]</a>
              <a href="author.html#12094">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Now that Sebastien has helped make the security
</I>&gt;<i> situation clearer, I think unloading assemblies is
</I>&gt;<i> (hopefully) the last big issue I need to resolve.
</I>
I now have a bytecode translator implemented which can
save and restore running code to serializable heap
objects and can check method calls against a white
list of allowed methods, so now I'm looking at how to
unload assemblies and JIT output when a script stops
or is serialized to a new server.

Zoltan convinced me that messing with the runtime to
try to unload assemblies was a bad idea and looking at
the DynamicMethod mechanisms provided by LCG it seems
that only static methods can be dynamically created
and  collected. 

So, now I'm looking at Richards suggestion of just
serializing all the scripts to disk, destroying the
current domain, creating a new one and loading the
scripts in to the new domain.

What i'm currently trying is:

1) mono_jit_init(&quot;root domain&quot;);
2) domain = mono_domain_create();
3) Load assembly in to domain.
4) Run script.
5) Serialize running script to file.
6) mono_domain_free(domain, true);
7) domain = mono_domain_create();
8) Deserialize script from file.

Looping this process I can run, save, load and run.
However, when I come to save the script for the second
time the application crashes with the call stack
below. If I remove the domain creation and destruction
steps the application will continue to loop, saving
and loading itself to and from file. 

Another concern is that when I list the assemblies
using AppDomain.CurrentDomain.GetAssemblies() The
current domain is always the root and always contains
my script assembly, even though I only load the script
assembly in to the secondary domain.

Does anyone know what I'm doing wrong here? Do
assemblies get loaded when I deserialize a script from
disk? If so how do I control which domain they get
loaded in to? Are there any examples for this stuff?
Should I be doing this from managed code? (I'd rather
not)

Cheers,

Jim.

Heres the call stack I get when I try to save for a
second time. I'm using Mono 1.1.7 on Debian and
Windows and get the same crash on both.

System.NullReferenceException: Object reference not
set to an instance of an object
in &lt;0x00030&gt; System.Type:Equals (System.Object o)
in &lt;0x0001e&gt; System.Collections.Hashtable:KeyEquals
(System.Object item, System.Object key)
in &lt;0x00144&gt; System.Collections.Hashtable:get_Item
(System.Object key)
in &lt;0x00535&gt;
System.Runtime.Serialization.Formatters.Binary.ObjectWriter:GetObjectData
(System.Object obj,
System.Runtime.Serialization.Formatters.Binary.TypeMetadata
metadata, System.Object data)
in &lt;0x0003f&gt;
System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObject
(System.IO.BinaryWriter writer, Int64 id,
System.Object obj)
in &lt;0x0014d&gt;
System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObjectInstance
(System.IO.BinaryWriter writer, System.Object obj,
Boolean isValueObject)
in &lt;0x00039&gt;
System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteQueuedObjects
(System.IO.BinaryWriter writer)
in &lt;0x00049&gt;
System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObjectGraph
(System.IO.BinaryWriter writer, System.Object obj,
System.Runtime.Remoting.Messaging.Header[] headers)
in &lt;0x002ce&gt;
System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Serialize
(System.IO.Stream serializationStream, System.Object
graph, System.Runtime.Remoting.Messaging.Header[]
headers)
in &lt;0x00015&gt;
System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Serialize
(System.IO.Stream serializationStream, System.Object
graph)
in &lt;0x000b5&gt; UThread.UThread:Save (System.String filename)


	
	
		
___________________________________________________________ 
Yahoo! Messenger - NEW crystal clear PC to PC calling worldwide with voicemail <A HREF="http://uk.messenger.yahoo.com">http://uk.messenger.yahoo.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012114.html">[Mono-devel-list] Pb with Session.Abandon();
</A></li>
	<LI>Next message: <A HREF="012096.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12094">[ date ]</a>
              <a href="thread.html#12094">[ thread ]</a>
              <a href="subject.html#12094">[ subject ]</a>
              <a href="author.html#12094">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
