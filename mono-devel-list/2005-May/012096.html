<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Re: Assembly Unloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Assembly%20Unloading&In-Reply-To=20050525164745.11160.qmail%40web25006.mail.ukl.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012094.html">
   <LINK REL="Next"  HREF="012105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Re: Assembly Unloading</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Assembly%20Unloading&In-Reply-To=20050525164745.11160.qmail%40web25006.mail.ukl.yahoo.com"
       TITLE="[Mono-devel-list] Re: Assembly Unloading">vargaz at gmail.com
       </A><BR>
    <I>Wed May 25 14:37:29 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012094.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
        <LI>Next message: <A HREF="012105.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12096">[ date ]</a>
              <a href="thread.html#12096">[ thread ]</a>
              <a href="subject.html#12096">[ subject ]</a>
              <a href="author.html#12096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                                        Hi,

  Appdomains should be unloaded using mono_domain_unload (), not
mono_domain_free (). The current domain of the current thread can be set
using mono_domain_set ().

                   Zoltan

On 5/25/05, Jim Purbrick &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jimpurbrick at yahoo.co.uk</A>&gt; wrote:
&gt;<i> &gt; Now that Sebastien has helped make the security
</I>&gt;<i> &gt; situation clearer, I think unloading assemblies is
</I>&gt;<i> &gt; (hopefully) the last big issue I need to resolve.
</I>&gt;<i> 
</I>&gt;<i> I now have a bytecode translator implemented which can
</I>&gt;<i> save and restore running code to serializable heap
</I>&gt;<i> objects and can check method calls against a white
</I>&gt;<i> list of allowed methods, so now I'm looking at how to
</I>&gt;<i> unload assemblies and JIT output when a script stops
</I>&gt;<i> or is serialized to a new server.
</I>&gt;<i> 
</I>&gt;<i> Zoltan convinced me that messing with the runtime to
</I>&gt;<i> try to unload assemblies was a bad idea and looking at
</I>&gt;<i> the DynamicMethod mechanisms provided by LCG it seems
</I>&gt;<i> that only static methods can be dynamically created
</I>&gt;<i> and  collected.
</I>&gt;<i> 
</I>&gt;<i> So, now I'm looking at Richards suggestion of just
</I>&gt;<i> serializing all the scripts to disk, destroying the
</I>&gt;<i> current domain, creating a new one and loading the
</I>&gt;<i> scripts in to the new domain.
</I>&gt;<i> 
</I>&gt;<i> What i'm currently trying is:
</I>&gt;<i> 
</I>&gt;<i> 1) mono_jit_init(&quot;root domain&quot;);
</I>&gt;<i> 2) domain = mono_domain_create();
</I>&gt;<i> 3) Load assembly in to domain.
</I>&gt;<i> 4) Run script.
</I>&gt;<i> 5) Serialize running script to file.
</I>&gt;<i> 6) mono_domain_free(domain, true);
</I>&gt;<i> 7) domain = mono_domain_create();
</I>&gt;<i> 8) Deserialize script from file.
</I>&gt;<i> 
</I>&gt;<i> Looping this process I can run, save, load and run.
</I>&gt;<i> However, when I come to save the script for the second
</I>&gt;<i> time the application crashes with the call stack
</I>&gt;<i> below. If I remove the domain creation and destruction
</I>&gt;<i> steps the application will continue to loop, saving
</I>&gt;<i> and loading itself to and from file.
</I>&gt;<i> 
</I>&gt;<i> Another concern is that when I list the assemblies
</I>&gt;<i> using AppDomain.CurrentDomain.GetAssemblies() The
</I>&gt;<i> current domain is always the root and always contains
</I>&gt;<i> my script assembly, even though I only load the script
</I>&gt;<i> assembly in to the secondary domain.
</I>&gt;<i> 
</I>&gt;<i> Does anyone know what I'm doing wrong here? Do
</I>&gt;<i> assemblies get loaded when I deserialize a script from
</I>&gt;<i> disk? If so how do I control which domain they get
</I>&gt;<i> loaded in to? Are there any examples for this stuff?
</I>&gt;<i> Should I be doing this from managed code? (I'd rather
</I>&gt;<i> not)
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Jim.
</I>&gt;<i> 
</I>&gt;<i> Heres the call stack I get when I try to save for a
</I>&gt;<i> second time. I'm using Mono 1.1.7 on Debian and
</I>&gt;<i> Windows and get the same crash on both.
</I>&gt;<i> 
</I>&gt;<i> System.NullReferenceException: Object reference not
</I>&gt;<i> set to an instance of an object
</I>&gt;<i> in &lt;0x00030&gt; System.Type:Equals (System.Object o)
</I>&gt;<i> in &lt;0x0001e&gt; System.Collections.Hashtable:KeyEquals
</I>&gt;<i> (System.Object item, System.Object key)
</I>&gt;<i> in &lt;0x00144&gt; System.Collections.Hashtable:get_Item
</I>&gt;<i> (System.Object key)
</I>&gt;<i> in &lt;0x00535&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.ObjectWriter:GetObjectData
</I>&gt;<i> (System.Object obj,
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.TypeMetadata
</I>&gt;<i> metadata, System.Object data)
</I>&gt;<i> in &lt;0x0003f&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObject
</I>&gt;<i> (System.IO.BinaryWriter writer, Int64 id,
</I>&gt;<i> System.Object obj)
</I>&gt;<i> in &lt;0x0014d&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObjectInstance
</I>&gt;<i> (System.IO.BinaryWriter writer, System.Object obj,
</I>&gt;<i> Boolean isValueObject)
</I>&gt;<i> in &lt;0x00039&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteQueuedObjects
</I>&gt;<i> (System.IO.BinaryWriter writer)
</I>&gt;<i> in &lt;0x00049&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.ObjectWriter:WriteObjectGraph
</I>&gt;<i> (System.IO.BinaryWriter writer, System.Object obj,
</I>&gt;<i> System.Runtime.Remoting.Messaging.Header[] headers)
</I>&gt;<i> in &lt;0x002ce&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Serialize
</I>&gt;<i> (System.IO.Stream serializationStream, System.Object
</I>&gt;<i> graph, System.Runtime.Remoting.Messaging.Header[]
</I>&gt;<i> headers)
</I>&gt;<i> in &lt;0x00015&gt;
</I>&gt;<i> System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Serialize
</I>&gt;<i> (System.IO.Stream serializationStream, System.Object
</I>&gt;<i> graph)
</I>&gt;<i> in &lt;0x000b5&gt; UThread.UThread:Save (System.String filename)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ___________________________________________________________
</I>&gt;<i> Yahoo! Messenger - NEW crystal clear PC to PC calling worldwide with voicemail <A HREF="http://uk.messenger.yahoo.com">http://uk.messenger.yahoo.com</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012094.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
	<LI>Next message: <A HREF="012105.html">[Mono-devel-list] Re: Assembly Unloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12096">[ date ]</a>
              <a href="thread.html#12096">[ thread ]</a>
              <a href="subject.html#12096">[ subject ]</a>
              <a href="author.html#12096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
