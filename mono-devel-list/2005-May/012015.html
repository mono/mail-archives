<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] merging two assemblies and related problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20merging%20two%20assemblies%20and%20related%20problems&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012013.html">
   <LINK REL="Next"  HREF="012016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] merging two assemblies and related problems</H1>
    <B>Vladimir Vukicevic</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20merging%20two%20assemblies%20and%20related%20problems&In-Reply-To="
       TITLE="[Mono-devel-list] merging two assemblies and related problems">vladimirv at gmail.com
       </A><BR>
    <I>Fri May 20 05:36:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012013.html">[Mono-devel-list] Weird runtime crash
</A></li>
        <LI>Next message: <A HREF="012016.html">[Mono-devel-list] merging two assemblies and related problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12015">[ date ]</a>
              <a href="thread.html#12015">[ thread ]</a>
              <a href="subject.html#12015">[ subject ]</a>
              <a href="author.html#12015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've brought up this problem in the past, but i'm again trying to find
a decent solution for this using mono.  The problem is pretty
straightforward:  I have two assemblies, A.dll and B.dll.  A.dll is
autogenerated using System.Reflection.Emit; B.dll is compiled from C#
source.  A.dll needs to access a custom attribute class that's defined
in B.dll.  So far, here are the approaches that I've tried, and the
problems I've encountered:

1) Use ILMerge (<A HREF="http://research.microsoft.com/~mbarnett/ilmerge.aspx">http://research.microsoft.com/~mbarnett/ilmerge.aspx</A>).
 Works great; binary only, Windows only.

2) Use PERWAPI (<A HREF="http://www.plas.fit.qut.edu.au/perwapi/Default.aspx">http://www.plas.fit.qut.edu.au/perwapi/Default.aspx</A>). 
It seems to work under .NET 1.1 on windows; under mono 1.1.7 I see
strange bugs (usually an infinite loop as it's trying to write an
assembly out on anything but the simplest assemblies).  It also balks
on some mono-generated assemblies, usually finding non-zero values
where it was expecting to just read zeros.

3) Use RAIL (<A HREF="http://rail.dei.uc.pt/">http://rail.dei.uc.pt/</A>).  A simple test of
RAssemblyDef.LoadAssembly(&quot;foo.dll&quot;).SaveAssembly(&quot;bar.dll&quot;) results
in:
** ERROR **: file reflection.c: line 835 (method_encode_clauses):
assertion failed: (ex_info-&gt;handlers)

4) Use monodis on both A.dll and B.dll, massage the output a bit, and
reassemble with ilasm -- basically remove the extern reference from
A.dll to B.dll, remove the foreign assembly reference from the custom
attribute usage in A.dll, and tack on most of B.dll's disassembly to
the end.  The problem here is that A.dll uses the &quot;calli&quot; instruction,
and monodis/ilasm can't round-trip the calli signatures... the output
has: &quot;IL_0008:  calli signature-0x11000001&quot;, signature-0x11000002, and
so on.  ildasm appropriately balks.

Is there a #5 that I'm missing that I haven't tried?  Out of the above
problems, fixing monodis/ilasm to round-trip signatures would probably
be the most straightforward, though that's the least elegant solution.
 Fixing the assertion failure with RAIL may or may not be difficult; I
haven't looked into what exactly is happening in much detail.  PERWAPI
might be making too many assumptions about the PE files it operates
on, and may be failing  due to .NET-only quirks.

A final last-ditch effort may be to just use S.R.E to generate the
classes/methods that B.dll provides directly into A.dll.  Maybe I
could use Cecil to read B.dll and generate appropriate output using
S.R.E.?

Any ideas would be appreciated.

Thanks,
    - Vladimir

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012013.html">[Mono-devel-list] Weird runtime crash
</A></li>
	<LI>Next message: <A HREF="012016.html">[Mono-devel-list] merging two assemblies and related problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12015">[ date ]</a>
              <a href="thread.html#12015">[ thread ]</a>
              <a href="subject.html#12015">[ subject ]</a>
              <a href="author.html#12015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
