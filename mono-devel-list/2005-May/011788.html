<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Patch to mimic MS.Net remoting name mangling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20to%20mimic%20MS.Net%20remoting%20name%20mangling&In-Reply-To=1115062866.6542.8.camel%40portatil.aticatac">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011786.html">
   <LINK REL="Next"  HREF="011789.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Patch to mimic MS.Net remoting name mangling</H1>
    <B>Luke Ravitch</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20to%20mimic%20MS.Net%20remoting%20name%20mangling&In-Reply-To=1115062866.6542.8.camel%40portatil.aticatac"
       TITLE="[Mono-devel-list] Patch to mimic MS.Net remoting name mangling">ravitch at nrtc.northrop.com
       </A><BR>
    <I>Mon May  2 16:46:12 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011786.html">[Mono-devel-list] Patch to mimic MS.Net remoting name mangling
</A></li>
        <LI>Next message: <A HREF="011789.html">[Mono-devel-list] contribute to VM Runtime project
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11788">[ date ]</a>
              <a href="thread.html#11788">[ thread ]</a>
              <a href="subject.html#11788">[ subject ]</a>
              <a href="author.html#11788">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, May 02, 2005 at 09:41:06PM +0200, Lluis Sanchez wrote:
&gt;<i> This bug needs a more generic solution. Field names should be encoded
</I>&gt;<i> using XmlConvert.EncodeLocalName, since there may be other characters in
</I>&gt;<i> the name that are not valid in xml names. For inherited fields, the
</I>
Good call - this version of the patch uses EncodeLocalName instead of
hacking it myself.  Is something like this what you have in mind?

&gt;<i> serialized name should be &quot;className+fieldName&quot;. The binary serializer
</I>&gt;<i> already write serialized fields in this way, but the class name is not
</I>&gt;<i> being added in the soap serializer (notice that &quot;+&quot; will be encoded to
</I>&gt;<i> _002B_ by XmlConvert.EncodeLocalName).
</I>
Yeah, I figured the _x002B_ meant &quot;+&quot;, but didn't realize that there's
a generic standardized way of doing the encoding.  I suppose I should
have thought to look.

-- 
Luke Ravitch  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ravitch at nrtc.northrop.com</A>&gt;   Telephone: 310-864-7478
Software Engr., Advanced Software Sys. | One Hornet Way, MS 9M52/W6
Northrop  Grumman  Integrated  Systems | El Segundo, CA 90245-23804
-------------- next part --------------
Index: mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapWriter.cs
===================================================================
--- mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapWriter.cs	(revision 43735)
+++ mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapWriter.cs	(working copy)
@@ -391,7 +391,9 @@
 //					bool specifyEncoding = false;
 //					if(objectData[i] != null)
 //						 specifyEncoding = (objectData[i].GetType() != fieldInfo.FieldType);
-					_xmlWriter.WriteStartElement(fieldInfo.Name);
+
+					string name = SoapReader.GetFieldName (fieldInfo, currentType);
+					_xmlWriter.WriteStartElement(name);
 					SerializeComponent(
 						objectData[i], 
 						IsEncodingNeeded(objectData[i], fieldInfo.FieldType));
Index: mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapReader.cs
===================================================================
--- mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapReader.cs	(revision 43735)
+++ mcs/class/System.Runtime.Serialization.Formatters.Soap/System.Runtime.Serialization.Formatters.Soap/SoapReader.cs	(working copy)
@@ -36,6 +36,7 @@
 using System.Runtime.Remoting;
 using System.Runtime.Serialization;
 using System.Runtime.Remoting.Messaging;
+using System.Runtime.Remoting.Metadata;
 
 namespace System.Runtime.Serialization.Formatters.Soap {
 	internal sealed class SoapReader {
@@ -729,7 +730,28 @@
 					indices);
 			}
 		}
-
+
+		static public string GetFieldName (FieldInfo info, Type type)
+		{
+			string name;
+			Type attr_t = typeof (SoapFieldAttribute);
+			SoapFieldAttribute soapAttr = Attribute.GetCustomAttribute (info, attr_t) as SoapFieldAttribute;
+
+			// To maintain compatibility with MS.Net, we need to mangle the names of any
+			// private inherited members that don't have XmlElementName set in a
+			// SoapFieldAttribute.  MS.Net prepends the base class name to the field name,
+			// using &quot;+&quot; as a delimiter.
+
+			if ((soapAttr != null) &amp;&amp; (soapAttr.XmlElementName != null)) {
+				name = soapAttr.XmlElementName;
+			} else if (info.IsPrivate &amp;&amp; (info.DeclaringType != type)) {
+				name = info.DeclaringType.Name + &quot;+&quot; + info.Name;
+			} else {
+				name = info.Name;
+			}
+			return XmlConvert.EncodeLocalName (name);
+		}
+		
 		TypeMetadata GetTypeMetadata (Type type)
 		{
 			TypeMetadata tm = _fieldIndices[type] as TypeMetadata;
@@ -738,10 +760,14 @@
 			tm = new TypeMetadata ();
 			tm.MemberInfos = FormatterServices.GetSerializableMembers (type, _context);
 			
-			tm.Indices	= new Hashtable();
-			for(int i = 0; i &lt; tm.MemberInfos.Length; i++) 
-				tm.Indices.Add (tm.MemberInfos[i].Name, i);
-			
+			tm.Indices = new Hashtable();
+			for (int i = 0; i &lt; tm.MemberInfos.Length; i++) {
+				// Only fields should be serializable, so this should never be null.
+				FieldInfo fieldInfo = tm.MemberInfos[i] as FieldInfo;
+
+				tm.Indices.Add (GetFieldName (fieldInfo, type), i);
+			} 
+
 			_fieldIndices[type] = tm;
 			return tm;
 		}
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011786.html">[Mono-devel-list] Patch to mimic MS.Net remoting name mangling
</A></li>
	<LI>Next message: <A HREF="011789.html">[Mono-devel-list] contribute to VM Runtime project
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11788">[ date ]</a>
              <a href="thread.html#11788">[ thread ]</a>
              <a href="subject.html#11788">[ subject ]</a>
              <a href="author.html#11788">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
