<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mono numerical performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mono%20numerical%20performance&In-Reply-To=1321807090.3279.11.camel%40ubuntu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038276.html">
   <LINK REL="Next"  HREF="038279.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mono numerical performance</H1>
    <B>Jonathan Shore</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mono%20numerical%20performance&In-Reply-To=1321807090.3279.11.camel%40ubuntu"
       TITLE="[Mono-dev] mono numerical performance">jonathan.shore at gmail.com
       </A><BR>
    <I>Sun Nov 20 12:04:56 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="038276.html">[Mono-dev] mono numerical performance
</A></li>
        <LI>Next message: <A HREF="038279.html">[Mono-dev] mono numerical performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38278">[ date ]</a>
              <a href="thread.html#38278">[ thread ]</a>
              <a href="subject.html#38278">[ subject ]</a>
              <a href="author.html#38278">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, Zoltan pointed out that the performance under LLVM is pretty good, so I probably did not have LLVM enabled.  Indeed I checked and found that to be the case (my bad).  As for the pattern you mention, aware that mono is able to avoid checks in that scenario.  

More often then not, though, I am dealing with structures that use double[] with allocations &gt; the span of interest (as the series grow in size).  So I usually have to rely on a variable that indicates size rather than array.Length.   I could have used in this test though.

It would be nice (and seemingly would be straightforward) if the JIT was able to recognize:

the len variable is invariant / locally scoped with respect to the loop
can have 2 code paths:
one for if the condition will be within bounds (can avoid bounds checking)
one for if the condition is either not in bounds or cannot be determined to be invariant (hence should do the normal bounds checking)

I suppose a crutch to work around this, playing to mono's jit would be:

for (int i = 0 ; i &lt; array.Length ; i++)
{
	if (i &lt; &lt;length expression&gt;)
		&lt;do computation on array[i]&gt;
	else
		break;
}

The cost of the extra condition might outweigh the benefit (I haven't studied the branch cycle times to know).    Better would be:

if (&lt;length expression&gt; &lt;= array.Length AND invariant)
{
	for (int i = 0 ; i &lt; &lt;length expression&gt; ; i++)
	{
		&lt;do computation on array[i] without checks&gt;
	}
}
else
{
	for (int i = 0 ; i &lt; &lt;length expression&gt; ; i++)
	{
		&lt;do computation on array[i] with checks&gt;
	}
}

It is too bad that one cannot declare a primitive expression to be locally const in C#.  In java one can do something like:

	final int len = &lt;some expression&gt;
	for (int i = 0 ; i &lt; len ; i++) ...

OR in C#

	const int len = &lt;some expression&gt;    (error if the expression refers to functions or variables)

With an explicit notion of invariance could simplify the decision for the JIT.


On Nov 20, 2011, at 11:38 AM, Konrad M. Kruczy&#324;ski wrote:

&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'd like to add that you may gain something on MS JIT compiler using 
</I>&gt;<i> for (int i = 0 ; i &lt; x.Length ; i++)
</I>&gt;<i> instead of
</I>&gt;<i> for (int i = 0 ; i &lt; len ; i++)
</I>&gt;<i> 
</I>&gt;<i> This may seem counter intuitive, however that's the scenario in which
</I>&gt;<i> JIT eliminates array bound checking for the x array (however not for the
</I>&gt;<i> second one) as arrays have constant length. I am not sure whether Mini
</I>&gt;<i> recognizes that. I'm pretty sure that Hotspot is much smarter here ;)
</I>&gt;<i> 
</I>&gt;<i> As Zoltan wrote in the bug comments, enabling LLVM improves the results
</I>&gt;<i> a lot. This is, I guess, due to much better register allocation in which
</I>&gt;<i> domain Mini isn't too good - and probably other optimizations like
</I>&gt;<i> better loop unrolling.
</I>&gt;<i> 
</I>&gt;<i> If I remember correctly, there once was a branch of LLVM with array
</I>&gt;<i> bounds check elimination, is it still developed?
</I>&gt;<i> 
</I>&gt;<i> I am also curious which code patterns enable ABC elimination in Mini.
</I>&gt;<i> 
</I>&gt;<i> On Sun, 2011-11-20 at 08:01 -0500, Jonathan Shore wrote:
</I>&gt;&gt;<i> Here is a link to and entry in bugzilla with attached code.  I could
</I>&gt;&gt;<i> not send to the list:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> <A HREF="http://bugzilla.xamarin.com/show_bug.cgi?id=2098">http://bugzilla.xamarin.com/show_bug.cgi?id=2098</A>
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Regards,
</I>&gt;<i> Konrad
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20111120/4592fbaf/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20111120/4592fbaf/attachment.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038276.html">[Mono-dev] mono numerical performance
</A></li>
	<LI>Next message: <A HREF="038279.html">[Mono-dev] mono numerical performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38278">[ date ]</a>
              <a href="thread.html#38278">[ thread ]</a>
              <a href="subject.html#38278">[ subject ]</a>
              <a href="author.html#38278">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
