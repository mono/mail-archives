<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] UriParser.cs - Threading fixes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20UriParser.cs%20-%20Threading%20fixes&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029594.html">
   <LINK REL="Next"  HREF="029591.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] UriParser.cs - Threading fixes</H1>
    <B>Alan McGovern</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20UriParser.cs%20-%20Threading%20fixes&In-Reply-To="
       TITLE="[Mono-dev] UriParser.cs - Threading fixes">alan.mcgovern at gmail.com
       </A><BR>
    <I>Fri Oct 31 11:38:06 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="029594.html">[Mono-dev] MS kills Linq to SQL ! --- Linq, Nhibernate or subsonic ?
</A></li>
        <LI>Next message: <A HREF="029591.html">[Mono-dev] [PATCH] Add .desktop file to gsharp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29590">[ date ]</a>
              <a href="thread.html#29590">[ thread ]</a>
              <a href="subject.html#29590">[ subject ]</a>
              <a href="author.html#29590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There are a few thread-unsafe accesses to the hashtable which I've fixed.
I've also cleaned up how the initial table is populated by removing
redundent calls to CreateDefaults ().

 Is this ok to commit?


Index: UriParser.cs
===================================================================
--- UriParser.cs    (revision 117256)
+++ UriParser.cs    (working copy)
@@ -38,7 +38,7 @@
     public abstract class UriParser {

         static object lock_object = new object ();
-        static Hashtable table;
+        static Hashtable table = CreateDefaults ();

         private string scheme_name;
         private int default_port;
@@ -211,11 +211,8 @@

         // static methods

-        private static void CreateDefaults ()
+        private static Hashtable CreateDefaults ()
         {
-            if (table != null)
-                return;
-
             Hashtable newtable = new Hashtable ();
             InternalRegister (newtable, new DefaultUriParser (),
Uri.UriSchemeFile, -1);
             InternalRegister (newtable, new DefaultUriParser (),
Uri.UriSchemeFtp, 21);
@@ -229,13 +226,8 @@
             InternalRegister (newtable, new DefaultUriParser (),
Uri.UriSchemeNntp, 119);
             // not defined in Uri.UriScheme* but a parser class exists
             InternalRegister (newtable, new DefaultUriParser (), &quot;ldap&quot;,
389);
-
-            lock (lock_object) {
-                if (table == null)
-                    table = newtable;
-                else
-                    newtable = null;
-            }
+
+            return newtable;
         }

         public static bool IsKnownScheme (string schemeName)
@@ -245,9 +237,10 @@
             if (schemeName.Length == 0)
                 throw new ArgumentOutOfRangeException (&quot;schemeName&quot;);

-            CreateDefaults ();
             string lc = schemeName.ToLower (CultureInfo.InvariantCulture);
-            return (table [lc] != null);
+
+            lock (lock_object)
+                return (table [lc] != null);
         }

         // *no* check version
@@ -280,14 +273,16 @@
             if ((defaultPort &lt; -1) || (defaultPort &gt;= UInt16.MaxValue))
                 throw new ArgumentOutOfRangeException (&quot;defaultPort&quot;);

-            CreateDefaults ();
-
             string lc = schemeName.ToLower (CultureInfo.InvariantCulture);
-            if (table [lc] != null) {
-                string msg = Locale.GetText (&quot;Scheme '{0}' is already
registred.&quot;);
-                throw new InvalidOperationException (msg);
+
+            lock (lock_object) {
+                if (table [lc] != null) {
+                    string msg = Locale.GetText (&quot;Scheme '{0}' is already
registred.&quot;);
+                    throw new InvalidOperationException (msg);
+                }
+
+                InternalRegister (table, uriParser, lc, defaultPort);
             }
-            InternalRegister (table, uriParser, lc, defaultPort);
         }

         internal static UriParser GetParser (string schemeName)
@@ -295,10 +290,10 @@
             if (schemeName == null)
                 return null;

-            CreateDefaults ();
-
             string lc = schemeName.ToLower (CultureInfo.InvariantCulture);
-            return (UriParser) table [lc];
+
+            lock (lock_object)
+                return (UriParser) table [lc];
         }
     }
 }
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081031/01044aae/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081031/01044aae/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: uriparserfix.patch
Type: text/x-patch
Size: 2587 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081031/01044aae/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081031/01044aae/attachment-0001.bin</A> 
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029594.html">[Mono-dev] MS kills Linq to SQL ! --- Linq, Nhibernate or subsonic ?
</A></li>
	<LI>Next message: <A HREF="029591.html">[Mono-dev] [PATCH] Add .desktop file to gsharp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29590">[ date ]</a>
              <a href="thread.html#29590">[ thread ]</a>
              <a href="subject.html#29590">[ subject ]</a>
              <a href="author.html#29590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
