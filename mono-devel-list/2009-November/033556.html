<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] inlining and performance of SIMD code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20inlining%20and%20performance%20of%20SIMD%20code&In-Reply-To=4ADDE0F7.70606%40inria.fr">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033555.html">
   <LINK REL="Next"  HREF="033557.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] inlining and performance of SIMD code</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20inlining%20and%20performance%20of%20SIMD%20code&In-Reply-To=4ADDE0F7.70606%40inria.fr"
       TITLE="[Mono-dev] inlining and performance of SIMD code">miguel at novell.com
       </A><BR>
    <I>Sun Nov 22 16:40:21 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033555.html">[Mono-dev] Mono.Cairo Pdf stream support...
</A></li>
        <LI>Next message: <A HREF="033557.html">[Mono-dev] [PATCH] XSP: Virtual path support on FastCGI Backend	(also resulting in MVC support)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33556">[ date ]</a>
              <a href="thread.html#33556">[ thread ]</a>
              <a href="subject.html#33556">[ subject ]</a>
              <a href="author.html#33556">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i> - I am curious what the heuristics are. I looked at the function 
</I>&gt;<i> mono_method_check_inlining, but even when the function returns TRUE, the 
</I>&gt;<i> function might not be inlined. Could you point me the relevant piece of code? Is 
</I>&gt;<i> there any high level rule to make a guess, like complex control flow, use of 
</I>&gt;<i> certain opcode, etc?
</I>
It happens in mini/method-to-ir.c, there are a few rules that govern the
inlining.

The routine that you mention has most of the heuristics, but the two
call sites that use it have additional limitations, check the source.

&gt;<i> - Can I force inlining of a given function? Even a hack is fine, I am trying to 
</I>&gt;<i> evaluate several code generation schemes, and I would like to measure the impact 
</I>&gt;<i> of inlining. Whatever works is fine.
</I>
I do not think that this is possible currently, but a simple hack that
allows you to do this with an environment variable would do the trick
(as a temporary hack).

&gt;<i> 
</I>&gt;<i> - I tried to run code with calls to Mono.Simd on architectures that do not 
</I>&gt;<i> support SIMD (or on x86 with the flag --optimize=-simd). A simple loop written 
</I>&gt;<i> in C a[i]=b[i]+c[i] gets vectorized by GCC, the bytecode esentially contains 
</I>&gt;<i> calls to Mono.Simd.Vector4f::LoadAligned, StoreAligned and op_Addition, plus 
</I>&gt;<i> address computations. The generated code, however, is very inefficient, values 
</I>&gt;<i> being copied around many times. Here is an example I captured with 'mono -v -v':
</I>&gt;<i>    f8:	8b 11                	mov    (%ecx),%edx
</I>&gt;<i>    fa:	89 55 b8             	mov    %edx,-0x48(%ebp)
</I>&gt;<i>   12e:	8b 4d b8             	mov    -0x48(%ebp),%ecx
</I>&gt;<i>   131:	89 4d 88             	mov    %ecx,-0x78(%ebp)
</I>&gt;<i>   15e:	d9 45 88             	flds   -0x78(%ebp)
</I>&gt;<i>   161:	d9 45 98             	flds   &lt;...second op...&gt;
</I>&gt;<i>   164:	de c1                	faddp  %st,%st(1)
</I>&gt;<i>   19c:	d9 9d 4c ff ff ff    	fstps  -0xb4(%ebp)
</I>&gt;<i>   1b6:	d9 85 4c ff ff ff    	flds   -0xb4(%ebp)
</I>&gt;<i>   1bc:	d9 5d a8             	fstps  -0x58(%ebp)
</I>&gt;<i>   1da:	8b 4d a8             	mov    -0x58(%ebp),%ecx
</I>&gt;<i>   1dd:	89 4d d8             	mov    %ecx,-0x28(%ebp)
</I>&gt;<i>   1f2:	8b 4d d8             	mov    -0x28(%ebp),%ecx
</I>&gt;<i>   1f5:	89 08                	mov    %ecx,(%eax)
</I>&gt;<i> 
</I>&gt;<i> It seems that a simple copy propagation followed by dead code elimination would 
</I>&gt;<i> fix it. But I am not sure where I should look. Any comment or suggestion?
</I>
You are correct that the code quality is not great, let me give you some
background on how we got here.   Our previous JIT engine transformed the
CIL byte stream into a tree-based intermediate representation.   Back in
that day we implemented various optimizations on this tree, including
the decomposition of the tree into an SSA form, and then various
optimizations based on the SSA form.   

Although the optimizations were useful, the tree representation
prevented other optimizations from taking place and the code quality was
not that great.

A new engine that circumvented the tree representation was created which
avoided the tree, so a new set of optimizations became possible, this
new IR is documented here:

<A HREF="http://www.mono-project.com/Linear_IL">http://www.mono-project.com/Linear_IL</A>

The code generation improved, but some of the old optimizations that we
had created were lost in the process.   Although the code continues to
exist in the tree, they have not been ported.

In particular, a full framework to do partial redundancy elimination
existed (and it supported dead code elimination) in the file ssapre.c

I am not sure what is best: to port the ssapre.c framework to work on
Mono's new JIT, or to build a simplistic DCE/PRE framework on top of the
current IR.

There is definitely plenty of low-hanging fruit in the Mono JIT at this
point.

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033555.html">[Mono-dev] Mono.Cairo Pdf stream support...
</A></li>
	<LI>Next message: <A HREF="033557.html">[Mono-dev] [PATCH] XSP: Virtual path support on FastCGI Backend	(also resulting in MVC support)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33556">[ date ]</a>
              <a href="thread.html#33556">[ thread ]</a>
              <a href="subject.html#33556">[ subject ]</a>
              <a href="author.html#33556">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
