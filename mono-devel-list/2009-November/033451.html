<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Deadlock in System.Web.Caching.Cache class
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Deadlock%20in%20System.Web.Caching.Cache%20class&In-Reply-To=4AF7C22C.1030001%40twistedcode.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033449.html">
   <LINK REL="Next"  HREF="033448.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Deadlock in System.Web.Caching.Cache class</H1>
    <B>Ivan Radovanovic</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Deadlock%20in%20System.Web.Caching.Cache%20class&In-Reply-To=4AF7C22C.1030001%40twistedcode.net"
       TITLE="[Mono-dev] Deadlock in System.Web.Caching.Cache class">rivanr at gmail.com
       </A><BR>
    <I>Mon Nov  9 04:11:13 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033449.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
        <LI>Next message: <A HREF="033448.html">[Mono-dev] Mono 2.6 preview tarball misses mcs/class/dlr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33451">[ date ]</a>
              <a href="thread.html#33451">[ thread ]</a>
              <a href="subject.html#33451">[ subject ]</a>
              <a href="author.html#33451">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Issue was in bad patch applied on mono/metadata/filewatcher.c - so no 
errors on mono side :-)
I will try to create test case for this deadlock, since it is not OS 
dependent, but anyway I don't think it is very serious

Best regards,
Ivan

Marek Habersack napisa:
&gt;<i> Ivan Radovanovic wrote:
</I>&gt;&gt;<i> Although this dead lock problem continues to potentially exists it 
</I>&gt;&gt;<i> seems that problem is after all OS specific - there is some weird 
</I>&gt;&gt;<i> behavior of fam/gamin reporting that bin/*.dll files are changed, 
</I>&gt;&gt;<i> causing ASP.Net runtime trying to restart application, while at the 
</I>&gt;&gt;<i> same time trying to compile *.aspx, *.ascx etc.
</I>&gt;<i> The issue might be in FAM FileSystemWatcher backend then.
</I>&gt;<i> 
</I>&gt;&gt;<i> Maybe deadlock can occur in normal conditions too (servicing some 
</I>&gt;&gt;<i> request that would need compiling of some control/page that is not 
</I>&gt;&gt;<i> compiled yet and replacing something in bin directory at the same 
</I>&gt;&gt;<i> time), but that should be rare enough :-)
</I>&gt;<i> The BuildManager in 2.4 has some bugs indeed, which in certain cases can 
</I>&gt;<i> lead to deadlocks (it's, among others, related to recursive dependencies 
</I>&gt;<i> between application files). For that reason I rewrote BuildManager for 
</I>&gt;<i> 2.6+ - if the problem you're seeing turns out to be an issue with more 
</I>&gt;<i> than few environments, I can just copy the new code to 2.4 branch for a 
</I>&gt;<i> future release. If you can come up with a test case that triggers the 
</I>&gt;<i> issue on your system, then please file a bug report and attach the 
</I>&gt;<i> testcase including OS/environment details.
</I>&gt;<i> 
</I>&gt;<i> marek
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ivan Radovanovic napisa:
</I>&gt;&gt;&gt;<i> Hello, I am experiencing weird deadlock in .net applications running 
</I>&gt;&gt;&gt;<i> latest release version of mono (2.4.2.3) on FreeBSD (I don't think it 
</I>&gt;&gt;&gt;<i> is OS specific, and it doesn't show all the times, but still often 
</I>&gt;&gt;&gt;<i> enough so I can trace it)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Stack from thread 1:
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.RemoveVirtualPathFromCaches(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.OnVirtualPathChanged(System.String 
</I>&gt;&gt;&gt;<i> key, System.Object value, CacheItemRemovedReason removedReason)
</I>&gt;&gt;&gt;<i>    at System.Web.Caching.Cache.InvokePrivateCallbacks()
</I>&gt;&gt;&gt;<i>    at System.Web.HttpRuntime.ShutdownAppDomain(System.Object args)
</I>&gt;&gt;&gt;<i> ====================================================================
</I>&gt;&gt;&gt;<i> Stack from thread 2:
</I>&gt;&gt;&gt;<i>    at System.Web.Caching.Cache.Add(System.String key, System.Object 
</I>&gt;&gt;&gt;<i> value, System.Web.Caching.CacheDependency dependencies, DateTime 
</I>&gt;&gt;&gt;<i> absoluteExpiration, TimeSpan slidingExpiration, CacheItemPriority 
</I>&gt;&gt;&gt;<i> priority, System.Web.Caching.CacheItemRemovedCallback onRemoveCallback)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.BuildManager.AddToCache(System.String 
</I>&gt;&gt;&gt;<i> virtualPath, System.Web.Compilation.BuildProvider bp)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GenerateAssembly(System.Web.Compilation.AssemblyBuilder 
</I>&gt;&gt;&gt;<i> abuilder, System.Collections.Generic.List`1 buildItems, 
</I>&gt;&gt;&gt;<i> System.Web.VirtualPath virtualPath, BuildKind buildKind)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.LoadType()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.GetType(System.String 
</I>&gt;&gt;&gt;<i> componentName, System.String ByRef source, System.String ByRef ns)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.CreateComponent(System.Web.Compilation.Foundry 
</I>&gt;&gt;&gt;<i> foundry, System.String tagName, System.String prefix, System.String tag)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.GetComponent(System.String 
</I>&gt;&gt;&gt;<i> tagName)
</I>&gt;&gt;&gt;<i>    at System.Web.UI.RootBuilder.GetChildControlType(System.String 
</I>&gt;&gt;&gt;<i> tagName, IDictionary attribs)
</I>&gt;&gt;&gt;<i>    at System.Web.UI.ControlBuilder.CreateSubBuilder(System.String 
</I>&gt;&gt;&gt;<i> tagid, System.Collections.Hashtable atts, System.Type childType, 
</I>&gt;&gt;&gt;<i> System.Web.UI.TemplateParser parser, ILocation location)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.ProcessTag(ILocation 
</I>&gt;&gt;&gt;<i> location, System.String tagid, System.Web.Compilation.TagAttributes 
</I>&gt;&gt;&gt;<i> atts, TagType tagtype, Boolean ByRef ignored)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.TagParsed(ILocation 
</I>&gt;&gt;&gt;<i> location, TagType tagtype, System.String tagid, 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspParser.OnTagParsed(TagType tagtype, 
</I>&gt;&gt;&gt;<i> System.String id, System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspParser.Parse()
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.Parse(System.IO.TextReader 
</I>&gt;&gt;&gt;<i> reader, System.String filename, Boolean doInitParser)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.Parse()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.GenericBuildProvider`1.get_CodeCompilerType()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCodeDomProviderType(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;&gt;<i> provider)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager+BuildItem..ctor(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;&gt;<i> provider)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.LoadBuildProviders(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath, System.String virtualDir, 
</I>&gt;&gt;&gt;<i> System.Collections.Generic.Dictionary`2 vpCache, BuildKind ByRef 
</I>&gt;&gt;&gt;<i> kind, System.String ByRef assemblyBaseName)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.LoadType()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.GetType(System.String 
</I>&gt;&gt;&gt;<i> componentName, System.String ByRef source, System.String ByRef ns)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.CreateComponent(System.Web.Compilation.Foundry 
</I>&gt;&gt;&gt;<i> foundry, System.String tagName, System.String prefix, System.String tag)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.GetComponent(System.String 
</I>&gt;&gt;&gt;<i> tagName)
</I>&gt;&gt;&gt;<i>    at System.Web.UI.RootBuilder.GetChildControlType(System.String 
</I>&gt;&gt;&gt;<i> tagName, IDictionary attribs)
</I>&gt;&gt;&gt;<i>    at System.Web.UI.ControlBuilder.CreateSubBuilder(System.String 
</I>&gt;&gt;&gt;<i> tagid, System.Collections.Hashtable atts, System.Type childType, 
</I>&gt;&gt;&gt;<i> System.Web.UI.TemplateParser parser, ILocation location)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.ProcessTag(ILocation 
</I>&gt;&gt;&gt;<i> location, System.String tagid, System.Web.Compilation.TagAttributes 
</I>&gt;&gt;&gt;<i> atts, TagType tagtype, Boolean ByRef ignored)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.TagParsed(ILocation 
</I>&gt;&gt;&gt;<i> location, TagType tagtype, System.String tagid, 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspParser.OnTagParsed(TagType tagtype, 
</I>&gt;&gt;&gt;<i> System.String id, System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspParser.Parse()
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.Parse(System.IO.TextReader 
</I>&gt;&gt;&gt;<i> reader, System.String filename, Boolean doInitParser)
</I>&gt;&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.Parse()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.GenericBuildProvider`1.get_CodeCompilerType()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCodeDomProviderType(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;&gt;<i> provider)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager+BuildItem..ctor(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;&gt;<i> provider)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.LoadBuildProviders(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath, System.String virtualDir, 
</I>&gt;&gt;&gt;<i> System.Collections.Generic.Dictionary`2 vpCache, BuildKind ByRef 
</I>&gt;&gt;&gt;<i> kind, System.String ByRef assemblyBaseName)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;&gt;<i> virtualPath)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.CreateInstanceFromVirtualPath(System.String 
</I>&gt;&gt;&gt;<i> virtualPath, System.Type requiredBaseType)
</I>&gt;&gt;&gt;<i>    at System.Web.UI.PageParser.GetCompiledPageInstance(System.String 
</I>&gt;&gt;&gt;<i> virtualPath, System.String inputFile, System.Web.HttpContext context)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.UI.PageHandlerFactory.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;&gt;<i> context, System.String requestType, System.String url, System.String 
</I>&gt;&gt;&gt;<i> path)
</I>&gt;&gt;&gt;<i>    at System.Web.HttpApplication.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;&gt;<i> context, System.String url, Boolean ignoreContextHandler)
</I>&gt;&gt;&gt;<i>    at System.Web.HttpApplication.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;&gt;<i> context, System.String url)
</I>&gt;&gt;&gt;<i>    at System.Web.HttpApplication+&lt;Pipeline&gt;c__Iterator2.MoveNext()
</I>&gt;&gt;&gt;<i>    at System.Web.HttpApplication.Tick()
</I>&gt;&gt;&gt;<i>    at System.Web.HttpApplication.Start(System.Object x)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.HttpApplication.System.Web.IHttpHandler.ProcessRequest(System.Web.HttpContext 
</I>&gt;&gt;&gt;<i> context)
</I>&gt;&gt;&gt;<i>    at System.Web.HttpRuntime.Process(System.Web.HttpWorkerRequest req)
</I>&gt;&gt;&gt;<i>    at System.Web.HttpRuntime.RealProcessRequest(System.Object o)
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> System.Web.HttpRuntime.ProcessRequest(System.Web.HttpWorkerRequest wr)
</I>&gt;&gt;&gt;<i>    at Mono.WebServer.MonoWorkerRequest.ProcessRequest()
</I>&gt;&gt;&gt;<i>    at 
</I>&gt;&gt;&gt;<i> Mono.WebServer.BaseApplicationHost.ProcessRequest(Mono.WebServer.MonoWorkerRequest 
</I>&gt;&gt;&gt;<i> mwr)
</I>&gt;&gt;&gt;<i>    at Mono.WebServer.XSPApplicationHost.ProcessRequest(Int32 reqId, 
</I>&gt;&gt;&gt;<i> Int64 localEPAddr, Int32 localEPPort, Int64 remoteEPAdds, Int32 
</I>&gt;&gt;&gt;<i> remoteEPPort, System.String verb, System.String path, System.String 
</I>&gt;&gt;&gt;<i> queryString, System.String protocol, System.Byte[] inputBuffer, 
</I>&gt;&gt;&gt;<i> System.String redirect, IntPtr socket, Mono.WebServer.SslInformations 
</I>&gt;&gt;&gt;<i> ssl)
</I>&gt;&gt;&gt;<i>    at Mono.WebServer.XSPWorker.RunInternal(System.Object state)
</I>&gt;&gt;&gt;<i> =============================================================================== 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As you can see there is deadlock between 
</I>&gt;&gt;&gt;<i> System.Web.Compilation.BuildManager.AddToCache (thread 2, second 
</I>&gt;&gt;&gt;<i> item) and System.Web.Compilation.BuildManager.GenerateAssembly (both 
</I>&gt;&gt;&gt;<i> using lock (buildCacheLock)) and between System.Web.Caching.Cache.Add 
</I>&gt;&gt;&gt;<i> and System.Web.Caching.Cache.InvokePrivateCallbacks() (both using 
</I>&gt;&gt;&gt;<i> lock(cache))
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am curious if someone is working on this bug (is this known bug?) 
</I>&gt;&gt;&gt;<i> or I should try to fix it myself?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Best regards,
</I>&gt;&gt;&gt;<i> Ivan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033449.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
	<LI>Next message: <A HREF="033448.html">[Mono-dev] Mono 2.6 preview tarball misses mcs/class/dlr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33451">[ date ]</a>
              <a href="thread.html#33451">[ thread ]</a>
              <a href="subject.html#33451">[ subject ]</a>
              <a href="author.html#33451">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
