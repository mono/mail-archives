<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Should we replace MemoryStream?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Should%20we%20replace%20MemoryStream%3F&In-Reply-To=23a15590911100421n49904fb5sd31ab20e019c567f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033472.html">
   <LINK REL="Next"  HREF="033474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Should we replace MemoryStream?</H1>
    <B>Steve Bjorg</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Should%20we%20replace%20MemoryStream%3F&In-Reply-To=23a15590911100421n49904fb5sd31ab20e019c567f%40mail.gmail.com"
       TITLE="[Mono-dev] Should we replace MemoryStream?">steveb at mindtouch.com
       </A><BR>
    <I>Tue Nov 10 07:47:02 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033472.html">[Mono-dev] Should we replace MemoryStream?
</A></li>
        <LI>Next message: <A HREF="033474.html">[Mono-dev] Should we replace MemoryStream?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33473">[ date ]</a>
              <a href="thread.html#33473">[ thread ]</a>
              <a href="subject.html#33473">[ subject ]</a>
              <a href="author.html#33473">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Allowing the first chunk to be variable sized doesn't make the code  
that much more complex.  This would mean in read-only cases, all  
operations would remain O(1) since the original byte array would be  
preserved.  For write operations, new chunks would be allocated as  
needed.  Determining which chunk to read from or write to would need  
to take into account the first chunk size, but that's it.

For the case where someone initializes the ChunkedMemoryStream with an  
existing byte array, then appends to it, and then calls GetBuffer(),  
we would end up with the same overhead as before since the  
MemoryStream would have needed to reallocate the byte array when the  
first append operation occurred, whereas the ChunkedMemoryStream does  
it on GetBuffer().  However, if the array needed to be extended  
multiple times due to many append operations, then the  
ChunkedMemoryStream will come out ahead again  since it only  
realloacted the buffer once.  At which point, the realloacted buffer  
could replace the first chunk so we don't do this again for repeated  
calls to GetBuffer().


On Nov 10, 2009, at 4:21 AM, Leszek Ciesielski wrote:

&gt;<i> Choice is not always good, and I think this is one of the cases when
</I>&gt;<i> the default (i.e. the MemoryStream implementation) should make the
</I>&gt;<i> choices instead presenting them to the user. Though I agree that the
</I>&gt;<i> case of constructing a MemoryStream from an existing byte[] would
</I>&gt;<i> require a special path in the code, as this is a stream that most
</I>&gt;<i> likely won't be resized and in this case users are expecting the
</I>&gt;<i> constructor to have a complexity of O(1) and GetBuffer to also be
</I>&gt;<i> O(1). The same expectation is probably also true with a fixed size
</I>&gt;<i> MemoryStream.
</I>&gt;<i>
</I>&gt;<i> On Tue, Nov 10, 2009 at 1:09 PM, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pablosantosluac at terra.es</A>
</I>&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pablosantosluac at terra.es</A>&gt; wrote:
</I>&gt;&gt;<i> I agree (especially thinking about the chunk-pool I mentioned) having
</I>&gt;&gt;<i> separate classes can be better, so that everyone can choose.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Andreas Nahr wrote:
</I>&gt;&gt;&gt;<i> I'm still not sure this is a good idea. A lot of this depends on the
</I>&gt;&gt;&gt;<i> use-case for MemoryStream.
</I>&gt;&gt;&gt;<i> If
</I>&gt;&gt;&gt;<i> 1) A MemoryStream is created with a parameterless constructor and  
</I>&gt;&gt;&gt;<i> then a lot
</I>&gt;&gt;&gt;<i> of data written to it multiple times the ChunkedStream will be  
</I>&gt;&gt;&gt;<i> better
</I>&gt;&gt;&gt;<i> always.
</I>&gt;&gt;&gt;<i> 2) If a MemoryStream is created with a parameterless constructor  
</I>&gt;&gt;&gt;<i> and only
</I>&gt;&gt;&gt;<i> gets a few bytes long ChunkedStream might bring considerable  
</I>&gt;&gt;&gt;<i> overhead.
</I>&gt;&gt;&gt;<i> 3) If MemoryStream is created with a fixed size then ChunkedStream  
</I>&gt;&gt;&gt;<i> will be
</I>&gt;&gt;&gt;<i> somewhat, but acceptably slower and have a higher overhead. But it  
</I>&gt;&gt;&gt;<i> will be
</I>&gt;&gt;&gt;<i> totally abysmal once GetBuffer comes into play.
</I>&gt;&gt;&gt;<i> 4) If MemoryStream is constructed from a (large) byte array (in the
</I>&gt;&gt;&gt;<i> scientific field I'm coming from this is by far the most common  
</I>&gt;&gt;&gt;<i> usage I've
</I>&gt;&gt;&gt;<i> seem; that is basically using MemoryStream as a (read-only) Stream- 
</I>&gt;&gt;&gt;<i> Wrapper
</I>&gt;&gt;&gt;<i> around a byte array) then performance will be abysmal when  
</I>&gt;&gt;&gt;<i> constructing (if
</I>&gt;&gt;&gt;<i> you chunkify e.g. a 500MB byte array) AND again with GetBuffer  
</I>&gt;&gt;&gt;<i> (recreate the
</I>&gt;&gt;&gt;<i> array). So would be O (n) or even O (2*n) instead of O (0).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It might be possible to create an implementation that can deal  
</I>&gt;&gt;&gt;<i> with all this
</I>&gt;&gt;&gt;<i> (would need to have variable sized buffers, keep things it gets  
</I>&gt;&gt;&gt;<i> passed in
</I>&gt;&gt;&gt;<i> the constructor alive with small overhead, etc.), but it will be  
</I>&gt;&gt;&gt;<i> quite
</I>&gt;&gt;&gt;<i> complex and come with a large base overhead. And even then the  
</I>&gt;&gt;&gt;<i> GetBuffer
</I>&gt;&gt;&gt;<i> O(n) problem remains in a few scenarios.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Maybe it would be better to just leave the class as is and  
</I>&gt;&gt;&gt;<i> document that for
</I>&gt;&gt;&gt;<i> certain scenarios alternative implementations are available that  
</I>&gt;&gt;&gt;<i> do a MUCH
</I>&gt;&gt;&gt;<i> better job. Everybody can easily replace the use of MemoryStream  
</I>&gt;&gt;&gt;<i> with an
</I>&gt;&gt;&gt;<i> alternative implementation if needed. But nobody expects this  
</I>&gt;&gt;&gt;<i> class to
</I>&gt;&gt;&gt;<i> behave completely different from how it originally did (and seems  
</I>&gt;&gt;&gt;<i> to do in
</I>&gt;&gt;&gt;<i> MS.Net).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Andreas
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

- Steve

--------------
Steve G. Bjorg
<A HREF="http://mindtouch.com">http://mindtouch.com</A>
<A HREF="http://twitter.com/bjorg">http://twitter.com/bjorg</A>
irc.freenode.net #mindtouch


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033472.html">[Mono-dev] Should we replace MemoryStream?
</A></li>
	<LI>Next message: <A HREF="033474.html">[Mono-dev] Should we replace MemoryStream?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33473">[ date ]</a>
              <a href="thread.html#33473">[ thread ]</a>
              <a href="subject.html#33473">[ subject ]</a>
              <a href="author.html#33473">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
