<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] MONO_IOMAP reporting option - string allocation locations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20MONO_IOMAP%20reporting%20option%20-%20string%0A%20allocation%20locations&In-Reply-To=79A9F7F0-9526-409A-A34D-0DE334389F3D%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033590.html">
   <LINK REL="Next"  HREF="033580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] MONO_IOMAP reporting option - string allocation locations</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20MONO_IOMAP%20reporting%20option%20-%20string%0A%20allocation%20locations&In-Reply-To=79A9F7F0-9526-409A-A34D-0DE334389F3D%40novell.com"
       TITLE="[Mono-dev] [PATCH] MONO_IOMAP reporting option - string allocation locations">grendel at twistedcode.net
       </A><BR>
    <I>Mon Nov 30 02:53:10 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033590.html">[Mono-dev] [PATCH] MONO_IOMAP reporting option - string	allocation locations
</A></li>
        <LI>Next message: <A HREF="033580.html">[Mono-dev] [Mono-list] WCF Service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33593">[ date ]</a>
              <a href="thread.html#33593">[ thread ]</a>
              <a href="subject.html#33593">[ subject ]</a>
              <a href="author.html#33593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/28/2009 07:12 AM, Miguel de Icaza wrote:
&gt;<i> Hello Marek,
</I>Hey Miguel,

&gt;<i>
</I>&gt;<i> I think the idea is very useful, but I would like to see this
</I>&gt;<i> implemented as a loadable profiler.
</I>We discussed that with Rodrigo and Zoltan, and while doing it is easy 
the conclusion was that at this time it's not practical because we don't 
support multiple profilers right now and it would conflict with, e.g., 
the soft debugger (it is possible to use the allocation profiling 
callback while another profiler is active, but since we support only one 
callback per category, it may override the original handler). Zoltan 
suggested that the code is committed as-is right now, and modified to 
use the profiler interface when we have multiple profiler support ready 
(the change to do that in my code would be really minimal).

&gt;<i> We could make an alias to load other modules like --module that would
</I>&gt;<i> just be an alias to this feature if you think that the profiler
</I>&gt;<i> association is too negative.
</I>I think it doesn't reflect the purpose of the code and, as Zoltan said, 
it is more a tooling interface than a profiling one. Also, what do you 
think about implementing the support in the similar fashion as the soft 
debugger - i.e. it wouldn't be a separate .so, but would live in the 
runtime, otherwise behaving like a shared module? That would let us keep 
the code together with the I/O portability layer.

marek

&gt;<i>
</I>&gt;<i> On Nov 26, 2009, at 7:08 PM, Marek Habersack wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello everybody,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Attached is an update to the original code I posted last week. The
</I>&gt;&gt;<i> update adds support for reporting string allocation locations. It is
</I>&gt;&gt;<i> useful with large code base where strings may be created in one
</I>&gt;&gt;<i> location but used in many others. The code adds a new internal
</I>&gt;&gt;<i> function which does the job of backtrace (3) but supports mono JIT.
</I>&gt;&gt;<i> It's basically a lighter version of mono_jit_walk_stack which was too
</I>&gt;&gt;<i> heavy for this purpose. The code needs to record stack location for
</I>&gt;&gt;<i> each and every string allocated in the application and the runtime
</I>&gt;&gt;<i> only to store it for later use when IOMAP kicks in. Doing that with
</I>&gt;&gt;<i> mono_stack_walk rendered Mono many times slower and made debugging the
</I>&gt;&gt;<i> application virtually impossible. The patch makes execution just
</I>&gt;&gt;<i> slightly slower than usual. The reporting code uses simple heuristics
</I>&gt;&gt;<i> to select the possible string allocation location - it attempts to
</I>&gt;&gt;<i> ignore all methods from assemblies installed in GAC, from corlib and,
</I>&gt;&gt;<i> should the two checks fail, from a list of assemblies and classes to
</I>&gt;&gt;<i> ignore. This is done based on the premise that the Mono runtime and
</I>&gt;&gt;<i> class libraries are case-sensitive and don't have the problem some
</I>&gt;&gt;<i> applications might have (there's actually an instance where that
</I>&gt;&gt;<i> assumption is incorrect - in System.Web we check for existence of
</I>&gt;&gt;<i> web.config, Web.config and Web.Config - but it's intended :)). The
</I>&gt;&gt;<i> results of the selection algorithm might not always be accurate, but
</I>&gt;&gt;<i> they should be close enough to aid the developer to spot the location
</I>&gt;&gt;<i> where string was allocated.
</I>&gt;&gt;<i> Please review and let me know if I can commit.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> marek
</I>&gt;&gt;<i> &lt;iomap-report.diff&gt;_______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033590.html">[Mono-dev] [PATCH] MONO_IOMAP reporting option - string	allocation locations
</A></li>
	<LI>Next message: <A HREF="033580.html">[Mono-dev] [Mono-list] WCF Service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33593">[ date ]</a>
              <a href="thread.html#33593">[ thread ]</a>
              <a href="subject.html#33593">[ subject ]</a>
              <a href="author.html#33593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
