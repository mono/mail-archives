<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Deadlock in System.Web.Caching.Cache class
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Deadlock%20in%20System.Web.Caching.Cache%20class&In-Reply-To=4AF5C7F9.5030002%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033447.html">
   <LINK REL="Next"  HREF="033451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Deadlock in System.Web.Caching.Cache class</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Deadlock%20in%20System.Web.Caching.Cache%20class&In-Reply-To=4AF5C7F9.5030002%40gmail.com"
       TITLE="[Mono-dev] Deadlock in System.Web.Caching.Cache class">grendel at twistedcode.net
       </A><BR>
    <I>Mon Nov  9 02:18:04 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033447.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
        <LI>Next message: <A HREF="033451.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33449">[ date ]</a>
              <a href="thread.html#33449">[ thread ]</a>
              <a href="subject.html#33449">[ subject ]</a>
              <a href="author.html#33449">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ivan Radovanovic wrote:
&gt;<i> Although this dead lock problem continues to potentially exists it seems 
</I>&gt;<i> that problem is after all OS specific - there is some weird behavior of 
</I>&gt;<i> fam/gamin reporting that bin/*.dll files are changed, causing ASP.Net 
</I>&gt;<i> runtime trying to restart application, while at the same time trying to 
</I>&gt;<i> compile *.aspx, *.ascx etc.
</I>The issue might be in FAM FileSystemWatcher backend then.

&gt;<i> Maybe deadlock can occur in normal conditions too (servicing some 
</I>&gt;<i> request that would need compiling of some control/page that is not 
</I>&gt;<i> compiled yet and replacing something in bin directory at the same time), 
</I>&gt;<i> but that should be rare enough :-)
</I>The BuildManager in 2.4 has some bugs indeed, which in certain cases can lead to deadlocks (it's, 
among others, related to recursive dependencies between application files). For that reason I 
rewrote BuildManager for 2.6+ - if the problem you're seeing turns out to be an issue with more than 
few environments, I can just copy the new code to 2.4 branch for a future release. If you can come 
up with a test case that triggers the issue on your system, then please file a bug report and attach 
the testcase including OS/environment details.

marek
&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> 
</I>&gt;<i> Ivan Radovanovic napisa:
</I>&gt;&gt;<i> Hello, I am experiencing weird deadlock in .net applications running 
</I>&gt;&gt;<i> latest release version of mono (2.4.2.3) on FreeBSD (I don't think it is 
</I>&gt;&gt;<i> OS specific, and it doesn't show all the times, but still often enough 
</I>&gt;&gt;<i> so I can trace it)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Stack from thread 1:
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.RemoveVirtualPathFromCaches(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.OnVirtualPathChanged(System.String 
</I>&gt;&gt;<i> key, System.Object value, CacheItemRemovedReason removedReason)
</I>&gt;&gt;<i>    at System.Web.Caching.Cache.InvokePrivateCallbacks()
</I>&gt;&gt;<i>    at System.Web.HttpRuntime.ShutdownAppDomain(System.Object args)
</I>&gt;&gt;<i> ====================================================================
</I>&gt;&gt;<i> Stack from thread 2:
</I>&gt;&gt;<i>    at System.Web.Caching.Cache.Add(System.String key, System.Object 
</I>&gt;&gt;<i> value, System.Web.Caching.CacheDependency dependencies, DateTime 
</I>&gt;&gt;<i> absoluteExpiration, TimeSpan slidingExpiration, CacheItemPriority 
</I>&gt;&gt;<i> priority, System.Web.Caching.CacheItemRemovedCallback onRemoveCallback)
</I>&gt;&gt;<i>    at System.Web.Compilation.BuildManager.AddToCache(System.String 
</I>&gt;&gt;<i> virtualPath, System.Web.Compilation.BuildProvider bp)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.GenerateAssembly(System.Web.Compilation.AssemblyBuilder 
</I>&gt;&gt;<i> abuilder, System.Collections.Generic.List`1 buildItems, 
</I>&gt;&gt;<i> System.Web.VirtualPath virtualPath, BuildKind buildKind)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspComponentFoundry+TagNameFoundry.LoadType()
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.GetType(System.String 
</I>&gt;&gt;<i> componentName, System.String ByRef source, System.String ByRef ns)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.CreateComponent(System.Web.Compilation.Foundry 
</I>&gt;&gt;<i> foundry, System.String tagName, System.String prefix, System.String tag)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.GetComponent(System.String 
</I>&gt;&gt;<i> tagName)
</I>&gt;&gt;<i>    at System.Web.UI.RootBuilder.GetChildControlType(System.String 
</I>&gt;&gt;<i> tagName, IDictionary attribs)
</I>&gt;&gt;<i>    at System.Web.UI.ControlBuilder.CreateSubBuilder(System.String tagid, 
</I>&gt;&gt;<i> System.Collections.Hashtable atts, System.Type childType, 
</I>&gt;&gt;<i> System.Web.UI.TemplateParser parser, ILocation location)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.ProcessTag(ILocation location, 
</I>&gt;&gt;<i> System.String tagid, System.Web.Compilation.TagAttributes atts, TagType 
</I>&gt;&gt;<i> tagtype, Boolean ByRef ignored)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.TagParsed(ILocation location, 
</I>&gt;&gt;<i> TagType tagtype, System.String tagid, 
</I>&gt;&gt;<i> System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspParser.OnTagParsed(TagType tagtype, 
</I>&gt;&gt;<i> System.String id, System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspParser.Parse()
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.Parse(System.IO.TextReader 
</I>&gt;&gt;<i> reader, System.String filename, Boolean doInitParser)
</I>&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.Parse()
</I>&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.get_CodeCompilerType()
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCodeDomProviderType(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;<i> provider)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager+BuildItem..ctor(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;<i> provider)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.LoadBuildProviders(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath, System.String virtualDir, 
</I>&gt;&gt;<i> System.Collections.Generic.Dictionary`2 vpCache, BuildKind ByRef kind, 
</I>&gt;&gt;<i> System.String ByRef assemblyBaseName)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspComponentFoundry+TagNameFoundry.LoadType()
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry+TagNameFoundry.GetType(System.String 
</I>&gt;&gt;<i> componentName, System.String ByRef source, System.String ByRef ns)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.CreateComponent(System.Web.Compilation.Foundry 
</I>&gt;&gt;<i> foundry, System.String tagName, System.String prefix, System.String tag)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.AspComponentFoundry.GetComponent(System.String 
</I>&gt;&gt;<i> tagName)
</I>&gt;&gt;<i>    at System.Web.UI.RootBuilder.GetChildControlType(System.String 
</I>&gt;&gt;<i> tagName, IDictionary attribs)
</I>&gt;&gt;<i>    at System.Web.UI.ControlBuilder.CreateSubBuilder(System.String tagid, 
</I>&gt;&gt;<i> System.Collections.Hashtable atts, System.Type childType, 
</I>&gt;&gt;<i> System.Web.UI.TemplateParser parser, ILocation location)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.ProcessTag(ILocation location, 
</I>&gt;&gt;<i> System.String tagid, System.Web.Compilation.TagAttributes atts, TagType 
</I>&gt;&gt;<i> tagtype, Boolean ByRef ignored)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.TagParsed(ILocation location, 
</I>&gt;&gt;<i> TagType tagtype, System.String tagid, 
</I>&gt;&gt;<i> System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspParser.OnTagParsed(TagType tagtype, 
</I>&gt;&gt;<i> System.String id, System.Web.Compilation.TagAttributes attributes)
</I>&gt;&gt;<i>    at System.Web.Compilation.AspParser.Parse()
</I>&gt;&gt;<i>    at System.Web.Compilation.AspGenerator.Parse(System.IO.TextReader 
</I>&gt;&gt;<i> reader, System.String filename, Boolean doInitParser)
</I>&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.Parse()
</I>&gt;&gt;<i>    at System.Web.Compilation.GenericBuildProvider`1.get_CodeCompilerType()
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.GetCodeDomProviderType(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;<i> provider)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager+BuildItem..ctor(System.Web.Compilation.BuildProvider 
</I>&gt;&gt;<i> provider)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.LoadBuildProviders(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath, System.String virtualDir, 
</I>&gt;&gt;<i> System.Collections.Generic.Dictionary`2 vpCache, BuildKind ByRef kind, 
</I>&gt;&gt;<i> System.String ByRef assemblyBaseName)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.BuildAssembly(System.Web.VirtualPath 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at System.Web.Compilation.BuildManager.GetCompiledType(System.String 
</I>&gt;&gt;<i> virtualPath)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.CreateInstanceFromVirtualPath(System.String 
</I>&gt;&gt;<i> virtualPath, System.Type requiredBaseType)
</I>&gt;&gt;<i>    at System.Web.UI.PageParser.GetCompiledPageInstance(System.String 
</I>&gt;&gt;<i> virtualPath, System.String inputFile, System.Web.HttpContext context)
</I>&gt;&gt;<i>    at System.Web.UI.PageHandlerFactory.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;<i> context, System.String requestType, System.String url, System.String path)
</I>&gt;&gt;<i>    at System.Web.HttpApplication.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;<i> context, System.String url, Boolean ignoreContextHandler)
</I>&gt;&gt;<i>    at System.Web.HttpApplication.GetHandler(System.Web.HttpContext 
</I>&gt;&gt;<i> context, System.String url)
</I>&gt;&gt;<i>    at System.Web.HttpApplication+&lt;Pipeline&gt;c__Iterator2.MoveNext()
</I>&gt;&gt;<i>    at System.Web.HttpApplication.Tick()
</I>&gt;&gt;<i>    at System.Web.HttpApplication.Start(System.Object x)
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> System.Web.HttpApplication.System.Web.IHttpHandler.ProcessRequest(System.Web.HttpContext 
</I>&gt;&gt;<i> context)
</I>&gt;&gt;<i>    at System.Web.HttpRuntime.Process(System.Web.HttpWorkerRequest req)
</I>&gt;&gt;<i>    at System.Web.HttpRuntime.RealProcessRequest(System.Object o)
</I>&gt;&gt;<i>    at System.Web.HttpRuntime.ProcessRequest(System.Web.HttpWorkerRequest 
</I>&gt;&gt;<i> wr)
</I>&gt;&gt;<i>    at Mono.WebServer.MonoWorkerRequest.ProcessRequest()
</I>&gt;&gt;<i>    at 
</I>&gt;&gt;<i> Mono.WebServer.BaseApplicationHost.ProcessRequest(Mono.WebServer.MonoWorkerRequest 
</I>&gt;&gt;<i> mwr)
</I>&gt;&gt;<i>    at Mono.WebServer.XSPApplicationHost.ProcessRequest(Int32 reqId, 
</I>&gt;&gt;<i> Int64 localEPAddr, Int32 localEPPort, Int64 remoteEPAdds, Int32 
</I>&gt;&gt;<i> remoteEPPort, System.String verb, System.String path, System.String 
</I>&gt;&gt;<i> queryString, System.String protocol, System.Byte[] inputBuffer, 
</I>&gt;&gt;<i> System.String redirect, IntPtr socket, Mono.WebServer.SslInformations ssl)
</I>&gt;&gt;<i>    at Mono.WebServer.XSPWorker.RunInternal(System.Object state)
</I>&gt;&gt;<i> =============================================================================== 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As you can see there is deadlock between 
</I>&gt;&gt;<i> System.Web.Compilation.BuildManager.AddToCache (thread 2, second item) 
</I>&gt;&gt;<i> and System.Web.Compilation.BuildManager.GenerateAssembly (both using 
</I>&gt;&gt;<i> lock (buildCacheLock)) and between System.Web.Caching.Cache.Add and 
</I>&gt;&gt;<i> System.Web.Caching.Cache.InvokePrivateCallbacks() (both using lock(cache))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am curious if someone is working on this bug (is this known bug?) or I 
</I>&gt;&gt;<i> should try to fix it myself?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards,
</I>&gt;&gt;<i> Ivan
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033447.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
	<LI>Next message: <A HREF="033451.html">[Mono-dev] Deadlock in System.Web.Caching.Cache class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33449">[ date ]</a>
              <a href="thread.html#33449">[ thread ]</a>
              <a href="subject.html#33449">[ subject ]</a>
              <a href="author.html#33449">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
