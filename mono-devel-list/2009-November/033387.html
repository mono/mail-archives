<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Heap snapshots in the loggin profiler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Heap%20snapshots%20in%20the%20loggin%20profiler&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033392.html">
   <LINK REL="Next"  HREF="033400.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Heap snapshots in the loggin profiler</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Heap%20snapshots%20in%20the%20loggin%20profiler&In-Reply-To="
       TITLE="[Mono-dev] Heap snapshots in the loggin profiler">massi at ximian.com
       </A><BR>
    <I>Sun Nov  1 12:18:10 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033392.html">[Mono-dev] [PATCH] Use trampolines for vtable fixups (Windows)	(updated)
</A></li>
        <LI>Next message: <A HREF="033400.html">[Mono-dev] mkbundle + System.Text.GetEncoding	=	NotSupportedException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33387">[ date ]</a>
              <a href="thread.html#33387">[ thread ]</a>
              <a href="subject.html#33387">[ subject ]</a>
              <a href="author.html#33387">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
The logging profiler has support for heap snapshots (like heap-shot),
but it has never been perfect.

This mail wants to explain what's wrong, and why I think it's better
concentrating on making it work with sgen instead of insisting in trying
it with Bohem (unless we are willing to implement a proper profiling API
for Bohem).

The heap profiling API in Mono is simply non-existant.
There are hooks for object creation and GC, but there is no API to
interact with the heap as a whole.
So it's not possible to iterate through all the current heap objects,
and it's not possible to be notified when the GC frees some object.

Therefore a profiler has to do all the bookkeeping by itself.

When heap profiling is requested, currently the logging profiler keeps a
&quot;mirror&quot; of the heap in internal buffers: for each allocated MonoObject
a pointer to it is stored there.
At each collection, just after the &quot;mark&quot; phase, the profiler scans
these buffers and for each object it calls &quot;mono_object_is_alive&quot;.
The problem is that this is not reliable: &quot;mono_object_is_alive&quot; was not
meant to be a public function.
And in fact sometimes the heap snapshots are wrong (or the profiler
crashes).

A &quot;workaround&quot;, suggested by Paolo, is to use GC handles to tell if
objects are alive.

This would be reliable, and in fact it mostly works.
And it would have the nice effect of making it easy to cope with sgen
when it moves objects: mono_gchandle_get_target would give the profiler
the new object location.

However, this approach has its downsides...

For each object, in principle it would be necessary to only store the GC
handle instead of the MonoObject* pointer.
In practice the profiler needs to emit information also when the object
has been freed, therefore the profiler must store at least the GC handle
and the MonoClass*, and in practice also the MonoObject*.
Moreover, working with GC handles I had some very strange deadlock
during collections.

The deadlocks could of course be solved.

But the resulting profiler keeps one GC handle for *every* allocated
object (this makes the GC handle tables huge), and on top of that it
stores three pointer sized values for each object in the profiler
tables.
Of course everything works anyway in &quot;common&quot; cases, but IMHO the memory
overhead is a bit too large.


The solution would be having a proper profiling API which allows the
profiler to walk the heap, object by object.

Or, even better, to have an API that provides the following hooks:
- Allocation-deallocation of a &quot;block&quot; of memory by the GC (the callback
would receive the block address and size, as well as its &quot;intended use&quot;
in the GC).
- Info of the fact that an object has been moved (old and new address
would be provided).
- Given a block of memory, the ability to &quot;walk&quot; it iterating all the
MonoObject it contains.
- The possibility to iterate among all the &quot;blocks&quot; currently used by
the GC (in case the profiler does not want to keep track of the blocks
by itself).

The last two API entry points (iteration of all heap &quot;memory blocks&quot; and
of all objects inside a given block) should be used only when the world
is stopped (during a collection).

The above API would have the following advantages:
- it would make implementing heap snapshots trivial, with no memory
overhead in the profiler, and
- it would also allow to profile how the GC is efficient in its block
usage.

I've had a chat with Mark, and I happily sow that he already implemented
most of this by itself while developing sgen.
His hooks write into a file that is then post processed by a script.

Of course in principle it would be possible to do this with Bohem.
But I really don't think it would be worth doing at this point.
It would be useful only if it worked out of the box on an &quot;old&quot; Mono
runtime, to profile production systems with the new heap profiler.
But I don't think this is going to be easy.

I am attaching the patch that makes the logging profiler use GC handles
to track objects, simply because I did it, and I don't want it to get
lost.
But I am not going to commit it, I don't think it's worth it.

Ciao!
  Massi

-------------- next part --------------
A non-text attachment was scrubbed...
Name: gc-handles-heap-shot.patch
Type: text/x-patch
Size: 14304 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20091101/70088d37/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20091101/70088d37/attachment.bin</A> 
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033392.html">[Mono-dev] [PATCH] Use trampolines for vtable fixups (Windows)	(updated)
</A></li>
	<LI>Next message: <A HREF="033400.html">[Mono-dev] mkbundle + System.Text.GetEncoding	=	NotSupportedException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33387">[ date ]</a>
              <a href="thread.html#33387">[ thread ]</a>
              <a href="subject.html#33387">[ subject ]</a>
              <a href="author.html#33387">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
