<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Arm9 NS9215 floating point troubles
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Arm9%20NS9215%20floating%20point%20troubles&In-Reply-To=C81ADC20-FDF8-4106-8746-3B8A6811E92E%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035249.html">
   <LINK REL="Next"  HREF="035258.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Arm9 NS9215 floating point troubles</H1>
    <B>Trevor Ackerman</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Arm9%20NS9215%20floating%20point%20troubles&In-Reply-To=C81ADC20-FDF8-4106-8746-3B8A6811E92E%40novell.com"
       TITLE="[Mono-dev] Arm9 NS9215 floating point troubles">t_ackerman at yahoo.com
       </A><BR>
    <I>Fri Jun 18 11:24:36 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035249.html">[Mono-dev] Arm9 NS9215 floating point troubles
</A></li>
        <LI>Next message: <A HREF="035258.html">[Mono-dev] Arm9 NS9215 floating point troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35257">[ date ]</a>
              <a href="thread.html#35257">[ thread ]</a>
              <a href="subject.html#35257">[ subject ]</a>
              <a href="author.html#35257">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I believe it is armel, here's what 'file' reports for a natively compiled C program.

hello_world_c: ELF 32-bit LSB executable, ARM, version 1, dynamically linked (uses shared libs), not stripped.

Let me know if you still believe it is a bug and how I may contribute a solution, whether the example change I posted is appropriate or not.

Thanks

--- On Thu, 6/17/10, Geoff Norton &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gnorton at novell.com</A>&gt; wrote:

From: Geoff Norton &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gnorton at novell.com</A>&gt;
Subject: Re: [Mono-dev] Arm9 NS9215 floating point troubles
To: &quot;Trevor Ackerman&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">t_ackerman at yahoo.com</A>&gt;
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Date: Thursday, June 17, 2010, 9:54 PM

Is your system armeb or armel?
It could be a endian bug in our softfloat impl somewhere.
-g
On 2010-06-17, at 7:54 PM, Trevor Ackerman wrote:
I have more to report.

I wrote a quick native C program to print out the bytes of a float and double variable that were assigned the literal value 1.0f. 

Then in the mono 2.6.4 routine mono_method_to_ir in source code file mono/mini/method_to_ir.c I dumped out the bytes of ip (instruction pointer) used for the double value in the case for CEE_LDC_R8.

I discovered that the bytes in the double value used on mono had the high and low 32 bits swapped compared to those produced by the native C program. I hacked the routine decompose_soft_float to swap the high and low words and now I have no troubles and the basic-float regression test passes 100%.

Although this happens to work, I have a hard time believing that this is the correct solution to my problem. I feel that others are probably using ARM9 without
 floating point issues and that I am probably missing something in how I built mono for my platform. If anyone can shed some light on what I did wrong with building mono that'd be great. Of course if this is the correct action to take please let me know that too and how I may contribute the change back to the trunk (assuming that the trunk doesn't work which I haven't had time to test yet).

In the meantime here's my hack to decompose_soft_float in method-to-ir.c


&#160;5073&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; case OP_R8CONST: {
&#160;5074&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; unsigned char *ucp = (unsigned char *) ins-&gt;inst_p0;
&#160;5075&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; unsigned char
 rawval[8];
&#160;5076&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; printf(&quot;decompose_soft_float OP_R8CONST\n&quot;);
&#160;5077&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[0] =
 ucp[4];
&#160;5078&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[1] = ucp[5];
&#160;5079&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[2] = ucp[6];
&#160;5080&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[3] = ucp[7];
&#160;5081&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[4] = ucp[0];
&#160;5082&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[5] = ucp[1];
&#160;5083&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[6] = ucp[2];
&#160;5084&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rawval[7] = ucp[3];
&#160;5085&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; DVal d;
&#160;5086
 //&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; d.vald = *(double*)ins-&gt;inst_p0;
&#160;5087&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; d.vald = *(double*)rawval;
&#160;5088&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; MONO_EMIT_NEW_I8CONST (cfg, ins-&gt;dreg, d.vall);
&#160;5089&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; break;
&#160;5090&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }

--- On Thu, 6/17/10, Trevor Ackerman &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">t_ackerman at yahoo.com</A>&gt; wrote:

From: Trevor Ackerman
 &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">t_ackerman at yahoo.com</A>&gt;
Subject: Re: [Mono-dev] Arm9 NS9215 floating point troubles
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Date: Thursday, June 17, 2010, 11:31 AM

Good suggestion but that did not change the results.

--- On Thu, 6/17/10, Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:

From: Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt;
Subject: Re: [Mono-dev] Arm9 NS9215 floating point troubles
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Date: Thursday, June 17, 2010, 10:53 AM

On 17.06.2010 18:07, Trevor Ackerman wrote:
&gt;<i> I have been able to cross-compile Mono 2.6.4 for the NS9215 (no fpu
</I>&gt;<i> afaik) and I'm having trouble with floats when executing
</I> code.

...

&gt;<i> My CFLAGS and CPPFLAGS environment variables are
</I>&gt;<i>&#160;&#160;&#160;both
</I>&gt;<i> -DARM_FPU_NONE=1 -DMONO_ARCH_SOFT_FLOAT=1
</I>
-DNO_UNALIGNED_ACCESS is probably needed as
 well.

Robert

_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>









      
-----Inline Attachment Follows-----

_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>



      _______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>




      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100618/0aa11154/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100618/0aa11154/attachment-0001.html</A> 
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035249.html">[Mono-dev] Arm9 NS9215 floating point troubles
</A></li>
	<LI>Next message: <A HREF="035258.html">[Mono-dev] Arm9 NS9215 floating point troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35257">[ date ]</a>
              <a href="thread.html#35257">[ thread ]</a>
              <a href="subject.html#35257">[ subject ]</a>
              <a href="author.html#35257">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
