<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] SmtpClient minor bugs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20SmtpClient%20minor%20bugs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035158.html">
   <LINK REL="Next"  HREF="035159.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] SmtpClient minor bugs</H1>
    <B>Michal Bochnak</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20SmtpClient%20minor%20bugs&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] SmtpClient minor bugs">bochnak at hotmail.com
       </A><BR>
    <I>Fri Jun  4 17:00:32 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035158.html">[Mono-dev] Customizing Mono for a specific app
</A></li>
        <LI>Next message: <A HREF="035159.html">[Mono-dev] [PATCH] Block map support for sgen
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35307">[ date ]</a>
              <a href="thread.html#35307">[ thread ]</a>
              <a href="subject.html#35307">[ subject ]</a>
              <a href="author.html#35307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found two minor bugs while running Mono's implementation of SmtpClient.

 

1. Mail sent using Mono's SmtpClient always encodes mail addresses to format
&quot;display_name&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">email at email.com</A>&gt;, regardless of display name not being
provided. This results in delivered emails show in some mail clients (e.g.
Outlook) to come from an empty address. Here's a simple patch for it (2.6):



Index: SmtpClient.cs

===================================================================

--- SmtpClient.cs    (revision 158490)

+++ SmtpClient.cs    (working copy)

@@ -264,8 +264,13 @@

              

              private static string EncodeAddress(MailAddress address)

              {

-                    string encodedDisplayName =
ContentType.EncodeSubjectRFC2047 (address.DisplayName, Encoding.UTF8);

-                    return &quot;\&quot;&quot; + encodedDisplayName + &quot;\&quot; &lt;&quot; +
address.Address + &quot;&gt;&quot;;

+                    if (string.IsNullOrEmpty(address.DisplayName)) {

+                          return address.Address;

+                    }

+                    else {

+                          string encodedDisplayName =
ContentType.EncodeSubjectRFC2047 (address.DisplayName, Encoding.UTF8);

+                          return &quot;\&quot;&quot; + encodedDisplayName + &quot;\&quot; &lt;&quot; +
address.Address + &quot;&gt;&quot;;

+                    }

              }

 

              private static string EncodeAddresses(MailAddressCollection
addresses)

 

 

2. Upon delivery of mail, when recipient is rejected (or other recipient
error occurs), only status and recipient are preserved in
SmtpFailedRecipientException object. Original response is not preserved
which is a bug. Here's a fix for it (2.6):

 

Index: SmtpClient.cs

===================================================================

--- SmtpClient.cs    (revision 158490)

+++ SmtpClient.cs    (working copy)

@@ -621,17 +621,17 @@

                     for (int i = 0; i &lt; message.To.Count; i ++) {

                           status = SendCommand (&quot;RCPT TO:&lt;&quot; + message.To
[i].Address + '&gt;');

                           if (IsError (status)) 

-                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.To [i].Address));

+                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.To [i].Address, status.Description));

                     }

                     for (int i = 0; i &lt; message.CC.Count; i ++) {

                           status = SendCommand (&quot;RCPT TO:&lt;&quot; + message.CC
[i].Address + '&gt;');

                           if (IsError (status)) 

-                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.CC [i].Address));

+                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.CC [i].Address, status.Description));

                     }

                     for (int i = 0; i &lt; message.Bcc.Count; i ++) {

                           status = SendCommand (&quot;RCPT TO:&lt;&quot; + message.Bcc
[i].Address + '&gt;');

                           if (IsError (status)) 

-                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.Bcc [i].Address));

+                                 sfre.Add (new SmtpFailedRecipientException
(status.StatusCode, message.Bcc [i].Address, status.Description));

                     }

 

 #if TARGET_JVM // List&lt;T&gt;.ToArray () is not supported

 

 

I'm not sure if this is a proper way for submitting patches but it is
selfish and definitely the beginning of an adventure with Mono.
<A HREF="http://mono-project.com/Contributing">http://mono-project.com/Contributing</A>

Thank you!

Michal

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100604/d457d2dc/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100604/d457d2dc/attachment-0001.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035158.html">[Mono-dev] Customizing Mono for a specific app
</A></li>
	<LI>Next message: <A HREF="035159.html">[Mono-dev] [PATCH] Block map support for sgen
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35307">[ date ]</a>
              <a href="thread.html#35307">[ thread ]</a>
              <a href="subject.html#35307">[ subject ]</a>
              <a href="author.html#35307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
