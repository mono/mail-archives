<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Problem with EventWaitHandle.WaitOne(timeout) during	setting time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Problem%20with%20EventWaitHandle.WaitOne%28timeout%29%20during%0A%09setting%20time&In-Reply-To=%3CD65E55BF26234D4EB86607792CFF958507FC6AFC72%40CL-DE-EXMB-02.sma.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038432.html">
   <LINK REL="Next"  HREF="038439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Problem with EventWaitHandle.WaitOne(timeout) during	setting time</H1>
    <B>Mirko Wischer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Problem%20with%20EventWaitHandle.WaitOne%28timeout%29%20during%0A%09setting%20time&In-Reply-To=%3CD65E55BF26234D4EB86607792CFF958507FC6AFC72%40CL-DE-EXMB-02.sma.de%3E"
       TITLE="[Mono-dev] Problem with EventWaitHandle.WaitOne(timeout) during	setting time">Mirko.Wischer at sma.de
       </A><BR>
    <I>Tue Jan 17 11:58:44 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038432.html">[Mono-dev] Show-stopper bug in libodbc.cs
</A></li>
        <LI>Next message: <A HREF="038439.html">[Mono-dev] mono with CoreCLR: How to add custom assemblies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38436">[ date ]</a>
              <a href="thread.html#38436">[ thread ]</a>
              <a href="subject.html#38436">[ subject ]</a>
              <a href="author.html#38436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

we hit a problem concerning EventWaitHandle.WaitOne(timeout) in conjunction with
changing system time during long timeouts.
The problem only exists using named events. After a short analysis I think I found the main problem:


In the io-layer  the WaitForSingleObjectEx method uses _wapi_calc_timeout (from misc.c) to compute

an absolute time from the given timeout, but the absolute timeout is computed using &quot;gettimeofday&quot;.

That will cause problems if the system clock changes during checking (named events spin through fake timeouts

until the absolute timeout seems to be reached).
                Unnamed events also use the _wapi_calc_timeout method to compute the absolute timeout. This timeout is
then used in mono_cond_timedwait (but this only wraps &quot;normal&quot; pthread conditions).
So I prepared a patch (see attached files) using clock_gettime(CLOCK_MONOTONIC,..) instead of gettimeofday, but this also requires
a change for unnamed events, because the pthreads condition needs to know what kind of clock provides the
absolute timeout.

This seems to fix the issue for us.  Is this an appropriate way to fix this? What do you think.
_wapi_calc_timeout is also used in some other timeout relevant functions, but I just found
the &quot;faketimeout&quot; way of checking the absolute timeout and the mono_cond_timed_wait.
Or do I miss some occurrences/cases checking the absolute timeout.

Thanks for looking at this.

CU Mirko





___________________________________________________

SMA Solar Technology AG
Aufsichtsrat: Guenther Cramer (Vorsitzender)
Vorstand: Juergen Dolle, Roland Grebe, Pierre-Pascal Urbon, Marko Werner
Handelsregister: Amtsgericht Kassel HRB 3972
Sitz der Gesellschaft: 34266 Niestetal
USt-ID-Nr. DE 113 08 59 54
WEEE-Reg.-Nr. DE 95881150
___________________________________________________
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: EventHandle_WaitOne.patch
Type: application/octet-stream
Size: 902 bytes
Desc: EventHandle_WaitOne.patch
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment.obj</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: EventHandle_WaitOne2.patch
Type: application/octet-stream
Size: 473 bytes
Desc: EventHandle_WaitOne2.patch
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment-0001.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120117/455f14c9/attachment-0001.obj</A>&gt;
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038432.html">[Mono-dev] Show-stopper bug in libodbc.cs
</A></li>
	<LI>Next message: <A HREF="038439.html">[Mono-dev] mono with CoreCLR: How to add custom assemblies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38436">[ date ]</a>
              <a href="thread.html#38436">[ thread ]</a>
              <a href="subject.html#38436">[ subject ]</a>
              <a href="author.html#38436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
