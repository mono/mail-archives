<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] AOT compiler crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20compiler%20crash&In-Reply-To=%3CCAOqP6L0ka5JDynHmSNx1H5QSHxSjgx6zeRhLakBrOOj-6R54Aw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038477.html">
   <LINK REL="Next"  HREF="038478.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] AOT compiler crash</H1>
    <B>Michael Bayne</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20compiler%20crash&In-Reply-To=%3CCAOqP6L0ka5JDynHmSNx1H5QSHxSjgx6zeRhLakBrOOj-6R54Aw%40mail.gmail.com%3E"
       TITLE="[Mono-dev] AOT compiler crash">mdb at samskivert.com
       </A><BR>
    <I>Fri Jan 20 20:44:01 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038477.html">[Mono-dev] AOT compiler crash
</A></li>
        <LI>Next message: <A HREF="038478.html">[Mono-dev] AOT compiler crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38473">[ date ]</a>
              <a href="thread.html#38473">[ thread ]</a>
              <a href="subject.html#38473">[ subject ]</a>
              <a href="author.html#38473">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jan 20, 2012 at 11:38 AM, Michael Bayne &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mdb at samskivert.com</A>&gt; wrote:
&gt;<i> since I don't have the source
</I>
I guess this isn't completely true. I can at least look at the mono
source and try to triangulate from there. Based on that, I'm seeing
only two likely callers of mono_marshal_get_delegate_begin_invoke,
which is what contains the failing assert:

	g_assert (method &amp;&amp; method-&gt;klass-&gt;parent ==
mono_defaults.multicastdelegate_class &amp;&amp;
		  !strcmp (method-&gt;name, &quot;BeginInvoke&quot;));

One in mini/aot-compiler.c:

		if (klass-&gt;delegate &amp;&amp; klass != mono_defaults.delegate_class &amp;&amp;
klass != mono_defaults.multicastdelegate_class &amp;&amp;
!klass-&gt;generic_container) {
			method = mono_get_delegate_invoke (klass);
...
			method = mono_class_get_method_from_name_flags (klass, &quot;BeginInvoke&quot;, -1, 0);
			if (method)
				add_method (acfg, mono_marshal_get_delegate_begin_invoke (method));

which seems to meet two of the failing assert conditions (that method
be non-null and that the method name be &quot;BeginInvoke&quot;), which leaves
the possibility of method-&gt;klass-&gt;parent not being
mono_defaults.multicastdelegate_class.

The other caller in mini/mini.c:

		if (method-&gt;klass-&gt;parent == mono_defaults.multicastdelegate_class) {
			if (*name == '.' &amp;&amp; (strcmp (name, &quot;.ctor&quot;) == 0)) {
...
			} else if (*name == 'I' &amp;&amp; (strcmp (name, &quot;Invoke&quot;) == 0)) {
...
			} else if (*name == 'B' &amp;&amp; (strcmp (name, &quot;BeginInvoke&quot;) == 0)) {
				nm = mono_marshal_get_delegate_begin_invoke (method);
				return mono_get_addr_from_ftnptr (mono_compile_method (nm));

seems to meet all three conditions, so I'm suspecting the first caller.

&gt;<i> Can someone point me in the direction of what useful debugging
</I>&gt;<i> information I can obtain to help pin-point the issue (if it's
</I>&gt;<i> something weird that IKVM is doing, I can certainly fix that).
</I>
I tried running arm-darwin-mono in gdb, but I can't seem to set a
breakpoint on mono_marshal_get_delegate_begin_invoke. I'm not super
fluent in Mac OS native development, but maybe that binary lacks
debugging symbols? (Is there a way to make otool show those?)

Just going off the hunch that maybe IKVM is generating a funny
delegate (that contains BeginInvoke but doesn't extend
MulticastDelegate), I tried running monodis on IKVM.OpenJDK.Core.dll.
Tragically that crashes with a bus error in:

0x0000f459 in dis_stringify_method_signature_full (m=0x902200,
method=0x0, methoddef_row=869, container=0x0, fully_qualified=0,
with_marshal_info=1) at get.c:913

before it gets very far into the dll.

Is it possible for me to rebuild arm-darwin-mono with debug symbols
based on the mono source checked out from Github? I don't know to what
extent the shipped version of MonoTouch differs from the open source
code on that front.

Thanks again for any pointers,

Michael

-- <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mdb at samskivert.com</A>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038477.html">[Mono-dev] AOT compiler crash
</A></li>
	<LI>Next message: <A HREF="038478.html">[Mono-dev] AOT compiler crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38473">[ date ]</a>
              <a href="thread.html#38473">[ thread ]</a>
              <a href="subject.html#38473">[ subject ]</a>
              <a href="author.html#38473">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
