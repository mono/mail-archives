<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Re: [Mono-devel-list] System.Data : DataTable.Select	performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20%5BMono-devel-list%5D%20System.Data%20%3A%20DataTable.Select%0A%09performance&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014816.html">
   <LINK REL="Next"  HREF="014861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Re: [Mono-devel-list] System.Data : DataTable.Select	performance</H1>
    <B>T Sureshkumar</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20%5BMono-devel-list%5D%20System.Data%20%3A%20DataTable.Select%0A%09performance&In-Reply-To="
       TITLE="[Mono-dev] Re: [Mono-devel-list] System.Data : DataTable.Select	performance">tsureshkumar at novell.com
       </A><BR>
    <I>Sun Sep 18 13:37:44 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014816.html">[Mono-dev] DataView.RowFilter trouble
</A></li>
        <LI>Next message: <A HREF="014861.html">[Mono-dev] [Gtk-sharp-list] GNOME 2.12 on Win32 and MonoDevelop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14817">[ date ]</a>
              <a href="thread.html#14817">[ thread ]</a>
              <a href="subject.html#14817">[ subject ]</a>
              <a href="author.html#14817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>sorry about re-posting. my previous attempt to mono-devel failed.

Novell Software Development (I) Private Limited
No. 49/1 &amp; 49/2, Garbebhavi Palya,
7th Mile, Hosur Road, BANGALORE - 560068,
Karnataka, INDIA 
Tel: 91-80-25731856/57 
Fax: 91-80- 25731870

&gt;&gt;&gt;<i> tsureshkumar&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsureshkumar at novell.com</A>&gt; 09/16/05 6:27 PM &gt;&gt;&gt;
</I>@@ -193,9 +206,14 @@
  				return false;
  			}
-			if (_filter != filter)
-				return false;
+			if (_filter != null) {
+				if (!_filter.Equals (filter))
+					return false;
+			}
+			else if (filter != null)
+					return false;

=======================================================
please review this conditional checking.
=======================================================

 &gt; @@ -640,6 +640,10 @@
 &gt; Table.RecordCache.DisposeRecord(Proposed);
 &gt;  				Proposed = -1;
 &gt; +
 &gt; +				int newVersion = (HasVersion &gt;
(DataRowVersion.Current)) ?
Current : Original;					
 &gt; +				foreach(Index index in Table.Indexes)
 &gt; +					index.Update(this,newVersion);					
=======================================================
why need to update indexes in CancelEdit. anyway, all values of the row
are removed?.
=======================================================

 &gt; @@ -1299,7 +1303,13 @@
 &gt;  				}
 &gt;  				CheckChildRows(DataRowAction.Rollback);
 &gt;
 &gt; -				Current = Original;
 &gt; +				if (Current != Original) {
 &gt; +					foreach(Index index in
Table.Indexes) {
 &gt; +						index.Delete (this);
 &gt; +						&gt;
index.Update(this,Original);
 &gt; +					}
 &gt; +					Current = Original;
 &gt; +				}

=======================================================
that means, wherever there is a pattern like this (even Original =
Current), we need to update indexes.

ChangLog is also missing.
=======================================================

 &gt; Hello all,
 &gt; The example attached demonstrates the performance problem in
 &gt; DataTable.Select - we run 30-40 times slower than .Net.
 &gt; The cause for this problem is creating a new index for each select
 &gt; executed without actually adding the newly created index into the
table
 &gt; indexes list.
 &gt;
 &gt; This patch improves a performance to be &quot;only&quot; 2 times slower than
.Net.
 &gt; Note that there is no performance improvement on the commented out
 &gt; section since indexes are created per each different select
expression.
 &gt;

that is good.


 &gt; There is two additional problems :
 &gt; - Not that overall number of the rows returned differs from .Net. It
is
 &gt; a separate bug (it happens before the update also).

is there a bug report?

 &gt; - As you can see, 
MonoTests_System.Data.DataTableTest2.Select_ByFilter
 &gt; fails fails with this fix. The failure is caused by the reason that
the
 &gt; previous test one throws an exception while executing Select() (as
 &gt; supposed), thus leaving the index in the inconsistent state, so
 &gt; additional Select() that reuses this index returns wrong result. The
 &gt; problem is a bit more general - there are some more cases we suppose
 &gt; index update or rebuild procedure to fail with exception, leaving
index
 &gt; in inconsistent state.

IMO, index should not become invalid. or when it becomes invalid, it
should auto correct itself.

 &gt;
 &gt; The question is what side we want to recognize the problem and to be
 &gt; responsible for removing the broken index : the index or the callee?
 &gt; Each of the solutions have both good and bad sides : solution on the
 &gt; index side looks bad because index needs to intervent into its parent
 &gt; object data structures and the callee side solution requires changes
in
 &gt; multiple places plus integration of the solution in each of the
future
 &gt; index uses.

Solution1 : delegate based mechanism to auto correct faulty indexes.
Solution2 : manually correct the index from the caller, when he finds
that index is wrong.

both are ok as long as we follow similar pattern for dealing with
indexes even though we repeat at many places.


regressions are not acceptable in favor of performance benefits. your3
patch introduces 1 regression in default profile and 2 regressions in
net_2_0 profile. But, the bug is somewhere with handling of the indexes.
  I guess that's why the indexes are not rebuilt with DataTable.Select
as well as DataRowCollection.Find method.

I think you can split your fix into

1. Equals implementations for expressions
2. Filter.Equals inside Key.Equals
3. Select method optimization.

We can check in 1 &amp; 2 and delay 3 until the fix for bug. Let's keep the
architecture ready and we can optimize when needed.

Regards,
suresh.

 &gt;
 &gt; Any critics/ideas on the issue?
 &gt;
 &gt; Thanks,
 &gt;
 &gt; --
 &gt; Boris Kirzner
 &gt; Mono R&amp;D team, Mainsoft Corporation.
 &gt; Blogging at <A HREF="http://boriskirzner.blogspot.com/">http://boriskirzner.blogspot.com/</A>





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014816.html">[Mono-dev] DataView.RowFilter trouble
</A></li>
	<LI>Next message: <A HREF="014861.html">[Mono-dev] [Gtk-sharp-list] GNOME 2.12 on Win32 and MonoDevelop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14817">[ date ]</a>
              <a href="thread.html#14817">[ thread ]</a>
              <a href="subject.html#14817">[ subject ]</a>
              <a href="author.html#14817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
