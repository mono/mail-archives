<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Remothing through HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Remothing%20through%20HTTPS&In-Reply-To=1126093179.14061.161.camel%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014613.html">
   <LINK REL="Next"  HREF="014782.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Remothing through HTTPS</H1>
    <B>Yngve Zackrisson</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Remothing%20through%20HTTPS&In-Reply-To=1126093179.14061.161.camel%40localhost.localdomain"
       TITLE="[Mono-dev] Remothing through HTTPS">yngve.zackrisson at mobila-kontoret.se
       </A><BR>
    <I>Thu Sep 15 06:27:25 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014613.html">[Mono-dev] Remothing through HTTPS
</A></li>
        <LI>Next message: <A HREF="014782.html">[Mono-dev] Remothing through HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14781">[ date ]</a>
              <a href="thread.html#14781">[ thread ]</a>
              <a href="subject.html#14781">[ subject ]</a>
              <a href="author.html#14781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I am still struggling with remoting and HTTPS:-).
After studying more I have a couple of questions:

A) Server certificate (for Linux / Mono): 

   On #75751 I questioned: 

   1) Is it posible to create the certificates with openssl in Linux 
      and use them in .NET (Linux and Mono on the server side 
      and Win32 and Microsoft .NET on the client side)?.
      Is there any 'HOWTODO-resouces' on this?.

   and I got the answer:

   (1) you best bet is to create the certificate (using OpenSSL) in the
   PKCS#12 format. This should make it easy to import on Windows and Mono
   can deal with this format.

   Current question:

   On Mono I have problem with getting the private key.

   I am doing a test server application to check the https communication 
   (using a &quot;Poupou's blog example and the XSP Web server as a base).
   I have succeeded creating the .p12 format.
   I also have the cert in DER (.cer) format and in .pem format.
   I also have the key in .pem format.
   On Mono I have problem with extraction of the private key from these files.
   AFAIK, one can get the key from the .pvk format through the 
   PrivateKey.CreateFromFile method.
   But how can I get the key in the .pvk format ?.



   Is there any other way to get the key?.




B) Server certificate to the Mono / Linux store: 

   Just checking if I got things right:

   I user the command: 

   $ mono /usr/lib/mono/certmgr.exe -add -c -m CA cacert.cer 

   $ mono /usr/lib/mono/certmgr.exe -add -c -m Trust server-certkey.cer 

   to load the CA cert (cacert.cer with in DER format) and 
   to load the server cert 
   (server certificate request are first signed and 
   then the server-cert.pem and server-key.pem are concatenated 
   with the cat command to server-certkey.pem 
   witch is then converted to server-certkey.cer in DER format).
   The CN should be the same as hostname.

   Do you find any error in the above procedure?



   Does the Mono SSL handle incomming httprequests automatically 
   or do I have to handle (for instance) the authentication in 
   the custom channel? (If so, any code to look at? XSP?).




C) Client side certificate handling in Win32.

   I use &quot;HttpWebRequest.ClientCertificates.Add(x509Certificate)&quot; 
   to set the client certificate.

   Below you wrote: 

&gt;<i> Using client certificates in this (remoting) setup may prove a little
</I>&gt;<i> more challenging as Fx1.x X509Certificate class has no notion of a
</I>&gt;<i> private key associated with the certificate. This may be fixed by doing
</I>&gt;<i> a custom remoting channel that use Mono.Security.dll (where you'll have
</I>&gt;<i> a callback to supply the private key for your client certificate).
</I>&gt;<i> 
</I>   
   Since I am no expert in this area (just have to try to be one 
   due to the current lack of SSL security .NET Remoting) 
   I just wonder if anyone can direct me to what to do.
   I have read (implemented) the MS articles about custom channels 
   and MS authentication, so I pretty much understand custom channels. 
   I ques that it is only the authentication I have to try to 
   implement in the custom channel?



   Are there any open source code (.NET Mono C#) - about 
   client side certificate authentication - I can download and read?.




Regards 



Yngve Zackrisson



On Wed, 2005-09-07 at 13:39, Sebastien Pouliot wrote:
&gt;<i> Hello Yngve,
</I>&gt;<i> 
</I>&gt;<i> On Wed, 2005-07-09 at 11:15 +0200, Yngve Zackrisson wrote:
</I>&gt;<i> &gt; Hi all.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I am doing an remoting application 
</I>&gt;<i> &gt; and have a Win32 Client with MS .NET v1.1
</I>&gt;<i> &gt; and a Linux (Fedora Core 3 x86) Server with Mono 1.1.8.3.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The different clients will call the remote objects methods 
</I>&gt;<i> &gt; on the server. 
</I>&gt;<i> &gt; Among other things the clients will upload a file to the server. 
</I>&gt;<i> &gt; I (now) only uses &quot;normal&quot; calls to upload a file - 
</I>&gt;<i> &gt; no &quot;callbacks&quot; any more.
</I>&gt;<i> &gt; The server will be located at our place.
</I>&gt;<i> &gt; The clients will be users of &quot;services&quot;, running on our server.
</I>&gt;<i> &gt; The remote objects is currently hosted by an Console application, 
</I>&gt;<i> &gt; but is planned to be hosted by a Windows service (on Linux / Mono :-)).
</I>&gt;<i> &gt; I have gotten this working with HTTP.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I now will try to do this with HTTPS (on port 443), 
</I>&gt;<i> &gt; to get a secure tunnel between the client and the server.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; We would like to use SSL with both encryption and authentication, 
</I>&gt;<i> &gt; through x509 certificates.
</I>&gt;<i> &gt; The certificates should (preferable) be self signed.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt;From my testings and readings I have found that: 
</I>&gt;<i> &gt; 1) My Win32 client uses Tls.
</I>&gt;<i> &gt; 2) The Win32 client certificates should be:
</I>&gt;<i> &gt;    a) Set in the ClientCertificates property of the HttpWebRequest.
</I>&gt;<i> &gt;    b) The client certificate must be installed in 
</I>&gt;<i> &gt;       the LOCAL_MACHINE registry hive.
</I>&gt;<i> &gt;    (Se: KB895971 at <A HREF="http://support.microsoft.com/?kbid=895971">http://support.microsoft.com/?kbid=895971</A>).
</I>&gt;<i> &gt; 3) .NET prefer the DER format (called .cer) 
</I>&gt;<i> &gt;    but may also use the .p12 format.
</I>&gt;<i> &gt; 4) From the Microsoft .NET documentation, 
</I>&gt;<i> &gt;    I have found support only for certificate authentication 
</I>&gt;<i> &gt;    through ASP.NET/IIS-hosting - In MS .NET v1.1.
</I>&gt;<i> &gt; 5) There is some support for SSL in Mono, 
</I>&gt;<i> &gt;    and I have succeeded to install certificates in Mono through certmgr 
</I>&gt;<i> &gt;    (but I may have done it wrong. No real test yet).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; What I wonder is weather this approach gonna work with .NET Remoting 
</I>&gt;<i> &gt; and with different Win32 MS .NET clients calling a Linux Mono server?.
</I>&gt;<i> 
</I>&gt;<i> Using client certificates in this (remoting) setup may prove a little
</I>&gt;<i> more challenging as Fx1.x X509Certificate class has no notion of a
</I>&gt;<i> private key associated with the certificate. This may be fixed by doing
</I>&gt;<i> a custom remoting channel that use Mono.Security.dll (where you'll have
</I>&gt;<i> a callback to supply the private key for your client certificate).
</I>&gt;<i> 
</I>&gt;<i> &gt; Do I have to customize any part of the SSL handshake?.
</I>&gt;<i> 
</I>&gt;<i> No. SSL/TLS is a negotiating protocol. You supply the certificates and
</I>&gt;<i> the rest gets done (well pretty much).
</I>&gt;<i> 
</I>&gt;<i> More details on SSL are available in the FAQ
</I>&gt;<i> <A HREF="http://www.mono-project.com/FAQ:_Security">http://www.mono-project.com/FAQ:_Security</A>
</I>&gt;<i> 
</I>&gt;<i> &gt; On the remote objects methods, I would like to have 
</I>&gt;<i> &gt; access checks on the users .NET Roles.
</I>&gt;<i> &gt; Is it possible to impersonate the principal and add .NET Roles 
</I>&gt;<i> &gt; to that principal when the remote objects is hosted in 
</I>&gt;<i> &gt; a Console application or a Windows service (in Linux / Mono)?.
</I>&gt;<i> 
</I>&gt;<i> You can't impersonate (in the win32 way) if your communication channel
</I>&gt;<i> doesn't support it (e.g. SSPI) - so this works only for _some_ win32
</I>&gt;<i> stuff.
</I>&gt;<i> 
</I>&gt;<i> You can always &quot;mimic&quot; the impersonation by transferring the identity in
</I>&gt;<i> a custom remoting channel (and setting the IPrincipal of the remote
</I>&gt;<i> object yourself). There are a lot of example for doing this on the net.
</I>&gt;<i> Alternatively you can create a new IPrincipal instance based on the
</I>&gt;<i> client certificate used by client client.
</I>&gt;<i> 
</I>&gt;<i> Lastly when using roles be sure to use imperative demands (e.g.
</I>&gt;<i> IPrincipal.IsInRole) and not declarative security attributes
</I>&gt;<i> (PrincipalPermission) unless you activate the security manager
</I>&gt;<i> (--security).
</I>&gt;<i> <A HREF="http://www.mono-project.com/CAS">http://www.mono-project.com/CAS</A>
</I>&gt;<i> 
</I>&gt;<i> &gt; Further, I am not really sure about how to set up the certificates 
</I>&gt;<i> &gt; on the Mono server for SSL.
</I>&gt;<i> 
</I>&gt;<i> See the FAQ and/or do a &quot;man certmgr&quot; in a terminal.
</I>&gt;<i> 
</I>&gt;<i> &gt; I assume the the certificates should be placed in the machine store.
</I>&gt;<i> 
</I>&gt;<i> That depends on what will be using the certificate.
</I>&gt;<i> 
</I>&gt;<i> &gt; I have the certificates in DER (.cer) format.
</I>&gt;<i> &gt; Should the CA certificate be placed in the CA store 
</I>&gt;<i> &gt; or in the Trust store?. Any more to think about?.
</I>&gt;<i> 
</I>&gt;<i> Self-signed certificates goes to the trusted store.
</I>&gt;<i> The CA store is for intermediate CA certificates.
</I>&gt;<i> 
</I>&gt;<i> &gt; I assume that the server certificate should be placed 
</I>&gt;<i> &gt; in the Trust store (of the machine store).
</I>&gt;<i> &gt; I hope this is right.
</I>&gt;<i> 
</I>&gt;<i> The machine store is handy if you don't know under which identity (user)
</I>&gt;<i> your program is gonna be executed (or if it may be executed by multiple
</I>&gt;<i> users on the same system). Otherwise keep your stuff in the user store.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014613.html">[Mono-dev] Remothing through HTTPS
</A></li>
	<LI>Next message: <A HREF="014782.html">[Mono-dev] Remothing through HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14781">[ date ]</a>
              <a href="thread.html#14781">[ thread ]</a>
              <a href="subject.html#14781">[ subject ]</a>
              <a href="author.html#14781">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
