<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]: Improve sparc I-cache flushing under Linux.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Improve%20sparc%20I-cache%20flushing%20under%20Linux.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025624.html">
   <LINK REL="Next"  HREF="025599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]: Improve sparc I-cache flushing under Linux.</H1>
    <B>David Miller</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Improve%20sparc%20I-cache%20flushing%20under%20Linux.&In-Reply-To="
       TITLE="[Mono-dev] [PATCH]: Improve sparc I-cache flushing under Linux.">davem at davemloft.net
       </A><BR>
    <I>Sat Nov  3 19:21:16 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025624.html">[Mono-dev] [PATCH]: Use sparc 'sethi' in more cases.
</A></li>
        <LI>Next message: <A HREF="025599.html">[Mono-dev] [PATCH]: Improve sparc I-cache flushing under Linux.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25544">[ date ]</a>
              <a href="thread.html#25544">[ thread ]</a>
              <a href="subject.html#25544">[ subject ]</a>
              <a href="author.html#25544">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On every UltraSPARC chip, it is sufficient to only flush
every 32-byte cache line.

As a future enhancement, if Niagara cpus are detected we can only
perform one flush instruction.  On Niagara the flush address is
completely ignored and the flush is only needed to synchronize the cpu
pipeline with previous stores.

I left the Solaris code as it is, calling sync_instruction_memory().
However, disassembling a test program shows that Solaris does not
optimize it properly and flushes every 8 bytes like the old code here
did.

I think it would be safe to have the Solaris case use the same code as
Linux so that both sides would get the performance improvement.

2007-11-03  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at huronp11.davemloft.net</A>&gt;

	* mini-sparc.c (mono_arch_flush_icache): Make more efficient
	under Linux.  We only need to flush every 32-byte cache line.

Index: mono/mini/mini-sparc.c
===================================================================
--- mono/mini/mini-sparc.c	(revision 88629)
+++ mono/mini/mini-sparc.c	(working copy)
@@ -293,18 +293,28 @@ mono_arch_flush_icache (guint8 *code, gi
 	/* Hopefully this is optimized based on the actual CPU */
 	sync_instruction_memory (code, size);
 #else
-	guint64 *p = (guint64*)code;
-	guint64 *end = (guint64*)(code + ((size + 8) /8));
-
-	/* 
-	 * FIXME: Flushing code in dword chunks in _slow_.
+	gulong start = (gulong) code;
+	gulong end = start + size;
+	gulong align;
+
+	/* Sparcv9 chips only need flushes on 32 byte
+	 * cacheline boundaries.
+	 *
+	 * Sparcv8 needs a flush every 8 bytes.
 	 */
-	while (p &lt; end)
+	align = (sparcv9 ? 32 : 8);
+
+	start &amp;= ~(align - 1);
+	end = (end + (align - 1)) &amp; ~(align - 1);
+
+	while (start &lt; end) {
 #ifdef __GNUC__
-		__asm__ __volatile__ (&quot;iflush %0&quot;::&quot;r&quot;(p++));
+		__asm__ __volatile__ (&quot;iflush %0&quot;::&quot;r&quot;(start));
 #else
-			flushi (p ++);
+		flushi (start);
 #endif
+		start += align;
+	}
 #endif
 }
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025624.html">[Mono-dev] [PATCH]: Use sparc 'sethi' in more cases.
</A></li>
	<LI>Next message: <A HREF="025599.html">[Mono-dev] [PATCH]: Improve sparc I-cache flushing under Linux.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25544">[ date ]</a>
              <a href="thread.html#25544">[ thread ]</a>
              <a href="subject.html#25544">[ subject ]</a>
              <a href="author.html#25544">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
