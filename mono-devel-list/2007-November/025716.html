<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Generic sharing: Static field access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20sharing%3A%20Static%20field%20access&In-Reply-To=295e750a0711191311s41f2ec84ob04b71b773c13d4d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025712.html">
   <LINK REL="Next"  HREF="025719.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Generic sharing: Static field access</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20sharing%3A%20Static%20field%20access&In-Reply-To=295e750a0711191311s41f2ec84ob04b71b773c13d4d%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Generic sharing: Static field access">lupus at ximian.com
       </A><BR>
    <I>Tue Nov 20 04:34:16 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025712.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
        <LI>Next message: <A HREF="025719.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25716">[ date ]</a>
              <a href="thread.html#25716">[ thread ]</a>
              <a href="subject.html#25716">[ subject ]</a>
              <a href="author.html#25716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/19/07 Zoltan Varga wrote:
&gt;<i>   The problem with the trampoline is that since the class to init is dynamically
</I>&gt;<i> decided, there is nothing to patch, so all calls will go through the
</I>&gt;<i> generic trampoline
</I>&gt;<i> code, which is much slower than a simple managed-to-native transition.
</I>
No, here is again the trampoline pseudo code I described in the first
email (vtable is in a register):

	deref vtable-&gt;initialized
	cmp/and/test
	condbranch slow_path:
	ret
slow_path:
	call class_init
	ret

We do the unmanaged transition only when the cctor has not been run yet.
The x86 implementation could be something like (with vtable in edx):

	test $INIT_BIT,initialize_offset(%edx)
	jz slow_path
	ret
slow_path:
	call class_init
	ret

The common path is 3 instructions, we need a single trampoline for all
the process and this works for both generics and AOT.
I think the tiny amount of arch-specific code is worth writing to avoid
the increased memory usage with the other solutions.
BTW, for AOT code we could put the above code inside the AOT image
itself, so it would be a direct call with no PLT entry involved.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025712.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
	<LI>Next message: <A HREF="025719.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25716">[ date ]</a>
              <a href="thread.html#25716">[ thread ]</a>
              <a href="subject.html#25716">[ subject ]</a>
              <a href="author.html#25716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
