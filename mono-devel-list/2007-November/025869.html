<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] InterOp problems with 1.2.6pre2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20InterOp%20problems%20with%201.2.6pre2&In-Reply-To=200711301836.39260.prakash%40punnoor.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025868.html">
   <LINK REL="Next"  HREF="025870.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] InterOp problems with 1.2.6pre2</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20InterOp%20problems%20with%201.2.6pre2&In-Reply-To=200711301836.39260.prakash%40punnoor.de"
       TITLE="[Mono-dev] InterOp problems with 1.2.6pre2">robertj at gmx.net
       </A><BR>
    <I>Fri Nov 30 14:18:22 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025868.html">[Mono-dev] InterOp problems with 1.2.6pre2
</A></li>
        <LI>Next message: <A HREF="025870.html">[Mono-dev] InterOp problems with 1.2.6pre2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25869">[ date ]</a>
              <a href="thread.html#25869">[ thread ]</a>
              <a href="subject.html#25869">[ subject ]</a>
              <a href="author.html#25869">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Prakash Punnoor wrote:
&gt;<i> Hi
</I>&gt;<i> 
</I>&gt;<i> I am wondering whether this problem is not interesting anyone? In the 
</I>&gt;<i> meanwhile I could pinpoint the troublemaker.
</I>
well, we'd be interested but you did not post a reproducible
test case.

&gt;<i> 
</I>&gt;<i> Basically it is a float[] field I declared in the struct Encoding context:
</I>&gt;<i> 
</I>
This doesn't look like a valid struct for p/invoke. Is this
the real code?

Aften's context does not declare a float array at this position.


Robert

&gt;<i> 	public struct EncodingContext
</I>&gt;<i> 	{
</I>&gt;<i> 		public EncodingParameters EncodingParameters;
</I>&gt;<i> 		public Metadata Metadata;
</I>&gt;<i> 		public Status Status;
</I>&gt;<i> 		public SystemParameters SystemParameters;
</I>&gt;<i> 		public int Verbosity;
</I>&gt;<i> 		public int Channels;
</I>&gt;<i> 		public AudioCodingMode AudioCodingMode;
</I>&gt;<i> 		public bool HasLfe;
</I>&gt;<i> 		public int SampleRate;
</I>&gt;<i> 		internal A52SampleFormat SampleFormat;
</I>&gt;<i> 
</I>&gt;<i> 		public float[] InitialSamples; // the trouble maker
</I>&gt;<i> 
</I>&gt;<i> 		private IntPtr m_Context;
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> and I have and InterOp like this:
</I>&gt;<i> 
</I>&gt;<i> 	public abstract class FrameEncoder
</I>&gt;<i> 	{
</I>&gt;<i> 		[DllImport( &quot;aften.dll&quot; )]
</I>&gt;<i> 		private static extern void aften_set_defaults( ref EncodingContext 
</I>&gt;<i> context );
</I>&gt;<i> 
</I>&gt;<i> 		public static EncodingContext GetDefaultsContext()
</I>&gt;<i> 		{
</I>&gt;<i> 			EncodingContext context = new EncodingContext();
</I>&gt;<i> 			aften_set_defaults( ref context );
</I>&gt;<i> 
</I>&gt;<i> 			return context;
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> This causes the crash/exception in mono (see quoted mail). So it doesn't have 
</I>&gt;<i> anything to do with generics as I suspected at first. If I change the float[] 
</I>&gt;<i> to IntPtr mono seems to work. As I said VS2008beta2 doesn't have any 
</I>&gt;<i> problems.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Prakash
</I>&gt;<i> 
</I>&gt;<i> On the day of Saturday 24 November 2007 Prakash Punnoor hast written:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> mono 1.2.6pre1 and pre2 on Linux x86_64 can't run some C# bindings to a C
</I>&gt;&gt;<i> library (an ac3 encoder), which works perfectly with vs2008beta2 and
</I>&gt;&gt;<i> .net2.0 target on x86.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can get the sources at <A HREF="http://sourceforge.net/projects/aften/">http://sourceforge.net/projects/aften/</A> in svn
</I>&gt;&gt;<i> (revision 659). Compile it using cmake. To build C# bindings,
</I>&gt;&gt;<i> pass -DBINDINGS_CS=1 to cmake. It worked with mono with the floating point
</I>&gt;&gt;<i> samples case before I switched the bindings to using generics to have other
</I>&gt;&gt;<i> types of samples supported (revision 651; though there were bugs in my code
</I>&gt;&gt;<i> at that time ;).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The testing code is this (remember the bindings are the troublemaker, not
</I>&gt;&gt;<i> this code):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using System;
</I>&gt;&gt;<i> using System.IO;
</I>&gt;&gt;<i> using System.Runtime.InteropServices;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using Aften;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> namespace AftenTest
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> 	class MainClass
</I>&gt;&gt;<i> 	{
</I>&gt;&gt;<i> 		public static int Main(string[] args)
</I>&gt;&gt;<i> 		{
</I>&gt;&gt;<i> 			Console.WriteLine(&quot;Aften AC3 Encoding Demo&quot;);
</I>&gt;&gt;<i> 			if (args.Length != 2)
</I>&gt;&gt;<i> 			{
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Console.WriteLine(&quot;Usage:
</I>&gt;&gt;<i> &quot;+Path.GetFileNameWithoutExtension(Environment.CommandLine)+&quot; &lt;input.wav&gt;
</I>&gt;&gt;<i> &lt;output.ac3&gt;&quot;);
</I>&gt;&gt;<i> 				return -1;
</I>&gt;&gt;<i> 			}
</I>&gt;&gt;<i> 			EncodingContext context = FrameEncoder.GetDefaultsContext();
</I>&gt;&gt;<i> 			context.Channels = 2;
</I>&gt;&gt;<i> 			context.AudioCodingMode = AudioCodingMode.Stereo;
</I>&gt;&gt;<i> 			context.SampleRate = 48000;
</I>&gt;&gt;<i> 			context.HasLfe = false;
</I>&gt;&gt;<i> 			context.SystemParameters.ThreadsCount = 1;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 			FrameEncoderInt16 encoder = new FrameEncoderInt16(ref context);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 			using (FileStream inputStream = new FileStream(args[0], FileMode.Open))
</I>&gt;&gt;<i> 			using (FileStream outputStream = new FileStream(args[1],
</I>&gt;&gt;<i> FileMode.CreateNew))
</I>&gt;&gt;<i> 			{
</I>&gt;&gt;<i> 				inputStream.Seek(44, SeekOrigin.Begin); //Skip WAVE header...
</I>&gt;&gt;<i> 				encoder.Encode(inputStream, outputStream);
</I>&gt;&gt;<i> 			}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 			Console.WriteLine(&quot;Done&quot;);
</I>&gt;&gt;<i> 			Console.ReadLine();
</I>&gt;&gt;<i> 			return 0;
</I>&gt;&gt;<i> 		}
</I>&gt;&gt;<i> 	}
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The error I get with mono:
</I>&gt;&gt;<i> mono  AftenTest.exe ~/Projects/bill.wav encoded.ac3
</I>&gt;&gt;<i> Aften AC3 Encoding Demo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ** ERROR **: Structure field of type Single[] can't be marshalled as
</I>&gt;&gt;<i> LPArray aborting...
</I>&gt;&gt;<i> Stacktrace:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at AftenTest.MainClass.Main (string[]) &lt;0xffffffff&gt;
</I>&gt;&gt;<i>   at AftenTest.MainClass.Main (string[]) &lt;0x000b8&gt;
</I>&gt;&gt;<i>   at (wrapper runtime-invoke)
</I>&gt;&gt;<i> AftenTest.MainClass.runtime_invoke_int_string[]
</I>&gt;&gt;<i> (object,intptr,intptr,intptr) &lt;0xffffffff&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Native stacktrace:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         mono [0x51fe5d]
</I>&gt;&gt;<i>         /lib/libpthread.so.0 [0x2b86da225880]
</I>&gt;&gt;<i>         /lib/libc.so.6(gsignal+0x35) [0x2b86da6e4fa5]
</I>&gt;&gt;<i>         /lib/libc.so.6(abort+0x110) [0x2b86da6e6a00]
</I>&gt;&gt;<i>         /usr/lib/libglib-2.0.so.0 [0x2b86d9d80dec]
</I>&gt;&gt;<i>         /usr/lib/libglib-2.0.so.0(g_log+0x83) [0x2b86d9d80e73]
</I>&gt;&gt;<i>         mono [0x48ba04]
</I>&gt;&gt;<i>         mono [0x48e297]
</I>&gt;&gt;<i>         mono [0x48f449]
</I>&gt;&gt;<i>         mono [0x493642]
</I>&gt;&gt;<i>         mono [0x4942db]
</I>&gt;&gt;<i>         mono [0x500646]
</I>&gt;&gt;<i>         mono [0x50bc76]
</I>&gt;&gt;<i>         mono [0x50d3da]
</I>&gt;&gt;<i>         mono [0x43df62]
</I>&gt;&gt;<i>         [0x4000015b]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Debug info from gdb:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Using host libthread_db library &quot;/lib/libthread_db.so.1&quot;.
</I>&gt;&gt;<i> [Thread debugging using libthread_db enabled]
</I>&gt;&gt;<i> [New Thread 0x2b86dac1bb40 (LWP 19911)]
</I>&gt;&gt;<i> [New Thread 0x40224950 (LWP 19913)]
</I>&gt;&gt;<i> [New Thread 0x40023950 (LWP 19912)]
</I>&gt;&gt;<i> 0x00002b86da22465b in read () from /lib/libpthread.so.0
</I>&gt;&gt;<i>   3 Thread 0x40023950 (LWP 19912)  0x00002b86da224f11 in nanosleep ()
</I>&gt;&gt;<i>    from /lib/libpthread.so.0
</I>&gt;&gt;<i>   2 Thread 0x40224950 (LWP 19913)  0x00002b86da221c39 in
</I>&gt;&gt;<i> pthread_cond_wait@@GLIBC_2.3.2 () from /lib/libpthread.so.0
</I>&gt;&gt;<i>   1 Thread 0x2b86dac1bb40 (LWP 19911)  0x00002b86da22465b in read ()
</I>&gt;&gt;<i>    from /lib/libpthread.so.0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thread 3 (Thread 0x40023950 (LWP 19912)):
</I>&gt;&gt;<i> #0  0x00002b86da224f11 in nanosleep () from /lib/libpthread.so.0
</I>&gt;&gt;<i> #1  0x00000000004d283f in collection_thread (unused=&lt;value optimized out&gt;)
</I>&gt;&gt;<i>     at collection.c:34
</I>&gt;&gt;<i> #2  0x00002b86da21d477 in start_thread () from /lib/libpthread.so.0
</I>&gt;&gt;<i> #3  0x00002b86da78b3ad in clone () from /lib/libc.so.6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thread 2 (Thread 0x40224950 (LWP 19913)):
</I>&gt;&gt;<i> #0  0x00002b86da221c39 in pthread_cond_wait@@GLIBC_2.3.2 ()
</I>&gt;&gt;<i>    from /lib/libpthread.so.0
</I>&gt;&gt;<i> #1  0x00000000004ce015 in timedwait_signal_poll_cond (cond=0x2aaaab6be268,
</I>&gt;&gt;<i>     mutex=0x2aaaab6be240, timeout=0x1, alertable=-1) at handles.c:1443
</I>&gt;&gt;<i> #2  0x00000000004d05eb in _wapi_handle_timedwait_signal_handle (
</I>&gt;&gt;<i>     handle=&lt;value optimized out&gt;, timeout=0x0, alertable=0) at
</I>&gt;&gt;<i> handles.c:1523 #3  0x00000000004c06af in WaitForSingleObjectEx
</I>&gt;&gt;<i> (handle=0x404,
</I>&gt;&gt;<i>     timeout=4294967295, alertable=0) at wait.c:200
</I>&gt;&gt;<i> #4  0x0000000000498db1 in finalizer_thread (unused=&lt;value optimized out&gt;)
</I>&gt;&gt;<i>     at gc.c:843
</I>&gt;&gt;<i> #5  0x0000000000480b53 in start_wrapper (data=&lt;value optimized out&gt;)
</I>&gt;&gt;<i>     at threads.c:550
</I>&gt;&gt;<i> #6  0x00000000004c2677 in thread_start_routine (args=0x2aaaab72a0d0)
</I>&gt;&gt;<i>     at threads.c:264
</I>&gt;&gt;<i> #7  0x00000000004db4f2 in GC_start_routine ()
</I>&gt;&gt;<i> #8  0x00002b86da21d477 in start_thread () from /lib/libpthread.so.0
</I>&gt;&gt;<i> #9  0x00002b86da78b3ad in clone () from /lib/libc.so.6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thread 1 (Thread 0x2b86dac1bb40 (LWP 19911)):
</I>&gt;&gt;<i> #0  0x00002b86da22465b in read () from /lib/libpthread.so.0
</I>&gt;&gt;<i> #1  0x00002b86d9da63e0 in read_ints () from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #2  0x00002b86d9da68c7 in fork_exec_with_pipes ()
</I>&gt;&gt;<i>    from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #3  0x00002b86d9da721f in g_spawn_sync () from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #4  0x00002b86d9da76d8 in g_spawn_command_line_sync ()
</I>&gt;&gt;<i>    from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #5  0x000000000051feee in mono_handle_native_sigsegv (
</I>&gt;&gt;<i>     signal=&lt;value optimized out&gt;, ctx=&lt;value optimized out&gt;)
</I>&gt;&gt;<i>     at mini-exceptions.c:1061
</I>&gt;&gt;<i> #6  &lt;signal handler called&gt;
</I>&gt;&gt;<i> #7  0x00002b86da6e4fa5 in raise () from /lib/libc.so.6
</I>&gt;&gt;<i> #8  0x00002b86da6e6a00 in abort () from /lib/libc.so.6
</I>&gt;&gt;<i> #9  0x00002b86d9d80dec in g_logv () from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #10 0x00002b86d9d80e73 in g_log () from /usr/lib/libglib-2.0.so.0
</I>&gt;&gt;<i> #11 0x000000000048ba04 in emit_struct_conv (mb=0x8fe000, klass=0x8abe88,
</I>&gt;&gt;<i>     to_object=1) at marshal.c:2758
</I>&gt;&gt;<i> #12 0x000000000048e297 in emit_marshal_vtype (m=&lt;value optimized out&gt;,
</I>&gt;&gt;<i>     argnum=0, t=0x8abf78, spec=&lt;value optimized out&gt;, conv_arg=3,
</I>&gt;&gt;<i>     conv_arg_type=&lt;value optimized out&gt;, action=&lt;value optimized out&gt;)
</I>&gt;&gt;<i>     at marshal.c:6192
</I>&gt;&gt;<i> #13 0x000000000048f449 in emit_marshal (m=0x7fffd1180200, argnum=0,
</I>&gt;&gt;<i>     t=0x8abf78, spec=0x0, conv_arg=3, conv_arg_type=0x0,
</I>&gt;&gt;<i>     action=MARSHAL_ACTION_CONV_OUT) at marshal.c:8357
</I>&gt;&gt;<i> #14 0x0000000000493642 in mono_marshal_emit_native_wrapper (
</I>&gt;&gt;<i>     image=&lt;value optimized out&gt;, mb=0x8fe000, sig=0x8bc940,
</I>&gt;&gt;<i> piinfo=0x8ae570, mspecs=0x8c1240, func=0x2aaaabcde7c0) at marshal.c:8584
</I>&gt;&gt;<i> #15 0x00000000004942db in mono_marshal_get_native_wrapper (method=0x8ae570)
</I>&gt;&gt;<i>     at marshal.c:8731
</I>&gt;&gt;<i> #16 0x0000000000500646 in mono_method_to_ir (cfg=0x8c9600, method=0x8b6c68,
</I>&gt;&gt;<i>     start_bblock=0x91aa00, end_bblock=0x91ab08, locals_offset=0,
</I>&gt;&gt;<i>     return_var=0x0, dont_inline=0x91f4e0, inline_args=0x0, inline_offset=0,
</I>&gt;&gt;<i>     is_virtual_call=0, shared_context=0x0) at mini.c:4817
</I>&gt;&gt;<i> #17 0x000000000050bc76 in mini_method_compile (method=0x8b6c68,
</I>&gt;&gt;<i> opts=5318911, domain=0x2aaaaab6ce00, run_cctors=&lt;value optimized out&gt;,
</I>&gt;&gt;<i>     compile_aot=&lt;value optimized out&gt;, parts=0) at mini.c:10728
</I>&gt;&gt;<i> #18 0x000000000050d3da in mono_jit_compile_method (method=0x8) at
</I>&gt;&gt;<i> mini.c:11141 #19 0x000000000043df62 in mono_magic_trampoline
</I>&gt;&gt;<i> (regs=0x7fffd1180a48, code=0x40010418 &quot;&#65533;&#65533;&quot;, m=0x8b6c68,
</I>&gt;&gt;<i>     tramp=0xffffffffffffffff &lt;Address 0xffffffffffffffff out of bounds&gt;)
</I>&gt;&gt;<i>     at mini-trampolines.c:121
</I>&gt;&gt;<i> #20 0x000000004000015b in ?? ()
</I>&gt;&gt;<i> #21 0x0000000000000000 in ?? ()
</I>&gt;&gt;<i> #0  0x00002b86da22465b in read () from /lib/libpthread.so.0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> =================================================================
</I>&gt;&gt;<i> Got a SIGABRT while executing native code. This usually indicates
</I>&gt;&gt;<i> a fatal error in the mono runtime or one of the native libraries
</I>&gt;&gt;<i> used by your application.
</I>&gt;&gt;<i> =================================================================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Would a fix be possible for 1.2.6 release?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025868.html">[Mono-dev] InterOp problems with 1.2.6pre2
</A></li>
	<LI>Next message: <A HREF="025870.html">[Mono-dev] InterOp problems with 1.2.6pre2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25869">[ date ]</a>
              <a href="thread.html#25869">[ thread ]</a>
              <a href="subject.html#25869">[ subject ]</a>
              <a href="author.html#25869">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
