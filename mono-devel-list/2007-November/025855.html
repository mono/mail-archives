<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Set hash algorithms block size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Set%20hash%20algorithms%20block%20size&In-Reply-To=bda1cfca0711290410o17e8ffccqab68d5498f009c15%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025841.html">
   <LINK REL="Next"  HREF="025857.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Set hash algorithms block size</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Set%20hash%20algorithms%20block%20size&In-Reply-To=bda1cfca0711290410o17e8ffccqab68d5498f009c15%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Set hash algorithms block size">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Thu Nov 29 08:04:22 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025841.html">[Mono-dev] [PATCH] Set hash algorithms block size
</A></li>
        <LI>Next message: <A HREF="025857.html">[Mono-dev] [PATCH] Set hash algorithms block size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25855">[ date ]</a>
              <a href="thread.html#25855">[ thread ]</a>
              <a href="subject.html#25855">[ subject ]</a>
              <a href="author.html#25855">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

On Thu, 2007-11-29 at 13:10 +0100, Javier Mart&#65533; wrote:
&gt;<i> In all Mono implementations (up to tonight's SVN) of the hash algorithms in
</I>&gt;<i> [corlib]System.Security.Cryptography, all of them fail to override the
</I>&gt;<i> InputBlockSize and OutputBlockSize properties, leaving them at 1 byte.
</I>
Actually they don't *fail* it's the *right*, even if not obvious, value.
The meaning isn't all that clear, the [Input|Output]BlockSize is
different than the algorithm block size.

The former is about what the implementation accept as a valid input,
i.e. it's valid to hash a single byte (which doesn't really answer the
output block size ;-)

&gt;<i> This should be mainly harmless, 
</I>
yes it is ;-)

&gt;<i> but, combined another bug in CryptoStream which
</I>&gt;<i> makes it ignore the CanTransformMultipleBlocks property of its ICryptoTransform
</I>&gt;<i> when reading (though not when writing!, brings about this doomsday scenario:
</I>&gt;<i> reading a 3MB file through a CryptoStream of, say, SHA1, issues about 3 million
</I>&gt;<i> calls to Buffer.BlockCopy and the same number to HashAlgorithm.TransformBlock.
</I>&gt;<i> That is, CryptoStream and HashAlgorithm are having fun passing millions of
</I>&gt;<i> one-byte arrays between them (and copying them). The speed penalty is extreme,
</I>&gt;<i> as stated below.
</I>
Please fill a bug into bugzilla.novell.com for this one.

&gt;<i> This fix is twofold: to begin with, I've modified the abstract base classes of
</I>&gt;<i> all hash algorithms in Sys.Sec.Crypto to include a protected const field called
</I>&gt;<i> SPEC_BLOKCSIZE and overriden InputBlockSize and OutputBlockSize to return this
</I>&gt;<i> value. 
</I>
Ok, even if the [Input|Output]BlockSize was bad (and it's not) you still
cannot add new protected methods inside mscorlib (or other most of Mono
assemblies). This would make code compiled with Mono incompatible with
MS.

We have some tools that can help you track if Mono is matching, or not,
MS implementation of the framework (check the web site for code
completion status pages).

&gt;<i> In principle, it should be cleaner to just add them to implementations
</I>&gt;<i> (SHA1Managed instead of SHA1), but the default provided is the one given by the
</I>&gt;<i> spec defining the algorithm, so most (sane) implementations are going to use it
</I>&gt;<i> and those who don't because they compute the hash through some other equivalent
</I>&gt;<i> method can just override the properties again.
</I>&gt;<i> 
</I>&gt;<i> The results are self-evident: even with the bug in CryptoStream (which I'll try
</I>&gt;<i> to patch shortly), the 3M calls turn into about 50K (3M / 64) in SHA1 or 25K
</I>&gt;<i> (3M / 128) in SHA2-512. In terms of time, hashing that 3MB file through CS went
</I>&gt;<i> down from 2.5s to about 0.5s. Thus, the speedup achieved was about 500%!
</I>
well you shouldn't be calling any Hash byte-by-byte as they don't do
much buffering themselves. 

Also CryptoStream design isn't very helpful(*) for buffering since it
must deal with other stuff (like padding, modes...). In a perfect world
(or maybe in Crimson) a real buffering class would be helpful in front
of hash algorithms.

(*) I personally discourage it's use for hashing alone.

&gt;<i> 
</I>&gt;<i> The (upcoming) second patch should reduce this number even more in algorithms
</I>&gt;<i> supporting CanTransformMultipleBlocks, so the number of calls to TransformBlock
</I>&gt;<i> (and thus buffer allocs &amp; copies) would be divided by the size passed to Read.
</I>&gt;<i> 
</I>&gt;<i> PD: I'm the &quot;stalker&quot; studend from yesterday Summit session. Sorry I won't be
</I>&gt;<i>     able to attend the rest of the sessions: Boo looked interesting.
</I>
Oh, sorry I missed the chance to talk to you :(

&gt;<i> PD2: It's the first time I send a formal diff patch to a project, so sorry if
</I>
For some reason part of your patch doesn't apply cleanly to SVN (only
RIPEMD160 applied, all others were rejected).

&gt;<i>      I missed some format rule - though I tried to replicate the formatting of
</I>&gt;<i>      code around my additions. Also, I've compiled the code (no Ws/Es) and
</I>&gt;<i>      lightly tested it hashing some files. It _seems_ I didn't break anything,
</I>
While doing your own tests is a good thing to do you should *always* run
the unit tests before sending a patch. Mono's crypto code is well tested
(so any error will likely get caught there) and you'll also have seen
that the [Input|Ouput]BlockSize were meant to be 1 (and not the
algorithm block size).

Sebastien


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025841.html">[Mono-dev] [PATCH] Set hash algorithms block size
</A></li>
	<LI>Next message: <A HREF="025857.html">[Mono-dev] [PATCH] Set hash algorithms block size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25855">[ date ]</a>
              <a href="thread.html#25855">[ thread ]</a>
              <a href="subject.html#25855">[ subject ]</a>
              <a href="author.html#25855">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
