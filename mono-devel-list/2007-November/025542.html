<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Fix%20abort%20when%20generating%20sparc%20V9%20code&In-Reply-To=295e750a0711020836i3bb153d1mff95f187440ff1dc%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025536.html">
   <LINK REL="Next"  HREF="025529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code</H1>
    <B>David Miller</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Fix%20abort%20when%20generating%20sparc%20V9%20code&In-Reply-To=295e750a0711020836i3bb153d1mff95f187440ff1dc%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code">davem at davemloft.net
       </A><BR>
    <I>Sat Nov  3 18:46:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025536.html">[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
</A></li>
        <LI>Next message: <A HREF="025529.html">[Mono-dev] VMWear player for Mono development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25542">[ date ]</a>
              <a href="thread.html#25542">[ thread ]</a>
              <a href="subject.html#25542">[ subject ]</a>
              <a href="author.html#25542">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>From: &quot;Zoltan Varga&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;
Date: Fri, 2 Nov 2007 16:36:02 +0100

&gt;<i> This is now in SVN.
</I>
Thanks Zoltan.

I have some MONO Sparc changes I've been working on to improve
code generation.  For example, I've copied the idea from the
PPC et al. ports to have a lowering pass right before register
allocation to improve handling of out-of-range immediate fields
so that the code emitter can be more simple and only consider
the cases where the immediate fields fit.

And as a result the sparc JIT now supports indexing loads and
stores.

This work is done and the testsuite has no regressions for sparc
32-bit, I'll be testing 64-bit soon.

I'm also going to add more cases to the peephole pass on Sparc.
For example, there are a lot of simple things not caught like
transforming:

	sethi	%hi(foo), %reg2		! OP_ICONST
	or	%reg2, %lo(foo), %reg2
	ld	[%reg2 + 0], %dest_reg	! OP_LOAD_MEMBASE

into:

	sethi	%hi(foo), %reg2			! OP_ICONST
	ld	[%reg2 + %lo(foo)], %dest_reg	! OP_LOAD_MEMBASE

This will require first lowering the &quot;sethi + or&quot; into seperate
operations (OP_ICONST, OP_OR_IMM) and then looking for this
&quot;OP_OR_IMM, OP_{LOAD,STORE}_*&quot; pattern.

OP_LOADU4_MEM could be decomposed similarly.

Next, I have a design in my head and plans for branch delay
slot filling.  At the very least it should be able to fill
branch delay slots using instructions from the same basic
block.  Ie. simple cases like transforming:

	add	%reg, 1, %reg
	bcond	label
	 nop

into:

	bcond	label
	 add	%reg, 1, %reg

For example.  This lack of delay slot filling (and the fact that the
branches are all marked as &quot;annuling&quot; which pessimizes performance on
all pre-Niagara UltraSparc chips) kills us in things like bench.exe on
Sparc currently.

Also, I cooked up a simple Sparc disassembler which I've integrated
into mono-sparc.c that I'm using to make this work less back-breaking
than it currently is.  In an ideal world, MONO could link to
libopcodes from binutils so that we wouldn't have to do that ugly
&quot;dump into asm file, run objdump on the thing, catch the output&quot; hack
it currently does.  But I don't see that happening any time soon. :-)

With either a libopcodes or by hand assembler, we could stylize the
assembler output, annotating it with MONO CIL opcodes and basic block
information in order to ease the debugging burdon.

Perhaps for the time being we can have some standard interfaces and
some $(cpu)-dis.c source files?  What the current code can do is try
to call the new disassembler interface, and if it returns an error, it
continues on to do the &quot;invoke objdump on foo.s file&quot; thing.

Anyways, just to let folks know what work I have coming down the
pipeline in the not too distant future.

Take care.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025536.html">[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
</A></li>
	<LI>Next message: <A HREF="025529.html">[Mono-dev] VMWear player for Mono development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25542">[ date ]</a>
              <a href="thread.html#25542">[ thread ]</a>
              <a href="subject.html#25542">[ subject ]</a>
              <a href="author.html#25542">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
