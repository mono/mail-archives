<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] DirectoryInfo.GetFiles() returns soft links pointing to	directories. Broken behavior in 1.2.5.2?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DirectoryInfo.GetFiles%28%29%20returns%20soft%20links%20pointing%20to%0A%09directories.%20Broken%20behavior%20in%201.2.5.2%3F&In-Reply-To=1194464183.23908.4.camel%40erandi.boston.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025607.html">
   <LINK REL="Next"  HREF="025609.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] DirectoryInfo.GetFiles() returns soft links pointing to	directories. Broken behavior in 1.2.5.2?</H1>
    <B>Max de Lavenne</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DirectoryInfo.GetFiles%28%29%20returns%20soft%20links%20pointing%20to%0A%09directories.%20Broken%20behavior%20in%201.2.5.2%3F&In-Reply-To=1194464183.23908.4.camel%40erandi.boston.ximian.com"
       TITLE="[Mono-dev] DirectoryInfo.GetFiles() returns soft links pointing to	directories. Broken behavior in 1.2.5.2?">max at tfbc.com
       </A><BR>
    <I>Wed Nov  7 20:22:31 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025607.html">[Mono-dev] Mono Bug Day Results.
</A></li>
        <LI>Next message: <A HREF="025609.html">[Mono-dev] Current binary installer is Broken
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25608">[ date ]</a>
              <a href="thread.html#25608">[ thread ]</a>
              <a href="subject.html#25608">[ subject ]</a>
              <a href="author.html#25608">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

After a an upgrade from mono 1.2.2.1 to 1.2.5.2, it appears that links to
folders (created by &quot;ln -s&quot;) are now returned by DirectoryInfo.GetFiles()
instead of DirectoryInfo.GetDirectories(); which used to be the way since
mono 0.31

Is there a reason why this behavior has changed? Or is this a regression?
How can I check that the file in question is actually a soft link pointing
to a directory?

I've looked into the system classes for DirectoryInfo.GetFiles(), 

So, I've peeking into ./mcs/class/corlib/System.IO/Directory.cs, line 305:
=======================================================================
    public static string [] GetFiles (string path, string pattern)
    {
            return GetFileSystemEntries (path, pattern,
FileAttributes.Directory, 0);
    }
=======================================================================

(appearing to be searching for FileAttributes.Directory files (?))

Which then calls into  ./mcs/class/corlib/System.IO/MonoIO.cs, line 140:
=======================================================================
   [MethodImplAttribute (MethodImplOptions.InternalCall)]
   public extern static string [] GetFileSystemEntries (string path, string
path_with_pattern, int attrs, int mask, out MonoIOError error);
=======================================================================

Leading me to the file ./mono/metadata/file-io.c, line 289:
=======================================================================
  do {
    if ((data.cFileName[0] == '.' &amp;&amp; data.cFileName[1] == 0) ||
        (data.cFileName[0] == '.' &amp;&amp; data.cFileName[1] == '.' &amp;&amp;
data.cFileName[2] == 0)) {
            continue;
    }

    if ((data.dwFileAttributes &amp; mask) == attrs) {
            utf8_result = g_utf16_to_utf8 (data.cFileName, -1, NULL, NULL,
NULL);
            if (utf8_result == NULL) {
                    continue;
            }

            full_name = g_build_filename (utf8_path, utf8_result, NULL);
            g_ptr_array_add (names, full_name);

            g_free (utf8_result);
    }
 } while(FindNextFile (find_handle, &amp;data));
=======================================================================

Now, it seems that the dwFileAttributes is checked against being a
directory, if I understand the call stack.
I may be wrong, but it seems that GetFiles() is trying to list all
directories, is it not?

Here's the code that worked all the way up to mono 1.2.2.1 but now fails in
1.2.5.2:

/// &lt;summary&gt;
/// Build the listing of files. Return a value greater than 0 if there's
been files found
/// &lt;/summary&gt;
private static int ListFiles(string dirpath,XmlTextWriter xw, ListingMode
listmode, string rootDir, string indent, VirtualDirectory vdir) {
	int count = 0;

	try {
		DirectoryInfo dirinfo = new DirectoryInfo(dirpath);
		if ( dirinfo.Exists ) {
			// add info about each encountered file
			FileInfo [] filelist = dirinfo.GetFiles();
			Array.Sort(filelist,new FileSystem());
			
			foreach ( FileInfo fileinfo in filelist ) {
				if ( vdir.CanShow(fileinfo.FullName) ) {
					string filename = fileinfo.Name;
					count++;
					xw.WriteRaw(&quot;\r\n&quot;);
					xw.WriteRaw(indent);
					xw.WriteStartElement(&quot;File&quot;);
	
xw.WriteAttributeString(&quot;Path&quot;,Strings.ToNeutral(filename));
	
xw.WriteAttributeString(&quot;Stamp&quot;,GetFileStampString(fileinfo));
	
xw.WriteAttributeString(&quot;Size&quot;,XmlConvert.ToString(fileinfo.Length));
					xw.WriteEndElement();
				}
			}

			// add info about each directory
			DirectoryInfo [] dirlist = dirinfo.GetDirectories();
			Array.Sort(dirlist,new FileSystem());

			foreach  ( DirectoryInfo dir in dirlist ) {
				string dirname = dir.Name;
				count++;
				xw.WriteRaw(&quot;\r\n&quot;);
				xw.WriteRaw(indent);
				xw.WriteStartElement(&quot;Directory&quot;);
	
xw.WriteAttributeString(&quot;Path&quot;,Strings.ToNeutral(dirname));
	
xw.WriteAttributeString(&quot;Stamp&quot;,GetFileStampString(dir));

				// go recursive if required
				if ( listmode == ListingMode.Recursive ) {
					if (
ListFiles(dir.FullName,xw,listmode,rootDir,indent+&quot; &quot;,vdir) &gt; 0 ) {
						xw.WriteRaw(&quot;\r\n&quot;);
						xw.WriteRaw(indent);
					}
				}

				xw.WriteEndElement();
			}
		}
	} catch ( Exception ex ) {
		StaticLogger.WriteException(ex,LogLevel.Error);
		//StaticLogger.WriteLine(&quot;got exception:
&quot;+ex.Message,LogLevel.Error);
	}

	return count;
}

How can I fix this behavior?

Thanks

Max


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025607.html">[Mono-dev] Mono Bug Day Results.
</A></li>
	<LI>Next message: <A HREF="025609.html">[Mono-dev] Current binary installer is Broken
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25608">[ date ]</a>
              <a href="thread.html#25608">[ thread ]</a>
              <a href="subject.html#25608">[ subject ]</a>
              <a href="author.html#25608">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
