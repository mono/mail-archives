<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Generic sharing: Static field access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20sharing%3A%20Static%20field%20access&In-Reply-To=f54ff3e80711190349y64842f3ej6b1837b713fc3f0c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025708.html">
   <LINK REL="Next"  HREF="025710.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Generic sharing: Static field access</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20sharing%3A%20Static%20field%20access&In-Reply-To=f54ff3e80711190349y64842f3ej6b1837b713fc3f0c%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Generic sharing: Static field access">lupus at ximian.com
       </A><BR>
    <I>Mon Nov 19 09:12:05 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025708.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
        <LI>Next message: <A HREF="025710.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25709">[ date ]</a>
              <a href="thread.html#25709">[ thread ]</a>
              <a href="subject.html#25709">[ subject ]</a>
              <a href="author.html#25709">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/19/07 Mark Probst wrote:
&gt;<i> &gt;   I don't really understand why a new trampoline is needed here. Since
</I>&gt;<i> &gt; the argument
</I>&gt;<i> &gt; to the trampoline is dynamic, it is not possible to patch the caller code, so a
</I>&gt;<i> &gt; normal call to mono_runtime_class_init () would be sufficient.
</I>&gt;<i> 
</I>&gt;<i> To be honest, I don't see any reason why we shouldn't use an icall in
</I>&gt;<i> those cases.  For some reason we defaulted to the trampoline, but it
</I>&gt;<i> doesn't seem to be necessary.
</I>
The new trampoline is not strictly essential to get the code working,
but it is needed to not make it too slow (we have the same perf issue
with AOT code).
The new trampoline code would be a singleton and passing the argument in
a register allows it to be just:
	deref vtable-&gt;initialized
	compare/and
	ret
	branch to icall
so basically just 4-5 instructions executed in the common case instead
of all the cost of going to unmanaged and back.

There is an alternative solution which we could implement as well,
though this requires one additional pointer per MonoVTable.
When the MonoVTable is created this pointer is set to the icall and once
the type is initialized it is set to a tiny function that just does:

	ret
With this the initialization becomes a memory dereference and an
indirect call+ret. The runtime cost is similar to the above solution
(in AOT code we'd even avoid a PLT call), but it has the additional
memory overhead.

Other suggestions for optimizing this codepath are welcome as well.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025708.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
	<LI>Next message: <A HREF="025710.html">[Mono-dev] [PATCH] Generic sharing: Static field access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25709">[ date ]</a>
              <a href="thread.html#25709">[ thread ]</a>
              <a href="subject.html#25709">[ subject ]</a>
              <a href="author.html#25709">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
