<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Fix%20abort%20when%20generating%20sparc%20V9%20code&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025526.html">
   <LINK REL="Next"  HREF="025536.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code</H1>
    <B>David Miller</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Fix%20abort%20when%20generating%20sparc%20V9%20code&In-Reply-To="
       TITLE="[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code">davem at davemloft.net
       </A><BR>
    <I>Fri Nov  2 00:49:41 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025526.html">[Mono-dev] Status Report
</A></li>
        <LI>Next message: <A HREF="025536.html">[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25528">[ date ]</a>
              <a href="thread.html#25528">[ thread ]</a>
              <a href="subject.html#25528">[ subject ]</a>
              <a href="author.html#25528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
In current SVN the testsuite gives an abort on sparc because the JIT
generates a branch whose relocation cannot fit.

It's a branch to an exception stub, so the branch is to the end of the
code generation area where the exception handler stubs are placed.

The V9 branch can only handle signed 19-bit offsets, and in this
case the code area is so big that the displacement to the exception
area is too large to fit into the relocation.

For these cases we only need the 32-bit icc condition codes.  So we
can expand the range of offsets that can be handled by using the
pre-v9 branches in this case.  This gives us a signed 22-bit offset to
work with.

This is not even sub-optimal for v9 chips because v9 chips use a
default prediction of not-taken for pre-v9 branches, and since
exceptions are &quot;exceptional&quot;...

While working on this patch I noticed a NULL pointer assertion in the
exception handler stub emitter that was after the first dereference of
that pointer, making it useless.

Please apply, thanks.

2007-11-01  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at davemloft.net</A>&gt;

	* mini-sparc.c (EMIT_COND_SYSTEM_EXCEPTION_GENERAL): Even if
	sparcv9, use non-v9 branch if using sparc_icc_short.
	(mono_arch_emit_exceptions): Move NULL pointer assertion before
	first dereference.

Index: mono/mini/mini-sparc.c
===================================================================
--- mono/mini/mini-sparc.c	(revision 88629)
+++ mono/mini/mini-sparc.c	(working copy)
@@ -1387,7 +1387,7 @@ if (ins-&gt;flags &amp; MONO_INST_BRLABEL) { \
 #define EMIT_COND_SYSTEM_EXCEPTION_GENERAL(ins,cond,sexc_name,filldelay,icc) do {     \
 		mono_add_patch_info (cfg, (guint8*)(code) - (cfg)-&gt;native_code,   \
 				    MONO_PATCH_INFO_EXC, sexc_name);  \
-        if (sparcv9) { \
+	if (sparcv9 &amp;&amp; ((icc) != sparc_icc_short)) {	      \
            sparc_branchp (code, 0, (cond), (icc), 0, 0); \
         } \
         else { \
@@ -4207,8 +4207,8 @@ mono_arch_emit_exceptions (MonoCompile *
 			sparc_patch ((guint32*)(cfg-&gt;native_code + patch_info-&gt;ip.i), code);
 
 			exc_class = mono_class_from_name (mono_defaults.corlib, &quot;System&quot;, patch_info-&gt;data.name);
-			type_idx = exc_class-&gt;type_token - MONO_TOKEN_TYPE_DEF;
 			g_assert (exc_class);
+			type_idx = exc_class-&gt;type_token - MONO_TOKEN_TYPE_DEF;
 			throw_ip = patch_info-&gt;ip.i;
 
 			/* Find a throw sequence for the same exception class */

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025526.html">[Mono-dev] Status Report
</A></li>
	<LI>Next message: <A HREF="025536.html">[Mono-dev] [PATCH]: Fix abort when generating sparc V9 code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25528">[ date ]</a>
              <a href="thread.html#25528">[ thread ]</a>
              <a href="subject.html#25528">[ subject ]</a>
              <a href="author.html#25528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
