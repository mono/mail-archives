<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] High CPU usage in System.Thread.Sleep on OS X after v.	4.3.2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20High%20CPU%20usage%20in%20System.Thread.Sleep%20on%20OS%20X%20after%20v.%0A%094.3.2&In-Reply-To=%3CCACrs54Sg2y8VyH5%2Bn%3D1kkUhV26HanXFDeh%3D5b-guonk6AT_X_A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043811.html">
   <LINK REL="Next"  HREF="043817.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] High CPU usage in System.Thread.Sleep on OS X after v.	4.3.2</H1>
    <B>Emil Sandst√∏</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20High%20CPU%20usage%20in%20System.Thread.Sleep%20on%20OS%20X%20after%20v.%0A%094.3.2&In-Reply-To=%3CCACrs54Sg2y8VyH5%2Bn%3D1kkUhV26HanXFDeh%3D5b-guonk6AT_X_A%40mail.gmail.com%3E"
       TITLE="[Mono-dev] High CPU usage in System.Thread.Sleep on OS X after v.	4.3.2">emil at fusetools.com
       </A><BR>
    <I>Thu Sep  8 14:16:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043811.html">[Mono-dev] Failing building mono on musl
</A></li>
        <LI>Next message (by thread): <A HREF="043817.html">[Mono-dev] High CPU usage in System.Thread.Sleep on OS X after	v. 4.3.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43813">[ date ]</a>
              <a href="thread.html#43813">[ thread ]</a>
              <a href="subject.html#43813">[ subject ]</a>
              <a href="author.html#43813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There has been a CPU performance regression in between the release of 4.3.2
and 4.4.0, on OS X when using System.Threading.Sleep. It's pretty critical,
we are talking about order of magnitude difference in performance between
those versions. Also it has been reproduced on more than one machine that
runs either El Capitan or Sierra, but not tested on earlier OS X versions.

I have made a code snippet that triggers the regression:
<A HREF="https://gist.github.com/Tapped/b4c0df072b2ff6fd38c6c4aff55d4669">https://gist.github.com/Tapped/b4c0df072b2ff6fd38c6c4aff55d4669</A>
It creates a thread that sleeps for one millisecond continuously in a loop.

# Profile data
When running the test in version 4.4.0 or higher the CPU usage is around 60
% of a core on my machine. However when running 4.3.2 or earlier versions,
the CPU usage is around 2-3 % of a core, which is as expected. Furthermore,
I've found that the bottleneck is pretty deep in Mono.

This is profile data from running 4.3.2:
<A HREF="https://az664292.vo.msecnd.net/files/TOfPF56ct1ePQsdN-Screen%20Shot%202016-09-08%20at%2015.34.14.png">https://az664292.vo.msecnd.net/files/TOfPF56ct1ePQsdN-Screen%20Shot%202016-09-08%20at%2015.34.14.png</A>

And this is profile data from running 4.4.0:
<A HREF="https://az664292.vo.msecnd.net/files/6To3h9tsG0DXzxFQ-Screen%20Shot%202016-09-08%20at%2015.35.03.png">https://az664292.vo.msecnd.net/files/6To3h9tsG0DXzxFQ-Screen%20Shot%202016-09-08%20at%2015.35.03.png</A>

What I'm find interesting is how much more time which is spent in
'pthread_cond_wait' in version 4.4.0 than in 4.3.2.
To be more specific, in 4.4.0 'pthread_cond_wait' calls __gettimeofday
which is where most of the CPU time is used.
And in 4.3.2 that internal method in pthread_cond_wait isn't called at all.

# Steps to reproduce
1. Download and install
<A HREF="http://download.mono-project.com/archive/4.3.2/macos-10-universal/MonoFramework-MDK-4.3.2.macos10.xamarin.universal.pkg">http://download.mono-project.com/archive/4.3.2/macos-10-universal/MonoFramework-MDK-4.3.2.macos10.xamarin.universal.pkg</A>
2. Build and run my test code (
<A HREF="https://az664292.vo.msecnd.net/files/VHeBcT7ZrmA5siqf-TestSleep.zip">https://az664292.vo.msecnd.net/files/VHeBcT7ZrmA5siqf-TestSleep.zip</A>)
3. Take a note of the &quot;average&quot; CPU usage.

4. Download and install <A HREF="http://download.mono-project.com/archive/4.4.0/">http://download.mono-project.com/archive/4.4.0/</A> or
a later version (same issue on 4.6.0 as well)
5. Build and run my test code (
<A HREF="https://az664292.vo.msecnd.net/files/VHeBcT7ZrmA5siqf-TestSleep.zip">https://az664292.vo.msecnd.net/files/VHeBcT7ZrmA5siqf-TestSleep.zip</A>)
6. Take a note of the &quot;average&quot; CPU usage and compare to what you found in
4.3.2.

I would like someone with more knowledge of the mono codebase to take a
look at this issue. I'm also available to test patches in our production
codebase, for end-to-end testing.

Thanks!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-devel-list/attachments/20160908/213f92b4/attachment.html">http://lists.dot.net/pipermail/mono-devel-list/attachments/20160908/213f92b4/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043811.html">[Mono-dev] Failing building mono on musl
</A></li>
	<LI>Next message (by thread): <A HREF="043817.html">[Mono-dev] High CPU usage in System.Thread.Sleep on OS X after	v. 4.3.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43813">[ date ]</a>
              <a href="thread.html#43813">[ thread ]</a>
              <a href="subject.html#43813">[ subject ]</a>
              <a href="author.html#43813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
