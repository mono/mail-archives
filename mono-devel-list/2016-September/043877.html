<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%0A%20%3D%3Futf-8%3Fq%3FPotential_bug_in_NetworkStream_in_Raspberry_%3F%3D%0A%20%3D%3Futf-8%3Fb%3FQVJNIOKAkyBNb25vIDQuNC4w%3F%3D&In-Reply-To=%3CBE4915CF-C612-41EE-9F07-191CACF47FA7%40asme.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043874.html">
   <LINK REL="Next"  HREF="043878.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0</H1>
    <B>David Curylo</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%0A%20%3D%3Futf-8%3Fq%3FPotential_bug_in_NetworkStream_in_Raspberry_%3F%3D%0A%20%3D%3Futf-8%3Fb%3FQVJNIOKAkyBNb25vIDQuNC4w%3F%3D&In-Reply-To=%3CBE4915CF-C612-41EE-9F07-191CACF47FA7%40asme.org%3E"
       TITLE="[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0">curylod at asme.org
       </A><BR>
    <I>Tue Sep 20 01:47:28 UTC 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043874.html">[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0
</A></li>
        <LI>Next message (by thread): <A HREF="043878.html">[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43877">[ date ]</a>
              <a href="thread.html#43877">[ thread ]</a>
              <a href="subject.html#43877">[ subject ]</a>
              <a href="author.html#43877">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I’m glad it helps.  AFAICT a slow network actually _helps_ trigger the issue, guessing it allows the kernel TCP buffers to fill and leads to this issue.

Here is an older mono NetworkStream.Write, which was making up for the issue by continuing to push data through when the buffers filled:
<A HREF="https://github.com/mono/mono/blob/mono-3.12.1/mcs/class/System/System.Net.Sockets/NetworkStream.cs#L414">https://github.com/mono/mono/blob/mono-3.12.1/mcs/class/System/System.Net.Sockets/NetworkStream.cs#L414</A>

So I expect that will work around your issue, although it needs to be fixed in Socket.cs like the comments &lt;<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=43902#c3">https://bugzilla.xamarin.com/show_bug.cgi?id=43902#c3</A>&gt; in the bug.

&gt;<i> On Sep 19, 2016, at 6:12 PM, <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">psantosl at codicesoftware.com</A> wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi David,
</I>&gt;<i> 
</I>&gt;<i> Thanks for the info!!
</I>&gt;<i> 
</I>&gt;<i> So, does this fix the issue?
</I>&gt;<i> 
</I>&gt;<i>             while (sent &lt; count)
</I>&gt;<i>             {
</I>&gt;<i>                 sent += mSocket.Send(buffer, offset + sent, count - sent, SocketFlags.None);
</I>&gt;<i>             }
</I>&gt;<i> 
</I>&gt;<i> Or am I simply having good luck??
</I>&gt;<i> 
</I>&gt;<i> I'm testing through VPN myself, so maybe the slow network helps. But, we are able to see the same issue on LAN... always using the raspberry as server.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> pablo
</I>&gt;<i> 
</I>&gt;<i> On 9/19/2016 23:38, David Curylo wrote:
</I>&gt;&gt;<i> Pablo,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I believe I’m experiencing a similar issue, also reported by others here: <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=43902">https://bugzilla.xamarin.com/show_bug.cgi?id=43902</A> &lt;<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=43902">https://bugzilla.xamarin.com/show_bug.cgi?id=43902</A>&gt;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Mono’s Socket.Send doesn’t block until all data is sent.  The old NetworkStream in mono used to account for this with a while loop to continue sending, but the NetworkStream from MS Reference Source expects the Socket to block until all data is sent.  When the reference source was pulled in, the Socket.Send could sometimes fail to send all the data.  I can’t ever make this failure occur on localhost, but it will occur for me communicating with remote hosts.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I’m working on a PR now to have Socket.Send_internal loop until all data is sent so Socket.Send will block as the reference source expects it to, unless anyone else has any suggestions.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> -Dave
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Sep 19, 2016, at 9:33 AM,  &lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">psantosl at codicesoftware.com</A>&gt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">psantosl at codicesoftware.com</A> &lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">psantosl at codicesoftware.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I have found a potential issue with NetworkStream on ARM (Raspberry).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> It might be a stupid bug on my code too, but I don't see it.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> In short: a simple multi-threaded server running on Raspberry (same behavior on Mono 4.4.0 as Mono 4.6.0), client on W10:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 1. Fails to correctly send data using NetworkStream (server seems to send the data, but it never arrives to client).<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs</A> &lt;<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs</A>&gt;
</I>&gt;&gt;&gt;<i> 1.1. Fails *only* using NetworkStream (no BufferedStream or BinaryReader/Writer around, and it still fails): <A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs</A> &lt;<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs</A>&gt;
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 2. Works correctly using Sockets (no streams on top). <A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs</A> &lt;<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs</A>&gt;
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 3. Works correctly using a custom NetworkStream:
</I>&gt;&gt;&gt;<i> 3.1.  <A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs</A> &lt;<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs</A>&gt;
</I>&gt;&gt;&gt;<i> 3.2.  <A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs</A> &lt;<A HREF="https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs">https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs</A>&gt;
</I>&gt;&gt;&gt;<i> 3.3. Although I just saw it timing out after transferring several hundred MB on each connection (I'm on a slow VPN connected to the Raspberry, although we reproduced it on LAN too). Interestingly, using the regular NetworkStream it fails inmediately.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> When it fails, what happens is that at a given point in time (in my tests like in a few seconds) one of the client threads (or more than one) NEVER exits the Read, data never arrives although the server log says the data was written, but it doesn't. Since I've set a timeout for the read operation, you see how the program stops working.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> == Additional tests performed ==
</I>&gt;&gt;&gt;<i> I tried with different buffer sizes, it always fails with the NetworkStream.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I ran the same server code on other setups:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> * Window 10/.NET: OK.
</I>&gt;&gt;&gt;<i> * OpenSuse 13.2 + mono 4.0.4 (Stable 4.0.4.1/5ab4c0d): OK.
</I>&gt;&gt;&gt;<i> * Raspberry: failed both with mono 4.4.0 and mono-4.6.0.245 (built from GitHub on the 746756c commit.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I originally discovered the issue running a Plastic SCM server on BananaPi &lt;<A HREF="http://www.bananapi.org/">http://www.bananapi.org/</A>&gt; (like a Raspberry + SATA).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> == Extra notes ==
</I>&gt;&gt;&gt;<i> * I know the multi-threaded server is not optimal and thread-per-connection is really bad, this is just a test case.
</I>&gt;&gt;&gt;<i> * Initially I thought we had an issue with async sockets, but after a few days I just isolated the problem in NetworkStream.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Any hints would be appreciated.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Thanks,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> pablo
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> www.plasticscm.com &lt;<A HREF="http://www.plasticscm.com/">http://www.plasticscm.com/</A>&gt;
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A> &lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A>&gt;
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">http://lists.dot.net/mailman/listinfo/mono-devel-list</A> &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">http://lists.dot.net/mailman/listinfo/mono-devel-list</A>&gt;
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-devel-list/attachments/20160919/029fca5e/attachment.html">http://lists.dot.net/pipermail/mono-devel-list/attachments/20160919/029fca5e/attachment.html</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043874.html">[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0
</A></li>
	<LI>Next message (by thread): <A HREF="043878.html">[Mono-dev] Potential bug in NetworkStream in Raspberry ARM – Mono 4.4.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43877">[ date ]</a>
              <a href="thread.html#43877">[ thread ]</a>
              <a href="subject.html#43877">[ subject ]</a>
              <a href="author.html#43877">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
