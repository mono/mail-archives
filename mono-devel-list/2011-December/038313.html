<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] P/Invoking libsmbclient from OSX
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20P/Invoking%20libsmbclient%20from%20OSX&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038312.html">
   <LINK REL="Next"  HREF="038315.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] P/Invoking libsmbclient from OSX</H1>
    <B>Alfred Hall</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20P/Invoking%20libsmbclient%20from%20OSX&In-Reply-To="
       TITLE="[Mono-dev] P/Invoking libsmbclient from OSX">ahall at ahall.org
       </A><BR>
    <I>Tue Dec  6 14:53:40 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="038312.html">[Mono-dev] Candidate Fix for 699643
</A></li>
        <LI>Next message: <A HREF="038315.html">[Mono-dev] P/Invoking libsmbclient from OSX
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38313">[ date ]</a>
              <a href="thread.html#38313">[ thread ]</a>
              <a href="subject.html#38313">[ subject ]</a>
              <a href="author.html#38313">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Good afternoon!

I have been trying to P/Invoke into libsmbclient on OSX 10.6 running
64 bit kernel. I compile the samba library myself (version 3.6.0) with
-m32 and managed to get a simple stub working in C/C++:

static void
auth_fn(const char *server, const char *share,
    char *workgroup, int wgmaxlen, char *username, int unmaxlen,
    char *password, int pwmaxlen)
{
}

smbc_init(auth_fn, 10);
smbc_opendir(&quot;<A HREF="smb://myuser:mypass@192.168.x.x/c$&quot;">smb://myuser:mypass@192.168.x.x/c$&quot;</A>);

This works fine, then I created the P/Invokes:

        public static void SmbInit()
        {
            smbc_init(CallBackAuth, 0);
        }


        public static void CallBackAuth(IntPtr server,
                                        IntPtr share,
                                        IntPtr workgroup,
                                        int wgmaxlen,
                                        IntPtr username,
                                        int unmaxlen,
                                        IntPtr password,
                                        int pwmaxlen)
        {
            Console.WriteLine(&quot;MeeMa&quot;);
        }

        public delegate void SmbCGetAuthDataFn(IntPtr server,
                                               IntPtr share,
                                               IntPtr workgroup,
                                               int wgmaxlen,
                                               IntPtr username,
                                               int unmaxlen,
                                               IntPtr password,
                                               int pwmaxlen);


        [DllImport(&quot;libsmbclient&quot;)] extern internal static int
smbc_init(SmbCGetAuthDataFn callBackAuth, int debug);
        [DllImport(&quot;libsmbclient&quot;)] extern internal static int
smbc_opendir([In, MarshalAs(UnmanagedType.LPStr)]string durl);


Then simple calling into:
    SambaWrapper.SmbInit();
    SambaWrapper.smbc_opendir(@&quot;<A HREF="smb://username:password@somehostname/someshare&quot;">smb://username:password@somehostname/someshare&quot;</A>);

Then I got this beautiful stacktrace here:
<A HREF="http://paste.pocoo.org/show/517187/.">http://paste.pocoo.org/show/517187/.</A> I have made sure it's calling
into the libsmbclient library I compiled and not the one that comes
with OSX. I have also tried
it against the one that comes with OSX but that one just blows up with
a different trace.

I was debugging this with Alan on IRC today and we thought it might be
the delete being free'd but we tried adding a new smbc_init function
into smb that
looks like this:

void
myauth_fn(const char *server, const char *share,
        char *workgroup, int wgmaxlen, char *username, int unmaxlen,
       char *password, int pwmaxlen)
{
}

int
smbc_init2(int debug)
{
    smbc_init(myauth_fn, debug);
    smbc_opendir(&quot;<A HREF="smb://user:pass@192.168.212.133/c$&quot;">smb://user:pass@192.168.212.133/c$&quot;</A>);
}

And then tried to P/Invoke smbc_init2 only and P/Invoke:

[DllImport(&quot;libsmbclient&quot;, CallingConvention =
CallingConvention.Cdecl)] extern internal static int smbc_init2(int
debug);

When calling into smbc_init2() it blows up with exactly the same
stacktrace. I tried again a C++ program that calls into smbc2_init()
and it worked fine.

Anyone here got any idea how to proceed further with this?

Many thanks,
Alfred
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038312.html">[Mono-dev] Candidate Fix for 699643
</A></li>
	<LI>Next message: <A HREF="038315.html">[Mono-dev] P/Invoking libsmbclient from OSX
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38313">[ date ]</a>
              <a href="thread.html#38313">[ thread ]</a>
              <a href="subject.html#38313">[ subject ]</a>
              <a href="author.html#38313">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
