<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] New managed code for unmanaged (Win32) resource	handling (SRE, PEAPI, MCS)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20New%20managed%20code%20for%20unmanaged%20%28Win32%29%20resource%0A%09handling%20%28SRE%2C%20PEAPI%2C%20MCS%29&In-Reply-To=002e01c63ed9%24fbcd5100%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017403.html">
   <LINK REL="Next"  HREF="017455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] New managed code for unmanaged (Win32) resource	handling (SRE, PEAPI, MCS)</H1>
    <B>Marek Safar</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20New%20managed%20code%20for%20unmanaged%20%28Win32%29%20resource%0A%09handling%20%28SRE%2C%20PEAPI%2C%20MCS%29&In-Reply-To=002e01c63ed9%24fbcd5100%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] New managed code for unmanaged (Win32) resource	handling (SRE, PEAPI, MCS)">marek.safar at seznam.cz
       </A><BR>
    <I>Mon Mar  6 16:14:30 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017403.html">[Mono-dev] [PATCH] New managed code for unmanaged (Win32) resource	handling (SRE, PEAPI, MCS)
</A></li>
        <LI>Next message: <A HREF="017455.html">[Mono-dev] [PATCH] New managed code for unmanaged (Win32)	resourcehandling (SRE, PEAPI, MCS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17450">[ date ]</a>
              <a href="thread.html#17450">[ thread ]</a>
              <a href="subject.html#17450">[ subject ]</a>
              <a href="author.html#17450">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Korn&#233;l,
&gt;<i> This patch adds a fully managed and object oriented unmanaged (Win32)
</I>&gt;<i> resource handling internal infractructure to the class library. The most
</I>&gt;<i> important change is that it implements the /resource command line 
</I>&gt;<i> option of
</I>&gt;<i> ilasm in PEAPI.
</I>&gt;<i>
</I>&gt;<i> I revorked DefineUnmanagedResource and DefineVersionInfoResource 
</I>&gt;<i> methods to
</I>&gt;<i> be fully MS.NET compatible. Including resource blob support.
</I>&gt;<i>
</I>&gt;<i> In addition I replaced the previous unamaged implementation with the same
</I>&gt;<i> unmanaged code that is used in PEAPI. This has the following advantages:
</I>&gt;<i> - Named resource identifiers are supported
</I>&gt;<i> - Very large .res files are supported because resources are not 
</I>&gt;<i> retained in
</I>&gt;<i> memory
</I>Well, I would prefer to use the memory solution.
1. It's faster
2. It's easier to implement, no problems with file removing, creating, 
locking, etc.
3. I don't believe that anyone will link more than 10 MB resource file.

&gt;<i> - Has exactly the same behavior as MS cvtres.exe that is used by the MS
</I>&gt;<i> runtime and csc.exe as well including the some tests and exceptions 
</I>&gt;<i> thrown
</I>&gt;<i> by the wrapper code of MS runtime.
</I>&gt;<i>
</I>&gt;<i> I removed the internal DefineIconResource method and moved it's
</I>&gt;<i> functionality to mcs compiler that now uses DefineUnmanagedResource.
</I>&gt;<i>
</I>&gt;<i> DefineVersionInfoResource and mcs no generate two differend and MS.NET
</I>&gt;<i> compatible version info resource files.
</I>I reviewed just mcs and corlib part of the patch and here are my comments.

+                    } catch (Exception ex) {
+                        Report.Error (1567, string.Format (&quot;Error 
generating Win32 resource: {0}&quot;, ex.Message));
+                        return false;
+                    }

1. You don't need to use string.Format as Report.Error accepts variable 
arguments.
2.  Please provide error tests for as many new error codes as possible.

-                MethodInfo define_icon = typeof 
(AssemblyBuilder).GetMethod (&quot;DefineIconResource&quot;, 
BindingFlags.Instance|BindingFlags.Public|BindingFlags.NonPublic);
-                if (define_icon == null) {
-                    Report.RuntimeMissingSupport (Location.Null, 
&quot;resource embeding&quot;);

I prefer this method of code sharing instead of copying all the sources 
to every file. Please use reflection to get instance of your internal 
classes. I know you are using several fields, so if you really need them 
then a solution can be to introduce interface e.g. IResource with all 
required properties and methods and distribute only this interface file 
across. Of course, you will need some factory method to create this 
interface but that is the trivial part.


+        private static void CreateDefaultResource (string fileName)
+        {

Try to move this method to CodeGen.Assembly class.

+        public static string CreateStringTableKey(ushort languageId, 
ushort codePage, bool upperCase)
+        {
+            return ((languageId &lt;&lt; 16) | codePage).ToString(upperCase ? 
&quot;X8&quot; : &quot;x8&quot;, CultureInfo.InvariantCulture);
+        }

Please use constants instead of X8, x8

+            base.WriteResources(resourceFile);
+
+            if (this.iconFileName != null)
+            {
+                stream = new FileStream(this.iconFileName, 
FileMode.Open, FileAccess.Read, FileShare.Read);

Please use style

if (this.iconFileName == null)
    return;



Regards,
Marek


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017403.html">[Mono-dev] [PATCH] New managed code for unmanaged (Win32) resource	handling (SRE, PEAPI, MCS)
</A></li>
	<LI>Next message: <A HREF="017455.html">[Mono-dev] [PATCH] New managed code for unmanaged (Win32)	resourcehandling (SRE, PEAPI, MCS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17450">[ date ]</a>
              <a href="thread.html#17450">[ thread ]</a>
              <a href="subject.html#17450">[ subject ]</a>
              <a href="author.html#17450">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
