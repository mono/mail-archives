<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Tree mover, again
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Tree%20mover%2C%20again&In-Reply-To=1142262218.1178.6.camel%40matrix">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017565.html">
   <LINK REL="Next"  HREF="017566.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Tree mover, again</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Tree%20mover%2C%20again&In-Reply-To=1142262218.1178.6.camel%40matrix"
       TITLE="[Mono-dev] [PATCH] Tree mover, again">lupus at ximian.com
       </A><BR>
    <I>Mon Mar 27 08:55:02 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017565.html">[Mono-dev] [PATCH] Tree mover, again
</A></li>
        <LI>Next message: <A HREF="017566.html">[Mono-dev] Bug in System.Web.Services in SoapMessage.ContentEncoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17798">[ date ]</a>
              <a href="thread.html#17798">[ thread ]</a>
              <a href="subject.html#17798">[ subject ]</a>
              <a href="author.html#17798">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Index: mono/mono/mini/local-propagation.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/mini/local-propagation.c	(revision 0)
</I>&gt;<i> +++ mono/mono/mini/local-propagation.c	(revision 0)
</I>&gt;<i> @@ -0,0 +1,1117 @@
</I>&gt;<i> +/*
</I>&gt;<i> + * local-propagation.c: Local constant, copy and tree propagation.
</I>&gt;<i> + *
</I>&gt;<i> + * Author:
</I>&gt;<i> + *   Massimiliano Mantione (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">massi at ximian.com</A>)
</I>
Since some of the code was copied from mini.c, copy over also the
copyright/author notice (Dietmar wrote most of it, IIRC).

&gt;<i> +extern MonoJitICallInfo **emul_opcode_map;
</I>&gt;<i> +static inline MonoJitICallInfo *
</I>&gt;<i> +find_jit_opcode_emulation (int opcode)
</I>&gt;<i> +{
</I>&gt;<i> +	if  (emul_opcode_map)
</I>&gt;<i> +		return emul_opcode_map [opcode];
</I>&gt;<i> +	else
</I>&gt;<i> +		return NULL;
</I>&gt;<i> +}
</I>
Not acceptable, export the existing mono_find_jit_opcode_emulation ()
instead.

&gt;<i> +#define MONO_DEBUG_LOCAL_PROP 0
</I>&gt;<i> +#define MONO_DEBUG_TREE_MOVER 0
</I>&gt;<i> +#define MONO_DUMP_TREE_MOVER 0
</I>&gt;<i> +#define MONO_APPLY_TREE_MOVER_TO_SINGLE_METHOD 0
</I>&gt;<i> +#define MONO_APPLY_TREE_MOVER_TO_COUNTED_METHODS 0
</I>&gt;<i> +
</I>&gt;<i> +struct MonoTreeMoverActSlot;
</I>&gt;<i> +typedef struct MonoTreeMoverDependencyNode {
</I>&gt;<i> +	struct MonoTreeMoverActSlot *used_slot;
</I>&gt;<i> +	struct MonoTreeMoverActSlot *affected_slot;
</I>&gt;<i> +	struct MonoTreeMoverDependencyNode *next_used_local;
</I>&gt;<i> +	struct MonoTreeMoverDependencyNode *next_affected_local;
</I>&gt;<i> +	struct MonoTreeMoverDependencyNode *previous_affected_local;
</I>&gt;<i> +	gboolean use_is_direct;
</I>&gt;<i> +} MonoTreeMoverDependencyNode;
</I>
I would %s/MonoTree/Tree/g, the names are unnecessarily long and they
are not user-visible so the Mono prefix can be removed.

&gt;<i> +#define TREE_MOVER_NEW_NODE(__node) do {\
</I>
Used in one place only, remove.

&gt;<i> +#define TREE_MOVER_NEW_MOVE(__move) do {\
</I>
Used in one place only, remove.

&gt;<i> +#define TREE_MOVER_DISPOSE_MOVE(__move) do {\
</I>
Same.

&gt;<i> +#define TREE_MOVER_DISPOSE_USED_NODES do {\
</I>
Unused.

&gt;<i> +#define TREE_MOVER_LINK_AFFECTING_NODE(__node,__affected_slot) do {\
</I>
Used once...

&gt;<i> +#define TREE_MOVER_CLEAR_FORWARDING_DEPENDENCY(__slot) do {\
</I>
Used once...

&gt;<i> +#define TREE_MOVER_ENFORCE_FORWARDING_DEPENDENCY(__slot) do {\
</I>
Same.

&gt;<i> +#define TREE_MOVER_CLEAN_ACT_SLOT_DEPENDENCY_NODES(__slot) do {\
</I>[...]
&gt;<i> +#define TREE_MOVER_CLEAN_ACT_SLOT_PENDING_MOVE(__slot) do {\
</I>
Idem.

I stopped reviewing macros at this point. Are you sure you need 30
macros some of which are unused and some of which are used just once?
This code needs serious cleanup to make it readable.

&gt;<i> +static gboolean stind_needs_conversion[(CEE_STIND_R8-CEE_STIND_REF)+1][STACK_MAX] = {
</I>
These arrays need to be declared const and use guchar instead of
gboolean to avoid wasting memory.

&gt;<i> +static MonoTreeMoverTreeMove*
</I>&gt;<i> +mono_cprop_copy_values (MonoCompile *cfg, MonoTreeMover *tree_mover, MonoInst *tree, MonoInst **acp)
</I>&gt;<i> +{
</I>&gt;<i> +	MonoInst *cp;
</I>&gt;<i> +	int arity;
</I>&gt;<i> +	MonoTreeMoverTreeMove *pending_move = NULL;
</I>&gt;<i> +
</I>&gt;<i> +	if (tree-&gt;ssa_op == MONO_SSA_LOAD &amp;&amp; (tree-&gt;inst_i0-&gt;opcode == OP_LOCAL || tree-&gt;inst_i0-&gt;opcode == OP_ARG) &amp;&amp;
</I>&gt;<i> +	    (cp = acp [tree-&gt;inst_i0-&gt;inst_c0]) &amp;&amp; !tree-&gt;inst_i0-&gt;flags) {
</I>
Conditionals that don't fit in one line need to be indented by two TABs,
no spaces.

&gt;<i> +
</I>&gt;<i> +		if (cp-&gt;opcode == OP_ICONST) {
</I>&gt;<i> +			if (cfg-&gt;opt &amp; MONO_OPT_CONSPROP) {
</I>&gt;<i> +				//{ static int c = 0; printf (&quot;CCOPY %d %d %s\n&quot;, c++, cp-&gt;inst_c0, mono_method_full_name (cfg-&gt;method, TRUE)); }
</I>&gt;<i> +#if MONO_DEBUG_LOCAL_PROP
</I>&gt;<i> +				printf (&quot;Propagating constant, tree &quot;);
</I>&gt;<i> +				mono_print_tree (tree);
</I>&gt;<i> +				printf (&quot; becomes &quot;);
</I>&gt;<i> +				mono_print_tree (cp);
</I>&gt;<i> +				printf (&quot;\n&quot;);
</I>&gt;<i> +#endif
</I>&gt;<i> +				*tree = *cp;
</I>
There are too many preprocessor conditionals in the code: please change
it to not use them. In most cases you can use normal if statements, at
least the code would align properly, like:

				if (MONO_DEBUG_LOCAL_PROP) {
					...
				}

But please note that in the first 45 lines of code there are only 8
lines of non-debugging stuff. It is unreadable, please cleanup.

&gt;<i> +			} else if ((i1-&gt;type==STACK_I8)||(i1-&gt;opcode==OP_I8CONST)||(i1-&gt;opcode==OP_R4CONST)||(i1-&gt;opcode==OP_R8CONST)||(i1-&gt;opcode==OP_AOTCONST)) {
</I>
Use spaces around operators as per the coding style.

&gt;<i> +void
</I>&gt;<i> +mono_local_cprop (MonoCompile *cfg) {
</I>&gt;<i> +	MonoBasicBlock *bb;
</I>&gt;<i> +	MonoInst **acp;
</I>&gt;<i> +	MonoTreeMover *tree_mover;
</I>&gt;<i> +
</I>&gt;<i> +	acp = alloca (sizeof (MonoInst *) * cfg-&gt;num_varinfo);
</I>
Just us malloc here, this can become too large.

&gt;<i> Index: mono/mono/mini/mini.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/mini/mini.h	(revision 57888)
</I>&gt;<i> +++ mono/mono/mini/mini.h	(working copy)
</I>[...]
&gt;<i> @@ -615,6 +616,7 @@
</I>&gt;<i>  #ifdef __ia64
</I>&gt;<i>  	guint8           ins, locals, outs; /* reg stack region sizes */
</I>&gt;<i>  #endif /* __ia64 */
</I>&gt;<i> +	int		num_calls;
</I>
This is unused.

Once the code will be cleaned up, please commit.
Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017565.html">[Mono-dev] [PATCH] Tree mover, again
</A></li>
	<LI>Next message: <A HREF="017566.html">[Mono-dev] Bug in System.Web.Services in SoapMessage.ContentEncoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17798">[ date ]</a>
              <a href="thread.html#17798">[ thread ]</a>
              <a href="subject.html#17798">[ subject ]</a>
              <a href="author.html#17798">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
