<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] RE: [Mono-patches] r57149 - in	trunk/mcs/class/System.Data: System.DataSystem.Data.Common	Test/ProviderTests/System.Data.SqlClientTest/System.Data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20RE%3A%20%5BMono-patches%5D%20r57149%20-%20in%0A%09trunk/mcs/class/System.Data%3A%20System.DataSystem.Data.Common%0A%09Test/ProviderTests/System.Data.SqlClientTest/System.Data&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017443.html">
   <LINK REL="Next"  HREF="017426.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] RE: [Mono-patches] r57149 - in	trunk/mcs/class/System.Data: System.DataSystem.Data.Common	Test/ProviderTests/System.Data.SqlClientTest/System.Data</H1>
    <B>Boris Kirzner</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20RE%3A%20%5BMono-patches%5D%20r57149%20-%20in%0A%09trunk/mcs/class/System.Data%3A%20System.DataSystem.Data.Common%0A%09Test/ProviderTests/System.Data.SqlClientTest/System.Data&In-Reply-To="
       TITLE="[Mono-dev] RE: [Mono-patches] r57149 - in	trunk/mcs/class/System.Data: System.DataSystem.Data.Common	Test/ProviderTests/System.Data.SqlClientTest/System.Data">borisk at mainsoft.com
       </A><BR>
    <I>Mon Mar  6 03:03:28 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017443.html">[Mono-dev] GDI+ and GetNearestColor
</A></li>
        <LI>Next message: <A HREF="017426.html">[Mono-dev] RE: [Mono-patches] r57149 -	in	trunk/mcs/class/System.Data:	System.DataSystem.Data.Common	Test/ProviderTests/System.Data.SqlClientTest/System.Data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17425">[ date ]</a>
              <a href="thread.html#17425">[ thread ]</a>
              <a href="subject.html#17425">[ subject ]</a>
              <a href="author.html#17425">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Senga,

One of your latest updates introduces a regression (see attached test
case, passes on r57148 but fails on r57149), due to the change in Key
default row state filter.

Please, next time you want to introduce some changes that has such a
wide effect, especially in the code you do not wrote by your own, maybe
it worth to give this fixes an opportunity to be reviewed by the
community before applying them.

Thanks,
Boris

--
Boris Kirzner
Mono R&amp;D team, Mainsoft Corporation.
Blogging at <A HREF="http://boriskirzner.blogspot.com/">http://boriskirzner.blogspot.com/</A>  

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A> 
</I>&gt;<i> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A>] On Behalf Of 
</I>&gt;<i> senga (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>)
</I>&gt;<i> Sent: Wednesday, February 22, 2006 12:03 PM
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ximian.monolist at gmail.com</A>; 
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-list at googlegroups.com</A>
</I>&gt;<i> Subject: [Mono-patches] r57149 - in 
</I>&gt;<i> trunk/mcs/class/System.Data: System.DataSystem.Data.Common 
</I>&gt;<i> Test/ProviderTests/System.Data.SqlClientTest/System.Data
</I>&gt;<i> 
</I>&gt;<i> Author: senga
</I>&gt;<i> Date: 2006-02-22 05:03:03 -0500 (Wed, 22 Feb 2006) New Revision: 57149
</I>&gt;<i> 
</I>&gt;<i> Modified:
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data.Common/ChangeLog
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data.Common/DbDataAdapter.cs
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data.Common/Key.cs
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data/DataRow.cs
</I>&gt;<i>    
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/ChangeLog
</I>&gt;<i>    
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/SqlDataAdapterTest.cs
</I>&gt;<i>    trunk/mcs/class/System.Data/Test/System.Data/ChangeLog
</I>&gt;<i>    
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataRowCollectionTest2.cs
</I>&gt;<i>    trunk/mcs/class/System.Data/Test/System.Data/DataTableTest2.cs
</I>&gt;<i>    
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/ForeignKeyConstra
</I>&gt;<i> intTest.cs
</I>&gt;<i> Log:
</I>&gt;<i> 2006-02-22  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 	* Test/System.Data/DataRowCollectionTest2.cs : Check if 
</I>&gt;<i> index is maintained for row on calling RejectChanges. 
</I>&gt;<i> 	* Test/System.Data/DataTableTest2.cs : Check if data is 
</I>&gt;<i> loaded and merged (if key exists) correctly.
</I>&gt;<i> 	* Test/System.Data/ForeignKeyConstraintTest.cs : Check 
</I>&gt;<i> if a ParentColumn value can be modified
</I>&gt;<i> 		when the row is in 'Added' State. Also, check 
</I>&gt;<i> if child col values are
</I>&gt;<i> 		updated correctly.
</I>&gt;<i> 	* 
</I>&gt;<i> Test/ProviderTests/System.Data.SqlClient/SqlAdapterTest.cs : 
</I>&gt;<i> Added testcases for verifying FillError Behavior
</I>&gt;<i> 	* System.Data.Common/DbDataAdapter.cs :
</I>&gt;<i> 		- FillTable : Move BeginLoadData, EndLoadData 
</I>&gt;<i> outside the loop. Also,
</I>&gt;<i> 		move EndLoadData outsidet try,catch block. 
</I>&gt;<i> FillError is only for errors
</I>&gt;<i> 		occuring during loading the data into datatable.
</I>&gt;<i> 	* System.Data.Common/Key.cs :
</I>&gt;<i> 		- Set Default value of RowStateFilter to 
</I>&gt;<i> (CurrentRos | OriginalRows).
</I>&gt;<i> 		- ContainsVersion : If RowStateFilter is set to 
</I>&gt;<i> default value, return true
</I>&gt;<i> 		for Modified Rows as they can contain 
</I>&gt;<i> Default/Original versions.
</I>&gt;<i> 	* System.Data/DataRow.cs 
</I>&gt;<i> 		- RejectChanges : Do not remove Row from 
</I>&gt;<i> Indexes when state is Deleted.
</I>&gt;<i> 		- CheckChildRows : When checking for the 
</I>&gt;<i> ChildRows, use the current value
</I>&gt;<i> 		and not the original value.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- trunk/mcs/class/System.Data/System.Data/ChangeLog	
</I>&gt;<i> 2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ trunk/mcs/class/System.Data/System.Data/ChangeLog	
</I>&gt;<i> 2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -1,3 +1,10 @@
</I>&gt;<i> +2006-02-22  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> +	* DataRow.cs 
</I>&gt;<i> +		- RejectChanges : Do not remove Row from 
</I>&gt;<i> Indexes when state is Deleted.
</I>&gt;<i> +		- CheckChildRows : When checking for the 
</I>&gt;<i> ChildRows, use the current value
</I>&gt;<i> +		and not the original value.
</I>&gt;<i> +
</I>&gt;<i>  2006-02-18  Atsushi Enomoto  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
</I>&gt;<i>  
</I>&gt;<i>  	* CustomDataClassGenerator.cs : Patch by Marek 
</I>&gt;<i> Habersack. xsd now
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/System.Data/DataRow.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- trunk/mcs/class/System.Data/System.Data/DataRow.cs	
</I>&gt;<i> 2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ trunk/mcs/class/System.Data/System.Data/DataRow.cs	
</I>&gt;<i> 2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -591,14 +591,14 @@
</I>&gt;<i>  					return;
</I>&gt;<i>  			case DataRowState.Added:
</I>&gt;<i>  			case DataRowState.Modified:
</I>&gt;<i> -					int original = Original;
</I>&gt;<i> -					DataRowState oldState = 
</I>&gt;<i> RowState;
</I>&gt;<i> +				int original = Original;
</I>&gt;<i> +				DataRowState oldState = RowState;
</I>&gt;<i>                                  if (Original &gt;= 0) {
</I>&gt;<i>                                          
</I>&gt;<i> Table.RecordCache.DisposeRecord(Original);
</I>&gt;<i>                                  }
</I>&gt;<i>                                  Original = Current;
</I>&gt;<i> -					foreach (Index index in 
</I>&gt;<i> Table.Indexes)
</I>&gt;<i> -						
</I>&gt;<i> index.Update(this, original, DataRowVersion.Original, oldState);
</I>&gt;<i> +				foreach (Index index in Table.Indexes)
</I>&gt;<i> +					index.Update(this, 
</I>&gt;<i> original, DataRowVersion.Original, oldState);
</I>&gt;<i>  				break;
</I>&gt;<i>  			case DataRowState.Deleted:
</I>&gt;<i>  				Table.DeleteRowFromIndexes(this);
</I>&gt;<i> @@ -654,7 +654,7 @@
</I>&gt;<i>  				Proposed = -1;
</I>&gt;<i>  
</I>&gt;<i>  				foreach(Index index in Table.Indexes)
</I>&gt;<i> -					
</I>&gt;<i> index.Update(this,oldRecord, DataRowVersion.Proposed, 
</I>&gt;<i> oldState);					
</I>&gt;<i> +					
</I>&gt;<i> index.Update(this,oldRecord, DataRowVersion.Proposed, oldState);
</I>&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> @@ -695,9 +695,8 @@
</I>&gt;<i>  			if (Current &gt;= 0) {
</I>&gt;<i>  				int current = Current;
</I>&gt;<i>  				DataRowState oldState = RowState;
</I>&gt;<i> -				if (Current != Original) {
</I>&gt;<i> +				if (Current != Original)
</I>&gt;<i>  					
</I>&gt;<i> _table.RecordCache.DisposeRecord(Current);
</I>&gt;<i> -				}
</I>&gt;<i>  				Current = -1;
</I>&gt;<i>  				foreach(Index index in Table.Indexes)
</I>&gt;<i>  					index.Update(this, 
</I>&gt;<i> current, DataRowVersion.Current, oldState); @@ -769,7 +768,7 @@
</I>&gt;<i>  								
</I>&gt;<i> // change only the values in the key columns
</I>&gt;<i>  								
</I>&gt;<i> // set the childcolumn value to the new parent row value
</I>&gt;<i>  								
</I>&gt;<i> 	for (int k = 0; k &lt; fkc.Columns.Length; k++)
</I>&gt;<i> -								
</I>&gt;<i> 		if (!fkc.RelatedColumns [k].DataContainer 
</I>&gt;<i> [Original].Equals (fkc.RelatedColumns [k].DataContainer [Proposed]))
</I>&gt;<i> +								
</I>&gt;<i> 		if (!fkc.RelatedColumns [k].DataContainer 
</I>&gt;<i> [Current].Equals 
</I>&gt;<i> +(fkc.RelatedColumns [k].DataContainer [Proposed]))
</I>&gt;<i>  								
</I>&gt;<i> 			childRows[j][fkc.Columns[k]] = 
</I>&gt;<i> this[fkc.RelatedColumns[k], DataRowVersion.Proposed];
</I>&gt;<i>  
</I>&gt;<i>  								
</I>&gt;<i> 	break;
</I>&gt;<i> @@ -1340,7 +1339,6 @@
</I>&gt;<i>  				break;
</I>&gt;<i>  			case DataRowState.Deleted:
</I>&gt;<i>  				CheckChildRows (DataRowAction.Rollback);
</I>&gt;<i> -				Table.DeleteRowFromIndexes(this);
</I>&gt;<i>  				Current = Original;
</I>&gt;<i>  				break;
</I>&gt;<i>  			}
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/System.Data.Common/ChangeLog
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- trunk/mcs/class/System.Data/System.Data.Common/ChangeLog	
</I>&gt;<i> 2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ trunk/mcs/class/System.Data/System.Data.Common/ChangeLog	
</I>&gt;<i> 2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -1,3 +1,14 @@
</I>&gt;<i> +2006-02-22  Senganal T &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> +	* DbDataAdapter.cs :
</I>&gt;<i> +		- FillTable : Move BeginLoadData, EndLoadData 
</I>&gt;<i> outside the loop. Also,
</I>&gt;<i> +		move EndLoadData outsidet try,catch block. 
</I>&gt;<i> FillError is only for errors
</I>&gt;<i> +		occuring during loading the data into datatable.
</I>&gt;<i> +	* Key.cs :
</I>&gt;<i> +		- Set Default value of RowStateFilter to 
</I>&gt;<i> (CurrentRos | OriginalRows).
</I>&gt;<i> +		- ContainsVersion : If RowStateFilter is set to 
</I>&gt;<i> default value, return true
</I>&gt;<i> +		for Modified Rows as they can contain 
</I>&gt;<i> Default/Original versions.
</I>&gt;<i> +
</I>&gt;<i>  2006-02-18  Raja R Harinath  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">harinath at gmail.com</A>&gt;
</I>&gt;<i>  
</I>&gt;<i>  	* DbConnectionStringBuilder.cs (ICollection.CopyTo): Use
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data.Common/DbDataAdapter.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data.Common/DbDataAda
</I>&gt;<i> pter.cs	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data.Common/DbDataAda
</I>&gt;<i> pter.cs	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -408,13 +408,12 @@
</I>&gt;<i>  				dataReader.Read ();
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i> +			dataTable.BeginLoadData ();
</I>&gt;<i>  			while (dataReader.Read () &amp;&amp; 
</I>&gt;<i> (maxRecords == 0 || (counter - counterStart) &lt; maxRecords)) {
</I>&gt;<i>  				try {
</I>&gt;<i> -					dataTable.BeginLoadData ();
</I>&gt;<i>  					dataTable.LoadDataRow 
</I>&gt;<i> (dataReader, sortedMapping, length, AcceptChangesDuringFill);
</I>&gt;<i> -					dataTable.EndLoadData ();
</I>&gt;<i>  					counter++;
</I>&gt;<i> -				} 
</I>&gt;<i> +				}
</I>&gt;<i>  				catch (Exception e) {
</I>&gt;<i>  					object[] readerArray = 
</I>&gt;<i> new object[dataReader.FieldCount];
</I>&gt;<i>  					object[] tableArray = 
</I>&gt;<i> new object[mapping.Length]; @@ -428,20 +427,22 @@
</I>&gt;<i>  					}
</I>&gt;<i>  					FillErrorEventArgs args 
</I>&gt;<i> = CreateFillErrorEvent (dataTable, tableArray, e);
</I>&gt;<i>  					OnFillError (args);
</I>&gt;<i> -					if(!args.Continue) {
</I>&gt;<i> -						return false;
</I>&gt;<i> -					}
</I>&gt;<i> +
</I>&gt;<i> +					// if args.Continue is 
</I>&gt;<i> not set to true or if a handler is not set, rethrow the error..
</I>&gt;<i> +					if(!args.Continue)
</I>&gt;<i> +						throw e;
</I>&gt;<i>  				}
</I>&gt;<i>  			}
</I>&gt;<i> +			dataTable.EndLoadData ();
</I>&gt;<i>  			return true;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  #if NET_2_0
</I>&gt;<i> -                /// &lt;summary&gt;
</I>&gt;<i> -                ///     Fills the given datatable using 
</I>&gt;<i> values from reader. if a value 
</I>&gt;<i> -                ///     for a column is  null, that will be 
</I>&gt;<i> filled with default value. 
</I>&gt;<i> -                /// &lt;/summary&gt;
</I>&gt;<i> -                /// &lt;returns&gt;No. of rows affected &lt;/returns&gt;
</I>&gt;<i> +		/// &lt;summary&gt;
</I>&gt;<i> +		///     Fills the given datatable using values 
</I>&gt;<i> from reader. if a value 
</I>&gt;<i> +		///     for a column is  null, that will be 
</I>&gt;<i> filled with default value. 
</I>&gt;<i> +		/// &lt;/summary&gt;
</I>&gt;<i> +		/// &lt;returns&gt;No. of rows affected &lt;/returns&gt;
</I>&gt;<i>  		internal static int FillFromReader (DataTable table,
</I>&gt;<i>                                                      
</I>&gt;<i> IDataReader reader,
</I>&gt;<i>                                                      int start, 
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/System.Data.Common/Key.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- trunk/mcs/class/System.Data/System.Data.Common/Key.cs	
</I>&gt;<i> 2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ trunk/mcs/class/System.Data/System.Data.Common/Key.cs	
</I>&gt;<i> 2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -47,6 +47,7 @@
</I>&gt;<i>  		//	and always uses the _current version
</I>&gt;<i>  		//so need a temp row for Eval calls
</I>&gt;<i>  		DataRow _tmpRow;
</I>&gt;<i> +		static DataViewRowState DefaultRowStateFilter = 
</I>&gt;<i> +(DataViewRowState.CurrentRows | DataViewRowState.OriginalRows);
</I>&gt;<i>  
</I>&gt;<i>  		#endregion //Fields
</I>&gt;<i>  
</I>&gt;<i> @@ -69,13 +70,11 @@
</I>&gt;<i>  				}
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i> -			if (rowState != DataViewRowState.None) {
</I>&gt;<i> +			if (rowState != DataViewRowState.None)
</I>&gt;<i>  				_rowStateFilter = rowState;
</I>&gt;<i> -			}
</I>&gt;<i> -			else {
</I>&gt;<i> +			else
</I>&gt;<i>  				// FIXME : what is the correct value ?
</I>&gt;<i> -				_rowStateFilter = 
</I>&gt;<i> DataViewRowState.CurrentRows;
</I>&gt;<i> -			}
</I>&gt;<i> +				_rowStateFilter = DefaultRowStateFilter;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		#endregion // Constructors
</I>&gt;<i> @@ -166,77 +165,59 @@
</I>&gt;<i>  		internal bool ContainsVersion (DataRowState 
</I>&gt;<i> state, DataRowVersion version)
</I>&gt;<i>  		{
</I>&gt;<i>  			switch (state) {
</I>&gt;<i> -				case DataRowState.Unchanged: {
</I>&gt;<i> -					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Unchanged) != DataViewRowState.None) {
</I>&gt;<i> +				case DataRowState.Unchanged:
</I>&gt;<i> +					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Unchanged) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> ((version &amp; DataRowVersion.Default) != 0);
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i> -				}
</I>&gt;<i> -				case DataRowState.Added: {
</I>&gt;<i> -					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Added) != DataViewRowState.None) {
</I>&gt;<i> +				case DataRowState.Added:
</I>&gt;<i> +					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Added) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> ((version &amp; DataRowVersion.Default) != 0);
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i> -				}
</I>&gt;<i> -				case DataRowState.Deleted: {
</I>&gt;<i> -					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Deleted) != DataViewRowState.None) {
</I>&gt;<i> +				case DataRowState.Deleted:
</I>&gt;<i> +					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Deleted) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return (version 
</I>&gt;<i> == DataRowVersion.Original);
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i> -				}
</I>&gt;<i>  				default:
</I>&gt;<i> -					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedCurrent) != DataViewRowState.None) {
</I>&gt;<i> +					// If _rowStateFilter 
</I>&gt;<i> has the default value, return true
</I>&gt;<i> +					if (_rowStateFilter ==  
</I>&gt;<i> DefaultRowStateFilter)
</I>&gt;<i> +						return true;
</I>&gt;<i> +					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedCurrent) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> ((version &amp; DataRowVersion.Default) != 0);
</I>&gt;<i> -					}
</I>&gt;<i> -					else if 
</I>&gt;<i> ((_rowStateFilter &amp; DataViewRowState.ModifiedOriginal) != 
</I>&gt;<i> DataViewRowState.None) {
</I>&gt;<i> +					if ((_rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedOriginal) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return (version 
</I>&gt;<i> == DataRowVersion.Original);
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i> -            return false;
</I>&gt;<i> +			return false;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		internal static int GetRecord(DataRow row, 
</I>&gt;<i> DataViewRowState rowStateFilter)
</I>&gt;<i>  		{
</I>&gt;<i>  			switch (row.RowState) {
</I>&gt;<i>  				case DataRowState.Unchanged: {
</I>&gt;<i> -					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Unchanged) != DataViewRowState.None) {
</I>&gt;<i> +					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Unchanged) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> row.Proposed &gt;= 0 ? row.Proposed : row.Current;
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i>  				}
</I>&gt;<i>  				case DataRowState.Added: {
</I>&gt;<i> -					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Added) != DataViewRowState.None) {
</I>&gt;<i> +					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Added) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> row.Proposed &gt;= 0 ? row.Proposed : row.Current;
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i>  				}
</I>&gt;<i>  				case DataRowState.Deleted: {
</I>&gt;<i> -					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Deleted) != DataViewRowState.None) {
</I>&gt;<i> +					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.Deleted) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return row.Original;
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i>  				}
</I>&gt;<i>  				default:
</I>&gt;<i> -					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedCurrent) != DataViewRowState.None) {
</I>&gt;<i> +					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedCurrent) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return 
</I>&gt;<i> row.Proposed &gt;= 0 ? row.Proposed : row.Current;
</I>&gt;<i> -					}
</I>&gt;<i> -					else if 
</I>&gt;<i> ((rowStateFilter &amp; DataViewRowState.ModifiedOriginal) != 
</I>&gt;<i> DataViewRowState.None) {
</I>&gt;<i> +					if ((rowStateFilter &amp; 
</I>&gt;<i> DataViewRowState.ModifiedOriginal) != 
</I>&gt;<i> +DataViewRowState.None)
</I>&gt;<i>  						return row.Original;
</I>&gt;<i> -					}
</I>&gt;<i> -
</I>&gt;<i>  					break;
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i> -            return -1;
</I>&gt;<i> +			return -1;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		/// &lt;summary&gt;
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/ChangeLog
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/ChangeLog	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/ChangeLog	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -1,5 +1,9 @@
</I>&gt;<i>  2006-02-13  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i>  
</I>&gt;<i> +	* SqlAdapterTest.cs : Added testcases for verifying 
</I>&gt;<i> FillError Behavior
</I>&gt;<i> +
</I>&gt;<i> +2006-02-13  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> +
</I>&gt;<i>  	* SqlAdapterTest.cs : Added testcases for #77480
</I>&gt;<i>  
</I>&gt;<i>  2006-02-10  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/SqlDataAdapterTest.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/SqlDataAdapterTest.cs	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/ProviderTests/System.Data.Sql
</I>&gt;<i> Client/SqlDataAdapterTest.cs	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -388,7 +388,52 @@
</I>&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> +		bool FillErrorContinue = false;
</I>&gt;<i>  		[Test]
</I>&gt;<i> +		public void Fill_Test_FillErrorTest ()
</I>&gt;<i> +		{
</I>&gt;<i> +			string query = &quot;select type_bigint from 
</I>&gt;<i> numeric_family where id=1 or 
</I>&gt;<i> +id=4 &quot;;
</I>&gt;<i> +
</I>&gt;<i> +			DataSet ds = new DataSet ();
</I>&gt;<i> +			DataTable table = ds.Tables.Add (&quot;test&quot;);
</I>&gt;<i> +			table.Columns.Add (&quot;col&quot;, typeof (int));
</I>&gt;<i> +
</I>&gt;<i> +			adapter = new SqlDataAdapter (query, 
</I>&gt;<i> connectionString);
</I>&gt;<i> +			DataTableMapping mapping = 
</I>&gt;<i> adapter.TableMappings.Add (&quot;numeric_family&quot;, &quot;test&quot;);
</I>&gt;<i> +			mapping.ColumnMappings.Add 
</I>&gt;<i> (&quot;type_bigint&quot;, &quot;col&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			int count = 0;
</I>&gt;<i> +			try {
</I>&gt;<i> +				count = adapter.Fill (ds, 
</I>&gt;<i> &quot;numeric_family&quot;);
</I>&gt;<i> +				Assert.Fail (&quot;#1 Overflow 
</I>&gt;<i> exception must be thrown&quot;);
</I>&gt;<i> +			}catch (OverflowException e) {
</I>&gt;<i> +			}
</I>&gt;<i> +			Assert.AreEqual (0, ds.Tables 
</I>&gt;<i> [0].Rows.Count, &quot;#2&quot;);
</I>&gt;<i> +			Assert.AreEqual (0, count, &quot;#3&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			adapter.FillError += new 
</I>&gt;<i> FillErrorEventHandler (ErrorHandler);
</I>&gt;<i> +			FillErrorContinue = false;
</I>&gt;<i> +			try {
</I>&gt;<i> +				count = adapter.Fill (ds, 
</I>&gt;<i> &quot;numeric_family&quot;);
</I>&gt;<i> +				Assert.Fail (&quot;#4 Overflow 
</I>&gt;<i> exception must be thrown&quot;);
</I>&gt;<i> +			}catch (OverflowException e) {
</I>&gt;<i> +			}
</I>&gt;<i> +			Assert.AreEqual (0, ds.Tables 
</I>&gt;<i> [0].Rows.Count, &quot;#5&quot;);
</I>&gt;<i> +			Assert.AreEqual (0, count, &quot;#6&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			FillErrorContinue = true;
</I>&gt;<i> +			count = adapter.Fill (ds, &quot;numeric_family&quot;);
</I>&gt;<i> +			// 1 row shud be filled
</I>&gt;<i> +			Assert.AreEqual (1, ds.Tables 
</I>&gt;<i> [0].Rows.Count, &quot;#7&quot;);
</I>&gt;<i> +			Assert.AreEqual (1, count, &quot;#8&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		void ErrorHandler (object sender, 
</I>&gt;<i> FillErrorEventArgs args)
</I>&gt;<i> +		{
</I>&gt;<i> +			args.Continue = FillErrorContinue;
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		[Test]
</I>&gt;<i>  		public void GetFillParametersTest ()
</I>&gt;<i>  		{
</I>&gt;<i>  			string query = &quot;select id, type_bit 
</I>&gt;<i> from numeric_family where id &gt; @param1&quot;;
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/Test/System.Data/ChangeLog
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- trunk/mcs/class/System.Data/Test/System.Data/ChangeLog	
</I>&gt;<i> 2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ trunk/mcs/class/System.Data/Test/System.Data/ChangeLog	
</I>&gt;<i> 2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -1,3 +1,11 @@
</I>&gt;<i> +2006-02-22  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> +	* DataRowCollectionTest2.cs : Check if index is 
</I>&gt;<i> maintained for row on calling RejectChanges. 
</I>&gt;<i> +	* DataTableTest2.cs : Check if data is loaded and 
</I>&gt;<i> merged (if key exists) correctly.
</I>&gt;<i> +	* ForeignKeyConstraintTest.cs : Check if a ParentColumn 
</I>&gt;<i> value can be modified
</I>&gt;<i> +		when the row is in 'Added' State. Also, check 
</I>&gt;<i> if child col values are
</I>&gt;<i> +		updated correctly.
</I>&gt;<i> +
</I>&gt;<i>  2006-02-16  Senganal T  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tsenganal at novell.com</A>&gt;
</I>&gt;<i>  
</I>&gt;<i>  	* DataSetTest2.cs :
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataRowCollectionTest2.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataRowCollection
</I>&gt;<i> Test2.cs	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataRowCollection
</I>&gt;<i> Test2.cs	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -183,6 +183,22 @@
</I>&gt;<i>  			dt.Rows.Add((Object[])null);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void FindByKey ()
</I>&gt;<i> +		{
</I>&gt;<i> +			DataTable table = new DataTable ();
</I>&gt;<i> +			table.Columns.Add (&quot;col1&quot;, typeof (int));
</I>&gt;<i> +			table.PrimaryKey = new DataColumn[] 
</I>&gt;<i> {table.Columns [0]};
</I>&gt;<i> +
</I>&gt;<i> +			table.Rows.Add (new object[] {1});
</I>&gt;<i> +			table.AcceptChanges ();
</I>&gt;<i> +			Assert.IsNotNull (table.Rows.Find (new 
</I>&gt;<i> object[] {1}), &quot;#1&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			table.Rows[0].Delete ();
</I>&gt;<i> +			table.RejectChanges ();
</I>&gt;<i> +			Assert.IsNotNull (table.Rows.Find (new 
</I>&gt;<i> object[] {1}), &quot;#2&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i>  		[Test]
</I>&gt;<i>  		public void DataRowCollection_Clear1()
</I>&gt;<i>  		{
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataTableTest2.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataTableT
</I>&gt;<i> est2.cs	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/DataTableT
</I>&gt;<i> est2.cs	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -1949,6 +1949,44 @@
</I>&gt;<i>  			Assert.AreEqual (1, 
</I>&gt;<i> table.Constraints.Count, &quot;#1&quot;);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void LoadDataRow_ExistingData ()
</I>&gt;<i> +		{
</I>&gt;<i> +			DataSet ds = new DataSet ();
</I>&gt;<i> +			DataTable table = ds.Tables.Add ();
</I>&gt;<i> +			
</I>&gt;<i> +			table.Columns.Add (&quot;col1&quot;, typeof (int));
</I>&gt;<i> +			table.Columns.Add (&quot;col2&quot;, typeof (int));
</I>&gt;<i> +			table.PrimaryKey = new DataColumn[] 
</I>&gt;<i> {table.Columns [0]};
</I>&gt;<i> +
</I>&gt;<i> +			table.BeginLoadData ();
</I>&gt;<i> +			table.LoadDataRow (new object[] {1,10}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {2,10}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {3,10}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {4,10}, true);
</I>&gt;<i> +			table.EndLoadData ();
</I>&gt;<i> +
</I>&gt;<i> +			Assert.AreEqual (4, table.Rows.Count, &quot;#1&quot;);
</I>&gt;<i> +			Assert.AreEqual (10, table.Rows [0][1], &quot;#2&quot;);
</I>&gt;<i> +			Assert.AreEqual (10, table.Rows [1][1], &quot;#3&quot;);
</I>&gt;<i> +			Assert.AreEqual (10, table.Rows [2][1], &quot;#4&quot;);
</I>&gt;<i> +			Assert.AreEqual (10, table.Rows [3][1], &quot;#5&quot;);
</I>&gt;<i> +	
</I>&gt;<i> +
</I>&gt;<i> +			table.BeginLoadData ();
</I>&gt;<i> +			table.LoadDataRow (new object[] {1,100}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {2,100}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {3,100}, true);
</I>&gt;<i> +			table.LoadDataRow (new object[] {4,100}, true);
</I>&gt;<i> +			table.EndLoadData ();
</I>&gt;<i> +
</I>&gt;<i> +			Assert.AreEqual (4, table.Rows.Count, &quot;#6&quot;);
</I>&gt;<i> +			Assert.AreEqual (100, table.Rows [0][1], &quot;#7&quot;);
</I>&gt;<i> +			Assert.AreEqual (100, table.Rows [1][1], &quot;#8&quot;);
</I>&gt;<i> +			Assert.AreEqual (100, table.Rows [2][1], &quot;#7&quot;);
</I>&gt;<i> +			Assert.AreEqual (100, table.Rows [3][1], &quot;#10&quot;);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i>  		private void OnRowDeleting_Handler(Object 
</I>&gt;<i> sender,DataRowChangeEventArgs e)
</I>&gt;<i>  		{
</I>&gt;<i>  			
</I>&gt;<i> 
</I>&gt;<i> Modified: 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/ForeignKeyConstra
</I>&gt;<i> intTest.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/ForeignKeyConstra
</I>&gt;<i> intTest.cs	2006-02-22 09:35:09 UTC (rev 57148)
</I>&gt;<i> +++ 
</I>&gt;<i> trunk/mcs/class/System.Data/Test/System.Data/ForeignKeyConstra
</I>&gt;<i> intTest.cs	2006-02-22 10:03:03 UTC (rev 57149)
</I>&gt;<i> @@ -509,5 +509,22 @@
</I>&gt;<i>  				_ds.EnforceConstraints = true;
</I>&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i> +
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		public void ModifyParentKeyBeforeAcceptChanges ()
</I>&gt;<i> +		{
</I>&gt;<i> +			DataSet ds1 = new DataSet();
</I>&gt;<i> +			DataTable t1= ds1.Tables.Add (&quot;t1&quot;);
</I>&gt;<i> +			DataTable t2= ds1.Tables.Add (&quot;t2&quot;);
</I>&gt;<i> +			t1.Columns.Add (&quot;col1&quot;, typeof (int));
</I>&gt;<i> +			t2.Columns.Add (&quot;col2&quot;, typeof (int));
</I>&gt;<i> +			ds1.Relations.Add (&quot;fk&quot;, t1.Columns 
</I>&gt;<i> [0], t2.Columns [0]);
</I>&gt;<i> +
</I>&gt;<i> +			t1.Rows.Add (new object[] {10});
</I>&gt;<i> +			t2.Rows.Add (new object [] {10});
</I>&gt;<i> +
</I>&gt;<i> +			t1.Rows [0][0]=20;
</I>&gt;<i> +			Assert(&quot;#1&quot;, (int)t2.Rows [0][0] == 20);
</I>&gt;<i> +		}
</I>&gt;<i>  	}
</I>&gt;<i>  }
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-patches maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A> 
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Class2.cs
Type: application/octet-stream
Size: 731 bytes
Desc: Class2.cs
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060306/09efca47/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060306/09efca47/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017443.html">[Mono-dev] GDI+ and GetNearestColor
</A></li>
	<LI>Next message: <A HREF="017426.html">[Mono-dev] RE: [Mono-patches] r57149 -	in	trunk/mcs/class/System.Data:	System.DataSystem.Data.Common	Test/ProviderTests/System.Data.SqlClientTest/System.Data
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17425">[ date ]</a>
              <a href="thread.html#17425">[ thread ]</a>
              <a href="subject.html#17425">[ subject ]</a>
              <a href="author.html#17425">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
