<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] PtrToStringAnsi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20PtrToStringAnsi&In-Reply-To=1141850302.8011.18.camel%40linux.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017474.html">
   <LINK REL="Next"  HREF="017493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] PtrToStringAnsi</H1>
    <B>Joshua Tauberer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20PtrToStringAnsi&In-Reply-To=1141850302.8011.18.camel%40linux.site"
       TITLE="[Mono-dev] PtrToStringAnsi">tauberer at for.net
       </A><BR>
    <I>Thu Mar  9 09:09:06 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017474.html">[Mono-dev] PtrToStringAnsi
</A></li>
        <LI>Next message: <A HREF="017493.html">[Mono-dev] PtrToStringAnsi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17489">[ date ]</a>
              <a href="thread.html#17489">[ thread ]</a>
              <a href="subject.html#17489">[ subject ]</a>
              <a href="author.html#17489">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Atsushi wrote:
&gt;<i> Mono does not support non-UTF8 multibyte conversion by design.
</I>
That's ok, but whatever we marshal out we should be able to marshal
back, yeah?

Okay, so after some more digging and realizing things are more
complicated than I thought, here's what I've learned:

PtrToStringAnsi does a UTF-8-to-UTF-16 conversion

StringToHGlobalAnsi does exactly the reverse

StringToCoTaskMemAnsi does something totally different!  It does
something kind of like a conversion to ANSI (or maybe it is ANSI, I'm
not sure).  There's no way to marshal such pointers back.

While the Ptr and HGlobal methods are icalls, the CoTaskMem methods are
in C#.

My confusion yesterday came from my assumption that
StringToCoTaskMemAnsi was simply wrapping StringToHGlobalAnsi, whose
implementation I was looking at.  StringToHGlobalAnsi eventually calls
the glib conversion function, and so I was expecting to see UTF-8 in the
resulting bytes whereas I was only seeing ANSI.

Anyway, I think StringToCoTaskMemAnsi should be changed to do exactly
the same thing as StringToHGlobalAnsi, right?  StringToCoTaskMemUni also
has a managed implementation, and while it looks OK, it strangely also
doesn't reuse the implementation of StringToHGlobalUni.

-- 
- Joshua Tauberer

<A HREF="http://taubz.for.net">http://taubz.for.net</A>

&quot;Unfortunately, we're having this discussion. It's too bad,
because guess who listens to the discussion: the enemy.&quot;

Atsushi Eno wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> Mono does not support non-UTF8 multibyte conversion by design. We
</I>&gt;<i> shouldn't change its behavior from current one. Actually it is pretty
</I>&gt;<i> classic matter which has been stated since 2003.
</I>&gt;<i> <A HREF="http://lists.ximian.com/archives/public/mono-list/2003-June/014500.html">http://lists.ximian.com/archives/public/mono-list/2003-June/014500.html</A>
</I>&gt;<i> 
</I>&gt;<i> It is Microsoft who should provide additional marshaling flags so that
</I>&gt;<i> it will be truly functional on every platforms (especially considering
</I>&gt;<i> that there is also Gtk+ on Windows which is apparently designed to work
</I>&gt;<i> on Windows and uses UTF-8 based marshaling). AFAIK they are also aware
</I>&gt;<i> on this matter through ECMA meetings.
</I>&gt;<i> 
</I>&gt;<i> Atsushi Eno
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> While debugging a SqliteClient issue, I came across an interesting bug.
</I>&gt;&gt;<i>  The following returns null when I'm pretty sure it should not (it
</I>&gt;&gt;<i> doesn't on Windows):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Marshal.PtrToStringAnsi(Marshal.StringToCoTaskMemAnsi(&quot;&#252;&quot;))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In case the encoding of this email gets messed up, that's a u with
</I>&gt;&gt;<i> umlauts, (char)0xFC.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The encoding half &quot;works&quot; (Marshal.ReadByte reports the bytes (0xFC
</I>&gt;&gt;<i> 0x00)), on the assumption that I'm supposed to get ANSI out of this
</I>&gt;&gt;<i> method.  Internally, g_utf16_to_utf8 is used, which means that (besides
</I>&gt;&gt;<i> being surprised this call doesn't actually do ANSI encoding) I would
</I>&gt;&gt;<i> actually expect a multibyte representation of that character.  That's
</I>&gt;&gt;<i> from a few minutes of Googling for info on UTF-8.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So I'm confused.  Can someone with more knowledge about encodings tell
</I>&gt;&gt;<i> me whether this really doesn't make sense?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm using the latest RPMs.  Here's a test program:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using System;
</I>&gt;&gt;<i> using System.Runtime.InteropServices;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> public class Test {
</I>&gt;&gt;<i>     public static void Main() 		
</I>&gt;&gt;<i> Console.WriteLine(Marshal.PtrToStringAnsi(Marshal.StringToCoTaskMemAnsi(&quot;&#252;&quot;)));
</I>&gt;&gt;<i> 	}
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017474.html">[Mono-dev] PtrToStringAnsi
</A></li>
	<LI>Next message: <A HREF="017493.html">[Mono-dev] PtrToStringAnsi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17489">[ date ]</a>
              <a href="thread.html#17489">[ thread ]</a>
              <a href="subject.html#17489">[ subject ]</a>
              <a href="author.html#17489">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
