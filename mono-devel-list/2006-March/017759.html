<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]: Implement Sparc exceptions correctly under	Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Implement%20Sparc%20exceptions%20correctly%20under%0A%09Linux&In-Reply-To=20060324.152743.36885617.davem%40davemloft.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017757.html">
   <LINK REL="Next"  HREF="017760.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under	Linux</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Implement%20Sparc%20exceptions%20correctly%20under%0A%09Linux&In-Reply-To=20060324.152743.36885617.davem%40davemloft.net"
       TITLE="[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under	Linux">vargaz at gmail.com
       </A><BR>
    <I>Fri Mar 24 19:00:51 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017757.html">[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under Linux
</A></li>
        <LI>Next message: <A HREF="017760.html">[Mono-dev] _wapi_sparc_lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17759">[ date ]</a>
              <a href="thread.html#17759">[ thread ]</a>
              <a href="subject.html#17759">[ subject ]</a>
              <a href="author.html#17759">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                              Hey,

  These patches are now in SVN HEAD and the 1.1.13 branch. Thanks !

                          Zoltan

On 3/25/06, David S. Miller &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at davemloft.net</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Linux does not pass a ucontext_t to signal handlers, instead
</I>&gt;<i> it passes in a &quot;struct sigcontext&quot;.  The layout is different
</I>&gt;<i> for 64-bit vs 32-bit chips.
</I>&gt;<i>
</I>&gt;<i> This patch implements the necessary support.
</I>&gt;<i>
</I>&gt;<i> With this and the libgc configure.in patch I just posted the
</I>&gt;<i> testsuite seems to be running quite well.
</I>&gt;<i>
</I>&gt;<i> Thanks.
</I>&gt;<i>
</I>&gt;<i> 2006-03-24  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at sunset.davemloft.net</A>&gt;
</I>&gt;<i>
</I>&gt;<i>         * exceptions-sparc.c (mono_arch_handle_exception,
</I>&gt;<i>         mono_arch_ip_from_context): Implement correctly for Linux.
</I>&gt;<i>
</I>&gt;<i> --- mono/mini/exceptions-sparc.c.~1~    2005-01-28 06:54:11.000000000 -0800
</I>&gt;<i> +++ mono/mini/exceptions-sparc.c        2006-03-24 15:01:22.000000000 -0800
</I>&gt;<i> @@ -425,6 +425,58 @@
</I>&gt;<i>         return FALSE;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> +#ifdef __linux__
</I>&gt;<i> +gboolean
</I>&gt;<i> +mono_arch_handle_exception (void *sigctx, gpointer obj, gboolean test_only)
</I>&gt;<i> +{
</I>&gt;<i> +       MonoContext mctx;
</I>&gt;<i> +       struct sigcontext *sc = sigctx;
</I>&gt;<i> +       gpointer *window;
</I>&gt;<i> +
</I>&gt;<i> +#ifdef SPARCV9
</I>&gt;<i> +       mctx.ip = (gpointer) sc-&gt;sigc_regs.tpc;
</I>&gt;<i> +       mctx.sp = (gpointer) sc-&gt;sigc_regs.u_regs[14];
</I>&gt;<i> +#else
</I>&gt;<i> +       mctx.ip = (gpointer) sc-&gt;si_regs.pc;
</I>&gt;<i> +       mctx.sp = (gpointer) sc-&gt;si_regs.u_regs[14];
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> +       window = (gpointer*)(((guint8*)mctx.sp) + MONO_SPARC_STACK_BIAS);
</I>&gt;<i> +       mctx.fp = window [sparc_fp - 16];
</I>&gt;<i> +
</I>&gt;<i> +       mono_handle_exception (&amp;mctx, obj, mctx.ip, test_only);
</I>&gt;<i> +
</I>&gt;<i> +#ifdef SPARCV9
</I>&gt;<i> +       sc-&gt;sigc_regs.tpc = (unsigned long) mctx.ip;
</I>&gt;<i> +       sc-&gt;sigc_regs.tnpc = (unsigned long) (mctx.ip + 4);
</I>&gt;<i> +       sc-&gt;sigc_regs.u_regs[14] = (unsigned long) mctx.sp;
</I>&gt;<i> +#else
</I>&gt;<i> +       sc-&gt;si_regs.pc = (unsigned long) mctx.ip;
</I>&gt;<i> +       sc-&gt;si_regs.npc = (unsigned long) (mctx.ip + 4);
</I>&gt;<i> +       sc-&gt;si_regs.u_regs[14] = (unsigned long) mctx.sp;
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> +       window = (gpointer*)(((guint8*)mctx.sp) + MONO_SPARC_STACK_BIAS);
</I>&gt;<i> +       window [sparc_fp - 16] = mctx.fp;
</I>&gt;<i> +
</I>&gt;<i> +       return TRUE;
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +gpointer
</I>&gt;<i> +mono_arch_ip_from_context (void *sigctx)
</I>&gt;<i> +{
</I>&gt;<i> +       struct sigcontext *sc = sigctx;
</I>&gt;<i> +       gpointer *ret;
</I>&gt;<i> +
</I>&gt;<i> +#ifdef SPARCV9
</I>&gt;<i> +       ret = (gpointer) sc-&gt;sigc_regs.tpc;
</I>&gt;<i> +#else
</I>&gt;<i> +       ret = (gpointer) sc-&gt;si_regs.pc;
</I>&gt;<i> +#endif
</I>&gt;<i> +
</I>&gt;<i> +       return ret;
</I>&gt;<i> +}
</I>&gt;<i> +#else
</I>&gt;<i>  gboolean
</I>&gt;<i>  mono_arch_handle_exception (void *sigctx, gpointer obj, gboolean test_only)
</I>&gt;<i>  {
</I>&gt;<i> @@ -437,12 +489,7 @@
</I>&gt;<i>          * under documented under solaris. The code below seems to work under
</I>&gt;<i>          * Solaris 9.
</I>&gt;<i>          */
</I>&gt;<i> -#ifndef __linux__
</I>&gt;<i>         g_assert (!ctx-&gt;uc_mcontext.gwins);
</I>&gt;<i> -#else
</I>&gt;<i> -       /* better, but doesn't work all the time.  need to rethink! */
</I>&gt;<i> -       g_assert (!ctx-&gt;uc_mcontext.gregs);
</I>&gt;<i> -#endif
</I>&gt;<i>
</I>&gt;<i>         mctx.ip = ctx-&gt;uc_mcontext.gregs [REG_PC];
</I>&gt;<i>         mctx.sp = ctx-&gt;uc_mcontext.gregs [REG_SP];
</I>&gt;<i> @@ -467,4 +514,4 @@
</I>&gt;<i>         ucontext_t *ctx = (ucontext_t*)sigctx;
</I>&gt;<i>         return (gpointer)ctx-&gt;uc_mcontext.gregs [REG_PC];
</I>&gt;<i>  }
</I>&gt;<i> -
</I>&gt;<i> +#endif
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017757.html">[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under Linux
</A></li>
	<LI>Next message: <A HREF="017760.html">[Mono-dev] _wapi_sparc_lock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17759">[ date ]</a>
              <a href="thread.html#17759">[ thread ]</a>
              <a href="subject.html#17759">[ subject ]</a>
              <a href="author.html#17759">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
