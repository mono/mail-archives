<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch to boost speed of UnicodeEncoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20to%20boost%20speed%20of%20UnicodeEncoding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017551.html">
   <LINK REL="Next"  HREF="017610.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch to boost speed of UnicodeEncoding</H1>
    <B>Andreas Nahr</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20to%20boost%20speed%20of%20UnicodeEncoding&In-Reply-To="
       TITLE="[Mono-dev] Patch to boost speed of UnicodeEncoding">ClassDevelopment at A-SoftTech.com
       </A><BR>
    <I>Thu Mar 16 15:11:21 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017551.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
        <LI>Next message: <A HREF="017610.html">String performance boost (Re: [Mono-dev] Patch to boost speed of	UnicodeEncoding)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17609">[ date ]</a>
              <a href="thread.html#17609">[ thread ]</a>
              <a href="subject.html#17609">[ subject ]</a>
              <a href="author.html#17609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Zac, Hi Korn&#233;l,

I've been working quite some time on improving the existing String class a
long time ago (about 2-3 years), but as I got a new job back then never had
the time to finish anything. My findings back then were that purely managed
implementations basically always outperformed the internalcalls (And I guess
the JIT is now even more evolved than it was 3 years ago).
However as I sayed it was never finished and contains bugs. Moreover it
doesn't care at all for alignment issues.
If anyone want's to look at it - I attach my String-Testing class. You'll
find lots of different tries to optimize the Methods. But beware, the code
is in horrible shape, far from being usable.
Some optimizations use specific string-domain knowlege (like &quot;equals&quot;
testing first for the first char and after that from the end of the string)

My conclusion was: We should have a few managed functions to do the work
(MemoryCopy, MemoryCompare, possibly for Byte* and Char*). They should be
managed so that optimizers and optimizing compilers are able to do
optimizations even on IL level. Whenever possible the JIT should replace
these at runtime (provided they aren't optimized away) with
architecture-specific assembly versions with the managed version as fallback
mechanism.


Here are some findings from microbenchmarks made back then (the first number
is always the time in milliseconds for the existing unmanaged implementation
(internalcall), the second for a tested managed implementation, the Number
in () is the length of the string tested):

Some Methods still need internalcalls to create new Strings, but were still
faster than the native implementations (The optimum would be to internalize
InternalAllocateStr calls).

CopyTo (000): 810 -&gt; 381
CopyTo (010): 832 -&gt; 441
CopyTo (100): 1352 -&gt; 881
CopyTo (512): 3395 -&gt; 3014

ToCharArray (000): 5067 -&gt; 4466
ToCharArray (002): 5317 -&gt; 4857
ToCharArray (015): 8041 -&gt; 7691
ToCharArray (960): 2915 -&gt; 2894

ToCharArray (with parameters): Similar to above

Trim (): 6930 -&gt; 6760
Trim (custom search Chars): 10596 -&gt; 9413
Trim (default search Chars): 10455 -&gt; 7210
Trim (no trimmed chars, long string): 1893 -&gt; 661
Trim (no trimmed chars, short string): 1893 -&gt; 631

Replace (004 - one replace): 37264 -&gt; 3135
Replace (004 - nothing to replace): 3735 -&gt; 310
Replace (961 - everything replaced): 2584 -&gt; 501
Replace (961 - only last char replaced): 2463 -&gt; 481

Split (default split Chars, long string, lots splitted): 42421 -&gt; 8523
Split (custom split Chars, long string, non found): 2944 -&gt; 2263
Split (custom split Chars, long string, lots found): 22062 -&gt; 7330
Split (default split Chars, short string, non found): 2093 -&gt; 761
Split (default split Chars, short string, nearly only splitChars): 8002 -&gt;
5067

IndexOf (17): 1132 -&gt; 791
IndexOf (2162): 10576 -&gt; 7862

LastIndexOf (similar to above)

IndexOfAny (long string, nothing found): 25867 -&gt; 2984 (Break even bei ca.
75chars)

LastIndexOfAny  (similar to above)

PadLeft/ PadRight: slightly slower that current (Should get faster once
optimized CharCopy is available): 1012 -&gt; 1031

Remove: slightly slower that current (Should get faster once optimized
CharCopy is available): 2153 -&gt; 2283


If somebody is interesting in picking this up I might be able to help a
litte.
Andreas

----- Original Message ----- 
From: &quot;Zac Bowling&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">zac at zacbowling.com</A>&gt;
To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;
Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Sunday, March 12, 2006 12:33 AM
Subject: Re: [Mono-dev] Patch to boost speed of UnicodeEncoding


That's interesting. Thanks for that. That gives me a another
perspective on it.

One thing though. I think it should be &quot;BitConverter.IsLittleEndian ==
bigEndian&quot; rather then not &quot;!=&quot;. If the System is little Endian and the
conversions is not big Endian, then it would be the same. That confused
me at first too and your test didn't catch that because it reverses
what it do each time.

I didn't even think of using buffer.blockcopy here. That's pretty cool.
I was going off the code inside String.cs which uses a set of functions
called &quot;memcpy&quot;. I need to do some research on why we don't use
BlockCopyInternal inside String.cs (maybe String.cs hasn't been looked
at in a while).

I'm going to setup up a profiler and some testing/sanity checking
scripts to start testing the speed advantages we get from mixing and
matching all these methods to see how we can tweak everything there.
Might even find a way to tweak the base string class if
InternalBlockCopy is faster then that managed memcpy function (which
would speed up almost everything in Mono that uses String.Substring,
String.Clone, String.Concat, etc...)

Thanks a bunch...

Time for double byte char and pointer logic fun! -- Zac Bowling
<A HREF="http://zacbowling.com/">http://zacbowling.com/</A>


----- Message from <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A> ---------
    Date: Sat, 11 Mar 2006 14:40:33 +0100
    From: Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;
Reply-To: Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;
Subject: Re: [Mono-dev] Patch to boost speed of UnicodeEncoding
      To: Zac Bowling &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">zac at zacbowling.com</A>&gt;, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>


&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I think doing something like in the attached draft is faster. No new 
</I>&gt;<i> String
</I>&gt;<i> object is created. Arrays are accessed using pointers. And I think there 
</I>&gt;<i> is
</I>&gt;<i> no use to use a more complicated conversion method for short strings.
</I>&gt;<i>
</I>&gt;<i> This draft is very unsafe. It lacks of any checks and does not perform any
</I>&gt;<i> special character or byte sequence handling.
</I>&gt;<i>
</I>&gt;<i> Note that I haven't done any tests to determine whether using byte pointer
</I>&gt;<i> or using int pointers and shift operations to swap bytes is faster. But
</I>&gt;<i> mixing bytes an ints results in two different code for big and little 
</I>&gt;<i> endian
</I>&gt;<i> encodings while byte swapping can be performed using a single code when
</I>&gt;<i> using only bytes or only ints.
</I>&gt;<i>
</I>&gt;<i> Korn&#233;l
</I>&gt;<i>
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i> From: &quot;Zac Bowling&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">zac at zacbowling.com</A>&gt;
</I>&gt;<i> To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Sent: Saturday, March 11, 2006 1:09 PM
</I>&gt;<i> Subject: [Mono-dev] Patch to boost speed of UnicodeEncoding
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Alright guys,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is a cool (and still incomplete) patch to speed up
</I>&gt;&gt;<i> System.Text.UnicodeEncoding I'm working on. Just want to make sure this
</I>&gt;&gt;<i> is sane before I finish it by getting everyone's opinions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was tinkering with this idea. Since the strings are stored in memory
</I>&gt;&gt;<i> as UTF-16 (UCS 2) already, the idea of converting them with like we do
</I>&gt;&gt;<i> with a while loop, one char at a time, was really bothering me.
</I>&gt;&gt;<i> Directly copying whats in memory seems a little bit more sane. I don't
</I>&gt;&gt;<i> want to make it sound that easy because it isn't (and maybe why it
</I>&gt;&gt;<i> wasn't done like this when it was first written). :-P
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The biggest problem is that UnicodeEncoding can be bigEndian or
</I>&gt;&gt;<i> littleEndian so I went through the logic and testing to see if the
</I>&gt;&gt;<i> system's endian (with 'BitConverter.IsLittleEndian') matched the endian
</I>&gt;&gt;<i> of the current Encoding class (using the 'bigEndian' bool field) and if
</I>&gt;&gt;<i> it doesn't then use the same method we already use. (Is that right? Is
</I>&gt;&gt;<i> the internal version of utf-16 we use in our strings specific to the
</I>&gt;&gt;<i> endian of the system? I assumed yes here but if it's not, it's a simple
</I>&gt;&gt;<i> change to remark it out.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also since the memcpy function in String.cs uses some unsafe logic,
</I>&gt;&gt;<i> taking a possible hit for that with a really small string seems silly,
</I>&gt;&gt;<i> so I put in an condition that if the char count is less then or equal
</I>&gt;&gt;<i> to 10 chars, then use the existing method. (Maybe 10 chars should be
</I>&gt;&gt;<i> adjusted or is that idea silly?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Below is an unfinished sample of my idea. Of course I will have to
</I>&gt;&gt;<i> reverse this logic for GetChars() (instead of GetBytes below) and
</I>&gt;&gt;<i> finish the overloads in System.Text.UnicodeEncoding's GetBytes and
</I>&gt;&gt;<i> GetChars methods but I want to see what everything thinks.
</I>&gt;<i>
</I>

----- End message from <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A> -----


_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: String.cs.old
Type: application/octet-stream
Size: 69614 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060316/f385242b/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060316/f385242b/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017551.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
	<LI>Next message: <A HREF="017610.html">String performance boost (Re: [Mono-dev] Patch to boost speed of	UnicodeEncoding)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17609">[ date ]</a>
              <a href="thread.html#17609">[ thread ]</a>
              <a href="subject.html#17609">[ subject ]</a>
              <a href="author.html#17609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
