<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH]: Implement Sparc exceptions correctly under Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Implement%20Sparc%20exceptions%20correctly%20under%20Linux&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017756.html">
   <LINK REL="Next"  HREF="017759.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under Linux</H1>
    <B>David S. Miller</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%3A%20Implement%20Sparc%20exceptions%20correctly%20under%20Linux&In-Reply-To="
       TITLE="[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under Linux">davem at davemloft.net
       </A><BR>
    <I>Fri Mar 24 18:27:43 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017756.html">[Mono-dev] [PATCH]: Fix build on sparc*-*-linux*
</A></li>
        <LI>Next message: <A HREF="017759.html">[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17757">[ date ]</a>
              <a href="thread.html#17757">[ thread ]</a>
              <a href="subject.html#17757">[ subject ]</a>
              <a href="author.html#17757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Linux does not pass a ucontext_t to signal handlers, instead
it passes in a &quot;struct sigcontext&quot;.  The layout is different
for 64-bit vs 32-bit chips.

This patch implements the necessary support.

With this and the libgc configure.in patch I just posted the
testsuite seems to be running quite well.

Thanks.

2006-03-24  David S. Miller  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">davem at sunset.davemloft.net</A>&gt;

	* exceptions-sparc.c (mono_arch_handle_exception,
	mono_arch_ip_from_context): Implement correctly for Linux.

--- mono/mini/exceptions-sparc.c.~1~	2005-01-28 06:54:11.000000000 -0800
+++ mono/mini/exceptions-sparc.c	2006-03-24 15:01:22.000000000 -0800
@@ -425,6 +425,58 @@
 	return FALSE;
 }
 
+#ifdef __linux__
+gboolean
+mono_arch_handle_exception (void *sigctx, gpointer obj, gboolean test_only)
+{
+	MonoContext mctx;
+	struct sigcontext *sc = sigctx;
+	gpointer *window;
+
+#ifdef SPARCV9
+	mctx.ip = (gpointer) sc-&gt;sigc_regs.tpc;
+	mctx.sp = (gpointer) sc-&gt;sigc_regs.u_regs[14];
+#else
+	mctx.ip = (gpointer) sc-&gt;si_regs.pc;
+	mctx.sp = (gpointer) sc-&gt;si_regs.u_regs[14];
+#endif
+
+	window = (gpointer*)(((guint8*)mctx.sp) + MONO_SPARC_STACK_BIAS);
+	mctx.fp = window [sparc_fp - 16];
+
+	mono_handle_exception (&amp;mctx, obj, mctx.ip, test_only);
+	
+#ifdef SPARCV9
+	sc-&gt;sigc_regs.tpc = (unsigned long) mctx.ip;
+	sc-&gt;sigc_regs.tnpc = (unsigned long) (mctx.ip + 4);
+	sc-&gt;sigc_regs.u_regs[14] = (unsigned long) mctx.sp;
+#else
+	sc-&gt;si_regs.pc = (unsigned long) mctx.ip;
+	sc-&gt;si_regs.npc = (unsigned long) (mctx.ip + 4);
+	sc-&gt;si_regs.u_regs[14] = (unsigned long) mctx.sp;
+#endif
+
+	window = (gpointer*)(((guint8*)mctx.sp) + MONO_SPARC_STACK_BIAS);
+	window [sparc_fp - 16] = mctx.fp;
+
+	return TRUE;
+}
+
+gpointer
+mono_arch_ip_from_context (void *sigctx)
+{
+	struct sigcontext *sc = sigctx;
+	gpointer *ret;
+
+#ifdef SPARCV9
+	ret = (gpointer) sc-&gt;sigc_regs.tpc;
+#else
+	ret = (gpointer) sc-&gt;si_regs.pc;
+#endif
+
+	return ret;
+}
+#else
 gboolean
 mono_arch_handle_exception (void *sigctx, gpointer obj, gboolean test_only)
 {
@@ -437,12 +489,7 @@
 	 * under documented under solaris. The code below seems to work under
 	 * Solaris 9.
 	 */
-#ifndef __linux__
 	g_assert (!ctx-&gt;uc_mcontext.gwins);
-#else
-	/* better, but doesn't work all the time.  need to rethink! */
-	g_assert (!ctx-&gt;uc_mcontext.gregs);
-#endif
 
 	mctx.ip = ctx-&gt;uc_mcontext.gregs [REG_PC];
 	mctx.sp = ctx-&gt;uc_mcontext.gregs [REG_SP];
@@ -467,4 +514,4 @@
 	ucontext_t *ctx = (ucontext_t*)sigctx;
 	return (gpointer)ctx-&gt;uc_mcontext.gregs [REG_PC];
 }
-
+#endif

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017756.html">[Mono-dev] [PATCH]: Fix build on sparc*-*-linux*
</A></li>
	<LI>Next message: <A HREF="017759.html">[Mono-dev] [PATCH]: Implement Sparc exceptions correctly under	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17757">[ date ]</a>
              <a href="thread.html#17757">[ thread ]</a>
              <a href="subject.html#17757">[ subject ]</a>
              <a href="author.html#17757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
