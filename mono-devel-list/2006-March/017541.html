<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch to boost speed of UnicodeEncoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20to%20boost%20speed%20of%20UnicodeEncoding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017540.html">
   <LINK REL="Next"  HREF="017551.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch to boost speed of UnicodeEncoding</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20to%20boost%20speed%20of%20UnicodeEncoding&In-Reply-To="
       TITLE="[Mono-dev] Patch to boost speed of UnicodeEncoding">kornelpal at hotmail.com
       </A><BR>
    <I>Sat Mar 11 08:40:33 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017540.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
        <LI>Next message: <A HREF="017551.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17541">[ date ]</a>
              <a href="thread.html#17541">[ thread ]</a>
              <a href="subject.html#17541">[ subject ]</a>
              <a href="author.html#17541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I think doing something like in the attached draft is faster. No new String
object is created. Arrays are accessed using pointers. And I think there is
no use to use a more complicated conversion method for short strings.

This draft is very unsafe. It lacks of any checks and does not perform any
special character or byte sequence handling.

Note that I haven't done any tests to determine whether using byte pointer
or using int pointers and shift operations to swap bytes is faster. But
mixing bytes an ints results in two different code for big and little endian
encodings while byte swapping can be performed using a single code when
using only bytes or only ints.

Korn&#233;l

----- Original Message -----
From: &quot;Zac Bowling&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">zac at zacbowling.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Saturday, March 11, 2006 1:09 PM
Subject: [Mono-dev] Patch to boost speed of UnicodeEncoding


&gt;<i> Alright guys,
</I>&gt;<i>
</I>&gt;<i> Here is a cool (and still incomplete) patch to speed up
</I>&gt;<i> System.Text.UnicodeEncoding I'm working on. Just want to make sure this
</I>&gt;<i> is sane before I finish it by getting everyone's opinions.
</I>&gt;<i>
</I>&gt;<i> I was tinkering with this idea. Since the strings are stored in memory
</I>&gt;<i> as UTF-16 (UCS 2) already, the idea of converting them with like we do
</I>&gt;<i> with a while loop, one char at a time, was really bothering me.
</I>&gt;<i> Directly copying whats in memory seems a little bit more sane. I don't
</I>&gt;<i> want to make it sound that easy because it isn't (and maybe why it
</I>&gt;<i> wasn't done like this when it was first written). :-P
</I>&gt;<i>
</I>&gt;<i> The biggest problem is that UnicodeEncoding can be bigEndian or
</I>&gt;<i> littleEndian so I went through the logic and testing to see if the
</I>&gt;<i> system's endian (with 'BitConverter.IsLittleEndian') matched the endian
</I>&gt;<i> of the current Encoding class (using the 'bigEndian' bool field) and if
</I>&gt;<i> it doesn't then use the same method we already use. (Is that right? Is
</I>&gt;<i> the internal version of utf-16 we use in our strings specific to the
</I>&gt;<i> endian of the system? I assumed yes here but if it's not, it's a simple
</I>&gt;<i> change to remark it out.)
</I>&gt;<i>
</I>&gt;<i> Also since the memcpy function in String.cs uses some unsafe logic,
</I>&gt;<i> taking a possible hit for that with a really small string seems silly,
</I>&gt;<i> so I put in an condition that if the char count is less then or equal
</I>&gt;<i> to 10 chars, then use the existing method. (Maybe 10 chars should be
</I>&gt;<i> adjusted or is that idea silly?)
</I>&gt;<i>
</I>&gt;<i> Below is an unfinished sample of my idea. Of course I will have to
</I>&gt;<i> reverse this logic for GetChars() (instead of GetBytes below) and
</I>&gt;<i> finish the overloads in System.Text.UnicodeEncoding's GetBytes and
</I>&gt;<i> GetChars methods but I want to see what everything thinks.
</I>-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ByteArrayCharArray.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060311/ba14fc3a/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060311/ba14fc3a/attachment.pl</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017540.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
	<LI>Next message: <A HREF="017551.html">[Mono-dev] Patch to boost speed of UnicodeEncoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17541">[ date ]</a>
              <a href="thread.html#17541">[ thread ]</a>
              <a href="subject.html#17541">[ subject ]</a>
              <a href="author.html#17541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
