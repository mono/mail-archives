<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] ppc64 port [was: Interpreter?]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20ppc64%20port%20%5Bwas%3A%20Interpreter%3F%5D&In-Reply-To=20070703155553.GG32215%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024042.html">
   <LINK REL="Next"  HREF="024052.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] ppc64 port [was: Interpreter?]</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20ppc64%20port%20%5Bwas%3A%20Interpreter%3F%5D&In-Reply-To=20070703155553.GG32215%40debian.org"
       TITLE="[Mono-dev] ppc64 port [was: Interpreter?]">andreas.faerber at web.de
       </A><BR>
    <I>Tue Jul  3 14:05:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024042.html">[Mono-dev] Interpreter?
</A></li>
        <LI>Next message: <A HREF="024052.html">[Mono-dev] ppc64 port [was: Interpreter?]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24040">[ date ]</a>
              <a href="thread.html#24040">[ thread ]</a>
              <a href="subject.html#24040">[ subject ]</a>
              <a href="author.html#24040">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

&gt;&gt;<i> First, it includes changes to eglib/configure.in to make it compile
</I>&gt;&gt;<i> on OS X and adds VPATH support to facilitate compiling for ppc and
</I>&gt;&gt;<i> ppc64.
</I>&gt;<i>
</I>&gt;<i> I suggest sending the eglib changes separately (note that the vararg
</I>&gt;<i> changes need to be inside a #ifdef conditional).
</I>
This is not a patch that anyone was supposed to apply. Also, I don't  
see an easy way of separating changes within one file that can go in  
from those that are not yet ready?

I *did* file eglib issues separately (#81456), unfortunately Jonathan  
soon after started to commit his own duplicating/conflicting Windows  
eglib patches that made this more difficult (see list).

The vararg stuff is an uncommited patch supplied by Jonathan  
available from my #81520; it made eglib compile again at all. You  
opposed his patch and demanded that *I* add tests first to have it  
reverted, in a scenario where exactly those tests were not running  
for me due to the ppc-ppc64 cross-compilation - I made that clear but  
to date nobody has stepped up with a solution (you will see that in  
my ppc64 patch eglib currently tests itself against itself so the  
tests probably are effectively useless).
Although not yet having used varargs in C myself, to me it looks  
wrong that the mandatory format argument is being dropped... So maybe  
there is a better way to patch where we don't need further ifdefs?

&gt;&gt;<i> Next, it reorganizes the ppc-codegen.h (header still needs some
</I>&gt;&gt;<i> changes Miguel requested) - instructions are now listed
</I>&gt;<i>
</I>&gt;<i> I'm sorry you have been led to do this kind of change: it is not
</I>&gt;<i> acceptable to do extensive cleanups together with code changes:
</I>&gt;<i> please send us only the code changes so we can actually review them
</I>&gt;<i> (this will also remove one third from the patch length).
</I>
I don't see the point in reverting those changes. Mine are trivial:  
64-bit instructions were added and are distinguishable by  
corresponding #ifdefs, for existing instructions only #ifndefs were  
added. Nothing was changed on the old instructions, and few of them  
are actually used anywhere at all! The new ordering is the only way  
the instructions can be checked sensibly because that's the order  
they are in the various manuals. I specifically asked Miguel about  
that file and he had only minor objections regarding the use of (c)  
vs. Copyright. So, might it be acceptable for you to try to split  
this up into one reordering patch and an addition/change patch?

&gt;&gt;<i> Then, the mini and arch ppc files were updated with #ifdefs for ppc64
</I>&gt;&gt;<i> doing all kinds of necessary changes. I have some FIXMEs/CHECKMEs in
</I>&gt;&gt;<i> there, especially some numeric offsets and alignments are unclear to
</I>&gt;&gt;<i> me. This is where I suspect the most issues.
</I>&gt;&gt;<i> Finally, all occurrences of ppc in the sources were checked and  
</I>&gt;&gt;<i> adapted.
</I>&gt;<i>
</I>&gt;<i> I gave a very quick read of the changes, here are a few suggestions:
</I>&gt;<i> *) you shold minimize the number of inserted #ifdefs. A patch that  
</I>&gt;<i> does:
</I>
Again this was not submitted for application. Were it clear in all  
places that this were actually intended I could have done so, yes.  
Unfortunately I am not sure everywhere that four equals sizeof 
(gpointer). Having it in one file during development simplifies  
comparison of before/after for me, avoiding the use of non-graphical  
svn diff (svnX's use of Apple's FileMerge tool rarely works for me).

&gt;<i> +#ifdef __ppc64__
</I>&gt;<i> +               offset += 8;
</I>&gt;<i> +#else
</I>&gt;<i>                 offset += 4;
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i> is not acceptable, while if it did:
</I>&gt;<i>
</I>&gt;<i> -               offset += 4;
</I>&gt;<i> +               offset += sizeof (gpointer);
</I>&gt;<i>
</I>&gt;<i> it would be applied right away.
</I>&gt;<i> Similar issues are with changes like:
</I>&gt;<i> +#ifdef __ppc64__
</I>&gt;<i> +       __asm__ volatile(&quot;ld    %0,0(r1)&quot; : &quot;=r&quot; (sframe));
</I>&gt;<i> +#else
</I>&gt;<i>         __asm__ volatile(&quot;lwz   %0,0(r1)&quot; : &quot;=r&quot; (sframe));
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i> Just add to the header something like:
</I>&gt;<i> #ifdef __ppc64__
</I>&gt;<i> #define PPC_LOAD_REG_INS &quot;ld&quot;
</I>&gt;<i> #else
</I>&gt;<i> #define PPC_LOAD_REG_INS &quot;lwz&quot;
</I>&gt;<i> #endif
</I>&gt;<i>
</I>&gt;<i> and replace the asm statements with:
</I>&gt;<i>         __asm__ volatile (PPC_LOAD_REG_INS &quot;   %0,0(r1)&quot; :  
</I>&gt;<i> &quot;=r&quot; (sframe));
</I>&gt;<i>
</I>&gt;<i> Something similar should be done also for the native code emitting
</I>&gt;<i> macros. Instead of:
</I>&gt;<i>
</I>&gt;<i> +#ifdef __ppc64__
</I>&gt;<i> +               ppc_ld  (buf, ppc_r0, (guint16)G_STRUCT_OFFSET 
</I>&gt;<i> (MonoLMF, previous_lmf) &gt;&gt; 2, ppc_r3);
</I>&gt;<i> +               ppc_std (buf, ppc_r0, (guint16)G_STRUCT_OFFSET 
</I>&gt;<i> (MonoLMF, previous_lmf) &gt;&gt; 2, ppc_r11);
</I>&gt;<i> +#else
</I>&gt;<i>                 ppc_lwz (buf, ppc_r0, G_STRUCT_OFFSET(MonoLMF,  
</I>&gt;<i> previous_lmf), ppc_r3);
</I>&gt;<i>                 ppc_stw (buf, ppc_r0, G_STRUCT_OFFSET(MonoLMF,  
</I>&gt;<i> previous_lmf), ppc_r11);
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i> define in ppc_codegen:
</I>&gt;<i>
</I>&gt;<i> #ifdef __ppc64__
</I>&gt;<i> #define ppc_load_reg(a,b,c,d) ppc_ld(a,b,(((c) &gt;&gt; 2) &amp; 0xffff),d)
</I>&gt;<i> #define ppc_store_reg(a,b,c,d) ppc_std(a,b,(((c) &gt;&gt; 2) &amp; 0xffff),d)
</I>&gt;<i> #else
</I>&gt;<i> #define ppc_load_reg(a,b,c,d) ppc_lwz(a,b,c,d)
</I>&gt;<i> #define ppc_store_reg(a,b,c,d) ppc_stw(a,b,c,d)
</I>&gt;<i> #endif
</I>&gt;<i>
</I>&gt;<i> This will make the changes so much cleaner that it will be possible to
</I>&gt;<i> more easily review them and find the issues (and it will also allow
</I>&gt;<i> us to commit them incrementally to svn).
</I>
These requested changes make sense but will take some more weeks and  
months which I can unlikely spend at this time...

&gt;<i> *) cpu-g5.md should become cpu-ppc64.md
</I>
In that case cpu-g4.md should also become cpu-ppc.md and the variable  
name in mini(?) should be changed, too.

&gt;<i> *) the ppc_load changes are not acceptable: add a ppc_load_sequence
</I>&gt;<i> or something like that that will emit lis/ori on 32 and the full
</I>&gt;<i> sequence on 64 bit and use that where it is required.
</I>
That I don't understand, please explain.
ppc_load is one logical operation and is ifdef'ed as the lis/ori for  
32, isn't it? All occurrences of manual lis/ori for trampolines were  
checked and updated and appear to work on ppc as is. So why would I  
need a ppc_load_sequence when there's no difference to ppc_load? The  
trampolines need 64-bit support in some places so we cannot say  
trampolines use 32-bit ppc_load and the rest 64-bit ppc_load_sequence.

&gt;<i> *) mono/io-layer/atomic.h: the changes here can't be skipped, they are
</I>&gt;<i> used in many parts of the runtime and without the 64 bit support there
</I>&gt;<i> can be memory corruption.
</I>
I will probably need more info than just &quot;can't be skipped&quot; to  
actually do that. :-)

&gt;<i> *) the emit_tls_access optimizations should likely be removed unless
</I>&gt;<i> they have been tested explicitly (they look a bit bogus).
</I>
Not sure what optimizations you mean? Obviously I have to update the  
code for ppc64 and can't just remove that part of the patch. The only  
&quot;optimization&quot; I'm aware of is removing the G4 case as the G4 to my  
knowledge is 32-bit by nature.

&gt;&gt;<i> compilation of System.dll using the new mono (or on execution of a
</I>&gt;&gt;<i> hello world assembly) it aborts with empty stacktrace:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> MONO_PATH=&quot;../../class/lib/basic:$MONO_PATH&quot; /Users/andreas/Mono/ 
</I>&gt;&gt;<i> mono-
</I>&gt;&gt;<i> ppc64/mono/runtime/mono-wrapper  ../../class/lib/basic/mcs.exe /
</I>&gt;&gt;<i> codepage:65001   -d:NET_1_1 -d:ONLY_1_1 -d:BOOTSTRAP_WITH_OLDLIB -
</I>&gt;&gt;<i> debug /noconfig -define:XML_DEP -r:System.Xml.dll -target:library -
</I>&gt;&gt;<i> out:System.dll  @System.dll.sources
</I>&gt;&gt;<i> Stacktrace:
</I>&gt;<i> [...]
</I>&gt;&gt;<i> (gdb) run ../../../testassembly.exe
</I>&gt;&gt;<i> Starting program: /Users/andreas/Mono/mono-ppc64/mono/mono/mini/
</I>&gt;&gt;<i> mono ../../../testassembly.exe
</I>&gt;&gt;<i> Reading symbols for shared libraries .++ done
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Program received signal SIGBUS, Bus error.
</I>&gt;&gt;<i> 0x0000000000000000 in ?? ()
</I>&gt;<i>
</I>&gt;<i> This looks like the result of a jump to NULL.
</I>&gt;<i> What are the results of running make rcheck in mini/? That is the  
</I>&gt;<i> first
</I>&gt;<i> thing that needs checking. If it fails in the same way before starting
</I>&gt;<i> the tests it is likely related to something earlier on in the
</I>&gt;<i> initialization.
</I>
I was not aware of a make rcheck, I only knew the standard make  
check, which fails with a similar error at the first compilation.

&gt;<i> The first thing that comes to mind is: doesn't ppc64 on OSX
</I>&gt;<i> use function descriptors like all the other ppc64 platforms? If it  
</I>&gt;<i> does
</I>&gt;<i> use them this would be the first thing to fix as any indirect call  
</I>&gt;<i> would
</I>&gt;<i> pretty much fail.
</I>
I had found no information on this. An IBM page described those for  
the Linux ABI, but the OS X ABI as we know differs in some points and  
did not talk about functions/descriptors. I don't have a ppc64 Linux  
running so couldn't check. My port was only targetted at OS X, for  
Linux some additional changes will need to be made and tested  
(different processor defines, offsets, the usual suspects).

&gt;<i> Well, I've been here and I don't remember seeing any jit-related  
</I>&gt;<i> request
</I>&gt;<i> for help:) Follow the above suggestions for now and we can both try to
</I>&gt;<i> get the changes in svn and get the bugs fixed.
</I>
I'd be happy to share this with other users through SVN but as stated  
before the changes requested above are non-trivial and will take some  
time; I started the port for an AI competition of our university but  
didn't finish in time. ;-) I wasn't able to work on it much lately,  
just merged some eglib conflicts and checked that no conflicting JIT  
changes were introduced and played with some of the unclear offset/ 
etc. values.

I did not ask earlier about atomic changes because I am in most cases  
a fan of test-driven development and did not dare submitting untested  
JIT changes for inclusion in SVN, the only successful tests so far  
being those of the ppc-codegen.h instruction macros.

Andreas

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024042.html">[Mono-dev] Interpreter?
</A></li>
	<LI>Next message: <A HREF="024052.html">[Mono-dev] ppc64 port [was: Interpreter?]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24040">[ date ]</a>
              <a href="thread.html#24040">[ thread ]</a>
              <a href="subject.html#24040">[ subject ]</a>
              <a href="author.html#24040">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
