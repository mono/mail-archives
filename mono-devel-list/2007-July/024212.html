<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Optimizations for FileSystemWatcher	and	MulticastDelegate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Optimizations%20for%20FileSystemWatcher%0A%09and%09MulticastDelegate&In-Reply-To=1184861070.5420.249.camel%40erandi.dom">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024213.html">
   <LINK REL="Next"  HREF="024217.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Optimizations for FileSystemWatcher	and	MulticastDelegate</H1>
    <B>Juraj Skripsky</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Optimizations%20for%20FileSystemWatcher%0A%09and%09MulticastDelegate&In-Reply-To=1184861070.5420.249.camel%40erandi.dom"
       TITLE="[Mono-dev] [PATCH] Optimizations for FileSystemWatcher	and	MulticastDelegate">js at hotfeet.ch
       </A><BR>
    <I>Thu Jul 19 12:34:54 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024213.html">[Mono-dev] [PATCH] Fix two small leaks in the runtime
</A></li>
        <LI>Next message: <A HREF="024217.html">[Mono-dev] [PATCH] Optimizations for FileSystemWatcher	and	MulticastDelegate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24212">[ date ]</a>
              <a href="thread.html#24212">[ thread ]</a>
              <a href="subject.html#24212">[ subject ]</a>
              <a href="author.html#24212">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Miguel,

On Thu, 2007-07-19 at 12:04 -0400, Miguel de Icaza wrote:
&gt;<i> Hello Juraj,
</I>&gt;<i> 
</I>&gt;<i>     can you explain the rationale for the changes in MulticastDelegate,
</I>&gt;<i> for example, why not return this.Clone () instead of the new construct
</I>&gt;<i> new Delegate [1] { this }?
</I>&gt;<i> 
</I>&gt;<i>     Also, should we not be checking prev/next in the method?
</I>&gt;<i> 
</I>
The new code distinguishes between two cases (see the diff below):

a) We don't have a chain, the only delegate to return is 'this'
   (or rather an array only containing one element: 'this').

   The old code did far too much work in this case:
   - clone this
   - build forward linked list (0 iterations as d.prev == null)
   - enter the if-block (as d.kpm_next was set to null)
   - clone the clone
   - set other.prev and other.kpm_next to null (they already are!)
   - return &quot;new Delegate[1] { other }&quot; where other.Equals(this)

   So it cloned the delegate twice and finally returned an
   array containing the second clone (which equals 'this').
   
   The new code does the same without all the unnecessary steps.

b) This stays the same.


     public sealed override Delegate[] GetInvocationList ()
     {
-        MulticastDelegate d;
-        d = (MulticastDelegate) this.Clone ();
+        // does the list only contain ourself?
+        if (prev == null)
+            return new Delegate [1] { this };
+
+        // walk the list backwards, connecting the links the other way 
+        MulticastDelegate d = this;
         for (d.kpm_next = null; d.prev != null; d = d.prev)
             d.prev.kpm_next = d;
 
-        if (d.kpm_next == null) {
-            MulticastDelegate other = (MulticastDelegate) d.Clone ();
-            other.prev = null;
-            other.kpm_next = null;
-            return new Delegate [1] { other };
-        }
-
+        // walk the list, building the invocation list
         ArrayList list = new ArrayList ();
         for (; d != null; d = d.kpm_next) {
             MulticastDelegate other = (MulticastDelegate) d.Clone ();


- Juraj


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024213.html">[Mono-dev] [PATCH] Fix two small leaks in the runtime
</A></li>
	<LI>Next message: <A HREF="024217.html">[Mono-dev] [PATCH] Optimizations for FileSystemWatcher	and	MulticastDelegate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24212">[ date ]</a>
              <a href="thread.html#24212">[ thread ]</a>
              <a href="subject.html#24212">[ subject ]</a>
              <a href="author.html#24212">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
