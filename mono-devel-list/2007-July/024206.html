<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Mono-gc-list]  Mono memory problems!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-gc-list%5D%20%20Mono%20memory%20problems%21&In-Reply-To=469E787E.7000902%40ufl.edu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024201.html">
   <LINK REL="Next"  HREF="024256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Mono-gc-list]  Mono memory problems!</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-gc-list%5D%20%20Mono%20memory%20problems%21&In-Reply-To=469E787E.7000902%40ufl.edu"
       TITLE="[Mono-dev] [Mono-gc-list]  Mono memory problems!">miguel at novell.com
       </A><BR>
    <I>Wed Jul 18 20:16:32 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024201.html">[Mono-dev] [Mono-gc-list]  Mono memory problems!
</A></li>
        <LI>Next message: <A HREF="024256.html">[Mono-dev] [Mono-gc-list]  Mono memory problems!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24206">[ date ]</a>
              <a href="thread.html#24206">[ thread ]</a>
              <a href="subject.html#24206">[ subject ]</a>
              <a href="author.html#24206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello folks,

    Thanks for tracking this problem down.

    Thanks for pointing out the comment in the source code;  I went and
re-read the documentation and I clearly did not understand it the first
time over, because the leak was documented to happen only in the .NET
1.0 and 1.1 scenarios, not on the 2.0 scenario.

    So the fix that takes ownership is correct.    I tidied up the patch
a little bit as well.   The fix is now on svn, thanks again for tracking
this down.

&gt;<i> In fact, I was able to fix the problem.
</I>&gt;<i> 
</I>&gt;<i> For some reason in WaitHandle.cs, the line...
</I>&gt;<i> safe_wait_handle = new SafeWaitHandle (value, false);
</I>&gt;<i> should be...
</I>&gt;<i> safe_wait_handle = new SafeWaitHandle (value, true);
</I>&gt;<i> (at least it makes sense according to other docs I read)...
</I>&gt;<i> 
</I>&gt;<i> second... in SafeWaitHandle.cs, the line ...
</I>&gt;<i>             NativeEventCalls.CloseEvent_internal (DangerousGetHandle());
</I>&gt;<i> should be...
</I>&gt;<i>             NativeEventCalls.CloseEvent_internal (handle);
</I>&gt;<i> 
</I>&gt;<i> The second one is kind of silly because Release gets called only after 
</I>&gt;<i> refcount == 0, but calling DangerousGetHandle throws an exception if 
</I>&gt;<i> refcount == 0.
</I>&gt;<i> 
</I>&gt;<i> I think there is still a problem of the array of wapi handles not being 
</I>&gt;<i> shrunk down, but that complexity is beyond me.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> David
</I>&gt;<i> 
</I>&gt;<i> Andreas F&#228;rber wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Am 18.07.2007 um 19:54 schrieb David Wolinsky:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; That case leaks as well.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Regards,
</I>&gt;<i> &gt;&gt; David
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Miguel de Icaza wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;         re = new AutoResetEvent(false);
</I>&gt;<i> &gt;&gt;&gt;&gt;         re.Close();
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; That depends on the finalizer to run to release memory from the
</I>&gt;<i> &gt;&gt;&gt; unmanaged side, since AutoResetEvent implements IDisposable you should
</I>&gt;<i> &gt;&gt;&gt; use it like this:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;     using (re = AutoResetEvent (false)) {   
</I>&gt;<i> &gt;&gt;&gt;         ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Doesn't Close() call Dispose()? At least for the Stream classes it 
</I>&gt;<i> &gt; should.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Andreas
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024201.html">[Mono-dev] [Mono-gc-list]  Mono memory problems!
</A></li>
	<LI>Next message: <A HREF="024256.html">[Mono-dev] [Mono-gc-list]  Mono memory problems!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24206">[ date ]</a>
              <a href="thread.html#24206">[ thread ]</a>
              <a href="subject.html#24206">[ subject ]</a>
              <a href="author.html#24206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
