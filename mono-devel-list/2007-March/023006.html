<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Need help tracking this bug...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=117799f00703290912p7eacb88fp26f061642594385e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023005.html">
   <LINK REL="Next"  HREF="023007.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Need help tracking this bug...</H1>
    <B>Joe Shaw</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=117799f00703290912p7eacb88fp26f061642594385e%40mail.gmail.com"
       TITLE="[Mono-dev] Need help tracking this bug...">joe at ximian.com
       </A><BR>
    <I>Thu Mar 29 14:53:34 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023005.html">[Mono-dev] Need help tracking this bug...
</A></li>
        <LI>Next message: <A HREF="023007.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23006">[ date ]</a>
              <a href="thread.html#23006">[ thread ]</a>
              <a href="subject.html#23006">[ subject ]</a>
              <a href="author.html#23006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alan,

On 3/29/07, Alan McGovern &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">alan.mcgovern at gmail.com</A>&gt; wrote:
&gt;<i> So, the thing is i can't track down what's causing the memory usage in
</I>&gt;<i> monotorrent. I have no idea how to even start. I've tried using the built in
</I>&gt;<i> profilers, but they require a graceful exit before they output their data,
</I>&gt;<i> and unfortunately i can't get them a graceful exit ;)
</I>
I would use the two external memory profilers for this: heap-buddy and
heap-shot.  Both are available from Mono SVN and straightforward to
build and use.

heap-buddy is a summarizing profiler.  It collects allocation
statistics while the program is running and writes out the aggregate
info to a file which you analyze with a command-line tool after it's
finished running.  It is robust against your app exiting ungracefully.
:<i>)
</I>
The tool has 4 basic modes: summary, history, types and backtraces.

Summary gives you high-level info: how many objects/bytes were
allocated, the final size of the heap, the number of GCs, etc.
History gives you a timeline of each heap resize and GC, telling you
the sizes of the heap, the number of objects and their size, and how
it changed over time.  You can see, for instance, that if your heap
resizes 5 times in a row without a GC all within 2 seconds that you
have a run away allocation pattern. :)

Types will show you all the value types that have been created, how
many total instances, the total bytes, the average size of one
instance, and the average age (ie, the number of GCs) it lived for.
If you're dealing with runaway memory, this will tell you what it is.
The average age is good for finding memory leaks.

Backtraces is like types, except it's more granular.  It shows you the
same info as types, but it breaks the types up by the call trace that
allocated them.  This is good when you're trying to find out what is
allocating all those damn strings. :)

The other tool is heap-shot, which is a snapshotting profiler.  When
you use it, you send SIGPROF to your running process which causes a
file to be written out with all the information about allocations at
that point.  Afterward you can use the GUI to see where all the memory
has gone.

The basic display mode shows you all the types, along with the number
of instances and the number of bytes these use.  This is pretty
similar to heap-buddy's types mode, except that it shows you the info
for a snapshot in time, rather than the aggregate over the whole run
of the program.

The beauty of this tool is in the &quot;Reverse references&quot; mode, which
tells you what objects hold references to a given type.  So, if you
reverse the references for &quot;string&quot;, you might see that 100 instances
of &quot;string&quot; are being referenced by 50 instances of
System.IO.FileInfo, and are using 2k of memory.  As you drill down,
you might see reference leaks (like those damned static ArrayLists and
Hashtables) that continually grow without bound.  These two tools
(especially heap-shot) have helped us reduce memory usage in Beagle
tremendously.

I've blogged about both tools in the past (mostly heap-buddy).  You
can search for them on <A HREF="http://joeshaw.org.">http://joeshaw.org.</A>  Lluis wrote heap-shot and
has blogged about it as well.

Good luck,
Joe

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023005.html">[Mono-dev] Need help tracking this bug...
</A></li>
	<LI>Next message: <A HREF="023007.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23006">[ date ]</a>
              <a href="thread.html#23006">[ thread ]</a>
              <a href="subject.html#23006">[ subject ]</a>
              <a href="author.html#23006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
