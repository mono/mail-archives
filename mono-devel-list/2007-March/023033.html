<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Need help tracking this bug...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=effa22060703301136j75fba6c5l5625b6b89d9a0d08%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023025.html">
   <LINK REL="Next"  HREF="023034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Need help tracking this bug...</H1>
    <B>Alan McGovern</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=effa22060703301136j75fba6c5l5625b6b89d9a0d08%40mail.gmail.com"
       TITLE="[Mono-dev] Need help tracking this bug...">alan.mcgovern at gmail.com
       </A><BR>
    <I>Fri Mar 30 20:15:48 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023025.html">[Mono-dev] Need help tracking this bug...
</A></li>
        <LI>Next message: <A HREF="023034.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23033">[ date ]</a>
              <a href="thread.html#23033">[ thread ]</a>
              <a href="subject.html#23033">[ subject ]</a>
              <a href="author.html#23033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

That leaves me with the question of how the hell a SocketAsyncResult is 10
megs in size! The size of the largest single object in my entire code is a
16kB byte[] buffer. If each SocketAsyncResult is 10 megabytes in size, i
have to question the internal workings of mono, as i know from profiling my
own code does *not* create objects anywhere near that size.

I'm going to do a bit of profiling to count how many socket BeginXXX calls
are made from my own code as compared to the EndXXX calls to see how they
match up.

Is there any way of finding out what exactly is inside those
SocketAsyncResults that is 10 megs in size? I can verify that the exact same
code running under Mono 1.2 and earlier does *not* exhibit the same
behavior, everything works fine. I only came across this bug after updating
my mono installation to 1.2.3. This is why i think it's a mono bug, however
i can't reproduce the problem in the form of an NUnit test.

Thanks again,
Alan.

On 3/30/07, Joe Shaw &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">joe at ximian.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hi again,
</I>&gt;<i>
</I>&gt;<i> On 3/30/07, Joe Shaw &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">joe at ximian.com</A>&gt; wrote:
</I>&gt;<i> &gt; That huge object array, in turn, is referenced by
</I>&gt;<i> &gt; System.Collections.Queue -&gt; System.Net.Socket.Socket, specifically the
</I>&gt;<i> &gt; readQ member.  So basically it means that the readQ member in
</I>&gt;<i> &gt; System.Net.Socket.Socket is a huge Queue, which internally has an
</I>&gt;<i> &gt; object array, which apparently has millions of SocketAsyncResult
</I>&gt;<i> &gt; objects inside.  So how those are being allocated?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; These objects are created a lot[...]
</I>&gt;<i>
</I>&gt;<i> I got a little ahead of myself here: I'm obviously looking at the code
</I>&gt;<i> for System.Net.Sockets.Socket here.
</I>&gt;<i>
</I>&gt;<i> &gt; I don't know much about the Socket class and how the async IO
</I>&gt;<i> &gt; works, but it boils down to the fact that BeginReceive() is being
</I>&gt;<i> &gt; called probably millions of times, but it doesn't look like Complete()
</I>&gt;<i> &gt; is being called enough (or possibly at all) to balance the load.
</I>&gt;<i>
</I>&gt;<i> I actually noticed something else:
</I>&gt;<i>
</I>&gt;<i> The object array in question has an average size of 10.6 megs, but it
</I>&gt;<i> only holds 56 references to SocketAsyncResult at the time of this
</I>&gt;<i> snapshot.  So this seems to indicate to me that the enqueues and
</I>&gt;<i> dequeues do ultimately match up, but that the allocation pattern is
</I>&gt;<i> bad and probably not interspersed.  That is,
</I>&gt;<i>
</I>&gt;<i> enqueue, enqueue, dequeue, dequeue, enqueue, enqueue, etc.
</I>&gt;<i>
</I>&gt;<i> would mean that an array could be as small as 2 items and still work
</I>&gt;<i> for N items, assuming a 1:1 match..  But if the pattern is instead,
</I>&gt;<i>
</I>&gt;<i> enqueue, enqueue, enqueue, enqueue, dequeue, dequeue, etc.
</I>&gt;<i>
</I>&gt;<i> then it would have to be at least N.  Now pretend N is a million. :)
</I>&gt;<i>
</I>&gt;<i> Joe
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070331/d9b16971/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070331/d9b16971/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023025.html">[Mono-dev] Need help tracking this bug...
</A></li>
	<LI>Next message: <A HREF="023034.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23033">[ date ]</a>
              <a href="thread.html#23033">[ thread ]</a>
              <a href="subject.html#23033">[ subject ]</a>
              <a href="author.html#23033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
