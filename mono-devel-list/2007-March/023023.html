<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Need help tracking this bug...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=117799f00703300859t15cde8dal7353cceccd507765%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023022.html">
   <LINK REL="Next"  HREF="023025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Need help tracking this bug...</H1>
    <B>Joe Shaw</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20tracking%20this%20bug...&In-Reply-To=117799f00703300859t15cde8dal7353cceccd507765%40mail.gmail.com"
       TITLE="[Mono-dev] Need help tracking this bug...">joe at ximian.com
       </A><BR>
    <I>Fri Mar 30 14:23:03 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023022.html">[Mono-dev] Need help tracking this bug...
</A></li>
        <LI>Next message: <A HREF="023025.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23023">[ date ]</a>
              <a href="thread.html#23023">[ thread ]</a>
              <a href="subject.html#23023">[ subject ]</a>
              <a href="author.html#23023">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

On 3/30/07, Alan McGovern &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">alan.mcgovern at gmail.com</A>&gt; wrote:
&gt;<i> Yup, i had noticed that ;) There is something fishy, but i can't find out
</I>&gt;<i> what it is. I've run heap-shot and attached and emailed the results in
</I>&gt;<i> already. Hopefully they'll make sense to someone. By the looks of it,
</I>&gt;<i> there's some kind of problem internal to mono which is resulting in this
</I>&gt;<i> rapid memory usage as on MS.NET this doesn't happen. There could easily be a
</I>&gt;<i> bug in my own code and MS.NET just handles it better, but i have no idea
</I>&gt;<i> what is causing the problem to start off with, so i can't fix it.
</I>
I just took a look at your heap-shot files, and it's a little odd.
Specifically in Second Run/outfile_1.omap:

object[] is the obvious problem.  367 instances, 490 megs, average
size: 1.3 megs.

You have to drill down in the inverse references to find specifically
the big consumer: object[] -&gt; System.Collections.Queue -&gt;
System.Net.Sockets.Socket -&gt;
System.Net.Sockets.Socket/SocketAsyncResult -&gt; object[].  It has 35
instances taking 373 megs, with an average of 10.6 megs each.

That huge object array, in turn, is referenced by
System.Collections.Queue -&gt; System.Net.Socket.Socket, specifically the
readQ member.  So basically it means that the readQ member in
System.Net.Socket.Socket is a huge Queue, which internally has an
object array, which apparently has millions of SocketAsyncResult
objects inside.  So how those are being allocated?

These objects are created a lot, but the ones that create them and
enqueue them into readQ are BeginReceive() and BeginReceiveFrom().
That queue is dequeued inside the Complete() method.  I don't know
much about the Socket class and how the async IO works, but it boils
down to the fact that BeginReceive() is being called probably millions
of times, but it doesn't look like Complete() is being called enough
(or possibly at all) to balance the load.

Hope this helps,
Joe

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023022.html">[Mono-dev] Need help tracking this bug...
</A></li>
	<LI>Next message: <A HREF="023025.html">[Mono-dev] Need help tracking this bug...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23023">[ date ]</a>
              <a href="thread.html#23023">[ thread ]</a>
              <a href="subject.html#23023">[ subject ]</a>
              <a href="author.html#23023">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
