<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Removing #region and #endregion from source code`
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Removing%20%23region%20and%20%23endregion%20from%20source%20code%60&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029251.html">
   <LINK REL="Next"  HREF="029240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Removing #region and #endregion from source code`</H1>
    <B>Daniel Morgan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Removing%20%23region%20and%20%23endregion%20from%20source%20code%60&In-Reply-To="
       TITLE="[Mono-dev] Removing #region and #endregion from source code`">monodanmorg at yahoo.com
       </A><BR>
    <I>Fri Sep 26 17:11:55 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="029251.html">[Mono-dev] [Fwd: [Patch] Simple optimization to	String.Replace	and	StringBuilder.Replace]
</A></li>
        <LI>Next message: <A HREF="029240.html">[Mono-dev] Removing #region and #endregion from source code`
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29237">[ date ]</a>
              <a href="thread.html#29237">[ thread ]</a>
              <a href="subject.html#29237">[ subject ]</a>
              <a href="author.html#29237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Raja,

Please do not remove #region and #endregion from source code files.  Just because your favorite text editor does not support #region does not give your the right to remove these.  My favorite text editor does support #region.

Thanks,
Daniel

--- On Fri, 9/26/08, Raja R Harinath (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">rharinath at novell.com</A>) &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-list at lists.ximian.com</A>&gt; wrote:

&gt;<i> From: Raja R Harinath (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">rharinath at novell.com</A>) &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Subject: [Mono-patches] r114232 - trunk/mcs/class/System.Data/System.Data
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A>, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ximian.monolist at gmail.com</A>, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-svn-patches-garchive-20758 at googlegroups.com</A>
</I>&gt;<i> Date: Friday, September 26, 2008, 4:00 PM
</I>&gt;<i> Author: raja
</I>&gt;<i> Date: 2008-09-26 16:00:41 -0400 (Fri, 26 Sep 2008)
</I>&gt;<i> New Revision: 114232
</I>&gt;<i> 
</I>&gt;<i> Modified:
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i>    trunk/mcs/class/System.Data/System.Data/DataView.cs
</I>&gt;<i> Log:
</I>&gt;<i> * DataView.cs: Convert into a partial class and sequester
</I>&gt;<i> interface-implementations and NET_2_0 pieces into separate
</I>&gt;<i> parts.
</I>&gt;<i> 
</I>&gt;<i> Modified: trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i> ===================================================================
</I>&gt;<i> ---
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data/ChangeLog	2008-09-26
</I>&gt;<i> 20:00:05 UTC (rev 114231)
</I>&gt;<i> +++
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data/ChangeLog	2008-09-26
</I>&gt;<i> 20:00:41 UTC (rev 114232)
</I>&gt;<i> @@ -1,3 +1,8 @@
</I>&gt;<i> +2008-09-27  Raja R Harinath  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">harinath at hurrynot.org</A>&gt;
</I>&gt;<i> +
</I>&gt;<i> +	* DataView.cs: Convert into a partial class and sequester
</I>&gt;<i> +	interface-implementations and NET_2_0 pieces into
</I>&gt;<i> separate parts.
</I>&gt;<i> +
</I>&gt;<i>  2008-09-16  brandin claar  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">brandin.claar at gmail.com</A>&gt;
</I>&gt;<i>  	    Raja R Harinath  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">harinath at hurrynot.org</A>&gt;
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Modified:
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data/DataView.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> ---
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data/DataView.cs	2008-09-26
</I>&gt;<i> 20:00:05 UTC (rev 114231)
</I>&gt;<i> +++
</I>&gt;<i> trunk/mcs/class/System.Data/System.Data/DataView.cs	2008-09-26
</I>&gt;<i> 20:00:41 UTC (rev 114232)
</I>&gt;<i> @@ -35,12 +35,7 @@
</I>&gt;<i>  	[DefaultEvent (&quot;PositionChanged&quot;)]
</I>&gt;<i>  	[DefaultProperty (&quot;Table&quot;)]
</I>&gt;<i>  	[DesignerAttribute
</I>&gt;<i> (&quot;Microsoft.VSDesigner.Data.VS.DataViewDesigner,
</I>&gt;<i> &quot;+ Consts.AssemblyMicrosoft_VSDesigner,
</I>&gt;<i> &quot;System.ComponentModel.Design.IDesigner&quot;)]
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -	public class DataView : MarshalByValueComponent,
</I>&gt;<i> IBindingList, IList, ICollection, IEnumerable, ITypedList,
</I>&gt;<i> ISupportInitialize, IBindingListView,
</I>&gt;<i> ISupportInitializeNotification
</I>&gt;<i> -#else
</I>&gt;<i> -	public class DataView : MarshalByValueComponent,
</I>&gt;<i> IBindingList, IList, ICollection, IEnumerable, ITypedList,
</I>&gt;<i> ISupportInitialize
</I>&gt;<i> -#endif
</I>&gt;<i> -	{
</I>&gt;<i> +	public partial class DataView : MarshalByValueComponent,
</I>&gt;<i> IEnumerable, ISupportInitialize {
</I>&gt;<i>  		internal DataTable dataTable;
</I>&gt;<i>  		string rowFilter = String.Empty;
</I>&gt;<i>  		IExpression rowFilterExpr;
</I>&gt;<i> @@ -50,9 +45,6 @@
</I>&gt;<i>  		DataColumn [] sortColumns;
</I>&gt;<i>  		internal DataViewRowState rowState;
</I>&gt;<i>  		internal DataRowView[] rowCache = new DataRowView [0];
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		private bool dataViewInitialized = true;
</I>&gt;<i> -#endif
</I>&gt;<i>  
</I>&gt;<i>  		// BeginInit() support
</I>&gt;<i>  		bool isInitPhase;
</I>&gt;<i> @@ -80,8 +72,6 @@
</I>&gt;<i>  		private DataViewManager dataViewManager;
</I>&gt;<i>  		internal static ListChangedEventArgs ListResetEventArgs
</I>&gt;<i> = new ListChangedEventArgs (ListChangedType.Reset,-1,-1);
</I>&gt;<i>  
</I>&gt;<i> -		#region Constructors
</I>&gt;<i> -
</I>&gt;<i>  		public DataView ()
</I>&gt;<i>  		{
</I>&gt;<i>  			rowState = DataViewRowState.CurrentRows;
</I>&gt;<i> @@ -118,10 +108,7 @@
</I>&gt;<i>  			rowState = RowState;
</I>&gt;<i>  			Open ();
</I>&gt;<i>  		}
</I>&gt;<i> -		#endregion // Constructors
</I>&gt;<i>  
</I>&gt;<i> -		#region PublicProperties
</I>&gt;<i> -
</I>&gt;<i>  		[DataCategory (&quot;Data&quot;)]
</I>&gt;<i>  #if !NET_2_0
</I>&gt;<i>  		[DataSysDescription (&quot;Indicates whether this
</I>&gt;<i> DataView and the user interface associated with it allows
</I>&gt;<i> deletes.&quot;)]
</I>&gt;<i> @@ -343,16 +330,6 @@
</I>&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		[Browsable (false)]
</I>&gt;<i> -		public bool IsInitialized {
</I>&gt;<i> -			get { return dataViewInitialized; }
</I>&gt;<i> -		}
</I>&gt;<i> -#endif
</I>&gt;<i> -		#endregion // PublicProperties
</I>&gt;<i> -
</I>&gt;<i> -		#region	PublicMethods
</I>&gt;<i> -
</I>&gt;<i>  		public virtual DataRowView AddNew ()
</I>&gt;<i>  		{
</I>&gt;<i>  			if (!IsOpen)
</I>&gt;<i> @@ -402,11 +379,11 @@
</I>&gt;<i>  			initRowState = RowStateFilter;
</I>&gt;<i>  
</I>&gt;<i>  			isInitPhase = true;
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -			dataViewInitialized = false;
</I>&gt;<i> -#endif
</I>&gt;<i> +			DataViewInitialized (false);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> +		partial void DataViewInitialized (bool value);
</I>&gt;<i> +
</I>&gt;<i>  		public void CopyTo (Array array, int index)
</I>&gt;<i>  		{
</I>&gt;<i>  			if (index + rowCache.Length &gt; array.Length)
</I>&gt;<i> @@ -436,27 +413,6 @@
</I>&gt;<i>  			row.Row.Delete ();
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		public virtual bool Equals (DataView dv)
</I>&gt;<i> -		{
</I>&gt;<i> -			if (this == dv)
</I>&gt;<i> -				return true;
</I>&gt;<i> -			if (!(this.Table == dv.Table &amp;&amp; this.Sort ==
</I>&gt;<i> dv.Sort &amp;&amp;
</I>&gt;<i> -				this.RowFilter == dv.RowFilter &amp;&amp;
</I>&gt;<i> -				this.RowStateFilter == dv.RowStateFilter &amp;&amp;
</I>&gt;<i> -				this.AllowEdit == dv.AllowEdit &amp;&amp;
</I>&gt;<i> -				this.AllowNew == dv.AllowNew &amp;&amp;
</I>&gt;<i> -				this.AllowDelete == dv.AllowDelete &amp;&amp;
</I>&gt;<i> -				this.Count == dv.Count))
</I>&gt;<i> -				return false;
</I>&gt;<i> -
</I>&gt;<i> -			for (int i = 0; i &lt; Count; ++i)
</I>&gt;<i> -				if (!this [i].Equals (dv [i]))
</I>&gt;<i> -					return false;
</I>&gt;<i> -			return true;
</I>&gt;<i> -		}
</I>&gt;<i> -#endif
</I>&gt;<i> -
</I>&gt;<i>  		public void EndInit ()
</I>&gt;<i>  		{
</I>&gt;<i>  			isInitPhase = false;
</I>&gt;<i> @@ -473,10 +429,7 @@
</I>&gt;<i>  
</I>&gt;<i>  			UpdateIndex (true);
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -			dataViewInitialized = true;
</I>&gt;<i> -			DataViewInitialized ();
</I>&gt;<i> -#endif
</I>&gt;<i> +			DataViewInitialized (true);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public int Find (object key)
</I>&gt;<i> @@ -532,18 +485,12 @@
</I>&gt;<i>  			return dataRowViews.GetEnumerator ();
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		#endregion // PublicMethods
</I>&gt;<i> -
</I>&gt;<i>  		[DataCategory (&quot;Data&quot;)]
</I>&gt;<i>  #if !NET_2_0
</I>&gt;<i>  		[DataSysDescription (&quot;Indicates that the data
</I>&gt;<i> returned by this DataView has somehow changed.&quot;)]
</I>&gt;<i>  #endif
</I>&gt;<i>  		public event ListChangedEventHandler ListChanged;
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		public event EventHandler Initialized;
</I>&gt;<i> -#endif
</I>&gt;<i> -
</I>&gt;<i>  		[Browsable (false)]
</I>&gt;<i>  #if !NET_2_0
</I>&gt;<i>  		[DataSysDescription (&quot;Indicates whether the view is
</I>&gt;<i> open.  &quot;)]
</I>&gt;<i> @@ -717,19 +664,6 @@
</I>&gt;<i>  			OnListChanged (new ListChangedEventArgs
</I>&gt;<i> (ListChangedType.ItemDeleted, newIndex, -1));
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		private void DataViewInitialized ()
</I>&gt;<i> -		{
</I>&gt;<i> -			EventArgs e = new EventArgs ();
</I>&gt;<i> -			OnDataViewInitialized (e);
</I>&gt;<i> -		}
</I>&gt;<i> -
</I>&gt;<i> -		private void OnDataViewInitialized (EventArgs e)
</I>&gt;<i> -		{
</I>&gt;<i> -			if (null != Initialized)
</I>&gt;<i> -				Initialized (this, e);
</I>&gt;<i> -		}
</I>&gt;<i> -#endif
</I>&gt;<i>  		protected virtual void ColumnCollectionChanged (object
</I>&gt;<i> sender, CollectionChangeEventArgs e)
</I>&gt;<i>  		{
</I>&gt;<i>  			// UpdateIndex() is not invoked here (even if the sort
</I>&gt;<i> @@ -789,88 +723,6 @@
</I>&gt;<i>  			OnListChanged (new ListChangedEventArgs
</I>&gt;<i> (ListChangedType.Reset, -1, -1 ));
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -#if NET_2_0
</I>&gt;<i> -		public DataTable ToTable ()
</I>&gt;<i> -		{
</I>&gt;<i> -			return this.ToTable (Table.TableName, false, new
</I>&gt;<i> string[] {});
</I>&gt;<i> -		}
</I>&gt;<i> -
</I>&gt;<i> -		public DataTable ToTable (string tableName)
</I>&gt;<i> -		{
</I>&gt;<i> -			return this.ToTable (tableName, false, new string[]
</I>&gt;<i> {});
</I>&gt;<i> -		}
</I>&gt;<i> -
</I>&gt;<i> -		public DataTable ToTable (bool isDistinct, params
</I>&gt;<i> string[] columnNames)
</I>&gt;<i> -		{
</I>&gt;<i> -			return this.ToTable (Table.TableName, isDistinct,
</I>&gt;<i> columnNames);
</I>&gt;<i> -		}
</I>&gt;<i> -
</I>&gt;<i> -		public DataTable ToTable (string tablename, bool
</I>&gt;<i> isDistinct, params string[] columnNames)
</I>&gt;<i> -		{
</I>&gt;<i> -			if (columnNames == null)
</I>&gt;<i> -				throw new ArgumentNullException
</I>&gt;<i> (&quot;columnNames&quot;, &quot;'columnNames'
</I>&gt;<i> argument cannot be null.&quot;);
</I>&gt;<i> -
</I>&gt;<i> -			DataTable newTable = new DataTable (tablename);
</I>&gt;<i> -
</I>&gt;<i> -			DataColumn[] columns;
</I>&gt;<i> -			ListSortDirection[] sortDirection = null;
</I>&gt;<i> -			if (columnNames.Length != 0) {
</I>&gt;<i> -				columns = new DataColumn [columnNames.Length];
</I>&gt;<i> -				for (int i=0; i &lt; columnNames.Length; ++i)
</I>&gt;<i> -					columns [i] = Table.Columns [columnNames [i]];
</I>&gt;<i> -
</I>&gt;<i> -				if (sortColumns != null) {
</I>&gt;<i> -					sortDirection = new ListSortDirection
</I>&gt;<i> [columnNames.Length];
</I>&gt;<i> -					for (int i=0; i &lt; columnNames.Length; ++i) {
</I>&gt;<i> -						sortDirection [i] = ListSortDirection.Ascending;
</I>&gt;<i> -						for (int j = 0; j &lt; sortColumns.Length; ++j) {
</I>&gt;<i> -							if (sortColumns [j] != columns [i])
</I>&gt;<i> -								continue;
</I>&gt;<i> -							sortDirection [i] = sortOrder [j];
</I>&gt;<i> -						}
</I>&gt;<i> -					}
</I>&gt;<i> -				}
</I>&gt;<i> -			} else {
</I>&gt;<i> -				columns = (DataColumn[]) Table.Columns.ToArray (typeof
</I>&gt;<i> (DataColumn));
</I>&gt;<i> -				sortDirection = sortOrder;
</I>&gt;<i> -			}
</I>&gt;<i> -
</I>&gt;<i> -			ArrayList expressionCols = new ArrayList ();
</I>&gt;<i> -			for (int i = 0; i &lt; columns.Length; ++i) {
</I>&gt;<i> -				DataColumn col = columns [i].Clone ();
</I>&gt;<i> -				if (col.Expression != String.Empty) {
</I>&gt;<i> -					col.Expression = string.Empty;
</I>&gt;<i> -					expressionCols.Add (col);
</I>&gt;<i> -				}
</I>&gt;<i> -				if (col.ReadOnly)
</I>&gt;<i> -					col.ReadOnly = false;
</I>&gt;<i> -				newTable.Columns.Add (col);
</I>&gt;<i> -			}
</I>&gt;<i> -
</I>&gt;<i> -			DataRow [] rows;
</I>&gt;<i> -			Index index = new Index (new Key(Table, columns,
</I>&gt;<i> sortDirection, RowStateFilter, rowFilterExpr));
</I>&gt;<i> -			if (isDistinct)
</I>&gt;<i> -				rows = index.GetDistinctRows ();
</I>&gt;<i> -			else
</I>&gt;<i> -				rows = index.GetAllRows ();
</I>&gt;<i> -
</I>&gt;<i> -			foreach (DataRow row in rows) {
</I>&gt;<i> -				DataRow newRow = newTable.NewNotInitializedRow ();
</I>&gt;<i> -				newTable.Rows.AddInternal (newRow);
</I>&gt;<i> -				newRow.Original = -1;
</I>&gt;<i> -				if (row.HasVersion (DataRowVersion.Current))
</I>&gt;<i> -					newRow.Current = newTable.RecordCache.CopyRecord
</I>&gt;<i> (Table, row.Current, -1);
</I>&gt;<i> -				else if (row.HasVersion (DataRowVersion.Original))
</I>&gt;<i> -					newRow.Current = newTable.RecordCache.CopyRecord
</I>&gt;<i> (Table, row.Original, -1);
</I>&gt;<i> -
</I>&gt;<i> -				foreach (DataColumn col in expressionCols)
</I>&gt;<i> -					newRow [col] = row [col.ColumnName];
</I>&gt;<i> -				newRow.Original = -1;
</I>&gt;<i> -			}
</I>&gt;<i> -			return newTable;
</I>&gt;<i> -		}
</I>&gt;<i> -#endif
</I>&gt;<i> -
</I>&gt;<i>  		protected void UpdateIndex ()
</I>&gt;<i>  		{
</I>&gt;<i>  			UpdateIndex (false);
</I>&gt;<i> @@ -956,13 +808,85 @@
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> +		private int IndexOf (DataRow dr)
</I>&gt;<i> +		{
</I>&gt;<i> +			for (int i=0; i &lt; rowCache.Length; i++)
</I>&gt;<i> +				if (dr.Equals (rowCache [i].Row))
</I>&gt;<i> +				return i;
</I>&gt;<i> +			return -1;
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		private void PopulateDefaultSort ()
</I>&gt;<i> +		{
</I>&gt;<i> +			sort = string.Empty;
</I>&gt;<i> +			foreach (Constraint c in dataTable.Constraints) {
</I>&gt;<i> +				if (c is UniqueConstraint) {
</I>&gt;<i> +					PopulateDefaultSort ((UniqueConstraint) c);
</I>&gt;<i> +					break;
</I>&gt;<i> +				}
</I>&gt;<i> +			}
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		private void PopulateDefaultSort (UniqueConstraint uc)
</I>&gt;<i> +		{
</I>&gt;<i> +			if (isInitPhase)
</I>&gt;<i> +				return;
</I>&gt;<i> +
</I>&gt;<i> +			DataColumn [] columns = uc.Columns;
</I>&gt;<i> +			if (columns.Length == 0) {
</I>&gt;<i> +				sort = String.Empty;
</I>&gt;<i> +				return;
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			StringBuilder builder = new StringBuilder ();
</I>&gt;<i> +			builder.Append (columns[0].ColumnName);
</I>&gt;<i> +			for (int i = 1; i &lt; columns.Length; i++) {
</I>&gt;<i> +				builder.Append (&quot;, &quot;);
</I>&gt;<i> +				builder.Append (columns [i].ColumnName);
</I>&gt;<i> +			}
</I>&gt;<i> +			sort = builder.ToString ();
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		internal DataView CreateChildView (DataRelation
</I>&gt;<i> relation, int index)
</I>&gt;<i> +		{
</I>&gt;<i> +			if (relation == null || relation.ParentTable != Table)
</I>&gt;<i> +				throw new ArgumentException(&quot;The relation is not
</I>&gt;<i> parented to the table to which this DataView points.&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			int record = GetRecord (index);
</I>&gt;<i> +			object[] keyValues = new object
</I>&gt;<i> [relation.ParentColumns.Length];
</I>&gt;<i> +			for (int i = 0; i &lt; relation.ParentColumns.Length;
</I>&gt;<i> i++)
</I>&gt;<i> +				keyValues [i] = relation.ParentColumns [i] [record];
</I>&gt;<i> +
</I>&gt;<i> +			return new RelatedDataView (relation.ChildColumns,
</I>&gt;<i> keyValues);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		private int GetRecord (int index)
</I>&gt;<i> +		{
</I>&gt;<i> +			if (index &lt; 0 || index &gt;= Count)
</I>&gt;<i> +				throw new
</I>&gt;<i> IndexOutOfRangeException(String.Format(&quot;There is no row
</I>&gt;<i> at position {0}.&quot;, index));
</I>&gt;<i> +
</I>&gt;<i> +			return (index == Index.Size) ?
</I>&gt;<i> +				_lastAdded.IndexFromVersion (DataRowVersion.Default) :
</I>&gt;<i> +				Index.IndexToRecord (index);
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i> +		internal DataRowVersion GetRowVersion (int index)
</I>&gt;<i> +		{
</I>&gt;<i> +			int record = GetRecord (index);
</I>&gt;<i> +			return Table.RecordCache [record].VersionFromIndex
</I>&gt;<i> (record);
</I>&gt;<i> +		}
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i> +	partial class DataView : ITypedList {
</I>&gt;<i>  		string ITypedList.GetListName (PropertyDescriptor []
</I>&gt;<i> listAccessors)
</I>&gt;<i>  		{
</I>&gt;<i>  			if (dataTable != null)
</I>&gt;<i>  				return dataTable.TableName;
</I>&gt;<i>  			return string.Empty;
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> +	partial class DataView : ICollection {
</I>&gt;<i>  		bool ICollection.IsSynchronized {
</I>&gt;<i>  			get { return false; }
</I>&gt;<i>  		}
</I>&gt;<i> @@ -970,7 +894,9 @@
</I>&gt;<i>  		object ICollection.SyncRoot {
</I>&gt;<i>  			get { return this; }
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> +	partial class DataView : IList {
</I>&gt;<i>  		bool IList.IsFixedSize {
</I>&gt;<i>  			get { return false; }
</I>&gt;<i>  		}
</I>&gt;<i> @@ -1030,9 +956,9 @@
</I>&gt;<i>  		{
</I>&gt;<i>  			Delete (index);
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> -		#region IBindingList implementation
</I>&gt;<i> -
</I>&gt;<i> +	partial class DataView : IBindingList {
</I>&gt;<i>  		[MonoTODO]
</I>&gt;<i>  		void IBindingList.AddIndex (PropertyDescriptor property)
</I>&gt;<i>  		{
</I>&gt;<i> @@ -1124,11 +1050,10 @@
</I>&gt;<i>  		bool IBindingList.SupportsSorting {
</I>&gt;<i>  			get { return true; }
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> -		#endregion // IBindingList implementation
</I>&gt;<i> -
</I>&gt;<i>  #if NET_2_0
</I>&gt;<i> -		#region IBindingListView implementation
</I>&gt;<i> +	partial class DataView : IBindingListView {
</I>&gt;<i>  		string IBindingListView.Filter {
</I>&gt;<i>  			get { return ((DataView) this).RowFilter; }
</I>&gt;<i>  			set { ((DataView) this).RowFilter = value; }
</I>&gt;<i> @@ -1169,76 +1094,130 @@
</I>&gt;<i>  		{
</I>&gt;<i>  			((IBindingListView) this).Filter = string.Empty;
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> -		#endregion //IBindingViewList implementation
</I>&gt;<i> -#endif
</I>&gt;<i> +	partial class DataView : ISupportInitializeNotification {
</I>&gt;<i> +		private bool dataViewInitialized = true;
</I>&gt;<i>  
</I>&gt;<i> -		private int IndexOf (DataRow dr)
</I>&gt;<i> -		{
</I>&gt;<i> -			for (int i=0; i &lt; rowCache.Length; i++)
</I>&gt;<i> -				if (dr.Equals (rowCache [i].Row))
</I>&gt;<i> -				return i;
</I>&gt;<i> -			return -1;
</I>&gt;<i> +		[Browsable (false)]
</I>&gt;<i> +		public bool IsInitialized {
</I>&gt;<i> +			get { return dataViewInitialized; }
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		private void PopulateDefaultSort ()
</I>&gt;<i> +		public event EventHandler Initialized;
</I>&gt;<i> +
</I>&gt;<i> +		partial void DataViewInitialized (bool value)
</I>&gt;<i>  		{
</I>&gt;<i> -			sort = string.Empty;
</I>&gt;<i> -			foreach (Constraint c in dataTable.Constraints) {
</I>&gt;<i> -				if (c is UniqueConstraint) {
</I>&gt;<i> -					PopulateDefaultSort ((UniqueConstraint) c);
</I>&gt;<i> -					break;
</I>&gt;<i> -				}
</I>&gt;<i> -			}
</I>&gt;<i> +			dataViewInitialized = value;
</I>&gt;<i> +			if (value)
</I>&gt;<i> +				OnDataViewInitialized (new EventArgs ());
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		private void PopulateDefaultSort (UniqueConstraint uc)
</I>&gt;<i> +		private void OnDataViewInitialized (EventArgs e)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (isInitPhase)
</I>&gt;<i> -				return;
</I>&gt;<i> -
</I>&gt;<i> -			DataColumn [] columns = uc.Columns;
</I>&gt;<i> -			if (columns.Length == 0) {
</I>&gt;<i> -				sort = String.Empty;
</I>&gt;<i> -				return;
</I>&gt;<i> -			}
</I>&gt;<i> -
</I>&gt;<i> -			StringBuilder builder = new StringBuilder ();
</I>&gt;<i> -			builder.Append (columns[0].ColumnName);
</I>&gt;<i> -			for (int i = 1; i &lt; columns.Length; i++) {
</I>&gt;<i> -				builder.Append (&quot;, &quot;);
</I>&gt;<i> -				builder.Append (columns [i].ColumnName);
</I>&gt;<i> -			}
</I>&gt;<i> -			sort = builder.ToString ();
</I>&gt;<i> +			if (null != Initialized)
</I>&gt;<i> +				Initialized (this, e);
</I>&gt;<i>  		}
</I>&gt;<i> +	}
</I>&gt;<i>  
</I>&gt;<i> -		internal DataView CreateChildView (DataRelation
</I>&gt;<i> relation, int index)
</I>&gt;<i> +	partial class DataView {
</I>&gt;<i> +		public virtual bool Equals (DataView dv)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (relation == null || relation.ParentTable != Table)
</I>&gt;<i> -				throw new ArgumentException(&quot;The relation is not
</I>&gt;<i> parented to the table to which this DataView points.&quot;);
</I>&gt;<i> +			if (this == dv)
</I>&gt;<i> +				return true;
</I>&gt;<i> +			if (!(this.Table == dv.Table &amp;&amp; this.Sort ==
</I>&gt;<i> dv.Sort &amp;&amp;
</I>&gt;<i> +				this.RowFilter == dv.RowFilter &amp;&amp;
</I>&gt;<i> +				this.RowStateFilter == dv.RowStateFilter &amp;&amp;
</I>&gt;<i> +				this.AllowEdit == dv.AllowEdit &amp;&amp;
</I>&gt;<i> +				this.AllowNew == dv.AllowNew &amp;&amp;
</I>&gt;<i> +				this.AllowDelete == dv.AllowDelete &amp;&amp;
</I>&gt;<i> +				this.Count == dv.Count))
</I>&gt;<i> +				return false;
</I>&gt;<i>  
</I>&gt;<i> -			int record = GetRecord (index);
</I>&gt;<i> -			object[] keyValues = new object
</I>&gt;<i> [relation.ParentColumns.Length];
</I>&gt;<i> -			for (int i = 0; i &lt; relation.ParentColumns.Length;
</I>&gt;<i> i++)
</I>&gt;<i> -				keyValues [i] = relation.ParentColumns [i] [record];
</I>&gt;<i> -
</I>&gt;<i> -			return new RelatedDataView (relation.ChildColumns,
</I>&gt;<i> keyValues);
</I>&gt;<i> +			for (int i = 0; i &lt; Count; ++i)
</I>&gt;<i> +				if (!this [i].Equals (dv [i]))
</I>&gt;<i> +					return false;
</I>&gt;<i> +			return true;
</I>&gt;<i>  		}
</I>&gt;<i> +		public DataTable ToTable ()
</I>&gt;<i> +		{
</I>&gt;<i> +			return this.ToTable (Table.TableName, false, new
</I>&gt;<i> string[] {});
</I>&gt;<i> +		}
</I>&gt;<i>  
</I>&gt;<i> -		private int GetRecord (int index)
</I>&gt;<i> +		public DataTable ToTable (string tableName)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (index &lt; 0 || index &gt;= Count)
</I>&gt;<i> -				throw new
</I>&gt;<i> IndexOutOfRangeException(String.Format(&quot;There is no row
</I>&gt;<i> at position {0}.&quot;, index));
</I>&gt;<i> +			return this.ToTable (tableName, false, new string[]
</I>&gt;<i> {});
</I>&gt;<i> +		}
</I>&gt;<i>  
</I>&gt;<i> -			return (index == Index.Size) ?
</I>&gt;<i> -				_lastAdded.IndexFromVersion (DataRowVersion.Default) :
</I>&gt;<i> -				Index.IndexToRecord (index);
</I>&gt;<i> +		public DataTable ToTable (bool isDistinct, params
</I>&gt;<i> string[] columnNames)
</I>&gt;<i> +		{
</I>&gt;<i> +			return this.ToTable (Table.TableName, isDistinct,
</I>&gt;<i> columnNames);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		internal DataRowVersion GetRowVersion (int index)
</I>&gt;<i> +		public DataTable ToTable (string tablename, bool
</I>&gt;<i> isDistinct, params string[] columnNames)
</I>&gt;<i>  		{
</I>&gt;<i> -			int record = GetRecord (index);
</I>&gt;<i> -			return Table.RecordCache [record].VersionFromIndex
</I>&gt;<i> (record);
</I>&gt;<i> +			if (columnNames == null)
</I>&gt;<i> +				throw new ArgumentNullException
</I>&gt;<i> (&quot;columnNames&quot;, &quot;'columnNames'
</I>&gt;<i> argument cannot be null.&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			DataTable newTable = new DataTable (tablename);
</I>&gt;<i> +
</I>&gt;<i> +			DataColumn[] columns;
</I>&gt;<i> +			ListSortDirection[] sortDirection = null;
</I>&gt;<i> +			if (columnNames.Length != 0) {
</I>&gt;<i> +				columns = new DataColumn [columnNames.Length];
</I>&gt;<i> +				for (int i=0; i &lt; columnNames.Length; ++i)
</I>&gt;<i> +					columns [i] = Table.Columns [columnNames [i]];
</I>&gt;<i> +
</I>&gt;<i> +				if (sortColumns != null) {
</I>&gt;<i> +					sortDirection = new ListSortDirection
</I>&gt;<i> [columnNames.Length];
</I>&gt;<i> +					for (int i=0; i &lt; columnNames.Length; ++i) {
</I>&gt;<i> +						sortDirection [i] = ListSortDirection.Ascending;
</I>&gt;<i> +						for (int j = 0; j &lt; sortColumns.Length; ++j) {
</I>&gt;<i> +							if (sortColumns [j] != columns [i])
</I>&gt;<i> +								continue;
</I>&gt;<i> +							sortDirection [i] = sortOrder [j];
</I>&gt;<i> +						}
</I>&gt;<i> +					}
</I>&gt;<i> +				}
</I>&gt;<i> +			} else {
</I>&gt;<i> +				columns = (DataColumn[]) Table.Columns.ToArray (typeof
</I>&gt;<i> (DataColumn));
</I>&gt;<i> +				sortDirection = sortOrder;
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			ArrayList expressionCols = new ArrayList ();
</I>&gt;<i> +			for (int i = 0; i &lt; columns.Length; ++i) {
</I>&gt;<i> +				DataColumn col = columns [i].Clone ();
</I>&gt;<i> +				if (col.Expression != String.Empty) {
</I>&gt;<i> +					col.Expression = string.Empty;
</I>&gt;<i> +					expressionCols.Add (col);
</I>&gt;<i> +				}
</I>&gt;<i> +				if (col.ReadOnly)
</I>&gt;<i> +					col.ReadOnly = false;
</I>&gt;<i> +				newTable.Columns.Add (col);
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			DataRow [] rows;
</I>&gt;<i> +			Index index = new Index (new Key(Table, columns,
</I>&gt;<i> sortDirection, RowStateFilter, rowFilterExpr));
</I>&gt;<i> +			if (isDistinct)
</I>&gt;<i> +				rows = index.GetDistinctRows ();
</I>&gt;<i> +			else
</I>&gt;<i> +				rows = index.GetAllRows ();
</I>&gt;<i> +
</I>&gt;<i> +			foreach (DataRow row in rows) {
</I>&gt;<i> +				DataRow newRow = newTable.NewNotInitializedRow ();
</I>&gt;<i> +				newTable.Rows.AddInternal (newRow);
</I>&gt;<i> +				newRow.Original = -1;
</I>&gt;<i> +				if (row.HasVersion (DataRowVersion.Current))
</I>&gt;<i> +					newRow.Current = newTable.RecordCache.CopyRecord
</I>&gt;<i> (Table, row.Current, -1);
</I>&gt;<i> +				else if (row.HasVersion (DataRowVersion.Original))
</I>&gt;<i> +					newRow.Current = newTable.RecordCache.CopyRecord
</I>&gt;<i> (Table, row.Original, -1);
</I>&gt;<i> +
</I>&gt;<i> +				foreach (DataColumn col in expressionCols)
</I>&gt;<i> +					newRow [col] = row [col.ColumnName];
</I>&gt;<i> +				newRow.Original = -1;
</I>&gt;<i> +			}
</I>&gt;<i> +			return newTable;
</I>&gt;<i>  		}
</I>&gt;<i>  	}
</I>&gt;<i> +#endif
</I>&gt;<i>  }
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-patches maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>
</I>

      
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029251.html">[Mono-dev] [Fwd: [Patch] Simple optimization to	String.Replace	and	StringBuilder.Replace]
</A></li>
	<LI>Next message: <A HREF="029240.html">[Mono-dev] Removing #region and #endregion from source code`
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29237">[ date ]</a>
              <a href="thread.html#29237">[ thread ]</a>
              <a href="subject.html#29237">[ subject ]</a>
              <a href="author.html#29237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
