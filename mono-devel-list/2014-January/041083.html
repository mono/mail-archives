<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] TcpListener.AcceptTcpClient leaks a socket at each call
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20TcpListener.AcceptTcpClient%20leaks%20a%20socket%20at%20each%20call&In-Reply-To=%3CCAOdw4D51MVOqXDcYEMK0RWoeFphW0jGVs5JMBUveN7ncCxgfEg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041082.html">
   <LINK REL="Next"  HREF="041084.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] TcpListener.AcceptTcpClient leaks a socket at each call</H1>
    <B>Jonathan Gagnon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20TcpListener.AcceptTcpClient%20leaks%20a%20socket%20at%20each%20call&In-Reply-To=%3CCAOdw4D51MVOqXDcYEMK0RWoeFphW0jGVs5JMBUveN7ncCxgfEg%40mail.gmail.com%3E"
       TITLE="[Mono-dev] TcpListener.AcceptTcpClient leaks a socket at each call">jonathan.gagnon at croesus.com
       </A><BR>
    <I>Wed Jan 22 21:32:12 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041082.html">[Mono-dev] Patch for Bug 17318 - Property validation does not	properly support nullable values
</A></li>
        <LI>Next message: <A HREF="041084.html">[Mono-dev] TcpListener.AcceptTcpClient leaks a socket at each	call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41083">[ date ]</a>
              <a href="thread.html#41083">[ thread ]</a>
              <a href="subject.html#41083">[ subject ]</a>
              <a href="author.html#41083">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found a leak in TcpListener.AcceptTcpClient :

public TcpClient AcceptTcpClient ()
{
if (!active)
 throw new InvalidOperationException (&quot;Socket is not listening&quot;);

Socket clientSocket = server.Accept ();

TcpClient client = new TcpClient();  // this call creates a socket even
though we don't need it
// use internal method SetTcpClient to make a
 // client with the specified socket
client.SetTcpClient (clientSocket);  // This method leaks the socket
created by the default constructor.

return client;
}


The method calls the default TcpClient constructor which creates a new
socket.  SetTcpClient is then called to assign the accepted socket to the
TcpClient object.  The problem is that the SetTcpClient simply replaces the
old socket reference by the new without closing the old socket.  The result
is that the socket created by the default constructor remains until the GC
reclaims it.

The fix would be really easy.  Instead of calling the default TcpClient
constructor, a new constructor could be created taking the socket as
parameter.  We would then avoid creating and leaking a socket every time
the method is called.  The fixed method would look like this :

public TcpClient AcceptTcpClient ()
{
if (!active)
throw new InvalidOperationException (&quot;Socket is not listening&quot;);

Socket clientSocket = server.Accept ();

TcpClient client = new TcpClient(clientSocket);

return client;
}


I could create a fix with the proposed solution.  Any thoughts?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140122/0a797043/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140122/0a797043/attachment.html</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041082.html">[Mono-dev] Patch for Bug 17318 - Property validation does not	properly support nullable values
</A></li>
	<LI>Next message: <A HREF="041084.html">[Mono-dev] TcpListener.AcceptTcpClient leaks a socket at each	call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41083">[ date ]</a>
              <a href="thread.html#41083">[ thread ]</a>
              <a href="subject.html#41083">[ subject ]</a>
              <a href="author.html#41083">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
