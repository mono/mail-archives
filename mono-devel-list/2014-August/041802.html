<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mono_fntptr_to_delegate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20mono_fntptr_to_delegate&In-Reply-To=%3CBLU406-EAS381CC855D708B910C320FB7C6EE0%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041801.html">
   <LINK REL="Next"  HREF="041803.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mono_fntptr_to_delegate</H1>
    <B>Bruno Lauze</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20mono_fntptr_to_delegate&In-Reply-To=%3CBLU406-EAS381CC855D708B910C320FB7C6EE0%40phx.gbl%3E"
       TITLE="[Mono-dev] mono_fntptr_to_delegate">brunolauze at msn.com
       </A><BR>
    <I>Fri Aug  8 17:29:33 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041801.html">[Mono-dev] GC precision
</A></li>
        <LI>Next message: <A HREF="041803.html">[Mono-dev] mono_fntptr_to_delegate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41802">[ date ]</a>
              <a href="thread.html#41802">[ thread ]</a>
              <a href="subject.html#41802">[ subject ]</a>
              <a href="author.html#41802">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, 

 

I am sure someone can help me out. At one point this code did work. I
changed something and/or I just reinstalled latest trunk and it broke.

I am trying to pass C delegate to C#. Everything is working C# is calling
back the method but the parameters seems to be invalid pointers.

The C delegate was returning the delegate object, and the parameters.

 

I did put mono_ftnptr_to_delegate to external removing MONO_INTERNAL and
placing it under MONO_API.

One could use Marshal.GetDelegateFromPointer with mono_runtime_invoke
(Adding that way too at the bottom.)

 

 

Consider the following code:

 

 

DelegateHelper.dll: MyClass.cs:

 

using System;

 

namespace DelegateHelper

{

        public delegate bool TestDelegate(string arg1);

 

        public class MyClass

        {

                public static bool Test(TestDelegate predicate)

                {

                        return predicate(&quot;TEST&quot;);

                }

        }

}

 

 

main.c:

 

 

#include &lt;stdio.h&gt;

#include &lt;glib.h&gt;

#include &lt;mono/jit/jit.h&gt;

#include &lt;mono/metadata/object.h&gt;

#include &lt;mono/metadata/reflection.h&gt;

#include &lt;mono/metadata/assembly.h&gt;

#include &lt;mono/metadata/threads.h&gt;

#include &lt;mono/metadata/mono-config.h&gt;

 

MONO_API MonoDelegate*

mono_ftnptr_to_delegate (MonoClass *klass, gpointer ftn);

 

MonoBoolean testMethod(MonoObject *arg1, MonoObject *arg2)

{

        printf(&quot;Calling delegate!&quot;);

        MonoString *str = mono_object_to_string(arg2, NULL); //crash

        return TRUE;

}

 

int main (int argc, char *argv[])

{

        printf (&quot;Delegate Test!\n&quot;);

 

        MonoDomain *domain = mono_jit_init_version(&quot;DelegateTest&quot;,
&quot;v4.0.30319&quot;);

        mono_config_parse(NULL);

        void *__parameters__[1];

        MonoAssembly *ass = mono_assembly_open(&quot;DelegateHelper.dll&quot;, NULL);

        MonoImage *image = mono_assembly_get_image(ass);

        MonoClass *delegateClass = mono_class_from_name(image,
&quot;DelegateHelper&quot;, &quot;TestDelegate&quot;);

        mono_class_init(delegateClass);

        MonoClass *testClass = mono_class_from_name(image, &quot;DelegateHelper&quot;,
&quot;MyClass&quot;);

        mono_class_init(testClass);

        gpointer ptr = (gpointer)testMethod;

        MonoDelegate *delegateObj = mono_ftnptr_to_delegate(delegateClass,
ptr); //Short way to call Marshal.GetDelegateFromFunctionPointer()

        MonoMethod *testMethod = mono_class_get_method_from_name(testClass,
&quot;Test&quot;, 1);

        __parameters__[0] = delegateObj;

        MonoObject *result = mono_runtime_invoke(testMethod, NULL,
__parameters__, NULL);

        return 0;

}

 

 

Result:

 

Delegate Test!

Calling delegate!

Stacktrace:

 

  at &lt;unknown&gt; &lt;0xffffffff&gt;

  at (wrapper managed-to-native) object.wrapper_native_0x40ea40 ()
&lt;0xffffffff&gt;

  at DelegateHelper.MyClass.Test (System.Func`2&lt;string, bool&gt;) &lt;0x00018&gt;

  at (wrapper runtime-invoke) &lt;Module&gt;.runtime_invoke_bool_object
(object,intptr,intptr,intptr) &lt;0xffffffff&gt;

 

=================================================================

Got a SIGSEGV while executing native code. This usually indicates

a fatal error in the mono runtime or one of the native libraries

used by your application.

=================================================================

 

Abort

 

 

This code could be used instead of mono_ftnptr_to_delegate which is normally
internal

 

        /*

        MonoImage *mscorlib =
mono_assembly_get_image(mono_domain_assembly_open(domain, &quot;mscorlib&quot;));

        MonoClass *marshal = mono_class_from_name(mscorlib,
&quot;System.Runtime.InteropServices&quot;, &quot;Marshal&quot;);

        MonoMethod *getDelegate = mono_class_get_method_from_name(marshal,
&quot;GetDelegateForFunctionPointer&quot;, 2);

        void *marshal_params[2];

        marshal_params[0] = ptr;

        marshal_params[1] = mono_type_get_object(domain,
mono_class_get_type(delegateClass));

        MonoObject *delegateObj = mono_runtime_invoke(getDelegate, NULL,
marshal_params, NULL);

        */

 

 

Please help!!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140808/36056571/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20140808/36056571/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041801.html">[Mono-dev] GC precision
</A></li>
	<LI>Next message: <A HREF="041803.html">[Mono-dev] mono_fntptr_to_delegate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41802">[ date ]</a>
              <a href="thread.html#41802">[ thread ]</a>
              <a href="subject.html#41802">[ subject ]</a>
              <a href="author.html#41802">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
