<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] making mono builds reproducible (xamarin bz #26842)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20making%20mono%20builds%20reproducible%20%28xamarin%20bz%20%2326842%29&In-Reply-To=%3C10715c5d0d5542f18a448d87efe6f720%40mane.sumatrasoftware.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042775.html">
   <LINK REL="Next"  HREF="042777.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] making mono builds reproducible (xamarin bz #26842)</H1>
    <B>Jeroen Frijters</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20making%20mono%20builds%20reproducible%20%28xamarin%20bz%20%2326842%29&In-Reply-To=%3C10715c5d0d5542f18a448d87efe6f720%40mane.sumatrasoftware.com%3E"
       TITLE="[Mono-dev] making mono builds reproducible (xamarin bz #26842)">jeroen at sumatra.nl
       </A><BR>
    <I>Tue Feb 17 13:52:00 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="042775.html">[Mono-dev] making mono builds reproducible (xamarin bz #26842)
</A></li>
        <LI>Next message: <A HREF="042777.html">[Mono-dev] Text Input Source Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42776">[ date ]</a>
              <a href="thread.html#42776">[ thread ]</a>
              <a href="subject.html#42776">[ subject ]</a>
              <a href="author.html#42776">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, that was very helpful. I've implemented something similar. By setting the UniverseOptions.DeterministicOutput flag, IKVM.Reflection will now do the same as Roslyn. This is currently not compatible with PDB file generation (because the PDB file generates another random GUID in the debug directory), but for Mono that is not an issue.

Marek, if mcs sets this flag it won't need to do anything else and given that Roslyn behaves the same, it is unlikely to cause problems (although for large files there is a small perf impact of hashing the output file).

Regards,
Jeroen

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alexander K&#246;plinger [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">alex.koeplinger at outlook.com</A>]
</I>&gt;<i> Sent: Tuesday, February 17, 2015 13:03
</I>&gt;<i> To: Jeroen Frijters; Daniel Kahn Gillmor; mono development list;
</I>&gt;<i> marek.safar <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">marek.safar at gmail.com</A>
</I>&gt;<i> Cc: Henrik Feldt; Jo Shields; Debian Reproducible Builds
</I>&gt;<i> Subject: RE: [Mono-dev] making mono builds reproducible (xamarin bz
</I>&gt;<i> #26842)
</I>&gt;<i> 
</I>&gt;<i> FYI, roslyn made the switch to being deterministic by default in April
</I>&gt;<i> last year:
</I>&gt;<i> <A HREF="https://github.com/dotnet/roslyn/commit/04462c44e30dfa91267581abdb029f31">https://github.com/dotnet/roslyn/commit/04462c44e30dfa91267581abdb029f31</A>
</I>&gt;<i> 02796486
</I>&gt;<i> 
</I>&gt;<i> Quoting from the commit:
</I>&gt;<i> &quot;(1) The timestamp in the header is replaced with 0 (which is
</I>&gt;<i> specifically allowed by the spec)
</I>&gt;<i>  (2) The module version ID Guid (Mvid) is computed by hashing the
</I>&gt;<i> contents of the generated assembly (with zero
</I>&gt;<i>       where the Mvid will go for the purposes of computing the hash)
</I>&gt;<i> 
</I>&gt;<i> The name of the &quot;private implementation details&quot; class no longer
</I>&gt;<i> includes the Mvid.&quot;
</I>&gt;<i> 
</I>&gt;<i> -- Alex
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jeroen at sumatra.nl</A>
</I>&gt;<i> &gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dkg at fifthhorseman.net</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>;
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">marek.safar at gmail.com</A>
</I>&gt;<i> &gt; Date: Tue, 17 Feb 2015 11:12:14 +0000
</I>&gt;<i> &gt; CC: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">henrik at logibit.se</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">directhex at apebox.org</A>;
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">reproducible-builds at lists.alioth.debian.org</A>
</I>&gt;<i> &gt; Subject: Re: [Mono-dev] making mono builds reproducible (xamarin bz
</I>&gt;<i> &gt; #26842)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hello all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm not a big fan of using an environment variable for this, but I
</I>&gt;<i> won't oppose it. In the mean time, I've added a new public API
</I>&gt;<i> (ModuleBuilder.__PEHeaderTimeDateStamp) to specify the time stamp. There
</I>&gt;<i> is already a public API to specify the module version GUID.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; As Miguel said, hard coding the GUID violates the spec and can lead to
</I>&gt;<i> weird problems. I think the proper solution is to base the GUID on a
</I>&gt;<i> SHA1 of the contents of the assembly. However, this is non-trivial, so
</I>&gt;<i> it will take some time to develop a complete solution. This will be an
</I>&gt;<i> opt-in feature, so it will also need to be supported by mcs or an
</I>&gt;<i> environment variable.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Marek, what do you think about adding an mcs switch to facilitate
</I>&gt;<i> reproducible builds?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt; Jeroen
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; -----Original Message-----
</I>&gt;<i> &gt; &gt; From: Daniel Kahn Gillmor [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dkg at fifthhorseman.net</A>]
</I>&gt;<i> &gt; &gt; Sent: Monday, February 16, 2015 23:20
</I>&gt;<i> &gt; &gt; To: mono development list
</I>&gt;<i> &gt; &gt; Cc: Jeroen Frijters; Jo Shields; Debian Reproducible Builds; Henrik
</I>&gt;<i> &gt; &gt; Feldt
</I>&gt;<i> &gt; &gt; Subject: making mono builds reproducible (xamarin bz #26842)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Hi Mono folks--
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; some good discussion has come up on the xamarin bugtracker about
</I>&gt;<i> &gt; &gt; being able to make builds using the mono toolchain reproducible:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=26842">https://bugzilla.xamarin.com/show_bug.cgi?id=26842</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Jo Shields offered a one-liner fix to PEWriter.cs to allow the use
</I>&gt;<i> &gt; &gt; of an environment variable to fix the timestamp epoch, but made it
</I>&gt;<i> &gt; &gt; clear that more feedback is needed, so i'm raising it here:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; from:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; public DWORD TimeDateStamp = (uint)(DateTime.UtcNow - new
</I>&gt;<i> &gt; &gt; DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; to:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; public DWORD TimeDateStamp =
</I>&gt;<i> &gt; &gt; Environment.GetEnvironmentVariable(&quot;IKVM_WRITER_TIMESTAMP_EPOCH&quot;) !=
</I>&gt;<i> &gt; &gt; null ?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; uint.Parse(Environment.GetEnvironmentVariable(&quot;IKVM_WRITER_TIMESTAMP
</I>&gt;<i> &gt; &gt; _EPO
</I>&gt;<i> &gt; &gt; CH&quot;)) :
</I>&gt;<i> &gt; &gt; (uint)(DateTime.UtcNow - new
</I>&gt;<i> &gt; &gt; DateTime(1970, 1, 1, 0, 0, 0, DateTimeKind.Utc)).TotalSeconds;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; (i'm not sure whether the integer number of seconds is the best form
</I>&gt;<i> &gt; &gt; for the environment variable, or whether it would be better to parse
</I>&gt;<i> &gt; &gt; a standard date string -- from debian's perspective, we can deal
</I>&gt;<i> &gt; &gt; with either, of course)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; And this still doesn't solve the secondary issue of the assembly
</I>&gt;<i> &gt; &gt; GUID, as Jo noted.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Any thoughts about how to best enable binary-reproducible builds
</I>&gt;<i> &gt; &gt; from the mono toolchain if the invoker requests them?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Regards,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; --dkg
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042775.html">[Mono-dev] making mono builds reproducible (xamarin bz #26842)
</A></li>
	<LI>Next message: <A HREF="042777.html">[Mono-dev] Text Input Source Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42776">[ date ]</a>
              <a href="thread.html#42776">[ thread ]</a>
              <a href="subject.html#42776">[ subject ]</a>
              <a href="author.html#42776">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
