<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] WCF WebServiceHost crashes mono if client	disconnects early
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WCF%20WebServiceHost%20crashes%20mono%20if%20client%0A%09disconnects%20early&In-Reply-To=%3CCAEMVr%2BDLGKJ1dRT_15FFdKuNHh7J%2Bip190WJXkMaVa-Sb-942g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042765.html">
   <LINK REL="Next"  HREF="042767.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] WCF WebServiceHost crashes mono if client	disconnects early</H1>
    <B>Alexander Grep</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WCF%20WebServiceHost%20crashes%20mono%20if%20client%0A%09disconnects%20early&In-Reply-To=%3CCAEMVr%2BDLGKJ1dRT_15FFdKuNHh7J%2Bip190WJXkMaVa-Sb-942g%40mail.gmail.com%3E"
       TITLE="[Mono-dev] WCF WebServiceHost crashes mono if client	disconnects early">alexhgrep at gmail.com
       </A><BR>
    <I>Sun Feb 15 19:48:45 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="042765.html">[Mono-dev] WCF WebServiceHost crashes mono if client	disconnects early
</A></li>
        <LI>Next message: <A HREF="042767.html">[Mono-dev] WCF WebServiceHost crashes mono if client disconnects early
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42766">[ date ]</a>
              <a href="thread.html#42766">[ thread ]</a>
              <a href="subject.html#42766">[ subject ]</a>
              <a href="author.html#42766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As far as I can tell, that patch fixes the crash. I'll be doing some more
testing in the next few days.

I'd be grateful if you could also have a look at
<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=20764">https://bugzilla.xamarin.com/show_bug.cgi?id=20764</A>
While it's not a crashing bug, it causes any OperationContract with a
return type of void to return status code 500 Internal Server Error, which
can cause undesirable effects in client applications.  The proposed patch
would work, though I'm not sure if it's the right way to do it.

Thanks,
Alex

On Sun, Feb 15, 2015 at 3:38 PM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt; wrote:

&gt;<i> Hello, [ I am CCing Atsushi so he can eyeball the patch ]
</I>&gt;<i>
</I>&gt;<i> Thanks for the background research and for pointing me to that
</I>&gt;<i> long-standing bug.
</I>&gt;<i>
</I>&gt;<i> It seems like a pull request was created, but that the author closed the
</I>&gt;<i> pull request.
</I>&gt;<i>
</I>&gt;<i> I have updated the patch, can you try this and report back?
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://gist.github.com/migueldeicaza/01aaf064b1bf626f8cc0">https://gist.github.com/migueldeicaza/01aaf064b1bf626f8cc0</A>
</I>&gt;<i>
</I>&gt;<i> Atsushi, does the above look correct?   And is Console.WriteLine the right
</I>&gt;<i> thing to do there, or should we use some other mechanism?
</I>&gt;<i>
</I>&gt;<i> Miguel
</I>&gt;<i>
</I>&gt;<i> On Sat, Feb 14, 2015 at 6:24 PM, Horst M&#252;ller &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">alexhgrep at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Greetings!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've stumbled upon what I believe to be a rather serious problem in
</I>&gt;&gt;<i> mono's WCF implementation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When a client disconnects during a transmission from a WebServiceHost, an
</I>&gt;&gt;<i> exception is thrown:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Exception Write failure   at System.Net.Sockets.NetworkStream.Write
</I>&gt;&gt;<i> (System.Byte[] buffer, Int32 offset, Int32 size) [0x0008e] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System/System.Net.Sockets/NetworkStream.cs:418
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.Net.ResponseStream.InternalWrite (System.Byte[] buffer, Int32
</I>&gt;&gt;<i> offset, Int32 count) [0x00029] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System/System.Net/ResponseStream.cs:132
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.Net.ResponseStream.Write (System.Byte[] buffer, Int32 offset,
</I>&gt;&gt;<i> Int32 count) [0x000dd] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System/System.Net/ResponseStream.cs:165
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Channels.Http.HttpRequestContext.InternalReply
</I>&gt;&gt;<i> (System.ServiceModel.Channels.Message msg, TimeSpan timeout) [0x00157] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpRequestContext.cs:160
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Channels.Http.HttpRequestContext.Reply
</I>&gt;&gt;<i> (System.ServiceModel.Channels.Message msg, TimeSpan timeout) [0x00000] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpRequestContext.cs:101
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Dispatcher.MessageProcessingContext.Reply
</I>&gt;&gt;<i> (Boolean useTimeout) [0x00026] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/MessageProcessingContext.cs:96
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Dispatcher.OperationInvokerHandler.Reply
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc, Boolean
</I>&gt;&gt;<i> useTimeout) [0x0001d] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/OperationInvokerHandler.cs:69
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at
</I>&gt;&gt;<i> System.ServiceModel.Dispatcher.OperationInvokerHandler.ProcessRequest
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc) [0x00044] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/OperationInvokerHandler.cs:29
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at
</I>&gt;&gt;<i> System.ServiceModel.Dispatcher.BaseRequestProcessorHandler.ProcessRequestChain
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc) [0x00000] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/BaseRequestProcessorHandler.cs:15
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at
</I>&gt;&gt;<i> System.ServiceModel.Dispatcher.BaseRequestProcessorHandler.ProcessRequestChain
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc) [0x00017] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/BaseRequestProcessorHandler.cs:16
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Dispatcher.HandlersChain.ProcessRequestChain
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc) [0x0000b] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/BaseRequestProcessor.cs:72
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Dispatcher.BaseRequestProcessor.ProcessRequest
</I>&gt;&gt;<i> (System.ServiceModel.Dispatcher.MessageProcessingContext mrc) [0x00018] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/BaseRequestProcessor.cs:26
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This exception gets caught and rethrown until it ends up at
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/ChannelDispatcher.cs:596,
</I>&gt;&gt;<i> where ProcessErrorWithHandlers returns false and we reply to the
</I>&gt;&gt;<i> RequestContext with an error message. This then generates a second
</I>&gt;&gt;<i> exception that is not caught, crashing the whole program:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unhandled Exception:
</I>&gt;&gt;<i> System.InvalidOperationException: Cannot be changed after headers are
</I>&gt;&gt;<i> sent.
</I>&gt;&gt;<i>   at System.Net.HttpListenerResponse.set_ContentType (System.String
</I>&gt;&gt;<i> value) [0x00027] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System/System.Net/HttpListenerResponse.cs:110
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at
</I>&gt;&gt;<i> System.ServiceModel.Channels.Http.HttpStandaloneResponseInfo.set_ContentType
</I>&gt;&gt;<i> (System.String value) [0x00000] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpContextInfo.cs:274
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Channels.Http.HttpRequestContext.InternalReply
</I>&gt;&gt;<i> (System.ServiceModel.Channels.Message msg, TimeSpan timeout) [0x00046] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpRequestContext.cs:140
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Channels.Http.HttpRequestContext.Reply
</I>&gt;&gt;<i> (System.ServiceModel.Channels.Message msg, TimeSpan timeout) [0x00000] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpRequestContext.cs:101
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Channels.Http.HttpRequestContext.Reply
</I>&gt;&gt;<i> (System.ServiceModel.Channels.Message msg) [0x00000] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Channels.Http/HttpRequestContext.cs:96
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at System.ServiceModel.Dispatcher.ListenerLoopManager.ProcessRequest
</I>&gt;&gt;<i> (IReplyChannel reply, System.ServiceModel.Channels.RequestContext rc)
</I>&gt;&gt;<i> [0x0003b] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/ChannelDispatcher.cs:601
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   at
</I>&gt;&gt;<i> System.ServiceModel.Dispatcher.ListenerLoopManager.TryReceiveRequestDone
</I>&gt;&gt;<i> (IAsyncResult result) [0x0001a] in
</I>&gt;&gt;<i> /build/mono/src/mono-3.12.0/mcs/class/System.ServiceModel/System.ServiceModel.Dispatcher/ChannelDispatcher.cs:575
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've attached an example that will trigger the problem if used to serve a
</I>&gt;&gt;<i> large file over a network. As soon as the client cancels the transfer, the
</I>&gt;&gt;<i> application will crash. In Microsoft .NET, no crash is observed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would be very grateful if someone could comment on this issue.
</I>&gt;&gt;<i> Apparently the problem has been reported before, but it seems no fix was
</I>&gt;&gt;<i> implemented:
</I>&gt;&gt;<i> <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=5926">https://bugzilla.xamarin.com/show_bug.cgi?id=5926</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is my example doing something that you're not supposed to do? It seems to
</I>&gt;&gt;<i> me that the WebServiceHost functionality is completely unusable with this
</I>&gt;&gt;<i> bug.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks and best regards,
</I>&gt;&gt;<i> Alex
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150215/ba69d8bc/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150215/ba69d8bc/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042765.html">[Mono-dev] WCF WebServiceHost crashes mono if client	disconnects early
</A></li>
	<LI>Next message: <A HREF="042767.html">[Mono-dev] WCF WebServiceHost crashes mono if client disconnects early
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42766">[ date ]</a>
              <a href="thread.html#42766">[ thread ]</a>
              <a href="subject.html#42766">[ subject ]</a>
              <a href="author.html#42766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
