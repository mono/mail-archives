<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Odbc and varchar - patch for varchars longer	than 255
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Odbc%20and%20varchar%20-%20patch%20for%20varchars%20longer%09than%20255&In-Reply-To=200706191223.32378.mbd%40dbc.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023928.html">
   <LINK REL="Next"  HREF="023930.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Odbc and varchar - patch for varchars longer	than 255</H1>
    <B>A Nagappan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Odbc%20and%20varchar%20-%20patch%20for%20varchars%20longer%09than%20255&In-Reply-To=200706191223.32378.mbd%40dbc.dk"
       TITLE="[Mono-dev] Odbc and varchar - patch for varchars longer	than 255">anagappan at novell.com
       </A><BR>
    <I>Tue Jun 19 07:26:26 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023928.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
        <LI>Next message: <A HREF="023930.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23929">[ date ]</a>
              <a href="thread.html#23929">[ thread ]</a>
              <a href="subject.html#23929">[ subject ]</a>
              <a href="author.html#23929">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
  Can you provide a sample test-case ?

Thanks
Nagappan


--
Nagappan A &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">anagappan at novell.com</A>&gt;
Linux Desktop Testing Project - <A HREF="http://ldtp.freedesktop.org">http://ldtp.freedesktop.org</A>
<A HREF="http://nagappanal.blogspot.com">http://nagappanal.blogspot.com</A>

Novell, Inc.
SUSE* Linux Enterprise 10
Your Linux is ready*
<A HREF="http://www.novell.com/linux">http://www.novell.com/linux</A>




&gt;&gt;&gt;<i> On Tue, Jun 19, 2007 at  3:53 PM, in message
</I>&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">200706191223.32378.mbd at dbc.dk</A>&gt;,
Mads Bondo Dydensborg &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mbd at dbc.dk</A>&gt; wrote: 
&gt;<i> Hi there.
</I>&gt;<i> 
</I>&gt;<i> I have had problems with strings containing binary 0, when retrieved
</I>through 
&gt;<i> 
</I>&gt;<i> the mono stack. Looking at OdbcDataReader, there seems to be a
</I>difference 
&gt;<i> between how GetBytes and GetValue( &quot;varchar&quot; ) works. 
</I>&gt;<i> 
</I>&gt;<i> GetBytes has this:
</I>&gt;<i> 
</I>&gt;<i> 10                         if (copyBuffer) {
</I>&gt;<i>     311                                 int i = 0;
</I>&gt;<i>     312                                 while (tbuff [i] !=
</I>libodbc.C_NULL) 
&gt;<i> {
</I>&gt;<i>     313                                         buffer [bufferIndex +
</I>i] = 
&gt;<i> tbuff [i];
</I>&gt;<i>     314                                         i++;
</I>&gt;<i>     315                                 }
</I>&gt;<i>     316                                 returnVal = i;
</I>&gt;<i>     317                         }
</I>&gt;<i>     318                         return returnVal;
</I>&gt;<i>     31
</I>&gt;<i> 
</I>&gt;<i> Whereas GetValue has this (sorry about the formatting):
</I>&gt;<i> 
</I>&gt;<i>  696                                 case OdbcType.VarChar:
</I>&gt;<i>     697                                         bufsize =
</I>(col.MaxLength &lt; 
&gt;<i> 255 ? (col.MaxLength+1) : 255);
</I>&gt;<i>     698                                         buffer = new 
</I>&gt;<i> byte[bufsize];  // According to sqlext.h, use SQL_CHAR for both char
</I>and 
&gt;<i> varchar
</I>&gt;<i>     699                                         StringBuilder sb1 =
</I>new 
&gt;<i> StringBuilder ();
</I>&gt;<i>     700                                         do {
</I>&gt;<i>     701                                                 ret = 
</I>&gt;<i> libodbc.SQLGetData (hstmt, ColIndex, col.SqlCType, buffer, bufsize,
</I>ref 
&gt;<i> outsize);
</I>&gt;<i>     702                                                 if (ret == 
</I>&gt;<i> OdbcReturn.Error)
</I>&gt;<i>     703                                                        
</I>break;
&gt;<i>     704                                                 if (ret != 
</I>&gt;<i> OdbcReturn.NoData &amp;&amp; outsize!=- 1) {
</I>&gt;<i>     705                                                         if
</I>(outsize &lt; 
&gt;<i> 
</I>&gt;<i> bufsize)
</I>&gt;<i>     706                                                              
</I>  
&gt;<i> sb1.Append
</I>(System.Text.Encoding.Default.GetString(buffer,0,outsize));
&gt;<i>     707                                                         else
</I>&gt;<i>     708                                                              
</I>  
&gt;<i> sb1.Append
</I>(System.Text.Encoding.Default.GetString(buffer,0,bufsize));
&gt;<i>     709                                                 }
</I>&gt;<i>     710                                         } while (ret != 
</I>&gt;<i> OdbcReturn.NoData);
</I>&gt;<i>     711                                         DataValue =
</I>sb1.ToString ();
&gt;<i>     712                                         break;
</I>&gt;<i> 
</I>&gt;<i> According to 
</I>&gt;<i> <A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-">http://msdn.microsoft.com/library/default.asp?url=/library/en-</A>
</I>us/odbc/htm/odb
&gt;<i> csqlgetdata.asp
</I>&gt;<i> &quot;It is up to the application to reassemble the parts, taking care to
</I>remove 
&gt;<i> the null- termination character from intermediate parts of character
</I>data. &quot;
&gt;<i> 
</I>&gt;<i> This patch fixes my problem:
</I>&gt;<i> 
</I>&gt;<i> Index: OdbcDataReader.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> ---  OdbcDataReader.cs   (revision 80063)
</I>&gt;<i> +++ OdbcDataReader.cs   (working copy)
</I>&gt;<i> @@ - 705,7 +705,7 @@
</I>&gt;<i>                                                         if (outsize &lt;
</I>
&gt;<i> bufsize)
</I>&gt;<i>                                                                
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,outsize));
</I>&gt;<i>                                                         else
</I>&gt;<i> -                                                               
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,bufsize));
</I>&gt;<i> +                                                              
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,bufsize- 1));
</I>&gt;<i>                                                 }
</I>&gt;<i>                                         } while (ret !=
</I>OdbcReturn.NoData);
&gt;<i>                                         DataValue = sb1.ToString ();
</I>&gt;<i> 
</I>&gt;<i> It assumes any fragment, with more data, always contains a binary
</I>zero on 
&gt;<i> the 
</I>&gt;<i> last position. This may or may not be the case -  some Odbc expert
</I>should 
&gt;<i> probably look at it. There could be a problem with NVarchar also.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> Mads
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023928.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
	<LI>Next message: <A HREF="023930.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23929">[ date ]</a>
              <a href="thread.html#23929">[ thread ]</a>
              <a href="subject.html#23929">[ subject ]</a>
              <a href="author.html#23929">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
