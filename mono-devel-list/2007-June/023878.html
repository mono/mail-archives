<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Dictionary`2: optimized and	serialization-compatible	with MS.net
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Dictionary%602%3A%20optimized%20and%09serialization-compatible%0A%09with%20MS.net&In-Reply-To=20070611145133.GF2377%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023876.html">
   <LINK REL="Next"  HREF="023879.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Dictionary`2: optimized and	serialization-compatible	with MS.net</H1>
    <B>Juraj Skripsky</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Dictionary%602%3A%20optimized%20and%09serialization-compatible%0A%09with%20MS.net&In-Reply-To=20070611145133.GF2377%40debian.org"
       TITLE="[Mono-dev] Dictionary`2: optimized and	serialization-compatible	with MS.net">js at hotfeet.ch
       </A><BR>
    <I>Mon Jun 11 12:27:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023876.html">[Mono-dev] Dictionary`2: optimized	and	serialization-compatible	with MS.net
</A></li>
        <LI>Next message: <A HREF="023879.html">[Mono-dev] Dictionary`2: optimized	and	serialization-compatible	with MS.net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23878">[ date ]</a>
              <a href="thread.html#23878">[ thread ]</a>
              <a href="subject.html#23878">[ subject ]</a>
              <a href="author.html#23878">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2007-06-11 at 16:51 +0200, Paolo Molaro wrote:
&gt;<i> You're missing that the hashcode check can be completely removed
</I>&gt;<i> since it's not needed. Having it may have some performance benefit
</I>&gt;<i> with many collisions or for presence checks that fail and happen
</I>&gt;<i> to hit a bucket with values that also have different hashcodes.
</I>&gt;<i> But this benefit (I think it is small, would love to see numbers for a
</I>&gt;<i> few test cases) needs to be balanced against a memory usage overhead
</I>&gt;<i> that in most cases is at about 20%.
</I>
Yes, I've realized this shortly after sending my last email. How could
I've missed that?!

I changed the code accordingly, getting rid of the hashcodes completely.
Unfortunately, the result of the change is a slow down which is often
considerable (especially for string keys):

Dictionary&lt;int, int&gt;:       6-12%
Dictionary&lt;double, double&gt;: 25-35%
Dictionary&lt;string, int&gt;:    30-80% *

*: depending on average string length and the strings themselves (I
tried quite a few string variations here)

For key types with slow Equals() methods (e.g. String.Equals, whose
running time is proportional to the length of the matching substring),
the slow down will always be substantial.

I would vote for keeping the hashcode around, as my guess (read: gut
feeling) for the average slow down in realistic scenarios would be
around 30%.

&gt;<i> Well, my opionion is that using a hashtable there is completely overkill
</I>&gt;<i> and the wrong thing to do (even if it is a super-optimized Dictionary&lt;T&gt;)
</I>&gt;<i> performance-wise, in fact I think I removed that sometime in the past
</I>&gt;<i> because it gave an enourmous performance vantage to not do it in a wide
</I>&gt;<i> range of cases. Just limiting the chars that are handled with the skip
</I>&gt;<i> table to latin1 would be enough to have so much better performance in
</I>&gt;<i> 95% of the cases that the remaining cases would become uninteresting.
</I>&gt;<i> But if we want to pay some service to people not using only the latin1
</I>&gt;<i> subset of unicode, we could still use a 256-entry array for latin1
</I>&gt;<i> and a hash/dictionary that is created and used only for the chars &gt; 255.
</I>&gt;<i> GetShiftDistance would become:
</I>&gt;<i> 
</I>&gt;<i> 	if (c &lt; 256)
</I>&gt;<i> 		return latin1_skip_table [(byte)c];
</I>&gt;<i> 	...current code...
</I>
Yes, that's true, a skip table based purely on Hashtable/Dictinary looks
like overkill in this case. Especially compared to your solution.

Juraj


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023876.html">[Mono-dev] Dictionary`2: optimized	and	serialization-compatible	with MS.net
</A></li>
	<LI>Next message: <A HREF="023879.html">[Mono-dev] Dictionary`2: optimized	and	serialization-compatible	with MS.net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23878">[ date ]</a>
              <a href="thread.html#23878">[ thread ]</a>
              <a href="subject.html#23878">[ subject ]</a>
              <a href="author.html#23878">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
