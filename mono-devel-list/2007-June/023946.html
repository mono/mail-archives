<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Odbc and varchar - patch for varchars longer	than 255
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Odbc%20and%20varchar%20-%20patch%20for%20varchars%20longer%09than%20255&In-Reply-To=200706200840.47496.mbd%40dbc.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023934.html">
   <LINK REL="Next"  HREF="023935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Odbc and varchar - patch for varchars longer	than 255</H1>
    <B>A Nagappan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Odbc%20and%20varchar%20-%20patch%20for%20varchars%20longer%09than%20255&In-Reply-To=200706200840.47496.mbd%40dbc.dk"
       TITLE="[Mono-dev] Odbc and varchar - patch for varchars longer	than 255">anagappan at novell.com
       </A><BR>
    <I>Thu Jun 21 06:23:08 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023934.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
        <LI>Next message: <A HREF="023935.html">[Mono-dev] Error in UnixGroupInfo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23946">[ date ]</a>
              <a href="thread.html#23946">[ thread ]</a>
              <a href="subject.html#23946">[ subject ]</a>
              <a href="author.html#23946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
  Thanks for the patch and test :) Checked in both the patch and test
in SVN.

Test - Committed revision 80428.
Patch - Committed revision 80429.

Thanks
Nagappan


--
Nagappan A &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">anagappan at novell.com</A>&gt;
Linux Desktop Testing Project - <A HREF="http://ldtp.freedesktop.org">http://ldtp.freedesktop.org</A>
<A HREF="http://nagappanal.blogspot.com">http://nagappanal.blogspot.com</A>

Novell, Inc.
SUSE* Linux Enterprise 10
Your Linux is ready*
<A HREF="http://www.novell.com/linux">http://www.novell.com/linux</A>




&gt;&gt;&gt;<i> On Wed, Jun 20, 2007 at 12:10 PM, in message
</I>&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">200706200840.47496.mbd at dbc.dk</A>&gt;,
Mads Bondo Dydensborg &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mbd at dbc.dk</A>&gt; wrote: 
&gt;<i> tirsdag 19 juni 2007 13:26 skrev A Nagappan:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>   Can you provide a sample test- case ?
</I>&gt;<i> 
</I>&gt;<i> Hi again. Please find attached a test case.
</I>&gt;<i> 
</I>&gt;<i> This is tested against a Sybase ASA 9.0.2 -  but I believe other DB's
</I>using 
&gt;<i> Odbc should/will give the same behaviour. When running the program,
</I>the 
&gt;<i> following output is  produced:
</I>&gt;<i> 
</I>&gt;<i> $ mono -- debug ZeroBug.exe
</I>&gt;<i> readAsString:
</I>&gt;<i> Looking for binary zero in string 'This string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 charactersThis string has
</I>more than 
&gt;<i> 255 charactersThis string has more than 255 charactersThis string has
</I>more 
&gt;<i> than 255 charactersThis string has more than 255 charactersThis
</I>string has 
&gt;<i> more than 255 charactersThis string has more than 255 charactersThis
</I>string 
&gt;<i> has more than 255 charactersThis string has more than 255
</I>charactersThis 
&gt;<i> string has more than 255 charactersThis string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 charactersThis string has
</I>more than 
&gt;<i> 255 charactersThis string has more than 255 charactersThis string has
</I>more 
&gt;<i> than 255 charactersThis string has more than 255 charactersThis
</I>string has 
&gt;<i> more than 255 charactersThis string has more than 255 charactersThis
</I>string 
&gt;<i> has more than 255 charactersThis string has more than 255
</I>charactersThis 
&gt;<i> string has more than 255 charactersThis string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 characters'
</I>&gt;<i> Found binary zero at pos 254
</I>&gt;<i> Found binary zero at pos 509
</I>&gt;<i> Found binary zero at pos 764
</I>&gt;<i> readAsBytes:
</I>&gt;<i> Looking for binary zero in string 'This string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 charactersThis string has
</I>more than 
&gt;<i> 255 charactersThis string has more than 255 charactersThis string has
</I>more 
&gt;<i> than 255 charactersThis string has more than 255 charactersThis
</I>string has 
&gt;<i> more than 255 charactersThis string has more than 255 charactersThis
</I>string 
&gt;<i> has more than 255 charactersThis string has more than 255
</I>charactersThis 
&gt;<i> string has more than 255 charactersThis string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 charactersThis string has
</I>more than 
&gt;<i> 255 charactersThis string has more than 255 charactersThis string has
</I>more 
&gt;<i> than 255 charactersThis string has more than 255 charactersThis
</I>string has 
&gt;<i> more than 255 charactersThis string has more than 255 charactersThis
</I>string 
&gt;<i> has more than 255 charactersThis string has more than 255
</I>charactersThis 
&gt;<i> string has more than 255 charactersThis string has more than 255 
</I>&gt;<i> charactersThis string has more than 255 characters'
</I>&gt;<i> 
</I>&gt;<i> The pattern is, that for each 255 characters, a binary zero is
</I>inserted. Not 
&gt;<i> 
</I>&gt;<i> good. :- )
</I>&gt;<i> 
</I>&gt;<i> when applying this patch (sorry for the formatting, only '- 1' is
</I>added)
&gt;<i> 
</I>&gt;<i> Index: OdbcDataReader.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> ---  OdbcDataReader.cs   (revision 80063)
</I>&gt;<i> +++ OdbcDataReader.cs   (working copy)
</I>&gt;<i> @@ - 705,7 +705,7 @@
</I>&gt;<i>                                                         if (outsize &lt;
</I>
&gt;<i> bufsize)
</I>&gt;<i>                                                                
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,outsize));
</I>&gt;<i>                                                         else
</I>&gt;<i> -                                                               
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,bufsize));
</I>&gt;<i> +                                                              
</I>sb1.Append 
&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,bufsize- 1));
</I>&gt;<i>                                                 }
</I>&gt;<i>                                         } while (ret !=
</I>OdbcReturn.NoData);
&gt;<i>                                         DataValue = sb1.ToString ();
</I>&gt;<i> 
</I>&gt;<i> no binary zeros are found.
</I>&gt;<i> 
</I>&gt;<i> There may be issues for NVarchar too.
</I>&gt;<i> 
</I>&gt;<i> Regards, 
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> Nagappan
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Nagappan A &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">anagappan at novell.com</A>&gt;
</I>&gt;&gt;<i> Linux Desktop Testing Project -  <A HREF="http://ldtp.freedesktop.org">http://ldtp.freedesktop.org</A>
</I>&gt;&gt;<i> <A HREF="http://nagappanal.blogspot.com">http://nagappanal.blogspot.com</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Novell, Inc.
</I>&gt;&gt;<i> SUSE* Linux Enterprise 10
</I>&gt;&gt;<i> Your Linux is ready*
</I>&gt;&gt;<i> <A HREF="http://www.novell.com/linux">http://www.novell.com/linux</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> &gt;&gt;&gt; On Tue, Jun 19, 2007 at  3:53 PM, in message
</I>&gt;&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">200706191223.32378.mbd at dbc.dk</A>&gt;,
</I>&gt;&gt;<i> Mads Bondo Dydensborg &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mbd at dbc.dk</A>&gt; wrote: 
</I>&gt;&gt;<i> &gt; Hi there.
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; I have had problems with strings containing binary 0, when
</I>retrieved
&gt;&gt;<i> through 
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; the mono stack. Looking at OdbcDataReader, there seems to be a
</I>&gt;&gt;<i> difference 
</I>&gt;&gt;<i> &gt; between how GetBytes and GetValue( &quot;varchar&quot; ) works. 
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; GetBytes has this:
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; 10                         if (copyBuffer) {
</I>&gt;&gt;<i> &gt;     311                                 int i = 0;
</I>&gt;&gt;<i> &gt;     312                                 while (tbuff [i] !=
</I>&gt;&gt;<i> libodbc.C_NULL) 
</I>&gt;&gt;<i> &gt; {
</I>&gt;&gt;<i> &gt;     313                                         buffer
</I>[bufferIndex +
&gt;&gt;<i> i] = 
</I>&gt;&gt;<i> &gt; tbuff [i];
</I>&gt;&gt;<i> &gt;     314                                         i++;
</I>&gt;&gt;<i> &gt;     315                                 }
</I>&gt;&gt;<i> &gt;     316                                 returnVal = i;
</I>&gt;&gt;<i> &gt;     317                         }
</I>&gt;&gt;<i> &gt;     318                         return returnVal;
</I>&gt;&gt;<i> &gt;     31
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; Whereas GetValue has this (sorry about the formatting):
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  696                                 case OdbcType.VarChar:
</I>&gt;&gt;<i> &gt;     697                                         bufsize =
</I>&gt;&gt;<i> (col.MaxLength &lt; 
</I>&gt;&gt;<i> &gt; 255 ? (col.MaxLength+1) : 255);
</I>&gt;&gt;<i> &gt;     698                                         buffer = new 
</I>&gt;&gt;<i> &gt; byte[bufsize];  // According to sqlext.h, use SQL_CHAR for both
</I>char
&gt;&gt;<i> and 
</I>&gt;&gt;<i> &gt; varchar
</I>&gt;&gt;<i> &gt;     699                                         StringBuilder sb1
</I>=
&gt;&gt;<i> new 
</I>&gt;&gt;<i> &gt; StringBuilder ();
</I>&gt;&gt;<i> &gt;     700                                         do {
</I>&gt;&gt;<i> &gt;     701                                                 ret = 
</I>&gt;&gt;<i> &gt; libodbc.SQLGetData (hstmt, ColIndex, col.SqlCType, buffer,
</I>bufsize,
&gt;&gt;<i> ref 
</I>&gt;&gt;<i> &gt; outsize);
</I>&gt;&gt;<i> &gt;     702                                                 if (ret ==
</I>
&gt;&gt;<i> &gt; OdbcReturn.Error)
</I>&gt;&gt;<i> &gt;     703                                                        
</I>&gt;&gt;<i> break;
</I>&gt;&gt;<i> &gt;     704                                                 if (ret !=
</I>
&gt;&gt;<i> &gt; OdbcReturn.NoData &amp;&amp; outsize!=-  1) {
</I>&gt;&gt;<i> &gt;     705                                                        
</I>if
&gt;&gt;<i> (outsize &lt; 
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; bufsize)
</I>&gt;&gt;<i> &gt;     706                                                           
</I>  
&gt;&gt;<i>   
</I>&gt;&gt;<i> &gt; sb1.Append
</I>&gt;&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,outsize));
</I>&gt;&gt;<i> &gt;     707                                                        
</I>else
&gt;&gt;<i> &gt;     708                                                           
</I>  
&gt;&gt;<i>   
</I>&gt;&gt;<i> &gt; sb1.Append
</I>&gt;&gt;<i> (System.Text.Encoding.Default.GetString(buffer,0,bufsize));
</I>&gt;&gt;<i> &gt;     709                                                 }
</I>&gt;&gt;<i> &gt;     710                                         } while (ret != 
</I>&gt;&gt;<i> &gt; OdbcReturn.NoData);
</I>&gt;&gt;<i> &gt;     711                                         DataValue =
</I>&gt;&gt;<i> sb1.ToString ();
</I>&gt;&gt;<i> &gt;     712                                         break;
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; According to 
</I>&gt;&gt;<i> &gt; <A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-">http://msdn.microsoft.com/library/default.asp?url=/library/en-</A>
</I>&gt;&gt;<i> us/odbc/htm/odb
</I>&gt;&gt;<i> &gt; csqlgetdata.asp
</I>&gt;&gt;<i> &gt; &quot;It is up to the application to reassemble the parts, taking care
</I>to
&gt;&gt;<i> remove 
</I>&gt;&gt;<i> &gt; the null-  termination character from intermediate parts of
</I>character
&gt;&gt;<i> data. &quot;
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; This patch fixes my problem:
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; Index: OdbcDataReader.cs
</I>&gt;&gt;<i> &gt;
</I>===================================================================
&gt;&gt;<i> &gt; ---   OdbcDataReader.cs   (revision 80063)
</I>&gt;&gt;<i> &gt; +++ OdbcDataReader.cs   (working copy)
</I>&gt;&gt;<i> &gt; @@ -  705,7 +705,7 @@
</I>&gt;&gt;<i> &gt;                                                         if
</I>(outsize &lt;
&gt;&gt;<i> 
</I>&gt;&gt;<i> &gt; bufsize)
</I>&gt;&gt;<i> &gt;                                                                
</I>&gt;&gt;<i> sb1.Append 
</I>&gt;&gt;<i> &gt; (System.Text.Encoding.Default.GetString(buffer,0,outsize));
</I>&gt;&gt;<i> &gt;                                                         else
</I>&gt;&gt;<i> &gt; -                                                                
</I>&gt;&gt;<i> sb1.Append 
</I>&gt;&gt;<i> &gt; (System.Text.Encoding.Default.GetString(buffer,0,bufsize));
</I>&gt;&gt;<i> &gt; +                                                             
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> sb1.Append 
</I>&gt;&gt;<i> &gt; (System.Text.Encoding.Default.GetString(buffer,0,bufsize-  1));
</I>&gt;&gt;<i> &gt;                                                 }
</I>&gt;&gt;<i> &gt;                                         } while (ret !=
</I>&gt;&gt;<i> OdbcReturn.NoData);
</I>&gt;&gt;<i> &gt;                                         DataValue = sb1.ToString
</I>();
&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; It assumes any fragment, with more data, always contains a binary
</I>&gt;&gt;<i> zero on 
</I>&gt;&gt;<i> &gt; the 
</I>&gt;&gt;<i> &gt; last position. This may or may not be the case -   some Odbc
</I>expert
&gt;&gt;<i> should 
</I>&gt;&gt;<i> &gt; probably look at it. There could be a problem with NVarchar also.
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; Regards,
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; Mads
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023934.html">[Mono-dev] Odbc and varchar - patch for varchars longer than 255
</A></li>
	<LI>Next message: <A HREF="023935.html">[Mono-dev] Error in UnixGroupInfo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23946">[ date ]</a>
              <a href="thread.html#23946">[ thread ]</a>
              <a href="subject.html#23946">[ subject ]</a>
              <a href="author.html#23946">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
