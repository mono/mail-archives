<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Using valgrind with Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Using%20valgrind%20with%20Mono&In-Reply-To=%3CCACmR%2BBAE2Q7S%2BG6H1%2B2S6ipWFmqHsh78w4466pSep0W3ROuJ%2BA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043587.html">
   <LINK REL="Next"  HREF="043590.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Using valgrind with Mono</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Using%20valgrind%20with%20Mono&In-Reply-To=%3CCACmR%2BBAE2Q7S%2BG6H1%2B2S6ipWFmqHsh78w4466pSep0W3ROuJ%2BA%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Using valgrind with Mono">kumpera at gmail.com
       </A><BR>
    <I>Wed Mar 30 00:14:34 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="043587.html">[Mono-dev] Using valgrind with Mono
</A></li>
        <LI>Next message: <A HREF="043590.html">[Mono-dev] Using valgrind with Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43589">[ date ]</a>
              <a href="thread.html#43589">[ thread ]</a>
              <a href="subject.html#43589">[ subject ]</a>
              <a href="author.html#43589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is the PR in question: <A HREF="https://github.com/mono/mono/pull/2783">https://github.com/mono/mono/pull/2783</A>

It probably won't make into 4.2, but should definitely be in 4.4.


On Tue, Mar 29, 2016 at 11:55 AM, Zinkevicius, Matt &lt;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matt.zinkevicius at hpe.com</A>&gt; wrote:

&gt;<i> Hi Rodrigo,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Is the following the PR that you were referring to that fixes the
</I>&gt;<i> &#8220;mono_method_get_header&#8221; leak?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/mono/mono/pull/2705">https://github.com/mono/mono/pull/2705</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am eager to find it, as this particular leak seems to be the most
</I>&gt;<i> egregious of the ones we&#8217;re experiencing, in terms of both occurrences and
</I>&gt;<i> total bytes leaked (hundreds of MB/hour when under load).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If so, I&#8217;ll try to backport it to Mono 4.2.3, though it is far from
</I>&gt;<i> patching cleanly currently.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] *On Behalf Of *Zinkevicius, Matt
</I>&gt;<i> *Sent:* Monday, March 28, 2016 2:42 PM
</I>&gt;<i> *To:* Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i> *Cc:* Straw, David (Storage) &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">david.straw at hpe.com</A>&gt;;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> *Subject:* Re: [Mono-dev] Using valgrind with Mono
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Rodrigo,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am not finding a recent commit in master that mentions
</I>&gt;<i> &#8220;mono_method_get_header&#8221;. Do you happen to have the commit ID or log
</I>&gt;<i> message handy?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sorry for the bother,
</I>&gt;<i>
</I>&gt;<i> Matt
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* Rodrigo Kumpera [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;]
</I>&gt;<i> *Sent:* Monday, March 28, 2016 1:58 PM
</I>&gt;<i> *To:* Zinkevicius, Matt &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matt.zinkevicius at hpe.com</A>&gt;
</I>&gt;<i> *Cc:* Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;; Straw, David (Storage) &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">david.straw at hpe.com</A>&gt;; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> *Subject:* Re: [Mono-dev] Using valgrind with Mono
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The memory leak on mono_method_get_header was recently fixed in master.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Mar 28, 2016 at 3:31 AM, Zinkevicius, Matt &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matt.zinkevicius at hpe.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> I can confirm that Zoltan&#8217;s fix does indeed remove any leak instances with
</I>&gt;<i> a call stack containing &#8220;ves_icall_Type_GetNestedTypes&#8221;, but unfortunately
</I>&gt;<i> that accounted for only 36 leak instances out of the 19,900 reported.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have filed a bug (<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=39940">https://bugzilla.xamarin.com/show_bug.cgi?id=39940</A>)
</I>&gt;<i> and attached the latest valgrind output there.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks again for any help you can provide,
</I>&gt;<i>
</I>&gt;<i> Matt Zinkevicius
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] *On Behalf Of *Zinkevicius, Matt
</I>&gt;<i> *Sent:* Sunday, March 27, 2016 11:06 PM
</I>&gt;<i> *To:* Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;
</I>&gt;<i> *Cc:* Straw, David (Storage) &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">david.straw at hpe.com</A>&gt;;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Subject:* Re: [Mono-dev] Using valgrind with Mono
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Zoltan,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you for investigating my findings. I will apply the fix you linked
</I>&gt;<i> to and report back. While I understand the other leaks are small, valgrind
</I>&gt;<i> reported over 19,000 instances of leaked memory in under 5 minutes of our
</I>&gt;<i> app running without load.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Matt Zinkevicius
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* Zoltan Varga [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;]
</I>&gt;<i> *Sent:* Sunday, March 27, 2016 4:45 PM
</I>&gt;<i> *To:* Zinkevicius, Matt &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matt.zinkevicius at hpe.com</A>&gt;
</I>&gt;<i> *Cc:* <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>; Straw, David (Storage) &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">david.straw at hpe.com</A>&gt;
</I>&gt;<i> *Subject:* Re: [Mono-dev] Using valgrind with Mono
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   Fixed the last one in:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/mono/mono/commit/b97ac0023256bf7d915552f5f24a7742b28c32b7">https://github.com/mono/mono/commit/b97ac0023256bf7d915552f5f24a7742b28c32b7</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The first two are leaks, but they should be small and bounded. Will look
</I>&gt;<i> into fixing them to decrease the noise.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>           Zoltan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sun, Mar 27, 2016 at 6:23 PM, Zinkevicius, Matt &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matt.zinkevicius at hpe.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Our backend service running on Mono 4.2.2 on Linux is experiencing an
</I>&gt;<i> unmanaged memory leak. When running our stress tests for several hours, we
</I>&gt;<i> see the managed heap sit around 50 MB, while private memory keeps growing
</I>&gt;<i> until the process is killed because of OOM. I am therefore attempting to
</I>&gt;<i> use valgrind to find the culprit, but I am getting so many leaks detected
</I>&gt;<i> that I think many must be false positives, so I thought I would ask here
</I>&gt;<i> for some guidance about which are safe to suppress or any other valgrind +
</I>&gt;<i> mono tricks you can share.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The vast majority of leaks reported have call stacks that closely match
</I>&gt;<i> one of the following:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ==16846== 4 bytes in 1 blocks are definitely lost in loss record 74 of
</I>&gt;<i> 19,903
</I>&gt;<i>
</I>&gt;<i> ==16846==    at 0x4C26FEF: calloc (vg_replace_malloc.c:711)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x62D1D9: monoeg_malloc0 (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x4870F2: decode_exception_debug_info (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x488975: mono_aot_find_jit_info (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x53C3A7: mono_jit_info_table_find_internal (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x493C04: mini_jit_info_table_find_ext (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x4988FB: mini_add_method_trampoline (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x499067: common_call_trampoline_inner (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x403217C: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x10D3FB63: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x10D3F41B: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x10D3F117: ???
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ==16846== 12 bytes in 1 blocks are definitely lost in loss record 1,172 of
</I>&gt;<i> 19,903
</I>&gt;<i>
</I>&gt;<i> ==16846==    at 0x4C2828A: malloc (vg_replace_malloc.c:299)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x62D221: monoeg_malloc (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x55B8EF: mono_metadata_type_dup (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x49FC4B: get_shared_gparam (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x49FE70: get_shared_inst (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x4A073A: mini_get_shared_method_full (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x414723: lookup_method (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x4147FA: mono_jit_compile_method_with_opt (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x414B9A: mono_jit_compile_method (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x498DA4: common_call_trampoline_inner (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x403405C: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x10D2DCA7: ???
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ==16846== 10 bytes in 1 blocks are definitely lost in loss record 739 of
</I>&gt;<i> 19,903
</I>&gt;<i>
</I>&gt;<i> ==16846==    at 0x4C2828A: malloc (vg_replace_malloc.c:299)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x62D221: monoeg_malloc (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x62BA8C: monoeg_g_utf16_to_utf8 (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x5A8646: mono_string_to_utf8_checked (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x5A885B: mono_string_to_utf8 (in /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x52DE3C: ves_icall_Type_GetNestedTypes (in
</I>&gt;<i> /usr/bin/mono-sgen)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x120D4256: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0xE338A78:
</I>&gt;<i> System_Type_GetMember_string_System_Reflection_BindingFlags (type.cs:806)
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x40C09EF: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x1259A6AF: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x73: ???
</I>&gt;<i>
</I>&gt;<i> ==16846==    by 0x141D191D: ???
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Are these valid leaks or is valgrind confused/misconfigured? I am using
</I>&gt;<i> the following command:
</I>&gt;<i>
</I>&gt;<i> valgrind --tool=memcheck -v --leak-check=full --log-file=val.txt
</I>&gt;<i> --smc-check=all mono program.exe
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks for any input you can offer,
</I>&gt;<i>
</I>&gt;<i> Matt Zinkevicius
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160329/fbd23d21/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160329/fbd23d21/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043587.html">[Mono-dev] Using valgrind with Mono
</A></li>
	<LI>Next message: <A HREF="043590.html">[Mono-dev] Using valgrind with Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43589">[ date ]</a>
              <a href="thread.html#43589">[ thread ]</a>
              <a href="subject.html#43589">[ subject ]</a>
              <a href="author.html#43589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
