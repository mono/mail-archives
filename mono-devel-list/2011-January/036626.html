<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] more support for Google Native Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20more%20support%20for%20Google%20Native%20Client&In-Reply-To=AANLkTi%3Dp5wr6fwarjRjB93FF8_N_8QMzVYcggmfXkZsk%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036625.html">
   <LINK REL="Next"  HREF="036636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] more support for Google Native Client</H1>
    <B>Elijah Taylor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20more%20support%20for%20Google%20Native%20Client&In-Reply-To=AANLkTi%3Dp5wr6fwarjRjB93FF8_N_8QMzVYcggmfXkZsk%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] more support for Google Native Client">elijahtaylor at google.com
       </A><BR>
    <I>Tue Jan  4 13:55:14 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="036625.html">[Mono-dev] [PATCH] more support for Google Native Client
</A></li>
        <LI>Next message: <A HREF="036636.html">[Mono-dev] [PATCH] more support for Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36626">[ date ]</a>
              <a href="thread.html#36626">[ thread ]</a>
              <a href="subject.html#36626">[ subject ]</a>
              <a href="author.html#36626">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Replies inline:

On Tue, Jan 4, 2011 at 10:30 AM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>   Some comments:
</I>&gt;<i> - the patch changes IMT_REG to AMD64_R11 in the non-nacl case, I'm not sure
</I>&gt;<i> thats
</I>&gt;<i>   intentional.
</I>&gt;<i>
</I>
Has this changed in the last six months on the Mono side?  IIRC I didn't
mean to change anything like this.  The reason I made explicit defines was
so code in aot-compiler and mini-amd64 could share defines over which reg
was the one we jump through and which was a scratch reg.  I'll diff vs Mono
head revision and make it correct.


&gt;<i> - you could define __mono_ilp32__ in the nacl/amd64 case, and use that
</I>&gt;<i> instead of
</I>&gt;<i>   defined(__native_client_codegen__) &amp;&amp; defined(TARGET_AMD64) in a few
</I>&gt;<i> places.
</I>&gt;<i>
</I>
That sounds reasonable.  I'm assuming you mean non-arch specific areas like
mini.c, aot-*.c, method-to-ir.c, etc?  Are there any other major
consequences to defining __mono_ilp32__ ?


&gt;<i> - it would be better to define nacl_global_codeman_validate () as a no-op
</I>&gt;<i> in the non-nacl case, so its callers wouldn't need #ifdefs.
</I>&gt;<i>
</I>
I'll fix this.


&gt;<i> - genmdesc.c contains this change, which is probably not needed:
</I>&gt;<i> +void __nacl_suspend_thread_if_needed() {}
</I>&gt;<i> +
</I>&gt;<i>
</I>
It is needed temporarily due to a preliminary GC implementation, we don't
have to submit it this way.  Eventually (soon) we won't need it at all.


&gt;<i> - you could use sizeof(mgreg_t) instead of SIZEOF_REGISTER to be consistent
</I>&gt;<i> with
</I>&gt;<i>   the usage of sizeof(gpointer).
</I>&gt;<i>
</I>
Sounds good.  I'll try to use sizeof for all compiled code and only use
SIZEOF_REGISTER/SIZEOF_VOID_P for pre-processor directives only.


&gt;<i> Other than these, I think the changes look fine, they aren't that
</I>&gt;<i> disruptive, since they don't
</I>&gt;<i> change the non-nacl behavior at all.
</I>&gt;<i>
</I>&gt;<i>
</I>Great!  I was worried just based on LOC changed that it might get more
resistance.  In truth I'm more worried about future Mono changes
accidentally breaking NaCl behavior.  I'm planning on getting some automated
testing implemented soon to combat this though.




&gt;<i> On Tue, Dec 21, 2010 at 9:12 PM, Elijah Taylor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">elijahtaylor at google.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Greetings Mono developers!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *[tl;dr  very large patch for Native Client&lt;<A HREF="http://www.chromium.org/nativeclient">http://www.chromium.org/nativeclient</A>&gt; support
</I>&gt;&gt;<i> hosted here &lt;<A HREF="https://github.com/elijahtaylor/mono">https://github.com/elijahtaylor/mono</A>&gt;, would love feedback
</I>&gt;&gt;<i> and many eyes to look at it]
</I>&gt;&gt;<i> *
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm back with another round of changes for supporting Google's Native
</I>&gt;&gt;<i> Client (NaCl), including support for amd64, JIT compilation, and Garbage
</I>&gt;&gt;<i> Collection.  It's a large set of changes, forked on Dec 14 in github @
</I>&gt;&gt;<i> <A HREF="https://github.com/elijahtaylor/mono.">https://github.com/elijahtaylor/mono.</A>  I would appreciate feedback on
</I>&gt;&gt;<i> these changes... to facilitate this, I'll try to explain the largest changes
</I>&gt;&gt;<i> by feature (please email if clarification is needed):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *1) amd64 codegen*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Rules located here:
</I>&gt;&gt;<i>    <A HREF="http://www.chromium.org/nativeclient/design-documents/nacl-sfi-model-on-x86-64-systems">http://www.chromium.org/nativeclient/design-documents/nacl-sfi-model-on-x86-64-systems</A>
</I>&gt;&gt;<i>       - Removed %r15 from register allocation, LMF save/restore, etc.
</I>&gt;&gt;<i>        (r15 is special and not modifiable by untrusted code)
</I>&gt;&gt;<i>       - Sandbox all data access through membase address mode.  If not
</I>&gt;&gt;<i>       %rsp or %rbp relative, re-write as clearing upper 32-bits + memindex
</I>&gt;&gt;<i>       addressing
</I>&gt;&gt;<i>       - align functions, call sites
</I>&gt;&gt;<i>       - Sandbox returns and all indirect jumps (need to be 32-byte
</I>&gt;&gt;<i>       aligned, cleared upper 32-bits)
</I>&gt;&gt;<i>       - Never omit frame pointer as general operations to rbp aren't
</I>&gt;&gt;<i>       allowed
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *2) NaCl x86-64 is ILP32 (this is the largest set of changes and may make
</I>&gt;&gt;<i> some mono devs unhappy)*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Set SIZEOF_REGISTER == 8 while sizeof(gpointer) == 4 for NaCl amd64
</I>&gt;&gt;<i>    (we can use 8-byte instructions, but pointers are 4-bytes)
</I>&gt;&gt;<i>    - Re-write large portions of mini-amd64.c, tramp-amd64.c,
</I>&gt;&gt;<i>    exceptions-amd64.c, mini.c, method-to-ir.c to use appropriate sizes
</I>&gt;&gt;<i>    (SIZEOF_REGISTER, sizeof(gpointer), literal '8').  *These changes are
</I>&gt;&gt;<i>    disruptive, but ultimately they should be more correct than what was there
</I>&gt;&gt;<i>    before.  *It's our opinion that these changes actually improve Mono
</I>&gt;&gt;<i>    despite their impact.
</I>&gt;&gt;<i>    - We only generate NaCl amd64 code from an ILP32 machine (either a
</I>&gt;&gt;<i>    32-bit application for AOT code, or NaCl runtime JIT), so we may not have
</I>&gt;&gt;<i>    caught all of the [8 &lt;--&gt; SIZEOF_REGISTER] conversions, but we likely caught
</I>&gt;&gt;<i>    most of the [sizeof(gpointer) &lt;--&gt; SIZEOF_REGISTER] and [8 &lt;--&gt;
</I>&gt;&gt;<i>    sizeof(gpointer)] changes that are necessary.
</I>&gt;&gt;<i>    - Change atomic operations and default pointer directives to use
</I>&gt;&gt;<i>    32-bit instructions (long instead of quad)
</I>&gt;&gt;<i>    - Change default operations to use 32-bit integers/pointers (eg,
</I>&gt;&gt;<i>    OP_LOAD_MEMBASE uses 4-bytes instead of 8)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *3) JIT support for NaCl*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - Since we're unable to emit code directly in its final executable
</I>&gt;&gt;<i>    location, we instead:
</I>&gt;&gt;<i>       - reserve a buffer on the heap
</I>&gt;&gt;<i>       - create a hash table entry mapping the temp location and final
</I>&gt;&gt;<i>       location
</I>&gt;&gt;<i>       - modify all non-local patches relative to the final location
</I>&gt;&gt;<i>       - request the NaCl runtime to install the created code in the final
</I>&gt;&gt;<i>       location
</I>&gt;&gt;<i>    - See mono/utils/mono-codeman.c changes for more detail.
</I>&gt;&gt;<i>    - For every codeman *reserve*, we must add a codeman *validate* call
</I>&gt;&gt;<i>    in order to install the method/trampoline/blob in the final location (as
</I>&gt;&gt;<i>    well as validate it for NaCl, pad it out, etc)
</I>&gt;&gt;<i>    - We don't delete or reuse code  (we can, but it's icky and the
</I>&gt;&gt;<i>    benefits don't outweigh the cost)
</I>&gt;&gt;<i>    - Backpatching changed to use NaCl syscalls to modify existing dynamic
</I>&gt;&gt;<i>    code
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *4) GC support for NaCl (boehm only)*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - NaCl compiler and Mono code generator both emit instrumentation at
</I>&gt;&gt;<i>    GC &quot;safe points&quot; (back branches and function prologs), for cooperative
</I>&gt;&gt;<i>    thread parking (we're not allowed to send and receive signals)
</I>&gt;&gt;<i>    - Added new opcode OP_NACL_GC_SAFE_POINT to handle mono
</I>&gt;&gt;<i>    instrumentation
</I>&gt;&gt;<i>    - modified pthread_stop_world.c and pthread_support.c somewhat
</I>&gt;&gt;<i>    extensively to support this new way of stopping the world
</I>&gt;&gt;<i>    - wrapped pthread_exit because NaCl doesn't support pthread cleanup
</I>&gt;&gt;<i>    functions
</I>&gt;&gt;<i>    - added machine type NACL to libgc with machine specific defines
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *5) Misc bug fixes (not NaCl-specific)*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    - fix *x86_memindex_emit* when disp is 32-bit
</I>&gt;&gt;<i>    - properly exclude code in libgc/gc_dlopen.c when DYNAMIC_LOADING not
</I>&gt;&gt;<i>    defined
</I>&gt;&gt;<i>    - properly exclude code based on DISABLE_SOCKETS by including config.h
</I>&gt;&gt;<i>    before checking define
</I>&gt;&gt;<i>    - clean up calculation of offset for amd64 AOT specific trampoline
</I>&gt;&gt;<i>    args
</I>&gt;&gt;<i>    - fix bug in *mono_bblock_insert_before_ins* when trying to insert an
</I>&gt;&gt;<i>    instruction to the beginning of an existing basic block.
</I>&gt;&gt;<i>    - fix small typo bug in genmdesc.pl which kept amd64 from being able
</I>&gt;&gt;<i>    to be a target of cross compiling
</I>&gt;&gt;<i>    - fix struct passing in amd64 with sizeof(struct) == 16 when fields
</I>&gt;&gt;<i>    aren't 8-byte aligned (eg, first field is 12 bytes, second field is 4
</I>&gt;&gt;<i>    bytes), pass on stack instead of in registers (mini-amd64.c:*
</I>&gt;&gt;<i>    add_valuetype*)
</I>&gt;&gt;<i>    - add extra checks to mini-amd64.c:*mono_arch_emit_exceptions* to keep
</I>&gt;&gt;<i>    exception/R4/R8 emitting from overflowing a buffer silently
</I>&gt;&gt;<i>    - fix bugs in *new_codechunk* and *mono_code_manager_reserve_align*which allowed unaligned code to be allocated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know we're close to holidays so I don't have any delusions that these
</I>&gt;&gt;<i> changes will get in by the end of the year :)  Please feel free to pick
</I>&gt;&gt;<i> apart these changes and let me know if there are things that should be
</I>&gt;&gt;<i> changed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Elijah
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110104/fa9113dc/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110104/fa9113dc/attachment-0001.html</A> 
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036625.html">[Mono-dev] [PATCH] more support for Google Native Client
</A></li>
	<LI>Next message: <A HREF="036636.html">[Mono-dev] [PATCH] more support for Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36626">[ date ]</a>
              <a href="thread.html#36626">[ thread ]</a>
              <a href="subject.html#36626">[ subject ]</a>
              <a href="author.html#36626">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
