<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Soft%20Debugger%20issues%20%28can%27t%20suspend%20threads%20in%0A%09wait_for_suspend%29&In-Reply-To=AANLkTi%3DT-0SUdO7juur1T9Z%3D3Ta%3DYz7kesa%2BU5jDqGrR%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036799.html">
   <LINK REL="Next"  HREF="036807.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)</H1>
    <B>Virgile Bello</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Soft%20Debugger%20issues%20%28can%27t%20suspend%20threads%20in%0A%09wait_for_suspend%29&In-Reply-To=AANLkTi%3DT-0SUdO7juur1T9Z%3D3Ta%3DYz7kesa%2BU5jDqGrR%40mail.gmail.com"
       TITLE="[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)">virgile.bello at gmail.com
       </A><BR>
    <I>Tue Jan 25 11:51:52 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="036799.html">[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)
</A></li>
        <LI>Next message: <A HREF="036807.html">[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36800">[ date ]</a>
              <a href="thread.html#36800">[ thread ]</a>
              <a href="subject.html#36800">[ subject ]</a>
              <a href="author.html#36800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Turns out it might be due to Win32 limitations (QueueUserAPC works only if
SleepEx/WaitForMultipleObjectsEx etc... are used), as notify_thread_apc is
never called back.
I can fix that on my own threads. However, finalizer thread should use such
functions as well otherwise it will always hang internally.
Sorry for the trouble.

On Wed, Jan 26, 2011 at 1:26 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:

&gt;<i> Sorry, last small update, if I simply disable the waiting loop
</I>&gt;<i> in wait_for_suspend() and make is_suspended() always return TRUE,
</I>&gt;<i> breakpoints/tracing work as expected (except maybe playing with other
</I>&gt;<i> threads of course).
</I>&gt;<i> This seems to confirm there might be some false positive when trying to
</I>&gt;<i> detect threads that run in native mode (mono think they are managed).
</I>&gt;<i>
</I>&gt;<i> On Wed, Jan 26, 2011 at 1:06 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Just as a small addition, to confirm what I said earlier concerning
</I>&gt;&gt;<i> situation with additional threads.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After adding 2 threads that don't actually call mono (simply register them
</I>&gt;&gt;<i> with mono_thread_attach(mono_get_root_domain())), I end up having:
</I>&gt;&gt;<i> &quot;Waiting for 2(4) threads to suspend...&quot; which mean 1 of the fully native
</I>&gt;&gt;<i> threads is also blocking it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe it can't detect well when threads are running in native mode?
</I>&gt;&gt;<i>  I will continue to investigate as well.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Wed, Jan 26, 2011 at 12:58 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am having trouble with mono soft debugger.
</I>&gt;&gt;&gt;<i> - I embed Mono runtime in my program, and I got MonoDevelop to act as
</I>&gt;&gt;&gt;<i> SoftDebugger client
</I>&gt;&gt;&gt;<i> - Mono soft debugger is loading properly (first breakpoint usually works
</I>&gt;&gt;&gt;<i> -- if already set beforehand -- I can see callstacks, etc...)
</I>&gt;&gt;&gt;<i> - As soon as I press F5 -- to execute until this breakpoint is reached
</I>&gt;&gt;&gt;<i> again next iteration -- or if I disable/reenable this breakpoint, program
</I>&gt;&gt;&gt;<i> hang (see log)
</I>&gt;&gt;&gt;<i> - Main loop is in C and Mono functions are called regularly.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I traced down the problem to thread(s) not suspending (cf log).
</I>&gt;&gt;&gt;<i> Usually, it seems it is the Finalizer thread (in this case 00002054) that
</I>&gt;&gt;&gt;<i> doesn't get suspended.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In mono sources, I tried to call
</I>&gt;&gt;&gt;<i> mono_gc_collect/mono_gc_invoke_finalizers in the suspend_thread loop. In
</I>&gt;&gt;&gt;<i> that case, I can manage to have F5 working (breakpoint trigger every step
</I>&gt;&gt;&gt;<i> inside the loop).
</I>&gt;&gt;&gt;<i> However it doesn't work as soon as I do anything else (such as removing &amp;
</I>&gt;&gt;&gt;<i> adding again the breakpoint).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I remember seeing this problem on more than 1 thread when I had other
</I>&gt;&gt;&gt;<i> threads active (i.e. Waiting for 3(4) threads to suspend...)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Does anyone have an idea? Maybe there is something special to do if Mono
</I>&gt;&gt;&gt;<i> doesn't keep hand (often back to full unmanaged world since main loop is in
</I>&gt;&gt;&gt;<i> C)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Debugger log:
</I>&gt;&gt;&gt;<i>  [00000410] Thread started, obj=04702F20, tls=004CDA60.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [00000410] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Suspending vm...
</I>&gt;&gt;&gt;<i> [00000410] Sent event VM_START, suspend=2.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Agent thread started, pid=00001260
</I>&gt;&gt;&gt;<i> [00002054] Thread started, obj=04702E70, tls=004EC1D8. &lt; Finalizer thread
</I>&gt;&gt;&gt;<i> [00002054] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(VERSION), id=1.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(SET_PROTOCOL_VERSION), id=2.
</I>&gt;&gt;&gt;<i> [dbg] Protocol version 2.2, client protocol version 2.2.
</I>&gt;&gt;&gt;<i> [dbg] Received command APPDOMAIN(1), id=3.
</I>&gt;&gt;&gt;<i> ...............
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(1), id=1785.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(6), id=1786.
</I>&gt;&gt;&gt;<i> [00002054] Received single step event for suspending.
</I>&gt;&gt;&gt;<i> [00002054] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(RESUME), id=1787.
</I>&gt;&gt;&gt;<i> [00001260] Resuming vm...
</I>&gt;&gt;&gt;<i> [00002054] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Suspending vm...
</I>&gt;&gt;&gt;<i> [00000410] Interrupting 00002054...
</I>&gt;&gt;&gt;<i> [00000410] Sent event TYPE_LOAD, suspend=2.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(1), id=1788.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(6), id=1789.
</I>&gt;&gt;&gt;<i> [00002054] Received single step event for suspending.
</I>&gt;&gt;&gt;<i> [00002054] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(RESUME), id=1790.
</I>&gt;&gt;&gt;<i> [00001260] Resuming vm...
</I>&gt;&gt;&gt;<i> [00002054] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Suspending vm...
</I>&gt;&gt;&gt;<i>  [00000410] Interrupting 00002054...
</I>&gt;&gt;&gt;<i> [00000410] Sent event TYPE_LOAD, suspend=2.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(1), id=1791.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(6), id=1792.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(RESUME), id=1793.
</I>&gt;&gt;&gt;<i> [00002054] Received single step event for suspending.
</I>&gt;&gt;&gt;<i> [00002054] Suspended.
</I>&gt;&gt;&gt;<i> [00001260] Resuming vm...
</I>&gt;&gt;&gt;<i> [00000410] Resumed.
</I>&gt;&gt;&gt;<i> [00002054] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Suspending vm...
</I>&gt;&gt;&gt;<i> [00000410] Interrupting 00002054...
</I>&gt;&gt;&gt;<i> [00000410] Sent event TYPE_LOAD, suspend=2.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(1), id=1794.
</I>&gt;&gt;&gt;<i> [dbg] Received command TYPE(6), id=1795.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(RESUME), id=1796.
</I>&gt;&gt;&gt;<i> [00001260] Resuming vm...
</I>&gt;&gt;&gt;<i> [00000410] Resumed.
</I>&gt;&gt;&gt;<i> [00000410] Breakpoint hit, method=Step, offset=0x1e.
</I>&gt;&gt;&gt;<i> [00000410] Suspending vm...
</I>&gt;&gt;&gt;<i> [00000410] Interrupting 00002054...
</I>&gt;&gt;&gt;<i> [00000410] Sent event BREAKPOINT, suspend=2.
</I>&gt;&gt;&gt;<i> [00000410] Suspended.
</I>&gt;&gt;&gt;<i> [dbg] Received command VM(ALL_THREADS), id=1797.
</I>&gt;&gt;&gt;<i> [dbg] Received command THREAD(1), id=1798.
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i> Waiting for 1(2) threads to suspend...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110126/fa96bf77/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110126/fa96bf77/attachment-0001.html</A> 
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036799.html">[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)
</A></li>
	<LI>Next message: <A HREF="036807.html">[Mono-dev] Soft Debugger issues (can't suspend threads in	wait_for_suspend)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36800">[ date ]</a>
              <a href="thread.html#36800">[ thread ]</a>
              <a href="subject.html#36800">[ subject ]</a>
              <a href="author.html#36800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
