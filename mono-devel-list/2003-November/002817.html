<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] incorrect code generated by mcs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20incorrect%20code%20generated%20by%20mcs&In-Reply-To=001201c3a3bd%244557bc30%243962f486%40net.plm.eds.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002816.html">
   <LINK REL="Next"  HREF="002803.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] incorrect code generated by mcs</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20incorrect%20code%20generated%20by%20mcs&In-Reply-To=001201c3a3bd%244557bc30%243962f486%40net.plm.eds.com"
       TITLE="[Mono-devel-list] incorrect code generated by mcs">lupus at ximian.com
       </A><BR>
    <I>Wed Nov  5 13:01:39 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002816.html">[Mono-devel-list] incorrect code generated by mcs
</A></li>
        <LI>Next message: <A HREF="002803.html">[Mono-devel-list] incorrect code generated by mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2817">[ date ]</a>
              <a href="thread.html#2817">[ thread ]</a>
              <a href="subject.html#2817">[ subject ]</a>
              <a href="author.html#2817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/05/03 Bernie Solomon wrote:
&gt;<i> I think Laurent is right: from the spec on stloc
</I>&gt;<i> 
</I>&gt;<i> The stloc indx instruction pops the top value off the evalution stack and
</I>&gt;<i> moves it into local variable number indx (see Partition I_alink_partitionI),
</I>&gt;<i> where local variables are numbered 0 onwards. The type of value must match
</I>&gt;<i> the type of the local variable as specified in the current method's locals
</I>&gt;<i> signature.
</I>&gt;<i> 
</I>&gt;<i> Actually I recall seeing something a little similar where both csc &amp; mcs
</I>&gt;<i> generated a 'dup' to effectively get from a int32 to a nati with no
</I>&gt;<i> conversion. I can't recall the input code at the moment. Though there is a
</I>&gt;<i> bit of a hack in the interpreter to try and manage this. When I get time
</I>&gt;<i> I'll try and work out the offending code.
</I>
Well, you should remember that the people that wrote the CLR are the
same that made sizeof(long) == sizeof(int) on 64 bit architectures:-)
So they are used to think sizeof(int) == sizeof(void*), too, even in
the sample code they post on blogs or mailing lists.
The standard is ambiguous with the wording: since the eval stack only
holds a subset of the primitive types, there is no way the type of the
value can always match the type of the local (think storing true/false
to a bool: the value is a int32).
So, my take is that the table about implicit conversions in argument
passing in the standard also applies to stloc/stfld and the like
(and yes, allowing the implicit cast from native int to int is
unfortunate, since native ints represent pointers).
If you write a little test in ilasm (c# won't let you) you'll also note
that PEVerify doesn't complain about that case, but does complain
if you put a long in an int (their jit in full trust mode will also
happily run the code). What this means, basically, is that there is
already code out there (and compilers) that likely depend on the
behaviour and we'll have to support that (note that the cost of this
support is basically null, since we need to verify the types anyway).

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002816.html">[Mono-devel-list] incorrect code generated by mcs
</A></li>
	<LI>Next message: <A HREF="002803.html">[Mono-devel-list] incorrect code generated by mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2817">[ date ]</a>
              <a href="thread.html#2817">[ thread ]</a>
              <a href="subject.html#2817">[ subject ]</a>
              <a href="author.html#2817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
