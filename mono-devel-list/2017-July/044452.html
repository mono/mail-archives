<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] increased memory usage when embedding mono under special	environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20increased%20memory%20usage%20when%20embedding%20mono%20under%0A%20special%09environment&In-Reply-To=%3CBN6PR21MB062679C1CCD8F5B8DB4DDE5AC2D70%40BN6PR21MB0626.namprd21.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044451.html">
   <LINK REL="Next"  HREF="044453.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] increased memory usage when embedding mono under special	environment</H1>
    <B>Bernhard Urban</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20increased%20memory%20usage%20when%20embedding%20mono%20under%0A%20special%09environment&In-Reply-To=%3CBN6PR21MB062679C1CCD8F5B8DB4DDE5AC2D70%40BN6PR21MB0626.namprd21.prod.outlook.com%3E"
       TITLE="[Mono-dev] increased memory usage when embedding mono under special	environment">beurba at microsoft.com
       </A><BR>
    <I>Tue Jul  4 13:01:06 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044451.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
        <LI>Next message (by thread): <A HREF="044453.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44452">[ date ]</a>
              <a href="thread.html#44452">[ thread ]</a>
              <a href="subject.html#44452">[ subject ]</a>
              <a href="author.html#44452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>How do you determine said memory usage?  Is your special program somehow messing with malloc?  Note that mono uses malloc for quite some stuff, so if your special program messes with the allocation pattern that could explain it. I suggest to look at it with some profiler.

-Bernhard
________________________________________
From: Mono-devel-list &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.dot.net</A>&gt; on behalf of Jovic, Vladimir &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">vladimir.jovic at ifm.com</A>&gt;
Sent: Tuesday, July 4, 2017 2:39:35 PM
To: <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list at lists.dot.net</A>
Subject: [Mono-dev] increased memory usage when embedding mono under special    environment

Hello,

I am crosscompiling mono 4.4.2 for PPC platform (couldn't compile newer version, as the configuration fails).
Also, I implemented a c++ library, which executes a C# function in DLL. This library is dynamically loaded at runtime (using dlopen) by a program with very special environment. I wouldn't be surprised to hear that this program experience both stack smash and memory overwrites at the same time, but I am not in a position to pick.

Now the problem I am having is: when I use my library in a standalone program, then it works fine. But when I use my library with the program with this special environment, than it uses 40 more megabytes to do some initializations. The parameters for both programs are the same (default, as I do not set any environment variables).

The code to set the mono library is next. As you see, it is a code that can be found in any example of how to execute a c# function from a DLL.

MonoMethod* csMethodEntryPoint = NULL;

void SetMethodEntryPoint( const std::string&amp; ifmDllsPath )
{
    mono_config_parse( NULL );

    MonoDomain* monoDomain = mono_jit_init_version( &quot;pdm_mono_sdk&quot;, &quot;v4.0.30319&quot; );

    const std::string assemblyName( ifmDllsPath + &quot;/ifmApiLinuxWrapper.dll&quot; );
    MonoAssembly* assembly = mono_domain_assembly_open( monoDomain, assemblyName.c_str() );
    if ( NULL == assembly )
    {
        throw std::runtime_error( &quot;assembly is NULL&quot; );
    }

    MonoImage* monoImage = mono_assembly_get_image( assembly );
    if ( NULL == monoImage )
    {
        throw std::runtime_error( &quot;monoImage is NULL&quot; );
    }

    MonoClass* entityClass = mono_class_from_name( monoImage, &quot;ifmApiLinuxWrapper&quot;, &quot;ifmApiLinuxWrapper&quot; );
    if ( NULL ==  entityClass )
    {
        throw std::runtime_error( &quot;entityClass is NULL&quot; );
    }

    csMethodEntryPoint = mono_class_get_method_from_name( entityClass, &quot;ApiCmdRequest&quot;, 2 );
    if ( NULL == csMethodEntryPoint )
    {
        throw std::runtime_error( &quot;entryPoint is NULL&quot; );
    }
}


The function that allocates extra memory is mono_jit_init_version(). In a standalone program, it allocates 1M, and with this special program 20M!
I said above that I lose 40M. So, 19M with mono_jit_init_version(), and extra 21M from a call to c# function.
I took a look into the mono source code for mono_jit_init_version() function, but the function is so huge, that I got lost quite quickly.

The question is how to debug this. Can I set some environment variable to help me track why extra memory is allocated?

Cheers,
Vladimir Jovic


_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A>
<A HREF="https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fmono-devel-list&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cf316d1bef9ff4526a28e08d4c2d9c199%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347687894932396&amp;sdata=7STXOC7bR3PWerb3i2SWA8ZjNKY5nuxhrhNa8YdCgj4%3D&amp;reserved=0">https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fmono-devel-list&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cf316d1bef9ff4526a28e08d4c2d9c199%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347687894932396&amp;sdata=7STXOC7bR3PWerb3i2SWA8ZjNKY5nuxhrhNa8YdCgj4%3D&amp;reserved=0</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044451.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
	<LI>Next message (by thread): <A HREF="044453.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44452">[ date ]</a>
              <a href="thread.html#44452">[ thread ]</a>
              <a href="subject.html#44452">[ subject ]</a>
              <a href="author.html#44452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
