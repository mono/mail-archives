<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] increased memory usage when embedding mono under special	environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20increased%20memory%20usage%20when%20embedding%20mono%20under%0A%20special%09environment&In-Reply-To=%3CBN6PR21MB062697B7BB5B0F5801F62F23C2D70%40BN6PR21MB0626.namprd21.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044453.html">
   <LINK REL="Next"  HREF="044455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] increased memory usage when embedding mono under special	environment</H1>
    <B>Bernhard Urban</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20increased%20memory%20usage%20when%20embedding%20mono%20under%0A%20special%09environment&In-Reply-To=%3CBN6PR21MB062697B7BB5B0F5801F62F23C2D70%40BN6PR21MB0626.namprd21.prod.outlook.com%3E"
       TITLE="[Mono-dev] increased memory usage when embedding mono under special	environment">beurba at microsoft.com
       </A><BR>
    <I>Tue Jul  4 21:51:01 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044453.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
        <LI>Next message (by thread): <A HREF="044455.html">[Mono-dev] SEGV during nursery scanning
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44454">[ date ]</a>
              <a href="thread.html#44454">[ thread ]</a>
              <a href="subject.html#44454">[ subject ]</a>
              <a href="author.html#44454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As hinted in my previous message I could image that your special program sets some environment variable that the malloc implementation of your embedded system respects, and thus changes the allocation behavior you observe. How about you dump all environment variables before calling into mono?

Also it would be useful to know what libc implementation you're using. What is the absolute memory usage before calling into mono in your special program vs. the example you posted? Maybe you trigger some threshold and malloc allocates some bigger chunk.

There are environment variables to control the heap size of mono (check the man page), but I doubt you set them by accident.

Just some thoughts, no idea what's going on.

-Bernhard

From: Jovic, Vladimir
Sent: Tuesday, July 4, 15:12
Subject: AW: [Mono-dev] increased memory usage when embedding mono under specialenvironment
To: Bernhard Urban, <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list at lists.dot.net</A>


Hello, To see where the memory goes, I used sysinfo() : <A HREF="https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman2%2Fsysinfo.2.html&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cea86b8b4102a4006b02d08d4c2de5d65%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347707686498740&amp;sdata=x9UzLkDI%2BdXcA%2BIjcedHbkcLKX1ZKgpww%2F83UvMh3fY%3D&amp;reserved=0">https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman2%2Fsysinfo.2.html&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cea86b8b4102a4006b02d08d4c2de5d65%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347707686498740&amp;sdata=x9UzLkDI%2BdXcA%2BIjcedHbkcLKX1ZKgpww%2F83UvMh3fY%3D&amp;reserved=0</A> and I printed before and after calling any mono function in the function bellow. Like that, I see free memory after every function. As I am developing for a PPC embedded device, I am quite limited in tools. Otherwise, I would use valgrind. Although I am not sure how it would help in this case, as the memory is allocated by mono. Could it be possible that program arguments, or environment variables, are somehow changing how much memory is allocated by mono? Cheers, Vladimir &gt; -----Urspr√ºngliche Nachricht----- &gt; Von: Bernhard Urban [mailto:<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">beurba at microsoft.com</A>] &gt; Gesendet: Dienstag, 4. Juli 2017 15:01 &gt; An: Jovic, Vladimir ; <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list at lists.dot.net</A> &gt; Betreff: Re: [Mono-dev] increased memory usage when embedding mono under &gt; special environment &gt; &gt; How do you determine said memory usage? Is your special program somehow &gt; messing with malloc? Note that mono uses malloc for quite some stuff, so if your &gt; special program messes with the allocation pattern that could explain it. I suggest &gt; to look at it with some profiler. &gt; &gt; -Bernhard &gt; ________________________________________ &gt; From: Mono-devel-list on behalf of &gt; Jovic, Vladimir &gt; Sent: Tuesday, July 4, 2017 2:39:35 PM &gt; To: <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list at lists.dot.net</A> &gt; Subject: [Mono-dev] increased memory usage when embedding mono under &gt; special environment &gt; &gt; Hello, &gt; &gt; I am crosscompiling mono 4.4.2 for PPC platform (couldn't compile newer version, &gt; as the configuration fails). &gt; Also, I implemented a c++ library, which executes a C# function in DLL. This library &gt; is dynamically loaded at runtime (using dlopen) by a program with very special &gt; environment. I wouldn't be surprised to hear that this program experience both &gt; stack smash and memory overwrites at the same time, but I am not in a position to &gt; pick. &gt; &gt; Now the problem I am having is: when I use my library in a standalone program, &gt; then it works fine. But when I use my library with the program with this special &gt; environment, than it uses 40 more megabytes to do some initializations. The &gt; parameters for both programs are the same (default, as I do not set any &gt; environment variables). &gt; &gt; The code to set the mono library is next. As you see, it is a code that can be &gt; found in any example of how to execute a c# function from a DLL. &gt; &gt; MonoMethod* csMethodEntryPoint = NULL; &gt; &gt; void SetMethodEntryPoint( const std::string&amp; ifmDllsPath ) { &gt; mono_config_parse( NULL ); &gt; &gt; MonoDomain* monoDomain = mono_jit_init_version( &quot;pdm_mono_sdk&quot;, &gt; &quot;v4.0.30319&quot; ); &gt; &gt; const std::string assemblyName( ifmDllsPath + &quot;/ifmApiLinuxWrapper.dll&quot; ); &gt; MonoAssembly* assembly = mono_domain_assembly_open( monoDomain, &gt; assemblyName.c_str() ); &gt; if ( NULL == assembly ) &gt; { &gt; throw std::runtime_error( &quot;assembly is NULL&quot; ); &gt; } &gt; &gt; MonoImage* monoImage = mono_assembly_get_image( assembly ); &gt; if ( NULL == monoImage ) &gt; { &gt; throw std::runtime_error( &quot;monoImage is NULL&quot; ); &gt; } &gt; &gt; MonoClass* entityClass = mono_class_from_name( monoImage, &gt; &quot;ifmApiLinuxWrapper&quot;, &quot;ifmApiLinuxWrapper&quot; ); &gt; if ( NULL == entityClass ) &gt; { &gt; throw std::runtime_error( &quot;entityClass is NULL&quot; ); &gt; } &gt; &gt; csMethodEntryPoint = mono_class_get_method_from_name( entityClass, &gt; &quot;ApiCmdRequest&quot;, 2 ); &gt; if ( NULL == csMethodEntryPoint ) &gt; { &gt; throw std::runtime_error( &quot;entryPoint is NULL&quot; ); &gt; } &gt; } &gt; &gt; &gt; The function that allocates extra memory is mono_jit_init_version(). In a standalone &gt; program, it allocates 1M, and with this special program 20M! &gt; I said above that I lose 40M. So, 19M with mono_jit_init_version(), and extra 21M &gt; from a call to c# function. &gt; I took a look into the mono source code for mono_jit_init_version() function, but &gt; the function is so huge, that I got lost quite quickly. &gt; &gt; The question is how to debug this. Can I set some environment variable to help me &gt; track why extra memory is allocated? &gt; &gt; Cheers, &gt; Vladimir Jovic &gt; &gt; &gt; _______________________________________________ &gt; Mono-devel-list mailing list &gt; <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A> &gt; <A HREF="https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Furldefense.proofpoint.com%2Fv2%2Furl%3Fu%3Dhttps-&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cea86b8b4102a4006b02d08d4c2de5d65%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347707686498740&amp;sdata=w72x1rfEWVGqz57A5jXS2mBqfU4CS7Prna8rxuQtlFI%3D&amp;reserved=0">https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Furldefense.proofpoint.com%2Fv2%2Furl%3Fu%3Dhttps-&amp;data=02%7C01%7Cbeurba%40microsoft.com%7Cea86b8b4102a4006b02d08d4c2de5d65%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636347707686498740&amp;sdata=w72x1rfEWVGqz57A5jXS2mBqfU4CS7Prna8rxuQtlFI%3D&amp;reserved=0</A> &gt; 3A__na01.safelinks.protection.outlook.com_-3Furl-3Dhttp-253A-252F- &gt; 252Flists.dot.net-252Fmailman-252Flistinfo-252Fmono-2Ddevel-2Dlist-26data- &gt; 3D02-257C01-257Cbeurba-2540microsoft.com- &gt; 257Cf316d1bef9ff4526a28e08d4c2d9c199- &gt; 257C72f988bf86f141af91ab2d7cd011db47-257C1-257C0- &gt; 257C636347687894932396-26sdata- &gt; 3D7STXOC7bR3PWerb3i2SWA8ZjNKY5nuxhrhNa8YdCgj4-253D-26reserved- &gt; 3D0&amp;d=DwIFAg&amp;c=riR7jviByh3sGm7GIiSlHkFN0_aSATB6A8x0nHa2EM0&amp;r=8wfds &gt; MUxnRudpdLb_Cg4rnnnKI- &gt; gQZ4ykr3tjUrejXg&amp;m=UXnPdEnbJm2f8D7zbepyWHCkddBX3nmBbM20hcNRWVw &gt; &amp;s=HeLECPauo2viZhcAN-930TZQaRS3NLvG4xlxnV-p8sM&amp;e=

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-devel-list/attachments/20170704/a1385256/attachment-0001.html">http://lists.dot.net/pipermail/mono-devel-list/attachments/20170704/a1385256/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044453.html">[Mono-dev] increased memory usage when embedding mono under special	environment
</A></li>
	<LI>Next message (by thread): <A HREF="044455.html">[Mono-dev] SEGV during nursery scanning
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44454">[ date ]</a>
              <a href="thread.html#44454">[ thread ]</a>
              <a href="subject.html#44454">[ subject ]</a>
              <a href="author.html#44454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
