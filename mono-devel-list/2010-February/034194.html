<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Trying to find a bug in my code...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Trying%20to%20find%20a%20bug%20in%20my%20code...&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034200.html">
   <LINK REL="Next"  HREF="034667.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Trying to find a bug in my code...</H1>
    <B>pfj</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Trying%20to%20find%20a%20bug%20in%20my%20code...&In-Reply-To="
       TITLE="[Mono-dev] Trying to find a bug in my code...">pjohnson1 at uclan.ac.uk
       </A><BR>
    <I>Wed Feb 24 04:57:43 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034200.html">[Mono-dev] Announcing Mono 2.6.1 Solaris packages
</A></li>
        <LI>Next message: <A HREF="034667.html">[Mono-dev] SafeFileHandle &amp; FileStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34194">[ date ]</a>
              <a href="thread.html#34194">[ thread ]</a>
              <a href="subject.html#34194">[ subject ]</a>
              <a href="author.html#34194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,

I have a very simple application which is connecting happily to gmail using
SSL. The problem is that it dies when I come to grabbing a list of the
emails on the server.

My connection and retrieval code is this

My code looks like this (pop3 first)

// from pop3.cs

using System;
using System.Collections;
using System.Net.Sockets;
using System.Net.Security;

namespace email_to_paul_winform
{
        /// &lt;summary&gt;
        /// Description of pop3.
        /// &lt;/summary&gt;
        public class pop3
        {
                public pop3()
                {
                }
               
                public class Pop3Exception : System. ApplicationException
                {
    public Pop3Exception( string str) : base( str)
    {
    }
                }
       
                public class Pop3Message
                {
    public long number;
    public long bytes;
    public bool retrieved;
    public string message;
                }
               
                SslStream netstream;
               
                public void Connect(string server, string username, string
password)
                {
    string message;
    string response;
    TcpClient tcpClient = new TcpClient();
    tcpClient.Connect(server, 995);
    netstream = new SslStream(tcpClient.GetStream());
    netstream.AuthenticateAsClient(&quot;pop.gmail.com&quot;);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }

    message = &quot;USER &quot; + username + &quot;\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }

    message = &quot;PASS &quot; + password + &quot;\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }
                }
               
                public void Disconnect()
                {
    string message;
    string response;
    message = &quot;QUIT\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }
                }
               
                public ArrayList List()
                {
    string message;
    string response;

    ArrayList retval = new ArrayList();
    message = &quot;LIST\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
       throw new Pop3Exception(response);
    }

    while (true)
    {
        response = Response(netstream);
        if (response == &quot;.\r\n&quot;)
        {
           return retval;
        }
        else
        {
            Pop3Message msg = new Pop3Message();
            char[] seps = { ' ' };
            string[] values = response.Split(seps);
            msg.number = Int32.Parse(values[0]);
            msg.bytes = Int32.Parse(values[1]);
            msg.retrieved = false;
            retval.Add(msg);
            continue;
        }
    }
                }
               
                public Pop3Message Retrieve(Pop3Message rhs)
                {
    string message;
    string response;

    Pop3Message msg = new Pop3Message();
    msg.bytes = rhs.bytes;
    msg.number = rhs.number;

    message = &quot;RETR &quot; + rhs.number + &quot;\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }

    msg.retrieved = true;
    while (true)
    {
        response = Response(netstream);
        if (response == &quot;.\r\n&quot;)
        {
            break;
        }
        else
        {
            msg.message += response;
        }
    }

    return msg;
                }
               
                public void Delete(Pop3Message rhs)
                {
    string message;
    string response;

    message = &quot;DELE &quot; + rhs.number + &quot;\r\n&quot;;
    Write(message, netstream);
    response = Response(netstream);
    if (response.Substring(0, 3) != &quot;+OK&quot;)
    {
        throw new Pop3Exception(response);
    }
                }
               
                private void Write(string message, SslStream stream)
                {
    System.Text.ASCIIEncoding en = new System.Text.ASCIIEncoding() ;

    byte[] WriteBuffer = new byte[1024] ;
    WriteBuffer = en.GetBytes(message) ;
                       
    //TcpClient tcpClient = new TcpClient();
   
    //NetworkStream stream = tcpClient.GetStream() ;
    stream.Write(WriteBuffer, 0, WriteBuffer.Length);

    //Debug.WriteLine(&quot;WRITE:&quot; + message);
                }
               
                private string Response(SslStream stream)
                {
    System.Text.ASCIIEncoding enc = new System.Text.ASCIIEncoding();
    byte[] serverbuff = new Byte[1024];
    //TcpClient tcpClient = new TcpClient();
   
    //NetworkStream stream = tcpClient.GetStream();
    int count = 0;
    while (true)
    {
        byte[] buff = new Byte[2];
        int bytes = stream.Read(buff, 0, 1 );
        if (bytes == 1)
        {
            serverbuff[count] = buff[0];
            count++;

            if (buff[0] == '\n')
            {
                break;
            }
        }
        else
        {
            break;
        };
    };

    string retval = enc.GetString(serverbuff, 0, count );
    //Debug.WriteLine(&quot;READ:&quot; + retval);
    return retval;
                }
        }
}

The driving code looks like this

                private void connect()
                {
                        pop3 pop = new pop3();
                        try
                        {
                                pop.Connect(&quot;pop.gmail.com&quot;,
&quot;valid_username&quot;, &quot;valid_password&quot;);
                                ArrayList list = pop.List();
                                foreach (pop3.Pop3Message message in list)
                                {
                                        pop3.Pop3Message msg2 =
pop.Retrieve(message);
                                        emails.Items.Add(msg2.ToString());
                                }
                                pop.Disconnect();
                        }
                        catch (pop3.Pop3Exception e )
    {
                                MessageBox.Show(e.ToString(), &quot;Error with
connection&quot;,
MessageBoxButtons.OK);
    }
    catch (System.Exception e)
    {
        MessageBox.Show(e.ToString(), &quot;General error&quot;,
MessageBoxButtons.OK);
    } 

When I run this through the debugger, everything seems to be working, except
if I look at what is being retrieved in the List method. Here the messages
don't look right (it's giving me things like response = 1 4935). I don't
know if this needs decrypting (as the connection uses SSL) or that because
netstream is instantated in the Connect() method, as soon as the Connect()
is done, the instantation is disposed off, therefore what is being seen in
List is actually undefined behaviour.

Can anyone shed any light on this?

TTFN

Paul


-- 
View this message in context: <A HREF="http://n4.nabble.com/Trying-to-find-a-bug-in-my-code-tp1567215p1567215.html">http://n4.nabble.com/Trying-to-find-a-bug-in-my-code-tp1567215p1567215.html</A>
Sent from the Mono - Dev mailing list archive at Nabble.com.
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034200.html">[Mono-dev] Announcing Mono 2.6.1 Solaris packages
</A></li>
	<LI>Next message: <A HREF="034667.html">[Mono-dev] SafeFileHandle &amp; FileStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34194">[ date ]</a>
              <a href="thread.html#34194">[ thread ]</a>
              <a href="subject.html#34194">[ subject ]</a>
              <a href="author.html#34194">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
