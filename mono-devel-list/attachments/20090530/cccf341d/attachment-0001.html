<tt>
Hi,&lt;br&gt;&lt;br&gt;The&nbsp;last&nbsp;argument&nbsp;is&nbsp;marshalled&nbsp;as&nbsp;VariantBool:&lt;br&gt;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[MarshalAs&nbsp;(UnmanagedType.VariantBool)]&lt;br&gt;<br>
bool&nbsp;bVBCustMarsh);&lt;br&gt;&lt;br&gt;VariantBool&nbsp;is&nbsp;marshalled&nbsp;as:&nbsp;(2&nbsp;bytes,&nbsp;VARIANT_TRUE&nbsp;=&nbsp;0xFFFF,&nbsp;VARIANT_FALSE&nbsp;=&nbsp;0)&lt;br&gt;&lt;br&gt;so&nbsp;the&nbsp;the&nbsp;C&nbsp;function&nbsp;should&nbsp;receive&nbsp;0xffff&nbsp;in&nbsp;bVBCustMarsh,&nbsp;not&nbsp;1.&nbsp;No&nbsp;idea&nbsp;why&nbsp;this&nbsp;happens&lt;br&gt;on&nbsp;ppc.&lt;br&gt;<br>
&lt;br&gt;                                   &nbsp;Zoltan&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sat,&nbsp;May&nbsp;30,&nbsp;2009&nbsp;at&nbsp;3:36&nbsp;AM,&nbsp;Steven&nbsp;Munroe&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:munroesj@us.ibm.com&quot;&gt;munroesj@us.ibm.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;The&nbsp;test:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; unsafe&nbsp;public&nbsp;static&nbsp;int&nbsp;test_0_VariantBool_In_Native&nbsp;()&lt;br&gt;<br>
&nbsp; &nbsp; {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp;ret;&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp;=&nbsp;mono_test_marshal_bool_in&nbsp;(5,&nbsp;0,&nbsp;false,&nbsp;false,&nbsp;false,&lt;br&gt;<br>
false,&nbsp;false);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(ret&nbsp;!=&nbsp;0)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0x0100&nbsp;+&nbsp;ret;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp;=&nbsp;mono_test_marshal_bool_in&nbsp;(5,&nbsp;0xFFFF,&nbsp;false,&nbsp;false,&nbsp;false,&lt;br&gt;<br>
false,&nbsp;true);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(ret&nbsp;!=&nbsp;0)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0x0200&nbsp;+&nbsp;ret;&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; bool&nbsp;testVal&nbsp;=&nbsp;false;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; bool*&nbsp;ptestVal&nbsp;=&nbsp;&amp;amp;testVal;&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Marshal.WriteByte&nbsp;((IntPtr)ptestVal,&nbsp;0x22);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp;=&nbsp;mono_test_marshal_bool_in&nbsp;(5,&nbsp;0xFFFF,&nbsp;false,&nbsp;false,&nbsp;false,&lt;br&gt;<br>
false,&nbsp;testVal);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(ret&nbsp;!=&nbsp;0)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0x0300&nbsp;+&nbsp;ret;&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0;&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
is&nbsp;failing&nbsp;specifically:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; ret&nbsp;=&nbsp;mono_test_marshal_bool_in&nbsp;(5,&nbsp;0xFFFF,&nbsp;false,&nbsp;false,&nbsp;false,&lt;br&gt;<br>
false,&nbsp;true);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(ret&nbsp;!=&nbsp;0)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0x0200&nbsp;+&nbsp;ret;&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;PPC&nbsp;we&nbsp;pass&nbsp;0x00000005&nbsp;parm&nbsp;arg&nbsp;in&nbsp;R3,&nbsp;0x0000FFFF&nbsp;to&nbsp;parm&nbsp;&amp;quot;expected&amp;quot;&lt;br&gt;<br>
in&nbsp;R4&nbsp;and&nbsp;0x00000001&nbsp;parm&nbsp;bVBCustMarsh&nbsp;in&nbsp;R9&nbsp;to&lt;br&gt;<br>
mono_test_marshal_bool_in.&nbsp;The&nbsp;Implementation&nbsp;of&lt;br&gt;<br>
mono_test_marshal_bool_in&nbsp;is:&lt;br&gt;<br>
&lt;br&gt;<br>
LIBTEST_API&nbsp;int&nbsp;STDCALL&lt;br&gt;<br>
mono_test_marshal_bool_in&nbsp;(int&nbsp;arg,&nbsp;unsigned&nbsp;int&nbsp;expected,&nbsp;unsigned&nbsp;int&lt;br&gt;<br>
bDefaultMarsh,&nbsp;unsigned&nbsp;int&nbsp;bBoolCustMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char&nbsp;bI1CustMarsh,&nbsp;unsigned&nbsp;char&nbsp;bU1CustMarsh,&nbsp;unsigned&lt;br&gt;<br>
short&nbsp;bVBCustMarsh)&lt;br&gt;<br>
{&lt;br&gt;<br>
&nbsp; &nbsp; switch&nbsp;(arg)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; case&nbsp;1:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bDefaultMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; case&nbsp;2:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bBoolCustMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;2;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; case&nbsp;3:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bI1CustMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;3;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; case&nbsp;4:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bU1CustMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;4;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; case&nbsp;5:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bVBCustMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;5;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; default:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;999;&lt;br&gt;<br>
&nbsp; &nbsp; }&lt;br&gt;<br>
&nbsp; &nbsp; return&nbsp;0;&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;this&nbsp;case&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(bVBCustMarsh&nbsp;!=&nbsp;expected)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;5;&lt;br&gt;<br>
&lt;br&gt;<br>
will&nbsp;compare&nbsp;0x0000FFFF&nbsp;!=&nbsp;0x00000001&nbsp;and&nbsp;return&nbsp;5.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;seems&nbsp;to&nbsp;be&nbsp;a&nbsp;number&nbsp;of&nbsp;problems&nbsp;with&nbsp;this&nbsp;test&nbsp;and&nbsp;its&nbsp;not&nbsp;clean&lt;br&gt;<br>
why&nbsp;it&nbsp;(appears&nbsp;to)&nbsp;work&nbsp;for&nbsp;x86_64.&nbsp;In&nbsp;marshalbool.cs&nbsp;we&nbsp;see&lt;br&gt;<br>
mono_test_marshal_bool_in&nbsp;declared&nbsp;as:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; [DllImport&nbsp;(&amp;quot;libtest&amp;quot;)]&lt;br&gt;<br>
&nbsp; &nbsp; static&nbsp;extern&nbsp;int&nbsp;mono_test_marshal_bool_in&nbsp;(int&nbsp;arg,&nbsp;uint&nbsp;expected,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;bool&nbsp;bDefaultMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[MarshalAs&nbsp;(UnmanagedType.Bool)]&nbsp;bool&lt;br&gt;<br>
bBoolCustMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[MarshalAs&nbsp;(UnmanagedType.I1)]&nbsp;bool&lt;br&gt;<br>
bI1CustMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[MarshalAs&nbsp;(UnmanagedType.U1)]&nbsp;bool&lt;br&gt;<br>
bU1CustMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[MarshalAs&nbsp;(UnmanagedType.VariantBool)]&lt;br&gt;<br>
bool&nbsp;bVBCustMarsh);&lt;br&gt;<br>
&lt;br&gt;<br>
Which&nbsp;does&nbsp;not&nbsp;match&nbsp;the&nbsp;declaration&nbsp;on&nbsp;libtest.c:&lt;br&gt;<br>
&lt;br&gt;<br>
LIBTEST_API&nbsp;int&nbsp;STDCALL&lt;br&gt;<br>
mono_test_marshal_bool_in&nbsp;(int&nbsp;arg,&nbsp;unsigned&nbsp;int&nbsp;expected,&nbsp;unsigned&nbsp;int&lt;br&gt;<br>
bDefaultMarsh,&nbsp;unsigned&nbsp;int&nbsp;bBoolCustMarsh,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char&nbsp;bI1CustMarsh,&nbsp;unsigned&nbsp;char&nbsp;bU1CustMarsh,&nbsp;unsigned&lt;br&gt;<br>
short&nbsp;bVBCustMarsh)&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;don&amp;#39;t&nbsp;see&nbsp;how&nbsp;this&nbsp;test&nbsp;is&nbsp;supposed&nbsp;to&nbsp;work&nbsp;(0x0000FFFF&nbsp;!=&nbsp;0x00000001)&lt;br&gt;<br>
especially&nbsp;as&nbsp;we&nbsp;are&nbsp;comparing&nbsp;a&nbsp;unsigned&nbsp;int&nbsp;to&nbsp;a&nbsp;unsigned&nbsp;short?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
