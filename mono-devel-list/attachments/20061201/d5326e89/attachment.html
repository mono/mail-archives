<tt>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;This&nbsp;patch&nbsp;adds&nbsp;support&nbsp;for&nbsp;COM&nbsp;Callable&nbsp;Wrappers&nbsp;to&nbsp;mono&nbsp;(exposing<br>
managed&nbsp;objects&nbsp;as&nbsp;COM&nbsp;objects&nbsp;to&nbsp;unmanaged&nbsp;code).&nbsp;I&nbsp;started&nbsp;to&nbsp;clean<br>
up&nbsp;some&nbsp;other&nbsp;cominterop&nbsp;work,&nbsp;but&nbsp;it&nbsp;just&nbsp;made&nbsp;the&nbsp;patch&nbsp;harder&nbsp;to<br>
read.&nbsp;So,&nbsp;I&nbsp;only&nbsp;put&nbsp;new&nbsp;methods&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;marshal.c&nbsp;file<br>
with&nbsp;the&nbsp;long&nbsp;term&nbsp;goal&nbsp;of&nbsp;all&nbsp;cominterop&nbsp;related&nbsp;methods&nbsp;located&nbsp;there<br>
or&nbsp;in&nbsp;another&nbsp;file.&nbsp;I&nbsp;also&nbsp;implemented/modified&nbsp;alot&nbsp;of&nbsp;the&nbsp;marshalling<br>
code&nbsp;to&nbsp;support&nbsp;COM&nbsp;Interop&nbsp;in&nbsp;both&nbsp;directions.&nbsp;Anyway,&nbsp;there&nbsp;are&nbsp;2<br>
changes&nbsp;that&nbsp;affect&nbsp;the&nbsp;runtime&nbsp;in&nbsp;non-cominterop&nbsp;cases.&lt;br&gt;&lt;div&nbsp;id=&quot;mb_0&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;The&nbsp;main&nbsp;change&nbsp;that&nbsp;affects&nbsp;the&nbsp;runtime&nbsp;outside&nbsp;of&nbsp;a&nbsp;COM&nbsp;Interop&nbsp;scenario&nbsp;is&nbsp;in&nbsp;gc.c.<br>
Basically,&nbsp;any&nbsp;managed&nbsp;object&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;unmanaged&nbsp;code.&nbsp;At&nbsp;that<br>
point,&nbsp;an&nbsp;unmanaged&nbsp;representation&nbsp;of&nbsp;the&nbsp;managed&nbsp;object&nbsp;is&nbsp;created.<br>
This&nbsp;needs&nbsp;cleaned&nbsp;up&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;garbage&nbsp;collected.&nbsp;So,&nbsp;I<br>
register&nbsp;the&nbsp;object&nbsp;for&nbsp;finalization.&nbsp;In&nbsp;the&nbsp;finalizer&nbsp;code,&nbsp;I&nbsp;check&nbsp;to<br>
see&nbsp;if&nbsp;the&nbsp;object&nbsp;has&nbsp;a&nbsp;ccw.&nbsp;There&nbsp;is&nbsp;a&nbsp;quick&nbsp;return&nbsp;if&nbsp;no&nbsp;CCW's&nbsp;have<br>
been&nbsp;created,&nbsp;so&nbsp;while&nbsp;there&nbsp;is&nbsp;a&nbsp;function&nbsp;call&nbsp;the&nbsp;hash&nbsp;table&nbsp;lookup<br>
only&nbsp;occurs&nbsp;if&nbsp;the&nbsp;program&nbsp;actually&nbsp;uses&nbsp;CCWs.<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;I&nbsp;am&nbsp;pretty&nbsp;sure&nbsp;I&nbsp;need&nbsp;some&nbsp;more&nbsp;locking&nbsp;around&nbsp;this&nbsp;code&nbsp;for<br>
thread&nbsp;safety.&nbsp;I'll&nbsp;also&nbsp;take&nbsp;a&nbsp;look&nbsp;at&nbsp;that&nbsp;for&nbsp;a&nbsp;future&nbsp;patch.<br>
&lt;br&gt;&lt;br&gt;Please<br>
review&nbsp;and&nbsp;comment.&nbsp;There&nbsp;are&nbsp;tests&nbsp;added&nbsp;as&nbsp;well&nbsp;for&nbsp;this<br>
functionality&nbsp;with&nbsp;some&nbsp;more&nbsp;to&nbsp;come.&nbsp;As&nbsp;usual,&nbsp;this&nbsp;code&nbsp;is<br>
contributed&nbsp;under&nbsp;the&nbsp;MIT/X11&nbsp;license,&nbsp;and&nbsp;I&nbsp;signed&nbsp;off&nbsp;in&nbsp;the<br>
ChangeLogs&nbsp;within&nbsp;the&nbsp;runtime&nbsp;code.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;/div&gt;<br>

</tt>
