<tt>
Hi&nbsp;Rolf,&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Reviewing &lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;font-family:&nbsp;arial,&nbsp;sans-serif;&nbsp;font-size:&nbsp;13px;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;&lt;b&gt;0004-io-layer-Improve-waiting-on-processes-a-lot.patch:&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;arial,&nbsp;sans-serif&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;//&nbsp;Ensure&nbsp;we&amp;#39;re&nbsp;not&nbsp;in&nbsp;here&nbsp;in&nbsp;multiple&nbsp;threads&nbsp;at&nbsp;once,&nbsp;nor&nbsp;recursive.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;if&nbsp;(InterlockedIncrement&nbsp;(&amp;amp;mono_processes_cleaning_up)&nbsp;&amp;gt;&nbsp;1)&nbsp;{&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;InterlockedDecrement&nbsp;(&amp;amp;mono_processes_cleaning_up);&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;Use&nbsp;the&nbsp;standard&nbsp;idiom&nbsp;of&nbsp;CAS&nbsp;(&amp;amp;zzz,&nbsp;0,&nbsp;1)&nbsp;instead&nbsp;of&nbsp;doing&nbsp;2&nbsp;atomic&nbsp;ops.&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;if&nbsp;(mono_processes_soft_lock&nbsp;!=&nbsp;0)&nbsp;{&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;/*&nbsp;The&nbsp;sigchld&nbsp;handler&nbsp;is&nbsp;watching&nbsp;us.&nbsp;Spin&nbsp;a&nbsp;bit&nbsp;and&nbsp;try&nbsp;again&nbsp;*/&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;_wapi_handle_spin&nbsp;(1);&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;+&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&nbsp;else&nbsp;{&lt;/span&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;This&nbsp;code&nbsp;doesn&amp;#39;t&nbsp;make&nbsp;much&nbsp;sense&nbsp;to&nbsp;me.&nbsp;You&nbsp;spin&nbsp;with&nbsp;the mono_processes_mutex&nbsp;lock&nbsp;held&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;only&nbsp;to&nbsp;drop&nbsp;it&nbsp;later&nbsp;to reacquire straight&nbsp;away.&nbsp;You&nbsp;must&nbsp;use&nbsp;an&nbsp;exponential&nbsp;backoff&nbsp;since&nbsp;the&nbsp;other&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;thread&nbsp;might&nbsp;be&nbsp;blocked&nbsp;for&nbsp;a&nbsp;significant&nbsp;amount&nbsp;of&nbsp;time.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;Overall&nbsp;the&nbsp;patch&nbsp;is&nbsp;ok,&nbsp;thou&nbsp;I&nbsp;have&nbsp;two&nbsp;comments,&nbsp;first&nbsp;that&nbsp;the&nbsp;style&nbsp;of&nbsp;reclamation&nbsp;is&nbsp;kludgy,&nbsp;we&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;would&nbsp;be&nbsp;better&nbsp;with &lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;SMR;&nbsp;second&nbsp;that,&nbsp;if&nbsp;I&nbsp;understand&nbsp;correctly,&nbsp;we&nbsp;only&nbsp;free&nbsp;process&nbsp;data&nbsp;when&nbsp;its&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;managed&nbsp;object&nbsp;is &lt;/span&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;collected&nbsp;or&nbsp;another&nbsp;process&nbsp;is&nbsp;spawned,&nbsp;right?&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;On&nbsp;other&nbsp;notes,&nbsp;your&nbsp;code&nbsp;mixes&nbsp;C&nbsp;and&nbsp;C++&nbsp;styles&nbsp;comments,&nbsp;stick&nbsp;with&nbsp;C&nbsp;style,&nbsp;please.&nbsp;You&amp;#39;re&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;not&nbsp;following&nbsp;our&nbsp;code&nbsp;conventions&nbsp;in&nbsp;a&nbsp;few&nbsp;places&nbsp;too:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;div&gt;<br>
+static&nbsp;void&nbsp;mono_processes_cleanup&nbsp;(void)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Should&nbsp;be:&lt;/div&gt;&lt;div&gt;static&nbsp;void&lt;/div&gt;&lt;div&gt;&lt;meta&nbsp;charset=&quot;utf-8&quot;&gt;mono_processes_cleanup&nbsp;(void)&lt;/div&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&nbsp;&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;collapse;&nbsp;-webkit-border-horizontal-spacing:&nbsp;2px;&nbsp;-webkit-border-vertical-spacing:&nbsp;2px;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/font&gt;&lt;/div&gt;<br>

</tt>
