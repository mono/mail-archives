<tt>
&lt;html&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;<br>
&lt;div&gt;It&nbsp;doesn't&nbsp;make&nbsp;much&nbsp;sense&nbsp;to&nbsp;pre-compute&nbsp;the&nbsp;hashcode&nbsp;for&nbsp;a&nbsp;string&nbsp;whose&nbsp;length&nbsp;is&nbsp;not&nbsp;greater&nbsp;than&nbsp;the&nbsp;cacheline&nbsp;size.&nbsp; Anything&nbsp;that&nbsp;fits&nbsp;into&nbsp;the&nbsp;cacheline&nbsp;and&nbsp;is&nbsp;not&nbsp;memory&nbsp;bound&nbsp;is&nbsp;plenty&nbsp;fast&nbsp;enough.&nbsp; &lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;For&nbsp;the&nbsp;same&nbsp;reason,&nbsp;the&nbsp;size&nbsp;and&nbsp;hashcode&nbsp;of&nbsp;a&nbsp;string&nbsp;would&nbsp;need&nbsp;to&nbsp;be&nbsp;juxtaposed&nbsp;in&nbsp;memory&nbsp;to&nbsp;load&nbsp;both&nbsp;on&nbsp;first&nbsp;hit.&nbsp; Otherwise,&nbsp;the&nbsp;benefits&nbsp;are&nbsp;again&nbsp;wiped&nbsp;out&nbsp;due&nbsp;to&nbsp;the&nbsp;high&nbsp;cost&nbsp;of&nbsp;loading&nbsp;data&nbsp;from&nbsp;memory&nbsp;into&nbsp;the&nbsp;cache.&nbsp; If&nbsp;optimization&nbsp;at&nbsp;that&nbsp;level&nbsp;isn't&nbsp;interesting&nbsp;(b/c&nbsp;we&nbsp;talking&nbsp;nanoseconds&nbsp;in&nbsp;this&nbsp;realm),&nbsp;then&nbsp;the&nbsp;bound&nbsp;for&nbsp;N&nbsp;will&nbsp;go&nbsp;up&nbsp;quite&nbsp;quickly&nbsp;before&nbsp;a&nbsp;cached&nbsp;hashcode&nbsp;makes&nbsp;sense.&nbsp; And&nbsp;as&nbsp;Robert&nbsp;so&nbsp;insightfully&nbsp;pointed&nbsp;out,&nbsp;strings&nbsp;for&nbsp;which&nbsp;a&nbsp;pre-computed&nbsp;hashcode&nbsp;might&nbsp;make&nbsp;sense&nbsp;may&nbsp;never&nbsp;be&nbsp;used&nbsp;as&nbsp;keys.&nbsp; Hence,&nbsp;the&nbsp;complexity&nbsp;increase&nbsp;in&nbsp;th&nbsp;string&nbsp;code&nbsp;--&nbsp;and&nbsp;therefore&nbsp;quality&nbsp;control&nbsp;headache&nbsp;--&nbsp;introduced&nbsp;by&nbsp;it&nbsp;might&nbsp;not&nbsp;be&nbsp;worth&nbsp;the&nbsp;effort.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;Just&nbsp;some&nbsp;assembly&nbsp;hacker&nbsp;thoughts&nbsp;on&nbsp;the&nbsp;subject...&nbsp;:)&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&nbsp;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;border-spacing:&nbsp;0px&nbsp;0px;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;12px;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;text-align:&nbsp;auto;&nbsp;-khtml-text-decorations-in-effect:&nbsp;none;&nbsp;text-indent:&nbsp;0px;&nbsp;-apple-text-size-adjust:&nbsp;auto;&nbsp;text-transform:&nbsp;none;&nbsp;orphans:&nbsp;2;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;border-spacing:&nbsp;0px&nbsp;0px;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;12px;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;text-align:&nbsp;auto;&nbsp;-khtml-text-decorations-in-effect:&nbsp;none;&nbsp;text-indent:&nbsp;0px;&nbsp;-apple-text-size-adjust:&nbsp;auto;&nbsp;text-transform:&nbsp;none;&nbsp;orphans:&nbsp;2;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;border-spacing:&nbsp;0px&nbsp;0px;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-family:&nbsp;Helvetica;&nbsp;font-size:&nbsp;12px;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;text-align:&nbsp;auto;&nbsp;-khtml-text-decorations-in-effect:&nbsp;none;&nbsp;text-indent:&nbsp;0px;&nbsp;-apple-text-size-adjust:&nbsp;auto;&nbsp;text-transform:&nbsp;none;&nbsp;orphans:&nbsp;2;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;&quot;&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;-&nbsp;Steve&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;br&nbsp;class=&quot;khtml-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;--------------&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;Steve&nbsp;G.&nbsp;Bjorg&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;http://wiki.mindtouch.com&quot;&gt;http://wiki.mindtouch.com&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;http://wiki.opengarden.org&quot;&gt;http://wiki.opengarden.org&lt;/a&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&nbsp;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Dec&nbsp;1,&nbsp;2007,&nbsp;at&nbsp;10:02&nbsp;AM,&nbsp;Alan&nbsp;McGovern&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Also,&nbsp;worst&nbsp;case&nbsp;scenario&nbsp;for&nbsp;a&nbsp;zero&nbsp;length&nbsp;string&nbsp;would&nbsp;mean&nbsp;a&nbsp;22%&nbsp;increase,&nbsp;not&nbsp;a&nbsp;100%&nbsp;increase&nbsp;as&nbsp;was&nbsp;said&nbsp;before.&lt;br&gt;&lt;br&gt;Alan.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Dec&nbsp;1,&nbsp;2007&nbsp;6:01&nbsp;PM,&nbsp;Alan&nbsp;McGovern&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:alan.mcgovern@gmail.com&quot;&gt;&nbsp;alan.mcgovern@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Well,&nbsp;'N'&nbsp;could&nbsp;be&nbsp;computed&nbsp;by&nbsp;asking&nbsp;what&nbsp;percent&nbsp;bloat&nbsp;is&nbsp;'OK'&nbsp;or&nbsp;it&nbsp;could&nbsp;be&nbsp;computed&nbsp;by&nbsp;asking&nbsp;'What&nbsp;%&nbsp;speedup&nbsp;do&nbsp;we&nbsp;want&nbsp;to&nbsp;make&nbsp;this&nbsp;a&nbsp;worthwhile&nbsp;tradeoff'.&nbsp;&lt;br&gt;&lt;br&gt;Currently&nbsp;a&nbsp;string&nbsp;has&nbsp;these&nbsp;two&nbsp;fields,&nbsp;an&nbsp;int&nbsp;and&nbsp;a&nbsp;char.&nbsp;Add&nbsp;in&nbsp;the&nbsp;object&nbsp;overhead&nbsp;of&nbsp;(i&nbsp;think)&nbsp;12&nbsp;bytes&nbsp;per&nbsp;object,&nbsp;you're&nbsp;up&nbsp;to&nbsp;18&nbsp;bytes&nbsp;straight&nbsp;off&nbsp;for&nbsp;a&nbsp;zero&nbsp;length&nbsp;string.&nbsp;Lets&nbsp;assume&nbsp;that&nbsp;you're&nbsp;only&nbsp;going&nbsp;to&nbsp;precalculate&nbsp;the&nbsp;hashcode&nbsp;for&nbsp;strings&nbsp;greater&nbsp;than&nbsp;length&nbsp;4.&nbsp;&lt;br&gt;&lt;br&gt;So,&nbsp;take&nbsp;the&nbsp;case&nbsp;of&nbsp;a&nbsp;string&nbsp;of&nbsp;length&nbsp;5.&nbsp;This&nbsp;puts&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;string&nbsp;at&nbsp;18&nbsp;+&nbsp;5*2&nbsp;=&nbsp;28&nbsp;bytes.&nbsp;Adding&nbsp;4&nbsp;bytes&nbsp;to&nbsp;this&nbsp;is&nbsp;15%&nbsp;extra&nbsp;memory&nbsp;usage.&nbsp;As&nbsp;string&nbsp;length&nbsp;goes&nbsp;up,&nbsp;this&nbsp;%&nbsp;goes&nbsp;down.&lt;br&gt;&lt;br&gt;I'm&nbsp;unsure&nbsp;what&nbsp;%&nbsp;speedup&nbsp;precalculating&nbsp;the&nbsp;hashcode&nbsp;would&nbsp;result&nbsp;in,&nbsp;but&nbsp;i'm&nbsp;sure&nbsp;someone&nbsp;could&nbsp;run&nbsp;a&nbsp;few&nbsp;benchmarks&nbsp;if&nbsp;they&nbsp;have&nbsp;the&nbsp;time&nbsp;free.&nbsp;You&nbsp;could&nbsp;say&nbsp;that&nbsp;you&nbsp;want&nbsp;at&nbsp;least&nbsp;a&nbsp;5x&nbsp;or&nbsp;maybe&nbsp;10x&nbsp;improvement&nbsp;before&nbsp;it&nbsp;becomes&nbsp;worthwhile,&nbsp;this&nbsp;would&nbsp;then&nbsp;put&nbsp;a&nbsp;lower&nbsp;bound&nbsp;on&nbsp;the&nbsp;string&nbsp;length&nbsp;to&nbsp;make&nbsp;it&nbsp;worthwhile.&nbsp;&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;Alan.&lt;/font&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Dec&nbsp;1,&nbsp;2007&nbsp;5:29&nbsp;PM,&nbsp;Robert&nbsp;Jordan&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:robertj@gmx.net&quot;&nbsp;target=&quot;_blank&quot;&gt;robertj@gmx.net&lt;/a&gt;&nbsp;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&nbsp;Hi&nbsp;Alan,&lt;br&gt;&lt;div&gt;&lt;br&gt;Alan&nbsp;McGovern&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;Also,&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;string&nbsp;source&nbsp;a&nbsp;bit&nbsp;more&nbsp;closely,&nbsp;it&nbsp;has&nbsp;a&lt;br&gt;&amp;gt;&nbsp;GetCaseInsensitiveHashcode&nbsp;method&nbsp;too,&nbsp;so&nbsp;i'd&nbsp;assume&nbsp;that&nbsp;would&nbsp;need&nbsp;to&nbsp;be&lt;br&gt;&nbsp;&amp;gt;&nbsp;cached&nbsp;too&nbsp;which&nbsp;would&nbsp;mean&nbsp;8&nbsp;bytes&nbsp;would&nbsp;be&nbsp;needed.&nbsp;This&nbsp;wouldn't&nbsp;scale&lt;br&gt;&amp;gt;&nbsp;well.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;Fair&nbsp;enough.&nbsp;Twas&nbsp;just&nbsp;an&nbsp;idea.&lt;br&gt;&lt;br&gt;&lt;/div&gt;nah,&nbsp;don't&nbsp;give&nbsp;up&nbsp;too&nbsp;early!&nbsp;:)&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;longer&nbsp;than&nbsp;&quot;n&quot;,&nbsp;&lt;br&gt;you&nbsp;could&nbsp;allocate&nbsp;4&nbsp;or&nbsp;even&nbsp;8&nbsp;additional&nbsp;bytes&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&lt;br&gt;array&nbsp;for&nbsp;lazily&nbsp;computed&nbsp;hash&nbsp;codes.&lt;br&gt;&lt;br&gt;Open&nbsp;questions:&lt;br&gt;&lt;br&gt;-&nbsp;What's&nbsp;the&nbsp;optimal&nbsp;&quot;n&quot;&nbsp;for&nbsp;all&nbsp;common&nbsp;application&nbsp;classes&lt;br&gt;&nbsp; &nbsp;mono&nbsp;is&nbsp;used&nbsp;for?&nbsp;:)&nbsp;It&nbsp;looks&nbsp;like&nbsp;it&nbsp;should&nbsp;be&nbsp;dynamically&nbsp;&lt;br&gt;&nbsp; &nbsp;computed&nbsp;&amp;amp;&nbsp;adjusted&nbsp;based&nbsp;on&nbsp;profiling&nbsp;data&nbsp;collected&nbsp;at&lt;br&gt;&nbsp; &nbsp;runtime.&lt;br&gt;&lt;br&gt;-&nbsp;What's&nbsp;the&nbsp;real&nbsp;gain&nbsp;of&nbsp;this&nbsp;optimization?&nbsp;If&nbsp;&quot;n&quot;&nbsp;tends&nbsp;to&lt;br&gt;&nbsp; &nbsp;be&nbsp;really&nbsp;large&nbsp;(say&nbsp;1-4KB),&nbsp;what's&nbsp;the&nbsp;probability&nbsp;of&nbsp;&lt;br&gt;&nbsp; &nbsp;such&nbsp;large&nbsp;strings&nbsp;being&nbsp;used&nbsp;as&nbsp;a&nbsp;hash&nbsp;key?&lt;br&gt;&nbsp; &nbsp;This&nbsp;question&nbsp;can&nbsp;be&nbsp;reduced&nbsp;to&nbsp;&quot;how&nbsp;frequently&nbsp;is&lt;br&gt;&nbsp; &nbsp;s.GetHashCode&nbsp;called,&nbsp;where&nbsp;s.Length&nbsp;&amp;gt;&nbsp;n&quot;.&lt;br&gt;&lt;br&gt;&nbsp; &nbsp;In&nbsp;mono's&nbsp;class&nbsp;libs&nbsp;sources&nbsp;there&nbsp;is&nbsp;only&nbsp;one&nbsp;place&nbsp;(I&nbsp;know&nbsp;&lt;br&gt;&nbsp; &nbsp;of)&nbsp;where&nbsp;large&nbsp;strings&nbsp;are&nbsp;potentially&nbsp;hashed:&nbsp;Sys.Web's&lt;br&gt;&nbsp; &nbsp;cache&nbsp;management.&lt;br&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;Robert&lt;br&gt;&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&nbsp;&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&nbsp;&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&nbsp;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;_______________________________________________&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;margin-top:&nbsp;0px;&nbsp;margin-right:&nbsp;0px;&nbsp;margin-bottom:&nbsp;0px;&nbsp;margin-left:&nbsp;0px;&nbsp;&quot;&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;/div&gt;&nbsp;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
