Index: System.Reflection/Assembly.cs
===================================================================
--- System.Reflection/Assembly.cs	(revision 37997)
+++ System.Reflection/Assembly.cs	(working copy)
@@ -708,10 +708,11 @@
 		internal void Resolve () 
 		{
 			lock (this) {
+				LoadAssemblyPermissions ();
 				_granted = SecurityManager.ResolvePolicy (Evidence, _minimum, _optional,
 					_refuse, out _denied);
 			}
-#if false
+#if true
 			Console.WriteLine ("*** ASSEMBLY RESOLVE INPUT ***");
 			if (_minimum != null)
 				Console.WriteLine ("Minimum: {0}", _minimum);
@@ -745,5 +746,39 @@
 				return _denied;
 			}
 		}
+
+		[MethodImplAttribute (MethodImplOptions.InternalCall)]
+		extern internal static bool LoadPermissions (Assembly a, 
+			ref IntPtr minimum, ref int minLength,
+			ref IntPtr optional, ref int optLength,
+			ref IntPtr refused, ref int refLength);
+
+		// Support for SecurityAction.RequestMinimum, RequestOptional and RequestRefuse
+		private void LoadAssemblyPermissions ()
+		{
+			IntPtr minimum = IntPtr.Zero, optional = IntPtr.Zero, refused = IntPtr.Zero;
+			int minLength = 0, optLength = 0, refLength = 0;
+			if (LoadPermissions (this, ref minimum, ref minLength, ref optional,
+				ref optLength, ref refused, ref refLength)) {
+
+				// Note: no need to cache these permission sets as they will only be created once
+				// at assembly resolution time.
+				if (minLength > 0) {
+					byte[] data = new byte [minLength];
+					Marshal.Copy (minimum, data, 0, minLength);
+					_minimum = SecurityManager.Decode (data);
+				}
+				if (optLength > 0) {
+					byte[] data = new byte [optLength];
+					Marshal.Copy (optional, data, 0, optLength);
+					_optional = SecurityManager.Decode (data);
+				}
+				if (refLength > 0) {
+					byte[] data = new byte [refLength];
+					Marshal.Copy (refused, data, 0, refLength);
+					_refuse = SecurityManager.Decode (data);
+				}
+			}
+		}
 	}
 }
Index: System.Reflection/ChangeLog
===================================================================
--- System.Reflection/ChangeLog	(revision 37997)
+++ System.Reflection/ChangeLog	(working copy)
@@ -1,3 +1,9 @@
+2004-12-20  Sebastien Pouliot  <sebastien@ximian.com> 
+
+	* Assembly.cs: Added private LoadAssemblyPermissions to get the 
+	declarative security permission sets (minimum, optional and refused)
+	for the assembly.
+
 2004-12-20  Sebastien Pouliot  <sebastien@ximian.com>
 
 	* Assembly.cs: Removed old Demand support (moved in System.Security).
