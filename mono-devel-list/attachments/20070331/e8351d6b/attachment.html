<tt>
Ok,&nbsp;i&nbsp;did&nbsp;a&nbsp;quick&nbsp;bit&nbsp;of&nbsp;testing&nbsp;on&nbsp;my&nbsp;code.&lt;br&gt;&lt;br&gt;Firstly,&nbsp;the&nbsp;54&nbsp;instances&nbsp;of&nbsp;SocketAsyncResult&nbsp;do&nbsp;make&nbsp;sense.&nbsp;Typically&nbsp;there&nbsp;will&nbsp;*always*&nbsp;be&nbsp;a&nbsp;pending&nbsp;BeginReceive&nbsp;on&nbsp;every&nbsp;socket&nbsp;i&nbsp;have&nbsp;opened.&nbsp;Therefore&nbsp;54&nbsp;instances&nbsp;of&nbsp;SocketAsyncResult&nbsp;would&nbsp;correspond&nbsp;to&nbsp;54&nbsp;open&nbsp;connections,&nbsp;which&nbsp;is&nbsp;pretty&nbsp;standard&nbsp;stuff.<br>
&lt;br&gt;&lt;br&gt;Every&nbsp;call&nbsp;to&nbsp;socket.BeginXXX&nbsp;or&nbsp;socket.EndXXX&nbsp;goes&nbsp;through&nbsp;a&nbsp;TCPConnection&nbsp;class,&nbsp;so&nbsp;i&nbsp;added&nbsp;a&nbsp;count&nbsp;there&nbsp;so&nbsp;i&nbsp;could&nbsp;see&nbsp;how&nbsp;many&nbsp;calls&nbsp;to&nbsp;each&nbsp;BeginXXX&nbsp;and&nbsp;EndXXX&nbsp;method&nbsp;i&nbsp;actually&nbsp;make.&nbsp;The&nbsp;results&nbsp;were&nbsp;pretty&nbsp;much&nbsp;as&nbsp;expected.&nbsp;There&nbsp;was&nbsp;always&nbsp;a&nbsp;difference&nbsp;between&nbsp;BeginReceive&nbsp;and&nbsp;EndReceive&nbsp;pretty&nbsp;much&nbsp;equal&nbsp;to&nbsp;the&nbsp;number&nbsp;of&nbsp;sockets&nbsp;i&nbsp;have&nbsp;open.&nbsp;The&nbsp;difference&nbsp;between&nbsp;BeginSend&nbsp;and&nbsp;EndSend&nbsp;was&nbsp;always&nbsp;close&nbsp;enough&nbsp;to&nbsp;zero,&nbsp;which&nbsp;would&nbsp;also&nbsp;make&nbsp;sense&nbsp;as&nbsp;most&nbsp;messages&nbsp;i&amp;#39;m&nbsp;sending&nbsp;would&nbsp;only&nbsp;be&nbsp;a&nbsp;few&nbsp;bytes&nbsp;in&nbsp;size.&nbsp;The&nbsp;difference&nbsp;between&nbsp;the&nbsp;BeginConnects&nbsp;and&nbsp;EndConnects&nbsp;is&nbsp;always&nbsp;5.&nbsp;This&nbsp;is&nbsp;right&nbsp;as&nbsp;i&amp;#39;ve&nbsp;set&nbsp;it&nbsp;so&nbsp;i&nbsp;only&nbsp;connect&nbsp;to&nbsp;at&nbsp;most&nbsp;5&nbsp;people&nbsp;at&nbsp;any&nbsp;one&nbsp;instant.<br>
&lt;br&gt;&lt;br&gt;So&nbsp;i&nbsp;can&nbsp;rule&nbsp;out&nbsp;a&nbsp;bug&nbsp;in&nbsp;my&nbsp;code&nbsp;that&amp;#39;s&nbsp;causing&nbsp;millions&nbsp;of&nbsp;BeginXXX&amp;#39;s&nbsp;without&nbsp;corresponding&nbsp;EndXXX&amp;#39;s.&nbsp;There&amp;#39;d&nbsp;typically&nbsp;be&nbsp;between&nbsp;80&nbsp;and&nbsp;120&nbsp;Begin/EndReceive&nbsp;calls&nbsp;a&nbsp;second,&nbsp;which&nbsp;isn&amp;#39;t&nbsp;that&nbsp;much&nbsp;really.&nbsp;A&nbsp;similar&nbsp;amount&nbsp;for&nbsp;Begin/EndSend.<br>
&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;3/31/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Alan&nbsp;McGovern&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:alan.mcgovern@gmail.com&quot;&gt;alan.mcgovern@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi,&lt;br&gt;&lt;br&gt;That&nbsp;leaves&nbsp;me&nbsp;with&nbsp;the&nbsp;question&nbsp;of&nbsp;how&nbsp;the&nbsp;hell&nbsp;a&nbsp;SocketAsyncResult&nbsp;is&nbsp;10&nbsp;megs&nbsp;in&nbsp;size!&nbsp;The&nbsp;size&nbsp;of&nbsp;the&nbsp;largest&nbsp;single&nbsp;object&nbsp;in&nbsp;my&nbsp;entire&nbsp;code&nbsp;is&nbsp;a&nbsp;16kB&nbsp;byte[]&nbsp;buffer.&nbsp;If&nbsp;each&nbsp;SocketAsyncResult&nbsp;is&nbsp;10&nbsp;megabytes&nbsp;in&nbsp;size,&nbsp;i&nbsp;have&nbsp;to&nbsp;question&nbsp;the&nbsp;internal&nbsp;workings&nbsp;of&nbsp;mono,&nbsp;as&nbsp;i&nbsp;know&nbsp;from&nbsp;profiling&nbsp;my&nbsp;own&nbsp;code&nbsp;does&nbsp;*not*&nbsp;create&nbsp;objects&nbsp;anywhere&nbsp;near&nbsp;that&nbsp;size.<br>
&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;going&nbsp;to&nbsp;do&nbsp;a&nbsp;bit&nbsp;of&nbsp;profiling&nbsp;to&nbsp;count&nbsp;how&nbsp;many&nbsp;socket&nbsp;BeginXXX&nbsp;calls&nbsp;are&nbsp;made&nbsp;from&nbsp;my&nbsp;own&nbsp;code&nbsp;as&nbsp;compared&nbsp;to&nbsp;the&nbsp;EndXXX&nbsp;calls&nbsp;to&nbsp;see&nbsp;how&nbsp;they&nbsp;match&nbsp;up.&lt;br&gt;&lt;br&gt;Is&nbsp;there&nbsp;any&nbsp;way&nbsp;of&nbsp;finding&nbsp;out&nbsp;what&nbsp;exactly&nbsp;is&nbsp;inside&nbsp;those&nbsp;SocketAsyncResults&nbsp;that&nbsp;is&nbsp;10&nbsp;megs&nbsp;in&nbsp;size?&nbsp;I&nbsp;can&nbsp;verify&nbsp;that&nbsp;the&nbsp;exact&nbsp;same&nbsp;code&nbsp;running&nbsp;under&nbsp;Mono&nbsp;<br>
1.2&nbsp;and&nbsp;earlier&nbsp;does&nbsp;*not*&nbsp;exhibit&nbsp;the&nbsp;same&nbsp;behavior,&nbsp;everything&nbsp;works&nbsp;fine.&nbsp;I&nbsp;only&nbsp;came&nbsp;across&nbsp;this&nbsp;bug&nbsp;after&nbsp;updating&nbsp;my&nbsp;mono&nbsp;installation&nbsp;to&nbsp;1.2.3.&nbsp;This&nbsp;is&nbsp;why&nbsp;i&nbsp;think&nbsp;it&amp;#39;s&nbsp;a&nbsp;mono&nbsp;bug,&nbsp;however&nbsp;i&nbsp;can&amp;#39;t&nbsp;reproduce&nbsp;the&nbsp;problem&nbsp;in&nbsp;the&nbsp;form&nbsp;of&nbsp;an&nbsp;NUnit&nbsp;test.<br>
&lt;br&gt;&lt;br&gt;Thanks&nbsp;again,&lt;br&gt;&lt;span&nbsp;class=&quot;sg&quot;&gt;Alan.&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;e&quot;&nbsp;id=&quot;q_111a5590f0ccd152_2&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;3/30/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Joe&nbsp;Shaw&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:joe@ximian.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;onclick=&quot;return&nbsp;top.js.OpenExtLink(window,event,this)&quot;&gt;<br>
joe@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi&nbsp;again,&lt;br&gt;&lt;br&gt;On&nbsp;3/30/07,&nbsp;Joe&nbsp;Shaw&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:joe@ximian.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;onclick=&quot;return&nbsp;top.js.OpenExtLink(window,event,this)&quot;&gt;joe@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;That&nbsp;huge&nbsp;object&nbsp;array,&nbsp;in&nbsp;turn,&nbsp;is&nbsp;referenced&nbsp;by<br>
&lt;br&gt;&amp;gt;&nbsp;System.Collections.Queue&nbsp;-&amp;gt;&nbsp;System.Net.Socket.Socket<br>
,&nbsp;specifically&nbsp;the&lt;br&gt;&amp;gt;&nbsp;readQ&nbsp;member.&amp;nbsp;&amp;nbsp;So&nbsp;basically&nbsp;it&nbsp;means&nbsp;that&nbsp;the&nbsp;readQ&nbsp;member&nbsp;in&lt;br&gt;&amp;gt;&nbsp;System.Net.Socket.Socket&nbsp;is&nbsp;a&nbsp;huge&nbsp;Queue,&nbsp;which&nbsp;internally&nbsp;has&nbsp;an&lt;br&gt;&amp;gt;&nbsp;object&nbsp;array,&nbsp;which&nbsp;apparently&nbsp;has&nbsp;millions&nbsp;of&nbsp;SocketAsyncResult<br>
&lt;br&gt;&amp;gt;&nbsp;objects&nbsp;inside.&amp;nbsp;&amp;nbsp;So&nbsp;how&nbsp;those&nbsp;are&nbsp;being&nbsp;allocated?&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;These&nbsp;objects&nbsp;are&nbsp;created&nbsp;a&nbsp;lot[...]&lt;br&gt;&lt;br&gt;I&nbsp;got&nbsp;a&nbsp;little&nbsp;ahead&nbsp;of&nbsp;myself&nbsp;here:&nbsp;I&amp;#39;m&nbsp;obviously&nbsp;looking&nbsp;at&nbsp;the&nbsp;code&lt;br&gt;for&nbsp;System.Net.Sockets.Socket<br>
<br>
&nbsp;here.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;much&nbsp;about&nbsp;the&nbsp;Socket&nbsp;class&nbsp;and&nbsp;how&nbsp;the&nbsp;async&nbsp;IO&lt;br&gt;&amp;gt;&nbsp;works,&nbsp;but&nbsp;it&nbsp;boils&nbsp;down&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;BeginReceive()&nbsp;is&nbsp;being&lt;br&gt;&amp;gt;&nbsp;called&nbsp;probably&nbsp;millions&nbsp;of&nbsp;times,&nbsp;but&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;look&nbsp;like&nbsp;Complete()<br>
&lt;br&gt;&amp;gt;&nbsp;is&nbsp;being&nbsp;called&nbsp;enough&nbsp;(or&nbsp;possibly&nbsp;at&nbsp;all)&nbsp;to&nbsp;balance&nbsp;the&nbsp;load.&lt;br&gt;&lt;br&gt;I&nbsp;actually&nbsp;noticed&nbsp;something&nbsp;else:&lt;br&gt;&lt;br&gt;The&nbsp;object&nbsp;array&nbsp;in&nbsp;question&nbsp;has&nbsp;an&nbsp;average&nbsp;size&nbsp;of&nbsp;10.6&nbsp;megs,&nbsp;but&nbsp;it&lt;br&gt;only&nbsp;holds&nbsp;56&nbsp;references&nbsp;to&nbsp;SocketAsyncResult&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;this<br>
&lt;br&gt;snapshot.&amp;nbsp;&amp;nbsp;So&nbsp;this&nbsp;seems&nbsp;to&nbsp;indicate&nbsp;to&nbsp;me&nbsp;that&nbsp;the&nbsp;enqueues&nbsp;and&lt;br&gt;dequeues&nbsp;do&nbsp;ultimately&nbsp;match&nbsp;up,&nbsp;but&nbsp;that&nbsp;the&nbsp;allocation&nbsp;pattern&nbsp;is&lt;br&gt;bad&nbsp;and&nbsp;probably&nbsp;not&nbsp;interspersed.&amp;nbsp;&amp;nbsp;That&nbsp;is,&lt;br&gt;&lt;br&gt;enqueue,&nbsp;enqueue,&nbsp;dequeue,&nbsp;dequeue,&nbsp;enqueue,&nbsp;enqueue,&nbsp;etc.<br>
&lt;br&gt;&lt;br&gt;would&nbsp;mean&nbsp;that&nbsp;an&nbsp;array&nbsp;could&nbsp;be&nbsp;as&nbsp;small&nbsp;as&nbsp;2&nbsp;items&nbsp;and&nbsp;still&nbsp;work&lt;br&gt;for&nbsp;N&nbsp;items,&nbsp;assuming&nbsp;a&nbsp;1:1&nbsp;match..&amp;nbsp;&amp;nbsp;But&nbsp;if&nbsp;the&nbsp;pattern&nbsp;is&nbsp;instead,&lt;br&gt;&lt;br&gt;enqueue,&nbsp;enqueue,&nbsp;enqueue,&nbsp;enqueue,&nbsp;dequeue,&nbsp;dequeue,&nbsp;etc.&lt;br&gt;&lt;br&gt;<br>
<br>
then&nbsp;it&nbsp;would&nbsp;have&nbsp;to&nbsp;be&nbsp;at&nbsp;least&nbsp;N.&amp;nbsp;&amp;nbsp;Now&nbsp;pretend&nbsp;N&nbsp;is&nbsp;a&nbsp;million.&nbsp;:)&lt;br&gt;&lt;br&gt;Joe&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
