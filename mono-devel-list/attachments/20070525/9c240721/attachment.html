<tt>
Hi&nbsp;Robert,&lt;br&gt;&lt;br&gt;I&nbsp;was&nbsp;revisiting&nbsp;the&nbsp;code&nbsp;and&nbsp;there&nbsp;must&nbsp;be&nbsp;2&nbsp;checks,&nbsp;but&nbsp;one&nbsp;is&nbsp;for&nbsp;sealed&nbsp;class&nbsp;and&nbsp;one&nbsp;for&nbsp;sealed&nbsp;method,&nbsp;but&nbsp;obviously&nbsp;the&nbsp;patch&nbsp;is&nbsp;wrong,&nbsp;thanks&nbsp;for&nbsp;spoting!&lt;br&gt;About&nbsp;the&nbsp;string_ctor&nbsp;check&nbsp;should&nbsp;be&nbsp;removed&nbsp;as&nbsp;well.<br>
&lt;br&gt;&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;5/25/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Robert&nbsp;Jordan&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:robertj@gmx.net&quot;&gt;robertj@gmx.net&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hey,&lt;br&gt;&lt;br&gt;Rodrigo&nbsp;Kumpera&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;The&nbsp;following&nbsp;patch&nbsp;perform&nbsp;simple&nbsp;devirtualization&nbsp;based&nbsp;on&nbsp;the&nbsp;sealed&lt;br&gt;&amp;gt;&nbsp;flag&lt;br&gt;&amp;gt;&nbsp;of&nbsp;methods&nbsp;and&nbsp;types.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;The&nbsp;patch&nbsp;makes&nbsp;pystone&nbsp;4%&nbsp;faster&nbsp;with&nbsp;IronPython&nbsp;<br>
2.0&nbsp;and&nbsp;1%&nbsp;faster&nbsp;with&lt;br&gt;&amp;gt;&nbsp;IronPython&nbsp;1.0.&nbsp;It&nbsp;should&nbsp;improve&nbsp;other&nbsp;benchmarks&nbsp;as&nbsp;well,&nbsp;since&nbsp;it&nbsp;main&lt;br&gt;&amp;gt;&nbsp;contribution&nbsp;is&nbsp;statically&nbsp;dispatching&nbsp;delegate.Invoke.&nbsp;To&nbsp;provide&nbsp;more&lt;br&gt;&amp;gt;&nbsp;broad&nbsp;results&nbsp;a&nbsp;sse&nbsp;pass&nbsp;that&nbsp;perform&nbsp;type&nbsp;propagation&nbsp;is&nbsp;needed.<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;The&nbsp;only&nbsp;thing&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;about&nbsp;this&nbsp;patch&nbsp;is&nbsp;if&nbsp;it&nbsp;should&nbsp;handle&lt;br&gt;&amp;gt;&nbsp;remoting&lt;br&gt;&amp;gt;&nbsp;wrappers&nbsp;is&nbsp;some&nbsp;sort&nbsp;of&nbsp;way.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;---&nbsp;inssel.brg&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(revision&nbsp;77933)&lt;br&gt;&amp;gt;&nbsp;+++&nbsp;inssel.brg&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(working&nbsp;copy)<br>
&lt;br&gt;&amp;gt;&nbsp;@@&nbsp;-1690,6&nbsp;+1690,17&nbsp;@@&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;method&nbsp;=&nbsp;((MonoCallInst*)tree)-&amp;gt;method&nbsp;=&nbsp;mono_marshal_get_remoting_invoke_with_check&nbsp;(method);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MONO_EMIT_NEW_UNALU&nbsp;(cfg,&nbsp;OP_CHECK_THIS,&nbsp;-1,&nbsp;this_reg);<br>
&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;tree-&amp;gt;dreg&nbsp;=&nbsp;state-&amp;gt;reg1;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;tree-&amp;gt;opcode&nbsp;=&nbsp;novirtop;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_bblock_add_inst&nbsp;(cfg-&amp;gt;cbb,&nbsp;tree);&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}<br>
&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;((method-&amp;gt;flags&nbsp;&amp;amp;&nbsp;METHOD_ATTRIBUTE_VIRTUAL)&nbsp;&amp;amp;&amp;amp;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;((method-&amp;gt;klass-&amp;gt;flags&nbsp;&amp;amp;&nbsp;TYPE_ATTRIBUTE_SEALED)&nbsp;||&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;(method-&amp;gt;klass-&amp;gt;flags&nbsp;&amp;amp;&nbsp;TYPE_ATTRIBUTE_SEALED)))&nbsp;{<br>
&lt;br&gt;&lt;br&gt;One&nbsp;of&nbsp;the&nbsp;TYPE_ATTRIBUTE_SEALED&nbsp;checks&nbsp;is&nbsp;redundant.&lt;br&gt;You&nbsp;probably&nbsp;want&nbsp;method-&amp;gt;flags&nbsp;&amp;amp;&nbsp;METHOD_ATTRIBUTE_FINAL.&lt;br&gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(!method-&amp;gt;string_ctor)&lt;br&gt;&lt;br&gt;The&nbsp;string&nbsp;ctor&nbsp;is&nbsp;probably&nbsp;not&nbsp;virtual,&nbsp;so&nbsp;you&nbsp;should&nbsp;leave&nbsp;the&nbsp;check<br>
&lt;br&gt;where&nbsp;it&nbsp;was.&lt;br&gt;&lt;br&gt;I&amp;#39;d&nbsp;rather&nbsp;remove&nbsp;the&nbsp;2nd&nbsp;branch&nbsp;at&nbsp;all&nbsp;and&nbsp;put&nbsp;the&lt;br&gt;method-&amp;gt;klass-&amp;gt;flags&nbsp;&amp;amp;&nbsp;TYPE_ATTRIBUTE_SEALED&nbsp;check&nbsp;in&nbsp;the&nbsp;existing&nbsp;one.&lt;br&gt;&lt;br&gt;I&nbsp;didn&amp;#39;t&nbsp;test&nbsp;it,&nbsp;though.&lt;br&gt;&lt;br&gt;&lt;br&gt;Robert&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;<br>
http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
