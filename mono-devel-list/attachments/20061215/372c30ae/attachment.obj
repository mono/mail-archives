Index: metadata/ChangeLog
===================================================================
--- metadata/ChangeLog	(revision 69562)
+++ metadata/ChangeLog	(working copy)
@@ -1,3 +1,9 @@
+2006-12-16  Jonathan Chambers  <joncham@gmail.com>
+
+	* marshal.c (ves_icall_System_Runtime_InteropServices_Marshal_AllocHGlobal,
+	ves_icall_System_Runtime_InteropServices_Marshal_FreeHGlobal): Use GlobalAlloc
+	and GlobalFree on Windows. Remove FIXME.
+	
 2006-12-15  Jonathan Chambers  <joncham@gmail.com>
 
 	* marshal.c (mono_string_from_bstr): Revert previous Windows change
Index: metadata/marshal.c
===================================================================
--- metadata/marshal.c	(revision 69562)
+++ metadata/marshal.c	(working copy)
@@ -9786,8 +9786,6 @@
 	mono_struct_delete_old (klass, (char *)src);
 }
 
-
-/* FIXME: on win32 we should probably use GlobalAlloc(). */
 void*
 ves_icall_System_Runtime_InteropServices_Marshal_AllocHGlobal (int size)
 {
@@ -9799,7 +9797,11 @@
 		/* This returns a valid pointer for size 0 on MS.NET */
 		size = 4;
 
+#ifdef PLATFORM_WIN32
+	res = GlobalAlloc (GMEM_FIXED, (gulong)size);
+#else
 	res = g_try_malloc ((gulong)size);
+#endif
 	if (!res)
 		mono_gc_out_of_memory ((gulong)size);
 
@@ -9811,7 +9813,11 @@
 {
 	MONO_ARCH_SAVE_REGS;
 
+#ifdef PLATFORM_WIN32
+	GlobalFree (ptr);
+#else
 	g_free (ptr);
+#endif
 }
 
 void*