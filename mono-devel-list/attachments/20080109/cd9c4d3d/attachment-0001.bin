Index: ChangeLog
===================================================================
--- ChangeLog	(revision 92275)
+++ ChangeLog	(working copy)
@@ -1,3 +1,9 @@
+2008-01-09  Jonathan Pryor  <jpryor@novell.com>
+
+	* signal.c: Provide a safe version of signal(3), as it isn't safe for
+	  marshaled delegates to be invoked from signal handler context.
+	* map.h: Flush (adds signal(3)-related prototypes).
+
 2008-01-05  Jonathan Pryor  <jpryor@novell.com>
 
 	* map.h, map.c: Flush; add new ST_NOEXEC, ST_REMOUNT, and ST_BIND MountFlags 
Index: signal.c
===================================================================
--- signal.c	(revision 92060)
+++ signal.c	(working copy)
@@ -9,6 +9,10 @@
 
 #include <signal.h>
 
+#ifndef PLATFORM_WIN32
+#include <unistd.h>
+#endif
+
 #include "map.h"
 #include "mph.h"
 
@@ -49,6 +53,40 @@
 	psignal (sig, s);
 	return errno == 0 ? 0 : -1;
 }
+
+static int signal_write;
+
+void
+_mph_set_signal_write_fd (int fd)
+{
+	signal_write = fd;
+}
+
+static void
+default_signal_handler (int signum)
+{
+	// FIXME: currently we assume that all signums are < 255
+	char c = signum;
+	write (signal_write, &c, 1);
+}
+
+void*
+Mono_Posix_Stdlib_signal (int signum, void* handler)
+{
+	if (handler == SIG_DFL || handler == SIG_ERR || handler == SIG_IGN) {
+		return signal (signum, handler);
+	}
+	return signal (signum, default_signal_handler);
+}
+
+#else /* ndef PLATFORM_WIN32 */
+
+void*
+Mono_Posix_Stdlib_signal (int signum, void* handler)
+{
+	return signal (signum, handler);
+}
+
 #endif /* ndef PLATFORM_WIN32 */
 
 
Index: map.h
===================================================================
--- map.h	(revision 92275)
+++ map.h	(working copy)
@@ -1397,6 +1397,7 @@
  * Delegate Declarations
  */
 
+typedef void (*SignalHandler) (int signal);
 
 /*
  * Structures
@@ -1545,6 +1546,7 @@
 /*
  * Functions
  */
+void _mph_set_signal_write_fd (int signum);
 char* helper_Mono_Posix_GetGroupName (int gid);
 char* helper_Mono_Posix_GetUserName (int uid);
 char* helper_Mono_Posix_readdir (void* dir);
@@ -1587,6 +1589,7 @@
 void* Mono_Posix_Stdlib_SIG_DFL (void);
 void* Mono_Posix_Stdlib_SIG_ERR (void);
 void* Mono_Posix_Stdlib_SIG_IGN (void);
+void* Mono_Posix_Stdlib_signal (int signum, void* handler);
 void* Mono_Posix_Stdlib_stderr (void);
 void* Mono_Posix_Stdlib_stdin (void);
 void* Mono_Posix_Stdlib_stdout (void);
