<tt>
Hey&nbsp;guys,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&nbsp;is&nbsp;the&nbsp;proposal&nbsp;onto&nbsp;how&nbsp;to&nbsp;implement collectible&nbsp;dynamic&nbsp;assembly&nbsp;(CDA)&nbsp;support&nbsp;from&nbsp;v4.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;CDA&nbsp;is&nbsp;just&nbsp;like&nbsp;your&nbsp;regular&nbsp;dynamic&nbsp;assembly&nbsp;except&nbsp;it&nbsp;can&nbsp;be&nbsp;collected&nbsp;when&nbsp;no&nbsp;more&nbsp;references&nbsp;to&nbsp;it&nbsp;exist.&lt;/div&gt;<br>
&lt;div&gt;Those&nbsp;references&nbsp;consist&nbsp;of:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)Objects&nbsp;from&nbsp;any&nbsp;CDA&nbsp;class&lt;/div&gt;&lt;div&gt;2)Object&nbsp;from&nbsp;any&nbsp;type&nbsp;that&nbsp;has&nbsp;a&nbsp;CDA&nbsp;class&nbsp;as&nbsp;it&amp;#39;s&nbsp;component[1]&lt;/div&gt;&lt;div&gt;3)Reflection&nbsp;objects&nbsp;for&nbsp;CDA&nbsp;stuff&lt;/div&gt;&lt;div&gt;<br>
4)Code&nbsp;been&nbsp;executed&nbsp;from&nbsp;any&nbsp;CDA&nbsp;method&lt;/div&gt;&lt;div&gt;5)Byrefs&nbsp;to&nbsp;objects&nbsp;or&nbsp;static&nbsp;data&nbsp;from&nbsp;any&nbsp;CDA&nbsp;related&nbsp;class&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;a&nbsp;type&nbsp;from&nbsp;another&nbsp;dynamic&nbsp;assembly&nbsp;statically&nbsp;reference,&nbsp;eg.&nbsp;extends,&nbsp;a&nbsp;type&nbsp;in&nbsp;a&nbsp;given&nbsp;CDA,&nbsp;the&nbsp;lifetime&lt;/div&gt;<br>
&lt;div&gt;of&nbsp;the&nbsp;later&nbsp;is&nbsp;extended&nbsp;by&nbsp;the&nbsp;former.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;problem&nbsp;is&nbsp;how&nbsp;do&nbsp;we&nbsp;figure&nbsp;out&nbsp;that&nbsp;all&nbsp;those&nbsp;conditions&nbsp;hold&nbsp;true.&nbsp;I&nbsp;believe&nbsp;can&nbsp;reference&nbsp;count &lt;/div&gt;&lt;div&gt;the&nbsp;dynamic&nbsp;image&nbsp;with&nbsp;the&nbsp;following:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Each&nbsp;reflection&nbsp;object&nbsp;increase&nbsp;by&nbsp;one&nbsp;on&nbsp;creation&nbsp;and&nbsp;decrease&nbsp;on&nbsp;finalization.&nbsp;This&nbsp;solve&nbsp;(3)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Make&nbsp;the&nbsp;vtable&nbsp;of&nbsp;all&nbsp;CDA&nbsp;related&nbsp;types&nbsp;garbage&nbsp;collectible&nbsp;and&nbsp;make&nbsp;their&nbsp;objects&nbsp;mark&nbsp;them.&nbsp;This&nbsp;solves&nbsp;(1),&nbsp;(2)&nbsp;and&nbsp;half&nbsp;of&nbsp;(5)&lt;/div&gt;<br>
&lt;div&gt;To&nbsp;make&nbsp;this&nbsp;work&nbsp;we&nbsp;cannot&nbsp;embed&nbsp;vtable&nbsp;literals&nbsp;in&nbsp;generated&nbsp;code,&nbsp;but&nbsp;load&nbsp;them&nbsp;from&nbsp;a&nbsp;memory&nbsp;location.&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;need&nbsp;to&nbsp;avoid&nbsp;having vtables been&nbsp;collected&nbsp;all&nbsp;the&nbsp;time&nbsp;as&nbsp;they&nbsp;are&nbsp;pretty&nbsp;expensive&nbsp;to&nbsp;create.&lt;/div&gt;<br>
&lt;div&gt;My&nbsp;suggestion&nbsp;is&nbsp;to&nbsp;use&nbsp;use&nbsp;the&nbsp;number&nbsp;of&nbsp;GCs&nbsp;to&nbsp;age&nbsp;the&nbsp;vtables.&nbsp;We&nbsp;resurrect&nbsp;them&nbsp;for,&nbsp;say,&nbsp;4&nbsp;collections&nbsp;before &lt;/div&gt;&lt;div&gt;setting&nbsp;the&nbsp;place&nbsp;managed&nbsp;code&nbsp;uses&nbsp;to&nbsp;load&nbsp;them&nbsp;from&nbsp;to&nbsp;null&nbsp;and&nbsp;collecting on&nbsp;the&nbsp;next&nbsp;GC.&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;-Once&nbsp;reference&nbsp;count&nbsp;drops&nbsp;to&nbsp;zero&nbsp;we&nbsp;crawl&nbsp;all&nbsp;stacks&nbsp;for&nbsp;methods&nbsp;from&nbsp;the&nbsp;CDA&nbsp;assembly&nbsp;and&nbsp;repeat&nbsp;it&nbsp;at&nbsp;every&nbsp;major&lt;/div&gt;&lt;div&gt;GC&nbsp;until&nbsp;it&nbsp;gets&nbsp;freed.&nbsp;This&nbsp;solves&nbsp;(4)&lt;/div&gt;<br>
&lt;div&gt;We&nbsp;could&nbsp;make&nbsp;the&nbsp;GC&nbsp;track&nbsp;this&nbsp;information&nbsp;by&nbsp;making&nbsp;method&nbsp;code&nbsp;GC&nbsp;tracked,&nbsp;but&nbsp;this&nbsp;would&nbsp;be&nbsp;pretty&nbsp;hacky&nbsp;under&nbsp;Boehm&nbsp;as&lt;/div&gt;&lt;div&gt;we&nbsp;can&amp;#39;t&nbsp;request&nbsp;it&nbsp;to&nbsp;allocate&nbsp;from&nbsp;rwx&nbsp;memory.&nbsp;We&nbsp;could&nbsp;later&nbsp;switch&nbsp;to&nbsp;this&nbsp;with&nbsp;sgen&nbsp;but&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;it&amp;#39;s&nbsp;work&nbsp;the&nbsp;trouble.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Make&nbsp;the&nbsp;static&nbsp;area&nbsp;of&nbsp;all&nbsp;CDA&nbsp;related&nbsp;types&nbsp;garbage&nbsp;collectible.&nbsp;Make&nbsp;the&nbsp;Assembly&nbsp;object&nbsp;reference&lt;/div&gt;&lt;div&gt;all&nbsp;static&nbsp;segments&nbsp;and&nbsp;all&nbsp;MonoType&nbsp;objects&nbsp;reference&nbsp;the&nbsp;Assembly&nbsp;object&nbsp;-&nbsp;this&nbsp;make&nbsp;sure&nbsp;statics&nbsp;won&amp;#39;t&nbsp;be&nbsp;collected&nbsp;earlier.&nbsp;This&nbsp;solves&nbsp;(5)&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;None&nbsp;of&nbsp;those&nbsp;changes&nbsp;are&nbsp;trivial&nbsp;to&nbsp;do&nbsp;but&nbsp;I&nbsp;believe&nbsp;there&nbsp;isn&amp;#39;t&nbsp;a&nbsp;simpler&nbsp;way&nbsp;to&nbsp;solve&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;comments&nbsp;before&nbsp;I&nbsp;start&nbsp;pushing&nbsp;patches&nbsp;for&nbsp;review?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
Cheers,&lt;/div&gt;&lt;div&gt;Rodrigo&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[1]&nbsp;Given CDA&nbsp;class&nbsp;Dyn,&nbsp;it&nbsp;could&nbsp;be&nbsp;types&nbsp;like&nbsp;Dyn[]&nbsp;or&nbsp;[mscorlib]System.Collections.Generic.List&amp;lt;Dyn&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;meta&nbsp;charset=&quot;utf-8&quot;&gt;<br>

</tt>
