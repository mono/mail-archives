<tt>
Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;I&nbsp;have&nbsp;posted&nbsp;a&nbsp;proposal&nbsp;for&nbsp;an&nbsp;embedding&nbsp;API&nbsp;to&nbsp;allow&nbsp;foreign&nbsp;thread&nbsp;tracking&nbsp;(see&nbsp;&lt;a&nbsp;href=&quot;https://bugzilla.novell.com/show_bug.cgi?id=537764#c26&quot;&gt;https://bugzilla.novell.com/show_bug.cgi?id=537764#c26&lt;/a&gt;).&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;API&nbsp;allows:&lt;/div&gt;&lt;div&gt;-&nbsp;To&nbsp;be&nbsp;notified&nbsp;when&nbsp;a&nbsp;foreign&nbsp;thread&nbsp;is&nbsp;registered&nbsp;with&nbsp;the&nbsp;Mono&nbsp;runtime&lt;/div&gt;&lt;div&gt;-&nbsp;To&nbsp;be&nbsp;notified&nbsp;when&nbsp;a&nbsp;foreign&nbsp;thread&nbsp;is&nbsp;de-registered&nbsp;from&nbsp;the&nbsp;Mono&nbsp;runtime&lt;/div&gt;&lt;div&gt;-&nbsp;To&nbsp;override&nbsp;default&nbsp;Mono&nbsp;behavior&nbsp;by&nbsp;telling&nbsp;that&nbsp;foreign&nbsp;thread&nbsp;are&nbsp;de-registered&nbsp;externally&lt;/div&gt;<br>
<br>
&lt;div&gt;-&nbsp;To&nbsp;de-register&nbsp;a&nbsp;foreign&nbsp;thread&nbsp;from&nbsp;the&nbsp;Mono&nbsp;runtime&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;are&nbsp;two&nbsp;cases&nbsp;of&nbsp;use:&lt;/div&gt;&lt;div&gt;1)&nbsp;An&nbsp;application&nbsp;hooks&nbsp;the&nbsp;Mono&nbsp;runtime&nbsp;to&nbsp;be&nbsp;notified&nbsp;when&nbsp;foreign&nbsp;thread&nbsp;are&nbsp;registered/de-registered.&lt;/div&gt;<br>
<br>
&lt;div&gt;2)&nbsp;An&nbsp;application&nbsp;hooks&nbsp;the&nbsp;Mono&nbsp;runtime&nbsp;to&nbsp;handle&nbsp;the&nbsp;foreign&nbsp;thread&nbsp;de-registration.&nbsp;When&nbsp;a&nbsp;foreign&nbsp;thread&nbsp;is&nbsp;registered,&nbsp;the&nbsp;application&nbsp;is&nbsp;notified.&nbsp;The&nbsp;application&nbsp;is&nbsp;then&nbsp;responsible&nbsp;for&nbsp;the&nbsp;de-registration&nbsp;of&nbsp;the&nbsp;foreign&nbsp;thread.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Some&nbsp;notes:&lt;/div&gt;&lt;div&gt;-&nbsp;The&nbsp;patch&nbsp;has&nbsp;been&nbsp;generated&nbsp;against&nbsp;the&nbsp;2.6.1&nbsp;release&nbsp;sources.&lt;/div&gt;&lt;div&gt;-&nbsp;I&nbsp;have&nbsp;put&nbsp;the&nbsp;embedding&nbsp;API&nbsp;in&nbsp;the&nbsp;&amp;quot;mono/utils&amp;quot;&nbsp;folder,&nbsp;because&nbsp;it&nbsp;is&nbsp;referenced&nbsp;both&nbsp;as&nbsp;a&nbsp;public&nbsp;API&nbsp;and&nbsp;used&nbsp;in&nbsp;the&nbsp;GC.&lt;/div&gt;<br>
<br>
&lt;div&gt;-&nbsp;I&nbsp;have&nbsp;decorated&nbsp;the&nbsp;API&nbsp;to&nbsp;work&nbsp;only&nbsp;if&nbsp;pthread&nbsp;is&nbsp;present.&nbsp;We&nbsp;can&nbsp;see&nbsp;later&nbsp;if&nbsp;other&nbsp;platforms&nbsp;have&nbsp;similar&nbsp;needs.&lt;/div&gt;&lt;div&gt;-&nbsp;I&nbsp;only&nbsp;work&nbsp;on&nbsp;the&nbsp;Bohem&nbsp;GC.&nbsp;I&nbsp;don&amp;#39;t&nbsp;have&nbsp;taken&nbsp;time&nbsp;to&nbsp;look&nbsp;into&nbsp;the&nbsp;SGen&nbsp;one.&lt;/div&gt;<br>
<br>
&lt;div&gt;-&nbsp;I&nbsp;have&nbsp;tested&nbsp;the&nbsp;embedding&nbsp;API&nbsp;on&nbsp;Leopard&nbsp;and&nbsp;Snow&nbsp;Leopard,&nbsp;and&nbsp;it&nbsp;works&nbsp;at&nbsp;it&nbsp;should&nbsp;for&nbsp;the&nbsp;2&nbsp;cases&nbsp;above.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;comments&nbsp;is&nbsp;welcome.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards,&nbsp;Laurent&nbsp;Etiemble.&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2009/12/8&nbsp;Laurent&nbsp;Etiemble&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:laurent.etiemble@monobjc.net&quot;&gt;laurent.etiemble@monobjc.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;starting&nbsp;this&nbsp;thread&nbsp;in&nbsp;order&nbsp;to&nbsp;find&nbsp;a&nbsp;solution&nbsp;to&nbsp;an&nbsp;issue&lt;br&gt;<br>
encountered&nbsp;with&nbsp;Mono&nbsp;and&nbsp;described&nbsp;in&nbsp;this&nbsp;bug&nbsp;entry&lt;br&gt;<br>
(&lt;a&nbsp;href=&quot;https://bugzilla.novell.com/show_bug.cgi?id=537764&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugzilla.novell.com/show_bug.cgi?id=537764&lt;/a&gt;).&lt;br&gt;<br>
&lt;br&gt;<br>
Short&nbsp;Summary:&nbsp;On&nbsp;Mac&nbsp;OS&nbsp;X,&nbsp;Mono&nbsp;is&nbsp;using&nbsp;POSIX&nbsp;pthread&nbsp;functions&nbsp;to&lt;br&gt;<br>
hook&nbsp;to&nbsp;TSD&nbsp;(Thread&nbsp;Specific&nbsp;Data)&nbsp;in&nbsp;order&nbsp;to&nbsp;track&nbsp;the&nbsp;lifecycle&nbsp;of&lt;br&gt;<br>
foreign&nbsp;thread&nbsp;(thread&nbsp;not&nbsp;created&nbsp;by&nbsp;the&nbsp;Mono&nbsp;runtime).&nbsp;Under&nbsp;some&lt;br&gt;<br>
circumstances,&nbsp;a&nbsp;native-to-managed&nbsp;call&nbsp;can&nbsp;lead&nbsp;to&nbsp;inconsistent&nbsp;state&lt;br&gt;<br>
in&nbsp;the&nbsp;Garbage&nbsp;Collector.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;recommended&nbsp;by&nbsp;Geoff,&nbsp;I&nbsp;am&nbsp;starting&nbsp;a&nbsp;discussion&nbsp;about&nbsp;new&nbsp;public&lt;br&gt;<br>
API&nbsp;to&nbsp;support&nbsp;the&nbsp;notification&nbsp;of&nbsp;thread&nbsp;death/creation&nbsp;in&nbsp;the&nbsp;Mono&lt;br&gt;<br>
runtime:&lt;br&gt;<br>
-&nbsp;How&nbsp;thread&nbsp;tracking&nbsp;can&nbsp;be&nbsp;done&nbsp;so&nbsp;Mono&nbsp;does&nbsp;not&nbsp;miss&nbsp;thread&nbsp;death&nbsp;?&lt;br&gt;<br>
-&nbsp;What&nbsp;about&nbsp;providing&nbsp;callback&nbsp;functions&nbsp;that&nbsp;override&nbsp;Mono&nbsp;default&lt;br&gt;<br>
behavior&nbsp;?&nbsp;They&nbsp;will&nbsp;be&nbsp;set&nbsp;during&nbsp;the&nbsp;Mono&nbsp;bootstrapping.&lt;br&gt;<br>
&lt;br&gt;<br>
Any&nbsp;comments&nbsp;or&nbsp;ideas&nbsp;are&nbsp;welcome.&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&nbsp;Laurent&nbsp;Etiemble.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
