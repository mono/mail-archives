<tt>
Hey&nbsp;guys,&lt;br&gt;&lt;br&gt;The&nbsp;attached&nbsp;patch&nbsp;fixes&nbsp;the&nbsp;appdomain&nbsp;unloading&nbsp;problem.&nbsp;I&nbsp;can&nbsp;no&nbsp;longer&nbsp;get&nbsp;the&lt;br&gt;test&nbsp;to&nbsp;crash&nbsp;here.&lt;br&gt;&lt;br&gt;&lt;br&gt;The&nbsp;patch&nbsp;tries&nbsp;to&nbsp;solve&nbsp;two&nbsp;issues:&lt;br&gt;&lt;br&gt;1)&nbsp;Remove&nbsp;all&nbsp;pending&nbsp;jobs&nbsp;from&nbsp;the&nbsp;TP&nbsp;queue&nbsp;that&nbsp;belongs&nbsp;to&nbsp;the&nbsp;app&nbsp;domain&nbsp;been&nbsp;shutdown.&lt;br&gt;<br>
<br>
&lt;br&gt;2)&nbsp;Coordinate&nbsp;the&nbsp;shutdown&nbsp;of&nbsp;the&nbsp;app&nbsp;domain&nbsp;with&nbsp;TP&nbsp;threads.&nbsp;This&nbsp;must&nbsp;be&nbsp;done&nbsp;because&nbsp;there&lt;br&gt;is&nbsp;a&nbsp;time&nbsp;window&nbsp;between&nbsp;the&nbsp;time&nbsp;the&nbsp;thread&nbsp;is&nbsp;spawn&nbsp;and&nbsp;mono_thread_push_appdomain_ref.&lt;br&gt;&lt;br&gt;The&nbsp;patch&nbsp;must&nbsp;be&nbsp;extended&nbsp;to&nbsp;handle&nbsp;async&nbsp;io&nbsp;threads&nbsp;as&nbsp;well,&nbsp;but&nbsp;it&amp;#39;s&nbsp;pretty&nbsp;much&nbsp;the&lt;br&gt;<br>
same&nbsp;fix,&nbsp;so&nbsp;if&nbsp;this&nbsp;one&nbsp;is&nbsp;ok,&nbsp;the&nbsp;other&nbsp;one&nbsp;should&nbsp;be&nbsp;as&nbsp;well.&lt;br&gt;&lt;br&gt;Please&nbsp;review&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;<br>

</tt>
