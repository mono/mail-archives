<tt>
Just&nbsp;to&nbsp;clarify,&nbsp;you&amp;#39;re&nbsp;using&nbsp;a&nbsp;comma&nbsp;as&nbsp;a&nbsp;decimal&nbsp;separator&nbsp;and&nbsp;a&nbsp;dot&nbsp;as&nbsp;a&nbsp;thousands&nbsp;seperator?&lt;br&gt;&lt;br&gt;So:&nbsp;766.6697&nbsp;ns/call&nbsp;=&nbsp;~766&nbsp;thousand&nbsp;ns/call&lt;br&gt;and&nbsp;13,0416&nbsp;ns/call&nbsp;=&nbsp;~13&nbsp;ns/call&lt;br&gt;&lt;br&gt;Alan.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
2009/3/15&nbsp;StApostol&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:stapostol@gmail.com&quot;&gt;stapostol@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi&nbsp;all,&lt;br&gt;&lt;br&gt;I&nbsp;just&nbsp;ran&nbsp;some&nbsp;tests&nbsp;to&nbsp;measure&nbsp;performance&nbsp;in&nbsp;OpenTK.Graphics&nbsp;and&nbsp;Tao.OpenGl&nbsp;and&nbsp;uncovered&nbsp;some&nbsp;surprising&nbsp;results.&lt;br&gt;&lt;br&gt;Some&nbsp;background&nbsp;first:&nbsp;OpenGL&nbsp;exports&nbsp;functions&nbsp;either&nbsp;statically&nbsp;(&amp;quot;core&nbsp;functions&amp;quot;)&nbsp;or&nbsp;dynamically&nbsp;(&amp;quot;extensions&amp;quot;).&nbsp;While&nbsp;you&nbsp;use&nbsp;a&nbsp;simple&nbsp;[DllImport]&nbsp;to&nbsp;invoke&nbsp;core&nbsp;functions,&nbsp;you&nbsp;have&nbsp;to&nbsp;invoke&nbsp;extensions&nbsp;through&nbsp;function&nbsp;pointers.&nbsp;Different&nbsp;platforms,&nbsp;video&nbsp;cards,&nbsp;even&nbsp;drivers&nbsp;expose&nbsp;different&nbsp;subsets&nbsp;of&nbsp;OpenGL&nbsp;as&nbsp;extensions,&nbsp;which&nbsp;means&nbsp;you&nbsp;have&nbsp;to&nbsp;handle&nbsp;this&nbsp;issue&nbsp;during&nbsp;runtime.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;To&nbsp;deal&nbsp;with&nbsp;this&nbsp;problem,&nbsp;the&nbsp;aforementioned&nbsp;libraries&nbsp;implement&nbsp;a&nbsp;relatively&nbsp;complex&nbsp;solution:&lt;br&gt;&lt;ul&gt;&lt;li&gt;The&nbsp;union&nbsp;of&nbsp;all&nbsp;core&nbsp;functions&nbsp;is&nbsp;declared&nbsp;as&nbsp;[DllImport]&nbsp;in&nbsp;a&nbsp;private&nbsp;class&nbsp;named&nbsp;&amp;quot;Core&amp;quot;.&lt;/li&gt;&lt;li&gt;<br>
<br>
The&nbsp;union&nbsp;of&nbsp;all&nbsp;core&nbsp;and&nbsp;extension&nbsp;functions&nbsp;are&nbsp;declared&nbsp;as&nbsp;delegates&nbsp;in&nbsp;a&nbsp;private&nbsp;class&nbsp;named&nbsp;&amp;quot;Delegates&amp;quot;.&lt;/li&gt;<br>
&lt;li&gt;Each&nbsp;delegate&nbsp;has&nbsp;one&nbsp;or&nbsp;more&nbsp;&amp;quot;wrapper&amp;quot;&nbsp;functions.&nbsp;This&nbsp;is&nbsp;the&nbsp;public&nbsp;API&nbsp;for&nbsp;the&nbsp;user.&lt;br&gt;&lt;/li&gt;&lt;li&gt;During&nbsp;initialization,&nbsp;we&nbsp;probe&nbsp;each&nbsp;OpenGL&nbsp;function&nbsp;and&nbsp;&amp;quot;arm&amp;quot;&nbsp;the&nbsp;relevant&nbsp;delegate&nbsp;with&nbsp;Marshal.GetDelegateForFunctionPointer,&nbsp;a&nbsp;function&nbsp;from&nbsp;the&nbsp;Core&nbsp;class&nbsp;or&nbsp;null&nbsp;(if&nbsp;it&nbsp;exported&nbsp;dynamically,&nbsp;statically&nbsp;or&nbsp;not&nbsp;at&nbsp;all,&nbsp;respectively).&lt;/li&gt;<br>
<br>
&lt;/ul&gt;Most&nbsp;of&nbsp;the&nbsp;types&nbsp;used&nbsp;in&nbsp;OpenGL&nbsp;interop&nbsp;are&nbsp;blittable,&nbsp;which&nbsp;makes&nbsp;most&nbsp;pinvokes&nbsp;pretty&nbsp;fast.&nbsp;The&nbsp;main&nbsp;bottleneck&nbsp;is&nbsp;the&nbsp;delegate&nbsp;call,&nbsp;which&nbsp;should&nbsp;be&nbsp;plenty&nbsp;fast&nbsp;(or&nbsp;so&nbsp;we&nbsp;thought).&lt;br&gt;&lt;br&gt;To&nbsp;test&nbsp;the&nbsp;performance&nbsp;of&nbsp;this&nbsp;approach,&nbsp;I&nbsp;wrote&nbsp;a&nbsp;simple&nbsp;test&nbsp;that&nbsp;simulates&nbsp;OpenGL&nbsp;calls&nbsp;(attached).&nbsp;The&nbsp;test&nbsp;measures&nbsp;the&nbsp;call&nbsp;overhead&nbsp;for&nbsp;two&nbsp;function&nbsp;prototypes&nbsp;that&nbsp;are&nbsp;very&nbsp;common&nbsp;in&nbsp;OpenGL:&lt;br&gt;<br>
<br>
&lt;ul&gt;&lt;li&gt;void&nbsp;SendFloat(int,&nbsp;int,&nbsp;int,&nbsp;float*)&lt;/li&gt;&lt;li&gt;void&nbsp;Send(int,&nbsp;int,&nbsp;int,&nbsp;int,&nbsp;void*)&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;The&nbsp;first&nbsp;function&nbsp;is&nbsp;wrapped&nbsp;as&nbsp;&amp;quot;void&nbsp;SendFloat(int,&nbsp;int,&nbsp;int,&nbsp;float[])&amp;quot;&nbsp;and&nbsp;the&nbsp;array&nbsp;is&nbsp;pinned&nbsp;and&nbsp;passed&nbsp;as&nbsp;a&nbsp;simple&nbsp;pointer. &nbsp;The&nbsp;second&nbsp;becomes&nbsp;&amp;quot;void&nbsp;Send(int,&nbsp;int,&nbsp;int,&nbsp;int,&nbsp;object)&amp;quot;&nbsp;and&nbsp;the&nbsp;last&nbsp;parameter&nbsp;is&nbsp;also&nbsp;pinned&nbsp;(with&nbsp;GCHandle.Alloc)&nbsp;and&nbsp;passed&nbsp;as&nbsp;a&nbsp;simple&nbsp;pointer&nbsp;(we&nbsp;assume&nbsp;&amp;#39;object&amp;#39;&nbsp;is&nbsp;a&nbsp;blittable&nbsp;struct).&nbsp;Each&nbsp;of&nbsp;these&nbsp;functions&nbsp;is&nbsp;tested&nbsp;twice,&nbsp;first&nbsp;through&nbsp;a&nbsp;delegate&nbsp;(as&nbsp;outlined&nbsp;above)&nbsp;and&nbsp;then&nbsp;directly&nbsp;with&nbsp;a&nbsp;simple&nbsp;pinvoke.&lt;br&gt;<br>
<br>
&lt;br&gt;The&nbsp;results&nbsp;are&nbsp;measured&nbsp;on&nbsp;a&nbsp;2.66GHz&nbsp;Core&nbsp;2&nbsp;Duo&nbsp;with&nbsp;each&nbsp;function&nbsp;called&nbsp;10^6&nbsp;times&nbsp;(not&nbsp;nearly&nbsp;enough&nbsp;for&nbsp;ns&nbsp;accuracy,&nbsp;but&nbsp;the&nbsp;problem&nbsp;is&nbsp;nonetheless&nbsp;obvious).&nbsp;The&nbsp;binaries&nbsp;were&nbsp;compiled&nbsp;with&nbsp;gmcs&nbsp;2.2&nbsp;(every&nbsp;test&nbsp;used&nbsp;the&nbsp;same&nbsp;executable).&nbsp;The&nbsp;unmanaged&nbsp;dll&nbsp;was&nbsp;compiled&nbsp;with&nbsp;gcc&nbsp;on&nbsp;Linux&nbsp;(x86_64)&nbsp;and&nbsp;msvc&nbsp;on&nbsp;Windows&nbsp;(x86):&lt;br&gt;<br>
<br>
&lt;br&gt;[Mono&nbsp;2.2,&nbsp;Linux&nbsp;x86_64]&lt;br&gt;Timing&nbsp;SendFloat&nbsp;(delegate): 0.7666697&nbsp;seconds&nbsp;(766.6697&nbsp;ns/call) with&nbsp;3/3/3 collections.&lt;br&gt;Timing&nbsp;SendFloat&nbsp;(direct): 0.0170575&nbsp;seconds&nbsp;(17.0575&nbsp;ns/call) with&nbsp;3/3/3 collections.&lt;br&gt;Timing&nbsp;Send&nbsp;(delegate): 1.3894752&nbsp;seconds&nbsp;(1389.4752&nbsp;ns/call) with&nbsp;3/3/3 collections.&lt;br&gt;<br>
<br>
Timing&nbsp;Send&nbsp;(direct): 0.2461236&nbsp;seconds&nbsp;(246.1236&nbsp;ns/call) with&nbsp;3/3/3 collections.&lt;br&gt;&lt;br&gt;[Mono&nbsp;2.4&nbsp;RC1,&nbsp;Windows&nbsp;x86&nbsp;(VirtualBox)]&lt;br&gt;Timing&nbsp;SendFloat&nbsp;(delegate):&nbsp;0,0130416&nbsp;seconds&nbsp;(13,0416&nbsp;ns/call)&nbsp;with&nbsp;1/1/1&nbsp;collections.&lt;br&gt;<br>
<br>
Timing&nbsp;SendFloat&nbsp;(direct):&nbsp;0,0140448&nbsp;seconds&nbsp;(14,0448&nbsp;ns/call)&nbsp;with&nbsp;1/1/1&nbsp;collections.&lt;br&gt;Timing&nbsp;Send&nbsp;(delegate):&nbsp;0,1033469&nbsp;seconds&nbsp;(103,3469&nbsp;ns/call)&nbsp;with&nbsp;1/1/1&nbsp;collections.&lt;br&gt;Timing&nbsp;Send&nbsp;(direct):&nbsp;0,1063392&nbsp;seconds&nbsp;(106,3392&nbsp;ns/call)&nbsp;with&nbsp;1/1/1&nbsp;collections.&lt;br&gt;<br>
<br>
&lt;br&gt;[.Net&nbsp;3.5&nbsp;SP1,&nbsp;Windows&nbsp;x86&nbsp;(VirtualBox)]&lt;br&gt;Timing&nbsp;SendFloat&nbsp;(delegate):&nbsp;0,0117486&nbsp;seconds&nbsp;(11,7486&nbsp;ns/call) with&nbsp;0/0/0 collections.&lt;br&gt;Timing&nbsp;SendFloat&nbsp;(direct): 0,0070824&nbsp;seconds&nbsp;(7,0824&nbsp;ns/call) with&nbsp;0/0/0 collections.&lt;br&gt;<br>
<br>
Timing&nbsp;Send&nbsp;(delegate):&nbsp;0,1087277&nbsp;seconds&nbsp;(108,7277&nbsp;ns/call) with&nbsp;0/0/0 collections.&lt;br&gt;Timing&nbsp;Send&nbsp;(direct): 0,095304&nbsp;seconds&nbsp;(95,304&nbsp;ns/call) with&nbsp;0/0/0 collections.&lt;br&gt;&lt;br&gt;As&nbsp;you&nbsp;can&nbsp;see,&nbsp;Mono&nbsp;2.2&nbsp;on&nbsp;Linux&nbsp;x86_64&nbsp;is&nbsp;5&nbsp;-&nbsp;40&nbsp;times&nbsp;slower&nbsp;when&nbsp;calling&nbsp;a&nbsp;delegate&nbsp;-&nbsp;nearly&nbsp;1us&nbsp;for&nbsp;a&nbsp;single&nbsp;delegate&nbsp;call!&nbsp;In&nbsp;comparison,&nbsp;calling&nbsp;a&nbsp;delegate&nbsp;on&nbsp;Windows&nbsp;x86&nbsp;seems&nbsp;comparable&nbsp;to&nbsp;a&nbsp;simple&nbsp;virtual&nbsp;call&nbsp;(1&nbsp;-&nbsp;3ns&nbsp;overhead).&lt;br&gt;<br>
<br>
&lt;br&gt;A&nbsp;typical,&nbsp;state-of-the-art&nbsp;3d&nbsp;program&nbsp;may&nbsp;contain&nbsp;somewhere&nbsp;between&nbsp;1000-5000&nbsp;draw&nbsp;calls&nbsp;per&nbsp;frame.&nbsp;Assuming&nbsp;the&nbsp;above&nbsp;results&nbsp;hold,&nbsp;the&nbsp;interop&nbsp;layer&nbsp;will&nbsp;consume&nbsp;between&nbsp;5-30%&nbsp;of&nbsp;your&nbsp;total&nbsp;frame&nbsp;bugdet&nbsp;(16.6ms)&nbsp;-&nbsp;not&nbsp;good!&lt;br&gt;<br>
<br>
&lt;br&gt;Is&nbsp;there&nbsp;an&nbsp;explanation&nbsp;for&nbsp;this&nbsp;discrepancy?&nbsp;Can&nbsp;we&nbsp;expect&nbsp;better&nbsp;performance&nbsp;in&nbsp;some&nbsp;future&nbsp;version&nbsp;of&nbsp;the&nbsp;runtime?&nbsp;Should&nbsp;we&nbsp;bite&nbsp;the&nbsp;bullet&nbsp;and&nbsp;rewrite&nbsp;the&nbsp;bindings&nbsp;in&nbsp;ilasm&nbsp;(replacing&nbsp;pinvokes&nbsp;with&nbsp;calli&nbsp;instructions)?&nbsp;Any&nbsp;possible&nbsp;workarounds&nbsp;/&nbsp;alternatives?&lt;br&gt;<br>
<br>
&lt;br&gt;Thanks&nbsp;for&nbsp;your&nbsp;time!&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
