? replace.diff
? doc/Makefile
? doc/Makefile.in
? mono/arch/amd64
? mono/interpreter/interp.lo
? mono/interpreter/libmint.la
Index: mono/metadata/ChangeLog
===================================================================
RCS file: /mono/mono/mono/metadata/ChangeLog,v
retrieving revision 1.1406
diff -u -r1.1406 ChangeLog
--- mono/metadata/ChangeLog	27 Feb 2004 02:34:45 -0000	1.1406
+++ mono/metadata/ChangeLog	29 Feb 2004 14:56:51 -0000
@@ -1,3 +1,8 @@
+2004-02-29  Jaroslaw Kowalski <jaak@zd.com.pl>
+
+	* locales.c, string-icalls.c: Fixed very nasty String.Replace() bug
+	where too small buffer was allocated and memory got corrupted.
+
 2004-02-27  Martin Baulig  <martin@ximian.com>
 
 	* reflection.c (mono_reflection_bind_generic_parameters): Take a
Index: mono/metadata/locales.c
===================================================================
RCS file: /mono/mono/mono/metadata/locales.c,v
retrieving revision 1.11
diff -u -r1.11 locales.c
--- mono/metadata/locales.c	2 Feb 2004 21:39:54 -0000	1.11
+++ mono/metadata/locales.c	29 Feb 2004 14:56:52 -0000
@@ -1320,11 +1320,17 @@
 	srclen = mono_string_length(me);
 
 	if (oldstrlen != newstrlen) {
-		for (i = 0; i <= srclen - oldstrlen; i++)
-			if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2)))
+		i = 0;
+		while (i <= srclen - oldstrlen) {
+			if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2))) {
 				occurr++;
-                if (occurr == 0)
-                        return me;
+				i += oldstrlen;
+			} else {
+				i++;
+			}
+		}
+ 		if (occurr == 0)
+        	return me;
 		newsize = srclen + ((newstrlen - oldstrlen) * occurr);
  	} else
 		newsize = srclen;
@@ -1343,7 +1349,7 @@
 				destpos += newstrlen;
 			}
 			i += oldstrlen;
-                        continue;
+            continue;
 		} else if (ret != NULL) {
 			dest[destpos] = src[i];
  		}
Index: mono/metadata/string-icalls.c
===================================================================
RCS file: /mono/mono/mono/metadata/string-icalls.c,v
retrieving revision 1.27
diff -u -r1.27 string-icalls.c
--- mono/metadata/string-icalls.c	13 Jan 2004 18:49:30 -0000	1.27
+++ mono/metadata/string-icalls.c	29 Feb 2004 14:56:53 -0000
@@ -347,11 +347,17 @@
 	srclen = mono_string_length(me);
 
 	if (oldstrlen != newstrlen) {
-		for (i = 0; i <= srclen - oldstrlen; i++)
-			if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2)))
+		i = 0;
+		while (i <= srclen - oldstrlen) {
+			if (0 == memcmp(src + i, oldstr, oldstrlen * sizeof(gunichar2))) {
 				occurr++;
-                if (occurr == 0)
-                        return me;
+				i += oldstrlen;
+			} else {
+				i++;
+			}
+		}
+        if (occurr == 0)
+        	return me;
 		newsize = srclen + ((newstrlen - oldstrlen) * occurr);
  	} else
 		newsize = srclen;
