<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;I&nbsp;found&nbsp;a&nbsp;leak&nbsp;in&nbsp;TcpListener.AcceptTcpClient&nbsp;:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;public&nbsp;TcpClient&nbsp;AcceptTcpClient&nbsp;()&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;if&nbsp;(!active)&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;throw&nbsp;new&nbsp;InvalidOperationException&nbsp;(&quot;Socket&nbsp;is&nbsp;not&nbsp;listening&quot;);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;Socket&nbsp;clientSocket&nbsp;=&nbsp;server.Accept&nbsp;();&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;TcpClient&nbsp;client&nbsp;=&nbsp;new&nbsp;TcpClient();&nbsp; //&nbsp;this&nbsp;call&nbsp;creates&nbsp;a&nbsp;socket&nbsp;even&nbsp;though&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;it&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;//&nbsp;use&nbsp;internal&nbsp;method&nbsp;SetTcpClient&nbsp;to&nbsp;make&nbsp;a&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;//&nbsp;client&nbsp;with&nbsp;the&nbsp;specified&nbsp;socket&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;client.SetTcpClient&nbsp;(clientSocket);&nbsp; //&nbsp;This&nbsp;method&nbsp;leaks&nbsp;the&nbsp;socket&nbsp;created&nbsp;by&nbsp;the&nbsp;default&nbsp;constructor.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;return&nbsp;client;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;method&nbsp;calls&nbsp;the&nbsp;default&nbsp;TcpClient&nbsp;constructor&nbsp;which&nbsp;creates&nbsp;a&nbsp;new&nbsp;socket.&nbsp; SetTcpClient&nbsp;is&nbsp;then&nbsp;called&nbsp;to&nbsp;assign&nbsp;the&nbsp;accepted&nbsp;socket&nbsp;to&nbsp;the&nbsp;TcpClient&nbsp;object.&nbsp; The&nbsp;problem&nbsp;is&nbsp;that&nbsp;the&nbsp;SetTcpClient&nbsp;simply&nbsp;replaces&nbsp;the&nbsp;old&nbsp;socket&nbsp;reference&nbsp;by&nbsp;the&nbsp;new&nbsp;without&nbsp;closing&nbsp;the&nbsp;old&nbsp;socket.&nbsp; The&nbsp;result&nbsp;is&nbsp;that&nbsp;the&nbsp;socket&nbsp;created&nbsp;by&nbsp;the&nbsp;default&nbsp;constructor&nbsp;remains&nbsp;until&nbsp;the&nbsp;GC&nbsp;reclaims&nbsp;it.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;fix&nbsp;would&nbsp;be&nbsp;really&nbsp;easy.&nbsp; Instead&nbsp;of&nbsp;calling&nbsp;the&nbsp;default&nbsp;TcpClient&nbsp;constructor,&nbsp;a&nbsp;new&nbsp;constructor&nbsp;could&nbsp;be&nbsp;created&nbsp;taking&nbsp;the&nbsp;socket&nbsp;as&nbsp;parameter.&nbsp; We&nbsp;would&nbsp;then&nbsp;avoid&nbsp;creating&nbsp;and&nbsp;leaking&nbsp;a&nbsp;socket&nbsp;every&nbsp;time&nbsp;the&nbsp;method&nbsp;is&nbsp;called.&nbsp; The&nbsp;fixed&nbsp;method&nbsp;would&nbsp;look&nbsp;like&nbsp;this&nbsp;:&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;public&nbsp;TcpClient&nbsp;AcceptTcpClient&nbsp;()&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;if&nbsp;(!active)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;throw&nbsp;new&nbsp;InvalidOperationException&nbsp;(&quot;Socket&nbsp;is&nbsp;not&nbsp;listening&quot;);&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;Socket&nbsp;clientSocket&nbsp;=&nbsp;server.Accept&nbsp;();&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;TcpClient&nbsp;client&nbsp;=&nbsp;new&nbsp;TcpClient(clientSocket);&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;return&nbsp;client;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;could&nbsp;create&nbsp;a&nbsp;fix&nbsp;with&nbsp;the&nbsp;proposed&nbsp;solution.&nbsp; Any&nbsp;thoughts?&lt;/div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;<br>

</tt>
