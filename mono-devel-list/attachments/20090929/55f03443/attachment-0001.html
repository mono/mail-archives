<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=UTF-8&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
Hi&nbsp;Miguel,&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1254175692.5057.153.camel@erandi.site&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Hello,<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;tried&nbsp;your&nbsp;sample,&nbsp;in&nbsp;my&nbsp;machine&nbsp;the&nbsp;memory&nbsp;usage&nbsp;with&nbsp;Case1&nbsp;does<br>
go&nbsp;up&nbsp;very&nbsp;quickly,&nbsp;but&nbsp;then&nbsp;it&nbsp;tends&nbsp;to&nbsp;stay&nbsp;stable&nbsp;around&nbsp;600&nbsp;megs.<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
Ok,&nbsp;but&nbsp;the&nbsp;problem&nbsp;is&nbsp;that&nbsp;ALL&nbsp;memory&nbsp;should&nbsp;be&nbsp;freed,&nbsp;since&nbsp;there&nbsp;are<br>
no&nbsp;references&nbsp;to&nbsp;the&nbsp;arrays.&nbsp;Of&nbsp;course&nbsp;you've&nbsp;to&nbsp;invoke&nbsp;GC.&nbsp;The&nbsp;600Mb<br>
in&nbsp;RES&nbsp;is&nbsp;a&nbsp;leak&nbsp;(Virtual&nbsp;Mem&nbsp;will&nbsp;only&nbsp;grow&nbsp;since&nbsp;libgc&nbsp;will&nbsp;never<br>
release&nbsp;it,&nbsp;this&nbsp;is&nbsp;another&nbsp;patch&nbsp;Dick&nbsp;has&nbsp;been&nbsp;working&nbsp;on)&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1254175692.5057.153.camel@erandi.site&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;Later,&nbsp;I&nbsp;modified&nbsp;the&nbsp;program&nbsp;to&nbsp;not&nbsp;allocate&nbsp;1&nbsp;meg&nbsp;blocks,&nbsp;but<br>
instead&nbsp;to&nbsp;allocation&nbsp;1024&nbsp;times&nbsp;1k&nbsp;blocks&nbsp;(so&nbsp;that&nbsp;it&nbsp;allocates&nbsp;the<br>
same&nbsp;amount&nbsp;of&nbsp;memory).&nbsp;&nbsp;&nbsp;The&nbsp;program&nbsp;stays&nbsp;stable&nbsp;at&nbsp;around&nbsp;200&nbsp;megs&nbsp;of<br>
ram&nbsp;in&nbsp;this&nbsp;case.<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
Same&nbsp;as&nbsp;above:&nbsp;if&nbsp;we're&nbsp;talking&nbsp;about&nbsp;RES&nbsp;it&nbsp;should&nbsp;be&nbsp;close&nbsp;to&nbsp;0&nbsp;(ok,<br>
size&nbsp;of&nbsp;the&nbsp;runtime&nbsp;and&nbsp;the&nbsp;program)&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1254175692.5057.153.camel@erandi.site&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;am&nbsp;sure&nbsp;your&nbsp;program&nbsp;is&nbsp;more&nbsp;complicated,&nbsp;but&nbsp;the&nbsp;difference<br>
between&nbsp;these&nbsp;two&nbsp;patterns&nbsp;of&nbsp;memory&nbsp;usage&nbsp;in&nbsp;my&nbsp;opinion&nbsp;are&nbsp;caused&nbsp;by<br>
memory&nbsp;fragmentation,&nbsp;not&nbsp;really&nbsp;conservative&nbsp;heap&nbsp;scanning.&nbsp;<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
We&nbsp;don't&nbsp;think&nbsp;so&nbsp;since&nbsp;memory&nbsp;is&nbsp;clearly&nbsp;not&nbsp;freed,&nbsp;even&nbsp;considering<br>
there're&nbsp;no&nbsp;references&nbsp;to&nbsp;the&nbsp;data.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1254175692.5057.153.camel@erandi.site&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;suggestion&nbsp;is&nbsp;to&nbsp;change&nbsp;the&nbsp;code&nbsp;in&nbsp;your&nbsp;server&nbsp;to&nbsp;use&nbsp;either<br>
unmanaged&nbsp;buffers&nbsp;for&nbsp;large&nbsp;allocations,&nbsp;or&nbsp;to&nbsp;do&nbsp;buffering&nbsp;with&nbsp;smaller<br>
blocks&nbsp;of&nbsp;memory&nbsp;instead&nbsp;of&nbsp;10&nbsp;megabyte&nbsp;blobs.<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
Ok,&nbsp;in&nbsp;fact&nbsp;this&nbsp;is&nbsp;just&nbsp;a&nbsp;simple&nbsp;example,&nbsp;our&nbsp;production&nbsp;code&nbsp;is&nbsp;not<br>
handling&nbsp;arrays&nbsp;pointing&nbsp;to&nbsp;such&nbsp;a&nbsp;big&nbsp;data.&nbsp;We&nbsp;can&nbsp;handle&nbsp;arrays&nbsp;of<br>
objects&nbsp;close&nbsp;to&nbsp;50K&nbsp;elements&nbsp;or&nbsp;even&nbsp;more,&nbsp;but&nbsp;not&nbsp;millions.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1254175692.5057.153.camel@erandi.site&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Hi&nbsp;all,<br>
<br>
After&nbsp;several&nbsp;weeks&nbsp;working&nbsp;on&nbsp;a&nbsp;bunch&nbsp;of&nbsp;mem&nbsp;issues&nbsp;related&nbsp;to&nbsp;the<br>
libgc&nbsp;based&nbsp;garbage&nbsp;collector,&nbsp;we've&nbsp;identified&nbsp;the&nbsp;following&nbsp;issue&nbsp;and<br>
a&nbsp;possible&nbsp;solution&nbsp;(Dick&nbsp;already&nbsp;sent&nbsp;some&nbsp;workarounds&nbsp;to&nbsp;the&nbsp;list):<br>
<br>
The&nbsp;libgc&nbsp;garbage&nbsp;collector&nbsp;has&nbsp;a&nbsp;really&nbsp;hard&nbsp;time&nbsp;identifying&nbsp;pointers<br>
to&nbsp;objects&nbsp;since&nbsp;it&nbsp;&quot;guesses&quot;&nbsp;what&nbsp;is&nbsp;a&nbsp;pointer&nbsp;instead&nbsp;of&nbsp;actually<br>
&quot;knowing&quot;&nbsp;by&nbsp;using&nbsp;data&nbsp;passed&nbsp;by&nbsp;the&nbsp;mono&nbsp;runtime.<br>
<br>
It&nbsp;means&nbsp;something&nbsp;as&nbsp;simple&nbsp;as&nbsp;introducing&nbsp;a&nbsp;long&nbsp;on&nbsp;the&nbsp;stack&nbsp;(for<br>
instance&nbsp;something&nbsp;like&nbsp;array&nbsp;=&nbsp;new&nbsp;int[1000000])&nbsp;will&nbsp;block&nbsp;(forever)<br>
the&nbsp;memory&nbsp;at&nbsp;address&nbsp;1000000.&nbsp;Yes,&nbsp;as&nbsp;incredible&nbsp;as&nbsp;it&nbsp;sounds,&nbsp;it&nbsp;can<br>
cause&nbsp;important&nbsp;mem&nbsp;problems&nbsp;on&nbsp;long&nbsp;living&nbsp;apps&nbsp;(typically&nbsp;servers).<br>
<br>
(As&nbsp;a&nbsp;side&nbsp;note,&nbsp;this&nbsp;exact&nbsp;problem&nbsp;is&nbsp;present&nbsp;on&nbsp;sgen,&nbsp;since&nbsp;it&nbsp;also<br>
scans&nbsp;the&nbsp;stack&nbsp;&quot;conservatively&quot;).<br>
<br>
A&nbsp;small&nbsp;improvement&nbsp;could&nbsp;be&nbsp;made&nbsp;in&nbsp;the&nbsp;current&nbsp;GC&nbsp;with&nbsp;little&nbsp;effort,<br>
and&nbsp;is&nbsp;supplying&nbsp;more&nbsp;class&nbsp;refmaps&nbsp;to&nbsp;libgc.<br>
<br>
Libgc&nbsp;is&nbsp;very&nbsp;hard&nbsp;to&nbsp;modify,&nbsp;it&nbsp;contains&nbsp;too&nbsp;many&nbsp;hacks&nbsp;and<br>
optimizations&nbsp;that&nbsp;have&nbsp;made&nbsp;the&nbsp;code&nbsp;a&nbsp;nightmare&nbsp;to&nbsp;understand&nbsp;and<br>
modify,&nbsp;so&nbsp;we&nbsp;don't&nbsp;find&nbsp;useful&nbsp;to&nbsp;make&nbsp;anything&nbsp;here&nbsp;beyond&nbsp;very&nbsp;small<br>
patches.<br>
<br>
That&nbsp;said,&nbsp;mono&nbsp;currently&nbsp;can&nbsp;provide&nbsp;reference&nbsp;bitmaps&nbsp;for&nbsp;objects,<br>
it's&nbsp;a&nbsp;matter&nbsp;of&nbsp;providing&nbsp;the&nbsp;right&nbsp;descriptor&nbsp;to&nbsp;the&nbsp;garbage&nbsp;collector.<br>
<br>
Libgc&nbsp;supports&nbsp;this&nbsp;kind&nbsp;of&nbsp;descriptors&nbsp;and&nbsp;mono&nbsp;already&nbsp;generates&nbsp;them<br>
for&nbsp;the&nbsp;sgen&nbsp;gc,&nbsp;so&nbsp;it's&nbsp;just&nbsp;a&nbsp;matter&nbsp;of&nbsp;joining&nbsp;those&nbsp;together&nbsp;(which<br>
should&nbsp;beeasy&nbsp;to&nbsp;do).&nbsp;This&nbsp;should&nbsp;improve&nbsp;a&nbsp;great&nbsp;number&nbsp;of&nbsp;scans&nbsp;in&nbsp;the<br>
arking&nbsp;process,&nbsp;leaving&nbsp;only&nbsp;stacks&nbsp;and&nbsp;several&nbsp;minor&nbsp;objects&nbsp;without<br>
precise&nbsp;marking.&nbsp;(Should&nbsp;become&nbsp;similar&nbsp;to&nbsp;the&nbsp;current&nbsp;sgen&nbsp;idea,&nbsp;where<br>
stacks&nbsp;and&nbsp;other&nbsp;roots&nbsp;are&nbsp;scanned&nbsp;conservatively,&nbsp;although&nbsp;not&nbsp;compacting).<br>
<br>
Attached&nbsp;is&nbsp;the&nbsp;sample&nbsp;code&nbsp;we&nbsp;use&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue&nbsp;on&nbsp;32&nbsp;bit<br>
based&nbsp;Linux/Mono&nbsp;systems.<br>
<br>
Some&nbsp;notes&nbsp;about&nbsp;the&nbsp;test&nbsp;app&nbsp;below:<br>
<br>
<br>
=======================================<br>
the&nbsp;program&nbsp;accepts&nbsp;commands&nbsp;like&nbsp;gc,&nbsp;mem,&nbsp;exit,&nbsp;2,&nbsp;or&nbsp;1<br>
<br>
2&nbsp;n&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creates&nbsp;n&nbsp;arrays&nbsp;of&nbsp;ints&nbsp;with&nbsp;m&nbsp;elements,&nbsp;and&nbsp;put&nbsp;them&nbsp;in&nbsp;an<br>
arraylist.&nbsp;After&nbsp;the&nbsp;call&nbsp;completes,&nbsp;they&nbsp;are&nbsp;no&nbsp;longer&nbsp;referenced.<br>
1&nbsp;n&nbsp;m&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;same,&nbsp;but&nbsp;waiting&nbsp;for&nbsp;a&nbsp;key&nbsp;press&nbsp;after&nbsp;each&nbsp;new&nbsp;array<br>
gc&nbsp;n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;performs&nbsp;n&nbsp;gcs<br>
exit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exits<br>
<br>
So,&nbsp;the&nbsp;case:<br>
<br>
mono&nbsp;test.exe<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;2&nbsp;2000000&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creates&nbsp;2&nbsp;million&nbsp;int&nbsp;arrays&nbsp;of&nbsp;70&nbsp;elements<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;each&nbsp;(virtual&nbsp;goes&nbsp;up&nbsp;to&nbsp;777MB)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;gc&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;should&nbsp;free&nbsp;everything,&nbsp;but&nbsp;around&nbsp;33MB<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;remain&nbsp;allocated&nbsp;acording&nbsp;to&nbsp;pmap:<br>
<br>
...<br>
bf4b5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;---p&nbsp;[anon]<br>
bfc9e000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;88K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;28K&nbsp;rwxp&nbsp;[stack]<br>
ffffe000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;r-xp&nbsp;[vdso]<br>
Total:&nbsp;&nbsp;&nbsp;777820K&nbsp;&nbsp;33852K&nbsp;&nbsp;29336K<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;2&nbsp;20&nbsp;25000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creates&nbsp;20&nbsp;int&nbsp;arrays&nbsp;of&nbsp;25&nbsp;million&nbsp;elements<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;each&nbsp;(2.7GB)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;gc&nbsp;10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;now&nbsp;pmap&nbsp;shows&nbsp;everything&nbsp;is&nbsp;screwed&nbsp;up:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;...<br>
b7f2b000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8K&nbsp;rwxp&nbsp;/lib/ld-2.6.1.so<br>
bf4b5000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;---p&nbsp;[anon]<br>
bfc9e000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;88K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;32K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;28K&nbsp;rwxp&nbsp;[stack]<br>
ffffe000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0K&nbsp;r-xp&nbsp;[vdso]<br>
Total:&nbsp;&nbsp;&nbsp;2764356K&nbsp;1696132K&nbsp;1691616K<br>
<br>
<br>
Trying&nbsp;with&nbsp;smaller&nbsp;sizes&nbsp;lets&nbsp;you&nbsp;see&nbsp;that&nbsp;segments&nbsp;are&nbsp;joined&nbsp;and<br>
split,&nbsp;but&nbsp;seems&nbsp;that&nbsp;there&nbsp;is&nbsp;some&nbsp;inability&nbsp;to&nbsp;free&nbsp;everything.<br>
<br>
======================================<br>
<br>
<br>
Regards,<br>
<br>
<br>
&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsppablo<br>
<br>
<br>
<br>
plain&nbsp;text&nbsp;document&nbsp;attachment&nbsp;(Program.cs)<br>
ï»¿using&nbsp;System;<br>
using&nbsp;System.Collections;<br>
<br>
namespace&nbsp;test<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Program<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;void&nbsp;Main(string[]&nbsp;args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WaitForEnter();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;WaitForEnter()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Command:&quot;);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(true)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.Write(&quot;&amp;gt;&nbsp;&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;line&nbsp;=&nbsp;Console.ReadLine();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string[]&nbsp;args&nbsp;=&nbsp;line.Split('&nbsp;');<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(args.Length&nbsp;&amp;lt;=&nbsp;0)&nbsp;continue;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(args[0].ToLower())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&quot;exit&quot;:&nbsp;return;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&quot;1&quot;:&nbsp;Case1(args);&nbsp;break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&quot;2&quot;:&nbsp;Case2(args);&nbsp;break;<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&quot;mem&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Memory&nbsp;now:&nbsp;{0}&quot;,&nbsp;GC.GetTotalMemory(false));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&quot;gc&quot;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Gcs(args);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Unknown&nbsp;command&quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;Gcs(string[]&nbsp;args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;loop&nbsp;=&nbsp;(args.Length&nbsp;==&nbsp;2)&nbsp;?&nbsp;Int32.Parse(args[1])&nbsp;:&nbsp;1;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;loop;&nbsp;++i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Memory&nbsp;{1}&nbsp;now&nbsp;:&nbsp;{0}&quot;,&nbsp;GC.GetTotalMemory(false),&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Memory&nbsp;{1}&nbsp;after&nbsp;GC:&nbsp;{0}&quot;,&nbsp;GC.GetTotalMemory(true),&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;const&nbsp;int&nbsp;OneMeg&nbsp;=&nbsp;1024&nbsp;*&nbsp;1024;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;Case1(string[]&nbsp;args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;loop&nbsp;=&nbsp;(args.Length&nbsp;&amp;gt;=&nbsp;2)&nbsp;?&nbsp;Int32.Parse(args[1])&nbsp;:&nbsp;5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;size&nbsp;=&nbsp;(args.Length&nbsp;&amp;gt;=&nbsp;3)&nbsp;?&nbsp;Int32.Parse(args[2])&nbsp;:&nbsp;10&nbsp;*&nbsp;OneMeg;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList&nbsp;container&nbsp;=&nbsp;new&nbsp;ArrayList();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;loop;&nbsp;++i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int[]&nbsp;s1&nbsp;=&nbsp;new&nbsp;int[size];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;j&nbsp;=&nbsp;0;&nbsp;j&nbsp;&amp;lt;&nbsp;size;&nbsp;++j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s1[j]&nbsp;=&nbsp;j;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container.Add(s1);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.Write(&quot;Iteration&nbsp;{0},&nbsp;press&nbsp;enter&nbsp;for&nbsp;next&quot;,&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.ReadLine();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Explicit&nbsp;in&nbsp;case&nbsp;it&nbsp;helps<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;Case2(string[]&nbsp;args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;loop&nbsp;=&nbsp;(args.Length&nbsp;&amp;gt;=&nbsp;2)&nbsp;?&nbsp;Int32.Parse(args[1])&nbsp;:&nbsp;5;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;size&nbsp;=&nbsp;(args.Length&nbsp;&amp;gt;=&nbsp;3)&nbsp;?&nbsp;Int32.Parse(args[2])&nbsp;:&nbsp;10&nbsp;*&nbsp;OneMeg;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ArrayList&nbsp;container&nbsp;=&nbsp;new&nbsp;ArrayList();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;loop;&nbsp;++i)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int[]&nbsp;s1&nbsp;=&nbsp;new&nbsp;int[size];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(int&nbsp;j&nbsp;=&nbsp;0;&nbsp;j&nbsp;&amp;lt;&nbsp;size;&nbsp;++j)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s1[j]&nbsp;=&nbsp;j;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container.Add(s1);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&quot;Iteration&nbsp;{0}&quot;,&nbsp;i);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Explicit&nbsp;in&nbsp;case&nbsp;it&nbsp;helps<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;container&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
_______________________________________________<br>
Mono-devel-list&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>
<br>
<br>

</tt>
