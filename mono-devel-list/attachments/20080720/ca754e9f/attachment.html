<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jul&nbsp;20,&nbsp;2008&nbsp;at&nbsp;11:59&nbsp;AM,&nbsp;Massimiliano&nbsp;Mantione&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:massi@ximian.com&quot;&gt;massi@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;br&gt;<br>
Hello!&lt;br&gt;<br>
&lt;br&gt;<br>
Rodrigo&nbsp;and&nbsp;others&nbsp;were&nbsp;asking&nbsp;to&nbsp;extend&nbsp;the&nbsp;stat&nbsp;profiler&nbsp;to&nbsp;recognize&lt;br&gt;<br>
also&nbsp;trampolines&nbsp;and&nbsp;thunks&nbsp;(right&nbsp;now&nbsp;they&nbsp;show&nbsp;up&nbsp;as&nbsp;&amp;quot;unknown&amp;quot;).&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;have&nbsp;looked&nbsp;at&nbsp;the&nbsp;code,&nbsp;and&nbsp;found&nbsp;that&nbsp;the&nbsp;different&nbsp;categories&nbsp;of&lt;br&gt;<br>
&amp;quot;thunks&amp;quot;&nbsp;we&nbsp;have&nbsp;are,&nbsp;roughly:&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp;create_fnptr&lt;br&gt;<br>
﻿-&nbsp;load_aot_method&lt;br&gt;<br>
﻿-&nbsp;imt&nbsp;thunk&lt;br&gt;<br>
﻿-&nbsp;jump&nbsp;table&lt;br&gt;<br>
﻿-&nbsp;debugger&nbsp;code&lt;br&gt;<br>
﻿-&nbsp;exception&nbsp;call&nbsp;filter&lt;br&gt;<br>
﻿﻿-&nbsp;﻿trampoline&nbsp;(various&nbsp;types)&lt;br&gt;<br>
﻿﻿﻿﻿﻿-&nbsp;throw&nbsp;corlib&nbsp;exception&lt;br&gt;<br>
﻿-&nbsp;restore&nbsp;context&lt;br&gt;<br>
﻿-&nbsp;throw&nbsp;exception&nbsp;by&nbsp;name&lt;br&gt;<br>
﻿-&nbsp;handle&nbsp;stack&nbsp;overflow&lt;br&gt;<br>
-&nbsp;throw&nbsp;exception&lt;br&gt;<br>
-&nbsp;delegate&nbsp;invoke&nbsp;implementation&lt;br&gt;<br>
-&nbsp;cpuid&nbsp;code&nbsp;:-)&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;are&nbsp;more&nbsp;than&nbsp;70&nbsp;places&nbsp;in&nbsp;the&nbsp;code&nbsp;that&nbsp;reserve&nbsp;memory&nbsp;from&nbsp;a&lt;br&gt;<br>
code&nbsp;manager&nbsp;to&nbsp;produce&nbsp;those&nbsp;small&nbsp;code&nbsp;snippets&nbsp;that&nbsp;we&amp;#39;d&nbsp;like&nbsp;to&lt;br&gt;<br>
track.&lt;br&gt;<br>
&lt;br&gt;<br>
Typically,&nbsp;when&nbsp;we&nbsp;add&nbsp;profiling&nbsp;infrastructure,&nbsp;we&nbsp;do&nbsp;not&nbsp;change&nbsp;the&lt;br&gt;<br>
runtime&nbsp;API,&nbsp;we&nbsp;just&nbsp;insert&nbsp;calls&nbsp;to&nbsp;the&nbsp;profiler&nbsp;APIs&nbsp;in&nbsp;the&nbsp;relevant&lt;br&gt;<br>
places.&lt;br&gt;<br>
However,&nbsp;in&nbsp;this&nbsp;case&nbsp;I&amp;#39;d&nbsp;really,&nbsp;really&nbsp;prefer&nbsp;to:&lt;br&gt;<br>
-&nbsp;create&nbsp;an&nbsp;enum&nbsp;with&nbsp;all&nbsp;the&nbsp;&amp;quot;thunk&nbsp;categories&amp;quot;&nbsp;above,&lt;br&gt;<br>
-&nbsp;add&nbsp;it&nbsp;as&nbsp;a&nbsp;parameter&nbsp;to&nbsp;&amp;quot;mono_code_manager_reserve*&amp;quot;&nbsp;functions,&nbsp;and&lt;br&gt;<br>
-&nbsp;call&nbsp;the&nbsp;new&nbsp;profiler&nbsp;API&nbsp;from&nbsp;there.&lt;br&gt;<br>
This&nbsp;will&nbsp;make&nbsp;the&nbsp;code&nbsp;more&nbsp;compact&nbsp;(without&nbsp;those&nbsp;70+&nbsp;calls&nbsp;to&lt;br&gt;<br>
profiler&nbsp;APIs&nbsp;scattered&nbsp;around),&nbsp;will&nbsp;make&nbsp;sure&nbsp;I&nbsp;don&amp;#39;t&nbsp;miss&nbsp;any&nbsp;spot,&lt;br&gt;<br>
and&nbsp;(most&nbsp;important)&nbsp;will&nbsp;make&nbsp;sure&nbsp;that&nbsp;future&nbsp;code&nbsp;maintenance&nbsp;will&lt;br&gt;<br>
not&nbsp;forget&nbsp;to&nbsp;call&nbsp;the&nbsp;profiler&nbsp;API&nbsp;as&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;before&nbsp;doing&nbsp;that&nbsp;I&nbsp;wanted&nbsp;to&nbsp;know&nbsp;if&nbsp;changing&nbsp;the&nbsp;code&nbsp;manager&nbsp;API&lt;br&gt;<br>
was&nbsp;OK...&lt;br&gt;<br>
&lt;br&gt;<br>
Ciao,&lt;br&gt;<br>
&nbsp;&amp;nbsp;Massi&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;br&gt;You&nbsp;can&nbsp;change&nbsp;the&nbsp;codeman&nbsp;API&nbsp;in&nbsp;non&nbsp;breaking&nbsp;ways,&nbsp;if&nbsp;necessary.&nbsp;By&nbsp;making&nbsp;the&nbsp;&lt;br&gt;current&nbsp;allocation&nbsp;function&nbsp;tell&nbsp;the&nbsp;profiler&nbsp;that&nbsp;these&nbsp;are&nbsp;unknown&nbsp;blocks.&nbsp;I&nbsp;like&amp;nbsp;&nbsp;this&nbsp;solution&lt;br&gt;as&nbsp;it&nbsp;would&nbsp;make&nbsp;changes&nbsp;more&nbsp;incremental.&lt;br&gt;<br>
&lt;br&gt;Using&nbsp;an&nbsp;enum&nbsp;to&nbsp;encode&nbsp;the&nbsp;kind&nbsp;of&nbsp;thunk&nbsp;has&nbsp;the&nbsp;advantage&nbsp;of&nbsp;been&nbsp;easier&nbsp;to&nbsp;encode&nbsp;in&lt;br&gt;a&nbsp;more&nbsp;compressed&nbsp;way,&nbsp;but&nbsp;reduces&nbsp;the&nbsp;report&nbsp;precision&nbsp;of&nbsp;what&nbsp;is&nbsp;been&nbsp;hit.&nbsp;For&nbsp;instance,&nbsp;it&lt;br&gt;would&nbsp;make&nbsp;harder&nbsp;to&nbsp;detect&nbsp;if&nbsp;we&nbsp;have&nbsp;long&nbsp;IMT&nbsp;thunks&nbsp;on&nbsp;a&nbsp;hot&nbsp;code&nbsp;path.&nbsp;On&nbsp;the&nbsp;other&lt;br&gt;<br>
hand,&nbsp;a&nbsp;lot&nbsp;of&nbsp;information&nbsp;can&nbsp;be&nbsp;extracted&nbsp;from&nbsp;call&nbsp;chains&nbsp;and&nbsp;it&nbsp;might&nbsp;be&nbsp;just&nbsp;enough.&lt;br&gt;&lt;br&gt;I&nbsp;believe&nbsp;that&nbsp;using&nbsp;an&nbsp;enum&nbsp;is&nbsp;enough&nbsp;for&nbsp;all&nbsp;use&nbsp;cases&nbsp;I&nbsp;have,&nbsp;as&nbsp;the&nbsp;other&nbsp;information&nbsp;I&nbsp;can&lt;br&gt;derive&nbsp;from&nbsp;call&nbsp;chain.&nbsp;I&nbsp;would&nbsp;be&nbsp;nice&nbsp;to&nbsp;hear&nbsp;from&nbsp;others&nbsp;about&nbsp;this&nbsp;subject,&nbsp;thou.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;br&gt;Rodrigo&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;
</tt>
