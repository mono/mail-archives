Index: ChangeLog
===================================================================
--- ChangeLog	(revision 93328)
+++ ChangeLog	(working copy)
@@ -1,3 +1,8 @@
+2008-01-19  Joshua Tauberer  <jit@occams.info>
+
+	* src/Mono.WebServer/BaseRequestBroker.cs: Read: Check the request
+	  ID is valid inside the lock.
+
 2007-12-12  Marek Habersack  <mhabersack@novell.com>
 
 	* test/1.1/handlers/monodoc.ashx: fix the rendering of
Index: src/Mono.WebServer/BaseRequestBroker.cs
===================================================================
--- src/Mono.WebServer/BaseRequestBroker.cs	(revision 93328)
+++ src/Mono.WebServer/BaseRequestBroker.cs	(working copy)
@@ -338,11 +338,12 @@
 		{
 			buffer = null;
 			
-			if (!ValidRequest (requestId))
-				return 0;
 			Worker w;
 
 			lock (reqlock) {
+				if (!ValidRequest (requestId))
+					return 0;
+
 				w = GetWorker (requestId);
 				if (w == null)
 					return 0;
