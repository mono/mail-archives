<tt>
Submit&nbsp;them&nbsp;separatedly,&nbsp;because&nbsp;the&nbsp;commits&nbsp;should&nbsp;be&nbsp;split&nbsp;anyway.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;please,&nbsp;don&amp;#39;t&nbsp;put&nbsp;the&nbsp;patch&nbsp;inline&nbsp;in&nbsp;the&nbsp;email&nbsp;body.&lt;div&gt;&lt;br&gt;Thanks,&lt;/div&gt;&lt;div&gt;Rodrigo&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
2009/11/1&nbsp;Kornél&nbsp;Pál&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:kornelpal@gmail.com&quot;&gt;kornelpal@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;I&nbsp;found&nbsp;out&nbsp;that&nbsp;reference&nbsp;counting&nbsp;in&nbsp;mono_image_close_except_pools&nbsp;was&nbsp;broken&nbsp;so&nbsp;I&nbsp;fixed&nbsp;that&nbsp;as&nbsp;well.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Double&nbsp;freeing&nbsp;was&nbsp;possible&nbsp;with&nbsp;mono_close_exe_image&nbsp;and&nbsp;I&nbsp;fixed&nbsp;that&nbsp;as&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;can&nbsp;submit&nbsp;these&nbsp;two&nbsp;separately,&nbsp;but&nbsp;the&nbsp;first&nbsp;one&nbsp;is&nbsp;required&nbsp;by&nbsp;mono_vtfixup_trampoline&nbsp;to&nbsp;function&nbsp;correctly.&lt;br&gt;<br>
&lt;br&gt;<br>
Kornél&lt;br&gt;<br>
&lt;br&gt;<br>
Kornél&nbsp;Pál&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Please&nbsp;see&nbsp;the&nbsp;attached&nbsp;patch&nbsp;that&nbsp;is&nbsp;a&nbsp;separated&nbsp;and&nbsp;improved&nbsp;version&lt;br&gt;<br>
of&nbsp;the&nbsp;prevously&nbsp;submitted&nbsp;patch.&lt;br&gt;<br>
&lt;br&gt;<br>
ChangeLog&nbsp;draft:&lt;br&gt;<br>
mono_image_fixup_vtable&nbsp;is&nbsp;now&nbsp;called&nbsp;only&nbsp;when&nbsp;the&nbsp;image&nbsp;is&nbsp;loaded&nbsp;and&lt;br&gt;<br>
creates&nbsp;trampolines&nbsp;rather&nbsp;than&nbsp;pointers&nbsp;to&nbsp;wrapper&nbsp;functions.&lt;br&gt;<br>
&lt;br&gt;<br>
A&nbsp;new&nbsp;trampoline&nbsp;type&nbsp;MONO_TRAMPOLINE_VTFIXUP&nbsp;is&nbsp;added&nbsp;that&nbsp;is&nbsp;created&lt;br&gt;<br>
by&nbsp;mono_image_fixup_vtable,&nbsp;and&nbsp;is&nbsp;replacing&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&lt;br&gt;<br>
trampoline&nbsp;with&nbsp;the&nbsp;result&nbsp;mono_marshal_get_vtfixup_ftnptr.&lt;br&gt;<br>
&lt;br&gt;<br>
Please&nbsp;review&nbsp;and&nbsp;if&nbsp;you&nbsp;like&nbsp;it,&nbsp;approve&nbsp;the&nbsp;patch.&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;Index:&nbsp;mono/mono/metadata/domain.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/domain.c&nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/domain.c&nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-1735,8&nbsp;+1735,10&nbsp;@@&lt;br&gt;<br>
 void&lt;br&gt;<br>
 mono_close_exe_image&nbsp;(void)&lt;br&gt;<br>
 {&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(exe_image)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(exe_image)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_image_close&nbsp;(exe_image);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;exe_image&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 /**&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/assembly.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/assembly.c&nbsp; &nbsp; &nbsp; &nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/assembly.c&nbsp; &nbsp; &nbsp; &nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-1522,11&nbsp;+1522,6&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; loaded_assemblies&nbsp;=&nbsp;g_list_prepend&nbsp;(loaded_assemblies,&nbsp;ass);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_assemblies_unlock&nbsp;();&lt;br&gt;<br>
&lt;br&gt;<br>
-#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;is_module_handle)&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(image);&lt;br&gt;<br>
-#endif&lt;br&gt;<br>
-&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_assembly_invoke_load_hook&nbsp;(ass);&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_profiler_assembly_loaded&nbsp;(ass,&nbsp;MONO_PROFILE_OK);&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/coree.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/coree.c&nbsp; (revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/coree.c&nbsp; (working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-106,20&nbsp;+106,12&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!image)&nbsp;{&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_free&nbsp;(file_name);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_free&nbsp;(file_name);&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!image)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;FALSE;&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *&nbsp;FIXME:&nbsp;Find&nbsp;a&nbsp;better&nbsp;way&nbsp;to&nbsp;call&nbsp;mono_image_fixup_vtable.&nbsp;Only&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *&nbsp;loader&nbsp;trampolines&nbsp;should&nbsp;be&nbsp;used&nbsp;and&nbsp;assembly&nbsp;loading&nbsp;should&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *&nbsp;probably&nbsp;be&nbsp;delayed&nbsp;until&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;an&nbsp;exported&nbsp;function.&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;tables&nbsp;[MONO_TABLE_ASSEMBLY].rows&nbsp;&amp;amp;&amp;amp;&nbsp;((MonoCLIImageInfo*)&nbsp;image-&amp;gt;image_info)-&amp;gt;cli_cli_header.ch_vtable_fixups.rva)&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;assembly&nbsp;=&nbsp;mono_assembly_open&nbsp;(file_name,&nbsp;NULL);&lt;br&gt;<br>
-&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_free&nbsp;(file_name);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(image);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; case&nbsp;DLL_PROCESS_DETACH:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(lpReserved&nbsp;!=&nbsp;NULL)&lt;br&gt;<br>
@@&nbsp;-198,6&nbsp;+190,8&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; argv&nbsp;[i]&nbsp;=&nbsp;g_utf16_to_utf8&nbsp;(argvw&nbsp;[i],&nbsp;-1,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; LocalFree&nbsp;(argvw);&lt;br&gt;<br>
&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(image);&lt;br&gt;<br>
+&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_runtime_run_main&nbsp;(method,&nbsp;argc,&nbsp;argv,&nbsp;NULL);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_thread_manage&nbsp;();&lt;br&gt;<br>
&lt;br&gt;<br>
@@&nbsp;-919,8&nbsp;+913,10&nbsp;@@&lt;br&gt;<br>
 void&lt;br&gt;<br>
 mono_fixup_exe_image&nbsp;(MonoImage*&nbsp;image)&lt;br&gt;<br>
 {&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!init_from_coree&nbsp;&amp;amp;&amp;amp;&nbsp;image&nbsp;&amp;amp;&amp;amp;&nbsp;image-&amp;gt;is_module_handle)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!init_from_coree&nbsp;&amp;amp;&amp;amp;&nbsp;image&nbsp;&amp;amp;&amp;amp;&nbsp;image-&amp;gt;is_module_handle)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MonoFixupExe&nbsp;((HMODULE)&nbsp;image-&amp;gt;raw_data);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(image);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 #endif&nbsp;/*&nbsp;PLATFORM_WIN32&nbsp;*/&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/object.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/object.c&nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/object.c&nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-470,10&nbsp;+470,18&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;NULL;&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
+static&nbsp;gpointer&lt;br&gt;<br>
+default_vtfixup_trampoline&nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;g_assert_not_reached&nbsp;();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;NULL;&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
 static&nbsp;MonoTrampoline&nbsp;arch_create_jit_trampoline&nbsp;=&nbsp;default_trampoline;&lt;br&gt;<br>
 static&nbsp;MonoJumpTrampoline&nbsp;arch_create_jump_trampoline&nbsp;=&nbsp;default_jump_trampoline;&lt;br&gt;<br>
 static&nbsp;MonoRemotingTrampoline&nbsp;arch_create_remoting_trampoline&nbsp;=&nbsp;default_remoting_trampoline;&lt;br&gt;<br>
 static&nbsp;MonoDelegateTrampoline&nbsp;arch_create_delegate_trampoline&nbsp;=&nbsp;default_delegate_trampoline;&lt;br&gt;<br>
+static&nbsp;MonoVTFixupTrampoline&nbsp;arch_create_vtfixup_trampoline&nbsp;=&nbsp;default_vtfixup_trampoline;&lt;br&gt;<br>
 static&nbsp;MonoImtThunkBuilder&nbsp;imt_thunk_builder&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
 #define&nbsp;ARCH_USE_IMT&nbsp;(imt_thunk_builder&nbsp;!=&nbsp;NULL)&lt;br&gt;<br>
 #if&nbsp;(MONO_IMT_SIZE&nbsp;&amp;gt;&nbsp;32)&lt;br&gt;<br>
@@&nbsp;-517,6&nbsp;+525,12&nbsp;@@&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 void&lt;br&gt;<br>
+mono_install_vtfixup_trampoline&nbsp;(MonoVTFixupTrampoline&nbsp;func)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;arch_create_vtfixup_trampoline&nbsp;=&nbsp;func?&nbsp;func:&nbsp;default_vtfixup_trampoline;&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
+void&lt;br&gt;<br>
 mono_install_imt_thunk_builder&nbsp;(MonoImtThunkBuilder&nbsp;func)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; imt_thunk_builder&nbsp;=&nbsp;func;&lt;br&gt;<br>
 }&lt;br&gt;<br>
@@&nbsp;-564,6&nbsp;+578,12&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;arch_create_delegate_trampoline&nbsp;(klass);&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
+gpointer&lt;br&gt;<br>
+mono_runtime_create_vtfixup_trampoline&nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;arch_create_vtfixup_trampoline&nbsp;(slot,&nbsp;image,&nbsp;token,&nbsp;type);&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
 static&nbsp;MonoFreeMethodFunc&nbsp;default_mono_free_method&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
&lt;br&gt;<br>
 /**&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/class-internals.h&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/class-internals.h&nbsp; &nbsp; &nbsp; &nbsp; (revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/class-internals.h&nbsp; &nbsp; &nbsp; &nbsp; (working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-803,6&nbsp;+803,7&nbsp;@@&lt;br&gt;<br>
 typedef&nbsp;gpointer&nbsp;(*MonoJumpTrampoline)&nbsp; &nbsp; &nbsp; &nbsp;(MonoDomain&nbsp;*domain,&nbsp;MonoMethod&nbsp;*method,&nbsp;gboolean&nbsp;add_sync_wrapper);&lt;br&gt;<br>
 typedef&nbsp;gpointer&nbsp;(*MonoRemotingTrampoline)&nbsp; &nbsp; &nbsp; &nbsp;(MonoDomain&nbsp;*domain,&nbsp;MonoMethod&nbsp;*method,&nbsp;MonoRemotingTarget&nbsp;target);&lt;br&gt;<br>
 typedef&nbsp;gpointer&nbsp;(*MonoDelegateTrampoline)&nbsp; &nbsp; &nbsp; &nbsp;(MonoClass&nbsp;*klass);&lt;br&gt;<br>
+typedef&nbsp;gpointer&nbsp;(*MonoVTFixupTrampoline)&nbsp; &nbsp; &nbsp; &nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type);&lt;br&gt;<br>
&lt;br&gt;<br>
 typedef&nbsp;gpointer&nbsp;(*MonoLookupDynamicToken)&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;gboolean&nbsp;valid_token,&nbsp;MonoClass&nbsp;**handle_class,&nbsp;MonoGenericContext&nbsp;*context);&lt;br&gt;<br>
&lt;br&gt;<br>
@@&nbsp;-892,6&nbsp;+893,9&nbsp;@@&lt;br&gt;<br>
 void&lt;br&gt;<br>
 mono_install_delegate_trampoline&nbsp;(MonoDelegateTrampoline&nbsp;func)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
+void&lt;br&gt;<br>
+mono_install_vtfixup_trampoline&nbsp;(MonoVTFixupTrampoline&nbsp;func)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
+&lt;br&gt;<br>
 gpointer&lt;br&gt;<br>
 mono_lookup_dynamic_token&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;MonoGenericContext&nbsp;*context)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
@@&nbsp;-907,6&nbsp;+911,9&nbsp;@@&lt;br&gt;<br>
 gpointer&lt;br&gt;<br>
 mono_runtime_create_delegate_trampoline&nbsp;(MonoClass&nbsp;*klass)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
+gpointer&lt;br&gt;<br>
+mono_runtime_create_vtfixup_trampoline&nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
+&lt;br&gt;<br>
 void&lt;br&gt;<br>
 mono_install_get_cached_class_info&nbsp;(MonoGetCachedClassInfo&nbsp;func)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/image.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/image.c&nbsp; (revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/image.c&nbsp; (working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-572,10&nbsp;+572,6&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(image-&amp;gt;modules&nbsp;[idx&nbsp;-&nbsp;1])&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_image_addref&nbsp;(image-&amp;gt;modules&nbsp;[idx&nbsp;-&nbsp;1]);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; image-&amp;gt;modules&nbsp;[idx&nbsp;-&nbsp;1]-&amp;gt;assembly&nbsp;=&nbsp;image-&amp;gt;assembly;&lt;br&gt;<br>
-#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;modules&nbsp;[idx&nbsp;-&nbsp;1]-&amp;gt;is_module_handle)&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(image-&amp;gt;modules&nbsp;[idx&nbsp;-&nbsp;1]);&lt;br&gt;<br>
-#endif&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*&nbsp;g_print&nbsp;(&amp;quot;loaded&nbsp;module&nbsp;%s&nbsp;from&nbsp;%s&nbsp;(%p)\n&amp;quot;,&nbsp;module_ref,&nbsp;image-&amp;gt;name,&nbsp;image-&amp;gt;assembly);&nbsp;*/&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g_free&nbsp;(module_ref);&lt;br&gt;<br>
@@&nbsp;-1292,7&nbsp;+1288,6&nbsp;@@&lt;br&gt;<br>
 void&lt;br&gt;<br>
 mono_image_fixup_vtable&nbsp;(MonoImage&nbsp;*image)&lt;br&gt;<br>
 {&lt;br&gt;<br>
-#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MonoCLIImageInfo&nbsp;*iinfo;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MonoPEDirEntry&nbsp;*de;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MonoVTableFixup&nbsp;*vtfixup;&lt;br&gt;<br>
@@&nbsp;-1301,7&nbsp;+1296,10&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; guint16&nbsp;slot_type;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp;slot_count;&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;g_assert&nbsp;(image-&amp;gt;is_module_handle);&lt;br&gt;<br>
+#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!image-&amp;gt;is_module_handle)&lt;br&gt;<br>
+#endif&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_assert_not_reached();&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; iinfo&nbsp;=&nbsp;image-&amp;gt;image_info;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; de&nbsp;=&nbsp;&amp;amp;iinfo-&amp;gt;cli_cli_header.ch_vtable_fixups;&lt;br&gt;<br>
@@&nbsp;-1310,7&nbsp;+1308,7&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; vtfixup&nbsp;=&nbsp;(MonoVTableFixup*)&nbsp;mono_image_rva_map&nbsp;(image,&nbsp;de-&amp;gt;rva);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(!vtfixup)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;&lt;br&gt;<br>
-&lt;br&gt;<br>
+&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; count&nbsp;=&nbsp;de-&amp;gt;size&nbsp;/&nbsp;sizeof&nbsp;(MonoVTableFixup);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; while&nbsp;(count--)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(!vtfixup-&amp;gt;rva&nbsp;||&nbsp;!vtfixup-&amp;gt;count)&lt;br&gt;<br>
@@&nbsp;-1320,24&nbsp;+1318,26&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g_assert&nbsp;(slot);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_type&nbsp;=&nbsp;vtfixup-&amp;gt;type;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_count&nbsp;=&nbsp;vtfixup-&amp;gt;count;&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(slot_type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_32BIT)&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;switch&nbsp;(slot_type&nbsp;&amp;amp;&nbsp;(VTFIXUP_TYPE_32BIT&nbsp;|&nbsp;VTFIXUP_TYPE_64BIT))&nbsp;{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case&nbsp;VTFIXUP_TYPE_32BIT:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while&nbsp;(slot_count--)&nbsp;{&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*((guint32*)&nbsp;slot)&nbsp;=&nbsp;(guint32)&nbsp;mono_marshal_get_vtfixup_ftnptr&nbsp;(image,&nbsp;*((guint32*)&nbsp;slot),&nbsp;slot_type);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*((guint32*)&nbsp;slot)&nbsp;=&nbsp;(guint32)&nbsp;mono_runtime_create_vtfixup_trampoline&nbsp;(slot,&nbsp;image,&nbsp;*((guint32*)&nbsp;slot),&nbsp;slot_type);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot&nbsp;=&nbsp;((guint32*)&nbsp;slot)&nbsp;+&nbsp;1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else&nbsp;if&nbsp;(slot_type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_64BIT)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;case&nbsp;VTFIXUP_TYPE_64BIT:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while&nbsp;(slot_count--)&nbsp;{&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*((guint64*)&nbsp;slot)&nbsp;=&nbsp;(guint64)&nbsp;mono_marshal_get_vtfixup_ftnptr&nbsp;(image,&nbsp;*((guint64*)&nbsp;slot),&nbsp;slot_type);&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot&nbsp;=&nbsp;((guint32*)&nbsp;slot)&nbsp;+&nbsp;1;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*((guint64*)&nbsp;slot)&nbsp;=&nbsp;(guint64)&nbsp;mono_runtime_create_vtfixup_trampoline&nbsp;(slot,&nbsp;image,&nbsp;*((guint64*)&nbsp;slot),&nbsp;slot_type);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot&nbsp;=&nbsp;((guint64*)&nbsp;slot)&nbsp;+&nbsp;1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;break;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g_assert_not_reached();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vtfixup++;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
-#else&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;g_assert_not_reached();&lt;br&gt;<br>
-#endif&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 static&nbsp;void&lt;br&gt;<br>
@@&nbsp;-1424,6&nbsp;+1424,15&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;FALSE;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
+#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;is_module_handle&nbsp;&amp;amp;&amp;amp;&nbsp;image-&amp;gt;has_entry_point&nbsp;&amp;amp;&amp;amp;&nbsp;image-&amp;gt;ref_count&nbsp;==&nbsp;0)&nbsp;{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;Image&nbsp;will&nbsp;be&nbsp;closed&nbsp;by&nbsp;_CorDllMain.&nbsp;*/&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FreeLibrary&nbsp;((HMODULE)&nbsp;image-&amp;gt;raw_data);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_unlock&nbsp;();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;FALSE;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
+#endif&lt;br&gt;<br>
+&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; loaded_images&nbsp;=&nbsp;image-&amp;gt;ref_only&nbsp;?&nbsp;loaded_images_refonly_hash&nbsp;:&nbsp;loaded_images_hash;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; image2&nbsp;=&nbsp;g_hash_table_lookup&nbsp;(loaded_images,&nbsp;image-&amp;gt;name);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(image&nbsp;==&nbsp;image2)&nbsp;{&lt;br&gt;<br>
@@&nbsp;-1435,19&nbsp;+1444,6&nbsp;@@&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_images_unlock&nbsp;();&lt;br&gt;<br>
&lt;br&gt;<br>
-#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;is_module_handle&nbsp;&amp;amp;&amp;amp;&nbsp;image-&amp;gt;has_entry_point)&nbsp;{&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_lock&nbsp;();&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;ref_count&nbsp;==&nbsp;0)&nbsp;{&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;Image&nbsp;will&nbsp;be&nbsp;closed&nbsp;by&nbsp;_CorDllMain.&nbsp;*/&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FreeLibrary&nbsp;((HMODULE)&nbsp;image-&amp;gt;raw_data);&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_unlock&nbsp;();&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;FALSE;&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_unlock&nbsp;();&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
-#endif&lt;br&gt;<br>
-&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_profiler_module_event&nbsp;(image,&nbsp;MONO_PROFILE_START_UNLOAD);&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_trace&nbsp;(G_LOG_LEVEL_INFO,&nbsp;MONO_TRACE_ASSEMBLY,&nbsp;&amp;quot;Unloading&nbsp;image&nbsp;%s&nbsp;[%p].&amp;quot;,&nbsp;image-&amp;gt;name,&nbsp;image);&lt;br&gt;<br>
@@&nbsp;-1477,10&nbsp;+1473,11&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
 #ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;mono_images_lock&nbsp;();&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;is_module_handle&nbsp;&amp;amp;&amp;amp;&nbsp;!image-&amp;gt;has_entry_point)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(image-&amp;gt;is_module_handle&nbsp;&amp;amp;&amp;amp;&nbsp;!image-&amp;gt;has_entry_point)&nbsp;{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_lock&nbsp;();&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FreeLibrary&nbsp;((HMODULE)&nbsp;image-&amp;gt;raw_data);&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;mono_images_unlock&nbsp;();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_images_unlock&nbsp;();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 #endif&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;(image-&amp;gt;raw_buffer_used)&nbsp;{&lt;br&gt;<br>
@@&nbsp;-1926,10&nbsp;+1923,6&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; image-&amp;gt;files&nbsp;[fileidx&nbsp;-&nbsp;1]&nbsp;=&nbsp;res;&lt;br&gt;<br>
-#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(res-&amp;gt;is_module_handle)&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_fixup_vtable&nbsp;(res);&lt;br&gt;<br>
-#endif&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_loader_unlock&nbsp;();&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; g_free&nbsp;(name);&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/marshal.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/marshal.c&nbsp; &nbsp; &nbsp; &nbsp; (revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/marshal.c&nbsp; &nbsp; &nbsp; &nbsp; (working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-8591,7&nbsp;+8591,7&nbsp;@@&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 gpointer&lt;br&gt;<br>
-mono_marshal_get_vtfixup_ftnptr&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&lt;br&gt;<br>
+mono_marshal_get_vtfixup_ftnptr&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type,&nbsp;MonoMethod&nbsp;**wrapper_method)&lt;br&gt;<br>
 {&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MonoMethod&nbsp;*method;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MonoMethodSignature&nbsp;*sig;&lt;br&gt;<br>
@@&nbsp;-8641,9&nbsp;+8641,15&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_metadata_free_marshal_spec&nbsp;(mspecs&nbsp;[i]);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; g_free&nbsp;(mspecs);&lt;br&gt;<br>
&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*wrapper_method&nbsp;=&nbsp;method;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;mono_compile_method&nbsp;(method);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!(type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_CALL_MOST_DERIVED))&nbsp;{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;wrapper_method&nbsp;=&nbsp;NULL;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;mono_compile_method&nbsp;(method);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
+&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; sig&nbsp;=&nbsp;mono_method_signature&nbsp;(method);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mb&nbsp;=&nbsp;mono_mb_new&nbsp;(method-&amp;gt;klass,&nbsp;method-&amp;gt;name,&nbsp;MONO_WRAPPER_MANAGED_TO_MANAGED);&lt;br&gt;<br>
&lt;br&gt;<br>
@@&nbsp;-8651,16&nbsp;+8657,14&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;param_count;&nbsp;i++)&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_mb_emit_ldarg&nbsp;(mb,&nbsp;i);&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_CALL_MOST_DERIVED)&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_mb_emit_op&nbsp;(mb,&nbsp;CEE_CALLVIRT,&nbsp;method);&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp;else&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_mb_emit_op&nbsp;(mb,&nbsp;CEE_CALL,&nbsp;method);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;mono_mb_emit_op&nbsp;(mb,&nbsp;CEE_CALLVIRT,&nbsp;method);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_RET);&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mb-&amp;gt;dynamic&nbsp;=&nbsp;1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; method&nbsp;=&nbsp;mono_mb_create_method&nbsp;(mb,&nbsp;sig,&nbsp;param_count);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_mb_free&nbsp;(mb);&lt;br&gt;<br>
&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*wrapper_method&nbsp;=&nbsp;method;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;mono_compile_method&nbsp;(method);&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/marshal.h&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/marshal.h&nbsp; &nbsp; &nbsp; &nbsp; (revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/marshal.h&nbsp; &nbsp; &nbsp; &nbsp; (working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-199,7&nbsp;+199,7&nbsp;@@&lt;br&gt;<br>
 mono_marshal_get_managed_wrapper&nbsp;(MonoMethod&nbsp;*method,&nbsp;MonoClass&nbsp;*delegate_klass,&nbsp;MonoObject&nbsp;**this_loc)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
 gpointer&lt;br&gt;<br>
-mono_marshal_get_vtfixup_ftnptr&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
+mono_marshal_get_vtfixup_ftnptr&nbsp;(MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type,&nbsp;MonoMethod&nbsp;**wrapper_method)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
&lt;br&gt;<br>
 MonoMethod&nbsp;*&lt;br&gt;<br>
 mono_marshal_get_icall_wrapper&nbsp;(MonoMethodSignature&nbsp;*sig,&nbsp;const&nbsp;char&nbsp;*name,&nbsp;gconstpointer&nbsp;func,&nbsp;gboolean&nbsp;check_exceptions)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
Index:&nbsp;mono/mono/mini/mini.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/mini/mini.c&nbsp; &nbsp; &nbsp; &nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/mini/mini.c&nbsp; &nbsp; &nbsp; &nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-5058,6&nbsp;+5058,7&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_install_jump_trampoline&nbsp;(mono_create_jump_trampoline);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_install_remoting_trampoline&nbsp;(mono_jit_create_remoting_trampoline);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_install_delegate_trampoline&nbsp;(mono_create_delegate_trampoline);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;mono_install_vtfixup_trampoline&nbsp;(mono_create_vtfixup_trampoline);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_install_create_domain_hook&nbsp;(mini_create_jit_domain_info);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_install_free_domain_hook&nbsp;(mini_free_jit_domain_info);&lt;br&gt;<br>
 #endif&lt;br&gt;<br>
Index:&nbsp;mono/mono/mini/mini.h&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/mini/mini.h&nbsp; &nbsp; &nbsp; &nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/mini/mini.h&nbsp; &nbsp; &nbsp; &nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-827,6&nbsp;+827,7&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MONO_TRAMPOLINE_MONITOR_ENTER,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MONO_TRAMPOLINE_MONITOR_EXIT,&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;MONO_TRAMPOLINE_VTFIXUP,&lt;br&gt;<br>
 #ifdef&nbsp;ENABLE_LLVM&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; MONO_TRAMPOLINE_LLVM_VCALL,&lt;br&gt;<br>
 #endif&lt;br&gt;<br>
@@&nbsp;-1482,6&nbsp;+1483,7&nbsp;@@&lt;br&gt;<br>
 gpointer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_create_monitor_enter_trampoline&nbsp;(void)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
 gpointer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_create_monitor_exit_trampoline&nbsp;(void)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
 gpointer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_create_static_rgctx_trampoline&nbsp;(MonoMethod&nbsp;*m,&nbsp;gpointer&nbsp;addr)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
+gpointer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_create_vtfixup_trampoline&nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
 gpointer&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mono_create_llvm_vcall_trampoline&nbsp;(MonoMethod&nbsp;*method)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
 MonoVTable*&nbsp; &nbsp; &nbsp; &nbsp;mono_find_class_init_trampoline_by_addr&nbsp;(gconstpointer&nbsp;addr)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
 guint32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_find_rgctx_lazy_fetch_trampoline_by_addr&nbsp;(gconstpointer&nbsp;addr)&nbsp;MONO_INTERNAL;&lt;br&gt;<br>
Index:&nbsp;mono/mono/mini/mini-trampolines.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/mini/mini-trampolines.c&nbsp; &nbsp;(revision&nbsp;145149)&lt;br&gt;<br>
+++&nbsp;mono/mono/mini/mini-trampolines.c&nbsp; &nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-6,6&nbsp;+6,8&nbsp;@@&lt;br&gt;<br>
 #include&nbsp;&amp;lt;mono/metadata/metadata-internals.h&amp;gt;&lt;br&gt;<br>
 #include&nbsp;&amp;lt;mono/metadata/marshal.h&amp;gt;&lt;br&gt;<br>
 #include&nbsp;&amp;lt;mono/metadata/tabledefs.h&amp;gt;&lt;br&gt;<br>
+#include&nbsp;&amp;lt;mono/metadata/assembly.h&amp;gt;&lt;br&gt;<br>
+#include&nbsp;&amp;lt;mono/metadata/cil-coff.h&amp;gt;&lt;br&gt;<br>
 #include&nbsp;&amp;lt;mono/utils/mono-counters.h&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
 #ifdef&nbsp;HAVE_VALGRIND_MEMCHECK_H&lt;br&gt;<br>
@@&nbsp;-779,6&nbsp;+781,67&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_monitor_exit&nbsp;(obj);&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
+static&nbsp;gpointer&lt;br&gt;<br>
+mono_vtfixup_trampoline&nbsp;(gssize&nbsp;*regs,&nbsp;guint8&nbsp;*code,&nbsp;guint8&nbsp;*slot_info,&nbsp;guint8*&nbsp;tramp)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;gpointer&nbsp;tramp_addr;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;gpointer&nbsp;slot,&nbsp;slot_addr;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;MonoImage&nbsp;*image;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;guint32&nbsp;token;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;guint16&nbsp;type;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;gpointer&nbsp;addr;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;MonoMethod&nbsp;*wrapper_method;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;MonoImageOpenStatus&nbsp;status;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;tramp_addr&nbsp;=&nbsp;*((gpointer*)&nbsp;(gpointer)&nbsp;slot_info);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;slot_info&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;slot&nbsp;=&nbsp;*((gpointer*)&nbsp;(gpointer)&nbsp;slot_info);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;slot_info&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;image&nbsp;=&nbsp;*((gpointer*)&nbsp;(gpointer)&nbsp;slot_info);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;slot_info&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;token&nbsp;=&nbsp;*((guint32*)&nbsp;(gpointer)&nbsp;slot_info);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;slot_info&nbsp;+=&nbsp;sizeof&nbsp;(guint32);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;type&nbsp;=&nbsp;*((guint16*)&nbsp;(gpointer)&nbsp;slot_info);&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_64BIT)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot_addr&nbsp;=&nbsp;(gpointer)&nbsp;*((volatile&nbsp;gint64*)&nbsp;(slot));&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;else&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot_addr&nbsp;=&nbsp;(gpointer)&nbsp;*((volatile&nbsp;gint32*)&nbsp;(slot));&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(slot_addr&nbsp;!=&nbsp;tramp_addr)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;slot_addr;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(!image-&amp;gt;assembly)&nbsp;{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;Open&nbsp;image&nbsp;to&nbsp;increment&nbsp;LoadLibrary&nbsp;reference&nbsp;count&nbsp;*/&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_assert&nbsp;(image&nbsp;==&nbsp;mono_image_open_full&nbsp;(image-&amp;gt;name,&nbsp;NULL,&nbsp;FALSE));&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;FIXME:&nbsp;Throw&nbsp;exceptions&nbsp;when&nbsp;assembly&nbsp;cannot&nbsp;be&nbsp;loaded&nbsp;*/&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;FIXME:&nbsp;Fix&nbsp;mono_assembly_load_from_full&nbsp;to&nbsp;allow&nbsp;loading&nbsp;mscorlib.dll&nbsp;*/&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;g_assert&nbsp;(mono_assembly_load_from_full&nbsp;(image,&nbsp;image-&amp;gt;name,&nbsp;&amp;amp;status,&nbsp;FALSE));&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/*&nbsp;Release&nbsp;temporary&nbsp;reference&nbsp;*/&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_image_close&nbsp;(image);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;addr&nbsp;=&nbsp;mono_marshal_get_vtfixup_ftnptr&nbsp;(image,&nbsp;token,&nbsp;type,&nbsp;&amp;amp;wrapper_method);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(type&nbsp;&amp;amp;&nbsp;VTFIXUP_TYPE_64BIT)&lt;br&gt;<br>
+#if&nbsp;SIZEOF_VOID_P&nbsp;==&nbsp;8&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot_addr&nbsp;=&nbsp;InterlockedCompareExchangePointer&nbsp;(slot,&nbsp;addr,&nbsp;tramp_addr);&lt;br&gt;<br>
+#else&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot_addr&nbsp;=&nbsp;(gpointer)&nbsp;ves_icall_System_Threading_Interlocked_CompareExchange_Long&nbsp;((gint64*)&nbsp;slot,&nbsp;(gint64)&nbsp;addr,&nbsp;(gint64)&nbsp;tramp_addr);&lt;br&gt;<br>
+#endif&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;else&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;slot_addr&nbsp;=&nbsp;(gpointer)&nbsp;InterlockedCompareExchange&nbsp;((gint32*)&nbsp;slot,&nbsp;(gint32)&nbsp;addr,&nbsp;(gint32)&nbsp;tramp_addr);&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(slot_addr&nbsp;==&nbsp;tramp_addr)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;addr;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(wrapper_method)&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mono_free_method&nbsp;(wrapper_method);&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;slot_addr;&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
 #ifdef&nbsp;MONO_ARCH_HAVE_CREATE_DELEGATE_TRAMPOLINE&lt;br&gt;<br>
&lt;br&gt;<br>
 /**&lt;br&gt;<br>
@@&nbsp;-922,6&nbsp;+985,8&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;mono_monitor_enter_trampoline;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; case&nbsp;MONO_TRAMPOLINE_MONITOR_EXIT:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;mono_monitor_exit_trampoline;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;case&nbsp;MONO_TRAMPOLINE_VTFIXUP:&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;mono_vtfixup_trampoline;&lt;br&gt;<br>
 #ifdef&nbsp;ENABLE_LLVM&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; case&nbsp;MONO_TRAMPOLINE_LLVM_VCALL:&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;mono_llvm_vcall_trampoline;&lt;br&gt;<br>
@@&nbsp;-956,6&nbsp;+1021,7&nbsp;@@&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_trampoline_code&nbsp;[MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING]&nbsp;=&nbsp;mono_arch_create_trampoline_code&nbsp;(MONO_TRAMPOLINE_GENERIC_VIRTUAL_REMOTING);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_trampoline_code&nbsp;[MONO_TRAMPOLINE_MONITOR_ENTER]&nbsp;=&nbsp;mono_arch_create_trampoline_code&nbsp;(MONO_TRAMPOLINE_MONITOR_ENTER);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_trampoline_code&nbsp;[MONO_TRAMPOLINE_MONITOR_EXIT]&nbsp;=&nbsp;mono_arch_create_trampoline_code&nbsp;(MONO_TRAMPOLINE_MONITOR_EXIT);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;mono_trampoline_code&nbsp;[MONO_TRAMPOLINE_VTFIXUP]&nbsp;=&nbsp;mono_arch_create_trampoline_code&nbsp;(MONO_TRAMPOLINE_VTFIXUP);&lt;br&gt;<br>
 #ifdef&nbsp;ENABLE_LLVM&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; mono_trampoline_code&nbsp;[MONO_TRAMPOLINE_LLVM_VCALL]&nbsp;=&nbsp;mono_arch_create_trampoline_code&nbsp;(MONO_TRAMPOLINE_LLVM_VCALL);&lt;br&gt;<br>
 #endif&lt;br&gt;<br>
@@&nbsp;-1280,7&nbsp;+1346,31&nbsp;@@&lt;br&gt;<br>
 #endif&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;code;&lt;br&gt;<br>
 }&lt;br&gt;<br>
-&lt;br&gt;<br>
+&lt;br&gt;<br>
+gpointer&lt;br&gt;<br>
+mono_create_vtfixup_trampoline&nbsp;(gpointer&nbsp;slot,&nbsp;MonoImage&nbsp;*image,&nbsp;guint32&nbsp;token,&nbsp;guint16&nbsp;type)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;gpointer&nbsp;tramp;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;MonoDomain&nbsp;*domain&nbsp;=&nbsp;mono_get_root_domain&nbsp;();&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;guint8&nbsp;*buf,&nbsp;*start;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;buf&nbsp;=&nbsp;start&nbsp;=&nbsp;mono_domain_code_reserve&nbsp;(domain,&nbsp;3&nbsp;*&nbsp;sizeof&nbsp;(gpointer)&nbsp;+&nbsp;sizeof&nbsp;(guint32)&nbsp;+&nbsp;sizeof&nbsp;(guint16));&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;buf&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*(gpointer*)&nbsp;(gpointer)&nbsp;buf&nbsp;=&nbsp;slot;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;buf&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*(gpointer*)&nbsp;(gpointer)&nbsp;buf&nbsp;=&nbsp;image;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;buf&nbsp;+=&nbsp;sizeof&nbsp;(gpointer);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*(guint32*)&nbsp;(gpointer)&nbsp;buf&nbsp;=&nbsp;token;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;buf&nbsp;+=&nbsp;sizeof&nbsp;(guint32);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*(guint16*)&nbsp;(gpointer)&nbsp;buf&nbsp;=&nbsp;type;&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;tramp&nbsp;=&nbsp;mono_create_specific_trampoline&nbsp;(start,&nbsp;MONO_TRAMPOLINE_VTFIXUP,&nbsp;domain,&nbsp;NULL);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;*(gpointer*)&nbsp;(gpointer)&nbsp;start&nbsp;=&nbsp;tramp;&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;tramp;&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
 #ifdef&nbsp;ENABLE_LLVM&lt;br&gt;<br>
 /*&lt;br&gt;<br>
&nbsp; *&nbsp;mono_create_llvm_vcall_trampoline:&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
