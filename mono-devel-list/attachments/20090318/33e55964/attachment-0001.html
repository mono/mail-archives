<tt>
Working&nbsp;on&nbsp;this&nbsp;one&nbsp;now.&lt;br&gt;&lt;br&gt;Thanks!&lt;br&gt;&lt;br&gt;Alan.&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Mar&nbsp;16,&nbsp;2009&nbsp;at&nbsp;7:21&nbsp;PM,&nbsp;Yves&nbsp;Dhondt&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:yves.dhondt@gmail.com&quot;&gt;yves.dhondt@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Issue:&lt;br&gt;<br>
-------&lt;br&gt;<br>
ZipPackagePart.GetStreamCore&nbsp;in&nbsp;System.IO.Packaging&nbsp;does&nbsp;not&nbsp;handle&lt;br&gt;<br>
Filemode&nbsp;mode&nbsp;input&nbsp;parameter&nbsp;(correctly).&lt;br&gt;<br>
&lt;br&gt;<br>
Test&nbsp;program&nbsp;(requires&nbsp;an&nbsp;existing&nbsp;openxml&nbsp;document,&nbsp;for&nbsp;example&lt;br&gt;<br>
test.docx&nbsp;as&nbsp;input):&lt;br&gt;<br>
-------------------&lt;br&gt;<br>
I&amp;#39;m&nbsp;not&nbsp;that&nbsp;good&nbsp;with&nbsp;unit&nbsp;testing,&nbsp;but&nbsp;the&nbsp;following&nbsp;code&nbsp;should&nbsp;be&lt;br&gt;<br>
easily&nbsp;translated&nbsp;into&nbsp;4&nbsp;tests.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
using&nbsp;System;&lt;br&gt;<br>
using&nbsp;System.IO;&lt;br&gt;<br>
using&nbsp;System.IO.Packaging;&lt;br&gt;<br>
&lt;br&gt;<br>
namespace&nbsp;MonoOpenXmlExperiment&lt;br&gt;<br>
{&lt;br&gt;<br>
 &nbsp;class&nbsp;Program&lt;br&gt;<br>
 &nbsp;{&lt;br&gt;<br>
   &nbsp;static&nbsp;void&nbsp;Main(string[]&nbsp;args)&lt;br&gt;<br>
   &nbsp;{&lt;br&gt;<br>
     &nbsp;//&nbsp;Warning&nbsp;do&nbsp;this&nbsp;with&nbsp;a&nbsp;document&nbsp;which&nbsp;can&nbsp;be&nbsp;damaged!!!&lt;br&gt;<br>
     &nbsp;Package&nbsp;pack&nbsp;=&nbsp;Package.Open(args[0]);&lt;br&gt;<br>
     &nbsp;PackagePart&nbsp;part&nbsp;=&nbsp;pack.CreatePart(new&nbsp;Uri(&amp;quot;/somepart.xml&amp;quot;,&lt;br&gt;<br>
UriKind.Relative),&nbsp;&amp;quot;application/xml&amp;quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;try&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;Stream&nbsp;s2&nbsp;=&nbsp;part.GetStream(FileMode.CreateNew,&nbsp;FileAccess.Write);&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
     &nbsp;catch&nbsp;(Exception&nbsp;ex)&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;//&nbsp;An&nbsp;ArgumentException&nbsp;should&nbsp;be&nbsp;throw&nbsp;as&nbsp;CreateNew&nbsp;is&nbsp;an&lt;br&gt;<br>
unsupported&nbsp;mode.&lt;br&gt;<br>
       &nbsp;Console.WriteLine(&amp;quot;Expected&nbsp;ArgumentException,&nbsp;got&nbsp;{0}.&amp;quot;,&lt;br&gt;<br>
ex.GetType().ToString());&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;try&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;Stream&nbsp;s3&nbsp;=&nbsp;part.GetStream(FileMode.Truncate,&nbsp;FileAccess.Write);&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
     &nbsp;catch&nbsp;(Exception&nbsp;ex)&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;//&nbsp;An&nbsp;ArgumentException&nbsp;should&nbsp;be&nbsp;throw&nbsp;as&nbsp;Truncate&nbsp;is&nbsp;an&lt;br&gt;<br>
unsupported&nbsp;mode.&lt;br&gt;<br>
       &nbsp;Console.WriteLine(&amp;quot;Expected&nbsp;ArgumentException,&nbsp;got&nbsp;{0}.&amp;quot;,&lt;br&gt;<br>
ex.GetType().ToString());&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;try&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;Stream&nbsp;s4&nbsp;=&nbsp;part.GetStream(FileMode.Append,&nbsp;FileAccess.Write);&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
     &nbsp;catch&nbsp;(Exception&nbsp;ex)&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;//&nbsp;An&nbsp;ArgumentException&nbsp;should&nbsp;be&nbsp;throw&nbsp;as&nbsp;Append&nbsp;is&nbsp;an&lt;br&gt;<br>
unsupported&nbsp;mode.&lt;br&gt;<br>
       &nbsp;Console.WriteLine(&amp;quot;Expected&nbsp;ArgumentException,&nbsp;got&nbsp;{0}.&amp;quot;,&lt;br&gt;<br>
ex.GetType().ToString());&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;Stream&nbsp;s&nbsp;=&nbsp;part.GetStream(FileMode.OpenOrCreate,&nbsp;FileAccess.Write);&lt;br&gt;<br>
     &nbsp;StreamWriter&nbsp;sw&nbsp;=&nbsp;new&nbsp;StreamWriter(s);&lt;br&gt;<br>
     &nbsp;sw.Write(&amp;quot;&amp;lt;test&amp;gt;aaaaaaa&amp;lt;/test&amp;gt;&amp;quot;);&lt;br&gt;<br>
     &nbsp;sw.Flush();&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;Stream&nbsp;s5&nbsp;=&nbsp;part.GetStream(FileMode.Create,&nbsp;FileAccess.ReadWrite);&lt;br&gt;<br>
     &nbsp;StreamWriter&nbsp;sw2&nbsp;=&nbsp;new&nbsp;StreamWriter(s5);&lt;br&gt;<br>
     &nbsp;sw2.Write(&amp;quot;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;&amp;quot;);&lt;br&gt;<br>
     &nbsp;sw2.Flush();&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;//&nbsp;Verify&nbsp;that&nbsp;the&nbsp;part&nbsp;got&nbsp;overwritten&nbsp;correctly.&lt;br&gt;<br>
     &nbsp;Stream&nbsp;s6&nbsp;=&nbsp;part.GetStream();&lt;br&gt;<br>
     &nbsp;StreamReader&nbsp;sr&nbsp;=&nbsp;new&nbsp;StreamReader(s6);&lt;br&gt;<br>
     &nbsp;Console.WriteLine(&amp;quot;Expected&nbsp;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;,&nbsp;got&nbsp;{0}.&amp;quot;,&nbsp;sr.ReadToEnd());&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;pack.Close();&lt;br&gt;<br>
   &nbsp;}&lt;br&gt;<br>
 &nbsp;}&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Expected&nbsp;output:&lt;br&gt;<br>
------------------------&lt;br&gt;<br>
Expected&nbsp;ArgumentException,&nbsp;got&nbsp;System.ArgumentException.&lt;br&gt;<br>
Expected&nbsp;ArgumentException,&nbsp;got&nbsp;System.ArgumentException.&lt;br&gt;<br>
Expected&nbsp;ArgumentException,&nbsp;got&nbsp;System.ArgumentException.&lt;br&gt;<br>
Expected&nbsp;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;,&nbsp;got&nbsp;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;.&lt;br&gt;<br>
&lt;br&gt;<br>
Output&nbsp;currently&nbsp;given&nbsp;by&nbsp;mono:&lt;br&gt;<br>
---------------------------------------------&lt;br&gt;<br>
Expected&nbsp;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;,&nbsp;got&nbsp;&amp;lt;test&amp;gt;bbb&amp;lt;/test&amp;gt;.&lt;br&gt;<br>
&lt;br&gt;<br>
Remarks:&lt;br&gt;<br>
-------------&lt;br&gt;<br>
The&nbsp;last&nbsp;test&nbsp;is&nbsp;especially&nbsp;important&nbsp;as&nbsp;it&nbsp;indicates&nbsp;that&nbsp;a&nbsp;create&lt;br&gt;<br>
would&nbsp;only&nbsp;overwrite&nbsp;part&nbsp;of&nbsp;stream.&lt;br&gt;<br>
&lt;br&gt;<br>
Solution:&lt;br&gt;<br>
------------&lt;br&gt;<br>
Replace&nbsp;function&nbsp;by:&lt;br&gt;<br>
&lt;br&gt;<br>
protected&nbsp;override&nbsp;Stream&nbsp;GetStreamCore&nbsp;(FileMode&nbsp;mode,&nbsp;FileAccess&nbsp;access)&lt;br&gt;<br>
   &nbsp;{&lt;br&gt;<br>
     &nbsp;MemoryStream&nbsp;stream;&lt;br&gt;<br>
&lt;br&gt;<br>
     &nbsp;switch&nbsp;(mode)&lt;br&gt;<br>
     &nbsp;{&lt;br&gt;<br>
       &nbsp;case&nbsp;FileMode.CreateNew:&lt;br&gt;<br>
         &nbsp;throw&nbsp;new&nbsp;ArgumentException(&amp;quot;FileMode&nbsp;not&nbsp;supported&amp;quot;,&nbsp;&amp;quot;CreateNew&amp;quot;);&lt;br&gt;<br>
       &nbsp;case&nbsp;FileMode.Truncate:&lt;br&gt;<br>
         &nbsp;throw&nbsp;new&nbsp;ArgumentException(&amp;quot;FileMode&nbsp;not&nbsp;supported&amp;quot;,&nbsp;&amp;quot;Truncate&amp;quot;);&lt;br&gt;<br>
       &nbsp;case&nbsp;FileMode.Append:&lt;br&gt;<br>
         &nbsp;throw&nbsp;new&nbsp;ArgumentException(&amp;quot;FileMode&nbsp;not&nbsp;supported&amp;quot;,&nbsp;&amp;quot;Append&amp;quot;);&lt;br&gt;<br>
       &nbsp;case&nbsp;FileMode.Open:&lt;br&gt;<br>
         &nbsp;if&nbsp;(Package.PartStreams.TryGetValue(Uri,&nbsp;out&nbsp;stream))&nbsp;{&lt;br&gt;<br>
           &nbsp;return&nbsp;new&nbsp;ZipPartStream(Package,&nbsp;stream,&nbsp;access);&lt;br&gt;<br>
         &nbsp;}&lt;br&gt;<br>
         &nbsp;else&nbsp;{&lt;br&gt;<br>
           &nbsp;throw&nbsp;new&nbsp;IOException();&nbsp;//&nbsp;Verify&nbsp;that&nbsp;this&nbsp;is&nbsp;the&lt;br&gt;<br>
correct&nbsp;exception.&lt;br&gt;<br>
         &nbsp;}&lt;br&gt;<br>
       &nbsp;case&nbsp;FileMode.OpenOrCreate:&lt;br&gt;<br>
        case&nbsp;FileMode.Create:&lt;br&gt;<br>
         &nbsp;//&nbsp;Check&nbsp;if&nbsp;a&nbsp;stream&nbsp;is&nbsp;already&nbsp;loaded.&nbsp;If&nbsp;not,&nbsp;load&nbsp;it&nbsp;or&lt;br&gt;<br>
create&nbsp;an&nbsp;empty&nbsp;one.&lt;br&gt;<br>
         &nbsp;if&nbsp;(!Package.PartStreams.TryGetValue(Uri,&nbsp;out&nbsp;stream))&nbsp;{&lt;br&gt;<br>
           &nbsp;stream&nbsp;=&nbsp;new&nbsp;MemoryStream();&lt;br&gt;<br>
&lt;br&gt;<br>
           &nbsp;try&lt;br&gt;<br>
           &nbsp;{&lt;br&gt;<br>
             &nbsp;using&nbsp;(UnzipArchive&nbsp;archive&nbsp;=&nbsp;new&lt;br&gt;<br>
UnzipArchive(Package.PackageStream))&lt;br&gt;<br>
             &nbsp;{&lt;br&gt;<br>
               &nbsp;foreach&nbsp;(string&nbsp;file&nbsp;in&nbsp;archive.GetFiles())&lt;br&gt;<br>
               &nbsp;{&lt;br&gt;<br>
                 &nbsp;if&nbsp;(file&nbsp;!=&nbsp;Uri.ToString().Substring(1))&lt;br&gt;<br>
                   &nbsp;continue;&lt;br&gt;<br>
&lt;br&gt;<br>
                 &nbsp;using&nbsp;(Stream&nbsp;archiveStream&nbsp;=&nbsp;archive.GetStream(file))&lt;br&gt;<br>
                 &nbsp;{&lt;br&gt;<br>
                   &nbsp;int&nbsp;read&nbsp;=&nbsp;0;&lt;br&gt;<br>
                   &nbsp;byte[]&nbsp;buffer&nbsp;=&nbsp;new&lt;br&gt;<br>
byte[Math.Min(archiveStream.Length,&nbsp;2&nbsp;*&nbsp;1024)];&lt;br&gt;<br>
                   &nbsp;while&nbsp;((read&nbsp;=&nbsp;archiveStream.Read(buffer,&nbsp;0,&lt;br&gt;<br>
buffer.Length))&nbsp;!=&nbsp;0)&lt;br&gt;<br>
                     &nbsp;stream.Write(buffer,&nbsp;0,&nbsp;read);&lt;br&gt;<br>
                 &nbsp;}&lt;br&gt;<br>
               &nbsp;}&lt;br&gt;<br>
             &nbsp;}&lt;br&gt;<br>
           &nbsp;}&lt;br&gt;<br>
           &nbsp;catch&lt;br&gt;<br>
           &nbsp;{&lt;br&gt;<br>
             &nbsp;//&nbsp;The&nbsp;zipfile&nbsp;is&nbsp;invalid,&nbsp;so&nbsp;just&nbsp;create&nbsp;the&nbsp;file&lt;br&gt;<br>
             &nbsp;//&nbsp;as&nbsp;if&nbsp;it&nbsp;didn&amp;#39;t&nbsp;exist&lt;br&gt;<br>
             &nbsp;stream.SetLength(0);&lt;br&gt;<br>
           &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
           &nbsp;Package.PartStreams.Add(Uri,&nbsp;stream);&lt;br&gt;<br>
         &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
  &nbsp;//&nbsp;This&nbsp;ensures&nbsp;that&nbsp;an&nbsp;existing&nbsp;stream&nbsp;to&nbsp;which&nbsp;a&nbsp;create&lt;br&gt;<br>
  &nbsp;//&nbsp;is&nbsp;applied&nbsp;will&nbsp;be&nbsp;overwritten.&lt;br&gt;<br>
  &nbsp;if&nbsp;(mode&nbsp;==&nbsp;FileMode.Create)&lt;br&gt;<br>
           &nbsp;stream.SetLength(0);&lt;br&gt;<br>
&lt;br&gt;<br>
         &nbsp;return&nbsp;new&nbsp;ZipPartStream(Package,&nbsp;stream,&nbsp;access);&lt;br&gt;<br>
 default:&lt;br&gt;<br>
  &nbsp;throw&nbsp;new&nbsp;ArgumentOutOfRangeException(&amp;quot;mode&amp;quot;);&lt;br&gt;<br>
     &nbsp;}&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
