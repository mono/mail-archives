<tt>
I&nbsp;quite&nbsp;like&nbsp;this&nbsp;patch,&nbsp;it&nbsp;removes&nbsp;more&nbsp;code&nbsp;than&nbsp;it&nbsp;adds&nbsp;back.&nbsp;The&nbsp;results&nbsp;should&nbsp;look&nbsp;clear&lt;br&gt;and&nbsp;if&nbsp;we&nbsp;end&nbsp;wishing&nbsp;optimizing&nbsp;a&nbsp;spot&nbsp;we&nbsp;can&nbsp;trade&nbsp;the&nbsp;loop&nbsp;for&nbsp;an&nbsp;inlined&nbsp;function&nbsp;or&nbsp;macro.&nbsp;[1]&lt;br&gt;&lt;br&gt;But&nbsp;there&nbsp;are&nbsp;a&nbsp;few&nbsp;things&nbsp;that&nbsp;I&nbsp;dislike&nbsp;about&nbsp;this&nbsp;patch.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;---&nbsp;a/mono/mini/cfold.c&lt;br&gt;+++&nbsp;b/mono/mini/cfold.c&lt;br&gt;@@&nbsp;-58,13&nbsp;+58,18&nbsp;@@&nbsp;mono_is_power_of_two&nbsp;(guint32&nbsp;val)&lt;br&gt;    &nbsp;   &nbsp;res&nbsp;=&nbsp;(cast)arg1-&amp;gt;inst_c0&nbsp;op&nbsp;(cast)arg2-&amp;gt;inst_c0;   &nbsp;\&lt;br&gt;        &nbsp;break;&nbsp;\&lt;br&gt; &lt;br&gt;+#define&nbsp;MONO_INST_NULLIFY_SREGS(dest)&nbsp;do&nbsp;{   &nbsp;   &nbsp;   &nbsp;   &nbsp;\&lt;br&gt;<br>
+   &nbsp;   &nbsp;(dest)-&amp;gt;sreg1&nbsp;=&nbsp;(dest)-&amp;gt;sreg2&nbsp;=&nbsp;(dest)-&amp;gt;sreg3&nbsp;=&nbsp;-1;   &nbsp;\&lt;br&gt;+   &nbsp;}&nbsp;while&nbsp;(0)&lt;br&gt;+&lt;br&gt; #undef&nbsp;MONO_INST_NEW&lt;br&gt; #define&nbsp;MONO_INST_NEW(cfg,dest,op)&nbsp;do&nbsp;{   &nbsp;\&lt;br&gt;    &nbsp;   &nbsp;(dest)&nbsp;=&nbsp;mono_mempool_alloc&nbsp;((cfg)-&amp;gt;mempool,&nbsp;sizeof&nbsp;(MonoInst));   &nbsp;\&lt;br&gt;<br>
        &nbsp;(dest)-&amp;gt;inst_p0&nbsp;=&nbsp;(dest)-&amp;gt;inst_p1&nbsp;=&nbsp;(dest)-&amp;gt;next&nbsp;=&nbsp;NULL;&nbsp;\&lt;br&gt;    &nbsp;   &nbsp;(dest)-&amp;gt;opcode&nbsp;=&nbsp;(op);   &nbsp;\&lt;br&gt;        &nbsp;(dest)-&amp;gt;flags&nbsp;=&nbsp;0;&nbsp;\&lt;br&gt;-       &nbsp;(dest)-&amp;gt;dreg&nbsp;=&nbsp;(dest)-&amp;gt;sreg1&nbsp;=&nbsp;(dest)-&amp;gt;sreg2&nbsp;=&nbsp;-1; &nbsp;\&lt;br&gt;<br>
+       &nbsp;(dest)-&amp;gt;dreg&nbsp;=&nbsp;-1;   &nbsp;   &nbsp;   &nbsp;   &nbsp;   &nbsp;\&lt;br&gt;+   &nbsp;MONO_INST_NULLIFY_SREGS&nbsp;((dest));   &nbsp;   &nbsp;   &nbsp;\&lt;br&gt;    &nbsp;}&nbsp;while&nbsp;(0)&lt;br&gt; &lt;br&gt;This&nbsp;is&nbsp;pure&nbsp;code&nbsp;duplication,&nbsp;kill&nbsp;it&nbsp;instead&nbsp;of&nbsp;patching.&lt;br&gt;&lt;br&gt;@@&nbsp;-138,6&nbsp;+142,15&nbsp;@@&nbsp;ins_info[]&nbsp;=&nbsp;{&lt;br&gt;<br>
 #include&nbsp;&amp;quot;mini-ops.h&amp;quot;&lt;br&gt; };&lt;br&gt; #undef&nbsp;MINI_OP&lt;br&gt;+#undef&nbsp;MINI_OP3&lt;br&gt;+&lt;br&gt;+#define&nbsp;MINI_OP(a,b,dest,src1,src2)&nbsp;-1,&lt;br&gt;+#define&nbsp;MINI_OP3(a,b,dest,src1,src2,src3)&nbsp;-1,&lt;br&gt;+gint8&nbsp;ins_sreg_counts[]&nbsp;=&nbsp;{&lt;br&gt;+#include&nbsp;&amp;quot;mini-ops.h&amp;quot;&lt;br&gt;<br>
+};&lt;br&gt;+#undef&nbsp;MINI_OP&lt;br&gt;+#undef&nbsp;MINI_OP3&lt;br&gt;&lt;br&gt;&lt;br&gt;This&nbsp;information&nbsp;can&nbsp;be&nbsp;calculated&nbsp;at&nbsp;compile&nbsp;time.&nbsp;All&nbsp;we&nbsp;get&nbsp;from&nbsp;running&nbsp;mini_init_op_sreg_counts&lt;br&gt;is&nbsp;an&nbsp;increased&nbsp;private&nbsp;RSS&nbsp;with&nbsp;no&nbsp;advantage.&nbsp;This&nbsp;information&nbsp;should&nbsp;be&nbsp;packaged&nbsp;in&nbsp;the&nbsp;ins_info&nbsp;array.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;@@&nbsp;-437,7&nbsp;+450,7&nbsp;@@&nbsp;struct&nbsp;MonoInst&nbsp;{&lt;br&gt;    &nbsp;guint8 &nbsp;flags &nbsp;:&nbsp;5;&lt;br&gt;    &nbsp;&lt;br&gt;    &nbsp;/*&nbsp;used&nbsp;by&nbsp;the&nbsp;register&nbsp;allocator&nbsp;*/&lt;br&gt;-   &nbsp;gint32&nbsp;dreg,&nbsp;sreg1,&nbsp;sreg2;&lt;br&gt;+   &nbsp;gint32&nbsp;dreg,&nbsp;sreg1,&nbsp;sreg2,&nbsp;sreg3;&lt;br&gt;&lt;br&gt;&lt;br&gt;This&nbsp;change&nbsp;increases&nbsp;the&nbsp;JIT&nbsp;working&nbsp;set&nbsp;significantly.&nbsp;Have&nbsp;you&nbsp;thought&nbsp;about&nbsp;doing&nbsp;something&nbsp;like&lt;br&gt;<br>
struct&nbsp;MonoCallInst?&lt;br&gt;&lt;br&gt;It&nbsp;would&nbsp;allow&nbsp;us&nbsp;to&nbsp;have&nbsp;3&nbsp;sregs&nbsp;and&nbsp;only&nbsp;pay&nbsp;the&nbsp;size&nbsp;price&nbsp;when&nbsp;needed.&nbsp;It&nbsp;would&nbsp;be&nbsp;trivial&nbsp;to&nbsp;have&lt;br&gt;a&nbsp;function&nbsp;to&nbsp;detect&nbsp;such&nbsp;instructions&nbsp;by&nbsp;expanding&nbsp;mini-ops.h&nbsp;to&nbsp;avoid&nbsp;hitting&nbsp;the&nbsp;ins_info&nbsp;array.&lt;br&gt;<br>
&lt;br&gt;Besides&nbsp;that,&nbsp;I&amp;#39;m&nbsp;eager&nbsp;to&nbsp;have&nbsp;this&nbsp;patch&nbsp;in&nbsp;so&nbsp;I&nbsp;can&nbsp;exploit&nbsp;it&nbsp;on&nbsp;Mono.Simd&nbsp;:)&lt;br&gt;&lt;br&gt;&lt;br&gt;[1]&nbsp;Doing&nbsp;something&nbsp;like&nbsp;like:&lt;br&gt;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;sreg_count&nbsp;(ins);&nbsp;++i)&nbsp;&lt;br&gt; &nbsp;zzzzz&lt;br&gt;&lt;br&gt;to&lt;br&gt;&lt;br&gt;static&nbsp;inline&nbsp;foo()&nbsp;{&nbsp;zzzzz&nbsp;}&nbsp;//OR&lt;br&gt;<br>
&lt;br&gt;#define&nbsp;FOO()&nbsp;do&nbsp;{&nbsp;zzzzz;&nbsp;}&nbsp;while&nbsp;(0)&lt;br&gt;&lt;br&gt;if&nbsp;(has_sreg1)&lt;br&gt; &nbsp;foo&nbsp;();&lt;br&gt;if&nbsp;(has_sreg2)&lt;br&gt;<br>
 &nbsp;foo&nbsp;();&lt;br&gt;if&nbsp;(unlikely&nbsp;(has_sreg3)&lt;br&gt; foo&nbsp;();&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2009/3/13&nbsp;Mark&nbsp;Probst&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mark.probst@gmail.com&quot;&gt;mark.probst@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;Mon,&nbsp;Feb&nbsp;23,&nbsp;2009&nbsp;at&nbsp;10:10&nbsp;PM,&nbsp;Zoltan&nbsp;Varga&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:vargaz@gmail.com&quot;&gt;vargaz@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;All&nbsp;this&nbsp;to&nbsp;add&nbsp;support&nbsp;for&nbsp;exactly&nbsp;one&nbsp;rarely&nbsp;used&nbsp;instruction,&nbsp;CAS.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;As&nbsp;per&nbsp;Paolo&amp;#39;s&nbsp;request&nbsp;I&nbsp;timed&nbsp;a&nbsp;--compile-all&nbsp;of&lt;br&gt;<br>
System.Windows.Forms.dll&nbsp;(which&nbsp;I&nbsp;chose&nbsp;instead&nbsp;of&nbsp;mscorlib.dll&lt;br&gt;<br>
because&nbsp;it&amp;#39;s&nbsp;larger)&nbsp;with&nbsp;and&nbsp;without&nbsp;the&nbsp;patch.&nbsp; It&nbsp;turns&nbsp;out&nbsp;with&lt;br&gt;<br>
the&nbsp;patch&nbsp;we&amp;#39;re&nbsp;about&nbsp;10%&nbsp;slower.&nbsp; With&nbsp;the&nbsp;attached&nbsp;revised&nbsp;patch,&lt;br&gt;<br>
which&nbsp;uses&nbsp;macros&nbsp;for&nbsp;all&nbsp;the&nbsp;getter&nbsp;functions,&nbsp;the&nbsp;difference&nbsp;is&lt;br&gt;<br>
barely&nbsp;3%&nbsp;(2.3166s&nbsp;vs&nbsp;2.2522s,&nbsp;on&nbsp;x86).&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
Mark&lt;br&gt;<br>
&lt;/font&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
