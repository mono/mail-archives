<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;Hi,&nbsp;I&#39;m&nbsp;poking&nbsp;through&nbsp;the&nbsp;pieces&nbsp;of&nbsp;the&nbsp;System.Core/System.IO.Pipes&nbsp;code&nbsp;looking&nbsp;to&nbsp;build&nbsp;out&nbsp;anonymous&nbsp;pipes.&nbsp;I&nbsp;have&nbsp;at&nbsp;least&nbsp;a&nbsp;basic&nbsp;working&nbsp;Unix&nbsp;implementation&nbsp;now.&nbsp;Though&nbsp;i&nbsp;imagine&nbsp;Win32&nbsp;and&nbsp;Named&nbsp;pipes&nbsp;have&nbsp;been&nbsp;broken&nbsp;(if&nbsp;they&nbsp;ever&nbsp;worked)&nbsp;in&nbsp;the&nbsp;process,&nbsp;and&nbsp;there&nbsp;is&nbsp;undoubtedly&nbsp;some&nbsp;cleanup&nbsp;work&nbsp;required.&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;get&nbsp;some&nbsp;feedback&nbsp;from&nbsp;people&nbsp;more&nbsp;knowledgeable&nbsp;than&nbsp;myself&nbsp;about&nbsp;mono&nbsp;at&nbsp;this&nbsp;point&nbsp;so&nbsp;i&nbsp;can&nbsp;try&nbsp;and&nbsp;wrap&nbsp;this&nbsp;project&nbsp;up&nbsp;into&nbsp;a&nbsp;pull&nbsp;request.&lt;br&gt;<br>
&lt;br&gt;My&nbsp;initial&nbsp;test&nbsp;case&nbsp;is&nbsp;this&nbsp;example&nbsp;from&nbsp;MSDN:&nbsp;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/bb546102.aspx&quot;&nbsp;target=&quot;_blank&quot;&gt;http://msdn.microsoft.com/en-us/library/bb546102.aspx&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Handle&nbsp;Inheritance&lt;br&gt;-------------------------&lt;br&gt;&lt;/div&gt;&lt;div&gt;Presently,&nbsp;Process.Start()&nbsp;arbitrarily&nbsp;closes&nbsp;all&nbsp;handles<br>
&nbsp;in&nbsp;the&nbsp;fork()&#39;d&nbsp;process,&nbsp;except&nbsp;stdin&nbsp;/&nbsp;stdout&nbsp;/&nbsp;stderr.&nbsp;There&nbsp;exists&nbsp;a<br>
&nbsp;todo&nbsp;comment&nbsp;in&nbsp;this&nbsp;same&nbsp;code&nbsp;(io-layer/processes.c)&nbsp;pointing&nbsp;out&nbsp;that<br>
&nbsp;(when&nbsp;inherit_handles&nbsp;is&nbsp;TRUE,&nbsp;which&nbsp;it&nbsp;is)&nbsp;that&nbsp;something&nbsp;should&nbsp;be&nbsp;<br>
done&nbsp;differently&nbsp;than&nbsp;when&nbsp;not...&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;pre&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;if&lt;/span&gt;&nbsp;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;&lt;i&gt;inherit_handles&lt;/i&gt;&lt;/span&gt;&nbsp;&lt;span&gt;!=&lt;/span&gt;&nbsp;&lt;span&gt;TRUE&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&nbsp;&lt;span&gt;{&lt;/span&gt;&lt;/div&gt;<br>
&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;/*&nbsp;FIXME:&nbsp;do&nbsp;something&nbsp;here&nbsp;*/&lt;/span&gt;<br>
&lt;/div&gt;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;span&gt;}&lt;/span&gt;<br>
&lt;/div&gt;&lt;/pre&gt;&lt;br&gt;Without&nbsp;a&nbsp;far&nbsp;more&nbsp;expansive&nbsp;knowledge&nbsp;of&nbsp;mono&nbsp;i&nbsp;can&#39;t&nbsp;<br>
make&nbsp;a&nbsp;very&nbsp;well&nbsp;informed&nbsp;decision&nbsp;about&nbsp;the&nbsp;liberties&nbsp;i&nbsp;can&nbsp;take&nbsp;in&nbsp;addressing&nbsp;this.&nbsp;&lt;br&gt;The&nbsp;cleanest&nbsp;solution&nbsp;might&nbsp;be&nbsp;to&nbsp;use&nbsp;FD_CLOEXEC&nbsp;on&nbsp;all&nbsp;the&nbsp;existing&nbsp;fd&#39;s&nbsp;and&nbsp;(at&nbsp;least&nbsp;in&nbsp;process.Start&nbsp;case)&nbsp;the&nbsp;handles&nbsp;that&nbsp;should&nbsp;be&nbsp;cleaned&nbsp;up&nbsp;would&nbsp;be&nbsp;closed&nbsp;automatically&nbsp;/&nbsp;inherited&nbsp;automatically.&nbsp;Are&nbsp;there&nbsp;compatibility&nbsp;reasons&nbsp;this&nbsp;cannot&nbsp;be&nbsp;done?&nbsp;Has&nbsp;there&nbsp;been&nbsp;any&nbsp;consideration&nbsp;for&nbsp;this&nbsp;that&nbsp;could&nbsp;be&nbsp;drawn&nbsp;upon?&lt;br&gt;<br>
&gt;From&nbsp;information&nbsp;i&nbsp;do&nbsp;have,&nbsp;it&nbsp;seems&nbsp;like&nbsp;these&nbsp;pipe&nbsp;handles&nbsp;could&nbsp;also&nbsp;be&nbsp;flagged&nbsp;as&nbsp;&#39;inheritable&#39;&nbsp;in&nbsp;the&nbsp;internal&nbsp;handle&nbsp;registry&nbsp;and&nbsp;then&nbsp;after&nbsp;fork()&nbsp;mono&nbsp;could&nbsp;leave&nbsp;those<br>
&nbsp;open,&nbsp;while&nbsp;closing&nbsp;everything&nbsp;else.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;addition&nbsp;to&nbsp;this&nbsp;basic&nbsp;test&nbsp;case,&nbsp;i&#39;m&nbsp;not&nbsp;currently&nbsp;aware&nbsp;of&nbsp;how&nbsp;anonymous&nbsp;pipes&nbsp;should&nbsp;behave&nbsp;when&nbsp;you&nbsp;invoke&nbsp;Process.Start()&nbsp;several&nbsp;times&nbsp;with&nbsp;an&nbsp;anonymous&nbsp;pipe.&nbsp;Without&nbsp;using&nbsp;FD_CLOEXEC&nbsp;it&nbsp;would&nbsp;be&nbsp;difficult&nbsp;and&nbsp;messy&nbsp;to&nbsp;(in&nbsp;a&nbsp;&#39;execd&#39;&nbsp;child&nbsp;process)&nbsp;to&nbsp;identify&nbsp;all&nbsp;the&nbsp;pipe&nbsp;handles&nbsp;at&nbsp;startup&nbsp;and&nbsp;register&nbsp;them&nbsp;in&nbsp;the&nbsp;mono&nbsp;handle&nbsp;registry&nbsp;as&nbsp;inheritable&nbsp;again&nbsp;(so&nbsp;that&nbsp;Process.Start&nbsp;in&nbsp;that&nbsp;child&nbsp;process&nbsp;would&nbsp;pass&nbsp;these&nbsp;handles&nbsp;on&nbsp;again&nbsp;to&nbsp;its&nbsp;children).&nbsp;If&nbsp;anonymous&nbsp;pipes&nbsp;are&nbsp;supposed&nbsp;to&nbsp;support&nbsp;this,&nbsp;it&nbsp;lends&nbsp;further&nbsp;support&nbsp;for&nbsp;the&nbsp;FD_CLOEXEC&nbsp;solution.&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;<br>
<br>
&lt;br&gt;API&nbsp;Methods&nbsp;Difficult&nbsp;To&nbsp;Implement&nbsp;In&nbsp;Unix&lt;br&gt;-------------------------&lt;br&gt;There&nbsp;doesn&#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;a&nbsp;clear&nbsp;specification&nbsp;for&nbsp;the&nbsp;anonymous&nbsp;pipe&nbsp;feature&nbsp;and&nbsp;i&#39;ve&nbsp;so&nbsp;far&nbsp;had&nbsp;to&nbsp;make&nbsp;some&nbsp;little&nbsp;assumptions&nbsp;/&nbsp;inferences&nbsp;based&nbsp;on&nbsp;the&nbsp;documentation&nbsp;on&nbsp;MSDN.&nbsp;That&nbsp;said,&nbsp;the&nbsp;posix&nbsp;anonymous&nbsp;pipe&nbsp;standard&nbsp;lacks&nbsp;a&nbsp;few&nbsp;features&nbsp;which&nbsp;are&nbsp;pertinent&nbsp;to&nbsp;the&nbsp;API&nbsp;for&nbsp;anonymous&nbsp;pipe&nbsp;streams.&nbsp;In&nbsp;particular&nbsp;there&nbsp;are&nbsp;two&nbsp;conflicting&nbsp;features:&lt;br&gt;<br>
&lt;br&gt;    &nbsp;*&nbsp;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/system.io.pipes.pipestream.waitforpipedrain.aspx&quot;&gt;WaitForPipeDrain&lt;/a&gt;()&nbsp;defined&nbsp;on&nbsp;the&nbsp;AnonymousPipeStream&nbsp;requires&nbsp;some&nbsp;ability&nbsp;to&nbsp;peak&nbsp;into&nbsp;an&nbsp;anonymous&nbsp;pipe&nbsp;and&nbsp;wait&nbsp;for&nbsp;the&nbsp;pipe&#39;s&nbsp;buffer&nbsp;to&nbsp;become&nbsp;empty&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;    &nbsp;*&nbsp;Write&nbsp;/&nbsp;Read&nbsp;/&nbsp;etc...&nbsp;is&nbsp;supposed&nbsp;to&nbsp;throw&nbsp;an&nbsp;IOException&nbsp;if&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;pipe&nbsp;stream&nbsp;has&nbsp;been&nbsp;closed&nbsp;(i&nbsp;have&nbsp;interpreted&nbsp;the&nbsp;wording&nbsp;&#39;pipe&nbsp;is&nbsp;broken&#39;&nbsp;from&nbsp;the&nbsp;msdn&nbsp;docs&nbsp;to&nbsp;mean&nbsp;this,&nbsp;although&nbsp;there&nbsp;is&nbsp;a&nbsp;chance&nbsp;i&nbsp;am&nbsp;mis-interpreting&nbsp;this&nbsp;too)&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;These&nbsp;two&nbsp;features&nbsp;conflict&nbsp;when&nbsp;trying&nbsp;to&nbsp;implement&nbsp;them&nbsp;in&nbsp;unix&nbsp;through&nbsp;minor&nbsp;hacks&nbsp;/&nbsp;workarounds.&nbsp;&lt;br&gt;&lt;br&gt;I&nbsp;can&nbsp;implement&nbsp;WaitForPipeDrain()&nbsp;by&nbsp;leaving&nbsp;the&nbsp;read&nbsp;end&nbsp;of&nbsp;the&nbsp;pipe&nbsp;handle&nbsp;open&nbsp;in&nbsp;the&nbsp;writer&nbsp;process,&nbsp;and&nbsp;calling&nbsp;poll(3)&nbsp;on&nbsp;the&nbsp;read&nbsp;end&nbsp;repeatedly&nbsp;until&nbsp;the&nbsp;POLL_IN&nbsp;flag&nbsp;is&nbsp;gone.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;detect&nbsp;that&nbsp;the&nbsp;pipe&nbsp;is&nbsp;broken&nbsp;by&nbsp;closing&nbsp;the&nbsp;read&nbsp;end&nbsp;on&nbsp;the&nbsp;writer,&nbsp;(and&nbsp;the&nbsp;write&nbsp;end&nbsp;on&nbsp;the&nbsp;reader)&nbsp;and&nbsp;calling&nbsp;poll(3),&nbsp;throwing&nbsp;this&nbsp;&quot;pipe&nbsp;broken&quot;&nbsp;error&nbsp;when&nbsp;a&nbsp;POLLERR&nbsp;/.&nbsp;POLLHUP&nbsp;is&nbsp;issued.&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;flags&nbsp;will&nbsp;be&nbsp;set&nbsp;if&nbsp;all&nbsp;handles&nbsp;to&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;pipe&nbsp;have&nbsp;been&nbsp;closed.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;order&nbsp;to&nbsp;implement&nbsp;both&nbsp;of&nbsp;these&nbsp;conflicting&nbsp;features&nbsp;i&nbsp;actually&nbsp;need&nbsp;to&nbsp;create&nbsp;two&nbsp;pipes&nbsp;(one&nbsp;where&nbsp;i&nbsp;can&nbsp;leave&nbsp;the&nbsp;read&nbsp;end&nbsp;open&nbsp;on&nbsp;the&nbsp;writer&nbsp;process,&nbsp;and&nbsp;one&nbsp;where&nbsp;i&nbsp;can&nbsp;close&nbsp;it).&nbsp;This&nbsp;is&nbsp;not&nbsp;very&nbsp;nice&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;system&nbsp;resources&nbsp;might&nbsp;be&nbsp;at&nbsp;a&nbsp;premium,&nbsp;however&nbsp;i&nbsp;haven&#39;t&nbsp;been&nbsp;able&nbsp;to&nbsp;devise&nbsp;any&nbsp;other&nbsp;way&nbsp;to&nbsp;get&nbsp;both&nbsp;features&nbsp;either.&nbsp;Would&nbsp;there&nbsp;be&nbsp;any&nbsp;major&nbsp;objection&nbsp;to&nbsp;implementing&nbsp;it&nbsp;like&nbsp;this&nbsp;(which&nbsp;as&nbsp;i&nbsp;have&nbsp;noted&nbsp;seems&nbsp;to&nbsp;be&nbsp;the&nbsp;only&nbsp;way)?&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Using&nbsp;two&nbsp;separate&nbsp;pipes&nbsp;like&nbsp;this,&nbsp;the&nbsp;GetClientHandleAsString()&nbsp;method&nbsp;is&nbsp;going&nbsp;to&nbsp;be&nbsp;significantly&nbsp;different&nbsp;from&nbsp;the&nbsp;win32&nbsp;version.&nbsp;When&nbsp;the&nbsp;client&nbsp;is&nbsp;supposed&nbsp;to&nbsp;be&nbsp;the&nbsp;writer,&nbsp;the&nbsp;client&nbsp;handle&nbsp;as&nbsp;string&nbsp;must&nbsp;contain&nbsp;three&nbsp;separate&nbsp;fds.&nbsp;When&nbsp;the&nbsp;client&nbsp;is&nbsp;the&nbsp;reader&nbsp;two&nbsp;fd&#39;s&nbsp;must&nbsp;be&nbsp;passed.&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;any&nbsp;reason&nbsp;that&nbsp;this&nbsp;would&nbsp;bother&nbsp;anybody,&nbsp;but&nbsp;if&nbsp;it&#39;s&nbsp;relevant&nbsp;let&nbsp;me&nbsp;know!&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Compatibility&lt;br&gt;-------------------------&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;create&nbsp;pipes&nbsp;and&nbsp;manipulate&nbsp;them&nbsp;without&nbsp;adding&nbsp;any&nbsp;new&nbsp;library&nbsp;references&nbsp;but&nbsp;i&nbsp;do&nbsp;depend&nbsp;on&nbsp;using&nbsp;the&nbsp;poll(3)&nbsp;function&nbsp;more&nbsp;heavily&nbsp;than&nbsp;it&nbsp;seems&nbsp;to&nbsp;be&nbsp;presently&nbsp;(it&#39;s&nbsp;only&nbsp;exposed&nbsp;for&nbsp;Network&nbsp;Sockets&nbsp;presently).&nbsp;Are&nbsp;there&nbsp;any&nbsp;portability&nbsp;/&nbsp;compatibility&nbsp;considerations&nbsp;with&nbsp;poll(3)&nbsp;that&nbsp;might&nbsp;need&nbsp;to&nbsp;be&nbsp;addressed?&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Versioning&lt;br&gt;-------------------------&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;m&nbsp;not&nbsp;familiar&nbsp;with&nbsp;how&nbsp;versioning&nbsp;between&nbsp;.NET&nbsp;1/2/3/etc...&nbsp;is&nbsp;being&nbsp;handled.&nbsp;Anonymous&nbsp;pipes&nbsp;are&nbsp;introduced&nbsp;in&nbsp;.NET&nbsp;3.5.&nbsp;Do&nbsp;these&nbsp;classes&nbsp;need&nbsp;to&nbsp;be&nbsp;hidden&nbsp;to&nbsp;older&nbsp;versions,&nbsp;etc...&nbsp;Maybe&nbsp;there&nbsp;is&nbsp;a&nbsp;wiki&nbsp;page&nbsp;i&nbsp;haven&#39;t&nbsp;found&nbsp;discussing&nbsp;some&nbsp;of&nbsp;this?&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;added&nbsp;several&nbsp;new&nbsp;internal&nbsp;calls&nbsp;to&nbsp;the&nbsp;MonoIO&nbsp;utility,&nbsp;specifically&nbsp;for&nbsp;poll(3)&nbsp;and&nbsp;pipe&nbsp;handle&nbsp;manipulation.&nbsp;Does&nbsp;adding&nbsp;internal&nbsp;calls&nbsp;require&nbsp;any&nbsp;versioning&nbsp;considerations?&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;Testing&lt;br&gt;<br>
-------------------------&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;order&nbsp;to&nbsp;write&nbsp;a&nbsp;test&nbsp;suite&nbsp;for&nbsp;anonymous&nbsp;pipes&nbsp;i&nbsp;need&nbsp;to&nbsp;start&nbsp;new&nbsp;processes&nbsp;and&nbsp;i&nbsp;will&nbsp;need&nbsp;to&nbsp;use&nbsp;some&nbsp;sort&nbsp;of&nbsp;IPC&nbsp;mechanism&nbsp;to&nbsp;communicate&nbsp;certain&nbsp;errors&nbsp;back&nbsp;to&nbsp;the&nbsp;test&nbsp;process.&nbsp;This&nbsp;seems&nbsp;like&nbsp;a&nbsp;rather&nbsp;unique&nbsp;challenge&nbsp;compared&nbsp;to&nbsp;most&nbsp;of&nbsp;the&nbsp;testing&nbsp;needed&nbsp;for&nbsp;mono.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Has&nbsp;any&nbsp;of&nbsp;this&nbsp;multi-process&nbsp;unit&nbsp;testing&nbsp;been&nbsp;done&nbsp;before&nbsp;in&nbsp;mono,&nbsp;or&nbsp;are&nbsp;there&nbsp;any&nbsp;considerations&nbsp;that&nbsp;might&nbsp;be&nbsp;relevant?&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
