TLS for Darwin/x86.

From: Mark Probst <schani@Test-Erichs-iMac.local>


---
 mono/mini/mini-x86.c |   22 +++++++++++++++++++++-
 mono/mini/mini-x86.h |    5 ++++-
 mono/mini/mini.c     |    2 +-
 3 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/mono/mini/mini-x86.c b/mono/mini/mini-x86.c
index 21c7413..e818084 100644
--- a/mono/mini/mini-x86.c
+++ b/mono/mini/mini-x86.c
@@ -2034,6 +2034,23 @@ emit_move_return_value (MonoCompile *cfg, MonoInst *ins, guint8 *code)
 	return code;
 }
 
+gboolean
+mono_x86_have_tls_get (void)
+{
+#ifdef __APPLE__
+	guint32 *ins = (guint32*)pthread_getspecific;
+	/*
+	 * We're looking for these two instructions:
+	 *
+	 * mov    0x4(%esp),%eax
+	 * mov    %gs:0x48(,%eax,4),%eax
+	 */
+	return ins [0] == 0x0424448b && ins [1] == 0x85048b65 && ins [2] == 0x00000048;
+#else
+	return TRUE;
+#endif
+}
+
 /*
  * mono_x86_emit_tls_get:
  * @code: buffer to store code to
@@ -2049,7 +2066,10 @@ emit_move_return_value (MonoCompile *cfg, MonoInst *ins, guint8 *code)
 guint8*
 mono_x86_emit_tls_get (guint8* code, int dreg, int tls_offset)
 {
-#ifdef TARGET_WIN32
+#if defined(__APPLE__)
+	x86_prefix (code, X86_GS_PREFIX);
+	x86_mov_reg_mem (code, dreg, 0x48 + tls_offset * 4, 4);
+#elif defined(TARGET_WIN32)
 	/* 
 	 * See the Under the Hood article in the May 1996 issue of Microsoft Systems 
 	 * Journal and/or a disassembly of the TlsGet () function.
diff --git a/mono/mini/mini-x86.h b/mono/mini/mini-x86.h
index 3280ead..bc7e0df 100644
--- a/mono/mini/mini-x86.h
+++ b/mono/mini/mini-x86.h
@@ -243,7 +243,7 @@ typedef struct {
 #define MONO_ARCH_HAVE_ATOMIC_EXCHANGE 1
 #define MONO_ARCH_HAVE_ATOMIC_CAS 1
 #define MONO_ARCH_HAVE_IMT 1
-#define MONO_ARCH_HAVE_TLS_GET 1
+#define MONO_ARCH_HAVE_TLS_GET (mono_x86_have_tls_get ())
 #define MONO_ARCH_IMT_REG X86_EDX
 #define MONO_ARCH_VTABLE_REG X86_EDX
 #define MONO_ARCH_RGCTX_REG X86_EDX
@@ -305,5 +305,8 @@ mono_x86_emit_tls_get (guint8* code, int dreg, int tls_offset) MONO_INTERNAL;
 guint32
 mono_x86_get_this_arg_offset (MonoGenericSharingContext *gsctx, MonoMethodSignature *sig) MONO_INTERNAL;
 
+gboolean
+mono_x86_have_tls_get (void) MONO_INTERNAL;
+
 #endif /* __MONO_MINI_X86_H__ */  
 
diff --git a/mono/mini/mini.c b/mono/mini/mini.c
index 30067f7..7676119 100644
--- a/mono/mini/mini.c
+++ b/mono/mini/mini.c
@@ -5614,7 +5614,7 @@ mini_init (const char *filename, const char *runtime_version)
 #endif
 
 #ifdef MONO_ARCH_HAVE_TLS_GET
-	mono_runtime_set_has_tls_get (TRUE);
+	mono_runtime_set_has_tls_get (MONO_ARCH_HAVE_TLS_GET);
 #else
 	mono_runtime_set_has_tls_get (FALSE);
 #endif