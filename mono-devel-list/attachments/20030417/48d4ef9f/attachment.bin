Index: gc.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/gc.c,v
retrieving revision 1.35
diff -u -r1.35 gc.c
--- gc.c	3 Apr 2003 16:41:01 -0000	1.35
+++ gc.c	17 Apr 2003 14:19:13 -0000
@@ -26,6 +26,11 @@
 
 static void object_register_finalizer (MonoObject *obj, void (*callback)(void *, void*));
 
+#if HAVE_BOEHM_GC
+static void finalize_notify (void);
+static HANDLE pending_done_event;
+#endif
+
 /* 
  * actually, we might want to queue the finalize requests in a separate thread,
  * but we need to be careful about the execution domain of the thread...
@@ -167,6 +172,8 @@
 	
 #if HAVE_BOEHM_GC
 	GC_gcollect ();
+	if (GC_should_invoke_finalizers ())
+		finalize_notify ();
 #endif
 	mono_g_hash_table_foreach (domain->class_vtable_hash, (GHFunc)finalize_static_data, todo);
 	/* FIXME: finalize objects in todo... */
@@ -247,6 +254,18 @@
 ves_icall_System_GC_WaitForPendingFinalizers (void)
 {
 	MONO_ARCH_SAVE_REGS;
+	
+#if HAVE_BOEHM_GC
+	if (!GC_should_invoke_finalizers ())
+		return;
+
+	ResetEvent (pending_done_event);
+	finalize_notify ();
+	/* g_print ("Waiting for pending finalizers....\n"); */
+	WaitForSingleObject (pending_done_event, INFINITE);
+	/* g_print ("Done pending....\n"); */
+#else
+#endif
 }
 
 static CRITICAL_SECTION allocator_section;
@@ -452,6 +471,7 @@
 #endif
 
 		GC_invoke_finalizers ();
+		SetEvent (pending_done_event);
 	}
 	
 	return(0);
@@ -510,7 +530,8 @@
 		return;
 	
 	finalizer_event = CreateEvent (NULL, FALSE, FALSE, NULL);
-	if (finalizer_event == NULL) {
+	pending_done_event = CreateEvent (NULL, TRUE, FALSE, NULL);
+	if (finalizer_event == NULL || pending_done_event == NULL) {
 		g_assert_not_reached ();
 	}
 
