<tt>
Thanks,&nbsp;I&amp;#39;ve&nbsp;read&nbsp;(and&nbsp;now-reread!)&nbsp;this&nbsp;fairly&nbsp;carefully,&nbsp;but&nbsp;my&nbsp;case<br>
is&nbsp;about&amp;nbsp;&nbsp;C&nbsp;code&nbsp;calling&nbsp;CLI&nbsp;code,&nbsp;not&nbsp;the&nbsp;other&nbsp;way<br>
around,&nbsp;so&nbsp;I&nbsp;do&nbsp;not&nbsp;see&nbsp;explicit&nbsp;instructions&nbsp;about&nbsp;things&nbsp;like,&nbsp;for&nbsp;instance,&nbsp;how&nbsp;to&nbsp;treat&nbsp;the&nbsp;char*&nbsp;returned&nbsp;from&nbsp;the&nbsp;managed&nbsp;delegate.&nbsp;I<br>
would&nbsp;have&nbsp;expected&nbsp;the&nbsp;copy&nbsp;of&nbsp;the&nbsp;char*&nbsp;I&nbsp;pass&nbsp;to&nbsp;the&nbsp;CLI&nbsp;(&amp;quot;hello&amp;quot;,&nbsp;below)&nbsp;to&nbsp;be<br>
magically&nbsp;handled&nbsp;by&nbsp;the&nbsp;CLI,&nbsp;but&nbsp;the&nbsp;document&nbsp;doesn&amp;#39;t&nbsp;make&nbsp;100%&nbsp;clear<br>
how&nbsp;to&nbsp;free&nbsp;the&nbsp;char*&nbsp;copy&nbsp;that&nbsp;comes&nbsp;back&nbsp;from&nbsp;the&nbsp;managed&nbsp;delegate.<br>
It&nbsp;seems&nbsp;clear&nbsp;to&nbsp;me&nbsp;that&nbsp;the&nbsp;CLI&nbsp;can&amp;#39;t&nbsp;collect&nbsp;it&nbsp;for&nbsp;me&nbsp;(its&nbsp;lifetime&nbsp;must&nbsp;be&nbsp;managed&nbsp;by&nbsp;C),&nbsp;but&nbsp;it&nbsp;also<br>
seems&nbsp;that&nbsp;I&nbsp;suffer&nbsp;a&nbsp;memory&nbsp;leak&nbsp;even&nbsp;if&nbsp;I&nbsp;try&nbsp;to&nbsp;g_free&nbsp;it.&nbsp;The&nbsp;equivalent&nbsp;explicit&nbsp;marshaling&nbsp;(mono_string_to_utf8(reinterpret_cast&amp;lt;MonoString*&amp;gt;(answer))&nbsp;works&nbsp;like&nbsp;a&nbsp;charm&nbsp;and&nbsp;leaks&nbsp;nothing.&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
On&nbsp;8/25/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Zoltan&nbsp;Varga&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:vargaz@gmail.com&quot;&gt;vargaz@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi,&lt;br&gt;&lt;br&gt;Try&nbsp;our&nbsp;interop&nbsp;tutorial.&nbsp;It&nbsp;has&nbsp;some&nbsp;answers&nbsp;to&nbsp;your&nbsp;questions.&lt;br&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://www.mono-project.com/Interop_with_Native_Libraries&quot;&gt;http://www.mono-project.com/Interop_with_Native_Libraries&lt;/a&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Zoltan<br>
&lt;br&gt;&lt;br&gt;On&nbsp;8/25/07,&nbsp;Sebastian&nbsp;Good&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:sebastian@palladiumconsulting.com&quot;&gt;sebastian@palladiumconsulting.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;Thanks&nbsp;to&nbsp;help&nbsp;on&nbsp;this&nbsp;list&nbsp;I&amp;#39;ve&nbsp;come&nbsp;a&nbsp;long&nbsp;way&nbsp;in&nbsp;embedding&nbsp;mono&nbsp;into&nbsp;my<br>
&lt;br&gt;&amp;gt;&nbsp;C++&nbsp;application.&nbsp;During&nbsp;the&nbsp;transition&nbsp;of&nbsp;a&nbsp;very&nbsp;large&nbsp;application&nbsp;(25+&nbsp;yrs&lt;br&gt;&amp;gt;&nbsp;of&nbsp;C,&nbsp;Fortran,&nbsp;&amp;amp;&nbsp;C++)&nbsp;towards&nbsp;managed&nbsp;code,&nbsp;we&nbsp;will&nbsp;be&nbsp;adding&nbsp;new&nbsp;code&nbsp;in&lt;br&gt;&amp;gt;&nbsp;.NET&nbsp;languages,&nbsp;but&nbsp;needing&nbsp;to&nbsp;access&nbsp;these&nbsp;objects&nbsp;from&nbsp;C++&nbsp;fairly<br>
&lt;br&gt;&amp;gt;&nbsp;intimately.&nbsp;Therefore&nbsp;I&amp;#39;m&nbsp;looking&nbsp;at&nbsp;writing&nbsp;wrappers&nbsp;which&nbsp;expose&nbsp;CLR&lt;br&gt;&amp;gt;&nbsp;classes&nbsp;as&nbsp;C++&nbsp;classes&nbsp;--&nbsp;without&nbsp;resorting&nbsp;to&nbsp;(XP)COM&nbsp;or&nbsp;CORBA.&nbsp;I&nbsp;figure&lt;br&gt;&amp;gt;&nbsp;most&nbsp;of&nbsp;these&nbsp;can&nbsp;be&nbsp;auto-generated.&nbsp;I&nbsp;believe&nbsp;it&nbsp;will&nbsp;make&nbsp;sense&nbsp;to&nbsp;emit<br>
&lt;br&gt;&amp;gt;&nbsp;mono-embedding&nbsp;wrappers&nbsp;for&nbsp;Linux&nbsp;and&nbsp;Managed&nbsp;C++&nbsp;wrappers&nbsp;for&nbsp;Windows.&nbsp;If&lt;br&gt;&amp;gt;&nbsp;anyone&nbsp;else&nbsp;is&nbsp;interested&nbsp;(or&nbsp;has&nbsp;already&nbsp;undertaken!)&nbsp;such&nbsp;an&nbsp;effort,&nbsp;let&lt;br&gt;&amp;gt;&nbsp;me&nbsp;know.&nbsp;However&nbsp;I&amp;#39;m&nbsp;still&nbsp;looking&nbsp;at&nbsp;some&nbsp;marshalling&nbsp;issues.<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;If&nbsp;I&nbsp;call&nbsp;.NET&nbsp;functions&nbsp;exclusively&nbsp;via&nbsp;the&nbsp;embedding&nbsp;reflection&nbsp;API,&nbsp;e.g.&lt;br&gt;&amp;gt;&nbsp;mono_runtime_invoke,&nbsp;and&nbsp;carefully&nbsp;call&nbsp;g_free&nbsp;on&nbsp;returned&nbsp;copies&nbsp;of&nbsp;things&lt;br&gt;&amp;gt;&nbsp;like&nbsp;strings,&nbsp;everything&nbsp;works&nbsp;fine,&nbsp;including&nbsp;managed&nbsp;exceptions.&nbsp;It&nbsp;seems<br>
&lt;br&gt;&amp;gt;&nbsp;that&amp;nbsp;&amp;nbsp;by&nbsp;caching&nbsp;the&nbsp;reflected&nbsp;objects,&nbsp;e.g.&nbsp;MonoMethod*,&nbsp;performance&nbsp;is&lt;br&gt;&amp;gt;&nbsp;good.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;However&nbsp;I&nbsp;am&nbsp;having&nbsp;problems&nbsp;with&nbsp;delegates&nbsp;invoked&nbsp;across&nbsp;the&nbsp;barrier.&lt;br&gt;&amp;gt;&nbsp;They&nbsp;execute&nbsp;properly,&nbsp;but&nbsp;appear&nbsp;to&nbsp;leak&nbsp;memory,&nbsp;and&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;how&nbsp;to<br>
&lt;br&gt;&amp;gt;&nbsp;catch&nbsp;exceptions&nbsp;they&nbsp;might&nbsp;throw.&nbsp;For&nbsp;the&nbsp;majority&nbsp;of&nbsp;our&nbsp;interop,&nbsp;we&nbsp;can&lt;br&gt;&amp;gt;&nbsp;avoid&nbsp;attempting&nbsp;this&nbsp;scenario,&nbsp;but&nbsp;we&amp;#39;d&nbsp;like&nbsp;to&nbsp;investigate&nbsp;it&nbsp;so&nbsp;that&nbsp;we&lt;br&gt;&amp;gt;&nbsp;can&nbsp;provide&nbsp;managed&nbsp;callbacks&nbsp;for&nbsp;unmanaged&nbsp;code&nbsp;to&nbsp;call.<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;In&nbsp;our&nbsp;C++,&nbsp;we&nbsp;define&nbsp;(using&nbsp;MSVC&nbsp;syntax&nbsp;for&nbsp;this&nbsp;prototype)&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;//&nbsp;function:&nbsp;string-&amp;gt;string&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;typedef&nbsp;char*&nbsp;(__stdcall&nbsp;*&nbsp;action_string)(char*);&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;//&nbsp;managed&nbsp;code&nbsp;will&nbsp;stash&nbsp;a&nbsp;delegate&nbsp;here&nbsp;for&nbsp;use&nbsp;by&nbsp;unmanaged&nbsp;code<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;action_string&nbsp;_f_string;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;extern&nbsp;&amp;quot;C&amp;quot;&nbsp;_declspec(dllexport)&nbsp;void&nbsp;__stdcall&nbsp;init_string(action_string&nbsp;f)&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;{&amp;nbsp;&amp;nbsp;_f_string&nbsp;=f&nbsp;;&nbsp;}&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;//&nbsp;the&nbsp;unmanged&nbsp;code&nbsp;actually&nbsp;calls&nbsp;this&nbsp;code,&nbsp;<br>
e.g.&nbsp;do_string(&amp;quot;hello&amp;quot;)&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;extern&nbsp;&amp;quot;C&amp;quot;&nbsp;_declspec(dllexport)&nbsp;char*&nbsp;__stdcall&nbsp;do_string(char*&nbsp;s);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;{&amp;nbsp;&amp;nbsp;return&nbsp;_f_string(s);&nbsp;}&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;then&nbsp;in&nbsp;C#&nbsp;we&nbsp;write&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;//&nbsp;function:&nbsp;string-&amp;gt;string,&nbsp;equivalent&nbsp;to&nbsp;action_string&nbsp;above<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;public&nbsp;delegate&nbsp;string&nbsp;ActionString(string&nbsp;_);&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;//&nbsp;the&nbsp;managed&nbsp;code&nbsp;we&amp;#39;ll&nbsp;be&nbsp;calling&nbsp;from&nbsp;unmanaged&nbsp;code&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;public&nbsp;static&nbsp;string&nbsp;Echo(string&nbsp;s)&nbsp;{&nbsp;return&nbsp;s+s;&nbsp;}&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;//&nbsp;and&nbsp;the&nbsp;bootstrapper<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;[DllImport(&amp;quot;libhost&amp;quot;)]&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;init_string(ActionString&lt;br&gt;&amp;gt;&nbsp;s);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;public&nbsp;static&nbsp;void&nbsp;Boot&nbsp;{&nbsp;init_string(Echo);&nbsp;}&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;and&nbsp;again&nbsp;in&nbsp;C++,&nbsp;we&nbsp;can&nbsp;actually&nbsp;call&nbsp;the&nbsp;managed&nbsp;code&nbsp;like&nbsp;so<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;//&nbsp;find_method&nbsp;is&nbsp;just&nbsp;a&nbsp;shortcut&nbsp;using&nbsp;debug-helpers&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;MonoMethod&nbsp;*bootMethod&nbsp;=&nbsp;find_method(&amp;quot;Hello.World:Boot&amp;quot;,&nbsp;image);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&nbsp;mono_runtime_invoke(bootMethod,&nbsp;NULL,&nbsp;NULL,&nbsp;NULL);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;//&nbsp;now&nbsp;we&nbsp;have&nbsp;a&nbsp;function&nbsp;pointer&nbsp;we&nbsp;can&nbsp;call<br>
&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;char&nbsp;*result&nbsp;=&nbsp;do_string(&amp;quot;hello&amp;quot;);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;g_free(result);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;Everything&nbsp;works.&nbsp;However,&nbsp;there&nbsp;appears&nbsp;to&nbsp;be&nbsp;a&nbsp;memory&nbsp;leak.&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&lt;br&gt;&amp;gt;&nbsp;whether&nbsp;it&nbsp;is&nbsp;the&nbsp;input&nbsp;that&nbsp;is&nbsp;leaking&nbsp;(i.e.&nbsp;a&nbsp;copy&nbsp;of&amp;nbsp;&amp;nbsp;char*&amp;quot;hello&amp;quot;&nbsp;turned<br>
&lt;br&gt;&amp;gt;&nbsp;into&nbsp;utf16&amp;quot;hello&amp;quot;),&nbsp;or&nbsp;if&nbsp;I&nbsp;am&nbsp;improperly&nbsp;freeing&nbsp;the&nbsp;output&nbsp;(which&nbsp;I&nbsp;must&lt;br&gt;&amp;gt;&nbsp;assume&nbsp;is&nbsp;a&nbsp;copied&nbsp;string)&nbsp;or&nbsp;something&nbsp;else&nbsp;in&nbsp;the&nbsp;internals.&nbsp;What&nbsp;is&lt;br&gt;&amp;gt;&nbsp;encouraging&nbsp;is&nbsp;that&nbsp;all&nbsp;the&nbsp;marshalling&nbsp;is&nbsp;correct,&nbsp;just&nbsp;leaky.&nbsp;Also,&nbsp;if&nbsp;the<br>
&lt;br&gt;&amp;gt;&nbsp;managed&nbsp;code&nbsp;throws&nbsp;an&nbsp;exception,&nbsp;the&nbsp;program&nbsp;prints&nbsp;an&nbsp;error&nbsp;message&lt;br&gt;&amp;gt;&nbsp;(&amp;quot;uncaught&nbsp;exception&amp;quot;)&nbsp;and&nbsp;hangs.&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;what&nbsp;I&nbsp;would&nbsp;have&nbsp;expected&lt;br&gt;&amp;gt;&nbsp;on&nbsp;the&nbsp;C++&nbsp;side,&nbsp;perhaps&nbsp;a&nbsp;C++&nbsp;exception,&nbsp;perhaps&nbsp;silence.<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;gt;From&nbsp;the&nbsp;fact&nbsp;that&nbsp;the&nbsp;function&nbsp;pointers&nbsp;work&nbsp;at&nbsp;all,&nbsp;I&nbsp;can&nbsp;tell&nbsp;a&nbsp;lot&nbsp;of&lt;br&gt;&amp;gt;&nbsp;thought&nbsp;has&nbsp;already&nbsp;gone&nbsp;into&nbsp;this&nbsp;PInvoke&nbsp;stuff.&nbsp;What&nbsp;am&nbsp;I&nbsp;missing&nbsp;on&nbsp;the&lt;br&gt;&amp;gt;&nbsp;garbage&nbsp;collection&nbsp;side?&nbsp;(And&nbsp;as&nbsp;soon&nbsp;as&nbsp;the&nbsp;strings&nbsp;work,&nbsp;I&nbsp;need&nbsp;to&nbsp;worry<br>
&lt;br&gt;&amp;gt;&nbsp;about&nbsp;making&nbsp;sure&nbsp;that&nbsp;managed&nbsp;delegate&nbsp;doesn&amp;#39;t&nbsp;move&nbsp;or&nbsp;get&nbsp;garbage&lt;br&gt;&amp;gt;&nbsp;collected!)&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;Thanks&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;Sebastian&lt;br&gt;&amp;gt;&nbsp;_______________________________________________&lt;br&gt;&amp;gt;&nbsp;Mono-devel-list&nbsp;mailing&nbsp;list<br>
&lt;br&gt;&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&amp;gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list<br>
&lt;/a&gt;&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&lt;br&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
