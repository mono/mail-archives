
using System;
using System.Collections.Generic;
using System.Text;
using System.Runtime.InteropServices;

namespace CriticalHandleTest
{
    class Program
    {
        static void Main(string[] args)
        {
            for (int i = 0; i < 10; i++)
            {
                FinalizerTest ft = new FinalizerTest(i);
            }
            GC.Collect();
            GC.Collect();
            GC.Collect();
            Console.ReadLine();
        }
    }

    class FinalizerTest : CriticalHandle
    {
        private int instance = -1;

        public FinalizerTest(int i): this()
        {
            instance = i;
        }

        public FinalizerTest(): base(IntPtr.Zero)
        {
        }

        protected override bool ReleaseHandle ()
        {
            Console.WriteLine("Handle {0} was released!", instance);
            return true;
        }

        public override bool IsInvalid
        {
            get {
                return instance == -1;
            }
        }
    }
}


