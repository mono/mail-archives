? gdiplus.diff
Index: bitmap.c
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/bitmap.c,v
retrieving revision 1.7
diff -u -r1.7 bitmap.c
--- bitmap.c	13 Nov 2003 21:45:55 -0000	1.7
+++ bitmap.c	10 Jan 2004 16:10:58 -0000
@@ -341,7 +341,7 @@
 	*stride = d.Stride;
 	*fptr = d.PixelFormat;
 	*res = d.Reserved;
-	*scan0 = d.Scan0;
+	*scan0 = (int)d.Scan0;
 
 	return s;
 }
Index: brush.c
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/brush.c,v
retrieving revision 1.5
diff -u -r1.5 brush.c
--- brush.c	28 Nov 2003 05:47:57 -0000	1.5
+++ brush.c	10 Jan 2004 16:10:58 -0000
@@ -60,6 +60,7 @@
 GdipDeleteBrush (GpBrush *brush)
 {
         GdipFree (brush);
+	return Ok;
 }
 
 GpStatus
Index: gdip.h
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/gdip.h,v
retrieving revision 1.7
diff -u -r1.7 gdip.h
--- gdip.h	23 Dec 2003 10:32:15 -0000	1.7
+++ gdip.h	10 Jan 2004 16:10:58 -0000
@@ -16,7 +16,9 @@
 #include <stdio.h>
 
 #include <cairo.h>
+#ifndef CAIRO_HAS_XLIB_SURFACE
 #include <cairo-xlib.h>
+#endif
 #include <mono/io-layer/uglify.h>
 
 /*
@@ -236,6 +238,7 @@
         GpPenAlignment mode;
         float dash_offset;
         int dash_count;
+	int own_dash_array;
         float *dash_array;
         GpUnit unit;
         GpMatrix *matrix;
Index: gdip_win32.h
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/gdip_win32.h,v
retrieving revision 1.4
diff -u -r1.4 gdip_win32.h
--- gdip_win32.h	5 Nov 2003 23:44:58 -0000	1.4
+++ gdip_win32.h	10 Jan 2004 16:10:59 -0000
@@ -9,7 +9,9 @@
 #define _GDIP_WIN32_H
 
 #include <cairo.h>
+#ifndef CAIRO_HAS_XLIB_SURFACE
 #include <cairo-xlib.h>
+#endif
 #include <mono/io-layer/uglify.h>
 
 /* sizeof (GDIOBJHDR) = 12 (2 + 2 + 4 + 4) */
Index: graphics.c
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/graphics.c,v
retrieving revision 1.13
diff -u -r1.13 graphics.c
--- graphics.c	24 Dec 2003 18:23:45 -0000	1.13
+++ graphics.c	10 Jan 2004 16:10:59 -0000
@@ -292,6 +292,7 @@
 	return Ok;
 }
 
+// FIXME: the stack implementation is probably not suitable
 #define MAX_GRAPHICS_STATE_STACK 100
 
 GpState saved_stack [MAX_GRAPHICS_STATE_STACK];
@@ -303,6 +304,7 @@
 	if (graphicsState < MAX_GRAPHICS_STATE_STACK) {
 		cairo_matrix_copy (graphics->copy_of_ctm, saved_stack[graphicsState].matrix);
 		cairo_set_matrix (graphics->ct, graphics->copy_of_ctm);
+		current_stack_pos = graphicsState;
 	}
 	else {
 		return InvalidParameter;
Index: matrix.c
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/matrix.c,v
retrieving revision 1.6
diff -u -r1.6 matrix.c
--- matrix.c	23 Dec 2003 10:32:15 -0000	1.6
+++ matrix.c	10 Jan 2004 16:10:59 -0000
@@ -108,10 +108,10 @@
 {
         cairo_status_t status;
 
-        if (order == MatrixOrderPrepend)
+        if (order == MatrixOrderAppend)
                 status = cairo_matrix_multiply (matrix, matrix, matrix2);
 
-        else if (order == MatrixOrderAppend)
+        else if (order == MatrixOrderPrepend)
                 status = cairo_matrix_multiply (matrix, matrix2, matrix);
         
         else
Index: pen.c
===================================================================
RCS file: /cvs/public/mcs/class/System.Drawing/gdiplus/pen.c,v
retrieving revision 1.8
diff -u -r1.8 pen.c
--- pen.c	2 Dec 2003 20:52:05 -0000	1.8
+++ pen.c	10 Jan 2004 16:10:59 -0000
@@ -30,13 +30,19 @@
 gdip_pen_init (GpPen *pen)
 {
         pen->color = 0;
+		pen->brush = 0;
         pen->width = 1;
         pen->miter_limit = 10;
         pen->line_join = LineJoinMiter;
+	pen->dash_style = DashStyleSolid;
+	pen->line_cap = LineCapFlat;
+	pen->mode = PenAlignmentCenter;
+	pen->dash_offset = 0;
+	pen->dash_count = 0;
+	pen->own_dash_array = 0;
+	pen->dash_array = 0;
+	pen->unit = UnitWorld;
         pen->matrix = NULL;
-        pen->dash_offset = 0;
-        pen->line_cap = LineCapFlat;
-        pen->line_join = LineJoinMiter;
 }
 
 GpPen*
@@ -163,15 +169,22 @@
 GpStatus 
 GdipClonePen (GpPen *pen, GpPen **clonepen)
 {
+	// FIXME: copy dash array and matrix
         GpPen *result = gdip_pen_new ();
         result->color = pen->color;
+	result->brush = pen->brush;
         result->width = pen->width;
         result->miter_limit = pen->miter_limit;
         result->line_join = pen->line_join;
-        result->matrix = pen->matrix;
-        result->dash_offset = pen->dash_offset;
+	result->dash_style = pen->dash_style;
         result->line_cap = pen->line_cap;
-        result->line_join = pen->line_join;
+	result->mode = pen->mode;
+        result->dash_offset = pen->dash_offset;
+	result->dash_count = pen->dash_count;
+	result->own_dash_array = 0;
+	result->dash_array = pen->dash_array;
+	result->unit = pen->unit;
+        result->matrix = pen->matrix;
 
         *clonepen = result;
 
@@ -185,10 +198,11 @@
         if (pen->matrix != NULL)
                 cairo_matrix_destroy (pen->matrix);
 
-        if (pen->dash_array != NULL)
+        if (pen->dash_array != NULL && pen->own_dash_array)
                 free (pen->dash_array);
         
         GdipFree (pen);
+	return Ok;
 }
 
 GpStatus
