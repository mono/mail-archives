<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;May&nbsp;29,&nbsp;2009&nbsp;at&nbsp;5:14&nbsp;PM,&nbsp;Ulrich&nbsp;Weigand&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:uweigand@de.ibm.com&quot;&gt;uweigand@de.ibm.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
diff&nbsp;-urNp&nbsp;mono-2.4-orig/mono/metadata/metadata.c&nbsp;mono-2.4/mono/metadata/metadata.c&lt;br&gt;<br>
---&nbsp;mono-2.4-orig/mono/metadata/metadata.c&nbsp; &nbsp; &nbsp; 2009-02-14&nbsp;00:33:05.000000000&nbsp;+0100&lt;br&gt;<br>
+++&nbsp;mono-2.4/mono/metadata/metadata.c&nbsp; &nbsp;2009-05-28&nbsp;20:12:38.000000000&nbsp;+0200&lt;br&gt;<br>
@@&nbsp;-2196,7&nbsp;+2197,8&nbsp;@@&nbsp;inflated_method_in_image&nbsp;(gpointer&nbsp;key,&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; //&nbsp;&lt;a&nbsp;href=&quot;https://bugzilla.novell.com/show_bug.cgi?id=458168&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugzilla.novell.com/show_bug.cgi?id=458168&lt;/a&gt;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;method-&amp;gt;declaring-&amp;gt;klass-&amp;gt;image&nbsp;==&nbsp;image&nbsp;||&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (method-&amp;gt;context.class_inst&nbsp;&amp;amp;&amp;amp;&nbsp;ginst_in_image&nbsp;(method-&amp;gt;context.class_inst,&nbsp;image))&nbsp;||&lt;br&gt;<br>
-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(method-&amp;gt;context.method_inst&nbsp;&amp;amp;&amp;amp;&nbsp;ginst_in_image&nbsp;(method-&amp;gt;context.method_inst,&nbsp;image))&nbsp;||&nbsp;signature_in_image&nbsp;(mono_method_signature&nbsp;((MonoMethod*)method),&nbsp;image);&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(method-&amp;gt;context.method_inst&nbsp;&amp;amp;&amp;amp;&nbsp;ginst_in_image&nbsp;(method-&amp;gt;context.method_inst,&nbsp;image))&nbsp;||&lt;br&gt;<br>
+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(((MonoMethod*)method)-&amp;gt;signature&nbsp;&amp;amp;&amp;amp;&nbsp;signature_in_image&nbsp;(((MonoMethod*)method)-&amp;gt;signature,&nbsp;image));&lt;br&gt;<br>
 }&lt;br&gt;<br>
&lt;br&gt;<br>
 static&nbsp;gboolean&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;This&nbsp;has&nbsp;been&nbsp;fixed&nbsp;in&nbsp;trunk&nbsp;and&nbsp;2.4&lt;br&gt;&lt;br&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;br&gt;<br>
The&nbsp;second&nbsp;problem&nbsp;is&nbsp;related&nbsp;to&nbsp;wrapper&nbsp;classes&nbsp;allocated&nbsp;by&nbsp;the&lt;br&gt;<br>
routines&nbsp;in&nbsp;marshal.c.&nbsp; I&amp;#39;ve&nbsp;been&nbsp;seeing&nbsp;various&nbsp;instances&nbsp;of&nbsp;crashes&lt;br&gt;<br>
caused&nbsp;by&nbsp;those&nbsp;routines&nbsp;returning&nbsp;apparently&nbsp;clobbered&nbsp;method&nbsp;structures.&lt;br&gt;<br>
&lt;br&gt;<br>
It&nbsp;turns&nbsp;out&nbsp;this&nbsp;was&nbsp;caused&nbsp;by&nbsp;stale&nbsp;entried&nbsp;in&nbsp;the&nbsp;caches&nbsp;maintained&lt;br&gt;<br>
by&nbsp;the&nbsp;marshal.c&nbsp;routines.&nbsp; For&nbsp;example,&nbsp;the&lt;br&gt;<br>
MonoMethod&nbsp;*mono_marshal_get_static_rgctx_invoke&nbsp;(MonoMethod&nbsp;*method)&lt;br&gt;<br>
routine&nbsp;will&nbsp;store&nbsp;the&nbsp;MonoMethod&nbsp;structure&nbsp;describing&nbsp;the&nbsp;wrapper&nbsp;for&lt;br&gt;<br>
&amp;quot;method&amp;quot;&nbsp;into&nbsp;a&nbsp;cache&nbsp;allocated&nbsp;on&nbsp;the&nbsp;mempool&nbsp;associated&nbsp;with&nbsp;the&lt;br&gt;<br>
image&nbsp;related&nbsp;to&nbsp;the&nbsp;method&amp;#39;s&nbsp;class.&nbsp; For&nbsp;&amp;quot;normal&amp;quot;&nbsp;methods,&nbsp;the&nbsp;method&lt;br&gt;<br>
structure&nbsp;itself&nbsp;was&nbsp;already&nbsp;allocated&nbsp;on&nbsp;that&nbsp;same&nbsp;mempool,&nbsp;so&nbsp;the&lt;br&gt;<br>
wrapper&nbsp;has&nbsp;identical&nbsp;lifetime&nbsp;as&nbsp;the&nbsp;method&nbsp;it&nbsp;wraps.&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;there&nbsp;is&nbsp;one&nbsp;case&nbsp;where&nbsp;things&nbsp;are&nbsp;more&nbsp;complex:&nbsp;&amp;quot;inflated&amp;quot;&lt;br&gt;<br>
generic&nbsp;methods.&nbsp; These&nbsp;are&nbsp;*not*&nbsp;allocated&nbsp;on&nbsp;a&nbsp;mempool,&nbsp;but&nbsp;on&nbsp;the&lt;br&gt;<br>
heap,&nbsp;and&nbsp;will&nbsp;be&nbsp;freed&nbsp;at&nbsp;a&nbsp;certain&nbsp;point&nbsp;in&nbsp;time.&nbsp; However,&nbsp;nothing&lt;br&gt;<br>
ensures&nbsp;that&nbsp;any&nbsp;previously&nbsp;allocated&nbsp;wrapper&nbsp;for&nbsp;such&nbsp;a&nbsp;method&nbsp;is&lt;br&gt;<br>
also&nbsp;freed&nbsp;at&nbsp;this&nbsp;time.&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;does&nbsp;not&nbsp;matter&nbsp;much,&nbsp;as&nbsp;the&nbsp;wrapper&nbsp;cache&nbsp;is&lt;br&gt;<br>
indexed&nbsp;using&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;MonoMethod&nbsp;structure&nbsp;as&nbsp;key.&nbsp; If&nbsp;the&lt;br&gt;<br>
method&nbsp;no&nbsp;longer&nbsp;exists,&nbsp;it&nbsp;isn&amp;#39;t&nbsp;looked&nbsp;up,&nbsp;so&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;matter&nbsp;that&lt;br&gt;<br>
a&nbsp;stale&nbsp;value&nbsp;is&nbsp;still&nbsp;in&nbsp;the&nbsp;hash&nbsp;table.&lt;br&gt;<br>
&lt;br&gt;<br>
However,&nbsp;it&nbsp;*can*&nbsp;happen&nbsp;that&nbsp;a&nbsp;later&nbsp;allocation&nbsp;of&nbsp;a&nbsp;fresh&nbsp;MonoMethod&lt;br&gt;<br>
just&nbsp;happens&nbsp;to&nbsp;reside&nbsp;at&nbsp;the&nbsp;same&nbsp;address&nbsp;as&nbsp;a&nbsp;method&nbsp;that&nbsp;was&nbsp;deleted&lt;br&gt;<br>
previously.&nbsp; Now,&nbsp;when&nbsp;looking&nbsp;up&nbsp;a&nbsp;wrapper&nbsp;for&nbsp;the&nbsp;new&nbsp;method,&nbsp;the&lt;br&gt;<br>
stale&nbsp;entry&nbsp;for&nbsp;the&nbsp;old&nbsp;method&nbsp;may&nbsp;indeed&nbsp;be&nbsp;found.&nbsp; This&nbsp;causes&nbsp;various&lt;br&gt;<br>
problems;&nbsp;in&nbsp;particular,&nbsp;while&nbsp;the&nbsp;cached&nbsp;wrapper&nbsp;method&nbsp;itself&nbsp;is&nbsp;still&lt;br&gt;<br>
live,&nbsp;some&nbsp;of&nbsp;the&nbsp;structures&nbsp;it&nbsp;points&nbsp;to&nbsp;(type,&nbsp;signature)&nbsp;may&nbsp;themselves&lt;br&gt;<br>
have&nbsp;been&nbsp;deleted&nbsp;in&nbsp;the&nbsp;meantime,&nbsp;so&nbsp;random&nbsp;memory&nbsp;may&nbsp;be&nbsp;accessed.&lt;br&gt;<br>
&lt;br&gt;<br>
A&nbsp;similar&nbsp;problem&nbsp;seems&nbsp;to&nbsp;occur&nbsp;for&nbsp;dynamic&nbsp;methods,&nbsp;and&nbsp;for&nbsp;those&nbsp;it&lt;br&gt;<br>
seems&nbsp;special&nbsp;care&nbsp;is&nbsp;taken&nbsp;to&nbsp;remove&nbsp;wrappers&nbsp;for&nbsp;such&nbsp;methods&nbsp;from&nbsp;the&lt;br&gt;<br>
cache&nbsp;when&nbsp;the&nbsp;method&nbsp;is&nbsp;deleted&nbsp;(mono_marshal_free_dynamic_wrappers).&lt;br&gt;<br>
&lt;br&gt;<br>
It&nbsp;looks&nbsp;like&nbsp;a&nbsp;similar&nbsp;approach&nbsp;ought&nbsp;to&nbsp;be&nbsp;taken&nbsp;for&nbsp;inflated&nbsp;methods.&lt;br&gt;<br>
The&nbsp;following&nbsp;patch&nbsp;implements&nbsp;this.&nbsp; Again,&nbsp;I&amp;#39;m&nbsp;not&nbsp;complete&nbsp;sure&nbsp;this&lt;br&gt;<br>
is&nbsp;the&nbsp;right&nbsp;approach,&nbsp;but&nbsp;it&nbsp;fixes&nbsp;the&nbsp;symptoms&nbsp;for&nbsp;me.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;Your&nbsp;change&nbsp;isn&amp;#39;t&nbsp;required&nbsp;because&nbsp;you&nbsp;only&nbsp;remove&nbsp;from&nbsp;image&nbsp;hash&nbsp;tables,&lt;br&gt;which&nbsp;are&nbsp;released&nbsp;together&nbsp;with&nbsp;the&nbsp;inflated&nbsp;method.&lt;br&gt;&lt;br&gt;Can&nbsp;you&nbsp;try&nbsp;OpenSim&nbsp;using&nbsp;mono&nbsp;from&nbsp;the&nbsp;tip&nbsp;of&nbsp;the&nbsp;2.4&nbsp;branch?&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
