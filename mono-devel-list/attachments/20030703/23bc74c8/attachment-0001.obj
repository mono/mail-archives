Index: marshal.c
===================================================================
RCS file: /mono/mono/mono/metadata/marshal.c,v
retrieving revision 1.109
diff -u -p -r1.109 marshal.c
--- marshal.c	12 Jun 2003 16:33:38 -0000	1.109
+++ marshal.c	3 Jul 2003 21:19:59 -0000
@@ -560,7 +560,7 @@ emit_ptr_to_str_conv (MonoMethodBuilder 
 	switch (conv) {
 	case MONO_MARSHAL_CONV_BOOL_I4:
 		mono_mb_emit_byte (mb, CEE_LDLOC_0);
-		mono_mb_emit_byte (mb, CEE_LDIND_I);
+		mono_mb_emit_byte (mb, CEE_LDIND_I4);
 		mono_mb_emit_byte (mb, CEE_BRFALSE_S);
 		mono_mb_emit_byte (mb, 5);
 		mono_mb_emit_byte (mb, CEE_LDLOC_1);
@@ -4087,6 +4087,8 @@ mono_type_native_stack_size (MonoType *t
 	case MONO_TYPE_U2:
 	case MONO_TYPE_I4:
 	case MONO_TYPE_U4:
+		*align = 4;
+		return 4;
 	case MONO_TYPE_I:
 	case MONO_TYPE_U:
 	case MONO_TYPE_STRING:
@@ -4098,7 +4100,7 @@ mono_type_native_stack_size (MonoType *t
 	case MONO_TYPE_ARRAY:
 	case MONO_TYPE_TYPEDBYREF:
 		*align = 4;
-		return 4;
+		return sizeof(gpointer);
 	case MONO_TYPE_R4:
 		*align = 4;
 		return 4;
@@ -4129,6 +4131,10 @@ mono_type_native_stack_size (MonoType *t
 	return 0;
 }
 
+#ifndef __GNUC__
+#define __alignof__(type) G_STRUCT_OFFSET(struct { char c; type x; }, x)
+#endif
+
 gint32
 mono_marshal_type_size (MonoType *type, MonoMarshalSpec *mspec, gint32 *align, 
 			gboolean as_field, gboolean unicode)
@@ -4155,13 +4161,13 @@ mono_marshal_type_size (MonoType *type, 
 		return 4;
 	case MONO_NATIVE_I8:
 	case MONO_NATIVE_U8:
-		*align = 4;
+		*align = __alignof__(guint64);
 		return 8;
 	case MONO_NATIVE_R4:
 		*align = 4;
 		return 4;
 	case MONO_NATIVE_R8:
-		*align = 4;
+		*align = __alignof__(double);
 		return 8;
 	case MONO_NATIVE_INT:
 	case MONO_NATIVE_UINT:
@@ -4180,7 +4186,7 @@ mono_marshal_type_size (MonoType *type, 
 	case MONO_NATIVE_VARIANTBOOL:
 	case MONO_NATIVE_FUNC:
 	case MONO_NATIVE_LPSTRUCT:
-		*align =  4;
+		*align = __alignof__(gpointer);
 		return sizeof (gpointer);
 	case MONO_NATIVE_STRUCT: 
 		klass = mono_class_from_mono_type (type);
