<tt>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;20&nbsp;July&nbsp;2011&nbsp;16:05,&nbsp;Robert&nbsp;Jordan&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:robertj@gmx.net&quot;&gt;robertj@gmx.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Hi&nbsp;Tom!&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Hi&nbsp;Robert! &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;Nice&nbsp;:)&nbsp;Not&nbsp;exactly&nbsp;&amp;quot;Mixed&nbsp;Mode&nbsp;Assemblies&amp;quot;&nbsp;though,&nbsp;because&nbsp;the&lt;br&gt;<br>
<br>
really&nbsp;interesting&nbsp;part&nbsp;(calling&nbsp;unmanaged&nbsp;code&nbsp;w/out&nbsp;having&nbsp;to&lt;br&gt;<br>
go&nbsp;through&nbsp;p/invoke)&nbsp;remains&nbsp;the&nbsp;same&nbsp;pain.&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Absolutely&nbsp;-&nbsp;I&amp;#39;ve&nbsp;been&nbsp;thinking&nbsp;a&nbsp;lot&nbsp;about&nbsp;that&nbsp;direction,&nbsp;and&nbsp;I&nbsp;think&nbsp;you&amp;#39;d&nbsp;probably&nbsp;need&nbsp;to&nbsp;write/extend&nbsp;a&nbsp;compiler&nbsp;to&nbsp;do&nbsp;it&nbsp;properly/efficiently.&nbsp; What&nbsp;I&amp;#39;ve&nbsp;made&nbsp;is&nbsp;just&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;the&nbsp;Mono&nbsp;embedding&nbsp;API,&nbsp;exposing&nbsp;classes&nbsp;as&nbsp;symbols&nbsp;in&nbsp;a&nbsp;shared&nbsp;object.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;properly&nbsp;build&nbsp;a&nbsp;mixed-mode&nbsp;assembly,&nbsp;I&nbsp;guess&nbsp;you&amp;#39;d&nbsp;have&nbsp;to&nbsp;have&nbsp;a&nbsp;compiler&nbsp;that&nbsp;was&nbsp;aware&nbsp;of&nbsp;it&nbsp;-&nbsp;I&nbsp;think.&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
<br>
Out&nbsp;of&nbsp;curiosity:&nbsp;How&nbsp;are&nbsp;you&nbsp;handling&nbsp;more&nbsp;than&nbsp;one&nbsp;of&nbsp;those&lt;br&gt;<br>
&amp;quot;mixed&nbsp;assemblies&amp;quot;&nbsp;in&nbsp;the&nbsp;same&nbsp;process?&nbsp;Is&nbsp;there&nbsp;a&nbsp;function&lt;br&gt;<br>
inside&nbsp;libmono&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;detect&nbsp;an&nbsp;already&nbsp;initialized&lt;br&gt;<br>
runtime?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;An&nbsp;interesting&nbsp;question&nbsp;-&nbsp;because&nbsp;I&nbsp;was&nbsp;just&nbsp;pondering&nbsp;that&nbsp;myself.&nbsp; Answer&nbsp;is,&nbsp;I&nbsp;haven&amp;#39;t&nbsp;thought&nbsp;about&nbsp;it&nbsp;yet&nbsp;and&nbsp;so&nbsp;haven&amp;#39;t&nbsp;tackled&nbsp;the&nbsp;problem.&nbsp; I&nbsp;am&nbsp;hacking&nbsp;away&nbsp;at&nbsp;it&nbsp;just&nbsp;now,&nbsp;so&nbsp;eventually&nbsp;I&amp;#39;ll&nbsp;come&nbsp;across&nbsp;the&nbsp;issue!&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
On&nbsp;the&nbsp;generated&nbsp;stubs:&nbsp;are&nbsp;you&nbsp;using&nbsp;thunks&nbsp;or&nbsp;mono_runtime_invoke?&lt;br&gt;<br>
Are&nbsp;you&nbsp;rewriting&nbsp;the&nbsp;signature&nbsp;of&nbsp;the&nbsp;stubs&nbsp;to&nbsp;be&nbsp;HRESULT-like&lt;br&gt;<br>
(to&nbsp;be&nbsp;able&nbsp;to&nbsp;catch/detect&nbsp;managed&nbsp;exceptions)?&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;m&nbsp;using mono_method_get_unmanaged_thunk,&nbsp;and&nbsp;at&nbsp;the&nbsp;moment&nbsp;if&nbsp;any&nbsp;exception&nbsp;was&nbsp;raised&nbsp;(by&nbsp;use&nbsp;of&nbsp;the&nbsp;exception&nbsp;output&nbsp;parameter&nbsp;in&nbsp;the&nbsp;thunk),&nbsp;it&nbsp;just&nbsp;gets&nbsp;re-thrown&nbsp;in&nbsp;situ,&nbsp;and&nbsp;hence&nbsp;not&nbsp;handled&nbsp;by&nbsp;the&nbsp;calling&nbsp;code.&nbsp; What&nbsp;I&amp;#39;ve&nbsp;done&nbsp;is&nbsp;make&nbsp;GCC&nbsp;put&nbsp;the&nbsp;stubs&nbsp;into&nbsp;their&nbsp;own&nbsp;linker&nbsp;section&nbsp;that&amp;#39;s&nbsp;writable&nbsp;(so&nbsp;as&nbsp;to&nbsp;make&nbsp;it&nbsp;possible&nbsp;to&nbsp;patch&nbsp;the&nbsp;stubs&nbsp;at&nbsp;runtime),&nbsp;and&nbsp;to&nbsp;this&nbsp;end,&nbsp;I&amp;#39;d&nbsp;like&nbsp;to&nbsp;re-write&nbsp;the&nbsp;entire&nbsp;stub&nbsp;on&nbsp;first&nbsp;call,&nbsp;after&nbsp;it&amp;#39;s&nbsp;gotten&nbsp;the&nbsp;unmanaged&nbsp;thunk,&nbsp;to&nbsp;directly&nbsp;call&nbsp;the&nbsp;function&nbsp;pointer,&nbsp;thus&nbsp;reducing&nbsp;the&nbsp;overhead&nbsp;of&nbsp;the&nbsp;stub.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&amp;#39;s&nbsp;an&nbsp;interesting&nbsp;problem&nbsp;to&nbsp;tackle,&nbsp;because&nbsp;you&nbsp;need&nbsp;to&nbsp;provide&nbsp;this&nbsp;exception&nbsp;to&nbsp;the&nbsp;calling&nbsp;code&nbsp;somehow,&nbsp;but&nbsp;I&amp;#39;m&nbsp;trying&nbsp;to&nbsp;limit&nbsp;the&nbsp;amount&nbsp;of&nbsp;information&nbsp;exposed&nbsp;to&nbsp;the&nbsp;callers,&nbsp;as&nbsp;I&nbsp;wanted&nbsp;it&nbsp;to&nbsp;be&nbsp;as&nbsp;close&nbsp;to&nbsp;native&nbsp;as&nbsp;possible.&nbsp; So,the&nbsp;stubs,&nbsp;at&nbsp;the&nbsp;moment,&nbsp;are&nbsp;just&nbsp;direct&nbsp;copies&nbsp;of&nbsp;the&nbsp;managed&nbsp;method&nbsp;signatures&nbsp;(plus&nbsp;a&nbsp;*this&nbsp;parameter&nbsp;for&nbsp;instance&nbsp;methods).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Let&nbsp;me&nbsp;see&nbsp;if&nbsp;I&nbsp;can&nbsp;get&nbsp;the&nbsp;code&nbsp;uploaded&nbsp;somewhere.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Oh,&nbsp;and&nbsp;another&nbsp;interesting&nbsp;problem&nbsp;to&nbsp;solve&nbsp;is&nbsp;that&nbsp;of&nbsp;multi-threading,&nbsp;firstly&nbsp;as&nbsp;you&nbsp;need&nbsp;to&nbsp;call&nbsp;mono_thread_attach&nbsp;when&nbsp;using&nbsp;threads&nbsp;and&nbsp;the&nbsp;embedding&nbsp;API,&nbsp;and&nbsp;secondly&nbsp;race&nbsp;conditions&nbsp;between&nbsp;initialising&nbsp;the&nbsp;runtime&nbsp;and&nbsp;calling&nbsp;other&nbsp;functions.&nbsp; It&nbsp;may&nbsp;have&nbsp;to&nbsp;be&nbsp;some&nbsp;kind&nbsp;of&nbsp;terrible&nbsp;lock,&nbsp;or&nbsp;something.&lt;/div&gt;<br>
&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;color=&quot;#888888&quot;&gt;Robert&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;div&gt;--&nbsp;Tom&lt;/div&gt;<br>

</tt>
