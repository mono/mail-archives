<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Gerardo,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;very&nbsp;good&nbsp;Mono&nbsp;improvement.&nbsp;Could&nbsp;change&nbsp;your&nbsp;tests&nbsp;to&nbsp;fit&nbsp;mono&nbsp;nunit&nbsp;test&nbsp;style.&nbsp;It&nbsp;should&nbsp;not&nbsp;be&nbsp;too&nbsp;hard&nbsp;if&nbsp;you&nbsp;need&nbsp;guidance&nbsp;let&nbsp;me&nbsp;know&nbsp;or&nbsp;look&nbsp;how&nbsp;it&#39;s&nbsp;done&nbsp;for&nbsp;other&nbsp;mono&nbsp;parts.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Secondly&nbsp;to&nbsp;make&nbsp;the&nbsp;review&nbsp;and&nbsp;merge&nbsp;easier&nbsp;for&nbsp;us&nbsp;could&nbsp;you&nbsp;send&nbsp;pull&nbsp;request&nbsp;with&nbsp;your&nbsp;changes.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&lt;/div&gt;&lt;div&gt;Marek&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;am&nbsp;Gerardo&nbsp;García&nbsp;Peña&nbsp;and&nbsp;I&#39;m&nbsp;new&nbsp;in&nbsp;this&nbsp;list.&lt;br&gt;&lt;br&gt;Some&nbsp;months&nbsp;ago&nbsp;started&nbsp;working&nbsp;with&nbsp;mono&nbsp;in&nbsp;a&nbsp;project&nbsp;which&nbsp;demands&nbsp;a&nbsp;very&nbsp;precise&nbsp;manipulation&nbsp;of&nbsp;UTF8&nbsp;(and&nbsp;other&nbsp;encodings)&nbsp;streams.&nbsp;When&nbsp;I&nbsp;started&nbsp;to&nbsp;write&nbsp;code&nbsp;I&nbsp;observed&nbsp;that&nbsp;the&nbsp;mono&nbsp;UTF8&nbsp;implementation&nbsp;is&nbsp;very&nbsp;buggy,&nbsp;while&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;http://MS.NET&quot;&nbsp;target=&quot;_blank&quot;&gt;MS.NET&lt;/a&gt;&nbsp;implementation&nbsp;is&nbsp;quite&nbsp;good.&nbsp;Then&nbsp;I&nbsp;started&nbsp;to&nbsp;isolate&nbsp;the&nbsp;bugs&nbsp;and&nbsp;filled&nbsp;some&nbsp;bugs&nbsp;in&nbsp;the&nbsp;Ximian&#39;s&nbsp;bugzilla&nbsp;[1]&nbsp;[2].&nbsp;They&#39;re&nbsp;still&nbsp;there&nbsp;and&nbsp;unfixed,&nbsp;but&nbsp;I&nbsp;think&nbsp;they&nbsp;are&nbsp;important:&nbsp;an&nbsp;incompatibility&nbsp;in&nbsp;the&nbsp;text&nbsp;codec&nbsp;subsystems&nbsp;virtually&nbsp;affects&nbsp;any&nbsp;application&nbsp;that&nbsp;need&nbsp;portability&nbsp;between&nbsp;Microsoft&nbsp;and&nbsp;Mono&nbsp;platforms.&nbsp;Specially&nbsp;from&nbsp;the&nbsp;data&nbsp;integrity&nbsp;point&nbsp;of&nbsp;view,&nbsp;and&nbsp;in&nbsp;some&nbsp;cases&nbsp;availability&nbsp;security&nbsp;issues&nbsp;(indexes&nbsp;and&nbsp;counters&nbsp;reported&nbsp;by&nbsp;the&nbsp;conversion&nbsp;methods&nbsp;and&nbsp;throwed&nbsp;exceptions&nbsp;could&nbsp;make&nbsp;apps&nbsp;running&nbsp;on&nbsp;the&nbsp;Mono&nbsp;environment&nbsp;to&nbsp;enter&nbsp;into&nbsp;infinite&nbsp;loops,&nbsp;making&nbsp;apps&nbsp;running&nbsp;on&nbsp;the&nbsp;mono&nbsp;runtime&nbsp;vulnerable&nbsp;to&nbsp;DoS&nbsp;attacks).&lt;br&gt;<br>
<br>
&lt;br&gt;The&nbsp;bugs&nbsp;are&nbsp;still&nbsp;there&nbsp;(unresolved),&nbsp;and&nbsp;during&nbsp;this&nbsp;time&nbsp;I&nbsp;have&nbsp;found&nbsp;some&nbsp;more,&nbsp;so&nbsp;I&nbsp;decided&nbsp;to&nbsp;start&nbsp;patching&nbsp;the&nbsp;UTF8&nbsp;libraries&nbsp;(and&nbsp;in&nbsp;the&nbsp;future,&nbsp;if&nbsp;this&nbsp;patch&nbsp;is&nbsp;accepted,&nbsp;I&nbsp;will&nbsp;continue&nbsp;working&nbsp;on&nbsp;other&nbsp;buggy&nbsp;codec&nbsp;that&nbsp;appears).&lt;br&gt;<br>
<br>
&lt;br&gt;The&nbsp;patch&nbsp;that&nbsp;I&nbsp;propose&nbsp;is&nbsp;an&nbsp;important&nbsp;modification&nbsp;of&nbsp;the&nbsp;file&nbsp;/mono/mcs/class/corlib/System.Text/UTF8Encoding.cs&nbsp;and&nbsp;some&nbsp;minor&nbsp;changes&nbsp;in&nbsp;other&nbsp;generic&nbsp;classes&nbsp;in&nbsp;System.Text.&nbsp;The&nbsp;targets&nbsp;of&nbsp;my&nbsp;patch&nbsp;are&nbsp;the&nbsp;following:&lt;br&gt;<br>
<br>
&lt;br&gt; &nbsp;-&nbsp;give&nbsp;a&nbsp;complete&nbsp;and&nbsp;good&nbsp;quality&nbsp;UTF8&nbsp;coder&nbsp;&amp;&nbsp;decoder&nbsp;implementation,&lt;br&gt; &nbsp;-&nbsp;at&nbsp;least&nbsp;it&nbsp;is&nbsp;as&nbsp;much&nbsp;efficient&nbsp;as&nbsp;the&nbsp;old&nbsp;implementation,&lt;br&gt; &nbsp;-&nbsp;better&nbsp;error&nbsp;handling&nbsp;and&nbsp;quick&nbsp;resync&nbsp;when&nbsp;bad&nbsp;sequences&nbsp;are&nbsp;found,&lt;br&gt;<br>
<br>
 &nbsp;-&nbsp;fix&nbsp;the&nbsp;index&nbsp;field&nbsp;in&nbsp;the&nbsp;Fallback&nbsp;exceptions&nbsp;(it&nbsp;is&nbsp;a&nbsp;key&nbsp;feature&nbsp;if&nbsp;one&lt;br&gt;   &nbsp;program&nbsp;want&nbsp;to&nbsp;handle&nbsp;strings&nbsp;with&nbsp;errors),&lt;br&gt; &nbsp;-&nbsp;refactorize&nbsp;and&nbsp;make&nbsp;code&nbsp;more&nbsp;maintainable,&lt;br&gt; &nbsp;-&nbsp;full&nbsp;compatibility&nbsp;with&nbsp;the&nbsp;.NET&nbsp;implementation&nbsp;(behaviour&nbsp;is&nbsp;exactly&nbsp;the&lt;br&gt;<br>
<br>
   &nbsp;same&nbsp;in&nbsp;front&nbsp;of&nbsp;bad&nbsp;and&nbsp;good&nbsp;sequences),&lt;br&gt; &nbsp;-&nbsp;complete&nbsp;some&nbsp;pending&nbsp;or&nbsp;incomplete&nbsp;features&nbsp;(MonoTODO)&nbsp;like&lt;br&gt;   &nbsp;Encoder::FallbackException::IsUnknownSurrogate()&nbsp;or&nbsp;use&nbsp;of&nbsp;BOM&lt;br&gt;   &nbsp;preambles.&lt;br&gt;&lt;br&gt;Please&nbsp;note&nbsp;that&nbsp;in&nbsp;spite&nbsp;of&nbsp;presenting&nbsp;a&nbsp;full-compatible&nbsp;implementation&nbsp;of&nbsp;this&nbsp;codec&nbsp;with&nbsp;the&nbsp;Microsoft&nbsp;implementation,&nbsp;my&nbsp;changes&nbsp;are&nbsp;not&nbsp;based&nbsp;on&nbsp;Microsoft&#39;s&nbsp;work,&nbsp;and&nbsp;they&nbsp;are&nbsp;totally&nbsp;written&nbsp;from&nbsp;scratch.&nbsp;I&nbsp;have&nbsp;not&nbsp;reversed&nbsp;any&nbsp;code&nbsp;and&nbsp;the&nbsp;behaviour&nbsp;of&nbsp;my&nbsp;patches&nbsp;has&nbsp;been&nbsp;tunned&nbsp;using&nbsp;an&nbsp;extensive&nbsp;and&nbsp;exhaustive&nbsp;test&nbsp;case.&lt;br&gt;<br>
<br>
&lt;br&gt;My&nbsp;test&nbsp;case&nbsp;uses&nbsp;several&nbsp;public&nbsp;UTF8&nbsp;test&nbsp;cases&nbsp;and&nbsp;one&nbsp;specific&nbsp;and&nbsp;giant&nbsp;UTF16&nbsp;test&nbsp;case&nbsp;built&nbsp;automatically.&nbsp;The&nbsp;test&nbsp;case&nbsp;must&nbsp;be&nbsp;executed&nbsp;first&nbsp;on&nbsp;the&nbsp;Mono&nbsp;runtime&nbsp;environment&nbsp;and&nbsp;once&nbsp;again&nbsp;on&nbsp;the&nbsp;Microsoft&nbsp;runtime.&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;test&nbsp;case&nbsp;are&nbsp;two&nbsp;directories&nbsp;(one&nbsp;for&nbsp;mono,&nbsp;another&nbsp;for&nbsp;net)&nbsp;documenting&nbsp;the&nbsp;output&nbsp;of&nbsp;(and&nbsp;exceptions&nbsp;thrown)&nbsp;the&nbsp;Convert()&nbsp;method.&nbsp;Once&nbsp;both&nbsp;executions&nbsp;are&nbsp;finished,&nbsp;it&nbsp;should&nbsp;not&nbsp;exist&nbsp;any&nbsp;difference&nbsp;between&nbsp;the&lt;br&gt;<br>
<br>
two&nbsp;output&nbsp;directories.&lt;br&gt;&lt;br&gt;The&nbsp;test&nbsp;case&nbsp;is&nbsp;focused&nbsp;only&nbsp;on&nbsp;the&nbsp;Convert()&nbsp;method&nbsp;because&nbsp;it&nbsp;allows&nbsp;to&nbsp;test&nbsp;any&nbsp;variation&nbsp;of&nbsp;the&nbsp;input.&nbsp;My&nbsp;implementation&nbsp;(and&nbsp;probably&nbsp;Microsoft&#39;s&nbsp;too)&nbsp;is&nbsp;based&nbsp;on&nbsp;two&nbsp;coder/decoder&nbsp;functions&nbsp;that&nbsp;are&nbsp;called&nbsp;by&nbsp;all&nbsp;the&nbsp;other&nbsp;public&nbsp;methods.&nbsp;Because&nbsp;that&nbsp;reason&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;test&nbsp;both&nbsp;implementations&nbsp;is&nbsp;using&nbsp;the&nbsp;method&nbsp;that&nbsp;exposes&nbsp;more&nbsp;directly&nbsp;the&nbsp;internal&nbsp;decoder/encoder.&lt;br&gt;<br>
<br>
&lt;br&gt;I&nbsp;posted&nbsp;the&nbsp;changes&nbsp;and&nbsp;my&nbsp;test&nbsp;suite&nbsp;in&nbsp;a&nbsp;github&nbsp;branch,&nbsp;and&nbsp;I&nbsp;also&nbsp;have&nbsp;attached&nbsp;them&nbsp;to&nbsp;this&nbsp;mail&nbsp;(if&nbsp;you&nbsp;want&nbsp;to&nbsp;test&nbsp;it&nbsp;quickly&nbsp;without&nbsp;doing&nbsp;any&nbsp;git&nbsp;operation):&lt;br&gt;&lt;br&gt; &nbsp;-&nbsp;mono&nbsp;branch&nbsp;with&nbsp;my&nbsp;patches&lt;br&gt;   &nbsp;&lt;a&nbsp;href=&quot;https://github.com/killabytenow/mono&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/killabytenow/mono&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;br&gt; &nbsp;-&nbsp;test&nbsp;suite&lt;br&gt;   &nbsp;&lt;a&nbsp;href=&quot;https://github.com/killabytenow/mono-System.Text.UTF8Encoding-test&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/killabytenow/mono-System.Text.UTF8Encoding-test&lt;/a&gt;&lt;br&gt;&lt;br&gt;To&nbsp;run&nbsp;the&nbsp;test&nbsp;suite,&nbsp;run&nbsp;the&nbsp;makefile&nbsp;and&nbsp;then&nbsp;execute&nbsp;the&nbsp;program&nbsp;convert.exe&nbsp;in&nbsp;the&nbsp;two&nbsp;platforms.&nbsp;You&#39;ll&nbsp;get&nbsp;a&nbsp;&#39;cnvout-mono&#39;&nbsp;and&nbsp;&#39;cnvout-other&#39;&nbsp;directories&nbsp;which&nbsp;will&nbsp;contain&nbsp;the&nbsp;output&nbsp;of&nbsp;each&nbsp;test&nbsp;run.&nbsp;Once&nbsp;they&nbsp;have&nbsp;finished&nbsp;run&nbsp;the&nbsp;&#39;mkdiff.sh&#39;&nbsp;shell&nbsp;script.&nbsp;This&nbsp;script&nbsp;will&nbsp;make&nbsp;a&nbsp;&#39;cnvout-diff&#39;&nbsp;directory,&nbsp;which&nbsp;should&nbsp;be&nbsp;empty&nbsp;if&nbsp;all&nbsp;files&nbsp;are&nbsp;equal.&lt;br&gt;<br>
<br>
&lt;br&gt;I&nbsp;know&nbsp;that&nbsp;it&nbsp;is&nbsp;an&nbsp;important&nbsp;patch&nbsp;because&nbsp;it&nbsp;affects&nbsp;the&nbsp;corlib&nbsp;libraries&nbsp;which&nbsp;are&nbsp;critical&nbsp;for&nbsp;the&nbsp;Mono&nbsp;runtime.&nbsp;If&nbsp;you&nbsp;have&nbsp;any&nbsp;question&nbsp;or&nbsp;note&nbsp;about&nbsp;the&nbsp;code,&nbsp;or&nbsp;if&nbsp;I&nbsp;can&nbsp;do&nbsp;anything&nbsp;to&nbsp;improve&nbsp;this&nbsp;patch,&nbsp;I&nbsp;will&nbsp;be&nbsp;glad&nbsp;to&nbsp;help.&lt;br&gt;<br>
<br>
&lt;br&gt;Thanks&nbsp;in&nbsp;advance,&lt;br&gt;Gerardo&nbsp;García&nbsp;Peña&lt;br&gt;&lt;br&gt;[1]&nbsp;10692&nbsp;&lt;a&nbsp;href=&quot;https://bugzilla.xamarin.com/show_bug.cgi?id=10692&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugzilla.xamarin.com/show_bug.cgi?id=10692&lt;/a&gt;&lt;br&gt;[2]&nbsp;10697&nbsp;&lt;a&nbsp;href=&quot;https://bugzilla.xamarin.com/show_bug.cgi?id=10697&quot;&nbsp;target=&quot;_blank&quot;&gt;https://bugzilla.xamarin.com/show_bug.cgi?id=10697&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
