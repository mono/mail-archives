<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jul&nbsp;29,&nbsp;2008&nbsp;at&nbsp;7:35&nbsp;PM,&nbsp;Kornél&nbsp;Pál&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:kornelpal@gmail.com&quot;&gt;kornelpal@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
-For&nbsp;simple&nbsp;methods&nbsp;such&nbsp;as&nbsp;OffsetToStringData&nbsp;the&nbsp;method&nbsp;call&nbsp;overhead&nbsp;might&nbsp;be&nbsp;a&nbsp;killer.&nbsp;We&lt;br&gt;<br>
should&nbsp;make&nbsp;sure&nbsp;that&nbsp;these&nbsp;new&nbsp;wrappers&nbsp;get&nbsp;a&nbsp;change&nbsp;to&nbsp;be&nbsp;inlined.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Currently&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;get&nbsp;inlined&nbsp;because&nbsp;the&nbsp;JIT&nbsp;has&nbsp;some&nbsp;logic&lt;br&gt;<br>
preventing&nbsp;(at&nbsp;least&nbsp;types)&nbsp;of&nbsp;wrappers&nbsp;being&nbsp;inlined&nbsp;but&nbsp;should&nbsp;be&lt;br&gt;<br>
possible&nbsp;to&nbsp;inline&nbsp;them.&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
-I&amp;#39;m&nbsp;not&nbsp;aware&nbsp;of&nbsp;how&nbsp;stack&nbsp;traces&nbsp;behave&nbsp;with&nbsp;wrappers,&nbsp;but&nbsp;are&nbsp;they&nbsp;preserved&nbsp;with&nbsp;your&nbsp;patch?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
As&nbsp;long&nbsp;as&nbsp;they&nbsp;are&nbsp;not&nbsp;inlined&nbsp;the&nbsp;stack&nbsp;trace&nbsp;is&nbsp;preserved.&nbsp;But&nbsp;this&lt;br&gt;<br>
is&nbsp;true&nbsp;for&nbsp;Class&nbsp;Library&nbsp;methods&nbsp;implemented&nbsp;in&nbsp;C#&nbsp;so&nbsp;icall&nbsp;builders&lt;br&gt;<br>
should&nbsp;not&nbsp;be&nbsp;treated&nbsp;differently.&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
-Does&nbsp;it&nbsp;work&nbsp;under&nbsp;trunk?&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
It&nbsp;should&nbsp;but&nbsp;the&nbsp;patch&nbsp;may&nbsp;be&nbsp;outdated.&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
-Do&nbsp;you&nbsp;have&nbsp;performance&nbsp;numbers&nbsp;on&nbsp;your&nbsp;change?&nbsp;Since&nbsp;it&nbsp;changes&nbsp;performance&nbsp;sensitive&lt;br&gt;<br>
parts&nbsp;of&nbsp;the&nbsp;runtime,&nbsp;attaching&nbsp;a&nbsp;benchmark&nbsp;(or&nbsp;pointing&nbsp;to&nbsp;an&nbsp;existing&nbsp;one)&nbsp;showing&nbsp;the&nbsp;implications&nbsp;is&lt;br&gt;<br>
fundamental.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
These&nbsp;are&nbsp;only&nbsp;reference&nbsp;implementations&nbsp;and&nbsp;OffsetToStringData&nbsp;for&lt;br&gt;<br>
example&nbsp;is&nbsp;slower&nbsp;for&nbsp;sure&nbsp;because&nbsp;it&nbsp;don&amp;#39;t&nbsp;get&nbsp;inlined.&nbsp;I&nbsp;expect&nbsp;string&nbsp;.ctors&nbsp;to&nbsp;have&nbsp;the&nbsp;same&nbsp;performance&nbsp;because&nbsp;the&nbsp;generated&nbsp;IL&nbsp;code&nbsp;is&nbsp;the&nbsp;same&nbsp;but&nbsp;using&nbsp;icall&nbsp;builder&nbsp;is&nbsp;a&nbsp;clean&nbsp;way&nbsp;as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;current&nbsp;hack.&nbsp;UnsafeAddrOfPinnedArrayElement&nbsp;should&nbsp;benefit&nbsp;because&nbsp;no&nbsp;native&nbsp;code&nbsp;will&nbsp;be&nbsp;called.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
As&nbsp;for&nbsp;OffsetToStringData&nbsp;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;whether&nbsp;mini_get_inst_for_method&nbsp;or&nbsp;an&nbsp;icall&nbsp;builder&nbsp;is&nbsp;faster&nbsp;when&nbsp;generating&nbsp;the&nbsp;code&nbsp;but&nbsp;using&nbsp;an&nbsp;icall&nbsp;builder&nbsp;solves&nbsp;the&nbsp;things&nbsp;at&nbsp;the&nbsp;highest&nbsp;possible&nbsp;level&nbsp;letting&nbsp;low&nbsp;level&nbsp;optimizations&nbsp;do&nbsp;their&nbsp;job.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
I&nbsp;don&amp;#39;t&nbsp;insist&nbsp;on&nbsp;getting&nbsp;these&nbsp;reference&nbsp;icall&nbsp;builder&nbsp;implementations&lt;br&gt;<br>
into&nbsp;trunk&nbsp;I&nbsp;just&nbsp;would&nbsp;like&nbsp;to&nbsp;get&nbsp;approval&nbsp;for&nbsp;the&nbsp;concept&nbsp;and&nbsp;the&nbsp;support&nbsp;code&nbsp;of&nbsp;icall&nbsp;builders.&nbsp;Actual&nbsp;icall&nbsp;builder&nbsp;implementations&nbsp;could&nbsp;be&nbsp;evaluated&nbsp;independently.&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;the&nbsp;attched&nbsp;test&nbsp;I&nbsp;got:&lt;br&gt;<br>
mono&nbsp;r109162:&nbsp;99060&lt;br&gt;<br>
mono&nbsp;r109162&nbsp;with&nbsp;my&nbsp;patch:&nbsp;17375&nbsp;(5.7x&nbsp;faster)&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://MS.NET&quot;&nbsp;target=&quot;_blank&quot;&gt;MS.NET&lt;/a&gt;&nbsp;2.0&nbsp;SP1:&nbsp;17898&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;imporvement&nbsp;is&nbsp;purely&nbsp;because&nbsp;of&nbsp;the&nbsp;method&nbsp;being&nbsp;implemented&nbsp;in&nbsp;managed&nbsp;code.&nbsp;So&nbsp;mono&nbsp;would&nbsp;benefit&nbsp;form&nbsp;icall&nbsp;builders&nbsp;for&nbsp;sure.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;code&nbsp;that&nbsp;decides&nbsp;what&nbsp;to&nbsp;be&nbsp;inlined&nbsp;is&nbsp;too&nbsp;cryptic&nbsp;to&nbsp;me&nbsp;because&nbsp;I&nbsp;believe&nbsp;that&nbsp;there&nbsp;are&nbsp;redundant&nbsp;checks&nbsp;against&nbsp;wrappers&nbsp;but&nbsp;if&nbsp;someone&nbsp;could&nbsp;enable&nbsp;the&nbsp;inlining&nbsp;of&nbsp;managed-to-managed&nbsp;wrappers&nbsp;icall&nbsp;builders&nbsp;could&nbsp;provide&nbsp;even&nbsp;more&nbsp;performance&nbsp;improvement.&lt;br&gt;<br>
<br>
&lt;/blockquote&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;br&gt;<br>
I&nbsp;also&nbsp;have&nbsp;attached&nbsp;an&nbsp;updated&nbsp;patch.&nbsp;(Only&nbsp;line&nbsp;numbers&nbsp;were&nbsp;updated&nbsp;no&nbsp;code&nbsp;modification&nbsp;was&nbsp;necessary.)&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;Making&nbsp;those&nbsp;wrappers&nbsp;inlineable&nbsp;should&nbsp;be&nbsp;straight&nbsp;forward,&nbsp;just&nbsp;add&nbsp;a&nbsp;mono_marshal_is_managed_icall&nbsp;that&nbsp;checks&nbsp;this&nbsp;info&nbsp;and&nbsp;verify&nbsp;for&nbsp;it&nbsp;in&nbsp;mono_method_check_inlining&nbsp;and&nbsp;in&nbsp;the&nbsp;code_block&nbsp;that&nbsp;activates&nbsp;inlining&nbsp;for&nbsp;CEE_CALL.&nbsp;I&nbsp;don&amp;#39;t&nbsp;understand&nbsp;the&nbsp;particularities&nbsp;of&nbsp;wrappers,&nbsp;so&nbsp;it&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;good&nbsp;idea&nbsp;making&nbsp;all&nbsp;M2M&nbsp;wrapper&nbsp;inlinable.&nbsp;Other&nbsp;than&nbsp;that,&nbsp;it&nbsp;might&nbsp;be&nbsp;interesting&nbsp;to&nbsp;have&nbsp;support&nbsp;to&nbsp;force&nbsp;it&nbsp;on&nbsp;some&nbsp;of&nbsp;then&nbsp;as&nbsp;well.&lt;br&gt;<br>
&lt;br&gt;Other&nbsp;option&nbsp;is&nbsp;to&nbsp;kill&nbsp;the&nbsp;inline_info&nbsp;bit&nbsp;in&nbsp;MonoMethod&nbsp;and&nbsp;use&nbsp;the&nbsp;space&nbsp;for&nbsp;a&nbsp;force_inline&nbsp;bit.&nbsp;inline_info&nbsp;can&nbsp;easily&nbsp;be&nbsp;replaced&nbsp;by&nbsp;a&nbsp;hash&nbsp;table&nbsp;in&nbsp;mini.c.&nbsp;This&nbsp;would&nbsp;be&nbsp;more&nbsp;general&nbsp;and&nbsp;useful.&lt;br&gt;&lt;br&gt;I&nbsp;like&nbsp;the&nbsp;idea&nbsp;of&nbsp;having&nbsp;some&nbsp;intrinsics&nbsp;expressed&nbsp;as&nbsp;IL&nbsp;instead&nbsp;of&nbsp;the&nbsp;mini_get_inst_for_method&nbsp;mess.&nbsp;Maybe&nbsp;we&nbsp;should&nbsp;move&nbsp;to&nbsp;use&nbsp;this&nbsp;model&nbsp;and&nbsp;just&nbsp;leave&nbsp;the&nbsp;icall&nbsp;machine&nbsp;as&nbsp;it&nbsp;currently&nbsp;is.&lt;br&gt;<br>
&lt;br&gt;I&nbsp;think&nbsp;this&nbsp;patch&nbsp;is&nbsp;really&nbsp;nice,&nbsp;so&nbsp;unless&nbsp;someone&nbsp;else&nbsp;opposes&nbsp;to&nbsp;it&nbsp;we&nbsp;should&nbsp;move&nbsp;forward&nbsp;to&nbsp;put&nbsp;it&nbsp;into&nbsp;commit&nbsp;shape&nbsp;-&nbsp;split&nbsp;the&nbsp;patch&nbsp;in&nbsp;a&nbsp;few&nbsp;smaller&nbsp;ones:&nbsp;one&nbsp;with&nbsp;just&nbsp;the&nbsp;new&nbsp;icall&nbsp;machinery,&nbsp;other&nbsp;adding&nbsp;the&nbsp;inlining&nbsp;behavior&nbsp;changes&nbsp;and&nbsp;finally&nbsp;another&nbsp;one&nbsp;with&nbsp;the&nbsp;converted&nbsp;icalls&nbsp;of&nbsp;your&nbsp;patch.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;Rodrigo&lt;br&gt;&lt;/div&gt;<br>

</tt>
