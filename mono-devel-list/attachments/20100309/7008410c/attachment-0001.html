<tt>
Hi&nbsp;Paolo,&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;spent&nbsp;some&nbsp;time&nbsp;talking&nbsp;with&nbsp;Zoltan&nbsp;and&nbsp;reading&nbsp;more&nbsp;code&nbsp;from&nbsp;the&nbsp;runtime&nbsp;and&nbsp;I&nbsp;have&nbsp;the&nbsp;follow&nbsp;proposal&nbsp;for&nbsp;fixing&nbsp;the&nbsp;problem.&lt;br&gt;First,&nbsp;the&nbsp;problem&nbsp;is&nbsp;that&nbsp;we&nbsp;must&nbsp;not&nbsp;abort&nbsp;finally&nbsp;blocks,&nbsp;the&nbsp;exception&nbsp;must&nbsp;be&nbsp;thrown&nbsp;right&nbsp;after&nbsp;it&nbsp;ends.&lt;br&gt;<br>
<br>
There&nbsp;are&nbsp;two&nbsp;options&nbsp;to&nbsp;fix&nbsp;this.&lt;br&gt;&lt;br&gt;One&nbsp;is&nbsp;to&nbsp;patch&nbsp;the&nbsp;return&nbsp;address&nbsp;of&nbsp;a&nbsp;finally&nbsp;clause&nbsp;to&nbsp;jump&nbsp;into&nbsp;runtime&nbsp;code&nbsp;that&nbsp;will&nbsp;handle&nbsp;raising&nbsp;the&nbsp;ThreadAbortException.&lt;br&gt;This&nbsp;is&nbsp;very&nbsp;tricky&nbsp;because&nbsp;we&nbsp;need&nbsp;to&nbsp;store&nbsp;precise&nbsp;unwind&nbsp;information&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;figure&nbsp;out&nbsp;where&nbsp;that&nbsp;value&nbsp;is.&nbsp;The&nbsp;advantage&nbsp;is&lt;br&gt;<br>
<br>
that&nbsp;is&nbsp;doesn&amp;#39;t&nbsp;slow&nbsp;down&nbsp;the&nbsp;fast&nbsp;path.&lt;br&gt;&lt;br&gt;The&nbsp;other&nbsp;option&nbsp;is&nbsp;to&nbsp;change&nbsp;how&nbsp;finally&nbsp;clauses&nbsp;work&nbsp;so&nbsp;they&nbsp;make&nbsp;this&nbsp;easier.&nbsp;Zoltan&nbsp;mentioned&nbsp;that&nbsp;we&nbsp;should&nbsp;restore&nbsp;from&nbsp;EH&nbsp;context&nbsp;and&nbsp;use&nbsp;a&nbsp;variable&nbsp;to&nbsp;tell&nbsp;what&nbsp;to&nbsp;do&nbsp;next.&nbsp;The&nbsp;pseudo-code&nbsp;for&nbsp;the&nbsp;fast-path&nbsp;are&nbsp;something&nbsp;like:&lt;br&gt;<br>
<br>
&lt;br&gt;Currently:&lt;br&gt;try_body:&lt;br&gt;  &nbsp;...&lt;br&gt; &nbsp;call&nbsp;finally&lt;br&gt; &nbsp;jmp&nbsp;rest_of_function&lt;br&gt;finally:&lt;br&gt; &nbsp;...&lt;br&gt; &nbsp;ret&lt;br&gt;rest_of_function:&lt;br&gt; &nbsp;...&lt;br&gt;&lt;br&gt;Zoltan&amp;#39;s&nbsp;suggestion:&lt;br&gt;&lt;br&gt;try&nbsp;body:&lt;br&gt; &nbsp;... &nbsp;&lt;br&gt; &nbsp;mov&nbsp;0,&nbsp;[EBP&nbsp;+&nbsp;?]&nbsp;//this&nbsp;is&nbsp;the&nbsp;variable&nbsp;that&nbsp;tells&nbsp;to&nbsp;resume&nbsp;unwinding&nbsp;or&nbsp;not&lt;br&gt;<br>
 &nbsp;jmp&nbsp;finally;&lt;br&gt;finally:&lt;br&gt; ...&lt;br&gt; cmp&nbsp;0,&nbsp;[EBP&nbsp;+&nbsp;?]&lt;br&gt; jmp_if_zero&nbsp;rest_of_function&lt;br&gt; call&nbsp;resume_unwinding&lt;br&gt;rest_of_function:&lt;br&gt; ...&lt;br&gt;&lt;br&gt;Looking&nbsp;at&nbsp;the&nbsp;pseudo&nbsp;code,&nbsp;currently&nbsp;we&nbsp;do&nbsp;3&nbsp;branches&nbsp;(call,&nbsp;ret,&nbsp;jmp)&nbsp;with&nbsp;Zoltan&amp;#39;s&nbsp;suggestion&lt;br&gt;<br>
<br>
we&nbsp;would&nbsp;do&nbsp;only&nbsp;two&nbsp;(jmp,&nbsp;jz),&nbsp;thou&nbsp;one&nbsp;is&nbsp;conditional.&nbsp;The&nbsp;memory&nbsp;bandwidth&nbsp;is&nbsp;the&nbsp;same,&lt;br&gt;both&nbsp;require&nbsp;one&nbsp;load&nbsp;and&nbsp;one&nbsp;store.&nbsp;Zoltan&amp;#39;s&nbsp;suggestion&nbsp;should&nbsp;result&nbsp;in&nbsp;larger&nbsp;code&nbsp;thou.&lt;br&gt;&lt;br&gt;But&nbsp;his&nbsp;suggestion,&nbsp;of&nbsp;course,&nbsp;can&nbsp;be&nbsp;optimized&nbsp;to&nbsp;do&nbsp;a&nbsp;lot&nbsp;better,&nbsp;something&nbsp;like&nbsp;the&nbsp;following&lt;br&gt;<br>
<br>
won&amp;#39;t&nbsp;be&nbsp;unusual&nbsp;since&nbsp;ordinary&nbsp;&amp;quot;try&nbsp;{}&nbsp;finally&nbsp;{}&amp;quot;&nbsp;code&nbsp;is&nbsp;laid&nbsp;out&nbsp;sequentialy:&lt;br&gt;&lt;br&gt;&lt;br&gt;try&nbsp;body:&lt;br&gt; &nbsp;...&lt;br&gt; &nbsp;mov&nbsp;0,&nbsp;[EBP&nbsp;+&nbsp;?]&nbsp;//this&nbsp;is&nbsp;the&nbsp;variable&nbsp;that&nbsp;tells&nbsp;to&nbsp;resume&nbsp;unwinding&nbsp;or&nbsp;jump&nbsp;somewhere&nbsp;else&lt;br&gt;<br>
 &nbsp;//no&nbsp;jmp,&nbsp;we&nbsp;just&nbsp;fall&nbsp;thru&lt;br&gt;<br>
finally:&lt;br&gt; &nbsp;...&lt;br&gt; &nbsp;cmp&nbsp;0,&nbsp;[EBP&nbsp;+&nbsp;?]&lt;br&gt; &nbsp;jmp_if_not_zero&nbsp;out_of_line_block&lt;br&gt;rest_of_function:&lt;br&gt; &nbsp;...&lt;br&gt;&lt;br&gt;out_of_line_block:&lt;br&gt; &nbsp;call&nbsp;resume_unwinding&lt;br&gt;&lt;br&gt;&lt;br&gt;The&nbsp;version&nbsp;is&nbsp;faster&nbsp;than&nbsp;what&nbsp;we&nbsp;currently&nbsp;generates&nbsp;and&nbsp;enables&nbsp;us&nbsp;to&lt;br&gt;<br>
<br>
trap&nbsp;finally&nbsp;handlers&nbsp;without&nbsp;doing&nbsp;something&nbsp;tricky&nbsp;as&nbsp;return&nbsp;address&nbsp;patching.&lt;br&gt;&lt;br&gt;For&nbsp;the&nbsp;cases&nbsp;where&nbsp;we&nbsp;have&nbsp;many&nbsp;leave&nbsp;instructions&nbsp;that&nbsp;target&nbsp;different&nbsp;instructions&lt;br&gt;we&nbsp;can&nbsp;generate&nbsp;either&nbsp;a&nbsp;jump&nbsp;table,&nbsp;a&nbsp;series&nbsp;of&nbsp;tests&nbsp;or&nbsp;set&nbsp;the&nbsp;destination&nbsp;variable&nbsp;to&lt;br&gt;<br>
an&nbsp;offset&nbsp;and&nbsp;use&nbsp;an&nbsp;indirect&nbsp;relative&nbsp;jump.&nbsp;All&nbsp;of&nbsp;those&nbsp;depending&nbsp;on&nbsp;what&nbsp;platform/target&lt;br&gt;we&nbsp;are.&nbsp;(AOT&nbsp;x86&nbsp;is&nbsp;better&nbsp;served&nbsp;with&nbsp;an&nbsp;indirect&nbsp;rel&nbsp;jump&nbsp;while&nbsp;ARM&nbsp;can&nbsp;always&nbsp;use&nbsp;a&lt;br&gt;jump&nbsp;table).&lt;br&gt;&lt;br&gt;From&nbsp;our&nbsp;irc&nbsp;log,&nbsp;you&nbsp;raised&nbsp;a&nbsp;few&nbsp;issues&nbsp;with&nbsp;this&nbsp;approach,&nbsp;first&nbsp;that&nbsp;is&nbsp;might&nbsp;cause&lt;br&gt;<br>
issues&nbsp;with&nbsp;the&nbsp;ppc&nbsp;ABI.&nbsp;This&nbsp;approach&nbsp;is&nbsp;basically&nbsp;the&nbsp;same&nbsp;to&nbsp;how&nbsp;we&nbsp;handle&nbsp;catch&lt;br&gt;<br>
clauses&nbsp;and&nbsp;the&nbsp;later&nbsp;doesn&amp;#39;t&nbsp;seen&nbsp;to&nbsp;have&nbsp;issues.&lt;br&gt;&lt;br&gt;You&nbsp;also&nbsp;mentioned&nbsp;that&nbsp;a&nbsp;finally&nbsp;clause&nbsp;can&nbsp;be&nbsp;called&nbsp;in&nbsp;a&nbsp;different&nbsp;stack&nbsp;frame&nbsp;that&lt;br&gt;of&nbsp;its&nbsp;original&nbsp;method.&nbsp;I&nbsp;fail&nbsp;to&nbsp;see&nbsp;how&nbsp;could&nbsp;that&nbsp;happen,&nbsp;specially&nbsp;if&nbsp;we&amp;#39;ll&nbsp;be&nbsp;restoring&nbsp;to&nbsp;it.&lt;br&gt;<br>
<br>
&lt;br&gt;I&nbsp;do&nbsp;support&nbsp;Zoltan&nbsp;that&nbsp;this&nbsp;approach&nbsp;is&nbsp;the&nbsp;way&nbsp;to&nbsp;go,&nbsp;but&nbsp;I&nbsp;rather&nbsp;hear&nbsp;your&nbsp;opinion&nbsp;first.&lt;br&gt;Even&nbsp;if&nbsp;it&nbsp;ends&nbsp;up&nbsp;been&nbsp;marginally&nbsp;slower,&nbsp;it&nbsp;has&nbsp;the&nbsp;advantage&nbsp;of&nbsp;been&nbsp;much&nbsp;much&nbsp;simpler,&lt;br&gt;which&nbsp;wins&nbsp;us&nbsp;in&nbsp;development&nbsp;time&nbsp;and&nbsp;reliability.&lt;br&gt;<br>
<br>
&lt;br&gt;Thanks,&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;<br>

</tt>
