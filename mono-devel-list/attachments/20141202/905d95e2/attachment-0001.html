<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Calibri<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;&lt;font&nbsp;color=&quot;#000000&quot;&nbsp;face=&quot;Calibri,sans-serif&quot;&gt;Can&nbsp;you&nbsp;send&nbsp;a&nbsp;pull&nbsp;request&nbsp;on&nbsp;GitHub?&nbsp;&lt;br&nbsp;id=&quot;FontBreak&quot;&gt;&lt;/font&gt;&lt;br&gt;&nbsp;&lt;BR&gt;&lt;div&gt;&gt;&nbsp;Date:&nbsp;Tue,&nbsp;2&nbsp;Dec&nbsp;2014&nbsp;12:01:29&nbsp;+0100&lt;br&gt;&gt;&nbsp;From:&nbsp;markus.beth@zkrd.de&lt;br&gt;&gt;&nbsp;To:&nbsp;mono-devel-list@lists.ximian.com&lt;br&gt;&gt;&nbsp;Subject:&nbsp;[Mono-dev]&nbsp;file&nbsp;handle&nbsp;leak&nbsp;in&nbsp;cpu_load&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Hi&nbsp;all,&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;last&nbsp;week&nbsp;we&nbsp;used&nbsp;the&nbsp;profiler&nbsp;of&nbsp;a&nbsp;mono&nbsp;3.10.0&nbsp;installation&nbsp;on&nbsp;&lt;br&gt;&gt;&nbsp;Linux&nbsp;x86_64&nbsp;and&nbsp;we&nbsp;found&nbsp;it&nbsp;leaks&nbsp;file&nbsp;handles&nbsp;(for&nbsp;/proc/loadavg).&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;I&nbsp;located&nbsp;the&nbsp;problem&nbsp;in&nbsp;the&nbsp;function&nbsp;cpu_load&nbsp;in&nbsp;&lt;br&gt;&gt;&nbsp;mono/utils/mono-counters.c.&nbsp;If&nbsp;a&nbsp;premature&nbsp;return&nbsp;is&nbsp;taken,&nbsp;the&nbsp;FILE&nbsp;&lt;br&gt;&gt;&nbsp;pointer&nbsp;f&nbsp;is&nbsp;not&nbsp;fclose()-ed.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;I&nbsp;propose&nbsp;the&nbsp;following&nbsp;fix:&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;---&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;mono/utils/mono-counters.c&nbsp;|&nbsp;2&nbsp;+-&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;1&nbsp;file&nbsp;changed,&nbsp;1&nbsp;insertion(+),&nbsp;1&nbsp;deletion(-)&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;diff&nbsp;--git&nbsp;a/mono/utils/mono-counters.c&nbsp;b/mono/utils/mono-counters.c&lt;br&gt;&gt;&nbsp;index&nbsp;1e0840c..c669454&nbsp;100644&lt;br&gt;&gt;&nbsp;---&nbsp;a/mono/utils/mono-counters.c&lt;br&gt;&gt;&nbsp;+++&nbsp;b/mono/utils/mono-counters.c&lt;br&gt;&gt;&nbsp;@@&nbsp;-360,6&nbsp;+360,7&nbsp;@@&nbsp;cpu_load&nbsp;(int&nbsp;kind)&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*f&nbsp;=&nbsp;fopen&nbsp;(&quot;/proc/loadavg&quot;,&nbsp;&quot;r&quot;);&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(f)&nbsp;{&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;=&nbsp;fread&nbsp;(buffer,&nbsp;1,&nbsp;sizeof&nbsp;(buffer)&nbsp;-&nbsp;1,&nbsp;f);&lt;br&gt;&gt;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose&nbsp;(f);&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(len&nbsp;&gt;&nbsp;0)&nbsp;{&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buffer&nbsp;[len&nbsp;&lt;&nbsp;511&nbsp;?&nbsp;len&nbsp;:&nbsp;511]&nbsp;=&nbsp;0;&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;buffer;&lt;br&gt;&gt;&nbsp;@@&nbsp;-374,7&nbsp;+375,6&nbsp;@@&nbsp;cpu_load&nbsp;(int&nbsp;kind)&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&gt;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose&nbsp;(f);&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;#endif&lt;br&gt;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;&lt;br&gt;&gt;&nbsp;--&nbsp;&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;It&nbsp;applies&nbsp;on&nbsp;master&nbsp;and&nbsp;also&nbsp;(with&nbsp;an&nbsp;offset&nbsp;of&nbsp;-32&nbsp;lines)&nbsp;on&nbsp;&lt;br&gt;&gt;&nbsp;mono-3.10.0-branch.&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;What&nbsp;do&nbsp;you&nbsp;think?&lt;br&gt;&gt;&nbsp;&lt;br&gt;&gt;&nbsp;Regards,&lt;br&gt;&gt;&nbsp;Markus&lt;br&gt;&gt;&nbsp;_______________________________________________&lt;br&gt;&gt;&nbsp;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&gt;&nbsp;Mono-devel-list@lists.ximian.com&lt;br&gt;&gt;&nbsp;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;br&gt;&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
