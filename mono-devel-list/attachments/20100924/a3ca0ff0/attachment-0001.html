<tt>
Hey&nbsp;Mark&nbsp;and&nbsp;Paolo,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ve&nbsp;speed&nbsp;some&nbsp;time&nbsp;looking&nbsp;into&nbsp;speeding&nbsp;up&nbsp;variant&nbsp;type&nbsp;cast&nbsp;as&nbsp;one&nbsp;can&nbsp;expect&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;a&nbsp;lot&nbsp;more&nbsp;with&nbsp;4.0&lt;/div&gt;&lt;div&gt;since&nbsp;a&nbsp;lot&nbsp;of&nbsp;central&nbsp;types&nbsp;have&nbsp;been&nbsp;made&nbsp;variant.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;first&nbsp;looked&nbsp;into&nbsp;making&nbsp;a&nbsp;managed&nbsp;version&nbsp;of&nbsp;the&nbsp;casting&nbsp;code&nbsp;for&nbsp;variant&nbsp;types&nbsp;but&nbsp;this&nbsp;is&nbsp;incredibly&nbsp;hard,&nbsp;to&nbsp;say&nbsp;the&nbsp;least,&lt;/div&gt;&lt;div&gt;due&nbsp;to&nbsp;2&nbsp;issues,&nbsp;it&nbsp;has&nbsp;to&nbsp;inspect&nbsp;the&nbsp;instantiation&nbsp;vector&nbsp;of&nbsp;the&nbsp;target&nbsp;type&nbsp;(which&nbsp;is&nbsp;made&nbsp;of&nbsp;MonoType&nbsp;values)&nbsp;and&nbsp;it&nbsp;has &lt;/div&gt;<br>
&lt;div&gt;to&nbsp;iterate&nbsp;thru&nbsp;all&nbsp;interfaces&nbsp;of&nbsp;a&nbsp;given&nbsp;type.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;is&nbsp;not&nbsp;impossible,&nbsp;but&nbsp;it&amp;#39;s&nbsp;a&nbsp;lot&nbsp;work&nbsp;and&nbsp;probably&nbsp;quite&nbsp;some&nbsp;extra&nbsp;memory&nbsp;to&nbsp;make&nbsp;it&nbsp;fast.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;I&nbsp;decided&nbsp;to&nbsp;avoid&nbsp;the&nbsp;whole&nbsp;problem&nbsp;and&nbsp;go&nbsp;with&nbsp;adding&nbsp;an&nbsp;one&nbsp;entry&nbsp;cache&nbsp;in&nbsp;front&nbsp;of&nbsp;the&nbsp;casting&nbsp;op.&nbsp;It&amp;#39;s&nbsp;significantly faster&lt;/div&gt;<br>
&lt;div&gt;when&nbsp;the&nbsp;hit&nbsp;ratio&nbsp;is&nbsp;high&nbsp;and&nbsp;the&nbsp;cache&nbsp;test&nbsp;could&nbsp;be&nbsp;inlined&nbsp;for&nbsp;extra&nbsp;performance&nbsp;(right&nbsp;now&nbsp;it&amp;#39;s&nbsp;an&nbsp;icall).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;got&nbsp;this&nbsp;working&nbsp;on&nbsp;on&nbsp;this&nbsp;branch&nbsp;of&nbsp;github: &lt;a&nbsp;href=&quot;http://github.com/kumpera/mono/commits/fast_variant_cast&quot;&gt;http://github.com/kumpera/mono/commits/fast_variant_cast&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Then&nbsp;I&nbsp;went&nbsp;into&nbsp;checking&nbsp;real&nbsp;world&nbsp;usefulness&nbsp;and&nbsp;found&nbsp;out&nbsp;that&nbsp;this&nbsp;change&nbsp;does&nbsp;no&nbsp;good&nbsp;at&nbsp;all.&nbsp;At&nbsp;least&nbsp;with&nbsp;the&nbsp;benchmarks&lt;/div&gt;&lt;div&gt;I&nbsp;selected.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;IronPython&nbsp;does&nbsp;a&nbsp;constant&nbsp;number&nbsp;of&nbsp;casting&nbsp;operations,&nbsp;so&nbsp;it&amp;#39;s&nbsp;not&nbsp;usable.&lt;/div&gt;<br>
&lt;div&gt;The&nbsp;test&nbsp;suites&nbsp;of&nbsp;corlib&nbsp;and&nbsp;sys.core&nbsp;revealed&nbsp;one&nbsp;critical&nbsp;bug&nbsp;with&nbsp;my&nbsp;approach,&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;it&amp;#39;s&nbsp;not&lt;/div&gt;&lt;div&gt;possible&nbsp;to&nbsp;statically&nbsp;known&nbsp;if&nbsp;we&amp;#39;re&nbsp;handling&nbsp;with&nbsp;a&nbsp;generic&nbsp;variant&nbsp;type&nbsp;or&nbsp;not.&nbsp;And&nbsp;this&nbsp;is&nbsp;99.999%&nbsp;of&nbsp;all&nbsp;casts&nbsp;to&nbsp;variant&nbsp;types&lt;/div&gt;<br>
&lt;div&gt;on&nbsp;those&nbsp;tests.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;this&nbsp;left&nbsp;me&nbsp;with&nbsp;two&nbsp;options.&nbsp;Make&nbsp;mono_object_isinst&nbsp;faster&nbsp;with&nbsp;variant&nbsp;types&nbsp;or&nbsp;look&nbsp;into&nbsp;caching&nbsp;all&nbsp;casts&nbsp;ops&lt;/div&gt;&lt;div&gt;under&nbsp;gsharing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;ll&nbsp;try&nbsp;enabling&nbsp;caching&nbsp;for&nbsp;all&nbsp;gshared&nbsp;cast&nbsp;ops&nbsp;first,&nbsp;then&nbsp;into&nbsp;making&nbsp;mono_object_isinst&nbsp;faster&nbsp;if&nbsp;needed.&nbsp;How&nbsp;to&nbsp;do&lt;/div&gt;<br>
&lt;div&gt;it&nbsp;still&nbsp;an&nbsp;open&nbsp;problem&nbsp;but&nbsp;looks&nbsp;easy&nbsp;for&nbsp;types&nbsp;without&nbsp;nested&nbsp;variance&nbsp;-&nbsp;not&nbsp;IEnumerable&amp;lt;Func&amp;lt;string,string&amp;gt;&amp;gt;&nbsp;for&nbsp;example.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;tried&nbsp;to&nbsp;enable&nbsp;caching&nbsp;for&nbsp;all&nbsp;gshared&nbsp;casts&nbsp;but&nbsp;I&amp;#39;m&nbsp;bumping&nbsp;into&nbsp;a&nbsp;runtime&nbsp;crash&nbsp;in&nbsp;the&nbsp;innards&nbsp;of&nbsp;the&nbsp;gsharing&nbsp;code.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Any&nbsp;advices,&nbsp;tips&nbsp;or&nbsp;a&nbsp;code&nbsp;review&nbsp;of&nbsp;the&nbsp;mentioned&nbsp;branch?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Cheers,&lt;/div&gt;&lt;div&gt;Rodrigo&lt;/div&gt;<br>

</tt>
