<tt>
Hey&nbsp;Mark,&lt;br&gt;&lt;br&gt;@@&nbsp;-762,7&nbsp;+774,8&nbsp;@@&lt;br&gt;&amp;nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;THREAD_DEBUG&nbsp;(g_message&nbsp;(&amp;quot;%s:&nbsp;Attached&nbsp;thread&nbsp;ID&nbsp;%&amp;quot;G_GSIZE_FORMAT&amp;quot;&nbsp;(handle&nbsp;%p)&amp;quot;,&nbsp;__func__,&nbsp;tid,&nbsp;thread_handle));&lt;br&gt;&amp;nbsp;&lt;br&gt;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;handle_store(thread);&lt;br&gt;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;may_start&nbsp;=&nbsp;handle_store(thread);<br>
&lt;br&gt;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;g_assert&nbsp;(may_start);&lt;br&gt;&lt;br&gt;Why&nbsp;are&nbsp;you&nbsp;asserting&nbsp;here?&nbsp;Shouldn&amp;#39;t&nbsp;the&nbsp;thread&nbsp;just&nbsp;play&nbsp;dead&nbsp;is&nbsp;may_start&nbsp;is&nbsp;false?&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Dec&nbsp;13,&nbsp;2007&nbsp;12:14&nbsp;PM,&nbsp;Mark&nbsp;Probst&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mark.probst@gmail.com&quot;&gt;<br>
mark.probst@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Hi&nbsp;Paolo,&nbsp;Dick,&nbsp;and&nbsp;everybody&nbsp;else!&lt;br&gt;&lt;br&gt;Here&amp;#39;s&nbsp;the&nbsp;new&nbsp;shutdown&nbsp;code&nbsp;which&nbsp;should&nbsp;fix&nbsp;bugs&nbsp;#337383&nbsp;and&nbsp;#347676.<br>
&lt;br&gt;&lt;br&gt;We&nbsp;have&nbsp;two&nbsp;shutdown&nbsp;paths&nbsp;in&nbsp;Mono:&lt;br&gt;&lt;br&gt;*&nbsp;Implicit&nbsp;exit:&nbsp;All&nbsp;threads&nbsp;shut&nbsp;down&nbsp;normally&lt;br&gt;*&nbsp;Explicit&nbsp;exit:&nbsp;Some&nbsp;thread&nbsp;calls&nbsp;System.Environment.Exit()&lt;br&gt;&lt;br&gt;In&nbsp;implicit&nbsp;exit&nbsp;the&nbsp;main&nbsp;thread&nbsp;shuts&nbsp;Mono&nbsp;down.&nbsp;&amp;nbsp;In&nbsp;explicit&nbsp;exit<br>
&lt;br&gt;whichever&nbsp;thread&nbsp;executes&nbsp;Exit()&nbsp;shuts&nbsp;down&nbsp;Mono.&lt;br&gt;&lt;br&gt;Problem:&nbsp;Two&nbsp;(or&nbsp;more)&nbsp;threads&nbsp;might&nbsp;attempt&nbsp;shutdown&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&lt;br&gt;That&amp;#39;s&nbsp;what&nbsp;mono_threads_set_shutting_down()&nbsp;is&nbsp;for:&nbsp;Make&nbsp;sure&nbsp;only&nbsp;one&lt;br&gt;thread&nbsp;gets&nbsp;to&nbsp;shut&nbsp;Mono&nbsp;down,&nbsp;the&nbsp;others&nbsp;just&nbsp;die&nbsp;or&nbsp;play&nbsp;dead.<br>
&lt;br&gt;&lt;br&gt;Before&nbsp;shutting&nbsp;down&nbsp;Mono&nbsp;all&nbsp;threads&nbsp;must&nbsp;quit&nbsp;or&nbsp;must&nbsp;be&nbsp;suspended.&lt;br&gt;To&nbsp;avoid&nbsp;deadlock&nbsp;(two&nbsp;threads&nbsp;waiting&nbsp;for&nbsp;each&nbsp;other&amp;#39;s&nbsp;suspension&nbsp;or&lt;br&gt;death,&nbsp;which&nbsp;can&nbsp;happen&nbsp;if&nbsp;the&nbsp;main&nbsp;thread&nbsp;is&nbsp;finished&nbsp;and&nbsp;waits&nbsp;for&nbsp;the<br>
&lt;br&gt;other&nbsp;threads&nbsp;and&nbsp;another&nbsp;thread&nbsp;wants&nbsp;to&nbsp;shut&nbsp;down&nbsp;via&nbsp;Exit)&nbsp;a&nbsp;thread&lt;br&gt;about&nbsp;to&nbsp;shut&nbsp;Mono&nbsp;down&nbsp;must&nbsp;set&nbsp;its&nbsp;status&nbsp;to&nbsp;finished&nbsp;(so&nbsp;that&nbsp;the&lt;br&gt;main&nbsp;thread&nbsp;will&nbsp;wake&nbsp;up&nbsp;from&nbsp;its&nbsp;waiting&nbsp;loop,&nbsp;realize&nbsp;that&nbsp;someone&lt;br&gt;<br>
wants&nbsp;to&nbsp;shut&nbsp;down,&nbsp;and&nbsp;get&nbsp;out&nbsp;of&nbsp;the&nbsp;game),&nbsp;and&nbsp;a&nbsp;thread&nbsp;wanting&nbsp;to&lt;br&gt;shut&nbsp;down,&nbsp;but&nbsp;failing&nbsp;(because&nbsp;another&nbsp;thread&nbsp;came&nbsp;first)&nbsp;must&nbsp;either&lt;br&gt;quit&nbsp;or&nbsp;pretend,&nbsp;as&nbsp;well.&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;what&nbsp;mono_threads_set_shutting_down()&nbsp;does,&nbsp;atomically&nbsp;(it<br>
&lt;br&gt;acquires&nbsp;the&nbsp;threads&nbsp;lock):&lt;br&gt;&lt;br&gt;mono_threads_set_shutting_down&nbsp;(bool&nbsp;may_abort)&nbsp;{&lt;br&gt;&nbsp;&amp;nbsp;if&nbsp;(shutting_down)&nbsp;{&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;//&nbsp;somebody&nbsp;else&nbsp;is&nbsp;already&nbsp;shutting&nbsp;down&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;if&nbsp;(may_abort)&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;call&nbsp;Thread.Abort()&nbsp;on&nbsp;self<br>
&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;else&nbsp;{&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;play&nbsp;dead;&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}&lt;br&gt;&nbsp;&amp;nbsp;}&nbsp;else&nbsp;{&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;shutting_down&nbsp;=&nbsp;TRUE;&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;set&nbsp;self&nbsp;status&nbsp;to&nbsp;finished,&nbsp;but&nbsp;don&amp;#39;t&nbsp;actually&nbsp;quit;&lt;br&gt;&nbsp;&amp;nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;We&nbsp;make&nbsp;sure&nbsp;(via&nbsp;the&nbsp;threads&nbsp;lock)&nbsp;that&nbsp;no&nbsp;thread&nbsp;can&nbsp;start&nbsp;(although<br>
&lt;br&gt;they&nbsp;can&nbsp;still&nbsp;be&nbsp;created)&nbsp;after&nbsp;mono_threads_set_shutting_down()&nbsp;has&lt;br&gt;been&nbsp;called&nbsp;for&nbsp;the&nbsp;first&nbsp;time.&lt;br&gt;&lt;br&gt;Here&nbsp;are&nbsp;the&nbsp;two&nbsp;shutdown&nbsp;paths:&lt;br&gt;&lt;br&gt;Main&nbsp;thread,&nbsp;after&nbsp;Main()&nbsp;has&nbsp;exited:&lt;br&gt;&lt;br&gt;do&nbsp;{&lt;br&gt;&nbsp;&amp;nbsp;wait&nbsp;for&nbsp;threads&nbsp;to&nbsp;change&nbsp;state;<br>
&lt;br&gt;&nbsp;&amp;nbsp;//&nbsp;some&nbsp;threads&nbsp;changed&nbsp;state&lt;br&gt;&nbsp;&amp;nbsp;if&nbsp;(somebody&nbsp;else&nbsp;is&nbsp;exiting)&lt;br&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;play&nbsp;dead;&lt;br&gt;}&nbsp;while&nbsp;(!all&nbsp;threads&nbsp;finished);&lt;br&gt;//&nbsp;all&nbsp;threads&nbsp;are&nbsp;finished&nbsp;now,&nbsp;but&nbsp;some&nbsp;threads&nbsp;might&nbsp;still&nbsp;start&nbsp;in&lt;br&gt;//&nbsp;this&nbsp;window&lt;br&gt;mono_threads_set_shutting_down(FALSE);<br>
&lt;br&gt;//&nbsp;we&amp;#39;re&nbsp;allowed&nbsp;to&nbsp;shut&nbsp;down,&nbsp;and&nbsp;no&nbsp;more&nbsp;threads&nbsp;can&nbsp;start&nbsp;now&lt;br&gt;abort&nbsp;all&nbsp;other&nbsp;threads;&lt;br&gt;shut&nbsp;down;&lt;br&gt;&lt;br&gt;Some&nbsp;thread&nbsp;(could&nbsp;be&nbsp;main&nbsp;thread),&nbsp;from&nbsp;Exit():&lt;br&gt;&lt;br&gt;mono_threads_set_shutting_down(TRUE);&lt;br&gt;//&nbsp;we&amp;#39;re&nbsp;allowed&nbsp;to&nbsp;shut&nbsp;down,&nbsp;and&nbsp;no&nbsp;more&nbsp;threads&nbsp;can&nbsp;start&nbsp;now<br>
&lt;br&gt;suspend&nbsp;all&nbsp;other&nbsp;threads;&lt;br&gt;shut&nbsp;down;&lt;br&gt;&lt;br&gt;Does&nbsp;the&nbsp;patch&nbsp;look&nbsp;ok?&nbsp;&amp;nbsp;Any&nbsp;cases&nbsp;I&amp;#39;ve&nbsp;missed?&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;Mark&lt;br&gt;&lt;/font&gt;&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list<br>
&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
