Index: security.c
===================================================================
--- security.c	(revision 36050)
+++ security.c	(working copy)
@@ -12,7 +12,10 @@
 #endif
 
 #include <mono/metadata/appdomain.h>
+#include <mono/metadata/cil-coff.h>
 #include <mono/metadata/exception.h>
+#include <mono/metadata/object-internals.h>
+#include <mono/metadata/metadata-internals.h>
 #include <mono/metadata/security.h>
 #include <mono/io-layer/io-layer.h>
 #include <mono/utils/strenc.h>
@@ -932,3 +935,26 @@
 #endif
 	return ret;
 }
+
+
+/*
+ * Returns TRUE if there is "something" where the Authenticode signature is 
+ * normally located. Returns FALSE is data directory is empty.
+ *
+ * Note: Neither the structure nor the signature is verified by this function.
+ */
+MonoBoolean
+ves_icall_System_Security_Policy_Evidence_IsAuthenticodePresent (MonoReflectionAssembly *refass)
+{
+	if (refass && refass->assembly && refass->assembly->image) {
+		MonoCLIImageInfo *iinfo = refass->assembly->image->image_info;
+		if (iinfo && &iinfo) {
+			MonoDotNetHeader *header = &iinfo->cli_header;
+			if (header) {
+				MonoPEDirEntry *de = &header->datadir.pe_certificate_table;
+				return ((de->rva != 0) && (de->size > 8));
+			}
+		}
+	}
+	return FALSE;
+}
Index: security.h
===================================================================
--- security.h	(revision 36050)
+++ security.h	(working copy)
@@ -45,4 +45,8 @@
 extern MonoBoolean ves_icall_Mono_Security_Cryptography_KeyPairPersistence_ProtectUser (MonoString *path);
 
 
+/* System.Security.Policy.Evidence */
+MonoBoolean ves_icall_System_Security_Policy_Evidence_IsAuthenticodePresent (MonoReflectionAssembly *refass);
+
+
 #endif /* _MONO_METADATA_SECURITY_H_ */
Index: ChangeLog
===================================================================
--- ChangeLog	(revision 36050)
+++ ChangeLog	(working copy)
@@ -1,3 +1,9 @@
+2004-11-12  Sebastien Pouliot  <sebastien@ximian.com>
+
+	* security.c|h: New function to ask the runtime if the PE header of an
+	assembly seems to point to an authenticode signature.
+	* icall.c: Added IsAuthenticodePresent internal call.
+
 2004-11-12  Martin Baulig  <martin@localhost>
 
 	* reflection.c (mono_image_create_token): Allow generic method
Index: icall.c
===================================================================
--- icall.c	(revision 36050)
+++ icall.c	(working copy)
@@ -6448,6 +6448,10 @@
 	{"_ProtectUser", ves_icall_Mono_Security_Cryptography_KeyPairPersistence_ProtectUser}
 };
 
+static const IcallEntry evidence_icalls [] = {
+	{"IsAuthenticodePresent", ves_icall_System_Security_Policy_Evidence_IsAuthenticodePresent}
+};
+
 /* proto
 static const IcallEntry array_icalls [] = {
 };
@@ -6520,6 +6524,7 @@
 	{"System.Runtime.Remoting.RemotingServices", remotingservices_icalls, G_N_ELEMENTS (remotingservices_icalls)},
 	{"System.RuntimeMethodHandle", methodhandle_icalls, G_N_ELEMENTS (methodhandle_icalls)},
 	{"System.Security.Cryptography.RNGCryptoServiceProvider", rng_icalls, G_N_ELEMENTS (rng_icalls)},
+	{"System.Security.Policy.Evidence", evidence_icalls, G_N_ELEMENTS (evidence_icalls)},
 	{"System.Security.Principal.WindowsIdentity", identity_icalls, G_N_ELEMENTS (identity_icalls)},
 	{"System.Security.Principal.WindowsImpersonationContext", impersonation_icalls, G_N_ELEMENTS (impersonation_icalls)},
 	{"System.Security.Principal.WindowsPrincipal", principal_icalls, G_N_ELEMENTS (principal_icalls)},
