Index: Evidence.cs
===================================================================
--- Evidence.cs	(revision 36051)
+++ Evidence.cs	(working copy)
@@ -33,9 +33,12 @@
 
 using System.Collections;
 using System.Reflection;
+using System.Runtime.CompilerServices;
 using System.Security.Permissions;
 using System.Security.Cryptography.X509Certificates;
 
+using Mono.Security.Authenticode;
+
 namespace System.Security.Policy {
 
 	[Serializable]
@@ -243,6 +246,11 @@
 		}
 #endif
 
+		// Use an icall to avoid multiple file i/o to detect the 
+		// "possible" presence of an Authenticode signature
+		[MethodImplAttribute (MethodImplOptions.InternalCall)]
+		static extern bool IsAuthenticodePresent (Assembly a);
+
 		// this avoid us to build all evidences from the runtime
 		// (i.e. multiple unmanaged->managed calls) and also allows
 		// to delay their creation until (if) needed
@@ -270,15 +278,17 @@
 			}
 
 			// Authenticode(r) signed assemblies get a Publisher evidence
-			try {
-				X509Certificate x509 = X509Certificate.CreateFromSignedFile (a.Location);
-				if (x509.GetHashCode () != 0) {
-					e.AddHost (new Publisher (x509));
+			if (IsAuthenticodePresent (a)) {
+				// Note: The certificate is part of the evidences even if it is not trusted!
+				// so we can't call X509Certificate.CreateFromSignedFile
+				AuthenticodeDeformatter ad = new AuthenticodeDeformatter (a.Location);
+				if (ad.SigningCertificate != null) {
+					X509Certificate x509 = new X509Certificate (ad.SigningCertificate.RawData);
+					if (x509.GetHashCode () != 0) {
+						e.AddHost (new Publisher (x509));
+					}
 				}
 			}
-			catch (ArgumentException) {
-				// URI are not supported
-			}
 #if NET_2_0
 			// assemblies loaded from the GAC also get a Gac evidence (new in Fx 2.0)
 			if (a.GlobalAssemblyCache) {
Index: ChangeLog
===================================================================
--- ChangeLog	(revision 36051)
+++ ChangeLog	(working copy)
@@ -1,3 +1,10 @@
+2004-11-12  Sebastien Pouliot  <sebastien@ximian.com>
+
+	* Evidence.cs: Faster default evidence creation by using a internal
+	call to check for a possible Authenticode signature of the assembly.
+	Previously we had to make several I/O to verify this (quite rare)
+	presence (but the runtime already had a good hint about this).
+
 2004-10-20  Sebastien Pouliot  <sebastien@ximian.com>
 
 	* Evidence.cs: Fix the case where GetPublicKey returns a 0 length
