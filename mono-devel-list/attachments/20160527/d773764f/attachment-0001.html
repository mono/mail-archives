<tt>
&lt;html&nbsp;xmlns:v=&quot;urn:schemas-microsoft-com:vml&quot;&nbsp;xmlns:o=&quot;urn:schemas-microsoft-com:office:office&quot;&nbsp;xmlns:w=&quot;urn:schemas-microsoft-com:office:word&quot;&nbsp;xmlns:m=&quot;http://schemas.microsoft.com/office/2004/12/omml&quot;&nbsp;xmlns=&quot;http://www.w3.org/TR/REC-html40&quot;&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;meta&nbsp;name=&quot;Generator&quot;&nbsp;content=&quot;Microsoft&nbsp;Word&nbsp;15&nbsp;(filtered&nbsp;medium)&quot;&gt;<br>
&lt;style&gt;&lt;!--<br>
/*&nbsp;Font&nbsp;Definitions&nbsp;*/<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:&quot;Cambria&nbsp;Math&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;4&nbsp;5&nbsp;3&nbsp;5&nbsp;4&nbsp;6&nbsp;3&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Calibri;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;15&nbsp;5&nbsp;2&nbsp;2&nbsp;2&nbsp;4&nbsp;3&nbsp;2&nbsp;4;}<br>
/*&nbsp;Style&nbsp;Definitions&nbsp;*/<br>
p.MsoNormal,&nbsp;li.MsoNormal,&nbsp;div.MsoNormal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin:0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-bottom:.0001pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:12.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Times&nbsp;New&nbsp;Roman&quot;,serif;}<br>
a:link,&nbsp;span.MsoHyperlink<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:blue;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
a:visited,&nbsp;span.MsoHyperlinkFollowed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:purple;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
span.EmailStyle17<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:personal-reply;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,sans-serif;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:#1F497D;}<br>
.MsoChpDefault<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:export-only;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,sans-serif;}<br>
@page&nbsp;WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{size:8.5in&nbsp;11.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:1.0in&nbsp;1.0in&nbsp;1.0in&nbsp;1.0in;}<br>
div.WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{page:WordSection1;}<br>
--&gt;&lt;/style&gt;&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&lt;o:shapedefaults&nbsp;v:ext=&quot;edit&quot;&nbsp;spidmax=&quot;1026&quot;&nbsp;/&gt;<br>
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&lt;o:shapelayout&nbsp;v:ext=&quot;edit&quot;&gt;<br>
&lt;o:idmap&nbsp;v:ext=&quot;edit&quot;&nbsp;data=&quot;1&quot;&nbsp;/&gt;<br>
&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;lang=&quot;EN-US&quot;&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&gt;<br>
&lt;div&nbsp;class=&quot;WordSection1&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;Thanks.&nbsp;I’ll&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;profiler,&nbsp;but&nbsp;this&nbsp;problem&nbsp;doesn’t&nbsp;happen&nbsp;at&nbsp;startup,&nbsp;and&nbsp;running&nbsp;the&nbsp;application&nbsp;under&nbsp;profiling&nbsp;for&nbsp;eight&nbsp;hours&nbsp;is&nbsp;probably&nbsp;infeasible.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;I&nbsp;see&nbsp;that&nbsp;at&nbsp;one&nbsp;point&nbsp;mono&nbsp;support&nbsp;signal-based&nbsp;enabling/disabling&nbsp;of&nbsp;the&nbsp;profiler,&nbsp;like&nbsp;how&nbsp;SIGUSR2&nbsp;toggles&nbsp;the&nbsp;trace&nbsp;mechanism&nbsp;on&nbsp;and&nbsp;off.&nbsp;Is&nbsp;that&nbsp;sort&nbsp;of<br>
&nbsp;functionality&nbsp;ever&nbsp;going&nbsp;to&nbsp;be&nbsp;re-added?&nbsp;Currently&nbsp;there’s&nbsp;the&nbsp;heapshot&nbsp;option&nbsp;via&nbsp;the&nbsp;TCP&nbsp;listener,&nbsp;perhaps&nbsp;there&nbsp;could&nbsp;be&nbsp;enable/disable&nbsp;commands&nbsp;via&nbsp;that&nbsp;mechanism?&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;chris&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;From:&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&nbsp;Ludovic&nbsp;Henry&nbsp;[mailto:ludovic@xamarin.com]<br>
&lt;br&gt;<br>
&lt;b&gt;Sent:&lt;/b&gt;&nbsp;Friday,&nbsp;May&nbsp;27,&nbsp;2016&nbsp;1:27&nbsp;AM&lt;br&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;Chris&nbsp;Swiedler&nbsp;&lt;cswiedler@trionworlds.com&gt;;&nbsp;mono-devel-list&nbsp;&lt;mono-devel-list@lists.ximian.com&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[Mono-dev]&nbsp;High&nbsp;threadpool&nbsp;CPU&nbsp;usage&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Hi&nbsp;Chris,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;signal&nbsp;handler&nbsp;you&nbsp;are&nbsp;seeing&nbsp;is&nbsp;the&nbsp;GC&nbsp;signalling&nbsp;every&nbsp;thread&nbsp;to&nbsp;suspend&nbsp;them.&nbsp;So&nbsp;yes&nbsp;you&nbsp;are&nbsp;right,&nbsp;that's&nbsp;the&nbsp;sgen&nbsp;collector&nbsp;stopping&nbsp;the&nbsp;world.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;To&nbsp;track&nbsp;down&nbsp;the&nbsp;large&nbsp;number&nbsp;of&nbsp;allocation,&nbsp;I&nbsp;would&nbsp;encourage&nbsp;you&nbsp;to&nbsp;try&nbsp;the&nbsp;log&nbsp;profiler&nbsp;(documentation:&nbsp;&lt;a&nbsp;href=&quot;http://www.mono-project.com/docs/debug&#43;profile/profile/profiler/&quot;&gt;http://www.mono-project.com/docs/debug&#43;profile/profile/profiler/&lt;/a&gt;<br>
&nbsp;).&nbsp;That&nbsp;should&nbsp;give&nbsp;you&nbsp;some&nbsp;more&nbsp;insights&nbsp;in&nbsp;where&nbsp;the&nbsp;allocations&nbsp;are&nbsp;coming&nbsp;from.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Thank&nbsp;you,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Ludovic&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;On&nbsp;Thu,&nbsp;May&nbsp;26,&nbsp;2016&nbsp;at&nbsp;8:20&nbsp;PM&nbsp;Chris&nbsp;Swiedler&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:cswiedler@trionworlds.com&quot;&gt;cswiedler@trionworlds.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;blockquote&nbsp;style=&quot;border:none;border-left:solid&nbsp;#CCCCCC&nbsp;1.0pt;padding:0in&nbsp;0in&nbsp;0in&nbsp;6.0pt;margin-left:4.8pt;margin-right:0in&quot;&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;Thanks,&nbsp;Ludovic.&nbsp;I’m&nbsp;using&nbsp;mono-4.2.3.&nbsp;The&nbsp;‘massive&nbsp;amounts&nbsp;of&nbsp;GC’&nbsp;idea&nbsp;makes&nbsp;sense&nbsp;based&nbsp;on&nbsp;what&nbsp;I’m<br>
&nbsp;seeing.&nbsp;When&nbsp;I&nbsp;run&nbsp;pstack,&nbsp;I&nbsp;get&nbsp;a&nbsp;number&nbsp;of&nbsp;threadpool&nbsp;threads&nbsp;in&nbsp;stacks&nbsp;with:&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;#0&nbsp;&nbsp;0x00007fdff1c6a952&nbsp;in&nbsp;do_sigsuspend&nbsp;(set=0x954220&nbsp;&lt;suspend_signal_mask&gt;)&nbsp;at&nbsp;../sysdeps/unix/sysv/linux/sigsuspend.c:32&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;#1&nbsp;&nbsp;__GI___sigsuspend&nbsp;(set=set@entry=0x954220&nbsp;&lt;suspend_signal_mask&gt;)&nbsp;at&nbsp;../sysdeps/unix/sysv/linux/sigsuspend.c:46&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;#2&nbsp;&nbsp;0x00000000005c7534&nbsp;in&nbsp;suspend_thread&nbsp;(info=0x7fdf480008c0,&nbsp;context=context@entry=0x7fde997ea1c0)<br>
&nbsp;at&nbsp;sgen-os-posix.c:126&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;#3&nbsp;&nbsp;0x00000000005c771f&nbsp;in&nbsp;suspend_handler&nbsp;(_dummy=&lt;optimized&nbsp;out&gt;,&nbsp;_info=&lt;optimized&nbsp;out&gt;,&nbsp;context=0x7fde997ea1c0)<br>
&nbsp;at&nbsp;sgen-os-posix.c:153&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;#4&nbsp;&nbsp;&lt;signal&nbsp;handler&nbsp;called&gt;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;I&nbsp;thought&nbsp;this&nbsp;was&nbsp;related&nbsp;to&nbsp;GDB&nbsp;/&nbsp;pstack&nbsp;attaching,&nbsp;but&nbsp;it’s&nbsp;actually&nbsp;the&nbsp;suspend&nbsp;handling&nbsp;for&nbsp;the<br>
&nbsp;sgen&nbsp;collector,&nbsp;right?&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;Is&nbsp;a&nbsp;thread&nbsp;suspending&nbsp;itself&nbsp;CPU-intensive?&nbsp;I&nbsp;see&nbsp;lots&nbsp;of&nbsp;threads&nbsp;with&nbsp;high&nbsp;CPU&nbsp;at&nbsp;any&nbsp;point,&nbsp;which<br>
&nbsp;seems&nbsp;to&nbsp;indicate&nbsp;that&nbsp;this&nbsp;wouldn’t&nbsp;just&nbsp;be&nbsp;the&nbsp;CPU&nbsp;usage&nbsp;of&nbsp;the&nbsp;collector&nbsp;thread&nbsp;itself.&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;Do&nbsp;you&nbsp;have&nbsp;any&nbsp;suggestions&nbsp;for&nbsp;how&nbsp;to&nbsp;track&nbsp;down&nbsp;the&nbsp;large&nbsp;numbers&nbsp;of&nbsp;allocations?&nbsp;This&nbsp;isn’t&nbsp;very<br>
&nbsp;easy&nbsp;to&nbsp;reproduce,&nbsp;but&nbsp;now&nbsp;that&nbsp;I&nbsp;know&nbsp;what&nbsp;to&nbsp;look&nbsp;for,&nbsp;I&nbsp;might&nbsp;be&nbsp;able&nbsp;to&nbsp;get&nbsp;it&nbsp;to&nbsp;happen&nbsp;in&nbsp;a&nbsp;test&nbsp;environment.&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;chris&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif;color:#1F497D&quot;&gt;&nbsp;&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;From:&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&nbsp;Ludovic&nbsp;Henry&nbsp;[mailto:&lt;a&nbsp;href=&quot;mailto:ludovic@xamarin.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ludovic@xamarin.com&lt;/a&gt;]<br>
&lt;br&gt;<br>
&lt;b&gt;Sent:&lt;/b&gt;&nbsp;Thursday,&nbsp;May&nbsp;26,&nbsp;2016&nbsp;8:43&nbsp;AM&lt;br&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;Chris&nbsp;Swiedler&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:cswiedler@trionworlds.com&quot;&nbsp;target=&quot;_blank&quot;&gt;cswiedler@trionworlds.com&lt;/a&gt;&gt;;&nbsp;mono-devel-list&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mono-devel-list@lists.ximian.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[Mono-dev]&nbsp;High&nbsp;threadpool&nbsp;CPU&nbsp;usage&lt;/span&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;Hi&nbsp;Chris,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;The&nbsp;first&nbsp;stacktrace&nbsp;you&nbsp;are&nbsp;observing&nbsp;is&nbsp;for&nbsp;threadpool&nbsp;thread&nbsp;parking.&nbsp;We&nbsp;use&nbsp;this&nbsp;technique&nbsp;for&nbsp;threads&nbsp;that&nbsp;are&nbsp;currently&nbsp;not&nbsp;doing&nbsp;anything,&nbsp;to&nbsp;keep&nbsp;them&nbsp;around&nbsp;for&nbsp;a&nbsp;little<br>
&nbsp;while&nbsp;(5-60&nbsp;seconds)&nbsp;so&nbsp;if&nbsp;we&nbsp;have&nbsp;burst&nbsp;of&nbsp;usage,&nbsp;we&nbsp;do&nbsp;not&nbsp;end&nbsp;up&nbsp;destroying&nbsp;and&nbsp;creating&nbsp;threads&nbsp;all&nbsp;the&nbsp;time.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;The&nbsp;second&nbsp;stacktrace&nbsp;you&nbsp;are&nbsp;observing&nbsp;is,&nbsp;as&nbsp;you&nbsp;noted,&nbsp;when&nbsp;performing&nbsp;a&nbsp;garbage&nbsp;collection,&nbsp;when&nbsp;the&nbsp;GC&nbsp;thread&nbsp;is&nbsp;suspending&nbsp;all&nbsp;the&nbsp;running&nbsp;threads.&nbsp;So&nbsp;if&nbsp;you&nbsp;are&nbsp;witnessing<br>
&nbsp;this&nbsp;trace&nbsp;very&nbsp;often,&nbsp;it&nbsp;means&nbsp;a&nbsp;thread&nbsp;is&nbsp;allocating&nbsp;memory&nbsp;very&nbsp;quickly&nbsp;triggering&nbsp;GC&nbsp;collection&nbsp;very&nbsp;often.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;So&nbsp;I&nbsp;would&nbsp;need&nbsp;more&nbsp;information&nbsp;to&nbsp;tell&nbsp;you&nbsp;exactly&nbsp;why&nbsp;it&nbsp;would&nbsp;use&nbsp;100%&nbsp;CPU.&nbsp;Also&nbsp;which&nbsp;version&nbsp;of&nbsp;Mono&nbsp;are&nbsp;you&nbsp;running?&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;Thank&nbsp;you&nbsp;very&nbsp;much,&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;margin-bottom:12.0pt&quot;&gt;Ludovic&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;On&nbsp;Wed,&nbsp;May&nbsp;25,&nbsp;2016&nbsp;at&nbsp;8:30&nbsp;PM&nbsp;Chris&nbsp;Swiedler&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:cswiedler@trionworlds.com&quot;&nbsp;target=&quot;_blank&quot;&gt;cswiedler@trionworlds.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;blockquote&nbsp;style=&quot;border:none;border-left:solid&nbsp;#CCCCCC&nbsp;1.0pt;padding:0in&nbsp;0in&nbsp;0in&nbsp;6.0pt;margin-left:4.8pt;margin-top:5.0pt;margin-right:0in;margin-bottom:5.0pt&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto&quot;&gt;We&nbsp;have&nbsp;a&nbsp;server&nbsp;app&nbsp;which&nbsp;is&nbsp;periodically&nbsp;going&nbsp;into&nbsp;a&nbsp;mode&nbsp;where&nbsp;all&nbsp;threadpool&nbsp;threads&nbsp;start&nbsp;running&nbsp;at&nbsp;very&nbsp;high&nbsp;CPU.&nbsp;I've&nbsp;run&nbsp;pstack&nbsp;when&nbsp;it's&nbsp;in&nbsp;this&nbsp;mode,&nbsp;and&nbsp;every&nbsp;time<br>
&nbsp;I&nbsp;do&nbsp;it,&nbsp;nearly&nbsp;all&nbsp;the&nbsp;threadpool&nbsp;threads&nbsp;have&nbsp;this&nbsp;stack:&lt;br&gt;<br>
&lt;br&gt;<br>
#0&nbsp;&nbsp;pthread_cond_timedwait@@GLIBC_2.3.2&nbsp;()&nbsp;at&nbsp;../nptl/sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238&lt;br&gt;<br>
#1&nbsp;&nbsp;0x0000000000618817&nbsp;in&nbsp;mono_cond_timedwait_ms&nbsp;(cond=cond@entry=0x7fe7ee1fddc0,&nbsp;mutex=0x241eb78,&nbsp;timeout_ms=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;mono-mutex.c:181&lt;br&gt;<br>
#2&nbsp;&nbsp;0x0000000000586f28&nbsp;in&nbsp;worker_park&nbsp;()&nbsp;at&nbsp;threadpool-ms.c:509&lt;br&gt;<br>
#3&nbsp;&nbsp;worker_thread&nbsp;(data=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;threadpool-ms.c:607&lt;br&gt;<br>
#4&nbsp;&nbsp;0x00000000005841e9&nbsp;in&nbsp;start_wrapper_internal&nbsp;(data=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;threads.c:725&lt;br&gt;<br>
#5&nbsp;&nbsp;start_wrapper&nbsp;(data=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;threads.c:772&lt;br&gt;<br>
#6&nbsp;&nbsp;0x0000000000621026&nbsp;in&nbsp;inner_start_thread&nbsp;(arg=0x7fe831df4650)&nbsp;at&nbsp;mono-threads-posix.c:97&lt;br&gt;<br>
#7&nbsp;&nbsp;0x00007fe88a55edf5&nbsp;in&nbsp;start_thread&nbsp;(arg=0x7fe7ee1fe700)&nbsp;at&nbsp;pthread_create.c:308&lt;br&gt;<br>
#8&nbsp;&nbsp;0x00007fe88a28c1ad&nbsp;in&nbsp;clone&nbsp;()&nbsp;at&nbsp;../sysdeps/unix/sysv/linux/x86_64/clone.S:113&lt;br&gt;<br>
&lt;br&gt;<br>
Usually&nbsp;one&nbsp;thread&nbsp;will&nbsp;have&nbsp;a&nbsp;stack&nbsp;like&nbsp;this:&lt;br&gt;<br>
&lt;br&gt;<br>
#0&nbsp;&nbsp;sem_wait&nbsp;()&nbsp;at&nbsp;../nptl/sysdeps/unix/sysv/linux/x86_64/sem_wait.S:85&lt;br&gt;<br>
#1&nbsp;&nbsp;0x000000000061aa37&nbsp;in&nbsp;mono_sem_wait&nbsp;(sem=0x9542c0&nbsp;&lt;suspend_ack_semaphore&gt;,&nbsp;alertable=alertable@entry=0)&nbsp;at&nbsp;mono-semaphore.c:107&lt;br&gt;<br>
#2&nbsp;&nbsp;0x00000000005c77bd&nbsp;in&nbsp;sgen_wait_for_suspend_ack&nbsp;(count=count@entry=18)&nbsp;at&nbsp;sgen-os-posix.c:188&lt;br&gt;<br>
#3&nbsp;&nbsp;0x00000000005c78f9&nbsp;in&nbsp;sgen_thread_handshake&nbsp;(suspend=suspend@entry=1)&nbsp;at&nbsp;sgen-os-posix.c:224&lt;br&gt;<br>
#4&nbsp;&nbsp;0x00000000005c7e92&nbsp;in&nbsp;sgen_client_stop_world&nbsp;(generation=generation@entry=0)&nbsp;at&nbsp;sgen-stw.c:234&lt;br&gt;<br>
#5&nbsp;&nbsp;0x00000000005e6aca&nbsp;in&nbsp;sgen_stop_world&nbsp;(generation=0)&nbsp;at&nbsp;sgen-gc.c:3389&lt;br&gt;<br>
#6&nbsp;&nbsp;0x00000000005e6c29&nbsp;in&nbsp;sgen_perform_collection&nbsp;(requested_size=4096,&nbsp;generation_to_collect=0,&nbsp;reason=0x6d9595&nbsp;&quot;Nursery&nbsp;full&quot;,&nbsp;wait_to_finish=0)&nbsp;at&nbsp;sgen-gc.c:2322#7&nbsp;&nbsp;0x00000000005da62a&nbsp;in&nbsp;sgen_alloc_obj_nolock&nbsp;(vtable=vtable@entry=0x7fe85c0343c0,&nbsp;size=size@entry=128)<br>
&nbsp;at&nbsp;sgen-alloc.c:291&lt;br&gt;<br>
#8&nbsp;&nbsp;0x00000000005da913&nbsp;in&nbsp;sgen_alloc_obj&nbsp;(vtable=vtable@entry=0x7fe85c0343c0,&nbsp;size=128)&nbsp;at&nbsp;sgen-alloc.c:457&lt;br&gt;<br>
#9&nbsp;&nbsp;0x00000000005c86e9&nbsp;in&nbsp;mono_gc_alloc_obj&nbsp;(vtable=vtable@entry=0x7fe85c0343c0,&nbsp;size=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;sgen-mono.c:936&lt;br&gt;<br>
#10&nbsp;0x00000000005a8b54&nbsp;in&nbsp;mono_object_new_alloc_specific&nbsp;(vtable=vtable@entry=0x7fe85c0343c0)&nbsp;at&nbsp;object.c:4385&lt;br&gt;<br>
#11&nbsp;0x00000000005a8bf0&nbsp;in&nbsp;mono_object_new_specific&nbsp;(vtable=0x7fe85c0343c0)&nbsp;at&nbsp;object.c:4379&lt;br&gt;<br>
#12&nbsp;0x00000000005a8c8c&nbsp;in&nbsp;mono_object_new&nbsp;(domain=domain@entry=0x1ded1c0,&nbsp;klass=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;object.c:4318&lt;br&gt;<br>
#13&nbsp;0x00000000005ac1c9&nbsp;in&nbsp;mono_async_result_new&nbsp;(domain=domain@entry=0x1ded1c0,&nbsp;handle=handle@entry=0x0,&nbsp;state=0x0,&nbsp;data=data@entry=0x0,&nbsp;object_data=object_data@entry=0x7fe8838af020)&nbsp;at&nbsp;object.c:5768&lt;br&gt;<br>
#14&nbsp;0x00000000005887ff&nbsp;in&nbsp;mono_threadpool_ms_begin_invoke&nbsp;(domain=0x1ded1c0,&nbsp;target=target@entry=0x7fe8838aee38,&nbsp;method=method@entry=0x2963d28,&nbsp;params=params@entry=0x7fe7ed9f8f10)&nbsp;at&nbsp;threadpool-ms.c:1300&lt;br&gt;<br>
#15&nbsp;0x000000000054b547&nbsp;in&nbsp;mono_delegate_begin_invoke&nbsp;(delegate=0x7fe8838aee38,&nbsp;params=0x7fe7ed9f8f10)&nbsp;at&nbsp;marshal.c:2111&lt;br&gt;<br>
#16&nbsp;0x00000000416d29d8&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;<br>
#17&nbsp;0x0000000000000000&nbsp;in&nbsp;??&nbsp;()&lt;br&gt;<br>
&lt;br&gt;<br>
Just&nbsp;from&nbsp;reading&nbsp;the&nbsp;first&nbsp;stack,&nbsp;it&nbsp;doesn't&nbsp;look&nbsp;like&nbsp;mono_cond_timedwait_ms&nbsp;would&nbsp;spin,&nbsp;at&nbsp;least&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;timeout_ms&nbsp;wasn't&nbsp;0.&nbsp;For&nbsp;the&nbsp;second&nbsp;stack,&nbsp;I&nbsp;don't&nbsp;know&nbsp;whether&nbsp;that's&nbsp;a&nbsp;normal&nbsp;garbage&nbsp;collection&nbsp;pass&nbsp;or&nbsp;(since&nbsp;we&nbsp;see&nbsp;it&nbsp;frequently)&nbsp;a&nbsp;sign<br>
&nbsp;that&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;happening&nbsp;too&nbsp;often.&lt;br&gt;<br>
&lt;br&gt;<br>
Can&nbsp;anyone&nbsp;give&nbsp;me&nbsp;some&nbsp;pointers&nbsp;for&nbsp;where&nbsp;to&nbsp;dig&nbsp;more&nbsp;deeply?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks,&lt;br&gt;<br>
chris&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
