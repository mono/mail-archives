<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hey&nbsp;Greg/Alex,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;should&nbsp;look&nbsp;at&nbsp;JVMTI&nbsp;Capabilities,&nbsp;as&nbsp;it&nbsp;was&nbsp;designed&nbsp;to&nbsp;handle&nbsp;this.&lt;/div&gt;&lt;div&gt;In&nbsp;JVMTI,&nbsp;the&nbsp;runtime&nbsp;has&nbsp;a&nbsp;set&nbsp;of&nbsp;capabilities&nbsp;than&nbsp;can&nbsp;be&nbsp;enabled&nbsp;at&nbsp;certain&nbsp;phases&nbsp;of&nbsp;the&nbsp;application.&nbsp;IE,&nbsp;some&nbsp;can&nbsp;only&nbsp;be&nbsp;enabled&nbsp;during&nbsp;startup,&nbsp;others&nbsp;any&nbsp;time.&lt;/div&gt;&lt;div&gt;Furthermore,&nbsp;those&nbsp;capabilities,&nbsp;once&nbsp;enabled,&nbsp;will&nbsp;remain&nbsp;latent&nbsp;if&nbsp;later&nbsp;disabled.&nbsp;IE,&nbsp;you&nbsp;can&nbsp;put&nbsp;gc&nbsp;allocation&nbsp;as&nbsp;a&nbsp;latent&nbsp;capability&nbsp;during&nbsp;startup&nbsp;and&nbsp;only&nbsp;later&nbsp;actually&nbsp;enable&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Rodrigo&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jun&nbsp;20,&nbsp;2017&nbsp;at&nbsp;9:44&nbsp;AM,&nbsp;Alex&nbsp;Rønne&nbsp;Petersen&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:alex@alexrp.com&quot;&nbsp;target=&quot;_blank&quot;&gt;alex@alexrp.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;(Re-sending&nbsp;since&nbsp;my&nbsp;last&nbsp;email&nbsp;didn&#39;t&nbsp;go&nbsp;to&nbsp;the&nbsp;list&nbsp;for&nbsp;some&nbsp;reason.)&lt;br&gt;<br>
&lt;br&gt;<br>
Hey&nbsp;Greg,&lt;br&gt;<br>
&lt;br&gt;<br>
One&nbsp;possibility&nbsp;is&nbsp;that&nbsp;we&nbsp;could&nbsp;use&nbsp;a&nbsp;new&nbsp;entry&nbsp;point&nbsp;name&nbsp;for&nbsp;the&lt;br&gt;<br>
new&nbsp;version&nbsp;of&nbsp;the&nbsp;profiler&nbsp;API.&nbsp;That&nbsp;way,&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;a&lt;br&gt;<br>
profiler&nbsp;module&nbsp;has&nbsp;the&nbsp;old&nbsp;entry&nbsp;point&nbsp;name,&nbsp;we&nbsp;could&nbsp;print&nbsp;an&nbsp;error&lt;br&gt;<br>
and&nbsp;refuse&nbsp;to&nbsp;load&nbsp;it,&nbsp;rather&nbsp;than&nbsp;relying&nbsp;on&nbsp;the&nbsp;dynamic&nbsp;linker&nbsp;to&lt;br&gt;<br>
throw&nbsp;errors&nbsp;when&nbsp;mono_profiler_install_*&nbsp;functions&nbsp;are&nbsp;invoked&nbsp;by&nbsp;the&lt;br&gt;<br>
profiler&nbsp;modules,&nbsp;Does&nbsp;this&nbsp;sound&nbsp;reasonable?&lt;br&gt;<br>
&lt;br&gt;<br>
Regarding&nbsp;dynamic&nbsp;enter/leave&nbsp;hooking,&nbsp;I&nbsp;agree&nbsp;that&nbsp;it&nbsp;would&nbsp;be&nbsp;a&lt;br&gt;<br>
super&nbsp;cool&nbsp;feature&nbsp;to&nbsp;have.&nbsp;Unfortunately,&nbsp;it&nbsp;would&nbsp;require&nbsp;a&lt;br&gt;<br>
significant&nbsp;amount&nbsp;of&nbsp;work&nbsp;on&nbsp;the&nbsp;JIT&nbsp;side&nbsp;as&nbsp;re-JITing&nbsp;code&nbsp;is&nbsp;a&nbsp;hard&lt;br&gt;<br>
problem&nbsp;to&nbsp;solve&nbsp;reliably&nbsp;on&nbsp;most&nbsp;architectures.&nbsp;There&nbsp;are&nbsp;other&lt;br&gt;<br>
reasons&nbsp;I&nbsp;could&nbsp;see&nbsp;re-JITing&nbsp;being&nbsp;a&nbsp;useful&nbsp;feature&nbsp;to&nbsp;have&nbsp;(e.g.&lt;br&gt;<br>
incremental&nbsp;optimization&nbsp;based&nbsp;on&nbsp;profiling),&nbsp;but&nbsp;I&nbsp;can&#39;t&nbsp;really&nbsp;say&lt;br&gt;<br>
definitively&nbsp;whether&nbsp;we&#39;ll&nbsp;ever&nbsp;do&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&lt;br&gt;<br>
Alex&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
On&nbsp;Tue,&nbsp;Jun&nbsp;20,&nbsp;2017&nbsp;at&nbsp;11:04&nbsp;AM,&nbsp;Greg&nbsp;Young&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:gregoryyoung1@gmail.com&quot;&gt;gregoryyoung1@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;So&nbsp;the&nbsp;possible&nbsp;issue&nbsp;with&nbsp;option&nbsp;#2&nbsp;that&nbsp;I&nbsp;see&nbsp;is&nbsp;in&nbsp;distribution&nbsp;for&lt;br&gt;<br>
&gt;&nbsp;3rd&nbsp;party&nbsp;profilers&nbsp;like&nbsp;privateeye.&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;this&nbsp;as&nbsp;a&nbsp;huge&nbsp;issue&lt;br&gt;<br>
&gt;&nbsp;but&nbsp;it&nbsp;might&nbsp;be&nbsp;useful&nbsp;to&nbsp;at&nbsp;least&nbsp;be&nbsp;able&nbsp;to&nbsp;load&nbsp;the&nbsp;old&nbsp;API&nbsp;still&lt;br&gt;<br>
&gt;&nbsp;(not&nbsp;work)&nbsp;so&nbsp;the&nbsp;old&nbsp;version&nbsp;of&nbsp;the&nbsp;profiler&nbsp;could&nbsp;realize&nbsp;it&nbsp;is&nbsp;on&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;newer&nbsp;version&nbsp;and&nbsp;exit&nbsp;(or&nbsp;the&nbsp;runtime&nbsp;could&nbsp;recognize&nbsp;this&nbsp;and&nbsp;give&nbsp;a&lt;br&gt;<br>
&gt;&nbsp;reasonable&nbsp;error&nbsp;message.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Also&nbsp;a&nbsp;wonderful&nbsp;feature&nbsp;would&nbsp;be&nbsp;the&nbsp;ability&nbsp;to&nbsp;dynamically&nbsp;hook&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;mono_profiler_install_enter_&lt;wbr&gt;leave&nbsp;(pe_method_enter,&nbsp;pe_method_leave);&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;As&nbsp;it&nbsp;is&nbsp;quite&nbsp;expensive.&nbsp;I&nbsp;imagine&nbsp;though&nbsp;this&nbsp;would&nbsp;be&nbsp;non-trivial.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Greg&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Tue,&nbsp;Jun&nbsp;20,&nbsp;2017&nbsp;at&nbsp;9:50&nbsp;AM,&nbsp;Alex&nbsp;Rønne&nbsp;Petersen&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:alex@alexrp.com&quot;&gt;alex@alexrp.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&gt;&nbsp;Hello&nbsp;everyone,&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;As&nbsp;part&nbsp;of&nbsp;our&nbsp;ongoing&nbsp;effort&nbsp;to&nbsp;make&nbsp;Mono&#39;s&nbsp;log&nbsp;profiler&nbsp;useful&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;more&nbsp;scenarios,&nbsp;I&#39;m&nbsp;planning&nbsp;to&nbsp;make&nbsp;it&nbsp;possible&nbsp;to&nbsp;interact&nbsp;with&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;profiler&nbsp;at&nbsp;runtime&nbsp;-&nbsp;you&nbsp;can&nbsp;enable,&nbsp;disable,&nbsp;and&nbsp;tweak&nbsp;specific&lt;br&gt;<br>
&gt;&gt;&nbsp;profiler&nbsp;features&nbsp;in&nbsp;certain&nbsp;sections&nbsp;of&nbsp;your&nbsp;application,&nbsp;so&nbsp;you&nbsp;get&lt;br&gt;<br>
&gt;&gt;&nbsp;exactly&nbsp;the&nbsp;data&nbsp;that&nbsp;you&#39;re&nbsp;interested&nbsp;in.&nbsp;In&nbsp;order&nbsp;to&nbsp;do&nbsp;this,&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;log&nbsp;profiler&nbsp;needs&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;change&nbsp;its&nbsp;event&nbsp;flags&nbsp;and&nbsp;installed&lt;br&gt;<br>
&gt;&gt;&nbsp;callbacks&nbsp;dynamically&nbsp;at&nbsp;runtime.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;#&nbsp;The&nbsp;Problem&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;It&nbsp;is&nbsp;currently&nbsp;impossible&nbsp;for&nbsp;any&nbsp;profiler&nbsp;to&nbsp;reliably&nbsp;change&nbsp;its&lt;br&gt;<br>
&gt;&gt;&nbsp;setup&nbsp;at&nbsp;runtime&nbsp;because&nbsp;Mono&#39;s&nbsp;profiler&nbsp;API&nbsp;(metadata/profiler.h)&lt;br&gt;<br>
&gt;&gt;&nbsp;only&nbsp;allows&nbsp;modifying&nbsp;the&nbsp;most&nbsp;recently&nbsp;installed&nbsp;profiler.&nbsp;Mono&lt;br&gt;<br>
&gt;&gt;&nbsp;supports&nbsp;having&nbsp;multiple&nbsp;profilers&nbsp;active&nbsp;at&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we&nbsp;do&lt;br&gt;<br>
&gt;&gt;&nbsp;in&nbsp;fact&nbsp;use&nbsp;this&nbsp;feature&nbsp;in&nbsp;the&nbsp;Xamarin&nbsp;platform&nbsp;products.&nbsp;There&#39;s&nbsp;no&lt;br&gt;<br>
&gt;&gt;&nbsp;way&nbsp;around&nbsp;it:&nbsp;We&nbsp;need&nbsp;to&nbsp;rethink&nbsp;the&nbsp;profiler&nbsp;API.&nbsp;All&nbsp;functions&nbsp;must&lt;br&gt;<br>
&gt;&gt;&nbsp;take&nbsp;an&nbsp;explicit&nbsp;MonoProfiler*&nbsp;parameter.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;This&nbsp;isn&#39;t&nbsp;the&nbsp;only&nbsp;problem&nbsp;with&nbsp;the&nbsp;current&nbsp;API.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Another&nbsp;issue&nbsp;is&nbsp;that&nbsp;multiple&nbsp;callbacks&nbsp;are&nbsp;installed&nbsp;through&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;same&nbsp;function.&nbsp;For&nbsp;example,&nbsp;mono_profiler_install_&lt;wbr&gt;exception&nbsp;installs&lt;br&gt;<br>
&gt;&gt;&nbsp;callbacks&nbsp;for&nbsp;thrown&nbsp;exceptions,&nbsp;exceptional&nbsp;method&nbsp;exits,&nbsp;and&lt;br&gt;<br>
&gt;&gt;&nbsp;exception&nbsp;clauses.&nbsp;When&nbsp;I&nbsp;had&nbsp;to&nbsp;add&nbsp;an&nbsp;extra&nbsp;parameter&nbsp;to&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;exception&nbsp;clause&nbsp;callback&nbsp;recently,&nbsp;I&nbsp;introduced&lt;br&gt;<br>
&gt;&gt;&nbsp;mono_profiler_install_&lt;wbr&gt;exception_clause&nbsp;for&nbsp;version&nbsp;2&nbsp;of&nbsp;that&nbsp;callback.&lt;br&gt;<br>
&gt;&gt;&nbsp;This&nbsp;means&nbsp;that&nbsp;new&nbsp;code&nbsp;will&nbsp;pass&nbsp;NULL&nbsp;to&nbsp;the&nbsp;third&nbsp;parameter&nbsp;of&lt;br&gt;<br>
&gt;&gt;&nbsp;mono_profiler_install_&lt;wbr&gt;exception&nbsp;from&nbsp;now&nbsp;on.&nbsp;This&nbsp;just&nbsp;adds&nbsp;confusion.&lt;br&gt;<br>
&gt;&gt;&nbsp;It&nbsp;would&nbsp;be&nbsp;much&nbsp;clearer&nbsp;if&nbsp;the&nbsp;old&nbsp;function&nbsp;had&nbsp;been&nbsp;called&lt;br&gt;<br>
&gt;&gt;&nbsp;mono_profiler_install_&lt;wbr&gt;exception_clause&nbsp;and&nbsp;I&#39;d&nbsp;just&nbsp;been&nbsp;able&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;introduce&nbsp;a&nbsp;mono_profiler_install_&lt;wbr&gt;exception_v2&nbsp;function.&nbsp;New&nbsp;users&nbsp;of&lt;br&gt;<br>
&gt;&gt;&nbsp;the&nbsp;API&nbsp;will&nbsp;likely&nbsp;wonder&nbsp;why&nbsp;mono_profiler_install_&lt;wbr&gt;exception_clause&lt;br&gt;<br>
&gt;&gt;&nbsp;isn&#39;t&nbsp;part&nbsp;of&nbsp;mono_profiler_install_&lt;wbr&gt;exception&nbsp;since&nbsp;the&nbsp;API&nbsp;has&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;precedent&nbsp;of&nbsp;bundling&nbsp;related&nbsp;callbacks&nbsp;into&nbsp;the&nbsp;same&nbsp;installation&lt;br&gt;<br>
&gt;&gt;&nbsp;function.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;There&nbsp;are&nbsp;also&nbsp;multiple&nbsp;callbacks&nbsp;in&nbsp;the&nbsp;API&nbsp;that&nbsp;aren&#39;t&nbsp;guarded&nbsp;by&lt;br&gt;<br>
&gt;&gt;&nbsp;event&nbsp;flags.&nbsp;For&nbsp;example,&nbsp;the&nbsp;code&nbsp;buffer&nbsp;callbacks&nbsp;should&nbsp;logically&lt;br&gt;<br>
&gt;&gt;&nbsp;be&nbsp;guarded&nbsp;by&nbsp;MONO_PROFILE_JIT_COMPILATION,&nbsp;but&nbsp;that&#39;s&nbsp;a&nbsp;change&nbsp;we&lt;br&gt;<br>
&gt;&gt;&nbsp;can&#39;t&nbsp;make&nbsp;now&nbsp;as&nbsp;it&nbsp;would&nbsp;be&nbsp;breaking.&nbsp;Another&nbsp;curiosity&nbsp;is&nbsp;that&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;GC&nbsp;handle&nbsp;callbacks&nbsp;are&nbsp;guarded&nbsp;by&nbsp;MONO_PROFILE_GC_ROOTS&nbsp;even&nbsp;though&lt;br&gt;<br>
&gt;&gt;&nbsp;it&#39;s&nbsp;entirely&nbsp;likely&nbsp;that&nbsp;someone&nbsp;would&nbsp;be&nbsp;interested&nbsp;in&nbsp;GC&nbsp;handles&lt;br&gt;<br>
&gt;&gt;&nbsp;but&nbsp;not&nbsp;GC&nbsp;roots&nbsp;(see:&nbsp;Alan&nbsp;McGovern&#39;s&nbsp;GC&nbsp;handle&nbsp;profiler).&nbsp;It&#39;s&nbsp;also&lt;br&gt;<br>
&gt;&gt;&nbsp;odd&nbsp;that&nbsp;the&nbsp;exceptional&nbsp;method&nbsp;exit&nbsp;callback&nbsp;is&nbsp;guarded&nbsp;by&lt;br&gt;<br>
&gt;&gt;&nbsp;MONO_PROFILE_EXCEPTIONS&nbsp;when&nbsp;in&nbsp;fact&nbsp;most&nbsp;uses&nbsp;of&nbsp;this&nbsp;callback&nbsp;have&lt;br&gt;<br>
&gt;&gt;&nbsp;little&nbsp;to&nbsp;do&nbsp;with&nbsp;profiling&nbsp;exceptions&nbsp;and&nbsp;everything&nbsp;to&nbsp;do&nbsp;with&lt;br&gt;<br>
&gt;&gt;&nbsp;keeping&nbsp;track&nbsp;of&nbsp;method&nbsp;entries/exits&nbsp;as&nbsp;with&nbsp;the&nbsp;normal&nbsp;method&lt;br&gt;<br>
&gt;&gt;&nbsp;enter/exit&nbsp;callbacks&nbsp;(which&nbsp;are&nbsp;guarded&nbsp;by&nbsp;MONO_PROFILE_ENTER_LEAVE).&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;We&nbsp;also&nbsp;have&nbsp;callbacks&nbsp;that&nbsp;serve&nbsp;no&nbsp;actual&nbsp;purpose,&nbsp;and&nbsp;never&nbsp;will.&lt;br&gt;<br>
&gt;&gt;&nbsp;For&nbsp;example,&nbsp;the&nbsp;notion&nbsp;of&nbsp;a&nbsp;&#39;class&nbsp;unload&#39;&nbsp;does&nbsp;not&nbsp;exist&nbsp;in&nbsp;the&nbsp;Mono&lt;br&gt;<br>
&gt;&gt;&nbsp;runtime.&nbsp;Never&nbsp;has,&nbsp;probably&nbsp;never&nbsp;will.&nbsp;Entire&nbsp;images&nbsp;are&nbsp;unloaded&nbsp;at&lt;br&gt;<br>
&gt;&gt;&nbsp;once,&nbsp;so&nbsp;this&nbsp;callback&nbsp;is&nbsp;literally&nbsp;never&nbsp;invoked.&nbsp;I&#39;d&nbsp;actually&nbsp;say&lt;br&gt;<br>
&gt;&gt;&nbsp;having&nbsp;that&nbsp;callback&nbsp;there&nbsp;adds&nbsp;negative&nbsp;value&nbsp;to&nbsp;the&nbsp;API.&nbsp;The&lt;br&gt;<br>
&gt;&gt;&nbsp;managed/native&nbsp;transition&nbsp;callback&nbsp;was&nbsp;never&nbsp;implemented,&nbsp;either.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Finally,&nbsp;some&nbsp;features&nbsp;in&nbsp;the&nbsp;API&nbsp;have&nbsp;not&nbsp;been&nbsp;maintained&nbsp;or&nbsp;tested&lt;br&gt;<br>
&gt;&gt;&nbsp;for&nbsp;years.&nbsp;The&nbsp;call&nbsp;chain&nbsp;sampling&nbsp;API&nbsp;is&nbsp;a&nbsp;great&nbsp;example&nbsp;of&nbsp;this.&lt;br&gt;<br>
&gt;&gt;&nbsp;Another&nbsp;example:&nbsp;Did&nbsp;you&nbsp;know&nbsp;that&nbsp;the&nbsp;profiler&nbsp;API&nbsp;supports&nbsp;two&lt;br&gt;<br>
&gt;&gt;&nbsp;coverage&nbsp;modes&nbsp;which&nbsp;are&nbsp;mutually&nbsp;exclusive?&nbsp;You&nbsp;might&nbsp;think&nbsp;that&lt;br&gt;<br>
&gt;&gt;&nbsp;MONO_PROFILE_COVERAGE&nbsp;is&nbsp;the&nbsp;flag&nbsp;that&nbsp;you&#39;re&nbsp;supposed&nbsp;to&nbsp;be&nbsp;using.&lt;br&gt;<br>
&gt;&gt;&nbsp;Nope;&nbsp;it&#39;s&nbsp;MONO_PROFILE_INS_COVERAGE.&nbsp;The&nbsp;former&nbsp;is&nbsp;implemented&nbsp;in&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;very&nbsp;platform-specific&nbsp;manner&nbsp;that&nbsp;has&nbsp;resulted&nbsp;in&nbsp;it&nbsp;not&nbsp;being&lt;br&gt;<br>
&gt;&gt;&nbsp;maintained,&nbsp;tested,&nbsp;or&nbsp;ported&nbsp;fully&nbsp;to&nbsp;new&nbsp;platforms.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;In&nbsp;short,&nbsp;the&nbsp;current&nbsp;profiler&nbsp;API&nbsp;is&nbsp;pretty&nbsp;bad.&nbsp;We&nbsp;need&nbsp;a&nbsp;new&nbsp;API.&lt;br&gt;<br>
&gt;&gt;&nbsp;Of&nbsp;course,&nbsp;the&nbsp;elephant&nbsp;in&nbsp;the&nbsp;room&nbsp;is&nbsp;backwards&nbsp;compatibility.&nbsp;The&lt;br&gt;<br>
&gt;&gt;&nbsp;question&nbsp;is:&nbsp;Do&nbsp;we&nbsp;introduce&nbsp;a&nbsp;new&nbsp;profiler&nbsp;API&nbsp;and&nbsp;make&nbsp;the&nbsp;old&nbsp;one&lt;br&gt;<br>
&gt;&gt;&nbsp;&#39;simply&#39;&nbsp;call&nbsp;the&nbsp;new&nbsp;one?&nbsp;Or&nbsp;do&nbsp;we&nbsp;just&nbsp;replace&nbsp;the&nbsp;old&nbsp;API&nbsp;entirely,&lt;br&gt;<br>
&gt;&gt;&nbsp;backwards&nbsp;compatibility&nbsp;be&nbsp;damned?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;#&nbsp;The&nbsp;New&nbsp;Profiler&nbsp;API&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;new&nbsp;API&nbsp;would&nbsp;not&nbsp;be&nbsp;all&nbsp;that&nbsp;different&nbsp;from&nbsp;the&nbsp;old&nbsp;one.&nbsp;The&nbsp;main&lt;br&gt;<br>
&gt;&gt;&nbsp;changes&nbsp;would&nbsp;be:&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;1.&nbsp;All&nbsp;functions&nbsp;in&nbsp;the&nbsp;API&nbsp;take&nbsp;an&nbsp;explicit&nbsp;MonoProfiler*&nbsp;parameter.&lt;br&gt;<br>
&gt;&gt;&nbsp;2.&nbsp;Callbacks&nbsp;can&nbsp;be&nbsp;changed&nbsp;safely&nbsp;at&nbsp;runtime.&lt;br&gt;<br>
&gt;&gt;&nbsp;3.&nbsp;One&nbsp;installation&nbsp;function&nbsp;installs&nbsp;exactly&nbsp;one&nbsp;callback.&lt;br&gt;<br>
&gt;&gt;&nbsp;4.&nbsp;You&nbsp;will&nbsp;no&nbsp;longer&nbsp;need&nbsp;to&nbsp;specify&nbsp;event&nbsp;flags.&lt;br&gt;<br>
&gt;&gt;&nbsp;5.&nbsp;Unmaintained&nbsp;and&nbsp;unfinished&nbsp;features&nbsp;(see&nbsp;above)&nbsp;will&nbsp;be&nbsp;removed.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;As&nbsp;an&nbsp;example,&nbsp;old&nbsp;code&nbsp;might&nbsp;look&nbsp;like&nbsp;this:&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;void&lt;br&gt;<br>
&gt;&gt;&nbsp;mono_profiler_startup&nbsp;(const&nbsp;char&nbsp;*args)&lt;br&gt;<br>
&gt;&gt;&nbsp;{&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; MonoProfiler&nbsp;*prof&nbsp;=&nbsp;malloc&nbsp;(...);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; profiler_specific_setup&nbsp;(prof);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_install&nbsp;(prof,&nbsp;my_shutdown_callback);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_install_enter_&lt;wbr&gt;leave&nbsp;(my_enter_callback,&nbsp;my_leave_callback);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_set_events&nbsp;(MONO_PROFILE_ENTER_LEAVE);&lt;br&gt;<br>
&gt;&gt;&nbsp;}&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;New&nbsp;code&nbsp;would&nbsp;look&nbsp;like&nbsp;this:&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;void&lt;br&gt;<br>
&gt;&gt;&nbsp;mono_profiler_startup&nbsp;(const&nbsp;char&nbsp;*args)&lt;br&gt;<br>
&gt;&gt;&nbsp;{&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; MonoProfiler&nbsp;*prof&nbsp;=&nbsp;malloc&nbsp;(...);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; profiler_specific_setup&nbsp;(prof);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_install&nbsp;(prof);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_set_shutdown_&lt;wbr&gt;callback&nbsp;(prof,&nbsp;my_shutdown_callback);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_set_enter_&lt;wbr&gt;callback&nbsp;(prof,&nbsp;my_enter_callback);&lt;br&gt;<br>
&gt;&gt; &nbsp; &nbsp; mono_profiler_set_leave_&lt;wbr&gt;callback&nbsp;(prof,&nbsp;my_leave_callback);&lt;br&gt;<br>
&gt;&gt;&nbsp;}&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;We&nbsp;would&nbsp;still&nbsp;use&nbsp;flags&nbsp;internally&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;slow&nbsp;the&nbsp;runtime&nbsp;down&lt;br&gt;<br>
&gt;&gt;&nbsp;with&nbsp;unnecessary&nbsp;profiler&nbsp;API&nbsp;calls,&nbsp;but&nbsp;that&nbsp;will&nbsp;be&nbsp;completely&lt;br&gt;<br>
&gt;&gt;&nbsp;hidden&nbsp;from&nbsp;users.&nbsp;All&nbsp;a&nbsp;user&nbsp;would&nbsp;have&nbsp;to&nbsp;worry&nbsp;about&nbsp;is&nbsp;(un)setting&lt;br&gt;<br>
&gt;&gt;&nbsp;callbacks,&nbsp;which&nbsp;can&nbsp;be&nbsp;done&nbsp;at&nbsp;any&nbsp;point&nbsp;during&nbsp;an&nbsp;app&#39;s&nbsp;lifetime.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Transitioning&nbsp;to&nbsp;the&nbsp;new&nbsp;API&nbsp;should&nbsp;be&nbsp;fairly&nbsp;painless.&nbsp;I&#39;d&nbsp;estimate&lt;br&gt;<br>
&gt;&gt;&nbsp;it&nbsp;to&nbsp;take&nbsp;an&nbsp;hour&nbsp;or&nbsp;two&nbsp;at&nbsp;worst&nbsp;for&nbsp;e.g.&nbsp;the&nbsp;log&nbsp;profiler.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;#&nbsp;Approach&nbsp;One:&nbsp;Backwards&nbsp;Compatibility&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;In&nbsp;this&nbsp;approach,&nbsp;we&nbsp;would&nbsp;introduce&nbsp;a&nbsp;new&nbsp;metadata/profiler-v2.h&lt;br&gt;<br>
&gt;&gt;&nbsp;header.&nbsp;This&nbsp;header&nbsp;would&nbsp;provide&nbsp;the&nbsp;new&nbsp;API&nbsp;and&nbsp;have&nbsp;no&nbsp;dependencies&lt;br&gt;<br>
&gt;&gt;&nbsp;on&nbsp;the&nbsp;old&nbsp;one.&nbsp;The&nbsp;old&nbsp;API&nbsp;would&nbsp;remain&nbsp;in&nbsp;metadata/profiler.h&nbsp;and&lt;br&gt;<br>
&gt;&gt;&nbsp;people&#39;s&nbsp;code&nbsp;would&nbsp;continue&nbsp;to&nbsp;compile&nbsp;and&nbsp;work.&nbsp;We&nbsp;would&nbsp;need&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;bridge&nbsp;the&nbsp;old&nbsp;API&nbsp;to&nbsp;the&nbsp;new&nbsp;one&nbsp;and&nbsp;make&nbsp;sure&nbsp;that&nbsp;it&#39;s&nbsp;done&nbsp;in&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;backwards-compatible&nbsp;way.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;advantage&nbsp;here&nbsp;is&nbsp;fairly&nbsp;obvious:&nbsp;Nobody&nbsp;likes&nbsp;having&nbsp;to&nbsp;rewrite&lt;br&gt;<br>
&gt;&gt;&nbsp;their&nbsp;code&nbsp;because&nbsp;the&nbsp;authors&nbsp;of&nbsp;a&nbsp;library&nbsp;decided&nbsp;to&nbsp;change&nbsp;the&nbsp;API,&lt;br&gt;<br>
&gt;&gt;&nbsp;especially&nbsp;if&nbsp;that&nbsp;change&nbsp;doesn&#39;t&nbsp;carry&nbsp;an&nbsp;obvious&nbsp;benefit&nbsp;to&nbsp;users,&lt;br&gt;<br>
&gt;&gt;&nbsp;which&nbsp;it&nbsp;could&nbsp;be&nbsp;argued&nbsp;this&nbsp;change&nbsp;wouldn&#39;t&nbsp;for&nbsp;most&nbsp;(all?)&nbsp;current&lt;br&gt;<br>
&gt;&gt;&nbsp;users&nbsp;of&nbsp;Mono&#39;s&nbsp;profiler&nbsp;API.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;this&nbsp;is&nbsp;a&nbsp;significant&nbsp;maintenance&nbsp;burden,&nbsp;both&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;the&nbsp;short&nbsp;and&nbsp;long&nbsp;term.&nbsp;Writing&nbsp;the&nbsp;code&nbsp;to&nbsp;bridge&nbsp;the&nbsp;nonsensical&lt;br&gt;<br>
&gt;&gt;&nbsp;aspects&nbsp;of&nbsp;the&nbsp;old&nbsp;API&nbsp;with&nbsp;the&nbsp;new&nbsp;one&nbsp;would&nbsp;be&nbsp;tricky&nbsp;to&nbsp;say&nbsp;the&lt;br&gt;<br>
&gt;&gt;&nbsp;least.&nbsp;In&nbsp;addition,&nbsp;there&#39;s&nbsp;the&nbsp;risk&nbsp;that&nbsp;any&nbsp;change&nbsp;to&nbsp;the&nbsp;new&nbsp;API&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;the&nbsp;future&nbsp;could&nbsp;break&nbsp;the&nbsp;old&nbsp;API.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;#&nbsp;Approach&nbsp;Two:&nbsp;Replacing&nbsp;the&nbsp;API&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;In&nbsp;this&nbsp;approach,&nbsp;we&nbsp;replace&nbsp;the&nbsp;old&nbsp;API&nbsp;in&nbsp;metadata/profiler.h&nbsp;with&lt;br&gt;<br>
&gt;&gt;&nbsp;the&nbsp;new&nbsp;one,&nbsp;with&nbsp;zero&nbsp;regard&nbsp;for&nbsp;backwards&nbsp;compatibility.&nbsp;People&#39;s&lt;br&gt;<br>
&gt;&gt;&nbsp;code&nbsp;would&nbsp;fail&nbsp;to&nbsp;compile,&nbsp;and&nbsp;old&nbsp;compiled&nbsp;profiler&nbsp;modules&nbsp;would&lt;br&gt;<br>
&gt;&gt;&nbsp;fail&nbsp;to&nbsp;run.&nbsp;In&nbsp;both&nbsp;cases,&nbsp;the&nbsp;failures&nbsp;should&nbsp;be&nbsp;fairly&nbsp;loud&nbsp;-&nbsp;a&lt;br&gt;<br>
&gt;&gt;&nbsp;compiler&nbsp;error,&nbsp;or&nbsp;a&nbsp;dynamic&nbsp;linker&nbsp;error.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;The&nbsp;advantage&nbsp;of&nbsp;this&nbsp;approach&nbsp;is&nbsp;that&nbsp;it&#39;s&nbsp;significantly&nbsp;less&nbsp;effort&lt;br&gt;<br>
&gt;&gt;&nbsp;to&nbsp;implement&nbsp;and&nbsp;maintain.&nbsp;It&nbsp;also&nbsp;avoids&nbsp;any&nbsp;potential&nbsp;confusion&nbsp;for&lt;br&gt;<br>
&gt;&gt;&nbsp;new&nbsp;users&nbsp;of&nbsp;the&nbsp;API,&nbsp;in&nbsp;that&nbsp;there&#39;s&nbsp;only&nbsp;one&nbsp;set&nbsp;of&nbsp;functions&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;use.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;If&nbsp;we&nbsp;go&nbsp;down&nbsp;this&nbsp;route,&nbsp;all&nbsp;projects&nbsp;that&nbsp;use&nbsp;Mono&#39;s&nbsp;profiler&nbsp;API&lt;br&gt;<br>
&gt;&gt;&nbsp;would&nbsp;need&nbsp;to&nbsp;change&nbsp;their&nbsp;code&nbsp;slightly,&nbsp;and&nbsp;people&nbsp;would&nbsp;need&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;compile&nbsp;separate&nbsp;versions&nbsp;of&nbsp;their&nbsp;profiler&nbsp;modules&nbsp;if&nbsp;they&nbsp;want&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;support&nbsp;older&nbsp;Mono&nbsp;versions.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;#&nbsp;My&nbsp;Opinion&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&#39;m&nbsp;strongly&nbsp;in&nbsp;favor&nbsp;of&nbsp;the&nbsp;second&nbsp;approach.&nbsp;Frankly,&nbsp;as&nbsp;the&nbsp;person&lt;br&gt;<br>
&gt;&gt;&nbsp;who&#39;ll&nbsp;be&nbsp;implementing&nbsp;and&nbsp;maintaining&nbsp;the&nbsp;new&nbsp;API,&nbsp;I&nbsp;don&#39;t&lt;br&gt;<br>
&gt;&gt;&nbsp;particularly&nbsp;enjoy&nbsp;the&nbsp;idea&nbsp;of&nbsp;having&nbsp;to&nbsp;also&nbsp;maintain&nbsp;the&nbsp;old&nbsp;one&nbsp;in&lt;br&gt;<br>
&gt;&gt;&nbsp;a&nbsp;backwards&nbsp;compatible&nbsp;fashion.&nbsp;I&nbsp;think&nbsp;there&nbsp;are&nbsp;much&nbsp;better&nbsp;things&nbsp;I&lt;br&gt;<br>
&gt;&gt;&nbsp;could&nbsp;be&nbsp;working&nbsp;on&nbsp;in&nbsp;Mono&#39;s&nbsp;profiling&nbsp;infrastructure.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;I&nbsp;also&nbsp;firmly&nbsp;believe&nbsp;that&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;time&nbsp;we&#39;ll&nbsp;have&nbsp;to&nbsp;do&nbsp;such&lt;br&gt;<br>
&gt;&gt;&nbsp;a&nbsp;drastic&nbsp;breaking&nbsp;change&nbsp;to&nbsp;the&nbsp;profiler&nbsp;API.&nbsp;This&nbsp;isn&#39;t&nbsp;a&nbsp;proposal&lt;br&gt;<br>
&gt;&gt;&nbsp;to&nbsp;jump&nbsp;on&nbsp;some&nbsp;fancy&nbsp;new&nbsp;API&nbsp;design&nbsp;fad.&nbsp;Using&nbsp;a&nbsp;mutable&nbsp;global&lt;br&gt;<br>
&gt;&gt;&nbsp;variable&nbsp;as&nbsp;an&nbsp;implicit&nbsp;parameter&nbsp;to&nbsp;an&nbsp;entire&nbsp;API&nbsp;was&nbsp;pretty&nbsp;bad&lt;br&gt;<br>
&gt;&gt;&nbsp;design,&nbsp;even&nbsp;by&nbsp;2002&nbsp;standards.&nbsp;Just&nbsp;by&nbsp;passing&nbsp;an&nbsp;explicit&lt;br&gt;<br>
&gt;&gt;&nbsp;MonoProfiler*&nbsp;argument&nbsp;to&nbsp;all&nbsp;API&nbsp;functions,&nbsp;we&nbsp;open&nbsp;ourselves&nbsp;up&nbsp;to&lt;br&gt;<br>
&gt;&gt;&nbsp;much&nbsp;easier,&nbsp;backwards-compatible&nbsp;expansion&nbsp;of&nbsp;the&nbsp;API&nbsp;in&nbsp;the&nbsp;future.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Finally,&nbsp;as&nbsp;I&nbsp;mentioned&nbsp;earlier,&nbsp;transitioning&nbsp;to&nbsp;the&nbsp;new&nbsp;API&nbsp;would&nbsp;be&lt;br&gt;<br>
&gt;&gt;&nbsp;very&nbsp;easy,&nbsp;and&nbsp;users&nbsp;would&nbsp;have&nbsp;to&nbsp;do&nbsp;it&nbsp;sooner&nbsp;or&nbsp;later&nbsp;anyway,&nbsp;as&nbsp;we&lt;br&gt;<br>
&gt;&gt;&nbsp;wouldn&#39;t&nbsp;want&nbsp;to&nbsp;keep&nbsp;the&nbsp;old&nbsp;API&nbsp;around&nbsp;forever,&nbsp;even&nbsp;in&nbsp;the&nbsp;first&lt;br&gt;<br>
&gt;&gt;&nbsp;approach.&nbsp;Also,&nbsp;in&nbsp;the&nbsp;grand&nbsp;scheme&nbsp;of&nbsp;things,&nbsp;this&nbsp;probably&nbsp;won&#39;t&lt;br&gt;<br>
&gt;&gt;&nbsp;affect&nbsp;that&nbsp;many&nbsp;people,&nbsp;unlike&nbsp;breaking&nbsp;changes&nbsp;to&nbsp;the&nbsp;core&nbsp;embedding&lt;br&gt;<br>
&gt;&gt;&nbsp;API.&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;What&#39;s&nbsp;everyone&#39;s&nbsp;thoughts&nbsp;on&nbsp;this?&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;Regards,&lt;br&gt;<br>
&gt;&gt;&nbsp;Alex&lt;br&gt;<br>
&gt;&gt;&nbsp;______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
&gt;&gt;&nbsp;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&gt;&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.dot.net&quot;&gt;Mono-devel-list@lists.dot.net&lt;/a&gt;&lt;br&gt;<br>
&gt;&gt;&nbsp;&lt;a&nbsp;href=&quot;http://lists.dot.net/mailman/listinfo/mono-devel-list&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.dot.net/mailman/&lt;wbr&gt;listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;--&lt;br&gt;<br>
&gt;&nbsp;Studying&nbsp;for&nbsp;the&nbsp;Turing&nbsp;test&lt;br&gt;<br>
______________________________&lt;wbr&gt;_________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.dot.net&quot;&gt;Mono-devel-list@lists.dot.net&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.dot.net/mailman/listinfo/mono-devel-list&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.dot.net/mailman/&lt;wbr&gt;listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
