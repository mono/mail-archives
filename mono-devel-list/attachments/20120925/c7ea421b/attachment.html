<tt>
Could&nbsp;you&nbsp;try&nbsp;master?&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;--&lt;/div&gt;Jérémie&nbsp;Laval&lt;div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;http://neteril.org&quot;&nbsp;target=&quot;_blank&quot;&gt;http://neteril.org&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Sep&nbsp;20,&nbsp;2012&nbsp;at&nbsp;2:38&nbsp;PM,&nbsp;Greg&nbsp;Young&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:gregoryyoung1@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;gregoryyoung1@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
Here&nbsp;are&nbsp;some&nbsp;tests&nbsp;that&nbsp;show&nbsp;some&nbsp;of&nbsp;the&nbsp;failure&nbsp;modes&nbsp;of&nbsp;concurrent&lt;br&gt;<br>
queue&nbsp;(all&nbsp;work&nbsp;in&nbsp;CLR&nbsp;impl)&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;my&nbsp;machine&nbsp;(8&nbsp;cores&nbsp;within&nbsp;1&nbsp;second&nbsp;of&nbsp;running&nbsp;for&nbsp;all&nbsp;failures).&lt;br&gt;<br>
The&nbsp;worst&nbsp;is&nbsp;the&nbsp;last&nbsp;one&nbsp;where&nbsp;anything&nbsp;larger&nbsp;than&nbsp;a&nbsp;reference&nbsp;gives&lt;br&gt;<br>
partial&nbsp;reads.&lt;br&gt;<br>
&lt;br&gt;<br>
in&nbsp;gist&nbsp;if&nbsp;you&nbsp;prefer:&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/3755979&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/3755979&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.NullReferenceException:&nbsp;Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&lt;br&gt;<br>
of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[T].TryDequeue&lt;br&gt;<br>
(System.Collections.Concurrent.T&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueReference&gt;c__AnonStorey1.&lt;&gt;m__0&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
[ERROR]&nbsp;FATAL&nbsp;UNHANDLED&nbsp;EXCEPTION:&nbsp;System.NullReferenceException:&lt;br&gt;<br>
Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&nbsp;of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[T].TryDequeue&lt;br&gt;<br>
(System.Collections.Concurrent.T&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueReference&gt;c__AnonStorey1.&lt;&gt;m__0&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;private&nbsp;static&nbsp;void&nbsp;TestMonoConcurrentQueueReference()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;queue&nbsp;=&nbsp;new&nbsp;ConcurrentQueue&lt;object&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;waits&nbsp;=&nbsp;new&nbsp;List&lt;AutoResetEvent&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;5;&nbsp;i++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int&nbsp;q&nbsp;=&nbsp;i;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.Add(new&nbsp;AutoResetEvent(false));&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;t&nbsp;=&nbsp;new&nbsp;Thread(x&nbsp;=&gt;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;(int&nbsp;j&nbsp;=&nbsp;0;&nbsp;j&nbsp;&lt;&nbsp;100000000;&nbsp;j++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(j&nbsp;%&nbsp;1000000&nbsp;==&nbsp;0)&nbsp;Console.Write(&quot;.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;queue.Enqueue(new&nbsp;object());&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;object&nbsp;item;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;(queue.TryDequeue(out&nbsp;item))&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits[q].Set();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;});&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.Start();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;waiting.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.ForEach(x&nbsp;=&gt;&nbsp;x.WaitOne());&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;done.&quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;end&nbsp;up&nbsp;in&nbsp;the&nbsp;else&nbsp;{}&nbsp;on&nbsp;try&nbsp;dequeue&nbsp;here&nbsp;don&#39;t&nbsp;think&nbsp;I&nbsp;should&nbsp;ever&lt;br&gt;<br>
be&nbsp;allowed&nbsp;to&nbsp;(and&nbsp;dont&nbsp;end&nbsp;up&nbsp;there&nbsp;in&nbsp;MS&nbsp;impl)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;struct&nbsp;TestStruct&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;public&nbsp;long&nbsp;X;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;public&nbsp;long&nbsp;Y;&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;public&nbsp;TestStruct(long&nbsp;x,&nbsp;long&nbsp;y)&nbsp;:&nbsp;this()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;X&nbsp;=&nbsp;x;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Y&nbsp;=&nbsp;y;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;private&nbsp;static&nbsp;void&nbsp;TestMonoConcurrentQueueBiggerThanReference()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;queue&nbsp;=&nbsp;new&nbsp;ConcurrentQueue&lt;TestStruct&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;waits&nbsp;=&nbsp;new&nbsp;List&lt;AutoResetEvent&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for(int&nbsp;i=0;i&lt;5;i++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int&nbsp;q&nbsp;=&nbsp;i;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.Add(new&nbsp;AutoResetEvent(false));&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;t&nbsp;=&nbsp;new&nbsp;Thread(x&nbsp;=&gt;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for(int&nbsp;j=0;j&lt;100000000;j++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(j%&nbsp;1000000&nbsp;==&nbsp;0)&lt;br&gt;<br>
Console.Write(&quot;.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queue.Enqueue(new&lt;br&gt;<br>
TestStruct(0x11223344,&nbsp;0x99887766));&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TestStruct&nbsp;item;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(queue.TryDequeue(out&nbsp;item))&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(item.X&nbsp;!=&lt;br&gt;<br>
0x11223344)&nbsp;throw&nbsp;new&nbsp;Exception(&quot;bad&nbsp;x&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(item.Y&nbsp;!=&lt;br&gt;<br>
0x99887766)&nbsp;throw&nbsp;new&nbsp;Exception(&quot;bad&nbsp;y&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;else&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw&nbsp;new&lt;br&gt;<br>
Exception(&quot;unable&nbsp;to&nbsp;read.&quot;);&nbsp;&lt;~~~~&nbsp;should&nbsp;never&nbsp;hit&nbsp;this.&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waits[q].Set();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.Start();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;waiting.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.ForEach(x&nbsp;=&gt;&nbsp;x.WaitOne());&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;done.&quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
For&nbsp;good&nbsp;measure&nbsp;lets&nbsp;take&nbsp;out&nbsp;the&nbsp;exception&nbsp;in&nbsp;the&nbsp;last&nbsp;about&nbsp;not&lt;br&gt;<br>
being&nbsp;able&nbsp;to&nbsp;read&nbsp;when&nbsp;it&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;(eg&nbsp;comment&nbsp;out&nbsp;the&lt;br&gt;<br>
throw)&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.Exception:&nbsp;bad&nbsp;y&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.NullReferenceException:&nbsp;Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&lt;br&gt;<br>
of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.NullReferenceException:&nbsp;Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&lt;br&gt;<br>
of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.NullReferenceException:&nbsp;Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&lt;br&gt;<br>
of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
Unhandled&nbsp;Exception:&lt;br&gt;<br>
System.NullReferenceException:&nbsp;Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&lt;br&gt;<br>
of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
[ERROR]&nbsp;FATAL&nbsp;UNHANDLED&nbsp;EXCEPTION:&nbsp;System.Exception:&nbsp;bad&nbsp;y&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
[ERROR]&nbsp;FATAL&nbsp;UNHANDLED&nbsp;EXCEPTION:&nbsp;System.NullReferenceException:&lt;br&gt;<br>
Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&nbsp;of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
[ERROR]&nbsp;FATAL&nbsp;UNHANDLED&nbsp;EXCEPTION:&nbsp;System.NullReferenceException:&lt;br&gt;<br>
Object&nbsp;reference&nbsp;not&nbsp;set&nbsp;to&nbsp;an&nbsp;instance&nbsp;of&nbsp;an&nbsp;object&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Collections.Concurrent.ConcurrentQueue`1[ConsoleApplication1.Program+TestStruct].TryDequeue&lt;br&gt;<br>
(ConsoleApplication1.TestStruct&amp;&nbsp;result)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&lt;br&gt;<br>
unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;ConsoleApplication1.Program+&lt;TestMonoConcurrentQueueBiggerThanReference&gt;c__AnonStorey3.&lt;&gt;m__2&lt;br&gt;<br>
(System.Object&nbsp;x)&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
 &nbsp;at&nbsp;System.Threading.Thread.StartInternal&nbsp;()&nbsp;[0x00000]&nbsp;in&nbsp;&lt;filename&nbsp;unknown&gt;:0&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;private&nbsp;static&nbsp;void&nbsp;TestMonoConcurrentQueueBiggerThanReference()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;queue&nbsp;=&nbsp;new&nbsp;ConcurrentQueue&lt;TestStruct&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;waits&nbsp;=&nbsp;new&nbsp;List&lt;AutoResetEvent&gt;();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for(int&nbsp;i=0;i&lt;5;i++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int&nbsp;q&nbsp;=&nbsp;i;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.Add(new&nbsp;AutoResetEvent(false));&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;var&nbsp;t&nbsp;=&nbsp;new&nbsp;Thread(x&nbsp;=&gt;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for(int&nbsp;j=0;j&lt;100000000;j++)&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(j%&nbsp;1000000&nbsp;==&nbsp;0)&lt;br&gt;<br>
Console.Write(&quot;.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queue.Enqueue(new&lt;br&gt;<br>
TestStruct(0x11223344,&nbsp;0x99887766));&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TestStruct&nbsp;item;&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(queue.TryDequeue(out&nbsp;item))&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(item.X&nbsp;!=&lt;br&gt;<br>
0x11223344)&nbsp;throw&nbsp;new&nbsp;Exception(&quot;bad&nbsp;x&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(item.Y&nbsp;!=&lt;br&gt;<br>
0x99887766)&nbsp;throw&nbsp;new&nbsp;Exception(&quot;bad&nbsp;y&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp;else&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //throw&nbsp;new&lt;br&gt;<br>
Exception(&quot;unable&nbsp;to&nbsp;read.&quot;);&nbsp;&lt;~~~~&nbsp;should&nbsp;never&nbsp;hit&nbsp;this.&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; waits[q].Set();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; });&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.Start();&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;waiting.&quot;);&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;waits.ForEach(x&nbsp;=&gt;&nbsp;x.WaitOne());&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Console.WriteLine(&quot;done.&quot;);&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;}&lt;br&gt;<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
--&lt;br&gt;<br>
Le&nbsp;doute&nbsp;n&#39;est&nbsp;pas&nbsp;une&nbsp;condition&nbsp;agréable,&nbsp;mais&nbsp;la&nbsp;certitude&nbsp;est&nbsp;absurde.&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
