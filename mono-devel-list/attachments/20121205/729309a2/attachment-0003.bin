using System;
using System.Threading;
using System.Threading.Tasks;
using System.Diagnostics;

namespace Test705
{
	class MainClass
	{
		public static void Main(string[] args)
		{
			var sw = Stopwatch.StartNew();
			Parallel.For(0, 1000000, i =>
			             {
				new A();
			});
			Console.WriteLine("Took {0}", sw.Elapsed);
		}
	}

	public class A
	{
		public A()
		{
			array = new object[GetRandom().Next(1000)];
			for(var i = 0; i < array.Length; i++)
			{
				array[i] = new object();
			}
		}

		~A()
		{
			Interlocked.Increment(ref Counter);
		}

		public static int Counter;

		private object[] array;

		private static Random GetRandom()
		{
			if(Rand == null)
			{
				Rand = new Random();
			}
			return Rand;
		}

		[ThreadStatic]
		private static Random Rand;
	}
}
