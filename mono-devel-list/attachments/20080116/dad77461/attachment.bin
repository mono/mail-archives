Index: Test/System.Web/ChangeLog
===================================================================
--- Test/System.Web/ChangeLog	(revision 92488)
+++ Test/System.Web/ChangeLog	(working copy)
@@ -1,3 +1,7 @@
+2008-01-09  Juraj Skripsky  <js@hotfeet.ch>
+
+	* HttpRequestTest.cs (TestReferer): added test for invalid referer url.
+
 2007-12-19  Gert Driesen  <drieseng@users.sourceforge.net>
 
 	* HttpCookieCollectionTest.cs: Added test for string indexer and
Index: Test/System.Web/HttpRequestTest.cs
===================================================================
--- Test/System.Web/HttpRequestTest.cs	(revision 92488)
+++ Test/System.Web/HttpRequestTest.cs	(working copy)
@@ -417,6 +417,7 @@
 					case 1: return null;
 					case 2: return "http://www.mono-project.com/test.aspx";
 					case 15: return "http://www.mono-project.com";
+					case 33: return "x";
 					}
 					break;
 				case HttpWorkerRequest.HeaderUserAgent:
@@ -751,7 +752,10 @@
 			Assert.AreEqual (null, c.Request.UrlReferrer, "REF1");
 
 			c = Cook (2);
-			Assert.AreEqual ("http://www.mono-project.com/test.aspx", c.Request.UrlReferrer.ToString (), "REF1");			
+			Assert.AreEqual ("http://www.mono-project.com/test.aspx", c.Request.UrlReferrer.ToString (), "REF1");
+
+			c = Cook (33);
+			Assert.AreEqual (null, c.Request.UrlReferrer, "REF1");			
 		}
 		
 
Index: System.Web/ChangeLog
===================================================================
--- System.Web/ChangeLog	(revision 92488)
+++ System.Web/ChangeLog	(working copy)
@@ -1,3 +1,12 @@
+2008-01-09  Juraj Skripsky  <js@hotfeet.ch>
+
+	* HttpRequest.cs (get_UrlReferrer): Handle case when headers contain
+	invalid Url for referer.
+
+2008-01-09  Juraj Skripsky  <js@hotfeet.ch>
+
+	* HttpCookieCollection.cs (AllKeys): Use Keys.CopyTo().
+
 2008-01-02  Vladimir Krasnov  <vladimirk@mainsoft.com>
 
 	* HttpContext.cs: added resource manager caching in GetResourceObject
Index: System.Web/HttpCookieCollection.cs
===================================================================
--- System.Web/HttpCookieCollection.cs	(revision 92488)
+++ System.Web/HttpCookieCollection.cs	(working copy)
@@ -28,6 +28,7 @@
 // WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 //
 
+using System.Collections;
 using System.Collections.Specialized;
 using System.Security.Permissions;
 
@@ -161,13 +162,8 @@
 
 		public string[] AllKeys {
 			get {
-				/* XXX another inefficient copy due to
-				 * lack of exposure from the base
-				 * class */
 				string[] keys = new string [Keys.Count];
-				for (int i = 0; i < Keys.Count; i ++)
-					keys[i] = Keys[i];
-				
+				((ICollection)Keys).CopyTo (keys, 0);
 				return keys;
 			}
 		}
Index: System.Web/HttpRequest.cs
===================================================================
--- System.Web/HttpRequest.cs	(revision 92488)
+++ System.Web/HttpRequest.cs	(working copy)
@@ -1069,7 +1069,11 @@
 				if (hr == null)
 					return null;
 
-				return new Uri (hr);
+				Uri uri = null;
+				try {
+					uri = new Uri (hr);
+				} catch (UriFormatException) {}
+				return uri;
 			}
 		}
 
