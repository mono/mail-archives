<tt>
Hi,&lt;br&gt;&lt;br&gt;The&nbsp;attached&nbsp;patch&nbsp;fixed&nbsp;this&nbsp;issues&nbsp;and&nbsp;remove&nbsp;some&nbsp;commented&nbsp;code&nbsp;too.&nbsp;I&nbsp;have&nbsp;changed&nbsp;all&nbsp;call&nbsp;sites&nbsp;of&nbsp;functions&nbsp;that&nbsp;can&nbsp;fail&nbsp;to&nbsp;verify&nbsp;the&nbsp;return&nbsp;value.&lt;br&gt;&lt;br&gt;Cheers,&lt;br&gt;Rodrigo&nbsp;Kumpera&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
On&nbsp;6/12/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Paolo&nbsp;Molaro&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&gt;lupus@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
On&nbsp;06/11/07&nbsp;Rodrigo&nbsp;Kumpera&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;Index:&nbsp;verify.c&lt;br&gt;&amp;gt;&nbsp;===================================================================&lt;br&gt;&amp;gt;&nbsp;---&nbsp;verify.c&amp;nbsp;&amp;nbsp;(revision&nbsp;79204)&lt;br&gt;&amp;gt;&nbsp;+++&nbsp;verify.c&amp;nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;&amp;gt;&nbsp;+/*&nbsp;FIXME:&nbsp;we&nbsp;could&nbsp;just&nbsp;load&nbsp;the&nbsp;signature&nbsp;instead&nbsp;of&nbsp;the&nbsp;whole&nbsp;MonoMethod<br>
&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*&nbsp;TODO&nbsp;handle&nbsp;vararg&nbsp;calls&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*&nbsp;TODO&nbsp;handle&nbsp;non&nbsp;virt&nbsp;calls&nbsp;to&nbsp;non-final&nbsp;virtual&nbsp;calls&nbsp;(exception&nbsp;clause&nbsp;in&nbsp;page&nbsp;52&nbsp;of&nbsp;partition&nbsp;3)&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*/&lt;br&gt;&amp;gt;&nbsp;+static&nbsp;void&lt;br&gt;&amp;gt;&nbsp;+do_invoke_method&nbsp;(VerifyContext&nbsp;*ctx,&nbsp;int&nbsp;method_token)<br>
&lt;br&gt;&amp;gt;&nbsp;+{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;int&nbsp;param_count,&nbsp;i;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoMethodSignature&nbsp;*sig;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ILStackDesc&nbsp;*value;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoMethod&nbsp;*method&nbsp;=&nbsp;mono_get_method_full&nbsp;(ctx-&amp;gt;image,&nbsp;method_token,&nbsp;NULL,&nbsp;ctx-&amp;gt;generic_context);<br>
&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(!method)&nbsp;{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ADD_VERIFY_ERROR&nbsp;(ctx,&nbsp;g_strdup_printf&nbsp;(&amp;quot;Method&nbsp;0x%08x&nbsp;not&nbsp;found&nbsp;at&nbsp;0x%04x&amp;quot;,&nbsp;method_token,&nbsp;ctx-&amp;gt;ip_offset));&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}<br>
&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(!(sig&nbsp;=&nbsp;mono_method_signature&nbsp;(method)))&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;sig&nbsp;=&nbsp;mono_method_get_signature&nbsp;(method,&nbsp;ctx-&amp;gt;image,&nbsp;method_token);&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;param_count&nbsp;=&nbsp;sig-&amp;gt;param_count&nbsp;+&nbsp;sig-&amp;gt;hasthis;<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;check_underflow&nbsp;(ctx,&nbsp;param_count);&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;sig-&amp;gt;param_count&nbsp;-&nbsp;1;&nbsp;i&nbsp;&amp;gt;=&nbsp;0;&nbsp;--i)&nbsp;{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;VERIFIER_DEBUG&nbsp;(&nbsp;printf&nbsp;(&amp;quot;verifying&nbsp;argument&nbsp;%d\n&amp;quot;,&nbsp;i);&nbsp;);&lt;br&gt;<br>
&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;value&nbsp;=&nbsp;stack_pop&nbsp;(ctx);&lt;br&gt;&lt;br&gt;If&nbsp;check_underflow&nbsp;failed,&nbsp;stack_pop()&nbsp;will&nbsp;access&nbsp;random&nbsp;memory:&nbsp;there&lt;br&gt;are&nbsp;a&nbsp;few&nbsp;cases&nbsp;where&nbsp;after&nbsp;some&nbsp;errors,&nbsp;you&nbsp;can&amp;#39;t&nbsp;continue&nbsp;checking&nbsp;for&lt;br&gt;more,&nbsp;as&nbsp;it&nbsp;would&nbsp;involve&nbsp;either&nbsp;bugs&nbsp;as&nbsp;above&nbsp;or&nbsp;adding&nbsp;many&nbsp;more<br>
&lt;br&gt;checks&nbsp;that&nbsp;slow&nbsp;down&nbsp;everything.&nbsp;Here&nbsp;we&nbsp;see&nbsp;a&nbsp;mismatch&nbsp;between&nbsp;the&lt;br&gt;needs&nbsp;of&nbsp;a&nbsp;verifier&nbsp;for&nbsp;the&nbsp;JIT&amp;#39;s&nbsp;use&nbsp;and&nbsp;an&nbsp;offline&nbsp;verifier:&nbsp;for&nbsp;the&lt;br&gt;JIT&nbsp;it&nbsp;needs&nbsp;to&nbsp;bail&nbsp;out&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible,&nbsp;for&nbsp;an&nbsp;offline&nbsp;verifier<br>
&lt;br&gt;you&nbsp;may&nbsp;want&nbsp;to&nbsp;try&nbsp;to&nbsp;continue&nbsp;and&nbsp;provide&nbsp;to&nbsp;the&nbsp;user&nbsp;more&nbsp;useful&lt;br&gt;feedback&nbsp;(sort&nbsp;of&nbsp;like&nbsp;compilers&nbsp;will&nbsp;try&nbsp;to&nbsp;check&nbsp;for&nbsp;more&nbsp;errors&nbsp;after&lt;br&gt;the&nbsp;first).&nbsp;Please&nbsp;check&nbsp;all&nbsp;the&nbsp;uses&nbsp;of&nbsp;check_underflow()&nbsp;and&nbsp;similar<br>
&lt;br&gt;for&nbsp;this&nbsp;issue.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(!verify_type_compat&nbsp;(ctx,&nbsp;sig-&amp;gt;params[i],&nbsp;value))&nbsp;{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ADD_VERIFY_ERROR&nbsp;(ctx,&nbsp;g_strdup_printf&nbsp;(&amp;quot;Incompatible&nbsp;parameter&nbsp;value&nbsp;with&nbsp;function&nbsp;signature&nbsp;at&nbsp;0x%04x&amp;quot;,&nbsp;ctx-&amp;gt;ip_offset));<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(sig-&amp;gt;hasthis)&nbsp;{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoType&nbsp;dummy;&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;VERIFIER_DEBUG&nbsp;(&nbsp;printf&nbsp;(&amp;quot;verifying&nbsp;this&nbsp;argument\n&amp;quot;);&nbsp;);<br>
&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;memset&nbsp;(&amp;amp;dummy,&nbsp;0,&nbsp;sizeof&nbsp;(MonoType));&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;dummy.data.klass&nbsp;=&nbsp;method-&amp;gt;klass;&lt;br&gt;&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(method-&amp;gt;klass&nbsp;==&nbsp;mono_defaults.object_class)&lt;br&gt;<br>
&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;dummy.type&nbsp;=&nbsp;MONO_TYPE_OBJECT;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;else&nbsp;if(method-&amp;gt;klass&nbsp;==&nbsp;mono_defaults.string_class)&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;dummy.type&nbsp;=&nbsp;MONO_TYPE_STRING;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;else<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;dummy.type&nbsp;=&nbsp;MONO_TYPE_CLASS;&lt;br&gt;&lt;br&gt;Please&nbsp;don&amp;#39;t&nbsp;construct&nbsp;a&nbsp;dummy&nbsp;type&nbsp;here:&nbsp;use&nbsp;klass-&amp;gt;byval_arg&nbsp;for&nbsp;references&lt;br&gt;and&nbsp;klass-&amp;gt;this_arg&nbsp;for&nbsp;valuetypes.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(sig-&amp;gt;ret-&amp;gt;type&nbsp;!=&nbsp;MONO_TYPE_VOID)&nbsp;{<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;check_overflow&nbsp;(ctx);&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;set_stack_value&nbsp;(stack_push&nbsp;(ctx),&nbsp;sig-&amp;gt;ret,&nbsp;FALSE);&lt;br&gt;&lt;br&gt;Here&nbsp;is&nbsp;another&nbsp;example&nbsp;where&nbsp;we&nbsp;flag&nbsp;the&nbsp;overflow&nbsp;error,&nbsp;but&nbsp;continue&lt;br&gt;and&nbsp;scribble&nbsp;over&nbsp;memory&nbsp;corrupting&nbsp;it.<br>
&lt;br&gt;&lt;br&gt;Thanks!&lt;br&gt;&lt;br&gt;lupus&lt;br&gt;&lt;br&gt;--&lt;br&gt;-----------------------------------------------------------------&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@debian.org&quot;&gt;lupus@debian.org&lt;/a&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;debian/rules&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&gt;<br>
lupus@ximian.com&lt;/a&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Monkeys&nbsp;do&nbsp;it&nbsp;better&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com<br>
&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
