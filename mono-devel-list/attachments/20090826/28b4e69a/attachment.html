<tt>
Hi,&lt;br&gt;&lt;br&gt; &nbsp;mono_gc_free_fixed&nbsp;()&nbsp;is&nbsp;a&nbsp;no-op&nbsp;when&nbsp;using&nbsp;mono&amp;#39;s&nbsp;built&nbsp;in&nbsp;GC,&nbsp;since&nbsp;mono_gc_alloc_fixed&nbsp;()&nbsp;is&nbsp;implemented&nbsp;as&nbsp;a&nbsp;call&nbsp;to&nbsp;GC_malloc&nbsp;().&lt;br&gt;&lt;br&gt;                    &nbsp;Zoltan&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Aug&nbsp;26,&nbsp;2009&nbsp;at&nbsp;2:55&nbsp;AM,&nbsp;James&nbsp;Zhao&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:jameszhao00@gmail.com&quot;&gt;jameszhao00@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;Hi,<br>
&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
Here&amp;#39;s&nbsp;Mono&nbsp;Continuations&amp;#39;&nbsp;continuation_store&nbsp;(...).&nbsp;From&nbsp;looking&nbsp;at&nbsp;the&nbsp;code&nbsp;below,&nbsp;it&nbsp;appears&nbsp;as&nbsp;though&nbsp;store()&nbsp;follows&nbsp;these&nbsp;two&nbsp;branches:<br>
&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
&nbsp;1.&nbsp;cont-&amp;gt;saved_stack&nbsp;&amp;amp;&amp;amp;&nbsp;num_bytes&nbsp;&amp;lt;=&nbsp;cont-&amp;gt;stack_alloc_size<br>
&nbsp;&nbsp;&nbsp;-&nbsp;use&nbsp;the&nbsp;memory&nbsp;directly &lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
&nbsp;2.&nbsp;else<br>
&nbsp;&nbsp;&nbsp;-&nbsp;gc&nbsp;free&nbsp;the&nbsp;used&nbsp;memory,&nbsp;and&nbsp;create&nbsp;some&nbsp;new&nbsp;memory.<br>
&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
However,&nbsp;the&nbsp;weird&nbsp;thing&nbsp;is&nbsp;if&nbsp;I&nbsp;repeatedly&nbsp;use&nbsp;continuation_store(),&nbsp;the&nbsp;memory&nbsp;usage&nbsp;increases&nbsp;until&nbsp;at&nbsp;a&nbsp;later&nbsp;step&nbsp;a&nbsp;huge&nbsp;and&nbsp;laggy&nbsp;GC&nbsp;operation&nbsp;is&nbsp;done.&nbsp;Can&nbsp;anyone&nbsp;explain&nbsp;why&nbsp;this&nbsp;happens?<br>
&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;If&nbsp;I&nbsp;alloc/free&nbsp;a&nbsp;continuation&nbsp;for&nbsp;roughly&nbsp;each&nbsp;time&nbsp;I&nbsp;call&nbsp;store&nbsp;,&nbsp;the&nbsp;continuation&nbsp;appears&nbsp;to&nbsp;be&nbsp;GC&amp;#39;ed&nbsp;immediately.&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
Thanks&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;15px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;James&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;line-height:&nbsp;13px;&nbsp;white-space:&nbsp;pre-wrap;&quot;&gt;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;small;&quot;&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;int<br>
&nbsp;&nbsp;&nbsp;&nbsp;continuation_store&nbsp;(MonoContinuation&nbsp;*cont,&nbsp;int&nbsp;state,&nbsp;MonoException&nbsp;**e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspMonoLMF&nbsp;*lmf&nbsp;=&nbsp;mono_get_lmf&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspgsize&nbsp;num_bytes;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspif&nbsp;(!cont-&amp;gt;domain)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp*e&nbsp;=&nbsp;&nbsp;mono_get_exception_argument&nbsp;(&amp;quot;cont&amp;quot;,&nbsp;&amp;quot;Continuation&nbsp;not&nbsp;initialized&amp;quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspif&nbsp;(cont-&amp;gt;domain&nbsp;!=&nbsp;mono_domain_get&nbsp;()&nbsp;||&nbsp;cont-&amp;gt;thread_id&nbsp;!=&nbsp;GetCurrentThreadId&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp*e&nbsp;=&nbsp;mono_get_exception_argument&nbsp;(&amp;quot;cont&amp;quot;,&nbsp;&amp;quot;Continuation&nbsp;from&nbsp;another&nbsp;thread&nbsp;or&nbsp;domain&amp;quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;lmf&nbsp;=&nbsp;lmf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;return_ip&nbsp;=&nbsp;__builtin_return_address&nbsp;(0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;return_sp&nbsp;=&nbsp;__builtin_frame_address&nbsp;(0);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspnum_bytes&nbsp;=&nbsp;(char*)cont-&amp;gt;top_sp&nbsp;-&nbsp;(char*)cont-&amp;gt;return_sp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp/*g_print&nbsp;(&amp;quot;store:&nbsp;%d&nbsp;bytes,&nbsp;sp:&nbsp;%p,&nbsp;ip:&nbsp;%p,&nbsp;lmf:&nbsp;%p\n&amp;quot;,&nbsp;num_bytes,&nbsp;cont-&amp;gt;return_sp,&nbsp;cont-&amp;gt;return_ip,&nbsp;lmf);*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspif&nbsp;(cont-&amp;gt;saved_stack&nbsp;&amp;amp;&amp;amp;&nbsp;num_bytes&nbsp;&amp;lt;=&nbsp;cont-&amp;gt;stack_alloc_size)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp/*&nbsp;clear&nbsp;to&nbsp;avoid&nbsp;GC&nbsp;retention&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspif&nbsp;(num_bytes&nbsp;&amp;lt;&nbsp;cont-&amp;gt;stack_used_size)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspmemset&nbsp;((char*)cont-&amp;gt;saved_stack&nbsp;+&nbsp;num_bytes,&nbsp;0,&nbsp;cont-&amp;gt;stack_used_size&nbsp;-&nbsp;num_bytes);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp}&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspelse&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsptasklets_lock&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspinternal_init&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspif&nbsp;(cont-&amp;gt;saved_stack)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspmono_g_hash_table_remove&nbsp;(keepalive_stacks,&nbsp;cont-&amp;gt;saved_stack);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspmono_gc_free_fixed&nbsp;(cont-&amp;gt;saved_stack);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;stack_used_size&nbsp;=&nbsp;num_bytes;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;stack_alloc_size&nbsp;=&nbsp;num_bytes&nbsp;*&nbsp;1.1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspcont-&amp;gt;saved_stack&nbsp;=&nbsp;mono_gc_alloc_fixed&nbsp;(cont-&amp;gt;stack_alloc_size,&nbsp;NULL);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspmono_g_hash_table_insert&nbsp;(keepalive_stacks,&nbsp;cont-&amp;gt;saved_stack,&nbsp;cont-&amp;gt;saved_stack);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsptasklets_unlock&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspmemcpy&nbsp;(cont-&amp;gt;saved_stack,&nbsp;cont-&amp;gt;return_sp,&nbsp;num_bytes);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspreturn&nbsp;state;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/span&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
