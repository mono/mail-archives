using System;
using System.Net;
using System.Net.Sockets;

namespace test_sendfile
{
	class MainClass
	{
		public static void Main (string[] args)
		{
			if (args.Length != 3) {
				Console.WriteLine ("Usage: test_sendfile AddessIP port file_to_send");
				return;

			}
			AsynchronousFileSend (args[0], args[1], args[2]);
			Console.WriteLine ("Press <enter> to close");
			Console.ReadLine ();
		}

		public static void AsynchronousFileSend(string server, string port, string fileName)
		{
			// Send a file to a remote device.
			IPAddress ipAddress = IPAddress.Parse (server);
			IPEndPoint remoteEP = new IPEndPoint(ipAddress, Int16.Parse(port));
			
			// Create a TCP/IP socket.
			Socket client = new Socket(AddressFamily.InterNetwork, SocketType.Stream, ProtocolType.Tcp);

			client.Connect (remoteEP);

			// Send file fileName to the remote device.
			Console.WriteLine(fileName);
			client.BeginSendFile(fileName, new AsyncCallback(FileSendCallback), client);

		}

		private static void FileSendCallback(IAsyncResult ar)
		{
			// Retrieve the socket from the state object.
			Socket client = (Socket) ar.AsyncState;
			
			// Complete sending the data to the remote device.
			client.EndSendFile(ar);
		}
	}
}