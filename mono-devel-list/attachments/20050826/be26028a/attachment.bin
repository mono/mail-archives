Index: docbrowser/GeckoHtmlRender.cs
===================================================================
--- docbrowser/GeckoHtmlRender.cs	(revision 48726)
+++ docbrowser/GeckoHtmlRender.cs	(working copy)
@@ -48,7 +48,6 @@
 	protected void OnOpenUri (object o, OpenUriArgs args)
 	{
 		url = CheckUrl (args.AURI);
-		System.Console.WriteLine ("Abriendo:{0}:{1}:", url, args.AURI);
 		if (UrlClicked != null)
 			UrlClicked (this, new EventArgs());
 		args.RetVal = true; //this prevents Gecko to continue processing
Index: docbrowser/ChangeLog
===================================================================
--- docbrowser/ChangeLog	(revision 48726)
+++ docbrowser/ChangeLog	(working copy)
@@ -1,3 +1,16 @@
+2005-08-22 Mario Sopena Novales <mario.sopena@gmail.com>
+	* browser.cs:
+		- Update the treeview everytime we change the tab
+		- Added a new CurrentNode property to Tabs
+		- Added a new class Contributions (Contributions window)
+		- update the save process to include the new NodeUrl property
+		- update the serial of not uploaded changes after a successful upload
+		- dont set the browser mode to viewer every time a row is activated
+	* browser.glade: 
+		- Change the "upload contributions" menu to "Contributions"
+		- Add the Contributions window
+	* GeckoHtmlRender.cs: cleaned
+	
 2005-08-17 Mario Sopena Novales <mario.sopena@gmail.com>
 	* browser.cs: Added Menu Items for changing the font size when using 
 	gecko. Also added a Reload function.
Index: docbrowser/browser.cs
===================================================================
--- docbrowser/browser.cs	(revision 48726)
+++ docbrowser/browser.cs	(working copy)
@@ -307,6 +307,9 @@
 		} else {
 			paste1.Sensitive = true;
 		}
+		
+		if (tree_browser.SelectedNode != CurrentTab.CurrentNode)
+			tree_browser.ShowNode (CurrentTab.CurrentNode);
 	}
 	//
 	// Reload current page
@@ -451,6 +454,7 @@
 	public void Render (string text, Node matched_node, string url)
 	{
 		CurrentUrl = url;
+		CurrentTab.CurrentNode = matched_node;
 		CurrentTab.html.Render(text);
 		if (matched_node != null) {
 			if (tree_browser.SelectedNode != matched_node)
@@ -740,7 +744,124 @@
 		About.Show (this);
 	}
 
-	void OnUpload (object sender, EventArgs a)
+	void OnContrib (object sender, EventArgs a) 
+	{
+		Contributions.Show (this);
+	}
+
+	class Contributions {
+		[Glade.Widget] Window contribs;
+		[Glade.Widget] TreeView contrib_tree;
+		[Glade.Widget] Button contrib_open;
+		[Glade.Widget] Button contrib_restore;
+		ListStore contrib_store;
+
+		static Contributions ContribBox;
+		Browser parent;
+		GlobalChangeset chgs;
+
+		Contributions (Browser parent)
+		{
+			Glade.XML ui = new Glade.XML (null, "browser.glade", "contribs", null);
+			ui.Autoconnect (this);
+			this.parent = parent;
+			contribs.TransientFor = parent.window1;
+
+			contrib_store = new ListStore (typeof (bool), typeof (string), typeof (Change));
+
+			chgs = EditingUtils.changes;
+			contrib_tree.Selection.Changed += new EventHandler (OnSelectionChg);
+
+			contrib_tree.Model = contrib_store;
+			
+			// columns
+			CellRendererToggle toggle_cell = new CellRendererToggle ();
+			toggle_cell.Toggled += new ToggledHandler (OnToggleCell);
+			contrib_tree.AppendColumn ("upload", toggle_cell, "active", 0);
+			contrib_tree.AppendColumn ("node_url", new CellRendererText (), "text", 1);
+		}
+		static public void Show (Browser parent)
+		{
+			if (ContribBox == null)
+				ContribBox = new Contributions (parent);
+
+			ContribBox.Load ();
+			ContribBox.contribs.ShowAll ();
+
+		}
+		void Load ()
+		{
+			contrib_store.Clear ();
+			foreach (DocSetChangeset dscs in chgs.DocSetChangesets) 
+				foreach (FileChangeset fcs in dscs.FileChangesets) 
+					foreach (Change c in fcs.Changes)  {
+						if (c.NodeUrl == null)
+							continue;
+						if (c.Serial == SettingsHandler.Settings.SerialNumber)
+							contrib_store.AppendValues (c.Upload, c.NodeUrl, c);
+					}
+		}
+			
+		//
+		// Event handlers
+		//
+		public void OnToggleCell (object sender, ToggledArgs args)
+		{
+			TreeIter iter;
+			bool ok = contrib_store.GetIterFromString (out iter, args.Path);
+			if (!ok)
+				return;
+			//obtain the change, toggle and save it
+			Change c = contrib_store.GetValue (iter, 2) as Change;
+			c.Upload = !c.Upload;
+
+			chgs.Save ();
+			Load ();
+		}
+		void OnSelectionChg (object sender, EventArgs a)
+		{
+			contrib_open.Sensitive = true;
+			contrib_restore.Sensitive = true;
+		}
+		public void OpenContrib (object sender, EventArgs a)
+		{
+			TreeIter iter;
+			TreeModel model;
+			bool selected = contrib_tree.Selection.GetSelected (out model, out iter);
+			if (!selected)
+				return;
+			Change c = contrib_store.GetValue (iter, 2) as Change;
+			parent.LoadUrl (c.NodeUrl);
+		}
+		public void DeleteContrib (object sender, EventArgs a)
+		{
+			TreeIter iter;
+			TreeModel model;
+			bool selected = contrib_tree.Selection.GetSelected (out model, out iter);
+			if (!selected)
+				return;
+			
+			Change del = contrib_store.GetValue (iter, 2) as Change;
+			chgs.DelChange (del);
+			//reload the tree
+			Load ();
+			//reload the browser
+			parent.Reload ();
+		}
+		public void OnUpload (object sender, EventArgs a)
+		{
+			contribs.Hide ();
+			parent.OnUpload ();
+		}
+		public void CloseContrib (object sender, EventArgs a)
+		{
+			contribs.Hide ();
+			ContribBox = null;	
+		}
+			
+		
+	}
+	void OnUpload ()
 	{
 		string key = SettingsHandler.Settings.Key;
 		if (key == null || key == "")
@@ -839,6 +960,14 @@
 			case State.Done:
 				status.Text = "All contributions uploaded";
 				cancel.Label = "Close";
+				//update serial of not uploaded changes
+				foreach (DocSetChangeset dscs in EditingUtils.changes.DocSetChangesets) 
+					foreach (FileChangeset fcs in dscs.FileChangesets) 
+						foreach (Change c in fcs.Changes) 
+							if (c.NodeUrl != null && !c.Upload)
+								c.Serial = serial;
+
+				EditingUtils.changes.Save ();
 				SettingsHandler.Settings.SerialNumber = serial;
 				SettingsHandler.Save ();
 				return;
@@ -1550,7 +1679,7 @@
 	void RowActivated  (object sender, EventArgs a)
 	{
 
-		browser.CurrentTab.SetMode (Mode.Viewer);
+		//browser.CurrentTab.SetMode (Mode.Viewer);
 
 		if (IgnoreRowActivated)
 			return;
@@ -1896,6 +2025,7 @@
 		set { titleLabel.Text = value; }
 	}
 	
+	public Node CurrentNode;
 	public System.Xml.XmlNode edit_node;
 	public string edit_url;
 	
@@ -1903,6 +2033,7 @@
 	{
 
 		browser = br;
+		CurrentNode = br.help_tree;
 		ShowTabs = false;
 		ShowBorder = false;
 		TabBorder = 0;
@@ -2127,7 +2258,7 @@
 			browser.statusbar.Push (browser.context_id, e.Message);
 			return;
 		}
-		EditingUtils.SaveChange (edit_url, browser.help_tree, edit_node);
+		EditingUtils.SaveChange (edit_url, browser.help_tree, edit_node, EcmaHelpSource.GetNiceUrl (browser.CurrentTab.CurrentNode));
 		SetMode (Mode.Viewer);
 		history.ActivateCurrent ();
 	}
Index: docbrowser/browser.glade
===================================================================
--- docbrowser/browser.glade	(revision 48726)
+++ docbrowser/browser.glade	(working copy)
@@ -85,9 +85,9 @@
 		  <child>
 		    <widget class="GtkMenuItem" id="contributor_settings1">
 		      <property name="visible">True</property>
-		      <property name="label" translatable="yes">_Upload Contributions</property>
+		      <property name="label" translatable="yes">Contrib_utions</property>
 		      <property name="use_underline">True</property>
-		      <signal name="activate" handler="OnUpload" last_modification_time="Wed, 08 Oct 2003 02:53:43 GMT"/>
+		      <signal name="activate" handler="OnContrib"  last_modification_time="Tue, 23 Aug 2005 15:01:59 GMT"/>
 		      <accelerator key="U" modifiers="GDK_CONTROL_MASK" signal="activate"/>
 		    </widget>
 		  </child>
@@ -3142,4 +3142,266 @@
   </child>
 </widget>
 
+<widget class="GtkWindow" id="contribs">
+  <property name="visible">True</property>
+  <property name="title" translatable="yes">Contributions</property>
+  <property name="type">GTK_WINDOW_TOPLEVEL</property>
+  <property name="window_position">GTK_WIN_POS_NONE</property>
+  <property name="modal">True</property>
+  <property name="default_width">475</property>
+  <property name="default_height">275</property>
+  <property name="resizable">True</property>
+  <property name="destroy_with_parent">False</property>
+  <property name="decorated">True</property>
+  <property name="skip_taskbar_hint">False</property>
+  <property name="skip_pager_hint">False</property>
+  <property name="type_hint">GDK_WINDOW_TYPE_HINT_NORMAL</property>
+  <property name="gravity">GDK_GRAVITY_NORTH_WEST</property>
+  <property name="focus_on_map">True</property>
+  <signal name="delete_event" handler="CloseContrib" last_modification_time="Tue, 23 Aug 2005 13:37:54 GMT"/>
+
+  <child>
+    <widget class="GtkVBox" id="vbox31">
+      <property name="visible">True</property>
+      <property name="homogeneous">False</property>
+      <property name="spacing">0</property>
+
+      <child>
+	<widget class="GtkLabel" id="label67">
+	  <property name="visible">True</property>
+	  <property name="label" translatable="yes">The selected items will be uploaded</property>
+	  <property name="use_underline">False</property>
+	  <property name="use_markup">False</property>
+	  <property name="justify">GTK_JUSTIFY_LEFT</property>
+	  <property name="wrap">False</property>
+	  <property name="selectable">False</property>
+	  <property name="xalign">0.3</property>
+	  <property name="yalign">0</property>
+	  <property name="xpad">0</property>
+	  <property name="ypad">0</property>
+	  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+	  <property name="width_chars">-1</property>
+	  <property name="single_line_mode">False</property>
+	  <property name="angle">0</property>
+	</widget>
+	<packing>
+	  <property name="padding">6</property>
+	  <property name="expand">False</property>
+	  <property name="fill">False</property>
+	</packing>
+      </child>
+
+      <child>
+	<widget class="GtkHSeparator" id="hseparator6">
+	  <property name="visible">True</property>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">False</property>
+	  <property name="fill">True</property>
+	</packing>
+      </child>
+
+      <child>
+	<widget class="GtkHBox" id="hbox34">
+	  <property name="visible">True</property>
+	  <property name="homogeneous">False</property>
+	  <property name="spacing">0</property>
+
+	  <child>
+	    <widget class="GtkScrolledWindow" id="scrolledwindow6">
+	      <property name="border_width">3</property>
+	      <property name="visible">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="hscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+	      <property name="vscrollbar_policy">GTK_POLICY_AUTOMATIC</property>
+	      <property name="shadow_type">GTK_SHADOW_IN</property>
+	      <property name="window_placement">GTK_CORNER_TOP_LEFT</property>
+
+	      <child>
+		<widget class="GtkTreeView" id="contrib_tree">
+		  <property name="visible">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="headers_visible">False</property>
+		  <property name="rules_hint">False</property>
+		  <property name="reorderable">False</property>
+		  <property name="enable_search">True</property>
+		  <property name="hover_selection">False</property>
+		  <property name="hover_expand">False</property>
+		</widget>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="padding">0</property>
+	      <property name="expand">True</property>
+	      <property name="fill">True</property>
+	    </packing>
+	  </child>
+
+	  <child>
+	    <widget class="GtkVButtonBox" id="vbuttonbox2">
+	      <property name="border_width">4</property>
+	      <property name="visible">True</property>
+	      <property name="layout_style">GTK_BUTTONBOX_START</property>
+	      <property name="spacing">3</property>
+
+	      <child>
+		<widget class="GtkButton" id="contrib_open">
+		  <property name="visible">True</property>
+		  <property name="sensitive">False</property>
+		  <property name="can_default">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label">gtk-open</property>
+		  <property name="use_stock">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <signal name="clicked" handler="OpenContrib" last_modification_time="Tue, 23 Aug 2005 13:37:01 GMT"/>
+		</widget>
+	      </child>
+
+	      <child>
+		<widget class="GtkButton" id="contrib_restore">
+		  <property name="visible">True</property>
+		  <property name="sensitive">False</property>
+		  <property name="can_default">True</property>
+		  <property name="can_focus">True</property>
+		  <property name="label">gtk-undelete</property>
+		  <property name="use_stock">True</property>
+		  <property name="relief">GTK_RELIEF_NORMAL</property>
+		  <property name="focus_on_click">True</property>
+		  <signal name="clicked" handler="DeleteContrib" last_modification_time="Tue, 23 Aug 2005 13:36:50 GMT"/>
+		</widget>
+	      </child>
+	    </widget>
+	    <packing>
+	      <property name="padding">0</property>
+	      <property name="expand">False</property>
+	      <property name="fill">True</property>
+	      <property name="pack_type">GTK_PACK_END</property>
+	    </packing>
+	  </child>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">True</property>
+	  <property name="fill">True</property>
+	</packing>
+      </child>
+
+      <child>
+	<widget class="GtkHSeparator" id="hseparator5">
+	  <property name="visible">True</property>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">False</property>
+	  <property name="fill">True</property>
+	</packing>
+      </child>
+
+      <child>
+	<widget class="GtkHButtonBox" id="hbuttonbox3">
+	  <property name="border_width">7</property>
+	  <property name="visible">True</property>
+	  <property name="layout_style">GTK_BUTTONBOX_END</property>
+	  <property name="spacing">0</property>
+
+	  <child>
+	    <widget class="GtkButton" id="button32">
+	      <property name="visible">True</property>
+	      <property name="can_default">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="label">gtk-close</property>
+	      <property name="use_stock">True</property>
+	      <property name="relief">GTK_RELIEF_NORMAL</property>
+	      <property name="focus_on_click">True</property>
+	      <signal name="clicked" handler="CloseContrib" last_modification_time="Tue, 23 Aug 2005 13:37:28 GMT"/>
+	    </widget>
+	  </child>
+
+	  <child>
+	    <widget class="GtkButton" id="contrib_upload">
+	      <property name="visible">True</property>
+	      <property name="can_default">True</property>
+	      <property name="can_focus">True</property>
+	      <property name="relief">GTK_RELIEF_NORMAL</property>
+	      <property name="focus_on_click">True</property>
+	      <signal name="clicked" handler="OnUpload" last_modification_time="Tue, 23 Aug 2005 15:01:59 GMT"/>
+
+	      <child>
+		<widget class="GtkAlignment" id="alignment1">
+		  <property name="visible">True</property>
+		  <property name="xalign">0.5</property>
+		  <property name="yalign">0.5</property>
+		  <property name="xscale">0</property>
+		  <property name="yscale">0</property>
+		  <property name="top_padding">0</property>
+		  <property name="bottom_padding">0</property>
+		  <property name="left_padding">0</property>
+		  <property name="right_padding">0</property>
+
+		  <child>
+		    <widget class="GtkHBox" id="hbox35">
+		      <property name="visible">True</property>
+		      <property name="homogeneous">False</property>
+		      <property name="spacing">2</property>
+
+		      <child>
+			<widget class="GtkImage" id="image133">
+			  <property name="visible">True</property>
+			  <property name="stock">gtk-connect</property>
+			  <property name="icon_size">4</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			</widget>
+			<packing>
+			  <property name="padding">0</property>
+			  <property name="expand">False</property>
+			  <property name="fill">False</property>
+			</packing>
+		      </child>
+
+		      <child>
+			<widget class="GtkLabel" id="label66">
+			  <property name="visible">True</property>
+			  <property name="label" translatable="yes">_Upload</property>
+			  <property name="use_underline">True</property>
+			  <property name="use_markup">False</property>
+			  <property name="justify">GTK_JUSTIFY_LEFT</property>
+			  <property name="wrap">False</property>
+			  <property name="selectable">False</property>
+			  <property name="xalign">0.5</property>
+			  <property name="yalign">0.5</property>
+			  <property name="xpad">0</property>
+			  <property name="ypad">0</property>
+			  <property name="ellipsize">PANGO_ELLIPSIZE_NONE</property>
+			  <property name="width_chars">-1</property>
+			  <property name="single_line_mode">False</property>
+			  <property name="angle">0</property>
+			</widget>
+			<packing>
+			  <property name="padding">0</property>
+			  <property name="expand">False</property>
+			  <property name="fill">False</property>
+			</packing>
+		      </child>
+		    </widget>
+		  </child>
+		</widget>
+	      </child>
+	    </widget>
+	  </child>
+	</widget>
+	<packing>
+	  <property name="padding">0</property>
+	  <property name="expand">False</property>
+	  <property name="fill">True</property>
+	</packing>
+      </child>
+    </widget>
+  </child>
+</widget>
+
 </glade-interface>