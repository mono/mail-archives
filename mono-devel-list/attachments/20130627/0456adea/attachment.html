<tt>
&lt;html&gt;&lt;body&gt;&lt;div&nbsp;style=&quot;color:#000;&nbsp;background-color:#fff;&nbsp;font-family:lucida&nbsp;console,&nbsp;sans-serif;font-size:10pt&quot;&gt;I&nbsp;just&nbsp;dealt&nbsp;with&nbsp;AOT&nbsp;cross&nbsp;compiling&nbsp;from&nbsp;win64&nbsp;to&nbsp;freebsd/amd64&nbsp;and&nbsp;had&nbsp;something&nbsp;like&nbsp;this&lt;br&gt;&lt;br&gt;mono_marshal_get_icall_wrapper&nbsp;emits&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;function&nbsp;to&nbsp;call&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;compilation.&lt;br&gt;&lt;br&gt;&lt;br&gt;As&nbsp;I&nbsp;was&nbsp;only&nbsp;concerned&nbsp;with&nbsp;AOT&nbsp;I&nbsp;just&nbsp;changed&lt;br&gt;&lt;br&gt;mono_mb_emit_native_call&nbsp;(mb,&nbsp;csig2,&nbsp;(gpointer)&nbsp;func);&lt;br&gt;&lt;br&gt;to&lt;br&gt;&lt;br&gt;mono_mb_emit_byte&nbsp;(mb,&nbsp;MONO_CUSTOM_PREFIX);&lt;div&gt;mono_mb_emit_op&nbsp;(mb,&nbsp;CEE_MONO_ICALL,&nbsp;func);&lt;/div&gt;&lt;br&gt;&lt;br&gt;I'm&nbsp;sure&nbsp;there&nbsp;was&nbsp;another&nbsp;case&nbsp;that&nbsp;also&nbsp;emitted&nbsp;the&nbsp;wrong&nbsp;address&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;but&nbsp;can't&nbsp;find&nbsp;it&nbsp;at&nbsp;the&nbsp;moment.&lt;br&gt;&lt;br&gt;Another&nbsp;issue&nbsp;that&nbsp;probably&nbsp;doesn't&nbsp;apply&nbsp;to&nbsp;you,&nbsp;but&nbsp;caused&nbsp;huge&nbsp;problems,&nbsp;was&nbsp;alignment&nbsp;of&nbsp;data&nbsp;structures&nbsp;between&nbsp;different&nbsp;compilers.&lt;br&gt;The&nbsp;mono&nbsp;vm&nbsp;compiled&nbsp;on&nbsp;freebsd&nbsp;had&nbsp;different&nbsp;alignment&nbsp;for&nbsp;bitfields&nbsp;than&nbsp;the&nbsp;compiler&nbsp;built&nbsp;with<br>
&nbsp;msvc.&lt;br&gt;&lt;br&gt;Gavin&lt;br&gt;&lt;div&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&nbsp;&nbsp;&lt;div&nbsp;style=&quot;font-family:&nbsp;lucida&nbsp;console,&nbsp;sans-serif;&nbsp;font-size:&nbsp;10pt;&quot;&gt;&nbsp;&lt;div&nbsp;style=&quot;font-family:&nbsp;times&nbsp;new&nbsp;roman,&nbsp;new&nbsp;york,&nbsp;times,&nbsp;serif;&nbsp;font-size:&nbsp;12pt;&quot;&gt;&nbsp;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&nbsp;&lt;hr&nbsp;size=&quot;1&quot;&gt;&nbsp;&nbsp;&lt;font&nbsp;face=&quot;Arial&quot;&nbsp;size=&quot;2&quot;&gt;&nbsp;&lt;b&gt;&lt;span&nbsp;style=&quot;font-weight:bold;&quot;&gt;From:&lt;/span&gt;&lt;/b&gt;&nbsp;voldemarz&nbsp;&lt;voldemarz@gmail.com&gt;&lt;br&gt;&nbsp;&lt;b&gt;&lt;span&nbsp;style=&quot;font-weight:&nbsp;bold;&quot;&gt;To:&lt;/span&gt;&lt;/b&gt;&nbsp;mono-devel-list@lists.ximian.com&nbsp;&lt;br&gt;&nbsp;&lt;b&gt;&lt;span&nbsp;style=&quot;font-weight:&nbsp;bold;&quot;&gt;Sent:&lt;/span&gt;&lt;/b&gt;&nbsp;Thursday,&nbsp;June&nbsp;27,&nbsp;2013&nbsp;9:52&nbsp;AM&lt;br&gt;&nbsp;&lt;b&gt;&lt;span&nbsp;style=&quot;font-weight:&nbsp;bold;&quot;&gt;Subject:&lt;/span&gt;&lt;/b&gt;&nbsp;Re:&nbsp;[Mono-dev]&nbsp;Mono&nbsp;AOT&nbsp;for&nbsp;64-bit&nbsp;Windows&lt;br&gt;&nbsp;&lt;/font&gt;&nbsp;&lt;/div&gt;&nbsp;&lt;div&nbsp;class=&quot;y_msg_container&quot;&gt;&lt;br&gt;<br>
Thanks&nbsp;for&nbsp;input.&nbsp;By&nbsp;seasoned&nbsp;you&nbsp;mean&nbsp;someone&nbsp;who&nbsp;has&nbsp;good&nbsp;knowledge&nbsp;of&nbsp;Mono&lt;br&gt;internals&nbsp;or&nbsp;generally&nbsp;a&nbsp;guy&nbsp;with&nbsp;low&nbsp;level&nbsp;experience&nbsp;on&nbsp;various&lt;br&gt;platforms/architectures?&lt;br&gt;&lt;br&gt;I&nbsp;slightly&nbsp;modified&nbsp;ASM&nbsp;generation&nbsp;&lt;br&gt;-&nbsp;wrapped&nbsp;.type&nbsp;and&nbsp;.size&nbsp;within&nbsp;.def/.endef&nbsp;directives&lt;br&gt;-&nbsp;removed&nbsp;local&nbsp;symbol&nbsp;emission&lt;br&gt;-&nbsp;removed&nbsp;underscore&nbsp;in&nbsp;front&nbsp;of&nbsp;global&nbsp;symbols&nbsp;&lt;br&gt;&lt;br&gt;Now&nbsp;I&nbsp;can&nbsp;generate&nbsp;AOT&nbsp;images&nbsp;and&nbsp;runtime&nbsp;seems&nbsp;to&nbsp;find&nbsp;all&nbsp;data&nbsp;structures&lt;br&gt;it&nbsp;needs.&nbsp;In&nbsp;few&nbsp;first&nbsp;runs&nbsp;surprisingly&nbsp;some&nbsp;simple&nbsp;tests&nbsp;worked&lt;br&gt;successfully&nbsp;in&nbsp;aot&nbsp;and&nbsp;full-aot&nbsp;mode&nbsp;-&nbsp;console&nbsp;output,&nbsp;simple&nbsp;calculations,&lt;br&gt;events,&nbsp;catching&nbsp;exceptions,&nbsp;allocating&nbsp;bunch&nbsp;of&nbsp;objects&nbsp;and&nbsp;invoking&lt;br&gt;garbage&nbsp;collection.&lt;br&gt;&lt;br&gt;Then&nbsp;I&nbsp;regenerated&nbsp;AOT&nbsp;image&nbsp;of&nbsp;mscorlib&nbsp;and&nbsp;it&nbsp;doesn't&nbsp;work&nbsp;any&nbsp;more.&lt;br&gt;Trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;issues&nbsp;now.&nbsp;In&nbsp;full-aot&nbsp;mode&nbsp;it&nbsp;crashes&nbsp;after&nbsp;a&nbsp;jump&nbsp;to&lt;br&gt;a&nbsp;non-executable&nbsp;memory&nbsp;region&nbsp;from<br>
&nbsp;function&lt;br&gt;wrapper_managed_to_native_object___icall_wrapper_mono_object_new_ptrfree_box_intptr&lt;br&gt;&lt;br&gt;The&nbsp;first&nbsp;few&nbsp;ops&nbsp;after&nbsp;the&nbsp;function&nbsp;prolog&nbsp;look&nbsp;like&nbsp;this&nbsp;(full&nbsp;function&lt;br&gt;asm&nbsp;&nbsp;here&nbsp;&lt;http://pastebin.com/GfTLeN1e&gt;&nbsp;&nbsp;):&lt;br&gt;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rax,7FACDFD19E0h&lt;br&gt;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,qword&nbsp;ptr&nbsp;[rbp-70h]&lt;br&gt;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsp,20h&lt;br&gt;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[rbp-38h],rsp&lt;br&gt;call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rax&lt;br&gt;&lt;br&gt;The&nbsp;address&nbsp;loaded&nbsp;into&nbsp;rax&nbsp;looks&nbsp;very&nbsp;suspicios.&nbsp;As&nbsp;far&nbsp;I&nbsp;can&nbsp;see&nbsp;that&lt;br&gt;function&nbsp;is&nbsp;compiled&nbsp;from&nbsp;IL.&nbsp;Haven't&nbsp;tracked&nbsp;down&nbsp;were&nbsp;is&nbsp;it&nbsp;coming&nbsp;from?&lt;br&gt;Could&nbsp;someone&nbsp;point&nbsp;me&nbsp;to&nbsp;it?&nbsp;What&nbsp;is&nbsp;it&nbsp;attempting&nbsp;call&nbsp;internally?&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;--&lt;br&gt;View&nbsp;this&nbsp;message&nbsp;in&nbsp;context:&nbsp;http://mono.1490590.n4.nabble.com/Mono-AOT-for-64-bit-Windows-tp4659926p4660049.html&lt;br&gt;Sent&nbsp;from&nbsp;the&nbsp;Mono&nbsp;-&nbsp;Dev&nbsp;mailing&nbsp;list&nbsp;archive&nbsp;at&nbsp;&lt;a&nbsp;target=&quot;_blank&quot;<br>
&nbsp;href=&quot;http://nabble.com/&quot;&gt;Nabble.com&lt;/a&gt;.&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;ymailto=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&nbsp;&lt;/div&gt;&nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
