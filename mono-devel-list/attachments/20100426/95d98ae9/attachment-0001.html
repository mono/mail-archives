<tt>
Hi&nbsp;folks,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;a&nbsp;summary&nbsp;of&nbsp;the&nbsp;initial&nbsp;design&nbsp;of&nbsp;Ephemeron&nbsp;support&nbsp;for&nbsp;sgen.&nbsp;The&nbsp;idea&nbsp;is&nbsp;to&nbsp;tailor&nbsp;it&nbsp;specially&nbsp;for&nbsp;ConditionalWeakTable&nbsp;since&lt;/div&gt;<br>
&lt;div&gt;it&amp;#39;s&nbsp;the&nbsp;only&nbsp;user&nbsp;for&nbsp;it&nbsp;on&nbsp;V4.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ConditionalWeakTable&nbsp;(CWT)&nbsp;will&nbsp;be&nbsp;implemented&nbsp;using&nbsp;open&nbsp;addressing&nbsp;instead&nbsp;of&nbsp;chaining&nbsp;since&nbsp;both&nbsp;key&nbsp;and&nbsp;value&nbsp;must&nbsp;be&nbsp;reference&nbsp;types&nbsp;and&lt;/div&gt;&lt;div&gt;scanning&nbsp;it&nbsp;is&nbsp;more&nbsp;cache&nbsp;friendly&nbsp;since&nbsp;the&nbsp;whole&nbsp;thing&nbsp;is&nbsp;just&nbsp;an&nbsp;array.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Since&nbsp;ephemerons&nbsp;must&nbsp;prevent&nbsp;both&nbsp;key&nbsp;and&nbsp;value&nbsp;to&nbsp;be&nbsp;marked&nbsp;during&nbsp;regular&nbsp;scan&nbsp;we&amp;#39;ll&nbsp;use&nbsp;a&nbsp;valuetype&nbsp;for&nbsp;it&nbsp;and&nbsp;special&nbsp;case&nbsp;it&amp;#39;s&nbsp;gc&nbsp;bitmap&nbsp;to&nbsp;be&lt;/div&gt;&lt;div&gt;empty.&nbsp;Something&nbsp;like&nbsp;&amp;quot;struct&nbsp;Ephemeron&nbsp;{&nbsp;object&nbsp;key,value;}&amp;quot;.&nbsp;I&amp;#39;m&nbsp;don&amp;#39;t&nbsp;know&nbsp;if&nbsp;it&amp;#39;s&nbsp;worth&nbsp;the&nbsp;trouble&nbsp;using&nbsp;a&nbsp;generics&nbsp;version&nbsp;of&nbsp;it&nbsp;since&nbsp;CWT&nbsp;is.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ephemerons&nbsp;are&nbsp;handled&nbsp;using&nbsp;the&nbsp;traditional&nbsp;3-phase&nbsp;GC,&nbsp;with&nbsp;the additional phase&nbsp;happening&nbsp;before&nbsp;weak&nbsp;references.&nbsp;CWT&nbsp;icalls&nbsp;the&nbsp;runtime&nbsp;to&nbsp;register&lt;/div&gt;&lt;div&gt;all&nbsp;relevant&nbsp;arrays,&nbsp;de-registering&nbsp;is&nbsp;done&nbsp;when&nbsp;they&nbsp;go&nbsp;unreachable.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;additional&nbsp;phase&nbsp;loops&nbsp;over&nbsp;all&nbsp;registered&nbsp;arrays&nbsp;looking&nbsp;for&nbsp;marked&nbsp;keys&nbsp;without&nbsp;marked&nbsp;values&nbsp;and&nbsp;pushing those&nbsp;to&nbsp;the&nbsp;grey&nbsp;stack.&nbsp;Termination&nbsp;happens when&nbsp;no&nbsp;new&nbsp;marked&nbsp;key/unmaked&nbsp;value&nbsp;pair&nbsp;is&nbsp;found.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Once&nbsp;this&nbsp;is&nbsp;properly&nbsp;working,&nbsp;two&nbsp;additional&nbsp;improvements&nbsp;should&nbsp;be&nbsp;done.&nbsp;Split&nbsp;the&nbsp;registered&nbsp;arrays&nbsp;in&nbsp;two,&nbsp;for nursery and&nbsp;oldgen&nbsp;and&nbsp;use&nbsp;remset&nbsp;information&nbsp;to know&nbsp;which&nbsp;old&nbsp;gen&nbsp;arrays&nbsp;needs&nbsp;to&nbsp;be&nbsp;scanned.&nbsp;The&nbsp;other&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;bitmap&nbsp;to&nbsp;encode&nbsp;which&nbsp;array&nbsp;slots&nbsp;must&nbsp;be&nbsp;scanned.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Using&nbsp;an&nbsp;array&nbsp;with&nbsp;references&nbsp;that&nbsp;are&nbsp;not&nbsp;scanned&nbsp;what&nbsp;chosen&nbsp;since&nbsp;the&nbsp;alternative&nbsp;would&nbsp;be&nbsp;to&nbsp;use&nbsp;an&nbsp;array&nbsp;of&nbsp;IntPtr&nbsp;and&nbsp;lose&nbsp;support&nbsp;for&nbsp;write&nbsp;barriers. It&nbsp;would&nbsp;have&nbsp;to&nbsp;be&nbsp;IntPtr&nbsp;otherwise&nbsp;since&nbsp;the&nbsp;GC&nbsp;must&nbsp;not&nbsp;scan&nbsp;them.&nbsp;Moving&nbsp;both&nbsp;values&nbsp;to&nbsp;the&nbsp;runtime&nbsp;would&nbsp;make&nbsp;manipulating&nbsp;the&nbsp;array&nbsp;much&nbsp;harder&nbsp;and&nbsp;possibly&nbsp;slower.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;CWT&nbsp;won&amp;#39;t&nbsp;be&nbsp;a&nbsp;nice,&nbsp;fast&nbsp;hashtable&nbsp;while&nbsp;I&nbsp;sort&nbsp;out&nbsp;all&nbsp;gc&nbsp;details,&nbsp;it&nbsp;will&nbsp;do&nbsp;linear&nbsp;search&nbsp;and&nbsp;only&nbsp;then&nbsp;I&amp;#39;ll&nbsp;look&nbsp;into&nbsp;using&nbsp;proper&nbsp;hashing&nbsp;with&nbsp;linear/quadratic&nbsp;probing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;Finally,&nbsp;a&nbsp;note&nbsp;on&nbsp;boehm.&nbsp;Since&nbsp;it&nbsp;will&nbsp;be&nbsp;phased&nbsp;out&nbsp;after&nbsp;2.8&nbsp;the&nbsp;idea&nbsp;is&nbsp;to&nbsp;implement&nbsp;it&nbsp;using&nbsp;a&nbsp;WeakReference&nbsp;for&nbsp;the&nbsp;key&nbsp;and&nbsp;live&nbsp;with&nbsp;leaks&nbsp;in&nbsp;case&nbsp;the&nbsp;value&nbsp;references&nbsp;it.&nbsp;It&nbsp;sucks,&nbsp;but&nbsp;requires&nbsp;little&nbsp;effort&nbsp;and&nbsp;should&nbsp;perform&nbsp;reasonably&nbsp;well.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
