<tt>
&amp;lt;snip&amp;gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;br&gt;<br>
It&nbsp;seems&nbsp;that&nbsp;only&nbsp;a&nbsp;small&nbsp;number&nbsp;of&nbsp;RGCTXs&nbsp;is&nbsp;ever&nbsp;used,&nbsp;and&nbsp;the&nbsp;ones&lt;br&gt;<br>
that&nbsp;are&nbsp;used&nbsp;could&nbsp;make&nbsp;do&nbsp;with&nbsp;2&nbsp;to&nbsp;5&nbsp;slots&nbsp;on&nbsp;average.&nbsp;&amp;nbsp;For&nbsp;FSharp,&lt;br&gt;<br>
for&nbsp;instance,&nbsp;if&nbsp;we&nbsp;used&nbsp;an&nbsp;optimal&nbsp;allocation&nbsp;strategy&nbsp;(i.e.&nbsp;only&lt;br&gt;<br>
allocate&nbsp;RGCTXs&nbsp;if&nbsp;needed,&nbsp;only&nbsp;allocate&nbsp;as&nbsp;many&nbsp;slots&nbsp;as&nbsp;needed&nbsp;and&lt;br&gt;<br>
don&amp;#39;t&nbsp;use&nbsp;any&nbsp;meta-data)&nbsp;we&nbsp;could&nbsp;get&nbsp;the&nbsp;600k&nbsp;down&nbsp;to&nbsp;about&nbsp;6k,&nbsp;which&lt;br&gt;<br>
would&nbsp;be&nbsp;more&nbsp;than&nbsp;acceptable.&lt;br&gt;<br>
&lt;br&gt;<br>
There&nbsp;is&nbsp;a&nbsp;problem&nbsp;with&nbsp;allocating&nbsp;a&nbsp;RGCTX&nbsp;lazily,&nbsp;though.&nbsp;&amp;nbsp;Allocating&lt;br&gt;<br>
a&nbsp;RGCTX&nbsp;requires&nbsp;some&nbsp;information.&nbsp;&amp;nbsp;Specifically,&nbsp;it&nbsp;requires&nbsp;the&lt;br&gt;<br>
MonoVTable*&nbsp;for&nbsp;the&nbsp;class&nbsp;for&nbsp;which&nbsp;to&nbsp;allocate&nbsp;the&nbsp;RGCTX.&nbsp;&amp;nbsp;This&nbsp;is&lt;br&gt;<br>
not&nbsp;an&nbsp;issue&nbsp;for&nbsp;non-static&nbsp;methods&nbsp;because&nbsp;the&nbsp;vtable&nbsp;is&nbsp;accessible&lt;br&gt;<br>
through&nbsp;the&nbsp;&amp;quot;this&amp;quot;&nbsp;argument.&nbsp;&amp;nbsp;Static&nbsp;methods&nbsp;don&amp;#39;t&nbsp;have&nbsp;that&nbsp;argument,&lt;br&gt;<br>
though.&nbsp;&amp;nbsp;In&nbsp;fact,&nbsp;the&nbsp;RGCTX&nbsp;must&nbsp;contain&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;vtable&lt;br&gt;<br>
because&nbsp;we&nbsp;need&nbsp;it&nbsp;in&nbsp;static&nbsp;methods&nbsp;for&nbsp;some&nbsp;purposes,&nbsp;like&nbsp;exception&lt;br&gt;<br>
handling.&nbsp;&amp;nbsp;So&nbsp;I&nbsp;think&nbsp;we&amp;#39;ll&nbsp;need&nbsp;to&nbsp;switch&nbsp;to&nbsp;passing&nbsp;not&nbsp;the&nbsp;RGCTX,&lt;br&gt;<br>
but&nbsp;the&nbsp;vtable&nbsp;to&nbsp;static&nbsp;methods,&nbsp;since&nbsp;the&nbsp;latter&nbsp;contains&nbsp;a&nbsp;pointer&lt;br&gt;<br>
to&nbsp;the&nbsp;RGCTX&nbsp;anyway,&nbsp;which,&nbsp;for&nbsp;lazy&nbsp;allocation,&nbsp;could&nbsp;be&nbsp;NULL.&nbsp;&amp;nbsp;This&lt;br&gt;<br>
would&nbsp;give&nbsp;us&nbsp;the&nbsp;additional&nbsp;advantage&nbsp;of&nbsp;not&nbsp;having&nbsp;to&nbsp;store&nbsp;the&lt;br&gt;<br>
vtable&nbsp;in&nbsp;the&nbsp;RGCTX,&nbsp;saving&nbsp;us&nbsp;4/8&nbsp;bytes&nbsp;per&nbsp;RGCTX.&lt;br&gt;<br>
&lt;br&gt;<br>
As&nbsp;for&nbsp;how&nbsp;to&nbsp;arrange&nbsp;the&nbsp;RGCTX&nbsp;itself&nbsp;I&nbsp;have&nbsp;the&nbsp;following&nbsp;proposal:&lt;br&gt;<br>
Let&amp;#39;s&nbsp;get&nbsp;rid&nbsp;of&nbsp;all&nbsp;the&nbsp;superclass&nbsp;and&nbsp;type&nbsp;argument&nbsp;type&nbsp;information&lt;br&gt;<br>
and&nbsp;just&nbsp;concentrate&nbsp;on&nbsp;the&nbsp;extensible&nbsp;part.&nbsp;&amp;nbsp;I&amp;#39;d&nbsp;like&nbsp;to&nbsp;implement&lt;br&gt;<br>
two&nbsp;different&nbsp;kinds&nbsp;of&nbsp;RGCTX&nbsp;-&nbsp;small&nbsp;ones&nbsp;and&nbsp;large&nbsp;ones.&nbsp;&amp;nbsp;Small&lt;br&gt;<br>
RGCTXs&nbsp;would&nbsp;have&nbsp;space&nbsp;for&nbsp;up&nbsp;to&nbsp;some&nbsp;constant&nbsp;number&nbsp;of&nbsp;slots,&lt;br&gt;<br>
preferably&nbsp;3&nbsp;or&nbsp;7.&nbsp;&amp;nbsp;The&nbsp;layout&nbsp;would&nbsp;look&nbsp;like&nbsp;this&nbsp;on&nbsp;a&nbsp;32-bit&lt;br&gt;<br>
system:&lt;br&gt;<br>
&lt;br&gt;<br>
struct&nbsp;small_rgctx&nbsp;{&lt;br&gt;<br>
&nbsp;&amp;nbsp;guint8&nbsp;size;&lt;br&gt;<br>
&nbsp;&amp;nbsp;guint8&nbsp;slot_numbers[3];&lt;br&gt;<br>
&nbsp;&amp;nbsp;gpointer&nbsp;slots[0];&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
size&nbsp;would&nbsp;be&nbsp;the&nbsp;number&nbsp;of&nbsp;slots&nbsp;in&nbsp;the&nbsp;RGCTX.&nbsp;&amp;nbsp;slot_numbers&nbsp;would&lt;br&gt;<br>
identify&nbsp;the&nbsp;type&nbsp;information&nbsp;stored&nbsp;in&nbsp;the&nbsp;slots&nbsp;array.&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;fetch&nbsp;an&nbsp;item&nbsp;out&nbsp;of&nbsp;the&nbsp;RGCTX&nbsp;we&amp;#39;d&nbsp;have&nbsp;to&nbsp;search&nbsp;through&nbsp;the&lt;br&gt;<br>
slot_numbers&nbsp;array&nbsp;to&nbsp;find&nbsp;the&nbsp;required&nbsp;type&nbsp;information&nbsp;and&nbsp;then&lt;br&gt;<br>
fetch&nbsp;the&nbsp;corresponding&nbsp;pointer&nbsp;from&nbsp;the&nbsp;slots&nbsp;array.&nbsp;&amp;nbsp;If&nbsp;the&nbsp;type&lt;br&gt;<br>
information&nbsp;is&nbsp;not&nbsp;found&nbsp;we&amp;#39;d&nbsp;jump&nbsp;into&nbsp;unmanaged&nbsp;code&nbsp;and&nbsp;extend&nbsp;the&lt;br&gt;<br>
RGCTX&nbsp;by&nbsp;allocating&nbsp;a&nbsp;new&nbsp;one&nbsp;with&nbsp;space&nbsp;for&nbsp;one&nbsp;more&nbsp;slot&nbsp;or,&nbsp;if&nbsp;the&lt;br&gt;<br>
maximum&nbsp;number&nbsp;of&nbsp;slots&nbsp;is&nbsp;reached,&nbsp;upgrading&nbsp;to&nbsp;a&nbsp;large&nbsp;RGCTX.&lt;br&gt;<br>
Another&nbsp;reason&nbsp;for&nbsp;using&nbsp;a&nbsp;large&nbsp;RGCTX&nbsp;would&nbsp;be&nbsp;if&nbsp;the&nbsp;values&nbsp;of&nbsp;the&lt;br&gt;<br>
slot&nbsp;numbers&nbsp;exceeded&nbsp;255,&nbsp;which&nbsp;should&nbsp;be&nbsp;very&nbsp;unlikely,&nbsp;though.&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;could&nbsp;keep&nbsp;free&nbsp;lists&nbsp;per&nbsp;domain&nbsp;of&nbsp;the&nbsp;RGCTXs&nbsp;we&amp;#39;ve&nbsp;thrown&nbsp;away.&lt;br&gt;<br>
It&nbsp;might&nbsp;be&nbsp;necessary&nbsp;to&nbsp;use&nbsp;hazard&nbsp;pointers&nbsp;for&nbsp;access&nbsp;to&nbsp;the&nbsp;RGCTX&lt;br&gt;<br>
so&nbsp;as&nbsp;to&nbsp;avoid&nbsp;reusing&nbsp;memory&nbsp;of&nbsp;a&nbsp;thrown-away&nbsp;RGCTX&nbsp;if&nbsp;another&nbsp;thread&lt;br&gt;<br>
is&nbsp;still&nbsp;accessing&nbsp;it.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;Isn&amp;#39;t&nbsp;possible&nbsp;or&nbsp;better&nbsp;to&nbsp;do&nbsp;RGCTX&nbsp;free&amp;#39;ing&nbsp;at&nbsp;GC&nbsp;time?&nbsp;It&nbsp;would&nbsp;be&nbsp;simpler,&nbsp;the&nbsp;hardest&lt;br&gt;part&nbsp;would&nbsp;be&nbsp;guarding&nbsp;against&nbsp;parking&nbsp;threads&nbsp;inside&nbsp;RGCTX&nbsp;related&nbsp;code,&nbsp;which&nbsp;can&nbsp;be&nbsp;done&nbsp;with&lt;br&gt;<br>
some&nbsp;link&nbsp;time&nbsp;trickery&nbsp;and&nbsp;a&nbsp;lit&nbsp;of&nbsp;changes&nbsp;on&nbsp;stack&nbsp;scanning&nbsp;code.&lt;br&gt;&lt;br&gt;&amp;nbsp;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;br&gt;<br>
A&nbsp;large&nbsp;RGCTX&nbsp;could&nbsp;be&nbsp;some&nbsp;kind&nbsp;of&nbsp;small&nbsp;hash&nbsp;table.&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;such&nbsp;data&nbsp;structures&nbsp;we&nbsp;could&nbsp;also&nbsp;do&nbsp;another&nbsp;optimization.&lt;br&gt;<br>
Right&nbsp;now&nbsp;every&nbsp;class&nbsp;that&nbsp;is&nbsp;either&nbsp;a&nbsp;generic&nbsp;class&nbsp;or&nbsp;is&nbsp;a&nbsp;direct&nbsp;or&lt;br&gt;<br>
indirect&nbsp;subclass&nbsp;of&nbsp;a&nbsp;generic&nbsp;class&nbsp;has&nbsp;its&nbsp;own&nbsp;RGCTX.&nbsp;&amp;nbsp;Non-generic&lt;br&gt;<br>
classes&nbsp;can&nbsp;never&nbsp;give&nbsp;rise&nbsp;to&nbsp;the&nbsp;need&nbsp;for&nbsp;another&nbsp;piece&nbsp;of&nbsp;type&lt;br&gt;<br>
information&nbsp;in&nbsp;a&nbsp;RGCTX,&nbsp;so&nbsp;they&nbsp;could&nbsp;share&nbsp;the&nbsp;RGCTXs&nbsp;of&nbsp;their&lt;br&gt;<br>
generic&nbsp;superclasses.&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;this&nbsp;sound&nbsp;like&nbsp;a&nbsp;sensible&nbsp;plan?&nbsp;&amp;nbsp;Am&nbsp;I&nbsp;missing&nbsp;something&nbsp;crucial?&lt;br&gt;<br>
&amp;nbsp;Does&nbsp;anybody&nbsp;have&nbsp;any&nbsp;suggestions&nbsp;or&nbsp;better&nbsp;ideas?&lt;br&gt;<br>
&lt;br&gt;<br>
Mark&lt;/blockquote&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;These&nbsp;are&nbsp;great&nbsp;news&nbsp;Mark.&lt;br&gt;&lt;br&gt;In&nbsp;Madrid&nbsp;we&nbsp;discussed&nbsp;about&nbsp;using&nbsp;segfaults&nbsp;to&nbsp;trigger&nbsp;lazy&nbsp;filling&nbsp;of&nbsp;rgctx,&nbsp;have&nbsp;you&nbsp;thought&nbsp;about&nbsp;using&nbsp;that?&lt;br&gt;&lt;br&gt;I&nbsp;remember&nbsp;that&nbsp;a&nbsp;major&nbsp;issue&nbsp;with&nbsp;the&nbsp;rgctx&nbsp;layout&nbsp;was&nbsp;that&nbsp;you&nbsp;need&nbsp;to&nbsp;coordinate&nbsp;slot&nbsp;filling&nbsp;between&nbsp;a&nbsp;type&nbsp;and&nbsp;all&nbsp;it&amp;#39;s&nbsp;parents&nbsp;to&nbsp;avoid&nbsp;collisions.&nbsp;How&nbsp;would&nbsp;that&nbsp;work&nbsp;on&nbsp;your&nbsp;proposed&nbsp;schema?&nbsp;How&nbsp;about&nbsp;using&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;parent&nbsp;context?&nbsp;This&nbsp;would&nbsp;eliminate&nbsp;the&nbsp;whole&nbsp;issue,&nbsp;could&nbsp;save&nbsp;some&nbsp;bytes&nbsp;for&nbsp;parents&nbsp;with&nbsp;fat&nbsp;rgctx&nbsp;and&nbsp;make&nbsp;even&nbsp;less&nbsp;likely&nbsp;to&nbsp;have&nbsp;a&nbsp;large&nbsp;rgctx.&lt;br&gt;<br>
&lt;br&gt;One&nbsp;more&nbsp;thing,&nbsp;your&nbsp;stats&nbsp;miss&nbsp;something&nbsp;I&nbsp;guess&nbsp;it&amp;#39;s&nbsp;important,&nbsp;how&nbsp;many&nbsp;generic&nbsp;sharing&nbsp;failures&nbsp;each&nbsp;test&nbsp;suite&nbsp;has?&nbsp;This&nbsp;is&nbsp;important&nbsp;to&nbsp;see&nbsp;how&nbsp;much&nbsp;further&nbsp;this&nbsp;could&nbsp;be&nbsp;improved&nbsp;if&nbsp;constrained&nbsp;and&nbsp;mixed&nbsp;reference/valuetype&nbsp;sharing&nbsp;gets&nbsp;done.&nbsp;&lt;br&gt;<br>
&lt;br&gt;It&nbsp;might&nbsp;too&nbsp;early&nbsp;to&nbsp;think&nbsp;about&nbsp;this,&nbsp;but&nbsp;do&nbsp;you&nbsp;have&nbsp;some&nbsp;speed&nbsp;results&nbsp;for&nbsp;these&nbsp;tests?&nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;Cheers,&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;&lt;br&gt;<br>

</tt>
