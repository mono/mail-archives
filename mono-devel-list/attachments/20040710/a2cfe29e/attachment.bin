using System;
using System.IO;
using System.Collections;
using System.Xml.Serialization;

namespace SerializationTest
{
	[Serializable]
	public class MyList : ArrayList
	{
		Container container;	// in real implementation i need to know "my container"

		// NOTE: MyList has no public constructor
		public MyList(Container container) : base() {
			this.container = container;
		}
	}

	[Serializable]
	public class Container
	{
		public MyList Items;

		public Container() {
			Items = new MyList(this);
		}

		public void Save(Stream s) {
			XmlSerializer serializer = new XmlSerializer(this.GetType());
			serializer.Serialize(s, this);
		}

		public static Container FromStream(Stream s) {
			XmlSerializer serializer = new XmlSerializer(typeof(Container));
			Container c = (Container) serializer.Deserialize(s);
			return c;
		}

		public static void Main()
		{
			Container c = new Container();
			c.Items.Add(1);
			using(FileStream fs = new FileStream("container.xml", FileMode.Create)) {
				c.Save(fs);
			}

			Container fromFile = Container.FromStream(File.OpenRead("container.xml"));
			Console.WriteLine("It works, first item is " + fromFile.Items[0]);
			Console.ReadLine();
		}
	}
}