using System;
using System.IO.Ports;

public class SerialPortTest
{
	public static void Main(string[] args)
	{
		SerialPortTest myTest = new SerialPortTest();
		myTest.Test();
	}

	private SerialPort myserial;


	public SerialPortTest()
	{
	}

	public void Test()
	{
		byte[]code=new byte[1];
		int counter=0;
		if (myserial != null)
			if (myserial.IsOpen)

				myserial.Close();

		myserial = new SerialPort("/dev/ttyUSB0",115200);
		myserial.Open();
		myserial.DiscardInBuffer();
		myserial.DiscardOutBuffer();


		myserial.ReadTimeout = 2000;
		//Send Status Request
		byte[] req =new byte[]{0xFA};
		Console.WriteLine("****Send status request****");
		myserial.Write(req,0,req.Length);

		while(true)
		{
			myserial.Read(code,0,1);
			Console.WriteLine("****Received code(hex): {0}",Convert.ToString(code[0],16));
			if(code[0]==0xFE)
			{
				counter++;
				Console.WriteLine("----------Vector nr:{0}----------",counter);
				readvector();
			}
			if(code[0]==0xFD)
			{
				Console.WriteLine("out of vectors");
				break;
			}
			if(code[0]==0xFC)
			{
				Console.WriteLine("max errors");
				break;
			}
			if(code[0]==0xFB)
			{
				Console.WriteLine("End of test");
				break;
			}
		} 
	}

	public void readvector()
	{
		byte[]tmp=new byte[16];
		string rxstring = "";
		string tmpstring = "";
		
			
		myserial.Read(tmp,0,16);
		for(int i=0; i<tmp.Length;i++)
		{
			tmpstring=Convert.ToString(tmp[i],2);
			tmpstring=tmpstring.PadLeft(8,'0'); //add zeros at the beginning 11 -> 00000011
			rxstring += tmpstring;
		}
		Console.WriteLine("vector: {0}",rxstring);
		rxstring = "";
		tmpstring = "";	
		
		
	
	}

	
}
