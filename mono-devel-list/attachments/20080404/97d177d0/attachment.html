<tt>
&lt;br&gt;Hi&nbsp;all,&lt;br&gt;&lt;br&gt;Possible&nbsp;mono&nbsp;bug&nbsp;--&nbsp;soliciting&nbsp;feedback&nbsp;before&nbsp;I&nbsp;actually&nbsp;file&nbsp;a&nbsp;bug&nbsp;report.&lt;br&gt;&lt;br&gt;I&amp;#39;m&nbsp;having&nbsp;difficulty&nbsp;making&nbsp;calls&nbsp;from&nbsp;C#&nbsp;to&nbsp;functions&nbsp;in&nbsp;native&nbsp;libraries&nbsp;that&nbsp;take&nbsp;pointers&nbsp;to&nbsp;structs&nbsp;as&nbsp;arguments.&nbsp;I&amp;#39;ve&nbsp;been&nbsp;able&nbsp;to&nbsp;work&nbsp;around&nbsp;the&nbsp;issue&nbsp;by&nbsp;using&nbsp;void*&nbsp;pointers&nbsp;in&nbsp;C#&nbsp;instead&nbsp;of&nbsp;pointers&nbsp;to&nbsp;a&nbsp;structure&nbsp;I&nbsp;define&nbsp;in&nbsp;C#.&nbsp;Nevertheless,&nbsp;based&nbsp;on&nbsp;my&nbsp;(limited)&nbsp;understanding&nbsp;of&nbsp;the&nbsp;way&nbsp;marshaling&nbsp;is&nbsp;supposed&nbsp;to&nbsp;work,&nbsp;this&nbsp;looks&nbsp;like&nbsp;it&nbsp;may&nbsp;be&nbsp;a&nbsp;mono&nbsp;bug.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;Here&amp;#39;s&nbsp;the&nbsp;error&nbsp;I&nbsp;see&nbsp;at&nbsp;runtime:&lt;br&gt;&lt;br&gt;Unhandled&nbsp;Exception:&nbsp;System.Runtime.InteropServices.MarshalDirectiveException:&nbsp;Can&nbsp;not&nbsp;marshal&nbsp;&amp;#39;parameter&nbsp;#1&amp;#39;:&nbsp;Pointers&nbsp;can&nbsp;not&nbsp;reference&nbsp;marshaled&nbsp;structures.&nbsp;Use&nbsp;byref&nbsp;instead.&lt;br&gt;<br>
&amp;nbsp;&nbsp;at&nbsp;(wrapper&nbsp;managed-to-native)&nbsp;Isc.StarP.UnmanagedCode.testlibrary:functionThatTakesPtr&nbsp;(Isc.StarP.UnmanagedCode.testlibrary/structy*)&lt;br&gt;&amp;nbsp;&nbsp;at&nbsp;Isc.StarP.UnmanagedCode.testlibrary.functionThatTakesPtr_W&nbsp;(.structy*&nbsp;mystruct)&nbsp;[0x00000]&nbsp;&lt;br&gt;<br>
&amp;nbsp;&nbsp;at&nbsp;libwrapper_test.Main&nbsp;()&nbsp;[0x00000]&nbsp;&lt;br&gt;&lt;br&gt;&lt;br&gt;Below&nbsp;is&nbsp;an&nbsp;isolated&nbsp;example&nbsp;of&nbsp;code&nbsp;that&nbsp;demonstrates&nbsp;the&nbsp;problem.&lt;br&gt;To&nbsp;reproduce&nbsp;it,&nbsp;run&nbsp;the&nbsp;following&nbsp;4&nbsp;commands&nbsp;(assuming&nbsp;linux&nbsp;+&nbsp;gcc):&lt;br&gt;gcc&nbsp;-o&nbsp;testlibrary.o&nbsp;-fPIC&nbsp;-c&nbsp;library.c&nbsp;-I.&lt;br&gt;<br>
gcc&nbsp;-shared&nbsp;-Wl,-soname,libtestlibrary.so&nbsp;-o&nbsp;libtestlibrary.so&nbsp;testlibrary.o&lt;br&gt;gmcs&nbsp;-unsafe&nbsp;-out:libwrapper_test.exe&amp;nbsp;&nbsp;testlibrary_W.cs&nbsp;libwrapper_test.cs&lt;br&gt;mono&nbsp;libwrapper_test.exe&lt;br&gt;&lt;br&gt;The&nbsp;4&nbsp;relevant&nbsp;source&nbsp;files&nbsp;are&nbsp;as&nbsp;follows:&lt;br&gt;<br>
&lt;br&gt;/************************************&lt;br&gt;<br>
<br>
&amp;nbsp;*&nbsp;library.h&lt;br&gt;<br>
<br>
&amp;nbsp;***********************************&nbsp;&lt;br&gt;<br>
<br>
*/&lt;br&gt;<br>
<br>
&lt;br&gt;#include&nbsp;&amp;lt;stdlib.h&amp;gt;&lt;br&gt;#include&nbsp;&amp;lt;stdio.h&amp;gt;&lt;br&gt;typedef&nbsp;struct&nbsp;structy&nbsp;{&lt;br&gt;&amp;nbsp;&nbsp;int&amp;nbsp;&amp;nbsp;&nbsp;blah;&nbsp;&lt;br&gt;}&nbsp;structy;&lt;br&gt;void&nbsp;functionThatTakesPtr(structy*&nbsp;mystruct);&lt;br&gt;&lt;br&gt;&lt;br&gt;/************************************&lt;br&gt;<br>
<br>
&amp;nbsp;*&nbsp;library.c&lt;br&gt;<br>
<br>
&amp;nbsp;***********************************&nbsp;&lt;br&gt;<br>
<br>
*/&lt;br&gt;<br>
<br>
&lt;br&gt;#include&nbsp;&amp;quot;library.h&amp;quot;&lt;br&gt;void&nbsp;functionThatTakesPtr(structy*&nbsp;mystruct)&nbsp;{&lt;br&gt;&amp;nbsp;&nbsp;printf&nbsp;(&amp;quot;I&nbsp;found&nbsp;an&nbsp;entry&nbsp;in&nbsp;the&nbsp;structy-struct&nbsp;with&nbsp;value&nbsp;%d\n&amp;quot;,&nbsp;mystruct-&amp;gt;blah);&lt;br&gt;}&lt;br&gt;structy*&nbsp;functionThatCreatesStruct()&nbsp;{&lt;br&gt;<br>
&amp;nbsp;&nbsp;structy*&nbsp;mystruct&nbsp;=&nbsp;(structy*)malloc(sizeof(structy));&lt;br&gt;&amp;nbsp;&nbsp;mystruct-&amp;gt;blah&nbsp;=&nbsp;42;&lt;br&gt;&amp;nbsp;&nbsp;return&nbsp;mystruct;&lt;br&gt;}&lt;br&gt;int&nbsp;main()&nbsp;{&lt;br&gt;&amp;nbsp;&nbsp;structy*&nbsp;mystruct&nbsp;=&nbsp;functionThatCreatesStruct();&lt;br&gt;&amp;nbsp;&nbsp;functionThatTakesPtr(mystruct);&lt;br&gt;<br>
}&lt;br&gt;&lt;br&gt;&lt;br&gt;/************************************&lt;br&gt;<br>
&amp;nbsp;*&nbsp;testlibrary_W.cs&lt;br&gt;<br>
&amp;nbsp;***********************************&nbsp;&lt;br&gt;<br>
*/&lt;br&gt;<br>
&lt;br&gt;using&nbsp;System;&lt;br&gt;using&nbsp;System.Runtime.InteropServices;&lt;br&gt;using&nbsp;System.Security;&lt;br&gt;using&nbsp;MyChar&nbsp;=&nbsp;System.Void;&lt;br&gt;&lt;br&gt;namespace&nbsp;Isc.StarP.UnmanagedCode&nbsp;{&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;public&nbsp;class&nbsp;testlibrary&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;private&nbsp;const&nbsp;string&nbsp;dllName&nbsp;=&nbsp;&amp;quot;libtestlibrary&amp;quot;;&lt;br&gt;<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;public&nbsp;struct&nbsp;structy&nbsp;{int&nbsp;blah;}&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;[DllImport(dllName,&nbsp;ExactSpelling=true,&nbsp;SetLastError=false,&nbsp;CallingConvention=CallingConvention.Cdecl,&nbsp;EntryPoint=&amp;quot;functionThatTakesPtr&amp;quot;)]&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//&nbsp;WORK&nbsp;AROUND&nbsp;(part&nbsp;1&nbsp;of&nbsp;2):&nbsp;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//&nbsp;Change&nbsp;the&nbsp;following&nbsp;to&nbsp;take&nbsp;a&nbsp;void*&nbsp;instead&nbsp;of&nbsp;structy*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;static&nbsp;extern&nbsp;void&nbsp;functionThatTakesPtr([In,Out]&nbsp;structy*&nbsp;mystruct);&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;[DllImport(dllName,&nbsp;ExactSpelling=true,&nbsp;SetLastError=false,&nbsp;CallingConvention=CallingConvention.Cdecl,&nbsp;EntryPoint=&amp;quot;functionThatCreatesStruct&amp;quot;)]&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;static&nbsp;extern&nbsp;structy*&nbsp;functionThatCreatesStruct();&lt;br&gt;&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//&nbsp;WORK&nbsp;AROUND&nbsp;(part&nbsp;2&nbsp;of&nbsp;2):&lt;br&gt;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;//&nbsp;Change&nbsp;the&nbsp;following&nbsp;to&nbsp;take&nbsp;a&nbsp;void*&nbsp;instead&nbsp;of&nbsp;structy*&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;public&nbsp;static&nbsp;void&nbsp;functionThatTakesPtr_W(structy*&nbsp;mystruct)&nbsp;{&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;functionThatTakesPtr(mystruct);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;public&nbsp;static&nbsp;structy&nbsp;*&nbsp;functionThatCreatesStruct_W()&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;(structy*)functionThatCreatesStruct();&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&amp;nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;/************************************&lt;br&gt;<br>
&amp;nbsp;*&nbsp;libwrapper_test.cs&lt;br&gt;&amp;nbsp;***********************************&nbsp;&lt;br&gt;*/&lt;br&gt;&lt;br&gt;using&nbsp;System;&lt;br&gt;using&nbsp;SizeType&nbsp;=&nbsp;System.UInt64;&lt;br&gt;using&nbsp;SignedSizeType=System.Int64;&lt;br&gt;&lt;br&gt;using&nbsp;Isc.StarP.UnmanagedCode;&lt;br&gt;&lt;br&gt;public&nbsp;class&nbsp;libwrapper_test&lt;br&gt;<br>
{&lt;br&gt;&amp;nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;Main()&lt;br&gt;&amp;nbsp;&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;unsafe&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;testlibrary.structy*&nbsp;mystruct&nbsp;=&nbsp;testlibrary.functionThatCreatesStruct_W();&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;testlibrary.functionThatTakesPtr_W(mystruct);&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;&amp;nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;br&gt;Thanks!&lt;br&gt;--&lt;br&gt;Steve&nbsp;Leibman&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:sleibman@interactivesupercomputing.com&quot;&gt;sleibman@interactivesupercomputing.com&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;<br>

</tt>
