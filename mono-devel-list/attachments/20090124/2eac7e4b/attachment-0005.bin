Index: mono/mini/mini-ppc.c
===================================================================
--- mono.orig/mini/mini-ppc.c	2009-01-24 17:06:32.000000000 +0100
+++ mono/mini/mini-ppc.c	2009-01-24 17:12:48.000000000 +0100
@@ -894,21 +894,36 @@
 		isync
 	}
 #else
-	if (1) {
-		for (p = start; p < endp; p += cachelineinc) {
-			asm ("dcbf 0,%0;" : : "r"(p) : "memory");
+	/* For POWER5/6 with ICACHE_SNOOP the dcbst/icbi is not required.  */
+	if (!HAS_ICACHE_SNOOP) {
+#ifdef __linux__
+		if (linux_ppc_SMP) {
+			for (p = start; p < endp; p += cachelineinc) {
+				asm ("dcbf 0,%0;" : : "r"(p) : "memory");
+			}
+		} else
+#endif
+		{
+			for (p = start; p < endp; p += cachelineinc) {
+				asm ("dcbst 0,%0;" : : "r"(p) : "memory");
+			}
 		}
-	} else {
+		asm ("sync");
+		p = code;
+	/* for ISA2.0+ implementations we should not need any extra sync instructions. */
 		for (p = start; p < endp; p += cachelineinc) {
-			asm ("dcbst 0,%0;" : : "r"(p) : "memory");
+#ifdef __linux__
+			if (linux_ppc_ISA2x)
+				asm ("icbi 0,%0;" : : "r"(p) : "memory");
+			else
+#endif
+				asm ("icbi 0,%0; sync;" : : "r"(p) : "memory");
 		}
 	}
-	asm ("sync");
-	p = code;
-	for (p = start; p < endp; p += cachelineinc) {
-		asm ("icbi 0,%0; sync;" : : "r"(p) : "memory");
-	}
-	asm ("sync");
+#ifdef __linux__
+	if (!linux_ppc_ISA2x)
+#endif
+		asm ("sync");
 	asm ("isync");
 #endif
 }
