<tt>
&lt;div&gt;I&nbsp;think&nbsp;we&nbsp;can&nbsp;simplify&nbsp;your&nbsp;approach&nbsp;to&nbsp;a&nbsp;much&nbsp;more&nbsp;localized&nbsp;change:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#ifdef MONO_ARCH_SOFT_FLOAT&lt;/div&gt;&lt;div&gt;#define&nbsp;COMPILE_SOFT_FLOAT(cfg)&nbsp;((cfg)-&amp;gt;use_soft_float)&lt;/div&gt;&lt;div&gt;<br>
#else&lt;/div&gt;&lt;div&gt;#define&nbsp;COMPILE_SOFT_FLOAT(cfg)&nbsp;0&lt;/div&gt;&lt;div&gt;#endif&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;then&nbsp;on mini_method_compile:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#ifdef MONO_ARCH_SOFT_FLOAT&lt;/div&gt;&lt;div&gt;cfg-&amp;gt;use_soft_float&nbsp;= mono_arch_is_soft_float&nbsp;()&nbsp;&amp;amp;&amp;amp; !COMPILE_LLVM (cfg);&lt;/div&gt;<br>
&lt;div&gt;#endif&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Then&nbsp;it&amp;#39;s&nbsp;a&nbsp;matter&nbsp;of&nbsp;replacing&nbsp;all&nbsp;checks&nbsp;for MONO_ARCH_SOFT_FLOAT&nbsp;to&nbsp;checks&nbsp;for COMPILE_SOFT_FLOAT(cfg).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;approach&nbsp;relies&nbsp;on&nbsp;a&nbsp;minimally&nbsp;decent&nbsp;compiler&nbsp;capable&nbsp;of&nbsp;eliminating&nbsp;trivial&nbsp;dead&nbsp;code&nbsp;which&nbsp;IMHO&nbsp;is&nbsp;something&nbsp;we&lt;/div&gt;<br>
&lt;div&gt;must&nbsp;assume&nbsp;to&nbsp;be&nbsp;true&nbsp;in&nbsp;2010.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&amp;#39;m&nbsp;not&nbsp;a&nbsp;big&nbsp;fan&nbsp;of&nbsp;the mono_arch_is_soft_float&nbsp;bit.&nbsp;I&nbsp;would&nbsp;rather&nbsp;cleanup&nbsp;and&nbsp;unify&nbsp;this&nbsp;with&nbsp;simd&nbsp;and&nbsp;cpu-specific&nbsp;ops&nbsp;into&nbsp;a&lt;/div&gt;&lt;div&gt;single&nbsp;cpu&nbsp;caps&nbsp;thing.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;we&nbsp;unify&nbsp;the&nbsp;above&nbsp;three,&nbsp;supporting&nbsp;AOT&nbsp;would&nbsp;be&nbsp;a&nbsp;matter&nbsp;of&nbsp;changing&nbsp;the&nbsp;initialization&nbsp;code&nbsp;to&nbsp;read&nbsp;a&nbsp;supplied&nbsp;argument&nbsp;that&lt;/div&gt;&lt;div&gt;override&nbsp;auto-detected&nbsp;caps.&nbsp;This&nbsp;would&nbsp;be&nbsp;a&nbsp;great&nbsp;addition&nbsp;to&nbsp;help&nbsp;testing&nbsp;those&nbsp;runtime&nbsp;selectable&nbsp;features.&nbsp;I&nbsp;should&nbsp;have&nbsp;done&nbsp;it&nbsp;for&nbsp;Mono.Simd&nbsp;so&nbsp;our&nbsp;build&nbsp;bot&nbsp;could&nbsp;test&nbsp;it&nbsp;running&nbsp;on&nbsp;less&nbsp;capable&nbsp;hardware.&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;only&nbsp;thing&nbsp;that&nbsp;would&nbsp;be&nbsp;very&nbsp;hard&nbsp;would&nbsp;be&nbsp;supporting&nbsp;runtime-selectable&nbsp;FPU&nbsp;under&nbsp;AOT.&nbsp;Well,&nbsp;not&nbsp;really,&nbsp;that&nbsp;would&nbsp;a&nbsp;minor&nbsp;enhancement&nbsp;over&nbsp;soft-float.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;By&nbsp;the&nbsp;way,&nbsp;what&amp;#39;s&nbsp;the&nbsp;use&nbsp;of&nbsp;runtime&nbsp;selectable&nbsp;FPU&nbsp;mode&nbsp;for&nbsp;JIT&amp;#39;d&nbsp;code&nbsp;if&nbsp;we&nbsp;don&amp;#39;t&nbsp;do&nbsp;the&nbsp;same&nbsp;for&nbsp;the&nbsp;runtime&nbsp;itself?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Jun&nbsp;20,&nbsp;2010&nbsp;at&nbsp;1:20&nbsp;AM,&nbsp;Geoff&nbsp;Norton&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:gnorton@novell.com&quot;&gt;gnorton@novell.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;<br>
Its&nbsp;valuable&nbsp;for&nbsp;us&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;jit&nbsp;to&nbsp;different&nbsp;FPU&amp;#39;s&nbsp;based&nbsp;on&nbsp;cpu&nbsp;capabilities,&nbsp;rather&nbsp;than&nbsp;a&nbsp;runtime&nbsp;compile,&nbsp;particularly&nbsp;on&nbsp;arm.&nbsp; As&nbsp;such&nbsp;I&amp;#39;ve&nbsp;started&nbsp;porting&nbsp;things&nbsp;over&nbsp;to&nbsp;being&nbsp;runtime&nbsp;selectable.&nbsp; I&amp;#39;ve&nbsp;attached&nbsp;a&nbsp;patch&nbsp;which&nbsp;reworks&nbsp;most&nbsp;of&nbsp;mini,&nbsp;and&nbsp;am&nbsp;looking&nbsp;for&nbsp;comments&nbsp;on&nbsp;the&nbsp;approach&nbsp;before&nbsp;continuing,&nbsp;VFP&nbsp;seems&nbsp;to&nbsp;be&nbsp;working&nbsp;but&nbsp;there&nbsp;are&nbsp;a&nbsp;few&nbsp;known&nbsp;issues:&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
#1:&nbsp;soft&nbsp;float&nbsp;currently&nbsp;has&nbsp;some&nbsp;regressions,&nbsp;I&amp;#39;m&nbsp;still&nbsp;tracking&nbsp;down&nbsp;exactly&nbsp;where,&nbsp;if&nbsp;it&nbsp;pops&nbsp;out&nbsp;please&nbsp;let&nbsp;me&nbsp;know&lt;br&gt;<br>
#2:&nbsp;We&nbsp;dont&nbsp;detect&nbsp;cpu&nbsp;capabilities&nbsp;at&nbsp;runtime&nbsp;yet,&nbsp;its&nbsp;driven&nbsp;off&nbsp;an&nbsp;env&nbsp;var,&nbsp;maybe&nbsp;we&nbsp;should&nbsp;emit&nbsp;and&nbsp;test&nbsp;small&nbsp;functions&nbsp;and&nbsp;catch&nbsp;the&nbsp;sigill&nbsp;on&nbsp;startup?&nbsp; input&nbsp;would&nbsp;be&nbsp;nice&nbsp;here&lt;br&gt;<br>
#3:&nbsp;How&nbsp;do&nbsp;we&nbsp;handle&nbsp;the&nbsp;aot&nbsp;case,&nbsp;perhaps&nbsp;we&nbsp;introduce&nbsp;a&nbsp;new&nbsp;aot&nbsp;flag&nbsp;for&nbsp;fpu&nbsp;mode?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
-g&lt;br&gt;<br>
&lt;/font&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
