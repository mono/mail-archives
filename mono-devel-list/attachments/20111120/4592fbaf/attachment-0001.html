<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;div&gt;Thanks,&nbsp;Zoltan&nbsp;pointed&nbsp;out&nbsp;that&nbsp;the&nbsp;performance&nbsp;under&nbsp;LLVM&nbsp;is&nbsp;pretty&nbsp;good,&nbsp;so&nbsp;I&nbsp;probably&nbsp;did&nbsp;not&nbsp;have&nbsp;LLVM&nbsp;enabled.&nbsp;&amp;nbsp;Indeed&nbsp;I&nbsp;checked&nbsp;and&nbsp;found&nbsp;that&nbsp;to&nbsp;be&nbsp;the&nbsp;case&nbsp;(my&nbsp;bad).&nbsp;&amp;nbsp;As&nbsp;for&nbsp;the&nbsp;pattern&nbsp;you&nbsp;mention,&nbsp;aware&nbsp;that&nbsp;mono&nbsp;is&nbsp;able&nbsp;to&nbsp;avoid&nbsp;checks&nbsp;in&nbsp;that&nbsp;scenario.&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;More&nbsp;often&nbsp;then&nbsp;not,&nbsp;though,&nbsp;I&nbsp;am&nbsp;dealing&nbsp;with&nbsp;structures&nbsp;that&nbsp;use&nbsp;double[]&nbsp;with&nbsp;allocations&nbsp;&amp;gt;&nbsp;the&nbsp;span&nbsp;of&nbsp;interest&nbsp;(as&nbsp;the&nbsp;series&nbsp;grow&nbsp;in&nbsp;size).&nbsp;&amp;nbsp;So&nbsp;I&nbsp;usually&nbsp;have&nbsp;to&nbsp;rely&nbsp;on&nbsp;a&nbsp;variable&nbsp;that&nbsp;indicates&nbsp;size&nbsp;rather&nbsp;than&nbsp;array.Length.&nbsp;&amp;nbsp;&nbsp;I&nbsp;could&nbsp;have&nbsp;used&nbsp;in&nbsp;this&nbsp;test&nbsp;though.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;would&nbsp;be&nbsp;nice&nbsp;(and&nbsp;seemingly&nbsp;would&nbsp;be&nbsp;straightforward)&nbsp;if&nbsp;the&nbsp;JIT&nbsp;was&nbsp;able&nbsp;to&nbsp;recognize:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;the&nbsp;len&nbsp;variable&nbsp;is&nbsp;invariant&nbsp;/&nbsp;locally&nbsp;scoped&nbsp;with&nbsp;respect&nbsp;to&nbsp;the&nbsp;loop&lt;/li&gt;&lt;li&gt;can&nbsp;have&nbsp;2&nbsp;code&nbsp;paths:&lt;/li&gt;&lt;ol&gt;&lt;li&gt;one&nbsp;for&nbsp;if&nbsp;the&nbsp;condition&nbsp;will&nbsp;be&nbsp;within&nbsp;bounds&nbsp;(can&nbsp;avoid&nbsp;bounds&nbsp;checking)&lt;/li&gt;&lt;li&gt;one&nbsp;for&nbsp;if&nbsp;the&nbsp;condition&nbsp;is&nbsp;either&nbsp;not&nbsp;in&nbsp;bounds&nbsp;or&nbsp;cannot&nbsp;be&nbsp;determined&nbsp;to&nbsp;be&nbsp;invariant&nbsp;(hence&nbsp;should&nbsp;do&nbsp;the&nbsp;normal&nbsp;bounds&nbsp;checking)&lt;/li&gt;&lt;/ol&gt;&lt;/ol&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;suppose&nbsp;a&nbsp;crutch&nbsp;to&nbsp;work&nbsp;around&nbsp;this,&nbsp;playing&nbsp;to&nbsp;mono's&nbsp;jit&nbsp;would&nbsp;be:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;array.Length&nbsp;;&nbsp;i++)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;if&nbsp;(i&nbsp;&amp;lt;&nbsp;&amp;lt;length&nbsp;expression&amp;gt;)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&amp;lt;do&nbsp;computation&nbsp;on&nbsp;array[i]&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;else&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;break;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;cost&nbsp;of&nbsp;the&nbsp;extra&nbsp;condition&nbsp;might&nbsp;outweigh&nbsp;the&nbsp;benefit&nbsp;(I&nbsp;haven't&nbsp;studied&nbsp;the&nbsp;branch&nbsp;cycle&nbsp;times&nbsp;to&nbsp;know).&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;Better&nbsp;would&nbsp;be:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if&nbsp;(&amp;lt;length&nbsp;expression&amp;gt;&nbsp;&amp;lt;=&nbsp;array.Length&nbsp;AND&nbsp;invariant)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;&amp;lt;length&nbsp;expression&amp;gt;&nbsp;;&nbsp;i++)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&amp;lt;do&nbsp;computation&nbsp;on&nbsp;array[i]&nbsp;without&nbsp;checks&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;else&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;&amp;lt;length&nbsp;expression&amp;gt;&nbsp;;&nbsp;i++)&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;{&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;&amp;lt;do&nbsp;computation&nbsp;on&nbsp;array[i]&nbsp;with&nbsp;checks&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:&nbsp;pre;&nbsp;&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;}&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;is&nbsp;too&nbsp;bad&nbsp;that&nbsp;one&nbsp;cannot&nbsp;declare&nbsp;a&nbsp;primitive&nbsp;expression&nbsp;to&nbsp;be&nbsp;locally&nbsp;const&nbsp;in&nbsp;C#.&nbsp;&amp;nbsp;In&nbsp;java&nbsp;one&nbsp;can&nbsp;do&nbsp;something&nbsp;like:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;final&nbsp;int&nbsp;len&nbsp;=&nbsp;&amp;lt;some&nbsp;expression&amp;gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;len&nbsp;;&nbsp;i++)&nbsp;...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;OR&nbsp;in&nbsp;C#&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;const&nbsp;int&nbsp;len&nbsp;=&nbsp;&amp;lt;some&nbsp;expression&amp;gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(error&nbsp;if&nbsp;the&nbsp;expression&nbsp;refers&nbsp;to&nbsp;functions&nbsp;or&nbsp;variables)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;With&nbsp;an&nbsp;explicit&nbsp;notion&nbsp;of&nbsp;invariance&nbsp;could&nbsp;simplify&nbsp;the&nbsp;decision&nbsp;for&nbsp;the&nbsp;JIT.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Nov&nbsp;20,&nbsp;2011,&nbsp;at&nbsp;11:38&nbsp;AM,&nbsp;Konrad&nbsp;M.&nbsp;Kruczy≈Ñski&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&gt;Hi,&lt;br&gt;&lt;br&gt;I'd&nbsp;like&nbsp;to&nbsp;add&nbsp;that&nbsp;you&nbsp;may&nbsp;gain&nbsp;something&nbsp;on&nbsp;MS&nbsp;JIT&nbsp;compiler&nbsp;using&nbsp;&lt;br&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;x.Length&nbsp;;&nbsp;i++)&lt;br&gt;instead&nbsp;of&lt;br&gt;for&nbsp;(int&nbsp;i&nbsp;=&nbsp;0&nbsp;;&nbsp;i&nbsp;&amp;lt;&nbsp;len&nbsp;;&nbsp;i++)&lt;br&gt;&lt;br&gt;This&nbsp;may&nbsp;seem&nbsp;counter&nbsp;intuitive,&nbsp;however&nbsp;that's&nbsp;the&nbsp;scenario&nbsp;in&nbsp;which&lt;br&gt;JIT&nbsp;eliminates&nbsp;array&nbsp;bound&nbsp;checking&nbsp;for&nbsp;the&nbsp;x&nbsp;array&nbsp;(however&nbsp;not&nbsp;for&nbsp;the&lt;br&gt;second&nbsp;one)&nbsp;as&nbsp;arrays&nbsp;have&nbsp;constant&nbsp;length.&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;whether&nbsp;Mini&lt;br&gt;recognizes&nbsp;that.&nbsp;I'm&nbsp;pretty&nbsp;sure&nbsp;that&nbsp;Hotspot&nbsp;is&nbsp;much&nbsp;smarter&nbsp;here&nbsp;;)&lt;br&gt;&lt;br&gt;As&nbsp;Zoltan&nbsp;wrote&nbsp;in&nbsp;the&nbsp;bug&nbsp;comments,&nbsp;enabling&nbsp;LLVM&nbsp;improves&nbsp;the&nbsp;results&lt;br&gt;a&nbsp;lot.&nbsp;This&nbsp;is,&nbsp;I&nbsp;guess,&nbsp;due&nbsp;to&nbsp;much&nbsp;better&nbsp;register&nbsp;allocation&nbsp;in&nbsp;which&lt;br&gt;domain&nbsp;Mini&nbsp;isn't&nbsp;too&nbsp;good&nbsp;-&nbsp;and&nbsp;probably&nbsp;other&nbsp;optimizations&nbsp;like&lt;br&gt;better&nbsp;loop&nbsp;unrolling.&lt;br&gt;&lt;br&gt;If&nbsp;I&nbsp;remember&nbsp;correctly,&nbsp;there&nbsp;once&nbsp;was&nbsp;a&nbsp;branch&nbsp;of&nbsp;LLVM&nbsp;with&nbsp;array&lt;br&gt;bounds&nbsp;check&nbsp;elimination,&nbsp;is&nbsp;it&nbsp;still&nbsp;developed?&lt;br&gt;&lt;br&gt;I&nbsp;am&nbsp;also&nbsp;curious&nbsp;which&nbsp;code&nbsp;patterns&nbsp;enable&nbsp;ABC&nbsp;elimination&nbsp;in&nbsp;Mini.&lt;br&gt;&lt;br&gt;On&nbsp;Sun,&nbsp;2011-11-20&nbsp;at&nbsp;08:01&nbsp;-0500,&nbsp;Jonathan&nbsp;Shore&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Here&nbsp;is&nbsp;a&nbsp;link&nbsp;to&nbsp;and&nbsp;entry&nbsp;in&nbsp;bugzilla&nbsp;with&nbsp;attached&nbsp;code.&nbsp;&amp;nbsp;I&nbsp;could&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;not&nbsp;send&nbsp;to&nbsp;the&nbsp;list:&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;a&nbsp;href=&quot;http://bugzilla.xamarin.com/show_bug.cgi?id=2098&quot;&gt;http://bugzilla.xamarin.com/show_bug.cgi?id=2098&lt;/a&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;--&lt;br&gt;Regards,&lt;br&gt;&nbsp;Konrad&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
