 Makefile.am         |   22 ++++++++++---------
 runtime/Makefile.am |   59 +++++++++++++++++++++++++++++++--------------------- 2 files changed, 48 insertions(+), 33 deletions(-)

Index: ChangeLog
from  Raja R Harinath  <rharinath@novell.com>

	Allow 'make fullbuild' to work on non-srcdir build.
	* Makefile.am (mcs_topdir): New variable.
	(mcs-tree-safe-build,mcs-rest,remove-binaries): Work in non-srcdir
	build.
	(xinstall-runtime): Likewise.  Use $(libgc_dir) directly, don't
	grep for 'libgc'.
	* runtime/Makefile.am (mcs_topdir): New variable.
	($(assembles_DATA)): Silence errors from 'cp'.  Allow to be
	bootstrapped by an installation in /usr.
	($(monobins_DATA)): Likewise.

Index: Makefile.am
===================================================================
RCS file: /mono/mono/Makefile.am,v
retrieving revision 1.37
diff -u -r1.37 Makefile.am
--- Makefile.am 7 Apr 2004 15:14:08 -0000 1.37
+++ Makefile.am 12 Apr 2004 08:01:42 -0000
@@ -20,25 +20,27 @@
 # problems by doing the compilation in the right order.
 #
 
+mcs_topdir=$(top_srcdir)/../mcs
+
 fullbuild: remove-binaries mcs-tree-safe-build xinstall-runtime mcs-rest install
 
 mcs-tree-safe-build:
-	(cd ../mcs/jay; $(MAKE))
-	(cd ../mcs/mcs; $(MAKE) MCS=mcs BOOTSTRAP_MCS=mcs)
-	(cd ../mcs/class/corlib; $(MAKE) MCS=mcs BOOTSTRAP_MCS=mcs)
-	cp ../mcs/class/lib/mscorlib.dll runtime
-	cp ../mcs/mcs/mcs.exe runtime
+	cd $(mcs_topdir)/jay; $(MAKE)
+	cd $(mcs_topdir)/mcs; $(MAKE) MCS=mcs BOOTSTRAP_MCS=mcs
+	cd $(mcs_topdir)/class/corlib; $(MAKE) MCS=mcs BOOTSTRAP_MCS=mcs
+	cp $(mcs_topdir)/class/lib/mscorlib.dll $(top_srcdir)/runtime
+	cp $(mcs_topdir)/mcs/mcs.exe $(top_srcdir)/runtime
 
 xinstall-runtime:
-	if echo $(SUBDIRS) | grep "libgc " > /dev/null; then (cd libgc; $(MAKE) && $(MAKE) install); fi
-	(cd mono; $(MAKE) && $(MAKE) install)
-	(cd runtime; $(MAKE) install assemblies_DATA=mscorlib.dll monobins_DATA=mcs.exe)
+	if test -z "$(libgc_dir)"; then :; else cd libgc; $(MAKE) && $(MAKE) install ; fi
+	cd mono; $(MAKE) && $(MAKE) install
+	cd runtime; $(MAKE) install assemblies_DATA=mscorlib.dll monobins_DATA=mcs.exe
 
 mcs-rest:
-	(cd ../mcs/class; $(MAKE))
+	cd $(mcs_topdir)/class; $(MAKE)
 
 remove-binaries:
-	rm ../mcs/class/lib/mscorlib.dll ../mcs/mcs/mcs.exe runtime/*dll runtime/*.exe > /dev/null 2>&1; echo
+	rm -f $(mcs_topdir)/class/lib/mscorlib.dll $(mcs_topdir)/mcs/mcs.exe $(top_srcdir)/runtime/*.dll $(top_srcdir)/runtime/*.exe
 
 
 win32getdeps:
Index: runtime/Makefile.am
===================================================================
RCS file: /mono/mono/runtime/Makefile.am,v
retrieving revision 1.55
diff -u -r1.55 Makefile.am
--- runtime/Makefile.am 6 Apr 2004 05:31:02 -0000 1.55
+++ runtime/Makefile.am 12 Apr 2004 08:01:42 -0000
@@ -2,6 +2,8 @@
 # being compiled on windows.
 #
 
+mcs_topdir=$(top_srcdir)/../mcs
+
 assemblies_DATA =	\
 	Accessibility.dll					\
 	ByteFX.Data.dll						\
@@ -18,7 +20,7 @@
 	Microsoft.VisualBasic.dll				\
 	Microsoft.VisualC.dll					\
 	Microsoft.Vsa.dll					\
-	Mono.Cairo.dll	                		\
+	Mono.Cairo.dll			\
 	Mono.CSharp.Debugger.dll				\
 	Mono.Data.SqliteClient.dll				\
 	Mono.Data.SybaseClient.dll				\
@@ -65,30 +67,41 @@
 monobinsdir = $(bindir)
 
 $(assemblies_DATA):
-	-cp $(top_srcdir)/../mcs/class/lib/$@ . || cp $(assembliesdir)/$@ . 
+	@f=$(mcs_topdir)/class/lib/$@; \
+	if test -f $$f; then :; else f=$(assembliesdir)/$@; fi ; \
+	if test -f $$f; then :; else f=/usr/lib/$@; fi ; \
+	echo cp -f $$f $(srcdir); \
+	cp -f $$f $(srcdir)
 
 $(monobins_DATA):
-	-cp $(top_srcdir)/../mcs/mcs/mcs.exe . || cp $(monobinsdir)/mcs.exe . 
-	-cp $(top_srcdir)/../mcs/mbas/mbas.exe . || cp $(monobinsdir)/mbas.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/secutil.exe . || cp $(monobinsdir)/secutil.exe . 
-	-cp $(top_srcdir)/../mcs/monoresgen/monoresgen.exe . || cp $(monobinsdir)/monoresgen.exe . 
-	-cp $(top_srcdir)/../mcs/ilasm/ilasm.exe . || cp $(monobinsdir)/ilasm.exe .
-	-cp $(top_srcdir)/../mcs/tools/cilc/cilc.exe . || cp $(monobinsdir)/cilc.exe .
-	-cp $(top_srcdir)/../mcs/tools/mono-xsd/xsd.exe . || cp $(monobinsdir)/xsd.exe .
-	-cp $(top_srcdir)/../mcs/tools/wsdl/wsdl.exe . || cp $(monobinsdir)/wsdl.exe .
-	-cp $(top_srcdir)/../mcs/tools/genxs/genxs.exe . || cp $(monobinsdir)/genxs.exe .
-	-cp $(top_srcdir)/../mcs/tools/al/al.exe . || cp $(monobinsdir)/al.exe .
-	-cp $(top_srcdir)/../mcs/tools/disco/disco.exe . || cp $(monobinsdir)/disco.exe .
-	-cp $(top_srcdir)/../mcs/tools/soapsuds/soapsuds.exe . || cp $(monobinsdir)/soapsuds.exe .
-	-cp $(top_srcdir)/../mcs/tools/SqlSharp/sqlsharp.exe . || cp $(monobinsdir)/sqlsharp.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/chktrust.exe . || cp $(monobinsdir)/chktrust.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/signcode.exe . || cp $(monobinsdir)/signcode.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/MakeCert.exe . || cp $(monobinsdir)/MakeCert.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/cert2spc.exe . || cp $(monobinsdir)/cert2spc.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/certmgr.exe . || cp $(monobinsdir)/certmgr.exe .
-	-cp $(top_srcdir)/../mcs/tools/security/setreg.exe . || cp $(monobinsdir)/setreg.exe .
-	-cp $(top_srcdir)/../mcs/tools/monop/monop.exe . || cp $(monobinsdir)/monop.exe .
-	-cp $(top_srcdir)/../mcs/tools/browsercaps-updater/browsercaps-updater.exe . || cp $(monobinsdir)/browsercaps-updater.exe .
+	@case "$@" in \
+	mcs.exe)                 d=mcs                          ;; \
+	mbas.exe)                d=mbas                         ;; \
+	secutil.exe)             d=tools/security               ;; \
+	monoresgen.exe)          d=monoresgen                   ;; \
+	ilasm.exe)               d=ilasm                        ;; \
+	cilc.exe)                d=tools/cilc                   ;; \
+	xsd.exe)                 d=tools/mono-xsd               ;; \
+	wsdl.exe)                d=tools/wsdl                   ;; \
+	genxs.exe)               d=tools/genxs                  ;; \
+	al.exe)                  d=tools/al                     ;; \
+	disco.exe)               d=tools/disco                  ;; \
+	soapsuds.exe)            d=tools/soapsuds               ;; \
+	sqlsharp.exe)            d=tools/SqlSharp               ;; \
+	chktrust.exe)            d=tools/security               ;; \
+	signcode.exe)            d=tools/security               ;; \
+	MakeCert.exe)            d=tools/security               ;; \
+	cert2spc.exe)            d=tools/security               ;; \
+	certmgr.exe)             d=tools/security               ;; \
+	setreg.exe)              d=tools/security               ;; \
+	monop.exe)               d=tools/monop                  ;; \
+	browsercaps-updater.exe) d=tools/browsercaps-updater    ;; \
+	esac; \
+	f=$(mcs_topdir)/$$d/$@; \
+	if test -f $$f; then :; else f=$(monobinsdir)/$@; fi ; \
+	if test -f $$f; then :; else f=/usr/bin/$@; fi ; \
+	echo cp -f $$f $(srcdir); \
+	cp -f $$f $(srcdir)
 
 dist-hook:
 	for i in $(monobins_DATA) $(assemblies_DATA); do	\
