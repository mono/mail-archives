<tt>
Hello,&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;COM&nbsp;Interop&nbsp;support&nbsp;in&nbsp;mono&nbsp;works&nbsp;pretty&nbsp;well&nbsp;for&nbsp;most&nbsp;basic&nbsp;uses,&nbsp;but&nbsp;has&nbsp;some&nbsp;limitations&nbsp;when&nbsp;it&nbsp;comes&nbsp;to&nbsp;strings.&nbsp;Mainly,&nbsp;BSTR&nbsp;marshalling&nbsp;on&nbsp;non-Windows&nbsp;platforms&nbsp;is&nbsp;just&nbsp;a&nbsp;default&nbsp;implementation.&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;most&nbsp;COM&nbsp;systems&nbsp;(both&nbsp;Mainsoft&amp;#39;s&nbsp;COM&nbsp;and&nbsp;Mozilla&amp;#39;s&nbsp;XPCOM)&nbsp;have&nbsp;specific&nbsp;requirements&nbsp;on&nbsp;strings.&nbsp;They&nbsp;need&nbsp;to&nbsp;follow&nbsp;a&nbsp;certain&nbsp;format&nbsp;(usually&nbsp;a&nbsp;length&nbsp;prefixed&nbsp;string),&nbsp;use&nbsp;special&nbsp;allocators/deallocators,&nbsp;and&nbsp;use&nbsp;the&nbsp;correct&nbsp;byte&nbsp;size&nbsp;(2-byte&nbsp;vs.&nbsp;4-byte&nbsp;encoding).<br>
&lt;br&gt;&lt;br&gt;Note,&nbsp;I&nbsp;did&nbsp;try&nbsp;to&nbsp;go&nbsp;down&nbsp;the&nbsp;road&nbsp;of&nbsp;using&nbsp;a&nbsp;custom&nbsp;marshaller,&nbsp;but&nbsp;ran&nbsp;into&nbsp;some&nbsp;issues.&nbsp;First,&nbsp;any&nbsp;assemblies&nbsp;that&nbsp;worked&nbsp;on&nbsp;Windows&nbsp;now&nbsp;need&nbsp;extensively&nbsp;modified&nbsp;to&nbsp;work&nbsp;on&nbsp;non-Windows&nbsp;platforms.&nbsp;This&nbsp;is&nbsp;more&nbsp;of&nbsp;an&nbsp;issue&nbsp;for&nbsp;COM,&nbsp;since&nbsp;MS&nbsp;has&nbsp;nice&nbsp;tools&nbsp;to&nbsp;generate&nbsp;COM&nbsp;Interop&nbsp;assemblies.&nbsp;Almost&nbsp;no&nbsp;one&nbsp;generates&nbsp;COM&nbsp;Interop&nbsp;code&nbsp;by&nbsp;hand.&nbsp;Second,&nbsp;even&nbsp;if&nbsp;the&nbsp;user&nbsp;tries&nbsp;to&nbsp;use&nbsp;a&nbsp;custom&nbsp;marshaller,&nbsp;there&nbsp;are&nbsp;places&nbsp;in&nbsp;the&nbsp;runtime&nbsp;that&nbsp;perform&nbsp;BSTR&nbsp;marshalling&nbsp;as&nbsp;well&nbsp;that&nbsp;the&nbsp;user&nbsp;cannot&nbsp;modify&nbsp;(without&nbsp;modifying&nbsp;mono&nbsp;and&nbsp;rebuilding).&nbsp;Examples&nbsp;include&nbsp;BSTR&nbsp;util&nbsp;methods&nbsp;in&nbsp;the&nbsp;Marshal&nbsp;class,&nbsp;VARIANT&nbsp;marshalling,&nbsp;etc.<br>
&lt;br&gt;&lt;br&gt;In&nbsp;order&nbsp;to&nbsp;better&nbsp;support&nbsp;this&nbsp;on&nbsp;non-Windows&nbsp;platforms,&nbsp;I&amp;#39;d&nbsp;like&nbsp;to&nbsp;make&nbsp;the&nbsp;BSTR&nbsp;marshalling&nbsp;in&nbsp;mono&nbsp;extensible.&nbsp;I&nbsp;have&nbsp;thought&nbsp;of&nbsp;a&nbsp;few&nbsp;ways&nbsp;to&nbsp;do&nbsp;this&nbsp;that&nbsp;I&amp;#39;ll&nbsp;list,&nbsp;and&nbsp;hopefully&nbsp;get&nbsp;some&nbsp;feedback&nbsp;on&nbsp;as&nbsp;to&nbsp;which&nbsp;is&nbsp;best.<br>
&lt;br&gt;&lt;br&gt;1.&nbsp;Expose&nbsp;some&nbsp;methods&nbsp;in&nbsp;the&nbsp;runtime&nbsp;so&nbsp;users&nbsp;could&nbsp;embed&nbsp;mono&nbsp;and&nbsp;adjust&nbsp;the&nbsp;BSTR&nbsp;marshalling&nbsp;behavior&nbsp;with&nbsp;callbacks.&nbsp;Something&nbsp;like&nbsp;mono_set_bstr_to_string_marshal,&nbsp;mono_set_bstr_from_string_marshal,&nbsp;mono_set_bstr_free.&nbsp;This&nbsp;would&nbsp;require&nbsp;users&nbsp;to&nbsp;embed&nbsp;mono.<br>
&lt;br&gt;&lt;br&gt;2.&nbsp;Use&nbsp;the&nbsp;dll&nbsp;map&nbsp;in&nbsp;the&nbsp;config&nbsp;file&nbsp;to&nbsp;let&nbsp;the&nbsp;user&nbsp;specify&nbsp;entry&nbsp;points&nbsp;to&nbsp;perform&nbsp;BSTR&nbsp;marshalling.&nbsp;This&nbsp;seems&nbsp;a&nbsp;better&nbsp;choice&nbsp;than&nbsp;the&nbsp;first.&nbsp;There&nbsp;is&nbsp;then&nbsp;a&nbsp;technical&nbsp;question&nbsp;as&nbsp;to&nbsp;how&nbsp;to&nbsp;implement&nbsp;this.&lt;br&gt;<br>
&lt;br&gt;a.&nbsp;Right&nbsp;now&nbsp;all&nbsp;BSTR&nbsp;marshalling&nbsp;occurs&nbsp;in&nbsp;an&nbsp;icall.&nbsp;The&nbsp;current&nbsp;icall&nbsp;could&nbsp;lookup&nbsp;the&nbsp;info&nbsp;in&nbsp;the&nbsp;config&nbsp;map,&nbsp;and&nbsp;call&nbsp;the&nbsp;entry&nbsp;point&nbsp;itself.&nbsp;This&nbsp;would&nbsp;require&nbsp;no&nbsp;changes&nbsp;to&nbsp;any&nbsp;other&nbsp;code,&nbsp;but&nbsp;would&nbsp;require&nbsp;logic&nbsp;to&nbsp;parse&nbsp;the&nbsp;config&nbsp;file,&nbsp;load&nbsp;a&nbsp;library,&nbsp;and&nbsp;get&nbsp;an&nbsp;entry&nbsp;point.&nbsp;I&nbsp;know&nbsp;this&nbsp;logic&nbsp;exists,&nbsp;but&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;how&nbsp;much&nbsp;of&nbsp;it&nbsp;exists&nbsp;outside&nbsp;of&nbsp;the&nbsp;pinvoke&nbsp;framework&nbsp;and&nbsp;whether&nbsp;we&nbsp;would&nbsp;want&nbsp;to&nbsp;put&nbsp;that&nbsp;logic&nbsp;in&nbsp;the&nbsp;icalls&nbsp;anyway.&nbsp;<br>
&lt;br&gt;&lt;br&gt;b.&nbsp;I&nbsp;could&nbsp;also&nbsp;change&nbsp;all&nbsp;BTSR&nbsp;related&nbsp;routines&nbsp;to&nbsp;go&nbsp;through&nbsp;the&nbsp;Marshal&nbsp;class.&nbsp;This&nbsp;would&nbsp;intern&nbsp;pinvoke&nbsp;into&nbsp;the&nbsp;runtime.&nbsp;We&nbsp;could&nbsp;then&nbsp;use&nbsp;the&nbsp;config&nbsp;file&nbsp;and&nbsp;the&nbsp;current&nbsp;pinvoke&nbsp;redirection&nbsp;logic&nbsp;to&nbsp;simply&nbsp;redirect&nbsp;those&nbsp;pinvokes&nbsp;to&nbsp;a&nbsp;user&nbsp;supplied&nbsp;library.&nbsp;The&nbsp;downside&nbsp;to&nbsp;this&nbsp;would&nbsp;be&nbsp;having&nbsp;to&nbsp;modify&nbsp;all&nbsp;the&nbsp;icalls/logic&nbsp;in&nbsp;the&nbsp;runtime&nbsp;marshalling&nbsp;code&nbsp;for&nbsp;BSTRs.&nbsp;It&nbsp;would&nbsp;also&nbsp;make&nbsp;the&nbsp;string&nbsp;marshalling&nbsp;code&nbsp;a&nbsp;bit&nbsp;uglier,&nbsp;as&nbsp;currently&nbsp;all&nbsp;string&nbsp;marshalling&nbsp;occurs&nbsp;in&nbsp;icalls.&nbsp;This&nbsp;would&nbsp;require&nbsp;a&nbsp;check&nbsp;for&nbsp;BSTRs&nbsp;to&nbsp;call&nbsp;a&nbsp;managed&nbsp;method&nbsp;rather&nbsp;than&nbsp;an&nbsp;icall.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;br&gt;&lt;br&gt;<br>

</tt>
