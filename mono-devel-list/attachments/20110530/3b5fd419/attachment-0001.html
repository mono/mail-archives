<tt>
The&nbsp;fix&nbsp;is&nbsp;to&nbsp;actually&nbsp;disable&nbsp;jmp&nbsp;to&nbsp;synchronized&nbsp;methods&nbsp;and&nbsp;use&nbsp;a&nbsp;regular&nbsp;call.&lt;div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;May&nbsp;30,&nbsp;2011&nbsp;at&nbsp;11:46&nbsp;AM,&nbsp;Martin&nbsp;Däumler&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mdae@cs.tu-chemnitz.de&quot;&gt;mdae@cs.tu-chemnitz.de&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
maybe&nbsp;there&nbsp;might&nbsp;be&nbsp;a&nbsp;problem&nbsp;with&nbsp;a&nbsp;optimization&nbsp;in&nbsp;the&nbsp;jump&lt;br&gt;<br>
trampoline&nbsp;code.&nbsp;In&nbsp;the&nbsp;IL&nbsp;code&nbsp;example&nbsp;appended,&nbsp;the&nbsp;main&nbsp;method&lt;br&gt;<br>
creates&nbsp;two&nbsp;threads&nbsp;that&nbsp;start&nbsp;with&nbsp;a&nbsp;method&nbsp;that&nbsp;jumps&nbsp;to&nbsp;a&lt;br&gt;<br>
synchronized&nbsp;method.&nbsp;The&nbsp;final&nbsp;value&nbsp;of&nbsp;the&nbsp;variable&nbsp;&amp;quot;count&amp;quot;&lt;br&gt;<br>
should&nbsp;be&nbsp;20,&nbsp;but&nbsp;it&nbsp;isn&amp;#39;t&nbsp;always&nbsp;so.&nbsp;If&nbsp;you&nbsp;change&nbsp;the&nbsp;jump&lt;br&gt;<br>
instruction&nbsp;to&nbsp;call&nbsp;instruction,&nbsp;the&nbsp;code&nbsp;works&nbsp;as&nbsp;expected.&nbsp;I&lt;br&gt;<br>
tested&nbsp;with&nbsp;Mono&nbsp;2.6.1,&nbsp;2.6.7&nbsp;and&nbsp;2.10.2&nbsp;on&nbsp;an&nbsp;x86&nbsp;machine&lt;br&gt;<br>
running&nbsp;Linux.&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;&amp;quot;mono_postprocess_patches()&amp;quot;,&nbsp;the&nbsp;handle&nbsp;to&nbsp;the&nbsp;method&nbsp;is&nbsp;stored&lt;br&gt;<br>
in&nbsp;the&nbsp;hash&nbsp;table&nbsp;&amp;quot;jump_target_hash&amp;quot;.&nbsp;When&nbsp;the&nbsp;synchronized&nbsp;method&lt;br&gt;<br>
(&amp;quot;tolleMethode()&amp;quot;)&nbsp;is&nbsp;jumped&nbsp;to&nbsp;the&nbsp;first&nbsp;time,&nbsp;the&nbsp;magic&nbsp;trampoline&lt;br&gt;<br>
creates&nbsp;a&nbsp;wrapper&nbsp;and&nbsp;returns&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;wrapper.&nbsp;The&nbsp;first&lt;br&gt;<br>
jump&nbsp;instruction&nbsp;is&nbsp;patched&nbsp;with&nbsp;that&nbsp;address.&nbsp;A&nbsp;later&nbsp;lookup&nbsp;in&nbsp;the&lt;br&gt;<br>
&amp;quot;jump_target_hash&amp;quot;&nbsp;(&amp;quot;mono_jit_compile_method_inner()&amp;quot;,&nbsp;in&nbsp;the&nbsp;scope&lt;br&gt;<br>
of&nbsp;the&nbsp;JIT-compilation&nbsp;of&nbsp;the&nbsp;wrapper)&nbsp;doesn&amp;#39;t&nbsp;return&nbsp;pending&nbsp;jump&lt;br&gt;<br>
patches&nbsp;because&nbsp;the&nbsp;method&nbsp;handle&nbsp;of&nbsp;&amp;quot;tolleMethod()&amp;quot;&nbsp;is&nbsp;stored,&lt;br&gt;<br>
instead&nbsp;of&nbsp;the&nbsp;wrapper&amp;#39;s&nbsp;handle.&nbsp;So,&nbsp;the&nbsp;second&nbsp;jump&nbsp;instruction&lt;br&gt;<br>
is&nbsp;not&nbsp;patched&nbsp;(if&nbsp;it&nbsp;is&nbsp;JIT-compiled&nbsp;so&nbsp;far).&lt;br&gt;<br>
&lt;br&gt;<br>
Even&nbsp;worse:&nbsp;When&nbsp;the&nbsp;wrapper&nbsp;is&nbsp;executed,&nbsp;the&nbsp;method&nbsp;&amp;quot;tolleMethode()&amp;quot;&lt;br&gt;<br>
is&nbsp;JIT-compiled.&nbsp;Then,&nbsp;in&nbsp;&amp;quot;mono_jit_compile_method_inner()&amp;quot;,&nbsp;there&lt;br&gt;<br>
is&nbsp;a&nbsp;hash&nbsp;hit&nbsp;and&nbsp;the&nbsp;second&nbsp;jump&nbsp;instruction&nbsp;is&nbsp;patched&nbsp;with&lt;br&gt;<br>
the&nbsp;method&amp;#39;s&nbsp;address&nbsp;instead&nbsp;of&nbsp;her&nbsp;wrapper&amp;#39;s&nbsp;one.&nbsp;So,&nbsp;I&nbsp;suggest&nbsp;to&lt;br&gt;<br>
check&nbsp;for&nbsp;a&nbsp;synchronized&nbsp;method&nbsp;in&nbsp;&amp;quot;mono_postprocess_patches()&amp;quot;,&lt;br&gt;<br>
to&nbsp;create&nbsp;a&nbsp;wrapper&nbsp;if&nbsp;needed&nbsp;and&nbsp;to&nbsp;change&nbsp;the&nbsp;patch&amp;#39;s&nbsp;target&lt;br&gt;<br>
method&nbsp;to&nbsp;the&nbsp;wrapper.&nbsp;There&nbsp;might&nbsp;be&nbsp;other&nbsp;problems&nbsp;I&nbsp;don&amp;#39;t&nbsp;see?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;kind&nbsp;regards,&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
Martin&nbsp;Däumler&lt;br&gt;<br>
&lt;/font&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
