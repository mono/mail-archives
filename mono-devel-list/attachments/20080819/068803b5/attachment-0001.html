<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;br&gt;&lt;br&gt;I&nbsp;spent&nbsp;a&nbsp;few&nbsp;hours&nbsp;yesterday&nbsp;trying&nbsp;to&nbsp;reproduce&nbsp;your&nbsp;bug&nbsp;without&nbsp;success.&nbsp;I&nbsp;have&nbsp;to&nbsp;say&nbsp;that&nbsp;from&nbsp;your&nbsp;valgrind&nbsp;result,&nbsp;the&nbsp;issue&nbsp;is&nbsp;closely&nbsp;related&nbsp;to&nbsp;how&lt;br&gt;your&nbsp;perforce&nbsp;library&nbsp;interact&nbsp;with&nbsp;unmanaged&nbsp;code&nbsp;-&nbsp;it&nbsp;happens&nbsp;when&nbsp;you&nbsp;pass&nbsp;a&nbsp;delegate&nbsp;to&nbsp;a&nbsp;pinvoke&nbsp;and&nbsp;somehow&nbsp;memory&nbsp;is&nbsp;leaked.&lt;br&gt;<br>
&lt;br&gt;Do&nbsp;you&nbsp;mind&nbsp;sharing&nbsp;the&nbsp;code&nbsp;and&nbsp;say&nbsp;what&nbsp;exactly&nbsp;your&nbsp;code&nbsp;is&nbsp;calling&nbsp;so&nbsp;I&nbsp;can&nbsp;try&nbsp;to&nbsp;produce&nbsp;a&nbsp;repro?&nbsp;You&nbsp;can&nbsp;send&nbsp;it&nbsp;directly&nbsp;to&nbsp;me&nbsp;if&nbsp;you&nbsp;don&amp;#39;t&nbsp;want&nbsp;to&nbsp;send&nbsp;it&nbsp;to&lt;br&gt;a&nbsp;public&nbsp;mailing&nbsp;list.&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Rodrigo&lt;br&gt;<br>
&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Aug&nbsp;15,&nbsp;2008&nbsp;at&nbsp;8:22&nbsp;PM,&nbsp;Casey&nbsp;Marshall&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:casey.s.marshall@gmail.com&quot;&gt;casey.s.marshall@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;Zoltan&nbsp;Varga&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&amp;nbsp;Try&nbsp;running&nbsp;the&nbsp;app&nbsp;with&nbsp;G_SLICE=always-malloc.&nbsp;That&nbsp;would&nbsp;force&lt;br&gt;<br>
glib&nbsp;to&nbsp;allocate&nbsp;all&lt;br&gt;<br>
memory&nbsp;using&nbsp;malloc,&nbsp;helping&nbsp;valgrind&nbsp;to&nbsp;produce&nbsp;more&nbsp;meaningful&nbsp;leak&nbsp;reports.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;&lt;/div&gt;<br>
That&nbsp;was&nbsp;immensely&nbsp;helpful!&nbsp;It&nbsp;now&nbsp;looks&nbsp;like&nbsp;it&amp;#39;s&nbsp;leaking&nbsp;information&nbsp;about&nbsp;function&nbsp;pointers-to-delegates&nbsp;--&nbsp;created&nbsp;by&nbsp;Marshal.GetFunctionPointerForDelegate.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;trace&nbsp;is&nbsp;showing&nbsp;it&nbsp;leaking&nbsp;in&nbsp;my&nbsp;Perforce&nbsp;interop&nbsp;code,&nbsp;but&nbsp;I&amp;#39;m&nbsp;pretty&nbsp;sure&nbsp;other&nbsp;sources&nbsp;are&nbsp;leaking&nbsp;these,&nbsp;too:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
==31524==&nbsp;466,386,527&nbsp;bytes&nbsp;in&nbsp;19,432,782&nbsp;blocks&nbsp;are&nbsp;indirectly&nbsp;lost&nbsp;in&nbsp;loss&nbsp;record&nbsp;231&nbsp;of&nbsp;232&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;at&nbsp;0x4C22FAB:&nbsp;malloc&nbsp;(vg_replace_malloc.c:207)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x5069EBB:&nbsp;g_malloc&nbsp;(in&nbsp;/usr/lib/libglib-2.0.so.0.1600.4)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x50810EE:&nbsp;g_strdup&nbsp;(in&nbsp;/usr/lib/libglib-2.0.so.0.1600.4)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x47FA32:&nbsp;mono_mb_new&nbsp;(method-builder.c:86)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x479977:&nbsp;mono_marshal_get_managed_wrapper&nbsp;(marshal.c:8970)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x479DA2:&nbsp;mono_delegate_to_ftnptr&nbsp;(marshal.c:688)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x8F58757:&nbsp;(wrapper&nbsp;managed-to-native)&nbsp;System.Object:__icall_wrapper_mono_delegate_to_ftnptr&nbsp;(object)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x178FD277:&nbsp;P4API.ClientUser:SwigDirectorConnect&nbsp;()&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x178FB25B:&nbsp;P4API.ClientUser:.ctor&nbsp;()&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x4C78EC:&nbsp;mono_runtime_invoke_array&nbsp;(object.c:3214)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x4DA29F:&nbsp;ves_icall_InternalInvoke&nbsp;(icall.c:3016)&lt;br&gt;<br>
==31524==&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;by&nbsp;0x8BAC75F:&nbsp;(wrapper&nbsp;managed-to-native)&nbsp;System.Reflection.MonoCMethod:InternalInvoke&nbsp;(object,object[],System.Exception&amp;amp;)&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
I&amp;#39;ve&nbsp;disabled&nbsp;my&nbsp;Perforce&nbsp;code,&nbsp;and&nbsp;am&nbsp;running&nbsp;it&nbsp;again&nbsp;to&nbsp;make&nbsp;sure,&nbsp;but&nbsp;it&nbsp;does&nbsp;still&nbsp;look&nbsp;like&nbsp;it&amp;#39;s&nbsp;leaking.&lt;br&gt;<br>
&lt;br&gt;<br>
Is&nbsp;this&nbsp;comment,&nbsp;from&nbsp;mono/metadata/loader.c,&nbsp;in&nbsp;mono_free_method,&nbsp;related?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;if&nbsp;(method-&amp;gt;signature)&nbsp;{&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;/*&nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;*&nbsp;FIXME:&nbsp;This&nbsp;causes&nbsp;crashes&nbsp;because&nbsp;the&nbsp;types&nbsp;inside&nbsp;signatures&nbsp;and&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;*&nbsp;locals&nbsp;are&nbsp;shared.&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;*/&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;/*&nbsp;mono_metadata_free_method_signature&nbsp;(method-&amp;gt;signature);&nbsp;*/&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;/*&nbsp;g_free&nbsp;(method-&amp;gt;signature);&nbsp;*/&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
Thanks.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
