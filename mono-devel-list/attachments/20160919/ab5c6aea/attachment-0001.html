<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;Pablo,&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;believe&nbsp;I’m&nbsp;experiencing&nbsp;a&nbsp;similar&nbsp;issue,&nbsp;also&nbsp;reported&nbsp;by&nbsp;others&nbsp;here:&nbsp;&lt;a&nbsp;href=&quot;https://bugzilla.xamarin.com/show_bug.cgi?id=43902&quot;&nbsp;class=&quot;&quot;&gt;https://bugzilla.xamarin.com/show_bug.cgi?id=43902&lt;/a&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Mono’s&nbsp;Socket.Send&nbsp;doesn’t&nbsp;block&nbsp;until&nbsp;all&nbsp;data&nbsp;is&nbsp;sent.&nbsp;&nbsp;The&nbsp;old&nbsp;NetworkStream&nbsp;in&nbsp;mono&nbsp;used&nbsp;to&nbsp;account&nbsp;for&nbsp;this&nbsp;with&nbsp;a&nbsp;while&nbsp;loop&nbsp;to&nbsp;continue&nbsp;sending,&nbsp;but&nbsp;the&nbsp;NetworkStream&nbsp;from&nbsp;MS&nbsp;Reference&nbsp;Source&nbsp;expects&nbsp;the&nbsp;Socket&nbsp;to&nbsp;block&nbsp;until&nbsp;all&nbsp;data&nbsp;is&nbsp;sent.&nbsp;&nbsp;When&nbsp;the&nbsp;reference&nbsp;source&nbsp;was&nbsp;pulled&nbsp;in,&nbsp;the&nbsp;Socket.Send&nbsp;could&nbsp;sometimes&nbsp;fail&nbsp;to&nbsp;send&nbsp;all&nbsp;the&nbsp;data.&nbsp;&nbsp;I&nbsp;can’t&nbsp;ever&nbsp;make&nbsp;this&nbsp;failure&nbsp;occur&nbsp;on&nbsp;localhost,&nbsp;but&nbsp;it&nbsp;will&nbsp;occur&nbsp;for&nbsp;me&nbsp;communicating&nbsp;with&nbsp;remote&nbsp;hosts.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I’m&nbsp;working&nbsp;on&nbsp;a&nbsp;PR&nbsp;now&nbsp;to&nbsp;have&nbsp;Socket.Send_internal&nbsp;loop&nbsp;until&nbsp;all&nbsp;data&nbsp;is&nbsp;sent&nbsp;so&nbsp;Socket.Send&nbsp;will&nbsp;block&nbsp;as&nbsp;the&nbsp;reference&nbsp;source&nbsp;expects&nbsp;it&nbsp;to,&nbsp;unless&nbsp;anyone&nbsp;else&nbsp;has&nbsp;any&nbsp;suggestions.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-Dave&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Sep&nbsp;19,&nbsp;2016,&nbsp;at&nbsp;9:33&nbsp;AM,&nbsp;&lt;a&nbsp;href=&quot;mailto:psantosl@codicesoftware.com&quot;&nbsp;class=&quot;&quot;&gt;psantosl@codicesoftware.com&lt;/a&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;&lt;div&nbsp;bgcolor=&quot;#FFFFFF&quot;&nbsp;text=&quot;#000000&quot;&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;font&nbsp;face=&quot;Corbel&quot;&nbsp;class=&quot;&quot;&gt;Hi,&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;have&nbsp;found&nbsp;a&nbsp;potential&nbsp;issue&nbsp;with&nbsp;NetworkStream&nbsp;on&nbsp;ARM<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Raspberry).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;It&nbsp;might&nbsp;be&nbsp;a&nbsp;stupid&nbsp;bug&nbsp;on&nbsp;my&nbsp;code&nbsp;too,&nbsp;but&nbsp;I&nbsp;don't&nbsp;see&nbsp;it.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;short:&nbsp;a&nbsp;simple&nbsp;multi-threaded&nbsp;server&nbsp;running&nbsp;on&nbsp;Raspberry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(same&nbsp;behavior&nbsp;on&nbsp;Mono&nbsp;4.4.0&nbsp;as&nbsp;Mono&nbsp;4.6.0),&nbsp;client&nbsp;on&nbsp;W10:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;Fails&lt;/b&gt;&nbsp;to&nbsp;correctly&nbsp;send&nbsp;data&nbsp;using&nbsp;NetworkStream<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(server&nbsp;seems&nbsp;to&nbsp;send&nbsp;the&nbsp;data,&nbsp;but&nbsp;it&nbsp;never&nbsp;arrives&nbsp;to&nbsp;client).<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs&quot;&gt;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master/Program.cs&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.1.&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;Fails&lt;/b&gt;&nbsp;*only*&nbsp;using&nbsp;NetworkStream&nbsp;(no&nbsp;BufferedStream<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;BinaryReader/Writer&nbsp;around,&nbsp;and&nbsp;it&nbsp;still&nbsp;fails):<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs&quot;&gt;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-only-network-stream/Program.cs&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;Works&nbsp;correctly&nbsp;using&nbsp;Sockets&nbsp;(no&nbsp;streams&nbsp;on&nbsp;top).<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs&quot;&gt;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-socket-only/Program.cs&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;Works&nbsp;correctly&nbsp;using&nbsp;a&nbsp;custom&nbsp;NetworkStream:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.1.&nbsp;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs&quot;&gt;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/Program.cs&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.2.&nbsp;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs&quot;&gt;https://github.com/psantosl/mono-raspberry-socket-issue/blob/master-use-alternative-network-stream/MyNetworkStream.cs&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.3.&nbsp;Although&nbsp;I&nbsp;just&nbsp;saw&nbsp;it&nbsp;timing&nbsp;out&nbsp;after&nbsp;transferring&nbsp;several<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hundred&nbsp;MB&nbsp;on&nbsp;each&nbsp;connection&nbsp;(I'm&nbsp;on&nbsp;a&nbsp;slow&nbsp;VPN&nbsp;connected&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Raspberry,&nbsp;although&nbsp;we&nbsp;reproduced&nbsp;it&nbsp;on&nbsp;LAN&nbsp;too).&nbsp;Interestingly,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;using&nbsp;the&nbsp;regular&nbsp;NetworkStream&nbsp;it&nbsp;fails&nbsp;inmediately.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When&nbsp;it&nbsp;fails,&nbsp;what&nbsp;happens&nbsp;is&nbsp;that&nbsp;at&nbsp;a&nbsp;given&nbsp;point&nbsp;in&nbsp;time&nbsp;(in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my&nbsp;tests&nbsp;like&nbsp;in&nbsp;a&nbsp;few&nbsp;seconds)&nbsp;one&nbsp;of&nbsp;the&nbsp;client&nbsp;threads&nbsp;(or&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;than&nbsp;one)&nbsp;NEVER&nbsp;exits&nbsp;the&nbsp;Read,&nbsp;data&nbsp;never&nbsp;arrives&nbsp;although&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server&nbsp;log&nbsp;says&nbsp;the&nbsp;data&nbsp;was&nbsp;written,&nbsp;but&nbsp;it&nbsp;doesn't.&nbsp;Since&nbsp;I've<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set&nbsp;a&nbsp;timeout&nbsp;for&nbsp;the&nbsp;read&nbsp;operation,&nbsp;you&nbsp;see&nbsp;how&nbsp;the&nbsp;program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stops&nbsp;working.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;==&nbsp;Addi&lt;/b&gt;&lt;b&nbsp;class=&quot;&quot;&gt;tional&nbsp;tests&nbsp;performed&nbsp;==&lt;/b&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;tried&nbsp;with&nbsp;different&nbsp;buffer&nbsp;sizes,&nbsp;it&nbsp;always&nbsp;fails&nbsp;with&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NetworkStream.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;ran&nbsp;the&nbsp;same&nbsp;server&nbsp;code&nbsp;on&nbsp;other&nbsp;setups:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Window&nbsp;10/.NET:&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;OK&lt;/b&gt;.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;OpenSuse&nbsp;13.2&nbsp;+&nbsp;mono&nbsp;4.0.4&nbsp;(Stable&nbsp;4.0.4.1/5ab4c0d):&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;OK&lt;/b&gt;.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Raspberry:&nbsp;failed&nbsp;both&nbsp;with&nbsp;mono&nbsp;4.4.0&nbsp;and&nbsp;mono-4.6.0.245&nbsp;(built<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;GitHub&nbsp;on&nbsp;the&nbsp;746756c&nbsp;commit.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;originally&nbsp;discovered&nbsp;the&nbsp;issue&nbsp;running&nbsp;a&nbsp;Plastic&nbsp;SCM&nbsp;server&nbsp;on<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://www.bananapi.org/&quot;&nbsp;class=&quot;&quot;&gt;BananaPi&lt;/a&gt;&nbsp;(like&nbsp;a&nbsp;Raspberry<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;SATA).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;b&nbsp;class=&quot;&quot;&gt;==&nbsp;Extra&nbsp;notes&nbsp;==&lt;/b&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;I&nbsp;know&nbsp;the&nbsp;multi-threaded&nbsp;server&nbsp;is&nbsp;not&nbsp;optimal&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thread-per-connection&nbsp;is&nbsp;really&nbsp;bad,&nbsp;this&nbsp;is&nbsp;just&nbsp;a&nbsp;test&nbsp;case.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Initially&nbsp;I&nbsp;thought&nbsp;we&nbsp;had&nbsp;an&nbsp;issue&nbsp;with&nbsp;async&nbsp;sockets,&nbsp;but<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;after&nbsp;a&nbsp;few&nbsp;days&nbsp;I&nbsp;just&nbsp;isolated&nbsp;the&nbsp;problem&nbsp;in&nbsp;NetworkStream.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Any&nbsp;hints&nbsp;would&nbsp;be&nbsp;appreciated.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thanks,&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pablo&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;http://www.plasticscm.com/&quot;&gt;www.plasticscm.com&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/font&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
<br>
_______________________________________________&lt;br&nbsp;class=&quot;&quot;&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&nbsp;class=&quot;&quot;&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.dot.net&quot;&nbsp;class=&quot;&quot;&gt;Mono-devel-list@lists.dot.net&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;http://lists.dot.net/mailman/listinfo/mono-devel-list&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
