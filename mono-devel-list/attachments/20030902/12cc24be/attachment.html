<tt>
&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;utf-8&quot;?&gt;<br>
&lt;html&nbsp;xmlns=&quot;http://www.w3.org/1999/xhtml&quot;<br>
&nbsp;&nbsp;&nbsp;xmlns:monodoc=&quot;http://www.go-mono.org/xml/monodoc&quot;&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;title&gt;Managed&nbsp;Code&nbsp;Interop&lt;/title&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;name=&quot;DC.Description&quot;&nbsp;content=&quot;Managed&nbsp;and&nbsp;Unmanaged&nbsp;Code&nbsp;Integration&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;name=&quot;DC.Contributor&quot;&nbsp;content=&quot;Jonathan&nbsp;Pryor&quot;/&gt;<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
&lt;h1&gt;Everything&nbsp;You&nbsp;(Never?)&nbsp;Wanted&nbsp;to&nbsp;Know&nbsp;About&nbsp;Marshaling&nbsp;<br>
&nbsp;&nbsp;&nbsp;(And&nbsp;Were&nbsp;Afraid&nbsp;To&nbsp;Ask)&lt;/h1&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;http://www.ecma-international.org/publications/standards/ecma-335.htm&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Common&nbsp;Language&nbsp;Infrastructure&lt;/a&gt;&nbsp;<br>
&nbsp;&nbsp;&nbsp;(&lt;acronym&nbsp;title=&quot;Common&nbsp;Language&nbsp;Infrastructure&quot;&gt;CLI&lt;/acronym&gt;)&nbsp;is<br>
&nbsp;&nbsp;&nbsp;designed&nbsp;to&nbsp;make&nbsp;it&nbsp;&quot;easy&quot;&nbsp;to&nbsp;interoperate&nbsp;with&nbsp;existing&nbsp;code.&nbsp;&nbsp;In&nbsp;principal,<br>
&nbsp;&nbsp;&nbsp;all&nbsp;you&nbsp;need&nbsp;to&nbsp;do&nbsp;is&nbsp;create&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.DllImportAttribute&quot;&gt;DllImport&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;function&nbsp;declaration&nbsp;for&nbsp;the&nbsp;legacy<br>
&nbsp;&nbsp;&nbsp;code&nbsp;to&nbsp;invoke,&nbsp;and&nbsp;the&nbsp;runtime&nbsp;will&nbsp;handle&nbsp;the&nbsp;rest.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;simple-dllimport&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[System.Runtime.InteropServices.DllImport&nbsp;(&quot;libc.so&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;int&nbsp;getpid&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;above&nbsp;C#&nbsp;function&nbsp;declaration&nbsp;would&nbsp;invoke&nbsp;the&nbsp;POSIX<br>
&nbsp;&nbsp;&nbsp;getpid(2)&nbsp;system&nbsp;call&nbsp;on&nbsp;platforms&nbsp;that&nbsp;have&nbsp;the&nbsp;libc.so&nbsp;library&nbsp;(other<br>
&nbsp;&nbsp;&nbsp;platforms&nbsp;would&nbsp;generate&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.MissingMethodException&quot;&gt;MissingMethodException&lt;/a&gt;).&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;Simple.&nbsp;&nbsp;Straightforward.&nbsp;&nbsp;What&nbsp;could&nbsp;be&nbsp;easier?&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;most&nbsp;existing&nbsp;code&nbsp;is&nbsp;far&nbsp;more&nbsp;complex.&nbsp;&nbsp;Strings&nbsp;will<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;be&nbsp;passed,&nbsp;structures&nbsp;may&nbsp;need&nbsp;to&nbsp;be&nbsp;passed,&nbsp;memory&nbsp;management<br>
&nbsp;&nbsp;&nbsp;practices&nbsp;will&nbsp;become&nbsp;involved...&nbsp;&nbsp;Existing&nbsp;code&nbsp;is&nbsp;a&nbsp;complex&nbsp;beast,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;interop&nbsp;layer&nbsp;needs&nbsp;to&nbsp;support&nbsp;this&nbsp;complexity.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&gt;Marshaling&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;How&nbsp;does&nbsp;code&nbsp;interop&nbsp;work?&nbsp;&nbsp;Given&nbsp;a&nbsp;managed&nbsp;call&nbsp;site&nbsp;(the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;call),&nbsp;and&nbsp;an&nbsp;unmanaged&nbsp;callee&nbsp;site&nbsp;(the&nbsp;function&nbsp;that's&nbsp;being&nbsp;called),&nbsp;each<br>
&nbsp;&nbsp;&nbsp;parameter&nbsp;in&nbsp;the&nbsp;call&nbsp;site&nbsp;is&nbsp;&quot;marshaled&quot;&nbsp;(converted)&nbsp;into&nbsp;an&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;equivalent.&nbsp;&nbsp;The&nbsp;marshaled&nbsp;data&nbsp;is&nbsp;in&nbsp;turn&nbsp;placed&nbsp;on&nbsp;the&nbsp;runtime&nbsp;stack<br>
&nbsp;&nbsp;&nbsp;(along&nbsp;with&nbsp;other&nbsp;data),&nbsp;and&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;is&nbsp;invoked.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;complexity&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;marshaling.&nbsp;&nbsp;For&nbsp;simple&nbsp;types,&nbsp;such&nbsp;as&nbsp;<br>
&nbsp;&nbsp;&nbsp;integers&nbsp;and&nbsp;floating-point&nbsp;numbers,&nbsp;marshaling&nbsp;is&nbsp;a&nbsp;bitwise-copy<br>
&nbsp;&nbsp;&nbsp;(&quot;blitting&quot;),&nbsp;just&nbsp;as&nbsp;would&nbsp;be&nbsp;the&nbsp;case&nbsp;for&nbsp;unmanaged&nbsp;code.&nbsp;&nbsp;String&nbsp;types<br>
&nbsp;&nbsp;&nbsp;introduce&nbsp;additional&nbsp;complexity,&nbsp;as&nbsp;you&nbsp;need&nbsp;to&nbsp;specify&nbsp;the&nbsp;form&nbsp;of&nbsp;string<br>
&nbsp;&nbsp;&nbsp;conversion.&nbsp;&nbsp;The&nbsp;runtime&nbsp;stores&nbsp;strings&nbsp;as&nbsp;UTF-16-encoded&nbsp;strings,&nbsp;and&nbsp;these<br>
&nbsp;&nbsp;&nbsp;will&nbsp;likely&nbsp;need&nbsp;to&nbsp;be&nbsp;marshaled&nbsp;to&nbsp;a&nbsp;more&nbsp;appropriate&nbsp;form&nbsp;(ANSI&nbsp;strings,<br>
&nbsp;&nbsp;&nbsp;UTF-8&nbsp;encoded&nbsp;strings,&nbsp;etc.).&nbsp;&nbsp;Strings&nbsp;get&nbsp;special&nbsp;support.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Marshaling&nbsp;behavior&nbsp;is&nbsp;controlled&nbsp;through&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.DllImportAttribute&quot;&gt;DllImport&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.MarshalAsAttribute&quot;&gt;MarshalAs&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;attributes.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&gt;Strings&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Strings&nbsp;are&nbsp;special.&nbsp;&nbsp;String&nbsp;marshaling&nbsp;behavior&nbsp;is&nbsp;also&nbsp;highly&nbsp;platform&nbsp;<br>
&nbsp;&nbsp;&nbsp;dependent.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;String&nbsp;marshaling&nbsp;for&nbsp;a&nbsp;function&nbsp;call&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;declaration&nbsp;with&nbsp;the&nbsp;DllImport&nbsp;attribute,&nbsp;by&nbsp;setting&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.DllImportAttribute.CharSet&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;CharSet&lt;/a&gt;&nbsp;field.&nbsp;&nbsp;The&nbsp;default&nbsp;value&nbsp;for&nbsp;this&nbsp;field&nbsp;is&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.CharSet.Auto&quot;&gt;CharSet.Auto&lt;/a&gt;,&nbsp;<br>
&nbsp;&nbsp;&nbsp;which&nbsp;implies&nbsp;&quot;magic.&quot;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Some&nbsp;background.&nbsp;&nbsp;The&nbsp;Microsoft&nbsp;Win32&nbsp;API&nbsp;supports&nbsp;two&nbsp;forms&nbsp;of&nbsp;strings,<br>
&nbsp;&nbsp;&nbsp;ANSI&nbsp;(localized)&nbsp;strings&nbsp;and&nbsp;Unicode&nbsp;strings.&nbsp;&nbsp;It&nbsp;supports&nbsp;these&nbsp;string<br>
&nbsp;&nbsp;&nbsp;formats&nbsp;by&nbsp;appending&nbsp;an&nbsp;&quot;A&quot;&nbsp;for&nbsp;Ansi&nbsp;string&nbsp;APIs&nbsp;and&nbsp;a&nbsp;&quot;W&quot;&nbsp;(&quot;wide&quot;)&nbsp;for&nbsp;<br>
&nbsp;&nbsp;&nbsp;Unicode&nbsp;string&nbsp;APIs.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Consider&nbsp;this&nbsp;Win32&nbsp;API&nbsp;description:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;text-out-marshaling&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[System.Runtime.InteropServices.DllImport&nbsp;(&quot;gdi32.dll&quot;,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CharSet=CharSet.Auto,&nbsp;CallingConvention=CallingConvention.StdCall)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;bool&nbsp;TextOut&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.IntPtr&nbsp;hdc,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;nXStart,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;nYStart,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;lpString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;cbString);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;When&nbsp;TextOut&nbsp;is&nbsp;called,&nbsp;the&nbsp;&quot;magic&quot;&nbsp;properties&nbsp;of&nbsp;String&nbsp;marshaling<br>
&nbsp;&nbsp;&nbsp;become&nbsp;apparent.&nbsp;&nbsp;The&nbsp;runtime&nbsp;will&nbsp;look&nbsp;for&nbsp;these&nbsp;functions,&nbsp;in&nbsp;this&nbsp;order,<br>
&nbsp;&nbsp;&nbsp;inside&nbsp;the&nbsp;gdi32.dll&nbsp;library:&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;ol&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOutW&nbsp;for&nbsp;Unicode&nbsp;string&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOutA&nbsp;for&nbsp;Ansi&nbsp;string&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOut&nbsp;with&nbsp;the&nbsp;platform-default&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;runtime&nbsp;will&nbsp;use&nbsp;the&nbsp;first&nbsp;function&nbsp;that&nbsp;it&nbsp;finds&nbsp;in&nbsp;that&nbsp;list.<br>
&nbsp;&nbsp;&nbsp;Unicode&nbsp;marshaling&nbsp;is&nbsp;preferred,&nbsp;as&nbsp;(ideally)&nbsp;the&nbsp;System.String&nbsp;can&nbsp;be<br>
&nbsp;&nbsp;&nbsp;passed&nbsp;as-is&nbsp;to&nbsp;the&nbsp;function,&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;function&nbsp;doesn't&nbsp;modify&nbsp;the<br>
&nbsp;&nbsp;&nbsp;string&nbsp;parameter.&nbsp;&nbsp;Ansi&nbsp;marshalling&nbsp;will&nbsp;require&nbsp;translating&nbsp;the&nbsp;Unicode<br>
&nbsp;&nbsp;&nbsp;string&nbsp;into&nbsp;an&nbsp;8-bit&nbsp;string&nbsp;(or&nbsp;DBCS,&nbsp;depending&nbsp;on&nbsp;the&nbsp;country)&nbsp;<br>
&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;users&nbsp;locale.&nbsp;&nbsp;Most&nbsp;(all?)&nbsp;of&nbsp;the&nbsp;time,<br>
&nbsp;&nbsp;&nbsp;this&nbsp;WILL&nbsp;NOT&nbsp;be&nbsp;UTF-8,&nbsp;so&nbsp;you&nbsp;CAN&nbsp;NOT&nbsp;assume&nbsp;that&nbsp;CharSet.Ansi&nbsp;will<br>
&nbsp;&nbsp;&nbsp;generate&nbsp;UTF-8-encoded&nbsp;strings.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Perhaps&nbsp;in&nbsp;the&nbsp;future&nbsp;the&nbsp;CharSet&nbsp;enumeration&nbsp;will&nbsp;contain&nbsp;more&nbsp;choices,<br>
&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;UnicodeLE&nbsp;(little-endian),&nbsp;UnicodeBE&nbsp;(big-endian),&nbsp;Utf7,&nbsp;Utf8,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;other&nbsp;common&nbsp;choices.&nbsp;&nbsp;Additionally,&nbsp;making&nbsp;such&nbsp;a&nbsp;change&nbsp;would&nbsp;also<br>
&nbsp;&nbsp;&nbsp;likely&nbsp;require&nbsp;changing&nbsp;the&nbsp;UnmanagedType&nbsp;enumeration.&nbsp;&nbsp;However,&nbsp;these&nbsp;would&nbsp;<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;go&nbsp;through&nbsp;ECMA,&nbsp;so&nbsp;it&nbsp;won't&nbsp;happen&nbsp;next&nbsp;week.&nbsp;&nbsp;(Unless&nbsp;some&nbsp;time&nbsp;<br>
&nbsp;&nbsp;&nbsp;has&nbsp;passed&nbsp;since&nbsp;this&nbsp;was&nbsp;originally&nbsp;written,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;may&nbsp;very&nbsp;<br>
&nbsp;&nbsp;&nbsp;well&nbsp;be&nbsp;next&nbsp;week.&nbsp;&nbsp;But&nbsp;don't&nbsp;count&nbsp;on&nbsp;it.)&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;More&nbsp;Control&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Using&nbsp;the&nbsp;DllImport&nbsp;attribute&nbsp;works&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;control&nbsp;all&nbsp;the<br>
&nbsp;&nbsp;&nbsp;strings&nbsp;in&nbsp;a&nbsp;function,&nbsp;but&nbsp;what&nbsp;if&nbsp;you&nbsp;need&nbsp;more&nbsp;control?&nbsp;&nbsp;You&nbsp;would&nbsp;need<br>
&nbsp;&nbsp;&nbsp;more&nbsp;control&nbsp;if&nbsp;a&nbsp;string&nbsp;is&nbsp;a&nbsp;member&nbsp;of&nbsp;a&nbsp;structure,&nbsp;or&nbsp;if&nbsp;the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;uses&nbsp;multiple&nbsp;different&nbsp;types&nbsp;of&nbsp;strings&nbsp;as&nbsp;parameters.&nbsp;&nbsp;In&nbsp;these<br>
&nbsp;&nbsp;&nbsp;circumstances,&nbsp;the&nbsp;MarshalAsAttribute&nbsp;can&nbsp;be&nbsp;used,&nbsp;setting&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;P:System.Runtime.InteropServices.MarshalAsAttribute.Value&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Value&lt;/a&gt;&nbsp;property&nbsp;(which&nbsp;is&nbsp;set&nbsp;in&nbsp;the&nbsp;constructor)<br>
&nbsp;&nbsp;&nbsp;to&nbsp;a&nbsp;value&nbsp;from&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;E:System.Runtime.InteropServices.UnmanagedType&quot;&gt;UnmanagedType&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;enumeration.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;mixed-string-marshaling&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;does-not-exist&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;void&nbsp;Foo&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPStr)]&nbsp;string&nbsp;ansiString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPWStr)]&nbsp;string&nbsp;unicodeString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPTStr)]&nbsp;string&nbsp;platformString);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;As&nbsp;you&nbsp;can&nbsp;guess&nbsp;by&nbsp;reading&nbsp;the&nbsp;example,&nbsp;UnmanagedType.LPStr&nbsp;will<br>
&nbsp;&nbsp;&nbsp;marshal&nbsp;the&nbsp;input&nbsp;string&nbsp;into&nbsp;an&nbsp;Ansi&nbsp;string,&nbsp;UnmanagedType.LPWStr&nbsp;will<br>
&nbsp;&nbsp;&nbsp;marshal&nbsp;the&nbsp;input&nbsp;string&nbsp;into&nbsp;a&nbsp;Unicode&nbsp;string&nbsp;(effectively&nbsp;doing<br>
&nbsp;&nbsp;&nbsp;nothing),&nbsp;and&nbsp;UnmanagedType.LPTStr&nbsp;will&nbsp;convert&nbsp;the&nbsp;string&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;platform's&nbsp;default&nbsp;string&nbsp;encoding.&nbsp;&nbsp;For&nbsp;all&nbsp;flavors&nbsp;of&nbsp;Windows&nbsp;NT&nbsp;(Windows<br>
&nbsp;&nbsp;&nbsp;NT&nbsp;3.51&nbsp;and&nbsp;4.0,&nbsp;Windows&nbsp;2000,&nbsp;Windows&nbsp;XP,&nbsp;Windows&nbsp;Server&nbsp;2003)&nbsp;the<br>
&nbsp;&nbsp;&nbsp;platform&nbsp;default&nbsp;encoding&nbsp;is&nbsp;Unicode,&nbsp;while&nbsp;for&nbsp;all&nbsp;Windows&nbsp;9x&nbsp;flavors<br>
&nbsp;&nbsp;&nbsp;(Windows&nbsp;95,&nbsp;98,&nbsp;ME)&nbsp;the&nbsp;platform&nbsp;default&nbsp;encoding&nbsp;is&nbsp;Ansi.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;other&nbsp;UnmangedType&nbsp;string&nbsp;marshaling&nbsp;options,&nbsp;but&nbsp;they're<br>
&nbsp;&nbsp;&nbsp;primarily&nbsp;of&nbsp;interest&nbsp;in&nbsp;COM&nbsp;Interop&nbsp;(BStr,&nbsp;AnsiBStr,&nbsp;TBStr).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;Does&nbsp;anybody&nbsp;know&nbsp;the&nbsp;default&nbsp;encoding&nbsp;for&nbsp;Unix&nbsp;platforms?&nbsp;&nbsp;I&nbsp;<br>
&nbsp;&nbsp;&nbsp;would&nbsp;guess&nbsp;Ansi&nbsp;as&nbsp;well...&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;If&nbsp;UnmanagedType&nbsp;doesn't&nbsp;provide&nbsp;enough&nbsp;flexibility&nbsp;for&nbsp;your&nbsp;string<br>
&nbsp;&nbsp;&nbsp;marshaling&nbsp;needs&nbsp;(for&nbsp;example,&nbsp;you're&nbsp;wrapping&nbsp;GTK+&nbsp;and&nbsp;you&nbsp;need&nbsp;to&nbsp;marshal<br>
&nbsp;&nbsp;&nbsp;strings&nbsp;in&nbsp;UTF-8&nbsp;format),&nbsp;look&nbsp;at&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;#custom-marshal&quot;&gt;Custom<br>
&nbsp;&nbsp;&nbsp;Marshaling&lt;/a&gt;&nbsp;section.<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Passing&nbsp;Caller-Modifiable&nbsp;Strings&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;A&nbsp;common&nbsp;C&nbsp;idiom&nbsp;is&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;provide&nbsp;the&nbsp;callee&nbsp;a&nbsp;buffer&nbsp;to<br>
&nbsp;&nbsp;&nbsp;fill.&nbsp;&nbsp;For&nbsp;exmple,&nbsp;consider&nbsp;strncpy(3):&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;strncpy-c-prototype&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;strncpy&nbsp;(char&nbsp;*dest,&nbsp;const&nbsp;char&nbsp;*src,&nbsp;size_t&nbsp;n);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;We&nbsp;can't&nbsp;use&nbsp;System.String&nbsp;for&nbsp;both&nbsp;parameters,&nbsp;as&nbsp;strings&nbsp;are<br>
&nbsp;&nbsp;&nbsp;immutable.&nbsp;&nbsp;This&nbsp;is&nbsp;OK&nbsp;for&nbsp;&quot;src&quot;,&nbsp;but&nbsp;&quot;dest&quot;&nbsp;will&nbsp;be&nbsp;modified,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;caller&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;see&nbsp;the&nbsp;modification.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;solution&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Text.StringBuilder&quot;&gt;System.Text.StringBuilder&lt;/a&gt;,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;gets&nbsp;special&nbsp;marshaling&nbsp;support&nbsp;from&nbsp;the&nbsp;runtime.&nbsp;&nbsp;This&nbsp;would&nbsp;allow<br>
&nbsp;&nbsp;&nbsp;strncpy(3)&nbsp;to&nbsp;be&nbsp;wrapped&nbsp;and&nbsp;used&nbsp;as:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;strncpy-csharp-prototype&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;libc.so&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;void&nbsp;strncpy&nbsp;(StringBuilder&nbsp;dest,&nbsp;string&nbsp;src,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint&nbsp;n);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;UseStrncpy&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;sb&nbsp;=&nbsp;new&nbsp;StringBuilder&nbsp;(256);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy&nbsp;(sb,&nbsp;&quot;this&nbsp;is&nbsp;the&nbsp;source&nbsp;string&quot;,&nbsp;sb.Capacity);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine&nbsp;(sb.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Some&nbsp;things&nbsp;to&nbsp;note&nbsp;is&nbsp;that&nbsp;the&nbsp;return&nbsp;value&nbsp;of&nbsp;strncpy(3)&nbsp;was&nbsp;changed<br>
&nbsp;&nbsp;&nbsp;to&nbsp;&quot;void&quot;,&nbsp;as&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;specify&nbsp;that&nbsp;the&nbsp;return&nbsp;value&nbsp;will&nbsp;be&nbsp;the<br>
&nbsp;&nbsp;&nbsp;same&nbsp;pointer&nbsp;address&nbsp;as&nbsp;the&nbsp;input&nbsp;&quot;dest&quot;&nbsp;string&nbsp;buffer,&nbsp;and&nbsp;thus&nbsp;it&nbsp;doesn't<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;be&nbsp;marshalled.&nbsp;&nbsp;If&nbsp;&quot;string&quot;&nbsp;were&nbsp;used&nbsp;instead,&nbsp;an&nbsp;extra&nbsp;copy&nbsp;of&nbsp;the<br>
&nbsp;&nbsp;&nbsp;return&nbsp;value&nbsp;would&nbsp;be&nbsp;made.&nbsp;&nbsp;The&nbsp;StringBuilder&nbsp;is&nbsp;allocated&nbsp;with&nbsp;the<br>
&nbsp;&nbsp;&nbsp;correct&nbsp;amount&nbsp;of&nbsp;storage&nbsp;as&nbsp;a&nbsp;constructor&nbsp;parameter,&nbsp;and&nbsp;this&nbsp;amount&nbsp;of<br>
&nbsp;&nbsp;&nbsp;storage&nbsp;is&nbsp;passed&nbsp;to&nbsp;strncpy(3)&nbsp;to&nbsp;prevent&nbsp;buffer&nbsp;overflow.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;TODO&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;What's&nbsp;the&nbsp;memory&nbsp;management&nbsp;policy&nbsp;for&nbsp;using&nbsp;&quot;string&quot;&nbsp;as&nbsp;a&nbsp;return<br>
&nbsp;&nbsp;&nbsp;value?&nbsp;&nbsp;Does&nbsp;the&nbsp;runtime&nbsp;expect&nbsp;to&nbsp;free&nbsp;it?&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpcondefaultmarshalingforstrings.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;MSDN:&nbsp;Default&nbsp;marshaling&nbsp;for&nbsp;Strings&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&gt;Class&nbsp;and&nbsp;Structure&nbsp;Marshaling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Conceptually,&nbsp;classes&nbsp;and&nbsp;structures&nbsp;are&nbsp;marshalled&nbsp;to&nbsp;native&nbsp;code<br>
&nbsp;&nbsp;&nbsp;by:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ol&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;runtime&nbsp;allocates&nbsp;a&nbsp;chunk&nbsp;of&nbsp;unmanaged&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;managed&nbsp;class&nbsp;data&nbsp;is&nbsp;copied&nbsp;into&nbsp;the&nbsp;unmanaged&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;unmanaged&nbsp;function&nbsp;is&nbsp;invoked,&nbsp;passing&nbsp;it&nbsp;the&nbsp;unmanaged&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;information&nbsp;instead&nbsp;of&nbsp;the&nbsp;managed&nbsp;memory&nbsp;information.&nbsp;&nbsp;This&nbsp;must&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;done&nbsp;so&nbsp;that&nbsp;if&nbsp;a&nbsp;GC&nbsp;occurs,&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;doesn't&nbsp;need&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worry&nbsp;about&nbsp;it.&nbsp;&nbsp;(And&nbsp;yes,&nbsp;you&nbsp;need&nbsp;to&nbsp;worry&nbsp;about&nbsp;GCs,&nbsp;as&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unmanaged&nbsp;function&nbsp;could&nbsp;call&nbsp;back&nbsp;into&nbsp;the&nbsp;runtime,&nbsp;generating&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GC.)&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;copied&nbsp;into&nbsp;managed&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;principal&nbsp;difference&nbsp;between&nbsp;class&nbsp;and&nbsp;structure&nbsp;marshaling&nbsp;is&nbsp;which<br>
&nbsp;&nbsp;&nbsp;of&nbsp;these&nbsp;conceptual&nbsp;steps&nbsp;actually&nbsp;occurs.&nbsp;:-)&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Class&nbsp;Marshaling&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Remember&nbsp;that&nbsp;classes&nbsp;are&nbsp;heap-allocated&nbsp;and&nbsp;garbage-collected&nbsp;in&nbsp;the<br>
&nbsp;&nbsp;&nbsp;CLI.&nbsp;&nbsp;As&nbsp;such,&nbsp;you&nbsp;cannot&nbsp;pass&nbsp;classes&nbsp;by&nbsp;value&nbsp;to&nbsp;unmanaged&nbsp;functions,<br>
&nbsp;&nbsp;&nbsp;only&nbsp;by&nbsp;reference:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;class-marshal-example&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;a,&nbsp;b,&nbsp;c;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;WRONG&nbsp;(struct&nbsp;UnamangedStruct&nbsp;pass_by_value)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;RIGHT&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*pass_by_reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;means&nbsp;that&nbsp;you&nbsp;cannot&nbsp;use&nbsp;classes&nbsp;to&nbsp;invoke&nbsp;unmanaged&nbsp;functions<br>
&nbsp;&nbsp;&nbsp;that&nbsp;expect&nbsp;a&nbsp;stack-allocated&nbsp;variable&nbsp;(such&nbsp;as&nbsp;the&nbsp;WRONG&nbsp;function,<br>
&nbsp;&nbsp;&nbsp;above).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;other&nbsp;issues&nbsp;with&nbsp;classes.&nbsp;&nbsp;First&nbsp;of&nbsp;all,&nbsp;classes&nbsp;by<br>
&nbsp;&nbsp;&nbsp;default&nbsp;use&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Auto&quot;&gt;Auto&lt;/a&gt;&nbsp;layout.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;the&nbsp;ordering&nbsp;of&nbsp;class&nbsp;data&nbsp;members&nbsp;is&nbsp;unknown,&nbsp;and&nbsp;won't&nbsp;be<br>
&nbsp;&nbsp;&nbsp;determined&nbsp;at&nbsp;runtime.&nbsp;&nbsp;The&nbsp;runtime&nbsp;can&nbsp;rearrange&nbsp;the&nbsp;order&nbsp;of&nbsp;members&nbsp;in<br>
&nbsp;&nbsp;&nbsp;any&nbsp;way&nbsp;it&nbsp;chooses,&nbsp;to&nbsp;optimize&nbsp;for&nbsp;access&nbsp;time&nbsp;or&nbsp;data&nbsp;layout&nbsp;space.&nbsp;&nbsp;As<br>
&nbsp;&nbsp;&nbsp;such,&nbsp;you&nbsp;MUST&nbsp;use&nbsp;the&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;T:System.Runtime.InteropServices.StructLayoutAttribute&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;StructLayoutAttribute&lt;/a&gt;&nbsp;and&nbsp;specify&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;E:System.Runtime.InteropServices.LayoutKind&quot;&gt;LayoutKind&lt;/a&gt;&nbsp;value<br>
&nbsp;&nbsp;&nbsp;of&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Sequential&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Sequential&lt;/a&gt;&nbsp;or&nbsp;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Explicit&quot;&gt;Explicit&lt;/a&gt;.<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Secondly,&nbsp;classes&nbsp;(again,&nbsp;by&nbsp;default)&nbsp;only&nbsp;have&nbsp;in-bound&nbsp;marshaling.<br>
&nbsp;&nbsp;&nbsp;That&nbsp;is,&nbsp;Step&nbsp;4&nbsp;(copying&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;representation&nbsp;back&nbsp;into&nbsp;<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;memory)&nbsp;is&nbsp;ommitted.&nbsp;&nbsp;If&nbsp;you&nbsp;need&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;to&nbsp;be&nbsp;copied<br>
&nbsp;&nbsp;&nbsp;back&nbsp;into&nbsp;managed&nbsp;memory,&nbsp;you&nbsp;must&nbsp;addorn&nbsp;the&nbsp;DllImport&nbsp;function<br>
&nbsp;&nbsp;&nbsp;declaration&nbsp;argument&nbsp;with&nbsp;an&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.OutAttribute&quot;&gt;Out&lt;/a&gt;&nbsp;attribute.<br>
&nbsp;&nbsp;&nbsp;You&nbsp;will&nbsp;also&nbsp;need&nbsp;to&nbsp;use&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.InAttribute&quot;&gt;In&lt;/a&gt;&nbsp;attribute&nbsp;if<br>
&nbsp;&nbsp;&nbsp;you&nbsp;want&nbsp;copy-in&nbsp;and&nbsp;copy-out&nbsp;behavior.&nbsp;&nbsp;To&nbsp;summarize:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Using&nbsp;[In]&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;not&nbsp;specifying&nbsp;any&nbsp;parameter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes,&nbsp;and&nbsp;will&nbsp;skip&nbsp;Step&nbsp;4&nbsp;(copying&nbsp;unmanaged&nbsp;memory&nbsp;into<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;managed&nbsp;memory).&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Using&nbsp;[Out]&nbsp;will&nbsp;skip&nbsp;Step&nbsp;2&nbsp;(copying&nbsp;managed&nbsp;memory&nbsp;into&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memory).&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Use&nbsp;[In,&nbsp;Out]&nbsp;to&nbsp;both&nbsp;copy&nbsp;managed&nbsp;memory&nbsp;to&nbsp;unmanaged&nbsp;memory&nbsp;before<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;call,&nbsp;and&nbsp;then&nbsp;copy&nbsp;unmanaged&nbsp;memory&nbsp;back&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;managed&nbsp;memory&nbsp;after&nbsp;the&nbsp;function&nbsp;call.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Structure&nbsp;Marshaling&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;primary&nbsp;differences&nbsp;between&nbsp;classes&nbsp;and&nbsp;structures.<br>
&nbsp;&nbsp;&nbsp;First,&nbsp;structures&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;allocated&nbsp;on&nbsp;the&nbsp;heap;&nbsp;they&nbsp;can&nbsp;be<br>
&nbsp;&nbsp;&nbsp;stack&nbsp;allocated.&nbsp;&nbsp;Secondly,&nbsp;they&nbsp;use&nbsp;Sequential&nbsp;LayoutKind&nbsp;by&nbsp;default,&nbsp;so<br>
&nbsp;&nbsp;&nbsp;structure&nbsp;declarations&nbsp;do&nbsp;not&nbsp;need&nbsp;any&nbsp;additional&nbsp;attributes&nbsp;to&nbsp;use&nbsp;them<br>
&nbsp;&nbsp;&nbsp;with&nbsp;unmanaged&nbsp;code&nbsp;(assuming&nbsp;that&nbsp;the&nbsp;default&nbsp;sequential&nbsp;layout&nbsp;rules&nbsp;are<br>
&nbsp;&nbsp;&nbsp;correct&nbsp;for&nbsp;the&nbsp;unmanaged&nbsp;structure).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;These&nbsp;differences&nbsp;permit&nbsp;structures&nbsp;to&nbsp;be&nbsp;passed&nbsp;by-value&nbsp;to&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;functions,&nbsp;unlike&nbsp;classes.&nbsp;&nbsp;Additionally,&nbsp;since&nbsp;structures&nbsp;are&nbsp;typically<br>
&nbsp;&nbsp;&nbsp;located&nbsp;on&nbsp;the&nbsp;stack&nbsp;(unless&nbsp;they're&nbsp;boxed&nbsp;or&nbsp;part&nbsp;of&nbsp;a&nbsp;class&nbsp;instance),&nbsp;if<br>
&nbsp;&nbsp;&nbsp;you&nbsp;pass&nbsp;a&nbsp;structure&nbsp;to&nbsp;an&nbsp;unmanaged&nbsp;function&nbsp;by-reference,&nbsp;the&nbsp;structure<br>
&nbsp;&nbsp;&nbsp;will&nbsp;be&nbsp;passed&nbsp;directly&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;function,&nbsp;without&nbsp;an&nbsp;intermediate<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;memory&nbsp;copy.&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;you&nbsp;may&nbsp;not&nbsp;need&nbsp;to&nbsp;specify&nbsp;the&nbsp;Out<br>
&nbsp;&nbsp;&nbsp;attribute&nbsp;to&nbsp;see&nbsp;changes&nbsp;made&nbsp;by&nbsp;unmanaged&nbsp;code.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Summary&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;It's&nbsp;always&nbsp;easier&nbsp;to&nbsp;show&nbsp;the&nbsp;code,&nbsp;so...&nbsp;&nbsp;Given&nbsp;the&nbsp;following<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;code&nbsp;definition:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-unmanaged-code&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByValue&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByReference&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*s);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;class&nbsp;wrapper&nbsp;would&nbsp;be:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-class-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout&nbsp;(LayoutKind.Sequential)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ClassWrapper&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;n;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;cannot&nbsp;wrap&nbsp;function&nbsp;PassByValue&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReference&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReference&nbsp;([In,&nbsp;Out]&nbsp;ClassWrapper&nbsp;s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;While&nbsp;the&nbsp;structure&nbsp;wrapper&nbsp;would&nbsp;be:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-struct-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;StructWrapper&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;n;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByValue&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByValue&nbsp;(StructWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReference&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReference&nbsp;(ref&nbsp;StructWrapper&nbsp;s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;TODO&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;How&nbsp;are&nbsp;return&nbsp;values&nbsp;handled?&nbsp;&nbsp;What&nbsp;are&nbsp;the&nbsp;differences&nbsp;between&nbsp;classes<br>
&nbsp;&nbsp;&nbsp;and&nbsp;structures?&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&gt;Marshaling&nbsp;Class&nbsp;and&nbsp;Structure&nbsp;Members&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Aside&nbsp;from&nbsp;the&nbsp;major&nbsp;differences&nbsp;between&nbsp;classes&nbsp;and&nbsp;structures&nbsp;outlined<br>
&nbsp;&nbsp;&nbsp;above,&nbsp;the&nbsp;members&nbsp;of&nbsp;classes&nbsp;and&nbsp;structures&nbsp;are&nbsp;marshaled&nbsp;identically.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;general&nbsp;rule&nbsp;of&nbsp;advice&nbsp;is&nbsp;this:&nbsp;never&nbsp;pass&nbsp;classes&nbsp;or&nbsp;structures<br>
&nbsp;&nbsp;&nbsp;containing&nbsp;members&nbsp;of&nbsp;reference&nbsp;type&nbsp;(classes)&nbsp;to&nbsp;unmanaged&nbsp;code.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;because&nbsp;unmanaged&nbsp;code&nbsp;can't&nbsp;do&nbsp;anything&nbsp;safely&nbsp;with&nbsp;the&nbsp;unmanaged&nbsp;<br>
&nbsp;&nbsp;&nbsp;reference&nbsp;(pointer),&nbsp;and&nbsp;the&nbsp;CLI&nbsp;runtime&nbsp;doesn't&nbsp;do&nbsp;a&nbsp;&quot;deep&nbsp;marshal&quot;<br>
&nbsp;&nbsp;&nbsp;(marshal&nbsp;members&nbsp;of&nbsp;marshaled&nbsp;classes,&nbsp;and&nbsp;their&nbsp;members,&nbsp;ad<br>
&nbsp;&nbsp;&nbsp;infinitum).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;immediate&nbsp;net&nbsp;effect&nbsp;of&nbsp;this&nbsp;is&nbsp;that&nbsp;you&nbsp;can't&nbsp;have&nbsp;string&nbsp;and&nbsp;array<br>
&nbsp;&nbsp;&nbsp;members&nbsp;of&nbsp;marshaled&nbsp;classes.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;It's&nbsp;not&nbsp;quite&nbsp;as&nbsp;bad&nbsp;as&nbsp;this&nbsp;makes&nbsp;out.&nbsp;&nbsp;You&nbsp;can't&nbsp;pass&nbsp;strings&nbsp;and<br>
&nbsp;&nbsp;&nbsp;arrays&nbsp;BY&nbsp;DEFAULT.&nbsp;&nbsp;If&nbsp;you&nbsp;help&nbsp;the&nbsp;runtime&nbsp;marshaler&nbsp;by&nbsp;addorning&nbsp;the<br>
&nbsp;&nbsp;&nbsp;members&nbsp;with&nbsp;the&nbsp;MarshalAs&nbsp;attribute,&nbsp;the&nbsp;marshaler&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;to<br>
&nbsp;&nbsp;&nbsp;do&nbsp;and&nbsp;you&nbsp;can&nbsp;live&nbsp;life&nbsp;peacefully&nbsp;with&nbsp;the&nbsp;ever-present&nbsp;strings&nbsp;and<br>
&nbsp;&nbsp;&nbsp;arrays.&nbsp;&nbsp;Alternatively,&nbsp;string&nbsp;marshaling&nbsp;can&nbsp;also&nbsp;be&nbsp;set&nbsp;by&nbsp;setting&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.StructLayoutAttribute.CharSet&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;CharSet&lt;/a&gt;&nbsp;member&nbsp;on&nbsp;the&nbsp;StructLayout&nbsp;attribute&nbsp;for&nbsp;the&nbsp;class&nbsp;or<br>
&nbsp;&nbsp;&nbsp;structure.&lt;/a&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Unions&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;A&nbsp;C&nbsp;union&nbsp;(in&nbsp;which&nbsp;multiple&nbsp;members&nbsp;share&nbsp;the&nbsp;same&nbsp;offset&nbsp;into&nbsp;a<br>
&nbsp;&nbsp;&nbsp;structure)&nbsp;can&nbsp;be&nbsp;simulated&nbsp;by&nbsp;using&nbsp;the&nbsp;FieldOffset&nbsp;attribute&nbsp;and<br>
&nbsp;&nbsp;&nbsp;specifying&nbsp;the&nbsp;same&nbsp;offset&nbsp;for&nbsp;the&nbsp;union&nbsp;members.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconmarshalingdatawithplatforminvoke.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Marshaling&nbsp;Data&nbsp;with&nbsp;Platform&nbsp;Invoke&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconarrayssample.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Arrays&nbsp;Sample&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Arrays&nbsp;Embedded&nbsp;Within&nbsp;Structures&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;might&nbsp;be&nbsp;of&nbsp;use.&nbsp;&nbsp;From&nbsp;David&nbsp;Jesk&nbsp;<br>
&nbsp;&nbsp;&nbsp;(&lt;a&nbsp;href=&quot;http://www.chat.net/~jeske/&quot;&gt;http://www.chat.net/~jeske/&lt;/a&gt;):<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;time&nbsp;I&nbsp;have&nbsp;some&nbsp;PInvoke&nbsp;information&nbsp;to&nbsp;share,&nbsp;so&nbsp;that&nbsp;when<br>
&nbsp;&nbsp;&nbsp;someone&nbsp;else&nbsp;runs&nbsp;into&nbsp;this&nbsp;issue&nbsp;they&nbsp;can&nbsp;see&nbsp;what&nbsp;I've&nbsp;done.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;my&nbsp;ClearSilver&nbsp;(www.clearsilver.net,&nbsp;an&nbsp;HTML&nbsp;template&nbsp;system)&nbsp;C#<br>
&nbsp;&nbsp;&nbsp;wrapper,&nbsp;I&nbsp;wanted&nbsp;to&nbsp;access&nbsp;this&nbsp;C-struct:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typedef&nbsp;struct&nbsp;_neo_err<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;desc[256];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*func;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;lineno;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;internal&nbsp;use&nbsp;only&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;_neo_err&nbsp;*next;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;NEOERR;<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;My&nbsp;philosophy&nbsp;of&nbsp;using&nbsp;unsafe&nbsp;struct&nbsp;pointers,&nbsp;and&nbsp;just&nbsp;accessing&nbsp;the<br>
&nbsp;&nbsp;&nbsp;struct&nbsp;out&nbsp;in&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;great,&nbsp;and&nbsp;it's&nbsp;exactly&nbsp;what&nbsp;I&nbsp;want<br>
&nbsp;&nbsp;&nbsp;to&nbsp;do.&nbsp;However,&nbsp;handling&nbsp;&quot;char&nbsp;dest[256]&quot;&nbsp;is&nbsp;not&nbsp;straightforward.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;C#&nbsp;arrays&nbsp;are&nbsp;reference&nbsp;types.&nbsp;Using&nbsp;one&nbsp;makes&nbsp;the&nbsp;struct&nbsp;a&nbsp;managed<br>
&nbsp;&nbsp;&nbsp;type,&nbsp;and&nbsp;I&nbsp;can't&nbsp;put&nbsp;the&nbsp;array&nbsp;size&nbsp;in.&nbsp;The&nbsp;following&nbsp;is&nbsp;conceptually<br>
&nbsp;&nbsp;&nbsp;what&nbsp;I&nbsp;want&nbsp;to&nbsp;do,&nbsp;however,&nbsp;it's&nbsp;obviously&nbsp;invalid:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout(LayoutKind.Sequential)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsafe&nbsp;struct&nbsp;NEOERR&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;byte[256]&nbsp;desc;&nbsp;&nbsp;//&nbsp;this&nbsp;is&nbsp;invalid,&nbsp;can't&nbsp;contain&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;const&nbsp;byte&nbsp;*file;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;const&nbsp;byte&nbsp;*func;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;lineno;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;internal&nbsp;use&nbsp;only&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;NEOERR&nbsp;*next;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;dosn't&nbsp;work&nbsp;either:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs&nbsp;(UnmanagedType.LPStr,&nbsp;SizeConst=256)]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;string&nbsp;desc;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Because&nbsp;in&nbsp;this&nbsp;case,&nbsp;I&nbsp;don't&nbsp;want&nbsp;to&nbsp;marshal&nbsp;the&nbsp;data.&nbsp;I&nbsp;just&nbsp;want&nbsp;to<br>
&nbsp;&nbsp;&nbsp;talk&nbsp;to&nbsp;it&nbsp;in&nbsp;place.&nbsp;The&nbsp;solution&nbsp;I&nbsp;could&nbsp;come&nbsp;up&nbsp;with&nbsp;is&nbsp;this:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout(LayoutKind.Explicit)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsafe&nbsp;struct&nbsp;NEOERR&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(0)]&nbsp;public&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(4)]&nbsp;public&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(8)]&nbsp;public&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;public&nbsp;byte[256]&nbsp;dest;&nbsp;&nbsp;//&nbsp;not&nbsp;representable<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(12)]&nbsp;public&nbsp;byte&nbsp;dest_first_char;&nbsp;//&nbsp;use&nbsp;this&nbsp;as&nbsp;an&nbsp;address??<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(268)]&nbsp;public&nbsp;byte&nbsp;*file;&nbsp;//&nbsp;const<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(272)]&nbsp;public&nbsp;byte&nbsp;*func;&nbsp;//&nbsp;const<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(276)]&nbsp;public&nbsp;int&nbsp;lineno;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;UGH!&nbsp;First,&nbsp;this&nbsp;is&nbsp;obviously&nbsp;annoying.&nbsp;Second,&nbsp;the&nbsp;only&nbsp;way&nbsp;I&nbsp;can<br>
&nbsp;&nbsp;&nbsp;figure&nbsp;to&nbsp;get&nbsp;access&nbsp;to&nbsp;&quot;char&nbsp;dest[256]&quot;&nbsp;is&nbsp;to&nbsp;use&nbsp;&quot;char*&nbsp;dest&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&amp;amp;nerr-&amp;gt;dest_first_char;&quot;&nbsp;and&nbsp;then&nbsp;just&nbsp;use&nbsp;dest&nbsp;as&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;string.&nbsp;I've&nbsp;dug&nbsp;through&nbsp;the&nbsp;documentation,&nbsp;and&nbsp;I&nbsp;can't&nbsp;find&nbsp;any<br>
&nbsp;&nbsp;&nbsp;better&nbsp;solution.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Obviously&nbsp;it&nbsp;would&nbsp;be&nbsp;ideal&nbsp;if&nbsp;there&nbsp;were&nbsp;a&nbsp;way&nbsp;to&nbsp;represent&nbsp;a<br>
&nbsp;&nbsp;&nbsp;value-type&nbsp;array.&nbsp;I&nbsp;wonder&nbsp;how&nbsp;Managed&nbsp;C++&nbsp;handles&nbsp;&quot;char&nbsp;foo[256];&quot;&nbsp;in<br>
&nbsp;&nbsp;&nbsp;a&nbsp;struct.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;custom-marshal&quot;&gt;Custom&nbsp;Marshaling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;custom&nbsp;marshaling...&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemruntimeinteropservicesicustommarshalerclasstopic.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;ICustomMarshal&nbsp;Interface&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&gt;Avoiding&nbsp;Marshaling&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Marshaling&nbsp;is&nbsp;no&nbsp;panacea,&nbsp;as&nbsp;marshaling&nbsp;implies&nbsp;copying&nbsp;data.<br>
&nbsp;&nbsp;&nbsp;Marshaling&nbsp;may&nbsp;be&nbsp;problematic&nbsp;because&nbsp;the&nbsp;data&nbsp;translation&nbsp;is&nbsp;a&nbsp;complex,<br>
&nbsp;&nbsp;&nbsp;time-consuming&nbsp;process.&nbsp;&nbsp;Alternativly,&nbsp;it&nbsp;may&nbsp;be&nbsp;problematic&nbsp;<br>
&nbsp;&nbsp;&nbsp;because&nbsp;it&nbsp;isn't&nbsp;possible&nbsp;to&nbsp;copy&nbsp;the&nbsp;data,&nbsp;as&nbsp;the&nbsp;data&nbsp;isn't&nbsp;known&nbsp;or&nbsp;is&nbsp;<br>
&nbsp;&nbsp;&nbsp;likely&nbsp;to&nbsp;change.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;An&nbsp;example&nbsp;of&nbsp;the&nbsp;latter&nbsp;would&nbsp;be&nbsp;the&nbsp;GTK+&nbsp;libraries.&nbsp;&nbsp;GTK+&nbsp;is&nbsp;an<br>
&nbsp;&nbsp;&nbsp;object-oriented&nbsp;toolkit&nbsp;written&nbsp;in&nbsp;C.&nbsp;&nbsp;As&nbsp;with&nbsp;all&nbsp;object-oriented<br>
&nbsp;&nbsp;&nbsp;libraries,&nbsp;there&nbsp;can&nbsp;be&nbsp;an&nbsp;unknown&nbsp;number&nbsp;of&nbsp;derived&nbsp;classes,&nbsp;each&nbsp;of&nbsp;which<br>
&nbsp;&nbsp;&nbsp;having&nbsp;a&nbsp;different&nbsp;class&nbsp;size.&nbsp;&nbsp;Furthermore,&nbsp;class&nbsp;instances&nbsp;are&nbsp;typically<br>
&nbsp;&nbsp;&nbsp;accessed&nbsp;through&nbsp;pointers.&nbsp;&nbsp;As&nbsp;such,&nbsp;marshaling&nbsp;the&nbsp;entire&nbsp;class&nbsp;between<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;and&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;not&nbsp;an&nbsp;option,&nbsp;as&nbsp;a&nbsp;copy&nbsp;isn't&nbsp;desired,<br>
&nbsp;&nbsp;&nbsp;access&nbsp;to&nbsp;the&nbsp;same&nbsp;instance&nbsp;is.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Another&nbsp;example&nbsp;is&nbsp;when&nbsp;using&nbsp;&quot;opaque&quot;&nbsp;data&nbsp;types;&nbsp;that&nbsp;is,&nbsp;types<br>
&nbsp;&nbsp;&nbsp;through&nbsp;which&nbsp;interaction&nbsp;is&nbsp;solely&nbsp;through&nbsp;pointers,&nbsp;and&nbsp;nothing&nbsp;about&nbsp;the<br>
&nbsp;&nbsp;&nbsp;internals&nbsp;of&nbsp;the&nbsp;type&nbsp;is&nbsp;public.&nbsp;&nbsp;This&nbsp;describes&nbsp;a&nbsp;large&nbsp;portion&nbsp;of&nbsp;the<br>
&nbsp;&nbsp;&nbsp;Win32&nbsp;API,&nbsp;where&nbsp;HANDLE&nbsp;is&nbsp;used&nbsp;to&nbsp;represent&nbsp;most&nbsp;objects.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;ways&nbsp;to&nbsp;handle&nbsp;this&nbsp;in&nbsp;C#:&nbsp;the&nbsp;&quot;type-safe&quot;&nbsp;way,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;involves&nbsp;using&nbsp;pointers&nbsp;and&nbsp;the&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;language&nbsp;features,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;CLS-compliant&nbsp;way,&nbsp;which&nbsp;uses&nbsp;System.IntPtr&nbsp;to&nbsp;stand&nbsp;in&nbsp;for&nbsp;a&nbsp;void<br>
&nbsp;&nbsp;&nbsp;pointer.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;effect,&nbsp;the&nbsp;separation&nbsp;between&nbsp;managed&nbsp;and&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;made<br>
&nbsp;&nbsp;&nbsp;explicit.&nbsp;&nbsp;Managed&nbsp;memory&nbsp;remains&nbsp;typesafe,&nbsp;while&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;not<br>
&nbsp;&nbsp;&nbsp;(since&nbsp;&lt;a&nbsp;href=&quot;T:System.IntPtr&quot;&gt;System.IntPtr&lt;/a&gt;&nbsp;is&nbsp;used&nbsp;to&nbsp;point&nbsp;into&nbsp;<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;memory,&nbsp;and&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;ensure&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;what&nbsp;<br>
&nbsp;&nbsp;&nbsp;the&nbsp;System.IntPtr&nbsp;refers&nbsp;to).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Be&nbsp;warned&nbsp;that&nbsp;this&nbsp;may&nbsp;not&nbsp;be&nbsp;safe,&nbsp;if&nbsp;the&nbsp;&quot;unmanaged&quot;&nbsp;memory&nbsp;is&nbsp;itself<br>
&nbsp;&nbsp;&nbsp;garbage&nbsp;collected.&nbsp;&nbsp;This&nbsp;may&nbsp;be&nbsp;the&nbsp;case&nbsp;if&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;handled<br>
&nbsp;&nbsp;&nbsp;by&nbsp;a&nbsp;different&nbsp;runtime&nbsp;system&nbsp;(Python,&nbsp;Ruby,&nbsp;Lisp,&nbsp;etc.)&nbsp;or&nbsp;a&nbsp;garbage<br>
&nbsp;&nbsp;&nbsp;collector&nbsp;is&nbsp;being&nbsp;used&nbsp;(Boehm).&nbsp;&nbsp;If&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;garbage<br>
&nbsp;&nbsp;&nbsp;collected,&nbsp;then&nbsp;the&nbsp;System.IntPtr&nbsp;won't&nbsp;be&nbsp;updated&nbsp;when&nbsp;unmanaged&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;undergoes&nbsp;a&nbsp;garbage&nbsp;collection,&nbsp;resulting&nbsp;in&nbsp;memory&nbsp;corruption.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;For&nbsp;example,&nbsp;given&nbsp;the&nbsp;unmanaged&nbsp;API:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-unmanaged-code&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typedef&nbsp;void*&nbsp;HANDLE;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;CreateItem&nbsp;(HANDLE&nbsp;*item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;DestroyItem&nbsp;(HANDLE&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;GetInfo&nbsp;(HANDLE&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;&quot;type-safe&quot;&nbsp;C#&nbsp;wrapper&nbsp;(using&nbsp;&quot;unsafe&quot;&nbsp;code)&nbsp;is:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-unsafe-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;Item&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;bool&nbsp;CreateItem&nbsp;(out&nbsp;Item*&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;void&nbsp;DestroyItem&nbsp;(Item*&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;int&nbsp;GetInfo&nbsp;(Item*&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ExampleUsage&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;void&nbsp;Main&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item*&nbsp;item&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.CreateItem&nbsp;(out&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n&nbsp;=&nbsp;Item.GetInfo&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Console.WriteLine&nbsp;(&quot;item&nbsp;count:&nbsp;{0}&quot;,&nbsp;n.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.DestroyItem&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;is&nbsp;&quot;type-safe&quot;&nbsp;in&nbsp;that&nbsp;you&nbsp;can't&nbsp;pass&nbsp;arbitrary&nbsp;memory&nbsp;locations&nbsp;to<br>
&nbsp;&nbsp;&nbsp;the&nbsp;static&nbsp;Item&nbsp;functions,&nbsp;you&nbsp;must&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;Item&nbsp;structure.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;isn't&nbsp;a&nbsp;strict&nbsp;amount&nbsp;of&nbsp;type&nbsp;safety,&nbsp;but&nbsp;it&nbsp;is&nbsp;likely&nbsp;to&nbsp;minimize<br>
&nbsp;&nbsp;&nbsp;accidental&nbsp;memory&nbsp;corruption.&nbsp;&nbsp;It's&nbsp;biggest&nbsp;problem&nbsp;is&nbsp;that&nbsp;it&nbsp;uses<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;code,&nbsp;and&nbsp;thus&nbsp;may&nbsp;not&nbsp;be&nbsp;usable&nbsp;from&nbsp;other&nbsp;.NET&nbsp;languages,&nbsp;such<br>
&nbsp;&nbsp;&nbsp;as&nbsp;Visual&nbsp;Basic&nbsp;.NET&nbsp;and&nbsp;JavaScript.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;CLS&nbsp;compliant&nbsp;version&nbsp;uses&nbsp;System.IntPtr&nbsp;to&nbsp;refer&nbsp;to&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;memory.&nbsp;&nbsp;This&nbsp;is&nbsp;similar&nbsp;to&nbsp;what&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.Marshal&quot;&gt;Marshal&lt;/a&gt;&nbsp;class&nbsp;does<br>
&nbsp;&nbsp;&nbsp;to&nbsp;interoperate&nbsp;with&nbsp;unmanaged&nbsp;memory.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-IntPtr-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Item&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;bool&nbsp;CreateItem&nbsp;(out&nbsp;System.IntPtr&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;DestroyItem&nbsp;(System.IntPtr&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;int&nbsp;GetInfo&nbsp;(System.IntPtr&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ExampleUsage&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;void&nbsp;Main&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.IntPtr&nbsp;item&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.CreateItem&nbsp;(out&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n&nbsp;=&nbsp;Item.GetInfo&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Console.WriteLine&nbsp;(&quot;item&nbsp;count:&nbsp;{0}&quot;,&nbsp;n.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.DestroyItem&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;is&nbsp;&quot;unsafe&quot;&nbsp;in&nbsp;that&nbsp;it&nbsp;is<br>
&nbsp;&nbsp;&nbsp;easier&nbsp;to&nbsp;accidently&nbsp;mis-use&nbsp;pointers.&nbsp;&nbsp;For&nbsp;example,&nbsp;if&nbsp;you're&nbsp;using&nbsp;two<br>
&nbsp;&nbsp;&nbsp;different&nbsp;libraries&nbsp;and&nbsp;wrapping&nbsp;them&nbsp;using&nbsp;System.IntPtr,&nbsp;it&nbsp;is&nbsp;possible<br>
&nbsp;&nbsp;&nbsp;to&nbsp;pass&nbsp;an&nbsp;object&nbsp;allocated&nbsp;from&nbsp;one&nbsp;library&nbsp;to&nbsp;a&nbsp;function&nbsp;exported&nbsp;by&nbsp;the<br>
&nbsp;&nbsp;&nbsp;other&nbsp;library,&nbsp;and&nbsp;the&nbsp;CLI&nbsp;Runtime&nbsp;will&nbsp;not&nbsp;catch&nbsp;this&nbsp;error,&nbsp;while&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;code&nbsp;would&nbsp;catch&nbsp;this&nbsp;error.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;However,&nbsp;this&nbsp;isn't&nbsp;normally&nbsp;considered&nbsp;a&nbsp;problem,&nbsp;however,&nbsp;as&nbsp;most<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;code&nbsp;shouldn't&nbsp;interact&nbsp;with&nbsp;P/Invoke&nbsp;code,&nbsp;but&nbsp;should&nbsp;instead<br>
&nbsp;&nbsp;&nbsp;interact&nbsp;with&nbsp;managed&nbsp;wrappers&nbsp;for&nbsp;the&nbsp;unmanaged&nbsp;code,&nbsp;which&nbsp;can&nbsp;provide&nbsp;a<br>
&nbsp;&nbsp;&nbsp;more&nbsp;natural&nbsp;interface&nbsp;to&nbsp;managed&nbsp;clients.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Meaning&nbsp;of&nbsp;&quot;Unsafe&quot;&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;I&nbsp;think&nbsp;the&nbsp;real&nbsp;problem&nbsp;is&nbsp;that&nbsp;&quot;unsafe&quot;&nbsp;is&nbsp;an&nbsp;overloaded&nbsp;term.&nbsp;&nbsp;It&nbsp;can<br>
&nbsp;&nbsp;&nbsp;refer&nbsp;to&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;keyword,&nbsp;and&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as<br>
&nbsp;&nbsp;&nbsp;&quot;anything&nbsp;that&nbsp;isn't&nbsp;safe&quot;,&nbsp;which,&nbsp;as&nbsp;you&nbsp;note,&nbsp;doesn't&nbsp;require&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;keyword.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;So,&nbsp;&quot;unsafe&quot;&nbsp;can&nbsp;mean&nbsp;(a)&nbsp;C#&nbsp;keyword;&nbsp;(b)&nbsp;violates&nbsp;.NET&nbsp;type&nbsp;system<br>
&nbsp;&nbsp;&nbsp;(similar&nbsp;to&nbsp;(a));&nbsp;(c)&nbsp;may&nbsp;be&nbsp;insecure&nbsp;(reading&nbsp;files&nbsp;from&nbsp;a&nbsp;web&nbsp;client);<br>
&nbsp;&nbsp;&nbsp;(d)&nbsp;capable&nbsp;of&nbsp;causing&nbsp;a&nbsp;segfault.&nbsp;&nbsp;There&nbsp;are&nbsp;likely&nbsp;other&nbsp;meanings<br>
&nbsp;&nbsp;&nbsp;people&nbsp;can&nbsp;dream&nbsp;up&nbsp;as&nbsp;well.&nbsp;&nbsp;Note&nbsp;that&nbsp;(d)&nbsp;doesn't&nbsp;imply&nbsp;(b),&nbsp;as&nbsp;far&nbsp;as<br>
&nbsp;&nbsp;&nbsp;.NET&nbsp;is&nbsp;concerned.&nbsp;&nbsp;The&nbsp;runtime&nbsp;could&nbsp;itself&nbsp;have&nbsp;a&nbsp;bug&nbsp;that&nbsp;generates&nbsp;a<br>
&nbsp;&nbsp;&nbsp;segfault,&nbsp;but&nbsp;this&nbsp;doesn't&nbsp;violate&nbsp;the&nbsp;type&nbsp;system.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;IntPtr&nbsp;doesn't&nbsp;require&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;type&nbsp;system,&nbsp;as&nbsp;you&nbsp;can't&nbsp;get<br>
&nbsp;&nbsp;&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;.NET&nbsp;object&nbsp;(unless&nbsp;you&nbsp;&quot;pin&quot;&nbsp;it,&nbsp;which&nbsp;would&nbsp;require<br>
&nbsp;&nbsp;&nbsp;the&nbsp;appropriate&nbsp;Security&nbsp;rights),&nbsp;and&nbsp;is&nbsp;thus&nbsp;principally&nbsp;useful&nbsp;for<br>
&nbsp;&nbsp;&nbsp;interacting&nbsp;with&nbsp;unmanaged&nbsp;code,&nbsp;which&nbsp;exists&nbsp;outside&nbsp;of&nbsp;the&nbsp;.NET&nbsp;type<br>
&nbsp;&nbsp;&nbsp;system.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Surely,&nbsp;this&nbsp;is&nbsp;pure&nbsp;semantics,&nbsp;but&nbsp;I&nbsp;can&nbsp;see&nbsp;the&nbsp;designers<br>
&nbsp;&nbsp;&nbsp;perspective.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;Security&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Well,&nbsp;to&nbsp;speak&nbsp;on&nbsp;.NET's&nbsp;behalf,&nbsp;.NET&nbsp;has&nbsp;a&nbsp;highly&nbsp;flexible&nbsp;security<br>
&nbsp;&nbsp;&nbsp;system.&nbsp;&nbsp;You&nbsp;can't&nbsp;invoke&nbsp;DllImported&nbsp;functions&nbsp;unless&nbsp;your&nbsp;app&nbsp;has&nbsp;the<br>
&nbsp;&nbsp;&nbsp;appropriate&nbsp;security&nbsp;rights&nbsp;--&nbsp;generally,&nbsp;that&nbsp;the&nbsp;app&nbsp;is&nbsp;running&nbsp;on&nbsp;the<br>
&nbsp;&nbsp;&nbsp;local&nbsp;machine.&nbsp;&nbsp;If&nbsp;you're&nbsp;running&nbsp;it&nbsp;from&nbsp;a&nbsp;network&nbsp;share,&nbsp;or&nbsp;from&nbsp;a&nbsp;web<br>
&nbsp;&nbsp;&nbsp;site&nbsp;(similar&nbsp;to&nbsp;Java&nbsp;Applets),&nbsp;then&nbsp;your&nbsp;app&nbsp;will&nbsp;get&nbsp;a<br>
&nbsp;&nbsp;&nbsp;SecurityException.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;You&nbsp;can&nbsp;get&nbsp;lots&nbsp;of&nbsp;security&nbsp;exceptions&nbsp;for&nbsp;various&nbsp;things,&nbsp;actually.&nbsp;<br>
&nbsp;&nbsp;&nbsp;Opening&nbsp;files&nbsp;can&nbsp;generate&nbsp;a&nbsp;security&nbsp;exception,&nbsp;for&nbsp;example.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;System.Security.Permissions.SecurityPermission&nbsp;is&nbsp;needed&nbsp;with<br>
&nbsp;&nbsp;&nbsp;SecurityPermissionFlag.UnmanagedCode&nbsp;specified&nbsp;in&nbsp;order&nbsp;to&nbsp;perform&nbsp;a<br>
&nbsp;&nbsp;&nbsp;P/Invoke.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Programs&nbsp;can't&nbsp;specify&nbsp;this&nbsp;permission,&nbsp;though,&nbsp;they&nbsp;can&nbsp;only&nbsp;request&nbsp;it<br>
&nbsp;&nbsp;&nbsp;(or&nbsp;demand&nbsp;it,&nbsp;and&nbsp;if&nbsp;they&nbsp;can't&nbsp;get&nbsp;it,&nbsp;a&nbsp;SecurityException&nbsp;is<br>
&nbsp;&nbsp;&nbsp;thrown).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Administrators&nbsp;are&nbsp;the&nbsp;people&nbsp;who&nbsp;specify&nbsp;what&nbsp;permissions&nbsp;an<br>
&nbsp;&nbsp;&nbsp;application&nbsp;actually&nbsp;receives.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;That's&nbsp;about&nbsp;the&nbsp;limits&nbsp;of&nbsp;my&nbsp;knowledge&nbsp;--&nbsp;Security&nbsp;isn't&nbsp;my&nbsp;forte.&nbsp;&nbsp;You<br>
&nbsp;&nbsp;&nbsp;might&nbsp;find&nbsp;the&nbsp;following&nbsp;topics&nbsp;interesting.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconrequestingpermissions.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Requesting&nbsp;Permissions&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconsecuritysyntax.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Security&nbsp;Syntax&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconcodeaccesssecurity.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Code&nbsp;Access&nbsp;Security&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconinheritancedemands.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Inheritance&nbsp;Demands&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/csspec/html/vclrfcsharpspec_A_2.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Unsafe&nbsp;Code&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&lt;h2&gt;Thanks&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&lt;p&gt;A&nbsp;large&nbsp;portion&nbsp;of&nbsp;this&nbsp;document&nbsp;was&nbsp;generated&nbsp;as&nbsp;a&nbsp;result&nbsp;of&nbsp;a&nbsp;mono-list<br>
&nbsp;&nbsp;discussion&nbsp;between&nbsp;Jonathan&nbsp;Pryor&nbsp;and&nbsp;David&nbsp;Jeske.&nbsp;&nbsp;See:&nbsp;<br>
&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://lists.ximian.com/archives/public/mono-list/2003-July/014886.html&quot;<br>
&nbsp;&nbsp;&gt;http://lists.ximian.com/archives/public/mono-list/2003-July/014886.html&lt;/a&gt;.<br>
&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>
<br>

</tt>
