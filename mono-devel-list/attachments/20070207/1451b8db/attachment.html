<tt>
Hello,&lt;br&gt;&lt;br&gt;Here&nbsp;is&nbsp;another&nbsp;attempt&nbsp;at&nbsp;this&nbsp;patch.&nbsp;It&nbsp;is&nbsp;a&nbsp;large&nbsp;amount&nbsp;of&nbsp;changes,&nbsp;but&nbsp;the&nbsp;good&nbsp;news&nbsp;is&nbsp;that&nbsp;this&nbsp;largely&nbsp;supports&nbsp;COM&nbsp;Callable&nbsp;Wrappers.&nbsp;So,&nbsp;the&nbsp;functionality&nbsp;here&nbsp;provides&nbsp;~60%&nbsp;of&nbsp;the&nbsp;COM&nbsp;support&nbsp;in&nbsp;the&nbsp;CLR&nbsp;and&nbsp;~90%&nbsp;of&nbsp;the&nbsp;COM&nbsp;support&nbsp;used&nbsp;by&nbsp;most&nbsp;applications.&nbsp;If&nbsp;I&nbsp;need&nbsp;to&nbsp;break&nbsp;this&nbsp;patch&nbsp;down&nbsp;(although&nbsp;alot&nbsp;of&nbsp;the&nbsp;changes&nbsp;are&nbsp;atomic)&nbsp;or&nbsp;change&nbsp;some&nbsp;things&nbsp;let&nbsp;me&nbsp;know.&nbsp;<br>
&lt;br&gt;&lt;br&gt;The&nbsp;only&nbsp;additional&nbsp;change&nbsp;from&nbsp;previous&nbsp;patches&nbsp;that&nbsp;would&nbsp;affect&nbsp;code&nbsp;outside&nbsp;of&nbsp;COM&nbsp;Interop&nbsp;uses&nbsp;is&nbsp;the&nbsp;fact&nbsp;that&nbsp;I&nbsp;cause&nbsp;wrapper&nbsp;methods&nbsp;to&nbsp;have&nbsp;local&nbsp;variables&nbsp;intialized.&nbsp;I&nbsp;was&nbsp;marshalling&nbsp;a&nbsp;local&nbsp;struct&nbsp;variable&nbsp;and&nbsp;ran&nbsp;into&nbsp;it&nbsp;being&nbsp;not&nbsp;initialized.&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;problem,&nbsp;I&nbsp;can&nbsp;work&nbsp;around&nbsp;it.<br>
&lt;br&gt;&lt;br&gt;This&nbsp;code&nbsp;is<br>
contributed&nbsp;under&nbsp;the&nbsp;MIT/X11&nbsp;license,&nbsp;and&nbsp;I&nbsp;signed&nbsp;off&nbsp;in&nbsp;the<br>
ChangeLogs&nbsp;within&nbsp;the&nbsp;runtime&nbsp;code.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;12/5/06,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Paolo&nbsp;Molaro&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&gt;lupus@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
On&nbsp;12/04/06&nbsp;Jon&nbsp;Chambers&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&amp;gt;You&nbsp;can&amp;#39;t&nbsp;insert&nbsp;a&nbsp;managed&nbsp;object&nbsp;inside&nbsp;a&nbsp;GHashTable,&nbsp;since&nbsp;objects&lt;br&gt;&amp;gt;&nbsp;&amp;gt;can&nbsp;move&nbsp;and&nbsp;the&nbsp;GC&nbsp;can&amp;#39;t&nbsp;see&nbsp;inside&nbsp;GHashTable,&nbsp;you&amp;#39;ll&nbsp;get&nbsp;a&nbsp;broken&lt;br&gt;&amp;gt;&nbsp;&amp;gt;pointer&nbsp;and&nbsp;a&nbsp;crash.&nbsp;If&nbsp;the&nbsp;hash&nbsp;must&nbsp;not&nbsp;keep&nbsp;alive&nbsp;the&nbsp;object&nbsp;and&nbsp;you<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;used&nbsp;a&nbsp;GHashTable&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;weak&nbsp;references,&nbsp;you&nbsp;must&nbsp;use&lt;br&gt;&amp;gt;&nbsp;&amp;gt;the&nbsp;runtime&nbsp;support&nbsp;for&nbsp;weak&nbsp;references&nbsp;instead.&nbsp;Also,&nbsp;remember&nbsp;that&nbsp;for&lt;br&gt;&amp;gt;&nbsp;&amp;gt;object&nbsp;hashes&nbsp;you&nbsp;must&nbsp;use&nbsp;the&nbsp;mono_object_hash()&nbsp;function.<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;The&nbsp;object&nbsp;is&nbsp;not&nbsp;put&nbsp;in&nbsp;hashtable,&nbsp;but&nbsp;just&nbsp;used&nbsp;as&nbsp;the&nbsp;key&nbsp;in&nbsp;this&nbsp;case.&nbsp;I&lt;br&gt;&amp;gt;&nbsp;changed&nbsp;the&nbsp;hash&nbsp;table&nbsp;to&nbsp;use&nbsp;mono_object_hash()&nbsp;as&nbsp;the&nbsp;hash&nbsp;function&nbsp;where&lt;br&gt;&amp;gt;&nbsp;the&nbsp;object&nbsp;is&nbsp;the&nbsp;key.&nbsp;I&amp;#39;ve&nbsp;removed&nbsp;the&nbsp;MonoObject*&nbsp;field&nbsp;from&nbsp;the&nbsp;MonoCCW<br>
&lt;br&gt;&amp;gt;&nbsp;struct&nbsp;and&nbsp;just&nbsp;look&nbsp;it&nbsp;up&nbsp;using&nbsp;the&nbsp;gc_handle&nbsp;when&nbsp;needed&nbsp;instead.&lt;br&gt;&lt;br&gt;The&nbsp;key&nbsp;can&nbsp;change&nbsp;if&nbsp;it&nbsp;is&nbsp;an&nbsp;object&nbsp;address,&nbsp;so&nbsp;you&nbsp;may&nbsp;end&nbsp;up&nbsp;not&lt;br&gt;finding&nbsp;the&nbsp;value&nbsp;from&nbsp;a&nbsp;previous&nbsp;object&nbsp;or&nbsp;finding&nbsp;it&nbsp;for&nbsp;an&nbsp;object<br>
&lt;br&gt;that&nbsp;wasn&amp;#39;t&nbsp;registered&nbsp;yet.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;Can&nbsp;you&nbsp;explain&nbsp;this&nbsp;MonoCCW&nbsp;data&nbsp;structure&nbsp;here?&nbsp;It&nbsp;has&nbsp;a&nbsp;pointer&lt;br&gt;&amp;gt;&nbsp;&amp;gt;to&nbsp;a&nbsp;reference&nbsp;which&nbsp;isn&amp;#39;t&nbsp;GC-tracked&nbsp;and&nbsp;so&nbsp;it&amp;#39;s&nbsp;bad.&nbsp;It&nbsp;looks&nbsp;to&nbsp;be&lt;br&gt;&amp;gt;&nbsp;&amp;gt;created&nbsp;with&nbsp;a&nbsp;0&nbsp;refcount&nbsp;and&nbsp;an&nbsp;handle&nbsp;is&nbsp;created&nbsp;for&nbsp;the&nbsp;object,&nbsp;so<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;there&nbsp;doesn&amp;#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;any&nbsp;need&nbsp;to&nbsp;store&nbsp;also&nbsp;an&nbsp;object&nbsp;in&nbsp;it.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;Also,&nbsp;the&nbsp;reference&nbsp;count&nbsp;increase&nbsp;is&nbsp;done&nbsp;in&nbsp;a&nbsp;thread-unsafe&nbsp;way.&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;I&amp;#39;ve&nbsp;removed&nbsp;the&nbsp;object&nbsp;reference.&nbsp;I&nbsp;only&nbsp;allocate&nbsp;a&nbsp;weak&nbsp;handle&nbsp;and&nbsp;set&nbsp;the<br>
&lt;br&gt;&amp;gt;&nbsp;reference&nbsp;count&nbsp;to&nbsp;0.&nbsp;If&nbsp;the&nbsp;unmanaged&nbsp;client&nbsp;code&nbsp;decides&nbsp;to&nbsp;addref&nbsp;and&lt;br&gt;&amp;gt;&nbsp;hold&nbsp;onto&nbsp;the&nbsp;CCW,&nbsp;I&nbsp;then&nbsp;allocate&nbsp;a&nbsp;strong&nbsp;handle.&nbsp;Once&nbsp;the&nbsp;reference&nbsp;count&lt;br&gt;&amp;gt;&nbsp;goes&nbsp;back&nbsp;to&nbsp;0&nbsp;I&nbsp;go&nbsp;back&nbsp;to&nbsp;a&nbsp;weak&nbsp;handle.&lt;br&gt;<br>
&lt;br&gt;Ok,&nbsp;please&nbsp;add&nbsp;the&nbsp;description&nbsp;as&nbsp;a&nbsp;comment.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(mono_marshal_free_ccw&nbsp;(o)&nbsp;&amp;amp;&amp;amp;&nbsp;!finalizer)&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;&amp;gt;So&nbsp;what&nbsp;happens&nbsp;if&nbsp;the&nbsp;object&nbsp;has&nbsp;a&nbsp;finalizer&nbsp;and&nbsp;wants&nbsp;to&nbsp;use&nbsp;COM<br>
&lt;br&gt;&amp;gt;&nbsp;&amp;gt;features&nbsp;in&nbsp;it?&nbsp;Is&nbsp;that&nbsp;not&nbsp;possible?&nbsp;We&nbsp;need&nbsp;a&nbsp;comment&nbsp;here.&lt;br&gt;&amp;gt;&nbsp;&amp;gt;You&nbsp;may&nbsp;also&nbsp;want&nbsp;to&nbsp;check&nbsp;what&nbsp;happens&nbsp;with&nbsp;resurrection&nbsp;(ie&nbsp;the&lt;br&gt;&amp;gt;&nbsp;&amp;gt;objects&nbsp;stores&nbsp;itself&nbsp;in&nbsp;a&nbsp;static&nbsp;field&nbsp;inside&nbsp;the&nbsp;finalizer).<br>
&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;Added&nbsp;better&nbsp;comment.&nbsp;If&nbsp;an&nbsp;object&nbsp;has&nbsp;a&nbsp;CCW&nbsp;associated&nbsp;with&nbsp;it&nbsp;and&nbsp;has&nbsp;no&lt;br&gt;&amp;gt;&nbsp;finalizer&nbsp;we&nbsp;can&nbsp;safely&nbsp;return&nbsp;after&nbsp;destroying&nbsp;the&nbsp;CCW&nbsp;since&nbsp;we&nbsp;are&nbsp;only&lt;br&gt;&amp;gt;&nbsp;being&nbsp;finalized&nbsp;since&nbsp;COM&nbsp;Interop&nbsp;registered&nbsp;the&nbsp;object&nbsp;for&nbsp;finalization&nbsp;to<br>
&lt;br&gt;&amp;gt;&nbsp;clean&nbsp;up&nbsp;the&nbsp;CCW.&nbsp;In&nbsp;all&nbsp;other&nbsp;cases&nbsp;we&nbsp;continue&nbsp;on&nbsp;(including&nbsp;the&nbsp;case&nbsp;you&lt;br&gt;&amp;gt;&nbsp;brought&nbsp;up&nbsp;where&nbsp;an&nbsp;object&nbsp;has&nbsp;a&nbsp;finalizer&nbsp;and&nbsp;has&nbsp;been&nbsp;exposed&nbsp;to&nbsp;unmanaged&lt;br&gt;&amp;gt;&nbsp;code&nbsp;via&nbsp;a&nbsp;CCW)&nbsp;to&nbsp;call&nbsp;the&nbsp;objects&nbsp;finalizer.&nbsp;I&amp;#39;ve&nbsp;added&nbsp;a&nbsp;FIXME&nbsp;for<br>
&lt;br&gt;&amp;gt;&nbsp;resurrection,&nbsp;and&nbsp;also&nbsp;if&nbsp;the&nbsp;user&nbsp;calls&nbsp;SuppressFinalize&nbsp;the&nbsp;CCW&nbsp;will&nbsp;leak&lt;br&gt;&amp;gt;&nbsp;currently.&nbsp;I&nbsp;see&nbsp;what&nbsp;is&nbsp;done&nbsp;for&nbsp;delegates&nbsp;in&nbsp;that&nbsp;case,&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;bit&lt;br&gt;&amp;gt;&nbsp;different.&nbsp;I&nbsp;currently&nbsp;have&nbsp;no&nbsp;way&nbsp;to&nbsp;determine&nbsp;that&nbsp;an&nbsp;object&nbsp;with&nbsp;a<br>
&lt;br&gt;&amp;gt;&nbsp;finalizer&nbsp;needs&nbsp;it&amp;#39;s&nbsp;CCW&nbsp;destroyed&nbsp;but&nbsp;don&amp;#39;t&nbsp;need&nbsp;it&amp;#39;s&nbsp;finalizer&nbsp;run.&lt;br&gt;&lt;br&gt;For&nbsp;delegates&nbsp;we&nbsp;just&nbsp;check&nbsp;and&nbsp;return&nbsp;in&nbsp;SuppressFinalize.&lt;br&gt;You&nbsp;could&nbsp;add&nbsp;a&nbsp;similar&nbsp;check&nbsp;there&nbsp;with&nbsp;the&nbsp;usual&nbsp;fast&nbsp;path&nbsp;for&nbsp;when&nbsp;no<br>
&lt;br&gt;com&nbsp;support&nbsp;has&nbsp;been&nbsp;used.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;Also,&nbsp;there&nbsp;are&nbsp;some&nbsp;places&nbsp;I&nbsp;know&nbsp;I&nbsp;need&nbsp;to&nbsp;make&nbsp;threadsafe.&nbsp;Should&nbsp;I&lt;br&gt;&amp;gt;&nbsp;create&nbsp;a&nbsp;new&nbsp;critical&nbsp;section,&nbsp;or&nbsp;just&nbsp;use&nbsp;the&nbsp;marshal&nbsp;one?&lt;br&gt;&lt;br&gt;Yes,&nbsp;please.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;Index:&nbsp;mono/mono/metadata/marshal.c<br>
&lt;br&gt;&amp;gt;&nbsp;===================================================================&lt;br&gt;&amp;gt;&nbsp;---&nbsp;mono/mono/metadata/marshal.c&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(revision&nbsp;68977)&lt;br&gt;&amp;gt;&nbsp;+++&nbsp;mono/mono/metadata/marshal.c&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;&amp;gt;&nbsp;@@&nbsp;-1823,18&nbsp;+1904,31&nbsp;@@<br>
&lt;br&gt;&amp;gt;&nbsp;@@&nbsp;-2102,20&nbsp;+2196,20&nbsp;@@&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;case&nbsp;MONO_MARSHAL_CONV_OBJECT_INTERFACE:&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;case&nbsp;MONO_MARSHAL_CONV_OBJECT_IDISPATCH:&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;case&nbsp;MONO_MARSHAL_CONV_OBJECT_IUNKNOWN:&nbsp;{&lt;br&gt;&amp;gt;&nbsp;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;guint32&nbsp;pos_failed&nbsp;=&nbsp;0,&nbsp;pos_rcw&nbsp;=&nbsp;0;<br>
&lt;br&gt;&amp;gt;&nbsp;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;char&nbsp;*&nbsp;msg;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;guint32&nbsp;pos_null&nbsp;=&nbsp;0,&nbsp;pos_rcw&nbsp;=&nbsp;0,&nbsp;pos_end&nbsp;=&nbsp;0;&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;/*&nbsp;COM&nbsp;types&nbsp;are&nbsp;initialized&nbsp;lazily&nbsp;*/&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_init_com_types&nbsp;();&lt;br&gt;<br>
&amp;gt;&nbsp;+&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_ldloc&nbsp;(mb,&nbsp;1);&lt;br&gt;&amp;gt;&nbsp;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//mono_mb_emit_ldloc&nbsp;(mb,&nbsp;0);&lt;br&gt;&amp;gt;&nbsp;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_ptr&nbsp;(mb,&nbsp;0);&lt;br&gt;&amp;gt;&nbsp;-&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;//mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_LDIND_U1);&lt;br&gt;<br>
&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_LDNULL);&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_mb_emit_byte&nbsp;(mb,&nbsp;CEE_STIND_I);&lt;br&gt;&lt;br&gt;ldnull&nbsp;loads&nbsp;an&nbsp;object&nbsp;and&nbsp;an&nbsp;object&nbsp;can&amp;#39;t&nbsp;be&nbsp;stored&nbsp;with&nbsp;stind.i:&nbsp;if&lt;br&gt;you&nbsp;really&nbsp;need&nbsp;to&nbsp;store&nbsp;a&nbsp;NULL&nbsp;pointer&nbsp;(and&nbsp;not&nbsp;a&nbsp;null&nbsp;reference),&nbsp;load<br>
&lt;br&gt;a&nbsp;0&nbsp;constant&nbsp;and&nbsp;convert&nbsp;it&nbsp;with&nbsp;conv.u.&nbsp;Otherwise&nbsp;use&nbsp;stind.ref&nbsp;to&lt;br&gt;store&nbsp;a&nbsp;reference.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;@@&nbsp;-3295,6&nbsp;+3413,20&nbsp;@@&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;res;&lt;br&gt;&amp;gt;&amp;nbsp;&amp;nbsp;}&lt;br&gt;&amp;gt;&lt;br&gt;&amp;gt;&nbsp;+/*&nbsp;Maps&nbsp;a&nbsp;managed&nbsp;object&nbsp;to&nbsp;its&nbsp;unmanaged&nbsp;representation<br>
&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*&nbsp;i.e.&nbsp;it&amp;#39;s&nbsp;COM&nbsp;Callable&nbsp;Wrapper&nbsp;(CCW).&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*&nbsp;Key:&nbsp;MonoObject*&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*&nbsp;Value:&nbsp;MonoCCW*&lt;br&gt;&amp;gt;&nbsp;+&nbsp;*/&lt;br&gt;&amp;gt;&nbsp;+static&nbsp;GHashTable*&nbsp;ccw_hash&nbsp;=&nbsp;NULL;&lt;br&gt;&lt;br&gt;As&nbsp;explained&nbsp;above,&nbsp;you&nbsp;can&amp;#39;t&nbsp;really&nbsp;use&nbsp;an&nbsp;object&nbsp;address&nbsp;as&nbsp;the&nbsp;key,<br>
&lt;br&gt;since&nbsp;it&nbsp;changes&nbsp;over&nbsp;time.&nbsp;One&nbsp;possible&nbsp;implementation&nbsp;idea:&nbsp;use&lt;br&gt;mono_object_hash()&nbsp;as&nbsp;the&nbsp;key&nbsp;and&nbsp;a&nbsp;list&nbsp;as&nbsp;the&nbsp;value:&nbsp;you&nbsp;then&nbsp;walk&nbsp;the&lt;br&gt;list&nbsp;and&nbsp;get&nbsp;the&nbsp;object&nbsp;to&nbsp;compare&nbsp;from&nbsp;the&nbsp;GC&nbsp;handle.&nbsp;There&nbsp;may&nbsp;be&nbsp;also<br>
&lt;br&gt;faster&nbsp;ways&nbsp;for&nbsp;sure&nbsp;and&nbsp;if&nbsp;this&nbsp;is&nbsp;accessed&nbsp;during&nbsp;finalizations&nbsp;we&lt;br&gt;should&nbsp;check&nbsp;that&nbsp;the&nbsp;Boehm&nbsp;GC&nbsp;doesn&amp;#39;t&nbsp;null&nbsp;the&nbsp;weak&nbsp;refs&nbsp;before&nbsp;running&lt;br&gt;the&nbsp;finalizers&nbsp;(but&nbsp;I&nbsp;guess&nbsp;that&nbsp;if&nbsp;you&nbsp;find&nbsp;a&nbsp;null&nbsp;target&nbsp;in&nbsp;the&nbsp;gc<br>
&lt;br&gt;handle&nbsp;you&nbsp;can&nbsp;free&nbsp;the&nbsp;ccw&nbsp;struct&nbsp;right&nbsp;away...)&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(!ccw_entry)&nbsp;{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;int&nbsp;vtable_index&nbsp;=&nbsp;method_count-1+start_slot;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_loader_lock&nbsp;();&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;vtable&nbsp;=&nbsp;mono_mempool_alloc0&nbsp;(klass-&amp;gt;image-&amp;gt;mempool,&nbsp;sizeof&nbsp;(gpointer)*(method_count+start_slot));<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;mono_loader_unlock&nbsp;();&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;memcpy(vtable,&nbsp;iunknown,&nbsp;sizeof(iunknown));&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;(start_slot&nbsp;==&nbsp;7)&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;memcpy(vtable+3,&nbsp;idispatch,&nbsp;sizeof(idispatch));<br>
&lt;br&gt;&lt;br&gt;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;the&nbsp;opening&nbsp;parenthesis&nbsp;of&nbsp;a&nbsp;function&nbsp;call.&lt;br&gt;&lt;br&gt;&amp;gt;&nbsp;+static&nbsp;gboolean&lt;br&gt;&amp;gt;&nbsp;+cominterop_class_guid_equal&nbsp;(gpointer&nbsp;guid,&nbsp;MonoClass*&nbsp;klass)&lt;br&gt;&amp;gt;&nbsp;+{&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;static&nbsp;MonoClass&nbsp;*GuidAttribute&nbsp;=&nbsp;NULL;<br>
&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoCustomAttrInfo&nbsp;*cinfo;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoReflectionGuidAttribute&nbsp;*attr;&lt;br&gt;&amp;gt;&nbsp;+&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;MonoString&nbsp;*guid_string&nbsp;=&nbsp;mono_string_new&nbsp;(mono_domain_get&nbsp;(),&nbsp;mono_guid_to_string&nbsp;((guint8*)guid));&lt;br&gt;&lt;br&gt;If&nbsp;guid&nbsp;is&nbsp;a&nbsp;guint8*,&nbsp;change&nbsp;the&nbsp;type&nbsp;from&nbsp;gpointer&nbsp;to&nbsp;it&nbsp;wherever&nbsp;it&nbsp;is<br>
&lt;br&gt;used.&lt;br&gt;&lt;br&gt;Thanks!&lt;br&gt;&lt;br&gt;lupus&lt;br&gt;&lt;br&gt;--&lt;br&gt;-----------------------------------------------------------------&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@debian.org&quot;&gt;lupus@debian.org&lt;/a&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;debian/rules<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&gt;lupus@ximian.com&lt;/a&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Monkeys&nbsp;do&nbsp;it&nbsp;better&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;<br>
Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
