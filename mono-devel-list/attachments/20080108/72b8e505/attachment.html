<tt>
Hello,&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Here&nbsp;is&nbsp;the&nbsp;first&nbsp;attempt&nbsp;at&nbsp;a&nbsp;patch.&nbsp;Nothing&nbsp;is&nbsp;changed&nbsp;with&nbsp;the&nbsp;default&nbsp;configuration.&nbsp;Things&nbsp;are&nbsp;controlled&nbsp;via&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(MONO_COM),&nbsp;and&nbsp;extensible&nbsp;using&nbsp;the&nbsp;dllmap&nbsp;in&nbsp;the&nbsp;config&nbsp;file.&nbsp;The&nbsp;only&nbsp;other&nbsp;current&nbsp;configuration&nbsp;is&nbsp;MONO_MS,&nbsp;which&nbsp;supports&nbsp;Mainsoft&nbsp;COM&nbsp;components.&nbsp;If&nbsp;this&nbsp;looks&nbsp;acceptable,&nbsp;I&nbsp;will&nbsp;cleanup&nbsp;any&nbsp;issues&nbsp;and&nbsp;document&nbsp;the&nbsp;environment&nbsp;variable.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Dec&nbsp;19,&nbsp;2007&nbsp;1:31&nbsp;PM,&nbsp;Jonathan&nbsp;Chambers&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:joncham@gmail.com&quot;&gt;joncham@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;On&nbsp;Dec&nbsp;19,&nbsp;2007&nbsp;11:05&nbsp;AM,&nbsp;Paolo&nbsp;Molaro&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;lupus@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
&lt;div&gt;On&nbsp;12/19/07&nbsp;Jonathan&nbsp;Chambers&nbsp;wrote:&lt;br&gt;&amp;gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;COM&nbsp;Interop&nbsp;support&nbsp;in&nbsp;mono&nbsp;works&nbsp;pretty&nbsp;well&nbsp;for&nbsp;most&nbsp;basic&nbsp;uses,&nbsp;but&lt;br&gt;&amp;gt;&nbsp;has&nbsp;some&nbsp;limitations&nbsp;when&nbsp;it&nbsp;comes&nbsp;to&nbsp;strings.&nbsp;Mainly,&nbsp;BSTR&nbsp;marshalling&nbsp;on<br>
&lt;br&gt;&amp;gt;&nbsp;non-Windows&nbsp;platforms&nbsp;is&nbsp;just&nbsp;a&nbsp;default&nbsp;implementation.&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&lt;br&gt;&amp;gt;&nbsp;most&nbsp;COM&nbsp;systems&nbsp;(both&nbsp;Mainsoft&amp;#39;s&nbsp;COM&nbsp;and&nbsp;Mozilla&amp;#39;s&nbsp;XPCOM)&nbsp;have&nbsp;specific&lt;br&gt;&amp;gt;&nbsp;requirements&nbsp;on&nbsp;strings.&nbsp;They&nbsp;need&nbsp;to&nbsp;follow&nbsp;a&nbsp;certain&nbsp;format&nbsp;(usually&nbsp;a<br>
&lt;br&gt;&amp;gt;&nbsp;length&nbsp;prefixed&nbsp;string),&nbsp;use&nbsp;special&nbsp;allocators/deallocators,&nbsp;and&nbsp;use&nbsp;the&lt;br&gt;&amp;gt;&nbsp;correct&nbsp;byte&nbsp;size&nbsp;(2-byte&nbsp;vs.&nbsp;4-byte&nbsp;encoding).&lt;br&gt;&lt;/div&gt;[...]&lt;br&gt;&lt;div&gt;&amp;gt;&nbsp;1.&nbsp;Expose&nbsp;some&nbsp;methods&nbsp;in&nbsp;the&nbsp;runtime&nbsp;so&nbsp;users&nbsp;could&nbsp;embed&nbsp;mono&nbsp;and&nbsp;adjust<br>
&lt;br&gt;&amp;gt;&nbsp;the&nbsp;BSTR&nbsp;marshalling&nbsp;behavior&nbsp;with&nbsp;callbacks.&nbsp;Something&nbsp;like&lt;br&gt;&amp;gt;&nbsp;mono_set_bstr_to_string_marshal,&nbsp;mono_set_bstr_from_string_marshal,&lt;br&gt;&amp;gt;&nbsp;mono_set_bstr_free.&nbsp;This&nbsp;would&nbsp;require&nbsp;users&nbsp;to&nbsp;embed&nbsp;mono.&lt;br&gt;&amp;gt;<br>
&lt;br&gt;&amp;gt;&nbsp;2.&nbsp;Use&nbsp;the&nbsp;dll&nbsp;map&nbsp;in&nbsp;the&nbsp;config&nbsp;file&nbsp;to&nbsp;let&nbsp;the&nbsp;user&nbsp;specify&nbsp;entry&nbsp;points&lt;br&gt;&amp;gt;&nbsp;to&nbsp;perform&nbsp;BSTR&nbsp;marshalling.&nbsp;This&nbsp;seems&nbsp;a&nbsp;better&nbsp;choice&nbsp;than&nbsp;the&nbsp;first.&lt;br&gt;&amp;gt;&nbsp;There&nbsp;is&nbsp;then&nbsp;a&nbsp;technical&nbsp;question&nbsp;as&nbsp;to&nbsp;how&nbsp;to&nbsp;implement&nbsp;this.<br>
&lt;br&gt;&lt;br&gt;&lt;/div&gt;The&nbsp;second&nbsp;solution&nbsp;would&nbsp;be&nbsp;better&nbsp;as&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;force&nbsp;embedding&nbsp;mono.&lt;br&gt;For&nbsp;this&nbsp;new&nbsp;feature,&nbsp;though,&nbsp;we&amp;#39;d&nbsp;need&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;handle&nbsp;both&lt;br&gt;xpcom&nbsp;and&nbsp;COM&nbsp;at&nbsp;the&nbsp;same&nbsp;time,&nbsp;so&nbsp;a&nbsp;global&nbsp;setting&nbsp;wouldn&amp;#39;t&nbsp;be&nbsp;enough.<br>
&lt;br&gt;Is&nbsp;there&nbsp;a&nbsp;way&nbsp;we&nbsp;could&nbsp;use&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;two&nbsp;cases&nbsp;at&nbsp;the&nbsp;time&lt;br&gt;we&amp;#39;re&nbsp;emitting&nbsp;the&nbsp;marshaling&nbsp;code?&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;Only&nbsp;by&nbsp;flagging&nbsp;the&nbsp;types&nbsp;(at&nbsp;the&nbsp;class/interface&nbsp;level)&nbsp;with&nbsp;some&nbsp;sort&nbsp;of&nbsp;attribute.&nbsp;[ComSystem(&amp;quot;XPCOM&amp;quot;)]&nbsp;or&nbsp;something&nbsp;like&nbsp;that.<br>
&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;br&gt;As&nbsp;for&nbsp;the&nbsp;implementation,&nbsp;we&nbsp;could&nbsp;load&nbsp;a&nbsp;shared&nbsp;library&nbsp;that<br>
&lt;br&gt;implements&nbsp;the&nbsp;needed&nbsp;bstr&nbsp;methods&nbsp;(this&nbsp;is&nbsp;indeed&nbsp;how&nbsp;I&nbsp;planned&nbsp;at&nbsp;the<br>
&lt;br&gt;time&nbsp;the&nbsp;COM&nbsp;support&nbsp;would&nbsp;work),&nbsp;but&nbsp;these&nbsp;shared&nbsp;libs&nbsp;would&nbsp;need&nbsp;to&nbsp;be&lt;br&gt;separate&nbsp;from&nbsp;mono,&nbsp;as&nbsp;we&nbsp;don&amp;#39;t&nbsp;want&nbsp;the&nbsp;mono&nbsp;build&nbsp;to&nbsp;have&nbsp;to&nbsp;depend&nbsp;on&lt;br&gt;xulrunner&nbsp;or&nbsp;com&nbsp;dev&nbsp;libs&nbsp;to&nbsp;be&nbsp;installed.&lt;br&gt;Or&nbsp;we&nbsp;could&nbsp;see&nbsp;if&nbsp;it&amp;#39;s&nbsp;possible&nbsp;to&nbsp;access&nbsp;the&nbsp;stuff&nbsp;we&nbsp;need&nbsp;with<br>
&lt;br&gt;dlopen/dlsym&nbsp;directly&nbsp;on&nbsp;the&nbsp;xpcom/com&nbsp;libs&nbsp;and&nbsp;use&nbsp;that&nbsp;inside&nbsp;the&lt;br&gt;runtime:&nbsp;this&nbsp;ahs&nbsp;the&nbsp;advantage&nbsp;that&nbsp;there&nbsp;is&nbsp;no&nbsp;build&nbsp;or&nbsp;runtime&lt;br&gt;dependency&nbsp;(unless&nbsp;the&nbsp;feature&nbsp;is&nbsp;actually&nbsp;used&nbsp;at&nbsp;runtime)&nbsp;and&nbsp;the&lt;br&gt;small&nbsp;drawback&nbsp;that&nbsp;the&nbsp;two&nbsp;systems&nbsp;are&nbsp;hardcoded&nbsp;(though&nbsp;we&amp;#39;d&nbsp;hope&nbsp;few<br>
&lt;br&gt;other&nbsp;com-like&nbsp;systems&nbsp;will&nbsp;be&nbsp;developed).&lt;/blockquote&gt;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;would&nbsp;work,&nbsp;as&nbsp;I&nbsp;think&nbsp;we&nbsp;would&nbsp;only&nbsp;need&nbsp;a&nbsp;few&nbsp;entry&nbsp;points.&nbsp;COM&nbsp;strings&nbsp;are&nbsp;well&nbsp;defined,&nbsp;but&nbsp;I&nbsp;am&nbsp;not&nbsp;so&nbsp;sure&nbsp;about&nbsp;XPCOM.&nbsp;I&nbsp;think&nbsp;they&nbsp;have&nbsp;a&nbsp;variety&nbsp;of&nbsp;strings,&nbsp;and&nbsp;least&nbsp;historically.&nbsp;Some&nbsp;are&nbsp;not&nbsp;simple&nbsp;strings,&nbsp;but&nbsp;C++&nbsp;classes&nbsp;AFAIK.<br>
&lt;br&gt;&lt;br&gt;I&amp;#39;ll&nbsp;work&nbsp;up&nbsp;a&nbsp;patch&nbsp;and&nbsp;send&nbsp;something&nbsp;in.&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;Jonathan&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
&lt;br&gt;&lt;br&gt;lupus&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;--&lt;br&gt;-----------------------------------------------------------------&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@debian.org&quot;&nbsp;target=&quot;_blank&quot;&gt;lupus@debian.org&lt;/a&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;debian/rules<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:lupus@ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;lupus@ximian.com&lt;/a&gt;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;Monkeys&nbsp;do&nbsp;it&nbsp;better&lt;br&gt;_______________________________________________&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;<br>
<br>
Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;&lt;/font&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;<br>
<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
