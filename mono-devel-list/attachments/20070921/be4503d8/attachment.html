<tt>
Hey&nbsp;guys,&lt;br&gt;&lt;br&gt;The&nbsp;patch&nbsp;if&nbsp;finally&nbsp;done&nbsp;and&nbsp;it&nbsp;works&nbsp;perfectly&nbsp;well&nbsp;against&nbsp;head.&nbsp;This&nbsp;patch&nbsp;turned&nbsp;to&nbsp;be&nbsp;very&nbsp;different&nbsp;from&nbsp;what&nbsp;it&nbsp;started&nbsp;to&nbsp;look&nbsp;like&nbsp;and&nbsp;fortunately&nbsp;this&nbsp;meant&nbsp;a&nbsp;reduction&nbsp;of&nbsp;more&nbsp;than&nbsp;an&nbsp;order&nbsp;of&nbsp;magnitude&nbsp;in&nbsp;its&nbsp;size,&nbsp;from&nbsp;<br>
3.000&nbsp;lines&nbsp;to&nbsp;a&nbsp;bit&nbsp;more&nbsp;than&nbsp;230.&lt;br&gt;&lt;br&gt;To&nbsp;have&nbsp;the&nbsp;patch&nbsp;make&nbsp;sense&nbsp;I&nbsp;need&nbsp;to&nbsp;first&nbsp;define&nbsp;what&nbsp;it&nbsp;fixes.&nbsp;Right&nbsp;now&nbsp;mono&nbsp;treat&nbsp;the&nbsp;generic&nbsp;type&nbsp;definition&nbsp;and&nbsp;the&nbsp;open&nbsp;instantiation&nbsp;over&nbsp;its&nbsp;own&nbsp;parameters&nbsp;(or&nbsp;just&nbsp;open&nbsp;instantiation&nbsp;from&nbsp;now&nbsp;on)&nbsp;as&nbsp;two&nbsp;different&nbsp;classes.&nbsp;For&nbsp;example,&nbsp;given&nbsp;the&nbsp;type&nbsp;&amp;quot;class&nbsp;Example&amp;lt;T,M&amp;gt;&amp;quot;,&nbsp;the&nbsp;generic&nbsp;type&nbsp;definition&nbsp;is&nbsp;&amp;quot;Example`2&amp;quot;&nbsp;and&nbsp;the&nbsp;open&nbsp;instantiation&nbsp;is&nbsp;&amp;quot;Example`2&amp;lt;T,M&amp;gt;&amp;quot;&nbsp;where&nbsp;T&nbsp;and&nbsp;M&nbsp;are&nbsp;the&nbsp;parameters&nbsp;of&nbsp;Example`2.&nbsp;If&nbsp;that&nbsp;doesn&amp;#39;t&nbsp;make&nbsp;much&nbsp;sense,&nbsp;the&nbsp;following&nbsp;code&nbsp;might&nbsp;help:<br>
&lt;br&gt;&lt;br&gt;Type&nbsp;gtd&nbsp;=&nbsp;typeof&nbsp;(Example&amp;lt;,&amp;gt;);&lt;br&gt;Type&nbsp;openInst&nbsp;=&nbsp;gtd.MakeGenericType&nbsp;(gtd.GetGenericArguments&nbsp;());&nbsp;//openInst&nbsp;and&nbsp;gtd&nbsp;should&nbsp;be&nbsp;the&nbsp;same&nbsp;instance&lt;br&gt;&lt;br&gt;This&nbsp;property&nbsp;is&nbsp;very&nbsp;important&nbsp;for&nbsp;all&nbsp;parts&nbsp;of&nbsp;mono&nbsp;that&nbsp;play&nbsp;with&nbsp;raw&nbsp;(non&nbsp;inflated)&nbsp;generic&nbsp;code.&nbsp;Analyzing&nbsp;the&nbsp;IL&nbsp;of&nbsp;generic&nbsp;code&nbsp;ilustrate&nbsp;this&nbsp;issue&nbsp;well&nbsp;better:<br>
&lt;br&gt;&lt;br&gt;.class&nbsp;public&nbsp;A`1&amp;lt;T&amp;gt;&nbsp;extends&nbsp;[mscorlib]System.Object&lt;br&gt;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;.field&amp;nbsp;&nbsp;private&amp;nbsp;&nbsp;!0&nbsp;fld&lt;br&gt;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;.method&nbsp;public&nbsp;instance&nbsp;void&nbsp;Example&nbsp;()<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;{&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;.maxstack&nbsp;2&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;.locals&nbsp;init&nbsp;(&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;!T&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;V_0)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ldarg.0&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ldfld&nbsp;!0&nbsp;class&nbsp;A`1&amp;lt;!0&amp;gt;::fld&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;stloc.0&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;ret&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;}&lt;br&gt;}&lt;br&gt;&lt;br&gt;The&nbsp;current&nbsp;situation&nbsp;is&nbsp;that&nbsp;the&nbsp;non-inflated&nbsp;method&nbsp;Example&nbsp;will&nbsp;be&nbsp;bound&nbsp;to&nbsp;a&nbsp;different&nbsp;MonoClass&nbsp;instance&nbsp;than&nbsp;the&nbsp;token&nbsp;of&nbsp;ldfld.&nbsp;Which&nbsp;will&nbsp;lead&nbsp;the&nbsp;runtime&nbsp;to&nbsp;view&nbsp;it&nbsp;as&nbsp;an&nbsp;error.&nbsp;Right&nbsp;now&nbsp;only&nbsp;the&nbsp;verifier&nbsp;is&nbsp;affected&nbsp;by&nbsp;this&nbsp;situation&nbsp;but&nbsp;I&nbsp;think&nbsp;the&nbsp;generics&nbsp;code&nbsp;sharing&nbsp;work&nbsp;might&nbsp;profit&nbsp;from&nbsp;the&nbsp;fix&nbsp;too.<br>
&lt;br&gt;&lt;br&gt;The&nbsp;original&nbsp;idea&nbsp;of&nbsp;how&nbsp;to&nbsp;fix&nbsp;it&nbsp;was&nbsp;to&nbsp;change&nbsp;the&nbsp;this_arg&nbsp;and&nbsp;byref_arg&nbsp;of&nbsp;the&nbsp;MonoClass&nbsp;struct&nbsp;to&nbsp;have&nbsp;type&nbsp;MONO_TYPE_GENERICINST.&nbsp;With&nbsp;that&nbsp;set,&nbsp;when&nbsp;a&nbsp;generic&nbsp;type&nbsp;was&nbsp;initialized,&nbsp;the&nbsp;open&nbsp;instantation&nbsp;MonoGenericClass&nbsp;would&nbsp;be&nbsp;bound&nbsp;to&nbsp;it.&nbsp;This&nbsp;works&nbsp;quite&nbsp;well&nbsp;except&nbsp;that&nbsp;it&nbsp;introduced&nbsp;a&nbsp;lot&nbsp;of&nbsp;issues.&nbsp;The&nbsp;main&nbsp;one&nbsp;that&nbsp;the&nbsp;container_type&nbsp;of&nbsp;generic&nbsp;instantiations&nbsp;would&nbsp;no&nbsp;longer&nbsp;be&nbsp;a&nbsp;MONO_TYPE_CLASS.<br>
&lt;br&gt;&lt;br&gt;First&nbsp;all&nbsp;code&nbsp;than&nbsp;handled&nbsp;MONO_TYPE_GENERICINST&nbsp;need&nbsp;to&nbsp;be&nbsp;changed&nbsp;to&nbsp;couple&nbsp;with&nbsp;this&nbsp;fact,&nbsp;this&nbsp;required&nbsp;changes&nbsp;across&nbsp;most&nbsp;of&nbsp;metadata&nbsp;and&nbsp;even&nbsp;in&nbsp;mini.c,&nbsp;some&nbsp;places&nbsp;expect&nbsp;a&nbsp;MONO_TYPE_CLASS&nbsp;and&nbsp;don&amp;#39;t&nbsp;even&nbsp;guard&nbsp;the&nbsp;retrieval&nbsp;from&nbsp;the&nbsp;data&nbsp;union&nbsp;of&nbsp;MonoType.&nbsp;This&nbsp;led&nbsp;to&nbsp;many&nbsp;hard&nbsp;to&nbsp;spot&nbsp;bugs.<br>
&lt;br&gt;<br>
&lt;br&gt;The&nbsp;last&nbsp;issue&nbsp;was&nbsp;with&nbsp;TypeBuilders,&nbsp;the&nbsp;way&nbsp;they&nbsp;are&nbsp;currently&nbsp;set,&nbsp;the&nbsp;associated&nbsp;MonoClass&nbsp;cannot&nbsp;be&nbsp;a&nbsp;MONO_TYPE_GENERICINST&nbsp;until&nbsp;CreateType&nbsp;()&nbsp;is&nbsp;called.&nbsp;Changing&nbsp;(this|byval)_arg.type&nbsp;during&nbsp;mono_reflection_create_runtime_class&nbsp;turned&nbsp;to&nbsp;be&nbsp;a&nbsp;bad&nbsp;idea,&nbsp;as&nbsp;it&nbsp;breaks&nbsp;the&nbsp;invariant&nbsp;that&nbsp;once&nbsp;the&nbsp;MonoClass&nbsp;is&nbsp;first&nbsp;initialized&nbsp;it&nbsp;won&amp;#39;t&nbsp;change&nbsp;(this|byval)_arg.type&nbsp;in&nbsp;such&nbsp;drastic&nbsp;way.&nbsp;I&nbsp;had&nbsp;to&nbsp;patch&nbsp;too&nbsp;many&nbsp;places&nbsp;trying&nbsp;to&nbsp;get&nbsp;around&nbsp;this&nbsp;issue.<br>
&lt;br&gt;&lt;br&gt;The&nbsp;bottom&nbsp;line&nbsp;is&nbsp;that&nbsp;this&nbsp;approach&nbsp;won&amp;#39;t&nbsp;work&nbsp;and&nbsp;the&nbsp;resulting&nbsp;patch&nbsp;would&nbsp;introduce&nbsp;a&nbsp;big&nbsp;chunk&nbsp;of&nbsp;new&nbsp;bugs.&nbsp;In&nbsp;the&nbsp;other&nbsp;hand,&nbsp;the&nbsp;runtime&nbsp;seens&nbsp;to&nbsp;be&nbsp;fine&nbsp;with&nbsp;breaking&nbsp;another&nbsp;premise,&nbsp;that&nbsp;all&nbsp;MonoClass&nbsp;instances&nbsp;bould&nbsp;to&nbsp;MonoGenericClass&nbsp;have&nbsp;type&nbsp;MONO_TYPE_GENERICINST.<br>
&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;how&nbsp;it&nbsp;works:&nbsp;when&nbsp;the&nbsp;generic&nbsp;type&nbsp;definition&nbsp;is&nbsp;initialized&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;either&nbsp;mono_reflection_create_runtime_class&nbsp;or&nbsp;mono_class_setup_mono_type,&nbsp;we&nbsp;lookup&nbsp;the&nbsp;open&nbsp;instantiation&nbsp;and&nbsp;bind&nbsp;it&nbsp;-&nbsp;IOW&nbsp;we&nbsp;set&nbsp;MonoGenericClass::cached_class&nbsp;to&nbsp;the&nbsp;<br>
&lt;br&gt;MonoClass&nbsp;instance&nbsp;of&nbsp;the&nbsp;generic&nbsp;type&nbsp;definition.&lt;br&gt;&lt;br&gt;There&nbsp;is&nbsp;one&nbsp;finall&nbsp;twist&nbsp;on&nbsp;this&nbsp;patch,&nbsp;the&nbsp;way&nbsp;System.Reflection.Emit&nbsp;in&nbsp;mono&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;.net.&nbsp;On&nbsp;mono,&nbsp;TypeBuilder::MakeGenericType&nbsp;returns&nbsp;a&nbsp;Type&nbsp;that&nbsp;is&nbsp;functional&nbsp;(one&nbsp;you&nbsp;can&nbsp;call&nbsp;GetConstructors).&nbsp;This&nbsp;means&nbsp;that&nbsp;you&nbsp;cannot&nbsp;have&nbsp;the&nbsp;same&nbsp;behavior&nbsp;that&nbsp;happens&nbsp;with&nbsp;types&nbsp;loaded&nbsp;from&nbsp;an&nbsp;assembly.&nbsp;To&nbsp;get&nbsp;arround&nbsp;this&nbsp;fact,&nbsp;either&nbsp;I&nbsp;could&nbsp;either&nbsp;&amp;quot;fix&amp;quot;&nbsp;gmcs&nbsp;to&nbsp;work&nbsp;with&nbsp;the&nbsp;crippled&nbsp;.net&nbsp;SRE&nbsp;API,&nbsp;or&nbsp;special&nbsp;case&nbsp;for&nbsp;TypeBuilder.&nbsp;I&nbsp;have&nbsp;choosen&nbsp;the&nbsp;later&nbsp;one&nbsp;as&nbsp;it&nbsp;makes&nbsp;more&nbsp;sense.&nbsp;<br>
&lt;br&gt;&lt;br&gt;This&nbsp;mean&nbsp;that&nbsp;in&nbsp;mono_metadata_lookup_generic_class&nbsp;we&nbsp;check&nbsp;if&nbsp;we&nbsp;are&nbsp;looking&nbsp;up&nbsp;the&nbsp;open&nbsp;instantiation&nbsp;of&nbsp;a&nbsp;TypeBuilder&nbsp;and&nbsp;return&nbsp;a&nbsp;MonoGenericClass&nbsp;than&nbsp;won&amp;#39;t&nbsp;be&nbsp;the&nbsp;same&nbsp;for&nbsp;the&nbsp;created&nbsp;type.&lt;br&gt;&lt;br&gt;What&nbsp;could&nbsp;receive&nbsp;some&nbsp;love&nbsp;in&nbsp;the&nbsp;patch&nbsp;is&nbsp;the&nbsp;way&nbsp;the&nbsp;check&nbsp;for&nbsp;the&nbsp;TypeBuilder&nbsp;is&nbsp;done&nbsp;could&nbsp;be&nbsp;optimized&nbsp;by&nbsp;doing&nbsp;pre-calculating&nbsp;it&nbsp;in&nbsp;mono_metadata_get_generic_inst.&nbsp;This&nbsp;could&nbsp;be&nbsp;done&nbsp;if&nbsp;you&nbsp;guys&nbsp;find&nbsp;that&amp;#39;s&nbsp;a&nbsp;good&nbsp;idea,&nbsp;I&amp;#39;m&nbsp;just&nbsp;not&nbsp;sure&nbsp;if&nbsp;it&amp;#39;s&nbsp;work&nbsp;the&nbsp;trouble.&nbsp;Right&nbsp;now&nbsp;the&nbsp;tests&nbsp;are&nbsp;using&nbsp;NUnit,&nbsp;maybe&nbsp;some&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;the&nbsp;regression&nbsp;suite.<br>
&lt;br&gt;&lt;br&gt;&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;<br>

</tt>
