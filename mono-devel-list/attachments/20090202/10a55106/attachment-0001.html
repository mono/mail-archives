<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Feb&nbsp;2,&nbsp;2009&nbsp;at&nbsp;12:38&nbsp;PM,&nbsp;Scott&nbsp;Peterson&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:lunchtimemama@gmail.com&quot;&gt;lunchtimemama@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&amp;gt;&nbsp;Why&nbsp;this&nbsp;change&nbsp;is&nbsp;required&nbsp;to&nbsp;make&nbsp;variance&nbsp;works?&lt;br&gt;<br>
&amp;gt;&nbsp;mono_class_interface_offset&nbsp;is&nbsp;a&nbsp;low&nbsp;level&nbsp;function&nbsp;used&nbsp;mainly&nbsp;to&nbsp;setup&lt;br&gt;<br>
&amp;gt;&nbsp;vtable&nbsp;layout.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;This&nbsp;change&nbsp;affects&nbsp;vtable&nbsp;layout&nbsp;code,&nbsp;remoting&nbsp;and&nbsp;reflection.&nbsp;Without&lt;br&gt;<br>
&amp;gt;&nbsp;proper&nbsp;testing&nbsp;to&nbsp;make&nbsp;sure&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;break&nbsp;stuff&nbsp;and&nbsp;is&nbsp;compatible&nbsp;with&nbsp;MS&lt;br&gt;<br>
&amp;gt;&nbsp;this&nbsp;patch&nbsp;is&nbsp;a&nbsp;no&nbsp;go.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;chicken&nbsp;and&nbsp;egg&nbsp;situation&nbsp;for&nbsp;testing&nbsp;can&nbsp;be&nbsp;overcome&nbsp;by&nbsp;either&nbsp;using&nbsp;IL&lt;br&gt;<br>
&amp;gt;&nbsp;just&nbsp;for&nbsp;the&nbsp;interfaces,&nbsp;the&nbsp;rest&nbsp;can&nbsp;be&nbsp;done&nbsp;with&nbsp;C#;&nbsp;or&nbsp;you&nbsp;can&nbsp;use&lt;br&gt;<br>
&amp;gt;&nbsp;System.Reflection.Emit&nbsp;to&nbsp;build&nbsp;types&nbsp;with&nbsp;variance.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Well,&nbsp;before&nbsp;the&nbsp;change,&nbsp;I&nbsp;tried&nbsp;to&nbsp;execute&nbsp;a&nbsp;legal&nbsp;image&nbsp;with&lt;br&gt;<br>
variance,&nbsp;and&nbsp;got&nbsp;a&nbsp;runtime&nbsp;error&nbsp;from&nbsp;the&nbsp;mini-trampoline&nbsp;code&lt;br&gt;<br>
because&nbsp;mono_class_interface_offset&nbsp;returned&nbsp;negative,&nbsp;meaning&nbsp;that&lt;br&gt;<br>
the&nbsp;offset&nbsp;of&nbsp;the&nbsp;interface&nbsp;for&nbsp;which&nbsp;it&nbsp;was&nbsp;looking&nbsp;could&nbsp;not&nbsp;be&lt;br&gt;<br>
found&nbsp;on&nbsp;the&nbsp;specified&nbsp;type.&nbsp;However&nbsp;the&nbsp;class&nbsp;did&nbsp;implement&nbsp;a&nbsp;variant&lt;br&gt;<br>
interface,&nbsp;so&nbsp;I&nbsp;modified&nbsp;mono_class_interface_offset&nbsp;to&nbsp;look&nbsp;for&lt;br&gt;<br>
variant&nbsp;interfaces&nbsp;if&nbsp;it&nbsp;couldn&amp;#39;t&nbsp;find&nbsp;the&nbsp;interface&nbsp;via&nbsp;the&nbsp;usual&lt;br&gt;<br>
search.&nbsp;There&nbsp;may&nbsp;well&nbsp;be&nbsp;a&nbsp;better&nbsp;place&nbsp;in&nbsp;the&nbsp;VM&nbsp;to&nbsp;handle&nbsp;the&lt;br&gt;<br>
problem:&nbsp;I&nbsp;just&nbsp;followed&nbsp;the&nbsp;stack&nbsp;trace&nbsp;:)&nbsp;I&amp;#39;ll&nbsp;put&nbsp;together&nbsp;an&nbsp;SRE&lt;br&gt;<br>
test&nbsp;for&nbsp;you&nbsp;to&nbsp;look&nbsp;at.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;I&nbsp;gave&nbsp;some&nbsp;thought&nbsp;over&nbsp;lunch&nbsp;to&nbsp;the&nbsp;need&nbsp;for&nbsp;your&nbsp;change&nbsp;and&nbsp;we&nbsp;indeed&nbsp;need&nbsp;something&nbsp;like&nbsp;it.&lt;br&gt;The&nbsp;problem&nbsp;is,&nbsp;I&nbsp;don&amp;#39;t&nbsp;know&nbsp;if&nbsp;all&nbsp;places&nbsp;should&nbsp;be&nbsp;doing&nbsp;a&nbsp;a&nbsp;generic&nbsp;variance&nbsp;aware&nbsp;iface&nbsp;offset&lt;br&gt;<br>
query.&nbsp;The&nbsp;vtable&nbsp;layout&nbsp;code&nbsp;is&nbsp;one&nbsp;place&nbsp;where&nbsp;this&nbsp;sounds&nbsp;as&nbsp;wrong.&lt;br&gt;&lt;br&gt;I&nbsp;think&nbsp;the&nbsp;easer/better&nbsp;solution&nbsp;is&nbsp;to&nbsp;have&nbsp;a&nbsp;variance&nbsp;aware&nbsp;version&nbsp;of&nbsp;mono_class_interface_offset&lt;br&gt;and&nbsp;then&nbsp;incrementally&nbsp;change&nbsp;all&nbsp;spots.&nbsp;This&nbsp;way&nbsp;the&nbsp;testing&nbsp;load&nbsp;will&nbsp;be&nbsp;incremental&nbsp;and&nbsp;we&nbsp;can&lt;br&gt;<br>
start&nbsp;to&nbsp;move&nbsp;forward.&lt;br&gt;&lt;br&gt;&lt;br&gt;<br>

</tt>
