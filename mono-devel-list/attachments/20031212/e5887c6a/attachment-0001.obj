Index: marshal.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/marshal.c,v
retrieving revision 1.130
diff -u -r1.130 marshal.c
--- marshal.c	9 Dec 2003 14:30:48 -0000	1.130
+++ marshal.c	12 Dec 2003 14:43:44 -0000
@@ -172,7 +172,7 @@
 		items_written = sb->capacity;
 	
 	if (!error) {
-		memcpy (sb->chars->vector, ut, items_written * 2);
+		memcpy (mono_string_chars (sb->str), ut, items_written * 2);
 		sb->length = items_written;
 	} else 
 		g_error_free (error);
@@ -183,16 +183,18 @@
 gpointer
 mono_string_builder_to_utf8 (MonoStringBuilder *sb)
 {
-	char *res;
+	GError *error = NULL;
+	gchar *res;
 
 	if (!sb)
 		return NULL;
 
-	res = g_malloc (sb->capacity + 1);
-
-	/* fixme: copy the content of the string builder? */
-	res [0] = 0;
-
+	res = g_utf16_to_utf8 (mono_string_chars (sb->str), sb->length, NULL, NULL, &error);
+	if (error) {
+		g_error_free (error);
+		mono_raise_exception (mono_get_exception_execution_engine ("Failed to convert StringBuilder from utf16 to utf8"));
+	}
+
 	return res;
 }
 
Index: object.h
===================================================================
RCS file: /cvs/public/mono/mono/metadata/object.h,v
retrieving revision 1.108
diff -u -r1.108 object.h
--- object.h	7 Dec 2003 13:12:09 -0000	1.108
+++ object.h	12 Dec 2003 14:43:45 -0000
@@ -112,9 +112,9 @@
 
 typedef struct {
 	MonoObject object;
-	gint32 capacity;
 	gint32 length;
-	MonoArray *chars;
+	gint32 capacity;
+	MonoString *str;
 } MonoStringBuilder;
 
 typedef struct {
