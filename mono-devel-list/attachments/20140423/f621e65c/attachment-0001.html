<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Hi,&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Apr&nbsp;22,&nbsp;2014&nbsp;at&nbsp;9:53&nbsp;PM,&nbsp;Miguel&nbsp;de&nbsp;Icaza&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:miguel@xamarin.com&quot;&nbsp;target=&quot;_blank&quot;&gt;miguel@xamarin.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hey&nbsp;guys,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;was&nbsp;looking&nbsp;at&nbsp;making&nbsp;the&nbsp;MSBuild&nbsp;system&nbsp;work,&nbsp;and&nbsp;during&nbsp;the&nbsp;process&nbsp;I&nbsp;have&nbsp;encountered&nbsp;a&nbsp;few&nbsp;problems&nbsp;that&nbsp;we&nbsp;have&nbsp;in&nbsp;our&nbsp;existing&nbsp;build&nbsp;system&nbsp;that&nbsp;are&nbsp;problematic.&lt;/div&gt;<br>
&lt;div&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;System,&nbsp;System.XML&nbsp;and&nbsp;System.Configuration&nbsp;are&nbsp;each&nbsp;defined&nbsp;in&nbsp;terms&nbsp;of&nbsp;the&nbsp;other&nbsp;assemblies.&nbsp;&nbsp;&nbsp;So&nbsp;we&nbsp;gradually&nbsp;bring&nbsp;up&nbsp;each&nbsp;one&nbsp;of&nbsp;those&nbsp;assemblies&nbsp;up&nbsp;by&nbsp;first&nbsp;compiling&nbsp;a&nbsp;stub&nbsp;System,&nbsp;which&nbsp;we&nbsp;use&nbsp;to&nbsp;build&nbsp;System.XML&nbsp;and&nbsp;System.Configuration.&nbsp;&nbsp;&nbsp;Then&nbsp;we&nbsp;rebuild&nbsp;System,&nbsp;this&nbsp;time&nbsp;referencing&nbsp;System.XML&nbsp;and&nbsp;System.Configuration&nbsp;so&nbsp;we&nbsp;can&nbsp;take&nbsp;a&nbsp;dependency&nbsp;on&nbsp;them,&nbsp;and&nbsp;so&nbsp;on.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;build&nbsp;a&nbsp;complete&nbsp;System.dll&nbsp;for&nbsp;a&nbsp;particular&nbsp;profile&nbsp;(net_2_0,&nbsp;net_4_0,&nbsp;etc)&nbsp;takes&nbsp;three&nbsp;steps:&nbsp;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Core&nbsp;Build&lt;/li&gt;&lt;li&gt;Secondary&nbsp;Build:&lt;/li&gt;&lt;ul&gt;&lt;li&gt;Core&nbsp;Build&nbsp;+&nbsp;&lt;/li&gt;&lt;li&gt;Defines:&nbsp;XML_DEP&nbsp;+&nbsp;SECURITY_DEP&lt;/li&gt;<br>
<br>
<br>
&lt;li&gt;Refs:&nbsp;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;-r:PrebuiltSystem=../lib/Previous/System.dll&nbsp;&lt;/li&gt;&lt;li&gt;-r:System.Xml.dll&lt;br&gt;&lt;/li&gt;&lt;li&gt;-r:MonoSecurity=Mono.Security.dll&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;li&gt;Final&nbsp;Build:&lt;/li&gt;&lt;ul&gt;&lt;li&gt;Secondary&nbsp;Build&nbsp;+&nbsp;&lt;/li&gt;&lt;li&gt;defines:&nbsp;-d:CONFIGURATION_DEP&lt;/li&gt;<br>
<br>
<br>
&lt;li&gt;Refs:&lt;/li&gt;&lt;ul&gt;&lt;li&gt;System.Configuration.dll&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Another&nbsp;option&nbsp;is&nbsp;to&nbsp;take&nbsp;advantage&nbsp;of&nbsp;the&nbsp;fact&nbsp;that&nbsp;ilasm&nbsp;does&nbsp;not&nbsp;require&nbsp;referenced&nbsp;assemblies&nbsp;to&nbsp;exist.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;The&nbsp;idea&nbsp;would&nbsp;be&nbsp;do&nbsp;to&nbsp;the&nbsp;following:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;<br>
Once:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;Use&nbsp;any&nbsp;existing&nbsp;mscorlib.dll,&nbsp;System.dll&nbsp;and&nbsp;System.XML.dll&nbsp;to&nbsp;create&nbsp;&lt;a&nbsp;href=&quot;http://mscorlib.il&quot;&gt;mscorlib.il&lt;/a&gt;,&nbsp;System.il&nbsp;and&nbsp;&lt;a&nbsp;href=&quot;http://System.XML.il&quot;&gt;System.XML.il&lt;/a&gt;&nbsp;(possibly&nbsp;by&nbsp;using&nbsp;mono-cil-strip&nbsp;so&nbsp;that&nbsp;only&nbsp;the&nbsp;metadata&nbsp;remains).&nbsp;We&nbsp;commit&nbsp;these&nbsp;files&nbsp;to&nbsp;the&nbsp;repository.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;During&nbsp;the&nbsp;build:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;Compile&nbsp;the&nbsp;*.il&nbsp;files&nbsp;to&nbsp;a&nbsp;set&nbsp;of&nbsp;reference&nbsp;assemblies&nbsp;(note&nbsp;that&nbsp;since&nbsp;ilasm&nbsp;does&nbsp;not&nbsp;require&nbsp;referenced&nbsp;assemblies&nbsp;to&nbsp;exist,&nbsp;we&nbsp;can&nbsp;compile&nbsp;&lt;a&nbsp;href=&quot;http://mscorlib.il&quot;&gt;mscorlib.il&lt;/a&gt;&nbsp;to&nbsp;a&nbsp;mscorlib.dll&nbsp;that&nbsp;references&nbsp;System.dll&nbsp;before&nbsp;System.dll&nbsp;exists).&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;Use&nbsp;those&nbsp;reference&nbsp;assemblies&nbsp;to&nbsp;compile&nbsp;the&nbsp;final&nbsp;mscorlib.dll,&nbsp;System.dll&nbsp;and&nbsp;System.XML.dll&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;<br>
Pros:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;No&nbsp;circular&nbsp;build&nbsp;magic&nbsp;required.&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;The&nbsp;build&nbsp;should&nbsp;be&nbsp;faster,&nbsp;each&nbsp;assembly&nbsp;is&nbsp;compiled&nbsp;at&nbsp;most&nbsp;twice&nbsp;(once&nbsp;the&nbsp;.il&nbsp;and&nbsp;once&nbsp;the&nbsp;final&nbsp;assembly).&nbsp;With&nbsp;the&nbsp;current&nbsp;setup&nbsp;we&nbsp;compile&nbsp;some&nbsp;assemblies&nbsp;three&nbsp;times.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Cons:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;*&nbsp;It&#39;ll&nbsp;probably&nbsp;be&nbsp;painful&nbsp;to&nbsp;update/create&nbsp;new&nbsp;.il&nbsp;files&nbsp;when&nbsp;new&nbsp;profiles&nbsp;comes&nbsp;out&nbsp;from&nbsp;Microsoft.&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_default&quot;&nbsp;style=&quot;font-size:small&quot;&gt;Rolf&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;The&nbsp;above&nbsp;is&nbsp;what&nbsp;is&nbsp;required&nbsp;to&nbsp;bring&nbsp;up&nbsp;System.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Our&nbsp;implementation&nbsp;has&nbsp;one&nbsp;major&nbsp;problem:&nbsp;it&nbsp;overwrites&nbsp;the&nbsp;intermediate&nbsp;files.&nbsp;&nbsp;So&nbsp;the&nbsp;core&nbsp;build&nbsp;output&nbsp;is&nbsp;overwritten&nbsp;by&nbsp;the&nbsp;secondary&nbsp;build,&nbsp;and&nbsp;the&nbsp;secondary&nbsp;build&nbsp;is&nbsp;overwritten&nbsp;by&nbsp;the&nbsp;final&nbsp;build.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;that&nbsp;historically,&nbsp;instead&nbsp;of&nbsp;introducing&nbsp;temporary&nbsp;directories&nbsp;for&nbsp;each&nbsp;stage,&nbsp;instead&nbsp;we&nbsp;hacked&nbsp;our&nbsp;way&nbsp;out&nbsp;of&nbsp;it.&nbsp;&nbsp;&nbsp;We&nbsp;introduced&nbsp;a&nbsp;LIBRARY_USE_INTERMEDIATE_FILE&nbsp;whose&nbsp;sole&nbsp;purpose&nbsp;was&nbsp;to&nbsp;work&nbsp;around&nbsp;the&nbsp;case&nbsp;where&nbsp;Windows&nbsp;was&nbsp;actively&nbsp;telling&nbsp;us&nbsp;we&nbsp;were&nbsp;doing&nbsp;something&nbsp;wrong&nbsp;(we&nbsp;were&nbsp;overwriting&nbsp;a&nbsp;file&nbsp;that&nbsp;we&nbsp;were&nbsp;actively&nbsp;referencing!)&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;above&nbsp;is&nbsp;also&nbsp;likely&nbsp;going&nbsp;to&nbsp;prevent&nbsp;reliable&nbsp;parallel&nbsp;builds,&nbsp;or&nbsp;probably&nbsp;means&nbsp;that&nbsp;we&nbsp;introduced&nbsp;some&nbsp;gross&nbsp;hack&nbsp;to&nbsp;make&nbsp;the&nbsp;above&nbsp;work&nbsp;in&nbsp;parallel.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;going&nbsp;to&nbsp;try&nbsp;to&nbsp;fix&nbsp;this,&nbsp;but&nbsp;the&nbsp;Makefile&nbsp;goop&nbsp;is&nbsp;pretty&nbsp;dense,&nbsp;and&nbsp;I&nbsp;might&nbsp;fail.&nbsp;&nbsp;&nbsp;I&nbsp;just&nbsp;figured&nbsp;I&nbsp;should&nbsp;share&nbsp;my&nbsp;findings&nbsp;in&nbsp;case&nbsp;civilization&nbsp;comes&nbsp;to&nbsp;an&nbsp;end&nbsp;and&nbsp;a&nbsp;future&nbsp;archeologist&nbsp;tries&nbsp;to&nbsp;figure&nbsp;out&nbsp;why&nbsp;this&nbsp;was&nbsp;not&nbsp;working.&lt;/div&gt;<br>
<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;These&nbsp;are&nbsp;the&nbsp;defines&nbsp;that&nbsp;we&nbsp;use&nbsp;to&nbsp;bring&nbsp;up&nbsp;System&nbsp;for&nbsp;each&nbsp;profile:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;basic&nbsp;Profile:&lt;/div&gt;&lt;div&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&gt;basic:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:BOOTSTRAP_BASIC&nbsp;-d:CONFIGURATION_2_0&lt;/p&gt;<br>
&lt;p&gt;basic:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:BOOTSTRAP_BASIC&nbsp;-d:CONFIGURATION_2_0&nbsp;-d:XML_DEP&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Build&nbsp;Profile:&lt;/p&gt;<br>
&lt;p&gt;build:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:CONFIGURATION_2_0&lt;/p&gt;&lt;p&gt;build:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:CONFIGURATION_2_0&nbsp;&nbsp;-d:XML_DEP&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Net&nbsp;2.0&nbsp;profile:&lt;/p&gt;<br>
&lt;p&gt;net_2_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;&nbsp;-d:CONFIGURATION_2_0&lt;/p&gt;<br>
&lt;p&gt;net_2_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;&nbsp;-d:CONFIGURATION_2_0&nbsp;&nbsp;-d:XML_DEP&nbsp;-d:SECURITY_DEP&nbsp;&lt;/p&gt;<br>
&lt;p&gt;net_2_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;&nbsp;-d:CONFIGURATION_2_0&nbsp;&nbsp;-d:XML_DEP&nbsp;-d:SECURITY_DEP&nbsp;-d:CONFIGURATION_DEP&nbsp;&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Net&nbsp;4.0&nbsp;profile:&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;net_4_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:CONFIGURATION_2_0&lt;/p&gt;<br>
&lt;p&gt;net_4_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:CONFIGURATION_2_0&nbsp;-d:XML_DEP&nbsp;&nbsp;-d:SECURITY_DEP&lt;/p&gt;<br>
&lt;p&gt;net_4_0:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:CONFIGURATION_2_0&nbsp;-d:XML_DEP&nbsp;&nbsp;-d:SECURITY_DEP&nbsp;&nbsp;-d:CONFIGURATION_DEP&lt;/p&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Net&nbsp;4.5&nbsp;profile:&lt;br&gt;&lt;/p&gt;<br>
&lt;p&gt;net_4_5:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:NET_4_5&nbsp;-d:CONFIGURATION_2_0&nbsp;&lt;/p&gt;<br>
&lt;p&gt;net_4_5:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:NET_4_5&nbsp;-d:CONFIGURATION_2_0&nbsp;-d:XML_DEP&nbsp;&nbsp;-d:SECURITY_DEP&nbsp;&lt;/p&gt;<br>
&lt;p&gt;net_4_5:&nbsp;-d:NET_1_1&nbsp;-d:NET_2_0&nbsp;-d:NET_3_0&nbsp;-d:NET_3_5&nbsp;-d:NET_4_0&nbsp;-d:NET_4_5&nbsp;-d:CONFIGURATION_2_0&nbsp;&nbsp;-d:XML_DEP&nbsp;-d:SECURITY_DEP&nbsp;-d:CONFIGURATION_DEP&nbsp;&lt;/p&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;Miguel&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;background-color:transparent;font-family:Arial;line-height:14.720000267028809px;vertical-align:baseline;white-space:pre-wrap&quot;&gt;Explore&nbsp;&lt;a&nbsp;href=&quot;http://xamarin.com/university&quot;&nbsp;style=&quot;color:rgb(17,85,204);text-decoration:none;font-family:arial,sans-serif&quot;&nbsp;target=&quot;_blank&quot;&gt;Xamarin&nbsp;University&lt;/a&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;background-color:transparent;line-height:14.720000267028809px;vertical-align:baseline;white-space:pre-wrap;font-family:Arial&quot;&gt;&mdash;unlimited,&nbsp;live,&nbsp;online,&nbsp;mobile&nbsp;training&nbsp;around&nbsp;the&nbsp;clock.&nbsp;&nbsp;&lt;/span&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
