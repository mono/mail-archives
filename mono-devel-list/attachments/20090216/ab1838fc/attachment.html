<tt>
Hey,&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;spent&nbsp;some&nbsp;time&nbsp;last&nbsp;week&nbsp;on&nbsp;this&nbsp;subject&nbsp;trying&nbsp;to&nbsp;see&nbsp;how&nbsp;this&nbsp;could&nbsp;be&nbsp;fixed.&lt;br&gt;&lt;br&gt;My&nbsp;initial&nbsp;idea&nbsp;was&nbsp;to&nbsp;remove&nbsp;the&nbsp;loader&nbsp;lock&nbsp;from&nbsp;all&nbsp;paths&nbsp;that&nbsp;lead&nbsp;to&nbsp;managed&nbsp;code&lt;br&gt;been&nbsp;called.&nbsp;Thou&nbsp;it&amp;#39;s&nbsp;possible,&nbsp;it&nbsp;would&nbsp;require&nbsp;some&nbsp;very&nbsp;complex&nbsp;changes&nbsp;to&nbsp;class&nbsp;loading&lt;br&gt;<br>
to&nbsp;support&nbsp;System&nbsp;F&nbsp;recursive&nbsp;type&nbsp;definitions&nbsp;(F&nbsp;:&nbsp;T&amp;lt;F&amp;gt;)&nbsp;in&nbsp;a&nbsp;way&nbsp;to&nbsp;do&nbsp;safe&nbsp;publishing.&lt;br&gt;&lt;br&gt;It&nbsp;would&nbsp;buy&nbsp;us&nbsp;more&nbsp;trouble&nbsp;than&nbsp;anything&nbsp;else.&nbsp;Which&nbsp;turned&nbsp;my&nbsp;attention&nbsp;into&nbsp;fixing&nbsp;ther&lt;br&gt;other&nbsp;locks&nbsp;instead.&nbsp;Besides&nbsp;the&nbsp;loader&nbsp;lock,&nbsp;only&nbsp;two&nbsp;other&nbsp;are&nbsp;held&nbsp;during&nbsp;complex&nbsp;interactions&lt;br&gt;<br>
with&nbsp;the&nbsp;system:&nbsp;the&nbsp;domain&nbsp;and&nbsp;domain&nbsp;jit&nbsp;code&nbsp;hash&nbsp;locks.&lt;br&gt;&lt;br&gt;My&nbsp;idea&nbsp;is&nbsp;to&nbsp;change&nbsp;the&nbsp;locking&nbsp;rules&nbsp;to&nbsp;make&nbsp;the&nbsp;loader&nbsp;lock&nbsp;the&nbsp;bottom&nbsp;one,&nbsp;this&nbsp;would&lt;br&gt;make&nbsp;it&nbsp;safe&nbsp;to&nbsp;call&nbsp;managed&nbsp;code&nbsp;while&nbsp;holding&nbsp;it&nbsp;and&nbsp;it&amp;#39;s&nbsp;not&nbsp;much&nbsp;different&nbsp;than&nbsp;what&nbsp;currently&lt;br&gt;<br>
happens.&lt;br&gt;&lt;br&gt;Both&nbsp;other&nbsp;locks,&nbsp;domain&nbsp;and&nbsp;domain&nbsp;jit&nbsp;code&nbsp;hash&nbsp;are&nbsp;used&nbsp;most&nbsp;of&nbsp;the&nbsp;time&nbsp;just&nbsp;to&nbsp;protect&lt;br&gt;resources&nbsp;that&nbsp;are&nbsp;part&nbsp;of&nbsp;MonoDomain.&lt;br&gt;&lt;br&gt;The&nbsp;issue&nbsp;then&nbsp;would&nbsp;be&nbsp;to&nbsp;rework&nbsp;the&nbsp;part&nbsp;of&nbsp;the&nbsp;runtime&nbsp;that&nbsp;hold&nbsp;the&nbsp;loader&nbsp;lock&nbsp;together&nbsp;with&lt;br&gt;<br>
the&nbsp;others.&nbsp;All&nbsp;code&nbsp;in&nbsp;metadata&nbsp;can&nbsp;be&nbsp;changed&nbsp;pretty&nbsp;easily&nbsp;as&nbsp;it&nbsp;acquires&nbsp;one&nbsp;after&nbsp;the&nbsp;other.&lt;br&gt;The&nbsp;trouble&nbsp;is&nbsp;in&nbsp;mini.c&nbsp;where&nbsp;the&nbsp;interaction&nbsp;between&nbsp;those&nbsp;locks&nbsp;is&nbsp;pretty&nbsp;complex&nbsp;but&nbsp;changing&lt;br&gt;it&nbsp;isn&amp;#39;t&nbsp;that&nbsp;that&nbsp;hard.&lt;br&gt;<br>
&lt;br&gt;This&nbsp;approach&nbsp;would&nbsp;require&nbsp;us&nbsp;to&nbsp;split&nbsp;all&nbsp;the&nbsp;uses&nbsp;of&nbsp;the&nbsp;loader&nbsp;lock&nbsp;to&nbsp;protect&nbsp;resources&nbsp;such&nbsp;as&nbsp;the&lt;br&gt;the&nbsp;uiid&nbsp;table&nbsp;as&nbsp;this&nbsp;is&nbsp;a&nbsp;task&nbsp;for&nbsp;simple&nbsp;locks&nbsp;and&nbsp;might&nbsp;have&nbsp;a&nbsp;bad&nbsp;interactions&nbsp;with&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&lt;br&gt;<br>
runtime.&lt;br&gt;&lt;br&gt;Comments?&lt;br&gt;&lt;br&gt;Cheers,&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;<br>

</tt>
