Index: mini.c
===================================================================
--- mini.c	(revision 36835)
+++ mini.c	(working copy)
@@ -7852,6 +7852,7 @@
 	jinfo->code_size = cfg->code_len;
 	jinfo->used_regs = cfg->used_int_regs;
 	jinfo->domain_neutral = (cfg->opt & MONO_OPT_SHARED) != 0;
+	jinfo->cas_inited = FALSE; /* initialization delayed at the first stalk walk using this method */
 
 	if (header->num_clauses) {
 		int i;
@@ -8440,6 +8441,8 @@
 				ves_icall_get_frame_info);
 	mono_add_internal_call ("System.Diagnostics.StackTrace::get_trace", 
 				ves_icall_get_trace);
+	mono_add_internal_call ("System.Security.SecurityFrame::_GetSecurityFrameInformation",
+				ves_icall_System_Security_SecurityFrame_GetSecurityFrameInformation);
 	mono_add_internal_call ("Mono.Runtime::mono_runtime_install_handlers", 
 				mono_runtime_install_handlers);
 
Index: mini.h
===================================================================
--- mini.h	(revision 36835)
+++ mini.h	(working copy)
@@ -844,4 +844,28 @@
 extern void
 mono_perform_abc_removal (MonoCompile *cfg);
 
+/* CAS - stack walk */
+MonoBoolean ves_icall_System_Security_SecurityFrame_GetSecurityFrameInformation (gint32 skip, MonoReflectionMethod **method, gint32 *flags);
+
+
+typedef MonoBoolean (* MonoGetFrameExtraInfo) (MonoJitInfo *ji, gint32 *native_offset, void* callback_data);
+
+MonoBoolean get_frame_info (gint32 skip, MonoReflectionMethod **method, gint32 *native_offset, MonoGetFrameExtraInfo callback, void* callback_data);
+
+typedef struct {
+	gint32 iloffset;
+	MonoBoolean need_file_info;
+	MonoString *file;
+	gint32 line;
+	gint32 column;
+} MonoFrameDebugInfo;
+
+MonoBoolean callback_get_frame_debug_info (MonoJitInfo *ji, gint32 *native_offset, void* callback_data);
+
+typedef struct {
+	guint32 flags;
+} MonoFrameSecurityInfo;
+
+MonoBoolean callback_get_frame_security_info (MonoJitInfo *ji, gint32 *native_offset, void* callback_data);
+
 #endif /* __MONO_MINI_H__ */  
Index: mini-exceptions.c
===================================================================
--- mini-exceptions.c	(revision 36835)
+++ mini-exceptions.c	(working copy)
@@ -187,11 +187,9 @@
 	}
 }
 
+
 MonoBoolean
-ves_icall_get_frame_info (gint32 skip, MonoBoolean need_file_info, 
-			  MonoReflectionMethod **method, 
-			  gint32 *iloffset, gint32 *native_offset,
-			  MonoString **file, gint32 *line, gint32 *column)
+get_frame_info (gint32 skip, MonoReflectionMethod **method, gint32 *native_offset, MonoGetFrameExtraInfo callback, void* callback_data)
 {
 	MonoDomain *domain = mono_domain_get ();
 	MonoJitTlsData *jit_tls = TlsGetValue (mono_jit_tls_id);
@@ -201,7 +199,7 @@
 
 	mono_arch_flush_register_windows ();
 
-	MONO_CONTEXT_SET_IP (&ctx, ves_icall_get_frame_info);
+	MONO_CONTEXT_SET_IP (&ctx, get_frame_info);
 	MONO_CONTEXT_SET_BP (&ctx, __builtin_frame_address (0));
 
 	skip++;
@@ -214,7 +212,7 @@
 		if (!ji || ji == (gpointer)-1 || MONO_CONTEXT_GET_BP (&ctx) >= jit_tls->end_of_stack)
 			return FALSE;
 
-		/* skip all wrappers ??*/
+		/* FIXME: skip all wrappers ??*/
 		if (ji->method->wrapper_type == MONO_WRAPPER_RUNTIME_INVOKE ||
 		    ji->method->wrapper_type == MONO_WRAPPER_XDOMAIN_INVOKE ||
 		    ji->method->wrapper_type == MONO_WRAPPER_XDOMAIN_DISPATCH ||
@@ -227,22 +225,94 @@
 	} while (skip >= 0);
 
 	*method = mono_method_get_object (domain, ji->method, NULL);
-	*iloffset = mono_debug_il_offset_from_address (ji->method, *native_offset, domain);
+	return callback (ji, native_offset, callback_data);
+}
 
-	if (need_file_info) {
-		gchar *filename;
+MonoBoolean
+callback_get_frame_debug_info (MonoJitInfo *ji, gint32 *native_offset, void* callback_data)
+{
+	MonoDomain *domain = mono_domain_get ();
+	MonoFrameDebugInfo *di = (MonoFrameDebugInfo*) callback_data;
+	di->iloffset = mono_debug_il_offset_from_address (ji->method, *native_offset, domain);
 
-		filename = mono_debug_source_location_from_address (ji->method, *native_offset, line, domain);
+	if (di->need_file_info) {
+		gchar *filename = mono_debug_source_location_from_address (ji->method, *native_offset, &di->line, domain);
 
-		*file = filename? mono_string_new (domain, filename): NULL;
-		*column = 0;
+		di->file = filename ? mono_string_new (domain, filename): NULL;
+		di->column = 0;
 
 		g_free (filename);
 	}
+	return TRUE;
+}
 
+MonoBoolean
+callback_get_frame_security_info (MonoJitInfo *ji, gint32 *native_offset, void* callback_data)
+{
+	MonoFrameSecurityInfo *si = (MonoFrameSecurityInfo*) callback_data;
+	if (si) {
+		int f = 0;
+		if (!ji->cas_inited) {
+			if (mono_method_has_declsec (ji->method)) {
+				/* Cache the stack modifiers into the MonoJitInfo structure to speed up future stack walks */
+				mono_declsec_cache_stack_modifiers (ji);
+			}
+			ji->cas_inited = TRUE;
+		}
+
+		if (ji->cas_class_assert)
+			f |= MONO_JITINFO_STACKMOD_ASSERT;
+		if (ji->cas_class_deny)
+			f |= MONO_JITINFO_STACKMOD_DENY;
+		if (ji->cas_class_permitonly)
+			f |= MONO_JITINFO_STACKMOD_PERMITONLY;
+		f <<= 8;
+		if (ji->cas_method_assert)
+			f |= MONO_JITINFO_STACKMOD_ASSERT;
+		if (ji->cas_method_deny)
+			f |= MONO_JITINFO_STACKMOD_DENY;
+		if (ji->cas_method_permitonly)
+			f |= MONO_JITINFO_STACKMOD_PERMITONLY;
+
+		si->flags = f;
+	}
 	return TRUE;
 }
 
+MonoBoolean
+ves_icall_get_frame_info (gint32 skip, MonoBoolean need_file_info, 
+			  MonoReflectionMethod **method, 
+			  gint32 *iloffset, gint32 *native_offset,
+			  MonoString **file, gint32 *line, gint32 *column)
+{
+	MonoFrameDebugInfo di;
+	di.need_file_info = need_file_info;
+
+	if (get_frame_info (skip, method, native_offset, callback_get_frame_debug_info, (void*)&di)) {
+		*iloffset = di.iloffset;
+		if (need_file_info) {
+			*file = di.file;
+			*line = di.line;
+			*column = di.column;
+		}
+		return TRUE;
+	}
+	return FALSE;
+}
+
+MonoBoolean
+ves_icall_System_Security_SecurityFrame_GetSecurityFrameInformation (gint32 skip, MonoReflectionMethod **method, gint32 *flags)
+{
+	MonoFrameSecurityInfo si;
+	guint32 native_offset;
+
+	if (get_frame_info (skip, method, &native_offset, callback_get_frame_security_info, (void*)&si)) {
+		*flags = si.flags;
+		return TRUE;
+	}
+	return FALSE;
+}
+
 static MonoArray *
 glist_to_array (GList *list) 
 {
