<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=Windows-1252&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;<br>
Jonathan,&nbsp;thanks&nbsp;for&nbsp;the&nbsp;info.&nbsp;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;The&nbsp;native&nbsp;thread&nbsp;(#4)&nbsp;does&nbsp;not&nbsp;know&nbsp;about&nbsp;mono&nbsp;nor&nbsp;is&nbsp;it&nbsp;linked&nbsp;with&nbsp;the&nbsp;mono&nbsp;libraries,&nbsp;it&nbsp;would&nbsp;be&nbsp;hard&nbsp;to&nbsp;call&nbsp;mono_thread_detach&nbsp;from&nbsp;it.&nbsp;Is&nbsp;there&nbsp;a&nbsp;different&nbsp;solution&nbsp;to&nbsp;this?<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Out&nbsp;of&nbsp;curiosity&nbsp;why&nbsp;does&nbsp;mono&nbsp;not&nbsp;detach&nbsp;a&nbsp;thread&nbsp;once&nbsp;a&nbsp;managed&nbsp;call&nbsp;is&nbsp;complete&nbsp;from&nbsp;a&nbsp;native&nbsp;thread.<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;On&nbsp;Dec&nbsp;13,&nbsp;2013,&nbsp;at&nbsp;12:55&nbsp;PM,&nbsp;Jonathan&nbsp;Chambers&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:joncham@gmail.com&quot;&gt;joncham@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;<br>
&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;If&nbsp;the&nbsp;native&nbsp;thread&nbsp;calls&nbsp;into&nbsp;managed&nbsp;code&nbsp;it&nbsp;is&nbsp;automatically&nbsp;'attached'&nbsp;to&nbsp;the&nbsp;mono&nbsp;runtime&nbsp;and&nbsp;the&nbsp;gc&nbsp;for&nbsp;tracking.&nbsp;It&nbsp;does&nbsp;not&nbsp;automatically&nbsp;unattached&nbsp;upon&nbsp;return&nbsp;of&nbsp;the&nbsp;call&nbsp;into&nbsp;managed&nbsp;code.&nbsp;Then&nbsp;at&nbsp;shutdown&nbsp;the&nbsp;native&nbsp;thread&nbsp;is&nbsp;part<br>
&nbsp;of&nbsp;the&nbsp;list&nbsp;of&nbsp;threads&nbsp;that&nbsp;are&nbsp;expected&nbsp;to&nbsp;exit&nbsp;before&nbsp;the&nbsp;runtime&nbsp;can&nbsp;shut&nbsp;down&nbsp;properly.<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Try&nbsp;to&nbsp;call&nbsp;mono_thread_detach()&nbsp;in&nbsp;thread&nbsp;#4&nbsp;before&nbsp;entering&nbsp;the&nbsp;wait&nbsp;for&nbsp;shutdown.&lt;br&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;Jonathan&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Dec&nbsp;13,&nbsp;2013&nbsp;at&nbsp;1:09&nbsp;PM,&nbsp;Bassam&nbsp;Tabbara&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;<br>
&lt;&lt;a&nbsp;href=&quot;mailto:bassam@symform.com&quot;&nbsp;target=&quot;_blank&quot;&gt;bassam@symform.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
I’m&nbsp;seeing&nbsp;a&nbsp;deadlock&nbsp;on&nbsp;shutdown&nbsp;of&nbsp;latest&nbsp;mono&nbsp;form&nbsp;master&nbsp;when&nbsp;using&nbsp;our&nbsp;own&nbsp;native&nbsp;background&nbsp;thread.&nbsp;Here&nbsp;are&nbsp;backtraces:&lt;br&gt;<br>
&lt;br&gt;<br>
*&nbsp;thread&nbsp;#1:&nbsp;tid&nbsp;=&nbsp;0xd83c3,&nbsp;0x00007fff91412716&nbsp;libsystem_kernel.dylib`__psynch_cvwait&nbsp;&#43;&nbsp;10,&nbsp;queue&nbsp;=&nbsp;'com.apple.main-thread,&nbsp;stop&nbsp;reason&nbsp;=&nbsp;signal&nbsp;SIGSTOP&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#0:&nbsp;0x00007fff91412716&nbsp;libsystem_kernel.dylib`__psynch_cvwait&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0x00007fff86b20c3b&nbsp;libsystem_pthread.dylib`_pthread_cond_wait&nbsp;&#43;&nbsp;727&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0x000000010919a892&nbsp;mono`_wapi_handle_timedwait_signal_handle(handle=&lt;unavailable&gt;,&nbsp;timeout=&lt;unavailable&gt;,&nbsp;alertable=1,&nbsp;poll=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;514&nbsp;at&nbsp;handles.c:1588&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0x00000001091ab95b&nbsp;mono`WaitForMultipleObjectsEx(numobjects=7,&nbsp;handles=0x00007fff56c6f2f0,&nbsp;waitall=1,&nbsp;timeout=4294967295,&nbsp;alertable=1)&nbsp;&#43;&nbsp;1419&nbsp;at&nbsp;wait.c:668&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0x0000000109112a2f&nbsp;mono`wait_for_tids(wait=0x00007fff56c6f2f0,&nbsp;timeout=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;47&nbsp;at&nbsp;threads.c:2809&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0x0000000109112626&nbsp;mono`mono_thread_manage&nbsp;&#43;&nbsp;694&nbsp;at&nbsp;threads.c:3095&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0x0000000108ffc9fd&nbsp;mono`mono_main(argc=11,&nbsp;argv=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;6301&nbsp;at&nbsp;driver.c:2015&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#7:&nbsp;0x0000000108f92a0c&nbsp;mono`main&nbsp;[inlined]&nbsp;mono_main_with_options(argv=&lt;unavailable&gt;,&nbsp;argc=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;549&nbsp;at&nbsp;main.c:98&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#8:&nbsp;0x0000000108f927e7&nbsp;mono`main(argc=&lt;unavailable&gt;,&nbsp;argv=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;39&nbsp;at&nbsp;main.c:133&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#9:&nbsp;0x00007fff8d7875fd&nbsp;libdyld.dylib`start&nbsp;&#43;&nbsp;1&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;thread&nbsp;#2:&nbsp;tid&nbsp;=&nbsp;0xd83c5,&nbsp;0x00007fff9140ea56&nbsp;libsystem_kernel.dylib`semaphore_wait_trap&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#0:&nbsp;0x00007fff9140ea56&nbsp;libsystem_kernel.dylib`semaphore_wait_trap&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0x00000001091b8d38&nbsp;mono`mono_sem_wait(sem=0x000000010930ad78,&nbsp;alertable=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;24&nbsp;at&nbsp;mono-semaphore.c:121&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0x0000000109136017&nbsp;mono`finalizer_thread(unused=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;103&nbsp;at&nbsp;gc.c:1073&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0x000000010910d743&nbsp;mono`start_wrapper&nbsp;[inlined]&nbsp;start_wrapper_internal&nbsp;&#43;&nbsp;456&nbsp;at&nbsp;threads.c:609&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0x000000010910d57b&nbsp;mono`start_wrapper(data=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;43&nbsp;at&nbsp;threads.c:654&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0x00000001091acd50&nbsp;mono`thread_start_routine(args=0x00007f930981cbf8)&nbsp;&#43;&nbsp;144&nbsp;at&nbsp;wthreads.c:294&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0x00000001091bdffa&nbsp;mono`inner_start_thread(arg=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;58&nbsp;at&nbsp;mono-threads-posix.c:49&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#7:&nbsp;0x00007fff86b1e899&nbsp;libsystem_pthread.dylib`_pthread_body&nbsp;&#43;&nbsp;138&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#8:&nbsp;0x00007fff86b1e72a&nbsp;libsystem_pthread.dylib`_pthread_start&nbsp;&#43;&nbsp;137&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#9:&nbsp;0x00007fff86b22fc9&nbsp;libsystem_pthread.dylib`thread_start&nbsp;&#43;&nbsp;13&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;thread&nbsp;#3:&nbsp;tid&nbsp;=&nbsp;0xd83c9,&nbsp;0x00007fff91413662&nbsp;libsystem_kernel.dylib`kevent64&nbsp;&#43;&nbsp;10,&nbsp;queue&nbsp;=&nbsp;'com.apple.libdispatch-manager&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#0:&nbsp;0x00007fff91413662&nbsp;libsystem_kernel.dylib`kevent64&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0x00007fff8e0ac43d&nbsp;libdispatch.dylib`_dispatch_mgr_invoke&nbsp;&#43;&nbsp;239&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0x00007fff8e0ac152&nbsp;libdispatch.dylib`_dispatch_mgr_thread&nbsp;&#43;&nbsp;52&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&nbsp;thread&nbsp;#4:&nbsp;tid&nbsp;=&nbsp;0xda1fc,&nbsp;0x00007fff9141364a&nbsp;libsystem_kernel.dylib`kevent&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#0:&nbsp;0x00007fff9141364a&nbsp;libsystem_kernel.dylib`kevent&nbsp;&#43;&nbsp;10&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#1:&nbsp;0x000000010fa22712&nbsp;libsymformutp.dylib`kq_dispatch(base=0x00007f930b564890,&nbsp;tv=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;706&nbsp;at&nbsp;kqueue.c:301&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#2:&nbsp;0x000000010fa17429&nbsp;libsymformutp.dylib`event_base_loop(base=0x00007f930b564890,&nbsp;flags=&lt;unavailable&gt;)&nbsp;&#43;&nbsp;873&nbsp;at&nbsp;event.c:1826&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#3:&nbsp;0x000000010f9fe657&nbsp;libsymformutp.dylib`UTPEvents::Run(e=0x00007f930b566180)&nbsp;&#43;&nbsp;23&nbsp;at&nbsp;utp_event.cpp:81&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#4:&nbsp;0x00007fff86b1e899&nbsp;libsystem_pthread.dylib`_pthread_body&nbsp;&#43;&nbsp;138&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#5:&nbsp;0x00007fff86b1e72a&nbsp;libsystem_pthread.dylib`_pthread_start&nbsp;&#43;&nbsp;137&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;frame&nbsp;#6:&nbsp;0x00007fff86b22fc9&nbsp;libsystem_pthread.dylib`thread_start&nbsp;&#43;&nbsp;13&lt;br&gt;<br>
&lt;br&gt;<br>
thread&nbsp;#4&nbsp;is&nbsp;out&nbsp;native&nbsp;thread&nbsp;that&nbsp;will&nbsp;be&nbsp;shutdown&nbsp;when&nbsp;a&nbsp;managed&nbsp;SafeHandle&nbsp;is&nbsp;released.&nbsp;This&nbsp;thread&nbsp;is&nbsp;likely&nbsp;to&nbsp;have&nbsp;called&nbsp;managed&nbsp;code&nbsp;at&nbsp;some&nbsp;point.&nbsp;thread&nbsp;#1&nbsp;seems&nbsp;to&nbsp;be&nbsp;waiting&nbsp;on&nbsp;all&nbsp;threads&nbsp;to&nbsp;exit&nbsp;including&nbsp;thread&nbsp;#4,&nbsp;but&nbsp;until&nbsp;finalization&nbsp;is<br>
&nbsp;complete&nbsp;on&nbsp;thread&nbsp;#2&nbsp;this&nbsp;is&nbsp;not&nbsp;going&nbsp;to&nbsp;happen,&nbsp;and&nbsp;hence&nbsp;the&nbsp;deadlock.&lt;br&gt;<br>
&lt;br&gt;<br>
Does&nbsp;this&nbsp;seem&nbsp;likely?&nbsp;Why&nbsp;does&nbsp;mono&nbsp;runtime&nbsp;wait&nbsp;for&nbsp;threads&nbsp;to&nbsp;exit&nbsp;that&nbsp;it&nbsp;did&nbsp;not&nbsp;create?&nbsp;Should&nbsp;finalization&nbsp;happen&nbsp;before&nbsp;waiting&nbsp;for&nbsp;all&nbsp;threads&nbsp;to&nbsp;exit?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&nbsp;in&nbsp;advance&nbsp;for&nbsp;the&nbsp;help.&lt;br&gt;<br>
Bassam&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;/div&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
