using System;
using System.IO;
using System.Diagnostics;
using System.Net;
using System.Text;
using System.Web;

class YahooDrive {
	public static void Main() {
		Trace.Listeners.Add(new TextWriterTraceListener(Console.Out));
		Trace.AutoFlush = true;	
	
		YahooMail ym = new YahooMail();
		ym.Login("r_holmes", "goddag");	
	}
}

class YahooMail {
	CookieCollection m_cookies;
	
	static string m_httpLogin = "http://mail.yahoo.com/config/login?.intl=us&.us=ym&.tries=1&.src=ym";
	//static Uri m_httpLogin = new Uri("http://127.0.0.1/test.php");
	//static Uri m_httpLogin = new Uri("http://mail.yahoo.com/config/login?.intl=us&.us=ym&.tries=1&.src=ym");	
	//static Uri m_httpLogin = new Uri("http://login.yahoo.com/config/login");

	public YahooMail() { }

	public void Login(string aUsername, string aPassword) {
		Debug.Assert(aUsername != "" && aPassword != "");

		// should really be string postData = "&login=" + HttpUtility.UrlEncode("r_holmes");
		string urlAppend = "&login=" + aUsername +
						   "&passwd=" + aPassword;
		
		Trace.WriteLine("Logging into Yahoo Mail with username '" + aUsername + "' and password '" + aPassword + "'");
		RedirectHandler(new Uri(m_httpLogin + urlAppend));
	}
	
	private void RedirectHandler(Uri aUri) {
		Encoding enc = System.Text.Encoding.GetEncoding("utf-8");

		HttpWebRequest request = (HttpWebRequest)WebRequest.Create(aUri);
		request.CookieContainer = new CookieContainer();
				
		if (m_cookies != null && m_cookies.Count > 0) {
			Trace.WriteLine("Setting up cookies to sent with the request");
			request.CookieContainer.Add(m_cookies);
		}

		SetHeaders(request);

		Trace.WriteLine("Opening '" + aUri + "'");		
		HttpWebResponse response = (HttpWebResponse)request.GetResponse();

		if (response.Cookies.Count > 0)
			UpdateCookieCollection(response.Cookies);		
		
		//StreamReader responseStream = new StreamReader(response.GetResponseStream(), enc);	
		//Console.WriteLine(responseStream.ReadToEnd());

		if ( (response.StatusCode == HttpStatusCode.Redirect) ||
			 (response.StatusCode == HttpStatusCode.Found) ||
			 (response.StatusCode == HttpStatusCode.Moved) ||
			 (response.StatusCode == HttpStatusCode.MovedPermanently) ) {
			Trace.WriteLine("Redirecting to '" + response.Headers["Location"] + "'");
			RedirectHandler(new Uri(response.Headers["Location"]));
		} 
		
        response.Close();
	}
	
	private void SetHeaders(HttpWebRequest aRequest) {
		Debug.Assert(aRequest != null);

		aRequest.Method = "GET";
		aRequest.UserAgent = "Mozilla/5.0 (X11; U; Linux i686; en-US; rv:0.9.4) Gecko/20010914";
		aRequest.AllowAutoRedirect = false;
	}
	
	private void UpdateCookieCollection(CookieCollection responseCollection) {
		Trace.WriteLine("UpdateCookieCollection()");
		
		if (m_cookies == null) {
			Trace.WriteLine("No previous cookies stored. Store all cookies");			
			m_cookies = responseCollection;
			Trace.Indent();
			
			foreach (Cookie c in m_cookies) {
				Trace.WriteLine(c.Name + " " + c.Value);
			}

			Trace.Unindent();			
		}
		else {
			Trace.Indent();

			foreach (Cookie responseCookie in responseCollection) {
				bool match = false;
				
				foreach (Cookie storedCookie in m_cookies) {
					if (storedCookie.Name.Equals(responseCookie.Name)) {
						storedCookie.Value = responseCookie.Value;
						Trace.WriteLine("Updated key/value pair: '" + storedCookie.Name + "'/'" + storedCookie.Value + "'");
						match = true;
					}
				}
							
				if (!match)
					Trace.WriteLine("Adding new key/value pair: '" + responseCookie.Name + "'/'" + responseCookie.Value + "'");
					m_cookies.Add(responseCookie);
			}
			
			Trace.Unindent();		
		}
	}
}

//http://us.f546.mail.yahoo.com/ym/ShowLetter?
//MsgId=6511_194490_7105_1237_1329_0_41799_4398_114043847&box=Inbox