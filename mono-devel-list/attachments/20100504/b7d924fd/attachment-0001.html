<tt>
&lt;div&gt;Hey&nbsp;guys,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Attached&nbsp;is&nbsp;a&nbsp;patch&nbsp;that&nbsp;has&nbsp;the&nbsp;initial&nbsp;implementation&nbsp;for&nbsp;ephemerons&nbsp;on&nbsp;sgen.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;implements&nbsp;classic,&nbsp;by&nbsp;the&nbsp;book,&nbsp;ephemerons&nbsp;with&nbsp;the&nbsp;twist&nbsp;that&nbsp;only&nbsp;arrays&nbsp;of&nbsp;them&nbsp;are&nbsp;supported.&nbsp;So&nbsp;it&nbsp;keeps&lt;/div&gt;<br>
&lt;/div&gt;&lt;div&gt;scanning&nbsp;all&nbsp;ephemeron&nbsp;arrays&nbsp;while&nbsp;new&nbsp;keys&nbsp;turn&nbsp;reachable.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;current&nbsp;algorithm&nbsp;should&nbsp;run&nbsp;in&nbsp;linear&nbsp;time&nbsp;requiring&nbsp;only&nbsp;a&nbsp;few&nbsp;rounds&nbsp;per&nbsp;GC&nbsp;cycle&nbsp;with&nbsp;worst&nbsp;execution&nbsp;time&nbsp;of&nbsp;O(n^2)&lt;/div&gt;<br>
&lt;div&gt;where&nbsp;N&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;ephemeron&nbsp;slots.&nbsp;This&nbsp;will&nbsp;only&nbsp;happen&nbsp;for&nbsp;some&nbsp;very&nbsp;carefully&nbsp;crafted&nbsp;code,&nbsp;so&nbsp;in&nbsp;practice&nbsp;it&nbsp;should&lt;/div&gt;&lt;div&gt;not&nbsp;be&nbsp;a&nbsp;problem.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;minor/major&nbsp;split&nbsp;is&nbsp;there.&nbsp;Minor&nbsp;collections&nbsp;don&amp;#39;t&nbsp;scan&nbsp;arrays&nbsp;in&nbsp;old&nbsp;gen&nbsp;and&nbsp;the&nbsp;write-barrier&nbsp;takes&nbsp;care&nbsp;of&nbsp;cross-generation&lt;/div&gt;<br>
&lt;div&gt;pointers.&nbsp;The&nbsp;only&nbsp;issue&nbsp;of&nbsp;this&nbsp;design&nbsp;is&nbsp;that&nbsp;during&nbsp;a&nbsp;minor&nbsp;collection&nbsp;all&nbsp;nursery&nbsp;ephemerons&nbsp;pointed&nbsp;by&nbsp;an&nbsp;old&nbsp;gen&nbsp;array&lt;/div&gt;&lt;div&gt;are&nbsp;treated&nbsp;as&nbsp;reachable. We&nbsp;could&nbsp;overcome&nbsp;this&nbsp;by&nbsp;having&nbsp;a&nbsp;custom&nbsp;wb&nbsp;but&nbsp;I&nbsp;don&amp;#39;t&nbsp;think&nbsp;there&nbsp;is&nbsp;much&nbsp;to&nbsp;gain&nbsp;here.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;didn&amp;#39;t&nbsp;split&nbsp;the&nbsp;linked&nbsp;lists&nbsp;into&nbsp;minor/major&nbsp;sets&nbsp;since&nbsp;I&nbsp;don&amp;#39;t&nbsp;expect&nbsp;many&nbsp;ConditionalWeakTable&nbsp;(CWT)&nbsp;to&nbsp;be&nbsp;created&nbsp;-&nbsp;those&nbsp;tables&nbsp;will&nbsp;be&nbsp;just&nbsp;be&nbsp;big&nbsp;instead.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;thing&nbsp;that&nbsp;might&nbsp;be&nbsp;worth&nbsp;looking&nbsp;at&nbsp;is&nbsp;to&nbsp;have&nbsp;a&nbsp;per-array&nbsp;bitmap&nbsp;of&nbsp;slots&nbsp;that&nbsp;requires attention,&nbsp;this&nbsp;should&nbsp;speed&nbsp;up&nbsp;cases&nbsp;where&lt;/div&gt;<br>
&lt;div&gt;a&nbsp;lot&nbsp;of&nbsp;passes&nbsp;are&nbsp;requires.&nbsp;Otherwise&nbsp;it&nbsp;will&nbsp;probably&nbsp;just&nbsp;slow&nbsp;down&nbsp;things.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;built&nbsp;up&nbsp;a&nbsp;suite&nbsp;of&nbsp;tests&nbsp;for&nbsp;the&nbsp;basics&nbsp;of&nbsp;ephemeron&nbsp;behavior&nbsp;and&nbsp;some&nbsp;stress&nbsp;tests.&nbsp;The&nbsp;attached&nbsp;patch&nbsp;passes&nbsp;them&nbsp;all.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Once&nbsp;this&nbsp;patch&nbsp;is&nbsp;accepted&nbsp;I&amp;#39;ll&nbsp;move&nbsp;into&nbsp;finishing&nbsp;the&nbsp;managed&nbsp;side&nbsp;of&nbsp;it.&nbsp;Right&nbsp;now&nbsp;CWT&nbsp;is&nbsp;implemented&nbsp;doing&nbsp;linear&nbsp;search,&nbsp;but&nbsp;the&nbsp;idea&nbsp;is&nbsp;to&nbsp;switch&nbsp;to&lt;/div&gt;&lt;div&gt;open&nbsp;addressing.&nbsp;To&nbsp;do&nbsp;that,&nbsp;the&nbsp;only&nbsp;change&nbsp;required&nbsp;to&nbsp;sgen&nbsp;is&nbsp;to&nbsp;store&nbsp;a&nbsp;tombstone&nbsp;instead&nbsp;of&nbsp;NULL&nbsp;when&nbsp;clearing&nbsp;unreachable&nbsp;keys.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;Rodrigo&lt;/div&gt;<br>

</tt>
