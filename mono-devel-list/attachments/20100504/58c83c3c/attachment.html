<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp;mono&nbsp;is&nbsp;designed&nbsp;to&nbsp;initialize&nbsp;most&nbsp;things&nbsp;lazily,&nbsp;so&nbsp;the&nbsp;first&nbsp;time&nbsp;&amp;lt;x&amp;gt;&nbsp;is&nbsp;done,&nbsp;it&nbsp;will&nbsp;take&nbsp;more&nbsp;time.&nbsp;In&nbsp;particular,&nbsp;loading&nbsp;an&nbsp;aot&nbsp;image&nbsp;might&nbsp;load&nbsp;it&nbsp;from&nbsp;disk,&nbsp;calling&nbsp;a&nbsp;pinvoke&nbsp;method&lt;/div&gt;<br>
&lt;div&gt;causes&nbsp;the&nbsp;shared&nbsp;libraries&nbsp;referenced&nbsp;by&nbsp;the&nbsp;pinvoke&nbsp;declaration&nbsp;to&nbsp;be&nbsp;loaded&nbsp;from&nbsp;disk,&nbsp;etc.&lt;br&gt;Even&nbsp;calling&nbsp;a&nbsp;method&nbsp;does&nbsp;not&nbsp;initialize&nbsp;all&nbsp;the&nbsp;stuff&nbsp;needed&nbsp;by&nbsp;it,&nbsp;some&nbsp;things&nbsp;will&nbsp;only&nbsp;be&lt;/div&gt;&lt;div&gt;initialized&nbsp;just&nbsp;before&nbsp;it&nbsp;is&nbsp;needed.&nbsp;So&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;do&nbsp;soft&nbsp;real&nbsp;time&nbsp;stuff,&nbsp;mono&nbsp;might&nbsp;not&nbsp;be&lt;/div&gt;<br>
&lt;div&gt;the&nbsp;perfect&nbsp;tool&nbsp;for&nbsp;that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;are&nbsp;some&nbsp;steps&nbsp;that&nbsp;can&nbsp;be&nbsp;taken&nbsp;to&nbsp;decrease&nbsp;the&nbsp;latencies:&lt;/div&gt;&lt;div&gt;-&nbsp;For&nbsp;pinvoke,&nbsp;there&nbsp;is&nbsp;a Marshal.Prelink&nbsp;method&nbsp;which&nbsp;loads/looks&nbsp;up&nbsp;the&nbsp;pinvoked&nbsp;function.&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;For&nbsp;aot,&nbsp;the&nbsp;aot&nbsp;image&nbsp;is&nbsp;loaded&nbsp;when&nbsp;the&nbsp;corresponding&nbsp;assembly&nbsp;is&nbsp;loaded.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Zoltan&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;May&nbsp;4,&nbsp;2010&nbsp;at&nbsp;2:16&nbsp;PM,&nbsp;Martin&nbsp;Däumler&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mdae@cs.tu-chemnitz.de&quot;&gt;mdae@cs.tu-chemnitz.de&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;Hello&nbsp;Mono&nbsp;developers,&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;need&nbsp;some&nbsp;help&nbsp;from&nbsp;Mono&nbsp;internals&nbsp;experts.&nbsp;Briefly&nbsp;speaking,&lt;br&gt;<br>
I&nbsp;want&nbsp;to&nbsp;know&nbsp;exactly&nbsp;why&nbsp;the&nbsp;first&nbsp;execution&nbsp;of&nbsp;a&nbsp;code&nbsp;snippet,&lt;br&gt;<br>
e.g.,&nbsp;a&nbsp;P/Invoke,&nbsp;within&nbsp;Mono&nbsp;takes&nbsp;more&nbsp;time&nbsp;than&nbsp;the&nbsp;second&nbsp;run,&lt;br&gt;<br>
especially&nbsp;in&nbsp;AOT&nbsp;case.&nbsp;First&nbsp;of&nbsp;all,&nbsp;I&nbsp;already&nbsp;read&nbsp;the&nbsp;AOT&lt;br&gt;<br>
documentation&nbsp;[1].&nbsp;I&nbsp;also&nbsp;tried&nbsp;to&nbsp;dive&nbsp;into&nbsp;the&nbsp;code&nbsp;and&nbsp;wrote&lt;br&gt;<br>
some&nbsp;Mono&nbsp;tracing&nbsp;outputs&nbsp;...&nbsp;but&nbsp;it&nbsp;is&nbsp;quite&nbsp;complex&nbsp;to&nbsp;select&lt;br&gt;<br>
the&nbsp;necessary&nbsp;information&nbsp;from&nbsp;the&nbsp;whole&nbsp;chain&nbsp;of&nbsp;methods&nbsp;that&lt;br&gt;<br>
keep&nbsp;Mono&nbsp;running.&lt;br&gt;<br>
&lt;br&gt;<br>
Source&nbsp;files&nbsp;for&nbsp;the&nbsp;example&nbsp;and&nbsp;information&nbsp;about&nbsp;the&nbsp;test&nbsp;system&lt;br&gt;<br>
(for&nbsp;short:&nbsp;Linux&nbsp;on&nbsp;x86)&nbsp;can&nbsp;be&nbsp;downloaded&nbsp;under&nbsp;[2].&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;Let&amp;#39;s&nbsp;examine&nbsp;a&nbsp;simple&nbsp;P/Invoke&nbsp;which&nbsp;is&nbsp;executed&nbsp;several&nbsp;times.&lt;br&gt;<br>
&nbsp; &nbsp;The&nbsp;invoked&nbsp;method&nbsp;just&nbsp;returns&nbsp;the&nbsp;method&nbsp;parameter&amp;#39;s&nbsp;value.&nbsp;The&lt;br&gt;<br>
&nbsp; &nbsp;very&nbsp;first&nbsp;P/Invoke&nbsp;takes&nbsp;much&nbsp;more&nbsp;time&nbsp;(JIT:&nbsp;approx.&nbsp;312&nbsp;µs,&lt;br&gt;<br>
&nbsp; &nbsp;AOT:&nbsp;&amp;gt;&nbsp;100&nbsp;ms)&nbsp;than&nbsp;the&nbsp;following&nbsp;ones&nbsp;(JIT:&nbsp;6&nbsp;or&nbsp;7&nbsp;µs,&nbsp;AOT:&nbsp;&amp;lt;&nbsp;1&nbsp;µs)&lt;br&gt;<br>
&nbsp; &nbsp;on&nbsp;the&nbsp;test&nbsp;system.&nbsp;Test2&nbsp;and&nbsp;Test3&nbsp;are&nbsp;variants&nbsp;of&nbsp;Test1&nbsp;which&lt;br&gt;<br>
&nbsp; &nbsp;demonstrate&nbsp;cache&nbsp;effects.&nbsp;However,&nbsp;the&nbsp;very&nbsp;first&nbsp;execution&nbsp;takes&lt;br&gt;<br>
&nbsp; &nbsp;longer&nbsp;in&nbsp;every&nbsp;case,&nbsp;so&nbsp;that&amp;#39;s&nbsp;not&nbsp;all&nbsp;due&nbsp;to&nbsp;cache&nbsp;effects.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;want&nbsp;to&nbsp;know&nbsp;how&nbsp;to&nbsp;make&nbsp;the&nbsp;execution&nbsp;of&nbsp;a&nbsp;code&nbsp;snippet/method&lt;br&gt;<br>
deterministic,&nbsp;i.e.,&nbsp;like&nbsp;C&nbsp;code&nbsp;can&nbsp;be&nbsp;deterministic,&nbsp;not&nbsp;necessarily&lt;br&gt;<br>
&amp;quot;fast&amp;quot;.&nbsp;That&nbsp;is,&nbsp;I&nbsp;tolerate&nbsp;a&nbsp;kind&nbsp;of&nbsp;&amp;quot;initialization&amp;quot;&nbsp;at&nbsp;startup&nbsp;time&lt;br&gt;<br>
of&nbsp;Mono,&nbsp;but&nbsp;the&nbsp;first&nbsp;execution&nbsp;must&nbsp;not&nbsp;take&nbsp;(much)&nbsp;more&nbsp;time&nbsp;than&lt;br&gt;<br>
following&nbsp;executions&nbsp;of&nbsp;the&nbsp;code&nbsp;snippet.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;detail:&lt;br&gt;<br>
==========&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;(How)&nbsp;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;load&nbsp;a&nbsp;AOT&nbsp;image&nbsp;completely&nbsp;into&nbsp;memory&lt;br&gt;<br>
&nbsp; &nbsp;(not&nbsp;just&nbsp;map&nbsp;into&nbsp;memory)&nbsp;before&nbsp;executing&nbsp;one&nbsp;of&nbsp;its&nbsp;methods?&lt;br&gt;<br>
&nbsp; &nbsp;Which&nbsp;function&nbsp;of&nbsp;Mono&nbsp;has&nbsp;to&nbsp;be&nbsp;called&nbsp;which&nbsp;way?&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;(How)&nbsp;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;fill&nbsp;the&nbsp;GOT-&nbsp;and&nbsp;PLT-entries&nbsp;_before_&lt;br&gt;<br>
&nbsp; &nbsp;they&nbsp;are&nbsp;used&nbsp;the&nbsp;first&nbsp;time?&nbsp;Maybe&nbsp;a&nbsp;GOT-entry&nbsp;can&nbsp;not&nbsp;be&lt;br&gt;<br>
&nbsp; &nbsp;filled&nbsp;beforehand&nbsp;if&nbsp;a&nbsp;runtime&nbsp;object&amp;#39;s&nbsp;address&nbsp;is&nbsp;not&nbsp;known&nbsp;at&lt;br&gt;<br>
&nbsp; &nbsp;startup&nbsp;time?&nbsp;Which&nbsp;function&nbsp;is&nbsp;called&nbsp;to&nbsp;do&nbsp;this&lt;br&gt;<br>
&nbsp; &nbsp;(&nbsp;decode_patch_info()?&nbsp;)?&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;Which&nbsp;additional&nbsp;functions&nbsp;have&nbsp;to&nbsp;be&nbsp;called&nbsp;when&nbsp;a&nbsp;AOT&nbsp;image&amp;#39;s&lt;br&gt;<br>
&nbsp; &nbsp;method&nbsp;is&nbsp;executed&nbsp;the&nbsp;first&nbsp;time?&nbsp;I.e.,&nbsp;how&nbsp;to&nbsp;get&nbsp;metadata&lt;br&gt;<br>
&nbsp; &nbsp;(mono_aot_get_class_info()?)&nbsp;or&nbsp;other&nbsp;necessary&nbsp;information/runtime&lt;br&gt;<br>
&nbsp; &nbsp;structures&nbsp;for&nbsp;the&nbsp;Mono&nbsp;runtime&nbsp;in&nbsp;advance?&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;Are&nbsp;there&nbsp;any&nbsp;other&nbsp;functions&nbsp;that&nbsp;could&nbsp;cause&nbsp;longer&nbsp;execution&lt;br&gt;<br>
&nbsp; &nbsp;time&nbsp;on&nbsp;first&nbsp;execution?&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;Any&nbsp;idea&nbsp;to&nbsp;measure&nbsp;execution&nbsp;time&nbsp;of&nbsp;managed&nbsp;code&nbsp;in&nbsp;granularity&lt;br&gt;<br>
&nbsp; &nbsp;of&nbsp;µs&nbsp;without&nbsp;using&nbsp;P/Invoke?&nbsp;The&nbsp;Environment.TickCount&nbsp;only&nbsp;provides&lt;br&gt;<br>
&nbsp; &nbsp;granularity&nbsp;of&nbsp;ms.&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;Why&nbsp;is&nbsp;the&nbsp;execution&nbsp;of&nbsp;code&nbsp;snippets&nbsp;in&nbsp;a&nbsp;loop&nbsp;faster&nbsp;than&lt;br&gt;<br>
&nbsp; &nbsp;when&nbsp;rolling&nbsp;out&nbsp;the&nbsp;loop&nbsp;in&nbsp;the&nbsp;JIT&nbsp;case?&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp;-&nbsp;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;JIT-compile&nbsp;all&nbsp;necessary&nbsp;wrapper&nbsp;methods&lt;br&gt;<br>
&nbsp; &nbsp;during&nbsp;the&nbsp;&amp;quot;initialization&amp;quot;&nbsp;(instead&nbsp;of&nbsp;porting&nbsp;Full&nbsp;AOT&nbsp;to&lt;br&gt;<br>
&nbsp; &nbsp;x86)?&nbsp;Note&nbsp;that&nbsp;AOTed&nbsp;wrapper&nbsp;methods&nbsp;(in&nbsp;the&nbsp;Full&nbsp;AOT&nbsp;case)&lt;br&gt;<br>
&nbsp; &nbsp;could&nbsp;also&nbsp;impose&nbsp;some&nbsp;overhead&nbsp;when&nbsp;starting&nbsp;first&nbsp;execution&lt;br&gt;<br>
&nbsp; &nbsp;since&nbsp;GOT-&nbsp;and/or&nbsp;PLT-entries&nbsp;have&nbsp;to&nbsp;be&nbsp;filled.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;kind&nbsp;regards,&lt;br&gt;<br>
Martin&nbsp;Däumler&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
[1]&nbsp;&lt;a&nbsp;href=&quot;http://mono-project.com/Mono:Runtime:Documentation:AOT&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mono-project.com/Mono:Runtime:Documentation:AOT&lt;/a&gt;&lt;br&gt;<br>
[2]&nbsp;&lt;a&nbsp;href=&quot;http://www.tu-chemnitz.de/~mdae/sample-code.zip&quot;&nbsp;target=&quot;_blank&quot;&gt;http://www.tu-chemnitz.de/~mdae/sample-code.zip&lt;/a&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
