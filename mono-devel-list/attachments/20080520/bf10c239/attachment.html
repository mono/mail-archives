<tt>
Hey,&lt;br&gt;&lt;br&gt;The&nbsp;attached&nbsp;patch&nbsp;implements&nbsp;managed&nbsp;code&nbsp;thread&nbsp;abort&nbsp;by&nbsp;installing&nbsp;a&nbsp;trampoline&nbsp;on&nbsp;signal&nbsp;return.&lt;br&gt;&lt;br&gt;This&nbsp;patch&nbsp;introduces&nbsp;two&nbsp;new&nbsp;arch&nbsp;specific&nbsp;functions,&nbsp;that&nbsp;I&amp;#39;ll&nbsp;port&nbsp;to&nbsp;arm&nbsp;and&nbsp;amd64&nbsp;once&nbsp;the&nbsp;current&nbsp;patch&lt;br&gt;<br>
<br>
is&nbsp;committed:&lt;br&gt;&lt;br&gt;void&nbsp;mono_arch_set_ip_in_context&nbsp;(void&nbsp;*sigctx,&nbsp;void&nbsp;*new_ip)&nbsp;MONO_INTERNAL;&lt;br&gt;gpointer&nbsp;mono_arch_get_call_interrupt_trampoline&nbsp;(gpointer&nbsp;process_interrup_function)&nbsp;MONO_INTERNAL;&lt;br&gt;&lt;br&gt;The&nbsp;first&nbsp;one&nbsp;is&nbsp;used&nbsp;to&nbsp;hijack&nbsp;the&nbsp;managed&nbsp;code&nbsp;execution&nbsp;and&nbsp;call&nbsp;the&nbsp;trampoline.&lt;br&gt;<br>
<br>
The&nbsp;second&nbsp;one&nbsp;fix&nbsp;the&nbsp;callstack,&nbsp;build&nbsp;a&nbsp;MonoContext&nbsp;and&nbsp;call&nbsp;process_interrup_function.&nbsp;The&nbsp;trampoline&lt;br&gt;must&nbsp;allow&nbsp;to&nbsp;resume&nbsp;execution&nbsp;of&nbsp;the&nbsp;managed&nbsp;method&nbsp;as&nbsp;it&nbsp;could&nbsp;be&nbsp;inside&nbsp;a&nbsp;protected&nbsp;wrapper.&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;moved&nbsp;this&nbsp;check&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;reduce&nbsp;the&nbsp;amount&nbsp;of&nbsp;signal&nbsp;safe&nbsp;code&nbsp;we&nbsp;need,&nbsp;which&lt;br&gt;<br>
<br>
improves&nbsp;reliability&nbsp;and&nbsp;gives&nbsp;us&nbsp;more&nbsp;freedom&nbsp;on&nbsp;the&nbsp;implementation.&lt;br&gt;&lt;br&gt;This&nbsp;patch&nbsp;doesn&amp;#39;t&nbsp;tackle&nbsp;mono_thread_request_interruption&nbsp;yet.&nbsp;The&nbsp;plan&nbsp;is&nbsp;to&nbsp;split&nbsp;it&nbsp;into&nbsp;three&nbsp;parts:&lt;br&gt;&lt;br&gt;-Managed&nbsp;code&nbsp;interrupt,&nbsp;called&nbsp;from&nbsp;the&nbsp;abort&nbsp;trampoline&lt;br&gt;<br>
<br>
-Alertable-wait&nbsp;wake&nbsp;up,&nbsp;called&nbsp;as&nbsp;part&nbsp;of&nbsp;Thread::Abort&lt;br&gt;-Unmanaged&nbsp;code&nbsp;interrupt,&nbsp;called&nbsp;from&nbsp;the&nbsp;signal&nbsp;handler&nbsp;-&nbsp;this&nbsp;should&nbsp;end&nbsp;been&nbsp;just&nbsp;incrementing&nbsp;thread_interruption_requested.&lt;br&gt;&lt;br&gt;This&nbsp;doesn&amp;#39;t&nbsp;handle&nbsp;the&nbsp;windows&nbsp;situation,&nbsp;which&nbsp;is&nbsp;something&nbsp;I&amp;#39;ll&nbsp;do&nbsp;next.&lt;br&gt;<br>
<br>
&lt;br&gt;Thanks,&lt;br&gt;Rodrigo<br>

</tt>
