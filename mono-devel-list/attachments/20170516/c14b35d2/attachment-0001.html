<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Below&nbsp;is&nbsp;a&nbsp;proposed&nbsp;solution&nbsp;to&nbsp;implement&nbsp;support&nbsp;of&nbsp;CoreCLR&nbsp;ICastable&nbsp;feature&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Why:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ICastable&nbsp;is&nbsp;supported&nbsp;by&nbsp;CoreCLR&nbsp;and&nbsp;used&nbsp;by&nbsp;MCG&nbsp;(Microsoft&nbsp;interop&nbsp;codegen&nbsp;tooling&nbsp;for&nbsp;WinRT&nbsp;API&#39;s)&nbsp;in&nbsp;order&nbsp;to&nbsp;call&nbsp;WinRT&nbsp;API&#39;s&nbsp;from&nbsp;managed&nbsp;code&nbsp;on&nbsp;Windows&nbsp;platforms.&nbsp;MCG&nbsp;consumes&nbsp;winmd&nbsp;files&nbsp;+&nbsp;a&nbsp;closure&nbsp;of&nbsp;WinRT&nbsp;API&nbsp;used&nbsp;by&nbsp;an&nbsp;application&nbsp;generating&nbsp;managed&nbsp;interop&nbsp;code.&nbsp;Supporting&nbsp;ICastable&nbsp;is&nbsp;a&nbsp;prerequisite&nbsp;in&nbsp;order&nbsp;to&nbsp;support&nbsp;MCG&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;requirements&nbsp;on&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;is&nbsp;described&nbsp;in&nbsp;the&nbsp;interface:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/dotnet/coreclr/blob/68f72dd2587c3365a9fe74d1991f93612c3bc62a/src/mscorlib/src/System/Runtime/CompilerServices/ICastable.cs&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;68f72dd2587c3365a9fe74d1991f93&lt;wbr&gt;612c3bc62a/src/mscorlib/src/&lt;wbr&gt;System/Runtime/&lt;wbr&gt;CompilerServices/ICastable.cs&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;is&nbsp;also&nbsp;a&nbsp;test&nbsp;case&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;Mono&#39;s&nbsp;implementation&nbsp;of&nbsp;ICastable:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/dotnet/coreclr/blob/84aab5f59d023849b9ccdc290e698e4a61ac75a2/tests/src/Interop/ICastable/Castable.cs&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;84aab5f59d023849b9ccdc290e698e&lt;wbr&gt;4a61ac75a2/tests/src/Interop/&lt;wbr&gt;ICastable/Castable.cs&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;+&nbsp;additional&nbsp;Mono&nbsp;extensions&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to&nbsp;run&nbsp;a&nbsp;couple&nbsp;of&nbsp;MCG-&gt;WinRT&nbsp;samples&nbsp;testing&nbsp;MCG&#39;s&nbsp;usage&nbsp;of&nbsp;Mono&#39;s&nbsp;ICastable&nbsp;implementation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;should&nbsp;work&nbsp;on&nbsp;Windows&nbsp;x64&nbsp;JIT&nbsp;+&nbsp;full&nbsp;AOT.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;How:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ICastable&nbsp;is&nbsp;a&nbsp;specific&nbsp;feature&nbsp;with&nbsp;several&nbsp;restrictions&nbsp;and&nbsp;constraints.&nbsp;The&nbsp;purpose&nbsp;is&nbsp;to&nbsp;dynamically,&nbsp;at&nbsp;runtime,&nbsp;add&nbsp;interfaces&nbsp;and&nbsp;implementation&nbsp;to&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;not&nbsp;part&nbsp;of&nbsp;the&nbsp;types&nbsp;original&nbsp;metadata.&nbsp;The&nbsp;added&nbsp;interfaces&nbsp;are&nbsp;then&nbsp;implemented&nbsp;by&nbsp;a&nbsp;complete&nbsp;different&nbsp;unrelated&nbsp;type&nbsp;returned&nbsp;by&nbsp;implementation&nbsp;of&nbsp;ICastable&nbsp;interface.&nbsp;That&nbsp;put&nbsp;some&nbsp;specific&nbsp;requirements&nbsp;on&nbsp;both&nbsp;the&nbsp;runtime&nbsp;but&nbsp;also&nbsp;on&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;class&nbsp;implementing&nbsp;the&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;its&nbsp;dispatch&nbsp;targets.&nbsp;Due&nbsp;to&nbsp;this,&nbsp;the&nbsp;feature&nbsp;should&nbsp;be&nbsp;considered&nbsp;&quot;Private&quot;&nbsp;limiting&nbsp;it&#39;s&nbsp;use&nbsp;and&nbsp;support&nbsp;to&nbsp;specific&nbsp;use&nbsp;cases.&nbsp;The&nbsp;main&nbsp;initial&nbsp;target&nbsp;is&nbsp;MCG&nbsp;stubs&nbsp;and&nbsp;interopability&nbsp;with&nbsp;WinRT&nbsp;API&#39;s&nbsp;on&nbsp;Windows&nbsp;platforms.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;Runtime:&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Looking&nbsp;into&nbsp;the&nbsp;current&nbsp;Mono&nbsp;source&nbsp;there&nbsp;is&nbsp;currently&nbsp;a&nbsp;feature&nbsp;that&nbsp;has&nbsp;similar&nbsp;characteristics&nbsp;and&nbsp;behavior&nbsp;as&nbsp;ICastable,&nbsp;transparent&nbsp;proxy&nbsp;support&nbsp;used&nbsp;by&nbsp;remoting.&nbsp;The&nbsp;plan&nbsp;is&nbsp;to&nbsp;use&nbsp;that&nbsp;as&nbsp;inspiration&nbsp;but&nbsp;not&nbsp;depending&nbsp;on&nbsp;current&nbsp;implementation&nbsp;(should&nbsp;not&nbsp;need&nbsp;to&nbsp;include&nbsp;remoting&nbsp;support&nbsp;to&nbsp;work).&nbsp;The&nbsp;underlying&nbsp;mechanism&nbsp;is&nbsp;still&nbsp;similar,&nbsp;dynamically&nbsp;extend&nbsp;an&nbsp;objects&nbsp;vtable&nbsp;if&nbsp;an&nbsp;objects&nbsp;gets&nbsp;casted&nbsp;to&nbsp;an&nbsp;interface&nbsp;indirectly&nbsp;supported&nbsp;by&nbsp;the&nbsp;underlying&nbsp;implementation&nbsp;of&nbsp;ICastable&nbsp;(or&nbsp;IRemotingTypeInfo.CanCastTo&nbsp;in&nbsp;remoting&nbsp;use&nbsp;case).&nbsp;The&nbsp;idea&nbsp;is&nbsp;to&nbsp;generalize&nbsp;and&nbsp;share&nbsp;the&nbsp;code&nbsp;already&nbsp;doing&nbsp;this&nbsp;logic&nbsp;in&nbsp;remoting&nbsp;making&nbsp;sure&nbsp;we&nbsp;only&nbsp;include&nbsp;one&nbsp;implementation&nbsp;of&nbsp;key&nbsp;features&nbsp;like&nbsp;rebuilding&nbsp;the&nbsp;vtable&nbsp;(currently&nbsp;done&nbsp;inÂ mono_class_proxy_vtable).&nbsp;ICastable&nbsp;implementation&nbsp;will&nbsp;also&nbsp;include&nbsp;a&nbsp;cache&nbsp;similar&nbsp;to&nbsp;the&nbsp;one&nbsp;used&nbsp;in&nbsp;the&nbsp;remoting&nbsp;use&nbsp;case&nbsp;(see&nbsp;mono_upgrade_remote_class&nbsp;for&nbsp;details).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;All&nbsp;code&nbsp;related&nbsp;to&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;will&nbsp;be&nbsp;guarded&nbsp;by&nbsp;a&nbsp;defined,&nbsp;FEATURE_ICASTABLE,&nbsp;so&nbsp;all&nbsp;platforms&nbsp;not&nbsp;needing&nbsp;this&nbsp;support&nbsp;(currently&nbsp;only&nbsp;needed&nbsp;on&nbsp;WinRT&nbsp;platforms),&nbsp;won&#39;t&nbsp;be&nbsp;affected&nbsp;by&nbsp;this&nbsp;change.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;BCL:&lt;/u&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;+&nbsp;helper&nbsp;class&nbsp;can&nbsp;be&nbsp;included&nbsp;from&nbsp;CoreCLR&nbsp;into&nbsp;Mono&#39;s&nbsp;mscorlib&nbsp;with&nbsp;a&nbsp;small&nbsp;adjustment&nbsp;to&nbsp;the&nbsp;helper&nbsp;class:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://github.com/dotnet/coreclr/blob/68f72dd2587c3365a9fe74d1991f93612c3bc62a/src/mscorlib/src/System/Runtime/CompilerServices/ICastable.cs&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;68f72dd2587c3365a9fe74d1991f93&lt;wbr&gt;612c3bc62a/src/mscorlib/src/&lt;wbr&gt;System/Runtime/&lt;wbr&gt;CompilerServices/ICastable.cs&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Part&nbsp;of&nbsp;supporting&nbsp;ICastable&nbsp;includes&nbsp;adding&nbsp;the&nbsp;above&nbsp;assembly&nbsp;and&nbsp;classes&nbsp;to&nbsp;Mono&#39;s&nbsp;BCL.&nbsp;It&nbsp;should&nbsp;build&nbsp;under&nbsp;net_4_x&nbsp;and&nbsp;winAOT&nbsp;profiles.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;u&gt;Examples&nbsp;of&nbsp;things&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;done&nbsp;to&nbsp;support&nbsp;ICastable:&lt;/u&gt;&lt;div&gt;&lt;br&gt;&lt;ul&gt;&lt;li&gt;Extend&nbsp;MonoVTable&nbsp;with&nbsp;a&nbsp;field&nbsp;indicating&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;(optimization&nbsp;for&nbsp;fast&nbsp;lookups&nbsp;and&nbsp;checks).&nbsp;Since&nbsp;this&nbsp;field&nbsp;is&nbsp;checked&nbsp;both&nbsp;by&nbsp;C&nbsp;code&nbsp;and&nbsp;generated&nbsp;code&nbsp;(handle_isinst,&nbsp;handle_castclass)&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;addressable.&nbsp;Field&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to&nbsp;include&nbsp;more&nbsp;meta&nbsp;information&nbsp;when&nbsp;an&nbsp;object&nbsp;implements&nbsp;ICastable&nbsp;and&nbsp;has&nbsp;been&nbsp;casted&nbsp;to&nbsp;different&nbsp;interfaces&nbsp;(needed&nbsp;by&nbsp;both&nbsp;caching&nbsp;and&nbsp;vtable&nbsp;rebuild).&lt;br&gt;&lt;/li&gt;&lt;li&gt;Extend&nbsp;mono_object_handle_isinst_&lt;wbr&gt;mbyref&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;br&gt;&lt;/li&gt;&lt;li&gt;Extend&nbsp;handle_isinst&nbsp;and&nbsp;handle_castclass&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;br&gt;&lt;/li&gt;&lt;li&gt;Extend&nbsp;objects&nbsp;vtable&nbsp;with&nbsp;new&nbsp;interfaces&nbsp;implemented&nbsp;by&nbsp;a&nbsp;different&nbsp;type&nbsp;indicated&nbsp;by&nbsp;ICastable::&lt;wbr&gt;IsInstanceOfInterface.&nbsp;Similar&nbsp;to&nbsp;how&nbsp;mono_upgrade_remote_class&nbsp;works&nbsp;for&nbsp;remote&nbsp;objects.&lt;br&gt;&lt;/li&gt;&lt;li&gt;Add&nbsp;support&nbsp;to&nbsp;mono_vcall_trampoline&nbsp;to&nbsp;resolve&nbsp;method&nbsp;implementation&nbsp;for&nbsp;ICastable&nbsp;objects&nbsp;when&nbsp;not&nbsp;directly&nbsp;implemented&nbsp;by&nbsp;type.&nbsp;Implementing&nbsp;type&nbsp;for&nbsp;method&nbsp;is&nbsp;returned&nbsp;by&nbsp;ICastable::GetImplType.&lt;br&gt;&lt;/li&gt;&lt;li&gt;Cache&nbsp;dynamically&nbsp;generated&nbsp;vtables&nbsp;based&nbsp;on&nbsp;object&nbsp;class&nbsp;+&nbsp;additional&nbsp;supported&nbsp;interface(s).&lt;br&gt;&lt;/li&gt;&lt;li&gt;Add&nbsp;support&nbsp;for&nbsp;CoreCLR&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;support&nbsp;class&nbsp;in&nbsp;Mono&#39;s&nbsp;mscorlib&nbsp;(net_4_x,&nbsp;winAOT&nbsp;profiles).&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;I&nbsp;have&nbsp;implemented&nbsp;a&nbsp;POC&nbsp;using&nbsp;the&nbsp;above&nbsp;approach&nbsp;and&nbsp;it&nbsp;solve&nbsp;the&nbsp;use&nbsp;case,&nbsp;getting&nbsp;pass&nbsp;on&nbsp;all&nbsp;tests&nbsp;in&nbsp;CoreCLR&nbsp;ICastable&nbsp;test&nbsp;suite&nbsp;and&nbsp;working&nbsp;with&nbsp;MCG&nbsp;stub&nbsp;samples,&nbsp;so&nbsp;above&nbsp;suggestion&nbsp;seems&nbsp;at&nbsp;least&nbsp;to&nbsp;be&nbsp;a&nbsp;way&nbsp;moving&nbsp;forward&nbsp;implementing&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Comments,&nbsp;thoughts&nbsp;and&nbsp;ideas&nbsp;are&nbsp;much&nbsp;appreciated.&lt;/div&gt;&lt;/div&gt;<br>

</tt>
