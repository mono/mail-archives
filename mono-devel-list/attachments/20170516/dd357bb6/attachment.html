<tt>
&lt;html&nbsp;xmlns:o=&quot;urn:schemas-microsoft-com:office:office&quot;&nbsp;xmlns:w=&quot;urn:schemas-microsoft-com:office:word&quot;&nbsp;xmlns:m=&quot;http://schemas.microsoft.com/office/2004/12/omml&quot;&nbsp;xmlns=&quot;http://www.w3.org/TR/REC-html40&quot;&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;meta&nbsp;name=&quot;Title&quot;&nbsp;content=&quot;&quot;&gt;<br>
&lt;meta&nbsp;name=&quot;Keywords&quot;&nbsp;content=&quot;&quot;&gt;<br>
&lt;meta&nbsp;name=&quot;Generator&quot;&nbsp;content=&quot;Microsoft&nbsp;Word&nbsp;15&nbsp;(filtered&nbsp;medium)&quot;&gt;<br>
&lt;style&gt;&lt;!--<br>
/*&nbsp;Font&nbsp;Definitions&nbsp;*/<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:&quot;Courier&nbsp;New&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;7&nbsp;3&nbsp;9&nbsp;2&nbsp;2&nbsp;5&nbsp;2&nbsp;4&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Wingdings;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:5&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:&quot;Cambria&nbsp;Math&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;4&nbsp;5&nbsp;3&nbsp;5&nbsp;4&nbsp;6&nbsp;3&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Calibri;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;15&nbsp;5&nbsp;2&nbsp;2&nbsp;2&nbsp;4&nbsp;3&nbsp;2&nbsp;4;}<br>
/*&nbsp;Style&nbsp;Definitions&nbsp;*/<br>
p.MsoNormal,&nbsp;li.MsoNormal,&nbsp;div.MsoNormal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin:0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-bottom:.0001pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:12.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Times&nbsp;New&nbsp;Roman&quot;,serif;}<br>
a:link,&nbsp;span.MsoHyperlink<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:blue;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
a:visited,&nbsp;span.MsoHyperlinkFollowed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:purple;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
span.EmailStyle17<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:personal-reply;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,sans-serif;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:windowtext;}<br>
span.msoIns<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:export-only;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-style-name:&quot;&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:teal;}<br>
.MsoChpDefault<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:export-only;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:10.0pt;}<br>
@page&nbsp;WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{size:8.5in&nbsp;11.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:1.0in&nbsp;1.0in&nbsp;1.0in&nbsp;1.0in;}<br>
div.WordSection1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{page:WordSection1;}<br>
/*&nbsp;List&nbsp;Definitions&nbsp;*/<br>
@list&nbsp;l0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-list-id:2007705164;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-list-template-ids:-871974022;}<br>
@list&nbsp;l0:level1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:.5in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Symbol;}<br>
@list&nbsp;l0:level2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:o;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:1.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Courier&nbsp;New&quot;,serif;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-bidi-font-family:&quot;Times&nbsp;New&nbsp;Roman&quot;;}<br>
@list&nbsp;l0:level3<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:1.5in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level4<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:2.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:2.5in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level6<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:3.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level7<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:3.5in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level8<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:4.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
@list&nbsp;l0:level9<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-level-number-format:bullet;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-text:;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-tab-stop:4.5in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-level-number-position:left;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-indent:-.25in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mso-ansi-font-size:10.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:Wingdings;}<br>
ol<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin-bottom:0in;}<br>
ul<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin-bottom:0in;}<br>
--&gt;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;white&quot;&nbsp;lang=&quot;EN-US&quot;&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&gt;<br>
&lt;div&nbsp;class=&quot;WordSection1&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Hi&nbsp;Johan,&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Transparent&nbsp;proxy&nbsp;needs&nbsp;to&nbsp;extend&nbsp;the&nbsp;vtable&nbsp;due&nbsp;to&nbsp;virtual&nbsp;methods.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;ICastable&nbsp;(IC),&nbsp;IIRC,&nbsp;doesn't&nbsp;need&nbsp;to,&nbsp;as&nbsp;it's&nbsp;only&nbsp;possible&nbsp;to&nbsp;dispatch&nbsp;to&nbsp;interface&nbsp;methods.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Beyond&nbsp;that,&nbsp;vtable&nbsp;patching&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;other&nbsp;complications,&nbsp;it&nbsp;breaks&nbsp;invariants&nbsp;such&nbsp;as&nbsp;that&nbsp;two&nbsp;instances&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;of&nbsp;the&nbsp;same&nbsp;class&nbsp;must&nbsp;have&nbsp;the&nbsp;same&nbsp;vtable&nbsp;pointer&nbsp;-&nbsp;we&nbsp;compare&nbsp;them&nbsp;all&nbsp;over&nbsp;the&nbsp;place.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;the&nbsp;following:&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Types&nbsp;implementing&nbsp;IC&nbsp;would&nbsp;force&nbsp;their&nbsp;IMT&nbsp;thunks&nbsp;to&nbsp;have&nbsp;a&nbsp;fail&nbsp;tramp,&nbsp;in&nbsp;a&nbsp;similar&nbsp;fashion&nbsp;as&nbsp;its&nbsp;done&nbsp;for&nbsp;other&nbsp;cases.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;imt&nbsp;fail&nbsp;trampoline&nbsp;code&nbsp;would&nbsp;then&nbsp;be&nbsp;adjusted&nbsp;to&nbsp;handle&nbsp;IC.&nbsp;It's&nbsp;a&nbsp;much&nbsp;simpler&nbsp;and&nbsp;maintainable&nbsp;change.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;That&nbsp;would&nbsp;not&nbsp;require&nbsp;changes&nbsp;to&nbsp;our&nbsp;compilation&nbsp;pipeline.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;comes&nbsp;the&nbsp;second&nbsp;part,&nbsp;type&nbsp;testing.&nbsp;We&nbsp;should&nbsp;be&nbsp;taking&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;clean&nbsp;up&nbsp;the&nbsp;casting&nbsp;code&nbsp;a&nbsp;bit.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;that&nbsp;we&nbsp;use&nbsp;space&nbsp;in&nbsp;the&nbsp;vtable&nbsp;to&nbsp;indicate&nbsp;whether&nbsp;type&nbsp;testing&nbsp;has&nbsp;a&nbsp;slow&nbsp;path.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Right&nbsp;now,&nbsp;we&nbsp;have&nbsp;a&nbsp;couple&nbsp;of&nbsp;cases:&nbsp;special&nbsp;array&nbsp;interfaces&nbsp;and&nbsp;TP.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;to&nbsp;unify&nbsp;the&nbsp;TP&nbsp;and&nbsp;the&nbsp;ICastable&nbsp;checks&nbsp;in&nbsp;the&nbsp;common&nbsp;path&nbsp;and&nbsp;outline&nbsp;the&nbsp;resolution&nbsp;of&nbsp;those.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;We&nbsp;should&nbsp;them&nbsp;experiment&nbsp;applying&nbsp;the&nbsp;same&nbsp;idea&nbsp;to&nbsp;special&nbsp;array&nbsp;interfaces&nbsp;and&nbsp;see&nbsp;whether&nbsp;performance&nbsp;numbers&nbsp;hold.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;We'd&nbsp;need&nbsp;to&nbsp;add&nbsp;checks&nbsp;for&nbsp;IC&nbsp;to&nbsp;all&nbsp;places&nbsp;we&nbsp;do&nbsp;today&nbsp;for&nbsp;TP.&nbsp;They&nbsp;might&nbsp;require&nbsp;big&nbsp;code&nbsp;changes&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;as&nbsp;the&nbsp;TP&nbsp;checks&nbsp;don't&nbsp;require&nbsp;calling&nbsp;into&nbsp;managed&nbsp;while&nbsp;IC&nbsp;does.&nbsp;The&nbsp;comments&nbsp;in&nbsp;that&nbsp;C#&nbsp;file&nbsp;don't&nbsp;mention&nbsp;impact&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;on&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&nbsp;runtime,&nbsp;like&nbsp;reflection,&nbsp;which&nbsp;we&nbsp;would&nbsp;need&nbsp;to&nbsp;verify&nbsp;as&nbsp;well.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;above&nbsp;model&nbsp;is&nbsp;how&nbsp;I&nbsp;think&nbsp;TP&nbsp;should&nbsp;be&nbsp;implemented,&nbsp;but&nbsp;that&nbsp;code&nbsp;predates&nbsp;IMTs.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Finally,&nbsp;there's&nbsp;no&nbsp;point&nbsp;in&nbsp;making&nbsp;ICastable&nbsp;an&nbsp;optional&nbsp;feature&nbsp;as&nbsp;it&nbsp;should&nbsp;be&nbsp;supported&nbsp;across&nbsp;the&nbsp;board.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;--&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Rodrigo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&nbsp;style=&quot;border:none;border-top:solid&nbsp;#B5C4DF&nbsp;1.0pt;padding:3.0pt&nbsp;0in&nbsp;0in&nbsp;0in&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;font-family:&quot;Calibri&quot;,sans-serif;color:black&quot;&gt;From:<br>
&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;font-family:&quot;Calibri&quot;,sans-serif;color:black&quot;&gt;Mono-devel-list&nbsp;&lt;mono-devel-list-bounces@lists.dot.net&gt;&nbsp;on&nbsp;behalf&nbsp;of&nbsp;Johan&nbsp;Lorensson&nbsp;&lt;lateralusx.github@gmail.com&gt;&lt;br&gt;<br>
&lt;b&gt;Date:&nbsp;&lt;/b&gt;Tuesday,&nbsp;May&nbsp;16,&nbsp;2017&nbsp;at&nbsp;2:44&nbsp;AM&lt;br&gt;<br>
&lt;b&gt;To:&nbsp;&lt;/b&gt;&quot;mono-devel-list@lists.dot.net&quot;&nbsp;&lt;mono-devel-list@lists.dot.net&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&nbsp;&lt;/b&gt;[Mono-dev]&nbsp;Supporting&nbsp;ICastable&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;o:p&gt;&lt;/o:p&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Hi,&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Below&nbsp;is&nbsp;a&nbsp;proposed&nbsp;solution&nbsp;to&nbsp;implement&nbsp;support&nbsp;of&nbsp;CoreCLR&nbsp;ICastable&nbsp;feature&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;Why:&lt;/b&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ICastable&nbsp;is&nbsp;supported&nbsp;by&nbsp;CoreCLR&nbsp;and&nbsp;used&nbsp;by&nbsp;MCG&nbsp;(Microsoft&nbsp;interop&nbsp;codegen&nbsp;tooling&nbsp;for&nbsp;WinRT&nbsp;API's)&nbsp;in&nbsp;order&nbsp;to&nbsp;call&nbsp;WinRT&nbsp;API's&nbsp;from&nbsp;managed&nbsp;code&nbsp;on&nbsp;Windows&nbsp;platforms.&nbsp;MCG&nbsp;consumes&nbsp;winmd&nbsp;files&nbsp;&#43;&nbsp;a&nbsp;closure&nbsp;of&nbsp;WinRT&nbsp;API&nbsp;used&nbsp;by&nbsp;an&nbsp;application<br>
&nbsp;generating&nbsp;managed&nbsp;interop&nbsp;code.&nbsp;Supporting&nbsp;ICastable&nbsp;is&nbsp;a&nbsp;prerequisite&nbsp;in&nbsp;order&nbsp;to&nbsp;support&nbsp;MCG&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;requirements&nbsp;on&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;is&nbsp;described&nbsp;in&nbsp;the&nbsp;interface:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F68f72dd2587c3365a9fe74d1991f93612c3bc62a%2Fsrc%2Fmscorlib%2Fsrc%2FSystem%2FRuntime%2FCompilerServices%2FICastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=t8tOm1Cvn9Klm4JwgxF%2BbeH%2Bqk%2B8sZbDOpIF2Q4t4Cc%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/coreclr/blob/68f72dd2587c3365a9fe74d1991f93612c3bc62a/src/mscorlib/src/System/Runtime/CompilerServices/ICastable.cs&lt;/a&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;There&nbsp;is&nbsp;also&nbsp;a&nbsp;test&nbsp;case&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;Mono's&nbsp;implementation&nbsp;of&nbsp;ICastable:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F84aab5f59d023849b9ccdc290e698e4a61ac75a2%2Ftests%2Fsrc%2FInterop%2FICastable%2FCastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=srFnEjYYl0MlveNf0dOKlydPiuXnb8Yy44XwVncoNWM%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/coreclr/blob/84aab5f59d023849b9ccdc290e698e4a61ac75a2/tests/src/Interop/ICastable/Castable.cs&lt;/a&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;&#43;&nbsp;additional&nbsp;Mono&nbsp;extensions&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to&nbsp;run&nbsp;a&nbsp;couple&nbsp;of&nbsp;MCG-&gt;WinRT&nbsp;samples&nbsp;testing&nbsp;MCG's&nbsp;usage&nbsp;of&nbsp;Mono's&nbsp;ICastable&nbsp;implementation.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;All&nbsp;should&nbsp;work&nbsp;on&nbsp;Windows&nbsp;x64&nbsp;JIT&nbsp;&#43;&nbsp;full&nbsp;AOT.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;How:&lt;/b&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ICastable&nbsp;is&nbsp;a&nbsp;specific&nbsp;feature&nbsp;with&nbsp;several&nbsp;restrictions&nbsp;and&nbsp;constraints.&nbsp;The&nbsp;purpose&nbsp;is&nbsp;to&nbsp;dynamically,&nbsp;at&nbsp;runtime,&nbsp;add&nbsp;interfaces&nbsp;and&nbsp;implementation&nbsp;to&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;not&nbsp;part&nbsp;of&nbsp;the&nbsp;types&nbsp;original&nbsp;metadata.&nbsp;The&nbsp;added&nbsp;interfaces&nbsp;are<br>
&nbsp;then&nbsp;implemented&nbsp;by&nbsp;a&nbsp;complete&nbsp;different&nbsp;unrelated&nbsp;type&nbsp;returned&nbsp;by&nbsp;implementation&nbsp;of&nbsp;ICastable&nbsp;interface.&nbsp;That&nbsp;put&nbsp;some&nbsp;specific&nbsp;requirements&nbsp;on&nbsp;both&nbsp;the&nbsp;runtime&nbsp;but&nbsp;also&nbsp;on&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;class&nbsp;implementing&nbsp;the&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;its&nbsp;dispatch<br>
&nbsp;targets.&nbsp;Due&nbsp;to&nbsp;this,&nbsp;the&nbsp;feature&nbsp;should&nbsp;be&nbsp;considered&nbsp;&quot;Private&quot;&nbsp;limiting&nbsp;it's&nbsp;use&nbsp;and&nbsp;support&nbsp;to&nbsp;specific&nbsp;use&nbsp;cases.&nbsp;The&nbsp;main&nbsp;initial&nbsp;target&nbsp;is&nbsp;MCG&nbsp;stubs&nbsp;and&nbsp;interopability&nbsp;with&nbsp;WinRT&nbsp;API's&nbsp;on&nbsp;Windows&nbsp;platforms.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;Runtime:&lt;/u&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Looking&nbsp;into&nbsp;the&nbsp;current&nbsp;Mono&nbsp;source&nbsp;there&nbsp;is&nbsp;currently&nbsp;a&nbsp;feature&nbsp;that&nbsp;has&nbsp;similar&nbsp;characteristics&nbsp;and&nbsp;behavior&nbsp;as&nbsp;ICastable,&nbsp;transparent&nbsp;proxy&nbsp;support&nbsp;used&nbsp;by&nbsp;remoting.&nbsp;The&nbsp;plan&nbsp;is&nbsp;to&nbsp;use&nbsp;that&nbsp;as&nbsp;inspiration&nbsp;but&nbsp;not&nbsp;depending&nbsp;on&nbsp;current<br>
&nbsp;implementation&nbsp;(should&nbsp;not&nbsp;need&nbsp;to&nbsp;include&nbsp;remoting&nbsp;support&nbsp;to&nbsp;work).&nbsp;The&nbsp;underlying&nbsp;mechanism&nbsp;is&nbsp;still&nbsp;similar,&nbsp;dynamically&nbsp;extend&nbsp;an&nbsp;objects&nbsp;vtable&nbsp;if&nbsp;an&nbsp;objects&nbsp;gets&nbsp;casted&nbsp;to&nbsp;an&nbsp;interface&nbsp;indirectly&nbsp;supported&nbsp;by&nbsp;the&nbsp;underlying&nbsp;implementation&nbsp;of&nbsp;ICastable<br>
&nbsp;(or&nbsp;IRemotingTypeInfo.CanCastTo&nbsp;in&nbsp;remoting&nbsp;use&nbsp;case).&nbsp;The&nbsp;idea&nbsp;is&nbsp;to&nbsp;generalize&nbsp;and&nbsp;share&nbsp;the&nbsp;code&nbsp;already&nbsp;doing&nbsp;this&nbsp;logic&nbsp;in&nbsp;remoting&nbsp;making&nbsp;sure&nbsp;we&nbsp;only&nbsp;include&nbsp;one&nbsp;implementation&nbsp;of&nbsp;key&nbsp;features&nbsp;like&nbsp;rebuilding&nbsp;the&nbsp;vtable&nbsp;(currently&nbsp;done&nbsp;in&nbsp;mono_class_proxy_vtable).<br>
&nbsp;ICastable&nbsp;implementation&nbsp;will&nbsp;also&nbsp;include&nbsp;a&nbsp;cache&nbsp;similar&nbsp;to&nbsp;the&nbsp;one&nbsp;used&nbsp;in&nbsp;the&nbsp;remoting&nbsp;use&nbsp;case&nbsp;(see&nbsp;mono_upgrade_remote_class&nbsp;for&nbsp;details).&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;All&nbsp;code&nbsp;related&nbsp;to&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;will&nbsp;be&nbsp;guarded&nbsp;by&nbsp;a&nbsp;defined,&nbsp;FEATURE_ICASTABLE,&nbsp;so&nbsp;all&nbsp;platforms&nbsp;not&nbsp;needing&nbsp;this&nbsp;support&nbsp;(currently&nbsp;only&nbsp;needed&nbsp;on&nbsp;WinRT&nbsp;platforms),&nbsp;won't&nbsp;be&nbsp;affected&nbsp;by&nbsp;this&nbsp;change.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;BCL:&lt;/u&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;&#43;&nbsp;helper&nbsp;class&nbsp;can&nbsp;be&nbsp;included&nbsp;from&nbsp;CoreCLR&nbsp;into&nbsp;Mono's&nbsp;mscorlib&nbsp;with&nbsp;a&nbsp;small&nbsp;adjustment&nbsp;to&nbsp;the&nbsp;helper&nbsp;class:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F68f72dd2587c3365a9fe74d1991f93612c3bc62a%2Fsrc%2Fmscorlib%2Fsrc%2FSystem%2FRuntime%2FCompilerServices%2FICastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=t8tOm1Cvn9Klm4JwgxF%2BbeH%2Bqk%2B8sZbDOpIF2Q4t4Cc%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/coreclr/blob/68f72dd2587c3365a9fe74d1991f93612c3bc62a/src/mscorlib/src/System/Runtime/CompilerServices/ICastable.cs&lt;/a&gt;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Part&nbsp;of&nbsp;supporting&nbsp;ICastable&nbsp;includes&nbsp;adding&nbsp;the&nbsp;above&nbsp;assembly&nbsp;and&nbsp;classes&nbsp;to&nbsp;Mono's&nbsp;BCL.&nbsp;It&nbsp;should&nbsp;build&nbsp;under&nbsp;net_4_x&nbsp;and&nbsp;winAOT&nbsp;profiles.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Examples&nbsp;of&nbsp;things&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;done&nbsp;to&nbsp;support&nbsp;ICastable:&lt;/u&gt;<br>
&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;ul&nbsp;type=&quot;disc&quot;&gt;<br>
&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Extend&nbsp;MonoVTable&nbsp;with&nbsp;a&nbsp;field&nbsp;indicating&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;(optimization&nbsp;for&nbsp;fast&nbsp;lookups&nbsp;and&nbsp;checks).&nbsp;Since&nbsp;this&nbsp;field&nbsp;is&nbsp;checked&nbsp;both&nbsp;by&nbsp;C&nbsp;code&nbsp;and&nbsp;generated&nbsp;code&nbsp;(handle_isinst,&nbsp;handle_castclass)&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;addressable.&nbsp;Field&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to<br>
&nbsp;include&nbsp;more&nbsp;meta&nbsp;information&nbsp;when&nbsp;an&nbsp;object&nbsp;implements&nbsp;ICastable&nbsp;and&nbsp;has&nbsp;been&nbsp;casted&nbsp;to&nbsp;different&nbsp;interfaces&nbsp;(needed&nbsp;by&nbsp;both&nbsp;caching&nbsp;and&nbsp;vtable&nbsp;rebuild).&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Extend&nbsp;mono_object_handle_isinst_mbyref&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Extend&nbsp;handle_isinst&nbsp;and&nbsp;handle_castclass&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Extend&nbsp;objects&nbsp;vtable&nbsp;with&nbsp;new&nbsp;interfaces&nbsp;implemented&nbsp;by&nbsp;a&nbsp;different&nbsp;type&nbsp;indicated&nbsp;by&nbsp;ICastable::IsInstanceOfInterface.&nbsp;Similar&nbsp;to&nbsp;how&nbsp;mono_upgrade_remote_class&nbsp;works&nbsp;for&nbsp;remote&nbsp;objects.&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Add&nbsp;support&nbsp;to&nbsp;mono_vcall_trampoline&nbsp;to&nbsp;resolve&nbsp;method&nbsp;implementation&nbsp;for&nbsp;ICastable&nbsp;objects&nbsp;when&nbsp;not&nbsp;directly&nbsp;implemented&nbsp;by&nbsp;type.&nbsp;Implementing&nbsp;type&nbsp;for&nbsp;method&nbsp;is&nbsp;returned&nbsp;by&nbsp;ICastable::GetImplType.&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Cache&nbsp;dynamically&nbsp;generated&nbsp;vtables&nbsp;based&nbsp;on&nbsp;object&nbsp;class&nbsp;&#43;&nbsp;additional&nbsp;supported&nbsp;interface(s).&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;mso-margin-top-alt:auto;mso-margin-bottom-alt:auto;margin-left:0in;mso-list:l0&nbsp;level1&nbsp;lfo1&quot;&gt;<br>
Add&nbsp;support&nbsp;for&nbsp;CoreCLR&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;support&nbsp;class&nbsp;in&nbsp;Mono's&nbsp;mscorlib&nbsp;(net_4_x,&nbsp;winAOT&nbsp;profiles).&lt;o:p&gt;&lt;/o:p&gt;&lt;/li&gt;&lt;/ul&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I&nbsp;have&nbsp;implemented&nbsp;a&nbsp;POC&nbsp;using&nbsp;the&nbsp;above&nbsp;approach&nbsp;and&nbsp;it&nbsp;solve&nbsp;the&nbsp;use&nbsp;case,&nbsp;getting&nbsp;pass&nbsp;on&nbsp;all&nbsp;tests&nbsp;in&nbsp;CoreCLR&nbsp;ICastable&nbsp;test&nbsp;suite&nbsp;and&nbsp;working&nbsp;with&nbsp;MCG&nbsp;stub&nbsp;samples,&nbsp;so&nbsp;above&nbsp;suggestion&nbsp;seems&nbsp;at&nbsp;least&nbsp;to&nbsp;be&nbsp;a&nbsp;way&nbsp;moving&nbsp;forward&nbsp;implementing<br>
&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Comments,&nbsp;thoughts&nbsp;and&nbsp;ideas&nbsp;are&nbsp;much&nbsp;appreciated.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
