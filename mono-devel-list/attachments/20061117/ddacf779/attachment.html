<tt>
I&nbsp;had&nbsp;sent&nbsp;a&nbsp;previous&nbsp;patch&nbsp;for&nbsp;supporting&nbsp;COM&nbsp;Callable&nbsp;Wrappers&nbsp;in&nbsp;mono.&nbsp;I&nbsp;removed&nbsp;the&nbsp;patch&nbsp;as&nbsp;it&nbsp;was&nbsp;too&nbsp;large&nbsp;to&nbsp;send,&nbsp;and&nbsp;probably&nbsp;to&nbsp;large&nbsp;to&nbsp;review.&nbsp;I'm&nbsp;breaking&nbsp;it&nbsp;down&nbsp;into&nbsp;a&nbsp;series&nbsp;of&nbsp;smaller&nbsp;patches,&nbsp;and&nbsp;here&nbsp;is&nbsp;the&nbsp;first.&nbsp;There&nbsp;is&nbsp;some&nbsp;managed&nbsp;changes&nbsp;that&nbsp;are&nbsp;somewhat&nbsp;minor.&nbsp;The&nbsp;big&nbsp;part&nbsp;of&nbsp;this&nbsp;patch&nbsp;is&nbsp;to&nbsp;put&nbsp;a&nbsp;level&nbsp;of&nbsp;indirection&nbsp;in&nbsp;the&nbsp;creation&nbsp;of&nbsp;managed-&amp;gt;unmanaged&nbsp;wrappers.&nbsp;Right&nbsp;now,&nbsp;a&nbsp;delegate&nbsp;class&nbsp;is&nbsp;needed.&nbsp;I&nbsp;created&nbsp;another&nbsp;function&nbsp;to&nbsp;seperate&nbsp;out&nbsp;all&nbsp;the&nbsp;delegate&nbsp;specific&nbsp;code.&nbsp;Then,&nbsp;I&nbsp;can&nbsp;use&nbsp;this&nbsp;new&nbsp;function&nbsp;to&nbsp;create&nbsp;wrappers&nbsp;for&nbsp;managed&nbsp;methods&nbsp;for&nbsp;COM&nbsp;without&nbsp;a&nbsp;delegate&nbsp;class&nbsp;for&nbsp;each.<br>
&lt;br&gt;&lt;br&gt;BTW,&nbsp;you&nbsp;can&nbsp;read&nbsp;the&nbsp;text&nbsp;below&nbsp;if&nbsp;you&nbsp;want&nbsp;an&nbsp;idea&nbsp;of&nbsp;the&nbsp;overall&nbsp;changes&nbsp;I&nbsp;will&nbsp;be&nbsp;proposing.&nbsp;All&nbsp;code&nbsp;is&nbsp;code&nbsp;is&nbsp;contributed&nbsp;under&nbsp;the&nbsp;MIT/X11&nbsp;license.&nbsp;I&nbsp;also&nbsp;understand&nbsp;that&nbsp;this&nbsp;may&nbsp;have&nbsp;to&nbsp;wait&nbsp;until&nbsp;1.2.*&nbsp;is&nbsp;out&nbsp;the&nbsp;door.&nbsp;Please&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;the&nbsp;patch&nbsp;is&nbsp;acceptable&nbsp;and&nbsp;when&nbsp;I&nbsp;can&nbsp;commit&nbsp;it.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;br&gt;&lt;br&gt;----------&nbsp;Forwarded&nbsp;message&nbsp;----------<br>
&lt;br&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;From:&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;Jon&nbsp;Chambers&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:joncham@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;onclick=&quot;return&nbsp;top.js.OpenExtLink(window,event,this)&quot;&gt;joncham@gmail.com&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
Date:&nbsp;Nov&nbsp;10,&nbsp;2006&nbsp;11:41&nbsp;PM&lt;br&gt;Subject:&nbsp;COM&nbsp;Callable&nbsp;Wrapper&nbsp;Patch&lt;br&gt;To:&nbsp;Mono&nbsp;Devel&nbsp;List&nbsp;&amp;lt;<br>
&lt;a&nbsp;href=&quot;mailto:mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;onclick=&quot;return&nbsp;top.js.OpenExtLink(window,event,this)&quot;&gt;mono-devel-list@lists.ximian.com&lt;/a&gt;&amp;gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;This&nbsp;patch&nbsp;adds&nbsp;support&nbsp;for&nbsp;COM&nbsp;Callable&nbsp;Wrappers&nbsp;to&nbsp;mono&nbsp;(exposing&nbsp;managed&nbsp;objects&nbsp;as&nbsp;COM&nbsp;objects&nbsp;to&nbsp;unmanaged&nbsp;code).&nbsp;I&nbsp;started&nbsp;to&nbsp;clean&nbsp;up&nbsp;some&nbsp;other&nbsp;cominterop&nbsp;work,&nbsp;but&nbsp;it&nbsp;just&nbsp;made&nbsp;the&nbsp;patch&nbsp;harder&nbsp;to&nbsp;read.&nbsp;So,&nbsp;I&nbsp;only&nbsp;put&nbsp;new&nbsp;methods&nbsp;at&nbsp;the&nbsp;bottom&nbsp;of&nbsp;the&nbsp;<br>
marshal.c&nbsp;file&nbsp;with&nbsp;the&nbsp;long&nbsp;term&nbsp;goal&nbsp;of&nbsp;all&nbsp;cominterop&nbsp;related&nbsp;methods&nbsp;located&nbsp;there&nbsp;or&nbsp;in&nbsp;another&nbsp;file.&nbsp;I&nbsp;also&nbsp;implemented/modified&nbsp;alot&nbsp;of&nbsp;the&nbsp;marshalling&nbsp;code&nbsp;to&nbsp;support&nbsp;COM&nbsp;Interop&nbsp;in&nbsp;both&nbsp;directions.&nbsp;Anyway,&nbsp;there&nbsp;are&nbsp;2&nbsp;changes&nbsp;that&nbsp;affect&nbsp;the&nbsp;runtime&nbsp;in&nbsp;non-cominterop&nbsp;cases.&nbsp;The&nbsp;first&nbsp;is&nbsp;the&nbsp;addition&nbsp;of&nbsp;the&nbsp;mono_marshal_emit_managed_wrapper.&nbsp;This&nbsp;method&nbsp;incorporates&nbsp;alot&nbsp;of&nbsp;the&nbsp;functionality&nbsp;contained&nbsp;in&nbsp;the&nbsp;existing&nbsp;mono_marshal_get_managed_wrapper.&nbsp;Basically,&nbsp;all&nbsp;the&nbsp;delegate&nbsp;specific&nbsp;code&nbsp;is&nbsp;in&nbsp;mono_marshal_get_managed_wrapper,&nbsp;and&nbsp;the&nbsp;general&nbsp;code&nbsp;for&nbsp;wrapping&nbsp;a&nbsp;managed&nbsp;method&nbsp;is&nbsp;located&nbsp;in&nbsp;mono_marshal_emit_managed_wrapper&nbsp;so&nbsp;I&nbsp;can&nbsp;create&nbsp;function&nbsp;pointers&nbsp;for&nbsp;the&nbsp;COM&nbsp;vtable&nbsp;without&nbsp;having&nbsp;a&nbsp;delegate&nbsp;type&nbsp;for&nbsp;each&nbsp;method.&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;better&nbsp;approach&nbsp;let&nbsp;me&nbsp;know.<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;The&nbsp;second&nbsp;change&nbsp;that&nbsp;affects&nbsp;the&nbsp;runtime&nbsp;is&nbsp;gc.c.&nbsp;Basically,&nbsp;any&nbsp;managed&nbsp;object&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;unmanaged&nbsp;code.&nbsp;At&nbsp;that&nbsp;point,&nbsp;an&nbsp;unmanaged&nbsp;representation&nbsp;of&nbsp;the&nbsp;managed&nbsp;object&nbsp;is&nbsp;created.&nbsp;This&nbsp;needs&nbsp;cleaned&nbsp;up&nbsp;when&nbsp;the&nbsp;object&nbsp;is&nbsp;garbage&nbsp;collected.&nbsp;So,&nbsp;I&nbsp;register&nbsp;the&nbsp;object&nbsp;for&nbsp;finalization.&nbsp;In&nbsp;the&nbsp;finalizer&nbsp;code,&nbsp;I&nbsp;check&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;object&nbsp;has&nbsp;a&nbsp;ccw.&nbsp;There&nbsp;is&nbsp;a&nbsp;quick&nbsp;return&nbsp;if&nbsp;no&nbsp;CCW's&nbsp;have&nbsp;been&nbsp;created,&nbsp;so&nbsp;while&nbsp;there&nbsp;is&nbsp;a&nbsp;function&nbsp;call&nbsp;the&nbsp;hash&nbsp;table&nbsp;lookup&nbsp;only&nbsp;occurs&nbsp;if&nbsp;the&nbsp;program&nbsp;actually&nbsp;uses&nbsp;CCWs.<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;As&nbsp;previously&nbsp;mentioned,&nbsp;I&nbsp;would&nbsp;like&nbsp;to&nbsp;clean&nbsp;up&nbsp;the&nbsp;COM&nbsp;Interop&nbsp;code&nbsp;(mainly&nbsp;by&nbsp;grouping&nbsp;together&nbsp;at&nbsp;the&nbsp;bottom)&nbsp;and&nbsp;inserting&nbsp;some&nbsp;#ifdefs&nbsp;to&nbsp;allow&nbsp;COM&nbsp;support&nbsp;to&nbsp;be&nbsp;not&nbsp;enabled&nbsp;in&nbsp;the&nbsp;runtime&nbsp;to&nbsp;save&nbsp;space.&nbsp;I'll&nbsp;do&nbsp;this&nbsp;in&nbsp;some&nbsp;future&nbsp;patches&nbsp;if&nbsp;no&nbsp;one&nbsp;objects.&nbsp;Also,&nbsp;I&nbsp;am&nbsp;pretty&nbsp;sure&nbsp;I&nbsp;need&nbsp;some&nbsp;more&nbsp;locking&nbsp;around&nbsp;this&nbsp;code&nbsp;for&nbsp;thread&nbsp;safety.&nbsp;I'll&nbsp;also&nbsp;take&nbsp;a&nbsp;look&nbsp;at&nbsp;that&nbsp;for&nbsp;a&nbsp;future&nbsp;patch.<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Finally,&nbsp;for&nbsp;debugging&nbsp;I&nbsp;find&nbsp;myself&nbsp;putting&nbsp;alot&nbsp;of&nbsp;printf's&nbsp;into&nbsp;the&nbsp;code.&nbsp;Can&nbsp;leave&nbsp;them&nbsp;in&nbsp;either&nbsp;via&lt;br&gt;#ifdef&nbsp;DEBUG_COMINTEROP&lt;br&gt;printf&nbsp;(...)&lt;br&gt;#endif&lt;br&gt;&lt;br&gt;or&lt;br&gt;&lt;br&gt;DEBUG_COMINTEROP&nbsp;(printf&nbsp;(...))&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;at&nbsp;least&nbsp;during&nbsp;this&nbsp;beginning&nbsp;stage&nbsp;when&nbsp;I'm&nbsp;debugging&nbsp;alot&nbsp;(or&nbsp;someone&nbsp;give&nbsp;a&nbsp;better&nbsp;suggestion)?&lt;br&gt;&lt;br&gt;Please&nbsp;review&nbsp;and&nbsp;comment.&nbsp;There&nbsp;are&nbsp;tests&nbsp;added&nbsp;as&nbsp;well&nbsp;for&nbsp;this&nbsp;functionality&nbsp;with&nbsp;some&nbsp;more&nbsp;to&nbsp;come.&nbsp;As&nbsp;usual,&nbsp;this&nbsp;code&nbsp;is&nbsp;contributed&nbsp;under&nbsp;the&nbsp;MIT/X11&nbsp;license,&nbsp;and&nbsp;I&nbsp;signed&nbsp;off&nbsp;in&nbsp;the&nbsp;ChangeLogs&nbsp;within&nbsp;the&nbsp;runtime&nbsp;code.<br>
&lt;br&gt;&lt;br&gt;Thanks,&lt;br&gt;Jonathan&lt;br&gt;<br>
<br>
<br>
&lt;br&nbsp;clear=&quot;all&quot;&gt;<br>
<br>

</tt>
