<tt>
&lt;!DOCTYPE&nbsp;html&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
Scott&nbsp;Mohekey&nbsp;wrote:<br>
&lt;blockquote&nbsp;cite=&quot;mid41472601.3010507@telogis.com&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
Scott&nbsp;Mohekey&nbsp;wrote:<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid4146E30E.1010200@telogis.com&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;<br>
&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
Scott&nbsp;Mohekey&nbsp;wrote:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;cite=&quot;mid4146DBA2.1090803@telogis.com&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;charset=ISO-8859-1&quot;<br>
&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;title&gt;&lt;/title&gt;<br>
Gonzalo&nbsp;Paniagua&nbsp;Javier&nbsp;wrote:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote<br>
&nbsp;cite=&quot;mid1095114207.5112.3.camel@localhost.localdomain&quot;&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;On&nbsp;Mon,&nbsp;2004-09-13&nbsp;at&nbsp;11:54,&nbsp;Scott&nbsp;Mohekey&nbsp;wrote:<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;I've&nbsp;spent&nbsp;the&nbsp;last&nbsp;few&nbsp;days&nbsp;looking&nbsp;into&nbsp;the&nbsp;issue&nbsp;that&nbsp;has&nbsp;been&nbsp;<br>
reported&nbsp;here&nbsp;(&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://bugs.ximian.com/show_bug.cgi?id=60576&quot;&gt;http://bugs.ximian.com/show_bug.cgi?id=60576&lt;/a&gt;)&nbsp;and&nbsp;here&nbsp;<br>
(&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://bugs.gentoo.org/show_bug.cgi?id=63734&quot;&gt;http://bugs.gentoo.org/show_bug.cgi?id=63734&lt;/a&gt;).<br>
<br>
This&nbsp;first&nbsp;code&nbsp;snippet&nbsp;exhibits&nbsp;the&nbsp;bug&nbsp;on&nbsp;a&nbsp;pure&nbsp;NPTL&nbsp;system:<br>
<br>
using&nbsp;System;<br>
using&nbsp;System.Threading;<br>
<br>
class&nbsp;Test<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;void&nbsp;Main(&nbsp;String[]&nbsp;args&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;0;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(&nbsp;true&nbsp;)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread&nbsp;t&nbsp;=&nbsp;new&nbsp;Thread(&nbsp;new&nbsp;ThreadStart(Blah)&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Start();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&nbsp;i+&quot;&nbsp;threads&quot;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;Blah()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&nbsp;&quot;starting&nbsp;thread&quot;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
Running&nbsp;this&nbsp;program&nbsp;inside&nbsp;gdb&nbsp;reveals&nbsp;that&nbsp;each&nbsp;of&nbsp;the&nbsp;threads&nbsp;created&nbsp;<br>
becomes&nbsp;a&nbsp;zombie&nbsp;as&nbsp;soon&nbsp;as&nbsp;it&nbsp;exits.&nbsp;Further&nbsp;investigation&nbsp;reveals&nbsp;that&nbsp;<br>
none&nbsp;of&nbsp;the&nbsp;mono&nbsp;thread&nbsp;cleanup&nbsp;code&nbsp;is&nbsp;being&nbsp;run&nbsp;(breaking&nbsp;on&nbsp;<br>
thread_cleanup()&nbsp;or&nbsp;handle_remove()&nbsp;gives&nbsp;no&nbsp;results)&nbsp;for&nbsp;any&nbsp;of&nbsp;the&nbsp;<br>
zombie&nbsp;threads.&nbsp;After&nbsp;the&nbsp;program&nbsp;has&nbsp;run&nbsp;for&nbsp;a&nbsp;certain&nbsp;length&nbsp;of&nbsp;time,&nbsp;<br>
the&nbsp;garbage&nbsp;collector&nbsp;is&nbsp;invoked,&nbsp;which&nbsp;forces&nbsp;a&nbsp;world&nbsp;stop&nbsp;of&nbsp;all&nbsp;<br>
threads.&nbsp;If&nbsp;the&nbsp;garbage&nbsp;collector&nbsp;is&nbsp;invoked&nbsp;when&nbsp;a&nbsp;zombie&nbsp;thread&nbsp;is&nbsp;<br>
present,&nbsp;mono_gc_stop_world()&nbsp;is&nbsp;called&nbsp;which&nbsp;iterates&nbsp;over&nbsp;the&nbsp;threads&nbsp;<br>
hashtable&nbsp;calling&nbsp;gc_stop_world()&nbsp;on&nbsp;each&nbsp;entry,&nbsp;which&nbsp;in&nbsp;turn&nbsp;calls&nbsp;<br>
SuspendThread()&nbsp;on&nbsp;the&nbsp;each.&nbsp;But&nbsp;because&nbsp;the&nbsp;thread&nbsp;cleanup&nbsp;code&nbsp;hasn't&nbsp;<br>
been&nbsp;run&nbsp;(in&nbsp;particular,&nbsp;handle_remove()&nbsp;which&nbsp;removes&nbsp;the&nbsp;thread&nbsp;handle&nbsp;<br>
from&nbsp;the&nbsp;hashtable),&nbsp;SuspendThread()&nbsp;gets&nbsp;called&nbsp;for&nbsp;threads&nbsp;which&nbsp;don't&nbsp;<br>
exist,&nbsp;or&nbsp;are&nbsp;zombies.&nbsp;The&nbsp;offending&nbsp;code&nbsp;appears&nbsp;to&nbsp;be:<br>
<br>
while&nbsp;(MONO_SEM_WAIT&nbsp;(&amp;amp;thread-&amp;gt;suspend_sem)&nbsp;!=&nbsp;0&nbsp;&amp;amp;&amp;amp;&nbsp;errno&nbsp;==&nbsp;EINTR);<br>
<br>
<br>
in&nbsp;_wapi_timed_thread_suspend(),&nbsp;which&nbsp;indirectly&nbsp;calls&nbsp;<br>
pthread_cond_wait()&nbsp;for&nbsp;a&nbsp;condition&nbsp;variable&nbsp;that&nbsp;is&nbsp;not&nbsp;going&nbsp;to&nbsp;be&nbsp;<br>
triggered,&nbsp;because&nbsp;the&nbsp;other&nbsp;thread&nbsp;is&nbsp;a&nbsp;zombie.<br>
<br>
As&nbsp;far&nbsp;as&nbsp;I&nbsp;can&nbsp;tell,&nbsp;mono_thread_manage&nbsp;runs&nbsp;it's&nbsp;'join'&nbsp;loop&nbsp;once,&nbsp;at&nbsp;<br>
which&nbsp;point&nbsp;it&nbsp;waits&nbsp;for&nbsp;eternity&nbsp;inside&nbsp;WaitForMultipleObjectsEx()&nbsp;<br>
which&nbsp;is&nbsp;called&nbsp;from&nbsp;wait_for_tids().&nbsp;Because&nbsp;of&nbsp;this,&nbsp;the&nbsp;<br>
thread_cleanup()&nbsp;call&nbsp;in&nbsp;wait_for_tids()&nbsp;is&nbsp;never&nbsp;reached,&nbsp;not&nbsp;for&nbsp;any&nbsp;<br>
of&nbsp;the&nbsp;threads.<br>
<br>
I'm&nbsp;going&nbsp;to&nbsp;continue&nbsp;investigating&nbsp;this.&nbsp;Any&nbsp;help&nbsp;would&nbsp;be&nbsp;greatly&nbsp;<br>
appreciated.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;!----&gt;<br>
Is&nbsp;that&nbsp;happening&nbsp;with&nbsp;CVS&nbsp;HEAD&nbsp;and&nbsp;not&nbsp;on&nbsp;1.0?&nbsp;I&nbsp;removed&nbsp;some&nbsp;code&nbsp;to<br>
fix&nbsp;this&nbsp;bug:<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://bugzilla.ximian.com/show_bug.cgi?id=65379&quot;&gt;http://bugzilla.ximian.com/show_bug.cgi?id=65379&lt;/a&gt;<br>
<br>
and&nbsp;that&nbsp;might&nbsp;be&nbsp;the&nbsp;cause&nbsp;of&nbsp;yours&nbsp;if&nbsp;you're&nbsp;using&nbsp;CVS&nbsp;HEAD.<br>
<br>
-Gonzalo<br>
<br>
<br>
_______________________________________________<br>
Mono-devel-list&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;<br>
&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;<br>
&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;<br>
<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
Yes,&nbsp;I&nbsp;have&nbsp;been&nbsp;using&nbsp;cvs&nbsp;HEAD.&nbsp;I&nbsp;switched&nbsp;back&nbsp;to&nbsp;version&nbsp;1.0.1&nbsp;and<br>
this&nbsp;problem&nbsp;(handle_remove()&nbsp;not&nbsp;being&nbsp;called)&nbsp;was&nbsp;not&nbsp;present<br>
anymore.&nbsp;However,&nbsp;the&nbsp;program&nbsp;still&nbsp;freezes&nbsp;during&nbsp;a&nbsp;garbage<br>
collection.&nbsp;Is&nbsp;it&nbsp;possible&nbsp;that&nbsp;a&nbsp;thread&nbsp;exits,&nbsp;and&nbsp;the&nbsp;garbage<br>
collector&nbsp;is&nbsp;called&nbsp;in&nbsp;another&nbsp;thread&nbsp;before&nbsp;handle_remove()&nbsp;is&nbsp;called<br>
for&nbsp;the&nbsp;exiting&nbsp;thread?&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
It&nbsp;appears&nbsp;not&nbsp;to&nbsp;be&nbsp;the&nbsp;case&nbsp;if&nbsp;the&nbsp;following&nbsp;output&nbsp;is&nbsp;anything&nbsp;to&nbsp;go<br>
by.&nbsp;I've&nbsp;built&nbsp;mono-1.0.1&nbsp;with&nbsp;THREAD_DEBUG,&nbsp;THREAD_WAIT_DEBUG,&nbsp;and<br>
LIBGC_DEBUG&nbsp;defined&nbsp;in&nbsp;metadata/threads.c.&nbsp;I&nbsp;also&nbsp;modified&nbsp;the<br>
g_message&nbsp;calls&nbsp;in&nbsp;handle_store&nbsp;and&nbsp;handle_remove&nbsp;to&nbsp;be&nbsp;a&nbsp;bit&nbsp;more<br>
descriptive.&nbsp;This&nbsp;the&nbsp;output&nbsp;of&nbsp;the&nbsp;thread&nbsp;test&nbsp;case&nbsp;run&nbsp;inside&nbsp;gdb.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;starting&nbsp;thread<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230700<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;Done&nbsp;launching&nbsp;thread&nbsp;0x8230700&nbsp;(1100430256)<br>
197&nbsp;threads<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x80fae00<br>
**&nbsp;Message:&nbsp;:&nbsp;joining&nbsp;thread&nbsp;handle&nbsp;0xd7d,&nbsp;-1&nbsp;ms<br>
**&nbsp;Message:&nbsp;:&nbsp;(1100430256)&nbsp;Abort&nbsp;requested&nbsp;for&nbsp;0x8230700&nbsp;(1100430256)<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230700<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230700<br>
**&nbsp;Message:&nbsp;:&nbsp;removing&nbsp;thread&nbsp;ID&nbsp;1100430256<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;(nil)<br>
**&nbsp;Message:&nbsp;:&nbsp;join&nbsp;successful<br>
**&nbsp;Message:&nbsp;:&nbsp;Trying&nbsp;to&nbsp;start&nbsp;a&nbsp;new&nbsp;thread:&nbsp;this&nbsp;(0x8230690)&nbsp;start&nbsp;(0x8241b18)<br>
[Thread&nbsp;1100430256&nbsp;(zombie)&nbsp;exited]<br>
[New&nbsp;Thread&nbsp;1102531504&nbsp;(LWP&nbsp;1187)]<br>
**&nbsp;Message:&nbsp;:&nbsp;Started&nbsp;thread&nbsp;ID&nbsp;1102531504&nbsp;(handle&nbsp;0xd80)<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;Launching&nbsp;thread&nbsp;0x8230690&nbsp;(1102531504)<br>
**&nbsp;Message:&nbsp;:&nbsp;storing&nbsp;thread&nbsp;0x8230690&nbsp;ID&nbsp;1102531504<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;waiting&nbsp;for&nbsp;thread&nbsp;0x8230690&nbsp;(1102531504)&nbsp;to&nbsp;start<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Start&nbsp;wrapper<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230690<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504,985)&nbsp;Setting&nbsp;thread&nbsp;stack&nbsp;to&nbsp;0x41b749ec<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Setting&nbsp;current_object_key&nbsp;to&nbsp;0x8230690<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;Done&nbsp;launching&nbsp;thread&nbsp;0x8230690&nbsp;(1102531504)<br>
198&nbsp;threads<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x80fae00<br>
**&nbsp;Message:&nbsp;:&nbsp;joining&nbsp;thread&nbsp;handle&nbsp;0xd80,&nbsp;-1&nbsp;ms<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230690<br>
starting&nbsp;thread<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230690<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Abort&nbsp;requested&nbsp;for&nbsp;0x8230690&nbsp;(1102531504)<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230690<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x8230690<br>
**&nbsp;Message:&nbsp;:&nbsp;join&nbsp;successful<br>
**&nbsp;Message:&nbsp;:&nbsp;Trying&nbsp;to&nbsp;start&nbsp;a&nbsp;new&nbsp;thread:&nbsp;this&nbsp;(0x8230620)&nbsp;start&nbsp;(0x8241a78)<br>
**&nbsp;Message:&nbsp;:&nbsp;removing&nbsp;thread&nbsp;ID&nbsp;1102531504<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;(nil)<br>
[Thread&nbsp;1102531504&nbsp;(zombie)&nbsp;exited]<br>
[New&nbsp;Thread&nbsp;1100430256&nbsp;(LWP&nbsp;1188)]<br>
Initiating&nbsp;full&nbsp;world-stop&nbsp;collection&nbsp;4&nbsp;after&nbsp;466576&nbsp;allocd&nbsp;bytes<br>
<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
Everything&nbsp;seems&nbsp;to&nbsp;be&nbsp;ok&nbsp;here.&nbsp;However,&nbsp;if&nbsp;I&nbsp;break&nbsp;on<br>
mono_gc_stop_world,&nbsp;the&nbsp;breakpoint&nbsp;isn't&nbsp;hit.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
Scott.&nbsp;&lt;/blockquote&gt;<br>
Heres&nbsp;another&nbsp;portion&nbsp;exhibiting&nbsp;slightly&nbsp;different&nbsp;behaviour:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;[Thread&nbsp;1104632752&nbsp;(zombie)&nbsp;exited]<br>
[New&nbsp;Thread&nbsp;1102531504&nbsp;(LWP&nbsp;2205)]<br>
**&nbsp;Message:&nbsp;:&nbsp;Started&nbsp;thread&nbsp;ID&nbsp;1102531504&nbsp;(handle&nbsp;0x683)<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;Launching&nbsp;thread&nbsp;0x82be000&nbsp;(1102531504)<br>
**&nbsp;Message:&nbsp;:&nbsp;storing&nbsp;thread&nbsp;0x82be000&nbsp;ID&nbsp;1102531504<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;waiting&nbsp;for&nbsp;thread&nbsp;0x82be000&nbsp;(1102531504)&nbsp;to&nbsp;start<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Start&nbsp;wrapper<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x82be000<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504,1723)&nbsp;Setting&nbsp;thread&nbsp;stack&nbsp;to&nbsp;0x41b749ec<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Setting&nbsp;current_object_key&nbsp;to&nbsp;0x82be000<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x82be000<br>
starting&nbsp;thread<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x82be000<br>
**&nbsp;Message:&nbsp;:&nbsp;(1098329008)&nbsp;Done&nbsp;launching&nbsp;thread&nbsp;0x82be000&nbsp;(1102531504)<br>
480&nbsp;threads<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x80fae00<br>
**&nbsp;Message:&nbsp;:&nbsp;joining&nbsp;thread&nbsp;handle&nbsp;0x683,&nbsp;-1&nbsp;ms<br>
**&nbsp;Message:&nbsp;:&nbsp;(1102531504)&nbsp;Abort&nbsp;requested&nbsp;for&nbsp;0x82be000&nbsp;(1102531504)<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x82be000<br>
**&nbsp;Message:&nbsp;:&nbsp;returning&nbsp;0x82be000<br>
**&nbsp;Message:&nbsp;:&nbsp;join&nbsp;successful<br>
Initiating&nbsp;full&nbsp;world-stop&nbsp;collection&nbsp;6&nbsp;after&nbsp;839344&nbsp;allocd&nbsp;bytes<br>
<br>
Program&nbsp;received&nbsp;signal&nbsp;SIGINT,&nbsp;Interrupt.<br>
[Switching&nbsp;to&nbsp;Thread&nbsp;1088395008&nbsp;(LWP&nbsp;1723)]<br>
0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
(gdb)&nbsp;info&nbsp;th<br>
&nbsp;&nbsp;483&nbsp;Thread&nbsp;1102531504&nbsp;(LWP&nbsp;2205)&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
&nbsp;&nbsp;3&nbsp;Thread&nbsp;1098329008&nbsp;(LWP&nbsp;1725)&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
&nbsp;&nbsp;2&nbsp;Thread&nbsp;1096207280&nbsp;(LWP&nbsp;1724)&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
*&nbsp;1&nbsp;Thread&nbsp;1088395008&nbsp;(LWP&nbsp;1723)&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
I'm&nbsp;not&nbsp;sure,&nbsp;but&nbsp;it&nbsp;looks&nbsp;like&nbsp;the&nbsp;last&nbsp;thread&nbsp;created&nbsp;is&nbsp;about&nbsp;to&nbsp;be<br>
removed&nbsp;(mono&nbsp;has&nbsp;joined&nbsp;with&nbsp;it),&nbsp;but&nbsp;handle_remove()&nbsp;has&nbsp;not&nbsp;been<br>
called,&nbsp;and&nbsp;as&nbsp;far&nbsp;as&nbsp;gdb&nbsp;is&nbsp;aware,&nbsp;the&nbsp;thread&nbsp;is&nbsp;still&nbsp;active&nbsp;(no<br>
&quot;(zombie)&nbsp;exited&quot;&nbsp;message).&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
It&nbsp;seems&nbsp;that&nbsp;what&nbsp;the&nbsp;system&nbsp;sees&nbsp;as&nbsp;the&nbsp;list&nbsp;of&nbsp;active&nbsp;threads&nbsp;is<br>
different&nbsp;to&nbsp;what&nbsp;mono&nbsp;sees&nbsp;as&nbsp;the&nbsp;list&nbsp;of&nbsp;active&nbsp;threads.&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
Scott&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/blockquote&gt;<br>
Further&nbsp;investigation&nbsp;reveals&nbsp;that&nbsp;the&nbsp;thread&nbsp;clean&nbsp;up&nbsp;code&nbsp;in&nbsp;the<br>
included&nbsp;libgc&nbsp;is&nbsp;not&nbsp;being&nbsp;run&nbsp;for&nbsp;any&nbsp;threads.&nbsp;After<br>
GC_start_routine(&nbsp;)&nbsp;has&nbsp;called&nbsp;the&nbsp;start&nbsp;function&nbsp;it's&nbsp;given,&nbsp;control<br>
is&nbsp;never&nbsp;returned&nbsp;to&nbsp;it.&nbsp;A&nbsp;backtrace&nbsp;in&nbsp;gdb&nbsp;shows&nbsp;that&nbsp;the&nbsp;offending<br>
threads&nbsp;have&nbsp;called&nbsp;__sigsetjmp&nbsp;and&nbsp;are&nbsp;waiting&nbsp;on&nbsp;a&nbsp;mutex&nbsp;lock<br>
(_L_mutex_loc_24()).&lt;br&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;pre&gt;(gdb)&nbsp;bt<br>
#0&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
#1&nbsp;&nbsp;0x419a1554&nbsp;in&nbsp;??&nbsp;()<br>
#2&nbsp;&nbsp;0x40d50000&nbsp;in&nbsp;??&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6<br>
#3&nbsp;&nbsp;0x00000008&nbsp;in&nbsp;??&nbsp;()<br>
#4&nbsp;&nbsp;0x40c6c345&nbsp;in&nbsp;sigsuspend&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6<br>
#5&nbsp;&nbsp;0x40156729&nbsp;in&nbsp;GC_suspend_handler&nbsp;()&nbsp;from&nbsp;/home/mono/lib/libmono.so.0<br>
#6&nbsp;&nbsp;&amp;lt;signal&nbsp;handler&nbsp;called&amp;gt;<br>
#7&nbsp;&nbsp;0xffffe410&nbsp;in&nbsp;??&nbsp;()<br>
#8&nbsp;&nbsp;0x419a18b8&nbsp;in&nbsp;??&nbsp;()<br>
#9&nbsp;&nbsp;0x00000002&nbsp;in&nbsp;??&nbsp;()<br>
#10&nbsp;0x00000000&nbsp;in&nbsp;??&nbsp;()<br>
#11&nbsp;0x40c0fece&nbsp;in&nbsp;__lll_mutex_lock_wait&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0<br>
#12&nbsp;0x40c0cceb&nbsp;in&nbsp;_L_mutex_lock_24&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0<br>
#13&nbsp;0x419a18ac&nbsp;in&nbsp;??&nbsp;()<br>
#14&nbsp;0x419a18b0&nbsp;in&nbsp;??&nbsp;()<br>
#15&nbsp;0x40c6b994&nbsp;in&nbsp;__sigsetjmp&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6<br>
#16&nbsp;0x40ed4964&nbsp;in&nbsp;??&nbsp;()<br>
#17&nbsp;0x419a18ac&nbsp;in&nbsp;??&nbsp;()<br>
#18&nbsp;0x00000000&nbsp;in&nbsp;??&nbsp;()<br>
#19&nbsp;0x401b6850&nbsp;in&nbsp;??&nbsp;()&nbsp;from&nbsp;/home/mono/lib/libmono.so.0<br>
#20&nbsp;0x00001000&nbsp;in&nbsp;??&nbsp;()<br>
#21&nbsp;0x419a1a80&nbsp;in&nbsp;??&nbsp;()<br>
#22&nbsp;0x419a1978&nbsp;in&nbsp;??&nbsp;()<br>
#23&nbsp;0x40135010&nbsp;in&nbsp;thread_exit&nbsp;(exitstatus=1075549660,&nbsp;handle=0x0)&nbsp;at&nbsp;threads.c:173<br>
#24&nbsp;0x40135010&nbsp;in&nbsp;thread_exit&nbsp;(exitstatus=0,&nbsp;handle=0xf19)&nbsp;at&nbsp;threads.c:173<br>
#25&nbsp;0x40136f03&nbsp;in&nbsp;_wapi_timed_thread_exit&nbsp;(exitstatus=0)&nbsp;at&nbsp;timed-thread.c:63<br>
#26&nbsp;0x401371bb&nbsp;in&nbsp;timed_thread_start_routine&nbsp;(args=0x8163950)&nbsp;at&nbsp;timed-thread.c:135<br>
#27&nbsp;0x40155dc5&nbsp;in&nbsp;GC_start_routine&nbsp;()&nbsp;from&nbsp;/home/mono/lib/libmono.so.0<br>
#28&nbsp;0x40c0b8dc&nbsp;in&nbsp;start_thread&nbsp;()&nbsp;from&nbsp;/lib/libpthread.so.0<br>
#29&nbsp;0x40cf567a&nbsp;in&nbsp;clone&nbsp;()&nbsp;from&nbsp;/lib/libc.so.6<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
So&nbsp;we&nbsp;have&nbsp;the&nbsp;garbage&nbsp;collecting&nbsp;thread&nbsp;waiting&nbsp;for&nbsp;a&nbsp;signal&nbsp;from&nbsp;the<br>
stopping&nbsp;threads&nbsp;to&nbsp;say&nbsp;that&nbsp;its&nbsp;ok&nbsp;to&nbsp;begin&nbsp;garbage&nbsp;collection.&nbsp;And<br>
the&nbsp;zombie&nbsp;threads&nbsp;are&nbsp;waiting&nbsp;on&nbsp;a&nbsp;mutex&nbsp;which&nbsp;is&nbsp;(I&nbsp;think)&nbsp;related&nbsp;to<br>
pthread_cleanup_push?&lt;br&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
Scott.&lt;br&gt;<br>
&lt;/blockquote&gt;<br>
From<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://techpubs.sgi.com/library/tpl/cgi-bin/getdoc.cgi?coll=linux&amp;db=bks&amp;srch=&amp;fname=/SGI_Admin/Porting_Guide/sgi_html/ch07.html&quot;&gt;http://techpubs.sgi.com/library/tpl/cgi-bin/getdoc.cgi?coll=linux&amp;amp;db=bks&amp;amp;srch=&amp;amp;fname=/SGI_Admin/Porting_Guide/sgi_html/ch07.html&lt;/a&gt;<br>
:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;font&nbsp;size=&quot;3&quot;&gt;The&nbsp;Native&nbsp;Posix&nbsp;Thread&nbsp;Library&nbsp;(described&nbsp;in&nbsp;&lt;a<br>
&nbsp;href=&quot;http://people.redhat.com/drepper/nptl-design.pdf&quot;&gt;http://people.redhat.com/drepper/nptl-design.pdf&lt;/a&gt;<br>
)&nbsp;provides&nbsp;performance&nbsp;improvements&nbsp;and&nbsp;increased&nbsp;scalability&nbsp;and&nbsp;it<br>
aims&nbsp;to&nbsp;overcome&nbsp;most&nbsp;of&nbsp;the&nbsp;deficiencies&nbsp;of&nbsp;Linux&nbsp;Threads&nbsp;while<br>
remaining&nbsp;as&nbsp;compatible&nbsp;as&nbsp;possible&nbsp;to&nbsp;the&nbsp;Linux&nbsp;Thread&nbsp;API.&nbsp;It&nbsp;is&nbsp;also<br>
a&nbsp;1:1&nbsp;(rather&nbsp;than&nbsp;M:N)&nbsp;threading&nbsp;model,&nbsp;but&nbsp;it&nbsp;corrects&nbsp;many&nbsp;of&nbsp;the<br>
issues&nbsp;with&nbsp;signal&nbsp;handling&nbsp;in&nbsp;Linux&nbsp;Threads&nbsp;and&nbsp;is&nbsp;thus&nbsp;much&nbsp;more<br>
standard&nbsp;conformant.&nbsp;Applications&nbsp;that&nbsp;rely&nbsp;on&nbsp;behavior&nbsp;where&nbsp;the<br>
LinuxThreads&nbsp;implementation&nbsp;deviates&nbsp;from&nbsp;the&nbsp;POSIX&nbsp;standard&nbsp;will&nbsp;need<br>
to&nbsp;be&nbsp;fixed.&lt;/font&gt;&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
