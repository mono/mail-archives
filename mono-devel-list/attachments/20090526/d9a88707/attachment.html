<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;are&nbsp;investigating&nbsp;some&nbsp;memory&nbsp;leaks&nbsp;in&nbsp;Mono&nbsp;that&nbsp;happen&nbsp;on&nbsp;Windows.&nbsp;In&nbsp;our&nbsp;(Unity)&nbsp;case,&nbsp;we&nbsp;live&nbsp;in&nbsp;a&nbsp;web&nbsp;browser&nbsp;and&nbsp;when&nbsp;closing&nbsp;our&nbsp;plugin&nbsp;the&nbsp;process&nbsp;does&nbsp;not&nbsp;terminate.&nbsp;Turns&nbsp;out&nbsp;there&nbsp;are&nbsp;some&nbsp;GC&nbsp;related&nbsp;memory&nbsp;leaks&nbsp;that&nbsp;persist&nbsp;after&nbsp;shutting&nbsp;down&nbsp;Mono.&nbsp;We&nbsp;are&nbsp;using&nbsp;quite&nbsp;an&nbsp;old&nbsp;Mono&nbsp;version,&nbsp;but&nbsp;from&nbsp;a&nbsp;quick&nbsp;glance&nbsp;at&nbsp;2.4&nbsp;and&nbsp;svn,&nbsp;looks&nbsp;like&nbsp;they&nbsp;could&nbsp;be&nbsp;there&nbsp;as&nbsp;well.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;found&nbsp;that&nbsp;there&nbsp;are&nbsp;some&nbsp;VirtualAlloc()&nbsp;calls&nbsp;that&nbsp;are&nbsp;never&nbsp;freed.&nbsp;They&nbsp;mostly&nbsp;manifest&nbsp;themselves&nbsp;when&nbsp;allocating&nbsp;large&nbsp;managed&nbsp;arrays&nbsp;(it&nbsp;looks&nbsp;like&nbsp;for&nbsp;large&nbsp;memory&nbsp;blocks&nbsp;a&nbsp;different&nbsp;allocation&nbsp;code&nbsp;path&nbsp;is&nbsp;used).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;we&nbsp;changed&nbsp;(everything&nbsp;on&nbsp;Windows):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1)&nbsp;add&nbsp;a&nbsp;call&nbsp;to GC_win32_free_heap()&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;mono_jit_cleanup&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2)&nbsp;change&nbsp;GC_win32_free_heap()&nbsp;to&nbsp;do&nbsp;VirtualFree&nbsp;as&nbsp;well&nbsp;(added&nbsp;whole&nbsp;&amp;quot;else&amp;quot;&nbsp;block):&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;void&nbsp;GC_win32_free_heap&nbsp;()&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;  &nbsp; if&nbsp;(GC_no_win32_dlls)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; while&nbsp;(GC_n_heap_bases&nbsp;&amp;gt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GlobalFree&nbsp;(GC_heap_bases[--GC_n_heap_bases]);&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GC_heap_bases[GC_n_heap_bases]&nbsp;=&nbsp;0;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;  &nbsp; }&nbsp;else&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; while&nbsp;(GC_n_heap_bases&nbsp;&amp;gt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VirtualFree(GC_heap_bases[--GC_n_heap_bases],&nbsp;0,&nbsp;MEM_RELEASE);&lt;/div&gt;<br>
&lt;div&gt;  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GC_heap_bases[GC_n_heap_bases]&nbsp;=&nbsp;0;&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; }&lt;/div&gt;&lt;div&gt;  &nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;above&nbsp;seems&nbsp;to&nbsp;fix&nbsp;major&nbsp;leaks.&nbsp;We&nbsp;are&nbsp;not&nbsp;totally&nbsp;sure&nbsp;if&nbsp;it&amp;#39;s&nbsp;the&nbsp;right&nbsp;thing&nbsp;to&nbsp;do,&nbsp;but&nbsp;it&nbsp;does&nbsp;look&nbsp;like&nbsp;some&nbsp;VirtualFree()&nbsp;calls&nbsp;were&nbsp;missing.&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;Aras&nbsp;Pranckevièius&lt;br&gt;work:&nbsp;&lt;a&nbsp;href=&quot;http://unity3d.com&quot;&gt;http://unity3d.com&lt;/a&gt;&lt;br&gt;home:&nbsp;&lt;a&nbsp;href=&quot;http://aras-p.info&quot;&gt;http://aras-p.info&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
