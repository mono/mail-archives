? m
Index: class.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/class.c,v
retrieving revision 1.245
diff -u -r1.245 class.c
--- class.c	10 Mar 2004 00:50:12 -0000	1.245
+++ class.c	13 Mar 2004 04:30:22 -0000
@@ -1055,8 +1055,11 @@
 		MonoMethod *cm;
 	       
 		cm = class->methods [i];
-
-		if (!(cm->flags & METHOD_ATTRIBUTE_NEW_SLOT) && (cm->flags & METHOD_ATTRIBUTE_VIRTUAL)) {
+		
+		if (cm->flags & METHOD_ATTRIBUTE_VIRTUAL == 0)
+			continue;
+		
+		if (!(cm->flags & METHOD_ATTRIBUTE_NEW_SLOT)) {
 			int slot = -1;
 			for (k = class->parent; k ; k = k->parent) {
 				int j;
Index: icall.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/icall.c,v
retrieving revision 1.431
diff -u -r1.431 icall.c
--- icall.c	11 Mar 2004 18:01:25 -0000	1.431
+++ icall.c	13 Mar 2004 04:30:24 -0000
@@ -2551,9 +2551,12 @@
 		}
 		
 		match = 0;
-		if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
-			continue;
-		g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), method);
+		if (method->slot != -1) {
+			if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
+				continue;
+			g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), method);
+		}
+		
 		member = (MonoObject*)mono_method_get_object (domain, method, refklass);
 		
 		l = g_slist_prepend (l, member);
@@ -2696,9 +2699,11 @@
 				continue;
 		}
 		
-		if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
-			continue;
-		g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), prop);
+		if (method->slot != -1) {
+			if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
+				continue;
+			g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), prop);
+		}
 
 		l = g_slist_prepend (l, mono_property_get_object (domain, startklass, prop));
 		len++;
Index: mono-debug-debugger.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/mono-debug-debugger.c,v
retrieving revision 1.24
diff -u -r1.24 mono-debug-debugger.c
--- mono-debug-debugger.c	18 Feb 2004 15:58:02 -0000	1.24
+++ mono-debug-debugger.c	13 Mar 2004 04:30:24 -0000
@@ -653,9 +653,12 @@
 
 		if (method->flags & METHOD_ATTRIBUTE_SPECIAL_NAME)
 			continue;
-		if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
-			continue;
-		g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), method);
+		
+		if (method->slot != -1) {
+			if (g_hash_table_lookup (method_slots, GUINT_TO_POINTER (method->slot)))
+				continue;
+			g_hash_table_insert (method_slots, GUINT_TO_POINTER (method->slot), method);
+		}
 
 		if (method->flags & METHOD_ATTRIBUTE_STATIC) {
 			++num_static_methods;
Index: object.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/object.c,v
retrieving revision 1.203
diff -u -r1.203 object.c
--- object.c	5 Mar 2004 03:46:04 -0000	1.203
+++ object.c	13 Mar 2004 04:30:24 -0000
@@ -1418,7 +1418,7 @@
 		if (!obj) {
 			obj = mono_object_new (mono_domain_get (), method->klass);
 			if (mono_object_class(obj) == mono_defaults.transparent_proxy_class) {
-				method = mono_marshal_get_remoting_invoke (method->klass->vtable [method->slot]);
+				method = mono_marshal_get_remoting_invoke (method->slot == -1 ? method : method->klass->vtable [method->slot]);
 			}
 		}
 		mono_runtime_invoke (method, obj, pa, exc);
