Index: inssel.brg
===================================================================
RCS file: /cvs/public/mono/mono/mini/inssel.brg,v
retrieving revision 1.35
diff -u -r1.35 inssel.brg
--- inssel.brg	5 Mar 2004 03:46:51 -0000	1.35
+++ inssel.brg	13 Mar 2004 20:16:20 -0000
@@ -1968,6 +1968,19 @@
 	int stypes_reg = mono_regstate_next_int (s->rs);
 	int stype = mono_regstate_next_int (s->rs);
 
+	if (klass->flags & TYPE_ATTRIBUTE_SEALED) {
+		if (mono_compile_aot) {
+			int const_reg = mono_regstate_next_int (s->rs);
+			MONO_EMIT_NEW_CLASSCONST (s, const_reg, klass);
+			MONO_EMIT_NEW_BIALU (s, OP_COMPARE, -1, klass_reg, const_reg);
+		} else {
+			MONO_EMIT_NEW_BIALU_IMM (s, OP_COMPARE_IMM, -1, klass_reg, klass);
+		}
+		
+		MONO_EMIT_NEW_BRANCH_LABEL (s, CEE_BEQ, true_target);
+		return;
+	}
+	
 	if (klass->idepth > MONO_DEFAULT_SUPERTABLE_SIZE) {
 		MONO_EMIT_NEW_LOAD_MEMBASE (s, idepth_reg, klass_reg, G_STRUCT_OFFSET (MonoClass, idepth));
 		MONO_EMIT_NEW_BIALU_IMM (s, OP_COMPARE_IMM, -1, idepth_reg, klass->idepth);
@@ -2020,6 +2033,19 @@
 	int stypes_reg = mono_regstate_next_int (s->rs);
 	int stype = mono_regstate_next_int (s->rs);
 
+	if (klass->flags & TYPE_ATTRIBUTE_SEALED) {
+		if (mono_compile_aot) {
+			int const_reg = mono_regstate_next_int (s->rs);
+			MONO_EMIT_NEW_CLASSCONST (s, const_reg, klass);
+			MONO_EMIT_NEW_BIALU (s, OP_COMPARE, -1, klass_reg, const_reg);
+		} else {
+			MONO_EMIT_NEW_BIALU_IMM (s, OP_COMPARE_IMM, -1, klass_reg, klass);
+		}
+		
+		MONO_EMIT_NEW_COND_EXC (s, NE_UN, "InvalidCastException");
+		return;
+	}
+	
 	if (klass->idepth > MONO_DEFAULT_SUPERTABLE_SIZE) {
 		MONO_EMIT_NEW_LOAD_MEMBASE (s, idepth_reg, klass_reg, G_STRUCT_OFFSET (MonoClass, idepth));
 		MONO_EMIT_NEW_BIALU_IMM (s, OP_COMPARE_IMM, -1, idepth_reg, klass->idepth);
