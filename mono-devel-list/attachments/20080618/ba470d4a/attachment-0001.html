<tt>
This&nbsp;patch&nbsp;looks&nbsp;fine&nbsp;to&nbsp;be&nbsp;commited.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2008/6/18&nbsp;Kornél&nbsp;Pál&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:kornelpal@gmail.com&quot;&gt;kornelpal@gmail.com&lt;/a&gt;&amp;gt;:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
Hi,&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;patch&nbsp;implements&nbsp;GetHINSTANCE:&lt;br&gt;<br>
Returns&nbsp;HINSTANCE&nbsp;(same&nbsp;as&nbsp;HMODULE)&nbsp;for&nbsp;modules&nbsp;loaded&nbsp;using&nbsp;LoadLibrary,&nbsp;otherwise&nbsp;returns&nbsp;-1.&nbsp;As&nbsp;a&nbsp;result&nbsp;-1&nbsp;is&nbsp;returned&nbsp;on&nbsp;non-Windows&nbsp;platforms.&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;you&nbsp;like&nbsp;the&nbsp;patch&nbsp;please&nbsp;approve&nbsp;it.&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
Kornél&lt;br&gt;<br>
&lt;/font&gt;&lt;br&gt;Index:&nbsp;mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs&nbsp;&amp;nbsp;(revision&nbsp;106149)&lt;br&gt;<br>
+++&nbsp;mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs&nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-377,10&nbsp;+377,12&nbsp;@@&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;throw&nbsp;new&nbsp;NotImplementedException&nbsp;();&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
-&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;[MonoTODO]&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;public&nbsp;static&nbsp;IntPtr&nbsp;GetHINSTANCE&nbsp;(Module&nbsp;m)&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;{&lt;br&gt;<br>
-&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;throw&nbsp;new&nbsp;NotImplementedException&nbsp;();&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;(m&nbsp;==&nbsp;null)&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;throw&nbsp;new&nbsp;ArgumentNullException&nbsp;(&amp;quot;m&amp;quot;);&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;return&nbsp;m.GetHINSTANCE&nbsp;();&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;[MonoTODO&nbsp;(&amp;quot;SetErrorInfo&amp;quot;)]&lt;br&gt;<br>
Index:&nbsp;mcs/class/corlib/System.Reflection/Module.cs&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mcs/class/corlib/System.Reflection/Module.cs&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(revision&nbsp;106149)&lt;br&gt;<br>
+++&nbsp;mcs/class/corlib/System.Reflection/Module.cs&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-446,6&nbsp;+446,9&nbsp;@@&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;[MethodImplAttribute&nbsp;(MethodImplOptions.InternalCall)]&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;internal&nbsp;extern&nbsp;IntPtr&nbsp;GetHINSTANCE&nbsp;();&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;[MethodImplAttribute&nbsp;(MethodImplOptions.InternalCall)]&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;private&nbsp;extern&nbsp;string&nbsp;GetGuidInternal&nbsp;();&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;[MethodImplAttribute&nbsp;(MethodImplOptions.InternalCall)]&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/icall-def.h&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/icall-def.h&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(revision&nbsp;106149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/icall-def.h&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-523,6&nbsp;+523,7&nbsp;@@&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_1,&nbsp;&amp;quot;Close&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_Close)&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_2,&nbsp;&amp;quot;GetGlobalType&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_GetGlobalType)&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_3,&nbsp;&amp;quot;GetGuidInternal&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_GetGuidInternal)&lt;br&gt;<br>
+ICALL(MODULE_14,&nbsp;&amp;quot;GetHINSTANCE&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_GetHINSTANCE)&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_4,&nbsp;&amp;quot;GetMDStreamVersion&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_GetMDStreamVersion)&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_5,&nbsp;&amp;quot;GetPEKind&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_GetPEKind)&lt;br&gt;<br>
&amp;nbsp;ICALL(MODULE_6,&nbsp;&amp;quot;InternalGetTypes&amp;quot;,&nbsp;ves_icall_System_Reflection_Module_InternalGetTypes)&lt;br&gt;<br>
Index:&nbsp;mono/mono/metadata/icall.c&lt;br&gt;<br>
===================================================================&lt;br&gt;<br>
---&nbsp;mono/mono/metadata/icall.c&nbsp;&amp;nbsp;(revision&nbsp;106149)&lt;br&gt;<br>
+++&nbsp;mono/mono/metadata/icall.c&nbsp;&amp;nbsp;(working&nbsp;copy)&lt;br&gt;<br>
@@&nbsp;-5210,6&nbsp;+5210,17&nbsp;@@&lt;br&gt;<br>
&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;return&nbsp;mono_string_new&nbsp;(domain,&nbsp;module-&amp;gt;image-&amp;gt;guid);&lt;br&gt;<br>
&amp;nbsp;}&lt;br&gt;<br>
&lt;br&gt;<br>
+static&nbsp;gpointer&lt;br&gt;<br>
+ves_icall_System_Reflection_Module_GetHINSTANCE&nbsp;(MonoReflectionModule&nbsp;*module)&lt;br&gt;<br>
+{&lt;br&gt;<br>
+#ifdef&nbsp;PLATFORM_WIN32&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;if&nbsp;(module-&amp;gt;image&nbsp;&amp;amp;&amp;amp;&nbsp;module-&amp;gt;image-&amp;gt;is_module_handle)&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;return&nbsp;module-&amp;gt;image-&amp;gt;raw_data;&lt;br&gt;<br>
+#endif&lt;br&gt;<br>
+&lt;br&gt;<br>
+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;return&nbsp;(gpointer)&nbsp;(-1);&lt;br&gt;<br>
+}&lt;br&gt;<br>
+&lt;br&gt;<br>
&amp;nbsp;static&nbsp;void&lt;br&gt;<br>
&amp;nbsp;ves_icall_System_Reflection_Module_GetPEKind&nbsp;(MonoImage&nbsp;*image,&nbsp;gint32&nbsp;*pe_kind,&nbsp;gint32&nbsp;*machine)&lt;br&gt;<br>
&amp;nbsp;{&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
