#! /bin/bash
#
# description: Provides ASP.NET functionality for Apache
#

# Source function library.
INITD=/etc/rc.d/init.d
. $INITD/functions

MOD_MONO_SERVER="/usr/local/bin/mod-mono-server.exe"

MOD_MONO_PIPE="/tmp/mod_mono_server"

start() {
    echo -n "Starting ASP.NET..."
    if [ -z "$PIDS" ]; then
	mono $MOD_MONO_SERVER --applications /:/home/html --nonstop > /dev/null &
	ret=$?
	if [ $ret -eq 0 ]; then
	    chmod 777 $MOD_MONO_PIPE
	    echo_success
	    /sbin/service apache2 restart
	else
	    echo_failure
	fi	
    else
	echo ASP.NET already running. PIDs: $PIDS
    fi
    echo
}

stop() {
    echo -n "Stopping ASP.NET..."
    if [ -z "$PIDS" ]; then
	echo ASP.NET is not running.
    else
	kill -9 $PIDS 2> /dev/null

	ret=$?
	if [ $ret -eq 0 ]; then
	    echo_success
	else
	    echo_failure
	fi	
    fi
    echo
}

restart() {
    $0 stop
    $0 start
}


PIDS=`ps awx | grep mod-mono-server | grep -v grep | cut -b 1-5`;

case "$1" in
    start)
	start
	;;
    
    stop)
	stop
	;;
    
    restart)
	restart
	;;
    
    *)
	echo $"Usage: $0 {start|stop|restart}"
	exit 1
esac

exit 0

