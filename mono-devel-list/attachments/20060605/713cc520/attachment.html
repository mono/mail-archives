<tt>
&lt;div&gt;Hi.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;improve&nbsp;performance&nbsp;by&nbsp;using&nbsp;System.Reflection.Emit.&nbsp;Here&nbsp;is&nbsp;what&nbsp;I&nbsp;do:&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;-&nbsp;I&nbsp;have&nbsp;a&nbsp;class&nbsp;(let's&nbsp;call&nbsp;it&nbsp;vector).&nbsp;It&nbsp;has&nbsp;a&nbsp;1D&nbsp;array&nbsp;of&nbsp;double&nbsp;for&nbsp;holding&nbsp;the&nbsp;data.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;-&nbsp;The&nbsp;Vector&nbsp;class&nbsp;has&nbsp;operators&nbsp;(+,&nbsp;-,&nbsp;etc.).&nbsp;In&nbsp;the&nbsp;overloaded&nbsp;operators,&nbsp;I&nbsp;build&nbsp;the&nbsp;expression&nbsp;tree.&nbsp;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;emulate&nbsp;expression&nbsp;template&nbsp;trick.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;-&nbsp;To&nbsp;copy&nbsp;the&nbsp;result&nbsp;of&nbsp;calculation&nbsp;to&nbsp;the&nbsp;destination&nbsp;Vector,&nbsp;I&nbsp;define&nbsp;a&nbsp;function&nbsp;Assign().&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;-&nbsp;The&nbsp;function&nbsp;Assign()&nbsp;will&nbsp;emit&nbsp;the&nbsp;opcodes&nbsp;based&nbsp;on&nbsp;expression&nbsp;that&nbsp;is&nbsp;passed.&nbsp;It&nbsp;only&nbsp;emit&nbsp;the&nbsp;opcodes&nbsp;when&nbsp;it's&nbsp;executed&nbsp;for&nbsp;the&nbsp;first&nbsp;time.&nbsp;The&nbsp;next&nbsp;time,&nbsp;it&nbsp;just&nbsp;execute&nbsp;the&nbsp;opcode.&lt;BR&gt;The&nbsp;pseudo&nbsp;code&nbsp;of&nbsp;Assign()&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;void&nbsp;Assign(Expression&nbsp;pex)&lt;BR&gt;{&lt;BR&gt;&amp;nbsp;if&nbsp;(the&nbsp;opcodes&nbsp;don't&nbsp;exist)&lt;BR&gt;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;Emit&nbsp;opcodes&nbsp;for&nbsp;expression&nbsp;pex.&lt;BR&gt;&amp;nbsp;}&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;execute&nbsp;the&nbsp;emitted&nbsp;opcodes&lt;BR&gt;}&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&lt;BR&gt;The&nbsp;main&nbsp;program<br>
&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;Vector&nbsp;v1&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;v2&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;v3&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;v4&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;v5&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;v6&nbsp;=&nbsp;new&nbsp;Vector(300);&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;BR&gt;Vector&nbsp;result&nbsp;=&nbsp;new&nbsp;Vector(300);&nbsp;&amp;nbsp;//&nbsp;create&nbsp;vector&nbsp;with&nbsp;300&nbsp;elements&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;result.Assign(v1&nbsp;+&nbsp;v2&nbsp;-&nbsp;v3&nbsp;+&nbsp;v4&nbsp;-&nbsp;v5&nbsp;+&nbsp;v6);&nbsp;&amp;nbsp;//&nbsp;copy&nbsp;the&nbsp;result.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;To&nbsp;find&nbsp;out&nbsp;the&nbsp;performance,&nbsp;I&nbsp;execute&nbsp;Assign()&nbsp;100000&nbsp;times&nbsp;and&nbsp;measure&nbsp;the&nbsp;execution&nbsp;time.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;for(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;100000;&nbsp;i++)&lt;BR&gt;&amp;nbsp;result.Assign(v1&nbsp;+&nbsp;v2&nbsp;-&nbsp;v3&nbsp;+&nbsp;v4&nbsp;-&nbsp;v5&nbsp;+&nbsp;v6);&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;To&nbsp;compare&nbsp;the&nbsp;speed,&nbsp;I&nbsp;also&nbsp;define&nbsp;another&nbsp;function&nbsp;Assign2()&nbsp;and&nbsp;execute&nbsp;it&nbsp;also&nbsp;100000&nbsp;times.<br>
&nbsp;Here&nbsp;is&nbsp;the&nbsp;implementation:&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;void&nbsp;Assign2(Vector&nbsp;v1,&nbsp;Vector&nbsp;v2,&nbsp;Vector&nbsp;v3,&nbsp;Vector&nbsp;v4,&nbsp;Vector&nbsp;v5,&nbsp;Vector&nbsp;v6)&lt;BR&gt;{&lt;BR&gt;&amp;nbsp;for(int&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&amp;lt;&nbsp;m_size;&nbsp;i++)&lt;BR&gt;&amp;nbsp;{&lt;BR&gt;&amp;nbsp;&amp;nbsp;m_data[i]&nbsp;=&nbsp;v1.m_data[i]+v2.m_data[i]-v3.m_data[i]+v4.m_data[i]-v5.m_data[i]+v6.m_data[i];&lt;BR&gt;&amp;nbsp;}&lt;BR&gt;}&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;I&nbsp;expect&nbsp;Assign&nbsp;(using&nbsp;Reflection.Emit)&nbsp;to&nbsp;outperform&nbsp;Assign2&nbsp;because&amp;nbsp;Assign()&nbsp;basically&nbsp;unrolls&nbsp;the&nbsp;loop.&nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;But&nbsp;I&nbsp;am&nbsp;very&nbsp;surprised&nbsp;to&nbsp;find&nbsp;out&nbsp;that&nbsp;Assign2&nbsp;is&nbsp;almost&nbsp;3&nbsp;times&nbsp;faster&nbsp;than&nbsp;Assign().&nbsp;I&nbsp;tried&nbsp;this&nbsp;in&nbsp;on&nbsp;mono&nbsp;1.1.13.8&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&lt;BR&gt;How&nbsp;can&nbsp;this&nbsp;happen?&nbsp;I&nbsp;thought&nbsp;Reflection.Emit&nbsp;is&nbsp;superior.&lt;BR&gt;Am&nbsp;I&nbsp;doing&nbsp;something&nbsp;wrong?&nbsp;Does&nbsp;it&nbsp;have&nbsp;something&nbsp;to&nbsp;do&nbsp;with&nbsp;memory&nbsp;or&nbsp;cache&nbsp;or&nbsp;????&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;Can&nbsp;someone&nbsp;help&nbsp;me?&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;The&nbsp;opcodes&nbsp;that&nbsp;I&nbsp;emitted&nbsp;is&nbsp;pretty&nbsp;much&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;opcodes&nbsp;in&nbsp;Assign2&nbsp;because&nbsp;I&nbsp;monodis&nbsp;Assign2()&nbsp;and&nbsp;then<br>
&nbsp;basically&nbsp;&quot;copy&quot;&nbsp;the&nbsp;opcodes&nbsp;to&nbsp;Assign()&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;I&nbsp;don't&nbsp;mind&nbsp;to&nbsp;go&nbsp;down&nbsp;to&nbsp;opcodes&nbsp;level&nbsp;as&nbsp;long&nbsp;as&nbsp;I&nbsp;can&nbsp;get&nbsp;the&nbsp;performance.&nbsp;But&amp;nbsp;the&nbsp;result&amp;nbsp;has&nbsp;been&nbsp;dissapointing&nbsp;so&nbsp;far.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;attention.&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&amp;nbsp;&lt;/div&gt;&nbsp;&nbsp;&lt;div&gt;&lt;BR&gt;Rusmin&lt;/div&gt;&lt;p&gt;&amp;#32;__________________________________________________&lt;br&gt;Do&nbsp;You&nbsp;Yahoo!?&lt;br&gt;Tired&nbsp;of&nbsp;spam?&nbsp;&nbsp;Yahoo!&nbsp;Mail&nbsp;has&nbsp;the&nbsp;best&nbsp;spam&nbsp;protection&nbsp;around&nbsp;&lt;br&gt;http://mail.yahoo.com&nbsp;
</tt>
