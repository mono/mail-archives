<tt>
Hi&nbsp;Massimiliano.&lt;br&gt;&lt;br&gt;Do&nbsp;you&nbsp;have&nbsp;any&nbsp;measurements&nbsp;of&nbsp;the&nbsp;collision&nbsp;rates&nbsp;the&nbsp;hash&nbsp;function&nbsp;generates&nbsp;over&nbsp;corlib?&nbsp;This&nbsp;should&nbsp;provide&nbsp;enough&nbsp;data&nbsp;to&nbsp;verify&nbsp;the&nbsp;hash&nbsp;quality.&nbsp;If&nbsp;collision&nbsp;is&nbsp;too&nbsp;bad,&nbsp;you&nbsp;could&nbsp;store&nbsp;the&nbsp;IMT&nbsp;slot&nbsp;in&nbsp;MonoMethod&nbsp;and&nbsp;do&nbsp;slot&nbsp;distribution&nbsp;when&nbsp;the&nbsp;interface&nbsp;is&nbsp;loaded.<br>
&lt;br&gt;&lt;br&gt;I&amp;#39;ve&nbsp;got&nbsp;some&nbsp;points&nbsp;about&nbsp;the&nbsp;IMT&nbsp;thunks:&lt;br&gt;&lt;br&gt;You&nbsp;are&nbsp;using&nbsp;indirect&nbsp;absolute&nbsp;jmps&nbsp;over&nbsp;the&nbsp;vtable&nbsp;pointer,&nbsp;which&nbsp;is&nbsp;slower&nbsp;than&nbsp;relative&nbsp;jmps.&nbsp;The&nbsp;code&nbsp;could&nbsp;check&nbsp;if&nbsp;the&nbsp;target&nbsp;method&nbsp;is&nbsp;already&nbsp;compiled&nbsp;and&nbsp;issue&nbsp;a&nbsp;relative&nbsp;jump&nbsp;directly.&nbsp;The&nbsp;compile&nbsp;trampolines&nbsp;could&nbsp;patch&nbsp;the&nbsp;thunks,&nbsp;but&nbsp;this&nbsp;could&nbsp;end&nbsp;been&nbsp;really&nbsp;tricky.<br>
&lt;br&gt;&lt;br&gt;The&nbsp;thunks&nbsp;will&nbsp;generate&nbsp;too&nbsp;much&nbsp;relocation&nbsp;in&nbsp;AOT&amp;#39;ed&nbsp;code,&nbsp;one&nbsp;for&nbsp;each&nbsp;collision,&nbsp;changing&nbsp;it&nbsp;to&nbsp;one&nbsp;for&nbsp;each&nbsp;thunk&nbsp;should&nbsp;improve&nbsp;that,&nbsp;just&nbsp;load&nbsp;the&nbsp;vtable&nbsp;at&nbsp;the&nbsp;beginning&nbsp;in&nbsp;a&nbsp;register.&nbsp;By&nbsp;the&nbsp;way,&nbsp;AOT&amp;#39;ed&nbsp;code&nbsp;could&nbsp;use&nbsp;a&nbsp;lot&nbsp;of&nbsp;relative&nbsp;jumps,&nbsp;so&nbsp;this&nbsp;point&nbsp;might&nbsp;be&nbsp;mild&nbsp;if&nbsp;relative&nbsp;jumps&nbsp;are&nbsp;used.<br>
&lt;br&gt;&lt;br&gt;How&nbsp;fast&nbsp;is&nbsp;the&nbsp;hash&nbsp;function?&nbsp;Shouldn&amp;#39;t&nbsp;the&nbsp;IMT&nbsp;slot&nbsp;be&nbsp;cached&nbsp;in&nbsp;MonoMethod?&lt;br&gt;&lt;br&gt;&lt;br&gt;The&nbsp;patch&nbsp;looks&nbsp;great,&nbsp;congrats!&lt;br&gt;&lt;br&gt;&lt;br&gt;Rodrigo&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;5/31/07,&nbsp;&lt;b&nbsp;class=&quot;gmail_sendername&quot;&gt;<br>
Massimiliano&nbsp;Mantione&lt;/b&gt;&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:massi@ximian.com&quot;&gt;massi@ximian.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;br&gt;Here&nbsp;is&nbsp;the&nbsp;IMT&nbsp;patch&nbsp;for&nbsp;an&nbsp;initial&nbsp;review.&lt;br&gt;See&nbsp;here&nbsp;for&nbsp;an&nbsp;explanation&nbsp;of&nbsp;what&nbsp;IMT&nbsp;is:&lt;br&gt;&lt;a&nbsp;href=&quot;http://primates.ximian.com/~massi/blog/archive/2007/May-10.html&quot;&gt;http://primates.ximian.com/~massi/blog/archive/2007/May-10.html<br>
&lt;/a&gt;&lt;br&gt;&lt;br&gt;Initially&nbsp;it&nbsp;looked&nbsp;&amp;quot;mildly&nbsp;unstable&amp;quot;:&nbsp;when&nbsp;rebuilding&nbsp;the&nbsp;whole&nbsp;Mono&lt;br&gt;I&nbsp;got&nbsp;a&nbsp;couple&nbsp;of&nbsp;NRE&nbsp;in&nbsp;the&nbsp;mcs&nbsp;symbol&nbsp;writer&nbsp;while&nbsp;compiling&nbsp;some&lt;br&gt;library;&nbsp;just&nbsp;typing&nbsp;make&nbsp;again&nbsp;worked,&nbsp;so&nbsp;the&nbsp;problem&nbsp;was&nbsp;very&nbsp;hard<br>
&lt;br&gt;to&nbsp;reproduce.&lt;br&gt;However,&nbsp;now&nbsp;I&nbsp;updated&nbsp;my&nbsp;tree,&nbsp;and&nbsp;I&nbsp;just&nbsp;cannot&nbsp;reproduce&nbsp;it&nbsp;anymore.&lt;br&gt;I&nbsp;fully&nbsp;rebuilt&nbsp;it&nbsp;three&nbsp;times,&nbsp;running&nbsp;the&nbsp;tests...&nbsp;no&nbsp;crashes.&lt;br&gt;The&nbsp;IMT&nbsp;size&nbsp;is&nbsp;set&nbsp;to&nbsp;a&nbsp;ridiculous&nbsp;4&nbsp;to&nbsp;get&nbsp;lots&nbsp;of&nbsp;collisions&nbsp;and<br>
&lt;br&gt;stress&nbsp;the&nbsp;thunks.&lt;br&gt;&lt;br&gt;TODO:&lt;br&gt;-&nbsp;Cleanup&nbsp;the&nbsp;code&nbsp;(mostly&nbsp;remove&nbsp;print&nbsp;statements).&lt;br&gt;&amp;nbsp;&amp;nbsp;BTW,&nbsp;do&nbsp;you&nbsp;think&nbsp;some&nbsp;of&nbsp;the&nbsp;print&nbsp;statements&nbsp;can&nbsp;stay&nbsp;there&nbsp;anyway?&lt;br&gt;-&nbsp;Move&nbsp;&amp;quot;mono_convert_imt_slot_to_vtable_slot&amp;quot;&nbsp;elsewhere&nbsp;(<br>
mini.c?).&lt;br&gt;-&nbsp;Does&nbsp;setting&nbsp;&amp;quot;MonoClass.imt_collisions_bitmap&amp;quot;&nbsp;need&nbsp;locking?&lt;br&gt;&amp;nbsp;&amp;nbsp;If&nbsp;yes,&nbsp;it&nbsp;should&nbsp;be&nbsp;the&nbsp;loader&nbsp;lock,&nbsp;but&nbsp;does&nbsp;acquiring&nbsp;it&nbsp;with&nbsp;the&lt;br&gt;&amp;nbsp;&amp;nbsp;domain&nbsp;lock&nbsp;held&nbsp;(we&nbsp;are&nbsp;building&nbsp;the&nbsp;MonoVTable)&nbsp;risk&nbsp;a&nbsp;deadlock?<br>
&lt;br&gt;-&nbsp;Add&nbsp;cumulative&nbsp;size&nbsp;of&nbsp;thunks&nbsp;to&nbsp;mono&nbsp;stats.&lt;br&gt;-&nbsp;Also&nbsp;add&nbsp;general&nbsp;&amp;quot;performance&amp;quot;&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;the&nbsp;stats?&lt;br&gt;&amp;nbsp;&amp;nbsp;I&nbsp;mean,&nbsp;collision&nbsp;ratio&nbsp;and&nbsp;things&nbsp;like&nbsp;that...&lt;br&gt;-&nbsp;Measure&nbsp;memory&nbsp;savings&nbsp;and&nbsp;call&nbsp;slowdown.<br>
&lt;br&gt;-&nbsp;Tune&nbsp;IMT&nbsp;size&nbsp;and&nbsp;hash&nbsp;function&nbsp;(even&nbsp;if&nbsp;IMO&nbsp;the&nbsp;hash&nbsp;is&nbsp;already&nbsp;OK).&lt;br&gt;-&nbsp;Maybe&nbsp;rewrite&nbsp;the&nbsp;thunks&nbsp;to&nbsp;do&nbsp;binary&nbsp;search&nbsp;instead&nbsp;of&nbsp;linear.&lt;br&gt;-&nbsp;Port&nbsp;to&nbsp;all&nbsp;the&nbsp;other&nbsp;architectures.&lt;br&gt;-&nbsp;Remove&nbsp;the&nbsp;&amp;quot;non&nbsp;IMT&amp;quot;&nbsp;code&nbsp;paths.<br>
&lt;br&gt;&lt;br&gt;Do&nbsp;you&nbsp;think&nbsp;this&nbsp;should&nbsp;be&nbsp;committed&nbsp;before&nbsp;the&nbsp;other&nbsp;archs&nbsp;are&nbsp;ported,&lt;br&gt;or&nbsp;should&nbsp;we&nbsp;wait&nbsp;for&nbsp;the&nbsp;port&nbsp;to&nbsp;be&nbsp;complete&nbsp;and&nbsp;commit&nbsp;without&nbsp;the&lt;br&gt;current&nbsp;code&nbsp;path?&lt;br&gt;&lt;br&gt;Ciao,&lt;br&gt;&amp;nbsp;&amp;nbsp;Massi&lt;br&gt;&lt;br&gt;&lt;br&gt;_______________________________________________<br>
&lt;br&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list<br>
&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
