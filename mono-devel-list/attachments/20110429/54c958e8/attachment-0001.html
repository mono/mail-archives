<tt>
Hi,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  Those&nbsp;trampolines&nbsp;are&nbsp;in&nbsp;tramp-&amp;lt;ARCH&amp;gt;.c,&nbsp;they&nbsp;are&nbsp;called&nbsp;monitor_enter/exit_trampoline&nbsp;().&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;  &nbsp; Zoltan&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Apr&nbsp;29,&nbsp;2011&nbsp;at&nbsp;3:39&nbsp;PM,&nbsp;Martin&nbsp;Daeumler&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:mdae@cs.tu-chemnitz.de&quot;&gt;mdae@cs.tu-chemnitz.de&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;March&nbsp;10,&nbsp;2010,&nbsp;Paolo&nbsp;Molaro&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;Further,&nbsp;I&nbsp;traced&nbsp;it&nbsp;down&nbsp;into&nbsp;the&nbsp;mono&nbsp;2.6.1&nbsp;code&nbsp;tree,&nbsp;and&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;mono_monitor_exit&nbsp;is&nbsp;never&nbsp;called.&nbsp;The&nbsp;trampoline&nbsp;generates&nbsp;the&nbsp;code,&nbsp;but&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;it&amp;#39;s&nbsp;never&nbsp;called.&nbsp;Can&nbsp;you&nbsp;provide&nbsp;a&nbsp;quick&nbsp;fix?&nbsp;It&nbsp;seems&nbsp;like&nbsp;a&nbsp;glaring&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;bug.&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;There&nbsp;is&nbsp;no&nbsp;bug,&nbsp;on&nbsp;your&nbsp;architecture&nbsp;the&nbsp;fast&nbsp;path&nbsp;is&nbsp;optimized&nbsp;and&nbsp;it&lt;br&gt;<br>
&amp;gt;won&amp;#39;t&nbsp;go&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;in&nbsp;the&nbsp;runtime.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Hello,&lt;br&gt;<br>
&lt;br&gt;<br>
how&nbsp;does&nbsp;this&nbsp;fast&nbsp;path&nbsp;work&nbsp;on&nbsp;x86&nbsp;and&nbsp;Mono&nbsp;2.6.1?&nbsp;During&nbsp;JITing&nbsp;this&nbsp;code:&lt;br&gt;<br>
&lt;br&gt;<br>
class&nbsp;Test&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; int&nbsp;test1;&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; public&nbsp;int&nbsp;callInst(Test&nbsp;myClass)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lock&nbsp;(this)&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; myClass.test1&nbsp;=&nbsp;1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;myClass.test1;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; static&nbsp;int&nbsp;Main()&nbsp;{&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Test&nbsp;meineKlasse&nbsp;=&nbsp;new&nbsp;Test();&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int&nbsp;ret&nbsp;=&nbsp;meineKlasse.callInst(meineKlasse);&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Console.WriteLine(&amp;quot;meineKlasse:&nbsp;&amp;quot;&nbsp;+&nbsp;ret.ToString());&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return&nbsp;0;&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; }&lt;br&gt;<br>
}&lt;br&gt;<br>
&lt;br&gt;<br>
,&nbsp;&amp;quot;mono_monitor_get_fast_enter_method()&amp;quot;&nbsp;and&lt;br&gt;<br>
&amp;quot;mono_monitor_get_fast_exit_method()&amp;quot;&lt;br&gt;<br>
are&nbsp;not&nbsp;called.&nbsp;While&nbsp;executing&nbsp;the&nbsp;method&nbsp;&amp;quot;callInst()&amp;quot;&nbsp;the&nbsp;unmanaged&lt;br&gt;<br>
function&lt;br&gt;<br>
&amp;quot;mono_monitor_enter()&amp;quot;&nbsp;(mono/metadata/monitor.c)&nbsp;is&nbsp;called&nbsp;through&nbsp;a&nbsp;generic&lt;br&gt;<br>
trampoline.&lt;br&gt;<br>
&lt;br&gt;<br>
Q1:&nbsp;The&nbsp;generic&nbsp;(monitor)&nbsp;trampoline&nbsp;is&nbsp;not&nbsp;called&nbsp;directly&nbsp;by&nbsp;the&nbsp;code&nbsp;of&lt;br&gt;<br>
&amp;quot;callInst()&amp;quot;.&lt;br&gt;<br>
There&nbsp;is&nbsp;a&nbsp;kind&nbsp;of&nbsp;wrapper&nbsp;that&nbsp;calls&nbsp;the&nbsp;generic&nbsp;trampoline.&nbsp;Where&nbsp;is&nbsp;the&lt;br&gt;<br>
wrapper&lt;br&gt;<br>
generated?&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;leaving&nbsp;the&nbsp;lock-block,&nbsp;i.e.,&nbsp;calling&lt;br&gt;<br>
&amp;quot;System.Threading.Monitor::Exit()&amp;quot;&nbsp;from&nbsp;within&lt;br&gt;<br>
the&nbsp;finally-block&nbsp;in&nbsp;den&nbsp;CIL-code,&nbsp;the&nbsp;unmanaged&nbsp;function&lt;br&gt;<br>
&amp;quot;mono_monitor_exit()&amp;quot;&lt;br&gt;<br>
(mono/metadata/monitor.c)&nbsp;is&nbsp;not&nbsp;called&nbsp;at&nbsp;all.&nbsp;There&nbsp;is&nbsp;an&nbsp;ominous&nbsp;piece&nbsp;of&lt;br&gt;<br>
code&nbsp;that&lt;br&gt;<br>
returns&nbsp;to&nbsp;&amp;quot;callInst()&amp;quot;.&lt;br&gt;<br>
&lt;br&gt;<br>
Q2:&nbsp;How&nbsp;is&nbsp;the&nbsp;monitor&nbsp;exit&nbsp;fast&nbsp;path&nbsp;realized?&nbsp;Where&nbsp;is&nbsp;the&nbsp;&amp;quot;wrapper&amp;quot;&lt;br&gt;<br>
generated&lt;br&gt;<br>
which&nbsp;does&nbsp;not&nbsp;call&nbsp;&amp;quot;mono_monitor_exit()&amp;quot;?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
With&nbsp;kind&nbsp;regards,&lt;br&gt;<br>
Martin&nbsp;Däumler&lt;br&gt;<br>
&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
--&lt;br&gt;<br>
View&nbsp;this&nbsp;message&nbsp;in&nbsp;context:&nbsp;&lt;a&nbsp;href=&quot;http://mono.1490590.n4.nabble.com/System-Threading-Monitor-Exit-fails-in-latest-trees-tp1578116p3483712.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://mono.1490590.n4.nabble.com/System-Threading-Monitor-Exit-fails-in-latest-trees-tp1578116p3483712.html&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;/font&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;Sent&nbsp;from&nbsp;the&nbsp;Mono&nbsp;-&nbsp;Dev&nbsp;mailing&nbsp;list&nbsp;archive&nbsp;at&nbsp;Nabble.com.&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
