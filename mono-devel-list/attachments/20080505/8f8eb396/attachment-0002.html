<tt>
&lt;html&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Back&nbsp;in&nbsp;September&nbsp;(&quot;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-weight:&nbsp;bold;&nbsp;&quot;&gt;Big&nbsp;Arrays,&nbsp;Many&nbsp;Changes&nbsp;---&nbsp;Request&nbsp;for&nbsp;Advice&lt;/span&gt;&quot;)&nbsp;I&nbsp;asked&nbsp;folks&nbsp;for&nbsp;advice&nbsp;on&nbsp;how&nbsp;to&nbsp;go&nbsp;about&nbsp;adding&nbsp;the&nbsp;capability&nbsp;to&nbsp;Mono&nbsp;to&nbsp;allocate&nbsp;arrays&nbsp;with&nbsp;more&nbsp;than&nbsp;Int32.MaxValue&nbsp;elements.&nbsp;&amp;nbsp;After&nbsp;playing&nbsp;around&nbsp;with&nbsp;it&nbsp;for&nbsp;a&nbsp;few&nbsp;months,&nbsp;I'm&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;I&nbsp;have&nbsp;an&nbsp;implementation&nbsp;that&nbsp;mostly&nbsp;works,&nbsp;with&nbsp;a&nbsp;couple&nbsp;of&nbsp;warts&nbsp;which&nbsp;could&nbsp;probably&nbsp;be&nbsp;quickly&nbsp;fixed&nbsp;by&nbsp;someone&nbsp;who&nbsp;knows&nbsp;more&nbsp;than&nbsp;I&nbsp;do&nbsp;about&nbsp;Mono&nbsp;internals.&amp;nbsp;I&nbsp;spoke&nbsp;with&nbsp;Miguel&nbsp;about&nbsp;these&nbsp;patches,&nbsp;and&nbsp;he&nbsp;encouraged&nbsp;me&nbsp;to&nbsp;post&nbsp;them&nbsp;to&nbsp;mono-dev&nbsp;as&nbsp;soon&nbsp;as&nbsp;I&nbsp;got&nbsp;them&nbsp;to&nbsp;pass&nbsp;the&nbsp;&quot;make&nbsp;check&quot;&nbsp;test&nbsp;suite.&nbsp;&amp;nbsp;So&nbsp;here&nbsp;I&nbsp;am&nbsp;a&nbsp;week&nbsp;later.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;want&nbsp;to&nbsp;start&nbsp;by&nbsp;going&nbsp;over&nbsp;the&nbsp;changes&nbsp;themselves,&nbsp;what&nbsp;alternatives&nbsp;there&nbsp;might&nbsp;be&nbsp;to&nbsp;what&nbsp;I&nbsp;had&nbsp;done&nbsp;and&nbsp;what&nbsp;flaws&nbsp;I&nbsp;know&nbsp;to&nbsp;exist&nbsp;in&nbsp;the&nbsp;implementation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;First&nbsp;off,&nbsp;though&nbsp;Microsoft&nbsp;chose&nbsp;for&nbsp;some&nbsp;reason&nbsp;NOT&nbsp;to&nbsp;implement&nbsp;large&nbsp;array&nbsp;allocation,&nbsp;the&nbsp;necessary&nbsp;APIs&nbsp;are&nbsp;in&nbsp;the&nbsp;.NET&nbsp;specification.&nbsp;&amp;nbsp;For&nbsp;example,&nbsp;in&nbsp;the&nbsp;System.Array&nbsp;class,&nbsp;we&nbsp;find:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;public&nbsp;long&amp;nbsp;&lt;/font&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/system.array.getlonglength.aspx&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;GetLongLength&lt;/font&gt;&lt;/a&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;(int&nbsp;dimension);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;public&nbsp;long&amp;nbsp;&lt;/font&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/system.array.longlength.aspx&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;LongLength&lt;/font&gt;&lt;/a&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&amp;nbsp;{&nbsp;get;&nbsp;}&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;public&nbsp;static&nbsp;Array&amp;nbsp;&lt;/font&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/1z8w3at5.aspx&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;CreateInstance&lt;/font&gt;&lt;/a&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;(Type&nbsp;elementType,&nbsp;params&nbsp;long[]&nbsp;lengths);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;public&nbsp;Object&amp;nbsp;&lt;/font&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/2zexc3z9.aspx&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;GetValue&lt;/font&gt;&lt;/a&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;(long&nbsp;index);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;public&nbsp;void&amp;nbsp;&lt;/font&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/czx562xz.aspx&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;SetValue&lt;/font&gt;&lt;/a&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;(Object&nbsp;value,&nbsp;long&nbsp;index);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;...&nbsp;(other&nbsp;overloads&nbsp;omitted,&nbsp;but&nbsp;there)&lt;br&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;we&nbsp;find&nbsp;that&nbsp;the&amp;nbsp;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/system.reflection.emit.opcodes.newarr(VS.71).aspx&quot;&gt;Newarr&lt;/a&gt;&amp;nbsp;&amp;nbsp;opcode&nbsp;takes&nbsp;a&nbsp;natural&nbsp;int&nbsp;or&nbsp;an&nbsp;Int32&nbsp;as&nbsp;the&nbsp;length,&nbsp;so&nbsp;the&nbsp;bytecode&nbsp;level&nbsp;is&nbsp;ready&nbsp;too.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Mono&nbsp;as&nbsp;of&nbsp;1.2.6&nbsp;already&nbsp;implemented&nbsp;most&nbsp;(all?)&nbsp;of&nbsp;the&nbsp;necessary&nbsp;interfaces&nbsp;in&amp;nbsp;mcs/class/corlib/System/Array.cs,&nbsp;but&nbsp;they&nbsp;all&nbsp;cast&nbsp;down&nbsp;their&nbsp;long&nbsp;arguments&nbsp;down&nbsp;to&nbsp;integers&nbsp;as&nbsp;the&nbsp;underlying&nbsp;implementation&nbsp;was&nbsp;not&nbsp;there.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;the&nbsp;first&nbsp;set&nbsp;of&nbsp;changes&nbsp;were&nbsp;to:&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/metadata/object.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/metadata/object.h&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/metadata/icall-def.h&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/metadata/icall.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/metadata/socket-io.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&amp;nbsp;object.h&nbsp;I&nbsp;made&nbsp;three&nbsp;changes:&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;1)&nbsp;Changed&nbsp;MonoArrayBounds&nbsp;to&nbsp;use&nbsp;gsize&nbsp;instead&nbsp;of&nbsp;guint32&nbsp;as&nbsp;the&nbsp;type&nbsp;for&nbsp;length&nbsp;and&nbsp;lower_bound,&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;2)&nbsp;Changed&nbsp;MonoArray&nbsp;to&nbsp;use&nbsp;gsize&nbsp;instead&nbsp;of&nbsp;guint32&nbsp;as&nbsp;the&nbsp;type&nbsp;of&nbsp;max_length,&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;3)&nbsp;Changed&nbsp;the&nbsp;prototypes&nbsp;for&nbsp;mono_array_new(),&nbsp;mono_array_new_full(),&nbsp;and&nbsp;mono_array_new_specific()&nbsp;to&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/span&gt;take&amp;nbsp;gsize's&nbsp;instead&nbsp;of&nbsp;guint32's&nbsp;for&nbsp;their&nbsp;size&nbsp;and&nbsp;bounds&nbsp;parameters.&lt;/div&gt;&lt;div&gt;I.e.:&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;MonoArray*&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;-mono_array_new&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(MonoDomain&nbsp;*domain,&nbsp;MonoClass&nbsp;*eclass,&nbsp;guint32&nbsp;n);&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;+mono_array_new&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(MonoDomain&nbsp;*domain,&nbsp;MonoClass&nbsp;*eclass,&nbsp;gsize&nbsp;n);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;MonoArray*&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&amp;nbsp;mono_array_new_full&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(MonoDomain&nbsp;*domain,&nbsp;MonoClass&nbsp;*array_class,&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;-&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;guint32&nbsp;*lengths,&nbsp;guint32&nbsp;*lower_bounds);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;+&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;gsize&nbsp;*lengths,&nbsp;gsize&nbsp;*lower_bounds);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;MonoArray&nbsp;*&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;-mono_array_new_specific&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(MonoVTable&nbsp;*vtable,&nbsp;guint32&nbsp;n);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/font&gt;&lt;/span&gt;&lt;font&nbsp;class=&quot;Apple-style-span&quot;&nbsp;face=&quot;'Courier&nbsp;New'&quot;&gt;+mono_array_new_specific&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;&nbsp;&amp;nbsp;(MonoVTable&nbsp;*vtable,&nbsp;gsize&nbsp;n);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;the&nbsp;first&nbsp;place&nbsp;an&nbsp;alternative&nbsp;shows&nbsp;up.&nbsp;&amp;nbsp;¿Which&nbsp;type&nbsp;is&nbsp;better:&nbsp;gsize&nbsp;or&nbsp;gssize?&nbsp;&amp;nbsp;The&nbsp;unsigned&nbsp;type&nbsp;gsize&nbsp;better&nbsp;matches&nbsp;the&nbsp;type&nbsp;memory&nbsp;allocation&nbsp;functions&nbsp;use&nbsp;(size_t&nbsp;or&nbsp;some&nbsp;variant)&nbsp;and&nbsp;the&nbsp;existing&nbsp;guint32,&nbsp;but&nbsp;the&nbsp;signed&nbsp;type&nbsp;better&nbsp;matches&nbsp;the&nbsp;interface&nbsp;presented&nbsp;at&nbsp;the&nbsp;top&nbsp;level&nbsp;(i.e.&nbsp;CreateInstance).&nbsp;&amp;nbsp;I&nbsp;chose&nbsp;the&nbsp;unsigned&nbsp;alternative,&nbsp;but&nbsp;an&nbsp;argument&nbsp;could&nbsp;be&nbsp;made&nbsp;for&nbsp;the&nbsp;signed&nbsp;type.&nbsp;&amp;nbsp;Another&nbsp;alternative&nbsp;would&nbsp;be&nbsp;to&nbsp;create&nbsp;64&nbsp;bit&nbsp;versions&nbsp;of&nbsp;the&amp;nbsp;mono_array_new(),&nbsp;mono_array_new_full(),&nbsp;and&nbsp;mono_array_new_specific()&nbsp;functions,&nbsp;but&nbsp;that&nbsp;seemed&nbsp;to&nbsp;be&nbsp;too&nbsp;much&nbsp;work.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;in&nbsp;&lt;b&gt;object.c&lt;/b&gt;&nbsp;add&nbsp;the&nbsp;implementations&nbsp;of&nbsp;the&nbsp;modified&amp;nbsp;mono_array_new(),&nbsp;mono_array_new_full(),&nbsp;and&nbsp;mono_array_new_specific()&nbsp;functions.&nbsp;&amp;nbsp;There&nbsp;was&nbsp;some&nbsp;confusing&nbsp;#defines&nbsp;around&nbsp;MYGUINT32_MAX&nbsp;that&nbsp;I&nbsp;did&nbsp;not&nbsp;like,&nbsp;but&nbsp;rather&nbsp;than&nbsp;replace&nbsp;that&nbsp;cruft,&nbsp;I&nbsp;extended&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;in&nbsp;&lt;b&gt;icall-def.h&lt;/b&gt;&nbsp;add&nbsp;two&nbsp;new&nbsp;method&nbsp;calls&nbsp;to&nbsp;the&nbsp;array&nbsp;object,&amp;nbsp;CreateInstanceImpl64()&nbsp;and&amp;nbsp;GetLongLength().&nbsp;&amp;nbsp;It&nbsp;might&nbsp;be&nbsp;possible&nbsp;to&nbsp;avoid&nbsp;the&amp;nbsp;CreateInstanceImpl64()&amp;nbsp;definition&amp;nbsp;and&nbsp;make&nbsp;it&nbsp;an&nbsp;overload&nbsp;of&amp;nbsp;CreateInstanceImpl()&nbsp;with&nbsp;long&nbsp;parameters,&nbsp;if&nbsp;I&nbsp;was&nbsp;sure&nbsp;on&nbsp;how&nbsp;to&nbsp;do&nbsp;that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;to&nbsp;&lt;b&gt;icall.c&lt;/b&gt;&nbsp;tweak&nbsp;the&nbsp;implementation&nbsp;of&amp;nbsp;ves_icall_System_Array_CreateInstanceImpl()&nbsp;to&nbsp;change&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;sizes&nbsp;array&nbsp;and&nbsp;add&nbsp;the&nbsp;implementations&nbsp;of&amp;nbsp;ves_icall_System_Array_CreateInstanceImpl64()&nbsp;and&amp;nbsp;ves_icall_System_Array_GetLongLength().&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;change&nbsp;to&nbsp;&lt;b&gt;socket-io.c&lt;/b&gt;&nbsp;was&nbsp;to&nbsp;tweak&nbsp;its&nbsp;usage&nbsp;of&nbsp;mono_array_new_full&nbsp;to&nbsp;use&nbsp;gssize&nbsp;instead&nbsp;of&nbsp;int&nbsp;for&nbsp;for&nbsp;the&nbsp;array&nbsp;of&nbsp;lengths.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;all&nbsp;these&nbsp;changes&nbsp;get&nbsp;us&nbsp;to&nbsp;the&nbsp;point&nbsp;where&nbsp;the&nbsp;basic&nbsp;foundation&nbsp;is&amp;nbsp;laid&amp;nbsp;down,&nbsp;but&nbsp;there&nbsp;is&nbsp;still&nbsp;the&nbsp;JIT&nbsp;to&nbsp;contend&nbsp;with.&nbsp;&amp;nbsp;It&nbsp;requires&nbsp;a&nbsp;few&nbsp;more&nbsp;files&nbsp;to&nbsp;be&nbsp;changed:&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/mini.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/jit-icalls.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/exceptions.cs&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;in&nbsp;&lt;b&gt;mini.c&lt;/b&gt;&nbsp;change&nbsp;the&nbsp;signature&nbsp;of&amp;nbsp;mono_array_new&nbsp;and&amp;nbsp;mono_array_new_specific&nbsp;to&nbsp;take&nbsp;&quot;int&quot;&nbsp;instead&nbsp;of&nbsp;&quot;int32&quot;.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;in&nbsp;&lt;b&gt;jit-calls.c&lt;/b&gt;&nbsp;do&nbsp;the&nbsp;boring&nbsp;change&nbsp;of&nbsp;guint32's&nbsp;into&nbsp;gsize's.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;changes&nbsp;in&amp;nbsp;&lt;b&gt;exceptions.cs&lt;/b&gt;&nbsp;split&nbsp;the&nbsp;test&nbsp;case&nbsp;for&nbsp;test_0_array_size&nbsp;into&nbsp;a&nbsp;32&nbsp;and&nbsp;64&nbsp;bit&nbsp;variant,&nbsp;because&nbsp;an&nbsp;allocation&nbsp;of&nbsp;Int32.MaxValue&nbsp;can&nbsp;succeed&nbsp;after&nbsp;these&nbsp;changes&nbsp;are&nbsp;applied.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;was&nbsp;only&nbsp;one&nbsp;touch-up&nbsp;needed&nbsp;in&nbsp;the&nbsp;the&nbsp;C#&nbsp;compiler:&nbsp;&amp;nbsp;the&nbsp;GetLength&nbsp;property&nbsp;code&nbsp;special-inlined&nbsp;code-generation&nbsp;needed&nbsp;to&nbsp;be&amp;nbsp;tweaked&amp;nbsp;since&nbsp;it&nbsp;is&nbsp;now&nbsp;possible&nbsp;to&nbsp;get&nbsp;an&nbsp;array&nbsp;length&nbsp;that&nbsp;will&nbsp;not&nbsp;fit&nbsp;into&nbsp;an&nbsp;I4.&nbsp;&amp;nbsp;Changing&amp;nbsp;&lt;b&gt;mcs/mcs/ecore.cs&lt;/b&gt;&nbsp;and&amp;nbsp;&lt;b&gt;mcs/mcs/expression.cs&lt;/b&gt;&nbsp;to&nbsp;use&amp;nbsp;&lt;b&gt;OpCodes.Conv_Ovf_I4&lt;/b&gt;&nbsp;after&amp;nbsp;&lt;b&gt;OpCodes.Ldlen&lt;/b&gt;&amp;nbsp;instead&nbsp;of&amp;nbsp;&lt;b&gt;OpCodes.Conv_I4&lt;/b&gt;&amp;nbsp;&amp;nbsp;fixed&nbsp;that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Oh,&nbsp;yeah,&nbsp;and&nbsp;ALL&nbsp;the&nbsp;long&nbsp;method&nbsp;calls&nbsp;in&amp;nbsp;&lt;b&gt;mcs/class/corlib/System/Array.cs&lt;/b&gt;&nbsp;needed&nbsp;to&nbsp;be&nbsp;converted&nbsp;over&nbsp;to&nbsp;use&amp;nbsp;CreateInstanceImpl64()&nbsp;and&amp;nbsp;GetLongLength().&nbsp;&amp;nbsp;The&nbsp;SetValue()&nbsp;and&nbsp;GetValue()&nbsp;implementations&nbsp;still&nbsp;need&nbsp;work,&nbsp;but&nbsp;since&nbsp;there&nbsp;are&nbsp;no&nbsp;unit&nbsp;tests&nbsp;for&nbsp;those&nbsp;methods,&nbsp;I&nbsp;put&nbsp;them&nbsp;off.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;gets&nbsp;us&nbsp;to&nbsp;the&nbsp;point&nbsp;where&nbsp;we&nbsp;can&nbsp;allocate&nbsp;a&nbsp;large&nbsp;array,&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;let&nbsp;us&nbsp;index&nbsp;a&nbsp;large&nbsp;array.&nbsp;&amp;nbsp;&nbsp;I&nbsp;changed&nbsp;the&nbsp;following&nbsp;files&nbsp;to&nbsp;start&nbsp;the&nbsp;process&nbsp;of&nbsp;converting&nbsp;the&nbsp;indexing&nbsp;operations&nbsp;to&nbsp;do&nbsp;bounds&nbsp;checking&nbsp;against&nbsp;the&nbsp;now&nbsp;32/64&nbsp;bit&nbsp;length&nbsp;of&nbsp;arrays&nbsp;and&nbsp;to&nbsp;index&nbsp;using&nbsp;a&nbsp;64/32&nbsp;bit&nbsp;index:&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/inssel-amd64.brg&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/mini-amd64.c&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/mini-ops.h&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&lt;/b&gt;&lt;/span&gt;&lt;b&gt;mono/mini/cpu-amd64.md&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&amp;nbsp;&lt;b&gt;inssel-amd64.brg&lt;/b&gt;,&nbsp;I&nbsp;changed&nbsp;the&nbsp;macro&amp;nbsp;MONO_EMIT_NEW_AMD64_ICOMPARE_MEMBASE_REG&nbsp;to&nbsp;use&nbsp;a&nbsp;new&nbsp;opcode&amp;nbsp;OP_AMD64_COMPARE_MEMBASE_REG_I8&nbsp;instead&nbsp;of&amp;nbsp;OP_AMD64_ICOMPARE_MEMBASE_REG&nbsp;and&amp;nbsp;hacked&nbsp;CEE_LDELEMA&nbsp;to&nbsp;no&nbsp;longer&nbsp;use&nbsp;&amp;nbsp;the&nbsp;faster&nbsp;OP_X86_LEA&nbsp;because&nbsp;I&nbsp;was&nbsp;not&nbsp;sure&nbsp;how&nbsp;to&nbsp;generalize&nbsp;it.&nbsp;Perhaps&amp;nbsp;MONO_EMIT_NEW_AMD64_ICOMPARE_MEMBASE_REG&nbsp;should&nbsp;be&nbsp;retired&nbsp;and&nbsp;explicit&nbsp;I4&nbsp;and&nbsp;I8&nbsp;versions&nbsp;substituted&nbsp;where&nbsp;appropriate.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&amp;nbsp;&lt;b&gt;mini-amd64.c&lt;/b&gt;&nbsp;I&nbsp;added&nbsp;the&amp;nbsp;OP_AMD64_COMPARE_MEMBASE_REG_I8&nbsp;opcode&nbsp;as&nbsp;being&nbsp;the&nbsp;same&nbsp;as&amp;nbsp;OP_AMD64_ICOMPARE_MEMBASE_REG,&nbsp;except&nbsp;with&nbsp;an&nbsp;operand&nbsp;size&nbsp;of&nbsp;8&nbsp;bytes&nbsp;instead&nbsp;of&nbsp;4.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&amp;nbsp;&lt;b&gt;mini-ops.h&lt;/b&gt;&nbsp;and&amp;nbsp;&lt;b&gt;cpu-amd64.md&lt;/b&gt;&amp;nbsp;I&nbsp;added&nbsp;an&nbsp;entries&nbsp;for&amp;nbsp;OP_AMD64_COMPARE_MEMBASE_REG_I8&nbsp;and&amp;nbsp;amd64_compare_membase_reg_i8.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;These&nbsp;changes&nbsp;seem&nbsp;to&nbsp;get&nbsp;64&nbsp;bit&nbsp;indexing&nbsp;working,&nbsp;and&nbsp;passed&nbsp;all&nbsp;the&nbsp;regression&nbsp;tests&nbsp;in&nbsp;1.2.6,&nbsp;but&nbsp;in&nbsp;1.9.1&nbsp;a&nbsp;regression&nbsp;test&nbsp;called&amp;nbsp;test_0_regress_75832()&nbsp;breaks.&nbsp;&amp;nbsp;It&nbsp;could&nbsp;be&nbsp;that&nbsp;the&nbsp;changes&nbsp;I&nbsp;made&nbsp;in&nbsp;mono/mini&nbsp;are&amp;nbsp;incorrect.&nbsp;&amp;nbsp;I&nbsp;am&nbsp;sure&nbsp;the&nbsp;changes&nbsp;are&nbsp;incomplete,&nbsp;and&nbsp;I&nbsp;have&nbsp;not&nbsp;considered&nbsp;what&nbsp;to&nbsp;do&nbsp;to&nbsp;other&nbsp;architectures.&nbsp;&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Advice&nbsp;or&nbsp;assistance&nbsp;is&nbsp;greatly&nbsp;appreciated.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Luis&nbsp;F.&nbsp;Ortiz&lt;/div&gt;&lt;div&gt;Official&nbsp;Mono&nbsp;Modifier&lt;/div&gt;&lt;div&gt;Interactive&nbsp;Supercomputing,&nbsp;&amp;nbsp;Inc.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;PS:&nbsp;&amp;nbsp;Here&nbsp;are&nbsp;the&nbsp;changes&nbsp;proper:&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
