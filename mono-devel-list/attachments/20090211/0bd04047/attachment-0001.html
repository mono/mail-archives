<tt>
IntPtr&nbsp;code&nbsp;should&nbsp;optimize&nbsp;as&nbsp;well&nbsp;as&nbsp;int&nbsp;on&nbsp;32bits&nbsp;machines&nbsp;and&nbsp;long&nbsp;on&nbsp;64&nbsp;bits&nbsp;machine.&nbsp;If&nbsp;it&amp;#39;s&nbsp;not&nbsp;the&nbsp;case,&nbsp;report&nbsp;it.&lt;br&gt;Working&nbsp;with&nbsp;ints&nbsp;using&nbsp;long&nbsp;will&nbsp;be&nbsp;a&nbsp;lot&nbsp;slower&nbsp;on&nbsp;32bits&nbsp;machines&nbsp;for&nbsp;sure.&lt;br&gt;&lt;br&gt;Regarding&nbsp;doing&nbsp;pointer&nbsp;math,&nbsp;the&nbsp;usual&nbsp;way&nbsp;to&nbsp;do&nbsp;it&nbsp;with&nbsp;C#&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;block&nbsp;of&nbsp;unsafe&nbsp;code&nbsp;and&nbsp;use&nbsp;proper&nbsp;pointer&nbsp;types.&lt;br&gt;<br>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Feb&nbsp;11,&nbsp;2009&nbsp;at&nbsp;3:12&nbsp;PM,&nbsp;&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:russell.kay@realtimeworlds.com&quot;&gt;russell.kay@realtimeworlds.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;div&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&nbsp;lang=&quot;EN-GB&quot;&gt;<br>
<br>
&lt;div&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;Rodrigo,&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;IntPtr&nbsp;objects&nbsp;are&nbsp;very&nbsp;awkward&nbsp;to&nbsp;use&nbsp;and&nbsp;optimise&nbsp;badly,&nbsp;we&nbsp;unwrap<br>
an&nbsp;IntPtr&nbsp;to&nbsp;an&nbsp;internal&nbsp;type&nbsp;called&nbsp;Ptr,&nbsp;that&nbsp;is&nbsp;an&nbsp;enum&nbsp;based&nbsp;on&nbsp;a&nbsp;long,&nbsp;as<br>
this&nbsp;generates&nbsp;much&nbsp;better&nbsp;code&nbsp;within&nbsp;loops&nbsp;and&nbsp;generally&nbsp;inlines&nbsp;better&nbsp;(on<br>
both&nbsp;Mono&nbsp;and&nbsp;MS.Net)&nbsp;we&nbsp;also&nbsp;keep&nbsp;this&nbsp;as&nbsp;a&nbsp;long&nbsp;so&nbsp;that&nbsp;we&nbsp;have&nbsp;the&nbsp;same<br>
assembly&nbsp;on&nbsp;both&nbsp;x86&nbsp;and&nbsp;x64&nbsp;(which&nbsp;limits&nbsp;our&nbsp;testing).&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;IntPtr&nbsp;is&nbsp;also&nbsp;fairly&nbsp;horrible&nbsp;to&nbsp;work&nbsp;with&nbsp;when&nbsp;you&nbsp;are&nbsp;doing<br>
any&nbsp;maths&nbsp;when&nbsp;working&nbsp;with&nbsp;memory&nbsp;operations&nbsp;(which&nbsp;we&nbsp;are&nbsp;doing&nbsp;a&nbsp;lot).&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;Now&nbsp;this&nbsp;is&nbsp;not&nbsp;a&nbsp;problem&nbsp;and&nbsp;works&nbsp;very&nbsp;well&nbsp;on&nbsp;both&nbsp;Mono&nbsp;and<br>
&lt;a&nbsp;href=&quot;http://MS.NET&quot;&nbsp;target=&quot;_blank&quot;&gt;MS.NET&lt;/a&gt;&nbsp;,&nbsp;when&nbsp;this&nbsp;patch&nbsp;is&nbsp;applied.&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;I&nbsp;do&nbsp;not&nbsp;see&nbsp;the&nbsp;objection&nbsp;to&nbsp;this&nbsp;patch&nbsp;as&nbsp;an&nbsp;IntPtr&amp;nbsp;&nbsp;can<br>
safely&nbsp;hold&nbsp;values&nbsp;that&nbsp;are&nbsp;over&nbsp;2Gb&nbsp;and&nbsp;they&nbsp;are&nbsp;valid&nbsp;addresses,&nbsp;also&nbsp;converting<br>
from&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;long&nbsp;does&nbsp;not&nbsp;sign&nbsp;extend&nbsp;it,&nbsp;which&nbsp;is&nbsp;perfectly&nbsp;valid&nbsp;and<br>
at&nbsp;times&nbsp;you&nbsp;do&nbsp;want&nbsp;to&nbsp;convert&nbsp;back&nbsp;to&nbsp;an&nbsp;IntPtr.&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;This&nbsp;is&nbsp;a&nbsp;perfectly&nbsp;safe&nbsp;and&nbsp;sensible&nbsp;patch.&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;Russell&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;p&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;11pt;&nbsp;color:&nbsp;rgb(31,&nbsp;73,&nbsp;125);&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;div&nbsp;style=&quot;border-style:&nbsp;solid&nbsp;none&nbsp;none;&nbsp;border-color:&nbsp;rgb(181,&nbsp;196,&nbsp;223)&nbsp;-moz-use-text-color&nbsp;-moz-use-text-color;&nbsp;border-width:&nbsp;1pt&nbsp;medium&nbsp;medium;&nbsp;padding:&nbsp;3pt&nbsp;0cm&nbsp;0cm;&quot;&gt;<br>
<br>
&lt;p&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;10pt;&quot;&nbsp;lang=&quot;EN-US&quot;&gt;From:&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;10pt;&quot;&nbsp;lang=&quot;EN-US&quot;&gt;&nbsp;Rodrigo&nbsp;Kumpera&nbsp;[mailto:&lt;a&nbsp;href=&quot;mailto:kumpera@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;kumpera@gmail.com&lt;/a&gt;]&nbsp;&lt;br&gt;<br>
&lt;b&gt;Sent:&lt;/b&gt;&nbsp;11&nbsp;February&nbsp;2009&nbsp;17:01&lt;br&gt;<br>
&lt;b&gt;To:&lt;/b&gt;&nbsp;Russell&nbsp;Kay&lt;br&gt;<br>
&lt;b&gt;Cc:&lt;/b&gt;&nbsp;&lt;a&nbsp;href=&quot;mailto:mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&lt;/b&gt;&nbsp;Re:&nbsp;[Mono-dev]&nbsp;Patch&nbsp;for&nbsp;IntPtr&nbsp;bug&lt;/div&gt;&lt;/span&gt;&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;style=&quot;margin-bottom:&nbsp;12pt;&quot;&gt;Russel,&lt;/p&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;think&nbsp;the&nbsp;issue&nbsp;is&nbsp;that&nbsp;you&amp;#39;re&nbsp;using&nbsp;long&nbsp;to&nbsp;represent&nbsp;pointers&nbsp;when&nbsp;you<br>
should&nbsp;be&nbsp;using&nbsp;IntPtr&nbsp;only.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;<br>
<br>
&lt;div&gt;<br>
<br>
&lt;p&gt;2009/2/11&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:russell.kay@realtimeworlds.com&quot;&nbsp;target=&quot;_blank&quot;&gt;russell.kay@realtimeworlds.com&lt;/a&gt;&amp;gt;&lt;/p&gt;<br>
<br>
&lt;div&gt;<br>
<br>
&lt;div&gt;<br>
<br>
&lt;p&gt;All,&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;Not&nbsp;sure&nbsp;the&nbsp;best&nbsp;way&nbsp;to&nbsp;submit&nbsp;this,&nbsp;please&nbsp;correct&nbsp;me&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;better<br>
way&nbsp;to&nbsp;do&nbsp;this&nbsp;(via&nbsp;bugzilla?)&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;I&nbsp;encountered&nbsp;a&nbsp;problem&nbsp;when&nbsp;casting&nbsp;a&nbsp;long&nbsp;to&nbsp;an&nbsp;IntPtr,&nbsp;which&nbsp;is&nbsp;something<br>
we&nbsp;have&nbsp;ended&nbsp;up&nbsp;doing&nbsp;a&nbsp;lot&nbsp;(we&nbsp;want&nbsp;to&nbsp;keep&nbsp;binary&nbsp;assembly&nbsp;compatibility<br>
between&nbsp;x86&nbsp;and&nbsp;x64,&nbsp;only&nbsp;changing&nbsp;the&nbsp;native&nbsp;code&nbsp;on&nbsp;the&nbsp;different<br>
architectures).&nbsp;We&nbsp;encountered&nbsp;a&nbsp;problem&nbsp;with&nbsp;Mono&nbsp;as&nbsp;there&nbsp;has&nbsp;been&nbsp;a&nbsp;check<br>
introduced&nbsp;into&nbsp;the&nbsp;IntPtr&nbsp;constructor&nbsp;from&nbsp;a&nbsp;long,&nbsp;this&nbsp;is&nbsp;checking&nbsp;the&nbsp;range<br>
of&nbsp;the&nbsp;long&nbsp;to&nbsp;ensure&nbsp;it&nbsp;is&nbsp;in&nbsp;range,&nbsp;unfortunately&nbsp;the&nbsp;check&nbsp;is&nbsp;incorrect.&nbsp;A<br>
long&nbsp;can&nbsp;easily&nbsp;hold&nbsp;from&nbsp;Int32.MinValue&nbsp;to&nbsp;UInt32.MaxValue&nbsp;(and&nbsp;not<br>
Int32.MaxValue&nbsp;as&nbsp;it&nbsp;currently&nbsp;in&nbsp;there).&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;See&nbsp;attached&nbsp;patch&nbsp;(contributed&nbsp;under&nbsp;the&nbsp;MIT&nbsp;X11&nbsp;license)&nbsp;to&nbsp;introduce&nbsp;the<br>
one&nbsp;extra&nbsp;character&nbsp;that&nbsp;makes&nbsp;the&nbsp;range&nbsp;check&nbsp;correct.&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;Can&nbsp;I&nbsp;also&nbsp;say&nbsp;that&nbsp;I&nbsp;think&nbsp;the&nbsp;check&nbsp;should&nbsp;really&nbsp;be&nbsp;in&nbsp;a&nbsp;Debug.Assert&nbsp;so<br>
that&nbsp;it&nbsp;disappears&nbsp;in&nbsp;non-Debug&nbsp;versions,&nbsp;the&nbsp;check&nbsp;is&nbsp;good&nbsp;for&nbsp;sanity&nbsp;checking<br>
but&nbsp;superfluous&nbsp;on&nbsp;released&nbsp;code.&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;Regards&lt;/p&gt;<br>
<br>
&lt;p&gt;&amp;nbsp;&lt;/p&gt;<br>
<br>
&lt;p&gt;Russell&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
&lt;p&gt;&lt;br&gt;<br>
____________________________________________________________________&lt;br&gt;<br>
DISCLAIMER&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;message&nbsp;and&nbsp;any&nbsp;attachments&nbsp;contain&nbsp;privileged&nbsp;and&nbsp;confidential<br>
information&nbsp;intended&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;addressee&nbsp;named&nbsp;above.&nbsp;If&nbsp;you&nbsp;are&nbsp;not<br>
the&nbsp;intended&nbsp;recipient&nbsp;of&nbsp;this&nbsp;message,&nbsp;you&nbsp;are&nbsp;hereby&nbsp;notified&nbsp;that&nbsp;any&nbsp;use,<br>
dissemination,&nbsp;distribution&nbsp;or&nbsp;reproduction&nbsp;of&nbsp;this&nbsp;message&nbsp;is&nbsp;prohibited.<br>
Please&nbsp;note&nbsp;that&nbsp;we&nbsp;cannot&nbsp;guarantee&nbsp;that&nbsp;this&nbsp;message&nbsp;or&nbsp;any&nbsp;attachment&nbsp;is<br>
virus&nbsp;free&nbsp;or&nbsp;that&nbsp;it&nbsp;has&nbsp;not&nbsp;been&nbsp;intercepted&nbsp;and&nbsp;amended.&nbsp;The&nbsp;views&nbsp;of&nbsp;the<br>
author&nbsp;may&nbsp;not&nbsp;necessarily&nbsp;reflect&nbsp;those&nbsp;of&nbsp;Realtime&nbsp;Worlds&nbsp;Ltd.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Realtime&nbsp;Worlds&nbsp;Ltd&nbsp;is&nbsp;registered&nbsp;in&nbsp;Scotland,&nbsp;number&nbsp;225628.&nbsp;Registered&nbsp;Office:<br>
152&nbsp;West&nbsp;Marketgait,&nbsp;Dundee,&nbsp;DD1&nbsp;1NJ.&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
&lt;p&nbsp;style=&quot;margin-bottom:&nbsp;12pt;&quot;&gt;&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
&lt;/div&gt;&lt;/div&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;<br>
&lt;br&gt;<br>
____________________________________________________________________&lt;br&gt;<br>
This&nbsp;email&nbsp;has&nbsp;been&nbsp;scanned&nbsp;by&nbsp;the&nbsp;MessageLabs&nbsp;Email&nbsp;Security&nbsp;System&lt;/div&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
<br>
&lt;br&gt;<br>
____________________________________________________________________&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
DISCLAIMER&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;message&nbsp;and&nbsp;any&nbsp;attachments&nbsp;contain&nbsp;privileged&nbsp;and&nbsp;confidential&nbsp;information&nbsp;intended&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;addressee&nbsp;named&nbsp;above.&nbsp;If&nbsp;you&nbsp;are&nbsp;not&nbsp;the&nbsp;intended&nbsp;recipient&nbsp;of&nbsp;this&nbsp;message,&nbsp;you&nbsp;are&nbsp;hereby&nbsp;notified&nbsp;that&nbsp;any&nbsp;use,&nbsp;dissemination,&nbsp;distribution&nbsp;or&nbsp;reproduction&nbsp;of&nbsp;this&nbsp;message&nbsp;is&nbsp;prohibited.&nbsp;Please&nbsp;note&nbsp;that&nbsp;we&nbsp;cannot&nbsp;guarantee&nbsp;that&nbsp;this&nbsp;message&nbsp;or&nbsp;any&nbsp;attachment&nbsp;is&nbsp;virus&nbsp;free&nbsp;or&nbsp;that&nbsp;it&nbsp;has&nbsp;not&nbsp;been&nbsp;intercepted&nbsp;and&nbsp;amended.&nbsp;The&nbsp;views&nbsp;of&nbsp;the&nbsp;author&nbsp;may&nbsp;not&nbsp;necessarily&nbsp;reflect&nbsp;those&nbsp;of&nbsp;Realtime&nbsp;Worlds&nbsp;Ltd.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
&nbsp;&lt;br&gt;<br>
&lt;br&gt;<br>
Realtime&nbsp;Worlds&nbsp;Ltd&nbsp;is&nbsp;registered&nbsp;in&nbsp;Scotland,&nbsp;number&nbsp;225628.&nbsp;Registered&nbsp;Office:&nbsp;152&nbsp;West&nbsp;Marketgait,&nbsp;Dundee,&nbsp;DD1&nbsp;1NJ.&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>
<br>
<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
