? one.patch
Index: inssel-long32.brg
===================================================================
RCS file: /cvs/public/mono/mono/mini/inssel-long32.brg,v
retrieving revision 1.18
diff -u -r1.18 inssel-long32.brg
--- inssel-long32.brg	1 Jul 2004 11:03:12 -0000	1.18
+++ inssel-long32.brg	9 Jul 2004 16:47:20 -0000
@@ -95,19 +95,28 @@
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-cflags: OP_COMPARE (CEE_LDIND_I4 (OP_REGVAR), reg) {
+cflags: OP_COMPARE (CEE_LDIND_REF (OP_REGVAR), reg),
+cflags: OP_COMPARE (CEE_LDIND_I (OP_REGVAR), reg),
+cflags: OP_COMPARE (CEE_LDIND_I4 (OP_REGVAR), reg),
+cflags: OP_COMPARE (CEE_LDIND_U4 (OP_REGVAR), reg) {
 	tree->sreg1 = state->left->left->tree->dreg;
 	tree->sreg2 = state->right->reg1;
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-cflags: OP_COMPARE (CEE_LDIND_I (OP_REGVAR), CEE_LDIND_I (OP_REGVAR)) {
+cflags: OP_COMPARE (CEE_LDIND_REF (OP_REGVAR), CEE_LDIND_REF (OP_REGVAR)),
+cflags: OP_COMPARE (CEE_LDIND_I (OP_REGVAR), CEE_LDIND_I (OP_REGVAR)),
+cflags: OP_COMPARE (CEE_LDIND_I4 (OP_REGVAR), CEE_LDIND_I4 (OP_REGVAR)),
+cflags: OP_COMPARE (CEE_LDIND_U4 (OP_REGVAR), CEE_LDIND_U4 (OP_REGVAR)) {
 	tree->sreg1 = state->left->left->tree->dreg;
 	tree->sreg2 = state->right->left->tree->dreg;
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-cflags: OP_COMPARE (CEE_LDIND_I4 (OP_REGVAR), OP_ICONST) {
+cflags: OP_COMPARE (CEE_LDIND_REF (OP_REGVAR), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_I (OP_REGVAR), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_I4 (OP_REGVAR), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_U4 (OP_REGVAR), OP_ICONST) {
 	tree->opcode = OP_COMPARE_IMM;
 	tree->sreg1 = state->left->left->tree->dreg;
 	tree->inst_imm = state->right->tree->inst_c0;
Index: inssel-x86.brg
===================================================================
RCS file: /cvs/public/mono/mono/mini/inssel-x86.brg,v
retrieving revision 1.22
diff -u -r1.22 inssel-x86.brg
--- inssel-x86.brg	14 May 2004 12:54:27 -0000	1.22
+++ inssel-x86.brg	9 Jul 2004 16:47:20 -0000
@@ -116,7 +116,10 @@
 	MONO_EMIT_NEW_BIALU_IMM (s, OP_ADD_IMM, X86_ESP, X86_ESP, 8);
 }
 
-cflags: OP_COMPARE (CEE_LDIND_I4 (base), reg) {
+cflags: OP_COMPARE (CEE_LDIND_REF (base), reg),
+cflags: OP_COMPARE (CEE_LDIND_I (base), reg),
+cflags: OP_COMPARE (CEE_LDIND_I4 (base), reg),
+cflags: OP_COMPARE (CEE_LDIND_U4 (base), reg) {
 	tree->opcode = OP_X86_COMPARE_MEMBASE_REG;
 	tree->inst_basereg = state->left->left->tree->inst_basereg;
 	tree->inst_offset = state->left->left->tree->inst_offset;
@@ -124,7 +127,10 @@
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-cflags: OP_COMPARE (CEE_LDIND_I4 (base), OP_ICONST) {
+cflags: OP_COMPARE (CEE_LDIND_REF (base), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_I (base), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_I4 (base), OP_ICONST),
+cflags: OP_COMPARE (CEE_LDIND_U4 (base), OP_ICONST) {
 	tree->opcode = OP_X86_COMPARE_MEMBASE_IMM;
 	tree->inst_basereg = state->left->left->tree->inst_basereg;
 	tree->inst_offset = state->left->left->tree->inst_offset;
@@ -132,7 +138,10 @@
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-cflags: OP_COMPARE (reg, CEE_LDIND_I4 (base)) {
+cflags: OP_COMPARE (reg, CEE_LDIND_REF (base)),
+cflags: OP_COMPARE (reg, CEE_LDIND_I (base)),
+cflags: OP_COMPARE (reg, CEE_LDIND_I4 (base)),
+cflags: OP_COMPARE (reg, CEE_LDIND_U4 (base)) {
 	tree->opcode = OP_X86_COMPARE_REG_MEMBASE;
 	tree->sreg2 = state->right->left->tree->inst_basereg;
 	tree->inst_offset = state->right->left->tree->inst_offset;
@@ -179,7 +188,10 @@
 	mono_bblock_add_inst (s->cbb, tree);
 }
 
-stmt: OP_SETRET (CEE_LDIND_REF (OP_REGVAR)) {
+stmt: OP_SETRET (CEE_LDIND_REF (OP_REGVAR)),
+stmt: OP_SETRET (CEE_LDIND_I (OP_REGVAR)),
+stmt: OP_SETRET (CEE_LDIND_I4 (OP_REGVAR)),
+stmt: OP_SETRET (CEE_LDIND_U4 (OP_REGVAR)) {
 	tree->opcode = OP_MOVE;
 	tree->sreg1 = state->left->left->tree->dreg;
 	tree->dreg = X86_EAX;
Index: inssel.brg
===================================================================
RCS file: /cvs/public/mono/mono/mini/inssel.brg,v
retrieving revision 1.45
diff -u -r1.45 inssel.brg
--- inssel.brg	6 Jul 2004 19:28:01 -0000	1.45
+++ inssel.brg	9 Jul 2004 16:47:20 -0000
@@ -419,7 +419,10 @@
 				 state->left->tree->inst_offset, state->right->reg1);
 }
 
-stmt: CEE_STIND_REF (base, CEE_LDIND_REF (OP_REGVAR)) {
+stmt: CEE_STIND_REF (base, CEE_LDIND_REF (OP_REGVAR)),
+stmt: CEE_STIND_REF (base, CEE_LDIND_I (OP_REGVAR)),
+stmt: CEE_STIND_I (base, CEE_LDIND_REF (OP_REGVAR)),
+stmt: CEE_STIND_I (base, CEE_LDIND_I (OP_REGVAR)) {
 	MONO_EMIT_STORE_MEMBASE (s, tree, OP_STORE_MEMBASE_REG, state->left->tree->inst_basereg,
 				 state->left->tree->inst_offset, state->right->left->tree->dreg);
 }
@@ -429,7 +432,10 @@
 				     state->left->tree->inst_offset, state->right->tree->inst_c0);
 }
 
-stmt: CEE_STIND_REF (OP_REGVAR, CEE_LDIND_REF (OP_REGVAR)) {
+stmt: CEE_STIND_REF (OP_REGVAR, CEE_LDIND_REF (OP_REGVAR)),
+stmt: CEE_STIND_REF (OP_REGVAR, CEE_LDIND_I (OP_REGVAR)),
+stmt: CEE_STIND_I (OP_REGVAR, CEE_LDIND_REF (OP_REGVAR)),
+stmt: CEE_STIND_I (OP_REGVAR, CEE_LDIND_I (OP_REGVAR)) {
 	MONO_EMIT_UNALU (s, tree, OP_MOVE, state->left->tree->dreg, state->right->left->tree->dreg);
 }
 
@@ -1028,9 +1034,22 @@
 
 # remove some common pops without side effects
 stmt: CEE_POP (OP_ICONST)
-stmt: CEE_POP (CEE_LDIND_REF (base))
-stmt: CEE_POP (CEE_LDIND_I4 (base))
+stmt: CEE_POP (CEE_LDIND_I1 (base))
 stmt: CEE_POP (CEE_LDIND_U1 (base))
+stmt: CEE_POP (CEE_LDIND_I2 (base))
+stmt: CEE_POP (CEE_LDIND_U2 (base))
+stmt: CEE_POP (CEE_LDIND_I4 (base))
+stmt: CEE_POP (CEE_LDIND_U4 (base))
+stmt: CEE_POP (CEE_LDIND_I (base))
+stmt: CEE_POP (CEE_LDIND_REF (base))
+stmt: CEE_POP (CEE_LDIND_I1 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_U1 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_I2 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_U2 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_I4 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_U4 (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_I (OP_REGVAR))
+stmt: CEE_POP (CEE_LDIND_REF (OP_REGVAR))
 
 stmt: CEE_JMP "0" {
 	mono_bblock_add_inst (s->cbb, tree);
