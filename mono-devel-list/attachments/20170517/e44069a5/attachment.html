<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;Rodrigo,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;feedback!&nbsp;I&nbsp;believe&nbsp;I&nbsp;could&nbsp;adopt&nbsp;using&nbsp;the&nbsp;IMT&nbsp;approach&nbsp;instead&nbsp;of&nbsp;patching&nbsp;the&nbsp;vtable&nbsp;(will&nbsp;simplify&nbsp;the&nbsp;solution).&nbsp;When&nbsp;I&nbsp;tried&nbsp;this&nbsp;in&nbsp;the&nbsp;past&nbsp;it&nbsp;didn&#39;t&nbsp;work&nbsp;out&nbsp;as&nbsp;expected&nbsp;so&nbsp;then&nbsp;I&nbsp;started&nbsp;to&nbsp;look&nbsp;at&nbsp;the&nbsp;transparent&nbsp;proxy&nbsp;solution,&nbsp;since&nbsp;it&nbsp;seemed&nbsp;to&nbsp;be&nbsp;quite&nbsp;close&nbsp;to&nbsp;what&nbsp;I&nbsp;was&nbsp;looking&nbsp;for.&nbsp;Based&nbsp;on&nbsp;your&nbsp;feedback&nbsp;I&nbsp;did&nbsp;a&nbsp;quick&nbsp;tests&nbsp;of&nbsp;switching&nbsp;to&nbsp;IMT&nbsp;together&nbsp;with&nbsp;the&nbsp;rest&nbsp;of&nbsp;ICastable&nbsp;changes&nbsp;+&nbsp;armed&nbsp;with&nbsp;a&nbsp;deeper&nbsp;knowledge&nbsp;around&nbsp;Mono&#39;s&nbsp;implementation&nbsp;of&nbsp;vtable&#39;s&nbsp;and&nbsp;type&nbsp;system,&nbsp;and&nbsp;it&nbsp;seems&nbsp;to&nbsp;work,&nbsp;getting&nbsp;pass&nbsp;on&nbsp;ICastable&nbsp;test&nbsp;suite,&nbsp;+&nbsp;MCG&nbsp;sample.&nbsp;I&nbsp;already&nbsp;had&nbsp;most&nbsp;code&nbsp;in&nbsp;place,&nbsp;so&nbsp;what&nbsp;I&nbsp;did&nbsp;was&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;get&nbsp;a&nbsp;IMT&nbsp;fail&nbsp;tramp&nbsp;for&nbsp;vtables&nbsp;supporting&nbsp;ICastable&nbsp;(will&nbsp;be&nbsp;the&nbsp;same&nbsp;fail&nbsp;tramp&nbsp;as&nbsp;other&nbsp;cases, callbacks.get_imt_trampoline).&nbsp;I&nbsp;already&nbsp;have&nbsp;logic&nbsp;in mono_vcall_trampoline&nbsp;to&nbsp;take&nbsp;care&nbsp;of&nbsp;resolving&nbsp;methods&nbsp;on&nbsp;ICastable&nbsp;objects&nbsp;and&nbsp;all&nbsp;seems&nbsp;to&nbsp;be&nbsp;working&nbsp;as&nbsp;expected.&nbsp;For&nbsp;methods&nbsp;implemented&nbsp;directly&nbsp;by&nbsp;a&nbsp;class&nbsp;that&nbsp;also&nbsp;implements&nbsp;ICastable,&nbsp;I&nbsp;already&nbsp;had&nbsp;solution&nbsp;making&nbsp;sure&nbsp;standard&nbsp;method&nbsp;resolve&nbsp;still&nbsp;kicks&nbsp;in,&nbsp;so&nbsp;the&nbsp;slow&nbsp;path&nbsp;will&nbsp;only&nbsp;be&nbsp;hit&nbsp;when&nbsp;calling&nbsp;methods&nbsp;not&nbsp;directly&nbsp;implemented&nbsp;by&nbsp;class,&nbsp;doing&nbsp;call&nbsp;to&nbsp;ICastable::GetImplType&nbsp;to&nbsp;get&nbsp;to&nbsp;the&nbsp;implementation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;it&nbsp;comes&nbsp;to&nbsp;the&nbsp;broader&nbsp;refactoring&nbsp;idea&nbsp;I&nbsp;think&nbsp;we&nbsp;could&nbsp;do&nbsp;this&nbsp;work&nbsp;in&nbsp;several&nbsp;steps.&nbsp;First&nbsp;step&nbsp;is&nbsp;to&nbsp;getting&nbsp;ICastable&nbsp;done&nbsp;together&nbsp;with&nbsp;the&nbsp;rest&nbsp;of&nbsp;changes&nbsp;needed&nbsp;for&nbsp;the&nbsp;MCG&nbsp;use&nbsp;case&nbsp;to&nbsp;work&nbsp;on&nbsp;the&nbsp;platforms&nbsp;we&nbsp;initial&nbsp;need&nbsp;it.&nbsp;Once&nbsp;all&nbsp;that&nbsp;is&nbsp;working&nbsp;we&nbsp;can&nbsp;move&nbsp;back&nbsp;to&nbsp;do&nbsp;an&nbsp;overhaul&nbsp;of&nbsp;the&nbsp;type&nbsp;checking&nbsp;and&nbsp;casting&nbsp;unifying&nbsp;it&nbsp;where&nbsp;it&nbsp;makes&nbsp;sense.&nbsp;We&nbsp;could&nbsp;keep&nbsp;patches&nbsp;at&nbsp;our&nbsp;end&nbsp;until&nbsp;all&nbsp;is&nbsp;done&nbsp;and&nbsp;then&nbsp;upstream,&nbsp;or&nbsp;we&nbsp;could&nbsp;issue&nbsp;PR&#39;s&nbsp;upstream&nbsp;in&nbsp;several&nbsp;steps&nbsp;as&nbsp;we&nbsp;go.&nbsp;One&nbsp;thing&nbsp;I&#39;m&nbsp;a&nbsp;little&nbsp;worried&nbsp;around&nbsp;is&nbsp;the&nbsp;regression&nbsp;impact&nbsp;refactoring&nbsp;the&nbsp;casting&nbsp;logic.&nbsp;The&nbsp;ICastable&nbsp;changes&nbsp;are&nbsp;still&nbsp;quite&nbsp;isolated&nbsp;to&nbsp;this&nbsp;use&nbsp;case&nbsp;and&nbsp;won&#39;t&nbsp;change&nbsp;other&nbsp;casting&nbsp;scenarios,&nbsp;but&nbsp;doing&nbsp;the&nbsp;bigger&nbsp;refactoring&nbsp;will&nbsp;of&nbsp;course&nbsp;open&nbsp;up&nbsp;for&nbsp;more&nbsp;potential&nbsp;problems.&nbsp;I&nbsp;assume&nbsp;we&nbsp;have&nbsp;tests&nbsp;covering&nbsp;most&nbsp;of&nbsp;the&nbsp;scenarios,&nbsp;special&nbsp;array,&nbsp;interfaces,&nbsp;TP&nbsp;and&nbsp;ones&nbsp;ICastable&nbsp;is&nbsp;in&nbsp;place,&nbsp;we&nbsp;will&nbsp;have&nbsp;a&nbsp;test&nbsp;suite&nbsp;covering&nbsp;that&nbsp;as&nbsp;well,&nbsp;to&nbsp;mitigate&nbsp;potential&nbsp;regression&nbsp;problems&nbsp;in&nbsp;areas&nbsp;not&nbsp;hit&nbsp;that&nbsp;frequent.&nbsp;This&nbsp;might&nbsp;be&nbsp;another&nbsp;reason&nbsp;for&nbsp;doing&nbsp;the&nbsp;change&nbsp;in&nbsp;more&nbsp;than&nbsp;one&nbsp;step,&nbsp;making&nbsp;it&nbsp;easier&nbsp;to&nbsp;track&nbsp;potential&nbsp;regression&nbsp;problems&nbsp;related&nbsp;to&nbsp;changes.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regarding&nbsp;ICastable&nbsp;and&nbsp;reflection,&nbsp;as&nbsp;far&nbsp;as&nbsp;I&nbsp;know&nbsp;and&nbsp;have&nbsp;seen,&nbsp;it&nbsp;is&nbsp;not&nbsp;supported&nbsp;in&nbsp;CoreCLR&nbsp;for&nbsp;ICastable&nbsp;and&nbsp;doesn&#39;t&nbsp;seem&nbsp;to&nbsp;be&nbsp;needed&nbsp;by&nbsp;use&nbsp;cases&nbsp;as&nbsp;MCG.&nbsp;The&nbsp;ICastable&nbsp;test&nbsp;suite&nbsp;in&nbsp;CoreCLR&nbsp;(that&nbsp;I&#39;m&nbsp;using&nbsp;as&nbsp;well)&nbsp;don&#39;t&nbsp;include&nbsp;any&nbsp;tests&nbsp;for&nbsp;reflection&nbsp;in&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regarding&nbsp;making&nbsp;ICastable&nbsp;feature&nbsp;mandatory&nbsp;in&nbsp;Mono?&nbsp;CoreCLR&nbsp;guards&nbsp;it&#39;s&nbsp;implementation&nbsp;with&nbsp;a&nbsp;define&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;set&nbsp;in&nbsp;order&nbsp;to&nbsp;get&nbsp;ICastable&nbsp;runtime&nbsp;support,&nbsp;FEATURE_ICASTABLE.&nbsp;If&nbsp;ICastable&nbsp;should&nbsp;be&nbsp;considered&nbsp;a&nbsp;supported&nbsp;feature&nbsp;in&nbsp;Mono,&nbsp;maybe&nbsp;it&nbsp;could&nbsp;still&nbsp;make&nbsp;sense&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;disable&nbsp;it&nbsp;using&nbsp;a&nbsp;define&nbsp;like&nbsp;DISABLE_ICASTABLE?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Johan&nbsp;Lorensson&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;May&nbsp;17,&nbsp;2017&nbsp;at&nbsp;12:36&nbsp;AM,&nbsp;Rodrigo&nbsp;Kumpera&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rokumper@microsoft.com&quot;&nbsp;target=&quot;_blank&quot;&gt;rokumper@microsoft.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;div&nbsp;bgcolor=&quot;white&quot;&nbsp;lang=&quot;EN-US&quot;&nbsp;link=&quot;blue&quot;&nbsp;vlink=&quot;purple&quot;&gt;<br>
&lt;div&nbsp;class=&quot;m_98293280395837568WordSection1&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Hi&nbsp;Johan,&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Transparent&nbsp;proxy&nbsp;needs&nbsp;to&nbsp;extend&nbsp;the&nbsp;vtable&nbsp;due&nbsp;to&nbsp;virtual&nbsp;methods.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;ICastable&nbsp;(IC),&nbsp;IIRC,&nbsp;doesn&#39;t&nbsp;need&nbsp;to,&nbsp;as&nbsp;it&#39;s&nbsp;only&nbsp;possible&nbsp;to&nbsp;dispatch&nbsp;to&nbsp;interface&nbsp;methods.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Beyond&nbsp;that,&nbsp;vtable&nbsp;patching&nbsp;has&nbsp;a&nbsp;lot&nbsp;of&nbsp;other&nbsp;complications,&nbsp;it&nbsp;breaks&nbsp;invariants&nbsp;such&nbsp;as&nbsp;that&nbsp;two&nbsp;instances&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;of&nbsp;the&nbsp;same&nbsp;class&nbsp;must&nbsp;have&nbsp;the&nbsp;same&nbsp;vtable&nbsp;pointer&nbsp;-&nbsp;we&nbsp;compare&nbsp;them&nbsp;all&nbsp;over&nbsp;the&nbsp;place.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;the&nbsp;following:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Types&nbsp;implementing&nbsp;IC&nbsp;would&nbsp;force&nbsp;their&nbsp;IMT&nbsp;thunks&nbsp;to&nbsp;have&nbsp;a&nbsp;fail&nbsp;tramp,&nbsp;in&nbsp;a&nbsp;similar&nbsp;fashion&nbsp;as&nbsp;its&nbsp;done&nbsp;for&nbsp;other&nbsp;cases.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;imt&nbsp;fail&nbsp;trampoline&nbsp;code&nbsp;would&nbsp;then&nbsp;be&nbsp;adjusted&nbsp;to&nbsp;handle&nbsp;IC.&nbsp;It&#39;s&nbsp;a&nbsp;much&nbsp;simpler&nbsp;and&nbsp;maintainable&nbsp;change.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;That&nbsp;would&nbsp;not&nbsp;require&nbsp;changes&nbsp;to&nbsp;our&nbsp;compilation&nbsp;pipeline.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;comes&nbsp;the&nbsp;second&nbsp;part,&nbsp;type&nbsp;testing.&nbsp;We&nbsp;should&nbsp;be&nbsp;taking&nbsp;this&nbsp;opportunity&nbsp;to&nbsp;clean&nbsp;up&nbsp;the&nbsp;casting&nbsp;code&nbsp;a&nbsp;bit.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;that&nbsp;we&nbsp;use&nbsp;space&nbsp;in&nbsp;the&nbsp;vtable&nbsp;to&nbsp;indicate&nbsp;whether&nbsp;type&nbsp;testing&nbsp;has&nbsp;a&nbsp;slow&nbsp;path.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Right&nbsp;now,&nbsp;we&nbsp;have&nbsp;a&nbsp;couple&nbsp;of&nbsp;cases:&nbsp;special&nbsp;array&nbsp;interfaces&nbsp;and&nbsp;TP.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;My&nbsp;suggestion&nbsp;is&nbsp;to&nbsp;unify&nbsp;the&nbsp;TP&nbsp;and&nbsp;the&nbsp;ICastable&nbsp;checks&nbsp;in&nbsp;the&nbsp;common&nbsp;path&nbsp;and&nbsp;outline&nbsp;the&nbsp;resolution&nbsp;of&nbsp;those.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;We&nbsp;should&nbsp;them&nbsp;experiment&nbsp;applying&nbsp;the&nbsp;same&nbsp;idea&nbsp;to&nbsp;special&nbsp;array&nbsp;interfaces&nbsp;and&nbsp;see&nbsp;whether&nbsp;performance&nbsp;numbers&nbsp;hold.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;We&#39;d&nbsp;need&nbsp;to&nbsp;add&nbsp;checks&nbsp;for&nbsp;IC&nbsp;to&nbsp;all&nbsp;places&nbsp;we&nbsp;do&nbsp;today&nbsp;for&nbsp;TP.&nbsp;They&nbsp;might&nbsp;require&nbsp;big&nbsp;code&nbsp;changes&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;as&nbsp;the&nbsp;TP&nbsp;checks&nbsp;don&#39;t&nbsp;require&nbsp;calling&nbsp;into&nbsp;managed&nbsp;while&nbsp;IC&nbsp;does.&nbsp;The&nbsp;comments&nbsp;in&nbsp;that&nbsp;C#&nbsp;file&nbsp;don&#39;t&nbsp;mention&nbsp;impact&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;on&nbsp;other&nbsp;parts&nbsp;of&nbsp;the&nbsp;runtime,&nbsp;like&nbsp;reflection,&nbsp;which&nbsp;we&nbsp;would&nbsp;need&nbsp;to&nbsp;verify&nbsp;as&nbsp;well.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;The&nbsp;above&nbsp;model&nbsp;is&nbsp;how&nbsp;I&nbsp;think&nbsp;TP&nbsp;should&nbsp;be&nbsp;implemented,&nbsp;but&nbsp;that&nbsp;code&nbsp;predates&nbsp;IMTs.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Finally,&nbsp;there&#39;s&nbsp;no&nbsp;point&nbsp;in&nbsp;making&nbsp;ICastable&nbsp;an&nbsp;optional&nbsp;feature&nbsp;as&nbsp;it&nbsp;should&nbsp;be&nbsp;supported&nbsp;across&nbsp;the&nbsp;board.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;--&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;Rodrigo                       &lt;wbr&gt;                     <br>
&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;span&nbsp;style=&quot;font-size:11.0pt;font-family:&quot;Calibri&quot;,sans-serif&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;div&nbsp;style=&quot;border:none;border-top:solid&nbsp;#b5c4df&nbsp;1.0pt;padding:3.0pt&nbsp;0in&nbsp;0in&nbsp;0in&quot;&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;&lt;span&nbsp;style=&quot;font-family:&quot;Calibri&quot;,sans-serif;color:black&quot;&gt;From:<br>
&lt;/span&gt;&lt;/b&gt;&lt;span&nbsp;style=&quot;font-family:&quot;Calibri&quot;,sans-serif;color:black&quot;&gt;Mono-devel-list&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mono-devel-list-bounces@lists.dot.net&quot;&nbsp;target=&quot;_blank&quot;&gt;mono-devel-list-bounces@&lt;wbr&gt;lists.dot.net&lt;/a&gt;&gt;&nbsp;on&nbsp;behalf&nbsp;of&nbsp;Johan&nbsp;Lorensson&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:lateralusx.github@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;lateralusx.github@gmail.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&lt;b&gt;Date:&nbsp;&lt;/b&gt;Tuesday,&nbsp;May&nbsp;16,&nbsp;2017&nbsp;at&nbsp;2:44&nbsp;AM&lt;br&gt;<br>
&lt;b&gt;To:&nbsp;&lt;/b&gt;&quot;&lt;a&nbsp;href=&quot;mailto:mono-devel-list@lists.dot.net&quot;&nbsp;target=&quot;_blank&quot;&gt;mono-devel-list@lists.dot.net&lt;/a&gt;&lt;wbr&gt;&quot;&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:mono-devel-list@lists.dot.net&quot;&nbsp;target=&quot;_blank&quot;&gt;mono-devel-list@lists.dot.net&lt;/a&gt;&lt;wbr&gt;&gt;&lt;br&gt;<br>
&lt;b&gt;Subject:&nbsp;&lt;/b&gt;[Mono-dev]&nbsp;Supporting&nbsp;ICastable&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/span&gt;&lt;/p&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Hi,&nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Below&nbsp;is&nbsp;a&nbsp;proposed&nbsp;solution&nbsp;to&nbsp;implement&nbsp;support&nbsp;of&nbsp;CoreCLR&nbsp;ICastable&nbsp;feature&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;Why:&lt;/b&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ICastable&nbsp;is&nbsp;supported&nbsp;by&nbsp;CoreCLR&nbsp;and&nbsp;used&nbsp;by&nbsp;MCG&nbsp;(Microsoft&nbsp;interop&nbsp;codegen&nbsp;tooling&nbsp;for&nbsp;WinRT&nbsp;API&#39;s)&nbsp;in&nbsp;order&nbsp;to&nbsp;call&nbsp;WinRT&nbsp;API&#39;s&nbsp;from&nbsp;managed&nbsp;code&nbsp;on&nbsp;Windows&nbsp;platforms.&nbsp;MCG&nbsp;consumes&nbsp;winmd&nbsp;files&nbsp;+&nbsp;a&nbsp;closure&nbsp;of&nbsp;WinRT&nbsp;API&nbsp;used&nbsp;by&nbsp;an&nbsp;application<br>
&nbsp;generating&nbsp;managed&nbsp;interop&nbsp;code.&nbsp;Supporting&nbsp;ICastable&nbsp;is&nbsp;a&nbsp;prerequisite&nbsp;in&nbsp;order&nbsp;to&nbsp;support&nbsp;MCG&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;requirements&nbsp;on&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;is&nbsp;described&nbsp;in&nbsp;the&nbsp;interface:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F68f72dd2587c3365a9fe74d1991f93612c3bc62a%2Fsrc%2Fmscorlib%2Fsrc%2FSystem%2FRuntime%2FCompilerServices%2FICastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=t8tOm1Cvn9Klm4JwgxF%2BbeH%2Bqk%2B8sZbDOpIF2Q4t4Cc%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;68f72dd2587c3365a9fe74d1991f93&lt;wbr&gt;612c3bc62a/src/mscorlib/src/&lt;wbr&gt;System/Runtime/&lt;wbr&gt;CompilerServices/ICastable.cs&lt;/a&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;There&nbsp;is&nbsp;also&nbsp;a&nbsp;test&nbsp;case&nbsp;that&nbsp;will&nbsp;be&nbsp;used&nbsp;to&nbsp;validate&nbsp;Mono&#39;s&nbsp;implementation&nbsp;of&nbsp;ICastable:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F84aab5f59d023849b9ccdc290e698e4a61ac75a2%2Ftests%2Fsrc%2FInterop%2FICastable%2FCastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=srFnEjYYl0MlveNf0dOKlydPiuXnb8Yy44XwVncoNWM%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;84aab5f59d023849b9ccdc290e698e&lt;wbr&gt;4a61ac75a2/tests/src/Interop/&lt;wbr&gt;ICastable/Castable.cs&lt;/a&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;+&nbsp;additional&nbsp;Mono&nbsp;extensions&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to&nbsp;run&nbsp;a&nbsp;couple&nbsp;of&nbsp;MCG-&gt;WinRT&nbsp;samples&nbsp;testing&nbsp;MCG&#39;s&nbsp;usage&nbsp;of&nbsp;Mono&#39;s&nbsp;ICastable&nbsp;implementation.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;All&nbsp;should&nbsp;work&nbsp;on&nbsp;Windows&nbsp;x64&nbsp;JIT&nbsp;+&nbsp;full&nbsp;AOT.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;b&gt;How:&lt;/b&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;ICastable&nbsp;is&nbsp;a&nbsp;specific&nbsp;feature&nbsp;with&nbsp;several&nbsp;restrictions&nbsp;and&nbsp;constraints.&nbsp;The&nbsp;purpose&nbsp;is&nbsp;to&nbsp;dynamically,&nbsp;at&nbsp;runtime,&nbsp;add&nbsp;interfaces&nbsp;and&nbsp;implementation&nbsp;to&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;not&nbsp;part&nbsp;of&nbsp;the&nbsp;types&nbsp;original&nbsp;metadata.&nbsp;The&nbsp;added&nbsp;interfaces&nbsp;are<br>
&nbsp;then&nbsp;implemented&nbsp;by&nbsp;a&nbsp;complete&nbsp;different&nbsp;unrelated&nbsp;type&nbsp;returned&nbsp;by&nbsp;implementation&nbsp;of&nbsp;ICastable&nbsp;interface.&nbsp;That&nbsp;put&nbsp;some&nbsp;specific&nbsp;requirements&nbsp;on&nbsp;both&nbsp;the&nbsp;runtime&nbsp;but&nbsp;also&nbsp;on&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;class&nbsp;implementing&nbsp;the&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;its&nbsp;dispatch<br>
&nbsp;targets.&nbsp;Due&nbsp;to&nbsp;this,&nbsp;the&nbsp;feature&nbsp;should&nbsp;be&nbsp;considered&nbsp;&quot;Private&quot;&nbsp;limiting&nbsp;it&#39;s&nbsp;use&nbsp;and&nbsp;support&nbsp;to&nbsp;specific&nbsp;use&nbsp;cases.&nbsp;The&nbsp;main&nbsp;initial&nbsp;target&nbsp;is&nbsp;MCG&nbsp;stubs&nbsp;and&nbsp;interopability&nbsp;with&nbsp;WinRT&nbsp;API&#39;s&nbsp;on&nbsp;Windows&nbsp;platforms.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;Runtime:&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Looking&nbsp;into&nbsp;the&nbsp;current&nbsp;Mono&nbsp;source&nbsp;there&nbsp;is&nbsp;currently&nbsp;a&nbsp;feature&nbsp;that&nbsp;has&nbsp;similar&nbsp;characteristics&nbsp;and&nbsp;behavior&nbsp;as&nbsp;ICastable,&nbsp;transparent&nbsp;proxy&nbsp;support&nbsp;used&nbsp;by&nbsp;remoting.&nbsp;The&nbsp;plan&nbsp;is&nbsp;to&nbsp;use&nbsp;that&nbsp;as&nbsp;inspiration&nbsp;but&nbsp;not&nbsp;depending&nbsp;on&nbsp;current<br>
&nbsp;implementation&nbsp;(should&nbsp;not&nbsp;need&nbsp;to&nbsp;include&nbsp;remoting&nbsp;support&nbsp;to&nbsp;work).&nbsp;The&nbsp;underlying&nbsp;mechanism&nbsp;is&nbsp;still&nbsp;similar,&nbsp;dynamically&nbsp;extend&nbsp;an&nbsp;objects&nbsp;vtable&nbsp;if&nbsp;an&nbsp;objects&nbsp;gets&nbsp;casted&nbsp;to&nbsp;an&nbsp;interface&nbsp;indirectly&nbsp;supported&nbsp;by&nbsp;the&nbsp;underlying&nbsp;implementation&nbsp;of&nbsp;ICastable<br>
&nbsp;(or&nbsp;IRemotingTypeInfo.CanCastTo&nbsp;in&nbsp;remoting&nbsp;use&nbsp;case).&nbsp;The&nbsp;idea&nbsp;is&nbsp;to&nbsp;generalize&nbsp;and&nbsp;share&nbsp;the&nbsp;code&nbsp;already&nbsp;doing&nbsp;this&nbsp;logic&nbsp;in&nbsp;remoting&nbsp;making&nbsp;sure&nbsp;we&nbsp;only&nbsp;include&nbsp;one&nbsp;implementation&nbsp;of&nbsp;key&nbsp;features&nbsp;like&nbsp;rebuilding&nbsp;the&nbsp;vtable&nbsp;(currently&nbsp;done&nbsp;in mono_class_proxy_vtable).<br>
&nbsp;ICastable&nbsp;implementation&nbsp;will&nbsp;also&nbsp;include&nbsp;a&nbsp;cache&nbsp;similar&nbsp;to&nbsp;the&nbsp;one&nbsp;used&nbsp;in&nbsp;the&nbsp;remoting&nbsp;use&nbsp;case&nbsp;(see&nbsp;mono_upgrade_remote_class&nbsp;for&nbsp;details).&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;All&nbsp;code&nbsp;related&nbsp;to&nbsp;the&nbsp;ICastable&nbsp;feature&nbsp;will&nbsp;be&nbsp;guarded&nbsp;by&nbsp;a&nbsp;defined,&nbsp;FEATURE_ICASTABLE,&nbsp;so&nbsp;all&nbsp;platforms&nbsp;not&nbsp;needing&nbsp;this&nbsp;support&nbsp;(currently&nbsp;only&nbsp;needed&nbsp;on&nbsp;WinRT&nbsp;platforms),&nbsp;won&#39;t&nbsp;be&nbsp;affected&nbsp;by&nbsp;this&nbsp;change.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Extending&nbsp;Mono&nbsp;BCL:&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;The&nbsp;ICastable&nbsp;implementation&nbsp;+&nbsp;helper&nbsp;class&nbsp;can&nbsp;be&nbsp;included&nbsp;from&nbsp;CoreCLR&nbsp;into&nbsp;Mono&#39;s&nbsp;mscorlib&nbsp;with&nbsp;a&nbsp;small&nbsp;adjustment&nbsp;to&nbsp;the&nbsp;helper&nbsp;class:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;a&nbsp;href=&quot;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fcoreclr%2Fblob%2F68f72dd2587c3365a9fe74d1991f93612c3bc62a%2Fsrc%2Fmscorlib%2Fsrc%2FSystem%2FRuntime%2FCompilerServices%2FICastable.cs&amp;data=02%7C01%7Crokumper%40microsoft.com%7Cd254047ed900449f843e08d49c40321e%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636305246941657781&amp;sdata=t8tOm1Cvn9Klm4JwgxF%2BbeH%2Bqk%2B8sZbDOpIF2Q4t4Cc%3D&amp;reserved=0&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/dotnet/&lt;wbr&gt;coreclr/blob/&lt;wbr&gt;68f72dd2587c3365a9fe74d1991f93&lt;wbr&gt;612c3bc62a/src/mscorlib/src/&lt;wbr&gt;System/Runtime/&lt;wbr&gt;CompilerServices/ICastable.cs&lt;/a&gt;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Part&nbsp;of&nbsp;supporting&nbsp;ICastable&nbsp;includes&nbsp;adding&nbsp;the&nbsp;above&nbsp;assembly&nbsp;and&nbsp;classes&nbsp;to&nbsp;Mono&#39;s&nbsp;BCL.&nbsp;It&nbsp;should&nbsp;build&nbsp;under&nbsp;net_4_x&nbsp;and&nbsp;winAOT&nbsp;profiles.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Examples&nbsp;of&nbsp;things&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;done&nbsp;to&nbsp;support&nbsp;ICastable:&lt;/u&gt;<br>
&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;ul&nbsp;type=&quot;disc&quot;&gt;<br>
&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Extend&nbsp;MonoVTable&nbsp;with&nbsp;a&nbsp;field&nbsp;indicating&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;(optimization&nbsp;for&nbsp;fast&nbsp;lookups&nbsp;and&nbsp;checks).&nbsp;Since&nbsp;this&nbsp;field&nbsp;is&nbsp;checked&nbsp;both&nbsp;by&nbsp;C&nbsp;code&nbsp;and&nbsp;generated&nbsp;code&nbsp;(handle_isinst,&nbsp;handle_castclass)&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;addressable.&nbsp;Field&nbsp;will&nbsp;also&nbsp;be&nbsp;used&nbsp;to<br>
&nbsp;include&nbsp;more&nbsp;meta&nbsp;information&nbsp;when&nbsp;an&nbsp;object&nbsp;implements&nbsp;ICastable&nbsp;and&nbsp;has&nbsp;been&nbsp;casted&nbsp;to&nbsp;different&nbsp;interfaces&nbsp;(needed&nbsp;by&nbsp;both&nbsp;caching&nbsp;and&nbsp;vtable&nbsp;rebuild).&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Extend&nbsp;mono_object_handle_isinst_&lt;wbr&gt;mbyref&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Extend&nbsp;handle_isinst&nbsp;and&nbsp;handle_castclass&nbsp;to&nbsp;have&nbsp;fallback&nbsp;for&nbsp;objects&nbsp;supporting&nbsp;ICastable.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Extend&nbsp;objects&nbsp;vtable&nbsp;with&nbsp;new&nbsp;interfaces&nbsp;implemented&nbsp;by&nbsp;a&nbsp;different&nbsp;type&nbsp;indicated&nbsp;by&nbsp;ICastable::&lt;wbr&gt;IsInstanceOfInterface.&nbsp;Similar&nbsp;to&nbsp;how&nbsp;mono_upgrade_remote_class&nbsp;works&nbsp;for&nbsp;remote&nbsp;objects.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Add&nbsp;support&nbsp;to&nbsp;mono_vcall_trampoline&nbsp;to&nbsp;resolve&nbsp;method&nbsp;implementation&nbsp;for&nbsp;ICastable&nbsp;objects&nbsp;when&nbsp;not&nbsp;directly&nbsp;implemented&nbsp;by&nbsp;type.&nbsp;Implementing&nbsp;type&nbsp;for&nbsp;method&nbsp;is&nbsp;returned&nbsp;by&nbsp;ICastable::GetImplType.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Cache&nbsp;dynamically&nbsp;generated&nbsp;vtables&nbsp;based&nbsp;on&nbsp;object&nbsp;class&nbsp;+&nbsp;additional&nbsp;supported&nbsp;interface(s).&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;li&nbsp;class=&quot;MsoNormal&quot;&nbsp;style=&quot;margin-left:0in&quot;&gt;<br>
Add&nbsp;support&nbsp;for&nbsp;CoreCLR&nbsp;ICastable&nbsp;interface&nbsp;and&nbsp;support&nbsp;class&nbsp;in&nbsp;Mono&#39;s&nbsp;mscorlib&nbsp;(net_4_x,&nbsp;winAOT&nbsp;profiles).&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/li&gt;&lt;/ul&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I&nbsp;have&nbsp;implemented&nbsp;a&nbsp;POC&nbsp;using&nbsp;the&nbsp;above&nbsp;approach&nbsp;and&nbsp;it&nbsp;solve&nbsp;the&nbsp;use&nbsp;case,&nbsp;getting&nbsp;pass&nbsp;on&nbsp;all&nbsp;tests&nbsp;in&nbsp;CoreCLR&nbsp;ICastable&nbsp;test&nbsp;suite&nbsp;and&nbsp;working&nbsp;with&nbsp;MCG&nbsp;stub&nbsp;samples,&nbsp;so&nbsp;above&nbsp;suggestion&nbsp;seems&nbsp;at&nbsp;least&nbsp;to&nbsp;be&nbsp;a&nbsp;way&nbsp;moving&nbsp;forward&nbsp;implementing<br>
&nbsp;support&nbsp;for&nbsp;ICastable&nbsp;on&nbsp;Mono&nbsp;Windows&nbsp;x64.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Comments,&nbsp;thoughts&nbsp;and&nbsp;ideas&nbsp;are&nbsp;much&nbsp;appreciated.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>
<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
