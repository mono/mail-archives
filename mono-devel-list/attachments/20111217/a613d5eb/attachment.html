<tt>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Dec&nbsp;15,&nbsp;2011&nbsp;at&nbsp;2:57&nbsp;PM,&nbsp;Robert&nbsp;Jordan&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:robertj@gmx.net&quot;&gt;robertj@gmx.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
Hi&nbsp;Andrey,&lt;br&gt;<br>
&lt;br&gt;<br>
Do&nbsp;you&nbsp;have&nbsp;a&nbsp;test&nbsp;case&nbsp;for&nbsp;these&nbsp;issues?&lt;br&gt;<br>
&lt;br&gt;<br>
Thanks&lt;br&gt;<br>
Robert&lt;br&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;pre&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
Hello&nbsp;Robert!<br>
<br>
Thank&nbsp;you&nbsp;for&nbsp;your&nbsp;quick&nbsp;reply.<br>
<br>
After&nbsp;an&nbsp;additional&nbsp;research&nbsp;I&amp;#39;ve&nbsp;decided&nbsp;to&nbsp;cancel&nbsp;patch#1.&nbsp;This&nbsp;issue&nbsp;(different&nbsp;behavior&nbsp;in&nbsp;.NET&nbsp;and&nbsp;Mono)&nbsp;takes&nbsp;place,&nbsp;but&nbsp;suggested&nbsp;patch&nbsp;is&nbsp;incorrect.&nbsp;<br>
I&nbsp;will&nbsp;try&nbsp;to&nbsp;find&nbsp;workaround&nbsp;in&nbsp;my&nbsp;application.<br>
<br>
Below&nbsp;is&nbsp;the&nbsp;test&nbsp;case&nbsp;for&nbsp;patch#2&nbsp;(patch.return-value.diff,&nbsp;link:&nbsp;&lt;a&nbsp;href=&quot;https://gist.github.com/1480249&quot;&gt;https://gist.github.com/1480249&lt;/a&gt;).<br>
<br>
Issue<br>
=====<br>
Mono&nbsp;doesn&amp;#39;t&nbsp;send&nbsp;the&nbsp;results&nbsp;of&nbsp;remote&nbsp;method&nbsp;execution&nbsp;to&nbsp;IDinamicMessageSink.ProcessMessageFinish().<br>
.NET&nbsp;Framework&nbsp;(2.0&nbsp;and&nbsp;4.0)&nbsp;sends&nbsp;to&nbsp;IDinamicMessageSink.ProcessMessageFinish()&nbsp;an&nbsp;instance&nbsp;of&nbsp;ReturnMessage&nbsp;class&nbsp;that&nbsp;implements&nbsp;IMethodReturnMessage&nbsp;interface.&nbsp;&nbsp;<br>
This&nbsp;interface&nbsp;contains&nbsp;all&nbsp;necessary&nbsp;information&nbsp;(return&nbsp;vlaue,&nbsp;exception,&nbsp;out&nbsp;args&nbsp;and&nbsp;modified&nbsp;call&nbsp;context).&nbsp;&nbsp;<br>
Mono&nbsp;sends&nbsp;an&nbsp;istance&nbsp;of&nbsp;MethodCall&nbsp;class,&nbsp;exactly&nbsp;the&nbsp;same&nbsp;as&nbsp;to&nbsp;IDinamicMessageSink.ProcessMessageStart().<br>
It&nbsp;seems&nbsp;to&nbsp;be&nbsp;a&nbsp;bug&nbsp;in&nbsp;Mono&nbsp;sources&nbsp;and&nbsp;I&nbsp;have&nbsp;suggested&nbsp;the&nbsp;patch.<br>
<br>
<br>
Test&nbsp;application<br>
================<br>
This&nbsp;test&nbsp;application&nbsp;illustrates&nbsp;an&nbsp;issue&nbsp;in&nbsp;Mono&nbsp;runtime.&nbsp;<br>
Server&nbsp;and&nbsp;client&nbsp;objects&nbsp;are&nbsp;created&nbsp;in&nbsp;a&nbsp;single&nbsp;application&nbsp;(for&nbsp;the&nbsp;simplification&nbsp;of&nbsp;an&nbsp;example).<br>
They&nbsp;interoperate&nbsp;through&nbsp;Remoting&nbsp;using&nbsp;IPC&nbsp;channel.<br>
Class&nbsp;MyDynamicMessageSink&nbsp;implements&nbsp;dynamic&nbsp;message&nbsp;sink&nbsp;to&nbsp;handle&nbsp;remoting&nbsp;method&nbsp;execution.&nbsp;<br>
<br>
<br>
Source&nbsp;code<br>
===========<br>
using&nbsp;System;<br>
using&nbsp;System.Runtime.Remoting;<br>
using&nbsp;System.Runtime.Remoting.Channels;<br>
using&nbsp;System.Runtime.Remoting.Channels.Ipc;<br>
using&nbsp;System.Runtime.Remoting.Messaging;<br>
using&nbsp;System.Runtime.Remoting.Contexts;<br>
<br>
namespace&nbsp;Patch2_Test<br>
{<br>
&nbsp;&nbsp;class&nbsp;Program<br>
&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;void&nbsp;Main(string[]&nbsp;args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Initialize&nbsp;server&nbsp;side&nbsp;remoting&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ChannelServices.RegisterChannel(new&nbsp;IpcChannel(&amp;quot;ipc_test&amp;quot;),&nbsp;false);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RemotingConfiguration.RegisterWellKnownServiceType(typeof(TestServer),&nbsp;&amp;quot;TestService&amp;quot;,&nbsp;WellKnownObjectMode.Singleton);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Context.RegisterDynamicProperty(new&nbsp;MyDynamicSinkProvider(),&nbsp;null,&nbsp;Context.DefaultContext);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;proxy&nbsp;to&nbsp;remote&nbsp;server<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TestServer&nbsp;server&nbsp;=&nbsp;(TestServer)Activator.GetObject(typeof(TestServer),&nbsp;&amp;quot;ipc://ipc_test/TestService&amp;quot;);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Execute&nbsp;remote&nbsp;method&nbsp;without&nbsp;exception<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server.TestMethod(false);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Execute&nbsp;remote&nbsp;method&nbsp;raising&nbsp;exception<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{&nbsp;server.TestMethod(true);&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch&nbsp;{&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Server&nbsp;class<br>
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;TestServer&nbsp;:&nbsp;MarshalByRefObject<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;string&nbsp;TestMethod(bool&nbsp;throwException)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(throwException)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw&nbsp;new&nbsp;Exception(&amp;quot;TestException&amp;quot;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;&amp;quot;Hello&amp;quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Dynamic&nbsp;message&nbsp;sink&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;class&nbsp;MyDynamicMessageSink&nbsp;:&nbsp;IDynamicMessageSink<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;ProcessMessageStart(IMessage&nbsp;reqMsg,&nbsp;bool&nbsp;bCliSide,&nbsp;bool&nbsp;bAsync)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;ProcessMessageFinish(IMessage&nbsp;replyMsg,&nbsp;bool&nbsp;bCliSide,&nbsp;bool&nbsp;bAsync)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Don&amp;#39;t&nbsp;handle&nbsp;messages&nbsp;on&nbsp;client&nbsp;side<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(bCliSide)&nbsp;return;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;***&nbsp;Executing&nbsp;IDynamicMessageSink.ProcessMessageFinish()&amp;quot;);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Check&nbsp;replyMsg&nbsp;type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;replyMsg&nbsp;is&nbsp;instance&nbsp;of&nbsp;&amp;quot;&nbsp;+&nbsp;(replyMsg&nbsp;as&nbsp;object).GetType().Name);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Get&nbsp;return&nbsp;value&nbsp;and&nbsp;exception&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMethodReturnMessage&nbsp;returnMessage&nbsp;=&nbsp;replyMsg&nbsp;as&nbsp;IMethodReturnMessage;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(returnMessage&nbsp;!=&nbsp;null)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;ReturnValue:&nbsp;&amp;quot;&nbsp;+&nbsp;(returnMessage.ReturnValue&nbsp;!=&nbsp;null&nbsp;?&nbsp;returnMessage.ReturnValue.ToString()&nbsp;:&nbsp;&amp;quot;NULL&amp;quot;));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exception&nbsp;e&nbsp;=&nbsp;returnMessage.Exception;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;Exception:&nbsp;&amp;quot;&nbsp;+&nbsp;(returnMessage.Exception&nbsp;!=&nbsp;null&nbsp;?&nbsp;returnMessage.Exception.Message&nbsp;:&nbsp;&amp;quot;NULL&amp;quot;));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;replyMsg&nbsp;doesn&amp;#39;t&nbsp;support&nbsp;IMethodReturnMessage&amp;quot;);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Try&nbsp;to&nbsp;get&nbsp;return&nbsp;value&nbsp;from&nbsp;replyMsg&nbsp;properties<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine(&amp;quot;replyMsg.Properties[\&amp;quot;__Return\&amp;quot;]:&nbsp;&amp;quot;&nbsp;+&nbsp;(replyMsg.Properties[&amp;quot;__Return&amp;quot;]&nbsp;!=&nbsp;null&nbsp;?&nbsp;replyMsg.Properties[&amp;quot;__Return&amp;quot;].ToString()&nbsp;:&nbsp;&amp;quot;&amp;lt;none&amp;gt;&amp;quot;));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Dynamic&nbsp;message&nbsp;sink&nbsp;provider<br>
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;class&nbsp;MyDynamicSinkProvider&nbsp;:&nbsp;IDynamicProperty,&nbsp;IContributeDynamicSink<br>
&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IDynamicMessageSink&nbsp;IContributeDynamicSink.GetDynamicSink()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;return&nbsp;new&nbsp;MyDynamicMessageSink();&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;IDynamicProperty.Name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;get&nbsp;{&nbsp;return&nbsp;&amp;quot;MyDynamicSinkProvider&amp;quot;;&nbsp;}&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;}<br>
}<br>
<br>
<br>
Program&nbsp;output&nbsp;in&nbsp;.NET&nbsp;Framework&nbsp;4.0<br>
=============================================<br>
***&nbsp;Executing&nbsp;IDynamicMessageSink.ProcessMessageFinish()<br>
replyMsg&nbsp;is&nbsp;instance&nbsp;of&nbsp;ReturnMessage<br>
ReturnValue:&nbsp;Hello<br>
Exception:&nbsp;NULL<br>
replyMsg.Properties[&amp;quot;__Return&amp;quot;]:&nbsp;Hello<br>
<br>
***&nbsp;Executing&nbsp;IDynamicMessageSink.ProcessMessageFinish()<br>
replyMsg&nbsp;is&nbsp;instance&nbsp;of&nbsp;ReturnMessage<br>
ReturnValue:&nbsp;NULL<br>
Exception:&nbsp;TestException<br>
replyMsg.Properties[&amp;quot;__Return&amp;quot;]:&nbsp;&amp;lt;none&amp;gt;<br>
<br>
&nbsp;<br>
Program&nbsp;output&nbsp;in&nbsp;Mono&nbsp;2.10.6<br>
=============================================<br>
***&nbsp;Executing&nbsp;IDynamicMessageSink.ProcessMessageFinish()<br>
replyMsg&nbsp;is&nbsp;instance&nbsp;of&nbsp;MethodCall<br>
replyMsg&nbsp;doesn&amp;#39;t&nbsp;support&nbsp;IMethodReturnMessage<br>
replyMsg.Properties[&amp;quot;__Return&amp;quot;]:&nbsp;&amp;lt;none&amp;gt;<br>
<br>
***&nbsp;Executing&nbsp;IDynamicMessageSink.ProcessMessageFinish()<br>
replyMsg&nbsp;is&nbsp;instance&nbsp;of&nbsp;MethodCall<br>
replyMsg&nbsp;doesn&amp;#39;t&nbsp;support&nbsp;IMethodReturnMessage<br>
replyMsg.Properties[&amp;quot;__Return&amp;quot;]:&nbsp;&amp;lt;none&amp;gt;<br>
<br>
<br>
Program&nbsp;output&nbsp;under&nbsp;Mono&nbsp;2.10.6&nbsp;with&nbsp;patch<br>
==============================================<br>
The&nbsp;same&nbsp;as&nbsp;in&nbsp;.NET&nbsp;Framework&nbsp;4.0<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp<br>
<br>
&lt;br&gt;--&nbsp;&lt;br&gt;Andrey&nbsp;Chernomyrdin&lt;br&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
