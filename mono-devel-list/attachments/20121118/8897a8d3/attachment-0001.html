<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hi&nbsp;everyone.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;there&#39;s&nbsp;a&nbsp;small&nbsp;problem&nbsp;with&nbsp;the&nbsp;way&nbsp;the&nbsp;runtime&nbsp;shuts&nbsp;down&nbsp;at&nbsp;the&nbsp;moment:&nbsp;the&nbsp;thread&nbsp;pool&nbsp;(and&nbsp;apparently&nbsp;other&nbsp;resources)&nbsp;are&nbsp;shut&nbsp;down&nbsp;before&nbsp;the&nbsp;ProcessExit&nbsp;signal&nbsp;is&nbsp;fired.&nbsp;This&nbsp;is&nbsp;the&nbsp;cause&nbsp;for&nbsp;the&nbsp;NLog&nbsp;bug&nbsp;described&nbsp;here[1],&nbsp;since&nbsp;NLog&nbsp;relies&nbsp;on&nbsp;the&nbsp;threadpool&nbsp;being&nbsp;available&nbsp;in&nbsp;ProcessExit&nbsp;(works&nbsp;on&nbsp;Microsoft&nbsp;but&nbsp;not&nbsp;mono). To&nbsp;my&nbsp;mind&nbsp;this&nbsp;is&nbsp;a&nbsp;bug,&nbsp;although&nbsp;oddly&nbsp;enough&nbsp;there&#39;s&nbsp;a&nbsp;runtime test[2]&nbsp;that&nbsp;appears&nbsp;to&nbsp;imply&nbsp;that&nbsp;it&nbsp;may&nbsp;be&nbsp;normal?&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;submitted&nbsp;this&nbsp;pull&nbsp;request[3]&nbsp;on&nbsp;github&nbsp;which&nbsp;has&nbsp;a&nbsp;test[4]&nbsp;that&nbsp;reproduces&nbsp;the&nbsp;problem,&nbsp;and&nbsp;a&nbsp;proposed&nbsp;patch&nbsp;which&nbsp;is&nbsp;probably&nbsp;insufficient&nbsp;since&nbsp;my&nbsp;first&nbsp;time&nbsp;in&nbsp;the&nbsp;runtime.&nbsp;The&nbsp;general&nbsp;idea&nbsp;is&nbsp;this:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;*&nbsp;mono_runtime_shutdown(),&nbsp;which&nbsp;runs&nbsp;the&nbsp;ProcessExit&nbsp;event&nbsp;code&nbsp;is&nbsp;executed&nbsp;from&nbsp;mini_cleanup(),&nbsp;which&nbsp;is&nbsp;a&nbsp;pretty&nbsp;late&nbsp;step&nbsp;(after&nbsp;we&nbsp;shutdown&nbsp;the&nbsp;pool&nbsp;and&nbsp;other&nbsp;resources&nbsp;in&nbsp;thread_manage()).&lt;/div&gt;&lt;div&gt;<br>
*&nbsp;The&nbsp;same&nbsp;thing&nbsp;happens&nbsp;in&nbsp;System_Environment_Exit(),&nbsp;which&nbsp;again&nbsp;shuts&nbsp;down&nbsp;the&nbsp;thread&nbsp;pool&nbsp;before&nbsp;calling&nbsp;mono_runtime_quit()&nbsp;(which&nbsp;eventually&nbsp;triggers&nbsp;the&nbsp;mono_runtime_shutdown()).&lt;/div&gt;&lt;div&gt;*&nbsp;My&nbsp;working&nbsp;patch&nbsp;moves mono_runtime_shutdown()&nbsp;and&nbsp;mono_domain_finalizers()&nbsp;out&nbsp;of&nbsp;mini_cleanup()&nbsp;and&nbsp;into&nbsp;thread_manage()&nbsp;and&nbsp;System_Environment_Exit(),&nbsp;right&nbsp;before&nbsp;we&nbsp;shut&nbsp;down&nbsp;the&nbsp;thread&nbsp;pool&nbsp;and&nbsp;other&nbsp;stuff.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Somebody&nbsp;who&nbsp;actually&nbsp;understands&nbsp;everything&nbsp;in&nbsp;there&nbsp;should&nbsp;take&nbsp;a&nbsp;look&nbsp;at&nbsp;this...&nbsp;For&nbsp;one&nbsp;thing,&nbsp;the&nbsp;according&nbsp;to&nbsp;the&nbsp;comment&nbsp;in&nbsp;mini.c,&nbsp;mono_domain_finalize()&nbsp;also&nbsp;seems&nbsp;like&nbsp;it&nbsp;should&nbsp;be&nbsp;called&nbsp;earlier,&nbsp;but&nbsp;going&nbsp;so&nbsp;(next&nbsp;to&nbsp;mono_runtime_shutdown)&nbsp;triggered&nbsp;a&nbsp;segmentation&nbsp;fault&nbsp;for&nbsp;me.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also,&nbsp;my&nbsp;patch&nbsp;duplicates&nbsp;code the&nbsp;two&nbsp;function&nbsp;calls,&nbsp;although&nbsp;other&nbsp;calls&nbsp;are&nbsp;already&nbsp;duplicated.&nbsp;It&nbsp;seems&nbsp;that&nbsp;a&nbsp;small&nbsp;cleanup/refactor&nbsp;could&nbsp;help&nbsp;eliminate&nbsp;this&nbsp;duplication,&nbsp;both&nbsp;across&nbsp;thread_manage()&nbsp;and&nbsp;System_Environment_Exit()&nbsp;and&nbsp;across&nbsp;mini&nbsp;and&nbsp;the&nbsp;interpreter&nbsp;(which&nbsp;doesn&#39;t&nbsp;trigger&nbsp;the&nbsp;ProcessExit&nbsp;event?)&nbsp;I&#39;d&nbsp;be&nbsp;glad&nbsp;to&nbsp;go&nbsp;deeper&nbsp;into&nbsp;this&nbsp;if&nbsp;people&nbsp;think&nbsp;it&#39;s&nbsp;good/necessary.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Shay&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[1] &lt;a&nbsp;href=&quot;http://nlog-project.org/2011/10/30/using-nlog-with-mono.html&quot;&gt;http://nlog-project.org/2011/10/30/using-nlog-with-mono.html&lt;/a&gt;&lt;/div&gt;&lt;div&gt;[2] &lt;a&nbsp;href=&quot;https://github.com/mono/mono/blob/master/mono/tests/bug-438454.cs&quot;&gt;https://github.com/mono/mono/blob/master/mono/tests/bug-438454.cs&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt;[3] &lt;a&nbsp;href=&quot;https://github.com/mono/mono/pull/505&quot;&gt;https://github.com/mono/mono/pull/505&lt;/a&gt;&lt;/div&gt;&lt;div&gt;[4] &lt;a&nbsp;href=&quot;https://github.com/roji/mono/commit/a2e54923bbd578e3fc8bdd95188b017648120de7&quot;&gt;https://github.com/roji/mono/commit/a2e54923bbd578e3fc8bdd95188b017648120de7&lt;/a&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
