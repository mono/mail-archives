<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&nbsp;font-size:&nbsp;14px;&nbsp;font-family:&nbsp;Calibri,&nbsp;sans-serif;&quot;&gt;<br>
&lt;div&gt;We&nbsp;have&nbsp;some&nbsp;code&nbsp;which&nbsp;works&nbsp;on&nbsp;Microsoft&#8217;s&nbsp;runtime&nbsp;and&nbsp;used&nbsp;to&nbsp;work&nbsp;on&nbsp;Mono&nbsp;3.12,&nbsp;but&nbsp;now&nbsp;fails&nbsp;on&nbsp;Mono&nbsp;4.2.&nbsp;Simplified&nbsp;code&nbsp;to&nbsp;reproduce&nbsp;the&nbsp;issue&nbsp;is&nbsp;as&nbsp;follows:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;public&nbsp;class&nbsp;WorkStateThread&lt;/div&gt;<br>
&lt;div&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;public&nbsp;void&nbsp;Start()&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;m_thread&nbsp;=&nbsp;new&nbsp;Thread(ThreadProc);&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;m_thread.Start(Thread.CurrentThread);&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;m_thread.Join();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;}&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;private&nbsp;void&nbsp;ThreadProc&nbsp;(object&nbsp;objData)&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;if&nbsp;(m_thread&nbsp;!=&nbsp;Thread.CurrentThread)&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;throw&nbsp;new&nbsp;InvalidOperationException&nbsp;(&quot;m_thread&nbsp;!=&nbsp;Thread.CurrentThread&quot;);&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;}&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;Thread&nbsp;m_thread;&lt;/div&gt;<br>
&lt;div&gt;}&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;class&nbsp;MainClass&lt;/div&gt;<br>
&lt;div&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;public&nbsp;static&nbsp;void&nbsp;Main&nbsp;(string[]&nbsp;args)&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;WorkStateThread&nbsp;ws&nbsp;=&nbsp;new&nbsp;WorkStateThread&nbsp;();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;ws.Start&nbsp;();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;Console.WriteLine&nbsp;(&quot;Done&quot;);&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;}&lt;/div&gt;<br>
&lt;div&gt;}&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;<br>
&lt;div&gt;[TestFixture]&lt;/div&gt;<br>
&lt;div&gt;public&nbsp;class&nbsp;Test&lt;/div&gt;<br>
&lt;div&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;[Test]&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;public&nbsp;void&nbsp;TestCase&nbsp;()&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;{&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;WorkStateThread&nbsp;ws&nbsp;=&nbsp;new&nbsp;WorkStateThread&nbsp;();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;ws.Start&nbsp;();&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;/span&gt;}&lt;/div&gt;<br>
&lt;div&gt;}&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;This&nbsp;code&nbsp;runs&nbsp;as&nbsp;expected&nbsp;when&nbsp;run&nbsp;from&nbsp;the&nbsp;command&nbsp;line,&nbsp;but&nbsp;if&nbsp;run&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;unit&nbsp;test&nbsp;using&nbsp;NUnit,&nbsp;the&nbsp;InvalidOperationException&nbsp;is&nbsp;thrown.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&#8212;&nbsp;Martin&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
