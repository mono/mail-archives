[From nobody Fri Sep 26 11:18:53 2008
X-Spam-Checker-Version: SpamAssassin 3.1.9 (2007-02-13) on mercury.hotfeet.ch
X-Spam-Level: 
X-Spam-Status: No, score=-102.5 required=5.0 tests=AWL,BAYES_00,
	USER_IN_WHITELIST autolearn=ham version=3.1.9
Delivered-To: js@hotfeet.ch
Received: by mercury.hotfeet.ch (Postfix, from userid 8) id B561A4F3CCC;
	Mon,  8 Sep 2008 21:31:24 +0200 (CEST)
X-Original-To: js@hotfeet.ch
Received: from lists.ximian.com (galactus.ximian.com [130.57.169.22]) by
	mercury.hotfeet.ch (Postfix) with ESMTP id 54B514F3CBA for
	&lt;js@hotfeet.ch&gt;; Mon,  8 Sep 2008 21:31:24 +0200 (CEST)
Received: from galactus.ximian.com (localhost.localdomain [127.0.0.1]) by
	lists.ximian.com (Postfix) with ESMTP id D3DFA1CFBFD; Mon,  8 Sep 2008
	15:28:37 -0400 (EDT)
X-Original-To: mono-devel-list@lists.ximian.com
Delivered-To: mono-devel-list@lists.ximian.com
Received: from herald.ximian.com (frontgate.ximian.com [130.57.169.19]) by
	lists.ximian.com (Postfix) with ESMTP id 8D2A01CFB2B for
	&lt;mono-devel-list@lists.ximian.com&gt;;
	Mon,  8 Sep 2008 15:28:29 -0400 (EDT)
Received: by herald.ximian.com (Postfix, from userid 2601) id 782BE70081;
	Mon,  8 Sep 2008 15:28:29 -0400 (EDT)
Received: from mercury.hotfeet.ch (mercury.hotfeet.ch [78.47.152.99]) by
	herald.ximian.com (Postfix) with ESMTP id A666D7001D for
	&lt;mono-devel-list@lists.ximian.com&gt;;
	Mon,  8 Sep 2008 15:28:27 -0400 (EDT)
Received: by mercury.hotfeet.ch (Postfix, from userid 8) id C94264F3CBA;
	Mon,  8 Sep 2008 21:31:00 +0200 (CEST)
X-Original-To: mono-devel-list@lists.ximian.com
Received: from [10.0.1.16] (phoenix.hotfeet.ch [212.55.211.203]) by
	mercury.hotfeet.ch (Postfix) with ESMTP id 862D94F3CBA; Mon,  8 Sep 2008
	21:31:00 +0200 (CEST)
From: Juraj Skripsky &lt;js@hotfeet.ch&gt;
To: mono-devel-list@lists.ximian.com
Content-Type: multipart/mixed; boundary=&quot;=-bwGvT0YqLFFBOOtMWI1w&quot;
Organization: HotFeet GmbH
Date: Mon, 08 Sep 2008 21:28:21 +0200
Message-Id: &lt;1220902101.2992.6.camel@funnyfarm.hotfeet.ch&gt;
Mime-Version: 1.0
X-Mailer: Evolution 2.22.3.1 (2.22.3.1-1.fc9) 
Cc: Andreas Nahr &lt;ClassDevelopment@A-SoftTech.com&gt;
Subject: [Mono-dev] [Patch] Simple optimization to String.Replace
	and	StringBuilder.Replace
X-BeenThere: mono-devel-list@lists.ximian.com
X-Mailman-Version: 2.1.8
Precedence: list
List-Id: Mono Development &lt;mono-devel-list.lists.ximian.com&gt;
List-Unsubscribe: &lt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&gt;, 
	&lt;mailto:mono-devel-list-request@lists.ximian.com?subject=unsubscribe&gt;
List-Archive: &lt;http://lists.ximian.com/pipermail/mono-devel-list&gt;
List-Post: &lt;mailto:mono-devel-list@lists.ximian.com&gt;
List-Help: &lt;mailto:mono-devel-list-request@lists.ximian.com?subject=help&gt;
List-Subscribe: &lt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&gt;,
	&lt;mailto:mono-devel-list-request@lists.ximian.com?subject=subscribe&gt;
Sender: mono-devel-list-bounces@lists.ximian.com
Errors-To: mono-devel-list-bounces@lists.ximian.com


--=-bwGvT0YqLFFBOOtMWI1w
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Hello,

Attached you'll find a patch which reduces the number of allocations
done in String.Replace and StringBuilder.Replace.

All unit tests pass, ChangeLog entries are included.
Please review.

- Juraj


PS: I've already posted this patch back in June, but this time I've
leaving out the controversial part.
http://lists.ximian.com/pipermail/mono-devel-list/2008-June/028239.html

--=-bwGvT0YqLFFBOOtMWI1w
Content-Disposition: attachment; filename=StringReplace.patch
Content-Type: text/x-patch; name=StringReplace.patch; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Index: corlib/System/ChangeLog
===================================================================
--- corlib/System/ChangeLog	(revision 112532)
+++ corlib/System/ChangeLog	(working copy)
@@ -1,3 +1,8 @@
+2008-09-08  Juraj Skripsky  &lt;js@hotfeet.ch&gt;
+
+	* String.cs (ReplaceUnchecked): Avoid any unnecessary work and 
+	string allocations by returning early when no oldValue was found.
+
 2008-09-07  Miguel de Icaza  &lt;miguel@novell.com&gt;
 
 	* TermInfoDriver.cs: Add support for updating the size of the
Index: corlib/System/String.cs
===================================================================
--- corlib/System/String.cs	(revision 112532)
+++ corlib/System/String.cs	(working copy)
@@ -1689,6 +1689,8 @@
 					}
 					i = found + oldValue.length;
 				}
+				if (count == 0)
+					return this;
 				int nlen = this.length + ((newValue.length - oldValue.length) * count);
 				String tmp = InternalAllocateStr (nlen);
 
Index: corlib/System.Text/StringBuilder.cs
===================================================================
--- corlib/System.Text/StringBuilder.cs	(revision 112532)
+++ corlib/System.Text/StringBuilder.cs	(working copy)
@@ -309,15 +309,22 @@
 			if (oldValue.Length == 0)
 				throw new ArgumentException (&quot;The old value cannot be zero length.&quot;);
 
-			// TODO: OPTIMIZE!
-			string replace = _str.Substring(startIndex, count).Replace(oldValue, newValue);
+			string substr = _str.Substring(startIndex, count);
+			string replace = substr.Replace(oldValue, newValue);
+			// return early if no oldValue was found
+			if ((object) replace == (object) substr)
+				return this;
 
 			InternalEnsureCapacity (replace.Length + (_length - count));
 
-			string end = _str.Substring (startIndex + count, _length - startIndex - count );
+			// shift end part
+			if (replace.Length &lt; count)
+				String.CharCopy (_str, startIndex + replace.Length, _str, startIndex + count, _length - startIndex  - count);
+			else if (replace.Length &gt; count)
+				String.CharCopyReverse (_str, startIndex + replace.Length, _str, startIndex + count, _length - startIndex  - count);
 
+			// copy middle part back into _str
 			String.CharCopy (_str, startIndex, replace, 0, replace.Length);
-			String.CharCopy (_str, startIndex + replace.Length, end, 0, end.Length);
 			
 			_length = replace.Length + (_length - count);
 
Index: corlib/System.Text/ChangeLog
===================================================================
--- corlib/System.Text/ChangeLog	(revision 112532)
+++ corlib/System.Text/ChangeLog	(working copy)
@@ -1,3 +1,8 @@
+2008-09-08  Juraj Skripsky  &lt;js@hotfeet.ch&gt;
+
+	* StringBuilder.cs (Replace): Return early when no oldValue was 
+	found. Avoid extra string allocations.   
+
 2008-07-03  Andreas Nahr  &lt;ClassDevelopment@A-SoftTech.com&gt;
 
 	* UTF8Encoding.cs: Fix parameter names, Remove unfounded TODO

--=-bwGvT0YqLFFBOOtMWI1w
Content-Type: text/plain; charset=&quot;us-ascii&quot;
MIME-Version: 1.0
Content-Disposition: inline
Content-Transfer-Encoding: 7bit

_______________________________________________
Mono-devel-list mailing list
Mono-devel-list@lists.ximian.com
http://lists.ximian.com/mailman/listinfo/mono-devel-list

--=-bwGvT0YqLFFBOOtMWI1w--
]