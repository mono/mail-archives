<tt>
&lt;HTML&nbsp;dir=rtl&gt;&lt;HEAD&gt;&lt;TITLE&gt;Re:&nbsp;[Mono-dev]&nbsp;Cecil&nbsp;improvement&lt;/TITLE&gt;<br>
&lt;META&nbsp;http-equiv=Content-Type&nbsp;content=&quot;text/html;&nbsp;charset=unicode&quot;&gt;<br>
&lt;META&nbsp;content=&quot;MSHTML&nbsp;6.00.2900.3157&quot;&nbsp;name=GENERATOR&gt;&lt;/HEAD&gt;<br>
&lt;BODY&nbsp;dir=ltr&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;color=#000000&nbsp;size=2&gt;&amp;gt;&nbsp;And&nbsp;how&nbsp;do&nbsp;you&nbsp;plan&nbsp;to&nbsp;represent&nbsp;those&nbsp;relations?&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;We&nbsp;need&nbsp;to&nbsp;represent&nbsp;two&nbsp;types&nbsp;of&nbsp;relations:.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;OL&nbsp;dir=ltr&gt;<br>
&lt;LI&gt;<br>
&lt;DIV&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;one&nbsp;to&nbsp;one&nbsp;(like&nbsp;Fields&nbsp;-&amp;gt;&nbsp;FieldLayout)-&nbsp;can&nbsp;be&nbsp;implemented&nbsp;as&nbsp;an&nbsp;unsinged&nbsp;int&nbsp;array,&nbsp;where&nbsp;for&nbsp;each&nbsp;element&nbsp;the&nbsp;index&nbsp;represents&nbsp;the&amp;nbsp;&amp;nbsp;&nbsp;RID&nbsp;of&nbsp;the&nbsp;source&nbsp;and&nbsp;the&nbsp;value&nbsp;represents&nbsp;the&nbsp;RID&nbsp;of&nbsp;the&nbsp;target.&lt;/FONT&gt;&lt;/DIV&gt;&lt;/LI&gt;<br>
&lt;LI&gt;<br>
&lt;DIV&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;one&nbsp;to&nbsp;many(like&nbsp;Method&nbsp;-&amp;gt;&nbsp;CustomAttributes)&nbsp;-&nbsp;same&nbsp;concept&nbsp;but&nbsp;with&nbsp;two&nbsp;dimensions&nbsp;array.&lt;/FONT&gt;&lt;/DIV&gt;&lt;/LI&gt;&lt;/OL&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;Of&nbsp;course&nbsp;we&nbsp;need&nbsp;to&nbsp;wrap&nbsp;it&nbsp;and&nbsp;define&nbsp;a&nbsp;good&nbsp;interface&nbsp;for&nbsp;such&nbsp;a&nbsp;relation.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;I&nbsp;have&nbsp;already&nbsp;tries&amp;nbsp;&nbsp;working&nbsp;with&nbsp;such&nbsp;a&nbsp;relation&nbsp;implementation,&nbsp;and&nbsp;it&nbsp;looks&nbsp;good&nbsp;in&nbsp;terms&nbsp;of&nbsp;memory&nbsp;consumption.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&lt;/FONT&gt;&amp;nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;&amp;gt;&nbsp;I'll&nbsp;create&nbsp;a&nbsp;branch&nbsp;for&nbsp;Cecil&nbsp;so&nbsp;we&nbsp;can&nbsp;experiment.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;face=Arial&nbsp;size=2&gt;That&nbsp;will&nbsp;be&nbsp;great,&nbsp;let&nbsp;me&nbsp;know&nbsp;when&nbsp;you&nbsp;do&nbsp;that.&lt;/FONT&gt;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;&lt;FONT&nbsp;size=2&gt;&lt;/FONT&gt;&lt;BR&gt;Regards,&nbsp;&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=ltr&nbsp;align=left&gt;Roei&nbsp;Erez&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=rtl&gt;<br>
&lt;HR&nbsp;tabIndex=-1&gt;<br>
&lt;/DIV&gt;<br>
&lt;DIV&nbsp;dir=rtl&gt;&lt;FONT&nbsp;face=Tahoma&nbsp;size=2&gt;&lt;B&gt;מאת:&lt;/B&gt;&nbsp;Jb&nbsp;Evain&nbsp;[mailto:jb@nurv.fr]&lt;BR&gt;&lt;B&gt;נשלח:&lt;/B&gt;&nbsp;ד&nbsp;22/08/2007&nbsp;04:53&lt;BR&gt;&lt;B&gt;אל:&lt;/B&gt;&nbsp;Roei&nbsp;Erez&lt;BR&gt;&lt;B&gt;עותק&nbsp;לידיעה:&lt;/B&gt;&nbsp;mono-devel-list@lists.ximian.com&lt;BR&gt;&lt;B&gt;נושא:&lt;/B&gt;&nbsp;Re:&nbsp;[Mono-dev]&nbsp;Cecil&nbsp;improvement&lt;BR&gt;&lt;/FONT&gt;&lt;BR&gt;&lt;/DIV&gt;<br>
&lt;DIV&gt;<br>
&lt;P&gt;&lt;FONT&nbsp;size=2&gt;Hey,&lt;BR&gt;&lt;BR&gt;On&nbsp;8/22/07,&nbsp;Roei&nbsp;Erez&nbsp;&amp;lt;roeie@mainsoft.com&amp;gt;&nbsp;wrote:&lt;BR&gt;&amp;gt;&nbsp;When&nbsp;writing&nbsp;an&nbsp;assembly&nbsp;a&nbsp;user&nbsp;needs&nbsp;to&nbsp;build&nbsp;the&nbsp;full&nbsp;object&nbsp;model,&nbsp;so&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;don't&nbsp;think&nbsp;there&nbsp;is&nbsp;a&nbsp;lot&nbsp;of&nbsp;room&nbsp;for&nbsp;improvement&nbsp;at&nbsp;this&nbsp;area.&lt;BR&gt;&lt;BR&gt;Well,&nbsp;it's&nbsp;difficult,&nbsp;but&nbsp;if&nbsp;it's&nbsp;possible&nbsp;to&nbsp;read&nbsp;the&nbsp;object&nbsp;model&lt;BR&gt;from&nbsp;the&nbsp;raw&nbsp;bytes,&nbsp;it&nbsp;should&nbsp;also&nbsp;be&nbsp;possible&nbsp;to&nbsp;write&nbsp;it&nbsp;back.&lt;BR&gt;&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;agree&nbsp;that&nbsp;cecil&nbsp;should&nbsp;expose&nbsp;an&nbsp;interface&nbsp;to&nbsp;load&nbsp;an&nbsp;assembly&nbsp;as&lt;BR&gt;&amp;gt;&nbsp;'Read&nbsp;Only',&nbsp;where&nbsp;the&nbsp;optimizations&nbsp;should&nbsp;be&nbsp;activated,&nbsp;and&nbsp;by&nbsp;that&lt;BR&gt;&amp;gt;&nbsp;save&nbsp;the&nbsp;worrying&nbsp;of&nbsp;the&nbsp;changes&nbsp;to&nbsp;the&nbsp;assembly&nbsp;writing&nbsp;part.&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;really&nbsp;like&nbsp;the&nbsp;idea&nbsp;that&nbsp;the&nbsp;object&nbsp;model&nbsp;will&nbsp;access&nbsp;the&nbsp;raw&nbsp;tables&lt;BR&gt;&amp;gt;&nbsp;directly&nbsp;and&nbsp;in&nbsp;lazy&nbsp;way.&lt;BR&gt;&amp;gt;&nbsp;This&nbsp;idea&nbsp;will&nbsp;work&nbsp;only&nbsp;if&nbsp;the&nbsp;access&nbsp;to&nbsp;the&nbsp;raw&nbsp;table&nbsp;will&nbsp;be&nbsp;fast,&lt;BR&gt;&amp;gt;&nbsp;and&nbsp;in&nbsp;order&nbsp;to&nbsp;do&nbsp;so,&nbsp;the&nbsp;code&nbsp;needs&nbsp;to&nbsp;build&nbsp;more&nbsp;relations&nbsp;between&lt;BR&gt;&amp;gt;&nbsp;these&nbsp;tables.&lt;BR&gt;&amp;gt;&nbsp;We&nbsp;can&nbsp;take&nbsp;the&nbsp;CustomAttributes&nbsp;table&nbsp;for&nbsp;example,&nbsp;each&nbsp;raw&nbsp;at&nbsp;this&lt;BR&gt;&amp;gt;&nbsp;table&nbsp;has&nbsp;the&nbsp;'RID'&nbsp;of&nbsp;the&nbsp;owner&nbsp;element,&nbsp;and&nbsp;the&nbsp;TokenType&nbsp;of&nbsp;the&lt;BR&gt;&amp;gt;&nbsp;owner,&nbsp;and&nbsp;in&nbsp;order&nbsp;for&nbsp;a&nbsp;'Field',&nbsp;for&nbsp;example,&nbsp;to&nbsp;load&nbsp;its&lt;BR&gt;&amp;gt;&nbsp;CustomAttibutes&nbsp;lazily,&nbsp;it&nbsp;needs&nbsp;that&nbsp;opposite&nbsp;relation,&nbsp;from&nbsp;its&nbsp;'RID'&lt;BR&gt;&amp;gt;&nbsp;to&nbsp;its&nbsp;CustomAttributes,&nbsp;will&nbsp;exist.&lt;BR&gt;&amp;gt;&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;basically&nbsp;want&nbsp;to&nbsp;suggest&nbsp;the&nbsp;following:&lt;BR&gt;&amp;gt;&nbsp;The&nbsp;methods&nbsp;of&nbsp;the&nbsp;ReflectionReader&nbsp;will&nbsp;be&nbsp;changed,&nbsp;and&nbsp;instead&nbsp;of&lt;BR&gt;&amp;gt;&nbsp;building&nbsp;an&nbsp;object&nbsp;model,&nbsp;they&nbsp;will&nbsp;only&nbsp;build&nbsp;the&nbsp;desired&nbsp;relations&lt;BR&gt;&amp;gt;&nbsp;between&nbsp;elements&nbsp;(Methods-&amp;gt;Types,&nbsp;Fields-&amp;gt;Constants,&lt;BR&gt;&amp;gt;&nbsp;Fields-&amp;gt;InitialValues&nbsp;...)&lt;BR&gt;&lt;BR&gt;And&nbsp;how&nbsp;do&nbsp;you&nbsp;plan&nbsp;to&nbsp;represent&nbsp;those&nbsp;relations?&lt;BR&gt;&lt;BR&gt;&amp;gt;&nbsp;The&nbsp;higher&nbsp;object&nbsp;model&nbsp;classes&nbsp;(TypeDefinition,&nbsp;MethodDefinition,&lt;BR&gt;&amp;gt;&nbsp;FieldDefinition&nbsp;...),&nbsp;will&nbsp;have&nbsp;their&nbsp;properties&nbsp;access&nbsp;lazily&nbsp;those&lt;BR&gt;&amp;gt;&nbsp;built&nbsp;relations&nbsp;in&nbsp;order&nbsp;to&nbsp;fetch&nbsp;the&nbsp;data&nbsp;on&nbsp;first&nbsp;access.&lt;BR&gt;&amp;gt;&nbsp;My&nbsp;favorite&nbsp;solution&nbsp;is&nbsp;to&nbsp;write&nbsp;a&nbsp;'ReadOnlyReflectionReader'&nbsp;that&nbsp;will&lt;BR&gt;&amp;gt;&nbsp;contain&nbsp;the&nbsp;above&nbsp;changes,&nbsp;and&nbsp;leave&nbsp;the&nbsp;current&nbsp;implementation&nbsp;as&nbsp;is&lt;BR&gt;&amp;gt;&nbsp;for&nbsp;writing&nbsp;purposes.&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;think&nbsp;we&nbsp;should&nbsp;also&nbsp;consider&nbsp;removing&nbsp;the&nbsp;'sealed'&nbsp;modifier&nbsp;from&nbsp;the&lt;BR&gt;&amp;gt;&nbsp;higher&nbsp;level&nbsp;object&nbsp;model&nbsp;classes&nbsp;(like&nbsp;TypeDefinition,&nbsp;MethodDefinition&lt;BR&gt;&amp;gt;&nbsp;...),&nbsp;by&nbsp;that&nbsp;give&nbsp;the&nbsp;used&nbsp;ReflectionReader&nbsp;full&nbsp;control&nbsp;over&nbsp;the&lt;BR&gt;&amp;gt;&nbsp;object&nbsp;model&nbsp;implementation,&nbsp;building&nbsp;its&nbsp;own&nbsp;read-only&nbsp;one.&lt;BR&gt;&lt;BR&gt;Another&nbsp;concern&nbsp;I&nbsp;have&nbsp;is&nbsp;Cecil's&nbsp;size.&nbsp;It's&nbsp;already&nbsp;~360k,&nbsp;and&nbsp;I'd&lt;BR&gt;like&nbsp;to&nbsp;avoid&nbsp;bloating&nbsp;it.&lt;BR&gt;&lt;BR&gt;&amp;gt;&nbsp;Now&nbsp;is&nbsp;a&nbsp;good&nbsp;time&nbsp;for&nbsp;us&nbsp;to&nbsp;start&nbsp;such&nbsp;a&nbsp;process,&nbsp;and&nbsp;I&nbsp;would&nbsp;really&lt;BR&gt;&amp;gt;&nbsp;want&nbsp;to&nbsp;push&nbsp;things&nbsp;forward.&lt;BR&gt;&lt;BR&gt;I'll&nbsp;create&nbsp;a&nbsp;branch&nbsp;for&nbsp;Cecil&nbsp;so&nbsp;we&nbsp;can&nbsp;experiment.&lt;BR&gt;&lt;BR&gt;&amp;gt;&nbsp;What&nbsp;do&nbsp;you&nbsp;think&nbsp;about&nbsp;the&nbsp;suggestion?&lt;BR&gt;&amp;gt;&nbsp;If&nbsp;you&nbsp;think&nbsp;about&nbsp;major&nbsp;issues&nbsp;that&nbsp;the&nbsp;above&nbsp;solution&nbsp;will&nbsp;encounter,&lt;BR&gt;&amp;gt;&nbsp;I&nbsp;would&nbsp;be&nbsp;happy&nbsp;to&nbsp;hear&nbsp;about&nbsp;them.&lt;BR&gt;&lt;BR&gt;I&nbsp;need&nbsp;to&nbsp;think&nbsp;more&nbsp;about&nbsp;the&nbsp;implications,&nbsp;but&nbsp;be&nbsp;sure&nbsp;there&nbsp;will&nbsp;be&lt;BR&gt;dragons&nbsp;:)&lt;BR&gt;&lt;BR&gt;--&lt;BR&gt;Jb&nbsp;Evain&amp;nbsp;&nbsp;&amp;lt;jb@nurv.fr&amp;gt;&lt;BR&gt;&lt;/FONT&gt;&lt;/P&gt;&lt;/DIV&gt;&lt;/BODY&gt;&lt;/HTML&gt;<br>
<br>

</tt>
