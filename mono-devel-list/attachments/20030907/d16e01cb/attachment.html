<tt>
&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;utf-8&quot;?&gt;<br>
&lt;html&nbsp;xmlns=&quot;http://www.w3.org/1999/xhtml&quot;<br>
&nbsp;&nbsp;&nbsp;xmlns:monodoc=&quot;http://www.go-mono.org/xml/monodoc&quot;&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;title&gt;Managed&nbsp;Code&nbsp;Interop&lt;/title&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;name=&quot;DC.Description&quot;&nbsp;content=&quot;Managed&nbsp;and&nbsp;Unmanaged&nbsp;Code&nbsp;Integration&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;name=&quot;DC.Contributor&quot;&nbsp;content=&quot;Jonathan&nbsp;Pryor&quot;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;!--<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TODO:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Marshaling&nbsp;Linked&nbsp;Lists?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--&gt;<br>
&lt;/head&gt;<br>
&lt;body&gt;<br>
&lt;h1&nbsp;id=&quot;top&quot;&gt;Everything&nbsp;you&nbsp;(n)ever&nbsp;wanted&nbsp;to&nbsp;know&nbsp;about&nbsp;Marshaling&nbsp;<br>
&nbsp;&nbsp;&nbsp;(and&nbsp;were&nbsp;afraid&nbsp;to&nbsp;ask!)&lt;/h1&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#intro&quot;&gt;Introduction&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#library-handling&quot;&gt;Library&nbsp;Handling&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#invoking-unmanaged-code&quot;&gt;Invoking&nbsp;Unmanaged&nbsp;Code&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#marshaling&quot;&gt;Marshaling&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#avoiding-marshaling&quot;&gt;Avoiding&nbsp;Marshaling&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#comments&quot;&gt;Commentary&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#thanks&quot;&gt;Thanks&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#copyright&quot;&gt;Copyright&lt;/a&gt;&lt;br&nbsp;/&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;intro&quot;&gt;Introduction&lt;/h2&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;http://www.ecma-international.org/publications/standards/ecma-335.htm&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Common&nbsp;Language&nbsp;Infrastructure&lt;/a&gt;&nbsp;<br>
&nbsp;&nbsp;&nbsp;(&lt;acronym&nbsp;title=&quot;Common&nbsp;Language&nbsp;Infrastructure&quot;&gt;CLI&lt;/acronym&gt;)&nbsp;is<br>
&nbsp;&nbsp;&nbsp;designed&nbsp;to&nbsp;make&nbsp;it&nbsp;&quot;easy&quot;&nbsp;to&nbsp;interoperate&nbsp;with&nbsp;existing&nbsp;code.&nbsp;&nbsp;In&nbsp;principal,<br>
&nbsp;&nbsp;&nbsp;all&nbsp;you&nbsp;need&nbsp;to&nbsp;do&nbsp;is&nbsp;create&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.DllImportAttribute&quot;&gt;DllImport&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;function&nbsp;declaration&nbsp;for&nbsp;the&nbsp;existing&nbsp;<br>
&nbsp;&nbsp;&nbsp;code&nbsp;to&nbsp;invoke,&nbsp;and&nbsp;the&nbsp;runtime&nbsp;will&nbsp;handle&nbsp;the&nbsp;rest.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;simple-dllimport&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;libc.so&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;int&nbsp;getpid&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Please&nbsp;note&nbsp;that&nbsp;most&nbsp;of&nbsp;the&nbsp;classes&nbsp;and&nbsp;enumerations&nbsp;mentioned&nbsp;in&nbsp;this<br>
&nbsp;&nbsp;&nbsp;document&nbsp;reside&nbsp;in&nbsp;the&nbsp;System.Runtime.InteropServices&nbsp;namespace.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;above&nbsp;C#&nbsp;function&nbsp;declaration&nbsp;would&nbsp;invoke&nbsp;the&nbsp;POSIX<br>
&nbsp;&nbsp;&nbsp;getpid(2)&nbsp;system&nbsp;call&nbsp;on&nbsp;platforms&nbsp;that&nbsp;have&nbsp;the&nbsp;libc.so&nbsp;library&nbsp;(other<br>
&nbsp;&nbsp;&nbsp;platforms&nbsp;would&nbsp;generate&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.MissingMethodException&quot;&gt;MissingMethodException&lt;/a&gt;).&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;Simple.&nbsp;&nbsp;Straightforward.&nbsp;&nbsp;What&nbsp;could&nbsp;be&nbsp;easier?&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;three&nbsp;problems&nbsp;with&nbsp;this:&nbsp;(1)&nbsp;specifying&nbsp;the&nbsp;library&nbsp;in&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;DllImport&nbsp;statement;&nbsp;&nbsp;(2)&nbsp;determining&nbsp;what&nbsp;function&nbsp;to&nbsp;actually&nbsp;invoke.&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;(3)&nbsp;most&nbsp;existing&nbsp;<br>
&nbsp;&nbsp;&nbsp;code&nbsp;is&nbsp;far&nbsp;more&nbsp;complex.&nbsp;&nbsp;Strings&nbsp;will&nbsp;need&nbsp;to&nbsp;be&nbsp;passed,&nbsp;structures&nbsp;may&nbsp;<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;be&nbsp;passed,&nbsp;memory&nbsp;management&nbsp;practices&nbsp;will&nbsp;become&nbsp;involved...&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;Existing&nbsp;code&nbsp;is&nbsp;a&nbsp;complex&nbsp;beast,&nbsp;and&nbsp;the&nbsp;interop&nbsp;layer&nbsp;needs&nbsp;to&nbsp;support&nbsp;<br>
&nbsp;&nbsp;&nbsp;this&nbsp;complexity.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;library-handling&quot;&gt;Library&nbsp;Handling&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;How&nbsp;does&nbsp;the&nbsp;runtime&nbsp;find&nbsp;the&nbsp;library&nbsp;specified&nbsp;in&nbsp;the&nbsp;DllImport<br>
&nbsp;&nbsp;&nbsp;attribute?&nbsp;&nbsp;This&nbsp;question&nbsp;is&nbsp;inherently&nbsp;platform&nbsp;specific.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;library-windows&quot;&gt;Windows&nbsp;DLL&nbsp;handling&lt;/h3&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;Describe&nbsp;Windows&nbsp;algorithm&nbsp;for&nbsp;finding&nbsp;libraries.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;library-linux&quot;&gt;Linux&nbsp;Shared&nbsp;Library&nbsp;Handling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;From&nbsp;the&nbsp;dlopen(3)&nbsp;man&nbsp;page,&nbsp;the&nbsp;necessary&nbsp;shared&nbsp;libraries&nbsp;needed&nbsp;by&nbsp;<br>
&nbsp;&nbsp;&nbsp;the&nbsp;program&nbsp;are&nbsp;searched&nbsp;for&nbsp;in&nbsp;the&nbsp;following&nbsp;order:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ol&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;A&nbsp;colon-separated&nbsp;list&nbsp;of&nbsp;directories&nbsp;in&nbsp;the&nbsp;user's<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tt&gt;LD_LIBRARY_PATH&lt;/tt&gt;&nbsp;environment&nbsp;variable.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;frequently-used&nbsp;way&nbsp;to&nbsp;allow&nbsp;native&nbsp;shared&nbsp;libraries&nbsp;to&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found&nbsp;by&nbsp;a&nbsp;CLI&nbsp;program.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;list&nbsp;of&nbsp;libraries&nbsp;cached&nbsp;in&nbsp;&lt;tt&gt;/etc/ld.so.cache&lt;/tt&gt;.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tt&gt;/etc/ld.so.cache&lt;/tt&gt;&nbsp;is&nbsp;created&nbsp;by&nbsp;editing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tt&gt;/etc/ld.so.conf&lt;/tt&gt;&nbsp;and&nbsp;running&nbsp;ldconfig(8).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Editing&nbsp;&lt;tt&gt;/etc/ld.so.cache&lt;/tt&gt;&nbsp;is&nbsp;the&nbsp;preferred&nbsp;way<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;search&nbsp;additional&nbsp;directories,&nbsp;as&nbsp;opposed&nbsp;to&nbsp;using<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tt&gt;LD_LIBRARY_PATH&lt;/tt&gt;,&nbsp;as&nbsp;this&nbsp;is&nbsp;more&nbsp;secure&nbsp;(it's&nbsp;more&nbsp;difficult<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;get&nbsp;a&nbsp;trojan&nbsp;library&nbsp;into&nbsp;&lt;tt&gt;/etc/ld.so.cache&lt;/tt&gt;,&nbsp;but&nbsp;quite<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;easy&nbsp;to&nbsp;insert&nbsp;it&nbsp;into&nbsp;&lt;tt&gt;LD_LIBRARY_PATH&lt;/tt&gt;).&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;tt&gt;/lib&lt;/tt&gt;,&nbsp;followed&nbsp;by&nbsp;&lt;tt&gt;/usr/lib&lt;/tt&gt;.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;library-linux-seealso&quot;&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;dlopen(3)&nbsp;man&nbsp;page.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;ld.so(8)&nbsp;man&nbsp;page.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;library-mac-os-x&quot;&gt;Mac&nbsp;OS&nbsp;X&nbsp;Bundle&nbsp;Handling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;if&nbsp;you're&nbsp;really&nbsp;brave,&nbsp;describe&nbsp;Mac&nbsp;OS&nbsp;X.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;library-names&quot;&gt;Library&nbsp;Names&lt;/h3&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Having&nbsp;different&nbsp;algorithms&nbsp;to&nbsp;find&nbsp;the&nbsp;libraries&nbsp;can&nbsp;be&nbsp;a<br>
&nbsp;&nbsp;&nbsp;portability&nbsp;problem,&nbsp;but&nbsp;(to&nbsp;make&nbsp;matters&nbsp;worse),&nbsp;different&nbsp;platforms&nbsp;often<br>
&nbsp;&nbsp;&nbsp;have&nbsp;different&nbsp;names&nbsp;for&nbsp;the&nbsp;same&nbsp;libraries.&nbsp;&nbsp;For&nbsp;example,&nbsp;the&nbsp;GTK+&nbsp;library<br>
&nbsp;&nbsp;&nbsp;name&nbsp;on&nbsp;Windows&nbsp;is&nbsp;&lt;tt&gt;libgtk-win32-2.0-0.dll&lt;/tt&gt;,&nbsp;while&nbsp;the&nbsp;Unix<br>
&nbsp;&nbsp;&nbsp;equivalent&nbsp;library&nbsp;is&nbsp;&lt;tt&gt;libgtk-x11-2.0.so&lt;/tt&gt;.&nbsp;&nbsp;So&nbsp;how&nbsp;do&nbsp;you&nbsp;write<br>
&nbsp;&nbsp;&nbsp;portable&nbsp;P/Invoke&nbsp;code&nbsp;that&nbsp;will&nbsp;work&nbsp;cross-platform?&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;short&nbsp;answer&nbsp;is&nbsp;that&nbsp;you&nbsp;don't.&nbsp;&nbsp;There&nbsp;is&nbsp;no&nbsp;standard&nbsp;way&nbsp;of<br>
&nbsp;&nbsp;&nbsp;specifying&nbsp;library&nbsp;names.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;However,&nbsp;as&nbsp;an&nbsp;extension,&nbsp;Mono&nbsp;provides&nbsp;a&nbsp;library&nbsp;mapping&nbsp;mechanism,&nbsp;via&nbsp;<br>
&nbsp;&nbsp;&nbsp;the&nbsp;&lt;tt&gt;$prefix/etc/mono/config&lt;/tt&gt;&nbsp;XML&nbsp;file.&nbsp;&nbsp;This&nbsp;file&nbsp;contains<br>
&nbsp;&nbsp;&nbsp;&lt;tt&gt;&amp;lt;dllmap/&amp;gt;&lt;/tt&gt;&nbsp;elements,&nbsp;which&nbsp;map&nbsp;an&nbsp;input&nbsp;library&nbsp;(the&nbsp;library&nbsp;<br>
&nbsp;&nbsp;&nbsp;specified&nbsp;in&nbsp;the&nbsp;DllImport&nbsp;statement)&nbsp;to&nbsp;the&nbsp;actual&nbsp;platform-specific&nbsp;<br>
&nbsp;&nbsp;&nbsp;library&nbsp;to&nbsp;load.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;simple-dllimport&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;configuration&amp;gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;dllmap&nbsp;dll=&quot;libgtk-win32-2.0-0.dll&quot;&nbsp;target=libgtk-x11-2.0.so&quot;&nbsp;/&amp;gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;lt;/configuration&amp;gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Using&nbsp;this&nbsp;mechanism,&nbsp;the&nbsp;Mono-endorsed&nbsp;way&nbsp;of&nbsp;specifying&nbsp;DllImport<br>
&nbsp;&nbsp;&nbsp;library&nbsp;names&nbsp;is&nbsp;to&nbsp;always&nbsp;use&nbsp;the&nbsp;Windows&nbsp;library&nbsp;name&nbsp;(as&nbsp;Microsoft&nbsp;.NET&nbsp;<br>
&nbsp;&nbsp;&nbsp;has&nbsp;no&nbsp;library&nbsp;mapping&nbsp;mechanism),&nbsp;and&nbsp;then&nbsp;provide&nbsp;a&nbsp;mapping&nbsp;in&nbsp;Mono's<br>
&nbsp;&nbsp;&nbsp;&lt;tt&gt;$prefix/etc/mono/config&lt;/tt&gt;&nbsp;file.&nbsp;&nbsp;This&nbsp;is&nbsp;what&nbsp;the&nbsp;Gtk#&nbsp;library<br>
&nbsp;&nbsp;&nbsp;does.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;invoking-unmanaged-code&quot;&gt;Invoking&nbsp;Unmanaged&nbsp;Code&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;As&nbsp;far&nbsp;as&nbsp;managed&nbsp;code&nbsp;is&nbsp;concerned,&nbsp;unmanaged&nbsp;code&nbsp;is&nbsp;invoked&nbsp;merely&nbsp;by<br>
&nbsp;&nbsp;&nbsp;invoking&nbsp;a&nbsp;method&nbsp;with&nbsp;an&nbsp;associated&nbsp;DllImport&nbsp;attribute.&nbsp;&nbsp;The&nbsp;CLI&nbsp;runtime<br>
&nbsp;&nbsp;&nbsp;must&nbsp;do&nbsp;more&nbsp;work&nbsp;to&nbsp;actually&nbsp;invoke&nbsp;the&nbsp;unmanaged&nbsp;code.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;principal,&nbsp;this&nbsp;is&nbsp;a&nbsp;straightforward&nbsp;process.&nbsp;&nbsp;The&nbsp;library&nbsp;specified<br>
&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;DllImport&nbsp;attribute&nbsp;is&nbsp;loaded&nbsp;(such&nbsp;as&nbsp;through&nbsp;LoadLibrary()&nbsp;or<br>
&nbsp;&nbsp;&nbsp;dlopen()).&nbsp;&nbsp;Then,&nbsp;the&nbsp;specified&nbsp;function&nbsp;is&nbsp;looked&nbsp;up&nbsp;(via&nbsp;GetProcAddess()<br>
&nbsp;&nbsp;&nbsp;or&nbsp;dlsym()).&nbsp;&nbsp;Finally,&nbsp;the&nbsp;function&nbsp;is&nbsp;invoked.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;But&nbsp;what&nbsp;string&nbsp;is&nbsp;used&nbsp;for&nbsp;the&nbsp;function&nbsp;lookup&nbsp;(in&nbsp;GetProcAddress()&nbsp;or<br>
&nbsp;&nbsp;&nbsp;dlopen())?&nbsp;&nbsp;By&nbsp;default,&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;managed&nbsp;code&nbsp;method&nbsp;is&nbsp;used,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;is&nbsp;why&nbsp;getpid()&nbsp;in&nbsp;the&nbsp;above&nbsp;example&nbsp;invokes&nbsp;getpid()&nbsp;from&nbsp;the&nbsp;C<br>
&nbsp;&nbsp;&nbsp;library.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Alternatively,&nbsp;the&nbsp;DllImport&nbsp;attribute's&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.EntryPoint&quot;&gt;EntryPoint&lt;/a&gt;&nbsp;field<br>
&nbsp;&nbsp;&nbsp;can&nbsp;be&nbsp;set,&nbsp;and&nbsp;that&nbsp;string&nbsp;used.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Either&nbsp;way,&nbsp;the&nbsp;string&nbsp;used&nbsp;is&nbsp;assumed&nbsp;to&nbsp;refer&nbsp;to&nbsp;a&nbsp;C&nbsp;ABI-compatible<br>
&nbsp;&nbsp;&nbsp;function&nbsp;exported&nbsp;by&nbsp;the&nbsp;specified&nbsp;library.&nbsp;&nbsp;On&nbsp;some&nbsp;platforms,&nbsp;this&nbsp;may<br>
&nbsp;&nbsp;&nbsp;cause&nbsp;a&nbsp;leading&nbsp;underscore&nbsp;to&nbsp;be&nbsp;prefixed&nbsp;to&nbsp;the&nbsp;symbol&nbsp;name.&nbsp;&nbsp;Other<br>
&nbsp;&nbsp;&nbsp;platforms&nbsp;generate&nbsp;no&nbsp;mangling.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Note&nbsp;that&nbsp;a&nbsp;C&nbsp;ABI&nbsp;is&nbsp;assumed.&nbsp;&nbsp;This&nbsp;makes&nbsp;it&nbsp;nearly&nbsp;impossible&nbsp;to<br>
&nbsp;&nbsp;&nbsp;directly&nbsp;invoke&nbsp;functions&nbsp;that&nbsp;are&nbsp;not&nbsp;C&nbsp;ABI&nbsp;compatible,&nbsp;such&nbsp;as&nbsp;C++<br>
&nbsp;&nbsp;&nbsp;library&nbsp;functions&nbsp;that&nbsp;are&nbsp;not&nbsp;&lt;tt&gt;extern&nbsp;&quot;C&quot;&lt;/tt&gt;.&nbsp;&nbsp;Some&nbsp;variation&nbsp;on&nbsp;the<br>
&nbsp;&nbsp;&nbsp;C&nbsp;ABI&nbsp;is&nbsp;permitted,&nbsp;such&nbsp;as&nbsp;variation&nbsp;in&nbsp;the&nbsp;function's<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.CallingConvention&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;CallingConvention&lt;/a&gt;.&nbsp;&nbsp;The&nbsp;default&nbsp;CallingConvention&nbsp;is<br>
&nbsp;&nbsp;&nbsp;platform-specific.&nbsp;&nbsp;Under&nbsp;Windows,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.CallingConvention.StdCall&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;StdCall&lt;/a&gt;&nbsp;is&nbsp;the&nbsp;default,&nbsp;as&nbsp;this&nbsp;is&nbsp;used&nbsp;for&nbsp;most&nbsp;Win32&nbsp;API&nbsp;functions.<br>
&nbsp;&nbsp;&nbsp;Under&nbsp;Unix&nbsp;platforms,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.CallingConvention.Cdecl&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Cdecl&lt;/a&gt;&nbsp;is&nbsp;the&nbsp;default.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Calling&nbsp;convention&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;C&nbsp;code&nbsp;by&nbsp;using&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&lt;tt&gt;__stdcall&lt;/tt&gt;&nbsp;and&nbsp;&lt;tt&gt;__cdecl&lt;/tt&gt;&nbsp;compiler&nbsp;intrinsics&nbsp;under&nbsp;Microsoft<br>
&nbsp;&nbsp;&nbsp;Visual&nbsp;C++,&nbsp;and&nbsp;by&nbsp;using&nbsp;the&nbsp;&lt;tt&gt;__attribute__((stdcall))&lt;/tt&gt;&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&lt;tt&gt;__attribute__((cdecl))&lt;/tt&gt;&nbsp;compiler&nbsp;intrinsics&nbsp;under&nbsp;GCC.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Does&nbsp;having&nbsp;the&nbsp;default&nbsp;CallingConvention&nbsp;vary&nbsp;between&nbsp;platforms&nbsp;cause<br>
&nbsp;&nbsp;&nbsp;portability&nbsp;problems?&nbsp;&nbsp;Yes.&nbsp;&nbsp;All&nbsp;the&nbsp;more&nbsp;reason&nbsp;to&nbsp;write&nbsp;as&nbsp;much&nbsp;code&nbsp;as<br>
&nbsp;&nbsp;&nbsp;possible&nbsp;as&nbsp;managed&nbsp;code,&nbsp;avoiding&nbsp;the&nbsp;whole&nbsp;P/Invoke/marshaling&nbsp;conundrum<br>
&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;first&nbsp;place.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&gt;See&nbsp;Also&lt;/h3&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;href=&quot;http://www.swig.org/&quot;&gt;SWIG&lt;/a&gt;,&nbsp;a&nbsp;code&nbsp;generation&nbsp;program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;easily&nbsp;wraps&nbsp;exising&nbsp;C&nbsp;and&nbsp;C++&nbsp;code&nbsp;for&nbsp;use&nbsp;by&nbsp;a&nbsp;multitude&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;languages,&nbsp;including&nbsp;CLI&nbsp;languages.&nbsp;&nbsp;This&nbsp;makes&nbsp;it&nbsp;easier&nbsp;to&nbsp;invoke&nbsp;C++<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code&nbsp;from&nbsp;a&nbsp;CLI&nbsp;application.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;marshaling&quot;&gt;Marshaling&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;How&nbsp;does&nbsp;code&nbsp;interop&nbsp;work?&nbsp;&nbsp;Given&nbsp;a&nbsp;managed&nbsp;call&nbsp;site&nbsp;(the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;call),&nbsp;and&nbsp;an&nbsp;unmanaged&nbsp;callee&nbsp;site&nbsp;(the&nbsp;function&nbsp;that's&nbsp;being&nbsp;called),&nbsp;each<br>
&nbsp;&nbsp;&nbsp;parameter&nbsp;in&nbsp;the&nbsp;call&nbsp;site&nbsp;is&nbsp;&quot;marshaled&quot;&nbsp;(converted)&nbsp;into&nbsp;an&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;equivalent.&nbsp;&nbsp;The&nbsp;marshaled&nbsp;data&nbsp;is&nbsp;in&nbsp;turn&nbsp;placed&nbsp;on&nbsp;the&nbsp;runtime&nbsp;stack<br>
&nbsp;&nbsp;&nbsp;(along&nbsp;with&nbsp;other&nbsp;data),&nbsp;and&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;is&nbsp;invoked.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;complexity&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;marshaling.&nbsp;&nbsp;For&nbsp;simple&nbsp;types,&nbsp;such&nbsp;as&nbsp;<br>
&nbsp;&nbsp;&nbsp;integers&nbsp;and&nbsp;floating-point&nbsp;numbers,&nbsp;marshaling&nbsp;is&nbsp;a&nbsp;bitwise-copy<br>
&nbsp;&nbsp;&nbsp;(&quot;blitting&quot;),&nbsp;just&nbsp;as&nbsp;would&nbsp;be&nbsp;the&nbsp;case&nbsp;for&nbsp;unmanaged&nbsp;code.&nbsp;&nbsp;In&nbsp;some&nbsp;cases,<br>
&nbsp;&nbsp;&nbsp;marshaling&nbsp;can&nbsp;be&nbsp;avoided,&nbsp;such&nbsp;as&nbsp;when&nbsp;passing&nbsp;structures&nbsp;by<br>
&nbsp;&nbsp;&nbsp;reference&nbsp;to&nbsp;unmanaged&nbsp;code&nbsp;(a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;structure&nbsp;is&nbsp;copied&nbsp;instead).&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;It's&nbsp;also&nbsp;possible&nbsp;to&nbsp;obtain&nbsp;more&nbsp;control<br>
&nbsp;&nbsp;&nbsp;over&nbsp;marshaling,&nbsp;using&nbsp;&lt;a&nbsp;href=&quot;#custom-marshal&quot;&gt;custom&nbsp;marshaling&lt;/a&gt;.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;String&nbsp;types<br>
&nbsp;&nbsp;&nbsp;introduce&nbsp;additional&nbsp;complexity,&nbsp;as&nbsp;you&nbsp;need&nbsp;to&nbsp;specify&nbsp;the&nbsp;form&nbsp;of&nbsp;string<br>
&nbsp;&nbsp;&nbsp;conversion.&nbsp;&nbsp;The&nbsp;runtime&nbsp;stores&nbsp;strings&nbsp;as&nbsp;UTF-16-encoded&nbsp;strings,&nbsp;and&nbsp;these<br>
&nbsp;&nbsp;&nbsp;will&nbsp;likely&nbsp;need&nbsp;to&nbsp;be&nbsp;marshaled&nbsp;to&nbsp;a&nbsp;more&nbsp;appropriate&nbsp;form&nbsp;(ANSI&nbsp;strings,<br>
&nbsp;&nbsp;&nbsp;UTF-8&nbsp;encoded&nbsp;strings,&nbsp;etc.).&nbsp;&nbsp;Strings&nbsp;get&nbsp;special&nbsp;support.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Marshaling&nbsp;behavior&nbsp;is&nbsp;controlled&nbsp;through&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.DllImportAttribute&quot;&gt;DllImport&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.MarshalAsAttribute&quot;&gt;MarshalAs&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;attributes.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;marshaling-strings&quot;&gt;Strings&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;&lt;a&nbsp;href=&quot;T:System.String&quot;&gt;String&lt;/a&gt;s&nbsp;are&nbsp;special.&nbsp;&nbsp;String&nbsp;marshaling&nbsp;<br>
&nbsp;&nbsp;&nbsp;behavior&nbsp;is&nbsp;also&nbsp;highly&nbsp;platform&nbsp;dependent.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;String&nbsp;marshaling&nbsp;for&nbsp;a&nbsp;function&nbsp;call&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;declaration&nbsp;with&nbsp;the&nbsp;DllImport&nbsp;attribute,&nbsp;by&nbsp;setting&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.DllImportAttribute.CharSet&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;CharSet&lt;/a&gt;&nbsp;field.&nbsp;&nbsp;The&nbsp;default&nbsp;value&nbsp;for&nbsp;this&nbsp;field&nbsp;is&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.CharSet.Auto&quot;&gt;CharSet.Auto&lt;/a&gt;,&nbsp;<br>
&nbsp;&nbsp;&nbsp;which&nbsp;implies&nbsp;&quot;magic.&quot;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Some&nbsp;background.&nbsp;&nbsp;The&nbsp;Microsoft&nbsp;Win32&nbsp;API&nbsp;supports&nbsp;two&nbsp;forms&nbsp;of&nbsp;strings,<br>
&nbsp;&nbsp;&nbsp;ANSI&nbsp;(localized)&nbsp;strings&nbsp;and&nbsp;Unicode&nbsp;strings.&nbsp;&nbsp;It&nbsp;supports&nbsp;these&nbsp;string<br>
&nbsp;&nbsp;&nbsp;formats&nbsp;by&nbsp;appending&nbsp;an&nbsp;&quot;A&quot;&nbsp;for&nbsp;Ansi&nbsp;string&nbsp;APIs&nbsp;and&nbsp;a&nbsp;&quot;W&quot;&nbsp;(&quot;wide&quot;)&nbsp;for&nbsp;<br>
&nbsp;&nbsp;&nbsp;Unicode&nbsp;string&nbsp;APIs.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Consider&nbsp;this&nbsp;Win32&nbsp;API&nbsp;description:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;text-out-marshaling&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;gdi32.dll&quot;,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CharSet=CharSet.Auto,&nbsp;CallingConvention=CallingConvention.StdCall)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;bool&nbsp;TextOut&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.IntPtr&nbsp;hdc,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;nXStart,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;nYStart,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;lpString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;cbString);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;When&nbsp;TextOut&nbsp;is&nbsp;called,&nbsp;the&nbsp;&quot;magic&quot;&nbsp;properties&nbsp;of&nbsp;String&nbsp;marshaling<br>
&nbsp;&nbsp;&nbsp;become&nbsp;apparent.&nbsp;&nbsp;Due&nbsp;to&nbsp;string&nbsp;marshaling,&nbsp;the&nbsp;runtime&nbsp;doesn't&nbsp;just&nbsp;look<br>
&nbsp;&nbsp;&nbsp;for&nbsp;an&nbsp;unmanaged&nbsp;function&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;as&nbsp;the&nbsp;specified&nbsp;method,&nbsp;as<br>
&nbsp;&nbsp;&nbsp;specified&nbsp;in&nbsp;&lt;a&nbsp;href=&quot;#invoking-unmanaged-code&quot;&gt;Invoking&nbsp;Unmanaged<br>
&nbsp;&nbsp;&nbsp;Code&lt;/a&gt;.&nbsp;&nbsp;Other&nbsp;permutations&nbsp;of&nbsp;the&nbsp;function&nbsp;may&nbsp;be&nbsp;searched&nbsp;for,<br>
&nbsp;&nbsp;&nbsp;depending&nbsp;on&nbsp;the&nbsp;CLI&nbsp;runtime&nbsp;and&nbsp;the&nbsp;host&nbsp;platform.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;three&nbsp;functions&nbsp;that&nbsp;may&nbsp;be&nbsp;searched&nbsp;for:&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOutW&nbsp;for&nbsp;Unicode&nbsp;string&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOutA&nbsp;for&nbsp;Ansi&nbsp;string&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;TextOut&nbsp;with&nbsp;the&nbsp;platform-default&nbsp;marshaling&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Under&nbsp;.NET,&nbsp;for&nbsp;platforms&nbsp;whose&nbsp;default&nbsp;character&nbsp;set&nbsp;is&nbsp;UCS2&nbsp;Unicode&nbsp;<br>
&nbsp;&nbsp;&nbsp;(all&nbsp;flavors&nbsp;of&nbsp;Windows&nbsp;NT,&nbsp;and&nbsp;Windows&nbsp;XP),&nbsp;the&nbsp;default<br>
&nbsp;&nbsp;&nbsp;search&nbsp;path&nbsp;is&nbsp;TextOutW,&nbsp;TextOutA,&nbsp;and&nbsp;TextOut.&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;Unicode&nbsp;marshaling&nbsp;is&nbsp;preferred,&nbsp;as&nbsp;(ideally)&nbsp;the&nbsp;System.String&nbsp;can&nbsp;be<br>
&nbsp;&nbsp;&nbsp;passed&nbsp;as-is&nbsp;to&nbsp;the&nbsp;function,&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;function&nbsp;doesn't&nbsp;modify&nbsp;the<br>
&nbsp;&nbsp;&nbsp;string&nbsp;parameter.&nbsp;&nbsp;Windows&nbsp;CE&nbsp;does&nbsp;not&nbsp;look&nbsp;for&nbsp;TextOutA,&nbsp;as&nbsp;it&nbsp;has&nbsp;no&nbsp;Ansi<br>
&nbsp;&nbsp;&nbsp;APIs.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Under&nbsp;.NET,&nbsp;for&nbsp;platforms&nbsp;whose&nbsp;default&nbsp;character&nbsp;set&nbsp;is&nbsp;Ansi&nbsp;<br>
&nbsp;&nbsp;&nbsp;(Windows&nbsp;9x,&nbsp;Windows&nbsp;ME),&nbsp;the&nbsp;default&nbsp;search&nbsp;path&nbsp;is&nbsp;TextOutA&nbsp;and&nbsp;TextOut&nbsp;<br>
&nbsp;&nbsp;&nbsp;(TextOutW&nbsp;is&nbsp;not&nbsp;looked&nbsp;for).<br>
&nbsp;&nbsp;&nbsp;Ansi&nbsp;marshalling&nbsp;will&nbsp;require&nbsp;translating&nbsp;the&nbsp;Unicode<br>
&nbsp;&nbsp;&nbsp;string&nbsp;into&nbsp;an&nbsp;8-bit&nbsp;string&nbsp;(or&nbsp;DBCS,&nbsp;depending&nbsp;on&nbsp;the&nbsp;country)&nbsp;<br>
&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;user's&nbsp;locale.&nbsp;&nbsp;Most&nbsp;(all?)&nbsp;of&nbsp;the&nbsp;time,<br>
&nbsp;&nbsp;&nbsp;this&nbsp;WILL&nbsp;NOT&nbsp;be&nbsp;UTF-8,&nbsp;so&nbsp;you&nbsp;CAN&nbsp;NOT&nbsp;assume&nbsp;that&nbsp;CharSet.Ansi&nbsp;will<br>
&nbsp;&nbsp;&nbsp;generate&nbsp;UTF-8-encoded&nbsp;strings.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;what&nbsp;does&nbsp;Mono&nbsp;do&nbsp;on&nbsp;Unix?&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;If&nbsp;you&nbsp;don't&nbsp;want&nbsp;the&nbsp;runtime&nbsp;to&nbsp;search&nbsp;for&nbsp;the&nbsp;alternate&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;functions,&nbsp;specify&nbsp;a&nbsp;CharSet&nbsp;value&nbsp;other&nbsp;than&nbsp;CharSet.Auto.&nbsp;&nbsp;This&nbsp;will<br>
&nbsp;&nbsp;&nbsp;cause&nbsp;the&nbsp;runtime&nbsp;to&nbsp;look&nbsp;only&nbsp;for&nbsp;the&nbsp;specified&nbsp;function.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Perhaps&nbsp;in&nbsp;the&nbsp;future&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.CharSet&quot;&gt;CharSet&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;enumeration&nbsp;will&nbsp;contain&nbsp;more&nbsp;choices,<br>
&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;UnicodeLE&nbsp;(little-endian),&nbsp;UnicodeBE&nbsp;(big-endian),&nbsp;Utf7,&nbsp;Utf8,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;other&nbsp;common&nbsp;choices.&nbsp;&nbsp;Additionally,&nbsp;making&nbsp;such&nbsp;a&nbsp;change&nbsp;would&nbsp;also<br>
&nbsp;&nbsp;&nbsp;likely&nbsp;require&nbsp;changing&nbsp;the&nbsp;UnmanagedType&nbsp;enumeration.&nbsp;&nbsp;However,&nbsp;these&nbsp;would&nbsp;<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;go&nbsp;through&nbsp;ECMA,&nbsp;so&nbsp;it&nbsp;won't&nbsp;happen&nbsp;next&nbsp;week.&nbsp;&nbsp;(Unless&nbsp;some&nbsp;time&nbsp;<br>
&nbsp;&nbsp;&nbsp;has&nbsp;passed&nbsp;since&nbsp;this&nbsp;was&nbsp;originally&nbsp;written,&nbsp;in&nbsp;which&nbsp;case&nbsp;it&nbsp;may&nbsp;very&nbsp;<br>
&nbsp;&nbsp;&nbsp;well&nbsp;be&nbsp;next&nbsp;week.&nbsp;&nbsp;But&nbsp;don't&nbsp;count&nbsp;on&nbsp;it.)&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;controlling-string-marshaling&quot;&gt;More&nbsp;Control&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Using&nbsp;the&nbsp;DllImport&nbsp;attribute&nbsp;works&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;control&nbsp;all&nbsp;the<br>
&nbsp;&nbsp;&nbsp;strings&nbsp;in&nbsp;a&nbsp;function,&nbsp;but&nbsp;what&nbsp;if&nbsp;you&nbsp;need&nbsp;more&nbsp;control?&nbsp;&nbsp;You&nbsp;would&nbsp;need<br>
&nbsp;&nbsp;&nbsp;more&nbsp;control&nbsp;if&nbsp;a&nbsp;string&nbsp;is&nbsp;a&nbsp;member&nbsp;of&nbsp;a&nbsp;structure,&nbsp;or&nbsp;if&nbsp;the&nbsp;function<br>
&nbsp;&nbsp;&nbsp;uses&nbsp;multiple&nbsp;different&nbsp;types&nbsp;of&nbsp;strings&nbsp;as&nbsp;parameters.&nbsp;&nbsp;In&nbsp;these<br>
&nbsp;&nbsp;&nbsp;circumstances,&nbsp;the&nbsp;MarshalAs&nbsp;attribute&nbsp;can&nbsp;be&nbsp;used,&nbsp;setting&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;P:System.Runtime.InteropServices.MarshalAsAttribute.Value&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Value&lt;/a&gt;&nbsp;property&nbsp;(which&nbsp;is&nbsp;set&nbsp;in&nbsp;the&nbsp;constructor)<br>
&nbsp;&nbsp;&nbsp;to&nbsp;a&nbsp;value&nbsp;from&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.UnmanagedType&quot;&gt;UnmanagedType&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;enumeration.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;mixed-string-marshaling&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;does-not-exist&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;void&nbsp;Foo&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPStr)]&nbsp;string&nbsp;ansiString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPWStr)]&nbsp;string&nbsp;unicodeString,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs(UnmanagedType.LPTStr)]&nbsp;string&nbsp;platformString);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;As&nbsp;you&nbsp;can&nbsp;guess&nbsp;by&nbsp;reading&nbsp;the&nbsp;example,&nbsp;UnmanagedType.LPStr&nbsp;will<br>
&nbsp;&nbsp;&nbsp;marshal&nbsp;the&nbsp;input&nbsp;string&nbsp;into&nbsp;an&nbsp;Ansi&nbsp;string,&nbsp;UnmanagedType.LPWStr&nbsp;will<br>
&nbsp;&nbsp;&nbsp;marshal&nbsp;the&nbsp;input&nbsp;string&nbsp;into&nbsp;a&nbsp;Unicode&nbsp;string&nbsp;(effectively&nbsp;doing<br>
&nbsp;&nbsp;&nbsp;nothing),&nbsp;and&nbsp;UnmanagedType.LPTStr&nbsp;will&nbsp;convert&nbsp;the&nbsp;string&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;platform's&nbsp;default&nbsp;string&nbsp;encoding.&nbsp;&nbsp;For&nbsp;all&nbsp;flavors&nbsp;of&nbsp;Windows&nbsp;NT&nbsp;(Windows<br>
&nbsp;&nbsp;&nbsp;NT&nbsp;3.51&nbsp;and&nbsp;4.0,&nbsp;Windows&nbsp;2000,&nbsp;Windows&nbsp;XP,&nbsp;Windows&nbsp;Server&nbsp;2003)&nbsp;the<br>
&nbsp;&nbsp;&nbsp;platform&nbsp;default&nbsp;encoding&nbsp;is&nbsp;Unicode,&nbsp;while&nbsp;for&nbsp;all&nbsp;Windows&nbsp;9x&nbsp;flavors<br>
&nbsp;&nbsp;&nbsp;(Windows&nbsp;95,&nbsp;98,&nbsp;ME)&nbsp;the&nbsp;platform&nbsp;default&nbsp;encoding&nbsp;is&nbsp;Ansi.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;other&nbsp;UnmangedType&nbsp;string&nbsp;marshaling&nbsp;options,&nbsp;but&nbsp;they're<br>
&nbsp;&nbsp;&nbsp;primarily&nbsp;of&nbsp;interest&nbsp;in&nbsp;COM&nbsp;Interop&nbsp;(BStr,&nbsp;AnsiBStr,&nbsp;TBStr).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;Does&nbsp;anybody&nbsp;know&nbsp;the&nbsp;default&nbsp;encoding&nbsp;for&nbsp;Unix&nbsp;platforms?&nbsp;&nbsp;I&nbsp;<br>
&nbsp;&nbsp;&nbsp;would&nbsp;guess&nbsp;Ansi&nbsp;as&nbsp;well...&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;If&nbsp;UnmanagedType&nbsp;doesn't&nbsp;provide&nbsp;enough&nbsp;flexibility&nbsp;for&nbsp;your&nbsp;string<br>
&nbsp;&nbsp;&nbsp;marshaling&nbsp;needs&nbsp;(for&nbsp;example,&nbsp;you're&nbsp;wrapping&nbsp;GTK+&nbsp;and&nbsp;you&nbsp;need&nbsp;to&nbsp;marshal<br>
&nbsp;&nbsp;&nbsp;strings&nbsp;in&nbsp;UTF-8&nbsp;format),&nbsp;look&nbsp;at&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;#custom-marshal&quot;&gt;Custom<br>
&nbsp;&nbsp;&nbsp;Marshaling&lt;/a&gt;&nbsp;section.<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-caller-modifiable-strings&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Passing&nbsp;Caller-Modifiable&nbsp;Strings&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;A&nbsp;common&nbsp;C&nbsp;idiom&nbsp;is&nbsp;for&nbsp;the&nbsp;caller&nbsp;to&nbsp;provide&nbsp;the&nbsp;callee&nbsp;a&nbsp;buffer&nbsp;to<br>
&nbsp;&nbsp;&nbsp;fill.&nbsp;&nbsp;For&nbsp;exmple,&nbsp;consider&nbsp;strncpy(3):&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;strncpy-c-prototype&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;strncpy&nbsp;(char&nbsp;*dest,&nbsp;const&nbsp;char&nbsp;*src,&nbsp;size_t&nbsp;n);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;We&nbsp;can't&nbsp;use&nbsp;System.String&nbsp;for&nbsp;both&nbsp;parameters,&nbsp;as&nbsp;strings&nbsp;are<br>
&nbsp;&nbsp;&nbsp;immutable.&nbsp;&nbsp;This&nbsp;is&nbsp;OK&nbsp;for&nbsp;&quot;src&quot;,&nbsp;but&nbsp;&quot;dest&quot;&nbsp;will&nbsp;be&nbsp;modified,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;caller&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;see&nbsp;the&nbsp;modification.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;solution&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Text.StringBuilder&quot;&gt;System.Text.StringBuilder&lt;/a&gt;,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;gets&nbsp;special&nbsp;marshaling&nbsp;support&nbsp;from&nbsp;the&nbsp;runtime.&nbsp;&nbsp;This&nbsp;would&nbsp;allow<br>
&nbsp;&nbsp;&nbsp;strncpy(3)&nbsp;to&nbsp;be&nbsp;wrapped&nbsp;and&nbsp;used&nbsp;as:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;strncpy-csharp-prototype&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;libc.so&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;extern&nbsp;void&nbsp;strncpy&nbsp;(StringBuilder&nbsp;dest,&nbsp;string&nbsp;src,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint&nbsp;n);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;void&nbsp;UseStrncpy&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;sb&nbsp;=&nbsp;new&nbsp;StringBuilder&nbsp;(256);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy&nbsp;(sb,&nbsp;&quot;this&nbsp;is&nbsp;the&nbsp;source&nbsp;string&quot;,&nbsp;sb.Capacity);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine&nbsp;(sb.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Some&nbsp;things&nbsp;to&nbsp;note&nbsp;is&nbsp;that&nbsp;the&nbsp;return&nbsp;value&nbsp;of&nbsp;strncpy(3)&nbsp;was&nbsp;changed<br>
&nbsp;&nbsp;&nbsp;to&nbsp;&quot;void&quot;,&nbsp;as&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;specify&nbsp;that&nbsp;the&nbsp;return&nbsp;value&nbsp;will&nbsp;be&nbsp;the<br>
&nbsp;&nbsp;&nbsp;same&nbsp;pointer&nbsp;address&nbsp;as&nbsp;the&nbsp;input&nbsp;&quot;dest&quot;&nbsp;string&nbsp;buffer,&nbsp;and&nbsp;thus&nbsp;it&nbsp;doesn't<br>
&nbsp;&nbsp;&nbsp;need&nbsp;to&nbsp;be&nbsp;marshalled.&nbsp;&nbsp;If&nbsp;&quot;string&quot;&nbsp;were&nbsp;used&nbsp;instead,&nbsp;Bad&nbsp;Things&nbsp;could<br>
&nbsp;&nbsp;&nbsp;happen&nbsp;(the&nbsp;returned&nbsp;string&nbsp;would&nbsp;be&nbsp;freed;&nbsp;see&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#marshaling-string-return-values&quot;&gt;Strings&nbsp;as&nbsp;Return&nbsp;Values&lt;/a&gt;).<br>
&nbsp;&nbsp;&nbsp;The&nbsp;StringBuilder&nbsp;is&nbsp;allocated&nbsp;with&nbsp;the<br>
&nbsp;&nbsp;&nbsp;correct&nbsp;amount&nbsp;of&nbsp;storage&nbsp;as&nbsp;a&nbsp;constructor&nbsp;parameter,&nbsp;and&nbsp;this&nbsp;amount&nbsp;of<br>
&nbsp;&nbsp;&nbsp;storage&nbsp;is&nbsp;passed&nbsp;to&nbsp;strncpy(3)&nbsp;to&nbsp;prevent&nbsp;buffer&nbsp;overflow.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-string-return-values&quot;&gt;Strings&nbsp;as&nbsp;Return&nbsp;Values&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;String&nbsp;type&nbsp;is&nbsp;a&nbsp;class,&nbsp;so&nbsp;see&nbsp;the<br>
&nbsp;&nbsp;&nbsp;section&nbsp;on&nbsp;&lt;a&nbsp;href=&quot;#cs-return-values&quot;&gt;returning&nbsp;classes&nbsp;from<br>
&nbsp;&nbsp;&nbsp;functions&lt;/a&gt;.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;If&nbsp;you&nbsp;don't&nbsp;want&nbsp;the&nbsp;runtime&nbsp;to&nbsp;free&nbsp;the&nbsp;returned&nbsp;string,&nbsp;either&nbsp;(a)<br>
&nbsp;&nbsp;&nbsp;don't&nbsp;specify&nbsp;the&nbsp;return&nbsp;value&nbsp;(as&nbsp;was&nbsp;done&nbsp;for&nbsp;the&nbsp;strncpy(3)&nbsp;function<br>
&nbsp;&nbsp;&nbsp;above),&nbsp;or&nbsp;(b)&nbsp;return&nbsp;a&nbsp;&lt;a&nbsp;href=&quot;T:System.IntPtr&quot;&gt;IntPtr&lt;/a&gt;&nbsp;and&nbsp;use&nbsp;one&nbsp;of<br>
&nbsp;&nbsp;&nbsp;the&nbsp;Marshal.PtrToString*&nbsp;functions,&nbsp;depending&nbsp;on&nbsp;the&nbsp;type&nbsp;of&nbsp;string<br>
&nbsp;&nbsp;&nbsp;returned.&nbsp;&nbsp;For&nbsp;example,&nbsp;use&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.PtrToStringAnsi&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.PtrToStringAnsi&lt;/a&gt;&nbsp;to&nbsp;marshal&nbsp;from&nbsp;a&nbsp;Ansi&nbsp;string,&nbsp;and&nbsp;use&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.PtrToStringUni&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.PtrToStringUni&lt;/a&gt;&nbsp;to&nbsp;marshal&nbsp;from&nbsp;a&nbsp;Unicode&nbsp;string.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h5&nbsp;id=&quot;marshal-retval-mono-note&quot;&gt;Implementation&nbsp;Note&lt;/h5&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;At&nbsp;this&nbsp;time,&nbsp;Mono&nbsp;does&nbsp;not&nbsp;free&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;functions.&nbsp;&nbsp;This<br>
&nbsp;&nbsp;&nbsp;should&nbsp;change&nbsp;in&nbsp;the&nbsp;future&nbsp;to&nbsp;avoid&nbsp;memory&nbsp;leaks.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpcondefaultmarshalingforstrings.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Default&nbsp;marshaling&nbsp;for&nbsp;Strings&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;marshaling-classes-or-structures&quot;&gt;Class&nbsp;and&nbsp;Structure&nbsp;Marshaling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Conceptually,&nbsp;classes&nbsp;and&nbsp;structures&nbsp;are&nbsp;marshalled&nbsp;to&nbsp;native&nbsp;code<br>
&nbsp;&nbsp;&nbsp;through&nbsp;the&nbsp;following&nbsp;process:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ol&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;runtime&nbsp;allocates&nbsp;a&nbsp;chunk&nbsp;of&nbsp;unmanaged&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;managed&nbsp;class&nbsp;data&nbsp;is&nbsp;copied&nbsp;into&nbsp;the&nbsp;unmanaged&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;unmanaged&nbsp;function&nbsp;is&nbsp;invoked,&nbsp;passing&nbsp;it&nbsp;the&nbsp;unmanaged&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;information&nbsp;instead&nbsp;of&nbsp;the&nbsp;managed&nbsp;memory&nbsp;information.&nbsp;&nbsp;This&nbsp;must&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;done&nbsp;so&nbsp;that&nbsp;if&nbsp;a&nbsp;GC&nbsp;occurs,&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;doesn't&nbsp;need&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;worry&nbsp;about&nbsp;it.&nbsp;&nbsp;(And&nbsp;yes,&nbsp;you&nbsp;need&nbsp;to&nbsp;worry&nbsp;about&nbsp;GCs,&nbsp;as&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unmanaged&nbsp;function&nbsp;could&nbsp;call&nbsp;back&nbsp;into&nbsp;the&nbsp;runtime,&nbsp;ultimately<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leading&nbsp;to&nbsp;a&nbsp;GC.)&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;copied&nbsp;back&nbsp;into&nbsp;managed&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;principal&nbsp;difference&nbsp;between&nbsp;class&nbsp;and&nbsp;structure&nbsp;marshaling&nbsp;is<br>
&nbsp;&nbsp;&nbsp;which,&nbsp;if&nbsp;any,&nbsp;of&nbsp;these&nbsp;conceptual&nbsp;steps&nbsp;actually&nbsp;occurs.&nbsp;:-)&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-classes&quot;&gt;Class&nbsp;Marshaling&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Remember&nbsp;that&nbsp;classes&nbsp;are&nbsp;heap-allocated&nbsp;and&nbsp;garbage-collected&nbsp;in&nbsp;the<br>
&nbsp;&nbsp;&nbsp;CLI.&nbsp;&nbsp;As&nbsp;such,&nbsp;you&nbsp;cannot&nbsp;pass&nbsp;classes&nbsp;by&nbsp;value&nbsp;to&nbsp;unmanaged&nbsp;functions,<br>
&nbsp;&nbsp;&nbsp;only&nbsp;by&nbsp;reference:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;class-marshal-example&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Unmanaged&nbsp;code&nbsp;declarations&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;a,&nbsp;b,&nbsp;c;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;WRONG&nbsp;(struct&nbsp;UnamangedStruct&nbsp;pass_by_value);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;RIGHT&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*pass_by_reference);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;means&nbsp;that&nbsp;you&nbsp;cannot&nbsp;use&nbsp;classes&nbsp;to&nbsp;invoke&nbsp;unmanaged&nbsp;functions<br>
&nbsp;&nbsp;&nbsp;that&nbsp;expect&nbsp;pass-by-value&nbsp;variables&nbsp;(such&nbsp;as&nbsp;the&nbsp;WRONG&nbsp;function,<br>
&nbsp;&nbsp;&nbsp;above).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;other&nbsp;issues&nbsp;with&nbsp;classes.&nbsp;&nbsp;First&nbsp;of&nbsp;all,&nbsp;classes&nbsp;by<br>
&nbsp;&nbsp;&nbsp;default&nbsp;use&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Auto&quot;&gt;Auto&lt;/a&gt;&nbsp;layout.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;the&nbsp;ordering&nbsp;of&nbsp;class&nbsp;data&nbsp;members&nbsp;is&nbsp;unknown,&nbsp;and&nbsp;won't&nbsp;be<br>
&nbsp;&nbsp;&nbsp;determined&nbsp;until&nbsp;runtime.&nbsp;&nbsp;The&nbsp;runtime&nbsp;can&nbsp;rearrange&nbsp;the&nbsp;order&nbsp;of&nbsp;members&nbsp;in<br>
&nbsp;&nbsp;&nbsp;any&nbsp;way&nbsp;it&nbsp;chooses,&nbsp;to&nbsp;optimize&nbsp;for&nbsp;access&nbsp;time&nbsp;or&nbsp;data&nbsp;layout&nbsp;space.&nbsp;&nbsp;As<br>
&nbsp;&nbsp;&nbsp;such,&nbsp;you&nbsp;MUST&nbsp;use&nbsp;the&nbsp;&lt;a<br>
&nbsp;&nbsp;&nbsp;href=&quot;T:System.Runtime.InteropServices.StructLayoutAttribute&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;StructLayoutAttribute&lt;/a&gt;&nbsp;and&nbsp;specify&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;E:System.Runtime.InteropServices.LayoutKind&quot;&gt;LayoutKind&lt;/a&gt;&nbsp;value<br>
&nbsp;&nbsp;&nbsp;of&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Sequential&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Sequential&lt;/a&gt;&nbsp;or&nbsp;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;href=&quot;F:System.Runtime.InteropServices.LayoutKind.Explicit&quot;&gt;Explicit&lt;/a&gt;.<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Secondly,&nbsp;classes&nbsp;(again,&nbsp;by&nbsp;default)&nbsp;only&nbsp;have&nbsp;in-bound&nbsp;marshaling.<br>
&nbsp;&nbsp;&nbsp;That&nbsp;is,&nbsp;Step&nbsp;4&nbsp;(copying&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;representation&nbsp;back&nbsp;into&nbsp;<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;memory)&nbsp;is&nbsp;ommitted.&nbsp;&nbsp;If&nbsp;you&nbsp;need&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;to&nbsp;be&nbsp;copied<br>
&nbsp;&nbsp;&nbsp;back&nbsp;into&nbsp;managed&nbsp;memory,&nbsp;you&nbsp;must&nbsp;addorn&nbsp;the&nbsp;DllImport&nbsp;function<br>
&nbsp;&nbsp;&nbsp;declaration&nbsp;argument&nbsp;with&nbsp;an&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.OutAttribute&quot;&gt;Out&lt;/a&gt;&nbsp;attribute.<br>
&nbsp;&nbsp;&nbsp;You&nbsp;will&nbsp;also&nbsp;need&nbsp;to&nbsp;use&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.InAttribute&quot;&gt;In&lt;/a&gt;&nbsp;attribute&nbsp;if<br>
&nbsp;&nbsp;&nbsp;you&nbsp;want&nbsp;copy-in&nbsp;and&nbsp;copy-out&nbsp;behavior.&nbsp;&nbsp;To&nbsp;summarize:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Using&nbsp;[In]&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;not&nbsp;specifying&nbsp;any&nbsp;parameter<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attributes,&nbsp;and&nbsp;will&nbsp;skip&nbsp;Step&nbsp;4&nbsp;(copying&nbsp;unmanaged&nbsp;memory&nbsp;into<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;managed&nbsp;memory).&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Using&nbsp;[Out]&nbsp;will&nbsp;skip&nbsp;Step&nbsp;2&nbsp;(copying&nbsp;managed&nbsp;memory&nbsp;into&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memory).&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Use&nbsp;[In,&nbsp;Out]&nbsp;to&nbsp;both&nbsp;copy&nbsp;managed&nbsp;memory&nbsp;to&nbsp;unmanaged&nbsp;memory&nbsp;before<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;call,&nbsp;and&nbsp;then&nbsp;copy&nbsp;unmanaged&nbsp;memory&nbsp;back&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;managed&nbsp;memory&nbsp;after&nbsp;the&nbsp;function&nbsp;call.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;some&nbsp;circumstances,&nbsp;the&nbsp;marshaled&nbsp;copy&nbsp;can&nbsp;be&nbsp;omitted.&nbsp;&nbsp;The&nbsp;object<br>
&nbsp;&nbsp;&nbsp;will&nbsp;simply&nbsp;be&nbsp;pinned&nbsp;in&nbsp;memory&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;data<br>
&nbsp;&nbsp;&nbsp;passed&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;function.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;When&nbsp;can&nbsp;this&nbsp;actually&nbsp;occur?&nbsp;&nbsp;If&nbsp;this&nbsp;happened&nbsp;for&nbsp;any&nbsp;class&nbsp;with<br>
&nbsp;&nbsp;&nbsp;Sequential&nbsp;layout,&nbsp;you&nbsp;wouldn't&nbsp;need&nbsp;to&nbsp;specify&nbsp;the&nbsp;[Out]&nbsp;attribute,&nbsp;as&nbsp;the<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;code&nbsp;would&nbsp;see&nbsp;the&nbsp;actual&nbsp;object.&nbsp;&nbsp;Is&nbsp;there&nbsp;a&nbsp;specific&nbsp;set&nbsp;of<br>
&nbsp;&nbsp;&nbsp;circumstances&nbsp;for&nbsp;when&nbsp;this&nbsp;can&nbsp;occur?<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;This&nbsp;appears&nbsp;to&nbsp;happen&nbsp;with<br>
&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;(my&nbsp;tests&nbsp;don't&nbsp;require&nbsp;an&nbsp;[Out]&nbsp;to&nbsp;see&nbsp;changes&nbsp;made&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;by&nbsp;unmanaged&nbsp;code),&nbsp;but&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;example&nbsp;I&nbsp;can&nbsp;think<br>
&nbsp;&nbsp;&nbsp;of.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-structures&quot;&gt;Structure&nbsp;Marshaling&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;primary&nbsp;differences&nbsp;between&nbsp;classes&nbsp;and&nbsp;structures.<br>
&nbsp;&nbsp;&nbsp;First,&nbsp;structures&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;allocated&nbsp;on&nbsp;the&nbsp;heap;&nbsp;they&nbsp;can&nbsp;be<br>
&nbsp;&nbsp;&nbsp;allocated&nbsp;on&nbsp;the&nbsp;stack.&nbsp;&nbsp;Secondly,&nbsp;they&nbsp;use&nbsp;Sequential&nbsp;LayoutKind&nbsp;by&nbsp;<br>
&nbsp;&nbsp;&nbsp;default,&nbsp;so&nbsp;structure&nbsp;declarations&nbsp;do&nbsp;not&nbsp;need&nbsp;any&nbsp;additional&nbsp;attributes&nbsp;to&nbsp;<br>
&nbsp;&nbsp;&nbsp;use&nbsp;them&nbsp;with&nbsp;unmanaged&nbsp;code&nbsp;(assuming&nbsp;that&nbsp;the&nbsp;default&nbsp;sequential&nbsp;layout&nbsp;<br>
&nbsp;&nbsp;&nbsp;rules&nbsp;are&nbsp;correct&nbsp;for&nbsp;the&nbsp;unmanaged&nbsp;structure).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;These&nbsp;differences&nbsp;permit&nbsp;structures&nbsp;to&nbsp;be&nbsp;passed&nbsp;by-value&nbsp;to&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;functions,&nbsp;unlike&nbsp;classes.&nbsp;&nbsp;Additionally,&nbsp;since&nbsp;structures&nbsp;are&nbsp;typically<br>
&nbsp;&nbsp;&nbsp;located&nbsp;on&nbsp;the&nbsp;stack&nbsp;(unless&nbsp;they're&nbsp;boxed&nbsp;or&nbsp;part&nbsp;of&nbsp;a&nbsp;class&nbsp;instance),&nbsp;if<br>
&nbsp;&nbsp;&nbsp;you&nbsp;pass&nbsp;a&nbsp;structure&nbsp;to&nbsp;an&nbsp;unmanaged&nbsp;function&nbsp;by-reference,&nbsp;the&nbsp;structure<br>
&nbsp;&nbsp;&nbsp;will&nbsp;be&nbsp;passed&nbsp;directly&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;function,&nbsp;without&nbsp;an&nbsp;intermediate<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;memory&nbsp;copy.&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;you&nbsp;may&nbsp;not&nbsp;need&nbsp;to&nbsp;specify&nbsp;the&nbsp;Out<br>
&nbsp;&nbsp;&nbsp;attribute&nbsp;to&nbsp;see&nbsp;changes&nbsp;made&nbsp;by&nbsp;unmanaged&nbsp;code.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;cs-return-values&quot;&gt;Classes&nbsp;and&nbsp;Structures&nbsp;as&nbsp;Return&nbsp;Values&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;differences&nbsp;in&nbsp;allocation&nbsp;behavior&nbsp;between&nbsp;classes&nbsp;and&nbsp;structures<br>
&nbsp;&nbsp;&nbsp;also&nbsp;affect&nbsp;how&nbsp;they're&nbsp;handled&nbsp;as&nbsp;return&nbsp;values&nbsp;from&nbsp;functions.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Classes&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;the&nbsp;return&nbsp;value&nbsp;of&nbsp;a&nbsp;function&nbsp;when&nbsp;the&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;function&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;unmanaged&nbsp;structure.&nbsp;&nbsp;Classes&nbsp;cannot&nbsp;be<br>
&nbsp;&nbsp;&nbsp;used&nbsp;for&nbsp;by-value&nbsp;return&nbsp;values.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Structures&nbsp;can&nbsp;be&nbsp;used&nbsp;when&nbsp;the&nbsp;unmanaged&nbsp;function&nbsp;returns&nbsp;the&nbsp;structure<br>
&nbsp;&nbsp;&nbsp;by-value.&nbsp;&nbsp;It&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;return&nbsp;structures&nbsp;with&nbsp;&quot;ref&quot;&nbsp;or&nbsp;&quot;out&quot;,&nbsp;so&nbsp;if<br>
&nbsp;&nbsp;&nbsp;an&nbsp;unmanaged&nbsp;function&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;a&nbsp;structure,&nbsp;System.IntPtr&nbsp;must<br>
&nbsp;&nbsp;&nbsp;be&nbsp;used&nbsp;for&nbsp;&quot;safe&quot;&nbsp;code,&nbsp;or&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;structure&nbsp;can&nbsp;be&nbsp;used&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;code.&nbsp;&nbsp;If&nbsp;System.IntPtr&nbsp;is&nbsp;used&nbsp;as&nbsp;the&nbsp;return&nbsp;type,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.PtrToStructure&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.PtrToStructure&lt;/a&gt;&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;unmanaged&nbsp;pointer<br>
&nbsp;&nbsp;&nbsp;into&nbsp;a&nbsp;managed&nbsp;structure.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Memory&nbsp;management&nbsp;is&nbsp;also&nbsp;heavily&nbsp;involved.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h5&nbsp;id=&quot;cs-retval-memory-mgmt&quot;&gt;Memory&nbsp;Management&lt;/h5&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;It's&nbsp;easy&nbsp;to&nbsp;skim&nbsp;over&nbsp;memory&nbsp;management&nbsp;for&nbsp;most&nbsp;of&nbsp;P/Invoke&nbsp;and<br>
&nbsp;&nbsp;&nbsp;marshaling,&nbsp;but&nbsp;for&nbsp;return&nbsp;values&nbsp;the&nbsp;CLI&nbsp;implements&nbsp;some&nbsp;default&nbsp;handling<br>
&nbsp;&nbsp;&nbsp;which&nbsp;must&nbsp;be&nbsp;considered.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;CLI&nbsp;assumes&nbsp;that,&nbsp;under&nbsp;certain&nbsp;circumstances,&nbsp;the&nbsp;CLI&nbsp;runtime&nbsp;is<br>
&nbsp;&nbsp;&nbsp;responsible&nbsp;for&nbsp;freeing&nbsp;memory&nbsp;allocated&nbsp;by&nbsp;unmanaged&nbsp;code.&nbsp;&nbsp;Return&nbsp;values<br>
&nbsp;&nbsp;&nbsp;is&nbsp;one&nbsp;of&nbsp;those&nbsp;circumstances,&nbsp;causing&nbsp;the&nbsp;return&nbsp;value&nbsp;to&nbsp;be&nbsp;a&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;boundary&nbsp;for&nbsp;control&nbsp;of&nbsp;memory&nbsp;(de)allocation.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;CLI&nbsp;assumes&nbsp;that&nbsp;all&nbsp;memory&nbsp;that&nbsp;is&nbsp;passed&nbsp;between&nbsp;the&nbsp;CLI/unmanaged<br>
&nbsp;&nbsp;&nbsp;code&nbsp;boundary&nbsp;is&nbsp;allocated&nbsp;via&nbsp;a&nbsp;common&nbsp;memory&nbsp;allocator.&nbsp;&nbsp;The&nbsp;developer<br>
&nbsp;&nbsp;&nbsp;does&nbsp;not&nbsp;get&nbsp;a&nbsp;choice&nbsp;in&nbsp;which&nbsp;memory&nbsp;allocator&nbsp;is&nbsp;used.&nbsp;&nbsp;For&nbsp;managed&nbsp;code,<br>
&nbsp;&nbsp;&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.AllocCoTaskMem&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.AllocCoTaskMem&lt;/a&gt;&nbsp;method&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;allocate&nbsp;memory,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.FreeCoTaskMem&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.FreeCoTaskMem&lt;/a&gt;&nbsp;is&nbsp;used&nbsp;to&nbsp;free&nbsp;the&nbsp;memory&nbsp;allocated&nbsp;by<br>
&nbsp;&nbsp;&nbsp;Marshal.AllocCoTaskMem,&nbsp;and&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;M:System.Runtime.InteropServices.Marshal.ReAllocCoTaskMem&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;Marshal.ReAllocCoTaskMem&lt;/a&gt;&nbsp;is&nbsp;used&nbsp;to&nbsp;resize&nbsp;a&nbsp;memory&nbsp;region&nbsp;originally<br>
&nbsp;&nbsp;&nbsp;allocated&nbsp;by&nbsp;Marshal.AllocCoTaskMem.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Since&nbsp;classes&nbsp;are&nbsp;passed&nbsp;by&nbsp;reference,&nbsp;a&nbsp;pointer&nbsp;is&nbsp;returned,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;runtime&nbsp;assumes&nbsp;that&nbsp;it&nbsp;must&nbsp;free&nbsp;this&nbsp;memory&nbsp;to&nbsp;avoid&nbsp;a&nbsp;memory&nbsp;leak.&nbsp;&nbsp;The<br>
&nbsp;&nbsp;&nbsp;chain&nbsp;of&nbsp;events&nbsp;is&nbsp;thus:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ol&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;Managed&nbsp;code&nbsp;invokes&nbsp;unmanaged&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unmanaged&nbsp;structure&nbsp;in&nbsp;unmanaged&nbsp;memory.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;An&nbsp;instance&nbsp;of&nbsp;the&nbsp;appropriate&nbsp;managed&nbsp;class&nbsp;is&nbsp;instantiated,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;marshaled&nbsp;into&nbsp;the&nbsp;managed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class.&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;The&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;freed&nbsp;by&nbsp;the&nbsp;runtime&nbsp;&quot;as&nbsp;if&quot;&nbsp;by&nbsp;invoking<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Marshal.FreeCoTaskMem().&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ol&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;How&nbsp;is&nbsp;Marshal.AllocCoTaskMem,&nbsp;Marshal.ReAllocCoTaskMem,&nbsp;and<br>
&nbsp;&nbsp;&nbsp;Marshal.FreeCoTaskMem&nbsp;implemented?&nbsp;&nbsp;That's&nbsp;platform-dependent.&nbsp;&nbsp;(So&nbsp;much<br>
&nbsp;&nbsp;&nbsp;for&nbsp;portable,&nbsp;platform-dependent&nbsp;code.)&nbsp;&nbsp;Under&nbsp;Windows,&nbsp;the&nbsp;COM&nbsp;Task&nbsp;Memory<br>
&nbsp;&nbsp;&nbsp;allocator&nbsp;is&nbsp;used&nbsp;(via&nbsp;CoTaskMemAlloc(),&nbsp;CoTaskMemReAlloc(),&nbsp;and&nbsp;<br>
&nbsp;&nbsp;&nbsp;CoTaskMemFree()).&nbsp;&nbsp;Under&nbsp;Unix,&nbsp;the&nbsp;C&nbsp;library&nbsp;memory&nbsp;allocation&nbsp;functions&nbsp;are<br>
&nbsp;&nbsp;&nbsp;used&nbsp;(malloc(3),&nbsp;realloc(3),&nbsp;and&nbsp;free(3)).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;What&nbsp;do&nbsp;you&nbsp;do&nbsp;if&nbsp;you&nbsp;don't&nbsp;want&nbsp;the&nbsp;runtime&nbsp;to&nbsp;free&nbsp;the&nbsp;memory?&nbsp;&nbsp;Don't<br>
&nbsp;&nbsp;&nbsp;return&nbsp;a&nbsp;class.&nbsp;&nbsp;Instead,&nbsp;return&nbsp;an&nbsp;IntPtr&nbsp;(the&nbsp;moral&nbsp;equivalent&nbsp;of&nbsp;a&nbsp;C<br>
&nbsp;&nbsp;&nbsp;&lt;tt&gt;void*&lt;/tt&gt;&nbsp;pointer),&nbsp;and&nbsp;then&nbsp;use&nbsp;the&nbsp;Marshal&nbsp;class&nbsp;methods&nbsp;to<br>
&nbsp;&nbsp;&nbsp;manipulate&nbsp;that&nbsp;pointer.&nbsp;&nbsp;This&nbsp;works&nbsp;for&nbsp;strings,&nbsp;and&nbsp;structures,&nbsp;but&nbsp;it<br>
&nbsp;&nbsp;&nbsp;doesn't&nbsp;appear&nbsp;to&nbsp;work&nbsp;for&nbsp;classes,&nbsp;as&nbsp;there&nbsp;is&nbsp;no&nbsp;PtrToClass<br>
&nbsp;&nbsp;&nbsp;method,&nbsp;so&nbsp;this&nbsp;technique&nbsp;is&nbsp;limited&nbsp;to&nbsp;strings&nbsp;and&nbsp;managed&nbsp;structures.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-class-struct-summary&quot;&gt;Summary&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;It's&nbsp;always&nbsp;easier&nbsp;to&nbsp;show&nbsp;the&nbsp;code,&nbsp;so...&nbsp;&nbsp;Given&nbsp;the&nbsp;following<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;code&nbsp;declarations:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-unmanaged-code&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;unmanaged&nbsp;code&nbsp;declarations&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByValue&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByReferenceIn&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByReferenceOut&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*s);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;PassByReferenceInOut&nbsp;(struct&nbsp;UnmanagedStruct&nbsp;*s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct&nbsp;ReturnByValue&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedStruct*&nbsp;ReturnByReference&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;class&nbsp;wrapper&nbsp;could&nbsp;be:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-class-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;note:&nbsp;sequential&nbsp;layout&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout&nbsp;(LayoutKind.Sequential)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ClassWrapper&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;n;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;cannot&nbsp;wrap&nbsp;function&nbsp;PassByValue&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceIn&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceIn&nbsp;(ClassWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceOut&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceOut&nbsp;([Out]&nbsp;ClassWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceInOut&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceInOut&nbsp;([In,&nbsp;Out]&nbsp;ClassWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;cannot&nbsp;wrap&nbsp;function&nbsp;ReturnByValue&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;ReturnByReference&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;ClassWrapper&nbsp;ReturnByReference&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;note:&nbsp;this&nbsp;causes&nbsp;returned&nbsp;pointer&nbsp;to&nbsp;be&nbsp;freed&nbsp;by&nbsp;runtime&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;While&nbsp;the&nbsp;structure&nbsp;wrapper&nbsp;could&nbsp;be:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-struct-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;StructWrapper&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;n;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByValue&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByValue&nbsp;(StructWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceIn&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceIn&nbsp;(ref&nbsp;StructWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceOut&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceOut&nbsp;(out&nbsp;StructWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;PassByReferenceInOut&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;PassByReferenceOut&nbsp;(ref&nbsp;StructWrapper&nbsp;s);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;ReturnByValue&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;StructWrapper&nbsp;ReturnByValue&nbsp;();<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;ReturnByReference:&nbsp;CLS-compliant&nbsp;way&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;,&nbsp;EntryPoint=&quot;ReturnByReference&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;ReturnByReferenceCLS&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;note:&nbsp;this&nbsp;DOES&nbsp;NOT&nbsp;cause&nbsp;returned&nbsp;pointer&nbsp;to&nbsp;be&nbsp;freed&nbsp;by&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime,&nbsp;so&nbsp;it's&nbsp;not&nbsp;identical&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClassWrapper.ReturnByReference&nbsp;*/<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;ReturnByReference:&nbsp;&quot;unsafe&quot;&nbsp;way&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;mylib&quot;,&nbsp;EntryPoint=&quot;ReturnByReference&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;StructWrapper*&nbsp;ReturnByReferenceUnsafe&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;note:&nbsp;this&nbsp;DOES&nbsp;NOT&nbsp;cause&nbsp;returned&nbsp;pointer&nbsp;to&nbsp;be&nbsp;freed&nbsp;by&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runtime,&nbsp;so&nbsp;it's&nbsp;not&nbsp;identical&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClassWrapper.ReturnByReference&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;marshaling-class-struct-members&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Marshaling&nbsp;Class&nbsp;and&nbsp;Structure&nbsp;Members&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Aside&nbsp;from&nbsp;the&nbsp;major&nbsp;differences&nbsp;between&nbsp;classes&nbsp;and&nbsp;structures&nbsp;outlined<br>
&nbsp;&nbsp;&nbsp;above,&nbsp;the&nbsp;members&nbsp;of&nbsp;classes&nbsp;and&nbsp;structures&nbsp;are&nbsp;marshaled&nbsp;identically.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;general&nbsp;rule&nbsp;of&nbsp;advice&nbsp;is&nbsp;this:&nbsp;never&nbsp;pass&nbsp;classes&nbsp;or&nbsp;structures<br>
&nbsp;&nbsp;&nbsp;containing&nbsp;members&nbsp;of&nbsp;reference&nbsp;type&nbsp;(classes)&nbsp;to&nbsp;unmanaged&nbsp;code.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;is&nbsp;because&nbsp;unmanaged&nbsp;code&nbsp;can't&nbsp;do&nbsp;anything&nbsp;safely&nbsp;with&nbsp;the&nbsp;unmanaged&nbsp;<br>
&nbsp;&nbsp;&nbsp;reference&nbsp;(pointer),&nbsp;and&nbsp;the&nbsp;CLI&nbsp;runtime&nbsp;doesn't&nbsp;do&nbsp;a&nbsp;&quot;deep&nbsp;marshal&quot;<br>
&nbsp;&nbsp;&nbsp;(marshal&nbsp;members&nbsp;of&nbsp;marshaled&nbsp;classes,&nbsp;and&nbsp;their&nbsp;members,&nbsp;ad<br>
&nbsp;&nbsp;&nbsp;infinitum).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;immediate&nbsp;net&nbsp;effect&nbsp;of&nbsp;this&nbsp;is&nbsp;that&nbsp;you&nbsp;can't&nbsp;have&nbsp;array<br>
&nbsp;&nbsp;&nbsp;members&nbsp;of&nbsp;marshaled&nbsp;classes.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Furthermore,&nbsp;the&nbsp;default&nbsp;string&nbsp;marshaling&nbsp;is&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#controlling-string-marshaling&quot;&gt;platform&nbsp;default&lt;/a&gt;,&nbsp;though&nbsp;this<br>
&nbsp;&nbsp;&nbsp;can&nbsp;be&nbsp;changed&nbsp;by&nbsp;setting&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.StructLayoutAttribute.CharSet&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;StructLayoutAttribute.CharSet&lt;/a&gt;&nbsp;field,&nbsp;which&nbsp;defaults&nbsp;to&nbsp;CharSet.Auto.<br>
&nbsp;&nbsp;&nbsp;Alternatively,&nbsp;you&nbsp;can&nbsp;addorn&nbsp;string&nbsp;members&nbsp;with&nbsp;the&nbsp;MarshalAs&nbsp;attribute&nbsp;<br>
&nbsp;&nbsp;&nbsp;to&nbsp;specify&nbsp;what&nbsp;kind&nbsp;of&nbsp;string&nbsp;they&nbsp;are.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Inline&nbsp;arrays&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;using&nbsp;a&nbsp;MarshalAs&nbsp;attribute&nbsp;with&nbsp;<br>
&nbsp;&nbsp;&nbsp;UnmanagedType.ByValArray&nbsp;and&nbsp;specifying&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;F:System.Runtime.InteropServices.MarshalAsAttribute.SizeConst&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;MarshalAsAttribute.SizeConst&lt;/a&gt;&nbsp;field&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;array&nbsp;to<br>
&nbsp;&nbsp;&nbsp;marshal.&lt;/a&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;However,&nbsp;the&nbsp;runtime&nbsp;doesn't&nbsp;automatically&nbsp;allocate&nbsp;arrays&nbsp;specified&nbsp;as<br>
&nbsp;&nbsp;&nbsp;UnmanagedType.ByValArray.&nbsp;&nbsp;The&nbsp;programmer&nbsp;is&nbsp;still&nbsp;responsible&nbsp;for<br>
&nbsp;&nbsp;&nbsp;allocating&nbsp;the&nbsp;managed&nbsp;array.&nbsp;&nbsp;See&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;#marshaling-members-summary&quot;&gt;summary&lt;/a&gt;&nbsp;for&nbsp;more&nbsp;information.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-unions&quot;&gt;Unions&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;A&nbsp;C&nbsp;union&nbsp;(in&nbsp;which&nbsp;multiple&nbsp;members&nbsp;share&nbsp;the&nbsp;same&nbsp;offset&nbsp;into&nbsp;a<br>
&nbsp;&nbsp;&nbsp;structure)&nbsp;can&nbsp;be&nbsp;simulated&nbsp;by&nbsp;using&nbsp;the&nbsp;FieldOffset&nbsp;attribute&nbsp;and<br>
&nbsp;&nbsp;&nbsp;specifying&nbsp;the&nbsp;same&nbsp;offset&nbsp;for&nbsp;the&nbsp;union&nbsp;members.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-members-summary&quot;&gt;Summary&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Again,&nbsp;example&nbsp;native&nbsp;code...&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-class-struct-members-native&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;original&nbsp;code&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;UnmanagedInformation&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;num;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;array[32];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int64_t&nbsp;addr;&nbsp;&nbsp;/*&nbsp;from&nbsp;&amp;lt;stdint.h&amp;gt;,&nbsp;C99&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double&nbsp;other;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;stuff;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;And&nbsp;the&nbsp;possible&nbsp;corresponding&nbsp;managed&nbsp;code:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-class-struct-members-managed&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;managed&nbsp;representation&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout&nbsp;(LayoutKind.Explicit,&nbsp;CharSet=CharSet.Ansi)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;ManagedInformation&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset&nbsp;(0)]&nbsp;int&nbsp;num;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset&nbsp;(4)]&nbsp;string&nbsp;str;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset&nbsp;(8),&nbsp;MarshalAs&nbsp;(UnmanagedType.ByValArray,&nbsp;SizeConst=32)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int[]&nbsp;array[];<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;union&nbsp;members&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset&nbsp;(136)]&nbsp;long&nbsp;stuff_addr;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset&nbsp;(136)]&nbsp;double&nbsp;stuff_other;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Note&nbsp;that&nbsp;this&nbsp;isn't&nbsp;an&nbsp;exact&nbsp;match&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;code.&nbsp;&nbsp;This<br>
&nbsp;&nbsp;&nbsp;structure&nbsp;must&nbsp;be&nbsp;built&nbsp;in&nbsp;two&nbsp;phases&nbsp;to&nbsp;match&nbsp;the&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;representation:&nbsp;(1)&nbsp;create&nbsp;the&nbsp;structure,&nbsp;and&nbsp;(2)&nbsp;allocate&nbsp;memory&nbsp;for&nbsp;<br>
&nbsp;&nbsp;&nbsp;ManagedInformation.array.&nbsp;&nbsp;For&nbsp;example:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;marshal-use-embedded-arrays&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ManagedInformation&nbsp;info&nbsp;=&nbsp;new&nbsp;ManagedInformation&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info.array&nbsp;=&nbsp;new&nbsp;int[32];<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;include&nbsp;MSDN&nbsp;examples&nbsp;using&nbsp;the&nbsp;more&nbsp;esotoric&nbsp;MarshalAs&nbsp;fields,<br>
&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;SizeParamIndex,&nbsp;ArraySubType,&nbsp;MarshalType,&nbsp;etc.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconmarshalingdatawithplatforminvoke.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Marshaling&nbsp;Data&nbsp;with&nbsp;Platform&nbsp;Invoke&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconarrayssample.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Arrays&nbsp;Sample&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;custom-marshal&quot;&gt;Custom&nbsp;Marshaling&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;TODO:&nbsp;custom&nbsp;marshaling...&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemruntimeinteropservicesicustommarshalerclasstopic.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;ICustomMarshal&nbsp;Interface&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;avoiding-marshaling&quot;&gt;Avoiding&nbsp;Marshaling&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Marshaling&nbsp;is&nbsp;no&nbsp;panacea,&nbsp;as&nbsp;marshaling&nbsp;implies&nbsp;copying&nbsp;data.<br>
&nbsp;&nbsp;&nbsp;Marshaling&nbsp;may&nbsp;be&nbsp;problematic&nbsp;because&nbsp;the&nbsp;data&nbsp;translation&nbsp;is&nbsp;a&nbsp;complex,<br>
&nbsp;&nbsp;&nbsp;time-consuming&nbsp;process.&nbsp;&nbsp;Alternativly,&nbsp;it&nbsp;may&nbsp;be&nbsp;problematic&nbsp;<br>
&nbsp;&nbsp;&nbsp;because&nbsp;it&nbsp;isn't&nbsp;possible&nbsp;to&nbsp;copy&nbsp;the&nbsp;data,&nbsp;as&nbsp;the&nbsp;data&nbsp;isn't&nbsp;known&nbsp;or&nbsp;is&nbsp;<br>
&nbsp;&nbsp;&nbsp;likely&nbsp;to&nbsp;change.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;An&nbsp;example&nbsp;of&nbsp;the&nbsp;latter&nbsp;would&nbsp;be&nbsp;the&nbsp;GTK+&nbsp;libraries.&nbsp;&nbsp;GTK+&nbsp;is&nbsp;an<br>
&nbsp;&nbsp;&nbsp;object-oriented&nbsp;toolkit&nbsp;written&nbsp;in&nbsp;C.&nbsp;&nbsp;As&nbsp;with&nbsp;all&nbsp;object-oriented<br>
&nbsp;&nbsp;&nbsp;libraries,&nbsp;there&nbsp;can&nbsp;be&nbsp;an&nbsp;unknown&nbsp;number&nbsp;of&nbsp;derived&nbsp;classes,&nbsp;each&nbsp;of&nbsp;which<br>
&nbsp;&nbsp;&nbsp;having&nbsp;a&nbsp;different&nbsp;class&nbsp;size.&nbsp;&nbsp;Furthermore,&nbsp;class&nbsp;instances&nbsp;are&nbsp;typically<br>
&nbsp;&nbsp;&nbsp;accessed&nbsp;through&nbsp;pointers.&nbsp;&nbsp;As&nbsp;such,&nbsp;marshaling&nbsp;the&nbsp;entire&nbsp;class&nbsp;between<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;and&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;not&nbsp;an&nbsp;option,&nbsp;as&nbsp;a&nbsp;copy&nbsp;isn't&nbsp;desired,<br>
&nbsp;&nbsp;&nbsp;access&nbsp;to&nbsp;the&nbsp;same&nbsp;instance&nbsp;is.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Another&nbsp;example&nbsp;is&nbsp;when&nbsp;using&nbsp;&quot;opaque&quot;&nbsp;data&nbsp;types;&nbsp;that&nbsp;is,&nbsp;types<br>
&nbsp;&nbsp;&nbsp;through&nbsp;which&nbsp;interaction&nbsp;is&nbsp;solely&nbsp;through&nbsp;pointers,&nbsp;and&nbsp;nothing&nbsp;about&nbsp;the<br>
&nbsp;&nbsp;&nbsp;internals&nbsp;of&nbsp;the&nbsp;type&nbsp;is&nbsp;public.&nbsp;&nbsp;This&nbsp;describes&nbsp;a&nbsp;large&nbsp;portion&nbsp;of&nbsp;the<br>
&nbsp;&nbsp;&nbsp;Win32&nbsp;API,&nbsp;where&nbsp;HANDLE&nbsp;is&nbsp;used&nbsp;to&nbsp;represent&nbsp;most&nbsp;objects.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;There&nbsp;are&nbsp;two&nbsp;ways&nbsp;to&nbsp;handle&nbsp;this&nbsp;in&nbsp;C#:&nbsp;the&nbsp;&quot;type-safe&quot;&nbsp;way,&nbsp;which<br>
&nbsp;&nbsp;&nbsp;involves&nbsp;using&nbsp;pointers&nbsp;and&nbsp;the&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;language&nbsp;features,&nbsp;and&nbsp;the<br>
&nbsp;&nbsp;&nbsp;CLS-compliant&nbsp;way,&nbsp;which&nbsp;uses&nbsp;System.IntPtr&nbsp;to&nbsp;stand&nbsp;in&nbsp;for&nbsp;a&nbsp;void<br>
&nbsp;&nbsp;&nbsp;pointer.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;effect,&nbsp;the&nbsp;separation&nbsp;between&nbsp;managed&nbsp;and&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;made<br>
&nbsp;&nbsp;&nbsp;explicit.&nbsp;&nbsp;Managed&nbsp;memory&nbsp;remains&nbsp;typesafe,&nbsp;while&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;not<br>
&nbsp;&nbsp;&nbsp;(since&nbsp;&lt;a&nbsp;href=&quot;T:System.IntPtr&quot;&gt;System.IntPtr&lt;/a&gt;&nbsp;is&nbsp;used&nbsp;to&nbsp;point&nbsp;into&nbsp;<br>
&nbsp;&nbsp;&nbsp;unmanaged&nbsp;memory,&nbsp;and&nbsp;there&nbsp;is&nbsp;no&nbsp;way&nbsp;to&nbsp;ensure&nbsp;the&nbsp;actual&nbsp;type&nbsp;of&nbsp;what&nbsp;<br>
&nbsp;&nbsp;&nbsp;the&nbsp;System.IntPtr&nbsp;refers&nbsp;to).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Be&nbsp;warned&nbsp;that&nbsp;this&nbsp;may&nbsp;not&nbsp;be&nbsp;safe,&nbsp;if&nbsp;the&nbsp;&quot;unmanaged&quot;&nbsp;memory&nbsp;is&nbsp;itself<br>
&nbsp;&nbsp;&nbsp;garbage&nbsp;collected.&nbsp;&nbsp;This&nbsp;may&nbsp;be&nbsp;the&nbsp;case&nbsp;if&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;handled<br>
&nbsp;&nbsp;&nbsp;by&nbsp;a&nbsp;different&nbsp;runtime&nbsp;system&nbsp;(Python,&nbsp;Ruby,&nbsp;Lisp,&nbsp;etc.)&nbsp;or&nbsp;a&nbsp;garbage<br>
&nbsp;&nbsp;&nbsp;collector&nbsp;is&nbsp;being&nbsp;used&nbsp;(Boehm).&nbsp;&nbsp;If&nbsp;the&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;garbage<br>
&nbsp;&nbsp;&nbsp;collected,&nbsp;then&nbsp;the&nbsp;System.IntPtr&nbsp;won't&nbsp;be&nbsp;updated&nbsp;when&nbsp;unmanaged&nbsp;memory<br>
&nbsp;&nbsp;&nbsp;undergoes&nbsp;a&nbsp;garbage&nbsp;collection,&nbsp;resulting&nbsp;in&nbsp;memory&nbsp;corruption.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;For&nbsp;example,&nbsp;given&nbsp;the&nbsp;unmanaged&nbsp;API:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-unmanaged-code&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typedef&nbsp;void*&nbsp;HANDLE;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;CreateItem&nbsp;(HANDLE&nbsp;*item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;DestroyItem&nbsp;(HANDLE&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;GetInfo&nbsp;(HANDLE&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;&quot;type-safe&quot;&nbsp;C#&nbsp;wrapper&nbsp;(using&nbsp;&quot;unsafe&quot;&nbsp;code)&nbsp;is:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-unsafe-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;Item&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;bool&nbsp;CreateItem&nbsp;(out&nbsp;Item*&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;void&nbsp;DestroyItem&nbsp;(Item*&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;extern&nbsp;int&nbsp;GetInfo&nbsp;(Item*&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ExampleUsage&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;void&nbsp;Main&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item*&nbsp;item&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.CreateItem&nbsp;(out&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n&nbsp;=&nbsp;Item.GetInfo&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Console.WriteLine&nbsp;(&quot;item&nbsp;count:&nbsp;{0}&quot;,&nbsp;n.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.DestroyItem&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;is&nbsp;&quot;type-safe&quot;&nbsp;in&nbsp;that&nbsp;you&nbsp;can't&nbsp;pass&nbsp;arbitrary&nbsp;memory&nbsp;locations&nbsp;to<br>
&nbsp;&nbsp;&nbsp;the&nbsp;static&nbsp;Item&nbsp;functions,&nbsp;you&nbsp;must&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;an&nbsp;Item&nbsp;structure.<br>
&nbsp;&nbsp;&nbsp;This&nbsp;isn't&nbsp;a&nbsp;strict&nbsp;amount&nbsp;of&nbsp;type&nbsp;safety,&nbsp;but&nbsp;it&nbsp;is&nbsp;likely&nbsp;to&nbsp;minimize<br>
&nbsp;&nbsp;&nbsp;accidental&nbsp;memory&nbsp;corruption.&nbsp;&nbsp;It's&nbsp;biggest&nbsp;problem&nbsp;is&nbsp;that&nbsp;it&nbsp;uses<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;code,&nbsp;and&nbsp;thus&nbsp;may&nbsp;not&nbsp;be&nbsp;usable&nbsp;from&nbsp;other&nbsp;.NET&nbsp;languages,&nbsp;such<br>
&nbsp;&nbsp;&nbsp;as&nbsp;Visual&nbsp;Basic&nbsp;.NET&nbsp;and&nbsp;JavaScript.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;The&nbsp;CLS&nbsp;compliant&nbsp;version&nbsp;uses&nbsp;System.IntPtr&nbsp;to&nbsp;refer&nbsp;to&nbsp;unmanaged<br>
&nbsp;&nbsp;&nbsp;memory.&nbsp;&nbsp;This&nbsp;is&nbsp;similar&nbsp;to&nbsp;what&nbsp;the&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;T:System.Runtime.InteropServices.Marshal&quot;&gt;Marshal&lt;/a&gt;&nbsp;class&nbsp;does<br>
&nbsp;&nbsp;&nbsp;to&nbsp;interoperate&nbsp;with&nbsp;unmanaged&nbsp;memory.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;no-marshal-IntPtr-wrapper&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Item&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;bool&nbsp;CreateItem&nbsp;(out&nbsp;System.IntPtr&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;void&nbsp;DestroyItem&nbsp;(System.IntPtr&nbsp;item);<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[DllImport&nbsp;(&quot;library&quot;)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;extern&nbsp;int&nbsp;GetInfo&nbsp;(System.IntPtr&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;ExampleUsage&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;unsafe&nbsp;void&nbsp;Main&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.IntPtr&nbsp;item&nbsp;=&nbsp;null;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.CreateItem&nbsp;(out&nbsp;item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n&nbsp;=&nbsp;Item.GetInfo&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.Console.WriteLine&nbsp;(&quot;item&nbsp;count:&nbsp;{0}&quot;,&nbsp;n.ToString());<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Item.DestroyItem&nbsp;(item);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;is&nbsp;&quot;unsafe&quot;&nbsp;in&nbsp;that&nbsp;it&nbsp;is<br>
&nbsp;&nbsp;&nbsp;easier&nbsp;to&nbsp;accidently&nbsp;mis-use&nbsp;pointers.&nbsp;&nbsp;For&nbsp;example,&nbsp;if&nbsp;you're&nbsp;using&nbsp;two<br>
&nbsp;&nbsp;&nbsp;different&nbsp;libraries&nbsp;and&nbsp;wrapping&nbsp;them&nbsp;using&nbsp;System.IntPtr,&nbsp;it&nbsp;is&nbsp;possible<br>
&nbsp;&nbsp;&nbsp;to&nbsp;pass&nbsp;an&nbsp;object&nbsp;allocated&nbsp;from&nbsp;one&nbsp;library&nbsp;to&nbsp;a&nbsp;function&nbsp;exported&nbsp;by&nbsp;the<br>
&nbsp;&nbsp;&nbsp;other&nbsp;library,&nbsp;and&nbsp;the&nbsp;CLI&nbsp;Runtime&nbsp;will&nbsp;not&nbsp;catch&nbsp;this&nbsp;error,&nbsp;while&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;code&nbsp;would&nbsp;catch&nbsp;this&nbsp;error.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;However,&nbsp;this&nbsp;isn't&nbsp;normally&nbsp;considered&nbsp;a&nbsp;problem,&nbsp;however,&nbsp;as&nbsp;most<br>
&nbsp;&nbsp;&nbsp;managed&nbsp;code&nbsp;shouldn't&nbsp;interact&nbsp;with&nbsp;P/Invoke&nbsp;code,&nbsp;but&nbsp;should&nbsp;instead<br>
&nbsp;&nbsp;&nbsp;interact&nbsp;with&nbsp;managed&nbsp;wrappers&nbsp;for&nbsp;the&nbsp;unmanaged&nbsp;code,&nbsp;which&nbsp;can&nbsp;provide&nbsp;a<br>
&nbsp;&nbsp;&nbsp;more&nbsp;natural&nbsp;interface&nbsp;to&nbsp;managed&nbsp;clients.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;marshaling-arrays&quot;&gt;Arrays&nbsp;Embedded&nbsp;Within&nbsp;Structures&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;might&nbsp;be&nbsp;of&nbsp;use.&nbsp;&nbsp;From&nbsp;David&nbsp;Jesk&nbsp;<br>
&nbsp;&nbsp;&nbsp;(&lt;a&nbsp;href=&quot;http://www.chat.net/~jeske/&quot;&gt;http://www.chat.net/~jeske/&lt;/a&gt;):<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;time&nbsp;I&nbsp;have&nbsp;some&nbsp;PInvoke&nbsp;information&nbsp;to&nbsp;share,&nbsp;so&nbsp;that&nbsp;when<br>
&nbsp;&nbsp;&nbsp;someone&nbsp;else&nbsp;runs&nbsp;into&nbsp;this&nbsp;issue&nbsp;they&nbsp;can&nbsp;see&nbsp;what&nbsp;I've&nbsp;done.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;my&nbsp;ClearSilver&nbsp;(www.clearsilver.net,&nbsp;an&nbsp;HTML&nbsp;template&nbsp;system)&nbsp;C#<br>
&nbsp;&nbsp;&nbsp;wrapper,&nbsp;I&nbsp;wanted&nbsp;to&nbsp;access&nbsp;this&nbsp;C-struct:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typedef&nbsp;struct&nbsp;_neo_err<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;desc[256];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const&nbsp;char&nbsp;*func;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;lineno;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;internal&nbsp;use&nbsp;only&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;_neo_err&nbsp;*next;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;NEOERR;<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;My&nbsp;philosophy&nbsp;of&nbsp;using&nbsp;unsafe&nbsp;struct&nbsp;pointers,&nbsp;and&nbsp;just&nbsp;accessing&nbsp;the<br>
&nbsp;&nbsp;&nbsp;struct&nbsp;out&nbsp;in&nbsp;unmanaged&nbsp;memory&nbsp;is&nbsp;great,&nbsp;and&nbsp;it's&nbsp;exactly&nbsp;what&nbsp;I&nbsp;want<br>
&nbsp;&nbsp;&nbsp;to&nbsp;do.&nbsp;However,&nbsp;handling&nbsp;&quot;char&nbsp;dest[256]&quot;&nbsp;is&nbsp;not&nbsp;straightforward.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;In&nbsp;C#&nbsp;arrays&nbsp;are&nbsp;reference&nbsp;types.&nbsp;Using&nbsp;one&nbsp;makes&nbsp;the&nbsp;struct&nbsp;a&nbsp;managed<br>
&nbsp;&nbsp;&nbsp;type,&nbsp;and&nbsp;I&nbsp;can't&nbsp;put&nbsp;the&nbsp;array&nbsp;size&nbsp;in.&nbsp;The&nbsp;following&nbsp;is&nbsp;conceptually<br>
&nbsp;&nbsp;&nbsp;what&nbsp;I&nbsp;want&nbsp;to&nbsp;do,&nbsp;however,&nbsp;it's&nbsp;obviously&nbsp;invalid:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout(LayoutKind.Sequential)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsafe&nbsp;struct&nbsp;NEOERR&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;byte[256]&nbsp;desc;&nbsp;&nbsp;//&nbsp;this&nbsp;is&nbsp;invalid,&nbsp;can't&nbsp;contain&nbsp;size<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;const&nbsp;byte&nbsp;*file;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;const&nbsp;byte&nbsp;*func;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;int&nbsp;lineno;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;internal&nbsp;use&nbsp;only&nbsp;*/<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;NEOERR&nbsp;*next;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;dosn't&nbsp;work&nbsp;either:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[MarshalAs&nbsp;(UnmanagedType.LPStr,&nbsp;SizeConst=256)]&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;string&nbsp;desc;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Because&nbsp;in&nbsp;this&nbsp;case,&nbsp;I&nbsp;don't&nbsp;want&nbsp;to&nbsp;marshal&nbsp;the&nbsp;data.&nbsp;I&nbsp;just&nbsp;want&nbsp;to<br>
&nbsp;&nbsp;&nbsp;talk&nbsp;to&nbsp;it&nbsp;in&nbsp;place.&nbsp;The&nbsp;solution&nbsp;I&nbsp;could&nbsp;come&nbsp;up&nbsp;with&nbsp;is&nbsp;this:&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;monodoc:example&nbsp;id=&quot;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[StructLayout(LayoutKind.Explicit)]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsafe&nbsp;struct&nbsp;NEOERR&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(0)]&nbsp;public&nbsp;int&nbsp;error;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(4)]&nbsp;public&nbsp;int&nbsp;err_stack;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(8)]&nbsp;public&nbsp;int&nbsp;flags;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;public&nbsp;byte[256]&nbsp;dest;&nbsp;&nbsp;//&nbsp;not&nbsp;representable<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(12)]&nbsp;public&nbsp;byte&nbsp;dest_first_char;&nbsp;//&nbsp;use&nbsp;this&nbsp;as&nbsp;an&nbsp;address??<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(268)]&nbsp;public&nbsp;byte&nbsp;*file;&nbsp;//&nbsp;const<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(272)]&nbsp;public&nbsp;byte&nbsp;*func;&nbsp;//&nbsp;const<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[FieldOffset(276)]&nbsp;public&nbsp;int&nbsp;lineno;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};<br>
&nbsp;&nbsp;&nbsp;&lt;/monodoc:example&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;UGH!&nbsp;First,&nbsp;this&nbsp;is&nbsp;obviously&nbsp;annoying.&nbsp;Second,&nbsp;the&nbsp;only&nbsp;way&nbsp;I&nbsp;can<br>
&nbsp;&nbsp;&nbsp;figure&nbsp;to&nbsp;get&nbsp;access&nbsp;to&nbsp;&quot;char&nbsp;dest[256]&quot;&nbsp;is&nbsp;to&nbsp;use&nbsp;&quot;char*&nbsp;dest&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&amp;amp;nerr-&amp;gt;dest_first_char;&quot;&nbsp;and&nbsp;then&nbsp;just&nbsp;use&nbsp;dest&nbsp;as&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;string.&nbsp;I've&nbsp;dug&nbsp;through&nbsp;the&nbsp;documentation,&nbsp;and&nbsp;I&nbsp;can't&nbsp;find&nbsp;any<br>
&nbsp;&nbsp;&nbsp;better&nbsp;solution.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Obviously&nbsp;it&nbsp;would&nbsp;be&nbsp;ideal&nbsp;if&nbsp;there&nbsp;were&nbsp;a&nbsp;way&nbsp;to&nbsp;represent&nbsp;a<br>
&nbsp;&nbsp;&nbsp;value-type&nbsp;array.&nbsp;I&nbsp;wonder&nbsp;how&nbsp;Managed&nbsp;C++&nbsp;handles&nbsp;&quot;char&nbsp;foo[256];&quot;&nbsp;in<br>
&nbsp;&nbsp;&nbsp;a&nbsp;struct.&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;meaning-of-unsafe&quot;&gt;Meaning&nbsp;of&nbsp;&quot;Unsafe&quot;&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;A&nbsp;&quot;problem&quot;&nbsp;is&nbsp;that&nbsp;&quot;unsafe&quot;&nbsp;is&nbsp;an&nbsp;overloaded&nbsp;term.&nbsp;&nbsp;It&nbsp;can<br>
&nbsp;&nbsp;&nbsp;refer&nbsp;to&nbsp;the&nbsp;use&nbsp;of&nbsp;the&nbsp;&quot;unsafe&quot;&nbsp;C#&nbsp;keyword,&nbsp;and&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as<br>
&nbsp;&nbsp;&nbsp;&quot;anything&nbsp;that&nbsp;isn't&nbsp;safe&quot;,&nbsp;which&nbsp;may&nbsp;not&nbsp;require&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&quot;unsafe&quot;&nbsp;keyword.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;So,&nbsp;&quot;unsafe&quot;&nbsp;can&nbsp;mean&nbsp;(a)&nbsp;C#&nbsp;keyword;&nbsp;(b)&nbsp;violates&nbsp;.NET&nbsp;type&nbsp;system<br>
&nbsp;&nbsp;&nbsp;(similar&nbsp;to&nbsp;(a));&nbsp;(c)&nbsp;may&nbsp;be&nbsp;insecure&nbsp;(reading&nbsp;files&nbsp;from&nbsp;a&nbsp;web&nbsp;client);<br>
&nbsp;&nbsp;&nbsp;(d)&nbsp;capable&nbsp;of&nbsp;causing&nbsp;a&nbsp;segfault.&nbsp;&nbsp;There&nbsp;are&nbsp;likely&nbsp;other&nbsp;meanings<br>
&nbsp;&nbsp;&nbsp;people&nbsp;can&nbsp;dream&nbsp;up&nbsp;as&nbsp;well.&nbsp;&nbsp;Note&nbsp;that&nbsp;(d)&nbsp;doesn't&nbsp;imply&nbsp;(b),&nbsp;as&nbsp;far&nbsp;as<br>
&nbsp;&nbsp;&nbsp;.NET&nbsp;is&nbsp;concerned.&nbsp;&nbsp;The&nbsp;runtime&nbsp;could&nbsp;itself&nbsp;have&nbsp;a&nbsp;bug&nbsp;that&nbsp;generates&nbsp;a<br>
&nbsp;&nbsp;&nbsp;segfault,&nbsp;but&nbsp;this&nbsp;doesn't&nbsp;violate&nbsp;the&nbsp;type&nbsp;system.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;IntPtr&nbsp;doesn't&nbsp;require&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;type&nbsp;system,&nbsp;as&nbsp;you&nbsp;can't&nbsp;get<br>
&nbsp;&nbsp;&nbsp;the&nbsp;address&nbsp;of&nbsp;a&nbsp;.NET&nbsp;object&nbsp;(unless&nbsp;you&nbsp;&quot;pin&quot;&nbsp;it,&nbsp;which&nbsp;would&nbsp;require<br>
&nbsp;&nbsp;&nbsp;the&nbsp;appropriate&nbsp;Security&nbsp;rights),&nbsp;and&nbsp;is&nbsp;thus&nbsp;principally&nbsp;useful&nbsp;for<br>
&nbsp;&nbsp;&nbsp;interacting&nbsp;with&nbsp;unmanaged&nbsp;code,&nbsp;which&nbsp;exists&nbsp;outside&nbsp;of&nbsp;the&nbsp;.NET&nbsp;type<br>
&nbsp;&nbsp;&nbsp;system.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Surely,&nbsp;this&nbsp;is&nbsp;pure&nbsp;semantics,&nbsp;but&nbsp;I&nbsp;can&nbsp;see&nbsp;the&nbsp;designers<br>
&nbsp;&nbsp;&nbsp;perspective.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&nbsp;id=&quot;security&quot;&gt;Security&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;.NET&nbsp;has&nbsp;a&nbsp;highly&nbsp;flexible&nbsp;security<br>
&nbsp;&nbsp;&nbsp;system.&nbsp;&nbsp;You&nbsp;can't&nbsp;invoke&nbsp;DllImported&nbsp;functions&nbsp;unless&nbsp;your&nbsp;app&nbsp;has&nbsp;the<br>
&nbsp;&nbsp;&nbsp;appropriate&nbsp;security&nbsp;rights&nbsp;--&nbsp;generally,&nbsp;that&nbsp;the&nbsp;app&nbsp;is&nbsp;running&nbsp;on&nbsp;the<br>
&nbsp;&nbsp;&nbsp;local&nbsp;machine.&nbsp;&nbsp;If&nbsp;you're&nbsp;running&nbsp;it&nbsp;from&nbsp;a&nbsp;network&nbsp;share,&nbsp;or&nbsp;from&nbsp;a&nbsp;web<br>
&nbsp;&nbsp;&nbsp;site&nbsp;(similar&nbsp;to&nbsp;Java&nbsp;Applets),&nbsp;then&nbsp;your&nbsp;app&nbsp;will&nbsp;get&nbsp;a<br>
&nbsp;&nbsp;&nbsp;SecurityException.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;You&nbsp;can&nbsp;get&nbsp;lots&nbsp;of&nbsp;security&nbsp;exceptions&nbsp;for&nbsp;various&nbsp;things,&nbsp;actually.&nbsp;<br>
&nbsp;&nbsp;&nbsp;Opening&nbsp;files&nbsp;can&nbsp;generate&nbsp;a&nbsp;security&nbsp;exception,&nbsp;for&nbsp;example.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;System.Security.Permissions.SecurityPermission&nbsp;is&nbsp;needed&nbsp;with<br>
&nbsp;&nbsp;&nbsp;SecurityPermissionFlag.UnmanagedCode&nbsp;specified&nbsp;in&nbsp;order&nbsp;to&nbsp;perform&nbsp;a<br>
&nbsp;&nbsp;&nbsp;P/Invoke.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Programs&nbsp;can't&nbsp;specify&nbsp;this&nbsp;permission,&nbsp;though,&nbsp;they&nbsp;can&nbsp;only&nbsp;request&nbsp;it<br>
&nbsp;&nbsp;&nbsp;(or&nbsp;demand&nbsp;it,&nbsp;and&nbsp;if&nbsp;they&nbsp;can't&nbsp;get&nbsp;it,&nbsp;a&nbsp;SecurityException&nbsp;is<br>
&nbsp;&nbsp;&nbsp;thrown).&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Administrators&nbsp;are&nbsp;the&nbsp;people&nbsp;who&nbsp;specify&nbsp;what&nbsp;permissions&nbsp;an<br>
&nbsp;&nbsp;&nbsp;application&nbsp;actually&nbsp;receives.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;That's&nbsp;about&nbsp;the&nbsp;limits&nbsp;of&nbsp;my&nbsp;knowledge&nbsp;--&nbsp;Security&nbsp;isn't&nbsp;my&nbsp;forte.&nbsp;&nbsp;You<br>
&nbsp;&nbsp;&nbsp;might&nbsp;find&nbsp;the&nbsp;following&nbsp;topics&nbsp;interesting.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconrequestingpermissions.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Requesting&nbsp;Permissions&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconsecuritysyntax.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Security&nbsp;Syntax&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconcodeaccesssecurity.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Code&nbsp;Access&nbsp;Security&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpguide/html/cpconinheritancedemands.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Inheritance&nbsp;Demands&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h4&gt;See&nbsp;Also&lt;/h4&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;ul&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;li&gt;&lt;a&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;href=&quot;http://msdn.microsoft.com/library/default.asp?url=/library/en-us/csspec/html/vclrfcsharpspec_A_2.asp&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;Unsafe&nbsp;Code&nbsp;at&nbsp;MSDN&lt;/a&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/li&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;/ul&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;comments&quot;&gt;Commentary&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Interesting&nbsp;commentary&nbsp;that&nbsp;doesn't&nbsp;really&nbsp;belong&nbsp;elsewhere,&nbsp;but&nbsp;is<br>
&nbsp;&nbsp;&nbsp;still&nbsp;good&nbsp;to&nbsp;know.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h3&nbsp;id=&quot;pinvoke-spec&quot;&gt;P/Invoke&nbsp;Specification&lt;/h3&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;From&nbsp;Paolo&nbsp;Molaro:&lt;/p&gt;<br>
&nbsp;&nbsp;&nbsp;&lt;blockquote&gt;<br>
&nbsp;&nbsp;&nbsp;Yes,&nbsp;the&nbsp;P/Invoke&nbsp;specification&nbsp;(or&nbsp;lack&nbsp;thereof)&nbsp;is&nbsp;a&nbsp;mess.&nbsp;It&nbsp;was&nbsp;done<br>
&nbsp;&nbsp;&nbsp;by&nbsp;people&nbsp;that&nbsp;didn't&nbsp;[think]&nbsp;through&nbsp;the&nbsp;portability&nbsp;issues&nbsp;and&nbsp;this&nbsp;is<br>
&nbsp;&nbsp;&nbsp;probably&nbsp;one&nbsp;of&nbsp;the&nbsp;reasons&nbsp;the&nbsp;MS&nbsp;CLR&nbsp;is&nbsp;not&nbsp;really&nbsp;supported&nbsp;on<br>
&nbsp;&nbsp;&nbsp;9x-based&nbsp;platforms.&nbsp;Note:&nbsp;P/Invoke&nbsp;is&nbsp;intrinsically&nbsp;non-portable,&nbsp;the<br>
&nbsp;&nbsp;&nbsp;main&nbsp;issue&nbsp;is&nbsp;that&nbsp;P/Invoke&nbsp;is&nbsp;poorly&nbsp;defined&nbsp;in&nbsp;a&nbsp;non-win32&nbsp;system.<br>
&nbsp;&nbsp;&nbsp;Think&nbsp;of&nbsp;Charset:&nbsp;they&nbsp;allow&nbsp;Ansi&nbsp;and&nbsp;Unicode&nbsp;(with&nbsp;Auto&nbsp;meaning&nbsp;one&nbsp;or<br>
&nbsp;&nbsp;&nbsp;the&nbsp;other&nbsp;according&nbsp;to&nbsp;the&nbsp;platform),&nbsp;but&nbsp;the&nbsp;world&nbsp;uses&nbsp;also&nbsp;other<br>
&nbsp;&nbsp;&nbsp;encodings.&nbsp;At&nbsp;the&nbsp;very&nbsp;least&nbsp;they&nbsp;should&nbsp;have&nbsp;added&nbsp;a&nbsp;Charset.Encoding<br>
&nbsp;&nbsp;&nbsp;or&nbsp;something,&nbsp;with&nbsp;the&nbsp;actual&nbsp;encoding&nbsp;specified&nbsp;separately&nbsp;as&nbsp;a&nbsp;string,<br>
&nbsp;&nbsp;&nbsp;for&nbsp;example&nbsp;(good&nbsp;luck,&nbsp;though,&nbsp;finding&nbsp;a&nbsp;UCS4&nbsp;encoding<br>
&nbsp;&nbsp;&nbsp;implementation&nbsp;in&nbsp;the&nbsp;base&nbsp;assemblies...).<br>
&nbsp;&nbsp;&nbsp;&lt;/blockquote&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;thanks&quot;&gt;Thanks&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Portions&nbsp;of&nbsp;this&nbsp;document&nbsp;were&nbsp;generated&nbsp;as&nbsp;a&nbsp;result&nbsp;of&nbsp;a&nbsp;mono-list<br>
&nbsp;&nbsp;&nbsp;discussion&nbsp;between&nbsp;Jonathan&nbsp;Pryor&nbsp;and&nbsp;David&nbsp;Jeske.&nbsp;&nbsp;See:&nbsp;<br>
&nbsp;&nbsp;&nbsp;&lt;a&nbsp;href=&quot;http://lists.ximian.com/archives/public/mono-list/2003-July/014886.html&quot;<br>
&nbsp;&nbsp;&nbsp;&gt;http://lists.ximian.com/archives/public/mono-list/2003-July/014886.html&lt;/a&gt;.<br>
&nbsp;&nbsp;&nbsp;&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Thanks&nbsp;also&nbsp;to&nbsp;Paolo&nbsp;Molaro&nbsp;for&nbsp;reviews&nbsp;and&nbsp;comments.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;h2&nbsp;id=&quot;copyright&quot;&gt;Copyright&lt;/h2&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;This&nbsp;document&nbsp;is&nbsp;entered&nbsp;into&nbsp;the&nbsp;Public&nbsp;Domain.&nbsp;&nbsp;Please&nbsp;properly<br>
&nbsp;&nbsp;&nbsp;document&nbsp;the&nbsp;original&nbsp;author&nbsp;(you&nbsp;don't&nbsp;go&nbsp;quoting&nbsp;Mark&nbsp;Twain&nbsp;without<br>
&nbsp;&nbsp;&nbsp;mentioning&nbsp;him&nbsp;even&nbsp;though&nbsp;his&nbsp;works&nbsp;are&nbsp;all&nbsp;Public&nbsp;Domain),&nbsp;but&nbsp;I&nbsp;fully<br>
&nbsp;&nbsp;&nbsp;expect&nbsp;that&nbsp;this&nbsp;document&nbsp;can&nbsp;(and&nbsp;will)&nbsp;be&nbsp;massaged&nbsp;for&nbsp;other&nbsp;mediums.&lt;/p&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&lt;p&gt;Written&nbsp;August-September&nbsp;2003,&nbsp;by&nbsp;Jonathan&nbsp;Pryor.&lt;/p&gt;<br>
<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>
<br>

</tt>
