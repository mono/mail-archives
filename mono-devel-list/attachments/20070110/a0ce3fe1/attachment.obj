Index: mono/mono/metadata/ChangeLog
===================================================================
--- mono/mono/metadata/ChangeLog	(revision 70820)
+++ mono/mono/metadata/ChangeLog	(working copy)
@@ -1,3 +1,7 @@
+2007-01-11  Jonathan Chambers  <joncham@gmail.com>
+
+	* marshal.c: Implement Marshal.ReAllocCoTaskMem.
+	
 2007-01-11  Raja R Harinath  <harinath@gmail.com>
 
 	* class-internals.h (mono_get_inflated_generic_class): Remove.
Index: mono/mono/metadata/icall-def.h
===================================================================
--- mono/mono/metadata/icall-def.h	(revision 70820)
+++ mono/mono/metadata/icall-def.h	(working copy)
@@ -578,26 +578,27 @@
 ICALL(MARSHAL_20, "PtrToStructure(intptr,System.Type)", ves_icall_System_Runtime_InteropServices_Marshal_PtrToStructure_type)
 ICALL(MARSHAL_21, "PtrToStructure(intptr,object)", ves_icall_System_Runtime_InteropServices_Marshal_PtrToStructure)
 ICALL(MARSHAL_22, "QueryInterface", ves_icall_System_Runtime_InteropServices_Marshal_QueryInterface)
-ICALL(MARSHAL_23, "ReAllocHGlobal", mono_marshal_realloc)
-ICALL(MARSHAL_24, "ReadByte", ves_icall_System_Runtime_InteropServices_Marshal_ReadByte)
-ICALL(MARSHAL_25, "ReadInt16", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt16)
-ICALL(MARSHAL_26, "ReadInt32", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt32)
-ICALL(MARSHAL_27, "ReadInt64", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt64)
-ICALL(MARSHAL_28, "ReadIntPtr", ves_icall_System_Runtime_InteropServices_Marshal_ReadIntPtr)
-ICALL(MARSHAL_29, "Release", ves_icall_System_Runtime_InteropServices_Marshal_Release)
-ICALL(MARSHAL_30, "SizeOf", ves_icall_System_Runtime_InteropServices_Marshal_SizeOf)
-ICALL(MARSHAL_31, "StringToBSTR", ves_icall_System_Runtime_InteropServices_Marshal_StringToBSTR)
-ICALL(MARSHAL_32, "StringToHGlobalAnsi", ves_icall_System_Runtime_InteropServices_Marshal_StringToHGlobalAnsi)
-ICALL(MARSHAL_33, "StringToHGlobalUni", ves_icall_System_Runtime_InteropServices_Marshal_StringToHGlobalUni)
-ICALL(MARSHAL_34, "StructureToPtr", ves_icall_System_Runtime_InteropServices_Marshal_StructureToPtr)
-ICALL(MARSHAL_35, "UnsafeAddrOfPinnedArrayElement", ves_icall_System_Runtime_InteropServices_Marshal_UnsafeAddrOfPinnedArrayElement)
-ICALL(MARSHAL_36, "WriteByte", ves_icall_System_Runtime_InteropServices_Marshal_WriteByte)
-ICALL(MARSHAL_37, "WriteInt16", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt16)
-ICALL(MARSHAL_38, "WriteInt32", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt32)
-ICALL(MARSHAL_39, "WriteInt64", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt64)
-ICALL(MARSHAL_40, "WriteIntPtr", ves_icall_System_Runtime_InteropServices_Marshal_WriteIntPtr)
-ICALL(MARSHAL_41, "copy_from_unmanaged", ves_icall_System_Runtime_InteropServices_Marshal_copy_from_unmanaged)
-ICALL(MARSHAL_42, "copy_to_unmanaged", ves_icall_System_Runtime_InteropServices_Marshal_copy_to_unmanaged)
+ICALL(MARSHAL_23, "ReAllocCoTaskMem", ves_icall_System_Runtime_InteropServices_Marshal_ReAllocCoTaskMem)
+ICALL(MARSHAL_24, "ReAllocHGlobal", mono_marshal_realloc)
+ICALL(MARSHAL_25, "ReadByte", ves_icall_System_Runtime_InteropServices_Marshal_ReadByte)
+ICALL(MARSHAL_26, "ReadInt16", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt16)
+ICALL(MARSHAL_27, "ReadInt32", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt32)
+ICALL(MARSHAL_28, "ReadInt64", ves_icall_System_Runtime_InteropServices_Marshal_ReadInt64)
+ICALL(MARSHAL_29, "ReadIntPtr", ves_icall_System_Runtime_InteropServices_Marshal_ReadIntPtr)
+ICALL(MARSHAL_30, "Release", ves_icall_System_Runtime_InteropServices_Marshal_Release)
+ICALL(MARSHAL_31, "SizeOf", ves_icall_System_Runtime_InteropServices_Marshal_SizeOf)
+ICALL(MARSHAL_32, "StringToBSTR", ves_icall_System_Runtime_InteropServices_Marshal_StringToBSTR)
+ICALL(MARSHAL_33, "StringToHGlobalAnsi", ves_icall_System_Runtime_InteropServices_Marshal_StringToHGlobalAnsi)
+ICALL(MARSHAL_34, "StringToHGlobalUni", ves_icall_System_Runtime_InteropServices_Marshal_StringToHGlobalUni)
+ICALL(MARSHAL_35, "StructureToPtr", ves_icall_System_Runtime_InteropServices_Marshal_StructureToPtr)
+ICALL(MARSHAL_36, "UnsafeAddrOfPinnedArrayElement", ves_icall_System_Runtime_InteropServices_Marshal_UnsafeAddrOfPinnedArrayElement)
+ICALL(MARSHAL_37, "WriteByte", ves_icall_System_Runtime_InteropServices_Marshal_WriteByte)
+ICALL(MARSHAL_38, "WriteInt16", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt16)
+ICALL(MARSHAL_39, "WriteInt32", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt32)
+ICALL(MARSHAL_40, "WriteInt64", ves_icall_System_Runtime_InteropServices_Marshal_WriteInt64)
+ICALL(MARSHAL_41, "WriteIntPtr", ves_icall_System_Runtime_InteropServices_Marshal_WriteIntPtr)
+ICALL(MARSHAL_42, "copy_from_unmanaged", ves_icall_System_Runtime_InteropServices_Marshal_copy_from_unmanaged)
+ICALL(MARSHAL_43, "copy_to_unmanaged", ves_icall_System_Runtime_InteropServices_Marshal_copy_to_unmanaged)
 
 ICALL_TYPE(ACTS, "System.Runtime.Remoting.Activation.ActivationServices", ACTS_1)
 ICALL(ACTS_1, "AllocateUninitializedClassInstance", ves_icall_System_Runtime_Activation_ActivationServices_AllocateUninitializedClassInstance)
Index: mono/mono/metadata/marshal.c
===================================================================
--- mono/mono/metadata/marshal.c	(revision 70820)
+++ mono/mono/metadata/marshal.c	(working copy)
@@ -10002,6 +10002,18 @@
 #endif
 }
 
+gpointer
+ves_icall_System_Runtime_InteropServices_Marshal_ReAllocCoTaskMem (gpointer ptr, int size)
+{
+	MONO_ARCH_SAVE_REGS;
+
+#ifdef PLATFORM_WIN32
+	return CoTaskMemRealloc (ptr, size);
+#else
+	return g_try_realloc (ptr, (gulong)size);
+#endif
+}
+
 void*
 ves_icall_System_Runtime_InteropServices_Marshal_UnsafeAddrOfPinnedArrayElement (MonoArray *arrayobj, int index)
 {
Index: mono/mono/metadata/marshal.h
===================================================================
--- mono/mono/metadata/marshal.h	(revision 70820)
+++ mono/mono/metadata/marshal.h	(working copy)
@@ -366,6 +366,9 @@
 void
 ves_icall_System_Runtime_InteropServices_Marshal_FreeCoTaskMem (void *ptr) MONO_INTERNAL;
 
+gpointer 
+ves_icall_System_Runtime_InteropServices_Marshal_ReAllocCoTaskMem (gpointer ptr, int size) MONO_INTERNAL;
+
 void*
 ves_icall_System_Runtime_InteropServices_Marshal_AllocHGlobal (int size) MONO_INTERNAL;
 
Index: mcs/class/corlib/System.Runtime.InteropServices/ChangeLog
===================================================================
--- mcs/class/corlib/System.Runtime.InteropServices/ChangeLog	(revision 70820)
+++ mcs/class/corlib/System.Runtime.InteropServices/ChangeLog	(working copy)
@@ -1,3 +1,7 @@
+2007-01-11  Jonathan Chambers  <joncham@gmail.com>
+
+	* Marshal.cs: Implement Marshal.ReAllocCoTaskMem.
+	
 2007-01-03  Miguel de Icaza  <miguel@novell.com>
 
 	* SafeHandle.cs: Do not use locks in SafeHandle to protect the
Index: mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs
===================================================================
--- mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs	(revision 70820)
+++ mcs/class/corlib/System.Runtime.InteropServices/Marshal.cs	(working copy)
@@ -724,11 +724,8 @@
 			throw new NotImplementedException ();
 		}
 
-		[MonoTODO]
-		public static IntPtr ReAllocCoTaskMem (IntPtr pv, int cb)
-		{
-			throw new NotImplementedException ();
-		}
+		[MethodImplAttribute (MethodImplOptions.InternalCall)]
+		public extern static IntPtr ReAllocCoTaskMem (IntPtr pv, int cb);
 
 		[MethodImplAttribute(MethodImplOptions.InternalCall)]
 		public extern static IntPtr ReAllocHGlobal (IntPtr pv, IntPtr cb);