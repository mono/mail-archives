<tt>
I&nbsp;agree&nbsp;with&nbsp;Zoltan,&nbsp;we&nbsp;better&nbsp;figure&nbsp;out&nbsp;how&nbsp;to&nbsp;extend&nbsp;the&nbsp;profilling&nbsp;interface&nbsp;to&nbsp;support&nbsp;such&nbsp;tool&nbsp;than&lt;br&gt;to&nbsp;increase&nbsp;the&nbsp;complexity&nbsp;of&nbsp;the&nbsp;runtime.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Nov&nbsp;26,&nbsp;2009&nbsp;at&nbsp;10:22&nbsp;PM,&nbsp;Zoltan&nbsp;Varga&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:vargaz@gmail.com&quot;&gt;vargaz@gmail.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;Hi,&lt;br&gt;&lt;br&gt; &nbsp;This&nbsp;patch&nbsp;adds&nbsp;code&nbsp;to&nbsp;the&nbsp;string&nbsp;allocation&nbsp;functions&nbsp;which&nbsp;need&nbsp;to&nbsp;be&nbsp;as&nbsp;fast&nbsp;as&lt;br&gt;<br>
possible.&nbsp;I&nbsp;think&nbsp;it&nbsp;might&nbsp;be&nbsp;better&nbsp;to&nbsp;implement&nbsp;this&nbsp;as&nbsp;a&nbsp;profiler&nbsp;module,&nbsp;a&nbsp;profiler&nbsp;can&nbsp;already&nbsp;receive&nbsp;notifications&nbsp;when&nbsp;an&nbsp;object&nbsp;is&nbsp;allocated.&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;                       &nbsp;Zoltan&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;Fri,&nbsp;Nov&nbsp;27,&nbsp;2009&nbsp;at&nbsp;1:08&nbsp;AM,&nbsp;Marek&nbsp;Habersack&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:grendel@twistedcode.net&quot;&nbsp;target=&quot;_blank&quot;&gt;grendel@twistedcode.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
<br>
&lt;/div&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;Hello&nbsp;everybody,&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; Attached&nbsp;is&nbsp;an&nbsp;update&nbsp;to&nbsp;the&nbsp;original&nbsp;code&nbsp;I&nbsp;posted&nbsp;last&nbsp;week.&nbsp;The&nbsp;update&nbsp;adds&nbsp;support&nbsp;for&nbsp;reporting&nbsp;string&nbsp;allocation&nbsp;locations.&nbsp;It&nbsp;is&nbsp;useful&nbsp;with&nbsp;large&nbsp;code&nbsp;base&nbsp;where&nbsp;strings&nbsp;may&nbsp;be&nbsp;created&nbsp;in&nbsp;one&nbsp;location&nbsp;but&nbsp;used&nbsp;in&nbsp;many&nbsp;others.&nbsp;The&nbsp;code&nbsp;adds&nbsp;a&nbsp;new&nbsp;internal&nbsp;function&nbsp;which&nbsp;does&nbsp;the&nbsp;job&nbsp;of&nbsp;backtrace&nbsp;(3)&nbsp;but&nbsp;supports&nbsp;mono&nbsp;JIT.&nbsp;It&amp;#39;s&nbsp;basically&nbsp;a&nbsp;lighter&nbsp;version&nbsp;of&nbsp;mono_jit_walk_stack&nbsp;which&nbsp;was&nbsp;too&nbsp;heavy&nbsp;for&nbsp;this&nbsp;purpose.&nbsp;The&nbsp;code&nbsp;needs&nbsp;to&nbsp;record&nbsp;stack&nbsp;location&nbsp;for&nbsp;each&nbsp;and&nbsp;every&nbsp;string&nbsp;allocated&nbsp;in&nbsp;the&nbsp;application&nbsp;and&nbsp;the&nbsp;runtime&nbsp;only&nbsp;to&nbsp;store&nbsp;it&nbsp;for&nbsp;later&nbsp;use&nbsp;when&nbsp;IOMAP&nbsp;kicks&nbsp;in.&nbsp;Doing&nbsp;that&nbsp;with&nbsp;mono_stack_walk&nbsp;rendered&nbsp;Mono&nbsp;many&nbsp;times&nbsp;slower&nbsp;and&nbsp;made&nbsp;debugging&nbsp;the&nbsp;application&nbsp;virtually&nbsp;impossible.&nbsp;The&nbsp;patch&nbsp;makes&nbsp;execution&nbsp;just&nbsp;slightly&nbsp;slower&nbsp;than&nbsp;usual.&nbsp;The&nbsp;reporting&nbsp;code&nbsp;uses&nbsp;simple&nbsp;heuristics&nbsp;to&nbsp;select&nbsp;the&nbsp;possible&nbsp;string&nbsp;allocation&nbsp;location&nbsp;-&nbsp;it&nbsp;attempts&nbsp;to&nbsp;ignore&nbsp;all&nbsp;methods&nbsp;from&nbsp;assemblies&nbsp;installed&nbsp;in&nbsp;GAC,&nbsp;from&nbsp;corlib&nbsp;and,&nbsp;should&nbsp;the&nbsp;two&nbsp;checks&nbsp;fail,&nbsp;from&nbsp;a&nbsp;list&nbsp;of&nbsp;assemblies&nbsp;and&nbsp;classes&nbsp;to&nbsp;ignore.&nbsp;This&nbsp;is&nbsp;done&nbsp;based&nbsp;on&nbsp;the&nbsp;premise&nbsp;that&nbsp;the&nbsp;Mono&nbsp;runtime&nbsp;and&nbsp;class&nbsp;libraries&nbsp;are&nbsp;case-sensitive&nbsp;and&nbsp;don&amp;#39;t&nbsp;have&nbsp;the&nbsp;problem&nbsp;some&nbsp;applications&nbsp;might&nbsp;have&nbsp;(there&amp;#39;s&nbsp;actually&nbsp;an&nbsp;instance&nbsp;where&nbsp;that&nbsp;assumption&nbsp;is&nbsp;incorrect&nbsp;-&nbsp;in&nbsp;System.Web&nbsp;we&nbsp;check&nbsp;for&nbsp;existence&nbsp;of&nbsp;web.config,&nbsp;Web.config&nbsp;and&nbsp;Web.Config&nbsp;-&nbsp;but&nbsp;it&amp;#39;s&nbsp;intended&nbsp;:)).&nbsp;The&nbsp;results&nbsp;of&nbsp;the&nbsp;selection&nbsp;algorithm&nbsp;might&nbsp;not&nbsp;always&nbsp;be&nbsp;accurate,&nbsp;but&nbsp;they&nbsp;should&nbsp;be&nbsp;close&nbsp;enough&nbsp;to&nbsp;aid&nbsp;the&nbsp;developer&nbsp;to&nbsp;spot&nbsp;the&nbsp;location&nbsp;where&nbsp;string&nbsp;was&nbsp;allocated.&lt;br&gt;<br>
<br>
<br>
&nbsp; &nbsp; &nbsp; &nbsp; Please&nbsp;review&nbsp;and&nbsp;let&nbsp;me&nbsp;know&nbsp;if&nbsp;I&nbsp;can&nbsp;commit.&lt;br&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;<br>
&lt;br&gt;<br>
marek&lt;br&gt;<br>
&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Mono-devel-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Mono-devel-list@lists.ximian.com&quot;&gt;Mono-devel-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/mono-devel-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/mono-devel-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
