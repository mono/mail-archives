<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Nov&nbsp;27,&nbsp;2009&nbsp;at&nbsp;4:43&nbsp;PM,&nbsp;Marek&nbsp;Habersack&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:grendel@twistedcode.net&quot;&gt;grendel@twistedcode.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;11/27/2009&nbsp;06:48&nbsp;PM,&nbsp;Rodrigo&nbsp;Kumpera&nbsp;wrote:&lt;br&gt;<br>
&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;Fri,&nbsp;Nov&nbsp;27,&nbsp;2009&nbsp;at&nbsp;1:40&nbsp;PM,&nbsp;Marek&nbsp;Habersack&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;<br>
&amp;lt;&lt;a&nbsp;href=&quot;mailto:grendel@twistedcode.net&quot;&nbsp;target=&quot;_blank&quot;&gt;grendel@twistedcode.net&lt;/a&gt;&nbsp;&amp;lt;mailto:&lt;a&nbsp;href=&quot;mailto:grendel@twistedcode.net&quot;&nbsp;target=&quot;_blank&quot;&gt;grendel@twistedcode.net&lt;/a&gt;&amp;gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; On&nbsp;11/27/2009&nbsp;02:29&nbsp;PM,&nbsp;Rodrigo&nbsp;Kumpera&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; I&nbsp;agree&nbsp;with&nbsp;Zoltan,&nbsp;we&nbsp;better&nbsp;figure&nbsp;out&nbsp;how&nbsp;to&nbsp;extend&nbsp;the&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; profilling&lt;br&gt;<br>
&nbsp; &nbsp; &nbsp; &nbsp; interface&nbsp;to&nbsp;support&nbsp;such&nbsp;tool&nbsp;than&lt;br&gt;<br>
&lt;br&gt;<br>
&nbsp; &nbsp; it&nbsp;would&nbsp;defy&nbsp;the&nbsp;purpose&nbsp;of&nbsp;the&nbsp;tool,&nbsp;but&nbsp;it&nbsp;seems&nbsp;I&nbsp;can&nbsp;remove&nbsp;the&lt;br&gt;<br>
&nbsp; &nbsp; code&nbsp;from&nbsp;mono_string_new_utf16&nbsp;without&nbsp;harming&nbsp;functionality&nbsp;-&lt;br&gt;<br>
&nbsp; &nbsp; would&nbsp;that&nbsp;be&nbsp;ok?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
Why&nbsp;using&nbsp;the&nbsp;profilling&nbsp;interface&nbsp;defy&nbsp;the&nbsp;purpose&nbsp;of&nbsp;the&nbsp;tool?&nbsp;I&nbsp;can&amp;#39;t&lt;br&gt;<br>
see&nbsp;how&nbsp;passing&nbsp;an&nbsp;extra&nbsp;argument&nbsp;to&nbsp;the&nbsp;mono&nbsp;runtime&nbsp;be&nbsp;a&nbsp;problem.&lt;br&gt;<br>
&lt;/div&gt;&lt;/blockquote&gt;<br>
The&nbsp;utility&nbsp;should&nbsp;be&nbsp;as&nbsp;seamless&nbsp;to&nbsp;use.&nbsp;With&nbsp;it&nbsp;consisting&nbsp;of&nbsp;two&nbsp;parts&nbsp;-&nbsp;one&nbsp;in&nbsp;IO&nbsp;portability&nbsp;code&nbsp;and&nbsp;another&nbsp;as&nbsp;a&nbsp;profiler&nbsp;module&nbsp;(&amp;#39;profiler&amp;#39;&nbsp;being&nbsp;a&nbsp;misnomer&nbsp;here&nbsp;too,&nbsp;as&nbsp;the&nbsp;tool&nbsp;is&nbsp;by&nbsp;no&nbsp;means&nbsp;a&nbsp;profiler)&nbsp;it&nbsp;would&nbsp;require&nbsp;setting&nbsp;both&nbsp;MONO_IOMAP&nbsp;and&nbsp;passing&nbsp;--profile=iomap&nbsp;(or&nbsp;somesuch)&nbsp;to&nbsp;the&nbsp;runtime&nbsp;as&nbsp;they&nbsp;both&nbsp;are&nbsp;required&nbsp;for&nbsp;the&nbsp;code&nbsp;to&nbsp;be&nbsp;useful.&nbsp;This&nbsp;can&nbsp;be&nbsp;a&nbsp;problem&nbsp;for&nbsp;MonoVS&nbsp;or&nbsp;MonoDevelop,&nbsp;which&nbsp;would&nbsp;have&nbsp;to&nbsp;call&nbsp;the&nbsp;runtime&nbsp;with&nbsp;--profile&nbsp;for&nbsp;every&nbsp;app&nbsp;whether&nbsp;or&nbsp;not&nbsp;it&nbsp;is&nbsp;necessary,&nbsp;and&nbsp;also&nbsp;it&nbsp;introduces&nbsp;a&nbsp;complexity&nbsp;for&nbsp;users&nbsp;not&nbsp;familiar&nbsp;with&nbsp;Mono&nbsp;command&nbsp;line.&nbsp;To&nbsp;get&nbsp;rid&nbsp;of&nbsp;the&nbsp;disparity,&nbsp;one&nbsp;would&nbsp;have&nbsp;to&nbsp;switch&nbsp;IOMAP&nbsp;on&nbsp;behind&nbsp;the&nbsp;scenes&nbsp;if&nbsp;--profile=iomap&nbsp;was&nbsp;used&nbsp;and&nbsp;this&nbsp;is&nbsp;not&nbsp;a&nbsp;nice&nbsp;thing&nbsp;to&nbsp;do,&nbsp;imho.&nbsp;From&nbsp;the&nbsp;other&nbsp;end,&nbsp;the&nbsp;user&nbsp;would&nbsp;have&nbsp;to&nbsp;know&nbsp;that&nbsp;they&nbsp;need&nbsp;to&nbsp;specify&nbsp;&amp;#39;all:report&amp;#39;&nbsp;and&nbsp;pass&nbsp;--profile=iomap&nbsp;to&nbsp;the&nbsp;runtime&nbsp;-&nbsp;also&nbsp;not&nbsp;a&nbsp;nice&nbsp;solution.&lt;/blockquote&gt;<br>
&lt;div&gt;&lt;br&gt;Ok,&nbsp;how&nbsp;about&nbsp;doing&nbsp;it&nbsp;just&nbsp;like&nbsp;sdb? &nbsp;Using&nbsp;the&nbsp;profiler&nbsp;API,&nbsp;but&nbsp;from&nbsp;the&nbsp;runtime&nbsp;itself?&nbsp;We&nbsp;could&nbsp;ship&nbsp;the&nbsp;code&nbsp;in&nbsp;IOMAP&nbsp;and&nbsp;MONO_IOMAP=&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
just&nbsp;fine,&nbsp;I&nbsp;don&amp;#39;t&nbsp;see&nbsp;a&nbsp;reason&nbsp;to&nbsp;add&nbsp;it&nbsp;to&nbsp;the&nbsp;runtime.&lt;br&gt;<br>
As&nbsp;I&nbsp;mentioned,&nbsp;we&nbsp;can&nbsp;extend&nbsp;the&nbsp;profiling&nbsp;API&nbsp;to&nbsp;fit&nbsp;your&nbsp;needs.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
The&nbsp;profiling&nbsp;API&nbsp;has&nbsp;all&nbsp;that&amp;#39;s&nbsp;needed&nbsp;-&nbsp;but&nbsp;if&nbsp;the&nbsp;code&nbsp;was&nbsp;there,&nbsp;it&nbsp;would&nbsp;have&nbsp;to&nbsp;hook&nbsp;up&nbsp;to&nbsp;the&nbsp;object&nbsp;allocation&nbsp;function&nbsp;and&nbsp;examine&nbsp;every&nbsp;single&nbsp;object&nbsp;whether&nbsp;it&amp;#39;s&nbsp;a&nbsp;string&nbsp;and&nbsp;then&nbsp;store&nbsp;the&nbsp;string&nbsp;-&nbsp;it&nbsp;would&nbsp;cost&nbsp;more&nbsp;time&nbsp;it&nbsp;does&nbsp;with&nbsp;the&nbsp;current&nbsp;patch.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;Well,&nbsp;you&nbsp;just&nbsp;mentioned&nbsp;what&nbsp;you&nbsp;need&nbsp;from&nbsp;the&nbsp;profiler,&nbsp;a&nbsp;way&nbsp;to&nbsp;tell&nbsp;the&nbsp;runtime&nbsp;that&nbsp;all&nbsp;you&nbsp;care&nbsp;about&nbsp;is&nbsp;string&nbsp;allocation.&lt;br&gt;&lt;br&gt;&lt;br&gt;Now,&nbsp;a&nbsp;few&nbsp;bits&nbsp;about&nbsp;your&nbsp;patch:&lt;br&gt;&lt;br&gt;The&nbsp;whole&nbsp;mono_jit_stack_backtrace&nbsp;thing&nbsp;is&nbsp;not&nbsp;required,&nbsp;you&nbsp;can&nbsp;get&nbsp;the&nbsp;same&nbsp;results&nbsp;with&nbsp;minimal&nbsp;perf&nbsp;hit&nbsp;by&nbsp;using&nbsp;mono_stack_walk_no_il.&lt;br&gt;<br>
This&nbsp;is&nbsp;true&nbsp;since&nbsp;mono_jit_stack_backtrace&nbsp;and&nbsp;mono_jit_walk_stack_from_ctx&nbsp;are&nbsp;basically&nbsp;identical.&nbsp;All&nbsp;you&nbsp;need&nbsp;to&nbsp;do&nbsp;is&nbsp;return&nbsp;TRUE&nbsp;from&lt;br&gt;the&nbsp;user&nbsp;func&nbsp;once&nbsp;you&nbsp;got&nbsp;enough&nbsp;frames.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;---&nbsp;a/mono/utils/mono-io-portability.c&lt;br&gt;<br>
+++&nbsp;b/mono/utils/mono-io-portability.c&lt;br&gt;&lt;br&gt;@@&nbsp;-130,6&nbsp;+190,13&nbsp;@@&nbsp;void&nbsp;mono_portability_helpers_init&nbsp;(void)&lt;br&gt;    &nbsp;   &nbsp;InitializeCriticalSection&nbsp;(&amp;amp;mismatched_files_section);&lt;br&gt;    &nbsp;   &nbsp;MONO_GC_REGISTER_ROOT&nbsp;(mismatched_files_hash);&lt;br&gt;<br>
    &nbsp;   &nbsp;mismatched_files_hash&nbsp;=&nbsp;mono_g_hash_table_new&nbsp;(mismatched_files_guint32_hash,&nbsp;mismatched_files_guint32_equal);&lt;br&gt;+&lt;br&gt;+   &nbsp;   &nbsp;MONO_GC_REGISTER_ROOT&nbsp;(saved_strings_hash);&lt;br&gt;+   &nbsp;   &nbsp;saved_strings_hash&nbsp;=&nbsp;mono_g_hash_table_new&nbsp;(NULL,&nbsp;NULL);&lt;br&gt;<br>
+&lt;br&gt;+   &nbsp;   &nbsp;MONO_GC_REGISTER_ROOT&nbsp;(string_locations_hash);&lt;br&gt;+   &nbsp;   &nbsp;string_locations_hash&nbsp;=&nbsp;mono_g_hash_table_new&nbsp;(mismatched_files_guint32_hash,&nbsp;mismatched_files_guint32_equal);&lt;br&gt;&lt;br&gt;Using&nbsp;MONO_GC_REGISTER_ROOT&nbsp;here&nbsp;won&amp;#39;t&nbsp;really&nbsp;work.&nbsp;It&nbsp;might&nbsp;work&nbsp;with&nbsp;boehm,&nbsp;but&nbsp;that&amp;#39;s&nbsp;far&nbsp;from&nbsp;optimal.&lt;br&gt;<br>
&lt;br&gt;Since&nbsp;you&nbsp;use&nbsp;string&nbsp;as&nbsp;key,&nbsp;you&nbsp;can&nbsp;use &nbsp;mono_g_hash_table_new_type&nbsp;with&nbsp;MONO_HASH_CONSERVATIVE_GC&lt;br&gt;since&nbsp;the&nbsp;value&nbsp;has&nbsp;an&nbsp;embedded&nbsp;MonoString&nbsp;in&nbsp;it.&lt;br&gt;&lt;br&gt;&lt;br&gt;+&lt;br&gt;+static&nbsp;gboolean&nbsp;ignore_frame&nbsp;(MonoMethod&nbsp;*method)&lt;br&gt;<br>
+{&lt;br&gt;&lt;br&gt;You&nbsp;can&nbsp;replaces&nbsp;all&nbsp;those&nbsp;types&nbsp;comparisons&nbsp;with&nbsp;&amp;quot;klass-&amp;gt;image&nbsp;==&nbsp;mono_defaults.corlib&amp;quot;&nbsp;since&lt;br&gt;you&nbsp;discard&nbsp;corlib&nbsp;types&nbsp;anyway.&lt;br&gt;&lt;br&gt;&lt;br&gt;+   &nbsp;EnterCriticalSection&nbsp;(&amp;amp;mismatched_files_section);&lt;br&gt;<br>
+   &nbsp;head&nbsp;=&nbsp;(SavedString*)mono_g_hash_table_lookup&nbsp;(saved_strings_hash,&nbsp;(gpointer)str);&lt;br&gt;&lt;br&gt;I&nbsp;just&nbsp;noticed&nbsp;you&nbsp;construct&nbsp;the&nbsp;hashtable&nbsp;without&nbsp;hash&nbsp;or&nbsp;equal&nbsp;functions,&nbsp;this&nbsp;means&nbsp;keys&nbsp;will&nbsp;be&nbsp;compared&nbsp;by&nbsp;their&nbsp;pointer&nbsp;value&lt;br&gt;<br>
and&nbsp;not&nbsp;content.&nbsp;Is&nbsp;that&nbsp;as&nbsp;intended?&nbsp;Because&nbsp;it&nbsp;makes&nbsp;the&nbsp;whole&nbsp;chaining&nbsp;you&nbsp;do&nbsp;here&nbsp;pretty&nbsp;useless&nbsp;as&nbsp;no&nbsp;2&nbsp;strings&nbsp;will&nbsp;be&nbsp;equal.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
