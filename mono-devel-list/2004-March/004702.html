<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] General impression about AppDomain.Unload() and finalizers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20General%20impression%20about%20AppDomain.Unload%28%29%20and%20finalizers&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004701.html">
   <LINK REL="Next"  HREF="004703.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] General impression about AppDomain.Unload() and finalizers</H1>
    <B>Jaroslaw Kowalski</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20General%20impression%20about%20AppDomain.Unload%28%29%20and%20finalizers&In-Reply-To="
       TITLE="[Mono-devel-list] General impression about AppDomain.Unload() and finalizers">jaak at zd.com.pl
       </A><BR>
    <I>Sun Mar 21 03:11:03 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004701.html">[Mono-devel-list] Mono Build System
</A></li>
        <LI>Next message: <A HREF="004703.html">[Mono-devel-list] [ANN] Firebird ADO.NET Data Provider 1.5.2 released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4702">[ date ]</a>
              <a href="thread.html#4702">[ thread ]</a>
              <a href="subject.html#4702">[ subject ]</a>
              <a href="author.html#4702">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi guys!

As you may know, I'm trying to get NAnt to run on Mono/Linux, but this
appears to be more difficult than I expected.

The root of all problems seems to be the AppDomain.Unload() &amp; the
finalizers.

AppDomains are important because this is how NAnt integrates with external
tools (NUnit 2.x being the primary example). In addition, some NAnt
operations lead to creation and destruction of AppDomains. NAnt unloads each
domain after use with AppDomain.Unload(). Unfortunately (as Chris Brumme
described it in his blog -
<A HREF="http://blogs.msdn.com/cbrumme/archive/2003/06/01/51466.aspx">http://blogs.msdn.com/cbrumme/archive/2003/06/01/51466.aspx</A>) this operation
is very difficult to implement and mono seems to have problems with it.
There are many problems: from deadlocks to some random exceptions. The
result is that it's close to impossible to run NAnt on Linux in a stable
manner today.

It's very difficult for me to debug this because this touches the internals
of garbage collector, which I know nothing of and producing reliable bug
reports is also difficult because of the non-determinism of GC.

Commenting out the body AppDomain.Unload() in
mcs/class/corlib/System/AppDomain.cs fixes all the problems. I'm aware that
this leaks some amount of memory, but for short-running applications like
NAnt this isn't a big problem.

With this in mind I'd like to propose a new (temporary) option to mono/mint:

&quot;--no-unload&quot;

which would cause a fast return from &quot;mono_domain_unload()&quot; in
&quot;appdomain.c&quot;. This option would be off by default, but could be overriden
through the use of an environment variable, like &quot;MONO_NO_UNLOAD&quot;.
As for the finalizers, they can be a problem too. How about a similar
options:

&quot;--no-finalizers&quot;

that would disable the entire finalization mechanism (there's no guarantee
that finalizers will ever get called, anyway). There would be
&quot;MONO_NO_FINALIZERS&quot; environment variable for this purpose.

This would make many nanters and nuniters happy on Linux, at least for some
time.

I can prepare a patch for this, if the idea gets any acceptance.

Jarek


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004701.html">[Mono-devel-list] Mono Build System
</A></li>
	<LI>Next message: <A HREF="004703.html">[Mono-devel-list] [ANN] Firebird ADO.NET Data Provider 1.5.2 released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4702">[ date ]</a>
              <a href="thread.html#4702">[ thread ]</a>
              <a href="subject.html#4702">[ subject ]</a>
              <a href="author.html#4702">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
