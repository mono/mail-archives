<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] XML Profile List
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20XML%20Profile%20List&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004729.html">
   <LINK REL="Next"  HREF="004743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] XML Profile List</H1>
    <B>Carlos Alberto Cortez Guevara</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20XML%20Profile%20List&In-Reply-To="
       TITLE="[Mono-devel-list] XML Profile List">carlos at unixmexico.org
       </A><BR>
    <I>Tue Mar 23 22:34:39 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004729.html">[Mono-devel-list] RE: SPARC build 0.31 ld option complaint re -v (guessing -ve
</A></li>
        <LI>Next message: <A HREF="004743.html">[Mono-devel-list] XML Profile List
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4730">[ date ]</a>
              <a href="thread.html#4730">[ thread ]</a>
              <a href="subject.html#4730">[ subject ]</a>
              <a href="author.html#4730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I'm attaching a patch to generate a xml file with the profile data
(intended to be used with the profiler gui). It only add some similar
functions with support for the xml file.

Since this is my first code-patch, I want you to review it.

Regards,
Carlos.

-- 
--------------------------------------------------
/* The definition of myself */
using Cortez;
using GeniusIntelligence;

public class Carlos : Human, IGenius, ILinuxUser {

	static void Main () {
		Me.Think();
	}

}

--------------------------------------------------
-------------- next part --------------
? xml_profile.diff
Index: profiler.c
===================================================================
RCS file: /cvs/public/mono/mono/metadata/profiler.c,v
retrieving revision 1.20
diff -u -r1.20 profiler.c
--- profiler.c	22 Mar 2004 17:48:46 -0000	1.20
+++ profiler.c	24 Mar 2004 02:45:20 -0000
@@ -7,6 +7,8 @@
 #include &lt;gmodule.h&gt;
 
 static MonoProfiler * current_profiler = NULL;
+static const char *profiler_xml_file = NULL;
+static FILE *xml_file = NULL;
 
 static MonoProfileAppDomainFunc   domain_start_load;
 static MonoProfileAppDomainResult domain_end_load;
@@ -682,6 +684,61 @@
 	printf (&quot;Total number of calls: %lld\n&quot;, total_calls);
 }
 
+static guint64
+total_number_calls (GList *funcs)
+{
+	GList *tmp;
+	MethodProfile *mp;
+	guint64 total_calls = 0;
+
+	for (tmp = funcs; tmp; tmp = tmp-&gt;next) {
+		mp = tmp-&gt;data;
+		total_calls += mp-&gt;count;
+	}
+
+	return total_calls;
+}
+
+static gboolean output_callers_xml (MethodProfile *p);
+
+static gboolean
+output_profile_xml (GList *funcs)
+{
+	char *m;
+	GList *tmp;
+	guint64 total_calls;
+	int length;
+	MethodProfile *p;
+
+	total_calls = total_number_calls (funcs);
+	length = fprintf (xml_file, &quot;\t&lt;time calls=\&quot;%lld\&quot;&gt;\n&quot;, total_calls);
+	if (length &lt; 0)
+		return FALSE;
+
+	for (tmp = funcs; tmp; tmp = tmp-&gt;next) {
+		p = tmp-&gt;data;
+
+		if (!(gint)(p-&gt;total*1000))
+			continue;
+
+		m = method_get_name (p-&gt;method);
+		length = fprintf (xml_file, &quot;\t\t&lt;method count=\&quot;%llu\&quot; name=\&quot;%s\&quot; time=\&quot;%f\&quot; total=\&quot;%f\&quot;&gt;\n&quot;,
+				p-&gt;count, m, (double) (p-&gt;total * 1000)/(double) p-&gt;count, (double) p-&gt;total * 1000);
+		
+		if (length &lt; 0 || !output_callers_xml (p))
+			return FALSE;
+
+		length = fprintf (xml_file, &quot;\t\t&lt;/method&gt;\n&quot;);
+		g_free (m);
+
+		if (length &lt; 0)
+			return FALSE;
+	}
+	length = fprintf (xml_file, &quot;\t&lt;/time&gt;\n&quot;);
+	
+	return (length &gt; 0)?TRUE:FALSE;
+}
+
 typedef struct {
 	MethodProfile *mp;
 	guint count;
@@ -766,6 +823,106 @@
 	}
 }
 
+static gboolean
+output_callers_xml (MethodProfile *p) {
+	char *m;
+	guint total_callers, percent;
+	int length;
+	CallerInfo *cinfo;
+	GSList *sorted, *tmps;
+
+	total_callers = 0;
+	for (cinfo = p-&gt;caller_info; cinfo; cinfo = cinfo-&gt;next)
+		total_callers += cinfo-&gt;count;
+	sorted = sort_caller_list (p-&gt;caller_info);
+	for (tmps = sorted; tmps; tmps = tmps-&gt;next) {
+		cinfo = tmps-&gt;data;
+		percent = (cinfo-&gt;count * 100)/total_callers;
+		if (percent &lt; 1)
+			continue;
+		m = method_get_name (cinfo-&gt;caller);
+		length = fprintf (xml_file, &quot;\t\t\t&lt;caller count=\&quot;%d\&quot; name=\&quot;%s\&quot; percent=\&quot;%d\&quot;/&gt;\n&quot;,
+				cinfo-&gt;count, m, percent);
+		g_free (m);
+		if (length &lt; 0)
+			return FALSE;
+	}
+
+	return TRUE;
+}
+
+static guint
+total_allocated_mem (GList *proflist)
+{
+	GList *tmp;
+	NewobjProfile *p;
+	guint total = 0;
+
+	for (tmp = proflist; tmp; tmp = tmp-&gt;next) {
+		p = tmp-&gt;data;
+		total += p-&gt;count;
+	}
+
+	return total;
+}
+
+static gboolean
+output_newobj_profile_xml (GList *proflist)
+{
+	AllocInfo *ainfo;
+	GList *tmp;
+	GSList *sorted, *tmps;
+	MethodProfile *mp;
+	MonoClass *klass;
+	NewobjProfile *p;
+	const char *isarray;
+	char *m;
+	char buf [256];
+	guint total;
+	int length;
+
+	total = total_allocated_mem (proflist);
+	length = fprintf (xml_file, &quot;\t&lt;allocation mem=\&quot;%d\&quot;&gt;\n&quot;, total / 1024);
+	if (length &lt; 0)
+		return FALSE;
+	for (tmp = proflist; tmp; tmp = tmp-&gt;next) {
+		p = tmp-&gt;data;
+		if (p-&gt;count &lt; 50000)
+			continue;
+		mp = p-&gt;mp;
+		m = method_get_name (mp-&gt;method);
+		length = fprintf (xml_file, &quot;\t\t&lt;method size=\&quot;%d\&quot; name=\&quot;%s\&quot;&gt;\n&quot;, p-&gt;count / 1024, m);
+		g_free (m);
+		if (length &lt; 0)
+			return FALSE;
+		sorted = sort_alloc_list (mp-&gt;alloc_info);
+		for (tmps = sorted; tmps; tmps = tmps-&gt;next) {
+			ainfo = tmps-&gt;data;
+			if (ainfo-&gt;mem &lt; 50000)
+				continue;
+			klass = ainfo-&gt;klass;
+			if (klass-&gt;rank) {
+				isarray = &quot;[]&quot;;
+				klass = klass-&gt;element_class;
+			} else {
+				isarray = &quot;&quot;;
+			}
+			g_snprintf (buf, sizeof (buf), &quot;%s.%s%s&quot;,
+					klass-&gt;name_space, klass-&gt;name, isarray);
+			length = fprintf (xml_file, &quot;\t\t\t&lt;alloc count=\&quot;%d\&quot; mem=\&quot;%d\&quot; name=\&quot;%s\&quot; /&gt;\n&quot;,
+					ainfo-&gt;count, ainfo-&gt;mem / 1024, buf);
+			if (length &lt; 0)
+				return FALSE;
+		}
+		if (!output_callers_xml (mp) || fprintf (xml_file, &quot;\t\t&lt;/method&gt;\n&quot;) &lt; 0)
+			return FALSE;
+	}
+
+	length = fprintf (xml_file, &quot;\t&lt;/allocation&gt;\n&quot;);
+
+	return (length &lt; 0)?FALSE:TRUE;
+}
+
 static void
 output_newobj_profile (GList *proflist)
 {
@@ -1003,13 +1160,87 @@
 }
 
 static void
-simple_shutdown (MonoProfiler *prof)
+profiler_xml_error ()
+{
+	g_error (&quot;Error writing %s.\n&quot;, profiler_xml_file);
+}
+
+static void
+simple_shutdown_xml (MonoProfiler *prof)
 {
+	gboolean errors;
+	GList *profile = NULL;
+	GSList *tmp;
+	MonoProfiler *tprof;
+	char *str;
+	int length;
+
+	if (!(xml_file = fopen (profiler_xml_file, &quot;w&quot;))) {
+		g_error (&quot;Unable to create profile data in %s&quot;, profiler_xml_file);
+		return;
+	}
+
+	for (tmp = prof-&gt;per_thread; tmp; tmp = tmp-&gt;next) {
+		tprof = tmp-&gt;data;
+		merge_thread_data (prof, tprof);
+	}
+	length = fprintf (xml_file, &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot; ?&gt;\n&lt;profile methods=\&quot;%d\&quot; total=\&quot;%g\&quot;&gt;\n&quot;,
+			prof-&gt;methods_jitted, prof-&gt;jit_time);
+	if (length &lt; 0) {
+		profiler_xml_error ();
+		return;
+	}
+	
+	if (prof-&gt;max_jit_method) {
+		str = method_get_name (prof-&gt;max_jit_method);
+		length = fprintf (xml_file, &quot;\t&lt;slowest name=\&quot;%s\&quot; time=\&quot;%g\&quot; /&gt;\n&quot;, str, prof-&gt;max_jit_time);
+		g_free (str);
+		if (length &lt; 0) {
+			profiler_xml_error ();
+			return;
+		}
+	}
+	
+	g_hash_table_foreach (prof-&gt;methods, (GHFunc)build_profile, &amp;profile);
+	errors = output_profile_xml (profile);
+	g_list_free (profile);
+	profile = NULL;
+
+	if (!errors) {
+		profiler_xml_error ();
+		return;
+	}
+	
+	g_hash_table_foreach (prof-&gt;methods, (GHFunc)build_newobj_profile, &amp;profile);
+	errors = output_newobj_profile_xml (profile);
+	g_list_free (profile);
+
+	if (!errors) {
+		profiler_xml_error ();
+		return;
+	}
+
+	length = fprintf (xml_file, &quot;&lt;/profile&gt;&quot;);
+	if (length &lt; 0)
+		profiler_xml_error ();
+
+	fclose (xml_file);
+	
+}
+
+static void
+simple_shutdown (MonoProfiler *prof)
+{	
 	GList *profile = NULL;
 	MonoProfiler *tprof;
 	GSList *tmp;
 	char *str;
 
+	if (profiler_xml_file &amp;&amp; strcmp (profiler_xml_file, &quot;&quot;)) {
+		simple_shutdown_xml (prof);
+		return;
+	}
+
 	for (tmp = prof-&gt;per_thread; tmp; tmp = tmp-&gt;next) {
 		tprof = tmp-&gt;data;
 		merge_thread_data (prof, tprof);
@@ -1056,11 +1287,17 @@
 			else
 			   if (!strcmp (arg, &quot;-alloc&quot;))
 				   flags &amp;= ~MONO_PROFILE_ALLOCATIONS;
-			   else {
-				   fprintf (stderr, &quot;profiler : Unknown argument '%s'.\n&quot;, arg);
-				   return;
-			   }
+			   else
+				   if (!strcmp (arg, &quot;xml&quot;))
+					   profiler_xml_file = &quot;profile.xml&quot;;
+				   else if (!strncmp (arg, &quot;xml=&quot;, 4))
+					   profiler_xml_file = arg + 4;
+				   else {
+					   fprintf (stderr, &quot;profiler : Unknown argument '%s'.\n&quot;, arg);
+					   return;
+				   }
 		}
+
 	}
 
 	prof = create_profiler ();
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004729.html">[Mono-devel-list] RE: SPARC build 0.31 ld option complaint re -v (guessing -ve
</A></li>
	<LI>Next message: <A HREF="004743.html">[Mono-devel-list] XML Profile List
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4730">[ date ]</a>
              <a href="thread.html#4730">[ thread ]</a>
              <a href="subject.html#4730">[ subject ]</a>
              <a href="author.html#4730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
