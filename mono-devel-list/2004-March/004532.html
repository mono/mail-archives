<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Remove static and non-virtual	methods from the VTable
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Remove%20static%20and%20non-virtual%0A%09methods%20from%20the%20VTable&In-Reply-To=1079195487.23734.14.camel%40melchior.magi">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004531.html">
   <LINK REL="Next"  HREF="004527.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Remove static and non-virtual	methods from the VTable</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Remove%20static%20and%20non-virtual%0A%09methods%20from%20the%20VTable&In-Reply-To=1079195487.23734.14.camel%40melchior.magi"
       TITLE="[Mono-devel-list] [PATCH] Remove static and non-virtual	methods from the VTable">bmaurer at users.sourceforge.net
       </A><BR>
    <I>Sat Mar 13 11:47:41 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004531.html">[Mono-devel-list] [PATCH] Remove static and non-virtual	methods from the VTable
</A></li>
        <LI>Next message: <A HREF="004527.html">[Mono-devel-list] MSBuild ..
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4532">[ date ]</a>
              <a href="thread.html#4532">[ thread ]</a>
              <a href="subject.html#4532">[ subject ]</a>
              <a href="author.html#4532">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As I understand it, the following code takes care of this:


&gt;<i> void 
</I>&gt;<i> mini_emit_virtual_call (MonoCompile *cfg, void *st, MonoInst *tree, int novirtop, int virtop)
</I>&gt;<i> {
</I>&gt;<i> ...
</I>&gt;<i> 	if (!(method-&gt;flags &amp; METHOD_ATTRIBUTE_VIRTUAL) || 
</I>&gt;<i> 	    ((method-&gt;flags &amp; METHOD_ATTRIBUTE_FINAL) &amp;&amp; 
</I>&gt;<i> 	     method-&gt;wrapper_type != MONO_WRAPPER_REMOTING_INVOKE_WITH_CHECK)) {
</I>&gt;<i> 		/* 
</I>&gt;<i> 		 * the method is not virtual, we just need to ensure this is not null
</I>&gt;<i> 		 * and then we can call the method directly.
</I>&gt;<i> 		 */
</I>&gt;<i> 		if (method-&gt;klass-&gt;marshalbyref || method-&gt;klass == mono_defaults.object_class) {
</I>&gt;<i> 			method = ((MonoCallInst*)tree)-&gt;method = mono_marshal_get_remoting_invoke_with_check (method);
</I>&gt;<i> 		}
</I>
When I ran the mono test suite, the first remoting test passed. The
second two failed before my patch was in place, and still failed. The
first one seems to test what you are talking about.

Like you, I do not claim to be an expert in this area. I would love if
lupus or Lluis would chime in here :-).

As I said on IRC, this patch seemed too small to be true, so i would not
be supprised if i am doing something wrong.

-- Ben


On Sat, 2004-03-13 at 11:31, Jonathan Pryor wrote:
&gt;<i> On Sat, 2004-03-13 at 00:12, Ben Maurer wrote:
</I>&gt;<i> &lt;snip/&gt;
</I>&gt;<i> &gt; * class.c : do not include static or non-virtual methods in the vtable.
</I>&gt;<i> 
</I>&gt;<i> I could be completely wrong, but how do you handle remoting?
</I>&gt;<i> 
</I>&gt;<i> AFAIK, .NET remoting is handled by giving a TransparentProxy object to
</I>&gt;<i> the client code, instead of a reference to the actual object (as the
</I>&gt;<i> actual object may be in a different process, etc.).  The
</I>&gt;<i> TransparentProxy is special, in that it can be cast to any interface and
</I>&gt;<i> any object, and it delegates function calls to a RealProxy, which
</I>&gt;<i> handles communication with the actual object, wherever it may be.
</I>&gt;<i> 
</I>&gt;<i> The key point to this, though, is that you can't directly invoke any
</I>&gt;<i> methods on any class deriving from MarshalByRefObject, unless you KNOW
</I>&gt;<i> it's in the same AppDomain you're in.  As such, all function calls on a
</I>&gt;<i> MarshalByRefObject subclass are typically virtual, so that the
</I>&gt;<i> TransparentProxy can intercept the method call and delegate it to the
</I>&gt;<i> RealProxy appropriately.
</I>&gt;<i> 
</I>&gt;<i> So if you remove all non-virtual functions from the vtable, how will
</I>&gt;<i> this interact with Remoting?  With your patch, non-virtual methods won't
</I>&gt;<i> have a vtable slot, so the TransparentProxy won't be able to intercept
</I>&gt;<i> the invocation, breaking remoting behavior.
</I>&gt;<i> 
</I>&gt;<i> Granted, I could be mis-understanding this (I'm no remoting expert), but
</I>&gt;<i> this is my current understanding.
</I>&gt;<i> 
</I>&gt;<i>  - Jon
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004531.html">[Mono-devel-list] [PATCH] Remove static and non-virtual	methods from the VTable
</A></li>
	<LI>Next message: <A HREF="004527.html">[Mono-devel-list] MSBuild ..
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4532">[ date ]</a>
              <a href="thread.html#4532">[ thread ]</a>
              <a href="subject.html#4532">[ subject ]</a>
              <a href="author.html#4532">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
