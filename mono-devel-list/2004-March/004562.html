<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Field Layout Optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Field%20Layout%20Optimization&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004555.html">
   <LINK REL="Next"  HREF="004564.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Field Layout Optimization</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Field%20Layout%20Optimization&In-Reply-To="
       TITLE="[Mono-devel-list] [PATCH] Field Layout Optimization">bernard at ugsolutions.com
       </A><BR>
    <I>Mon Mar 15 14:40:18 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004555.html">[Mono-devel-list] [PATCH] Field Layout Optimization
</A></li>
        <LI>Next message: <A HREF="004564.html">[Mono-devel-list] [PATCH] Field Layout Optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4562">[ date ]</a>
              <a href="thread.html#4562">[ thread ]</a>
              <a href="subject.html#4562">[ subject ]</a>
              <a href="author.html#4562">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If you are going to do this sort of relayout then it would be good to 
implement the full behaviour which looking at the LayoutKind 
documentation says for Auto:

    The runtime automatically chooses an appropriate layout for the 
    members of an object in unmanaged memory. Objects defined 
    with this enumeration member cannot be exposed outside of 
    managed code. Attempting to do so generates an exception.

Note the last sentence. If you don't people will get all sorts
of odd behaviour with pinvoke if there is no explicit exception
(of course this could force the corlib problems for structs of
POD data to get fixed too).

Bernie Solomon

----- Original Message ----- 
From: &quot;Ben Maurer&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at users.sourceforge.net</A>&gt;
To: &quot;Mono Development&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Sunday, March 14, 2004 3:24 PM
Subject: [Mono-devel-list] [PATCH] Field Layout Optimization


&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> The following patch optimizes the layout of fields both for object
</I>&gt;<i> instances and for static data.
</I>&gt;<i> 
</I>&gt;<i> The patch does two things:
</I>&gt;<i> 
</I>&gt;<i> Create a better autolayout:
</I>&gt;<i>         Right now, we do a `GC aware' layout that places object
</I>&gt;<i>         references at the beginning of the object. However we can do
</I>&gt;<i>         better.
</I>&gt;<i>         
</I>&gt;<i>         Lets say you have the following class:
</I>&gt;<i>         class T {
</I>&gt;<i>            bool a;
</I>&gt;<i>            long b;
</I>&gt;<i>            bool c;
</I>&gt;<i>            long d;
</I>&gt;<i>         }
</I>&gt;<i>         
</I>&gt;<i>         We lay out the class as follows (. is padding):
</I>&gt;<i>         a.......bbbbbbbbc.......dddddddd
</I>&gt;<i>         
</I>&gt;<i>         However, obviously we are wasting alot of space with padding.
</I>&gt;<i>         This patch makes the class get laid out as:
</I>&gt;<i>         
</I>&gt;<i>         ab......bbbbbbbbdddddddd
</I>&gt;<i> 
</I>&gt;<i> Omit literal data from static memory:
</I>&gt;<i>         Right now, if you have a literal field (const in C#), the field
</I>&gt;<i>         is stored in memory. However the CLI spec says `In contrast to
</I>&gt;<i>         initonly fields, literal fields do not exist at runtime. There
</I>&gt;<i>         is no memory allocated for them. literal fields become part of
</I>&gt;<i>         the metadata but cannot be accessed by the code'. This patch
</I>&gt;<i>         implements that behavior. For MCS bootstrap, this reduces the
</I>&gt;<i>         static memory by 2kb, from 7kb to 5kb.
</I>&gt;<i> 
</I>&gt;<i> As well, a command line option is added to mini, --print-class-layout.
</I>&gt;<i> This prints the physical layout of every class the runtime uses. Some
</I>&gt;<i> sample output is:
</I>&gt;<i> &gt; Layout for System.Type
</I>&gt;<i> &gt;  Instance:
</I>&gt;<i> &gt;       0 -   8 &lt;parent&gt; (MemberInfo)
</I>&gt;<i> &gt;       8 -  12 _impl (System.RuntimeTypeHandle)
</I>&gt;<i> &gt;  Static:
</I>&gt;<i> &gt;       0 -   4 EmptyTypes (System.Type[])
</I>&gt;<i> &gt;       4 -   8 FilterAttribute (System.Reflection.MemberFilter)
</I>&gt;<i> &gt;       8 -  12 FilterName (System.Reflection.MemberFilter)
</I>&gt;<i> &gt;      12 -  16 FilterNameIgnoreCase (System.Reflection.MemberFilter)
</I>&gt;<i> &gt;      16 -  20 Missing (System.Object)
</I>&gt;<i> &gt;      20 -  22 Delimiter (System.Char)
</I>&gt;<i> 
</I>&gt;<i> This was very helpful to me while designing the patch, and I hope it
</I>&gt;<i> might be of aid to hackers in the future.
</I>&gt;<i> 
</I>&gt;<i> A ChangeLog:
</I>&gt;<i> 
</I>&gt;<i> * class.[ch]:
</I>&gt;<i>         - (mono_print_class_layout) A global variable to signal that
</I>&gt;<i>         layout tables should be printed
</I>&gt;<i>         - (mono_class_layout_fields) Optimize field layout. For instance
</I>&gt;<i>         fields, reference fields are placed first, then sorted by
</I>&gt;<i>         alignment requirements. For static fields, just sorted by
</I>&gt;<i>         alignment requirmeents. Also, literal fields are not included in
</I>&gt;<i>         the static layout plan.
</I>&gt;<i>         - (print_class_layout) a utility function to print class layout.
</I>&gt;<i> * icall.c, reflection.c:
</I>&gt;<i>         - account for api changes.
</I>&gt;<i> * object.[ch]:
</I>&gt;<i>         - (get_default_field_value) A helper to get a fields default
</I>&gt;<i>         value, as stored in the metadata.
</I>&gt;<i>         - (mono_class_vtable) Account for api changes; Assert that a
</I>&gt;<i>         field being RVA based is mutually exclusive with having a
</I>&gt;<i>         default value, do not place literal fields in the static data
</I>&gt;<i>         area.
</I>&gt;<i>         - (mono_field_static_set_value) assert that a constant is not
</I>&gt;<i>         being set.
</I>&gt;<i>         - (mono_field_static_get_value) get literal values directly from
</I>&gt;<i>         the metadata.
</I>&gt;<i>         - (mono_ldstr_metdata_sig) load a string from *anywhere* in the
</I>&gt;<i>         metadata. A generalization of mono_ldstr.
</I>&gt;<i>         - (mono_ldstr) call mono_ldstr_metdata_sig
</I>&gt;<i> 
</I>&gt;<i> Open issues:
</I>&gt;<i>       * Is the assertion that being rva based and having a default value
</I>&gt;<i>         are mutually exclusive correct? It would not be logical to have
</I>&gt;<i>         both.
</I>&gt;<i>       * What should mono_field_static_set_value when it tries to set a
</I>&gt;<i>         const value?
</I>&gt;<i>       * Is it correct to load strings that are stored in literal fields
</I>&gt;<i>         as interned. The reason I did this was to ensure that we dont
</I>&gt;<i>         create a string on each access (which is incorrect). However, I
</I>&gt;<i>         am not sure if it shoudl be interned.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This patch caused no regressions on corlib tests, mono/tests or the mini
</I>&gt;<i> regression tests.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004555.html">[Mono-devel-list] [PATCH] Field Layout Optimization
</A></li>
	<LI>Next message: <A HREF="004564.html">[Mono-devel-list] [PATCH] Field Layout Optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4562">[ date ]</a>
              <a href="thread.html#4562">[ thread ]</a>
              <a href="subject.html#4562">[ subject ]</a>
              <a href="author.html#4562">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
