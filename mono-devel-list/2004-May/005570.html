<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] ORBit2 binding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20ORBit2%20binding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005560.html">
   <LINK REL="Next"  HREF="005575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] ORBit2 binding</H1>
    <B>David Voit</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20ORBit2%20binding&In-Reply-To="
       TITLE="[Mono-devel-list] ORBit2 binding">david.voit at weihenstephan.org
       </A><BR>
    <I>Sun May  9 19:24:26 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="005560.html">[Mono-devel-list] OciDefineHandle.cs patches for System.Data.OracleClient data provider
</A></li>
        <LI>Next message: <A HREF="005575.html">[Mono-devel-list] ORBit2 binding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5570">[ date ]</a>
              <a href="thread.html#5570">[ thread ]</a>
              <a href="subject.html#5570">[ subject ]</a>
              <a href="author.html#5570">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I try to write a sample mono Programm which implements the echo client
from the orbit-docs Package.

Now I need help from People which understand C# and P/Invoke much better
than me.

Some questions:
- Is it possible to DllImport extern variables
- Howto generate pointer arrays like this in C#:
gpointer _args[1];
char *string = &quot;Hello World&quot;;

_args[0] = &amp;string;

If i get these solved I could drop libglue.so

Now to the Code it compiles, but it fails in ORBit_c_stub_invoke on
execution.

&gt;&gt;<i> glue.c
</I>#include &lt;orbit/orbit.h&gt;

CORBA_ORB orb_init (char *orb_identifier, CORBA_Environment *ev)
{
	int argc = 1;
	char *argv[1];
	argv[0] = &quot;test&quot;;

	return CORBA_ORB_init (&amp;argc, argv, orb_identifier, ev);
}

CORBA_TypeCode get_typecode (CORBA_TCKind kind)
{
	switch (kind)
	{
		case CORBA_tk_null: return TC_null;
		case CORBA_tk_void: return TC_void;
		case CORBA_tk_short: return TC_CORBA_short;
		case CORBA_tk_long: return TC_CORBA_long;
		case CORBA_tk_longlong: return TC_CORBA_long_long;
		case CORBA_tk_ushort: return TC_CORBA_unsigned_short;
		case CORBA_tk_ulong: return TC_CORBA_unsigned_long;
		case CORBA_tk_ulonglong: return TC_CORBA_unsigned_long_long;
		case CORBA_tk_float: return TC_CORBA_float;
		case CORBA_tk_double: return TC_CORBA_double;
		case CORBA_tk_longdouble: return TC_CORBA_long_double;
		case CORBA_tk_boolean: return TC_CORBA_boolean;
		case CORBA_tk_char: return TC_CORBA_char;
		case CORBA_tk_wchar: return TC_CORBA_wchar;
		case CORBA_tk_octet: return TC_CORBA_octet;
		case CORBA_tk_any: return TC_CORBA_any;
		case CORBA_tk_TypeCode: return TC_CORBA_TypeCode;
		case CORBA_tk_string: return TC_CORBA_string;
	}

	return (CORBA_TypeCode) NULL;
}

gpointer get_string ()
{
	static void *_args[1];

	static char *str = &quot;Hello World!&quot;;

	_args[0] = &amp;str;

	return _args;
}

&gt;&gt;<i> main.c
</I>#include &lt;orbit/orbit.h&gt;
#include &lt;stdio.h&gt;

CORBA_ORB orb_init (char *orb_identifier, CORBA_Environment *ev);
CORBA_TypeCode get_typecode (CORBA_TCKind kind);

int
main (int argc, char* argv[])
{
   gpointer _args[1];
	CORBA_Environment *ev = NULL;
	CORBA_ORB orb;
	CORBA_Object echo;
	char *string =  &quot;Hello from C&quot;;
	char ior[2048];
	FILE *echo_ref;
	int i;

	ORBit_IArg arginfo[] = {
	{get_typecode (CORBA_tk_string), ORBit_I_ARG_IN, &quot;input&quot;}
	};

	ORBit_IMethod imethod[] =
	{
		{{1, 1, arginfo, FALSE},
			{0, 0, NULL, FALSE},
			{0, 0, NULL, FALSE},
			get_typecode (CORBA_tk_void), &quot;echoString&quot;, 10,
		0	}
	};

	ORBit_IMethods methods = {1, 1, imethod, FALSE};

	if (argc &gt; 1)
		_args[0] = &amp;argv[1];
	else
		_args[0] = &amp;string;

	echo_ref = fopen (&quot;echo.ref&quot;, &quot;r&quot;);

	fread (&amp;ior, sizeof(char), 2048, echo_ref);

	fclose (echo_ref);

	ev = CORBA_exception__alloc ();

	CORBA_exception_init (ev);

	orb = orb_init (&quot;orbit-local-orb&quot;, ev);

	echo = CORBA_ORB_string_to_object (orb, ior, ev);

   ORBit_c_stub_invoke(echo, &amp;methods, 0, NULL, get_string (), NULL,
					   ev, 0, 4,
					   NULL);

	CORBA_ORB_destroy(orb, ev);

	CORBA_exception_free (ev);

	CORBA_free (ev);

	return 0;
}

&gt;&gt;<i> main.cs
</I>using System;
using System.IO;
using System.Runtime.InteropServices;

public struct IArg
{
	public IntPtr typecode; //TypeCodes are extern in libORBit-2.so.0
	public long flags;
	public String name;
};

public struct IArgs
{
	public ulong _maximum, _length;
	public IArg[] _buffer;
	public bool _release;
}

public struct IContexts
{
	public ulong _maximum, _length;
	public string[] _buffer;
	public bool _release;
}

public struct ITypes
{
	public ulong _maximum, _length;
	public IntPtr[] _buffer; //TypeCode again
	public bool _release;
}

public struct IMethod
{
	public IArgs arguments;
	public IContexts contexts;
	public ITypes exceptions;
	public IntPtr ret; //TypeCode again
	public string name;
	public long name_len;
	public long flags;
}

public struct IMethods
{
	public ulong _maximum, _length;
	public IMethod[] _buffer;
	public bool _release;
}

public class SimpleCorbaClient
{
	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern IntPtr CORBA_exception__alloc ();

	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern void CORBA_free (IntPtr ptr);

	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern void CORBA_exception_free (IntPtr ev);

	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern IntPtr CORBA_ORB_string_to_object (IntPtr orb, string ior, IntPtr ev);

	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern void CORBA_ORB_destroy (IntPtr orb, IntPtr ev);

	[DllImport(&quot;libORBit-2.so.0&quot;)]
	public static extern void ORBit_c_stub_invoke (IntPtr obj,
						       IMethods[] methods, 
						       long method_index,
						       IntPtr ret,
						       IntPtr args,
						       IntPtr ctx,
						       IntPtr ev,
						       long class_id,
						       long method_offset,
						       IntPtr skel_impl);

	[DllImport(&quot;libglue.so&quot;)]
	public static extern IntPtr orb_init (string orb_identifier, IntPtr ev);

	[DllImport(&quot;libglue.so&quot;)]
	public static extern IntPtr get_typecode (long kind);

	[DllImport(&quot;libglue.so&quot;)]
	public static extern IntPtr get_string ();

	static void Main()
	{

		IArg[] arginfo = new IArg[1];
		IArgs args;
		IContexts contexts;
		ITypes types;
		IMethod[] imethod = new IMethod[1];
		IMethods[] imethods = new IMethods[1];
		IntPtr ev;
		IntPtr orb;
		IntPtr echo;

		string ior;
		using (StreamReader iorFile = new StreamReader(&quot;echo.ref&quot;))
		{
			ior = iorFile.ReadToEnd();
		}

		arginfo[0].typecode = get_typecode (18);
		arginfo[0].flags = 32;
		arginfo[0].name = &quot;input&quot;;

		args._maximum = 1;
		args._length = 1;
		args._buffer = arginfo;
		args._release = false;

		contexts._maximum = 0;
		contexts._length = 0;
		contexts._buffer = null;
		contexts._release = false;

		types._maximum = 0;
		types._length = 0;
		types._buffer = null;
		types._release = false;

		imethod[0].arguments = args;
		imethod[0].contexts = contexts;
		imethod[0].exceptions = types;
		imethod[0].ret = get_typecode (1);
		imethod[0].name = &quot;echoString&quot;;
		imethod[0].name_len = 10;
		imethod[0].flags = 0;

		imethods[0]._maximum = 1;
		imethods[0]._length = 1;
		imethods[0]._buffer = imethod;
		imethods[0]._release = false;

		ev = CORBA_exception__alloc ();

		orb = orb_init (&quot;orbit-local-orb&quot;, ev);

		echo = CORBA_ORB_string_to_object (orb, ior, ev);

		ORBit_c_stub_invoke(echo, imethods, 0, IntPtr.Zero, get_string(), IntPtr.Zero,
					   ev, 0, 4,
					   IntPtr.Zero);

		CORBA_ORB_destroy(orb, ev);

		CORBA_exception_free (ev);

		CORBA_free (ev);
	}
}



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005560.html">[Mono-devel-list] OciDefineHandle.cs patches for System.Data.OracleClient data provider
</A></li>
	<LI>Next message: <A HREF="005575.html">[Mono-devel-list] ORBit2 binding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5570">[ date ]</a>
              <a href="thread.html#5570">[ thread ]</a>
              <a href="subject.html#5570">[ subject ]</a>
              <a href="author.html#5570">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
