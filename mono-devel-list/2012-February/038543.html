<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Handling%20StackOverflow%2C%20OutOfMemory%2C%0A%09ThreadAbortException&In-Reply-To=%3CCACmR%2BBA-bZFDuKvH25AX7J%2Bp61cz9ZKPc3X59nShf1qocZA8HQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038539.html">
   <LINK REL="Next"  HREF="038560.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Handling%20StackOverflow%2C%20OutOfMemory%2C%0A%09ThreadAbortException&In-Reply-To=%3CCACmR%2BBA-bZFDuKvH25AX7J%2Bp61cz9ZKPc3X59nShf1qocZA8HQ%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException">kumpera at gmail.com
       </A><BR>
    <I>Wed Feb  1 21:22:33 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038539.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
        <LI>Next message: <A HREF="038560.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38543">[ date ]</a>
              <a href="thread.html#38543">[ thread ]</a>
              <a href="subject.html#38543">[ subject ]</a>
              <a href="author.html#38543">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 1, 2012 at 1:39 PM, Miguel Mudge
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">michael.mudge at welchallyn.com</A>&gt;wrote:

&gt;<i> On Wed, Feb 1, 2012 at 9:48 AM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Wed, Feb 1, 2012 at 12:22 PM, Miguel Mudge &lt;
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">michael.mudge at welchallyn.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes, it's got machine exceptions.  With the help of the MMU, we are able
</I>&gt;&gt;&gt;<i> to detect when the stack is down to the last 64K, so there is no need for
</I>&gt;&gt;&gt;<i> an alternate stack.  We can call a function from there, somewhat akin to
</I>&gt;&gt;&gt;<i> signals.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On which stack and thread is that function called? You obviously can't
</I>&gt;&gt;<i> call it on the overflown one.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The RTOS is ThreadX for ARM - it is fairly useless.  Mono is supported
</I>&gt;<i> mostly by a homebrew POSIX implementation wrapped around it [cringe].
</I>&gt;<i>
</I>&gt;<i> We wrote our own MMU driver.  When an overflow occurs, we increase the
</I>&gt;<i> size of the stack on the fly and call the overflow-handling function on the
</I>&gt;<i> same thread and stack where the overflow occurred.  When that function
</I>&gt;<i> returns, execution resumes on the instruction that caused the overflow, but
</I>&gt;<i> this time with the larger stack.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The requirements are that:
</I>&gt;&gt;&gt;<i> - The native code is allowed to continue execution.
</I>&gt;&gt;&gt;<i> - The managed code throws a StackOverflowException that executes finally
</I>&gt;&gt;&gt;<i> blocks.
</I>&gt;&gt;&gt;<i> - The root AppDomain continues running.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The out-of-memory exception is almost the exact same story... When
</I>&gt;&gt;&gt;<i> memory gets low, I want to be able to do something that allows native code
</I>&gt;&gt;&gt;<i> to continue, but OutOfMemoryException is thrown when execution returns to
</I>&gt;&gt;&gt;<i> managed code.  I assume there is no mechanism in there for this?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OOM is quite a different beast, it's handled synchronously since we know
</I>&gt;&gt;<i> exactly when we're out of managed memory. Mono doesn't handle native
</I>&gt;&gt;<i> allocation failures
</I>&gt;&gt;<i>  well and this is something I would love to see patches for. Managed
</I>&gt;&gt;<i> allocation failures are well handled with sgen.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since Mono doesn't handle running out of system memory very well, I'd
</I>&gt;<i> rather actually handle it in exactly the same way as StackOverflowException
</I>&gt;<i> - free up some &quot;guard memory&quot; and throw the OutOfMemoryException when
</I>&gt;<i> execution returns to native code.
</I>&gt;<i>
</I>&gt;<i> In the context of our own requirements, I still see ThreadAbortException,
</I>&gt;<i> StackOverflowException and OutOfMemoryException as ideally following the
</I>&gt;<i> same code path.  In all 3 cases, a specific thread isn't prepared to handle
</I>&gt;<i> the exception on the the exact instruction where it happens, so the
</I>&gt;<i> exception gets thrown at the native-&gt;managed transition.
</I>&gt;<i>
</I>&gt;<i> Perhaps I'm oversimplifying this - maybe the thread abort code is too
</I>&gt;<i> specific to thread abort, and I certainly don't want to butcher it.  To me,
</I>&gt;<i> so far, this looks like an opportunity to generalize code that was
</I>&gt;<i> originally intended to be an exception [so to speak] to the way
</I>&gt;<i> ThreadAbortException is thrown, compared to other exceptions.
</I>&gt;<i>
</I>&gt;<i> We're also not super-familiar with all of Mono's existing facilities for
</I>&gt;<i> this stuff - if there is a straightforward function we should call and/or
</I>&gt;<i> adapt to our environment, that'd be quite helpful too.
</I>&gt;<i>
</I>

Now I see how and what you're trying to accomplish. Let's think in steps.

About OOM. The managed case is already handled for you, the unmanaged one
will require some environment help. But your plan of releasing some guard
memory and
then raising an OOM exception is sound.

To apply it to stack overflow is a bit trickier since you need  to handle
the case where managed code is executing as well.

To handle native OOM, I guess patching the thread interruption code is the
easier way to go. Change mono_thread_interruption_checkpoint_request to
check for your OOM condition and you're set.

To handle stack overflow it will require a bit more work. You could
patch mono_thread_interruption_checkpoint_request to check for it as well.
But would still need to patch the stack with a trampoline to raise the
overflow exception in case it happens strictly on managed code.

And then you have a trickier issue, which is to reconquer soft guard pages
from stack and memory allocator. This is specially important in case of
stack overflow.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120201/8769a8c1/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120201/8769a8c1/attachment-0001.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038539.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
	<LI>Next message: <A HREF="038560.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38543">[ date ]</a>
              <a href="thread.html#38543">[ thread ]</a>
              <a href="subject.html#38543">[ subject ]</a>
              <a href="author.html#38543">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
