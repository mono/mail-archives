<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Handling%20StackOverflow%2C%20OutOfMemory%2C%0A%09ThreadAbortException&In-Reply-To=%3CCAO5XfkA88mhq%3DF%3DDVUcELe-XEQvtLTuSgTrviGt6BGoDrCkm7w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038537.html">
   <LINK REL="Next"  HREF="038543.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException</H1>
    <B>Miguel Mudge</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Handling%20StackOverflow%2C%20OutOfMemory%2C%0A%09ThreadAbortException&In-Reply-To=%3CCAO5XfkA88mhq%3DF%3DDVUcELe-XEQvtLTuSgTrviGt6BGoDrCkm7w%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException">michael.mudge at welchallyn.com
       </A><BR>
    <I>Wed Feb  1 15:39:37 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038537.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
        <LI>Next message: <A HREF="038543.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38539">[ date ]</a>
              <a href="thread.html#38539">[ thread ]</a>
              <a href="subject.html#38539">[ subject ]</a>
              <a href="author.html#38539">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 1, 2012 at 9:48 AM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:

&gt;<i> On Wed, Feb 1, 2012 at 12:22 PM, Miguel Mudge &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">michael.mudge at welchallyn.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Yes, it's got machine exceptions.  With the help of the MMU, we are able
</I>&gt;&gt;<i> to detect when the stack is down to the last 64K, so there is no need for
</I>&gt;&gt;<i> an alternate stack.  We can call a function from there, somewhat akin to
</I>&gt;&gt;<i> signals.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On which stack and thread is that function called? You obviously can't
</I>&gt;<i> call it on the overflown one.
</I>&gt;<i>
</I>
The RTOS is ThreadX for ARM - it is fairly useless.  Mono is supported
mostly by a homebrew POSIX implementation wrapped around it [cringe].

We wrote our own MMU driver.  When an overflow occurs, we increase the size
of the stack on the fly and call the overflow-handling function on the same
thread and stack where the overflow occurred.  When that function returns,
execution resumes on the instruction that caused the overflow, but this
time with the larger stack.


&gt;<i> The requirements are that:
</I>&gt;&gt;<i> - The native code is allowed to continue execution.
</I>&gt;&gt;<i> - The managed code throws a StackOverflowException that executes finally
</I>&gt;&gt;<i> blocks.
</I>&gt;&gt;<i> - The root AppDomain continues running.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The out-of-memory exception is almost the exact same story... When memory
</I>&gt;&gt;<i> gets low, I want to be able to do something that allows native code to
</I>&gt;&gt;<i> continue, but OutOfMemoryException is thrown when execution returns to
</I>&gt;&gt;<i> managed code.  I assume there is no mechanism in there for this?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> OOM is quite a different beast, it's handled synchronously since we know
</I>&gt;<i> exactly when we're out of managed memory. Mono doesn't handle native
</I>&gt;<i> allocation failures
</I>&gt;<i>  well and this is something I would love to see patches for. Managed
</I>&gt;<i> allocation failures are well handled with sgen.
</I>&gt;<i>
</I>
Since Mono doesn't handle running out of system memory very well, I'd
rather actually handle it in exactly the same way as StackOverflowException
- free up some &quot;guard memory&quot; and throw the OutOfMemoryException when
execution returns to native code.

In the context of our own requirements, I still see ThreadAbortException,
StackOverflowException and OutOfMemoryException as ideally following the
same code path.  In all 3 cases, a specific thread isn't prepared to handle
the exception on the the exact instruction where it happens, so the
exception gets thrown at the native-&gt;managed transition.

Perhaps I'm oversimplifying this - maybe the thread abort code is too
specific to thread abort, and I certainly don't want to butcher it.  To me,
so far, this looks like an opportunity to generalize code that was
originally intended to be an exception [so to speak] to the way
ThreadAbortException is thrown, compared to other exceptions.

We're also not super-familiar with all of Mono's existing facilities for
this stuff - if there is a straightforward function we should call and/or
adapt to our environment, that'd be quite helpful too.

- Kipp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120201/8934b25e/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120201/8934b25e/attachment.html</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038537.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
	<LI>Next message: <A HREF="038543.html">[Mono-dev] Handling StackOverflow, OutOfMemory,	ThreadAbortException
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38539">[ date ]</a>
              <a href="thread.html#38539">[ thread ]</a>
              <a href="subject.html#38539">[ subject ]</a>
              <a href="author.html#38539">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
