<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Little-endian MIPS support -- first draft
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Little-endian%20MIPS%20support%20--%20first%20draft&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032459.html">
   <LINK REL="Next"  HREF="032464.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Little-endian MIPS support -- first draft</H1>
    <B>Rayson Ho</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Little-endian%20MIPS%20support%20--%20first%20draft&In-Reply-To="
       TITLE="[Mono-dev] Little-endian MIPS support -- first draft">raysonlogin at gmail.com
       </A><BR>
    <I>Mon Jun 22 03:56:03 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032459.html">[Mono-dev] register allocator.
</A></li>
        <LI>Next message: <A HREF="032464.html">[Mono-dev] [PATCH] Interrupting socket calls on Windows during	shutdown.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32463">[ date ]</a>
              <a href="thread.html#32463">[ thread ]</a>
              <a href="subject.html#32463">[ subject ]</a>
              <a href="author.html#32463">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>These are the core changes for supporting Mono on MIPS-EL. The problem
in the existing code (MIPS in big-endian mode) is that it is assuming
&quot;lower-numbered reg is most significant&quot;, which is not true.

Test code:
  long long abc = 929;
  func(abc);

gcc generates:
        li      $2,929                  # 0x3a1
        move    $3,$0
        sw      $2,24($fp)
        sw      $3,28($fp)
        .loc 1 12 0
        lw      $4,24($fp)
        lw      $5,28($fp)
        lw      $25,%call16(func)($28)

Note that the lower-numbered reg ($4) holds the less significant word,
while $5 holds the more significant word.


# svn diff mono/mini/mini-mips.c
Index: mono/mini/mini-mips.c
===================================================================
--- mono/mini/mini-mips.c       (revision 136576)
+++ mono/mini/mini-mips.c       (working copy)
@@ -1467,13 +1464,13 @@
                                ins-&gt;dreg = mono_alloc_ireg (cfg);
                                ins-&gt;sreg1 = in-&gt;dreg + 1;
                                MONO_ADD_INS (cfg-&gt;cbb, ins);
-                               mono_call_inst_add_outarg_reg (cfg,
call, ins-&gt;dreg, ainfo-&gt;reg + 1, FALSE);
+                               mono_call_inst_add_outarg_reg (cfg,
call, ins-&gt;dreg, ainfo-&gt;reg + REGPAIR_LOW, FALSE);

                                MONO_INST_NEW (cfg, ins, OP_MOVE);
                                ins-&gt;dreg = mono_alloc_ireg (cfg);
                                ins-&gt;sreg1 = in-&gt;dreg + 2;
                                MONO_ADD_INS (cfg-&gt;cbb, ins);
-                               mono_call_inst_add_outarg_reg (cfg,
call, ins-&gt;dreg, ainfo-&gt;reg, FALSE);
+                               mono_call_inst_add_outarg_reg (cfg,
call, ins-&gt;dreg, ainfo-&gt;reg + REGPAIR_HIGH, FALSE);
                        } else
 #endif
                        if (!t-&gt;byref &amp;&amp; (t-&gt;type == MONO_TYPE_R4)) {
@@ -1694,8 +1691,8 @@
                        MonoInst *ins;

                        MONO_INST_NEW (cfg, ins, OP_SETLRET);
-                       ins-&gt;sreg1 = val-&gt;dreg + 1;
-                       ins-&gt;sreg2 = val-&gt;dreg + 2;
+                       ins-&gt;sreg1 = val-&gt;dreg + 1 + REGPAIR_HIGH;
+                       ins-&gt;sreg2 = val-&gt;dreg + 1 + REGPAIR_LOW;
                        MONO_ADD_INS (cfg-&gt;cbb, ins);
                        return;
                }
@@ -3552,8 +3549,8 @@
                        mips_mtc1 (code, ins-&gt;dreg, ins-&gt;sreg1);
                        break;
                case OP_MIPS_MTC1S_2:
-                       mips_mtc1 (code, ins-&gt;dreg, ins-&gt;sreg1);
-                       mips_mtc1 (code, ins-&gt;dreg+1, ins-&gt;sreg2);
+                       mips_mtc1 (code, ins-&gt;dreg + REGPAIR_HIGH, ins-&gt;sreg1);
+                       mips_mtc1 (code, ins-&gt;dreg + REGPAIR_LOW,  ins-&gt;sreg2);
                        break;
                case OP_MIPS_MFC1S:
                        mips_mfc1 (code, ins-&gt;dreg, ins-&gt;sreg1);
@@ -3565,8 +3562,8 @@
 #if 0
                        mips_dmfc1 (code, ins-&gt;dreg, ins-&gt;sreg1);
 #else
-                       mips_mfc1 (code, ins-&gt;dreg+1, ins-&gt;sreg1);
-                       mips_mfc1 (code, ins-&gt;dreg, ins-&gt;sreg1+1);
+                       mips_mfc1 (code, ins-&gt;dreg,   ins-&gt;sreg1 + REGPAIR_LOW);
+                       mips_mfc1 (code, ins-&gt;dreg+1, ins-&gt;sreg1 +
REGPAIR_HIGH);
 #endif
                        break;

@@ -4012,8 +4009,8 @@
                        mips_ldc1 (code, ins-&gt;dreg, mips_at,
((guint32)ins-&gt;inst_p0) &amp; 0xffff);
 #else
                        mips_load_const (code, mips_at, ins-&gt;inst_p0);
-                       mips_lwc1 (code, ins-&gt;dreg, mips_at, 4);
-                       mips_lwc1 (code, ins-&gt;dreg+1, mips_at, 0);
+                       mips_lwc1 (code, ins-&gt;dreg + REGPAIR_LOW,  mips_at, 0);
+                       mips_lwc1 (code, ins-&gt;dreg + REGPAIR_HIGH, mips_at, 4);
 #endif
                        break;
                case OP_R4CONST:
@@ -4029,31 +4026,31 @@
                case OP_STORER8_MEMBASE_REG:
                        if (mips_is_imm16 (ins-&gt;inst_offset)) {
 #if _MIPS_SIM == _ABIO32
-                               mips_swc1 (code, ins-&gt;sreg1,
ins-&gt;inst_destbasereg, ins-&gt;inst_offset+4);
-                               mips_swc1 (code, ins-&gt;sreg1+1,
ins-&gt;inst_destbasereg, ins-&gt;inst_offset);
+                                mips_swc1 (code, ins-&gt;sreg1 +
REGPAIR_LOW,  ins-&gt;inst_destbasereg, ins-&gt;inst_offset);
+                               mips_swc1 (code, ins-&gt;sreg1 +
REGPAIR_HIGH, ins-&gt;inst_destbasereg, ins-&gt;inst_offset+4);
 #elif _MIPS_SIM == _ABIN32
                                mips_sdc1 (code, ins-&gt;sreg1,
ins-&gt;inst_destbasereg, ins-&gt;inst_offset);
 #endif
                        } else {
                                mips_load_const (code, mips_at,
ins-&gt;inst_offset);
                                mips_addu (code, mips_at, mips_at,
ins-&gt;inst_destbasereg);
-                               mips_swc1 (code, ins-&gt;sreg1, mips_at, 4);
-                               mips_swc1 (code, ins-&gt;sreg1+1, mips_at, 0);
+                               mips_swc1 (code, ins-&gt;sreg1 +
REGPAIR_LOW,  mips_at, 0);
+                               mips_swc1 (code, ins-&gt;sreg1 +
REGPAIR_HIGH, mips_at, 4);
                        }
                        break;
                case OP_LOADR8_MEMBASE:
                        if (mips_is_imm16 (ins-&gt;inst_offset)) {
 #if _MIPS_SIM == _ABIO32
-                               mips_lwc1 (code, ins-&gt;dreg,
ins-&gt;inst_basereg, ins-&gt;inst_offset+4);
-                               mips_lwc1 (code, ins-&gt;dreg+1,
ins-&gt;inst_basereg, ins-&gt;inst_offset);
+                                mips_lwc1 (code, ins-&gt;dreg +
REGPAIR_LOW,  ins-&gt;inst_basereg, ins-&gt;inst_offset);
+                               mips_lwc1 (code, ins-&gt;dreg +
REGPAIR_HIGH, ins-&gt;inst_basereg, ins-&gt;inst_offset+4);
 #elif _MIPS_SIM == _ABIN32
                                mips_ldc1 (code, ins-&gt;dreg,
ins-&gt;inst_basereg, ins-&gt;inst_offset);
 #endif
                        } else {
                                mips_load_const (code, mips_at,
ins-&gt;inst_offset);
                                mips_addu (code, mips_at, mips_at,
ins-&gt;inst_basereg);
-                               mips_lwc1 (code, ins-&gt;dreg, mips_at, 4);
-                               mips_lwc1 (code, ins-&gt;dreg+1, mips_at, 0);
+                               mips_lwc1 (code, ins-&gt;dreg +
REGPAIR_LOW,  mips_at, 0);
+                               mips_lwc1 (code, ins-&gt;dreg +
REGPAIR_HIGH, mips_at, 4);
                        }
                        break;
                case OP_STORER4_MEMBASE_REG:
@@ -4781,8 +4778,8 @@
                                g_assert (mips_is_imm16 (inst-&gt;inst_offset));
                                if (ainfo-&gt;size == 8) {
 #if _MIPS_SIM == _ABIO32
-                                       mips_swc1 (code, ainfo-&gt;reg,
inst-&gt;inst_basereg, inst-&gt;inst_offset+4);
-                                       mips_swc1 (code, ainfo-&gt;reg+1,
inst-&gt;inst_basereg, inst-&gt;inst_offset);
+                                       mips_swc1 (code, ainfo-&gt;reg +
REGPAIR_LOW,  inst-&gt;inst_basereg, inst-&gt;inst_offset);
+                                       mips_swc1 (code, ainfo-&gt;reg +
REGPAIR_HIGH, inst-&gt;inst_basereg, inst-&gt;inst_offset + 4);
 #elif _MIPS_SIM == _ABIN32
                                        mips_sdc1 (code, ainfo-&gt;reg,
inst-&gt;inst_basereg, inst-&gt;inst_offset);
 #endif


# svn diff mono/mini/mini-mips.h
Index: mono/mini/mini-mips.h
===================================================================
--- mono/mini/mini-mips.h       (revision 136576)
+++ mono/mini/mini-mips.h       (working copy)
@@ -175,16 +175,18 @@

 /* Parameters used by the register allocator */

-/* On Mips, for regpairs, the lower-numbered reg is most significant
- * This is true in both big and little endian
- */
-
 #if G_BYTE_ORDER == G_LITTLE_ENDIAN
 #define RET_REG1 mips_v0
 #define RET_REG2 mips_v1
+
+#define REGPAIR_LOW   0
+#define REGPAIR_HIGH  1
 #else
 #define RET_REG1 mips_v1
 #define RET_REG2 mips_v0
+
+#define REGPAIR_LOW   1
+#define REGPAIR_HIGH  0
 #endif

 #define MONO_ARCH_INST_SREG2_MASK(ins)         (0)

Would be great if someone can take a quick look at my code.

Thanks,
Rayson
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032459.html">[Mono-dev] register allocator.
</A></li>
	<LI>Next message: <A HREF="032464.html">[Mono-dev] [PATCH] Interrupting socket calls on Windows during	shutdown.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32463">[ date ]</a>
              <a href="thread.html#32463">[ thread ]</a>
              <a href="subject.html#32463">[ subject ]</a>
              <a href="author.html#32463">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
