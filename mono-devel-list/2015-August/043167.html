<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] s390x - delegate-async-exit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20s390x%20-%20delegate-async-exit&In-Reply-To=%3CCAL2amZbD7T1ezbOYZoCfq%2B3sBibZfrEzJvFNC_aM5W%3DfLh7kNw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043161.html">
   <LINK REL="Next"  HREF="043170.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] s390x - delegate-async-exit</H1>
    <B>Ludovic Henry</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20s390x%20-%20delegate-async-exit&In-Reply-To=%3CCAL2amZbD7T1ezbOYZoCfq%2B3sBibZfrEzJvFNC_aM5W%3DfLh7kNw%40mail.gmail.com%3E"
       TITLE="[Mono-dev] s390x - delegate-async-exit">ludovic at xamarin.com
       </A><BR>
    <I>Thu Aug  6 15:27:50 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043161.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
        <LI>Next message: <A HREF="043170.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43167">[ date ]</a>
              <a href="thread.html#43167">[ thread ]</a>
              <a href="subject.html#43167">[ subject ]</a>
              <a href="author.html#43167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Neale,

When hitting threadpool-ms.c:1310, could you print the result of the
following 2 commands in gdb (or equivalent):

p mono_object_describe_fields((MonoObject*)async_result)
p (long long)(void*)&amp;async_result-&gt;async_callback - (long
long)(void*)async_result

I suspect the memory layout on s390x of the native struct is not the same
as the memory layout of the managed object, leading to memory corruption
like bugs.

Thank you!

Ludovic

On Wed, Aug 5, 2015 at 5:47 PM, Neale Ferguson &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">neale at sinenomine.net</A>&gt; wrote:

&gt;<i> Further investigation shows the value being set here:
</I>&gt;<i>
</I>&gt;<i> 0x80200bb2 is in mono_gc_wbarrier_set_arrayref (sgen-mono.c:171).
</I>&gt;<i> 166     void
</I>&gt;<i> 167     mono_gc_wbarrier_set_arrayref (MonoArray *arr, gpointer slot_ptr,
</I>&gt;<i> MonoObject* value)
</I>&gt;<i> 168     {
</I>&gt;<i> 169             HEAVY_STAT (++stat_wbarrier_set_arrayref);
</I>&gt;<i> 170             if (sgen_ptr_in_nursery (slot_ptr)) {
</I>&gt;<i> 171                     *(void**)slot_ptr = value;
</I>&gt;<i> 172                     return;
</I>&gt;<i> 173             }
</I>&gt;<i> 174             SGEN_LOG (8, &quot;Adding remset at %p&quot;, slot_ptr);
</I>&gt;<i> 175             if (value)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is called from:
</I>&gt;<i>
</I>&gt;<i> 0x801a5c22 is in mono_threadpool_ms_end_invoke (threadpool-ms.c:1310).
</I>&gt;<i> 1305            }
</I>&gt;<i> 1306
</I>&gt;<i> 1307            MONO_OBJECT_SETREF (ares, endinvoke_called, 1);
</I>&gt;<i> 1308
</I>&gt;<i> 1309            /* wait until we are really finished */
</I>&gt;<i> 1310            if (ares-&gt;completed) {
</I>&gt;<i> 1311                    mono_monitor_exit ((MonoObject *) ares);
</I>&gt;<i> 1312            } else {
</I>&gt;<i> 1313                    gpointer wait_event;
</I>&gt;<i> 1314                    if (ares-&gt;handle) {
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Now the fact that the scan is pulling the value 0x1000000000000 this would
</I>&gt;<i> indicate that the slot_ptr (ares) is not aligned on a pointer boundary so
</I>&gt;<i> the calculation of this location must be incorrect.
</I>&gt;<i> Neale
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>


-- 
Ludovic Henry
Runtime Software Engineer
Xamarin, Inc.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150806/8293c8f6/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150806/8293c8f6/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043161.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
	<LI>Next message: <A HREF="043170.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43167">[ date ]</a>
              <a href="thread.html#43167">[ thread ]</a>
              <a href="subject.html#43167">[ subject ]</a>
              <a href="author.html#43167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
