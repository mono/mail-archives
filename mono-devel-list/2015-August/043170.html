<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] s390x - delegate-async-exit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20s390x%20-%20delegate-async-exit&In-Reply-To=%3CCAL2amZbaD%3DspPnnRmS%3DD3x%2BpysQ_9LDmBPaK-L8GKkQTeEMfiQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043167.html">
   <LINK REL="Next"  HREF="043168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] s390x - delegate-async-exit</H1>
    <B>Ludovic Henry</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20s390x%20-%20delegate-async-exit&In-Reply-To=%3CCAL2amZbaD%3DspPnnRmS%3DD3x%2BpysQ_9LDmBPaK-L8GKkQTeEMfiQ%40mail.gmail.com%3E"
       TITLE="[Mono-dev] s390x - delegate-async-exit">ludovic at xamarin.com
       </A><BR>
    <I>Thu Aug  6 19:05:27 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043167.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
        <LI>Next message: <A HREF="043168.html">[Mono-dev] Number of elements in a fixed buffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43170">[ date ]</a>
              <a href="thread.html#43170">[ thread ]</a>
              <a href="subject.html#43170">[ subject ]</a>
              <a href="author.html#43170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Neal,

So it appears the use of MONO_OBJECT_SETREF on end_invoke_called is wrong
as it is going to write on 8 bytes, instead of 1.
I added an assertion to this macro to test the size of the field we are
assigning to try to avoid further bugs.

Can you try with abad8aaabda16bde4adda57c6533833fca23791a to check if its
working now?

Thank you very much!


On Thu, Aug 6, 2015 at 2:08 PM, Ludovic Henry &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ludovic at xamarin.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> ---------- Forwarded message ----------
</I>&gt;<i> From: Neale Ferguson &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">neale at sinenomine.net</A>&gt;
</I>&gt;<i> Date: Thu, Aug 6, 2015 at 11:38 AM
</I>&gt;<i> Subject: Re: [Mono-dev] s390x - delegate-async-exit
</I>&gt;<i> To: Ludovic Henry &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ludovic at xamarin.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I assume you meant ares and not async_result:
</I>&gt;<i>
</I>&gt;<i> (gdb) p mono_object_describe_fields((MonoObject*)ares)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd400698 (ofs: 16) async_state: String at 0x3fffba70150, length:
</I>&gt;<i> 3, 'foo'
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006a0 (ofs: 24) handle: System.Threading.ManualResetEvent
</I>&gt;<i> object at 0x3fffd400910 (klass: 0x8041ad80)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006a8 (ofs: 32) async_delegate: foo/foo_delegate object at
</I>&gt;<i> 0x3fffd400488 (klass: 0x80473210)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006b0 (ofs: 40) data: (nil)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006b8 (ofs: 48) object_data: System.MonoAsyncCall object at
</I>&gt;<i> 0x3fffd400648 (klass: 0x8047b370)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006c0 (ofs: 56) sync_completed: False (0)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006c1 (ofs: 57) completed: True (1)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006c2 (ofs: 58) endinvoke_called: False (0)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006c8 (ofs: 64) async_callback: (null)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006d0 (ofs: 72) current: System.Threading.ExecutionContext
</I>&gt;<i> object at 0x3fffd400740 (klass: 0x8041e870)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006d8 (ofs: 80) original: (null)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006e0 (ofs: 88) add_time: 0
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006e8 (ofs: 96) call_message: (null)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006f0 (ofs: 104) message_ctrl: (null)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd4006f8 (ofs: 112) reply_message: (null)
</I>&gt;<i>
</I>&gt;<i> At 0x3fffd400700 (ofs: 120) orig_cb: (null)
</I>&gt;<i>
</I>&gt;<i> $1 = void
</I>&gt;<i>
</I>&gt;<i> (gdb) p (long long)(void*)&amp;ares-&gt;async_callback - (long long)(void*)ares
</I>&gt;<i>
</I>&gt;<i> $2 = 64
</I>&gt;<i>
</I>&gt;<i> From: Ludovic Henry &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ludovic at xamarin.com</A>&gt;
</I>&gt;<i> Date: Thursday, August 6, 2015 at 11:27 AM
</I>&gt;<i> To: Neale Ferguson &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">neale at sinenomine.net</A>&gt;
</I>&gt;<i> Cc: Mono-Devel &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Subject: Re: [Mono-dev] s390x - delegate-async-exit
</I>&gt;<i>
</I>&gt;<i> Hey Neale,
</I>&gt;<i>
</I>&gt;<i> When hitting threadpool-ms.c:1310, could you print the result of the
</I>&gt;<i> following 2 commands in gdb (or equivalent):
</I>&gt;<i>
</I>&gt;<i> p mono_object_describe_fields((MonoObject*)async_result)
</I>&gt;<i> p (long long)(void*)&amp;async_result-&gt;async_callback - (long
</I>&gt;<i> long)(void*)async_result
</I>&gt;<i>
</I>&gt;<i> I suspect the memory layout on s390x of the native struct is not the same
</I>&gt;<i> as the memory layout of the managed object, leading to memory corruption
</I>&gt;<i> like bugs.
</I>&gt;<i>
</I>&gt;<i> Thank you!
</I>&gt;<i>
</I>&gt;<i> Ludovic
</I>&gt;<i>
</I>&gt;<i> On Wed, Aug 5, 2015 at 5:47 PM, Neale Ferguson &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">neale at sinenomine.net</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Further investigation shows the value being set here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 0x80200bb2 is in mono_gc_wbarrier_set_arrayref (sgen-mono.c:171).
</I>&gt;&gt;<i> 166     void
</I>&gt;&gt;<i> 167     mono_gc_wbarrier_set_arrayref (MonoArray *arr, gpointer slot_ptr,
</I>&gt;&gt;<i> MonoObject* value)
</I>&gt;&gt;<i> 168     {
</I>&gt;&gt;<i> 169             HEAVY_STAT (++stat_wbarrier_set_arrayref);
</I>&gt;&gt;<i> 170             if (sgen_ptr_in_nursery (slot_ptr)) {
</I>&gt;&gt;<i> 171                     *(void**)slot_ptr = value;
</I>&gt;&gt;<i> 172                     return;
</I>&gt;&gt;<i> 173             }
</I>&gt;&gt;<i> 174             SGEN_LOG (8, &quot;Adding remset at %p&quot;, slot_ptr);
</I>&gt;&gt;<i> 175             if (value)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is called from:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 0x801a5c22 is in mono_threadpool_ms_end_invoke (threadpool-ms.c:1310).
</I>&gt;&gt;<i> 1305            }
</I>&gt;&gt;<i> 1306
</I>&gt;&gt;<i> 1307            MONO_OBJECT_SETREF (ares, endinvoke_called, 1);
</I>&gt;&gt;<i> 1308
</I>&gt;&gt;<i> 1309            /* wait until we are really finished */
</I>&gt;&gt;<i> 1310            if (ares-&gt;completed) {
</I>&gt;&gt;<i> 1311                    mono_monitor_exit ((MonoObject *) ares);
</I>&gt;&gt;<i> 1312            } else {
</I>&gt;&gt;<i> 1313                    gpointer wait_event;
</I>&gt;&gt;<i> 1314                    if (ares-&gt;handle) {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now the fact that the scan is pulling the value 0x1000000000000 this would
</I>&gt;&gt;<i> indicate that the slot_ptr (ares) is not aligned on a pointer boundary so
</I>&gt;&gt;<i> the calculation of this location must be incorrect.
</I>&gt;&gt;<i> Neale
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Ludovic Henry
</I>&gt;<i> Runtime Software Engineer
</I>&gt;<i> Xamarin, Inc.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Ludovic Henry
</I>&gt;<i> Runtime Software Engineer
</I>&gt;<i> Xamarin, Inc.
</I>&gt;<i>
</I>


-- 
Ludovic Henry
Runtime Software Engineer
Xamarin, Inc.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150806/3f710b71/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150806/3f710b71/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043167.html">[Mono-dev] s390x - delegate-async-exit
</A></li>
	<LI>Next message: <A HREF="043168.html">[Mono-dev] Number of elements in a fixed buffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43170">[ date ]</a>
              <a href="thread.html#43170">[ thread ]</a>
              <a href="subject.html#43170">[ subject ]</a>
              <a href="author.html#43170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
