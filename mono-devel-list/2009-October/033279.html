<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] sse_mathfun convert
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sse_mathfun%20convert&In-Reply-To=25696934.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033176.html">
   <LINK REL="Next"  HREF="033177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] sse_mathfun convert</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sse_mathfun%20convert&In-Reply-To=25696934.post%40talk.nabble.com"
       TITLE="[Mono-dev] sse_mathfun convert">kumpera at gmail.com
       </A><BR>
    <I>Sat Oct 17 10:15:06 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033176.html">[Mono-dev]  sse_mathfun convert
</A></li>
        <LI>Next message: <A HREF="033177.html">[Mono-dev] 2.6 preview 1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33279">[ date ]</a>
              <a href="thread.html#33279">[ thread ]</a>
              <a href="subject.html#33279">[ subject ]</a>
              <a href="author.html#33279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Your code does a lot of things in a non optimal way.
First, due to the calling convention mono uses, having a method call in
between Simd code
causes all simd variables to be spill on stack. This causes passing a
Vecto4f do be 2x slower than
passing a double since 16 bytes have to be pushed to the stack.

A few more comments inline.

On Thu, Oct 1, 2009 at 12:23 PM, jetthink &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jetthink at gmail.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>  I have converted exp_ps(from <A HREF="http://gruntthepeon.free.fr/ssemath/">http://gruntthepeon.free.fr/ssemath/</A>) to
</I>&gt;<i> Mono.
</I>&gt;<i> using System;
</I>&gt;<i> using Mono.Simd;
</I>&gt;<i>
</I>&gt;<i> public static class Myext{
</I>&gt;<i>    public static unsafe Vector4i LogicalLeftShift(this Vector4i v1, int
</I>&gt;<i> amount)
</I>&gt;<i>    {
</I>&gt;<i>        Vector4i res = new Vector4i();
</I>&gt;<i>        int* a = (int*)&amp;v1;
</I>&gt;<i>        int* b =(int*)&amp;res;
</I>&gt;<i>        for (int i = 0; i &lt; 4; ++i)
</I>&gt;<i>            *b++ = (int)((uint)(*a++) &lt;&lt; amount);
</I>&gt;<i>        return res;
</I>&gt;<i>    }
</I>&gt;<i>
</I>
There are 2 issues here, first, by taking the address of a variable you ruin
any change the JIT
has to keep it on a register - this is a current limitation of mono's JIT.

Second, why can't you just use a regular vector shift? &quot;v1 &lt;&lt; amount&quot; would
have the same result.




&gt;<i>    public static unsafe Vector4ui LogicalLeftShift(this Vector4ui v1, int
</I>&gt;<i> amount)
</I>&gt;<i>    {
</I>&gt;<i>        Vector4ui res = new Vector4ui();
</I>&gt;<i>        uint* a = (uint*)&amp;v1;
</I>&gt;<i>        uint* b =(uint*)&amp;res;
</I>&gt;<i>        for (int i = 0; i &lt; 4; ++i)
</I>&gt;<i>            *b++ = ((uint)(*a++) &lt;&lt; amount);
</I>&gt;<i>        return res;
</I>&gt;<i>    }
</I>&gt;<i>
</I>
Just use the left shift operation here &quot;v1 &lt;&lt; amount&quot;.



&gt;<i>    public static unsafe Vector4f Cast2Vector4f(this Vector4i v1)
</I>&gt;<i>    {
</I>&gt;<i>        Vector4f res = new Vector4f();
</I>&gt;<i>        int* a = (int*)&amp;v1;
</I>&gt;<i>        float* b = (float*)&amp;res;
</I>&gt;<i>        for (int i = 0; i &lt; 4; ++i)
</I>&gt;<i>            *b++ = ((float)(*a++));
</I>&gt;<i>        return res;
</I>&gt;<i>    }
</I>&gt;<i>
</I>
Here you're hitting a limitation of Mono.Simd as it lacks an intrinsic to
perform this conversion using
an SSE instruction. This have to be addressed.


&gt;<i>    static Vector4f v4sf_0p5 = new Vector4f(0.5f);
</I>&gt;<i>    static Vector4ui v4sui_0x7f = new Vector4ui(0x7f);
</I>&gt;<i>    static Vector4i v4si_0x7f = new Vector4i(0x7f);
</I>&gt;<i>    static Vector4f v4sf_one = Vector4f.One;
</I>&gt;<i>
</I>&gt;<i>    static Vector4f v4sf_exp_hi = new Vector4f(88.3762626647949f);
</I>&gt;<i>    static Vector4f v4sf_exp_lo = new Vector4f(-88.3762626647949f);
</I>&gt;<i>    static Vector4f v4sf_cephes_LOG2EF = new Vector4f(1.44269504088896341f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_C1 = new Vector4f(0.693359375f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_C2 = new Vector4f(-2.12194440e-4f);
</I>&gt;<i>
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p0 = new Vector4f(1.9875691500E-4f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p1 = new Vector4f(1.3981999507E-3f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p2 = new Vector4f(8.3334519073E-3f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p3 = new Vector4f(4.1665795894E-2f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p4 = new Vector4f(1.6666665459E-1f);
</I>&gt;<i>    static Vector4f v4sf_cephes_exp_p5 = new Vector4f(5.0000001201E-1f);
</I>&gt;<i>    public static Vector4f ExpSSE(Vector4f x)
</I>&gt;<i>    {
</I>&gt;<i>        //Vector4f tmp =  Vector4f.Zero;
</I>&gt;<i>        Vector4f fx = Vector4f.Zero;
</I>&gt;<i>
</I>&gt;<i>        Vector4i emm0;
</I>&gt;<i>
</I>&gt;<i>        x = VectorOperations.Min(x, v4sf_exp_hi);
</I>&gt;<i>        x = VectorOperations.Max(x, v4sf_exp_lo);
</I>

You can use those methods as extension methods &quot;x.Min(v4sf_exp_hi)&quot;
It might be faster to explicitly create the constant instead of loading it
of a
static variable. This is specially true for single variable constructors.


Thanks for doing this experiment, there are certainly some remaining work
left to do on Mono.Simd and it does show it.


Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20091017/f421b297/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20091017/f421b297/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033176.html">[Mono-dev]  sse_mathfun convert
</A></li>
	<LI>Next message: <A HREF="033177.html">[Mono-dev] 2.6 preview 1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33279">[ date ]</a>
              <a href="thread.html#33279">[ thread ]</a>
              <a href="subject.html#33279">[ subject ]</a>
              <a href="author.html#33279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
