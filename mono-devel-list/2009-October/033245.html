<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev]  Problem when embedding dll (without Main method)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20Problem%20when%20embedding%20dll%20%28without%20Main%20method%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033244.html">
   <LINK REL="Next"  HREF="033246.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev]  Problem when embedding dll (without Main method)</H1>
    <B>holgers</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20Problem%20when%20embedding%20dll%20%28without%20Main%20method%29&In-Reply-To="
       TITLE="[Mono-dev]  Problem when embedding dll (without Main method)">hschmalle at afmg.eu
       </A><BR>
    <I>Mon Oct 12 07:56:22 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="033244.html">[Mono-dev] Fwd:  SerialPortStream patch
</A></li>
        <LI>Next message: <A HREF="033246.html">[Mono-dev] Problem when embedding dll (without Main method)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33245">[ date ]</a>
              <a href="thread.html#33245">[ thread ]</a>
              <a href="subject.html#33245">[ subject ]</a>
              <a href="author.html#33245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hello,

when embedding a dll which has no main method I encountered the following
problem:

I cannot invoke mono_jit_exec(...) because there is no main. This results in
a not completely initialized runtime.

Is there another way to initialize the runtime correctly?

The problem can easily be reproduced by applying the following patches to
the mono/samples/embed examples.

Compiled with:
gmcs invoke_mod.cs
gcc -Wall -o test-invoke_mod test-invoke_mod.c `pkg-config --cflags --libs
mono` -lm

Result:
./test-invoke_mod invoke_mod.exe In ctor val is: 5
In ctor str is: hello
Value of field is: 5
Value of str is: hello
In method val is 10
In method str is: hello from the embedding API

Unhandled Exception: System.TypeInitializationException: An exception was
thrown by the type initializer for System.Xml.Serialization.XmlSerializer
---&gt; System.Configuration.ConfigurationErrorsException: Error Initializing
the configuration system. ---&gt; System.NullReferenceException: Object
reference not set to an instance of an object
  at System.Configuration.ConfigurationManager.OpenExeConfigurationInternal
(ConfigurationUserLevel userLevel, System.Reflection.Assembly
calling_assembly, System.String exePath) [0x00000] 
  at System.Configuration.ClientConfigurationSystem.get_Configuration ()
[0x00000] 
  --- End of inner exception stack trace ---
  at System.Configuration.ClientConfigurationSystem.get_Configuration ()
[0x00000] 
  at
System.Configuration.ClientConfigurationSystem.System.Configuration.Internal.IInternalConfigSystem.GetSection
(System.String configKey) [0x00000] 
  at System.Configuration.ConfigurationManager.GetSection (System.String
sectionName) [0x00000] 
  at System.Configuration.ConfigurationSettings.GetConfig (System.String
sectionName) [0x00000] 
  at System.Xml.Serialization.XmlSerializer..cctor () [0x00000] 
  --- End of inner exception stack trace ---
  at Embed.MyType.method () [0x00000] 

Patches:

invoke_mod.cs:
--- invoke.cs	2009-10-12 13:21:13.000000000 +0200
+++ invoke_mod.cs	2009-10-12 13:36:28.000000000 +0200
@@ -1,6 +1,12 @@
 using System;
+using System.Xml.Serialization;
 
 namespace Embed {
+
+	public class Foo {
+		public int i;
+	}
+
 	class MyType {
 		int val = 5;
 		string str = &quot;hello&quot;;
@@ -17,6 +23,7 @@
 		void method () {
 			Console.WriteLine (&quot;In method val is {0}&quot;, val);
 			Console.WriteLine (&quot;In method str is: {0}&quot;, str);
+			XmlSerializer ser = new XmlSerializer(typeof(Foo));
 		}
 
 		int Value {

test-invoke_mod.c:
--- test-invoke.c	2009-10-12 13:21:13.000000000 +0200
+++ test-invoke_mod.c	2009-10-12 13:19:53.000000000 +0200
@@ -307,7 +307,7 @@
 	 * The return value needs to be looked up from
 	 * System.Environment.ExitCode.
 	 */
-	mono_jit_exec (domain, assembly, argc, argv);
+	//mono_jit_exec (domain, assembly, argc, argv);
 
 	create_object (domain, mono_assembly_get_image (assembly));
 }

Regards,
Holger
-- 
View this message in context: <A HREF="http://www.nabble.com/Problem-when-embedding-dll-%28without-Main-method%29-tp25854471p25854471.html">http://www.nabble.com/Problem-when-embedding-dll-%28without-Main-method%29-tp25854471p25854471.html</A>
Sent from the Mono - Dev mailing list archive at Nabble.com.

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033244.html">[Mono-dev] Fwd:  SerialPortStream patch
</A></li>
	<LI>Next message: <A HREF="033246.html">[Mono-dev] Problem when embedding dll (without Main method)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33245">[ date ]</a>
              <a href="thread.html#33245">[ thread ]</a>
              <a href="subject.html#33245">[ subject ]</a>
              <a href="author.html#33245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
