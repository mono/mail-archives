<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Strange Casting bug in .net 4 profile
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Strange%20Casting%20bug%20in%20.net%204%20profile&In-Reply-To=0E710D610510664A8D09869C417AA22031B96FF72D%40INTCL1EX01.uk.ioko365.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035709.html">
   <LINK REL="Next"  HREF="035711.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Strange Casting bug in .net 4 profile</H1>
    <B>Gary Thomas</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Strange%20Casting%20bug%20in%20.net%204%20profile&In-Reply-To=0E710D610510664A8D09869C417AA22031B96FF72D%40INTCL1EX01.uk.ioko365.com"
       TITLE="[Mono-dev] Strange Casting bug in .net 4 profile">Gary.Thomas at ioko.com
       </A><BR>
    <I>Wed Aug 18 11:05:42 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035709.html">[Mono-dev] Strange Casting bug in .net 4 profile
</A></li>
        <LI>Next message: <A HREF="035711.html">[Mono-dev] Strange Casting bug in .net 4 profile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35710">[ date ]</a>
              <a href="thread.html#35710">[ thread ]</a>
              <a href="subject.html#35710">[ subject ]</a>
              <a href="author.html#35710">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A little more digging using reflector on the binary shows the path to the dependency as follows:

CastBug 0.0.0.0 depends on
System.ServiceModel 4.0.0 which depends on
Microsoft.Transactions.Bridge 3.0.0 which depends on
System.ServiceModel 3.0.0.0



-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Gary Thomas
Sent: 18 August 2010 15:42
To: Robert Jordan; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Strange Casting bug in .net 4 profile

There are some similar looking bugs on bugzilla but it is still happening in trunk now.

I just deleted /opt/mono
ran:
make clean
git pull
./autogen.sh --prefix=/opt/mono
make
sudo make install

then recompiled the test app, ran it and still get the same results.

Below is a trace of the application run with --debug. It seems to show that System.Configuration 2.0.0.0 assembly load is redirected to 4.0.0.0
However I see that two versions of System.ServiceModel are being loaded (the class I am trying to cast to is in System.ServiceModel) so perhaps this is the problem after all.
Any idea how to fix? Is it a binding redirect in the mono config file or something simple like that?

Thanks,
Gary

[mono] ~/Projects/CastBug @ MONO_LOG_LEVEL=debug MONO_LOG_MASK=asm mono --debug CastBug.exe
Mono: Assembly Loader probing location: '/opt/mono/lib/mono/4.0/mscorlib.dll'.
Mono: Image addref mscorlib 0x86f5088 -&gt; /opt/mono/lib/mono/4.0/mscorlib.dll 0x86f4710: 2

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/4.0/mscorlib.dll'.
Mono: Assembly Ref addref mscorlib 0x86f5088 -&gt; mscorlib 0x86f5088: 1

Mono: Assembly mscorlib 0x86f5088 added to domain CastBug.exe, ref_count=2

Mono: Assembly Loader probing location: 'CastBug.exe'.
Mono: Image addref CastBug 0x87443a0 -&gt; /home/garyt/Projects/CastBug/CastBug.exe 0x86f3c00: 3

Mono: Assembly CastBug 0x87443a0 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: 'CastBug.exe'.
Mono: Assembly Loader probing location: 'CastBug.exe'.
Mono: Assembly Ref addref CastBug 0x87443a0 -&gt; mscorlib 0x86f5088: 3

Mono: Assembly Loader probing location: '/opt/mono/lib/mono/gac/System.ServiceModel/4.0.0.0__b77a5c561934e089/System.ServiceModel.dll'.
Mono: Image addref System.ServiceModel 0x874c5d8 -&gt; /opt/mono/lib/mono/gac/System.ServiceModel/4.0.0.0__b77a5c561934e089/System.ServiceModel.dll 0x874bd20: 2

Mono: Assembly System.ServiceModel 0x874c5d8 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/gac/System.ServiceModel/4.0.0.0__b77a5c561934e089/System.ServiceModel.dll'.
Mono: Assembly Ref addref CastBug 0x87443a0 -&gt; System.ServiceModel 0x874c5d8: 2

Mono: Assembly Loader probing location: '/opt/mono/lib/mono/gac/System.Configuration/4.0.0.0__b03f5f7f11d50a3a/System.Configuration.dll'.
Mono: Image addref System.Configuration 0x87579d8 -&gt; /opt/mono/lib/mono/gac/System.Configuration/4.0.0.0__b03f5f7f11d50a3a/System.Configuration.dll 0x8757020: 2

Mono: Assembly System.Configuration 0x87579d8 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/gac/System.Configuration/4.0.0.0__b03f5f7f11d50a3a/System.Configuration.dll'.
Mono: Assembly Ref addref System.ServiceModel 0x874c5d8 -&gt; System.Configuration 0x87579d8: 2

Mono: Assembly Ref addref System.Configuration 0x87579d8 -&gt; mscorlib 0x86f5088: 4

Mono: Assembly Ref addref CastBug 0x87443a0 -&gt; System.Configuration 0x87579d8: 3

Mono: Assembly Loader probing location: '/opt/mono/lib/mono/gac/System/4.0.0.0__b77a5c561934e089/System.dll'.
Mono: Image addref System 0x87615f8 -&gt; /opt/mono/lib/mono/gac/System/4.0.0.0__b77a5c561934e089/System.dll 0x8760c10: 2

Mono: Assembly System 0x87615f8 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/gac/System/4.0.0.0__b77a5c561934e089/System.dll'.
Mono: Assembly Ref addref System.Configuration 0x87579d8 -&gt; System 0x87615f8: 2

Mono: Assembly Loader probing location: '/opt/mono/lib/mono/gac/System.Xml/4.0.0.0__b77a5c561934e089/System.Xml.dll'.
Mono: Image addref System.Xml 0x876fbb0 -&gt; /opt/mono/lib/mono/gac/System.Xml/4.0.0.0__b77a5c561934e089/System.Xml.dll 0x876f5c0: 2

Mono: Assembly System.Xml 0x876fbb0 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/gac/System.Xml/4.0.0.0__b77a5c561934e089/System.Xml.dll'.
Mono: Assembly Ref addref System.Configuration 0x87579d8 -&gt; System.Xml 0x876fbb0: 2

Mono: Assembly Ref addref System.Xml 0x876fbb0 -&gt; mscorlib 0x86f5088: 5

Mono: Assembly Ref addref System 0x87615f8 -&gt; mscorlib 0x86f5088: 6

Mono: Assembly Ref addref System.Xml 0x876fbb0 -&gt; System 0x87615f8: 3

Mono: Assembly Loader probing location: '/opt/mono/lib/mono/gac/System.ServiceModel/3.0.0.0__b77a5c561934e089/System.ServiceModel.dll'.
Mono: Image addref System.ServiceModel 0x8834158 -&gt; /opt/mono/lib/mono/gac/System.ServiceModel/3.0.0.0__b77a5c561934e089/System.ServiceModel.dll 0x88300d0: 2

Mono: Assembly System.ServiceModel 0x8834158 added to domain CastBug.exe, ref_count=1

Mono: Assembly Loader loaded assembly from location: '/opt/mono/lib/mono/gac/System.ServiceModel/3.0.0.0__b77a5c561934e089/System.ServiceModel.dll'.
Mono: The request to load the assembly System.Configuration v2.0.0.0 was remapped to v4.0.0.0
Mono: Assembly Ref addref System.ServiceModel 0x8834158 -&gt; System.Configuration 0x87579d8: 4

Mono: The request to load the assembly mscorlib v2.0.0.0 was remapped to v4.0.0.0
Mono: Assembly Ref addref System.ServiceModel 0x8834158 -&gt; mscorlib 0x86f5088: 7

Mono: Assembly Ref addref System 0x87615f8 -&gt; System.Xml 0x876fbb0: 3

System.ServiceModel.Configuration.ServicesSection
section is ConfigurationSection True
section is ServicesSection False
ServiceSection type System.ServiceModel.Configuration.ServicesSection
Casting section

Unhandled Exception: System.InvalidCastException: Cannot cast from source type to destination type.
  at CastBug.MainClass.Main (System.String[] args) [0x0006e] in /home/garyt/Projects/CastBug/CastBug.cs:19 
[mono] ~/Projects/CastBug @


-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Robert Jordan
Sent: 18 August 2010 13:29
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Strange Casting bug in .net 4 profile

Hey,

I believe this is already fixed in trunk. It was a mismatch
between the 2.0 and 4.0 System.Configuration.dll that were
loaded together into the same appdomain. This means that
ServicesSection defined in these assemblies were actually
incompatible to each other.

Robert

On 18.08.2010 13:52, Gary Thomas wrote:
&gt;<i> Hi all,
</I>&gt;<i> 	I have been using mono from trunk and playing with the WCF stuff when I noticed an InvalidCastException being thrown. I figured out that this only happened when using the .net 4 profile, when using .net 3.5 profile it didn't happen.
</I>&gt;<i> I have put together a simple app to show the problem and here are the results.
</I>&gt;<i>
</I>&gt;<i> With .net 4:
</I>&gt;<i>
</I>&gt;<i> [mono] ~/Projects/CastBug @ dmcs CastBug.cs /reference:System.Configuration /reference:System.ServiceModel
</I>&gt;<i> CastBug.cs(19,41): warning CS0219: The variable `ss' is assigned but its value is never used
</I>&gt;<i> Compilation succeeded - 1 warning(s)
</I>&gt;<i> [mono] ~/Projects/CastBug @ mono CastBug.exe
</I>&gt;<i> System.ServiceModel.Configuration.ServicesSection
</I>&gt;<i> section is ConfigurationSection True
</I>&gt;<i> section is ServicesSection False
</I>&gt;<i> ServiceSection type System.ServiceModel.Configuration.ServicesSection
</I>&gt;<i> Casting section
</I>&gt;<i>
</I>&gt;<i> Unhandled Exception: System.InvalidCastException: Cannot cast from source type to destination type.
</I>&gt;<i>    at CastBug.MainClass.Main (System.String[] args) [0x00000] in&lt;filename unknown&gt;:0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> With .net 3.5:
</I>&gt;<i>
</I>&gt;<i> [mono] ~/Projects/CastBug @ gmcs CastBug.cs /reference:System.Configuration /reference:System.ServiceModel
</I>&gt;<i> CastBug.cs(19,41): warning CS0219: The variable `ss' is assigned but its value is never used
</I>&gt;<i> Compilation succeeded - 1 warning(s)
</I>&gt;<i> [mono] ~/Projects/CastBug @ mono CastBug.exe
</I>&gt;<i> System.ServiceModel.Configuration.ServicesSection
</I>&gt;<i> section is ConfigurationSection True
</I>&gt;<i> section is ServicesSection True
</I>&gt;<i> ServiceSection type System.ServiceModel.Configuration.ServicesSection
</I>&gt;<i> Casting section
</I>&gt;<i> Done casting section
</I>&gt;<i>
</I>&gt;<i> The runtime reports the type of the object as ServicesSection but casting it to a ServicesSection causes an InvalidCastException.
</I>&gt;<i>
</I>&gt;<i> Here is the test app:
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i> using System.Configuration;
</I>&gt;<i> using System.ServiceModel.Configuration;
</I>&gt;<i>
</I>&gt;<i> namespace CastBug
</I>&gt;<i> {
</I>&gt;<i>          class MainClass
</I>&gt;<i>          {
</I>&gt;<i>                  public static void Main (string[] args)
</I>&gt;<i>                  {
</I>&gt;<i>                          var section = ConfigurationManager.GetSection(&quot;system.serviceModel/services&quot;);
</I>&gt;<i>                          Console.WriteLine(section.GetType().ToString());
</I>&gt;<i>                          Console.WriteLine(&quot;section is ConfigurationSection {0}&quot;, section is ConfigurationSection);
</I>&gt;<i>                          Console.WriteLine(&quot;section is ServicesSection {0}&quot;, section is ServicesSection);
</I>&gt;<i>                          Console.WriteLine(&quot;ServiceSection type {0}&quot;, typeof(ServicesSection).ToString());
</I>&gt;<i>
</I>&gt;<i>                          Console.WriteLine(&quot;Casting section&quot;);
</I>&gt;<i>                          // throws an InvalidCastException
</I>&gt;<i>                          ServicesSection ss = (ServicesSection)section;
</I>&gt;<i>                          Console.WriteLine(&quot;Done casting section&quot;);
</I>&gt;<i>
</I>&gt;<i>                  }
</I>&gt;<i>          }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Is this a known issue? Should I report a bug? If it was a simple bug in the c# libraries I would have a go at fixing myself but this seem more fundamental than that.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Gary
</I>

_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035709.html">[Mono-dev] Strange Casting bug in .net 4 profile
</A></li>
	<LI>Next message: <A HREF="035711.html">[Mono-dev] Strange Casting bug in .net 4 profile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35710">[ date ]</a>
              <a href="thread.html#35710">[ thread ]</a>
              <a href="subject.html#35710">[ subject ]</a>
              <a href="author.html#35710">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
