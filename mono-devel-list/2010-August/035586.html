<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Proposed Patch - Google Native Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Proposed%20Patch%20-%20Google%20Native%20Client&In-Reply-To=AANLkTimY2L2o2Wa8Fx8ZR9pGNeJQfHvcBmaBGwrRr1hN%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035583.html">
   <LINK REL="Next"  HREF="035587.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Proposed Patch - Google Native Client</H1>
    <B>Elijah Taylor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Proposed%20Patch%20-%20Google%20Native%20Client&In-Reply-To=AANLkTimY2L2o2Wa8Fx8ZR9pGNeJQfHvcBmaBGwrRr1hN%40mail.gmail.com"
       TITLE="[Mono-dev] Proposed Patch - Google Native Client">elijahtaylor at google.com
       </A><BR>
    <I>Mon Aug  2 12:48:03 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035583.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
        <LI>Next message: <A HREF="035587.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35586">[ date ]</a>
              <a href="thread.html#35586">[ thread ]</a>
              <a href="subject.html#35586">[ subject ]</a>
              <a href="author.html#35586">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, comments inline:

On Mon, Aug 2, 2010 at 5:00 AM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>   Some further comments:
</I>&gt;<i>
</I>&gt;<i> - it would be nice to follow the mono coding conventions for the changes,
</I>&gt;<i> i.e.
</I>&gt;<i>   put a space before '(' in calls, use tabs in files where tabs are used
</I>&gt;<i> for indentation, etc.
</I>&gt;<i>
</I>
Yes, we've been trying to do that for future modifications in amd64.  I can
address these issues with x86 with an alternate patch if you'd like, let me
know.


&gt;<i> - some of the #ifdefs could be avoided by adding a NACL_SIZE() macro:
</I>&gt;<i>
</I>&gt;<i> #if defined(__native_client_codegen__) || defined(__native_client__)
</I>&gt;<i> #define NACL_SIZE(a, b) (b)
</I>&gt;<i> #else
</I>&gt;<i> #define NACL_SIZE(a, b) (a)
</I>&gt;<i>
</I>&gt;<i> and using it for things like the trampoline buffer sizes:
</I>&gt;<i>
</I>&gt;<i> +#ifdef __native_client_codegen__
</I>&gt;<i> + tramp_size = 128;
</I>&gt;<i> +#else
</I>&gt;<i>   tramp_size = 64;
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i> would become:
</I>&gt;<i>
</I>&gt;<i>        tramp_size = NACL_SIZE (64, 128);
</I>&gt;<i>
</I>&gt;<i>
</I>It looks like you're trying to optimize for as few preprocessor defines as
possible.  If that's the case, we'll try to carry that sentiment over to our
new changes too.

One thing we've been talking about locally is what to do in amd64 (where
we're having to make more changes than in x86) when we have divergent
behavior between normal mono and NaCl.  Trying to be good guests in the Mono
codebase, we started putting the mono codeblocks first, like so:

#if defined(__default_codegen__)
//normal mono behavior
#elif defined(__native_client_codegen__)
//new nacl behavior
#else (if needed)
//optional default case
#endif

And then defining __default_codegen__ for non-nacl builds.  Obviously this
is a little messy as it adds a new define for every other build, but we
thought it made it clear that it is the default path, rather than using
&quot;#ifndef __native_client_codegen__&quot;.  I find that it's easier to parse code
with a lot of ifdefs rather than a mixture of ifndefs and ifdefs.

Does anyone have any strong opinions one way or another about how we do
this?


                             Zoltan
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Jul 16, 2010 at 1:30 AM, Elijah Taylor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">elijahtaylor at google.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi, here's an updated patch with your feedback addressed.  I re-based the
</I>&gt;&gt;<i> diff closer to head revision (r160382) to include the other changes of ours
</I>&gt;&gt;<i> that already landed, as well as make sure we're still compatible with
</I>&gt;&gt;<i> current Mono development.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In general this diff should have a smaller impact on the .c files:
</I>&gt;&gt;<i> mini-x86.c, exceptions-x86.c, tramp-x86.c specifically, and the Native
</I>&gt;&gt;<i> Client changes are a little more grouped together rather than spread out.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A couple of points separate from the feedback:
</I>&gt;&gt;<i> 1) I fixed a bug in my implementation of genmdesc.pl changes, so that
</I>&gt;&gt;<i> will be different from the previous patch
</I>&gt;&gt;<i> 2) There's a small typo at head revision in mono/mini/tramp-x86.c which
</I>&gt;&gt;<i> says &quot;rethow&quot; instead of &quot;reth*r*ow&quot; for your rethrow exception
</I>&gt;&gt;<i> trampoline.  This is also fixed in my patch.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As always feedback is appreciated from everyone.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Elijah
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tue, Jul 6, 2010 at 6:35 AM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> One possibility is to pad out all x86_prefix instructions to the nearest
</I>&gt;&gt;&gt;&gt;<i> 32-byte boundary, but that could really bloat things depending on how often
</I>&gt;&gt;&gt;&gt;<i> they're used.  Do you have any idea of the prefix to non-prefix instruction
</I>&gt;&gt;&gt;&gt;<i> ratio?  It seems like it'd be pretty low based on looking at the code but I
</I>&gt;&gt;&gt;&gt;<i> haven't looked at any actual metrics.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think that would be ok, they are seldom used.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>                                  Zoltan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100802/6d6ab322/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100802/6d6ab322/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035583.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
	<LI>Next message: <A HREF="035587.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35586">[ date ]</a>
              <a href="thread.html#35586">[ thread ]</a>
              <a href="subject.html#35586">[ subject ]</a>
              <a href="author.html#35586">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
