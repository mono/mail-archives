<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Fast variant type cast
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Fast%20variant%20type%20cast&In-Reply-To=AANLkTik%3D3UV5rKRR27-4jnOciFbDH_3T8%3D5F6sD3DFSv%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035932.html">
   <LINK REL="Next"  HREF="035933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Fast variant type cast</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Fast%20variant%20type%20cast&In-Reply-To=AANLkTik%3D3UV5rKRR27-4jnOciFbDH_3T8%3D5F6sD3DFSv%40mail.gmail.com"
       TITLE="[Mono-dev] Fast variant type cast">kumpera at gmail.com
       </A><BR>
    <I>Sun Sep 26 17:03:05 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035932.html">[Mono-dev] Fast variant type cast
</A></li>
        <LI>Next message: <A HREF="035933.html">[Mono-dev] [PATCH] implement type comparison for MONO_TYPE_FNPTR
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35942">[ date ]</a>
              <a href="thread.html#35942">[ thread ]</a>
              <a href="subject.html#35942">[ subject ]</a>
              <a href="author.html#35942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>An update on the branch.

I fixed caching under gsharing and made detection more usable. I also added
a negative cache to isinst
which translated into big hit-ratio (99%) for test suites workload.

I'd like your opinion on this approach before I go forward into making it
faster by making wrappers.

Cheers,
Rodrigo



On Fri, Sep 24, 2010 at 7:21 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:

&gt;<i> Hey Mark and Paolo,
</I>&gt;<i>
</I>&gt;<i> I've speed some time looking into speeding up variant type cast as one can
</I>&gt;<i> expect it to be used a lot more with 4.0
</I>&gt;<i> since a lot of central types have been made variant.
</I>&gt;<i>
</I>&gt;<i> I first looked into making a managed version of the casting code for
</I>&gt;<i> variant types but this is incredibly hard, to say the least,
</I>&gt;<i> due to 2 issues, it has to inspect the instantiation vector of the target
</I>&gt;<i> type (which is made of MonoType values) and it has
</I>&gt;<i> to iterate thru all interfaces of a given type.
</I>&gt;<i>
</I>&gt;<i> It is not impossible, but it's a lot work and probably quite some extra
</I>&gt;<i> memory to make it fast.
</I>&gt;<i>
</I>&gt;<i> So I decided to avoid the whole problem and go with adding an one entry
</I>&gt;<i> cache in front of the casting op. It's significantly faster
</I>&gt;<i> when the hit ratio is high and the cache test could be inlined for extra
</I>&gt;<i> performance (right now it's an icall).
</I>&gt;<i>
</I>&gt;<i> I got this working on on this branch of github:
</I>&gt;<i> <A HREF="http://github.com/kumpera/mono/commits/fast_variant_cast">http://github.com/kumpera/mono/commits/fast_variant_cast</A>
</I>&gt;<i>
</I>&gt;<i> Then I went into checking real world usefulness and found out that this
</I>&gt;<i> change does no good at all. At least with the benchmarks
</I>&gt;<i> I selected.
</I>&gt;<i>
</I>&gt;<i> IronPython does a constant number of casting operations, so it's not
</I>&gt;<i> usable.
</I>&gt;<i> The test suites of corlib and sys.core revealed one critical bug with my
</I>&gt;<i> approach, it doesn't handle the case where it's not
</I>&gt;<i> possible to statically known if we're handling with a generic variant type
</I>&gt;<i> or not. And this is 99.999% of all casts to variant types
</I>&gt;<i> on those tests.
</I>&gt;<i>
</I>&gt;<i> So this left me with two options. Make mono_object_isinst faster with
</I>&gt;<i> variant types or look into caching all casts ops
</I>&gt;<i> under gsharing.
</I>&gt;<i>
</I>&gt;<i> I'll try enabling caching for all gshared cast ops first, then into making
</I>&gt;<i> mono_object_isinst faster if needed. How to do
</I>&gt;<i> it still an open problem but looks easy for types without nested variance -
</I>&gt;<i> not IEnumerable&lt;Func&lt;string,string&gt;&gt; for example.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I tried to enable caching for all gshared casts but I'm bumping into a
</I>&gt;<i> runtime crash in the innards of the gsharing code.
</I>&gt;<i>
</I>&gt;<i> Any advices, tips or a code review of the mentioned branch?
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Rodrigo
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100926/53b34973/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100926/53b34973/attachment.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035932.html">[Mono-dev] Fast variant type cast
</A></li>
	<LI>Next message: <A HREF="035933.html">[Mono-dev] [PATCH] implement type comparison for MONO_TYPE_FNPTR
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35942">[ date ]</a>
              <a href="thread.html#35942">[ thread ]</a>
              <a href="subject.html#35942">[ subject ]</a>
              <a href="author.html#35942">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
