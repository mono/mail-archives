<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mixed Mode Assemblies
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mixed%20Mode%20Assemblies&In-Reply-To=j06qse%24hkv%241%40dough.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037836.html">
   <LINK REL="Next"  HREF="037838.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mixed Mode Assemblies</H1>
    <B>Tom Spink</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mixed%20Mode%20Assemblies&In-Reply-To=j06qse%24hkv%241%40dough.gmane.org"
       TITLE="[Mono-dev] Mixed Mode Assemblies">tspink at gmail.com
       </A><BR>
    <I>Wed Jul 20 11:17:52 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037836.html">[Mono-dev] Mixed Mode Assemblies
</A></li>
        <LI>Next message: <A HREF="037838.html">[Mono-dev] Mixed Mode Assemblies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37837">[ date ]</a>
              <a href="thread.html#37837">[ thread ]</a>
              <a href="subject.html#37837">[ subject ]</a>
              <a href="author.html#37837">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20 July 2011 16:05, Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:

&gt;<i> Hi Tom!
</I>&gt;<i>
</I>
Hi Robert!

Nice :) Not exactly &quot;Mixed Mode Assemblies&quot; though, because the
&gt;<i> really interesting part (calling unmanaged code w/out having to
</I>&gt;<i> go through p/invoke) remains the same pain.
</I>&gt;<i>
</I>&gt;<i>
</I>Absolutely - I've been thinking a lot about that direction, and I think
you'd probably need to write/extend a compiler to do it
properly/efficiently.  What I've made is just a wrapper around the Mono
embedding API, exposing classes as symbols in a shared object.

To properly build a mixed-mode assembly, I guess you'd have to have a
compiler that was aware of it - I think.


&gt;<i> Out of curiosity: How are you handling more than one of those
</I>&gt;<i> &quot;mixed assemblies&quot; in the same process? Is there a function
</I>&gt;<i> inside libmono that can be used to detect an already initialized
</I>&gt;<i> runtime?
</I>&gt;<i>
</I>
An interesting question - because I was just pondering that myself.  Answer
is, I haven't thought about it yet and so haven't tackled the problem.  I am
hacking away at it just now, so eventually I'll come across the issue!


&gt;<i> On the generated stubs: are you using thunks or mono_runtime_invoke?
</I>&gt;<i> Are you rewriting the signature of the stubs to be HRESULT-like
</I>&gt;<i> (to be able to catch/detect managed exceptions)?
</I>&gt;<i>
</I>
I'm using mono_method_get_unmanaged_thunk, and at the moment if any
exception was raised (by use of the exception output parameter in the
thunk), it just gets re-thrown in situ, and hence not handled by the calling
code.  What I've done is make GCC put the stubs into their own linker
section that's writable (so as to make it possible to patch the stubs at
runtime), and to this end, I'd like to re-write the entire stub on first
call, after it's gotten the unmanaged thunk, to directly call the function
pointer, thus reducing the overhead of the stub.

It's an interesting problem to tackle, because you need to provide this
exception to the calling code somehow, but I'm trying to limit the amount of
information exposed to the callers, as I wanted it to be as close to native
as possible.  So,the stubs, at the moment, are just direct copies of the
managed method signatures (plus a *this parameter for instance methods).

Let me see if I can get the code uploaded somewhere.

Oh, and another interesting problem to solve is that of multi-threading,
firstly as you need to call mono_thread_attach when using threads and the
embedding API, and secondly race conditions between initialising the runtime
and calling other functions.  It may have to be some kind of terrible lock,
or something.


&gt;<i> Robert
</I>

-- Tom
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110720/1e306cf8/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110720/1e306cf8/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037836.html">[Mono-dev] Mixed Mode Assemblies
</A></li>
	<LI>Next message: <A HREF="037838.html">[Mono-dev] Mixed Mode Assemblies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37837">[ date ]</a>
              <a href="thread.html#37837">[ thread ]</a>
              <a href="subject.html#37837">[ subject ]</a>
              <a href="author.html#37837">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
