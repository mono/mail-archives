<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] gc_test_and_set + arm architectures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20gc_test_and_set%20%2B%20arm%20architectures&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037886.html">
   <LINK REL="Next"  HREF="037888.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] gc_test_and_set + arm architectures</H1>
    <B>Brian Luczkiewicz</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20gc_test_and_set%20%2B%20arm%20architectures&In-Reply-To="
       TITLE="[Mono-dev] gc_test_and_set + arm architectures">brian at sooloos.com
       </A><BR>
    <I>Wed Jul 27 09:59:59 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037886.html">[Mono-dev] F# packaging + fsyacc/fslex
</A></li>
        <LI>Next message: <A HREF="037888.html">[Mono-dev] gc_test_and_set + arm architectures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37885">[ date ]</a>
              <a href="thread.html#37885">[ thread ]</a>
              <a href="subject.html#37885">[ subject ]</a>
              <a href="author.html#37885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This code (duplicated below, from gc_locks.h) is a little bit troublesome.
I'm not sure what the best way to resolve is, but I figured I'd raise the
issue anyways.

On most architectures, building for an old CPU then running on a newer one
is safe. For example, running code compiled for i386 on a modern intel cpu
generally turns out ok.

With mono+arm this is not the case. If I use gcc to build for arm with no
-march/etc flags, gcc builds for armv5. If I run this mono on an SMP armv7a
machine, I get deadlocks and terribleness, because test+set is broken. The
comments seems to suggest that someone anticipated this issue, but never
followed up.

Any ideas how we can make this experience better? If it's truly not possible
to write a single code path that is suitable for both CPUs when building for
armv5, maybe code built for armv5 should force mono into a single cpu or
assert at boot if run on an SMP arm machine.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

        inline static int GC_test_and_set(volatile unsigned int *addr) {#if
defined(__ARM_ARCH_6__) || defined(__ARM_ARCH_7A__) ||
defined(__ARM_ARCH_7__)
          int ret, tmp;
          __asm__ __volatile__ (
                                 &quot;1:\n&quot;
&quot;ldrex %0, [%3]\n&quot;
                                 &quot;strex %1, %2, [%3]\n&quot;
                                 &quot;teq %1, #0\n&quot;
                                 &quot;bne 1b\n&quot;
                                 : &quot;=&amp;r&quot; (ret), &quot;=&amp;r&quot; (tmp)
                                 : &quot;r&quot; (1), &quot;r&quot; (addr)
                                 : &quot;memory&quot;, &quot;cc&quot;);
          return ret;
#else
          int oldval;
          /* SWP on ARM is very similar to XCHG on x86.  Doesn't lock the
           * bus because there are no SMP ARM machines.  If/when there are,
           * this code will likely need to be updated. */
          /* See linuxthreads/sysdeps/arm/pt-machine.h in glibc-2.1 */
          __asm__ __volatile__(&quot;swp %0, %1, [%2]&quot;
                             : &quot;=&amp;r&quot;(oldval)
                             : &quot;r&quot;(1), &quot;r&quot;(addr)
                             : &quot;memory&quot;);
          return oldval;
#endif
        }
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110727/3511c04c/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110727/3511c04c/attachment.html</A> 
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037886.html">[Mono-dev] F# packaging + fsyacc/fslex
</A></li>
	<LI>Next message: <A HREF="037888.html">[Mono-dev] gc_test_and_set + arm architectures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37885">[ date ]</a>
              <a href="thread.html#37885">[ thread ]</a>
              <a href="subject.html#37885">[ subject ]</a>
              <a href="author.html#37885">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
