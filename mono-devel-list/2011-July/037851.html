<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Non-TCP/IP socket access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Non-TCP/IP%20socket%20access&In-Reply-To=j0bul8%24fc7%241%40dough.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037850.html">
   <LINK REL="Next"  HREF="037854.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Non-TCP/IP socket access</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Non-TCP/IP%20socket%20access&In-Reply-To=j0bul8%24fc7%241%40dough.gmane.org"
       TITLE="[Mono-dev] Non-TCP/IP socket access">robertj at gmx.net
       </A><BR>
    <I>Fri Jul 22 10:15:25 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037850.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
        <LI>Next message: <A HREF="037854.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37851">[ date ]</a>
              <a href="thread.html#37851">[ thread ]</a>
              <a href="subject.html#37851">[ subject ]</a>
              <a href="author.html#37851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22.07.2011 15:40, Robert Jordan wrote:
&gt;<i> On 22.07.2011 15:00, Andy Hume wrote:
</I>&gt;&gt;&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf
</I>&gt;&gt;&gt;<i> Of Robert Jordan
</I>&gt;&gt;&gt;<i> Sent: 22 July 2011 12:43
</I>&gt;&gt;&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [Mono-dev] Non-TCP/IP socket access
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 22.07.2011 13:08, Andy Hume wrote:
</I>&gt;&gt;&gt;&gt;<i> Presumably I can't convert my fd to a wapi handle somehow...  So is
</I>&gt;&gt;&gt;&gt;<i> that plan not going to work? :-,(
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It won't work. The whole socket machinery assumes type
</I>&gt;&gt;&gt;<i> AF_UNIX or AF_INET. If you set a fd of some other address
</I>&gt;&gt;&gt;<i> family type, a lot of nasty things could happen if this check
</I>&gt;&gt;&gt;<i> wasn't there.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Get/SetSocketOptions, Local/RemoteEndPoint etc. simply don't
</I>&gt;&gt;&gt;<i> cope with other AF types. They would return garbage at best.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> I actually don't need to call any of those functions -- and if I were I
</I>&gt;&gt;<i> could just P/Invoke them...[1] :-,(
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The bit I obviously don't want to have to write myself is anything to do
</I>&gt;&gt;<i> with I/O.  That's a huge amount of difficult work and its all there and
</I>&gt;&gt;<i> working in Mono and would work for my (SOCK_STREAM) socket if I could
</I>&gt;&gt;<i> just create the socket somehow. :-,(
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All I need is that wapi handle...[2]  Do we think it's impossible to
</I>&gt;&gt;<i> access it.
</I>&gt;<i>
</I>&gt;<i> It looks like you could be able to create the socket with
</I>&gt;<i> io-layers's function:
</I>&gt;<i>
</I>&gt;<i> [DllImport(&quot;__Internal&quot;)]
</I>&gt;<i> static extern int _wapi_socket(int domain, int type,
</I>&gt;<i>     int protocol, IntPtr unused1, int unused2, int unused3);
</I>
Thank God this doesn't work because _wapi_* symbols are marked
as private.

But there is another way:

1) create an INET socket with Mono's System.Net.Sockets.Socket
class

2) get its FD via reflection

3) close it via p/invoke with close(2) (see &quot;man 2 close&quot;)

4) create your socket via p/invoke with socket(2)

5) don't close the socket create in (4) yourself, because
WAPI will take care of it.

6) use the socket created in (1) throughout your application

Because Unix is reusing descriptors, the socket created in (4)
will have the same number, and WAPI will be happy.

Put this code inside a lock to prevent that some other
thread is stealing your fd.

Robert

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037850.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
	<LI>Next message: <A HREF="037854.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37851">[ date ]</a>
              <a href="thread.html#37851">[ thread ]</a>
              <a href="subject.html#37851">[ subject ]</a>
              <a href="author.html#37851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
