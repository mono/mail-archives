<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Non-TCP/IP socket access
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Non-TCP/IP%20socket%20access&In-Reply-To=j0c7hq%24at8%241%40dough.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037857.html">
   <LINK REL="Next"  HREF="037866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Non-TCP/IP socket access</H1>
    <B>Andy Hume</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Non-TCP/IP%20socket%20access&In-Reply-To=j0c7hq%24at8%241%40dough.gmane.org"
       TITLE="[Mono-dev] Non-TCP/IP socket access">andyhume32 at yahoo.co.uk
       </A><BR>
    <I>Mon Jul 25 09:24:39 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037857.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
        <LI>Next message: <A HREF="037866.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37865">[ date ]</a>
              <a href="thread.html#37865">[ thread ]</a>
              <a href="subject.html#37865">[ subject ]</a>
              <a href="author.html#37865">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> 
</I>&gt;<i> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf 
</I>&gt;<i> Of Robert Jordan
</I>&gt;<i> Sent: 22 July 2011 17:12
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-dev] Non-TCP/IP socket access
</I>&gt;<i> 
</I>&gt;<i> On 22.07.2011 18:04, Ivo Smits wrote:
</I>&gt;<i> &gt; Op 22-7-2011 17:05, Andy Hume schreef:
</I>[...]
&gt;<i> &gt; However, looking at the mono code, there are no checks in 
</I>&gt;<i> the managed 
</I>&gt;<i> &gt; part of the Socket construction. Did I miss anything, is it in the 
</I>&gt;<i> &gt; unmanaged code perhaps? Have you tried to use the managed Socket
</I>&gt;<i> 
</I>&gt;<i> There are checks. That's the whole point.
</I>&gt;<i>
</I>So just to explain to Ivo and any other interested parties what happens
in Sockets on Mono versus on MSFT.

On MSFT implementations there are no restriction on the sockets values
and types that can be used.  For instance any address family can be used
in Socket..ctor(af,t,p)[1].  There are also no restrictions on the
EndPoint sub-classes that can be used, that class cleverly uses the
Prototype Pattern with instance methods Serialize[2] converting to
sockaddr as a byte[] and Create for the opposite direction (and noted
before which is support in Mono since 2007-08-02).  For instance we have
simple BluetoothEndPoint (and e.g. IrDAEndPoint) classes that work both
on the Win32 CLR and on the NETCF.  Finally there any no restriction on
socket options.  Basically in all cases the values used by the caller
are passed unchanged to the Winsock calls and vice versa.


On Mono however there is the necessity to handle different platforms
(Linux, OSX, Windows etc).  Code for this has been placed in the runtime
(native) code.  It will convert the family values used in managed code
(System.Net.Sockets.AddressFamily) to the platform equivalent and in
reverse, it also remaps the layout of sockaddr structs, and finally does
similar things for socket options.  That's all good and well and useful
for TCP/IP sockets as there is support on all platforms, it also works
for UNIX sockets for instance.

Currently other socket types are blocked.  This occurs because the
mapping functions will return an error if asked to handle a different
address family.  For instance see convert_family at
mono/metadata/socket-io.c[3], when given an unknown value will skip it
and return -1, similarly for the other direction convert_to_mono_family
returns AddressFamily_Unknown.  For Connect and Bind, they use
create_sockaddr_from_object which for an unknown family returns:
		*error = WSAEAFNOSUPPORT;

Hence why I can't use Socket directly currently. :-,(

Andy


_Footnotes/Details

[1] For Socket the given family value will be passed directly though
managed code to the CLR and to the native call.

[2] For EndPoint, in-box support on desktop includes IPEndPoint, and on
NETCF an addition is IrDAEndPoint.  As a third-party we have
successfully used our BluetoothEndPoint and IrDAEndPoint classes on both
platforms.

What happens is that for Connect/Bind the EndPoint.Serialize instance
method is called by the managed Socket methods and the result byte array
is passed directly through the CLR to the relevant native calls.
Similar support exists for getting EndPoints _from_ native code, for
Local-/RemoteEndPoint properties).  There the EndPoint.Create instance
method is used.  (Apparently Serialize is called first to get a
correctly-size buffer to pass down to the native code.

[3] <A HREF="https://github.com/mono/mono/blob/master/mono/metadata/socket-io.c">https://github.com/mono/mono/blob/master/mono/metadata/socket-io.c</A>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037857.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
	<LI>Next message: <A HREF="037866.html">[Mono-dev] Non-TCP/IP socket access
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37865">[ date ]</a>
              <a href="thread.html#37865">[ thread ]</a>
              <a href="subject.html#37865">[ subject ]</a>
              <a href="author.html#37865">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
