<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] how does unmanaged callback marshalling work in full	aot?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20how%20does%20unmanaged%20callback%20marshalling%20work%20in%20full%0A%09aot%3F&In-Reply-To=FA79B6B6-8C33-4870-BFBA-EFF98507FE04%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037891.html">
   <LINK REL="Next"  HREF="037894.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] how does unmanaged callback marshalling work in full	aot?</H1>
    <B>Brian Luczkiewicz</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20how%20does%20unmanaged%20callback%20marshalling%20work%20in%20full%0A%09aot%3F&In-Reply-To=FA79B6B6-8C33-4870-BFBA-EFF98507FE04%40gmail.com"
       TITLE="[Mono-dev] how does unmanaged callback marshalling work in full	aot?">brian at sooloos.com
       </A><BR>
    <I>Sat Jul 30 17:51:16 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037891.html">[Mono-dev] how does unmanaged callback marshalling work in full	aot?
</A></li>
        <LI>Next message: <A HREF="037894.html">[Mono-dev] how does unmanaged callback marshalling work in full	aot?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37893">[ date ]</a>
              <a href="thread.html#37893">[ thread ]</a>
              <a href="subject.html#37893">[ subject ]</a>
              <a href="author.html#37893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just thought of a scheme to do non-static delegate marshalling without
code generation, but it's a little bit goofy.

Allocate a structure that contains two things:

(1) the instance ptr that you want to capture
(2) the function ptr for a compile-time-generated invoker that implements
the desired unmanaged function signature.

Then hand this structure off to unmanaged-land as if it were a function
pointer.

when you try to execute the function, the kernel will raise a fault. The
runtime can notice that it's in this situation and invoke (2) with (1)
either using another compile time generated function to forward the call, or
(maybe on x86) by rewriting the stack to push the instance pointer + then
jumping to the real function.

There's obviously a cost associated with the fault. There's also a chance
that the specific implementation of iOS's limitations would prohibit this
(the kernel might murder the process before we get a chance to recover).

Anyways, just a thought..





On Fri, Jul 29, 2011 at 5:14 PM, Geoff Norton &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">grompf at gmail.com</A>&gt; wrote:

&gt;<i> It is disabled in full-aot environments.  Full-aot only supports static
</I>&gt;<i> delegates to be pinvoked, and even then they need to be decorated with a
</I>&gt;<i> special attribute.
</I>&gt;<i>
</I>&gt;<i> See <A HREF="https://github.com/mono/mono/blob/master/mono/mini/aot-compiler.c">https://github.com/mono/mono/blob/master/mono/mini/aot-compiler.c</A> around
</I>&gt;<i> line 2793.
</I>&gt;<i>
</I>&gt;<i> -g
</I>&gt;<i>
</I>&gt;<i> On 2011-07-29, at 5:03 PM, Brian Luczkiewicz wrote:
</I>&gt;<i>
</I>&gt;<i> I'm having trouble seeing how an arbitrary delegate can be marshalled into
</I>&gt;<i> an unmanaged function pointer without runtime code generation to capture the
</I>&gt;<i> object pointer.
</I>&gt;<i>
</I>&gt;<i> Is this functionality disabled in full-aot environments or is it
</I>&gt;<i> accomplished by some mechanism that I'm not considering?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110730/a5944051/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110730/a5944051/attachment.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037891.html">[Mono-dev] how does unmanaged callback marshalling work in full	aot?
</A></li>
	<LI>Next message: <A HREF="037894.html">[Mono-dev] how does unmanaged callback marshalling work in full	aot?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37893">[ date ]</a>
              <a href="thread.html#37893">[ thread ]</a>
              <a href="subject.html#37893">[ subject ]</a>
              <a href="author.html#37893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
