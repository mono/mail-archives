<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] {kinda OT} Linux equivalent of	Win32	&quot;ReadProcessMemory&quot;...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%7Bkinda%20OT%7D%20Linux%20equivalent%20of%0A%09Win32%09%22ReadProcessMemory%22...&In-Reply-To=05DA40EB-A002-46FC-A2E4-91F3EA131C55%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031739.html">
   <LINK REL="Next"  HREF="031774.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] {kinda OT} Linux equivalent of	Win32	&quot;ReadProcessMemory&quot;...</H1>
    <B>Martin Baulig</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%7Bkinda%20OT%7D%20Linux%20equivalent%20of%0A%09Win32%09%22ReadProcessMemory%22...&In-Reply-To=05DA40EB-A002-46FC-A2E4-91F3EA131C55%40novell.com"
       TITLE="[Mono-dev] {kinda OT} Linux equivalent of	Win32	&quot;ReadProcessMemory&quot;...">martin at novell.com
       </A><BR>
    <I>Tue Apr 14 11:47:39 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031739.html">[Mono-dev] {kinda OT} Linux equivalent of Win32	&quot;ReadProcessMemory&quot;...
</A></li>
        <LI>Next message: <A HREF="031774.html">[Mono-dev] {kinda OT} Linux equivalent of	Win32	&quot;ReadProcessMemory&quot;...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31763">[ date ]</a>
              <a href="thread.html#31763">[ thread ]</a>
              <a href="subject.html#31763">[ subject ]</a>
              <a href="author.html#31763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 2009-04-13 at 10:45 -0400, Miguel de Icaza wrote:

&gt;<i> &gt; * Has anyone actually done something like this and run into non- 
</I>&gt;<i> &gt; obvious
</I>&gt;<i> &gt; problems?  I'm most concerned that there are some gotchas in how Linux
</I>&gt;<i> &gt; manages memory, though if its just a matter of trial and error to find
</I>&gt;<i> &gt; the right spots in memory I'm already assuming that's coming.
</I>&gt;<i> 
</I>&gt;<i> You might want to first look in /proc/PID/maps which describes which  
</I>&gt;<i> memory addresses are actually valid for that process.   Then you can  
</I>&gt;<i> start seeking and reading at will.
</I>
Hi,

you're not allowed to do that !

The following restrictions apply:

a) you're trying to read from yourself - that's allowed

or

b) you're the tracing parent of the target process - and the restriction
   applies on thread-level.

This means that in a multi-threaded application, only the thread which
initially started ptrace()'ing the target process is allowed to read
from its /proc/PID/mem.

You can check mem_read() in fs/proc/base.c in the Linux kernel
(I'm using 2.6.25.20):

====[around line 726]=====
static ssize_t mem_read(struct file * file, char __user * buf,
                        size_t count, loff_t *ppos)
{
        struct task_struct *task =
get_proc_task(file-&gt;f_path.dentry-&gt;d_inode);
        char *page;
        unsigned long src = *ppos;
        int ret = -ESRCH;
        struct mm_struct *mm;

        if (!task)
                goto out_no_task;

        if (!MAY_PTRACE(task) || !ptrace_may_attach(task))
                goto out;
======

and MAY_TRACE() is defined as

====[around line 217]=====
#define MAY_PTRACE(task) \
        (task == current || \
        (task-&gt;parent == current &amp;&amp; \
        (task-&gt;ptrace &amp; PT_PTRACED) &amp;&amp; \
         (task_is_stopped_or_traced(task)) &amp;&amp; \
         security_ptrace(current,task) == 0))
========

The reasoning for these restriction is simple: you must not attempt to
read from a process'es memory while that process is running.  The linux
kernel enforces this by requiring you to ptrace() the process.

-- 
Martin Baulig - <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">martin at novell.com</A>
&#65279;Novell GmbH, N&#246;rdlicher Zubringer 9-11, 40470 D&#252;sseldorf
GF: Dr. J&#252;rgen M&#252;ller, Sylvia Geil, Felix Imend&#246;rffer; HRB 21108 (AG
D&#252;sseldorf) 


</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031739.html">[Mono-dev] {kinda OT} Linux equivalent of Win32	&quot;ReadProcessMemory&quot;...
</A></li>
	<LI>Next message: <A HREF="031774.html">[Mono-dev] {kinda OT} Linux equivalent of	Win32	&quot;ReadProcessMemory&quot;...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31763">[ date ]</a>
              <a href="thread.html#31763">[ thread ]</a>
              <a href="subject.html#31763">[ subject ]</a>
              <a href="author.html#31763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
