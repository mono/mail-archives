<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Performance problems on ARM/linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20problems%20on%20ARM/linux&In-Reply-To=49DE3195.3060003%40parkeon.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031676.html">
   <LINK REL="Next"  HREF="031793.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Performance problems on ARM/linux</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20problems%20on%20ARM/linux&In-Reply-To=49DE3195.3060003%40parkeon.com"
       TITLE="[Mono-dev] Performance problems on ARM/linux">kumpera at gmail.com
       </A><BR>
    <I>Wed Apr 15 13:40:07 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031676.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
        <LI>Next message: <A HREF="031793.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31792">[ date ]</a>
              <a href="thread.html#31792">[ thread ]</a>
              <a href="subject.html#31792">[ subject ]</a>
              <a href="author.html#31792">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Which FP mode your cpu/linux support? FPA, VFP or soft-float?

ARM_FPU_NONE enables soft-float mode, which is super slow compared
to any hardware.



On Thu, Apr 9, 2009 at 2:34 PM, Martin Fuzzey &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mfuzzey at parkeon.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i> I'm running mono on ARM/linux (i.MX21 processor) using svn build 130875
</I>&gt;<i> (the xbuild in the 2.4 release won't build my application).
</I>&gt;<i>
</I>&gt;<i> It works but the performance doesn't seem very good.
</I>&gt;<i> Specifically compared to the same hardware under WinCE and .NET compact
</I>&gt;<i> framework i'm seeing a *6 on startup time and *7 on many operations.
</I>&gt;<i>
</I>&gt;<i> The mono application is compiled with xbuild / gmcs  (using framework
</I>&gt;<i> 2.0 rather than the CF so it's not quite a fair comparison I know).
</I>&gt;<i>
</I>&gt;<i> I've built mono with:
</I>&gt;<i> configure: --with-tls=pthread --without-static_mono
</I>&gt;<i> --without-sigaltstack --without-mcs_docs --disable-parallel-mark
</I>&gt;<i> C_FLAGS: -DARM_FPU_FPA
</I>&gt;<i> I'm using the SMALL_CONFIG option for the gc
</I>&gt;<i> I'm not using any -enable-minimal options as I'm not worried (for the
</I>&gt;<i> moment) about disk size.
</I>&gt;<i>
</I>&gt;<i> [I need --without-static_mono because the application accesses
</I>&gt;<i> WaitForSingleObject etc - I can use the versions supplied by the iolayer
</I>&gt;<i> via an assemble config file but it only works if both the mono runtime
</I>&gt;<i> and the imported native DLL use the same code]
</I>&gt;<i>
</I>&gt;<i> Initially I used ARM_FPU_NONE but that causes floats (but not doubles)
</I>&gt;<i> to fail. In particular it caused an assertion error relative the the
</I>&gt;<i> load factor (which is a float) of the Hashtable class. With FPU_NONE the
</I>&gt;<i> following test app gives incorrect output:
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i>
</I>&gt;<i> public class FloatTest {
</I>&gt;<i>
</I>&gt;<i>        static void Main()
</I>&gt;<i>        {
</I>&gt;<i>                        int i1 = 1;
</I>&gt;<i>                        int i2 = 2;
</I>&gt;<i>                        float f1 = 1.0f;
</I>&gt;<i>                        float f2 = 1.5f;
</I>&gt;<i>                        double d1 = 1.0;
</I>&gt;<i>                        double d2 = 1.5;
</I>&gt;<i>                        bool result;
</I>&gt;<i>
</I>&gt;<i>                        System.Console.WriteLine(&quot;Hello world&quot;);
</I>&gt;<i>                        System.Console.WriteLine(&quot;i1=&quot; + i1 + &quot; i2=&quot; + i2);
</I>&gt;<i>                        System.Console.WriteLine(&quot;f1=&quot; + f1 + &quot; f2=&quot; + f2);
</I>&gt;<i>                        System.Console.WriteLine(&quot;d1=&quot; + d1 + &quot; d2=&quot; + d2);
</I>&gt;<i>
</I>&gt;<i>                        result = i1 &lt; i2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;i1 &lt; i2 : &quot; + result);
</I>&gt;<i>                        result = i1 &gt; i2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;i1 &gt; i2 : &quot; + result);
</I>&gt;<i>
</I>&gt;<i>                        result = f1 &lt; f2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;f1 &lt; f2 : &quot; + result);
</I>&gt;<i>                        result = f1 &gt; f2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;f1 &gt; f2 : &quot; + result);
</I>&gt;<i>
</I>&gt;<i>                        result = d1 &lt; d2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;d1 &lt; d2 : &quot; + result);
</I>&gt;<i>                        result = d1 &gt; d2;
</I>&gt;<i>                        System.Console.WriteLine(&quot;d1 &gt; d2 : &quot; + result);
</I>&gt;<i>        }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> [it gave gibberish values and incorrect comparisons for f1,f2  (but not
</I>&gt;<i> for d1,d2)]
</I>&gt;<i>
</I>&gt;<i> time shows that it's mostly userspace:
</I>&gt;<i>
</I>&gt;<i> real    0m 51.26s
</I>&gt;<i> user    0m 44.05s
</I>&gt;<i> sys     0m 5.09s
</I>&gt;<i>
</I>&gt;<i> I've tried using
</I>&gt;<i> --profile=default:stat
</I>&gt;<i>
</I>&gt;<i> but that gives me
</I>&gt;<i>
</I>&gt;<i> **
</I>&gt;<i> ** ERROR:(handles.c:497):_wapi_handle_new: assertion failed:
</I>&gt;<i> (_wapi_has_shut_down == FALSE)
</I>&gt;<i>
</I>&gt;<i> ** (fatapp/Fat_App.exe:1994): WARNING **: Thread (nil) may have been
</I>&gt;<i> prematurely finalized
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Bug 445610 talks about something similar but on OS X.  Should the
</I>&gt;<i> profiler work on ARM??
</I>&gt;<i>
</I>&gt;<i> I don't think it's a gc problem because --stats gives:
</I>&gt;<i> Major GC collections:   20
</I>&gt;<i> Major GC time in msecs: 1012.903000
</I>&gt;<i>
</I>&gt;<i> ie the GC only accounts for 1s of the 50s
</I>&gt;<i>
</I>&gt;<i> I've tried using aot ;  it compiles fine and generates a .so but when
</I>&gt;<i> running it I get a segfault:
</I>&gt;<i>
</I>&gt;<i> Stacktrace:
</I>&gt;<i>
</I>&gt;<i>  at System.Windows.Forms.Control.OnSizeChanged (System.EventArgs)
</I>&gt;<i> &lt;0xffffffff&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.OnSizeChanged (System.EventArgs) &lt;0x00034&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.UpdateBounds (int,int,int,int,int,int)
</I>&gt;<i> &lt;0x00223&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.UpdateBounds (int,int,int,int) &lt;0x000f3&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.SetBoundsCoreInternal
</I>&gt;<i> (int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x00383&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.SetBoundsCore
</I>&gt;<i> (int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x0005f&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.SetBoundsInternal
</I>&gt;<i> (int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x0013b&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.SetBounds
</I>&gt;<i> (int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x000ab&gt;
</I>&gt;<i>  at System.Windows.Forms.Control.set_Size (System.Drawing.Size) &lt;0x00047&gt;
</I>&gt;<i>  at (wrapper remoting-invoke-with-check)
</I>&gt;<i> System.Windows.Forms.Control.set_Size (System.Drawing.Size) &lt;0xffffffff&gt;
</I>&gt;<i>  at Fat_App.Form1.InitializeComponent () &lt;0x00a63&gt;
</I>&gt;<i>  at Fat_App.Form1..ctor () &lt;0x00033&gt;
</I>&gt;<i>  at (wrapper remoting-invoke-with-check) Fat_App.Form1..ctor ()
</I>&gt;<i> &lt;0xffffffff&gt;
</I>&gt;<i>  at Fat_App.Program.Main () &lt;0x00033&gt;
</I>&gt;<i>  at (wrapper runtime-invoke) object.runtime_invoke_void
</I>&gt;<i> (object,intptr,intptr,intptr) &lt;0xffffffff&gt;
</I>&gt;<i>
</I>&gt;<i> Native stacktrace:
</I>&gt;<i>
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x4012403c]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40054350]
</I>&gt;<i>        /lib/libc.so.6(__default_rt_sa_restorer+0) [0x405788b0]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40224bd0]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40224ed4]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40051f98]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40052a88]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40053750]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40053940]
</I>&gt;<i>        /usr/local/lib/libmono.so.0(mono_compile_method+0x7c) [0x40180638]
</I>&gt;<i>        /usr/local/lib/libmono.so.0 [0x40125544]
</I>&gt;<i>        [0x406ad058]
</I>&gt;<i>
</I>&gt;<i> I don't get a full symbolic stack trace even if the binaries are not
</I>&gt;<i> stripped.
</I>&gt;<i> But I don't understand why it found mono_compile_method and not the others.
</I>&gt;<i>
</I>&gt;<i> Running the X86 version of mono (built from the same sources) has no
</I>&gt;<i> problems (all the profiling options work).
</I>&gt;<i> Just one strange thing in that case - even when using --aot the --stats
</I>&gt;<i> output on execution shows
</I>&gt;<i> Methods from AOT:       0
</I>&gt;<i>
</I>&gt;<i> I would much appreciate any ideas on:
</I>&gt;<i> a) Why the profiling / aot stuff doesn't work
</I>&gt;<i> b) Ideas for other avenues to persue
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Martin Fuzzey
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090415/87fc5073/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090415/87fc5073/attachment.html</A> 
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031676.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
	<LI>Next message: <A HREF="031793.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31792">[ date ]</a>
              <a href="thread.html#31792">[ thread ]</a>
              <a href="subject.html#31792">[ subject ]</a>
              <a href="author.html#31792">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
