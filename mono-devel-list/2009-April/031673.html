<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Performance problems on ARM/linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20problems%20on%20ARM/linux&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031677.html">
   <LINK REL="Next"  HREF="031676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Performance problems on ARM/linux</H1>
    <B>Martin Fuzzey</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20problems%20on%20ARM/linux&In-Reply-To="
       TITLE="[Mono-dev] Performance problems on ARM/linux">mfuzzey at parkeon.com
       </A><BR>
    <I>Thu Apr  9 13:34:13 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031677.html">[Mono-dev] [PATCH] Fix wrong maximal instruction length	assertion for embedded builds
</A></li>
        <LI>Next message: <A HREF="031676.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31673">[ date ]</a>
              <a href="thread.html#31673">[ thread ]</a>
              <a href="subject.html#31673">[ subject ]</a>
              <a href="author.html#31673">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
I'm running mono on ARM/linux (i.MX21 processor) using svn build 130875 
(the xbuild in the 2.4 release won't build my application).

It works but the performance doesn't seem very good.
Specifically compared to the same hardware under WinCE and .NET compact
framework i'm seeing a *6 on startup time and *7 on many operations.

The mono application is compiled with xbuild / gmcs  (using framework
2.0 rather than the CF so it's not quite a fair comparison I know).

I've built mono with:
configure: --with-tls=pthread --without-static_mono
--without-sigaltstack --without-mcs_docs --disable-parallel-mark
C_FLAGS: -DARM_FPU_FPA
I'm using the SMALL_CONFIG option for the gc
I'm not using any -enable-minimal options as I'm not worried (for the
moment) about disk size.

[I need --without-static_mono because the application accesses
WaitForSingleObject etc - I can use the versions supplied by the iolayer
via an assemble config file but it only works if both the mono runtime
and the imported native DLL use the same code]

Initially I used ARM_FPU_NONE but that causes floats (but not doubles)
to fail. In particular it caused an assertion error relative the the
load factor (which is a float) of the Hashtable class. With FPU_NONE the
following test app gives incorrect output:

using System;

public class FloatTest {

        static void Main()
        {
                        int i1 = 1;
                        int i2 = 2;
                        float f1 = 1.0f;
                        float f2 = 1.5f;
                        double d1 = 1.0;
                        double d2 = 1.5;
                        bool result;

                        System.Console.WriteLine(&quot;Hello world&quot;);
                        System.Console.WriteLine(&quot;i1=&quot; + i1 + &quot; i2=&quot; + i2);
                        System.Console.WriteLine(&quot;f1=&quot; + f1 + &quot; f2=&quot; + f2);
                        System.Console.WriteLine(&quot;d1=&quot; + d1 + &quot; d2=&quot; + d2);

                        result = i1 &lt; i2;
                        System.Console.WriteLine(&quot;i1 &lt; i2 : &quot; + result);
                        result = i1 &gt; i2;
                        System.Console.WriteLine(&quot;i1 &gt; i2 : &quot; + result);

                        result = f1 &lt; f2;
                        System.Console.WriteLine(&quot;f1 &lt; f2 : &quot; + result);
                        result = f1 &gt; f2;
                        System.Console.WriteLine(&quot;f1 &gt; f2 : &quot; + result);

                        result = d1 &lt; d2;
                        System.Console.WriteLine(&quot;d1 &lt; d2 : &quot; + result);
                        result = d1 &gt; d2;
                        System.Console.WriteLine(&quot;d1 &gt; d2 : &quot; + result);
        }
}

[it gave gibberish values and incorrect comparisons for f1,f2  (but not
for d1,d2)]

time shows that it's mostly userspace:

real    0m 51.26s
user    0m 44.05s
sys     0m 5.09s

I've tried using
--profile=default:stat

but that gives me

**
** ERROR:(handles.c:497):_wapi_handle_new: assertion failed:
(_wapi_has_shut_down == FALSE)

** (fatapp/Fat_App.exe:1994): WARNING **: Thread (nil) may have been
prematurely finalized


Bug 445610 talks about something similar but on OS X.  Should the
profiler work on ARM??

I don't think it's a gc problem because --stats gives:
Major GC collections:   20
Major GC time in msecs: 1012.903000

ie the GC only accounts for 1s of the 50s

I've tried using aot ;  it compiles fine and generates a .so but when
running it I get a segfault:

Stacktrace:

  at System.Windows.Forms.Control.OnSizeChanged (System.EventArgs)
&lt;0xffffffff&gt;
  at System.Windows.Forms.Control.OnSizeChanged (System.EventArgs) &lt;0x00034&gt;
  at System.Windows.Forms.Control.UpdateBounds (int,int,int,int,int,int)
&lt;0x00223&gt;
  at System.Windows.Forms.Control.UpdateBounds (int,int,int,int) &lt;0x000f3&gt;
  at System.Windows.Forms.Control.SetBoundsCoreInternal
(int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x00383&gt;
  at System.Windows.Forms.Control.SetBoundsCore
(int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x0005f&gt;
  at System.Windows.Forms.Control.SetBoundsInternal
(int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x0013b&gt;
  at System.Windows.Forms.Control.SetBounds
(int,int,int,int,System.Windows.Forms.BoundsSpecified) &lt;0x000ab&gt;
  at System.Windows.Forms.Control.set_Size (System.Drawing.Size) &lt;0x00047&gt;
  at (wrapper remoting-invoke-with-check)
System.Windows.Forms.Control.set_Size (System.Drawing.Size) &lt;0xffffffff&gt;
  at Fat_App.Form1.InitializeComponent () &lt;0x00a63&gt;
  at Fat_App.Form1..ctor () &lt;0x00033&gt;
  at (wrapper remoting-invoke-with-check) Fat_App.Form1..ctor ()
&lt;0xffffffff&gt;
  at Fat_App.Program.Main () &lt;0x00033&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void
(object,intptr,intptr,intptr) &lt;0xffffffff&gt;

Native stacktrace:

        /usr/local/lib/libmono.so.0 [0x4012403c]
        /usr/local/lib/libmono.so.0 [0x40054350]
        /lib/libc.so.6(__default_rt_sa_restorer+0) [0x405788b0]
        /usr/local/lib/libmono.so.0 [0x40224bd0]
        /usr/local/lib/libmono.so.0 [0x40224ed4]
        /usr/local/lib/libmono.so.0 [0x40051f98]
        /usr/local/lib/libmono.so.0 [0x40052a88]
        /usr/local/lib/libmono.so.0 [0x40053750]
        /usr/local/lib/libmono.so.0 [0x40053940]
        /usr/local/lib/libmono.so.0(mono_compile_method+0x7c) [0x40180638]
        /usr/local/lib/libmono.so.0 [0x40125544]
        [0x406ad058]

I don't get a full symbolic stack trace even if the binaries are not
stripped.
But I don't understand why it found mono_compile_method and not the others.

Running the X86 version of mono (built from the same sources) has no
problems (all the profiling options work).
Just one strange thing in that case - even when using --aot the --stats
output on execution shows
Methods from AOT:       0

I would much appreciate any ideas on:
a) Why the profiling / aot stuff doesn't work
b) Ideas for other avenues to persue

Regards,

Martin Fuzzey



</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031677.html">[Mono-dev] [PATCH] Fix wrong maximal instruction length	assertion for embedded builds
</A></li>
	<LI>Next message: <A HREF="031676.html">[Mono-dev] Performance problems on ARM/linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31673">[ date ]</a>
              <a href="thread.html#31673">[ thread ]</a>
              <a href="subject.html#31673">[ subject ]</a>
              <a href="author.html#31673">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
