<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] CRL Checking
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CRL%20Checking&In-Reply-To=4AF42B70D78BC945978C6DFF76161005A9B0FA65%40Pet15.dip.co.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032800.html">
   <LINK REL="Next"  HREF="032823.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] CRL Checking</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CRL%20Checking&In-Reply-To=4AF42B70D78BC945978C6DFF76161005A9B0FA65%40Pet15.dip.co.uk"
       TITLE="[Mono-dev] CRL Checking">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Wed Aug 19 09:44:32 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032800.html">[Mono-dev] CRL Checking
</A></li>
        <LI>Next message: <A HREF="032823.html">[Mono-dev] ASP:UpdatePanel with UpdateMode=&quot;Conditional&quot; updates always
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32801">[ date ]</a>
              <a href="thread.html#32801">[ thread ]</a>
              <a href="subject.html#32801">[ subject ]</a>
              <a href="author.html#32801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Alex,

On Wed, 2009-08-19 at 14:07 +0100, Alex Mason wrote:
&gt;<i> I'm attempting to use the Mono store system to store CRL files as part
</I>&gt;<i> of a manual implementation of online CRL checking with
</I>&gt;<i> X509Chain.Build(). Whereas X509Crl is an open object,
</I>&gt;<i> Mono.Security.X509.X509Store has no public constructor, and seemingly
</I>&gt;<i> no way to instantiate it or access it directly from a user program.
</I>
Have a look at X509Stores class to access well-known (properties) or
custom (the Open method) stores.

<A HREF="http://www.go-mono.org/docs/index.aspx?link=T%">http://www.go-mono.org/docs/index.aspx?link=T%</A>
3AMono.Security.X509.X509Stores.Names%2F*

&gt;<i>  This class contains the Import function for CRLs, although as far as
</I>&gt;<i> I can tell it isn't called anywhere else within Mono. 
</I>
No, I never got the time to complete a full (gui) certificate manager
(nor some other features that would be required for one).

&gt;<i> At the moment I've implemented the online check by generating a chain,
</I>&gt;<i> walking the elements and manually fetching the certificates, writing
</I>&gt;<i> them to the correct file name for the CRL so they can be picked up by
</I>&gt;<i> X509Chain.FindCrl
</I>
The &quot;right way&quot; is to query, from the store, a CRL for each certificate
(in the chain). If one is available then check if it's still valid. If
not (available or out-of-date) then you download a new one and update
the store.

This is important as some CRL are rarely updated and the certificate can
be used several times (e.g. check against a server) leading to severe
performance problems.

&gt;<i> Obviously it's be useful to have some way to access the Mono X509Store
</I>&gt;<i> instead of relying on these hacks. I've not that familiar with the
</I>&gt;<i> codebase, but if I'm not mistaken there's currently no way, and so I
</I>&gt;<i> was thinking maybe it's possible to provide a public constructor for
</I>&gt;<i> the store, or some system to allow importing and retrieval of CRLs?
</I>
see above

&gt;<i> On another note, I noticed X509Crl.Parse() assumes an unencoded format
</I>&gt;<i> for CRLs,
</I>
as long as &quot;unencoded == ASN.1 encoded&quot; that right ;-)

&gt;<i>  although upon downloading a few test ones I realised quite a few come
</I>&gt;<i> base64 encoded, so I created the following function, based on
</I>&gt;<i> Mono.Security.X509. X509Certificate.PEM 
</I>&gt;<i>  
</I>&gt;<i>         private static byte[] _DecodeCrlBase64(byte[] data)
</I>&gt;<i>         {
</I>&gt;<i>             string crl = Encoding.ASCII.GetString(data);
</I>&gt;<i>  
</I>&gt;<i>             string header = String.Format(&quot;-----BEGIN {0}-----&quot;, &quot;X509
</I>&gt;<i> CRL&quot;);
</I>&gt;<i>             int start = crl.IndexOf(header) + header.Length;
</I>&gt;<i>  
</I>&gt;<i>             if (start - header.Length == -1)
</I>&gt;<i>                 return data;
</I>&gt;<i>  
</I>&gt;<i>             string footer = String.Format(&quot;-----END {0}-----&quot;, &quot;X509
</I>&gt;<i> CRL&quot;);
</I>&gt;<i>             int end = crl.IndexOf(footer, start);
</I>&gt;<i>             
</I>&gt;<i>             string base64 = crl.Substring(start, (end - start));
</I>&gt;<i>             return Convert.FromBase64String(base64);
</I>&gt;<i>         }
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> I also had troubles with FindCrl, mainly:
</I>&gt;<i>  
</I>&gt;<i>         if ((ski.Length == 0) || (ski == GetAuthorityKeyIdentifier
</I>&gt;<i> (crl)))
</I>&gt;<i>      return crl;
</I>&gt;<i>  
</I>&gt;<i> this line seems to impose a mandatory Authority Key Identifier
</I>&gt;<i> (2.5.29.35) check. According to
</I>&gt;<i> <A HREF="http://www.redhat.com/docs/manuals/cert-system/admin/7.1/app_ext.html">http://www.redhat.com/docs/manuals/cert-system/admin/7.1/app_ext.html</A>
</I>
Avoid using old, pre-standard, documents (2001) and refer to the newer
RFC (e.g. 3280).

&gt;<i>  this extension is non-critical and &quot;If this extension is not present,
</I>&gt;<i> then the issuer name alone is used to identify the issuer
</I>&gt;<i> certificate.&quot;.
</I>
Criticality can be suggested/mandated by a profile (like PKIX/RFC3280
are) but (the fun part) is that everyone got it's own profile ;-) Anyway
the code itself cannot assume something is [non-]critical - but must
deal with how the extension is encoded.

&gt;<i>  
</I>&gt;<i> Hence, I believe the check should be optional, replacing the above
</I>&gt;<i> line in both places with something along the lines of:
</I>&gt;<i>  
</I>&gt;<i>         string aki = GetAuthorityKeyIdentifier (crl);
</I>&gt;<i>   
</I>&gt;<i>         if ((ski.Length == 0) || (String.IsNullOrEmpty(aki) || ski ==
</I>&gt;<i> aki))
</I>&gt;<i>             return crl;
</I>
I would need to re-read the spec before changing this.

&gt;<i> I haven't got any real functional knowledge of the theory behind the
</I>&gt;<i> CRL checks, apart from checking the related RFCs, specs and general
</I>&gt;<i> internet resources. However, I would like to contribute with this, and
</I>&gt;<i> it'd be great to get online CRL checking working in a future release
</I>&gt;<i> of Mono, as well as opening up the functionality for dealing with CRLs
</I>&gt;<i> in the store. 
</I>
There's not a big distinction between them. &quot;online&quot; does not mean
&quot;always download CRL&quot;, it means that it can update the stored [delta]
CRL and use OCSP (when available). &quot;offline&quot; means its limited to what's
available in the store.

&gt;<i> I know on top of just downloading if not found, there should be some
</I>&gt;<i> checking to ensure CRls are updated should they be found to be out of
</I>&gt;<i> date, although I don't know if this should occur in the
</I>&gt;<i> X509Chain.Build method or not.
</I>
My original idea was to provide an optional, cron-based, script/tool to
update all CRL from every store (when they become out-of-date). That
would reduce the need (and impact) of downloading CRL from X509Chain
itself.
 
&gt;<i> Hopefully someone more knowledge can give advice on how best to go
</I>&gt;<i> about all of this.
</I>
Have a look at the existing unit tests, in particular the ones that are
disabled by default (the PKITS-based tests). See the README inside
/mcs/class/System/Test/System.Security.Cryptography.X509Certificates/pkits/
for more details. Many sections are not yet tested (because the features
were missing) and no (existing) tests should regress when adding the new
features.

Sebastien


</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032800.html">[Mono-dev] CRL Checking
</A></li>
	<LI>Next message: <A HREF="032823.html">[Mono-dev] ASP:UpdatePanel with UpdateMode=&quot;Conditional&quot; updates always
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32801">[ date ]</a>
              <a href="thread.html#32801">[ thread ]</a>
              <a href="subject.html#32801">[ subject ]</a>
              <a href="author.html#32801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
