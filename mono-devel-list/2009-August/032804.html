<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] New error handling framework for mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20error%20handling%20framework%20for%20mono&In-Reply-To=20090818144348.GW7506%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032795.html">
   <LINK REL="Next"  HREF="032780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] New error handling framework for mono</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20error%20handling%20framework%20for%20mono&In-Reply-To=20090818144348.GW7506%40debian.org"
       TITLE="[Mono-dev] New error handling framework for mono">kumpera at gmail.com
       </A><BR>
    <I>Thu Aug 20 16:10:59 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032795.html">[Mono-dev] New error handling framework for mono
</A></li>
        <LI>Next message: <A HREF="032780.html">[Mono-dev] Fixing all promiscuous use of mono_raise_exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32804">[ date ]</a>
              <a href="thread.html#32804">[ thread ]</a>
              <a href="subject.html#32804">[ subject ]</a>
              <a href="author.html#32804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Aug 18, 2009 at 11:43 AM, Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; wrote:

&gt;<i> On 08/18/09 Rodrigo Kumpera wrote:
</I>&gt;<i> &gt; &gt; Still open is how this would be integrated on 2.6
</I>&gt;<i>
</I>&gt;<i> I think we should keep this internal for 2.6 and expose it in 2.8 wth
</I>&gt;<i> the other API changes, once we have gained experience with the new API.
</I>

Makes sense, otherwise we'll have no opportunity to fix all the eventual
mistakes.
But, for the cases where we want to change an exported function to use it,
simply
adding a _with_error version should be enough while 2.6 is not released.



&gt;<i> &gt; --- /dev/null
</I>&gt;<i> &gt; +++ b/mono/metadata/mono-error.c
</I>&gt;<i> &gt; @@ -0,0 +1,253 @@
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#define mono_error_get_message(E) (((E)-&gt;flags &amp;
</I>&gt;<i> MONO_ERROR_ON_SIGNAL_CONTEXT) ? (E)-&gt;message : (E)-&gt;full_message)
</I>&gt;<i>
</I>&gt;<i> I don't like MONO_ERROR_ON_SIGNAL_CONTEXT: most code is not going to
</I>&gt;<i> know in what mode it was called in. Simply always use the message
</I>&gt;<i> buffer.
</I>

I changed this to have a MONO_ERROR_STORE_FULL_MESSAGE flag. My reasoning
behind this is
that some messages are exceptionally large, specially when it does include
the assembly path. Look
at loader.c:330, just the format string is more than 320 chars long and I
don't want to embed it inside
the MonoError machinery.

Now about MONO_ERROR_ON_SIGNAL_CONTEXT, it made sense to me when the caller
did init
MonoError . Now that this change, it has to change.

I've added a MONO_ERROR_DONT_COPY_STRINGS flag but, honestly, I don't think
it is that
helpfull and it doesn't help at all into make it safe for use under signal
context.
I'm not sure if the proposed patch is usable under such conditions since I
could not find any reference
if g_vsnprintf is signal safe or not.


&gt;<i> +void
</I>&gt;<i> &gt; +mono_error_set_assembly_load (MonoError *error, char *assembly_name,
</I>&gt;<i> char *msg_format, ...)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +     va_list args;
</I>&gt;<i> &gt; +     error-&gt;error_code = MONO_EXCEPTION_FILE_NOT_FOUND;
</I>&gt;<i>
</I>&gt;<i> File not found is not the only failure case for an assembly load, we
</I>&gt;<i> should be more flexible here. Think of a bad image, for example, but
</I>&gt;<i> also of an out of memory issue.
</I>&gt;<i>
</I>
The current function naming is after the failure code and not the kind of
problem
is represents. So for bad image it's expected that one would use
mono_error_set_bad_image.

I added an option to make it possible to raise any corlib exception, which
should handle
most cases we currently have.

With this mechanism in place, the error_code only needs to encode exceptions
to which
we want to pass additional arguments beyond message.

About out-of-memory situations, yes, this needs special handling as we want
to use the
domains OOM object.

But what should be done when we get an allocation failure on the
mono_exception_set_*
function? Should we just convert such error into an OOM, abort due to a
double-fault or
silently ignore those arguments (and print something on console).


&gt;<i> to keep the code readable. It's kind of an hack.
</I>&gt;<i> An alternative is to have a separate struct with the correct types and
</I>&gt;<i> names and cast to it on public function entry.
</I>&gt;<i>
</I>
I spited it into MonoError and MonoErrorInternal.

The attached patch does all suggested changes.

Cheers,
Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090820/c8c2772a/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090820/c8c2772a/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: mono-error-patch.2.diff
Type: text/x-diff
Size: 16801 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090820/c8c2772a/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090820/c8c2772a/attachment-0001.bin</A> 
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032795.html">[Mono-dev] New error handling framework for mono
</A></li>
	<LI>Next message: <A HREF="032780.html">[Mono-dev] Fixing all promiscuous use of mono_raise_exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32804">[ date ]</a>
              <a href="thread.html#32804">[ thread ]</a>
              <a href="subject.html#32804">[ subject ]</a>
              <a href="author.html#32804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
