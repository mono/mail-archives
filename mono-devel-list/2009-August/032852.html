<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono Continuations - Memory keeps increasing after	store()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20Continuations%20-%20Memory%20keeps%20increasing%20after%0A%09store%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032858.html">
   <LINK REL="Next"  HREF="032853.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono Continuations - Memory keeps increasing after	store()</H1>
    <B>James Zhao</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20Continuations%20-%20Memory%20keeps%20increasing%20after%0A%09store%28%29&In-Reply-To="
       TITLE="[Mono-dev] Mono Continuations - Memory keeps increasing after	store()">jameszhao00 at gmail.com
       </A><BR>
    <I>Tue Aug 25 20:55:30 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032858.html">[Mono-dev] [PATCH] TimeZoneInfo
</A></li>
        <LI>Next message: <A HREF="032853.html">[Mono-dev] Mono Continuations - Memory keeps increasing after	store()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32852">[ date ]</a>
              <a href="thread.html#32852">[ thread ]</a>
              <a href="subject.html#32852">[ subject ]</a>
              <a href="author.html#32852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
Here's Mono Continuations' continuation_store (...). From looking at the
code below, it appears as though store() follows these two branches:

1. cont-&gt;saved_stack &amp;&amp; num_bytes &lt;= cont-&gt;stack_alloc_size - use the memory
directly

2. else - gc free the used memory, and create some new memory.
However, the weird thing is if I repeatedly use continuation_store(), the
memory usage increases until at a later step a huge and laggy GC operation
is done. Can anyone explain why this happens?
If I alloc/free a continuation for roughly each time I call store , the
continuation appears to be GC'ed immediately.

Thanks
James
static int continuation_store (MonoContinuation *cont, int state,
MonoException **e) { MonoLMF *lmf = mono_get_lmf (); gsize num_bytes; if
(!cont-&gt;domain) *e = mono_get_exception_argument (&quot;cont&quot;, &quot;Continuation not
initialized&quot;); if (cont-&gt;domain != mono_domain_get () || cont-&gt;thread_id !=
GetCurrentThreadId ()) *e = mono_get_exception_argument (&quot;cont&quot;,
&quot;Continuation from another thread or domain&quot;); cont-&gt;lmf = lmf;
cont-&gt;return_ip = __builtin_return_address (0); cont-&gt;return_sp =
__builtin_frame_address (0); num_bytes = (char*)cont-&gt;top_sp -
(char*)cont-&gt;return_sp; /*g_print (&quot;store: %d bytes, sp: %p, ip: %p, lmf:
%p\n&quot;, num_bytes, cont-&gt;return_sp, cont-&gt;return_ip, lmf);*/ if
(cont-&gt;saved_stack &amp;&amp; num_bytes &lt;= cont-&gt;stack_alloc_size) { /* clear to
avoid GC retention */ if (num_bytes &lt; cont-&gt;stack_used_size) memset
((char*)cont-&gt;saved_stack + num_bytes, 0, cont-&gt;stack_used_size -
num_bytes); } else { tasklets_lock (); internal_init (); if
(cont-&gt;saved_stack) { mono_g_hash_table_remove (keepalive_stacks,
cont-&gt;saved_stack); mono_gc_free_fixed (cont-&gt;saved_stack); }
cont-&gt;stack_used_size = num_bytes; cont-&gt;stack_alloc_size = num_bytes * 1.1;
cont-&gt;saved_stack = mono_gc_alloc_fixed (cont-&gt;stack_alloc_size, NULL);
mono_g_hash_table_insert (keepalive_stacks, cont-&gt;saved_stack,
cont-&gt;saved_stack); tasklets_unlock (); } memcpy (cont-&gt;saved_stack,
cont-&gt;return_sp, num_bytes); return state; }
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090825/9390d460/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090825/9390d460/attachment.html</A> 
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032858.html">[Mono-dev] [PATCH] TimeZoneInfo
</A></li>
	<LI>Next message: <A HREF="032853.html">[Mono-dev] Mono Continuations - Memory keeps increasing after	store()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32852">[ date ]</a>
              <a href="thread.html#32852">[ thread ]</a>
              <a href="subject.html#32852">[ subject ]</a>
              <a href="author.html#32852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
