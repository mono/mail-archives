<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] New error handling framework for mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20error%20handling%20framework%20for%20mono&In-Reply-To=h62436%2430n%241%40ger.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032778.html">
   <LINK REL="Next"  HREF="032781.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] New error handling framework for mono</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20error%20handling%20framework%20for%20mono&In-Reply-To=h62436%2430n%241%40ger.gmane.org"
       TITLE="[Mono-dev] New error handling framework for mono">kumpera at gmail.com
       </A><BR>
    <I>Thu Aug 13 19:05:24 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032778.html">[Mono-dev] New error handling framework for mono
</A></li>
        <LI>Next message: <A HREF="032781.html">[Mono-dev] New error handling framework for mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32779">[ date ]</a>
              <a href="thread.html#32779">[ thread ]</a>
              <a href="subject.html#32779">[ subject ]</a>
              <a href="author.html#32779">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There are a few issues with using TLS for offloading error information:

The first is that we must always copy information into it so we don't hold
onto stale
and possibly invalid data. This means it can't be used in signal context.

The second is that the information there is not as reliable as passing it
explicitly
since, for example, if one place forgets to clean up and the other fails but
doesn't
set the TLS data we might see out of context errors - mono has a lot of
those bugs
due to how the loader error stuff works.

It's harder to nest error handling contexts using TLS. To do it one has to
first save locally
all information from the nested error then insert the new one.

Finally, it makes up for good consistency to not use the return value as a
guard for error handling
because there are cases where returning NULL can mean either a valid
condition or error.


On Thu, Aug 13, 2009 at 7:28 PM, Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Zoltan Varga wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   I still it would be easier to simply pass a int* or use an int return
</I>&gt;<i> &gt; value, instead of a structure which needs to be initialized/cleaned up,
</I>&gt;<i> and
</I>&gt;<i> &gt; store any excess state in TLS. This is because
</I>&gt;<i> &gt; most code can't do anything with an error other than cleaning up and
</I>&gt;<i> passing
</I>&gt;<i> &gt; it up to the
</I>&gt;<i> &gt; caller.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So the code below could look like:
</I>&gt;<i>
</I>&gt;<i> I like this.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   err = foo ();
</I>&gt;<i> &gt;   if (err)
</I>&gt;<i>
</I>&gt;<i> Or the same pattern with excess state in TLS:
</I>&gt;<i>
</I>&gt;<i> if (foo ())
</I>&gt;<i>        MonoError *err = mono_get_last_error ();
</I>&gt;<i>        ...
</I>&gt;<i>
</I>&gt;<i> Using the return value to signal an error condition
</I>&gt;<i> also makes the code more macro-able, e.g.:
</I>&gt;<i>
</I>&gt;<i> #define MONO_CHECK(x) do { if ((x))
</I>&gt;<i>        abort (mono_get_last_error_message ()); } while (0)
</I>&gt;<i>
</I>&gt;<i> #define MONO_TRY(x) if ((x)) goto cleanup
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>        MONO_CHECK (foo ());
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;<i>        MONO_TRY (foo ());
</I>&gt;<i>        ...
</I>&gt;<i>
</I>&gt;<i>        cleanup:
</I>&gt;<i>
</I>&gt;<i> Robert
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;                                  Zoltan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Aug 13, 2009 at 11:26 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hey,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The attached patch implements the basics for the new MonoError struct
</I>&gt;<i> that
</I>&gt;<i> &gt;&gt; will be used for error handling in the runtime.
</I>&gt;<i> &gt;&gt; It has only the basics to support the current exceptions the runtime
</I>&gt;<i> handle
</I>&gt;<i> &gt;&gt; for it's operation.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The usage is pretty much like the one in Paolo's email on the subject:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; gboolean do_stuff () {
</I>&gt;<i> &gt;&gt; MonoError error;
</I>&gt;<i> &gt;&gt; mono_error_init (&amp;error, 0);
</I>&gt;<i> &gt;&gt; runtime_function_that_might_fail (..., &amp;error)
</I>&gt;<i> &gt;&gt; if (!mono_error_is_ok (&amp;error))
</I>&gt;<i> &gt;&gt;   goto fail;
</I>&gt;<i> &gt;&gt; return TRUE;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; fail:
</I>&gt;<i> &gt;&gt; mono_error_cleaup (&amp;error);
</I>&gt;<i> &gt;&gt; return FALSE; //or raise an exception using mono_raise_exception
</I>&gt;<i> &gt;&gt; (mono_error_prepare_exception (&amp;error));
</I>&gt;<i> &gt;&gt; }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The idea is to replace all error handling code with using this (loader
</I>&gt;<i> &gt;&gt; error, type exception_data and JIT's exception_type).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Still open is how this would be integrated on 2.6 and if functions
</I>&gt;<i> should
</I>&gt;<i> &gt;&gt; error out if passed an already set error object.
</I>&gt;<i> &gt;&gt; The last point enables more concise code like:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; MonoError error;
</I>&gt;<i> &gt;&gt; MonoType *type = ...;
</I>&gt;<i> &gt;&gt; mono_error_init (&amp;error);
</I>&gt;<i> &gt;&gt; MonoClass *class = mono_class_from_mono_type (type, &amp;error);
</I>&gt;<i> &gt;&gt; mono_class_init (class, &amp;error);
</I>&gt;<i> &gt;&gt; MonoMethod *method = mono_class_get_method_from_name (class, &quot;Invoke&quot;,
</I>&gt;<i> 1,
</I>&gt;<i> &gt;&gt; &amp;error);
</I>&gt;<i> &gt;&gt; if (!mono_error_ok (&amp;error))
</I>&gt;<i> &gt;&gt;   return NULL;
</I>&gt;<i> &gt;&gt; return mono_runtime_invoke (method, NULL, params, NULL);
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I left behind some aditional features I would like to add to help
</I>&gt;<i> &gt;&gt; development, like logging, signaling a breakpoint and
</I>&gt;<i> &gt;&gt; asserting if setting a second error to the same MonoError.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; It would be a good time to hear the feeback on everyone about this,
</I>&gt;<i> &gt;&gt; specially embedders, since this will be the basis for
</I>&gt;<i> &gt;&gt; error handling of the new API comming in 2.8.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Please comment,
</I>&gt;<i> &gt;&gt; Rodrigo
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mono-devel-list mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090813/eacbd3ea/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090813/eacbd3ea/attachment.html</A> 
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032778.html">[Mono-dev] New error handling framework for mono
</A></li>
	<LI>Next message: <A HREF="032781.html">[Mono-dev] New error handling framework for mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32779">[ date ]</a>
              <a href="thread.html#32779">[ thread ]</a>
              <a href="subject.html#32779">[ subject ]</a>
              <a href="author.html#32779">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
