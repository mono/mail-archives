<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono tasklet memory issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20tasklet%20memory%20issues&In-Reply-To=6cf7c3110908300850y403b186bgf06fad408a331b0d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032872.html">
   <LINK REL="Next"  HREF="032874.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono tasklet memory issues</H1>
    <B>James Zhao</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20tasklet%20memory%20issues&In-Reply-To=6cf7c3110908300850y403b186bgf06fad408a331b0d%40mail.gmail.com"
       TITLE="[Mono-dev] Mono tasklet memory issues">jameszhao00 at gmail.com
       </A><BR>
    <I>Sun Aug 30 12:37:58 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032872.html">[Mono-dev] Mono tasklet memory issues
</A></li>
        <LI>Next message: <A HREF="032874.html">[Mono-dev]  when will full-aot be supported on windows?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32873">[ date ]</a>
              <a href="thread.html#32873">[ thread ]</a>
              <a href="subject.html#32873">[ subject ]</a>
              <a href="author.html#32873">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Actually, that just uses up so much memory that every 2 steps it does a gc.

On Sun, Aug 30, 2009 at 11:50 AM, James Zhao &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jameszhao00 at gmail.com</A>&gt; wrote:

&gt;<i> Ah here's the problem. I didn't call yield/wait on any of the threads (and
</I>&gt;<i> thus store()). I fixed the problem by having every thread call yield at
</I>&gt;<i> least once and turning the code back to the version where one continuation
</I>&gt;<i> is created per step.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sun, Aug 30, 2009 at 12:45 AM, James Zhao &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jameszhao00 at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> I'm currently working on something that uses mono 2.6's
</I>&gt;&gt;<i> tasklet/continuations (similar to stackless python/'eve). However, I'm
</I>&gt;&gt;<i> experiencing some really bizzare memory issues. I tested on Windows and
</I>&gt;&gt;<i> Linux.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I modified the default Mono.MicroThreads library so each microthread
</I>&gt;&gt;<i> reuses continuations rather than allocating a new continuation every
</I>&gt;&gt;<i> Start().
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm experiencing high memory usage when calling Mono Continuation's
</I>&gt;&gt;<i> Continuation.store(). Every 4 or 5 seconds a huge GC op/spike happens.
</I>&gt;&gt;<i> Here's a comparison of memory/cpu for using Mono Continuations and directly
</I>&gt;&gt;<i> calling the method.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can view the source code
</I>&gt;&gt;<i> <A HREF="http://code.google.com/p/mmo-test/source/browse/#svn/trunk/mmo_v2">http://code.google.com/p/mmo-test/source/browse/#svn/trunk/mmo_v2</A> .
</I>&gt;&gt;<i> EntityProcessor.cs/Run() runs the microthreads and
</I>&gt;&gt;<i> EntityProcessor.cs/AddQueuedEntities() adds the microthreads.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here's some data.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Memory, ms spent in iteration
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Using Mono Continuations (200k entities/MicroThreads)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 367210496, 410
</I>&gt;&gt;<i> 385441792, 418
</I>&gt;&gt;<i> 405204992, 346
</I>&gt;&gt;<i> 427053056, 363
</I>&gt;&gt;<i> 444809216, 333
</I>&gt;&gt;<i> 462483456, 339
</I>&gt;&gt;<i> 423661568, 1559
</I>&gt;&gt;<i> 441327616, 465
</I>&gt;&gt;<i> 458985472, 305
</I>&gt;&gt;<i> 403214336, 1338
</I>&gt;&gt;<i> 419254272, 506
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not sing Mono Continuations (200k entities)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 365662208, 67
</I>&gt;&gt;<i> 365662208, 67
</I>&gt;&gt;<i> 365662208, 66
</I>&gt;&gt;<i> 365662208, 66
</I>&gt;&gt;<i> 365662208, 67
</I>&gt;&gt;<i> 365662208, 67
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> James
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here's my chat log with Rodrigo:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 12:16 AM me: hey rodrigo. do u have a moment?
</I>&gt;&gt;<i>  Rodrigo: yes
</I>&gt;&gt;<i> 12:17 AM me: i'm currently working on something that uses mono 2.6's
</I>&gt;&gt;<i> tasklet/continuations (similar to stackless python/'eve). however, im
</I>&gt;&gt;<i> experiencing some really bizzare memory issues
</I>&gt;&gt;<i>  Rodrigo: right
</I>&gt;&gt;<i>   on linux, right?
</I>&gt;&gt;<i> 12:18 AM me: i tested on linux and windows.
</I>&gt;&gt;<i>  Rodrigo: ok
</I>&gt;&gt;<i>  me: once i start using them, it causes memory usage to continue rising,
</I>&gt;&gt;<i>  Rodrigo: what kind of problems are you having?
</I>&gt;&gt;<i>  me: until at around 4-5 secs a huge gc op occur
</I>&gt;&gt;<i>   i took a look at the source
</I>&gt;&gt;<i> 12:19 AM *c source
</I>&gt;&gt;<i>  Rodrigo: well, each tasklet holds onto a big block of memory
</I>&gt;&gt;<i>  me: and it should be gcing each time store() is called, or it will
</I>&gt;&gt;<i> overwrite
</I>&gt;&gt;<i>   and im reusing continuations across iterations
</I>&gt;&gt;<i> 12:20 AM Rodrigo: why, it shouldn't be required
</I>&gt;&gt;<i>  me: sorry. gc if current required &gt; previous size
</I>&gt;&gt;<i>   overwrite if otherwise
</I>&gt;&gt;<i>  Rodrigo: I still fails to see a reason to trigger a gc on this case
</I>&gt;&gt;<i> 12:21 AM me: hmm i guess im not too sure either
</I>&gt;&gt;<i> 12:22 AM but the thing is, even if im reusing the continuation
</I>&gt;&gt;<i>   the memory, (ms spent) is like this
</I>&gt;&gt;<i>   87314432, 161
</I>&gt;&gt;<i> 92131328, 128
</I>&gt;&gt;<i> 91377664, 315
</I>&gt;&gt;<i> 95244288, 88
</I>&gt;&gt;<i> 93085696, 330
</I>&gt;&gt;<i> 91824128, 319
</I>&gt;&gt;<i> 89403392, 292
</I>&gt;&gt;<i>   it keeps cycling
</I>&gt;&gt;<i> 12:23 AM sorry. it's more like this
</I>&gt;&gt;<i>   367210496, 410
</I>&gt;&gt;<i> 385441792, 418
</I>&gt;&gt;<i> 405204992, 346
</I>&gt;&gt;<i> 427053056, 363
</I>&gt;&gt;<i> 444809216, 333
</I>&gt;&gt;<i> 462483456, 339
</I>&gt;&gt;<i> 423661568, 1559
</I>&gt;&gt;<i> 441327616, 465
</I>&gt;&gt;<i> 458985472, 305
</I>&gt;&gt;<i> 403214336, 1338
</I>&gt;&gt;<i> 419254272, 506
</I>&gt;&gt;<i>  Rodrigo: and 400mb is like the working set of your app?
</I>&gt;&gt;<i> 12:24 AM me: at
</I>&gt;&gt;<i> 423661568, 1559, there's a huge lag spike
</I>&gt;&gt;<i>   lemme check
</I>&gt;&gt;<i>  Rodrigo: those spike can happen
</I>&gt;&gt;<i>  me: 530 ish on windows
</I>&gt;&gt;<i>   thing is, im not reallocating anything major each iteration
</I>&gt;&gt;<i>   *allocating
</I>&gt;&gt;<i> 12:25 AM i allocate 1 new continuation per step, and call store() on 200k
</I>&gt;&gt;<i> others
</I>&gt;&gt;<i>  Rodrigo: why are you calling store on those 200k other?
</I>&gt;&gt;<i>  me: yield/sleep
</I>&gt;&gt;<i> 12:26 AM Rodrigo: oh, ok
</I>&gt;&gt;<i>   well, you realize that the working set is largely related to the living
</I>&gt;&gt;<i> set of the objects on the many stacks
</I>&gt;&gt;<i>   and GC spikes are not really uncommon
</I>&gt;&gt;<i> 12:27 AM me: but i tested another scenario
</I>&gt;&gt;<i>   i also have a version of microthreads that doesnt use continuations
</I>&gt;&gt;<i>   that just runs() and waits for it to return
</I>&gt;&gt;<i>   and that one doesnt have any spikes on mono
</I>&gt;&gt;<i> 12:28 AM and memory on that one barely increases
</I>&gt;&gt;<i>  Rodrigo: do you mind emails the list with your code and CC Paolo Molaro
</I>&gt;&gt;<i>   he's the maintainer of tasklets
</I>&gt;&gt;<i>   I'm not familiar with the code
</I>&gt;&gt;<i>  me: yea sure. do u mind if i link this chat?
</I>&gt;&gt;<i>  Rodrigo: no problem
</I>&gt;&gt;<i>  me: k. thank you
</I>&gt;&gt;<i> 12:29 AM later
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090830/538eb403/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090830/538eb403/attachment-0001.html</A> 
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032872.html">[Mono-dev] Mono tasklet memory issues
</A></li>
	<LI>Next message: <A HREF="032874.html">[Mono-dev]  when will full-aot be supported on windows?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32873">[ date ]</a>
              <a href="thread.html#32873">[ thread ]</a>
              <a href="subject.html#32873">[ subject ]</a>
              <a href="author.html#32873">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
