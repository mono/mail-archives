<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Switching to position independent AOT code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Switching%20to%20position%20independent%20AOT%20code&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009656.html">
   <LINK REL="Next"  HREF="009659.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Switching to position independent AOT code</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Switching%20to%20position%20independent%20AOT%20code&In-Reply-To="
       TITLE="[Mono-devel-list] Switching to position independent AOT code">vargaz at gmail.com
       </A><BR>
    <I>Tue Jan  4 12:39:27 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009656.html">[Mono-devel-list] Latest version
</A></li>
        <LI>Next message: <A HREF="009659.html">[Mono-devel-list] patch for generic List
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9657">[ date ]</a>
              <a href="thread.html#9657">[ thread ]</a>
              <a href="subject.html#9657">[ subject ]</a>
              <a href="author.html#9657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                                     Hi,

   The amd64 and x86 ports will emit position independent code from now one when
using --aot. This means the runtime does not have to relocate the AOT code when
loading it, allowing multiple runtime processes to share the same code. This 
has some performance impact, but running mcs with all assemblies AOTed is still
faster than running it with the JIT.

The rest of this mail attempts to describe the changes neccesary to
convert a port
to use PIC AOT code.

1. Introduction

Generated native code needs to reference various runtime structures/functions
whose address is only known at run time. JITted code can simple embed the
address into the native code, but AOT code needs to do an indirection. This 
indirection is done through a table called the Global Offset Table (GOT), which
is similar to the GOT table in the Elf spec.  When the runtime saves
the AOT image,
it saves some information for each method describing the GOT table entries
used by that method. When loading a method from an AOT image, the runtime
will fill out the GOT entries needed by the method.

2. Computing the address of the GOT

Methods which need to access the GOT first need to compute its address. On
the x86 it is done by code like this:

call &lt;IP + 5&gt;
pop ebx
add &lt;OFFSET TO GOT&gt;, ebx
&lt;save got addr to a register&gt;

The variable representing the got is stored in cfg-&gt;got_var. It is
allways allocated
to a global register to prevent some problems with branches + basic blocks.

3. Referencing GOT entries

Any time the native code needs to access some other runtime structure/function
(i.e. any time the backend calls mono_add_patch_info ()), the code pointed by
the patch needs to load the value from the got. For example, instead of 
call &lt;ABSOLUTE ADDR&gt;
it needs to do:
call *&lt;OFFSET&gt;(&lt;GOT REG&gt;)
Here, the &lt;OFFSET&gt; can be 0, it will be fixed up by the AOT compiler.


For more examples on the changes required, see

svn diff -r 37739:38213 mini-x86.c 

                   Zoltan

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009656.html">[Mono-devel-list] Latest version
</A></li>
	<LI>Next message: <A HREF="009659.html">[Mono-devel-list] patch for generic List
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9657">[ date ]</a>
              <a href="thread.html#9657">[ thread ]</a>
              <a href="subject.html#9657">[ subject ]</a>
              <a href="author.html#9657">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
