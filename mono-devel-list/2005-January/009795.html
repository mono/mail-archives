<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] StringBuilder Speedup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20StringBuilder%20Speedup&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009824.html">
   <LINK REL="Next"  HREF="009796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] StringBuilder Speedup</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20StringBuilder%20Speedup&In-Reply-To="
       TITLE="[Mono-devel-list] [PATCH] StringBuilder Speedup">bmaurer at ximian.com
       </A><BR>
    <I>Sat Jan 15 23:19:25 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009824.html">[Mono-devel-list] The type mscorlib has two conflicting	definitons
</A></li>
        <LI>Next message: <A HREF="009796.html">[Mono-devel-list] Re: [PATCH] StringBuilder Speedup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9795">[ date ]</a>
              <a href="thread.html#9795">[ thread ]</a>
              <a href="subject.html#9795">[ subject ]</a>
              <a href="author.html#9795">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey guys,

Attached is a patch that speeds up StringBuilder in some common cases.
The goal of this patch is to avoid allocations of the string builder
buffer when possible. I do this in two ways:

1. Lazily allocate the buffer

When you create a new string builder, it will have an empty string, &quot;&quot;,
as the buffer. This avoids the first allocation

2. Make the first append not allocate a buffer

Rather than allocate a buffer by the time of the first append, this just
sets the cached string and the buffer equal to the string we get in.


Doing this prevents allocations in a few common cases:

Case 1:

{
	StringBuilder sb = new StringBuilder ();
}

Here, we saved allocating the buffer at all.

Case 2:

{
	StringBuilder sb = new StringBuilder ();
	sb.Append (&quot;foo&quot;);
	sb.ToString ();
}

Here, we avoided two allocations: the buffer in the string builder, and
the string that would have been created from ToString. We just return
the same string as was passed into append.


Case 3:

{
	StringBuilder sb = new StringBuilder ();
	sb.Append (&quot;0123456789&quot;);
	sb.Append (&quot;0123456789&quot;);
	sb.ToString ();
}

We saved one allocation here. The default size of a StringBuilder is 16.
However, in the second append, it knows that this will not be large
enough. So it is able to make its first buffer 32 chars.


Doing this patch will make the behavior as compared to MSFT a bit
different for some pendantic test cases (mostly in terms of the capacity
property). However, I think this is a reasonable difference between two
impls of the framework.

If nobody objects, I will check this in.

-- Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009824.html">[Mono-devel-list] The type mscorlib has two conflicting	definitons
</A></li>
	<LI>Next message: <A HREF="009796.html">[Mono-devel-list] Re: [PATCH] StringBuilder Speedup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9795">[ date ]</a>
              <a href="thread.html#9795">[ thread ]</a>
              <a href="subject.html#9795">[ subject ]</a>
              <a href="author.html#9795">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
