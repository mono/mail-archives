<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Embedding Mono in a Virtual World
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050126175800.85775.qmail%40web25007.mail.ukl.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010055.html">
   <LINK REL="Next"  HREF="010064.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Embedding Mono in a Virtual World</H1>
    <B>Jonathan Gilbert</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050126175800.85775.qmail%40web25007.mail.ukl.yahoo.com"
       TITLE="[Mono-devel-list] Embedding Mono in a Virtual World">2a5gjx302 at sneakemail.com
       </A><BR>
    <I>Wed Jan 26 13:28:31 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010055.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
        <LI>Next message: <A HREF="010064.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10057">[ date ]</a>
              <a href="thread.html#10057">[ thread ]</a>
              <a href="subject.html#10057">[ subject ]</a>
              <a href="author.html#10057">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 05:58 PM 26/01/2005 +0000, Jim Purbrick wrote:
&gt;<i> --- Jonathan Gilbert &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">2a5gjx302 at sneakemail.com</A>&gt; 
</I>&gt;&gt;<i> Just thought I'd chime in and point out that it
</I>&gt;&gt;<i> sounds like what Jim wants is simply pre-emptive 
</I>&gt;&gt;<i> multithreading, which the operating system will
</I>&gt;&gt;<i> already provide for mono's threads.
</I>&gt;<i>
</I>&gt;<i>But, we've established that I won't be able to use 1
</I>&gt;<i>thread per script as I'd need 1000s of mono threads.
</I>
How sensitive are the scripts to latency? You could use a thread pool with
a high maximum (e.g. 300 or 500 threads), and it probably wouldn't be more
than a few milliseconds for each new script to run, provided each script
only took that long to run. Also, another important factor is how the
scripts will behave. Using a large number of threads will work well in the
following scenarios:

1. The threads frequently perform I/O, which causes them to block. While
blocked, another thread can run. Or,
2. The threads' entire runtime will be short enough to fit into a single
clock cycle, so that imposed context switches are minimized.

If the script threads will meet neither of these requirements, you may be
better off using a single thread for executing scripts (or one thread per
processor). You can use something like a semaphore + queue to transfer
requests to the threads that run them. This actually isn't too much
different than using ThreadPool. I don't know if it would perform worse :-)

static Semaphore request_count = new Semaphore(0);
static Queue requests = Queue.Synchronized(new Queue());

static void script_runner_thread_proc()
{
  while (true)
  {
    // the following line will block if necessary to keep
    // the invariant that the semaphore's value &gt;= 0
    request_count.Decrement();
    Request request = (Request)requests.Dequeue();

    try
    {
      request.Run();
    }
    catch (Exception e)
    {
      request.Exception = e;
    }

    // notify anyone waiting for the result -- you may not need this part.
    lock (request.Sync)
      Monitor.Pulse(request.Sync);
  }
}

With this design, you can create as many script running threads as you want
(but preferably not many more than the number of processors in the system),
and whenever an event requires processing, you simply do:

requests.Enqueue(new Request(...));
request_count.Increment();

This could be done from some main thread managing the communication with
clients or the other aspects of the simulation.

By the way, another thing that popped into my mind when I was reading your
requirement that scripts be collectable is that you may want to
old-fashioned interpret the scripts the first few times, and only after it
has been established that it will be run periodically expend the overhead
of having the code JITted and calling it through a delegate instead of an
interface. (Delegate invocations are rumoured to be 30 to 50 times slower
than interface invocations.)

This could be slotted into the above scenario by making two subclasses of
'Request', one of which invokes the interpreter from its 'Run()' method,
and the other of which invokes the compiled delegate from its 'Run()'
method. If switching from one instance to another is too tricky, you could
alternately have a flag within Request, and an &quot;if (compiled)
the_delegate(); else interpret(this);&quot; in Run().

Only scripts with extensive looping would benefit from the JIT pass for a
single execution; while the JIT surely is fast, wiring up the result to a
delegate and then invoking the delegate would probably consume most of the
savings for a simple script. You could always hint the scripts, indicating
which ones should be JITted right off the bat...

Anyway, good luck with your virtual world project :-)

Jonathan Gilbert


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010055.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
	<LI>Next message: <A HREF="010064.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10057">[ date ]</a>
              <a href="thread.html#10057">[ thread ]</a>
              <a href="subject.html#10057">[ subject ]</a>
              <a href="author.html#10057">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
