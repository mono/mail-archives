<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] GC Profiling Interfaces
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20GC%20Profiling%20Interfaces&In-Reply-To=20050123111644.GA12180%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009967.html">
   <LINK REL="Next"  HREF="009972.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] GC Profiling Interfaces</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20GC%20Profiling%20Interfaces&In-Reply-To=20050123111644.GA12180%40debian.org"
       TITLE="[Mono-devel-list] [PATCH] GC Profiling Interfaces">bmaurer at ximian.com
       </A><BR>
    <I>Sun Jan 23 11:33:41 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009967.html">[Mono-devel-list] [PATCH] GC Profiling Interfaces
</A></li>
        <LI>Next message: <A HREF="009972.html">[Mono-devel-list] [PATCH] GC Profiling Interfaces
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9970">[ date ]</a>
              <a href="thread.html#9970">[ thread ]</a>
              <a href="subject.html#9970">[ subject ]</a>
              <a href="author.html#9970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 2005-01-23 at 12:16 +0100, Paolo Molaro wrote:
&gt;<i> There are several problems with the patch.
</I>&gt;<i> First, it's not 64 bit clean. You need to use at least size_t
</I>&gt;<i> for heap sizes, but maybe it's better to just use a 64 bit int
</I>&gt;<i> unconditionally.
</I>
Yes, I should. Fixing now.

&gt;<i> The interface is wrong, IMHO. First, mono_profiler_mark_set() is misnamed:
</I>&gt;<i> it should be mono_object_is_alive () and it should not be included in
</I>&gt;<i> the profiler interface.
</I>
I wanted to keep it in the profiler because it is only useful during the
profiler callback.

&gt;<i>  But even with these changes, I'm not sure we
</I>&gt;<i> can support that interface and the way you use it. Think for example a GC
</I>&gt;<i> that sets the mark bits in the least significant bits of the object header:
</I>&gt;<i> the function can be implemented, but you can't use the object directly.
</I>&gt;<i> I don't want to export assumptions on a GC implementation in a public
</I>&gt;<i> interface.
</I>
This interface is not designed to be useful for a different gc impl. It
doesn't handle moving objects *at all*.

A profiler for Mono 1.2 is unlikely to be useful for 2.0 (Or whenever we
get a moving gc). Even if the api were designed so that the profiler
were correct, the things one wants to look at in each impl are very
different.

I'd also like to get boehm specific stuff (eg, number of blocks
blacklisted). Maybe these functions need to be put somewhere else...

&gt;<i> As for knowing that an object died vs knowing which objects are alive, it's
</I>&gt;<i> a simple difference which you could do when post processing, too, if needed.
</I>&gt;<i> Either way, we may consider exporting such an ugly interface only if
</I>&gt;<i> the overhead with the heap walk is significant.
</I>
Maybe, considering dependency on the gc impl, we should consider this a
private contract with the gc profiler? 

&gt;<i> &gt; +/* Slow/general mark bit manipulation: */
</I>&gt;<i> &gt; +GC_API int GC_is_marked GC_PROTO((char * p));
</I>&gt;<i> &gt; +GC_API void GC_clear_mark_bit GC_PROTO((char * p));
</I>&gt;<i> &gt; +GC_API void GC_set_mark_bit GC_PROTO((char * p));
</I>&gt;<i> 
</I>&gt;<i> Why do you export GC_clear_mark_bit and GC_set_mark_bit even if they are not used.
</I>&gt;<i> The fact that they are in the gc_priv.h header should be a strong enough
</I>&gt;<i> hint that care should be applied when exporting them.
</I>
Ooops, that is some over zealous c+p.

&gt;<i> &gt; Index: mono/metadata/profiler.c
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- mono/metadata/profiler.c	(revision 39325)
</I>&gt;<i> &gt; +++ mono/metadata/profiler.c	(working copy)
</I>&gt;<i> &gt; @@ -12,6 +12,7 @@
</I>&gt;<i> &gt;  #ifdef HAVE_BACKTRACE_SYMBOLS
</I>&gt;<i> &gt;  #include &lt;execinfo.h&gt;
</I>&gt;<i> &gt;  #endif
</I>&gt;<i> &gt; +#include &lt;mono/os/gc_wrapper.h&gt;
</I>&gt;<i> 
</I>&gt;<i> It's not acceptable to depend on the guts of the GC in this file.
</I>&gt;<i> Don't use any Boehm GC specific call here, we need to provide an API,
</I>&gt;<i> not hack the code until it seems to work.
</I>
Ok, I'll abstract the code out to the gc code.

&gt;<i> Note that you can use mono_gc_get_total_memory() when you want and your code
</I>&gt;<i> won't depend on the GC implementation details.
</I>
Ok.

&gt;<i> This interface is wrong: it should provide GC events such as GC start
</I>&gt;<i> and GC end and it should include the generation number.
</I>&gt;<i> 
</I>&gt;<i> enum {
</I>&gt;<i> 	/* maybe also add suspend and resume events */
</I>&gt;<i> 	MONO_GC_EVENT_START,
</I>&gt;<i> 	MONO_GC_EVENT_RECLAIM,
</I>&gt;<i> 	MONO_GC_EVENT_END
</I>&gt;<i> };
</I>&gt;<i> 
</I>&gt;<i> typedef void (*MonoProfileGCFunc)         (MonoProfiler *prof, int event_type, int gen_num);
</I>&gt;<i> 
</I>&gt;<i> Of course for the current GC the generation number will be always 0, but
</I>&gt;<i> the interface will work with the new GC. Note also that the generation number
</I>&gt;<i> is not needed, since you can easily keep your counter when the MONO_GC_EVENT_START
</I>&gt;<i> event is received.
</I>
So MONO_GC_EVENT_RECLAIM would be like the one that allows me to see the
mark bits?

-- Ben


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009967.html">[Mono-devel-list] [PATCH] GC Profiling Interfaces
</A></li>
	<LI>Next message: <A HREF="009972.html">[Mono-devel-list] [PATCH] GC Profiling Interfaces
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9970">[ date ]</a>
              <a href="thread.html#9970">[ thread ]</a>
              <a href="subject.html#9970">[ subject ]</a>
              <a href="author.html#9970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
