<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Inline assembly in C#
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Inline%20assembly%20in%20C%23&In-Reply-To=%3C7574a283-2b9d-a4bf-a61f-e443a5a774da%40illusorystudios.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044387.html">
   <LINK REL="Next"  HREF="044389.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Inline assembly in C#</H1>
    <B>James Bellinger</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Inline%20assembly%20in%20C%23&In-Reply-To=%3C7574a283-2b9d-a4bf-a61f-e443a5a774da%40illusorystudios.com%3E"
       TITLE="[Mono-dev] Inline assembly in C#">james at illusorystudios.com
       </A><BR>
    <I>Fri Jun  2 22:07:54 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044387.html">[Mono-dev] Inline assembly in C#
</A></li>
        <LI>Next message (by thread): <A HREF="044389.html">[Mono-dev] Inline assembly in C#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44388">[ date ]</a>
              <a href="thread.html#44388">[ thread ]</a>
              <a href="subject.html#44388">[ subject ]</a>
              <a href="author.html#44388">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please make it so all platforms can be embedded in the same assembly. 
Separate compilation is a mess. And it's not as simple as 'x86-64' vs 
'ppc'. Different CPUs have different instructions.

I can figure out which to call on my own. If I know it's x86-64, beyond 
that, one can do tests and build a library to test for additional CPU 
features.

A method that just takes pointers, even, would be completely usable for 
any game.  Incidentally, if they could all be embedded in this manner, 
it'd make SIMD much more powerful and frankly, even be useful outside of 
Mono, on Windows.

James


On 6/2/2017 5:49 PM, Jon Purdy via Mono-devel-list wrote:
&gt;<i> Would this be AOT-only? And should a method be allowed to contain a mix of
</I>&gt;<i> inline assembly and managed code? These greatly affect whatever design we
</I>&gt;<i> might come up with.
</I>&gt;<i>
</I>&gt;<i> If assembly can appear anywhere in a managed method, you need something
</I>&gt;<i> like the GCC extended asm notation so you can specify inputs, outputs, and
</I>&gt;<i> clobbers to determine things like addressing modes and register allocation
</I>&gt;<i> for the surrounding code. It¹s also useful to have ³volatile² (don¹t move
</I>&gt;<i> this) and ³goto² (may jump to managed label), but these are maybe less
</I>&gt;<i> critical.
</I>&gt;<i>
</I>&gt;<i> I would be in favor of the simpler alternative of restricting inline
</I>&gt;<i> assembly to a whole method:
</I>&gt;<i>
</I>&gt;<i>      public unsafe __asm__(x86_64) int ReturnOne ()  {
</I>&gt;<i>          &quot;movl $1, %rax&quot;
</I>&gt;<i>      }
</I>&gt;<i>
</I>&gt;<i>      public unsafe __asm__(ppc) int ReturnOne () {
</I>&gt;<i>          &quot;li r3, 1&quot;
</I>&gt;<i>      }
</I>&gt;<i>
</I>&gt;<i>      public __asm__ int ReturnOne () {
</I>&gt;<i>          return 1;
</I>&gt;<i>      }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The idea is that when you compile (AOT) or load+compile (JIT) this
</I>&gt;<i> assembly on x86-64, the __asm__(x86_64) method is selected and the
</I>&gt;<i> __asm__(ppc) method is ignored entirely; if you¹re compiling on neither
</I>&gt;<i> x86-64 nor PowerPC, the managed fallback is chosen. I suppose the fallback
</I>&gt;<i> could also be written in IL:
</I>&gt;<i>
</I>&gt;<i>      public unsafe __asm__(cil) int ReturnOne () {
</I>&gt;<i>          &quot;ldc.i4 1&quot;
</I>&gt;<i>          &quot;ret&quot;
</I>&gt;<i>      }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> However, this comes at the cost of some expressiveness and inhibits
</I>&gt;<i> optimisations.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 6/1/17, 6:59 AM, &quot;Mono-devel-list on behalf of Miguel de Icaza via
</I>&gt;<i> Mono-devel-list&quot; &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.dot.net</A> on behalf of
</I>&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">mono-devel-list at lists.dot.net</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These are good observations.    If we ever do this (I am not saying we
</I>&gt;&gt;<i> are, I just wanted to get this off my head), we would indeed require
</I>&gt;&gt;<i> assemblies for 32/64 on the same system.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any work that we did to support inline assembly would need some extra
</I>&gt;&gt;<i> work on the runtime, so adding support for mixed-mode execution would
</I>&gt;&gt;<i> fall into the sort of work we would need to do.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyways, this is a very good catch, and it means that the original design
</I>&gt;&gt;<i> was probably best.   And it is still an independent issue from having an
</I>&gt;&gt;<i> inline assembler in place.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Miguel.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 5/30/17, 1:58 PM, &quot;Vincent Povirk&quot; &lt;<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">madewokherd at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &gt; Now that Mono is switching to platform-specific assemblies for the
</I>&gt;&gt;<i> core
</I>&gt;&gt;<i>     &gt; assemblies as opposed to cross-platform assemblies that work across
</I>&gt;&gt;<i> Windows,
</I>&gt;&gt;<i>     &gt; Mac and Linux (a price we pay to converge with CoreFX) it made me
</I>&gt;&gt;<i> wonder if
</I>&gt;&gt;<i>     &gt; we could not reuse instead the existing support for mixed-mode
</I>&gt;&gt;<i> assemblies in
</I>&gt;&gt;<i>     &gt; the CLR.
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i>     What you're suggesting are architecture-specific assemblies, not
</I>&gt;&gt;<i>     platform-specific. So you would be multiplying the platform variations
</I>&gt;&gt;<i>     by the set of architecture variations.
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i>     This would be a problem for Wine Mono's use case. Currently we can use
</I>&gt;&gt;<i>     one set of class libraries with 32-bit and 64-bit Mono dll's. We would
</I>&gt;&gt;<i>     need a mechanism to load some different class libraries based on
</I>&gt;&gt;<i>     architecture.
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i>     &gt; Essentially, instead of having inline assembly in the body of a
</I>&gt;&gt;<i> method, we
</I>&gt;&gt;<i>     &gt; could define entire method as inline assembly, and set the method
</I>&gt;&gt;<i>     &gt; implementation flags in the ECMA metadata to be native and point to
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i>     &gt; code.   It is not as flexible, but would eliminate the need for a
</I>&gt;&gt;<i>     &gt; post-processor, and would merely require the C# compiler to perform
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i>     &gt; assembly code generation and injection.
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i>     You would also have to extend the Mono runtime to support mixed-mode
</I>&gt;&gt;<i>     assemblies on non-Windows platforms.
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A>
</I>&gt;&gt;<i> <A HREF="https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.">https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.</A>
</I>&gt;&gt;<i> net%2Fmailman%2Flistinfo%2Fmono-devel-list&amp;data=02%7C01%7Cjopur%40microsof
</I>&gt;&gt;<i> t.com%7C8ded07862a7b48c9590608d4a8f667e9%7C72f988bf86f141af91ab2d7cd011db4
</I>&gt;&gt;<i> 7%7C1%7C0%7C636319223645828454&amp;sdata=4JueGESfWp8sLKAYXKibnUTZQNu1NBcsPwmpB
</I>&gt;&gt;<i> lWtaTg%3D&amp;reserved=0
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A>
</I>&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">http://lists.dot.net/mailman/listinfo/mono-devel-list</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044387.html">[Mono-dev] Inline assembly in C#
</A></li>
	<LI>Next message (by thread): <A HREF="044389.html">[Mono-dev] Inline assembly in C#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44388">[ date ]</a>
              <a href="thread.html#44388">[ thread ]</a>
              <a href="subject.html#44388">[ subject ]</a>
              <a href="author.html#44388">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
