<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] FastCGI Performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20FastCGI%20Performance&In-Reply-To=%3C1397071202.28280.38.camel%40sergey%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041407.html">
   <LINK REL="Next"  HREF="041377.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] FastCGI Performance</H1>
    <B>Sergey Zhukov</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20FastCGI%20Performance&In-Reply-To=%3C1397071202.28280.38.camel%40sergey%3E"
       TITLE="[Mono-dev] FastCGI Performance">svg at ngs.ru
       </A><BR>
    <I>Wed Apr  9 19:20:02 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041407.html">[Mono-dev] FastCGI Performance
</A></li>
        <LI>Next message: <A HREF="041377.html">[Mono-dev] Ongoing Mono development / Mono roadmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41376">[ date ]</a>
              <a href="thread.html#41376">[ thread ]</a>
              <a href="subject.html#41376">[ subject ]</a>
              <a href="author.html#41376">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Marcello,

I'll try to find a way to remove ASP.NET dependency, in this case you'll
be able to reuse communication part of the HyperFastCgi and provide an
additional way to write FastCgi http servers. 

On Tue, 2014-04-08 at 18:01 -0300, Marcelo Zabani wrote:
&gt;<i> xplicit, perhaps we could concentrate the effort of the FastCgi parts
</I>&gt;<i> in HyperFastCgi in a separate library? I think both our projects and
</I>&gt;<i> the community could benefit from this. I'm not sure how developed the
</I>&gt;<i> FastCgi parts in HyperFastCgi are, but perhaps we could merge the good
</I>&gt;<i> of both into FastCgiNet? (<A HREF="http://github.com/mzabani/FastCgiNet">http://github.com/mzabani/FastCgiNet</A>).
</I>&gt;<i> At this point FastCgiNet is reasonably well documented (its code as
</I>&gt;<i> well) - the best docs I've seen in any FastCgi library for .NET - so
</I>&gt;<i> it shouldn't be *too* hard for other people to help.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Tue, Apr 8, 2014 at 4:33 PM, &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">etienne.champetier at free.fr</A>&gt; wrote:
</I>&gt;<i>         Hi
</I>&gt;<i>         
</I>&gt;<i>         This thread is named &quot;FastCGI performance&quot;, but much more
</I>&gt;<i>         important than
</I>&gt;<i>         performance is stablility, ie don't explode (10Gb memory
</I>&gt;<i>         usage :)).
</I>&gt;<i>         
</I>&gt;<i>         I want to thanks Sergey for his HyperFastCGI, because it seems
</I>&gt;<i>         to handle
</I>&gt;<i>         load just fine (ab -c200)(response time goes up, thread number
</I>&gt;<i>         stay at ~35,
</I>&gt;<i>         and memory is between 90Mb and 200Mb)
</I>&gt;<i>         
</I>&gt;<i>         ----- Mail original -----
</I>&gt;<i>         &gt; De: &quot;Sergey Zhukov&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">svg at ngs.ru</A>&gt;
</I>&gt;<i>         &gt; &#192;: &quot;Giuliano Barberi&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gbarberi at aotaonline.com</A>&gt;
</I>&gt;<i>         &gt; Cc: &quot;Mono Developer List&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i>         &gt; Envoy&#233;: Mardi 8 Avril 2014 20:50:23
</I>&gt;<i>         &gt; Objet: Re: [Mono-dev] FastCGI Performance
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; To be more exact I did not write some special code for
</I>&gt;<i>         connection
</I>&gt;<i>         &gt; pooling, but I did thread pooling for MonoWorkerRequest and
</I>&gt;<i>         tried to
</I>&gt;<i>         &gt; pool CGI records, which are used for communication between
</I>&gt;<i>         nginx and
</I>&gt;<i>         &gt; FastCgi server. The last one did not show any increasing in
</I>&gt;<i>         &gt; performance
</I>&gt;<i>         &gt; for me, and I did not merge the code to master branch. The
</I>&gt;<i>         second one
</I>&gt;<i>         &gt; can be enabled or disabled with /usethreadpool=yes|no
</I>&gt;<i>         option.
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; About connection pooling: KeepAlive mode reuses opened
</I>&gt;<i>         connections
</I>&gt;<i>         &gt; very
</I>&gt;<i>         &gt; good, so for 100000 tests requests I get only 50-60
</I>&gt;<i>         instances of
</I>&gt;<i>         &gt; NetworkConnector are created. You can check it by adding the
</I>&gt;<i>         line
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;             if (cn % 10 == 0)
</I>&gt;<i>         &gt;                 Logger.Write (LogLevel.All, &quot;cn={0}&quot;, cn);
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; to the end of NetworkConnector constructor. If you see that
</I>&gt;<i>         cn is
</I>&gt;<i>         &gt; growing, that something wrong with configuration and this
</I>&gt;<i>         produces
</I>&gt;<i>         &gt; huge
</I>&gt;<i>         &gt; drop of performance.
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; Also, I'll look into benchmarks you point out and will see,
</I>&gt;<i>         what can
</I>&gt;<i>         &gt; be
</I>&gt;<i>         &gt; done more to increase performance.
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; On Tue, 2014-04-08 at 13:19 -0400, Giuliano Barberi wrote:
</I>&gt;<i>         &gt; &gt; I'm gonna close this issue. I mainly opened it to ask
</I>&gt;<i>         about whether
</I>&gt;<i>         &gt; &gt; that would help a lot but I can see from you said it won't
</I>&gt;<i>         since
</I>&gt;<i>         &gt; &gt; you're already pooling. The evhttp-sharp implementation
</I>&gt;<i>         does use
</I>&gt;<i>         &gt; &gt; native calls though it uses evhttp from libevent but the
</I>&gt;<i>         author
</I>&gt;<i>         &gt; &gt; says
</I>&gt;<i>         &gt; &gt; the main bottleneck at this point is that its single
</I>&gt;<i>         threaded in
</I>&gt;<i>         &gt; &gt; case
</I>&gt;<i>         &gt; &gt; you want something to compare against.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt; Regards
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt; On Tue, Apr 8, 2014 at 12:03 PM, xplicit &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">svg at ngs.ru</A>&gt;
</I>&gt;<i>         wrote:
</I>&gt;<i>         &gt; &gt;         From my point of view the bollteneck currently is
</I>&gt;<i>         not in
</I>&gt;<i>         &gt; &gt;         the
</I>&gt;<i>         &gt; &gt;         socket library,
</I>&gt;<i>         &gt; &gt;         but in the System.Web implementation. For example,
</I>&gt;<i>         when I
</I>&gt;<i>         &gt; &gt;         did
</I>&gt;<i>         &gt; &gt;         benchmarks for
</I>&gt;<i>         &gt; &gt;         HyperFastCgi server, I've got such results:
</I>&gt;<i>         &gt; &gt;         Get static file from nginx - 10K rps
</I>&gt;<i>         &gt; &gt;         Get hardcoded html-response from HyperFastCgi
</I>&gt;<i>         server
</I>&gt;<i>         &gt; &gt;         (without
</I>&gt;<i>         &gt; &gt;         passing http
</I>&gt;<i>         &gt; &gt;         request to mono web.server) - ~5K rps.
</I>&gt;<i>         &gt; &gt;         Yes, it's double-time drop in performance, but I
</I>&gt;<i>         think
</I>&gt;<i>         &gt; &gt;         that's
</I>&gt;<i>         &gt; &gt;         mostly because
</I>&gt;<i>         &gt; &gt;         static file is cached inside nginx, while using
</I>&gt;<i>         fastcgi
</I>&gt;<i>         &gt; &gt;         requires additional
</I>&gt;<i>         &gt; &gt;         layer of communication throught sockets.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         Then when I added mono web server to the
</I>&gt;<i>         nginx-fastcgi
</I>&gt;<i>         &gt; &gt;         chain
</I>&gt;<i>         &gt; &gt;         performance
</I>&gt;<i>         &gt; &gt;         dropped to 1.5-2K rps depending on the requests
</I>&gt;<i>         were
</I>&gt;<i>         &gt; &gt;         served.
</I>&gt;<i>         &gt; &gt;         I'm pretty
</I>&gt;<i>         &gt; &gt;         sure, if you remove all sockets references from
</I>&gt;<i>         web server
</I>&gt;<i>         &gt; &gt;         and
</I>&gt;<i>         &gt; &gt;         will emulate
</I>&gt;<i>         &gt; &gt;         HTTP requests directly to System.Web you won't get
</I>&gt;<i>         &gt; &gt;         incredible
</I>&gt;<i>         &gt; &gt;         improvement of
</I>&gt;<i>         &gt; &gt;         performance, it will still be slow. However, I
</I>&gt;<i>         might be
</I>&gt;<i>         &gt; &gt;         wrong,
</I>&gt;<i>         &gt; &gt;         all
</I>&gt;<i>         &gt; &gt;         performance assumptions must be measured, because
</I>&gt;<i>         sometimes
</I>&gt;<i>         &gt; &gt;         you'll get
</I>&gt;<i>         &gt; &gt;         results is not what you expect.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         But what I saw:
</I>&gt;<i>         &gt; &gt;         System.Web uses very slow implementation of
</I>&gt;<i>         &gt; &gt;         System.Configuration. For every
</I>&gt;<i>         &gt; &gt;         request path not in cache it tries to find
</I>&gt;<i>         web.config and
</I>&gt;<i>         &gt; &gt;         read
</I>&gt;<i>         &gt; &gt;         some basic
</I>&gt;<i>         &gt; &gt;         stuff (globalization, authentication, etc).
</I>&gt;<i>          Simple making
</I>&gt;<i>         &gt; &gt;         globalization
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &lt;<A HREF="https://github.com/xplicit/mono/commit/081596b827cfcd8f8eed212c58f8869d600ac3e6">https://github.com/xplicit/mono/commit/081596b827cfcd8f8eed212c58f8869d600ac3e6</A>&gt;
</I>&gt;<i>         &gt; &gt;         to be read only once now gives me 20-30%
</I>&gt;<i>         performance boost.
</I>&gt;<i>         &gt; &gt;         (NB: I don't
</I>&gt;<i>         &gt; &gt;         know what's changed with mono or my system, but
</I>&gt;<i>         when I did
</I>&gt;<i>         &gt; &gt;         this several
</I>&gt;<i>         &gt; &gt;         month ago, it was only about 5% addition in
</I>&gt;<i>         performance).
</I>&gt;<i>         &gt; &gt;         That's why
</I>&gt;<i>         &gt; &gt;         HttpListener will be faster it does not need to
</I>&gt;<i>         handle all
</I>&gt;<i>         &gt; &gt;         of
</I>&gt;<i>         &gt; &gt;         these
</I>&gt;<i>         &gt; &gt;         settings.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         Some terrible using of sessions cache in
</I>&gt;<i>         System.Web. I
</I>&gt;<i>         &gt; &gt;         wrote a
</I>&gt;<i>         &gt; &gt;         little about
</I>&gt;<i>         &gt; &gt;         issues with caching here
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         <A HREF="http://forcedtoadmin.blogspot.ru/2013/12/unexpected-unloading-of-mono-web.html">http://forcedtoadmin.blogspot.ru/2013/12/unexpected-unloading-of-mono-web.html</A>
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &lt;<A HREF="http://forcedtoadmin.blogspot.ru/2013/12/unexpected-unloading-of-mono-web.html">http://forcedtoadmin.blogspot.ru/2013/12/unexpected-unloading-of-mono-web.html</A>&gt;
</I>&gt;<i>         &gt; &gt;         . When mono web tries to reload itself and
</I>&gt;<i>         recompile
</I>&gt;<i>         &gt; &gt;         ASP.NET
</I>&gt;<i>         &gt; &gt;         the pages it
</I>&gt;<i>         &gt; &gt;         again drops the performance.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         Some performance issues due to no-caching http
</I>&gt;<i>         handlers.
</I>&gt;<i>         &gt; &gt;         Using of slow hashcodes for headers dictionary
</I>&gt;<i>         after
</I>&gt;<i>         &gt; &gt;         security
</I>&gt;<i>         &gt; &gt;         patch.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         And so on. Every thing of these produce a little
</I>&gt;<i>         drop which
</I>&gt;<i>         &gt; &gt;         become an
</I>&gt;<i>         &gt; &gt;         avalanche and wash away good performance from the
</I>&gt;<i>         web.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         Finally. To be sure, what is most slow part, it
</I>&gt;<i>         should be
</I>&gt;<i>         &gt; &gt;         created few
</I>&gt;<i>         &gt; &gt;         benchmarks.
</I>&gt;<i>         &gt; &gt;         1. Sockets benchmarks. Pure multi-threaded
</I>&gt;<i>         application,
</I>&gt;<i>         &gt; &gt;         which
</I>&gt;<i>         &gt; &gt;         returns some
</I>&gt;<i>         &gt; &gt;         test data. One application must be written on c#,
</I>&gt;<i>         other
</I>&gt;<i>         &gt; &gt;         must
</I>&gt;<i>         &gt; &gt;         be native.
</I>&gt;<i>         &gt; &gt;         Difference in measurement will show is C# socket
</I>&gt;<i>         &gt; &gt;         implementation slow or not.
</I>&gt;<i>         &gt; &gt;         2. System.Web benchmarks. Create two apps: one is
</I>&gt;<i>         a
</I>&gt;<i>         &gt; &gt;         simulator
</I>&gt;<i>         &gt; &gt;         of web
</I>&gt;<i>         &gt; &gt;         requests to System.Web, other - pure application,
</I>&gt;<i>         which
</I>&gt;<i>         &gt; &gt;         also
</I>&gt;<i>         &gt; &gt;         simulates
</I>&gt;<i>         &gt; &gt;         requests to some pretty simple HTTP responder.
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;         --
</I>&gt;<i>         &gt; &gt;         View this message in context:
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         <A HREF="http://mono.1490590.n4.nabble.com/FastCGI-Performance-tp4662454p4662480.html">http://mono.1490590.n4.nabble.com/FastCGI-Performance-tp4662454p4662480.html</A>
</I>&gt;<i>         &gt; &gt;         Sent from the Mono - Dev mailing list archive at
</I>&gt;<i>         &gt; &gt;         Nabble.com.
</I>&gt;<i>         &gt; &gt;         _______________________________________________
</I>&gt;<i>         &gt; &gt;         Mono-devel-list mailing list
</I>&gt;<i>         &gt; &gt;         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt;
</I>&gt;<i>         &gt; &gt; --
</I>&gt;<i>         &gt; &gt; Giuliano Barberi
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt;
</I>&gt;<i>         &gt; _______________________________________________
</I>&gt;<i>         &gt; Mono-devel-list mailing list
</I>&gt;<i>         &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>         &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>         &gt;
</I>&gt;<i>         _______________________________________________
</I>&gt;<i>         Mono-devel-list mailing list
</I>&gt;<i>         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>         <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>         
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041407.html">[Mono-dev] FastCGI Performance
</A></li>
	<LI>Next message: <A HREF="041377.html">[Mono-dev] Ongoing Mono development / Mono roadmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41376">[ date ]</a>
              <a href="thread.html#41376">[ thread ]</a>
              <a href="subject.html#41376">[ subject ]</a>
              <a href="author.html#41376">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
