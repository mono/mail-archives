<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Double/redundant release of COM object while marshaling from IUnknown (with patch)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Double/redundant%20release%20of%20COM%20object%20while%20marshaling%0A%20from%20IUnknown%20%28with%20patch%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037481.html">
   <LINK REL="Next"  HREF="037485.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Double/redundant release of COM object while marshaling from IUnknown (with patch)</H1>
    <B>Ivo Smits</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Double/redundant%20release%20of%20COM%20object%20while%20marshaling%0A%20from%20IUnknown%20%28with%20patch%29&In-Reply-To="
       TITLE="[Mono-dev] Double/redundant release of COM object while marshaling from IUnknown (with patch)">Ivo at UFO-Net.nl
       </A><BR>
    <I>Tue Apr 26 16:04:39 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037481.html">[Mono-dev] Mono 2.10.2
</A></li>
        <LI>Next message: <A HREF="037485.html">[Mono-dev] Status of COM interop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37484">[ date ]</a>
              <a href="thread.html#37484">[ thread ]</a>
              <a href="subject.html#37484">[ subject ]</a>
              <a href="author.html#37484">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>While working on an interface between VirtualBox and C# on Linux, I ran 
into a problem, which I think may be a bug in the mono code.

The System.Runtime.InteropServices.Marshal.GetObjectForIUnknown function 
releases (using Marshal.Release) the given COM pointer. Microsoft's 
documentation does not speak about such behaviour. The reference count 
should instead be incremented and only get decremented when the proxy is 
garbage collected. The result is that for consecutive calls to 
GetObjectForIUnknown on the same pointer, the second call fails, as the 
COM object has been released (and may have been destructed!) by the 
first call. Also, when Marshaling an output/return parameter of a COM 
interop function, the COM pointer is released in the interop code as 
well - after calling GetObjectForIUnknown. This results in a 
double/redundant Release of the COM object, which leads to crashes.

I am not sure about the correct behaviour, and how well the current code 
has been tested. I've patched mono (from git) to work with my code, the 
diff is listed below. I have removed both calls to Marshal.Release in 
the GetObjectForIUnknown function. I am not sure about the purpose of 
the interlocked increment; Marshal.AddRef should be used for COM 
reference counting.

--
Ivo



diff --git a/mcs/class/corlib/Mono.Interop/ComInteropProxy.cs 
b/mcs/class/corlib/Mono.Interop/ComInteropProxy.cs
index 54fefe2..1271257 100644
--- a/mcs/class/corlib/Mono.Interop/ComInteropProxy.cs
+++ b/mcs/class/corlib/Mono.Interop/ComInteropProxy.cs
@@ -93,12 +93,9 @@ namespace Mono.Interop
                         Marshal.ThrowExceptionForHR (hr);
                         ComInteropProxy obj = FindProxy (ppv);
                         if (obj == null) {
-                               Marshal.Release (pItf);
                                 return new ComInteropProxy (ppv);
                         }
                         else {
-                               Marshal.Release (pItf);
-                               System.Threading.Interlocked.Increment 
(ref obj.ref_count);
                                 return obj;
                         }
                 }
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037481.html">[Mono-dev] Mono 2.10.2
</A></li>
	<LI>Next message: <A HREF="037485.html">[Mono-dev] Status of COM interop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37484">[ date ]</a>
              <a href="thread.html#37484">[ thread ]</a>
              <a href="subject.html#37484">[ subject ]</a>
              <a href="author.html#37484">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
