<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Mono-patches] [mono/moon] caef081d: Implemented an iconv-like API for unicode conversion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20%5Bmono/moon%5D%20caef081d%3A%20Implemented%20an%0A%20iconv-like%20API%20for%20unicode%20conversion&In-Reply-To=BANLkTimQG0dqkk0LJ_k6YhoPUeCmw1JrhQ%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037447.html">
   <LINK REL="Next"  HREF="037449.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Mono-patches] [mono/moon] caef081d: Implemented an iconv-like API for unicode conversion</H1>
    <B>Jeffrey Stedfast</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20%5Bmono/moon%5D%20caef081d%3A%20Implemented%20an%0A%20iconv-like%20API%20for%20unicode%20conversion&In-Reply-To=BANLkTimQG0dqkk0LJ_k6YhoPUeCmw1JrhQ%40mail.gmail.com"
       TITLE="[Mono-dev] [Mono-patches] [mono/moon] caef081d: Implemented an iconv-like API for unicode conversion">fejj at novell.com
       </A><BR>
    <I>Wed Apr 20 07:07:21 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037447.html">[Mono-dev] [Mono-patches] [mono/moon] caef081d: Implemented an iconv-like API for unicode conversion
</A></li>
        <LI>Next message: <A HREF="037449.html">[Mono-dev] Mono.Data.SybaseClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37448">[ date ]</a>
              <a href="thread.html#37448">[ thread ]</a>
              <a href="subject.html#37448">[ subject ]</a>
              <a href="author.html#37448">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/20/2011 12:00 AM, Rodrigo Kumpera wrote:
&gt;<i>
</I>&gt;<i> Jeff, shouldn't this be part of eglib as a build time option?
</I>&gt;<i>
</I>
I suppose it could be, but I think the plan right now is to simply 
remove g_iconv() from eglib since eglib is supposed to remain a 
minimalist version of glib as per discussion with Miguel.

It's also probably not very useful for most people who want to use 
g_iconv() to *just* have UTF-16/32BE/LE to UTF-8 conversion.

Jeff


&gt;<i> On Apr 19, 2011 10:06 PM, &quot;Jeffrey Stedfast (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">fejj at gnome.org</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">fejj at gnome.org</A>&gt;)&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A>&gt;&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Branch: refs/heads/master
</I>&gt;<i> &gt; Home: <A HREF="https://github.com/mono/moon">https://github.com/mono/moon</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Commit: caef081dc43c17327c37932f65264deec19d8022
</I>&gt;<i> &gt; Author: Jeffrey Stedfast &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">fejj at gnome.org</A> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">fejj at gnome.org</A>&gt;&gt;
</I>&gt;<i> &gt; Date: 04/19/2011 21:05:59
</I>&gt;<i> &gt; URL: 
</I>&gt;<i> <A HREF="https://github.com/mono/moon/commit/caef081dc43c17327c37932f65264deec19d8022">https://github.com/mono/moon/commit/caef081dc43c17327c37932f65264deec19d8022</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Implemented an iconv-like API for unicode conversion
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Changed paths:
</I>&gt;<i> &gt; M src/Makefile.am
</I>&gt;<i> &gt; Added paths:
</I>&gt;<i> &gt; A src/miconv.cpp
</I>&gt;<i> &gt; A src/miconv.h
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Modified: src/Makefile.am
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- a/src/Makefile.am
</I>&gt;<i> &gt; +++ b/src/Makefile.am
</I>&gt;<i> &gt; @@ -78,6 +78,7 @@ libmoon_include_headers = \
</I>&gt;<i> &gt; medialog.h \
</I>&gt;<i> &gt; mediaplayer.h \
</I>&gt;<i> &gt; messaging.h \
</I>&gt;<i> &gt; + miconv.h \
</I>&gt;<i> &gt; moon-curves.h \
</I>&gt;<i> &gt; moonlightconfiguration.h\
</I>&gt;<i> &gt; moon-path.h \
</I>&gt;<i> &gt; @@ -234,6 +235,7 @@ dist_libmoon_la_SOURCES = \
</I>&gt;<i> &gt; medialog.cpp \
</I>&gt;<i> &gt; mediaplayer.cpp \
</I>&gt;<i> &gt; messaging.cpp \
</I>&gt;<i> &gt; + miconv.cpp \
</I>&gt;<i> &gt; moon-curves.c \
</I>&gt;<i> &gt; moonlightconfiguration.cpp \
</I>&gt;<i> &gt; moon-path.c \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Added: src/miconv.cpp
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- /dev/null
</I>&gt;<i> &gt; +++ b/src/miconv.cpp
</I>&gt;<i> &gt; @@ -0,0 +1,344 @@
</I>&gt;<i> &gt; +/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: t; 
</I>&gt;<i> c-basic-offset: 8 -*- */
</I>&gt;<i> &gt; +/*
</I>&gt;<i> &gt; + * miconv.cpp:
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * Contact:
</I>&gt;<i> &gt; + * Moonlight List (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">moonlight-list at lists.ximian.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">moonlight-list at lists.ximian.com</A>&gt;)
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * Copyright 2011 Novell, Inc. (<A HREF="http://www.novell.com">http://www.novell.com</A>)
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * See the LICENSE file included with the distribution for details.
</I>&gt;<i> &gt; + */
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#include &lt;config.h&gt;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#include &lt;glib.h&gt;
</I>&gt;<i> &gt; +#include &lt;string.h&gt;
</I>&gt;<i> &gt; +#include &lt;errno.h&gt;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#include &quot;miconv.h&quot;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +namespace Moonlight {
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +enum Endian {
</I>&gt;<i> &gt; + LittleEndian,
</I>&gt;<i> &gt; + BigEndian
</I>&gt;<i> &gt; +};
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +typedef int (* Decoder) (Endian endian, char **inbytes, size_t 
</I>&gt;<i> *inbytesleft, gunichar *outchar);
</I>&gt;<i> &gt; +typedef int (* Encoder) (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int decode_utf32 (Endian endian, char **inbytes, size_t 
</I>&gt;<i> *inbytesleft, gunichar *outchar);
</I>&gt;<i> &gt; +//static int encode_utf32 (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int decode_utf16 (Endian endian, char **inbytes, size_t 
</I>&gt;<i> *inbytesleft, gunichar *outchar);
</I>&gt;<i> &gt; +//static int encode_utf16 (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int decode_utf8 (Endian endian, char **inbytes, size_t 
</I>&gt;<i> *inbytesleft, gunichar *outchar);
</I>&gt;<i> &gt; +static int encode_utf8 (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static struct {
</I>&gt;<i> &gt; + const char *name;
</I>&gt;<i> &gt; + Decoder decoder;
</I>&gt;<i> &gt; + Encoder encoder;
</I>&gt;<i> &gt; + Endian endian;
</I>&gt;<i> &gt; +} charsets[] = {
</I>&gt;<i> &gt; + { &quot;UTF-32BE&quot;, decode_utf32, NULL, BigEndian },
</I>&gt;<i> &gt; + { &quot;UTF-32LE&quot;, decode_utf32, NULL, LittleEndian },
</I>&gt;<i> &gt; + { &quot;UTF-16BE&quot;, decode_utf16, NULL, BigEndian },
</I>&gt;<i> &gt; + { &quot;UTF-16LE&quot;, decode_utf16, NULL, LittleEndian },
</I>&gt;<i> &gt; + { &quot;UTF-8&quot;, decode_utf8, encode_utf8, LittleEndian },
</I>&gt;<i> &gt; +};
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +struct _miconv_t {
</I>&gt;<i> &gt; + Decoder decode;
</I>&gt;<i> &gt; + Encoder encode;
</I>&gt;<i> &gt; + Endian endian;
</I>&gt;<i> &gt; + gunichar c;
</I>&gt;<i> &gt; +};
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +miconv_t
</I>&gt;<i> &gt; +miconv_open (const char *to, const char *from)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + Decoder decoder = NULL;
</I>&gt;<i> &gt; + Encoder encoder = NULL;
</I>&gt;<i> &gt; + Endian endian;
</I>&gt;<i> &gt; + miconv_t cd;
</I>&gt;<i> &gt; + guint i;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (!to || !from)
</I>&gt;<i> &gt; + return (miconv_t) -1;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + for (i = 0; i &lt; G_N_ELEMENTS (charsets); i++) {
</I>&gt;<i> &gt; + if (!strcmp (charsets[i].name, from)) {
</I>&gt;<i> &gt; + decoder = charsets[i].decoder;
</I>&gt;<i> &gt; + endian = charsets[i].endian;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (!strcmp (charsets[i].name, to))
</I>&gt;<i> &gt; + encoder = charsets[i].encoder;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (encoder == NULL || decoder == NULL)
</I>&gt;<i> &gt; + return (miconv_t) -1;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + cd = (miconv_t) g_malloc (sizeof (*cd));
</I>&gt;<i> &gt; + cd-&gt;decode = decoder;
</I>&gt;<i> &gt; + cd-&gt;encode = encoder;
</I>&gt;<i> &gt; + cd-&gt;endian = endian;
</I>&gt;<i> &gt; + cd-&gt;c = -1;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return cd;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +int
</I>&gt;<i> &gt; +miconv_close (miconv_t cd)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + g_free (cd);
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +int
</I>&gt;<i> &gt; +miconv (miconv_t cd, char **inbytes, size_t *inbytesleft,
</I>&gt;<i> &gt; + char **outbytes, size_t *outbytesleft)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + size_t inleft, outleft;
</I>&gt;<i> &gt; + char *inptr, *outptr;
</I>&gt;<i> &gt; + gunichar c;
</I>&gt;<i> &gt; + int rc = 0;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (outbytes == NULL || outbytesleft == NULL) {
</I>&gt;<i> &gt; + /* reset converter */
</I>&gt;<i> &gt; + cd-&gt;c = -1;
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + inleft = inbytesleft ? *inbytesleft : 0;
</I>&gt;<i> &gt; + inptr = inbytes ? *inbytes : NULL;
</I>&gt;<i> &gt; + outleft = *outbytesleft;
</I>&gt;<i> &gt; + outptr = *outbytes;
</I>&gt;<i> &gt; + c = cd-&gt;c;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + while (inleft &gt;= 0 &amp;&amp; outleft &gt; 0) {
</I>&gt;<i> &gt; + if (c == (gunichar) -1 &amp;&amp; cd-&gt;decode (cd-&gt;endian, &amp;inptr, &amp;inleft, 
</I>&gt;<i> &amp;c) == -1) {
</I>&gt;<i> &gt; + rc = -1;
</I>&gt;<i> &gt; + break;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (cd-&gt;encode (c, &amp;outptr, &amp;outleft) == -1) {
</I>&gt;<i> &gt; + rc = -1;
</I>&gt;<i> &gt; + break;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + c = -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (inbytesleft)
</I>&gt;<i> &gt; + *inbytesleft = inleft;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (inbytes)
</I>&gt;<i> &gt; + *inbytes = inptr;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + *outbytesleft = outleft;
</I>&gt;<i> &gt; + *outbytes = outptr;
</I>&gt;<i> &gt; + cd-&gt;c = c;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return rc;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int
</I>&gt;<i> &gt; +decode_utf32 (Endian endian, char **inbytes, size_t *inbytesleft, 
</I>&gt;<i> gunichar *outchar)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + gunichar *inptr = (gunichar *) *inbytes;
</I>&gt;<i> &gt; + size_t inleft = *inbytesleft;
</I>&gt;<i> &gt; + gunichar c;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (inleft &lt; 4) {
</I>&gt;<i> &gt; + errno = EINVAL;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (endian == BigEndian)
</I>&gt;<i> &gt; + c = GUINT32_FROM_BE (*inptr);
</I>&gt;<i> &gt; + else
</I>&gt;<i> &gt; + c = GUINT32_FROM_LE (*inptr);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + inleft -= 4;
</I>&gt;<i> &gt; + inptr++;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (c &gt;= 2147483648UL) {
</I>&gt;<i> &gt; + errno = EILSEQ;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + *inbytes = (char *) inptr;
</I>&gt;<i> &gt; + *inbytesleft = inleft;
</I>&gt;<i> &gt; + *outchar = c;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +//static int encode_utf32 (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int
</I>&gt;<i> &gt; +decode_utf16 (Endian endian, char **inbytes, size_t *inbytesleft, 
</I>&gt;<i> gunichar *outchar)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + gunichar2 *inptr = (gunichar2 *) *inbytes;
</I>&gt;<i> &gt; + size_t inleft = *inbytesleft;
</I>&gt;<i> &gt; + gunichar2 c;
</I>&gt;<i> &gt; + gunichar u;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (inleft &lt; 2) {
</I>&gt;<i> &gt; + errno = EINVAL;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (endian == BigEndian)
</I>&gt;<i> &gt; + u = GUINT16_FROM_BE (*inptr);
</I>&gt;<i> &gt; + else
</I>&gt;<i> &gt; + u = GUINT16_FROM_LE (*inptr);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + inleft -= 2;
</I>&gt;<i> &gt; + inptr++;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (u &gt;= 0xdc00 &amp;&amp; u &lt;= 0xdfff) {
</I>&gt;<i> &gt; + errno = EILSEQ;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + } else if (u &gt;= 0xd800 &amp;&amp; u &lt;= 0xdbff) {
</I>&gt;<i> &gt; + if (inleft &lt; 2) {
</I>&gt;<i> &gt; + errno = EINVAL;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (endian == BigEndian)
</I>&gt;<i> &gt; + c = GUINT16_FROM_BE (*inptr);
</I>&gt;<i> &gt; + else
</I>&gt;<i> &gt; + c = GUINT16_FROM_LE (*inptr);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + inleft -= 2;
</I>&gt;<i> &gt; + inptr++;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (c &lt; 0xdc00 || c &gt; 0xdfff) {
</I>&gt;<i> &gt; + errno = EILSEQ;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + u = ((u - 0xd800) &lt;&lt; 10) + (c - 0xdc00) + 0x0010000UL;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + *inbytes = (char *) inptr;
</I>&gt;<i> &gt; + *inbytesleft = inleft;
</I>&gt;<i> &gt; + *outchar = u;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +//static int encode_utf16 (gunichar c, char **outbytes, size_t 
</I>&gt;<i> *outbytesleft);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int
</I>&gt;<i> &gt; +decode_utf8 (Endian endian, char **inbytes, size_t *inbytesleft, 
</I>&gt;<i> gunichar *outchar)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + size_t inleft = *inbytesleft;
</I>&gt;<i> &gt; + char *inptr = *inbytes;
</I>&gt;<i> &gt; + size_t i, len = 0;
</I>&gt;<i> &gt; + unsigned char c;
</I>&gt;<i> &gt; + gunichar u;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + c = *inptr++;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (c &lt; 0x80) {
</I>&gt;<i> &gt; + /* simple ascii case */
</I>&gt;<i> &gt; + len = 1;
</I>&gt;<i> &gt; + } else if ((c &amp; 0xe0) == 0xc0) {
</I>&gt;<i> &gt; + c &amp;= 0x1f;
</I>&gt;<i> &gt; + len = 2;
</I>&gt;<i> &gt; + } else if ((c &amp; 0xf0) == 0xe0) {
</I>&gt;<i> &gt; + c &amp;= 0x0f;
</I>&gt;<i> &gt; + len = 3;
</I>&gt;<i> &gt; + } else if ((c &amp; 0xf8) == 0xf0) {
</I>&gt;<i> &gt; + c &amp;= 0x07;
</I>&gt;<i> &gt; + len = 4;
</I>&gt;<i> &gt; + } else if ((c &amp; 0xfc) == 0xf8) {
</I>&gt;<i> &gt; + c &amp;= 0x03;
</I>&gt;<i> &gt; + len = 5;
</I>&gt;<i> &gt; + } else if ((c &amp; 0xfe) == 0xfc) {
</I>&gt;<i> &gt; + c &amp;= 0x01;
</I>&gt;<i> &gt; + len = 6;
</I>&gt;<i> &gt; + } else {
</I>&gt;<i> &gt; + errno = EILSEQ;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (len &gt; inleft) {
</I>&gt;<i> &gt; + errno = EINVAL;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + u = c;
</I>&gt;<i> &gt; + for (i = 1; i &lt; len; i++) {
</I>&gt;<i> &gt; + u &lt;&lt;= 6 | ((*inptr) &amp; 0x3f);
</I>&gt;<i> &gt; + inptr++;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + *inbytesleft = inleft - len;
</I>&gt;<i> &gt; + *inbytes = inptr;
</I>&gt;<i> &gt; + *outchar = u;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +static int
</I>&gt;<i> &gt; +encode_utf8 (gunichar c, char **outbytes, size_t *outbytesleft)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; + size_t outleft = *outbytesleft;
</I>&gt;<i> &gt; + char *outptr = *outbytes;
</I>&gt;<i> &gt; + size_t len, i;
</I>&gt;<i> &gt; + char base;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (c &lt; 128UL) {
</I>&gt;<i> &gt; + base = 0;
</I>&gt;<i> &gt; + len = 1;
</I>&gt;<i> &gt; + } else if (c &lt; 2048UL) {
</I>&gt;<i> &gt; + base = 192;
</I>&gt;<i> &gt; + len = 2;
</I>&gt;<i> &gt; + } else if (c &lt; 65536UL) {
</I>&gt;<i> &gt; + base = 224;
</I>&gt;<i> &gt; + len = 3;
</I>&gt;<i> &gt; + } else if (c &lt; 2097152UL) {
</I>&gt;<i> &gt; + base = 240;
</I>&gt;<i> &gt; + len = 4;
</I>&gt;<i> &gt; + } else if (c &lt; 67108864UL) {
</I>&gt;<i> &gt; + base = 248;
</I>&gt;<i> &gt; + len = 5;
</I>&gt;<i> &gt; + } else if (c &lt; 2147483648UL) {
</I>&gt;<i> &gt; + base = 252;
</I>&gt;<i> &gt; + len = 6;
</I>&gt;<i> &gt; + } else {
</I>&gt;<i> &gt; + errno = EINVAL;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + if (outleft &lt; len) {
</I>&gt;<i> &gt; + errno = E2BIG;
</I>&gt;<i> &gt; + return -1;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + for (i = len - 1; i &gt; 0; i--) {
</I>&gt;<i> &gt; + /* mask off 6 bits worth and add 128 */
</I>&gt;<i> &gt; + outptr[i] = 128 + (c &amp; 0x3f);
</I>&gt;<i> &gt; + c &gt;&gt;= 6;
</I>&gt;<i> &gt; + }
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + /* first character has a different base */
</I>&gt;<i> &gt; + outptr[0] = base + (c &amp; 0x3f);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + *outbytesleft = outleft - len;
</I>&gt;<i> &gt; + *outbytes = outptr + len;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; + return 0;
</I>&gt;<i> &gt; +}
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +};
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Added: src/miconv.h
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- /dev/null
</I>&gt;<i> &gt; +++ b/src/miconv.h
</I>&gt;<i> &gt; @@ -0,0 +1,35 @@
</I>&gt;<i> &gt; +/* -*- Mode: C++; tab-width: 8; indent-tabs-mode: t; 
</I>&gt;<i> c-basic-offset: 8 -*- */
</I>&gt;<i> &gt; +/*
</I>&gt;<i> &gt; + * miconv.h:
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * Contact:
</I>&gt;<i> &gt; + * Moonlight List (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">moonlight-list at lists.ximian.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">moonlight-list at lists.ximian.com</A>&gt;)
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * Copyright 2011 Novell, Inc. (<A HREF="http://www.novell.com">http://www.novell.com</A>)
</I>&gt;<i> &gt; + *
</I>&gt;<i> &gt; + * See the LICENSE file included with the distribution for details.
</I>&gt;<i> &gt; + */
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#ifndef __MICONV_H__
</I>&gt;<i> &gt; +#define __MICONV_H__
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#include &lt;glib.h&gt;
</I>&gt;<i> &gt; +#include &lt;sys/types.h&gt;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +namespace Moonlight {
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +G_BEGIN_DECLS
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +typedef struct _miconv_t *miconv_t;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +int miconv (miconv_t cd, char **inbytes, size_t *inbytesleft,
</I>&gt;<i> &gt; + char **outbytes, size_t *outbytesleft);
</I>&gt;<i> &gt; +miconv_t miconv_open (const char *to, const char *from);
</I>&gt;<i> &gt; +int miconv_close (miconv_t cd);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +G_END_DECLS
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +};
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +#endif /* __MICONV_H__ */
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-patches maillist - <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>&gt;
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110420/d0eb03d3/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110420/d0eb03d3/attachment-0001.html</A> 
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037447.html">[Mono-dev] [Mono-patches] [mono/moon] caef081d: Implemented an iconv-like API for unicode conversion
</A></li>
	<LI>Next message: <A HREF="037449.html">[Mono-dev] Mono.Data.SybaseClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37448">[ date ]</a>
              <a href="thread.html#37448">[ thread ]</a>
              <a href="subject.html#37448">[ subject ]</a>
              <a href="author.html#37448">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
