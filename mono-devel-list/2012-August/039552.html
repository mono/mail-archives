<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Malloc issue?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Malloc%20issue%3F&In-Reply-To=%3CCAC9RQtiWpfJLgC9%3DV%2Bw5k2Os1C9YCPZ1PRTR7YHTfQ%2B3GC0EzA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039553.html">
   <LINK REL="Next"  HREF="039554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Malloc issue?</H1>
    <B>Greg Young</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Malloc%20issue%3F&In-Reply-To=%3CCAC9RQtiWpfJLgC9%3DV%2Bw5k2Os1C9YCPZ1PRTR7YHTfQ%2B3GC0EzA%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Malloc issue?">gregoryyoung1 at gmail.com
       </A><BR>
    <I>Fri Aug 24 14:12:28 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039553.html">[Mono-dev] Malloc issue?
</A></li>
        <LI>Next message: <A HREF="039554.html">[Mono-dev] Malloc issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39552">[ date ]</a>
              <a href="thread.html#39552">[ thread ]</a>
              <a href="subject.html#39552">[ subject ]</a>
              <a href="author.html#39552">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Will take a look. Not sure what it may not be liking. Code is very basic.
Literally allocates 16mb chunk then frees it (each object has one) code
works fine in windows with same calls. Will debug it on Sunday.

On Friday, August 24, 2012, Jonathan Pryor wrote:

&gt;<i> On Aug 23, 2012, at 2:35 AM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&lt;javascript:;&gt;&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; We are allocating and releasing unmanaged memory with
</I>&gt;<i> marshal.allochglobal. In mono we are getting the following failure (no
</I>&gt;<i> failures under clr).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any ideas?
</I>&gt;<i>
</I>&gt;<i> That's not a mono error, that's a glibc assert (and thus cannot become an
</I>&gt;<i> exception, ever):
</I>&gt;<i>
</I>&gt;<i> &gt; part from team city logs:
</I>&gt;<i> &gt; [20:55:52][Step 2/2] mono: malloc.c:2451: sYSMALLOc: Assertion `(old_top
</I>&gt;<i> == (((mbinptr) (((char *) &amp;((av)-&gt;bins[((1) - 1) * 2])) -
</I>&gt;<i> __builtin_offsetof (struct malloc_chunk, fd)))) &amp;&amp; old_size == 0) ||
</I>&gt;<i> ((unsigned long) (old_size) &gt;= (unsigned long)((((__builtin_offsetof
</I>&gt;<i> (struct malloc_chunk, fd_nextsize))+((2 * (sizeof(size_t))) - 1)) &amp; ~((2 *
</I>&gt;<i> (sizeof(size_t))) - 1))) &amp;&amp; ((old_top)-&gt;size &amp; 0x1) &amp;&amp; ((unsigned
</I>&gt;<i> long)old_end &amp; pagemask) == 0)' failed.
</I>&gt;<i>
</I>&gt;<i> Very probably coming from:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=0f1796c9134ffef289ec31fb1cd538f3a9490ae1;hb=HEAD#l2361">http://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=0f1796c9134ffef289ec31fb1cd538f3a9490ae1;hb=HEAD#l2361</A>
</I>&gt;<i>            /*
</I>&gt;<i>               If not the first time through, we require old_size to be
</I>&gt;<i>               at least MINSIZE and to have prev_inuse set.
</I>&gt;<i>            */
</I>&gt;<i>
</I>&gt;<i>            assert((old_top == initial_top(av) &amp;&amp; old_size == 0) ||
</I>&gt;<i>                   ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp;
</I>&gt;<i>                    prev_inuse(old_top) &amp;&amp;
</I>&gt;<i>                    ((unsigned long)old_end &amp; pagemask) == 0));
</I>&gt;<i>
</I>&gt;<i> The line number is different, but it's the same file and the assert looks
</I>&gt;<i> close enough (considering macro expansion, etc.).
</I>&gt;<i>
</I>&gt;<i> In short, malloc(3) doesn't like you or something that you're doing. I
</I>&gt;<i> would suggest setting the MALLOC_CHECK_ environment variable (see the
</I>&gt;<i> malloc(3) man page), and/or &quot;porting&quot; your malloc use to C to verify that
</I>&gt;<i> it also crashes there.
</I>&gt;<i>
</I>&gt;<i>  - Jon
</I>&gt;<i>
</I>&gt;<i>
</I>
-- 
Le doute n'est pas une condition agr&#233;able, mais la certitude est absurde.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120824/aa45e9cc/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120824/aa45e9cc/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039553.html">[Mono-dev] Malloc issue?
</A></li>
	<LI>Next message: <A HREF="039554.html">[Mono-dev] Malloc issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39552">[ date ]</a>
              <a href="thread.html#39552">[ thread ]</a>
              <a href="subject.html#39552">[ subject ]</a>
              <a href="author.html#39552">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
