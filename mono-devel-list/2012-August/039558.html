<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Why does .NET object lifetime not extend into an instance method call?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Why%20does%20.NET%20object%20lifetime%20not%20extend%20into%20an%0A%20instance%20method%20call%3F&In-Reply-To=%3CB8B0CD8414046C4D9381B794DDC038341F958E70%40ORSMSX104.amr.corp.intel.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039557.html">
   <LINK REL="Next"  HREF="039559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Why does .NET object lifetime not extend into an instance method call?</H1>
    <B>Lepisto, Stephen P</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Why%20does%20.NET%20object%20lifetime%20not%20extend%20into%20an%0A%20instance%20method%20call%3F&In-Reply-To=%3CB8B0CD8414046C4D9381B794DDC038341F958E70%40ORSMSX104.amr.corp.intel.com%3E"
       TITLE="[Mono-dev] Why does .NET object lifetime not extend into an instance method call?">stephen.p.lepisto at intel.com
       </A><BR>
    <I>Fri Aug 24 20:47:47 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039557.html">[Mono-dev] Why does .NET object lifetime not extend into an instance method call?
</A></li>
        <LI>Next message: <A HREF="039559.html">[Mono-dev] Why does .NET object lifetime not extend into an instance method call?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39558">[ date ]</a>
              <a href="thread.html#39558">[ thread ]</a>
              <a href="subject.html#39558">[ subject ]</a>
              <a href="author.html#39558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am I wrong in thinking that in

   void Problem() { mo.doSomething(); }

&quot;mo&quot; is contained within the context of the method body of Problem() and therefore cannot be disposed of until the method body of Problem() has done execution.  This means that &quot;mo&quot; will continue to live for the life of the call to doSomething() because the Problem() method body holds onto &quot;mo&quot; until after doSomething() returns.


From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of David Jeske
Sent: Friday, August 24, 2012 1:27 PM
To: Jonathan Pryor
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Why does .NET object lifetime not extend into an instance method call?

On Fri, Aug 24, 2012 at 10:50 AM, Jonathan Pryor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jonpryor at vt.edu</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jonpryor at vt.edu</A>&gt;&gt; wrote:
&gt;<i> It seems this could happen in more cases than just PInvoke. This seems to allow a finalizer to run before an object is &quot;done being used&quot; anytime the object instance is not stored. (i.e. inside a statement of the form &quot;new Foo().Method();&quot;) If the finalizer triggers an IDispose pattern, this could cause a managed resource to be torn down before it's done being used as well.
</I>
The managed resource can't be disposed before it's done being used AS LONG AS the GC knows about all uses of the managed resource.

... snip ...

The real problem is that the GC doesn't know anything about native code, and thus can't ensure that no native code is using the resource.

Thanks very mych for the detailed reply. It seems to me there is a race that has nothing to do with native code. Consider this example..

class Foo : IDisposable {
   ManagedObject mo = new ManagedObject();

   ~Foo() { this.Dispose(); }
   public void Dispose() {
       if (mo != null) {
          try {mo.Dispose();} finally { mo = null; }
       }
   }

   void Problem() { mo.doSomething(); }

   static void Main() { new Foo().Problem(); }
}

If I understand the MS.NET&lt;<A HREF="http://MS.NET">http://MS.NET</A>&gt; article, as soon as ms.doSomething enters the vcall, &quot;this&quot; is no longer referenced. Which means during ManagedObject.DoSomething, Foo could be finalized, and thus Disposed, and since the Dispose explicitly Disposes mo, the code would Dispose mo while it's still inside mo.doSomething(). Did I miss something?


&gt;<i> Why isn't this considered a bug in the .NET runtime?
</I>How would you fix it? The .NET runtime has no way of knowing what native code is doing, so short of disassembling the native code (&quot;magic&quot;), what is .NET supposed to do?

Ohh, I don't think the problem is the way this is handled for native code. I think the above interaction in IDisposable seems like a problem too. To me this seems like a pre-mature finalization bug caused because &quot;this&quot; isn't considered referenced for the entire body of instance methods.

&gt;<i> (2) Does the Mono GC have the same behavior?
</I>Yes, because there's no other sane behavior.

However, this can't be relied upon; Linux supports &quot;precise stack marking,&quot; which prevents conservative scanning of native stack frames. This has the wonderful performance advantage that less memory needs to be pinned, allowing the GC to be more efficient:

        <A HREF="http://www.mono-project.com/Generational_GC#Precise_Stack_Marking">http://www.mono-project.com/Generational_GC#Precise_Stack_Marking</A>

I'm sorry for my naivety. Why does allowing unused function arguments to be collected before a function returns have such important effects on memory usage?


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120824/f35d5f4f/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120824/f35d5f4f/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039557.html">[Mono-dev] Why does .NET object lifetime not extend into an instance method call?
</A></li>
	<LI>Next message: <A HREF="039559.html">[Mono-dev] Why does .NET object lifetime not extend into an instance method call?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39558">[ date ]</a>
              <a href="thread.html#39558">[ thread ]</a>
              <a href="subject.html#39558">[ subject ]</a>
              <a href="author.html#39558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
