<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Malloc issue?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Malloc%20issue%3F&In-Reply-To=%3C9A99A980-D679-4410-A8A4-CCCBC2341D14%40vt.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039551.html">
   <LINK REL="Next"  HREF="039552.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Malloc issue?</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Malloc%20issue%3F&In-Reply-To=%3C9A99A980-D679-4410-A8A4-CCCBC2341D14%40vt.edu%3E"
       TITLE="[Mono-dev] Malloc issue?">jonpryor at vt.edu
       </A><BR>
    <I>Fri Aug 24 13:47:54 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039551.html">[Mono-dev] Malloc issue?
</A></li>
        <LI>Next message: <A HREF="039552.html">[Mono-dev] Malloc issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39553">[ date ]</a>
              <a href="thread.html#39553">[ thread ]</a>
              <a href="subject.html#39553">[ subject ]</a>
              <a href="author.html#39553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Aug 23, 2012, at 2:35 AM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt; wrote:
&gt;<i> We are allocating and releasing unmanaged memory with marshal.allochglobal. In mono we are getting the following failure (no failures under clr).
</I>&gt;<i> 
</I>&gt;<i> Any ideas?
</I>
That's not a mono error, that's a glibc assert (and thus cannot become an exception, ever):

&gt;<i> part from team city logs:
</I>&gt;<i> [20:55:52][Step 2/2] mono: malloc.c:2451: sYSMALLOc: Assertion `(old_top == (((mbinptr) (((char *) &amp;((av)-&gt;bins[((1) - 1) * 2])) - __builtin_offsetof (struct malloc_chunk, fd)))) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= (unsigned long)((((__builtin_offsetof (struct malloc_chunk, fd_nextsize))+((2 * (sizeof(size_t))) - 1)) &amp; ~((2 * (sizeof(size_t))) - 1))) &amp;&amp; ((old_top)-&gt;size &amp; 0x1) &amp;&amp; ((unsigned long)old_end &amp; pagemask) == 0)' failed.
</I>
Very probably coming from:

	<A HREF="http://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=0f1796c9134ffef289ec31fb1cd538f3a9490ae1;hb=HEAD#l2361">http://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=0f1796c9134ffef289ec31fb1cd538f3a9490ae1;hb=HEAD#l2361</A>
	   /*
	      If not the first time through, we require old_size to be
	      at least MINSIZE and to have prev_inuse set.
	   */

	   assert((old_top == initial_top(av) &amp;&amp; old_size == 0) ||
	          ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp;
	           prev_inuse(old_top) &amp;&amp;
	           ((unsigned long)old_end &amp; pagemask) == 0));

The line number is different, but it's the same file and the assert looks close enough (considering macro expansion, etc.).

In short, malloc(3) doesn't like you or something that you're doing. I would suggest setting the MALLOC_CHECK_ environment variable (see the malloc(3) man page), and/or &quot;porting&quot; your malloc use to C to verify that it also crashes there.

 - Jon

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039551.html">[Mono-dev] Malloc issue?
</A></li>
	<LI>Next message: <A HREF="039552.html">[Mono-dev] Malloc issue?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39553">[ date ]</a>
              <a href="thread.html#39553">[ thread ]</a>
              <a href="subject.html#39553">[ subject ]</a>
              <a href="author.html#39553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
