<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Stack overflow in Array.Sort for large arrays
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Stack%20overflow%20in%20Array.Sort%20for%20large%20arrays&In-Reply-To=%3CEAD2497C591C9A4DA707DE1FA9AA7108010C7E%40MAIL02.lrscorp.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039472.html">
   <LINK REL="Next"  HREF="039480.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Stack overflow in Array.Sort for large arrays</H1>
    <B>Martin Potter</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Stack%20overflow%20in%20Array.Sort%20for%20large%20arrays&In-Reply-To=%3CEAD2497C591C9A4DA707DE1FA9AA7108010C7E%40MAIL02.lrscorp.net%3E"
       TITLE="[Mono-dev] Stack overflow in Array.Sort for large arrays">martin.potter at logos.com
       </A><BR>
    <I>Sat Aug  4 18:18:08 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039472.html">[Mono-dev] Stack overflow in Array.Sort for large arrays
</A></li>
        <LI>Next message: <A HREF="039480.html">[Mono-dev] Stack overflow in Array.Sort for large arrays
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39479">[ date ]</a>
              <a href="thread.html#39479">[ thread ]</a>
              <a href="subject.html#39479">[ subject ]</a>
              <a href="author.html#39479">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Forgot to cc the list, sorry for the duplicate Marek.

Marek,

When running Mono from the command line, it appears that the stack limit is not reached as quickly as when running embedded or on a ThreadPool thread like we do in our application. Running from the command line, it takes a much larger array to reach stack overflow, but it will eventually hit that limit.

Are you able to answer the question as to why the change was made? It does not seem like an optimization as the commit states. Using the actual 228299 element list, which is just one example of the type of data we are sorting, Mono 2.10.9 takes 00.0382963 seconds to sort, Mono 2.11.2 takes 17.293864 seconds to sort; this seems less than optimal and is a huge concern for us.

I am not at home at the moment where I have access to the actual array values, but will file a bug when I am at home again. Until then, the following code will reproduce the issue for me running Mono 2.11.2 built from source on Mac OS X:

using System;
using System.Collections.Generic;
using System.Threading;

namespace SortCrash
{
class Program
{
static ManualResetEvent s_wait;
static void Main (string[] args)
{
s_wait = new ManualResetEvent(false);
ThreadPool.QueueUserWorkItem(Sort);
s_wait.WaitOne();
}

static void Sort(object state)
{
List&lt;int&gt; ints = new List&lt;int&gt;();
for (int i = 0; i &lt; 50000; i++)
ints.Add(1);

ints.Sort();
s_wait.Set();
}
}
}

I have updated the various qsort methods on our fork to their state prior to the optimization commit, added back the Insertion sort optimization (along with adding it to the non-generic qsort method) and modified the algorithm to only recurse on the smaller partition, limiting the potential for stack overflow. These changes are available at <A HREF="https://github.com/LogosBible/mono/commit/d4d4d0768a39881fd8a12818be363139a37c3da3">https://github.com/LogosBible/mono/commit/d4d4d0768a39881fd8a12818be363139a37c3da3</A> if you are interested.

Thanks,
Martin
________________________________
From: Marek Safar [<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">marek.safar at gmail.com</A>]
Sent: Saturday, August 04, 2012 8:03 AM
To: Martin Potter
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Stack overflow in Array.Sort for large arrays

Hi,

I cannot reproduce the issue. Could you fill a bug report with test case how to reproduce it.

Thanks
Marek

On Thu, Aug 2, 2012 at 7:21 PM, Martin Potter &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">martin.potter at logos.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">martin.potter at logos.com</A>&gt;&gt; wrote:
I am currently working on testing Mono to 2.11 with the hope to ease the transition to 2.12 when it is release. When testing, I found a nasty bug when sorting a large (228,000 elements) List&lt;int&gt; that resulted in a stack overflow. The partial stack trace from the crash:

System.Collections.Generic.List`1&lt;int&gt;:Sort ()
System.Array:Sort&lt;int&gt; (int[],int,int)
System.Array:Sort&lt;int&gt; (int[],int,int,System.Collections.Generic.IComparer`1&lt;int&gt;)
System.Array:SortImpl&lt;int, int&gt; (int[],int[],int,int,System.Collections.Generic.IComparer`1&lt;int&gt;)
System.Array:qsort&lt;int, int&gt; (int[],int[],int,int)
...
System.Array:qsort&lt;int, int&gt; (int[],int[],int,int)

Upon pulling the related sorting code from System.Array into a separate project, I determined that the stack overflow was occurring for this particular List/Array due to the fact that over half of the list elements were same number. It appears that this occurs as a result of the change to the various qsort methods in <A HREF="https://github.com/mono/mono/commit/d97cdb0c124729152be551c421c4a11732e45fc9,">https://github.com/mono/mono/commit/d97cdb0c124729152be551c421c4a11732e45fc9,</A> which introduced a change in the treatment of elements with equal values. Reverting this commit fixes the stack overflow in the test app. In testing, I noticed that the old qsort code was significantly faster sorting when there were lots of duplicate values, was there are particular reason for changing the logic for dealing with equal values?

&#8212; Martin



_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>&gt;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120804/bf5a3a26/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120804/bf5a3a26/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039472.html">[Mono-dev] Stack overflow in Array.Sort for large arrays
</A></li>
	<LI>Next message: <A HREF="039480.html">[Mono-dev] Stack overflow in Array.Sort for large arrays
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39479">[ date ]</a>
              <a href="thread.html#39479">[ thread ]</a>
              <a href="subject.html#39479">[ subject ]</a>
              <a href="author.html#39479">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
