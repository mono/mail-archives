<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] WCF NetTcpBinding doesn't seem to honor	MaxReceivedMessageSize
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WCF%20NetTcpBinding%20doesn%27t%20seem%20to%20honor%0A%09MaxReceivedMessageSize&In-Reply-To=%3CCAK%3DA7Efqxnc5rL3xxPRQSYBh4e1dc29GgCm19rg8op2E21Fdyw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039522.html">
   <LINK REL="Next"  HREF="039524.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] WCF NetTcpBinding doesn't seem to honor	MaxReceivedMessageSize</H1>
    <B>matthieu Barth&#233;lemy</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WCF%20NetTcpBinding%20doesn%27t%20seem%20to%20honor%0A%09MaxReceivedMessageSize&In-Reply-To=%3CCAK%3DA7Efqxnc5rL3xxPRQSYBh4e1dc29GgCm19rg8op2E21Fdyw%40mail.gmail.com%3E"
       TITLE="[Mono-dev] WCF NetTcpBinding doesn't seem to honor	MaxReceivedMessageSize">bonsouere at gmail.com
       </A><BR>
    <I>Wed Aug 15 12:16:04 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039522.html">[Mono-dev] Problems building Mono 2.10.8 on 64-bit SmartOS	(Solaris)
</A></li>
        <LI>Next message: <A HREF="039524.html">[Mono-dev] How do I use scratch registers in op code implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39523">[ date ]</a>
              <a href="thread.html#39523">[ thread ]</a>
              <a href="subject.html#39523">[ subject ]</a>
              <a href="author.html#39523">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

My project uses WCF to perform remoting communications between a server and
a client.
Sometimes I have to transfer 'large' data (large meaning here &quot;more than
the default max value&quot;).

So to get transferts to work, I had to declare my binding with the
following parameters:
var binding = new NetTcpBinding ();
binding.Security.Mode = SecurityMode.None;
 binding.OpenTimeout = new TimeSpan(1,0,0);
binding.SendTimeout = new TimeSpan(1,0,0);
 binding.CloseTimeout = new TimeSpan(1,0,0);
binding.MaxReceivedMessageSize = 1000000000;
 binding.MaxBufferPoolSize = 100000000;
var address = new EndpointAddress
(&quot;net.<A HREF="tcp://">tcp://</A>&quot;+serverIP+&quot;:&quot;+serverPort+&quot;/&quot;);
 IRemoteOperations remote = new ChannelFactory&lt;IRemoteOperations&gt; (binding,
address).CreateChannel();
remote.CallMyMethodGeneratingBigData();


This works as expected on .NET/Windows, but under mono I get the following
exception:

Error : The message is too large.
  at
System.ServiceModel.Channels.NetTcp.TcpBinaryFrameManager.ReadSizedChunk ()
[0x00039] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel.Channels.NetTcp/TcpBinaryFrameManager.cs:202
  at
System.ServiceModel.Channels.NetTcp.TcpBinaryFrameManager.ReadSizedMessage
() [0x00089] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel.Channels.NetTcp/TcpBinaryFrameManager.cs:337
  at System.ServiceModel.Channels.NetTcp.TcpDuplexSessionChannel.TryReceive
(TimeSpan timeout, System.ServiceModel.Channels.Message&amp; message) [0x00046]
in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel.Channels.NetTcp/TcpDuplexSessionChannel.cs:171
  at System.ServiceModel.Channels.DuplexChannelBase.Receive (TimeSpan
timeout) [0x00000] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel.Channels/DuplexChannelBase.cs:178
  at
System.ServiceModel.MonoInternal.ClientRuntimeChannel.RequestCorrelated
(System.ServiceModel.Channels.Message msg, TimeSpan timeout, IOutputChannel
channel) [0x00013] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel/ClientRuntimeChannel.cs:594
  at System.ServiceModel.MonoInternal.ClientRuntimeChannel.Request
(System.ServiceModel.Channels.Message msg, TimeSpan timeout) [0x00019] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel/ClientRuntimeChannel.cs:584
  at System.ServiceModel.MonoInternal.ClientRuntimeChannel.Request
(System.ServiceModel.Description.OperationDescription od, System.Object[]
parameters) [0x00066] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel/ClientRuntimeChannel.cs:537
  at System.ServiceModel.MonoInternal.ClientRuntimeChannel.DoProcess
(System.Reflection.MethodBase method, System.String operationName,
System.Object[] parameters) [0x00038] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel/ClientRuntimeChannel.cs:502
  at System.ServiceModel.MonoInternal.ClientRuntimeChannel.Process
(System.Reflection.MethodBase method, System.String operationName,
System.Object[] parameters) [0x0001c] in
/usr/src/packages/BUILD/mono-2.10.9/mcs/class/System.ServiceModel/System.ServiceModel/ClientRuntimeChannel.cs:479


My mono source code skill are not (yet) good enough to dive very deep, but
it looks like the &quot;binding.MaxReceivedMessageSize&quot; custom value is not
honored.
Greping the sources (from mono 2.10.8 tarball), I realized that the
file mcs/class/System.ServiceModel/System.ServiceModel.Channels.NetTcp/TcpBinaryFrameManager.cs
has the following code (in my opinion, part of the problem is located line
201):

193                 public byte [] ReadSizedChunk ()
194                 {
195                         lock (read_lock) {
196
197                         int length = reader.ReadVariableInt ();
198                         if (length == 0)
199                                 return empty_bytes;
200
201                         if (length &gt; 65536)
202                                 throw new InvalidOperationException
(&quot;The message is too large.&quot;);
203
204                         byte [] buffer = new byte [length];
205                         for (int readSize = 0; readSize &lt; length; )
206                                 readSize += reader.Read (buffer,
readSize, length - readSize);
207                         return buffer;
208
209                         }
210                 }


if I replace this 64k hard-coded value (in my case, to be 10x bigger) and
recompile my mono instance, everything works as expected.

I guess there was a good reason to put an hardcoded value here, but then,
what is supposed to happen for messages bigger than this value,
when MaxReceivedMessageSize has been set appropriately?
Should mono have a loop calling ReadSizedChunk to process chunks until we
reach final size (reader.ReadVariableInt ())?
Or should the hardcoded 65536 be removed?

Many thanks for your help!

My version of Mono:
&gt;<i> mono -V
</I>Mono JIT compiler version 2.10.9 (tarball Fri Jul 13 23:11:26 UTC 2012)
Copyright (C) 2002-2011 Novell, Inc, Xamarin, Inc and Contributors.
www.mono-project.com
        TLS:           __thread
        SIGSEGV:       altstack
        Notifications: epoll
        Architecture:  amd64
        Disabled:      none
        Misc:          debugger softdebug
        LLVM:          supported, not enabled.
        GC:            Included Boehm (with typed GC and Parallel Mark)



Matthieu Barthelemy
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120815/b65377e4/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120815/b65377e4/attachment.html</A>&gt;
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039522.html">[Mono-dev] Problems building Mono 2.10.8 on 64-bit SmartOS	(Solaris)
</A></li>
	<LI>Next message: <A HREF="039524.html">[Mono-dev] How do I use scratch registers in op code implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39523">[ date ]</a>
              <a href="thread.html#39523">[ thread ]</a>
              <a href="subject.html#39523">[ subject ]</a>
              <a href="author.html#39523">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
