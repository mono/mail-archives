<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Cross application domain call optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Cross%20application%20domain%20call%20optimization&In-Reply-To=1097880027.6232.34.camel%40omega">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008345.html">
   <LINK REL="Next"  HREF="008332.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Cross application domain call optimization</H1>
    <B>Lluis Sanchez</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Cross%20application%20domain%20call%20optimization&In-Reply-To=1097880027.6232.34.camel%40omega"
       TITLE="[Mono-devel-list] Cross application domain call optimization">lluis at ximian.com
       </A><BR>
    <I>Mon Oct 18 06:42:25 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008345.html">[Mono-devel-list] Cross application domain call optimization
</A></li>
        <LI>Next message: <A HREF="008332.html">[Mono-devel-list] Cross application domain call optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8364">[ date ]</a>
              <a href="thread.html#8364">[ thread ]</a>
              <a href="subject.html#8364">[ subject ]</a>
              <a href="author.html#8364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> &gt; However, there is a drawback: we need to generate two additional methods
</I>&gt;<i> &gt; for each remotable method. As an example, a monodevelop run creates
</I>&gt;<i> &gt; around 80 wrapper methods + 80 helper methods, averaging 435 bytes of IL
</I>&gt;<i> &gt; per couple, which means 34kb of IL code (plus the memory of internal
</I>&gt;<i> &gt; data structures). And all this is dead code, since monodevelop does not
</I>&gt;<i> &gt; use app domains, but the wrappers are generated for every call to a non-
</I>&gt;<i> &gt; virtual MarshalByRefObject method. The reason is that those calls are
</I>&gt;<i> &gt; made through the remoting-invoke-with-check wrapper, wich has a
</I>&gt;<i> &gt; reference to the other wrappers.
</I>&gt;<i> 
</I>&gt;<i> Nope, this doesn't have to be done. What we do is: you emit this code:
</I>&gt;<i> 
</I>&gt;<i> call trampoline
</I>&gt;<i> 
</I>&gt;<i> That method will go into the runtime, generate the IL for the wrapper
</I>&gt;<i> method, and jit it. Then, it takes that jitted code and dynamically
</I>&gt;<i> patches the address so that it refers to the new method. This avoids the
</I>&gt;<i> lookup.
</I>
Yes, that is what I was talking about in the end of my mail. This would
solve the memory issue without losing performance. But it is not yet
supported.

&gt;<i> 
</I>&gt;<i> One other option would be to always call functions in MBRO's virtually.
</I>&gt;<i> It may end up being faster than having to do the call, etc.
</I>&gt;<i> 
</I>&gt;<i> Ok, now specific patch comments:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; +	object get_xappdomain_target (RealProxy rp)
</I>&gt;<i> &gt; +	{
</I>&gt;<i> 
</I>&gt;<i> Why not actually write this method in C# and call it from the marshal
</I>&gt;<i> stuff?
</I>
Yes, it can be done.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; +	Exception mono_serialize_exception (Exception ex)
</I>&gt;<i> &gt; +	{
</I>&gt;<i> &gt; +		Exception loc_exc = ex;
</I>&gt;<i> &gt; +		byte[] loc_data;
</I>&gt;<i> &gt; +		int retry = 4;
</I>&gt;<i> &gt; +		
</I>&gt;<i> &gt; +		do {
</I>&gt;<i> &gt; +			try {
</I>&gt;<i> &gt; +				mono_thread_force_interruption_checkpoint ();
</I>&gt;<i> &gt; +				loc_data = RemotingServices.SerializeObject (loc_exc);
</I>&gt;<i> &gt; +				return loc_data;
</I>&gt;<i> 
</I>&gt;<i> Same comment here. Also, why do we need the interruption checkpoint?
</I>
While doing the domain transition the thread should only be able to be
aborted at some specific safe points. That's one of them.
However, there is an issue that I need to fix regarding this, since
although the other wrappers can be protected against interruptions, this
method is still not.

Lluis.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008345.html">[Mono-devel-list] Cross application domain call optimization
</A></li>
	<LI>Next message: <A HREF="008332.html">[Mono-devel-list] Cross application domain call optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8364">[ date ]</a>
              <a href="thread.html#8364">[ thread ]</a>
              <a href="subject.html#8364">[ subject ]</a>
              <a href="author.html#8364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
