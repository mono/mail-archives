<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20What%20to%20do%20with%20TypeInitialization%20in%20case%20of%20exceptions%20on%20second%20attempt%20to%20access%20class%20%3F%20Singleton%20pattern&In-Reply-To=20041025170730.A0112124784%40lists.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008480.html">
   <LINK REL="Next"  HREF="008487.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern</H1>
    <B>Rafael Teixeira</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20What%20to%20do%20with%20TypeInitialization%20in%20case%20of%20exceptions%20on%20second%20attempt%20to%20access%20class%20%3F%20Singleton%20pattern&In-Reply-To=20041025170730.A0112124784%40lists.ximian.com"
       TITLE="[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern">monoman at gmail.com
       </A><BR>
    <I>Mon Oct 25 14:00:39 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008480.html">[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern
</A></li>
        <LI>Next message: <A HREF="008487.html">[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8482">[ date ]</a>
              <a href="thread.html#8482">[ thread ]</a>
              <a href="subject.html#8482">[ subject ]</a>
              <a href="author.html#8482">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just a comment:

To avoid that behavior, I normally use &quot;lazy initialization&quot; or &quot;on
demand initialization&quot;:

class Singleton
{
   Singleton() { throw new ArgumentException(&quot;I feel headache. Try
again next night&quot;); }
   private static Singleton instance = null;

   public static Singleton Instance  { 
     get {
       if  (Singleton.instance == null)
           Singleton.instance = new Singleton();
       return Singleton.instance; } 
   }
}

Although it WILL throw an exception in this example, it will do so at
another point in time in code that normally is easier for the class
user to deal with it.

I normally do it more explicit to the class user code:

class Singleton
{
   Singleton() { throw new ArgumentException(&quot;I feel headache. Try
again next night&quot;); }
   private static Singleton instance = null;

   public static Singleton Instance  { 
     get {
       if  (Singleton.instance == null)
            try { Singleton.instance = new Singleton(); }  catch
(Exception ex) { log(ex); }
       return Singleton.instance; } 
   }
}

so the user code must be like:

if (Singleton.Instance != null)
   // use Singleton.Instance

All of this doesn't invalidate your report of Mono different behaviour.

Fun,

On Mon, 25 Oct 2004 20:07:10 +0300, Andriy G. Tereshchenko
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-list at spam.24.odessa.ua</A>&gt; wrote:
&gt;<i> Hello Mono developers,
</I>&gt;<i> 
</I>&gt;<i> While writing failure tests for one of my projects I've found very tricky issue.
</I>&gt;<i> This is very common to use singleton pattern using static field initiation.
</I>&gt;<i> But in case if your singleton require some access to external objects - like a configuration settings, file, network or database or
</I>&gt;<i> object protected using CRL security - then singleton constructor can fail.
</I>&gt;<i> 
</I>&gt;<i> In this case pattern using static properties fail very-very hard:
</I>&gt;<i> class Singleton
</I>&gt;<i> {
</I>&gt;<i>     Singleton() { throw new ArgumentException(&quot;I feel headache. Try again next night&quot;); }
</I>&gt;<i>     public static Singleton Instance  { get {  return Singleton.instance; } }
</I>&gt;<i>     private static Singleton instance = new Singleton();
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> First of all - user receive System.TypeInitializationException exceptions.
</I>&gt;<i> This is unexpected to user - but documented feature of CLR.
</I>&gt;<i> But this email not about this. But about future user actions.
</I>&gt;<i> 
</I>&gt;<i> In case if code will try to access this static property at second (third as so on) attempt - here is most funny things happen.
</I>&gt;<i> In Microsoft implementation -  TypeInitialization thrown for all future access.
</I>&gt;<i> This is somethat good - as all users of incorrectly constructed singleton will be notified about this.
</I>&gt;<i> But in the same time - this can result some parts of singleton code executed more that once and result in side-effects.
</I>&gt;<i> 
</I>&gt;<i> In Java - all future access to non-fully constructed classes result in ClassNotFound exception !!  Not good ;-)
</I>&gt;<i> 
</I>&gt;<i> But now then trying to test the same application (Program.cs) on Mono - it looks like Mono decided to implement this in different
</I>&gt;<i> way.
</I>&gt;<i> All future access to property return null and no exceptions ! Not good.
</I>&gt;<i> 
</I>&gt;<i> As for specification - I think this is undocumented.
</I>&gt;<i> CLR Partition I, 8.5.9 Class Type Definition:
</I>&gt;<i> ---
</I>&gt;<i> 4.      If not marked BeforeFieldInit then that type's initializer method is executed at (i.e., is triggered by):
</I>&gt;<i> * first access to any static or instance field of that type, or
</I>&gt;<i> * first invocation of any static, instance or virtual method of that type
</I>&gt;<i> ---
</I>&gt;<i> There is nothing about invoking it on second attempt then first attempt failed ;-)
</I>&gt;<i> 
</I>&gt;<i> What do you think ?
</I>&gt;<i> --
</I>&gt;<i> Andriy G. Tereshchenko
</I>&gt;<i> Odessa, Ukraine
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>

-- 
Rafael &quot;Monoman&quot; Teixeira
---------------------------------------
Just the 'crazy' me in a sane world, or would it be the reverse? I dunno...

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008480.html">[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern
</A></li>
	<LI>Next message: <A HREF="008487.html">[Mono-devel-list] What to do with TypeInitialization in case of exceptions on second attempt to access class ? Singleton pattern
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8482">[ date ]</a>
              <a href="thread.html#8482">[ thread ]</a>
              <a href="subject.html#8482">[ subject ]</a>
              <a href="author.html#8482">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
