<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Cross application domain call optimization, Take 2.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Cross%20application%20domain%20call%20optimization%2C%20Take%202.&In-Reply-To=1098981897.6347.31.camel%40portatil.aticatac">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008552.html">
   <LINK REL="Next"  HREF="008511.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Cross application domain call optimization, Take 2.</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Cross%20application%20domain%20call%20optimization%2C%20Take%202.&In-Reply-To=1098981897.6347.31.camel%40portatil.aticatac"
       TITLE="[Mono-devel-list] Cross application domain call optimization, Take 2.">lupus at ximian.com
       </A><BR>
    <I>Fri Oct 29 06:15:23 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008552.html">[Mono-devel-list] Cross application domain call optimization,	Take 2.
</A></li>
        <LI>Next message: <A HREF="008511.html">[Mono-devel-list] compiling LIGGDIPLUS for Mono on Solaris
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8562">[ date ]</a>
              <a href="thread.html#8562">[ thread ]</a>
              <a href="subject.html#8562">[ subject ]</a>
              <a href="author.html#8562">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/28/04 Lluis Sanchez wrote:
&gt;<i> El dj 28 de 10 del 2004 a les 17:59 +0200, en/na Paolo Molaro va
</I>&gt;<i> &gt; &gt; +mono_get_xdomain_marshal_type (MonoType *t)
</I>&gt;<i> &gt; &gt; +{
</I>&gt;<i> &gt; &gt; +	switch (t-&gt;type) {
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Can you ever get a byref type here?
</I>&gt;<i> 
</I>&gt;<i> Yes, 't' can be a byref parameter type. Is that a problem (I guess it
</I>&gt;<i> is)?
</I>
Yes, you usually deal with it separately before the switch:
	if (t-&gt;byref) {
		do something;
		return xx;
	}

&gt;<i> &gt; &gt; +mono_marshal_emit_load_domain_method (MonoMethodBuilder *mb, MonoMethod *method)
</I>&gt;<i> &gt; &gt; +{
</I>&gt;<i> &gt; &gt; +	static MonoMethodSignature *csig = NULL;
</I>&gt;<i> &gt; &gt; +	if (!csig) {
</I>&gt;<i> &gt; &gt; +		csig = mono_metadata_signature_alloc (mono_defaults.corlib, 1);
</I>&gt;<i> &gt; &gt; +		csig-&gt;params [0] = &amp;mono_defaults.int_class-&gt;byval_arg;
</I>&gt;<i> &gt; &gt; +		csig-&gt;ret = &amp;mono_defaults.int_class-&gt;byval_arg;
</I>&gt;<i> &gt; &gt; +		csig-&gt;pinvoke = 1;
</I>&gt;<i> &gt; &gt; +	}
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, MONO_CUSTOM_PREFIX);
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, CEE_MONO_LDPTR);
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_i4 (mb, mono_mb_add_data (mb, method));
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_native_call (mb, csig, mono_compile_method);
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Why do you need to compile the method? It seems unusual. Maybe you can just use LDFTN?
</I>&gt;<i> 
</I>&gt;<i> I don't think so. LDFNT would load the method from the domain that is
</I>&gt;<i> compiling the wrapper, right? I need here to get the method for the
</I>&gt;<i> target domain, which is only known when running the wrapper.
</I>
Ok. If it's semantically correct to have the method compiled right away it's fine
(like, if there is no side effect, for types that need to obey the beforefieldinit
flag value). But please add a comment that says you need the pointer to the method in
the current domain.

&gt;<i> &gt; &gt; +	for (i = 0; i &lt; sig-&gt;param_count; i++)
</I>&gt;<i> &gt; &gt; +		if (marshal_types [i] != MONO_MARSHAL_SERIALIZE)
</I>&gt;<i> &gt; &gt; +			csig-&gt;params [j++] = sig-&gt;params [i];
</I>&gt;<i> &gt; This copies also the attributes of the params: is that the intended behaviour?
</I>&gt;<i> 
</I>&gt;<i> I think it is correct. Would those attribute have any side effect in the
</I>&gt;<i> JIT?
</I>
It's likely ok then, there should not be any weird side effect.

&gt;<i> &gt; &gt; +	/* Main exception catch */
</I>&gt;<i> &gt; &gt; +	main_clause-&gt;flags = MONO_EXCEPTION_CLAUSE_FILTER;
</I>&gt;<i> &gt; &gt; +	main_clause-&gt;try_len = mb-&gt;pos - main_clause-&gt;try_offset;
</I>&gt;<i> &gt; &gt; +	main_clause-&gt;token_or_filter = mb-&gt;pos;
</I>&gt;<i> &gt; &gt; +	/* filter code */
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, CEE_POP);
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, CEE_LDC_I4_1);
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, CEE_PREFIX1);
</I>&gt;<i> &gt; &gt; +	mono_mb_emit_byte (mb, CEE_ENDFILTER);
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Why do you need a filter that always catches the exception?
</I>&gt;<i> 
</I>&gt;<i> I really don't, I just need to catch all exceptions. Which clause type
</I>&gt;<i> should I use?
</I>
A catch (object) clause will catch all the exceptions (this requires a small
change, though: where token_or_filter is used, it needs to be replaced with
a union holding a MonoClass* and the filter offset).

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008552.html">[Mono-devel-list] Cross application domain call optimization,	Take 2.
</A></li>
	<LI>Next message: <A HREF="008511.html">[Mono-devel-list] compiling LIGGDIPLUS for Mono on Solaris
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8562">[ date ]</a>
              <a href="thread.html#8562">[ thread ]</a>
              <a href="subject.html#8562">[ subject ]</a>
              <a href="author.html#8562">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
