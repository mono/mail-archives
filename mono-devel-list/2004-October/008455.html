<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] AMD64, PInvoke + Native Exceptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20AMD64%2C%20PInvoke%20%2B%20Native%20Exceptions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008454.html">
   <LINK REL="Next"  HREF="008461.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] AMD64, PInvoke + Native Exceptions</H1>
    <B>Willibald Krenn</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20AMD64%2C%20PInvoke%20%2B%20Native%20Exceptions&In-Reply-To="
       TITLE="[Mono-devel-list] AMD64, PInvoke + Native Exceptions">Willibald.Krenn at gmx.at
       </A><BR>
    <I>Sun Oct 24 15:20:24 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008454.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
        <LI>Next message: <A HREF="008461.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8455">[ date ]</a>
              <a href="thread.html#8455">[ thread ]</a>
              <a href="subject.html#8455">[ subject ]</a>
              <a href="author.html#8455">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>J&#243; napot!

&gt;<i> &gt; exceptions thrown in e.g. a g++ compiled .so, 
</I>&gt;<i> 
</I>&gt;<i> This will not be implemented in the near future.
</I>
I see. But it should be possible to catch those exceptions by implementing a
custom personality routine for exception handling - if I'm not mistaken.
Will look into that.
 
&gt;<i> &gt; BTW: LMF seems pretty senseless on AMD64, or have I missed something..
</I>&gt;<i> 
</I>&gt;<i> LMF is used to return to the last managed method in case the unmanaged
</I>&gt;<i> method
</I>&gt;<i> threw an exception. This is used when the internal runtime code throws
</I>&gt;<i> an .NET exception,
</I>&gt;<i> for example. It is also used when there is a segmentation fault in
</I>&gt;<i> unmanaged code.
</I>
Just to see, if I understand that correctly: In case I can come up with a
custom personality routine, LMF should not be needed on AMD64 because
 -&gt; c runtime will search the DWARF info for a catch handler
 -&gt; it will find the custom personality routine from the stub that
encapsulated the call to the internal runtime code / native code.
 -&gt; the personality routine will do mono style exception handling..
    (As mono uses plain stack-frames and has all the meta information at
hands the exception handling should be doable by the personality routine..)

BTW: Throwing a C++ exception in native code just aborts mono because the C
runtime can not find any valid catch handler. So how should Mono be ever
able to use the LMF in case of an exception thrown in native code? (I guess,
I'm missing something here: Signals are another story for sure.)


&gt;<i> &gt; Another question that arose has to do with OP_CHECK_THIS: Am I right
</I>&gt;<i> that
</I>&gt;<i> &gt; this is not fully implemented yet?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> OP_CHECK_THIS works by loading the value pointed to by the given this
</I>&gt;<i> variable. If
</I>&gt;<i> the variable is null, a SIGSEGV is sent to the thread, which will be
</I>&gt;<i> converted to a
</I>&gt;<i> NullReferenceException by the exception handling code.
</I>

Well, so how does that work in the following case:
[... Next, the code will call the constructor of the
System.NotImplementedException  class, thereby passing the 'this' (self)
pointer as argument in %rdi.
 Interestingly enough, the pointer is compared to NULL, but no conditional
 jump can be found before the callq opcode.
 Essentially, the cmp opcode comes from an OP_CHECK_THIS(?) mono
intermediate instruction and should issue an exception when 'this' is found
to be NULL. The check, however, does not seem to be completely implemented
yet.]
  35:   49 8b ff                mov    %r15,%rdi
  38:   49 83 3f 00             cmpq   $0x0,(%r15)
  3c:   49 bb 30 6b f0 96 2a    mov    $0x2a96f06b30,%r11
  43:   00 00 00
  46:   49 ff d3                callq  *%r11



By looking at the code above, it's pretty obvious that mono issues calls on
AMD64 by a &quot;mov IMM8, reg\n  call *reg&quot; opcode combination. You've a fixme
in the codegen header at this position IIRC: Does that mean you want to use
the IP-relative imm4 version, if the call target is in reach?

 
&gt;<i> &gt; And the last one: When stepping through code with ddd, I often get SIG35
</I>&gt;<i> &gt; exceptions.. Anything I can do about that?
</I>&gt;<i> &gt; 
</I>&gt;<i> Some signals are used by the runtime/libgc for suspending/aborting
</I>&gt;<i> threads etc. These
</I>&gt;<i> can be ignored during debugging by the gdb 'handle' command.
</I>
Ah, ok. Thanks!
I already disabled PWR and another signal, but was not aware that there are
more signals to ignore. 

Willi

-- 
Geschenkt: 3 Monate GMX ProMail + 3 Ausgaben der TV Movie mit DVD
++++ Jetzt anmelden und testen <A HREF="http://www.gmx.net/de/go/mail">http://www.gmx.net/de/go/mail</A> ++++


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008454.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
	<LI>Next message: <A HREF="008461.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8455">[ date ]</a>
              <a href="thread.html#8455">[ thread ]</a>
              <a href="subject.html#8455">[ subject ]</a>
              <a href="author.html#8455">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
