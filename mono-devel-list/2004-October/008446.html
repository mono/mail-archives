<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] .NET Blog on performance.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20.NET%20Blog%20on%20performance.&In-Reply-To=1098553996.7484.513.camel%40linux.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008445.html">
   <LINK REL="Next"  HREF="008430.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] .NET Blog on performance.</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20.NET%20Blog%20on%20performance.&In-Reply-To=1098553996.7484.513.camel%40linux.site"
       TITLE="[Mono-devel-list] .NET Blog on performance.">bmaurer at ximian.com
       </A><BR>
    <I>Sat Oct 23 16:24:43 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008445.html">[Mono-devel-list] .NET Blog on performance.
</A></li>
        <LI>Next message: <A HREF="008430.html">[Mono-devel-list] TODOs in the HttpBrowserCapabilities Class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8446">[ date ]</a>
              <a href="thread.html#8446">[ thread ]</a>
              <a href="subject.html#8446">[ subject ]</a>
              <a href="author.html#8446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, 2004-10-23 at 13:53 -0400, Miguel de Icaza wrote:
&gt;<i> The other issue is that AOT code makes code slower, because the code
</I>&gt;<i> basically is &quot;shared&quot; so loads to static variables or static method
</I>&gt;<i> invocations have to be dereferenced and this might impact performance.
</I>
This is not correct.

What happens when you AOT code and it is used in multiple app domains
is:

- The code is compiled as it normally is for the jit. If you need to
(say) load a static field, we emit code like this:

0x10:   mov eax, 0x00000000 
0x15:   mov eax, [eax]

In the static data, we have information that looks basically like:

Offset   Patch type                    Patch data
0x15     PATCH_TYPE_STATIC_FIELD       0xdeadbeef

When the runtime needs to jit the method, it will see that we already
have the jitted data in the aot. The runtime will then look at the patch
table. It will see that the method has a patch at offset 0x10. When the
code is copied into memory, it will be copied as

0x10:   mov eax, 0xcafebabe
0x15:   mov eax, [eax]

So, the story for loading a static field (or calling a static method,
etc) is about the same as it was for the JIT story. The only difference
was the extra mov that we emitted. Today, this is one of the
disadvantages of aot -- we are not able to patch some patterns, say

mov eax, [0xcafebabe]

So, we resort to longer patterns mov eax, blah, mov eax, [eax]. It is
slightly sub-optimal, but not horrific.

In order to handle multiple appdomains, we make copy and patch the code
for each appdomain, just as code is jitted for each appdomain.

You can use mono -v -v -v --aot ... to see the code that is being
generated by aot.

(you can run mono -O=shared --aot to get the shared code. Of course this
will run sower, however it will not need to be loaded per-ad)

-- 
Ben Maurer &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008445.html">[Mono-devel-list] .NET Blog on performance.
</A></li>
	<LI>Next message: <A HREF="008430.html">[Mono-devel-list] TODOs in the HttpBrowserCapabilities Class
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8446">[ date ]</a>
              <a href="thread.html#8446">[ thread ]</a>
              <a href="subject.html#8446">[ subject ]</a>
              <a href="author.html#8446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
