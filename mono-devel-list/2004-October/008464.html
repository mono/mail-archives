<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] AMD64, PInvoke + Native Exceptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20AMD64%2C%20PInvoke%20%2B%20Native%20Exceptions&In-Reply-To=295e750a041024142510cfc68d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008540.html">
   <LINK REL="Next"  HREF="008470.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] AMD64, PInvoke + Native Exceptions</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20AMD64%2C%20PInvoke%20%2B%20Native%20Exceptions&In-Reply-To=295e750a041024142510cfc68d%40mail.gmail.com"
       TITLE="[Mono-devel-list] AMD64, PInvoke + Native Exceptions">bmaurer at ximian.com
       </A><BR>
    <I>Sun Oct 24 20:01:06 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008540.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
        <LI>Next message: <A HREF="008470.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8464">[ date ]</a>
              <a href="thread.html#8464">[ thread ]</a>
              <a href="subject.html#8464">[ subject ]</a>
              <a href="author.html#8464">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 2004-10-24 at 23:25 +0200, Zoltan Varga wrote:
&gt;<i> The SIGSEGV will be sent by the processor itself when %r15 is 0, and the
</I>&gt;<i> runtime will convert this to a NullReferenceException.
</I>&gt;<i> 
</I>&gt;<i> &gt;   35:   49 8b ff                mov    %r15,%rdi
</I>&gt;<i> &gt;   38:   49 83 3f 00             cmpq   $0x0,(%r15)
</I>&gt;<i> &gt;   3c:   49 bb 30 6b f0 96 2a    mov    $0x2a96f06b30,%r11
</I>&gt;<i> &gt;   43:   00 00 00
</I>&gt;<i> &gt;   46:   49 ff d3                callq  *%r11
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; By looking at the code above, it's pretty obvious that mono issues calls on
</I>&gt;<i> &gt; AMD64 by a &quot;mov IMM8, reg\n  call *reg&quot; opcode combination. You've a fixme
</I>&gt;<i> &gt; in the codegen header at this position IIRC: Does that mean you want to use
</I>&gt;<i> &gt; the IP-relative imm4 version, if the call target is in reach?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> This could be optimized but this is not done yet. Mostly because originally
</I>&gt;<i> methods make calls to trampolines which call back into the JIT to compile the
</I>&gt;<i> method, then the call site is patched to call the newly compiled method.
</I>Well, unless the code has already been compiled, in which case you could
make the call with whatever offset fits...

&gt;<i>  If the trampoline can be called with a 32 bit offset, but the newly compiled method
</I>&gt;<i> can't, then the call site can't be patched which could lead to perf problems.
</I>
It seems exceedingly unlikely that the new code would not land within
2gb of the old one.

Even if this happens, there is an easy way out. As soon as you hit the
first method where the call site can not be patched, change the
trampoline be code to jmp to the compiled method. This avoids the huge
overhead on every call. The only disadvantage is that you end up
executing a tad bit more code per call. However, this small, unlikely
cost is likely amortized by the savings in code space elsewhere.

-- 
Ben Maurer &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008540.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
	<LI>Next message: <A HREF="008470.html">[Mono-devel-list] AMD64, PInvoke + Native Exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8464">[ date ]</a>
              <a href="thread.html#8464">[ thread ]</a>
              <a href="subject.html#8464">[ subject ]</a>
              <a href="author.html#8464">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
