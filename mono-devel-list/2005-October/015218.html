<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Initial (bad) attempt at making MonoInst.klass	always meaningfu
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Initial%20%28bad%29%20attempt%20at%20making%20MonoInst.klass%0A%09always%20meaningfu&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015246.html">
   <LINK REL="Next"  HREF="015226.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Initial (bad) attempt at making MonoInst.klass	always meaningfu</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Initial%20%28bad%29%20attempt%20at%20making%20MonoInst.klass%0A%09always%20meaningfu&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Initial (bad) attempt at making MonoInst.klass	always meaningfu">massi at ximian.com
       </A><BR>
    <I>Thu Oct  6 10:02:55 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015246.html">[Mono-dev] Problem with asmx file
</A></li>
        <LI>Next message: <A HREF="015226.html">[Mono-dev] Mono structure of development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15218">[ date ]</a>
              <a href="thread.html#15218">[ thread ]</a>
              <a href="subject.html#15218">[ subject ]</a>
              <a href="author.html#15218">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hello,
this code is needed by type based alias analysis.

In this kind of analysis we need to know as precisely as possible
the class of every managed pointer that refers to an object (those
referring to value types are not relevant here).

In our IR, this kind of info is stored in the &quot;klass&quot; field of the
&quot;MonoInst&quot; struct.
However, this info is not properly maintained in the JIT.
This patch is an attempt to make that field accurate.

I am not ready to commit it because it has some problems, and I'm
seeking comments especially on the &quot;FIXMEMASSI&quot; issues.

One issue is really a trouble for me, and it is the one for which
(in debugging) I duplicated the &quot;type_from_stack_type&quot; function,
and introduced a silly &quot;type_from_stack_type_safe&quot; variant (which
in fact is just the original, unmodified &quot;type_from_stack_type&quot;).

In my patch I just wanted to modify the &quot;type_from_stack_type&quot;
function, making it more explicit in case of &quot;STACK_OBJ&quot; values.
This appeared to work, but introduced subtle regressions when
inlining was activated.
I tried to track the issue down, and verified that the problem is
related to the &quot;MonoInst&quot;s laying on the evaluation stack and
used as arguments when inlining.
Somehow, their &quot;klass&quot; is not OK, and when &quot;type_from_stack_type&quot;
uses it very strange things happen, which generally generate
failures in some g_assert (not the same in different tests).
The idea is that the generated IR is illegal, or corrupted, but
I still did not debug this fully (there are too many places in the
code that put &quot;MonoInst&quot;s on the evaluation stack).

What I *did* verify (and could be a clue to those who know more
than me) is that reverting my change in exactly two places (the
ones that now call the silly &quot;type_from_stack_type_safe&quot; function)
fully eliminates the regressions.

Please, those who have clues, share them ;-)

Ciao,
  Massi

-------------- next part --------------
A non-text attachment was scrubbed...
Name: meaningful-klass-value.patch
Type: text/x-patch
Size: 5097 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051006/e2bca727/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051006/e2bca727/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015246.html">[Mono-dev] Problem with asmx file
</A></li>
	<LI>Next message: <A HREF="015226.html">[Mono-dev] Mono structure of development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15218">[ date ]</a>
              <a href="thread.html#15218">[ thread ]</a>
              <a href="subject.html#15218">[ subject ]</a>
              <a href="author.html#15218">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
