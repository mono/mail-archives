<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Possible bug in Dictionary
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Possible%20bug%20in%20Dictionary&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015428.html">
   <LINK REL="Next"  HREF="015436.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Possible bug in Dictionary</H1>
    <B>Gustavo Guerra</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Possible%20bug%20in%20Dictionary&In-Reply-To="
       TITLE="[Mono-dev] Possible bug in Dictionary">gmcg at acm.org
       </A><BR>
    <I>Sat Oct 22 08:25:22 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015428.html">[Mono-dev] Re: [PATCH] ImageList: Simulate handle creation and add	2.0 members
</A></li>
        <LI>Next message: <A HREF="015436.html">[Mono-dev] PInvoke : argument passing by ref
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15435">[ date ]</a>
              <a href="thread.html#15435">[ thread ]</a>
              <a href="subject.html#15435">[ subject ]</a>
              <a href="author.html#15435">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

In the documentation is stated that the default constructor of 
Dictionary&lt;TKey, TValue&gt; will use EqualityComparer.Default, that will use 
the IEquatable interface if TKey implements it. That is not the case. If we 
set a breakpoint in the IEquatable&lt;TKey&gt;.Equals, it isn't called, and the 
Dictionary class seems to be basing its results on GetHashCode of TKey 
instances. This program:

public class A : IEquatable&lt;A&gt;
{
    private int _i;
    public A(int i) { _i = i; }
    bool IEquatable&lt;A&gt;.Equals(A other) { return _i.Equals(other._i); }

    public static void Main()
    {
        if (!EqualityComparer&lt;A&gt;.Default.Equals(new A(2), new A(2)))
            Console.WriteLine(&quot;BUG 1&quot;);
        Dictionary&lt;A, int&gt; d = new Dictionary&lt;A, int&gt;();
            A a = new A(2);
        d.Add(a, 3);
        int value;
        if (!d.TryGetValue(new A(2), out value))
            Console.WriteLine(&quot;BUG 2&quot;);
        if (!d.TryGetValue(a, out value))
            Console.WriteLine(&quot;BUG 3&quot;);
        d = new Dictionary&lt;A, int&gt;(new EqualityComparer&lt;A&gt;.Default);
        d.Add(a, 3);
        if (!d.TryGetValue(new A(2), out value))
            Console.WriteLine(&quot;BUG 4&quot;);
    }
}

Will print:
BUG2
BUG4

When it shouldn't print anything.
The problem seems to be not in EqualityComparer&lt;&gt;.Default but in Dictionary 
that doesn't use it.

Best regards,
Gustavo Guerra




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015428.html">[Mono-dev] Re: [PATCH] ImageList: Simulate handle creation and add	2.0 members
</A></li>
	<LI>Next message: <A HREF="015436.html">[Mono-dev] PInvoke : argument passing by ref
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15435">[ date ]</a>
              <a href="thread.html#15435">[ thread ]</a>
              <a href="subject.html#15435">[ subject ]</a>
              <a href="author.html#15435">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
