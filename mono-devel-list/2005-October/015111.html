<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Bug with your exception-optimization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Bug%20with%20your%20exception-optimization&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015181.html">
   <LINK REL="Next"  HREF="015114.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Bug with your exception-optimization</H1>
    <B>Hubert FONGARNAND</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Bug%20with%20your%20exception-optimization&In-Reply-To="
       TITLE="[Mono-dev] Bug with your exception-optimization">informatique.internet at fiducial.fr
       </A><BR>
    <I>Mon Oct  3 07:59:58 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015181.html">[Mono-dev] Arrays in a loop?
</A></li>
        <LI>Next message: <A HREF="015114.html">[Mono-dev] Bug with your exception-optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15111">[ date ]</a>
              <a href="thread.html#15111">[ thread ]</a>
              <a href="subject.html#15111">[ subject ]</a>
              <a href="author.html#15111">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
I've seen that your have commited an optimization in exception handling
in mini... Fri Sept 30...
I've found a very very nasty bug...

Try this test case :

 // project created on 03/10/2005 at 11:30
using System;
using System.Data;
using System.Data.OracleClient;


class MainClass
{



  private static void CreateDummy()
  {
   IDbConnection sqlCon = new OracleConnection(&quot;user id=hubert;data
source=10.69.100.181:1521/ORALINUX;password=cosmic&quot;);
   IDbCommand command = sqlCon.CreateCommand();
   command.Connection = sqlCon;
   sqlCon.Open();
   command.CommandText =
    @&quot; DROP TABLE INTRA_LANGUE CASCADE CONSTRAINTS&quot;;
    try{
   command.ExecuteNonQuery();
   }catch(Exception e)
   {}
   command.CommandText =
    @&quot; CREATE TABLE INTRA_LANGUE (LANGUE_CODE VARCHAR2(40) NOT
NULL,LANGUE VARCHAR2(100),	CONSTRAINT PK_INTRA_LANGUE PRIMARY KEY
(LANGUE_CODE))&quot;;
   command.ExecuteNonQuery();
   sqlCon.Close();
  }

public void checkexception(Exception e, IDbCommand command, string
stack)
{
	//Console.WriteLine(e.GetType().ToString());
	try
	{
		throw e;
	}
	catch (OracleException ee)
	{
		Console.WriteLine(&quot;OracleException :::&quot;+ee.Message);
		Console.WriteLine(&quot;Command text :&quot;+command.CommandText);
		foreach (IDataParameter param in command.Parameters)
		{
			Console.WriteLine(param.ParameterName);
			Console.WriteLine(param.Value.ToString());
		}

	}
}

  public void Test()
  {
   IDbCommand command=new OracleCommand();
   try
   {
   NSUniDataAccess.UniDataAccess.SetDb(&quot;Oracle&quot;);
   IDbConnection sqlCon =
NSUniDataAccess.UniDataAccess.GetConnection(&quot;user id=hubert;data
source=10.69.100.181:1521/ORALINUX;password=cosmic&quot;);
   command = sqlCon.CreateCommand();
   command.Connection = sqlCon;
   sqlCon.Open();
	OracleParameter p1 = new OracleParameter(&quot;param1&quot;,OracleType.VarChar);
	p1.Value = &quot;en&quot;;
	OracleParameter p2 = new OracleParameter(&quot;param2&quot;,OracleType.VarChar);
	p2.Value = &quot;english&quot;;
	command.Parameters.Add(p1);
	command.Parameters.Add(p2);
   	command.CommandText =
    @&quot; INSERT INTO INTRA_LANGUE (LANGUE_CODE,LANGUE)
VALUES(:param1,:param2)&quot;;
   command.ExecuteNonQuery();
   command.CommandText =
    @&quot; INSERT INTO INTRA_LANGUE (LANGUE_CODE,LANGUE)
VALUES(:param1,:param2)&quot;;
   // Should throw a Unique constraint exception...
   command.ExecuteNonQuery();
   sqlCon.Close();
   }
   catch(Exception e)
   {
	Console.WriteLine(&quot;oops : execption&quot;);
    checkexception(e,command,e.StackTrace);
   }
   return;
  }
	public static void Main(string[] args)
	{
		CreateDummy();
		Console.WriteLine(&quot;Hello World!&quot;);
		MainClass monprog=new MainClass();
		monprog.Test();
	}
}

With the last svn revision : i got as a result of this program:

Hello World!
oops : execption
OracleException :::ORA-00001: unique constraint (HUBERT.PK_INTRA_LANGUE)
violated

Command text : INSERT INTO INTRA_LANGUE (LANGUE_CODE,LANGUE)
VALUES(:param1,:param2)
param1
en

Unhandled Exception: System.NullReferenceException: Object reference not
set to an instance of an object
in [0x0006b] (at /home/hubert/Projects/ExceptionBug/Main.cs:47)
MainClass:checkexception (System.Exception e, IDbCommand command,
System.String stack)
in [0x000bf] (at /home/hubert/Projects/ExceptionBug/Main.cs:79)
MainClass:Test ()
in [0x00016] (at /home/hubert/Projects/ExceptionBug/Main.cs:88)
MainClass:Main (System.String[] args)

If I revert your changes : I get :
Hello World!
oops : execption
System.Data.OracleClient.OracleException
OracleException :::ORA-00001: unique constraint (HUBERT.PK_INTRA_LANGUE)
violated

Command text : INSERT INTO INTRA_LANGUE (LANGUE_CODE,LANGUE)
VALUES(:param1,:param2)
param1
en
param2
english


I dont't know exactly what's the underlying problem, but I know that
this regression is caused by your commit...

Thanks...
_______________________________________________
Ce message et les &#233;ventuels documents joints peuvent contenir des informations confidentielles.
Au cas o&#249; il ne vous serait pas destin&#233;, nous vous remercions de bien vouloir le supprimer et en aviser imm&#233;diatement l'exp&#233;diteur. Toute utilisation de ce message non conforme &#224; sa destination, toute diffusion ou publication, totale ou partielle et quel qu'en soit le moyen est formellement interdite.
Les communications sur internet n'&#233;tant pas s&#233;curis&#233;es, l'int&#233;grit&#233; de ce message n'est pas assur&#233;e et la soci&#233;t&#233; &#233;mettrice ne peut &#234;tre tenue pour responsable de son contenu.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051003/b69580f8/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051003/b69580f8/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015181.html">[Mono-dev] Arrays in a loop?
</A></li>
	<LI>Next message: <A HREF="015114.html">[Mono-dev] Bug with your exception-optimization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15111">[ date ]</a>
              <a href="thread.html#15111">[ thread ]</a>
              <a href="subject.html#15111">[ subject ]</a>
              <a href="author.html#15111">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
