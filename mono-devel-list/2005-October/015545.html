<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SIGSEGV%20in%20Cairo.CairoAPI%3Acairo_get/set_matrix%28%29&In-Reply-To=43667F79.4070008%40fastmail.fm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015543.html">
   <LINK REL="Next"  HREF="015548.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()</H1>
    <B>John Luke</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SIGSEGV%20in%20Cairo.CairoAPI%3Acairo_get/set_matrix%28%29&In-Reply-To=43667F79.4070008%40fastmail.fm"
       TITLE="[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()">john.luke at gmail.com
       </A><BR>
    <I>Mon Oct 31 16:26:56 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015543.html">[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()
</A></li>
        <LI>Next message: <A HREF="015548.html">[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15545">[ date ]</a>
              <a href="thread.html#15545">[ thread ]</a>
              <a href="subject.html#15545">[ subject ]</a>
              <a href="author.html#15545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,
I think ref is used in too many places.  Perhaps I am wrong, but at 
least for the set_* methods they won't be modifying it.
Maybe going through the cairo docs can help you decide to use 
out/ref/neither for each of those calls, if you didn't already.
For example, cairo_get_matrix looks like it should be out, and 
cairo_set_matrix looks like it should not be ref or out.

For the Matrix struct, the public fields should have the first letter 
capitalized.

The rest looks sane, but I haven't tested it.  Do any of the samples use 
these parts? and if so do they work with these changes?
Hope that helps.

Idan Gazit wrote:
&gt;<i> Ok, so attached is a patch covering the items I mention below.
</I>&gt;<i>
</I>&gt;<i> I expect somebody more experienced with Mono.Cairo should look this
</I>&gt;<i> over, I expect I'll have to make some changes. *nudging Hisham/JLuke*...
</I>&gt;<i>
</I>&gt;<i> Regarding the broken ref arguments, I filed:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=76603">http://bugzilla.ximian.com/show_bug.cgi?id=76603</A>
</I>&gt;<i>
</I>&gt;<i> in this regards.
</I>&gt;<i>
</I>&gt;<i> Should I break this patch up into two pieces, one to fix the ref issue
</I>&gt;<i> and one for everything else?
</I>&gt;<i>
</I>&gt;<i> -Idan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Idan Gazit wrote:
</I>&gt;<i>   
</I>&gt;&gt;<i> OK, So this email touches on Mono.Cairo in 3 parts:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. SIGSEGV
</I>&gt;&gt;<i> ==========
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OK, I got some help from Michael Dominic, who pointed out that
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cairo_get_matrix (IntPtr cr, Matrix_T matrix);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> should really be:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cairo_get_matrix (IntPtr cr, ref Matrix_T matrix);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It seems that any CairoAPI function which takes a matrix should pass a
</I>&gt;&gt;<i> ref Matrix_T and not a Matrix_T. This seems to include the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cairo_transform
</I>&gt;&gt;<i> cairo_get/set_matrix
</I>&gt;&gt;<i> cairo_set_font_matrix
</I>&gt;&gt;<i> cairo_pattern_get/set_matrix
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm preparing a patch to this effect.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Class Or Struct?
</I>&gt;&gt;<i> ===================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> About this time, lewing (in #mono) suggested that there's no point for
</I>&gt;&gt;<i> Matrix to be a class hiding a Matrix_T struct, rather make Matrix a
</I>&gt;&gt;<i> struct. So I went ahead and did this, and I'm testing it now (looks OK).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't know the reasons behind wrapping Matrix_T in a class, so can
</I>&gt;&gt;<i> somebody tell me (not sarcastic) why? If there are advantages to having
</I>&gt;&gt;<i> Matrix be a struct and doing away with Matrix_T then I have the patch
</I>&gt;&gt;<i> ready to go.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. Miscellaneous Design Improvements(?)
</I>&gt;&gt;<i> =======================================
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Either way to go (struct or class), I saw a few places where changes
</I>&gt;&gt;<i> seemed logical to me:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - &quot;Identify&quot; should be &quot;Identity&quot;
</I>&gt;&gt;<i> - Have Translate/Rotate/Scale et al return (this); so as to enable
</I>&gt;&gt;<i> things like myMatrix.Translate().Rotate().Scale().
</I>&gt;&gt;<i> - public static Matrix Identity property as an easy way of getting at
</I>&gt;&gt;<i> the identity matrix.
</I>&gt;&gt;<i> - No need for Pointer nor Raw properties in Matrix (they're not used
</I>&gt;&gt;<i> elsewhere...)?
</I>&gt;&gt;<i> - override Matrix.ToString () to produce something useful for debugging.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At any rate, all of these together constitutes a patch to Cairo.cs,
</I>&gt;&gt;<i> Graphics.cs, Matrix.cs, and Pattern.cs. I can make patches for each of
</I>&gt;&gt;<i> the three individually, or whatever.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please let me know how to proceed, I'd be very happy to put in my first
</I>&gt;&gt;<i> patch for mono. :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Idan
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Idan Gazit wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     
</I>&gt;&gt;&gt;<i> Hey,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So I manage to segfault when playing with the Graphics.Matrix
</I>&gt;&gt;&gt;<i> property. Basically anything that would result in a call to
</I>&gt;&gt;&gt;<i> cairo_get_matrix or cairo_set_matrix segfaults.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The stacktrace for this segfault when doing get is below, but
</I>&gt;&gt;&gt;<i> triggering it is pretty easy:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> // set up graphics here, then
</I>&gt;&gt;&gt;<i> System.Console.WriteLine(g.Matrix.ToString());
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> the same for set:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Cairo.Matrix transformMatrix = new Cairo.Matrix ();
</I>&gt;&gt;&gt;<i> transformMatrix.CreateIdentify ();
</I>&gt;&gt;&gt;<i> // set up graphics here, then
</I>&gt;&gt;&gt;<i> g.Matrix = transformMatrix;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Should I be talking to the cairo devs aobut this, instead?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -Idan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> =================================================================
</I>&gt;&gt;&gt;<i> Got a SIGSEGV while executing native code. This usually indicates
</I>&gt;&gt;&gt;<i> a fatal error in the mono runtime or one of the native libraries
</I>&gt;&gt;&gt;<i> used by your application.
</I>&gt;&gt;&gt;<i> =================================================================
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Stacktrace:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Native stacktrace:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> in &lt;0x4&gt; (wrapper managed-to-native) Cairo.CairoAPI:cairo_get_matrix
</I>&gt;&gt;&gt;<i> (intptr,Cairo.Matrix_T)
</I>&gt;&gt;&gt;<i> in &lt;0xffffffa1&gt; (wrapper managed-to-native)
</I>&gt;&gt;&gt;<i> Cairo.CairoAPI:cairo_get_matrix (intptr,Cairo.Matrix_T)
</I>&gt;&gt;&gt;<i> in &lt;0x49&gt; Cairo.Graphics:get_Matrix ()
</I>&gt;&gt;&gt;<i> in [0xc1] Meshwork.NetworkMap.ZoomableCairoArea:OnExposeEvent
</I>&gt;&gt;&gt;<i> (Gdk.EventExpose)
</I>&gt;&gt;&gt;<i> in [0x14] Gtk.Widget:exposeevent_cb (intptr,intptr)
</I>&gt;&gt;&gt;<i> in &lt;0x49cce3&gt; (wrapper native-to-managed) Gtk.Widget:exposeevent_cb
</I>&gt;&gt;&gt;<i> (intptr,intptr)
</I>&gt;&gt;&gt;<i> in &lt;0x4&gt; (wrapper managed-to-native) Gtk.Application:gtk_main ()
</I>&gt;&gt;&gt;<i> in &lt;0xffffffe7&gt; (wrapper managed-to-native) Gtk.Application:gtk_main ()
</I>&gt;&gt;&gt;<i> in [0x0] Gtk.Application:Run ()
</I>&gt;&gt;&gt;<i> in [0xb] MainClass:Main (string[])
</I>&gt;&gt;&gt;<i> in &lt;0x50bbe2f9&gt; (wrapper runtime-invoke)
</I>&gt;&gt;&gt;<i> System.Object:runtime_invoke_void_string[] (object,intptr,intptr,intptr)
</I>&gt;&gt;&gt;<i>     mono(mono_handle_native_sigsegv+0x73) [0x813d883]
</I>&gt;&gt;&gt;<i>     mono [0x81108db]
</I>&gt;&gt;&gt;<i>     [0xffffe440]
</I>&gt;&gt;&gt;<i>     /usr/lib/libcairo.so.2(cairo_get_matrix+0x1b) [0xb69343fb]
</I>&gt;&gt;&gt;<i>     [0xb67d4064]
</I>&gt;&gt;&gt;<i>     [0xb67d3fc2]
</I>&gt;&gt;&gt;<i>     [0xb67d0145]
</I>&gt;&gt;&gt;<i>     [0xb67cf725]
</I>&gt;&gt;&gt;<i>     [0xb67cf37e]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgtk-x11-2.0.so.0(_gtk_marshal_BOOLEAN__BOXED+0x58)
</I>&gt;&gt;&gt;<i> [0xb6c6c02c]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgobject-2.0.so.0(g_closure_invoke+0x11e) [0xb697b3a8]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgobject-2.0.so.0 [0xb6989c9f]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgobject-2.0.so.0(g_signal_emit_valist+0x41e) [0xb698aec3]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgobject-2.0.so.0(g_signal_emit+0x29) [0xb698b4c3]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgtk-x11-2.0.so.0 [0xb6d4e16f]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgtk-x11-2.0.so.0(gtk_main_do_event+0x4f7) [0xb6c6ad72]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgdk-x11-2.0.so.0 [0xb6ae6bfa]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgdk-x11-2.0.so.0(gdk_window_process_all_updates+0x95)
</I>&gt;&gt;&gt;<i> [0xb6ae6ccd]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgdk-x11-2.0.so.0 [0xb6ae6d4e]
</I>&gt;&gt;&gt;<i>     /usr/lib/libglib-2.0.so.0 [0xb7f0d750]
</I>&gt;&gt;&gt;<i>     /usr/lib/libglib-2.0.so.0(g_main_context_dispatch+0x1dc) [0xb7f0b4ee]
</I>&gt;&gt;&gt;<i>     /usr/lib/libglib-2.0.so.0 [0xb7f0e4f6]
</I>&gt;&gt;&gt;<i>     /usr/lib/libglib-2.0.so.0(g_main_loop_run+0x1a1) [0xb7f0e7e3]
</I>&gt;&gt;&gt;<i>     /usr/lib/libgtk-x11-2.0.so.0(gtk_main+0xb4) [0xb6c69e65]
</I>&gt;&gt;&gt;<i>     [0xb67cf6a1]
</I>&gt;&gt;&gt;<i>     [0xb67cf660]
</I>&gt;&gt;&gt;<i>     [0xb74d2f12]
</I>&gt;&gt;&gt;<i>     [0xb74d2813]
</I>&gt;&gt;&gt;<i>     mono(mono_runtime_exec_main+0x52) [0x8090ae2]
</I>&gt;&gt;&gt;<i>     mono(mono_runtime_run_main+0x12f) [0x80934ef]
</I>&gt;&gt;&gt;<i>     mono(mono_main+0xeff) [0x805d26f]
</I>&gt;&gt;&gt;<i>     /lib/tls/i686/cmov/libc.so.6(__libc_start_main+0xd2) [0xb7d7bea2]
</I>&gt;&gt;&gt;<i>     mono [0x805be11]
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;&gt;<i>       
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>     
</I>&gt;<i>
</I>&gt;<i>   
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> Index: Cairo.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- Cairo.cs	(revision 52380)
</I>&gt;<i> +++ Cairo.cs	(working copy)
</I>&gt;<i> @@ -110,12 +110,13 @@
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                
</I>&gt;<i>                  public static extern void cairo_rotate (IntPtr cr, double angle);
</I>&gt;<i> -
</I>&gt;<i> +		
</I>&gt;<i> +		// TODO out keyword necessary?
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern void cairo_transform (IntPtr cr, out Matrix_T matrix);
</I>&gt;<i> +                public static extern void cairo_transform (IntPtr cr, out Matrix matrix);
</I>&gt;<i>                  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern void cairo_set_matrix (IntPtr cr, Matrix_T matrix);
</I>&gt;<i> +                public static extern void cairo_set_matrix (IntPtr cr, ref Matrix matrix);
</I>&gt;<i>                  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i>                  public static extern void cairo_identity_matrix (IntPtr cr);
</I>&gt;<i> @@ -223,7 +224,7 @@
</I>&gt;<i>  		
</I>&gt;<i>  		[DllImport (CairoImp)]
</I>&gt;<i>                  public static extern void cairo_set_font_matrix (IntPtr cr,
</I>&gt;<i> -							     Matrix_T matrix);
</I>&gt;<i> +							    ref Matrix matrix);
</I>&gt;<i>  		
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i>                  public static extern void cairo_show_text (IntPtr cr, string utf8);
</I>&gt;<i> @@ -305,7 +306,7 @@
</I>&gt;<i>  		public static extern double cairo_get_miter_limit (IntPtr cr);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern void cairo_get_matrix (IntPtr cr, Matrix_T matrix);
</I>&gt;<i> +                public static extern void cairo_get_matrix (IntPtr cr, ref Matrix matrix);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i>                  public static extern IntPtr cairo_get_target (IntPtr cr);
</I>&gt;<i> @@ -382,52 +383,52 @@
</I>&gt;<i>                  //
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                
</I>&gt;<i> -                public static extern void cairo_matrix_init (ref Matrix_T matrix,
</I>&gt;<i> +                public static extern void cairo_matrix_init (ref Matrix matrix,
</I>&gt;<i>  		 double xx, double yx, double xy, double yy, double x0, double y0);
</I>&gt;<i>  		
</I>&gt;<i>  		[DllImport (CairoImp)]                
</I>&gt;<i> -                public static extern void cairo_matrix_init_translate (ref Matrix_T matrix,
</I>&gt;<i> +                public static extern void cairo_matrix_init_translate (ref Matrix matrix,
</I>&gt;<i>  							 double tx, double ty);
</I>&gt;<i>  		
</I>&gt;<i>  		[DllImport (CairoImp)]                
</I>&gt;<i> -                public static extern void cairo_matrix_translate (ref Matrix_T matrix,
</I>&gt;<i> +                public static extern void cairo_matrix_translate (ref Matrix matrix,
</I>&gt;<i>  							 double tx, double ty);
</I>&gt;<i>  		
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern void cairo_matrix_init_identity (ref Matrix_T matrix);
</I>&gt;<i> +                public static extern void cairo_matrix_init_identity (ref Matrix matrix);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                
</I>&gt;<i> -                public static extern void cairo_matrix_init_scale (ref Matrix_T matrix,
</I>&gt;<i> +                public static extern void cairo_matrix_init_scale (ref Matrix matrix,
</I>&gt;<i>  								   double sx, 
</I>&gt;<i>  								   double sy);
</I>&gt;<i>  		
</I>&gt;<i>                  [DllImport (CairoImp)]                
</I>&gt;<i> -                public static extern void cairo_matrix_scale (ref Matrix_T matrix,
</I>&gt;<i> +                public static extern void cairo_matrix_scale (ref Matrix matrix,
</I>&gt;<i>  								   double sx, 
</I>&gt;<i>  								   double sy);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i>                  public static extern void cairo_matrix_init_rotate (
</I>&gt;<i> -                        ref Matrix_T matrix, double radians);		
</I>&gt;<i> +                        ref Matrix matrix, double radians);		
</I>&gt;<i>  		
</I>&gt;<i>                  [DllImport (CairoImp)]                                
</I>&gt;<i>                  public static extern void cairo_matrix_rotate (
</I>&gt;<i> -                        ref Matrix_T matrix, double radians);
</I>&gt;<i> +                        ref Matrix matrix, double radians);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                                
</I>&gt;<i> -                public static extern Cairo.Status cairo_matrix_invert (ref Matrix_T matrix);
</I>&gt;<i> +                public static extern Cairo.Status cairo_matrix_invert (ref Matrix matrix);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                                
</I>&gt;<i>                  public static extern void cairo_matrix_multiply (
</I>&gt;<i> -                        ref Matrix_T result, ref Matrix_T a, ref Matrix_T b);
</I>&gt;<i> +                        ref Matrix result, ref Matrix a, ref Matrix b);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                                
</I>&gt;<i>                  public static extern void cairo_matrix_transform_distance (
</I>&gt;<i> -                        ref Matrix_T matrix, ref double dx, ref double dy);
</I>&gt;<i> +                        ref Matrix matrix, ref double dx, ref double dy);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]                                
</I>&gt;<i>                  public static extern void cairo_matrix_transform_point (
</I>&gt;<i> -                        ref Matrix_T matrix, ref double x, ref double y);
</I>&gt;<i> +                        ref Matrix matrix, ref double x, ref double y);
</I>&gt;<i>  
</I>&gt;<i>                  //
</I>&gt;<i>                  // Pattern functions
</I>&gt;<i> @@ -469,10 +470,10 @@
</I>&gt;<i>  		        double offset, double red, double green, double blue);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern Status cairo_pattern_set_matrix (IntPtr pattern, IntPtr matrix);
</I>&gt;<i> +                public static extern Status cairo_pattern_set_matrix (IntPtr pattern, ref Matrix matrix);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i> -                public static extern Status cairo_pattern_get_matrix (IntPtr pattern, IntPtr matrix);
</I>&gt;<i> +                public static extern Status cairo_pattern_get_matrix (IntPtr pattern, ref Matrix matrix);
</I>&gt;<i>  
</I>&gt;<i>                  [DllImport (CairoImp)]
</I>&gt;<i>                  public static extern Status cairo_pattern_set_extend (IntPtr pattern, Extend extend);
</I>&gt;<i> Index: Pattern.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- Pattern.cs	(revision 52380)
</I>&gt;<i> +++ Pattern.cs	(working copy)
</I>&gt;<i> @@ -132,17 +132,13 @@
</I>&gt;<i>                  public Matrix Matrix {
</I>&gt;<i>                          set { 
</I>&gt;<i>  				CairoAPI.cairo_pattern_set_matrix (pattern,
</I>&gt;<i> -								   value.Raw);
</I>&gt;<i> +								   ref value);
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i>                          get {
</I>&gt;<i> -				Matrix_T matrix = new Matrix_T ();				
</I>&gt;<i> -				IntPtr p = Marshal.AllocCoTaskMem ( Marshal.SizeOf (matrix));
</I>&gt;<i> -				Marshal.StructureToPtr (matrix, p, true);
</I>&gt;<i> -				CairoAPI.cairo_pattern_get_matrix (pattern, p);
</I>&gt;<i> -				matrix = (Matrix_T)Marshal.PtrToStructure(p, typeof(Matrix_T));
</I>&gt;<i> -				Marshal.FreeCoTaskMem (p);
</I>&gt;<i> -				return new Cairo.Matrix (matrix);
</I>&gt;<i> +				Matrix m = new Matrix ();
</I>&gt;<i> +				CairoAPI.cairo_pattern_get_matrix (pattern, ref m);
</I>&gt;<i> +				return m;
</I>&gt;<i>                          }
</I>&gt;<i>                  }
</I>&gt;<i>  
</I>&gt;<i> Index: Graphics.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- Graphics.cs	(revision 52380)
</I>&gt;<i> +++ Graphics.cs	(working copy)
</I>&gt;<i> @@ -527,13 +527,13 @@
</I>&gt;<i>  		
</I>&gt;<i>                  public Cairo.Matrix Matrix {
</I>&gt;<i>                          set {
</I>&gt;<i> -                                CairoAPI.cairo_set_matrix (state, value.Pointer);
</I>&gt;<i> +                                CairoAPI.cairo_set_matrix (state, ref value);
</I>&gt;<i>                          }
</I>&gt;<i>  
</I>&gt;<i>                          get {
</I>&gt;<i> -				Matrix_T m = new Matrix_T ();
</I>&gt;<i> -				CairoAPI.cairo_get_matrix (state, m);
</I>&gt;<i> -                                return new Matrix (m);
</I>&gt;<i> +				Matrix m = new Matrix ();
</I>&gt;<i> +				CairoAPI.cairo_get_matrix (state, ref m);
</I>&gt;<i> +                                return m;
</I>&gt;<i>                          }
</I>&gt;<i>                  }
</I>&gt;<i>  		/*
</I>&gt;<i> @@ -560,7 +560,7 @@
</I>&gt;<i>  		
</I>&gt;<i>  		public void FontSetMatrix (Matrix m)
</I>&gt;<i>  		{
</I>&gt;<i> -			CairoAPI.cairo_set_font_matrix (state, m.Pointer);
</I>&gt;<i> +			CairoAPI.cairo_set_font_matrix (state, ref m);
</I>&gt;<i>  		}
</I>&gt;<i>                  
</I>&gt;<i>  		/*
</I>&gt;<i> Index: Matrix.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- Matrix.cs	(revision 52380)
</I>&gt;<i> +++ Matrix.cs	(working copy)
</I>&gt;<i> @@ -33,118 +33,108 @@
</I>&gt;<i>  using System.Runtime.InteropServices;
</I>&gt;<i>  
</I>&gt;<i>  namespace Cairo {
</I>&gt;<i> -   
</I>&gt;<i> -                  
</I>&gt;<i> -   [StructLayout(LayoutKind.Sequential)]
</I>&gt;<i> -   internal struct Matrix_T
</I>&gt;<i> -   {
</I>&gt;<i> -	   public double xx; 
</I>&gt;<i> -	   public double yx;
</I>&gt;<i> -	   public double xy; 
</I>&gt;<i> -	   public double yy;
</I>&gt;<i> -	   public double x0; 
</I>&gt;<i> -	   public double y0;	   
</I>&gt;<i> -   }
</I>&gt;<i> -   
</I>&gt;<i> -   
</I>&gt;<i> -   
</I>&gt;<i> -        public class Matrix
</I>&gt;<i> +
</I>&gt;<i> +   	[StructLayout(LayoutKind.Sequential)]
</I>&gt;<i> +        public struct Matrix
</I>&gt;<i>          {		
</I>&gt;<i> -		internal Matrix_T matrix;
</I>&gt;<i> -		
</I>&gt;<i> -                public Matrix ()       
</I>&gt;<i> +		public double xx;
</I>&gt;<i> +		public double yx;
</I>&gt;<i> +		public double xy; 
</I>&gt;<i> +		public double yy;
</I>&gt;<i> +		public double x0; 
</I>&gt;<i> +		public double y0;	
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> +                public Matrix (double xx, double yx, double xy, double yy,
</I>&gt;<i> +				  double x0, double y0)
</I>&gt;<i>                  {               
</I>&gt;<i> -			//CreateIdentify();
</I>&gt;<i> +			this.xx = xx; this.yx = yx; this.xy = xy;
</I>&gt;<i> +			this.yy = yy; this.x0 = x0; this.y0 = y0;
</I>&gt;<i>                  }
</I>&gt;<i> -		
</I>&gt;<i> -                internal Matrix (Matrix_T ptr)
</I>&gt;<i> -                {
</I>&gt;<i> -                        //if (ptr == null)
</I>&gt;<i> -			//  CreateIdentify ();
</I>&gt;<i> -			
</I>&gt;<i> -                        matrix = ptr;
</I>&gt;<i> -                }
</I>&gt;<i> -		
</I>&gt;<i> -                public void CreateIdentify ()
</I>&gt;<i> +
</I>&gt;<i> +		public static Matrix Identity {
</I>&gt;<i> +			get {
</I>&gt;<i> +				Matrix identity = new Matrix ();
</I>&gt;<i> +				identity.InitIdentity();
</I>&gt;<i> +				return identity;
</I>&gt;<i> +			}
</I>&gt;<i> +		}
</I>&gt;<i> +				
</I>&gt;<i> +                public void InitIdentity ()
</I>&gt;<i>                  {			
</I>&gt;<i> -			CairoAPI.cairo_matrix_init_identity (ref matrix);
</I>&gt;<i> +			CairoAPI.cairo_matrix_init_identity (ref this);
</I>&gt;<i>                  }
</I>&gt;<i>  		
</I>&gt;<i> -		public void Init (double xx, double yx, double xy, double yy,
</I>&gt;<i> +		public Matrix Init (double xx, double yx, double xy, double yy,
</I>&gt;<i>  				  double x0, double y0)
</I>&gt;<i>  		{
</I>&gt;<i> -			matrix.xx = xx; matrix.yx = yx; matrix.xy = xy;
</I>&gt;<i> -			matrix.yy = yy; matrix.x0 = x0; matrix.y0 = y0;
</I>&gt;<i> +			this.xx = xx; this.yx = yx; this.xy = xy;
</I>&gt;<i> +			this.yy = yy; this.x0 = x0; this.y0 = y0;
</I>&gt;<i> +			return this;
</I>&gt;<i>  		}
</I>&gt;<i>  		
</I>&gt;<i> -		public void InitTranslate (double tx, double ty)
</I>&gt;<i> +		public Matrix InitTranslate (double tx, double ty)
</I>&gt;<i>  		{		
</I>&gt;<i> -			CairoAPI.cairo_matrix_init_translate (ref matrix, tx, ty);
</I>&gt;<i> +			CairoAPI.cairo_matrix_init_translate (ref this, tx, ty);
</I>&gt;<i> +			return this;
</I>&gt;<i>  		}		
</I>&gt;<i>  		  			       
</I>&gt;<i> -		public void Translate (double tx, double ty)
</I>&gt;<i> +		public Matrix Translate (double tx, double ty)
</I>&gt;<i>  		{
</I>&gt;<i> -			CairoAPI.cairo_matrix_translate (ref matrix, tx, ty);
</I>&gt;<i> +			CairoAPI.cairo_matrix_translate (ref this, tx, ty);
</I>&gt;<i> +			return this;
</I>&gt;<i>  		}
</I>&gt;<i>  		
</I>&gt;<i> -                public void InitScale (double sx, double sy)
</I>&gt;<i> +                public Matrix InitScale (double sx, double sy)
</I>&gt;<i>                  {
</I>&gt;<i> -			CairoAPI.cairo_matrix_init_scale (ref matrix, sx, sy);
</I>&gt;<i> +			CairoAPI.cairo_matrix_init_scale (ref this, sx, sy);
</I>&gt;<i> +			return this;
</I>&gt;<i>                  }		
</I>&gt;<i>  		
</I>&gt;<i> -                public void Scale (double sx, double sy)
</I>&gt;<i> +                public Matrix Scale (double sx, double sy)
</I>&gt;<i>                  {
</I>&gt;<i> -			CairoAPI.cairo_matrix_scale (ref matrix, sx, sy);
</I>&gt;<i> +			CairoAPI.cairo_matrix_scale (ref this, sx, sy);
</I>&gt;<i> +			return this;
</I>&gt;<i>                  }
</I>&gt;<i>  
</I>&gt;<i> -                public void InitRotate (double radians)
</I>&gt;<i> +                public Matrix InitRotate (double radians)
</I>&gt;<i>                  {
</I>&gt;<i> -			CairoAPI.cairo_matrix_init_rotate (ref matrix, radians);
</I>&gt;<i> +			CairoAPI.cairo_matrix_init_rotate (ref this, radians);
</I>&gt;<i> +			return this;
</I>&gt;<i>                  }		
</I>&gt;<i>  		
</I>&gt;<i> -                public void Rotate (double radians)
</I>&gt;<i> +                public Matrix Rotate (double radians)
</I>&gt;<i>                  {
</I>&gt;<i> -			CairoAPI.cairo_matrix_rotate (ref matrix, radians);
</I>&gt;<i> +			CairoAPI.cairo_matrix_rotate (ref this, radians);
</I>&gt;<i> +			return this;
</I>&gt;<i>                  }
</I>&gt;<i>  
</I>&gt;<i>                  public Cairo.Status Invert ()
</I>&gt;<i>                  {
</I>&gt;<i> -			return  CairoAPI.cairo_matrix_invert (ref matrix);
</I>&gt;<i> +			return CairoAPI.cairo_matrix_invert (ref this);
</I>&gt;<i>                  }
</I>&gt;<i>  
</I>&gt;<i> -
</I>&gt;<i> -                public static void Multiply (ref Cairo.Matrix res, 
</I>&gt;<i> -					 ref Cairo.Matrix a, ref Cairo.Matrix b)
</I>&gt;<i> -                {	
</I>&gt;<i> -			if (res == null)
</I>&gt;<i> -			  res = new Matrix ();
</I>&gt;<i> -						
</I>&gt;<i> -                        CairoAPI.cairo_matrix_multiply (ref res.matrix, 
</I>&gt;<i> -							ref a.matrix, 
</I>&gt;<i> -							ref b.matrix);
</I>&gt;<i> -                }
</I>&gt;<i> +		public Matrix Multiply (ref Cairo.Matrix b) {
</I>&gt;<i> +			Matrix result = new Matrix ();
</I>&gt;<i> +			CairoAPI.cairo_matrix_multiply (ref result, ref this, ref b);
</I>&gt;<i> +			return (result);
</I>&gt;<i> +		}
</I>&gt;<i>  		
</I>&gt;<i>                  public void TransformDistance (ref double dx, ref double dy)
</I>&gt;<i>                  {
</I>&gt;<i> -                        CairoAPI.cairo_matrix_transform_distance (ref matrix, ref dx, ref dy);
</I>&gt;<i> +                        CairoAPI.cairo_matrix_transform_distance (ref this, ref dx, ref dy);
</I>&gt;<i>                  }
</I>&gt;<i>  
</I>&gt;<i>                  public void TransformPoint (ref double x, ref double y)
</I>&gt;<i>                  {
</I>&gt;<i> -                        CairoAPI.cairo_matrix_transform_point (ref matrix, ref x, ref y);
</I>&gt;<i> +                        CairoAPI.cairo_matrix_transform_point (ref this, ref x, ref y);
</I>&gt;<i>  		}
</I>&gt;<i> -		
</I>&gt;<i> -                internal Matrix_T Pointer {
</I>&gt;<i> -                        get { return matrix; }
</I>&gt;<i> -			set { matrix = value; }
</I>&gt;<i> -                }
</I>&gt;<i> -		
</I>&gt;<i> -		public IntPtr Raw {
</I>&gt;<i> -			get {
</I>&gt;<i> -				IntPtr p = Marshal.AllocCoTaskMem ( Marshal.SizeOf (matrix));
</I>&gt;<i> -				Marshal.StructureToPtr (matrix, p, true);
</I>&gt;<i> -				return p;
</I>&gt;<i> -			}
</I>&gt;<i> +
</I>&gt;<i> +		public override String ToString ()
</I>&gt;<i> +		{
</I>&gt;<i> +			String s = String.Format (&quot;xx:{0:##0.0#} xy:{1:##0.0#} yy:{2:##0.0#} yx:{3:##0.0#} x0:{4:##0.0#} y0:{5:##0.0#}&quot;,
</I>&gt;<i> +				this.xx, this.xy, this.yy, this.yx, this.x0, this.y0);
</I>&gt;<i> +			return s;
</I>&gt;<i>  		}
</I>&gt;<i>  				
</I>&gt;<i>          }
</I>&gt;<i>   
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>   
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015543.html">[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()
</A></li>
	<LI>Next message: <A HREF="015548.html">[Mono-dev] SIGSEGV in Cairo.CairoAPI:cairo_get/set_matrix()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15545">[ date ]</a>
              <a href="thread.html#15545">[ thread ]</a>
              <a href="subject.html#15545">[ subject ]</a>
              <a href="author.html#15545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
