<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Proposal: Library Loading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Proposal%3A%20Library%20Loading&In-Reply-To=1081920709.4105.1666.camel%40erandi.boston.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004996.html">
   <LINK REL="Next"  HREF="004997.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Proposal: Library Loading</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Proposal%3A%20Library%20Loading&In-Reply-To=1081920709.4105.1666.camel%40erandi.boston.ximian.com"
       TITLE="[Mono-devel-list] Proposal: Library Loading">jonpryor at vt.edu
       </A><BR>
    <I>Wed Apr 14 07:53:29 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004996.html">[Mono-devel-list] Proposal: Library Loading
</A></li>
        <LI>Next message: <A HREF="004997.html">[Mono-devel-list] Proposal: Library Loading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4991">[ date ]</a>
              <a href="thread.html#4991">[ thread ]</a>
              <a href="subject.html#4991">[ subject ]</a>
              <a href="author.html#4991">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 2004-04-14 at 01:31, Miguel de Icaza wrote:
&gt;<i> Hello,
</I>&lt;snip/&gt;
&gt;<i> Am sorry we missed each other on irc.  
</I>
Me too.

&gt;<i> The idea we are thinking about is a bit simpler than the proposed solution.  
</I>&gt;<i> 
</I>&gt;<i> Every library provider that needs DllImport functionality needs to
</I>&gt;<i> install in $sysconfdir/mono/ a file with the extension .libmap.
</I>
I don't think this will work as-is.  I'll detail below.

&gt;<i> For example, Gtk# would install something like this:
</I>&gt;<i> 
</I>&gt;<i> &lt;configuration&gt;
</I>&gt;<i> 	&lt;dllmap dll=&quot;libglib-2.0-0.dll&quot; target=&quot;libglib-2.0.so.0.200.3&quot; /&gt;
</I>&gt;<i> &lt;/configuration&gt;
</I>&gt;<i> 
</I>&gt;<i> Notice that the full version for the .so file is specified on the
</I>&gt;<i> .libmap file.
</I>
And this is the problem: the full version is specified.  If no further
intelligence is present, then I won't be able to use Gtk# anymore, as I
have libglib-2.0.so.0.200.2 installed.  Since the version numbers don't
match exactly (and mine has a lower patch number), dlopen(3) won't be
able to find the library, so I won't be able to run my programs anymore.

I think this is also brittle in the face of change: if GLib 2.2.4 came
out tomorrow (with a full version of libglib-2.0.so.0.200.4) and was
installed on the users machine (yay Red Carpet!), the version number
would no longer match exactly, and dlopen(3) would not be able to find
the new library.

Consequently, previously working apps would no longer work, &quot;just
because&quot; the user upgraded their GLib installation.

I don't think it would be acceptable to require that GLib (1) know about
Mono, and (2) keep Mono up-to-date about which version is installed.

This is why whatever solution Mono uses *must* be intelligent enough to
search for compatible versions: if the major.minor version doesn't
exist, fall-back and try the major version.  If that doesn't exist, try
it without a version.  If that doesn't exist, throw an exception.

&gt;<i> Now, to install the libmap file a program must be invoked, this program
</I>&gt;<i> is responsible for copying the .libmap file into the $syconfdir
</I>&gt;<i> directory, and generate a fresh $sysconfdir/mono/config
</I>&gt;<i> 
</I>&gt;<i> So something like to install:
</I>&gt;<i> 
</I>&gt;<i> 	mlibconf -i gtk-sharp.libmap
</I>&gt;<i> 
</I>&gt;<i> And to remove:
</I>&gt;<i> 
</I>&gt;<i> 	mlibconf -e gtk-sharp.libmap
</I>
I forget who originally mentioned it, but I don't think the distributors
will like the requirement to run a tool during the postinstall step. 
Then again, it needs to be done for the GAC anyway, so maybe this isn't
so bad.

&gt;<i> The benefit is that Mono only needs to open *one* configuration file
</I>&gt;<i> instead of having to get a directory listing, and load multiple files,
</I>&gt;<i> which impacts startup time. 
</I>
Pardon my ignorance, but is the config file *really* needed at program
startup?  I thought it was only needed when DllImport statements were
used.

If that's the case (and I hope it is), then it would only impact the
startup time of programs that used DllImport, not all programs (just
many of them ;-), and the config directory could be lazy initialized on
the first load of a native library.

Michal Moskal already noted that the directory reading might not be that
slow, anyway.  Guess we'd have to test it.

 - Jon



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004996.html">[Mono-devel-list] Proposal: Library Loading
</A></li>
	<LI>Next message: <A HREF="004997.html">[Mono-devel-list] Proposal: Library Loading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4991">[ date ]</a>
              <a href="thread.html#4991">[ thread ]</a>
              <a href="subject.html#4991">[ subject ]</a>
              <a href="author.html#4991">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
