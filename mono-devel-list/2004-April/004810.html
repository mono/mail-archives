<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] updated gac patches
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20updated%20gac%20patches&In-Reply-To=1080821637.2605.33.camel%40atreyu.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004803.html">
   <LINK REL="Next"  HREF="004806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] updated gac patches</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20updated%20gac%20patches&In-Reply-To=1080821637.2605.33.camel%40atreyu.localdomain"
       TITLE="[Mono-devel-list] updated gac patches">lupus at ximian.com
       </A><BR>
    <I>Thu Apr  1 12:14:35 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004803.html">[Mono-devel-list] updated gac patches
</A></li>
        <LI>Next message: <A HREF="004806.html">[Mono-devel-list] reflection.c patch to set culture and flags for asmb references
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4810">[ date ]</a>
              <a href="thread.html#4810">[ thread ]</a>
              <a href="subject.html#4810">[ subject ]</a>
              <a href="author.html#4810">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/01/04 Jackson Harper wrote:
&gt;<i> --- metadata/appdomain.c	28 Mar 2004 16:15:17 -0000	1.122
</I>&gt;<i> +++ metadata/appdomain.c	1 Apr 2004 11:35:16 -0000
</I>&gt;<i> @@ -751,6 +751,7 @@
</I>&gt;<i>  	g_free ((void *) aname-&gt;name);
</I>&gt;<i>  	g_free ((void *) aname-&gt;culture);
</I>&gt;<i>  	g_free ((void *) aname-&gt;hash_value);
</I>&gt;<i> +	g_free ((void *) aname-&gt;public_tok_value);
</I>[...]
&gt;<i> +				aname-&gt;public_tok_value = g_strstrip (g_strdup (value));
</I>
g_strstrip () can return a pointer that is not the beginning of the
alloced area, so calling g_free () on it later will make it crash (bug
was there before as well). Also I'm not sure what the code did before
here and why we don't need it anymore. Care to explain?

&gt;<i> --- metadata/assembly.c	1 Apr 2004 09:12:05 -0000	1.86
</I>&gt;<i> +++ metadata/assembly.c	1 Apr 2004 11:35:16 -0000
</I>&gt;<i> @@ -22,8 +22,11 @@
</I>[...]
&gt;<i> +gboolean allow_user_gac = FALSE;
</I>
Make static.

&gt;<i> +static gchar*
</I>&gt;<i> +encode_public_tok (const guchar *token, gint32 len)
</I>&gt;<i> +{
</I>&gt;<i> +	static gchar allowed [] = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f' };
</I>&gt;<i> +	gchar *res;
</I>&gt;<i> +	int i;
</I>&gt;<i> +
</I>&gt;<i> +	res = g_malloc (len * 2);
</I>&gt;<i> +	for (i = 0; i &lt; len; i++) {
</I>&gt;<i> +		res [i * 2] = allowed [token [i] &gt;&gt; 4];
</I>&gt;<i> +		res [i * 2 + 1] = allowed [token [i] &amp; 0xF];
</I>&gt;<i> +	}
</I>&gt;<i> +	res [len * 2] = 0;
</I>
Classic buffer overflow with malloced C strings. You need to alloc one
more byte.

&gt;<i> @@ -615,12 +662,12 @@
</I>&gt;<i>  mono_assembly_load (MonoAssemblyName *aname, const char *basedir, MonoImageOpenStatus *status)
</I>&gt;<i>  {
</I>&gt;<i>  	MonoAssembly *result;
</I>&gt;<i> -	char *fullpath, *filename;
</I>&gt;<i> +	char *fullpath, *filename, *asmbname;
</I>&gt;<i> +	int len;
</I>&gt;<i>  
</I>&gt;<i>  	result = invoke_assembly_preload_hook (aname, assemblies_path);
</I>&gt;<i>  	if (result)
</I>&gt;<i>  		return result;
</I>&gt;<i> -
</I>&gt;<i>  	/* g_print (&quot;loading %s\n&quot;, aname-&gt;name); */
</I>&gt;<i>  	/* special case corlib */
</I>&gt;<i>  	if ((strcmp (aname-&gt;name, &quot;mscorlib&quot;) == 0) || (strcmp (aname-&gt;name, &quot;corlib&quot;) == 0)) {
</I>&gt;<i> @@ -645,29 +692,71 @@
</I>&gt;<i>  	result = search_loaded (aname);
</I>&gt;<i>  	if (result)
</I>&gt;<i>  		return result;
</I>&gt;<i> +
</I>&gt;<i>  	/* g_print (&quot;%s not found in cache\n&quot;, aname-&gt;name); */
</I>&gt;<i> -	if (strstr (aname-&gt;name, &quot;.dll&quot;))
</I>&gt;<i> +	if (strstr (aname-&gt;name, &quot;.dll&quot;)) {
</I>&gt;<i>  		filename = g_strdup (aname-&gt;name);
</I>&gt;<i> -	else
</I>&gt;<i> +		len = strlen (filename) - 4;
</I>&gt;<i> +		asmbname = malloc (len);
</I>&gt;<i> +		strncpy (asmbname, aname-&gt;name, len);
</I>&gt;<i> +	} else {
</I>&gt;<i>  		filename = g_strconcat (aname-&gt;name, &quot;.dll&quot;, NULL);
</I>&gt;<i> +		asmbname = g_strdup (aname-&gt;name);
</I>&gt;<i> +	}
</I>&gt;<i>  	if (basedir) {
</I>&gt;<i>  		fullpath = g_build_filename (basedir, filename, NULL);
</I>&gt;<i>  		result = mono_assembly_open (fullpath, status);
</I>&gt;<i>  		g_free (fullpath);
</I>&gt;<i>  		if (result) {
</I>&gt;<i> +			result-&gt;in_gac = FALSE;
</I>&gt;<i> +			g_free (filename);
</I>&gt;<i> +			g_free (asmbname);
</I>&gt;<i> +			return result;
</I>&gt;<i> +		}
</I>&gt;<i> +	}
</I>&gt;<i> +	/* try the gac */
</I>&gt;<i> +	if (aname-&gt;public_tok_value) {
</I>
I think the rule in the MS runtime is to look in the GAC first, before
checking in the dir where the referencing assembly is located.

&gt;<i> +		gchar *version;
</I>&gt;<i> +		version = g_strdup_printf (&quot;%d.%d.%d.%d_%s_%s&quot;, aname-&gt;major,
</I>&gt;<i> +				aname-&gt;minor, aname-&gt;build, aname-&gt;revision,
</I>&gt;<i> +				aname-&gt;culture, aname-&gt;public_tok_value);
</I>&gt;<i> +
</I>&gt;<i> +		fullpath = g_build_path (G_DIR_SEPARATOR_S, MONO_ASSEMBLIES, &quot;mono&quot;, &quot;gac&quot;,
</I>&gt;<i> +				asmbname, version, filename, NULL);
</I>&gt;<i> +		result = mono_assembly_open (fullpath, status);
</I>&gt;<i> +
</I>&gt;<i> +		g_free (fullpath);
</I>&gt;<i> +
</I>&gt;<i> +		if (!result &amp;&amp; allow_user_gac &amp;&amp; getenv (&quot;HOME&quot;)) {
</I>&gt;<i> +			fullpath = g_build_path (G_DIR_SEPARATOR_S, getenv (&quot;HOME&quot;), &quot;.mono&quot;, &quot;gac&quot;,
</I>&gt;<i> +					asmbname, version, filename, NULL);
</I>&gt;<i> +			result = mono_assembly_open (fullpath, status);
</I>&gt;<i> +			g_free (fullpath);
</I>&gt;<i> +		}
</I>
It might be worth to have two helper functions (or one) to just do the
lookup in the GAC (ie pull this code outside this function). Also, in
mono we use the GLib function g_get_home_dir () instead of getenv (&quot;HOME&quot;).

Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004803.html">[Mono-devel-list] updated gac patches
</A></li>
	<LI>Next message: <A HREF="004806.html">[Mono-devel-list] reflection.c patch to set culture and flags for asmb references
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4810">[ date ]</a>
              <a href="thread.html#4810">[ thread ]</a>
              <a href="subject.html#4810">[ subject ]</a>
              <a href="author.html#4810">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
