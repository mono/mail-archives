<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Patch for System.Timespan
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20System.Timespan&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005029.html">
   <LINK REL="Next"  HREF="005031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Patch for System.Timespan</H1>
    <B>Andreas Nahr</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20System.Timespan&In-Reply-To="
       TITLE="[Mono-devel-list] Patch for System.Timespan">ClassDevelopment at A-SoftTech.com
       </A><BR>
    <I>Sat Apr 17 04:43:26 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="005029.html">[Mono-devel-list] Patch for System.Timespan
</A></li>
        <LI>Next message: <A HREF="005031.html">[Mono-devel-list] Patch for System.Timespan
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5030">[ date ]</a>
              <a href="thread.html#5030">[ thread ]</a>
              <a href="subject.html#5030">[ subject ]</a>
              <a href="author.html#5030">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

comments in text

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> Ok, a few general comments:
</I>&gt;<i>       * You have no changelog. As such, I have a very hard time guessing
</I>&gt;<i>         what you tried to do. Please include a detailed changelog
</I>&gt;<i>         stating the improvements in each class.
</I>
Sorry, forgot that one. However it isn't much more detailed that the mailing
was. As I wrote this was basically a reimplementation. I started from
scratch and copied things over that I felt were ok (weren't really a lot)

This is a (probably not complete) list of content changes (no stylings):
public TimeSpan (int hours, int minutes, int seconds): Perf+, better called
method
public TimeSpan (int days, int hours, int minutes, int seconds): Perf+, same
public TimeSpan (int days, int hours, int minutes, int seconds, int
milliseconds): Perf+, Own impl., BugFix: thows correct and elaborate
exception
private TimeSpan (bool sign, int days, int hours, int minutes, int seconds,
long ticks): BugFix: thows correct and elaborate exception
public TimeSpan Add (TimeSpan ts): Minor Bugfix: Throw elaborate exception
public int CompareTo (object value): Bugfix, spelling in exception
public TimeSpan Duration (): Minor Bugfix: Throw elaborate exception
public static TimeSpan FromDays (double value): Perf+++++, huge speed
improvement, completely rewritten, Also fixes several bugs: Throws
ArgumentExceptions for NaN, Fixes bug with wrong overflows with very big or
very small values (did throw exceptions before), Correctly throws
Overflowexceptions
public static TimeSpan FromHours (double value): Perf+++++, huge speed
improvement, completely rewritten, Also fixes several bugs: Throws
ArgumentExceptions for NaN, Fixes bug with wrong overflows with very big or
very small values (did throw exceptions before), Correctly throws
Overflowexceptions
public static TimeSpan FromMinutes (double value): Perf+++++, huge speed
improvement, completely rewritten, Also fixes several bugs: Throws
ArgumentExceptions for NaN, Fixes bug with wrong overflows with very big or
very small values (did throw exceptions before), Correctly throws
Overflowexceptions
public static TimeSpan FromSeconds (double value): Perf+++++, huge speed
improvement, completely rewritten, Also fixes several bugs: Throws
ArgumentExceptions for NaN, Fixes bug with wrong overflows with very big or
very small values (did throw exceptions before), Correctly throws
Overflowexceptions
public static TimeSpan FromMilliseconds (double value): Perf++++, huge speed
improvement, completely rewritten, Also fixes several bugs: Throws
ArgumentExceptions for NaN, Fixes bug with wrong overflows with very big or
very small values (did throw exceptions before), Correctly throws
Overflowexceptions
public TimeSpan Negate (): Minor Bugfix: Localize exception
public static TimeSpan Parse (string s): Bugfix: incorrect exception
public TimeSpan Subtract (TimeSpan ts): Minor Bugfix: Throw elaborate
exception
public override string ToString (): Perf+++
public static bool operator == (TimeSpan t1, TimeSpan t2): Perf+++
public static bool operator &gt; (TimeSpan t1, TimeSpan t2): Perf+++
public static bool operator &gt;= (TimeSpan t1, TimeSpan t2): Perf+++
public static bool operator != (TimeSpan t1, TimeSpan t2): Perf+++
public static bool operator &lt; (TimeSpan t1, TimeSpan t2): Perf+++
public static bool operator &lt;= (TimeSpan t1, TimeSpan t2): Perf+++
public Parser (string src): Removed stupid (unneeded) method
+ Several typofixes in error texts
This are the changes that I can remember right now if looking over both
classes, probably more
And that is just the result. Obviously there are much more changes in the
methods to archive this.

&gt;<i>       * You are intermingling formatting changes, bug fixes, and
</I>&gt;<i>         performance improvements. What I would suggest you do is the
</I>&gt;<i>         following:
</I>&gt;<i>               * Check in all formatting related changes that you want.
</I>
That didn't seem to make sense to me with the reimpl. approach.

&gt;<i>               * Attach *ONE* patch per bug. If a bug appears in multiple
</I>&gt;<i>                 areas, it is OK to attach one patch that fixes the issue
</I>&gt;<i>                 in each method. In general, there should be one patch
</I>&gt;<i>                 per bug that would be filed in bugzilla
</I>
The bugs are currently not in bugzilla (at least I didn't check if any of
them are there). I just encountered them (mostly) while doing the perfomance
test. And obviously while testing my implementation. And I really just do
this all for fun in my spare time and starting to file bugs for things I
immediately fix is not really fun for me.

&gt;<i>               * Attach one patch for each optimization.
</I>&gt;<i>       * ALL performance improvements should come with benchmarks.
</I>
There are A LOT of them. Would anybody have much for insight if I posted
40-50 individual patches for that?
I've done a lot of microbenchmarking (which fortunatelly is relatively
simple when dealing mostly with longs). However I do not have any of those
available for inclusion as I just use one app and modify as needed.

&gt;<i> Some more specific ones:
</I>&gt;<i>       * Be careful about large arithmetic. For example, you have
</I>&gt;<i>         TicksPerXXX as a long each time. However, if some of these were
</I>&gt;<i>         ints, the JIT could make more optimizations. Also, some
</I>
These need to be longs because the values can reach long values

&gt;<i>         operations could be moved out of checked contexts to make them
</I>&gt;<i>         faster.
</I>
I choose all of the checked contexts very carefully. If you can tell me any
context where the check is not needed please tell me. But if I made no
mistakes the checks are crucial at  the positions where they are now. (These
places could overflow, but must never do)

&gt;<i>       * When you use stringbuilder, try to guess at how long the string
</I>&gt;<i>         will be -- this avoids reallocs.
</I>
Yes - played around with that one for a bit of time, but in the end the
default value of 16 elements seemed just right (This is one of the cases (in
this struct) were usage profile would matter)

&gt;<i> I would really encourage you to consider where you place performance
</I>&gt;<i> improvements. Frankly, not that many apps use TimeSpan. I have never
</I>&gt;<i> seen it be a bottleneck in those that do. Here are a few ideas -- maybe
</I>&gt;<i> they can get you started:
</I>&gt;<i>       * Try any method in System.Array on a large array of ints (like
</I>&gt;<i>         Array.Sort (my_int_array). Try it under the profiler.
</I>&gt;<i>       * Buffer.BlockCopy is slower than Array.Copy. It would be
</I>&gt;<i>         interesting to take a look at that.
</I>&gt;<i>       * Can we implement String.Concat in C#? There is a thread from a
</I>&gt;<i>         while back about this. This method would be interesting also as
</I>&gt;<i>         a case study for jit optimizations.
</I>&gt;<i>       * Many classes have static ctors that do not need them. Also, some
</I>&gt;<i>         classes use the static CLASS () {} construct which prevents
</I>&gt;<i>         beforefieldinit. It would be nice to do an audit for this. An
</I>&gt;<i>         example of the problem is IntPtr, which has a static ctor to
</I>&gt;<i>         init a static field to 0 (this is not needed, as it is inited to
</I>&gt;<i>         zero by default).
</I>&gt;<i>       * Many components of reflection could use some love.
</I>&gt;<i>       * There are many places where we could use stackalloc to avoid the
</I>&gt;<i>         cost of hitting the GC. Example -- many of the .ToString methods
</I>&gt;<i>         -- they use very small buffers. Good case for stackalloc.
</I>&gt;<i>
</I>&gt;<i> Am betting that a 100% improvement in any one of these issues will net
</I>&gt;<i> far more benefit than a 3000% improvement in TimeSpan.
</I>
This is probably right. I've also done a LOT of test/ checks on String
members. However testing string takes MUCH more time as it
a) is alredy somewhat optimized (also there is a lot of improvement
possible). However in String lots depend upon usage profile (length and
structure of used strings), which makes it so hard to find completely
superior solutions.



Also IMHO we should not make too much assumptions about when and how a
application uses the core classes. There MAY be applications out there that
depend on TimeSpan in a very perfomance sensitive way and it is one of the
CORE classes. So an area where we are 100ds of times slower than MS impl.
would even seem like a showstopper to me. And it's also just nice that some
are now faster than MS ;)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005029.html">[Mono-devel-list] Patch for System.Timespan
</A></li>
	<LI>Next message: <A HREF="005031.html">[Mono-devel-list] Patch for System.Timespan
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5030">[ date ]</a>
              <a href="thread.html#5030">[ thread ]</a>
              <a href="subject.html#5030">[ subject ]</a>
              <a href="author.html#5030">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
