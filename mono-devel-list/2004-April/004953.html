<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Anyone have ideas on making ThreadAbor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Anyone%20have%20ideas%20on%20making%20ThreadAbor&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004945.html">
   <LINK REL="Next"  HREF="004959.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Anyone have ideas on making ThreadAbor</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Anyone%20have%20ideas%20on%20making%20ThreadAbor&In-Reply-To="
       TITLE="[Mono-devel-list] Anyone have ideas on making ThreadAbor">bernard at ugsolutions.com
       </A><BR>
    <I>Mon Apr 12 17:55:57 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004945.html">[Mono-devel-list] Anyone have ideas on making ThreadAbor
</A></li>
        <LI>Next message: <A HREF="004959.html">[Mono-devel-list] System.ArgumentException when using System.Drawing.Image.FromFile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4953">[ date ]</a>
              <a href="thread.html#4953">[ thread ]</a>
              <a href="subject.html#4953">[ subject ]</a>
              <a href="author.html#4953">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After I sent my email I suddenly thought of the GC and so on
as cases where problems will arise trying to handle signals - let
alone other pinvoke'd code. So I think you are right that it must 
be done by some form of polling approach (not heard of the 
write protection trick you mention before - not quite sure how
that works to only cause one thread to fault though - or do they
all fault and continue until the right thread unprotects it?). The 
managed/unmanaged  transition does seem like an obvious 
place to check - and it  also requires all the EINTR checking you 
mention for appropriate IO calls. Does this also mean every 
mutex lock should be timed so we can check for aborts on the 
timeouts (the pthread man page seems to say any signal should 
not cause the lock call to exit).

How to make this all work on Windows is a different matter.

I'll see what this really involves - but this does seem like the best
approach.

Bernie


----- Original Message ----- 
From: &quot;Varga Zoltan&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at freemail.hu</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, April 12, 2004 10:31 AM
Subject: RE: [Mono-devel-list] Anyone have ideas on making ThreadAbor


&gt;<i> 
</I>&gt;<i>                                                  Hi,
</I>&gt;<i> 
</I>&gt;<i>    I would advocate using the polling approach to handling async
</I>&gt;<i> exceptions like ThreadAbort. The current approach has many
</I>&gt;<i> problems:
</I>&gt;<i> - since the runtime can be in any state when receiving the
</I>&gt;<i> signal,
</I>&gt;<i>   the handler can only call code which is 'async-signal
</I>&gt;<i> safe'. This is
</I>&gt;<i>   impossible to satisfy in general, since during exception
</I>&gt;<i> handling,
</I>&gt;<i>   filter code can be called which might execute arbitary
</I>&gt;<i> code. Also, 
</I>&gt;<i>   common code like the Boehm GC allocation functions are not
</I>&gt;<i> async
</I>&gt;<i>   safe.
</I>&gt;<i> - locking problems. If the thread holds unmanaged locks and
</I>&gt;<i> it is 
</I>&gt;<i>   aborted, the locks are not released, leading to a deadlock
</I>&gt;<i> later. This
</I>&gt;<i>   is already happening during appdomain unloading. This could be
</I>&gt;<i>   solved by somehow registering which thread holds which
</I>&gt;<i> lock, but
</I>&gt;<i>   I think this is hard to implement and slow. Also, some
</I>&gt;<i> locks, like the
</I>&gt;<i>   GC lock, are outside our control and can't be handled that
</I>&gt;<i> way.
</I>&gt;<i> - Disabling signals is another solution but it is also hard
</I>&gt;<i> to get right,
</I>&gt;<i>   and would hurt performance.
</I>&gt;<i> - It doesn't work on Windows, and don't seem to work on
</I>&gt;<i> Solaris either.
</I>&gt;<i> 
</I>&gt;<i> I think polling can be implemented efficiently:
</I>&gt;<i> - If the thread is in managed code when receiving the
</I>&gt;<i> signal, there is
</I>&gt;<i>    no problem, and the current approach can be used.
</I>&gt;<i> - If the thread is in unmanaged code, then a flag could be
</I>&gt;<i> set which is
</I>&gt;<i>    checked when returning from unmanaged code. Checking the flag
</I>&gt;<i>    can be done in one instruction by writing to a memory
</I>&gt;<i> location which
</I>&gt;<i>    is write protected by runtime when there is a pending
</I>&gt;<i> async exception
</I>&gt;<i>    for the thread/process. Since there is already some
</I>&gt;<i> overhead with
</I>&gt;<i>    managed-&gt;unmanaged transitions, this wouldn't hurt
</I>&gt;<i> performance much.
</I>&gt;<i> 
</I>&gt;<i> The other problem with polling is what happens if the thread
</I>&gt;<i> blocks
</I>&gt;<i> indefinitely in unmanaged code. There are two cases here:
</I>&gt;<i> - runtime code which is under our control: this code should
</I>&gt;<i> be written
</I>&gt;<i>    in such a way that it does not block indefinitely, e.g.
</I>&gt;<i> by checking 
</I>&gt;<i>   the return value of system calls, and if it is EINTR, then
</I>&gt;<i> check for async
</I>&gt;<i>   exceptions, and if there is an exception, then return from
</I>&gt;<i> the 
</I>&gt;<i>   native code, and the managed-&gt;unmanaged transition code
</I>&gt;<i> will do
</I>&gt;<i>    the rest.
</I>&gt;<i> - native code which is outside of our control like pinvoke:
</I>&gt;<i> There's little
</I>&gt;<i>    that can be done here. If the thread does not return to
</I>&gt;<i> managed 
</I>&gt;<i>    code, then it can't be aborted.
</I>&gt;<i> 
</I>&gt;<i> So this approach has the disadvantage that it doesn't always
</I>&gt;<i> work, i.e.
</I>&gt;<i> some threads can't be aborted. But it is much safer than the
</I>&gt;<i> current
</I>&gt;<i> approach, i.e. it doesn't lead to deadlocks and crashes.
</I>&gt;<i> 
</I>&gt;<i>                                                           
</I>&gt;<i> Zoltan
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>   
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-admin at lists.ximian.com</A>
</I>&gt;<i> &gt; [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-admin at lists.ximian.com</A>]On Behalf
</I>&gt;<i> Of ext Bernie
</I>&gt;<i> &gt; Solomon
</I>&gt;<i> &gt; Sent: Monday, April 12, 2004 6:57 PM
</I>&gt;<i> &gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; Subject: [Mono-devel-list] Anyone have ideas on making
</I>&gt;<i> &gt; ThreadAbortException robust
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; In running various tests I believe handling
</I>&gt;<i> ThreadAbortException
</I>&gt;<i> &gt; isn't robust at present. Unless there is something going
</I>&gt;<i> &gt; on I haven't realized and hopefully someone will correct me.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004945.html">[Mono-devel-list] Anyone have ideas on making ThreadAbor
</A></li>
	<LI>Next message: <A HREF="004959.html">[Mono-devel-list] System.ArgumentException when using System.Drawing.Image.FromFile
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4953">[ date ]</a>
              <a href="thread.html#4953">[ thread ]</a>
              <a href="subject.html#4953">[ subject ]</a>
              <a href="author.html#4953">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
