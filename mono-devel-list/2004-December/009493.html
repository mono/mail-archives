<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Re: svnmirror.sh v0.0.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20svnmirror.sh%20v0.0.5&In-Reply-To=20041217053305.GJ1202%40monsters.rsn.uni-rostock.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009509.html">
   <LINK REL="Next"  HREF="009474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Re: svnmirror.sh v0.0.5</H1>
    <B>Marcus Rueckert</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20svnmirror.sh%20v0.0.5&In-Reply-To=20041217053305.GJ1202%40monsters.rsn.uni-rostock.de"
       TITLE="[Mono-devel-list] Re: svnmirror.sh v0.0.5">darix at web.de
       </A><BR>
    <I>Fri Dec 17 00:45:40 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009509.html">[Mono-devel-list] using mono to write a linux gui
</A></li>
        <LI>Next message: <A HREF="009474.html">[Mono-devel-list] HttpWorkerRequest
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9493">[ date ]</a>
              <a href="thread.html#9493">[ thread ]</a>
              <a href="subject.html#9493">[ subject ]</a>
              <a href="author.html#9493">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi,

again. i forgot to update some parts of the config documentation.
fixed it and attached new version. i didnt bump the version number.

darix

-- 
irssi - the client of the smart and beautiful people

              <A HREF="http://www.irssi.de/">http://www.irssi.de/</A>

-------------- next part --------------
* contrib/server-side/svnmirror.sh

    + added DUMPPARAMS to specify the params for the svnadmin dump call
    + added note about svnadmin 1.1 and &quot;--deltas&quot; cmdline option
    * made the script POSIX sh-compatible
      (zsh in native-mode does not work atm!)
    * changed handling of default settings
    * created config file has all lines commented out now
    + check if necessary values are set
    + added note about current users
    * fixed documentation in the default config
-------------- next part --------------
#!/bin/sh
#######################################################################
#
# svnmirror.sh
#
VERSION=&quot;0.0.5&quot;
#
# This script syncs changes from a developer repository to a
#             _READONLY_public_repository_
#
# It supports pushing or pulling the changes via ssh and svn tools.
# It is intended to be run manually or from cron.
#
#######################################################################
#
# Things you have to take care of:
#
# 1. You need write access to the directory structure on both boxes
#    for more see the warning at:
#    <A HREF="http://svnbook.red-bean.com/html-chunk/ch06s03.html">http://svnbook.red-bean.com/html-chunk/ch06s03.html</A>
#
# 2. For running it from cron i suggest the use of the ssh agent e.g
#    via keychain &lt;<A HREF="http://www.gentoo.org/proj/en/keychain.xml">http://www.gentoo.org/proj/en/keychain.xml</A>&gt;
#    in general read &quot;man ssh-agent&quot; and &quot;man ssh-keygen&quot;.
#
# 3. Do NOT run it from post commit scripts it can lead to broken public
#    repositories!
#
# 4. You do not have to be afraid of the public repos. If the pipe is
#    broken nothing will be committed to it.
#    21:40:47 &lt;@sussman&gt; tberman:  welcome to atomic commits.
#
# 5. For local syncing use &quot;svnadmin hotcopy&quot;
#    see: &quot;svnadmin help hotcopy&quot;
#
#######################################################################
#
# Authors:
#    - Martin Furter &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mf at rola.ch</A>&gt;
#    - Marcus R?ckert &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">darix at irssi.org</A>&gt;
#    - Joerg Sonnenberger &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">joerg at bec.de</A>&gt;
#
#    with suggestions from:
#       - tberman (#svn at freenode)
#         - he actually needed such a script :)
#       - Erik Huelsmann &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">e.huelsmann at gmx.net</A>&gt;
#         - the little if for remote version :)
#         - status reply
#       - Ben Collins-Sussman &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sussman at collab.net</A>&gt;
#         - for some help with the svn commands
#       - Bj?rn Magnus Mathisen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">epic at generation.no</A>&gt;
#         - for pointing out i forgot to replace one ssh with $LSSH
#
# Users:
#    our biggest users atm are Mono Project and MonoDevelop
#    Mono Team currently mirrors the repos every 30 minutes!:)
#    see <A HREF="http://www.mono-project.com/contributing/anonsvn.html">http://www.mono-project.com/contributing/anonsvn.html</A>
#
# License:
#    The same as svn itself. for latest version check:
#    <A HREF="http://svn.collab.net/repos/svn/trunk/subversion/LICENSE">http://svn.collab.net/repos/svn/trunk/subversion/LICENSE</A>
#
# Thanks to the subversion team for their great work.
#
# Links:
#    If you do not like our solution check:
#       - svnpush
#         + <A HREF="http://svn.collab.net/repos/svn/trunk/contrib/client-side/svn-push/svn-push.c">http://svn.collab.net/repos/svn/trunk/contrib/client-side/svn-push/svn-push.c</A>
#       - svn replicate
#         + <A HREF="https://open.datacore.ch/read-only/">https://open.datacore.ch/read-only/</A>
#       - SVN::Mirror and SVN::Web
#         + <A HREF="http://svn.elixus.org/repos/member/clkao/">http://svn.elixus.org/repos/member/clkao/</A>
#         + <A HREF="http://svn.elixus.org/svnweb/repos/browse/member/clkao/">http://svn.elixus.org/svnweb/repos/browse/member/clkao/</A> 
#
# Changes:
#
#  0.0.5
#    + added DUMPPARAMS to specify the params for the svnadmin dump call
#    + added note about svnadmin 1.1 and &quot;--deltas&quot; cmdline option
#    * made the script POSIX sh-compatible
#      (zsh in native-mode does not work atm!)
#    * changed handling of default settings
#    * created config file has all lines commented out now
#    + check if necessary values are set
#    + added note about current users
#    * fixed documentation in the default config
#
#  0.0.4
#    + added comandline switch -v which shows the version.
#    + using markers now to find the config so it's not twice in this script
#    + added/changed some more documentation
#
#  0.0.3
#    + added comandline switches: -C (create config) -f (read config file)
#      -h (help) -q (quiet).
#
#  0.0.2
#    * initial version
#
#######################################################################
#
# uncomment this line for debugging
# set -x
#
#_CONFIG_START_MARKER
#######################################################################
#
# svnmirror default config
#
# Everything starting with &quot;R&quot; refers to the remote host
# with &quot;L&quot; to the local host
#
# the required variables are LREPOS, RREPOS and RHOST
#
#######################################################################
#
# Mode:
#
# push == Mirror from local repository to remote (readonly) repository
# pull == Mirror from remote repository to local (readonly) repository
#
DFLT_MODE=&quot;push&quot;

#
# keychain = path to keychain sh file
# If the variable is not set, the script tries to read
# &quot;$HOME/.keychain/`uname -n`-sh&quot;, if it is readable.
#
DFLT_KEYCHAIN=&quot;&quot;

#
# DUMPPARMS
#
# see &quot;svnadmin help dump&quot; for it.
# default is &quot;--incremental&quot;
# 
# if you use svn 1.1 on both you should add &quot;--deltas&quot;
# it should speed up the transfer on slow lines.
#
DFLT_DUMPPARAMS=&quot;--incremental&quot;

# Absolute path of svnlook on the local host.
DFLT_LSVNLOOK=&quot;/usr/bin/svnlook&quot;

# Absolute path of svnadmin on the local host.
DFLT_LSVNADMIN=&quot;/usr/bin/svnadmin&quot;

# Absolute path to the repository on the local host.
# REQUIRED
DFLT_LREPOS=&quot;/path/to/repos&quot;

# Absolute path of ssh on the local host.
#   '-c blowfish -C' to speed up the transfer a bit :)
DFLT_LSSH=&quot;/usr/bin/ssh -c blowfish -C&quot;

# Name or IP of the remote host.
# REQUIRED
DFLT_RHOST=&quot;host&quot;

# UNIX username on the remote host.
# defaults to the local username.
DFLT_RUSER=&quot;user&quot;

# Absolute path of svnlook on the remote host.
DFLT_RSVNLOOK=&quot;/usr/bin/svnlook&quot;

# Absolute path of svnadmin on the remote host.
DFLT_RSVNADMIN=&quot;/usr/bin/svnadmin&quot;

# Absolute path to the repository on the remote host.
# REQUIRED
DFLT_RREPOS=&quot;/path/to/repos&quot;

# Additional commands you want to run before loading the dump in to the repos
# e.g. setting umask or change group via newgrp.
#
# Make sure the last char is a &quot;;&quot;.
#
DFLT_LADDITIONAL=&quot;&quot;
DFLT_RADDITIONAL=&quot;&quot;

#_CONFIG_END_MARKER
#######################################################################
#
# create a config file
#
#######################################################################

create_config()
{
    CFGFILE=&quot;$1&quot;
    if [ -f &quot;${CFGFILE}&quot; ]; then
        echo &quot;config file '${CFGFILE}' already exists.&quot; &gt;&amp;2
        exit 1
    fi
    SVNMIRROR=&quot;$0&quot;
    if [ ! -f &quot;$0&quot; ]; then
        SVNMIRROR=`which &quot;$0&quot;`
        if [ $? -ne 0 ]; then
            echo &quot;could not locate $0&quot; &gt;&amp;2
            exit 1
        fi
    fi
    STARTLINE=`grep -n &quot;^#_CONFIG_START_MARKER&quot; &quot;$SVNMIRROR&quot; | sed 's/:.*$//'`
    ENDLINE=`grep -n &quot;^#_CONFIG_END_MARKER&quot; &quot;$SVNMIRROR&quot; | sed 's/:.*$//'`
    ENDLINE=`expr ${ENDLINE} - 1`
    LINECOUNT=`expr ${ENDLINE} - ${STARTLINE}`
    head -n ${ENDLINE} &quot;$SVNMIRROR&quot; | tail -$LINECOUNT | sed -e 's/^#/##/' -e 's/^DFLT_/# /g' | \
        sed 's/default config/config/' &gt; &quot;$CFGFILE&quot;
}

#######################################################################
#
# parse the commandline
#
#######################################################################
#
# 

show_help()
{
    echo &quot;&quot;
    echo &quot;usage:&quot;
    echo &quot;  svnmirror.sh [-f configfile] [-h] [-q] [-v]&quot;
    echo &quot;  svnmirror.sh -C configfile&quot;
    echo &quot;&quot;
    echo &quot;  -C configfile   create a config file&quot;
    echo &quot;  -f configfile   read config from the specified file&quot;
    echo &quot;  -h              show this help&quot;
    echo &quot;  -q              quiet (-q -q for really quiet)&quot;
    echo &quot;  -v              show version&quot;
    echo &quot;&quot;
    echo &quot;Note: For -f, configfile is relative to the current PATH settings&quot;
    echo &quot;&quot;
}

CONFIGREAD=false
QUIET=&quot;&quot;
VERBOSE=true
while getopts C:f:hqv OPTION; do
    case &quot;$OPTION&quot; in
        C)
            create_config &quot;${OPTARG}&quot;
            exit 0
            ;;
        f)
            if [ ${CONFIGREAD} = true ]; then
                echo &quot;config already read&quot; &gt;&amp;2
                exit 1
            elif [ ! -r &quot;${OPTARG}&quot; ]; then
                echo &quot;cannot read config file '${OPTARG}'&quot; &gt;&amp;2
                exit 1
            else
                . ${OPTARG}
            fi
            ;;
        h)
            show_help
            exit 0
            ;;
        q)
            if [ -z &quot;${QUIET}&quot; ]; then
                QUIET=&quot;-q&quot;
            else
                VERBOSE=false
            fi
            ;;
        v)
            echo &quot;svnmirror.sh $VERSION&quot;
            exit 0
            ;;
        \?)
            echo &quot;  for help use $0 -h&quot;
            exit 1
            ;;
    esac
done

#######################################################################
#
# add default values
#
#######################################################################
MODE=&quot;${MODE:-$DFLT_MODE}&quot;
DUMPPARAMS=&quot;${DUMPPARAMS:-$DFLT_DUMPPARAMS}&quot;
LSVNLOOK=&quot;${LSVNLOOK:-$DFLT_LSVNLOOK}&quot;
LSVNADMIN=&quot;${LSVNADMIN:-$DFLT_LSVNADMIN}&quot;
LSSH=&quot;${LSSH:-$DFLT_LSSH}&quot;
RUSER=&quot;${RUSER:-$USER}&quot;
RSVNLOOK=&quot;${RSVNLOOK:-$DFLT_RSVNLOOK}&quot;
RSVNADMIN=&quot;${RSVNADMIN:-$DFLT_RSVNADMIN}&quot;
LADDITIONAL=&quot;${LADDITIONAL:-$DFLT_LADDITIONAL}&quot;
RADDITIONAL=&quot;${RADDITIONAL:-$DFLT_RADDITIONAL}&quot;

echo &quot;${LREPOS:?Required variable LREPOS is not set in config file}&quot; &gt; /dev/null
echo &quot;${RREPOS:?Required variable RREPOS is not set in config file}&quot; &gt; /dev/null
echo &quot;${RHOST:?Required variable RHOST is not set in config file}&quot; &gt; /dev/null

KEYCHAIN=&quot;${KEYCHAIN:-$HOME/.keychain/`uname -n`-sh}&quot;
[ -n &quot;${KEYCHAIN}&quot; -a -r &quot;${KEYCHAIN}&quot; ] &amp;&amp; . ${KEYCHAIN}

#######################################################################
#
# the actual script
#
#######################################################################
#

#
# getting version of the remote repository
#
RVERSION=`${LSSH} ${RUSER}@${RHOST} ${RSVNLOOK} youngest ${RREPOS}`
if [ -z &quot;${RVERSION}&quot; ] ; then
    echo &quot;getting version of remote repository failed&quot; &gt;&amp;2
    exit 1
fi

#
# getting version of the local repository
#
${LADDITIONAL}
LVERSION=`${LSVNLOOK} youngest ${LREPOS}`
if [ -z &quot;${LVERSION}&quot; ] ; then
    echo &quot;getting version of local repository failed&quot; &gt;&amp;2
    exit 1
fi

#
# compare revision numbers
#
if [ ${RVERSION} -eq ${LVERSION} ] ; then
    [ ${VERBOSE} = true ] &amp;&amp; \
        echo &quot;both repositories are already at ${LVERSION}&quot; &gt;&amp;2
    exit 0
fi

#
# syncing
#
RC=0
if [ ${MODE} = &quot;push&quot; ] ; then
    if [ ${RVERSION} -gt ${LVERSION} ] ; then
        echo &quot;revision of remote repos is higher than local one&quot; &gt;&amp;2
        exit 1
    fi
    REVRANGE=&quot;`expr ${RVERSION} + 1`:${LVERSION}&quot;
    [ ${VERBOSE} = true ] &amp;&amp; \
        echo -n &quot;syncing r${REVRANGE} to ${RHOST} &quot;;
    ${LSVNADMIN} dump ${QUIET} ${DUMPPARAMS} -r${REVRANGE} ${LREPOS} | \
    ${LSSH} ${RUSER}@${RHOST} &quot;${RADDITIONAL} ${RSVNADMIN} load ${QUIET} ${RREPOS}&quot; || \
    RC=1
elif [ ${MODE} = &quot;pull&quot; ] ; then
    if [ ${LVERSION} -gt ${RVERSION} ] ; then
        echo &quot;revision of local repos is higher than remote one&quot; &gt;&amp;2
        exit 1
    fi
    REVRANGE=&quot;`expr ${LVERSION} + 1`:${RVERSION}&quot;
    [ ${VERBOSE} = true ] &amp;&amp; \
        echo -n &quot;syncing r${REVRANGE} from ${RHOST} &quot;;
    ${LSSH} ${RUSER}@${RHOST} \
    &quot;${RADDITIONAL} ${RSVNADMIN} dump ${QUIET} ${DUMPPARAMS} -r${REVRANGE} ${RREPOS}&quot; | \
    ${LSVNADMIN} load ${QUIET} ${LREPOS} || \
    RC=1
else
    echo &quot;invalid mode \&quot;${MODE}\&quot; specified!&quot; &gt;&amp;2
    exit 1
fi
if [ ${RC} -ne 0 ]; then
    echo &quot;failed&quot; &gt;&amp;2
else
    [ ${VERBOSE} = true ] &amp;&amp; \
        echo &quot;successfull completed.&quot;
fi
exit ${RC}


-------------- next part --------------
---------------------------------------------------------------------
To unsubscribe, e-mail: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dev-unsubscribe at subversion.tigris.org</A>
For additional commands, e-mail: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dev-help at subversion.tigris.org</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009509.html">[Mono-devel-list] using mono to write a linux gui
</A></li>
	<LI>Next message: <A HREF="009474.html">[Mono-devel-list] HttpWorkerRequest
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9493">[ date ]</a>
              <a href="thread.html#9493">[ thread ]</a>
              <a href="subject.html#9493">[ subject ]</a>
              <a href="author.html#9493">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
