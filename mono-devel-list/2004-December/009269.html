<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Patch for wrong out BB
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20wrong%20out%20BB&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009267.html">
   <LINK REL="Next"  HREF="009289.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Patch for wrong out BB</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20wrong%20out%20BB&In-Reply-To="
       TITLE="[Mono-devel-list] Patch for wrong out BB">massi at ximian.com
       </A><BR>
    <I>Mon Dec  6 15:18:29 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009267.html">[Mono-devel-list] monocov patch for building on trunk
</A></li>
        <LI>Next message: <A HREF="009289.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9269">[ date ]</a>
              <a href="thread.html#9269">[ thread ]</a>
              <a href="subject.html#9269">[ subject ]</a>
              <a href="author.html#9269">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,
I noticed that in mono_method_to_ir, when creating BBs, the last
&quot;proper&quot; BB is always linked to the exit BB, even when it has an
explicit branch instruction at the end.

This means that if one method has as last CIL instruction a jump
to somewhere inside the method (which is legal), one of its BBs
(the last &quot;proper&quot; one) will have two out BBs: the jump target,
and the exit BB, which is wrong.

This causes a bug when using both consprop (or copyprop) and
ssapre, even if the issue is not risen by ssapre, but from the
removal of critical edges: removing critical edges that &quot;last&quot;
BB is not the &quot;last&quot; one anymore, nevertheless it has the exit
BB as out BB (which it should not have), and this gives troubles.

The attached patch solves the issue, and also enables SSAPRE when
consprop|copyprop are used, because the bug is gone ;-)

OK to commit?

As an alternative, I could make so that critical edges removal
never &quot;splits&quot; edges pointing to the exit BB, even if they are
critical. This should not harm, because the exit BB is always
empty so critical edges would be harmless there, and would save
some BB and some branches in these cases.
However, I would find it somewhat &quot;unclean&quot;, and probably also
dangerous in unexpected situations.

Ciao,
  Massi

P.S. The bug showed up in the &quot;odd-even&quot; regression test, which
is coded in IL and has an unusual branch pattern...

-------------- next part --------------
A non-text attachment was scrubbed...
Name: branch-on-last-bb.patch
Type: text/x-patch
Size: 1788 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20041206/a3555caf/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20041206/a3555caf/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009267.html">[Mono-devel-list] monocov patch for building on trunk
</A></li>
	<LI>Next message: <A HREF="009289.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9269">[ date ]</a>
              <a href="thread.html#9269">[ thread ]</a>
              <a href="subject.html#9269">[ subject ]</a>
              <a href="author.html#9269">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
