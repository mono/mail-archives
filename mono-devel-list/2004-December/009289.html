<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Patch for wrong out BB
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20wrong%20out%20BB&In-Reply-To=1102364292.4222.22.camel%40matrix">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009269.html">
   <LINK REL="Next"  HREF="009298.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Patch for wrong out BB</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20wrong%20out%20BB&In-Reply-To=1102364292.4222.22.camel%40matrix"
       TITLE="[Mono-devel-list] Patch for wrong out BB">lupus at ximian.com
       </A><BR>
    <I>Tue Dec  7 12:40:53 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009269.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
        <LI>Next message: <A HREF="009298.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9289">[ date ]</a>
              <a href="thread.html#9289">[ thread ]</a>
              <a href="subject.html#9289">[ subject ]</a>
              <a href="author.html#9289">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/06/04 Massimiliano Mantione wrote:
&gt;<i> I noticed that in mono_method_to_ir, when creating BBs, the last
</I>&gt;<i> &quot;proper&quot; BB is always linked to the exit BB, even when it has an
</I>&gt;<i> explicit branch instruction at the end.
</I>
Good catch.

&gt;<i> OK to commit?
</I>
I don't think your patch is correct/complete.

&gt;<i> Index: mono/mono/mini/mini.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/mono/mini/mini.c	(revision 37209)
</I>&gt;<i> +++ mono/mono/mini/mini.c	(working copy)
</I>&gt;<i> @@ -5846,7 +5846,26 @@
</I>&gt;<i>  
</I>&gt;<i>  	bblock-&gt;cil_length = ip - bblock-&gt;cil_code;
</I>&gt;<i>  	bblock-&gt;next_bb = end_bblock;
</I>&gt;<i> -	link_bblock (cfg, bblock, end_bblock);
</I>&gt;<i> +	if (bblock-&gt;last_ins != NULL &amp;&amp; ((bblock-&gt;last_ins-&gt;opcode == CEE_BR) ||
</I>&gt;<i> +			(bblock-&gt;last_ins-&gt;opcode == CEE_BNE_UN) ||
</I>
CEE_BR would be ok and it's what is tested in the even-odd test.
But the conditional branches should never happen here, as the not taken
branch is a follow-through and it gets out of the method code. The verifier
has a check for that, so the extra checks would be redundant even if
they were correct.

&gt;<i> +			(bblock-&gt;last_ins-&gt;opcode == CEE_SWITCH) )) {
</I>
CEE_SWITCH is fine, but a few more opcodes are missing. I think
a better way to implement this is to add a local:
	const char *no_link_needed_at_ip;
The var is set with:
	no_link_needed_at_ip = ip;
at the end of each case for opcodes that need this handling.
Besides CEE_BR, CEE_BR_S, CEE_SWITCH we have also CEE_RET,
CEE_JMP, CEE_THROW, CEE_ENDFILTER, CEE_ENDFINALLY, CEE_RETHROW,
CEE_LEAVE, CEE_LEAVE_S. Hope I didn't miss any. Using the ip var
is better, because after the internal representation is generated,
there is no easy way to check bblock-&gt;last_ins e check for all
these cases.
Care to rework the patch and test it?
Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009269.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
	<LI>Next message: <A HREF="009298.html">[Mono-devel-list] Patch for wrong out BB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9289">[ date ]</a>
              <a href="thread.html#9289">[ thread ]</a>
              <a href="subject.html#9289">[ subject ]</a>
              <a href="author.html#9289">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
