<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20%5BVBNC%5D%20Treat%20AscW%20as%20CInt%20with%0A%09/novbruntimeref&In-Reply-To=009101c6d1a3%24f6511060%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020337.html">
   <LINK REL="Next"  HREF="020339.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref</H1>
    <B>Rolf Bjarne</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20%5BVBNC%5D%20Treat%20AscW%20as%20CInt%20with%0A%09/novbruntimeref&In-Reply-To=009101c6d1a3%24f6511060%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref">rolfbasura at ya.com
       </A><BR>
    <I>Wed Sep  6 07:48:12 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020337.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with /novbruntimeref
</A></li>
        <LI>Next message: <A HREF="020339.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20338">[ date ]</a>
              <a href="thread.html#20338">[ thread ]</a>
              <a href="subject.html#20338">[ subject ]</a>
              <a href="author.html#20338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Commenting code inline:

+        If Info.Compiler.CommandLine.NoVBRuntimeRef AndAlso  
Info.Compiler.Assembly.IsDefinedHere(Method.DeclaringType) AndAlso  
Method.IsStatic AndAlso CompareNameOrdinal(Method.Name, &quot;AscW&quot;) Then
+            Dim methodParameters() As ParameterInfo =  
Method.GetParameters()
You might want to use Helper.GetParameters(Info.Compiler, Method), since  
this will fail if a MethodBuilder is passed in instead of a  
MethodDescriptor.
+
+            If methodParameters.Length &lt;&gt; 0 AndAlso  
Helper.CompareType(methodParameters(0).ParameterType, TypeCache.Char) Then
To compare types use Helper.CompareType(type1, type2), I have found that  
comparing type instances at the same time as using Reflection.Emit is very  
unreliable.
+                If Arguments.Count &lt;&gt; 0 Then
This pushes a Char on the stack:
+                    result = Arguments(0).GenerateCode(Info.Clone(True,  
False, TypeCache.Char), methodParameters(0)) AndAlso result
Always put a 'AndAlso result' after assigning to result, this will ensure  
that a False result value earlier on won't get lost. I know there is no  
earlier assignment right now to result, but when the code changes it is  
very easy to forget this.
+                Else
+                    Helper.Assert(methodParameters(0).IsOptional)
This also pushes a Char on the stack:
+                    Emitter.EmitLoadValue(Info.Clone(TypeCache.Char),  
methodParameters(0).DefaultValue)
+                End If
If you now push an integer on the stack you'll have the char and the  
integer there. I suggest using this:
			Info.Stack.SwitchHead(TypeCache.Char, TypeCache.Integer)
+                Info.Stack.Push(TypeCache.Integer)
+
+                Return result
+            End If
+        End If
+

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I added a hack to EmitArgumentsAndCallOrCallVirt to support the  
</I>&gt;<i> previously
</I>&gt;<i> discussed functionality.
</I>&gt;<i>
</I>&gt;<i> I don't know how exactly the stack evaluation in vbnc works and I keep
</I>&gt;<i> getting ...  reached, but stack is not empty.
</I>The stack evaluation is only for debug purposes and is anyway flawed, so  
you can safely ignore these warnings if the resulting assembly works.

&gt;<i> Another missing functionality is that the return value of this replaced  
</I>&gt;<i> AscW
</I>&gt;<i> should be treated as Integer regardless of the return type of the  
</I>&gt;<i> replaced
</I>&gt;<i> AscW function.
</I>In order for this to work correctly you would have to insert the hack  
earlier on in the compiler, probably in the Resolve phase, when during  
resolution a call to AscW is detected the parse tree is modified to just  
load the char/integer value on the stack. Error checking would have to be  
bypassed since it is now allowed in VB to treat a Char value as any other  
int value (this error isn't reported now anyway though). Having in mind  
that this is a hack to support a feature of an unsupported commandline  
option your hack might be just good enough.

&gt;<i> Korn&#233;l
</I>
Rolf


-- 
Using M2, Opera's revolutionary e-mail client: <A HREF="http://www.opera.com/m2/">http://www.opera.com/m2/</A>


-- 
No virus found in this outgoing message.
Checked by AVG Free Edition.
Version: 7.1.405 / Virus Database: 268.11.7/438 - Release Date: 05/09/2006


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020337.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with /novbruntimeref
</A></li>
	<LI>Next message: <A HREF="020339.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20338">[ date ]</a>
              <a href="thread.html#20338">[ thread ]</a>
              <a href="subject.html#20338">[ subject ]</a>
              <a href="author.html#20338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
