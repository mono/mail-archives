<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20%5BVBNC%5D%20Treat%20AscW%20as%20CInt%20with%0A%09/novbruntimeref&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020338.html">
   <LINK REL="Next"  HREF="020346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20%5BVBNC%5D%20Treat%20AscW%20as%20CInt%20with%0A%09/novbruntimeref&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref">kornelpal at gmail.com
       </A><BR>
    <I>Wed Sep  6 10:06:35 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020338.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
</A></li>
        <LI>Next message: <A HREF="020346.html">[Mono-dev] Bug System.Web.Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20339">[ date ]</a>
              <a href="thread.html#20339">[ thread ]</a>
              <a href="subject.html#20339">[ subject ]</a>
              <a href="author.html#20339">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for your help. AscW_emit.diff contains a modified version of the 
previous patch.

I tried to implement the replacement at resolving but I was unable to 
succeed. AscW_resolve.diff contains my try.

Korn&#233;l

----- Original Message ----- 
From: &quot;Rolf Bjarne&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">rolfbasura at ya.com</A>&gt;
To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Wednesday, September 06, 2006 1:48 PM
Subject: Re: [Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with 
/novbruntimeref


&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> Commenting code inline:
</I>&gt;<i>
</I>&gt;<i> +        If Info.Compiler.CommandLine.NoVBRuntimeRef AndAlso 
</I>&gt;<i> Info.Compiler.Assembly.IsDefinedHere(Method.DeclaringType) AndAlso 
</I>&gt;<i> Method.IsStatic AndAlso CompareNameOrdinal(Method.Name, &quot;AscW&quot;) Then
</I>&gt;<i> +            Dim methodParameters() As ParameterInfo = 
</I>&gt;<i> Method.GetParameters()
</I>&gt;<i> You might want to use Helper.GetParameters(Info.Compiler, Method), since 
</I>&gt;<i> this will fail if a MethodBuilder is passed in instead of a 
</I>&gt;<i> MethodDescriptor.
</I>&gt;<i> +
</I>&gt;<i> +            If methodParameters.Length &lt;&gt; 0 AndAlso 
</I>&gt;<i> Helper.CompareType(methodParameters(0).ParameterType, TypeCache.Char) Then
</I>&gt;<i> To compare types use Helper.CompareType(type1, type2), I have found that 
</I>&gt;<i> comparing type instances at the same time as using Reflection.Emit is very 
</I>&gt;<i> unreliable.
</I>&gt;<i> +                If Arguments.Count &lt;&gt; 0 Then
</I>&gt;<i> This pushes a Char on the stack:
</I>&gt;<i> +                    result = Arguments(0).GenerateCode(Info.Clone(True, 
</I>&gt;<i> False, TypeCache.Char), methodParameters(0)) AndAlso result
</I>&gt;<i> Always put a 'AndAlso result' after assigning to result, this will ensure 
</I>&gt;<i> that a False result value earlier on won't get lost. I know there is no 
</I>&gt;<i> earlier assignment right now to result, but when the code changes it is 
</I>&gt;<i> very easy to forget this.
</I>&gt;<i> +                Else
</I>&gt;<i> +                    Helper.Assert(methodParameters(0).IsOptional)
</I>&gt;<i> This also pushes a Char on the stack:
</I>&gt;<i> +                    Emitter.EmitLoadValue(Info.Clone(TypeCache.Char), 
</I>&gt;<i> methodParameters(0).DefaultValue)
</I>&gt;<i> +                End If
</I>&gt;<i> If you now push an integer on the stack you'll have the char and the 
</I>&gt;<i> integer there. I suggest using this:
</I>&gt;<i> Info.Stack.SwitchHead(TypeCache.Char, TypeCache.Integer)
</I>&gt;<i> +                Info.Stack.Push(TypeCache.Integer)
</I>&gt;<i> +
</I>&gt;<i> +                Return result
</I>&gt;<i> +            End If
</I>&gt;<i> +        End If
</I>&gt;<i> +
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I added a hack to EmitArgumentsAndCallOrCallVirt to support the 
</I>&gt;&gt;<i> previously
</I>&gt;&gt;<i> discussed functionality.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't know how exactly the stack evaluation in vbnc works and I keep
</I>&gt;&gt;<i> getting ...  reached, but stack is not empty.
</I>&gt;<i> The stack evaluation is only for debug purposes and is anyway flawed, so 
</I>&gt;<i> you can safely ignore these warnings if the resulting assembly works.
</I>&gt;<i>
</I>&gt;&gt;<i> Another missing functionality is that the return value of this replaced 
</I>&gt;&gt;<i> AscW
</I>&gt;&gt;<i> should be treated as Integer regardless of the return type of the 
</I>&gt;&gt;<i> replaced
</I>&gt;&gt;<i> AscW function.
</I>&gt;<i> In order for this to work correctly you would have to insert the hack 
</I>&gt;<i> earlier on in the compiler, probably in the Resolve phase, when during 
</I>&gt;<i> resolution a call to AscW is detected the parse tree is modified to just 
</I>&gt;<i> load the char/integer value on the stack. Error checking would have to be 
</I>&gt;<i> bypassed since it is now allowed in VB to treat a Char value as any other 
</I>&gt;<i> int value (this error isn't reported now anyway though). Having in mind 
</I>&gt;<i> that this is a hack to support a feature of an unsupported commandline 
</I>&gt;<i> option your hack might be just good enough.
</I>&gt;<i>
</I>&gt;&gt;<i> Korn&#233;l
</I>&gt;<i>
</I>&gt;<i> Rolf
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> Using M2, Opera's revolutionary e-mail client: <A HREF="http://www.opera.com/m2/">http://www.opera.com/m2/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> No virus found in this outgoing message.
</I>&gt;<i> Checked by AVG Free Edition.
</I>&gt;<i> Version: 7.1.405 / Virus Database: 268.11.7/438 - Release Date: 05/09/2006
</I>&gt;<i> 
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: AscW_emit.diff
Type: application/octet-stream
Size: 1837 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060906/cab589ca/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060906/cab589ca/attachment.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: AscW_resolve.diff
Type: application/octet-stream
Size: 4692 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060906/cab589ca/attachment-0001.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060906/cab589ca/attachment-0001.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020338.html">[Mono-dev] [PATCH] [VBNC] Treat AscW as CInt with	/novbruntimeref
</A></li>
	<LI>Next message: <A HREF="020346.html">[Mono-dev] Bug System.Web.Services
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20339">[ date ]</a>
              <a href="thread.html#20339">[ thread ]</a>
              <a href="subject.html#20339">[ subject ]</a>
              <a href="author.html#20339">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
