<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] BUG in TypeDescriptor.GetAttributes : Ignores	overriden attributes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20BUG%20in%20TypeDescriptor.GetAttributes%20%3A%20Ignores%0A%09overriden%20attributes&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020274.html">
   <LINK REL="Next"  HREF="020270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] BUG in TypeDescriptor.GetAttributes : Ignores	overriden attributes</H1>
    <B>Ivan N. Zlatev</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20BUG%20in%20TypeDescriptor.GetAttributes%20%3A%20Ignores%0A%09overriden%20attributes&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] BUG in TypeDescriptor.GetAttributes : Ignores	overriden attributes">contact at i-nz.net
       </A><BR>
    <I>Fri Sep  1 17:09:43 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020274.html">[Mono-dev] mono/interpreter/interp.c build problems
</A></li>
        <LI>Next message: <A HREF="020270.html">[Mono-dev] [PATCH] BUG in TypeDescriptor.GetAttributes :	Ignores overriden attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20269">[ date ]</a>
              <a href="thread.html#20269">[ thread ]</a>
              <a href="subject.html#20269">[ subject ]</a>
              <a href="author.html#20269">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The current implementation of TypeDescriptor.GetAttributes ignores
overriden attributes and returns the bottom most in the inheritance
tree. The attached patch fixes that. I have also attached a test case
so you can observe the wrong behaviour. The patch also does whitespace
cleanup.

Please review and commit.

P.S: The fix is this and everything else is just the whitespace cleanup:

=== START ===
 		protected AttributeCollection GetAttributes (IComponent comp)
 		{
 			if (_attributes != null)
 				return _attributes;
-			
+
 			bool cache = true;
 			object[] ats = _infoType.GetCustomAttributes (true);
 			Hashtable t = new Hashtable ();
-			foreach (Attribute at in ats)
-				t [at.TypeId] = at;
-					
-			if (comp != null &amp;&amp; comp.Site != null)
+
+			// Filter the custom attributes, so that only the top
+			// level of the same type are left.
+			//
+			for (int i = ats.Length -1; i &gt; 0; i--) {
+				t [((Attribute) ats[i]).TypeId] = ats[i];
+			}
+
+			if (comp != null &amp;&amp; comp.Site != null)
 			{
 				ITypeDescriptorFilterService filter =
(ITypeDescriptorFilterService) comp.Site.GetService
(typeof(ITypeDescriptorFilterService));
 				cache = filter.FilterAttributes (comp, t);
 			}
=== END ===
-- 
Ivan N. Zlatev

Web: <A HREF="http://www.i-nZ.net">http://www.i-nZ.net</A>
GPG Key: <A HREF="http://files.i-nZ.net/i-nZ.asc">http://files.i-nZ.net/i-nZ.asc</A>
&quot;It's all some kind of whacked out conspiracy.&quot;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: TypeDescriptor.GetAttributes_Ignores_overriden_attributes_fix.patch
Type: text/x-patch
Size: 10103 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060902/00405ca7/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060902/00405ca7/attachment.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test.cs
Type: application/octet-stream
Size: 937 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060902/00405ca7/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060902/00405ca7/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020274.html">[Mono-dev] mono/interpreter/interp.c build problems
</A></li>
	<LI>Next message: <A HREF="020270.html">[Mono-dev] [PATCH] BUG in TypeDescriptor.GetAttributes :	Ignores overriden attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20269">[ date ]</a>
              <a href="thread.html#20269">[ thread ]</a>
              <a href="subject.html#20269">[ subject ]</a>
              <a href="author.html#20269">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
