<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Mono-winforms-list] Extended error reportingforlibgdiplus/System.Drawing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-winforms-list%5D%20Extended%20error%0A%20reportingforlibgdiplus/System.Drawing&In-Reply-To=1157460664.26675.362.camel%40poupou.home">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020322.html">
   <LINK REL="Next"  HREF="020324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Mono-winforms-list] Extended error reportingforlibgdiplus/System.Drawing</H1>
    <B>Jonathan Gilbert</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-winforms-list%5D%20Extended%20error%0A%20reportingforlibgdiplus/System.Drawing&In-Reply-To=1157460664.26675.362.camel%40poupou.home"
       TITLE="[Mono-dev] [Mono-winforms-list] Extended error reportingforlibgdiplus/System.Drawing">2a5gjx302 at sneakemail.com
       </A><BR>
    <I>Tue Sep  5 13:24:37 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="020322.html">[Mono-dev] [Mono-winforms-list] Extended error reporting	for	libgdiplus/System.Drawing
</A></li>
        <LI>Next message: <A HREF="020324.html">[Mono-dev] C# source files in mcs tree are now UTF-8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20330">[ date ]</a>
              <a href="thread.html#20330">[ thread ]</a>
              <a href="subject.html#20330">[ subject ]</a>
              <a href="author.html#20330">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 08:51 AM 05/09/2006 -0400, Sebastien Pouliot wrote:
&gt;<i>Hello Jonathan,
</I>&gt;<i>
</I>&gt;<i>On Mon, 2006-09-04 at 17:57 -0500, Jonathan Gilbert wrote:
</I>&gt;&gt;<i> Ever since I started working on libgdiplus and the related System.Drawing
</I>&gt;&gt;<i> bits, I've always been somewhat unimpressed by the error reporting
</I>&gt;&gt;<i> capabilities of GDI+. 
</I>&gt;<i>
</I>&gt;<i>True, still very similar to most of the Win32 API ;-)
</I>
Well yes, except that the Win32 API typically does not do a great deal in
any given function call, whereas GDI+ has many layers &amp; modules which can
be involved in a single call (e.g. GdipLoadImageFromStream).

For instance, while loading a BMP file, if the stream is cut off early (or
in fact if any partial fread() occurs), the error code returned will be
InvalidParameter, to indicate that the filename provided refers to an
invalid file. At present, this will be turned into an exception of type
ArgumentException with message:

  Invalid Parameter. A null reference or invalid value was found.

This really doesn't convey what actually went wrong, and with extended
error reporting, the code which currently does:

  status = InvalidParameter;

..could be changed to something like:

  status = GdipSetErrorEx(InvalidParameter, &quot;Unexpected end-of-file while
reading BMP data.&quot;);

&gt;&gt;<i> Comments? 
</I>&gt;<i>
</I>&gt;<i>Yes.
</I>&gt;<i>
</I>&gt;<i>On a general note, I don't like making big changes this late in the 1.2
</I>&gt;<i>beta cycle. No the patch itself isn't big, however it won't be useful
</I>&gt;<i>until other large changes are made.
</I>
I wasn't aware that 1.2 was approaching; if it's going to be soon, then I
would recommend applying this patch to HEAD now (or if a branch for 1.2 has
not yet been made, just after one has been made) but deferring any changes
to make use of the new function until after the release.

&gt;<i>On a technical level:
</I>&gt;<i>
</I>&gt;<i>* this introduce user-visible strings inside libgdiplus - something we
</I>&gt;<i>do not have right now. While translation hasn't been a big issue yet (in
</I>&gt;<i>Mono source code) it will become one (sooner than later) and should be
</I>&gt;<i>addressed as a &quot;day-1&quot; issue (i.e. before the patch gets approved).
</I>
I think GdipSetErrorEx() would be the logical place for any
internationalization efforts, since all of the custom strings go through
there. Of course, this would prevent the use of tools which look for calls
through the _() macro...

&gt;<i>* while error reporting is weak I can't recall many times where an error
</I>&gt;<i>needed a more a detailed explanation. So I'm unsure how much we really
</I>&gt;<i>gain (on the Linux side). Evidently this doesn't affect (nor help) the
</I>&gt;<i>Windows side (Mono or MS runtime) where most of the System.Drawing
</I>&gt;<i>development currently occurs.
</I>
Well, specific errors indicating why an image file couldn't be loaded is
one area that would really get a benefit out of this. Other places wouldn't
have to use the system until someone found a strong reason for it.

&gt;&gt;<i> If nobody thinks this is a bad idea (and some people
</I>&gt;&gt;<i> think it is a good idea), I can commit it.
</I>&gt;<i>
</I>&gt;<i>My feeling is that it's not a bad idea *but* this should wait after Mono
</I>&gt;<i>1.2 release because it won't help immediately, other things needs to be
</I>&gt;<i>addressed and (finally) if we should add this it would be nice to do it
</I>&gt;<i>with some refactoring of the current source code.
</I>&gt;<i>
</I>&gt;<i>However it's worth a longer discussion, along with other current issues
</I>&gt;<i>in libgdiplus. Are you coming, by any chance, to the Mono Summit ?
</I>
I'm afraid I won't be able to make it.

&gt;&gt;<i> +
</I>&gt;&gt;<i> +		/* Ensure TLS storage for error information. */
</I>&gt;&gt;<i> +		if (pthread_key_create(&amp;last_error_status_tls_key, NULL)
</I>&gt;&gt;<i> +		 || pthread_key_create(&amp;last_error_description_tls_key, free))
</I>&gt;&gt;<i> +			use_extended_status = FALSE;
</I>&gt;&gt;<i> +
</I>&gt;<i>
</I>&gt;<i>been a while ? ;-) 
</I>&gt;<i>this (and more) doesn't follow Mono source code conventions
</I>
I'm far more accustomed to no-spare-before-paren styles, but I did catch
myself while making this patch and I thought I had fixed it. Maybe I made
the diff before that point and forgot to re-create it. Certainly, I'll
review it closely for this one.

&gt;&gt;<i> +/* New Error-Reporting Functionality */
</I>&gt;&gt;<i> +GpStatus
</I>&gt;&gt;<i> +GdipSetErrorEx(GpStatus status, char *description)
</I>&gt;&gt;<i> +{
</I>&gt;&gt;<i> +	if (!use_extended_error_reporting)
</I>&gt;&gt;<i> +		return status;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	free(pthread_getspecific(last_error_description_tls_key));
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	pthread_setspecific(last_error_status_tls_key, (void *)status);
</I>&gt;&gt;<i> +	pthread_setspecific(last_error_description_tls_key, strdup(description));
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	return ExtendedError;
</I>&gt;&gt;<i> +}
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +int
</I>&gt;&gt;<i> +GdipGetErrorEx(GpStatus *status, char *description)
</I>&gt;&gt;<i> +{
</I>&gt;&gt;<i> +	char *last_error_description;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	if (status != NULL)
</I>&gt;&gt;<i> +		*status = (GpStatus)pthread_getspecific(last_error_status_tls_key);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	last_error_description =
</I>&gt;&gt;<i> pthread_getspecific(last_error_description_tls_key);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	if (last_error_description != NULL) {
</I>&gt;&gt;<i> +		if (description != NULL)
</I>&gt;&gt;<i> +			strcpy(description, last_error_description);
</I>&gt;&gt;<i> +		return strlen(last_error_description) + 1;
</I>&gt;&gt;<i> +	}
</I>&gt;&gt;<i> +	else {
</I>&gt;&gt;<i> +		if (description != NULL)
</I>&gt;&gt;<i> +			description[0] = '\0';
</I>&gt;&gt;<i> +		return 1; /* Null-terminator only. */
</I>&gt;&gt;<i> +	}
</I>&gt;&gt;<i> +}
</I>
Yeah, the spaces before parentheses are completely missing from the patch I
submitted. My bad :-)

(Personally, I actually think it looks pretty ugly that way, but it's not a
big issue...)

&gt;&gt;<i> +    /* New error-reporting mechanism: This value means that the caller
</I>&gt;&gt;<i> +     * can assume that GdipGetErrorEx () will be present and will
</I>&gt;&gt;<i> +     * return a meaningful error string along with the correct GpStatus
</I>&gt;&gt;<i> +     * value for the last operation on the current thread.
</I>&gt;&gt;<i> +     */
</I>&gt;&gt;<i> +    ExtendedError = 1000000
</I>&gt;<i>
</I>&gt;<i>maybe we should use this as a flag, and not a value
</I>
I prefer it to be a value, because existing code wouldn't know what to do
with a flag anyway, and I would very much like to keep the status stored
alongside its description; it doesn't feel right to have descriptions
stranded with no indication of what the error was at the time.

&gt;&gt;<i> +/* Error */
</I>&gt;&gt;<i> +int GdipGetErrorEx(GpStatus *status, char *description);
</I>&gt;<i>
</I>&gt;<i>please move this into general.h
</I>&gt;<i>
</I>&gt;<i>note: someday we'll need to clean up public/internal API definitions so
</I>&gt;<i>that libgdiplus can be used outside Mono
</I>
Yeah, I was going to put it into general.h, but it didn't look like that
would be visible to outsiders who #include'd &lt;gdip.h&gt;.

&gt;&gt;<i> +		// Extended error reporting
</I>&gt;&gt;<i> +		[DllImport(&quot;gdiplus&quot;)]
</I>&gt;&gt;<i> +		static extern int GdipGetErrorEx (out Status status, StringBuilder
</I>&gt;&gt;<i> description);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +		[DllImport(&quot;gdiplus&quot;)]
</I>&gt;&gt;<i> +		static extern int GdipGetErrorEx (IntPtr status_ptr, StringBuilder
</I>&gt;&gt;<i> description);
</I>&gt;<i>
</I>&gt;<i>Shouldn't this one be GdipSetErrorEx ?
</I>
Nope, these are both GdipGetErrorEx. One of them takes an &quot;out Status&quot; for
the first parameter; the other one permits passing NULL in (IntPtr.Zero),
when the status value is not being retrieved (in this case, because it has
already been retrieved).

The extended error is currently never set from within System.Drawing, and
though there's no reason why it *couldn't* be, I can't see any reason why
it *should* be either.

&gt;&gt;<i> +		static private string coalesce (string t1, string t2)
</I>&gt;&gt;<i> +		{
</I>&gt;&gt;<i> +			return (t1 != null) ? t1 : t2;
</I>&gt;&gt;<i> +		}
</I>&gt;&gt;<i> +
</I>&gt;<i>
</I>&gt;<i>That could be a place to introduce localization, however this would mean
</I>&gt;<i>libgdiplus itself wouldn't be translated (there's good and bad in both
</I>&gt;<i>cases).
</I>
I think this function should be kept simple, so that its function is what
its name says it is. Certainly, though, the default text should be
localized at the same time as any localization occurring within libgdiplus.

&gt;&gt;<i>  		// Converts a status into exception
</I>&gt;&gt;<i>  		static internal void CheckStatus (Status status)
</I>&gt;&gt;<i>  		{
</I>&gt;&gt;<i> +			string error_text = null;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +			if (status == (Status)1000000) { /* GpStatus.ExtendedError */
</I>&gt;&gt;<i> +				int text_length = GdipGetErrorEx (out status, null);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +				StringBuilder text_buffer = new StringBuilder ();
</I>&gt;&gt;<i> +				text_buffer.Length = text_length;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +				GdipGetErrorEx (IntPtr.Zero, text_buffer);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +				for (text_length = 0; text_length &lt; text_buffer.Length; text_length++)
</I>&gt;&gt;<i> +					if (text_buffer[text_length] == '\0')
</I>&gt;&gt;<i> +						break;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +				error_text = text_buffer.ToString(0, text_length);
</I>&gt;&gt;<i> +			}
</I>&gt;<i>
</I>&gt;<i>would be simpler if 1000000 was a mask
</I>
Not really; it still needs to make two calls to GdipGetErrorEx, because it
needs to get the number of chars to allocate in the StringBuilder before
the call. I'd prefer to keep it this way, too, along with the strdup() in
the TLS slot assignment, because it makes it possible for people to
construct error text that includes parameter data (such as a filename).

Using it as a mask would also require a range comparison instead of just
straight equality.

Thanks for the detailed review :-)

Jonathan Gilbert

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020322.html">[Mono-dev] [Mono-winforms-list] Extended error reporting	for	libgdiplus/System.Drawing
</A></li>
	<LI>Next message: <A HREF="020324.html">[Mono-dev] C# source files in mcs tree are now UTF-8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20330">[ date ]</a>
              <a href="thread.html#20330">[ thread ]</a>
              <a href="subject.html#20330">[ subject ]</a>
              <a href="author.html#20330">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
