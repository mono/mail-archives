<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Why do we need separate I18N assemblies?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Why%20do%20we%20need%20separate%20I18N%20assemblies%3F&In-Reply-To=001701c69cee%243a5b9db0%246464a8c0%40ansirua">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019200.html">
   <LINK REL="Next"  HREF="019205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Why do we need separate I18N assemblies?</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Why%20do%20we%20need%20separate%20I18N%20assemblies%3F&In-Reply-To=001701c69cee%243a5b9db0%246464a8c0%40ansirua"
       TITLE="[Mono-dev] Why do we need separate I18N assemblies?">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Sat Jul  1 11:34:54 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019200.html">[Mono-dev] Why do we need separate I18N assemblies?
</A></li>
        <LI>Next message: <A HREF="019205.html">[Mono-dev] genmdesc for MPC8xx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19202">[ date ]</a>
              <a href="thread.html#19202">[ thread ]</a>
              <a href="subject.html#19202">[ subject ]</a>
              <a href="author.html#19202">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Andreas,

Thanks for your quick review and please fill bugs for the issues you
find.

P.S. I encourage you write a Gendarme rule to check for this behavior
(which we can turned on Mono BCL). It's probably faster than doing the
review itself, won't miss any case and can be reused by anyone.

On Sat, 2006-07-01 at 11:10 +0200, Andreas Nahr wrote:
&gt;<i> I had a few minutes and checked through corelib:
</I>&gt;<i> 
</I>&gt;<i> In AppDomainSetup:
</I>&gt;<i> private static string GetAppBase(string appBase)
</I>&gt;<i> {
</I>&gt;<i>       if (appBase == null)
</I>&gt;<i>       {
</I>&gt;<i>             return null;
</I>&gt;<i>       }
</I>&gt;<i>       if ((appBase.Length &gt;= 8) &amp;&amp; appBase.ToLower().StartsWith(&quot;<A HREF="file://&quot;">file://&quot;</A>))
</I>&gt;<i>       {
</I>&gt;<i> .......}
</I>&gt;<i> This should most likely be:
</I>&gt;<i>       if ((appBase.Length &gt;= 8) &amp;&amp; 
</I>&gt;<i> appBase.ToLowerInvariant().StartsWith(&quot;<A HREF="file://&quot;">file://&quot;</A>))
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In Module:
</I>&gt;<i> private static bool filter_by_type_name_ignore_case(Type m, object 
</I>&gt;<i> filterCriteria)
</I>&gt;<i> {
</I>&gt;<i>       string text1 = (string) filterCriteria;
</I>&gt;<i>       if (text1.EndsWith(&quot;*&quot;))
</I>&gt;<i>       {
</I>&gt;<i>             return m.Name.ToLower().StartsWith(text1.Substring(0, 
</I>&gt;<i> text1.Length - 1).ToLower());
</I>&gt;<i>       }
</I>&gt;<i>       return (string.Compare(m.Name, text1, true) == 0);
</I>&gt;<i> }
</I>&gt;<i> These .ToLower() are most likely incorrect, too.
</I>&gt;<i> Others are: RemotingConfiguration.SetCustomErrorsMode(string) and 
</I>&gt;<i> Microsoft.Win32.UnixRegistryApi.ToUnix(String)
</I>&gt;<i> 
</I>&gt;<i> Also lots of stuff in Mono.Security.Uri ist cultural-aware, but probably 
</I>&gt;<i> shouldn't be (in fact it's pretty much mixed there between cultural aware, 
</I>&gt;<i> not-aware and usage of InvariantCulture)
</I>
It's (mostly) a copy of System's Uri which some required changes to be
used by corlib's security classes.

&gt;<i> System.Security.Site.UrlToSite ist most likely wrong, too.
</I>&gt;<i> 
</I>&gt;<i> Several other classes in Mono.Security are actually semantically correct, 
</I>&gt;<i> but make unneccessary use of the Globalization classes and through that 
</I>&gt;<i> produce additional unneeded overhead.
</I>
Please open a bug for them.

&gt;<i> ----- Original Message ----- 
</I>&gt;<i> From: &quot;Andreas Nahr&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ClassDevelopment at A-SoftTech.com</A>&gt;
</I>&gt;<i> To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;; &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
</I>&gt;<i> Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Sent: Saturday, July 01, 2006 12:43 AM
</I>&gt;<i> Subject: Re: [Mono-dev] Why do we need separate I18N assemblies?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> b meant Option b) from above - the Globalization.
</I>&gt;<i> 
</I>&gt;<i> If you look at the profile you will see that a simple Console.WriteLine
</I>&gt;<i> (&quot;A&quot;) results in the usage/compilation of the Globalization classes. This is
</I>&gt;<i> very likely from a bug in the code like comparing two non-cultural-aware
</I>&gt;<i> strings (are there any cultural-aware string in corelib anyway?) in a
</I>&gt;<i> cultural-aware way like this:
</I>&gt;<i> if (String1.ToLower () == String2.ToLower ())
</I>&gt;<i> 
</I>&gt;<i> &gt; By the way what do you exactly mean on &quot;b is triggered because of String
</I>&gt;<i> &gt; handling mistakes within corelib&quot;?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Korn&#233;l
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----- Original Message ----- 
</I>&gt;<i> &gt; From: &quot;Andreas Nahr&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ClassDevelopment at A-SoftTech.com</A>&gt;
</I>&gt;<i> &gt; To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;; &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
</I>&gt;<i> &gt; Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> &gt; Sent: Friday, June 30, 2006 10:26 PM
</I>&gt;<i> &gt; Subject: Re: [Mono-dev] Why do we need separate I18N assemblies?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I think it would be worth it to try to remove the reflection overhead,
</I>&gt;<i> &gt;&gt; because it is not just taking some time but also quite some amount of
</I>&gt;<i> &gt;&gt; additional memory. Personally I would recommend to put the small
</I>&gt;<i> &gt;&gt; encodings
</I>&gt;<i> &gt;&gt; directly into corelib and the larger and seldom used ones in one or more
</I>&gt;<i> &gt;&gt; additional assemblies that could be referenced without reflection and
</I>&gt;<i> &gt;&gt; simply
</I>&gt;<i> &gt;&gt; be deleted when not needed.
</I>&gt;<i> &gt;&gt; I did some simple testing on the potential benefits:
</I>&gt;<i> &gt;&gt; The basic overhead of a Mono Application is a little bit below this:
</I>&gt;<i> &gt;&gt; -----------------------------------------------------------------
</I>&gt;<i> &gt;&gt; Mono Jit statistics
</I>&gt;<i> &gt;&gt; Compiled methods:       35
</I>&gt;<i> &gt;&gt; Methods from AOT:       0
</I>&gt;<i> &gt;&gt; Methods cache lookup:   12
</I>&gt;<i> &gt;&gt; Method trampolines:     868
</I>&gt;<i> &gt;&gt; Basic blocks:           196
</I>&gt;<i> &gt;&gt; Max basic blocks:       14
</I>&gt;<i> &gt;&gt; Allocated vars:         141
</I>&gt;<i> &gt;&gt; Analyze stack repeat:   0
</I>&gt;<i> &gt;&gt; Compiled CIL code size: 1594
</I>&gt;<i> &gt;&gt; Native code size:       5095
</I>&gt;<i> &gt;&gt; Max code size ratio:    32,00 (Object::.ctor)
</I>&gt;<i> &gt;&gt; Biggest method:         1126 (Hashtable::.cctor)
</I>&gt;<i> &gt;&gt; Code reallocs:          3
</I>&gt;<i> &gt;&gt; Allocated code size:    5095
</I>&gt;<i> &gt;&gt; Inlineable methods:     0
</I>&gt;<i> &gt;&gt; Inlined methods:        0
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Created object count:   51
</I>&gt;<i> &gt;&gt; Initialized classes:    53
</I>&gt;<i> &gt;&gt; Used classes:           30
</I>&gt;<i> &gt;&gt; Static data size:       96
</I>&gt;<i> &gt;&gt; VTable data size:       5160
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Generic instances:      0
</I>&gt;<i> &gt;&gt; Initialized classes:    0
</I>&gt;<i> &gt;&gt; Inflated methods:       0 / 0
</I>&gt;<i> &gt;&gt; Inflated types:         0
</I>&gt;<i> &gt;&gt; Generics metadata size: 0
</I>&gt;<i> &gt;&gt; Total time spent compiling 35 methods (sec): 0
</I>&gt;<i> &gt;&gt; -----------------------------------------------------------------
</I>&gt;<i> &gt;&gt; if you do a single
</I>&gt;<i> &gt;&gt; Console.WriteLine (&quot;Test&quot;);
</I>&gt;<i> &gt;&gt; It becomes:
</I>&gt;<i> &gt;&gt; -----------------------------------------------------------------
</I>&gt;<i> &gt;&gt; Test
</I>&gt;<i> &gt;&gt; Mono Jit statistics
</I>&gt;<i> &gt;&gt; Compiled methods:       466
</I>&gt;<i> &gt;&gt; Methods from AOT:       0
</I>&gt;<i> &gt;&gt; Methods cache lookup:   511
</I>&gt;<i> &gt;&gt; Method trampolines:     3333
</I>&gt;<i> &gt;&gt; Basic blocks:           3939
</I>&gt;<i> &gt;&gt; Max basic blocks:       237
</I>&gt;<i> &gt;&gt; Allocated vars:         3102
</I>&gt;<i> &gt;&gt; Analyze stack repeat:   0
</I>&gt;<i> &gt;&gt; Compiled CIL code size: 40443
</I>&gt;<i> &gt;&gt; Native code size:       93100
</I>&gt;<i> &gt;&gt; Max code size ratio:    32,00 (Object::.ctor)
</I>&gt;<i> &gt;&gt; Biggest method:         4930 (SimpleCollator::CompareInternal)
</I>&gt;<i> &gt;&gt; Code reallocs:          40
</I>&gt;<i> &gt;&gt; Allocated code size:    93100
</I>&gt;<i> &gt;&gt; Inlineable methods:     0
</I>&gt;<i> &gt;&gt; Inlined methods:        5
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Created object count:   1800
</I>&gt;<i> &gt;&gt; Initialized classes:    235
</I>&gt;<i> &gt;&gt; Used classes:           153
</I>&gt;<i> &gt;&gt; Static data size:       510
</I>&gt;<i> &gt;&gt; VTable data size:       24312
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Generic instances:      0
</I>&gt;<i> &gt;&gt; Initialized classes:    0
</I>&gt;<i> &gt;&gt; Inflated methods:       0 / 0
</I>&gt;<i> &gt;&gt; Inflated types:         0
</I>&gt;<i> &gt;&gt; Generics metadata size: 0
</I>&gt;<i> &gt;&gt; Total time spent compiling 466 methods (sec): 0,0625
</I>&gt;<i> &gt;&gt; Slowest method to compile (sec): 0,01563: I18N.Common.Handlers::.cctor()
</I>&gt;<i> &gt;&gt; -----------------------------------------------------------------
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; So this means you have about 20 times as much Native Code Size, need
</I>&gt;<i> &gt;&gt; 150-200
</I>&gt;<i> &gt;&gt; msec additional time (See attached textfile for JITTime+Runtime, run on a
</I>&gt;<i> &gt;&gt; 3500+ Athlon) and more than 100kb additional memory. Moreover the GC has
</I>&gt;<i> &gt;&gt; to
</I>&gt;<i> &gt;&gt; manage/kill 1800! Objects already, with no single line of Application
</I>&gt;<i> &gt;&gt; code
</I>&gt;<i> &gt;&gt; run yet.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The overhead actually comes mostly from two places:
</I>&gt;<i> &gt;&gt; a) I18N
</I>&gt;<i> &gt;&gt; b) Globalisation
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; b is triggered because of String handling mistakes within corelib,
</I>&gt;<i> &gt;&gt; however
</I>&gt;<i> &gt;&gt; the biggest share in runtime is I18N (see textfile - 78 ms out of 93 ms
</I>&gt;<i> &gt;&gt; total app time).
</I>&gt;<i> &gt;&gt; In terms of memory it is more complicated to estimate, but from looking
</I>&gt;<i> &gt;&gt; at
</I>&gt;<i> &gt;&gt; the profile one could assume that there are also big potential
</I>&gt;<i> &gt;&gt; optimizations.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; mfg
</I>&gt;<i> &gt;&gt; Andreas
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;I once dreamed to change encoding implementation like you but
</I>&gt;<i> &gt;&gt;&gt; I noticed that it helps few people other than my personal
</I>&gt;<i> &gt;&gt;&gt; satisfaction and spends too much time just for such a niche
</I>&gt;<i> &gt;&gt;&gt; (at least for me).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; When you split conversion map data from I18N.*.dll which is mostly
</I>&gt;<i> &gt;&gt;&gt; extraneous for people who don't use those them, feel free to try
</I>&gt;<i> &gt;&gt;&gt; merging it into mscorlib. Otherwise, I don't like your idea.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Originally I was thinking of simply moving Encoding classes to corlib but
</I>&gt;<i> &gt;&gt; you and Jonathan are right that there are cases when it has advantages if
</I>&gt;<i> &gt;&gt; such large data can be excluded.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; But you are right this would need a lot of time...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Why do you quote Microsoft mscorlib size here? It is far from
</I>&gt;<i> &gt;&gt;&gt; something to do with it. Stop making misleading. To my understanding
</I>&gt;<i> &gt;&gt;&gt; they have different files for encoding maps (*.nlp).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I just tried to glorify the size of our mscorlib.:) If we add the size of
</I>&gt;<i> &gt;&gt; I18N assemblies to the size of our mscorlib our is sill smaller than
</I>&gt;<i> &gt;&gt; Microsoft's one. (And you are right that it has external dependencies so
</I>&gt;<i> &gt;&gt; the
</I>&gt;<i> &gt;&gt; difference may be even more.) As long as our mscorlib can do the same as
</I>&gt;<i> &gt;&gt; their this only means that ours is better and nothing more.:)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; &quot;Mono should be MS.NET compatible&quot; is simply wrong as usual.
</I>&gt;<i> &gt;&gt;&gt; We have broader supported environment which requires different
</I>&gt;<i> &gt;&gt;&gt; thinking.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;From <A HREF="http://www.mono-project.com/FAQ:_General:">http://www.mono-project.com/FAQ:_General:</A>
</I>&gt;<i> &gt;&gt; &quot;Its objective is to enable UNIX developers to build and deploy
</I>&gt;<i> &gt;&gt; cross-platform .NET Applications.&quot;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; And note that this is why I like Mono.:) This goal cannot be achieved
</I>&gt;<i> &gt;&gt; without MS.NET compatibility. Of course I don't mean compatiblitiy at any
</I>&gt;<i> &gt;&gt; costs. Or for example I don't like the bug compatibility at any cost
</I>&gt;<i> &gt;&gt; policy
</I>&gt;<i> &gt;&gt; of MWF altough I admit that it helps run GUI applications that often
</I>&gt;<i> &gt;&gt; relay
</I>&gt;<i> &gt;&gt; on weird SWF behaviours.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Korn&#233;l
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mono-devel-list mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>-- 
Sebastien Pouliot  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien at ximian.com</A>&gt;
Blog: <A HREF="http://pages.infinit.net/ctech/">http://pages.infinit.net/ctech/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019200.html">[Mono-dev] Why do we need separate I18N assemblies?
</A></li>
	<LI>Next message: <A HREF="019205.html">[Mono-dev] genmdesc for MPC8xx
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19202">[ date ]</a>
              <a href="thread.html#19202">[ thread ]</a>
              <a href="subject.html#19202">[ subject ]</a>
              <a href="author.html#19202">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
