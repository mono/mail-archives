<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] COM Interop Patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20COM%20Interop%20Patch&In-Reply-To=17c2d80b0607141044y2ee1219x3677410455d3732d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019421.html">
   <LINK REL="Next"  HREF="019392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] COM Interop Patch</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20COM%20Interop%20Patch&In-Reply-To=17c2d80b0607141044y2ee1219x3677410455d3732d%40mail.gmail.com"
       TITLE="[Mono-dev] COM Interop Patch">vargaz at gmail.com
       </A><BR>
    <I>Fri Jul 14 14:57:15 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019421.html">[Mono-dev] COM Interop Patch
</A></li>
        <LI>Next message: <A HREF="019392.html">[Mono-dev] How do I set Trace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19422">[ date ]</a>
              <a href="thread.html#19422">[ thread ]</a>
              <a href="subject.html#19422">[ subject ]</a>
              <a href="author.html#19422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                                    Hi,

  Since that method is not a native wrapper, it should go into the cominterop
cache.
                         Zoltan

On 7/14/06, Jon Chambers &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">joncham at gmail.com</A>&gt; wrote:
&gt;<i> Thanks for the review Zoltan. I am addressing the issues you brought up. The
</I>&gt;<i> only issue is with the two methods needed for a COM call and their caching.
</I>&gt;<i> The first method (the one that calls the other generated method) is the one
</I>&gt;<i> I need to cache. You said I shouldn't mark it as wrapper type
</I>&gt;<i> MONO_WRAPPER_MANAGED_TO_NATIVE, which makes sense. I'll mark it
</I>&gt;<i> MONO_WRAPPER_COMINTEROP. The second generated method I'll mark
</I>&gt;<i> MONO_WRAPPER_MANAGED_TO_NATIVE, since it is. The second method never needs
</I>&gt;<i> looked up, so I will remove that cache. However, what cache should I put the
</I>&gt;<i> first method into; the native_wrapper_cache or a specific cache for
</I>&gt;<i> cominterop (I can use the cache I was using for the second emitted method,
</I>&gt;<i> since those methods don't need it).
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Jonathan
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 7/14/06, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;                                          Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   Here are my comments:
</I>&gt;<i> &gt; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> &gt; - class.c OK
</I>&gt;<i> &gt; - loader.c:
</I>&gt;<i> &gt;         - why is signature-&gt;cominterop needed, ie IS_IMPORT (m-&gt;klass) can
</I>&gt;<i> be
</I>&gt;<i> &gt; used instead ?
</I>&gt;<i> &gt; - domain.c: OK
</I>&gt;<i> &gt; - image.c: OK
</I>&gt;<i> &gt; - metadata.c:
</I>&gt;<i> &gt;   - The comment of mono_metadata_type_dup_mp is incorrect, also:
</I>&gt;<i> &gt;   - mono_stats.generics_metadata_size += sizeof
</I>&gt;<i> (MonoType);
</I>&gt;<i> &gt;     is not needed
</I>&gt;<i> &gt;   - this is not needed:
</I>&gt;<i> &gt; +       r-&gt;attrs = original-&gt;attrs;
</I>&gt;<i> &gt; +       r-&gt;byref = original-&gt;byref;
</I>&gt;<i> &gt; - metadata-internals.h : OK
</I>&gt;<i> &gt; - the declaration of mono_metadata_type_dup_mp () should go to
</I>&gt;<i> &gt; metadata-internals.h to avoid making it public
</I>&gt;<i> &gt; - object.c OK
</I>&gt;<i> &gt; - class-internals.h OK
</I>&gt;<i> &gt; - object-internals.h OK
</I>&gt;<i> &gt;   - move the '#endregion' in RealProxy.cs to encompass all the fields,
</I>&gt;<i> add a
</I>&gt;<i> &gt;     comment saying that other classes visible to the runtime inherit from
</I>&gt;<i> this
</I>&gt;<i> &gt;     class so all new fields should be added between #region-#endregion.
</I>&gt;<i> &gt; - marshal.c:
</I>&gt;<i> &gt;   - the comment for cominterop_get_method_interface is wrong
</I>&gt;<i> &gt;   - in cominterop_get_native_wrapper_adjusted (), the
</I>&gt;<i> created method is put
</I>&gt;<i> &gt;     into the cache, but never looked up, so either the lookup is missing,
</I>&gt;<i> or
</I>&gt;<i> &gt;     the cache is not really needed.
</I>&gt;<i> &gt;   - in cominterop_get_native_wrapper (), no need to set save_lmf.
</I>&gt;<i> &gt; Also, the wrapper type shouldn't be MONO_WRAPPER_MANAGED_TO_NATIVE,
</I>&gt;<i> &gt; since this calls another managed method, not native code.
</I>&gt;<i> &gt;   - in cominterop_get_invoke (), sig = signature_no_pinvoke () should be
</I>&gt;<i> &gt;     moved after the if ((res = mono_marshal_find_in_cached ()))
</I>&gt;<i> &gt; otherwise it is leaked. This means the if (!sig-&gt;hasthis) line needs
</I>&gt;<i> &gt; to changed as well.
</I>&gt;<i> &gt;   - in cominterop_get_invoke (), no need to set save_lmf. Also, no
</I>&gt;<i> &gt; need for emit_thread_interrupt_checkpoint ().
</I>&gt;<i> &gt; - marshal.h OK
</I>&gt;<i> &gt; - icall.c: The ComObject icalls should be moved to marshal.c.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - Marshal.cs: I think the [MonoTODO]s should remain, since these methods
</I>&gt;<i> can
</I>&gt;<i> &gt;   still throw NotImplementedException ().
</I>&gt;<i> &gt; - __ComObject.cs: This should use #region-#endregion to mark which fields
</I>&gt;<i> are
</I>&gt;<i> &gt;   visible from unmanaged code.
</I>&gt;<i> &gt; - ActivationService.cs: This could use Type.IsImport.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - need to increase corlib version in appdomain.c and
</I>&gt;<i> System/Environment.cs.
</I>&gt;<i> &gt; - it would be nice to add the design comments in your mail to the wiki
</I>&gt;<i> &gt; page about COM Interop and to the code, like the reasoning behind the
</I>&gt;<i> &gt; _adjusted methods.
</I>&gt;<i> &gt; &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Other than these, the code look ok to me. Good Work !
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;              Zoltan
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 7/12/06, Jon Chambers &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">joncham at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; Here is another attempt at a COM Interop patch. First, all
</I>&gt;<i> &gt; &gt; changes/contributions are MIT X11. Now, for a brief overview ;-).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I implemented COM Interop on top of the current remoting infrastructure.
</I>&gt;<i> &gt; &gt; This allows for two main things. 1. Forwarding of method calls to the
</I>&gt;<i> &gt; &gt; underlying unmanaged COM object. 2. Casting RCW (Runtime Callable
</I>&gt;<i> Wrappers -
</I>&gt;<i> &gt; &gt; the managed wrapper around the unmanaged COM object) to interfaces not
</I>&gt;<i> &gt; &gt; specified as implemented in metadata. This can occur if a QueryInterface
</I>&gt;<i> for
</I>&gt;<i> &gt; &gt; that interface's Guid (IID) succeeds on the underlying object.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; So, when a user says &quot;MyComObj obj = new MyComObj()&quot; the runtime creates
</I>&gt;<i> a
</I>&gt;<i> &gt; &gt; ComInteropProxy and returns it's TransparentProxy. However, instead of
</I>&gt;<i> &gt; &gt; forwarding methods via the remoting invoke mechanism using messages, I
</I>&gt;<i> &gt; &gt; shortcut to a Com Interop invoke. The is a great performance boost (by a
</I>&gt;<i> few
</I>&gt;<i> &gt; &gt; orders of magnitude if I recall). I first emit the invoke call, which
</I>&gt;<i> &gt; &gt; transitions the call from a call on the transparent proxy, into a call
</I>&gt;<i> on
</I>&gt;<i> &gt; &gt; the actuall RCW.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The method implementation is done by cominterop_get_native_wrapper. This
</I>&gt;<i> &gt; &gt; emits a method whose signature matches the managed method. The emitted
</I>&gt;<i> &gt; &gt; method calls a final emitted method created by
</I>&gt;<i> &gt; &gt; cominterop_get_native_wrapper_adjusted. The two
</I>&gt;<i> methods,
</I>&gt;<i> &gt; &gt; created by cominterop_get_native_wrapper and
</I>&gt;<i> &gt; &gt; cominterop_get_native_wrapper_adjusted are 1-1. The
</I>&gt;<i> &gt; &gt; adjusted method matches the unmanaged signature, and as thus can reuse
</I>&gt;<i> all
</I>&gt;<i> &gt; &gt; the existing unmanaged calling functionality provided by
</I>&gt;<i> &gt; &gt; mono_marshal_emit_native_wrapper. The only small change
</I>&gt;<i> to
</I>&gt;<i> &gt; &gt; mono_marshal_emit_native_wrapper was that the function
</I>&gt;<i> &gt; &gt; pointer is push onto the stack at call time, rather than when the method
</I>&gt;<i> is
</I>&gt;<i> &gt; &gt; emitted since the function pointer depends on the object making the call
</I>&gt;<i> &gt; &gt; (different objects implementing the same interface could have different
</I>&gt;<i> &gt; &gt; implementations, and thus vtables, thus function pointers).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Another minor note is the internal calls added to __ComObject. This is
</I>&gt;<i> so I
</I>&gt;<i> &gt; &gt; can store a hashtable of COM interfaces and later release them in the
</I>&gt;<i> &gt; &gt; finalizer to ensure proper reference counting. I had a Hashtable in
</I>&gt;<i> managed
</I>&gt;<i> &gt; &gt; code intially but couldn't access it in my finalizer.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I also implemented a series of COM Interop related methods in the
</I>&gt;<i> Marshal
</I>&gt;<i> &gt; &gt; class.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On windows you should be able to run some basic tests. I added a few to
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; cominterop.cs test file but disabled them for the moment. COM is a
</I>&gt;<i> binary
</I>&gt;<i> &gt; &gt; standard and I wasn't sure what vtable layouts would be like on Solaris,
</I>&gt;<i> &gt; &gt; ARM, etc. (I know HP is different) and didn't want to cause regressions
</I>&gt;<i> on
</I>&gt;<i> &gt; &gt; those platforms. But, on windows/linux x86/64 you can enable them and
</I>&gt;<i> run
</I>&gt;<i> &gt; &gt; them. Or more excitingly you can add a reference to an interop assembly
</I>&gt;<i> on
</I>&gt;<i> &gt; &gt; MS and test run real COM objects (Internet Explorer for example). The
</I>&gt;<i> &gt; &gt; largest thing missing right now is the marshalling of com objects. So,
</I>&gt;<i> you
</I>&gt;<i> &gt; &gt; can't call any methods that have parameters/return value of COM objects.
</I>&gt;<i> &gt; &gt; This will be the next thing I work on.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm sure there are some issues, so please review and I'll fix them ASAP.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Thanks,
</I>&gt;<i> &gt; &gt; Jonathan
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019421.html">[Mono-dev] COM Interop Patch
</A></li>
	<LI>Next message: <A HREF="019392.html">[Mono-dev] How do I set Trace
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19422">[ date ]</a>
              <a href="thread.html#19422">[ thread ]</a>
              <a href="subject.html#19422">[ subject ]</a>
              <a href="author.html#19422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
