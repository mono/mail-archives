<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Redirect certain string constructors to	CreateString
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Redirect%20certain%20string%20constructors%20to%0A%09CreateString&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019398.html">
   <LINK REL="Next"  HREF="019444.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Redirect%20certain%20string%20constructors%20to%0A%09CreateString&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString">kornelpal at gmail.com
       </A><BR>
    <I>Thu Jul 13 08:48:01 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019398.html">[Mono-dev] Patch for System.Web BulletedList control
</A></li>
        <LI>Next message: <A HREF="019444.html">[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19401">[ date ]</a>
              <a href="thread.html#19401">[ thread ]</a>
              <a href="subject.html#19401">[ subject ]</a>
              <a href="author.html#19401">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I reallized that simply redirecting the method may not be a good solution 
because the .ctor method is lost from the stack trace this way. And I think 
other problems may occur altough I never experienced such problems.

I attached an extended version of the previous patch that creates a wrapper.

In addition now CreateString () methods are properly implemented and I've 
patched ASCIIEncoding and Latin1Encoding classes so that their GetString () 
methods no longer recurse to CreateString () methods.

If these modifications are approved I'll commit this patch and later it will 
be easier to extend CreateString () to use faster method implementations for 
internal encoding classes. (I changed my mind.:)

Korn&#233;l

----- Original Message ----- 
From: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
To: &quot;Zoltan Varga&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;
Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Wednesday, July 12, 2006 5:27 PM
Subject: Re: [Mono-dev] [PATCH] Redirect certain string constructors to
CreateString


&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> CreateString methods are not yet complete. The attached CreateString
</I>&gt;<i> methods were forged for testing only.
</I>&gt;<i>
</I>&gt;<i> Encoding.GetString() methods are currently using new String (char []) so
</I>&gt;<i> the performance gain were probably insignificant and
</I>&gt;<i> Latin1Encoding.GetString () methods currently use new String (sbyte*, int,
</I>&gt;<i> int) that would result in infinite recursion.
</I>&gt;<i>
</I>&gt;<i> I'm going to check-in the modifications made to the runtime after I finish
</I>&gt;<i> the work on Encoding classes. (And when those modifications will be
</I>&gt;<i> approved as well.)
</I>&gt;<i>
</I>&gt;<i> Thanks for the approval and your help in implementing the code.
</I>&gt;<i>
</I>&gt;<i> Korn&#233;l
</I>&gt;<i>
</I>&gt;<i> ----- Original Message ----- 
</I>&gt;<i> From: &quot;Zoltan Varga&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;
</I>&gt;<i> To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
</I>&gt;<i> Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Sent: Wednesday, July 12, 2006 4:30 PM
</I>&gt;<i> Subject: Re: [Mono-dev] [PATCH] Redirect certain string constructors to
</I>&gt;<i> CreateString
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>           Hi,
</I>&gt;<i>
</I>&gt;<i> This looks ok to check-in, except the Console.WriteLine in CreateString
</I>&gt;<i> ().
</I>&gt;<i>
</I>&gt;<i>        Zoltan
</I>&gt;<i>
</I>&gt;<i> On 7/12/06, Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> Attached a modified version. Using a function instead of (-1) is a good
</I>&gt;&gt;<i> idea
</I>&gt;&gt;<i> not because g_assert_not_reached () can be used but because (-1) will not
</I>&gt;&gt;<i> be
</I>&gt;&gt;<i> monopolized to string constructors (altought it's very unlikely to need
</I>&gt;&gt;<i> any
</I>&gt;&gt;<i> other kind of redirection).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And I added two more g_asserts to ensure that CreateString methods are
</I>&gt;&gt;<i> implemented using managed code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you have any other comments please let me know.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Korn&#233;l
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----- Original Message -----
</I>&gt;&gt;<i> From: &quot;Zoltan Varga&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt;
</I>&gt;&gt;<i> To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
</I>&gt;&gt;<i> Sent: Wednesday, July 12, 2006 12:43 PM
</I>&gt;&gt;<i> Subject: Re: [Mono-dev] [PATCH] Redirect certain string constructors to
</I>&gt;&gt;<i> CreateString
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>                                          Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   This approach seems workable. It would be better to have a dummy string
</I>&gt;&gt;<i> ctor (eg ves_icall_System_String_ctor_CreateString with a body of
</I>&gt;&gt;<i> g_assert_not_reached ()) instead of the ICALL_... constant. Probably
</I>&gt;&gt;<i> only
</I>&gt;&gt;<i> mono_marshal_lock () is needed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 7/11/06, Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt; The previous one did not cache the results. Now this is fixed.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; BTW is mono_loader_lock () and mono_marshal_lock () necessary as well?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Korn&#233;l
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; ----- Original Message -----
</I>&gt;&gt;<i> &gt; From: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
</I>&gt;&gt;<i> &gt; To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> &gt; Sent: Tuesday, July 11, 2006 9:20 AM
</I>&gt;&gt;<i> &gt; Subject: [PATCH] Redirect certain string constructors to CreateString
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; &gt; Hi,
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; The attached patch implements what I was planning to do.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; Note that if the patch is approved I'm not going to commit is yet
</I>&gt;&gt;<i> &gt; &gt; because
</I>&gt;&gt;<i> &gt; &gt; the encoding classes should be updated first.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; This patch contains String.cs modifications as well that should
</I>&gt;&gt;<i> &gt; &gt; compile
</I>&gt;&gt;<i> &gt; &gt; with
</I>&gt;&gt;<i> &gt; &gt; the current encoding classes as well.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; I think this is a good solution and works for me but comments are
</I>&gt;&gt;<i> &gt; &gt; welcome.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; Please review and approve the patch.
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt; &gt; Korn&#233;l
</I>&gt;&gt;<i> &gt; &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: CreateString.diff
Type: application/octet-stream
Size: 8913 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060713/eaf5fae9/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060713/eaf5fae9/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019398.html">[Mono-dev] Patch for System.Web BulletedList control
</A></li>
	<LI>Next message: <A HREF="019444.html">[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19401">[ date ]</a>
              <a href="thread.html#19401">[ thread ]</a>
              <a href="subject.html#19401">[ subject ]</a>
              <a href="author.html#19401">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
