<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Redirect certain string constructors	toCreateString
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Redirect%20certain%20string%20constructors%0A%09toCreateString&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019444.html">
   <LINK REL="Next"  HREF="019412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Redirect certain string constructors	toCreateString</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Redirect%20certain%20string%20constructors%0A%09toCreateString&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Redirect certain string constructors	toCreateString">kornelpal at gmail.com
       </A><BR>
    <I>Mon Jul 17 07:13:18 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019444.html">[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString
</A></li>
        <LI>Next message: <A HREF="019412.html">[Mono-dev] Packaging NAnt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19445">[ date ]</a>
              <a href="thread.html#19445">[ thread ]</a>
              <a href="subject.html#19445">[ subject ]</a>
              <a href="author.html#19445">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I understand what are talking about but I don't really understand how this 
affects my patch.:)

This patch would make the runtime to avoid any unmanaged code in these three 
string .ctors (other string .ctors could simply redirected as well but 
currently there is no use to do so). Strings are allocated 
String.InternalAllocateStr. InternalAllocateStr is currently implemented in 
native code but if managed string allocation were implemented in ther 
runtime these .ctor to CreateString redirections still were useful.

I thing it's easier to patch InternalAllocateStr to a managed string 
allocation code in the runtime rather than every string constructor because 
in these three string .ctors in qestion there is no string allocation done. 
The expected behavior is to let Encoding.GetString allocate the strings. 
Furthermore StringBuilder and TextInfo are using InternalAllocateStr as well 
so I think string allocation should be left in InternalAllocateStr that 
should be called by .ctors later. When InternalAllocateStr will be managed 
there will be use to implement the other string constructors using managed 
code but until that native implementation should be faster because there is 
only one internal call that way.

&gt;<i>The JIT will automatically use the method headers from the Create*
</I>&gt;<i>methods for the implementation of the string ctors internal calls
</I>&gt;<i>with trivial changes to the runtime. This implementation should cover
</I>&gt;<i>your needs and it will avoid having a wrapper in the middle of
</I>&gt;<i>performance-sensitive code.
</I>
I think this patch does exactly the same:
<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060712/a8ba9469/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060712/a8ba9469/attachment.obj</A>

But later I realized that it has drawbacks do do something like this. There 
will be no .ctor in stack trace, security attributes won't be used...

The currently proposed patch:
<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060716/e4a64304/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060716/e4a64304/attachment.obj</A>

Is different only in the fact that there is a simple managed-to-managed 
wrapper (uses CEE_CALL) that is named .ctor and is marked as a wrapper, so 
the runtime can handle it as a wrapper method and the above described 
problems should disappear.

If you have a solution to aviod the wrapper and avoid the above described 
problems at the same time as well it would be appreciated. Otherwise I think 
using a managed-to-managed wrapper is good because the overhead is very 
little.

I think your plans doesn't interfere with this patch and in fact they 
implement a part of your plans. As I see after applying my patch only 
InternalAllocateStr should be made managed to achieve the goals you 
described.

If I didn't understand something correctly please let me know.

Korn&#233;l

----- Original Message ----- 
From: &quot;Paolo Molaro&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, July 17, 2006 12:32 PM
Subject: Re: [Mono-dev] [PATCH] Redirect certain string constructors 
toCreateString


On 07/13/06 Korn&#233;l P&#225;l wrote:
&gt;<i> I reallized that simply redirecting the method may not be a good solution
</I>&gt;<i> because the .ctor method is lost from the stack trace this way. And I 
</I>&gt;<i> think
</I>&gt;<i> other problems may occur altough I never experienced such problems.
</I>&gt;<i>
</I>&gt;<i> I attached an extended version of the previous patch that creates a 
</I>&gt;<i> wrapper.
</I>&gt;<i>
</I>&gt;<i> In addition now CreateString () methods are properly implemented and I've
</I>&gt;<i> patched ASCIIEncoding and Latin1Encoding classes so that their GetString 
</I>&gt;<i> ()
</I>&gt;<i> methods no longer recurse to CreateString () methods.
</I>
I had a change similar to this in my long-term todo list, long term
because to improve performance it will need the changes in the GC that
allow object allocation completely in managed code. This way the string
ctors won't need to perform the managed &lt;&gt; unmanaged transitions.
The change would involve all the string ctors, of course.
Since the change would need to improve performance, using a wrapper
is not allowed, instead the Create* methods would have the same
signature as our currently used internal string ctors (taking a fake
string this first argument and returning the string instead of void).
The JIT will automatically use the method headers from the Create*
methods for the implementation of the string ctors internal calls
with trivial changes to the runtime. This implementation should cover
your needs and it will avoid having a wrapper in the middle of
performance-sensitive code.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A> 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019444.html">[Mono-dev] [PATCH] Redirect certain string constructors to	CreateString
</A></li>
	<LI>Next message: <A HREF="019412.html">[Mono-dev] Packaging NAnt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19445">[ date ]</a>
              <a href="thread.html#19445">[ thread ]</a>
              <a href="subject.html#19445">[ subject ]</a>
              <a href="author.html#19445">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
