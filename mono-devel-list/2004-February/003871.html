<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Problem with P/Invoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Problem%20with%20P/Invoke&In-Reply-To=1075588042.25957.87.camel%40melchior.magi">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003870.html">
   <LINK REL="Next"  HREF="003875.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Problem with P/Invoke</H1>
    <B>Carlos Alberto Cortez Guevara</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Problem%20with%20P/Invoke&In-Reply-To=1075588042.25957.87.camel%40melchior.magi"
       TITLE="[Mono-devel-list] Problem with P/Invoke">carlos at unixmexico.org
       </A><BR>
    <I>Sun Feb  1 19:23:44 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="003870.html">[Mono-devel-list] Problem with P/Invoke
</A></li>
        <LI>Next message: <A HREF="003875.html">[Mono-devel-list] Can one &quot;hook&quot; API functions?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3871">[ date ]</a>
              <a href="thread.html#3871">[ thread ]</a>
              <a href="subject.html#3871">[ subject ]</a>
              <a href="author.html#3871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I didn't know the problem about the function returns, but will take care
of them then (I had seen that IntPtr return in gtk-sharp, but thought it
wasn't neccessary at all ...)

I've seen duncan looked at a test. However, I'm seeing that if you try
to modify a string n-times, it will continue failing. 

If you have a code like:

&lt;code&gt;

[DllImport (&quot;libc&quot;)]
private static extern IntPtr strncpy (StringBuilder dest, string src,
uint length);

string a = &quot;Message to be printed&quot;;
StringBuilder s = new StringBuilder (a.Length);

for (int i = 1;i &lt;= a.Length; i++) {
	strncpy (dest, src, i);
	Console.WriteLine (dest);
}

&lt;/code&gt;

It will print ten &quot;M&quot;. I've updated my mono modules from cvs, and I'm
still getting this error. Let me know if my tree is wrong ..

Thanks in advance,
Carlos.

El s&#225;b, 31-01-2004 a las 16:27, Jonathan Pryor escribi&#243;:
&gt;<i> There are a couple of problems with your DllImport statement.  First of
</I>&gt;<i> all, strncpy(3) is documented as taking a &quot;size_t n&quot; argument, so your
</I>&gt;<i> third argument should be uint, not int, though this really won't matter
</I>&gt;<i> unless you try passing in negative values.
</I>&gt;<i> 
</I>&gt;<i> The second problem is more serious: you have a &quot;string&quot; return type. 
</I>&gt;<i> .NET (and Mono), when marshaling functions with class return types (not
</I>&gt;<i> structures), will attempt to free the memory of the of the returned
</I>&gt;<i> object.  It is assumed that the runtime is supposed to take ownership of
</I>&gt;<i> the memory in the return value.
</I>&gt;<i> 
</I>&gt;<i> Since strncpy(3) returns it's first argument, you *really* don't want
</I>&gt;<i> the runtime to be freeing this memory, so you have two alternatives: use
</I>&gt;<i> a &quot;void&quot; return type, or use System.IntPtr (which can then be converted
</I>&gt;<i> to a string -- without freeing the memory -- using
</I>&gt;<i> System.Runtime.InteropServices.Marshal.PtrToStringAnsi).
</I>&gt;<i> 
</I>&gt;<i> Thus, your DllImport should be:
</I>&gt;<i> 
</I>&gt;<i> 	[DllImport (&quot;libc.so&quot;)]
</I>&gt;<i> 	private static extern IntPtr strncpy (StringBuilder dest,
</I>&gt;<i> 		string src, uint len);
</I>&gt;<i> 
</I>&gt;<i> Now, the bad news begins.  When I try this under Mono 0.29, the code
</I>&gt;<i> doesn't work correctly.  Nothing appears to be copied.
</I>&gt;<i> 
</I>&gt;<i> Could someone running CVS try this example, with the above DllImport
</I>&gt;<i> statement (and appropriate casts to uint), and see if this works?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i>  - Jon
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Fri, 2004-01-30 at 14:16, Carlos Alberto Cortez Guevara wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I was playing with some P/Invoke samples, and I found that the next code
</I>&gt;<i> &gt; doesn't work perfect.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'm loading the strncpy function from the standard library (libc), and
</I>&gt;<i> &gt; the first call works perfect. However, in the second call (and third,
</I>&gt;<i> &gt; ..) it doesn't work.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Is this a bug?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt; Carlos.
</I>-- 
--------------------------------------------------
/* The definition of myself */
using Cortez;
using GeniusIntelligence;

public class Carlos : Human, IGenius, ILinuxUser {

	static void Main () {
		Me.Think();
	}

}

--------------------------------------------------

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003870.html">[Mono-devel-list] Problem with P/Invoke
</A></li>
	<LI>Next message: <A HREF="003875.html">[Mono-devel-list] Can one &quot;hook&quot; API functions?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3871">[ date ]</a>
              <a href="thread.html#3871">[ thread ]</a>
              <a href="subject.html#3871">[ subject ]</a>
              <a href="author.html#3871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
