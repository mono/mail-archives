<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] New compiler--CIL/CTS questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20New%20compiler--CIL/CTS%20questions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004045.html">
   <LINK REL="Next"  HREF="004044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] New compiler--CIL/CTS questions</H1>
    <B>Chris Capel</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20New%20compiler--CIL/CTS%20questions&In-Reply-To="
       TITLE="[Mono-devel-list] New compiler--CIL/CTS questions">chris at iBankTech.NET
       </A><BR>
    <I>Fri Feb 13 20:05:43 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004045.html">[Mono-devel-list] Re: [Mono-patches] libgdiplus/src stringformat.c,NONE,1.1	ChangeLog,1.4,1.5 Makefile.am,1.2,1.3 font.c,1.1,1.2 gdip.h,1.3,1.4	general.c,1.1.1.1,1.2 graphics.c,1.4,1.5 solidbrush.c,1.1.1.1,1.2
</A></li>
        <LI>Next message: <A HREF="004044.html">[Mono-devel-list] New compiler--CIL/CTS questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4041">[ date ]</a>
              <a href="thread.html#4041">[ thread ]</a>
              <a href="subject.html#4041">[ subject ]</a>
              <a href="author.html#4041">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, all.

I'm in the planning phases of writing a Lisp compiler for the CLI, and
I'm stuck trying to figure out how to implement dynamic functions
(lambdas and macros, basically) efficiently using CIL, and cooperating
as much as possible with the CTS.  The problem is, I don't see any way
to generate a method at runtime and then call it without using lots and
lots and lots of really slow, excruciatingly non-dynamic reflection.
The best I've managed so far is this:

AssemblyName n = new AssemblyName();
n.Name = &quot;test&quot;;
AssemblyBuilder asm =
	AppDomain.CurrentDomain.DefineDynamicAssembly(n,
AssemblyBuilderAccess.RunAndSave);
ModuleBuilder m = asm.DefineDynamicModule(&quot;test.exe&quot;, &quot;test.exe&quot;);
MethodBuilder meth = m.DefineGlobalMethod(&quot;MyMethod&quot;,
MethodAttributes.Static
	| MethodAttributes.Public, CallingConventions.Standard,
	typeof(void), null);
ILGenerator il = meth.GetILGenerator();
il.Emit(OpCodes.Ldstr, &quot;Hello world&quot;);
il.EmitCall(OpCodes.Call, typeof(Console).GetMethod(&quot;WriteLine&quot;,
	new Type[] { typeof(string) }),
	null);
il.Emit(OpCodes.Ret);
m.CreateGlobalFunctions();
m.GetMethod(&quot;MyMethod&quot;).Invoke(null, null);

As you can see, this involves creating a module, or at *least* a type
(although I'm not even sure you can call methods on types in a non-baked
module or create new types in a baked one), for every single new
function you want to run, unless you interpret the function manually.  I
mean, I want to have an interpreter, but there's no question that to be
useful, this has to be a compiled language.  Even if this *wasn't* way
too much overhead, there's the issue that any types you created can't be
cleaned up later.  They're going to stick around in your application
domain until you quit.  Never garbage collected.  Never removed from
memory.  They'll just collect and accrue in your dynamic module until it
bursts.  Also, there's a conspicuous lack of any CIL instructions having
to do with dynamic-anything.  Does it bother anyone besides me that you
couldn't write the CTS using CIL, in anything nearly resembling
efficient?

The only thing that occurs to me, given my limited knowledge of the CLI,
is to provide, like most other Lisp compilers, a normal interpreted
mode, and require that the compile function be used only at the
module/package/source file level, so that the overhead doesn't become to
great during debugging. But that solution doesn't solve the lambda/macro
problem (can you imagine the compiler creating a new type every time a
macro was expanded?), which is basically the
ever-growing-number-of-types-that-you-can't-get-rid-of problem; it
doesn't even mitigate it that much.  In fact, it's probably not any
better than making Lisp a non-interactive language, just like any old C
family member.

I read a posting on some MIT list that the CLI was too restrictive to
efficiently implement Lisp.  After reading the ECMA CLI spec, and
experimenting with the System.Reflection.Emit classes pertinent, I'm
beginning to agree.  And that's just a big shame.

Chris Capel

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004045.html">[Mono-devel-list] Re: [Mono-patches] libgdiplus/src stringformat.c,NONE,1.1	ChangeLog,1.4,1.5 Makefile.am,1.2,1.3 font.c,1.1,1.2 gdip.h,1.3,1.4	general.c,1.1.1.1,1.2 graphics.c,1.4,1.5 solidbrush.c,1.1.1.1,1.2
</A></li>
	<LI>Next message: <A HREF="004044.html">[Mono-devel-list] New compiler--CIL/CTS questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4041">[ date ]</a>
              <a href="thread.html#4041">[ thread ]</a>
              <a href="subject.html#4041">[ subject ]</a>
              <a href="author.html#4041">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
