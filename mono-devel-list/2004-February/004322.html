<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] First CIL Regex performance result
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20First%20CIL%20Regex%20performance%20result&In-Reply-To=40422448.7050005%40ulaval.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004321.html">
   <LINK REL="Next"  HREF="004323.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] First CIL Regex performance result</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20First%20CIL%20Regex%20performance%20result&In-Reply-To=40422448.7050005%40ulaval.ca"
       TITLE="[Mono-devel-list] First CIL Regex performance result">bmaurer at users.sourceforge.net
       </A><BR>
    <I>Sun Feb 29 13:34:48 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="004321.html">[Mono-devel-list] First CIL Regex performance result
</A></li>
        <LI>Next message: <A HREF="004323.html">[Mono-devel-list] First CIL Regex performance result
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4322">[ date ]</a>
              <a href="thread.html#4322">[ thread ]</a>
              <a href="subject.html#4322">[ subject ]</a>
              <a href="author.html#4322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 2004-02-29 at 12:41, Eric Durand Tremblay wrote:
&gt;<i> 		blt IL_0096
</I>&gt;<i> 		br  IL_0075
</I>&gt;<i> 	  You can do a simple jump optimization, and change that to:
</I>&gt;<i> 		bge IL_0075
</I>&gt;<i> 
</I>&gt;<i> These two line of IL are independent (One is from emitBranch, the
</I>&gt;<i> other by emitCharacter)  For exemple, a character matching is'nt
</I>&gt;<i> necessary called by a branch.  It can be called directly by an anchor
</I>&gt;<i> or anything else.
</I>
Hrm, maybe we can catch this in the JIT. I think MCS emits code like
this sometimes. For example, when we have:

&gt;<i> while (true) {
</I>&gt;<i> 	i ++;
</I>&gt;<i> 	if (a &lt; b)
</I>&gt;<i> 		continue;
</I>&gt;<i> 	...
</I>&gt;<i> }
</I>
MCS emits
&gt;<i> // i++
</I>&gt;<i>         IL_0006:  ldloc.0
</I>&gt;<i>         IL_0007:  ldc.i4.1
</I>&gt;<i>         IL_0008:  add
</I>&gt;<i>         IL_0009:  stloc.0
</I>&gt;<i> // if (a &lt; b)
</I>&gt;<i>         IL_000a:  ldloc.1
</I>&gt;<i>         IL_000b:  ldloc.2
</I>&gt;<i>         IL_000c:  bge IL_0016
</I>&gt;<i> // continue
</I>&gt;<i>         IL_0011:  br IL_0006
</I>&gt;<i> // ...
</I>
I think this would be easier to get in the JIT.


&gt;<i> 	* In 0xba, you do something similar:
</I>&gt;<i> 
</I>&gt;<i> 		IL_00ba:  beq IL_00c4
</I>&gt;<i> 		IL_00bf:  br IL_0075
</I>&gt;<i> 		IL_00c4:  br IL_012d
</I>
&gt;<i> From Ben :
</I>&gt;<i> 
</I>&gt;<i> Ok, lemme add some of my own:
</I>&gt;<i> &gt; &gt; 	IL_000d:  ldc.i4 0
</I>&gt;<i> &gt; &gt; 	IL_0012:  add 
</I>&gt;<i> x + 0 = x
</I>&gt;<i> The peace of code you this refer to resolve to (int anch_end =
</I>&gt;<i> text_end - match_min + anch_offset)  
</I>&gt;<i> The 0 is anch_offset... You are right, I can test this (anch_offset is
</I>&gt;<i> almost always 0)
</I>Now that I think of it, we should be catching this in the JIT.


&gt;<i> For debugging purposes, some of your code is really complex and hard
</I>&gt;<i> to
</I>&gt;<i> understand. I realize it is not designed to be read, but you are going
</I>&gt;<i> ot make it hard on yourself if you emit code like:
</I>&gt;<i> 
</I>&gt;<i> Yeah, we taught that Dup was more efficient than reloading the value. 
</I>Why think? Why not just look at the code:


&gt;<i> case CEE_DUP: {
</I>&gt;<i> 	/* ... */
</I>&gt;<i> 		
</I>&gt;<i> 	/* 
</I>&gt;<i> 	 * small optimization: if the loaded value was from a local already,
</I>&gt;<i> 	 * just load it twice.
</I>&gt;<i> 	 */
</I>&gt;<i> 	if (ins-&gt;ssa_op == MONO_SSA_LOAD &amp;&amp; 
</I>&gt;<i> 	    (ins-&gt;inst_i0-&gt;opcode == OP_LOCAL || ins-&gt;inst_i0-&gt;opcode == OP_ARG)) {
</I>

&gt;<i> &gt; &gt; IL_00da:  br IL_0128
</I>&gt;<i> &gt; &gt; ...
</I>&gt;<i> &gt; &gt; IL_0128:  br IL_005f
</I>&gt;<i> &gt;   
</I>&gt;<i> That can be simplified.
</I>&gt;<i> &gt; &gt; 	IL_002a:  blt IL_0068
</I>&gt;<i> &gt; &gt; 	IL_0063:  br IL_0028
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 	IL_0068:  ldc.i4.0 
</I>&gt;<i> &gt; &gt; 	IL_0069:  ret
</I>&gt;<i> &gt;   
</I>&gt;<i> The only branch to 68 is the one in 2a. So you can just move the code
</I>&gt;<i> up there.
</I>
Actually, this one could also get caught by the jit. MCS emits this one
too sometimes:


&gt;<i> 		string s = &quot;foo&quot;;
</I>&gt;<i> 		char lastletter = ' ';
</I>&gt;<i> 		foreach (char c in s) {
</I>&gt;<i> 			if (char.IsLetter (c))
</I>&gt;<i> 				lastletter = c;
</I>&gt;<i> 		}
</I>
gives:


&gt;<i>         IL_0000:  ldstr &quot;foo&quot;
</I>&gt;<i>         IL_0005:  stloc.0
</I>&gt;<i>         IL_0006:  ldc.i4.s 0x20
</I>&gt;<i>         IL_0008:  stloc.1
</I>&gt;<i>         IL_0009:  ldloc.0
</I>&gt;<i>         IL_000a:  callvirt instance class [mscorlib]'System.CharEnumerator' valuetype [mscorlib]'System.String'::'GetEnumerator'()
</I>&gt;<i>         IL_000f:  stloc.3
</I>&gt;<i>         IL_0010:  ldloc.3
</I>&gt;<i>         IL_0011:  callvirt instance bool class [mscorlib]'System.CharEnumerator'::'MoveNext'()
</I>&gt;<i>         IL_0016:  brfalse IL_0034
</I>&gt;<i>  
</I>&gt;<i>         IL_001b:  ldloc.3
</I>&gt;<i>         IL_001c:  callvirt instance char class [mscorlib]'System.CharEnumerator'::'get_Current'()
</I>&gt;<i>         IL_0021:  stloc.2
</I>&gt;<i>         IL_0022:  ldloc.2
</I>&gt;<i>         IL_0023:  call bool valuetype [mscorlib]'System.Char'::'IsLetter'(char)
</I>&gt;<i>         IL_0028:  brfalse IL_002f
</I>&gt;<i>  
</I>&gt;<i>         IL_002d:  ldloc.2
</I>&gt;<i>         IL_002e:  stloc.1
</I>&gt;<i>         IL_002f:  br IL_0010
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004321.html">[Mono-devel-list] First CIL Regex performance result
</A></li>
	<LI>Next message: <A HREF="004323.html">[Mono-devel-list] First CIL Regex performance result
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4322">[ date ]</a>
              <a href="thread.html#4322">[ thread ]</a>
              <a href="subject.html#4322">[ subject ]</a>
              <a href="author.html#4322">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
