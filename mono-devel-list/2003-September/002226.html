<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Optimization for ConfigurationSettings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Optimization%20for%20ConfigurationSettings&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002224.html">
   <LINK REL="Next"  HREF="002233.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Optimization for ConfigurationSettings</H1>
    <B>eric lindvall</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Optimization%20for%20ConfigurationSettings&In-Reply-To="
       TITLE="[Mono-devel-list] [PATCH] Optimization for ConfigurationSettings">eric at 5stops.com
       </A><BR>
    <I>Tue Sep 30 14:43:56 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002224.html">[Mono-devel-list] Garbage Collection problem
</A></li>
        <LI>Next message: <A HREF="002233.html">[Mono-devel-list] [PATCH] Optimization for	ConfigurationSettings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2226">[ date ]</a>
              <a href="thread.html#2226">[ thread ]</a>
              <a href="subject.html#2226">[ subject ]</a>
              <a href="author.html#2226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is a patch that helps improve the performance of reading the
.config files by only reading the file once per section.

It should really be using the FileSystemWatcher, but it didn't look like
that has been implemented yet.

e.


-------------- next part --------------
Index: class/System/System.Configuration/ConfigurationSettings.cs
===================================================================
RCS file: /mono/mcs/class/System/System.Configuration/ConfigurationSettings.cs,v
retrieving revision 1.21
diff -u -p -u -r1.21 ConfigurationSettings.cs
--- class/System/System.Configuration/ConfigurationSettings.cs	15 Jul 2003 10:08:31 -0000	1.21
+++ class/System/System.Configuration/ConfigurationSettings.cs	30 Sep 2003 18:38:45 -0000
@@ -4,6 +4,7 @@
 // Author:
 //   Christopher Podurgiel (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">cpodurgiel at msn.com</A>)
 //   Gonzalo Paniagua Javier (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gonzalo at ximian.com</A>)
+//   Eric Lindvall (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">eric at 5stops.com</A>)
 //
 // C) Christopher Podurgiel
 // (c) 2002 Ximian, Inc. (<A HREF="http://www.ximian.com">http://www.ximian.com</A>)
@@ -129,6 +130,65 @@ namespace System.Configuration
 		}
 	}
 
+        //
+        // TODO: this should be changed to use the FileSystemWatcher
+        //
+        //  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">-eric at 5stops.com</A> 9.20.2003
+        //
+        class FileWatcherCache
+        {
+                Hashtable _cacheTable;
+                FileInfo _lastInfo;
+                string _filename;
+
+                public FileWatcherCache (string filename)
+                {
+                        _cacheTable = Hashtable.Synchronized (new Hashtable());
+                        _lastInfo = new FileInfo (filename);
+                        _filename = filename;
+                }
+
+                private bool HasFileChanged()
+                {
+                        FileInfo currentInfo = new FileInfo (_filename);
+
+                        if (_lastInfo.LastWriteTime != currentInfo.LastWriteTime)
+                                return (true);
+
+                        if (_lastInfo.CreationTime != currentInfo.CreationTime)
+                                return (true);
+
+                        if (_lastInfo.Length != currentInfo.Length)
+                                return (true);
+
+                        return (false);
+                }
+
+                private void CheckFileChange()
+                {
+                        if (HasFileChanged() == true)
+                        {
+                                _lastInfo = new FileInfo (_filename);
+
+                                _cacheTable.Clear();
+                        }
+                }
+
+                public void Set (string key, object value)
+                {
+                        CheckFileChange();
+
+                        _cacheTable[key] = value;
+                }
+
+                public object Get (string key)
+                {
+                        CheckFileChange();
+
+                        return (_cacheTable[key]);
+                }
+        }
+
 	class ConfigurationData
 	{
 		ConfigurationData parent;
@@ -136,6 +196,8 @@ namespace System.Configuration
 		string fileName;
 		object removedMark = new object ();
 		object groupMark = new object ();
+                object emptyMark = new object ();
+                FileWatcherCache fileCache = null;
 
 		public ConfigurationData () : this (null)
 		{
@@ -170,6 +232,8 @@ namespace System.Configuration
 					reader.Close();
 			}
 
+                        fileCache = new FileWatcherCache (fileName);
+
 			return true;
 		}
 
@@ -242,7 +306,7 @@ namespace System.Configuration
 			return doc;
 		}
 		
-		public object GetConfig (string sectionName)
+		object GetConfigInternal (string sectionName)
 		{
 			object handler = GetHandler (sectionName);
 			if (handler == null)
@@ -265,6 +329,30 @@ namespace System.Configuration
 			
 			return ((IConfigurationSectionHandler) handler).Create (parentConfig, null, doc.DocumentElement);
 		}
+
+		public object GetConfig (string sectionName)
+		{
+                        object config;
+
+                        // check to see if the handler is in the cache
+                        config = fileCache.Get (sectionName);
+
+                        if (config == emptyMark)
+                                return (null);
+                        else if (config != null)
+                                return (config);
+                        else
+                        {
+                                config = GetConfigInternal (sectionName);
+
+                                if (config == null)
+                                        fileCache.Set (sectionName, emptyMark);
+                                else
+                                        fileCache.Set (sectionName, config);
+
+                                return (config);
+                        }
+                }
 
 		private object LookForFactory (string key)
 		{
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002224.html">[Mono-devel-list] Garbage Collection problem
</A></li>
	<LI>Next message: <A HREF="002233.html">[Mono-devel-list] [PATCH] Optimization for	ConfigurationSettings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2226">[ date ]</a>
              <a href="thread.html#2226">[ thread ]</a>
              <a href="subject.html#2226">[ subject ]</a>
              <a href="author.html#2226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
