<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] TcpChannel hang on Windows.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20TcpChannel%20hang%20on%20Windows.&In-Reply-To=37c5788d0812171203m626bfd07sc6d8af88b46c10c8%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030243.html">
   <LINK REL="Next"  HREF="030246.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] TcpChannel hang on Windows.</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20TcpChannel%20hang%20on%20Windows.&In-Reply-To=37c5788d0812171203m626bfd07sc6d8af88b46c10c8%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] TcpChannel hang on Windows.">kornelpal at gmail.com
       </A><BR>
    <I>Wed Dec 17 16:44:27 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="030243.html">[Mono-dev]  [PATCH] TcpChannel hang on Windows.
</A></li>
        <LI>Next message: <A HREF="030246.html">[Mono-dev] [PATCH] TcpChannel hang on Windows.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30245">[ date ]</a>
              <a href="thread.html#30245">[ thread ]</a>
              <a href="subject.html#30245">[ subject ]</a>
              <a href="author.html#30245">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

You did a great job at implementing support for this functionality but 
I'm afraid that this very functionality is not supported by MS.NET either.

The difference seems to be in terminating the background threads on exit 
rather that in socket handling.

Please see the attached test case that hangs on MS.NET as well. I 
haven't try your patch but I believe that it would not cause this test 
case to hang either.

Korn&#233;l

Bill Holmes wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Over the past week I have been asking some of you how to correct a
</I>&gt;<i> hang on exit with TcpChannels on Windows.  To recap instantiating a
</I>&gt;<i> TcpChannel runs a background thread which calls Socket.Accept and
</I>&gt;<i> blocks.  During shutdown a call to mono_thread_manage executes an APC
</I>&gt;<i> on the waiting thread and then (mono_thread_manage) waits for the
</I>&gt;<i> blocking thread to exit.  The problem is that the APC call does not
</I>&gt;<i> cause the accept call to break.
</I>&gt;<i> 
</I>&gt;<i> There were a couple of suggestions about how to solve this problem.
</I>&gt;<i> Some were specific to accept and others were general patterns
</I>&gt;<i> 'un-stick' blocking calls in the runtime.  I believe that have tried
</I>&gt;<i> them all.  Some did not work while others caused other complications.
</I>&gt;<i> 
</I>&gt;<i> The one I decided on was to call select with a timeout to determine if
</I>&gt;<i> a following accept call would succeed immediately.  Consider it a peek
</I>&gt;<i> on the socket.  If the select times out and no connection is present I
</I>&gt;<i> check the thread state for StopRequested. (Not Abort intentionally.)
</I>&gt;<i> Finally this is an a infinite loop until a connection is present or
</I>&gt;<i> the thread is stopped.  The loop is only applicable to Windows as I do
</I>&gt;<i> not observe a problem on Linux.
</I>&gt;<i> 
</I>&gt;<i> One thing that I had to change was the signature to the internal
</I>&gt;<i> accept call.  I need to know the blocking state of the socket.  If a
</I>&gt;<i> socket is in blocking mode I can go into the loop.  If the socket is
</I>&gt;<i> in non-blocking mode I can not use the loop because it will cause the
</I>&gt;<i> call to accept to block on a non-blocking socket.  The reason I have
</I>&gt;<i> to pass it into the internal call is because after much searching I
</I>&gt;<i> can not find a way to query the blocking state of a socket.  (There is
</I>&gt;<i> no ret = fcntl(fd, F_GETFL, 0); on Windows?)  If anyone knows how to
</I>&gt;<i> query this state let me know and I will be happy to change it.
</I>&gt;<i> 
</I>&gt;<i> -bill
</I>&gt;<i> 
</I>&gt;<i> 2008-12-17  Bill Holmes  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">billholmes54 at gmail.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 	* Socket.cs (Accept_internal) :  Changing the signature to pass
</I>&gt;<i> 	  the blocking state.
</I>&gt;<i> 
</I>&gt;<i> 	* socket-io.h : Changing the signature of
</I>&gt;<i> 	  ves_icall_System_Net_Sockets_Socket_Accept_internal to pass
</I>&gt;<i> 	  the blocking state.
</I>&gt;<i> 
</I>&gt;<i> 	* icall-def.h :  Changing the signature of
</I>&gt;<i> 	  System.Net.Sockets.Socket.Accept_internal to pass the blocking state.
</I>&gt;<i> 
</I>&gt;<i> 	* socket-io.c (ves_icall_System_Net_Sockets_Socket_Accept_internal) :
</I>&gt;<i> 	  For Windows only.  Avoid blocking when calling accept by
</I>&gt;<i> 	  querying for a connection via select.  The loop also queries
</I>&gt;<i> 	  the thread state every 1000 micro seconds for the thread
</I>&gt;<i> 	  stop state.  This will avoid the process hanging on shutdown
</I>&gt;<i> 	  when using a TcpChannel that is never connected to.
</I>&gt;<i> 
</I>&gt;<i> 	Code is contributed under MIT/X11 license.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: BlockingAccept.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081217/165ab667/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081217/165ab667/attachment.pl</A> 
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030243.html">[Mono-dev]  [PATCH] TcpChannel hang on Windows.
</A></li>
	<LI>Next message: <A HREF="030246.html">[Mono-dev] [PATCH] TcpChannel hang on Windows.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30245">[ date ]</a>
              <a href="thread.html#30245">[ thread ]</a>
              <a href="subject.html#30245">[ subject ]</a>
              <a href="author.html#30245">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
