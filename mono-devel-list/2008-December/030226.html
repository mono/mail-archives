<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] FW: RealTimeSignal patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20FW%3A%20RealTimeSignal%20patch&In-Reply-To=E961123C01E7E94AA29163941172913E0722B89B%40mail1.dundee.realtimeworlds.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030219.html">
   <LINK REL="Next"  HREF="030232.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] FW: RealTimeSignal patch</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20FW%3A%20RealTimeSignal%20patch&In-Reply-To=E961123C01E7E94AA29163941172913E0722B89B%40mail1.dundee.realtimeworlds.com"
       TITLE="[Mono-dev] FW: RealTimeSignal patch">jonpryor at vt.edu
       </A><BR>
    <I>Tue Dec 16 15:05:32 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="030219.html">[Mono-dev] FW: RealTimeSignal patch
</A></li>
        <LI>Next message: <A HREF="030232.html">[Mono-dev] FW: RealTimeSignal patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30226">[ date ]</a>
              <a href="thread.html#30226">[ thread ]</a>
              <a href="subject.html#30226">[ subject ]</a>
              <a href="author.html#30226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It looks good.  I see only a few issues.

On Tue, 2008-12-16 at 15:54 +0000, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tim.jenks at realtimeworlds.com</A> wrote:
&gt;<i> Index: class/Mono.Posix/Mono.Unix.Native/Stdlib.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- class/Mono.Posix/Mono.Unix.Native/Stdlib.cs (revision 121281)
</I>&gt;<i> +++ class/Mono.Posix/Mono.Unix.Native/Stdlib.cs (working copy)
</I>&gt;<i> @@ -504,6 +504,16 @@
</I>&gt;<i>  
</I>&gt;<i>                 public static int SetSignalAction (Signum signal, SignalAction action)
</I>&gt;<i>                 {
</I>&gt;<i> +                       return SetSignalAction(NativeConvert.FromSignum (signal), action);
</I>
Space before parenthesis (and elsewhere in the patch).

&gt;<i> Index: class/Mono.Posix/Test/Mono.Unix/UnixSignalTest.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- class/Mono.Posix/Test/Mono.Unix/UnixSignalTest.cs   (revision 121281)
</I>&gt;<i> +++ class/Mono.Posix/Test/Mono.Unix/UnixSignalTest.cs   (working copy)
</I>&gt;<i> @@ -3,11 +3,13 @@
</I>&gt;<i>  //
</I>&gt;<i>  // Authors:
</I>&gt;<i>  //     Jonathan Pryor  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jonpryor at vt.edu</A>&gt;
</I>&gt;<i> +//     Tim Jenks       &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tim.jenks at realtimeworlds.com</A>&gt;
</I>&gt;<i>  //
</I>&gt;<i>  // (C) 2008 Jonathan Pryor
</I>&gt;<i>  //
</I>&gt;<i>  
</I>&gt;<i>  using NUnit.Framework;
</I>&gt;<i> +using NUnit.Framework.SyntaxHelpers;
</I>&gt;<i>  using System;
</I>&gt;<i>  using System.Text;
</I>&gt;<i>  using System.Threading;
</I>&gt;<i> @@ -18,31 +20,171 @@
</I>&gt;<i>  
</I>&gt;<i>         [TestFixture]
</I>&gt;<i>         public class UnixSignalTest {
</I>&gt;<i> +
</I>&gt;<i>                 [Test]
</I>&gt;<i> -               public void TestRaise ()
</I>&gt;<i> +               public void TestRealTimeCstor()
</I>&gt;<i>                 {
</I>&gt;<i> -                       Thread t1 = new Thread (delegate () {
</I>&gt;<i> -                                       using (UnixSignal a = new UnixSignal (Signum.SIGINT)) {
</I>&gt;<i> +                       RealTimeSignum rts = new RealTimeSignum(0);
</I>&gt;<i> +                       using (UnixSignal s = new UnixSignal(rts))
</I>&gt;<i> +                       {
</I>&gt;<i> +                               Assert.That(s.IsRealTimeSignal);
</I>&gt;<i> +                               Assert.That(s.RealTimeSignum, Is.EqualTo(rts));
</I>&gt;<i> +                       }
</I>&gt;<i> +               }
</I>&gt;<i> +
</I>&gt;<i> +               [Test]
</I>&gt;<i> +               [ExpectedException(typeof(ArgumentOutOfRangeException))]
</I>&gt;<i> +               public void TestRealTimeOutOfRange()
</I>&gt;<i> +               {
</I>&gt;<i> +                       RealTimeSignum rts = new RealTimeSignum(int.MaxValue);
</I>
RealTimeSignum tests should be moved into a class/Mono.Posix/Test/Mono.Unix.Native/RealTimeSignum.cs file.

&gt;<i> +               // helper method to create a thread waiting on a UnixSignal
</I>&gt;<i> +               private Thread WaitSignal(UnixSignal signal, int timeout)'
</I>
CreateWaitSignalThread() would be a better name.

&gt;<i> +               {
</I>&gt;<i> +                       Thread t1 = new Thread(delegate() {
</I>&gt;<i>                                                 DateTime start = DateTime.Now;
</I>&gt;<i> -                                               bool r = a.WaitOne (5000, false);
</I>&gt;<i> +                                               bool r = signal.WaitOne (timeout, false);
</I>&gt;<i>                                                 DateTime end = DateTime.Now;
</I>&gt;<i> -                                               Assert.AreEqual (a.Count, 1);
</I>&gt;<i> +                                               Assert.AreEqual (signal.Count, 1);
</I>&gt;<i>                                                 Assert.AreEqual (r, true);
</I>&gt;<i> -                                               if ((end - start) &gt; new TimeSpan (0, 0, 5))
</I>&gt;<i> +                                               if ((end - start) &gt; new TimeSpan (0, 0, timeout/1000))
</I>&gt;<i>                                                         throw new InvalidOperationException (&quot;Signal slept too long&quot;);
</I>&gt;<i> -                                       }
</I>&gt;<i> -                       });
</I>&gt;<i> -                       Thread t2 = new Thread (delegate () {
</I>&gt;<i> -                                       Thread.Sleep (1000);
</I>&gt;<i> -                                       Stdlib.raise (Signum.SIGINT);
</I>&gt;<i> -                       });
</I>&gt;<i> -                       t1.Start ();
</I>&gt;<i> -                       t2.Start ();
</I>&gt;<i> -                       t1.Join ();
</I>&gt;<i> -                       t2.Join ();
</I>&gt;<i> +                                       });
</I>&gt;<i> +                       return t1;
</I>&gt;<i>                 }
</I>...
&gt;<i> +               [Test]
</I>&gt;<i> +               public void TestRaiseRTMINSignal()
</I>&gt;<i> +               {
</I>&gt;<i> +                       RealTimeSignum rts = new RealTimeSignum(0);
</I>&gt;<i> +                       Thread t1 = WaitSignal(new UnixSignal(rts), 5000);
</I>
You need to ensure that the UnixSignal is disposed, as WaitSignal()
won't (and can't).  (The UnixSignal must be disposed so that it will
unregister itself, otherwise subsequent tests may fail.)  Thus, this
would be better done as:

	RealTimeSignum rts = new RealTimeSignum ();
	using (UnixSignal signal = new UnixSignal (rts)) {
		Thread t1 = CreateWaitSignalThread (signal, 5000);
		Thread t2 = ...;
	}

Alternatively, make CreateWaitSignalThread() higher-level, e.g.

	static void MultiThreadTest (UnixSignal signal, int timeout, ThreadStart b)
	{
		Thread t1 = CreateWaitSignalThread (signal, timeout);
		Thread t2 = new Thread (b);
		t1.Start ();
		t2.Start ();
		t1.Join ();
		t2.Join ();
	}

with a caller of:

&#65279;
	RealTimeSignum rts = new RealTimeSignum ();
	using (UnixSignal signal = new UnixSignal (rts)) {
		MultiThreadTest (signal, 5000, delegate () {
			Thread.Sleep (1000);
			Stdlib.raise (rts);
		});
	}

&gt;<i> Index: class/Mono.Posix/Mono.Unix/UnixSignal.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- class/Mono.Posix/Mono.Unix/UnixSignal.cs    (revision 121281)
</I>&gt;<i> +++ class/Mono.Posix/Mono.Unix/UnixSignal.cs    (working copy)
</I>&gt;<i> @@ -3,6 +3,7 @@
</I>&gt;<i>  //
</I>&gt;<i>  // Authors:
</I>&gt;<i>  //   Jonathan Pryor (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jpryor at novell.com</A>)
</I>&gt;<i> +//   Tim Jenks (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tim.jenks at realtimeworlds.com</A>)
</I>&gt;<i>  //
</I>&gt;<i>  // (C) 2008 Novell, Inc.
</I>&gt;<i>  //
</I>&gt;<i> @@ -33,28 +34,106 @@
</I>&gt;<i>  using Mono.Unix.Native;
</I>&gt;<i>  
</I>&gt;<i>  namespace Mono.Unix {
</I>&gt;<i> +
</I>&gt;<i> +       public struct RealTimeSignum
</I>
This type should be moved into Mono.Unix.Native, so that it's in the
same namespace as Signum.

&gt;<i> +#if NET_2_0
</I>&gt;<i> +                : IEquatable &lt;RealTimeSignum&gt;
</I>&gt;<i> +#endif
</I>&gt;<i> +       {
</I>&gt;<i> +               private int rt_offset;
</I>&gt;<i> +               public static readonly RealTimeSignum MinValue = new RealTimeSignum(0);
</I>&gt;<i> +               public static readonly RealTimeSignum MaxValue = new RealTimeSignum(UnixSignal.GetSIGRTMAX() - UnixSignal.GetSIGRTMIN() - 1);
</I>&gt;<i> +       
</I>&gt;<i> +               public RealTimeSignum(int offset)
</I>&gt;<i> +               {
</I>&gt;<i> +                       if (offset &lt; 0)
</I>&gt;<i> +                               throw new ArgumentOutOfRangeException(&quot;Offset cannot be negative&quot;);
</I>&gt;<i> +                       if (offset &gt; (UnixSignal.GetSIGRTMAX()-UnixSignal.GetSIGRTMIN()-1))
</I>
There's no need to call UnixSignal.GetSIGRTMAX() here, as the MaxValue
field has already computed this.  Just do:

	if (offset &gt; MaxValue.Offset)
		throw new &#65279;ArgumentOutOfRangeException(...);

&gt;<i> +               public override bool Equals (object obj)
</I>&gt;<i> +               {
</I>&gt;<i> +                       if ((obj == null) || (obj.GetType () != GetType ()))
</I>&gt;<i> +                               return false;
</I>
This should delegate to Equals(RealTimeSignum) so that the core logic
isn't duplicated.

&gt;<i> +               public int Offset { 
</I>&gt;<i> +                       get { return rt_offset; }
</I>&gt;<i> +               }
</I>
This property should be closer to the constructor, before Equals() and
the overridden operators.

 - Jon


</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030219.html">[Mono-dev] FW: RealTimeSignal patch
</A></li>
	<LI>Next message: <A HREF="030232.html">[Mono-dev] FW: RealTimeSignal patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30226">[ date ]</a>
              <a href="thread.html#30226">[ thread ]</a>
              <a href="subject.html#30226">[ subject ]</a>
              <a href="author.html#30226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
