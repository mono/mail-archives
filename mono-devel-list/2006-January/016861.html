<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mono_thread_attach/mono_thread_detach%20not%20threadsafe%3F&In-Reply-To=F6E4CBD6-CAF9-4E9E-A5F5-284723113B28%40counterpop.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016860.html">
   <LINK REL="Next"  HREF="016873.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?</H1>
    <B>Allan Hsu</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mono_thread_attach/mono_thread_detach%20not%20threadsafe%3F&In-Reply-To=F6E4CBD6-CAF9-4E9E-A5F5-284723113B28%40counterpop.net"
       TITLE="[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?">allan at counterpop.net
       </A><BR>
    <I>Tue Jan 31 00:36:39 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="016860.html">[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?
</A></li>
        <LI>Next message: <A HREF="016873.html">[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16861">[ date ]</a>
              <a href="thread.html#16861">[ thread ]</a>
              <a href="subject.html#16861">[ subject ]</a>
              <a href="author.html#16861">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>One thing I forgot to mention:

This code will not print the warning on OS X or segfault on Linux if  
you run it with GC_DONT_GC=1.

	-Allan
--
Allan Hsu &lt;allan at counterpop dot net&gt;
1E64 E20F 34D9 CBA7 1300  1457 AC37 CBBB 0E92 C779


On Jan 30, 2006, at 7:44 PM, Allan Hsu wrote:

&gt;<i> Lately, we've been seeing a lot of messages in the imeem OS X  
</I>&gt;<i> client that look like this:
</I>&gt;<i>
</I>&gt;<i> ** (process:23127): WARNING **: _wapi_handle_unref: Attempting to  
</I>&gt;<i> unref unused handle 0x7cf
</I>&gt;<i>
</I>&gt;<i> These messages eventually lead to messages of this form:
</I>&gt;<i>
</I>&gt;<i> ** (process:23127): WARNING **: _wapi_thread_apc_pending: error  
</I>&gt;<i> looking up thread handle 0x2c8
</I>&gt;<i>
</I>&gt;<i> I've tracked down these messages to our use of mono_thread_attach  
</I>&gt;<i> and mono_thread_detach; I've isolated the messages down to a small  
</I>&gt;<i> bit of C that mimics the Dumbarton NSThread poser (minus the  
</I>&gt;<i> Objective-C code):
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.blargle.com/~allan/racy.tar.bz2">http://www.blargle.com/~allan/racy.tar.bz2</A>
</I>&gt;<i>
</I>&gt;<i> Is this proper usage of mono_thread_attach/mono_thread_detach? The  
</I>&gt;<i> results that follow seem to suggest that I'm either using these two  
</I>&gt;<i> functions incorrectly, or these functions are not threadsafe and  
</I>&gt;<i> the code in the tarball is exposing some sort of race condition.
</I>&gt;<i>
</I>&gt;<i> The code:
</I>&gt;<i>
</I>&gt;<i> The code simply initializes the JIT and then creates 64 threads  
</I>&gt;<i> that call mono_thread_attach, then mono_thread_detach, then joins  
</I>&gt;<i> each thread and repeats the process indefinitely.
</I>&gt;<i>
</I>&gt;<i> Under Mono 1.1.13.2 on OS X 10.4.4, the sample code eventually  
</I>&gt;<i> generates a lot of _wapi_handle_unref g_log calls that originate  
</I>&gt;<i> from CloseHandle called from the finalizer thread:
</I>&gt;<i>
</I>&gt;<i> #0  0x006e8688 in g_log ()
</I>&gt;<i> #1  0x00317130 in _wapi_handle_unref (handle=0x2863) at handles.c:827
</I>&gt;<i> #2  0x00317c18 in CloseHandle (handle=0x2863) at handles.c:1040
</I>&gt;<i> #3  0x00309d74 in  
</I>&gt;<i> ves_icall_System_Threading_Thread_Thread_free_internal (this=0x0,  
</I>&gt;<i> thread=0x10) at threads.c:555
</I>&gt;<i> #4  0x00064c58 in ?? ()
</I>&gt;<i> #5  0x00064968 in ?? ()
</I>&gt;<i> #6  0x0006458c in ?? ()
</I>&gt;<i> #7  0x0022f334 in mono_jit_runtime_invoke (method=0x111c6c0,  
</I>&gt;<i> obj=0xe4870, params=0x0, exc=0xf0103c90) at mini.c:9863
</I>&gt;<i> #8  0x002e5b9c in mono_runtime_invoke (method=0x0, obj=0x10,  
</I>&gt;<i> params=0x382300, exc=0x3822ec) at object.c:1346
</I>&gt;<i> #9  0x002b446c in run_finalize (obj=0xe4870, data=0x0) at gc.c:102
</I>&gt;<i> #10 0x00343920 in GC_invoke_finalizers ()
</I>&gt;<i> #11 0x002b5300 in finalizer_thread (unused=0x0) at gc.c:778
</I>&gt;<i> #12 0x003097c8 in start_wrapper (data=0x0) at threads.c:305
</I>&gt;<i> #13 0x0032a360 in timed_thread_start_routine (args=0x1120a40) at  
</I>&gt;<i> timed-thread.c:134
</I>&gt;<i> #14 0x9002b200 in _pthread_body ()
</I>&gt;<i>
</I>&gt;<i> Sometimes (though rarely), this code will cause Mono on OS X to  
</I>&gt;<i> segfault. This will happen more often if you increase  
</I>&gt;<i> CHUNK_THREADCOUNT to 200 or more.
</I>&gt;<i>
</I>&gt;<i> Under Mono 1.1.13.2  on (32-bit) Linux 2.6.9, the sample code  
</I>&gt;<i> almost immediately dies with a segfault; Mono catches the segfault  
</I>&gt;<i> roughly half the time. Here is a backtrace:
</I>&gt;<i>
</I>&gt;<i> 0x00d1c890 in pthread_kill () from /lib/tls/libpthread.so.0
</I>&gt;<i> (gdb) bt
</I>&gt;<i> #0  0x00d1c890 in pthread_kill () from /lib/tls/libpthread.so.0
</I>&gt;<i> #1  0x0025bb05 in GC_suspend_all () from /usr/lib/libmono.so.0
</I>&gt;<i> #2  0x0025bb49 in GC_suspend_all () from /usr/lib/libmono.so.0
</I>&gt;<i> #3  0x0025bcf7 in GC_stop_world () from /usr/lib/libmono.so.0
</I>&gt;<i> #4  0x0024b731 in GC_stopped_mark () from /usr/lib/libmono.so.0
</I>&gt;<i> #5  0x0024b3b4 in GC_try_to_collect_inner () from /usr/lib/ 
</I>&gt;<i> libmono.so.0
</I>&gt;<i> #6  0x0024c4f3 in GC_collect_or_expand () from /usr/lib/libmono.so.0
</I>&gt;<i> #7  0x0024c736 in GC_allocobj () from /usr/lib/libmono.so.0
</I>&gt;<i> #8  0x00250ed1 in GC_generic_malloc_inner () from /usr/lib/ 
</I>&gt;<i> libmono.so.0
</I>&gt;<i> #9  0x00250ff1 in GC_generic_malloc () from /usr/lib/libmono.so.0
</I>&gt;<i> #10 0x002512dd in GC_malloc () from /usr/lib/libmono.so.0
</I>&gt;<i> #11 0x001da3df in mono_gc_alloc_fixed () from /usr/lib/libmono.so.0
</I>&gt;<i> #12 0x001f3385 in mono_thread_get_pending_exception ()
</I>&gt;<i>    from /usr/lib/libmono.so.0
</I>&gt;<i> #13 0x001f3531 in mono_thread_get_pending_exception ()
</I>&gt;<i>    from /usr/lib/libmono.so.0
</I>&gt;<i> #14 0x001f0718 in mono_thread_attach () from /usr/lib/libmono.so.0
</I>&gt;<i> #15 0x080487f1 in thread_function ()
</I>&gt;<i> #16 0x00d19341 in start_thread () from /lib/tls/libpthread.so.0
</I>&gt;<i> #17 0x00c846fe in clone () from /lib/tls/libc.so.6
</I>&gt;<i>
</I>&gt;<i> 	-Allan
</I>&gt;<i> --
</I>&gt;<i> Allan Hsu &lt;allan at counterpop dot net&gt;
</I>&gt;<i> 1E64 E20F 34D9 CBA7 1300  1457 AC37 CBBB 0E92 C779
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016860.html">[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?
</A></li>
	<LI>Next message: <A HREF="016873.html">[Mono-dev] mono_thread_attach/mono_thread_detach not threadsafe?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16861">[ date ]</a>
              <a href="thread.html#16861">[ thread ]</a>
              <a href="subject.html#16861">[ subject ]</a>
              <a href="author.html#16861">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
