<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Creating AppDomains From Embedded Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Creating%20AppDomains%20From%20Embedded%20Mono&In-Reply-To=20060111181726.92783.qmail%40web25002.mail.ukl.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016585.html">
   <LINK REL="Next"  HREF="016588.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Creating AppDomains From Embedded Mono</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Creating%20AppDomains%20From%20Embedded%20Mono&In-Reply-To=20060111181726.92783.qmail%40web25002.mail.ukl.yahoo.com"
       TITLE="[Mono-dev] Creating AppDomains From Embedded Mono">vargaz at gmail.com
       </A><BR>
    <I>Wed Jan 11 14:08:32 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="016585.html">[Mono-dev] Creating AppDomains From Embedded Mono
</A></li>
        <LI>Next message: <A HREF="016588.html">[Mono-dev] Creating AppDomains From Embedded Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16586">[ date ]</a>
              <a href="thread.html#16586">[ thread ]</a>
              <a href="subject.html#16586">[ subject ]</a>
              <a href="author.html#16586">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                                                  Hi,

  You might want to try to compile the runtime yourself using VS.NET.
The instructions
to do this are available in the README.vsnet directory in the runtime
source root
directory. This would enable you to step into the runtime code when debugging.

                                       Zoltan

On 1/11/06, Jim Purbrick &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jimpurbrick at yahoo.co.uk</A>&gt; wrote:
&gt;<i> Hi Robert/Lupus/Everyone,
</I>&gt;<i>
</I>&gt;<i> I've tried Robert's approach (which cleans my code up,
</I>&gt;<i> but is vulnerable to changes in _MonoAppDomain as
</I>&gt;<i> Paolo said), but I still get the same crash when
</I>&gt;<i> making the mono_runtime_invoke() call to
</I>&gt;<i> AppDomain.CreateDomain().
</I>&gt;<i>
</I>&gt;<i> At this point I'm struggling with the limited
</I>&gt;<i> debugging I can do in VS 2003 when the code calls in
</I>&gt;<i> to glib or the mono. The error I get is Unhandled
</I>&gt;<i> exception at 0x10059acc in debugsim.exe: 0xC0000005:
</I>&gt;<i> Access violation reading location 0x00000007. And the
</I>&gt;<i> call stack is:
</I>&gt;<i>
</I>&gt;<i>         mono.dll!10059acc()
</I>&gt;<i>         libglib-2.0-0.dll!0032bb3e()
</I>&gt;<i>         mono.dll!10059bad()
</I>&gt;<i>         libglib-2.0-0.dll!0032baf9()
</I>&gt;<i>         mono.dll!10059736()
</I>&gt;<i>         mono.dll!1002b3ba()
</I>&gt;<i>         mono.dll!1002b7a0()
</I>&gt;<i>         mono.dll!10067527()
</I>&gt;<i>         debugsim.exe!createDomain(const char *
</I>&gt;<i> name=0x0302edf8)  Line 31 + 0x11        C++
</I>&gt;<i>
</I>&gt;<i> Which doesn't tell me a lot. I wonder whether the
</I>&gt;<i> problem is something to do with my new Windows
</I>&gt;<i> configuration as the code worked fine with mono
</I>&gt;<i> 1.1.9.2 in my old Windows installation, but now I get
</I>&gt;<i> this problem with mono 1.1.9.2, 1.1.12.1 and 1.1.13.
</I>&gt;<i> Could some differences in the environment be causing
</I>&gt;<i> the problem? The value of MONO_PATH or some other
</I>&gt;<i> environment variable? This is just wild speculation
</I>&gt;<i> really. Is there anything else I can do to diagnose
</I>&gt;<i> the problem?
</I>&gt;<i>
</I>&gt;<i> At the moment I'm thinking the best thing to do might
</I>&gt;<i> be to #define the code to use a single AppDomain on
</I>&gt;<i> Windows and just do the secondary AppDomain creation
</I>&gt;<i> and unloading on Linux, which is our production
</I>&gt;<i> environment anyway. I'm loathe to make the 2 versions
</I>&gt;<i> behave differently, but it would allow me to make some
</I>&gt;<i> forward progress while trying to sort this problem out
</I>&gt;<i> as a background task.
</I>&gt;<i>
</I>&gt;<i> Thanks for all your help on this.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Jim.
</I>&gt;<i>
</I>&gt;<i> --- Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi Jim,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hi Robert/Everyone,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;&gt;You can and *should* invoke the managed
</I>&gt;<i> &gt; &gt;&gt;AppDomain methods to load and unload domains.
</I>&gt;<i> &gt; &gt;&gt;You don't need an intermediate managed assembly
</I>&gt;<i> &gt; &gt;&gt;to do that (untested):
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;MonoAppDomain*
</I>&gt;<i> &gt; &gt;&gt;createDomain (char *name) ....
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;void
</I>&gt;<i> &gt; &gt;&gt;unloadDomain (MonoAppDomain *domain) ...
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; That gets me a MonoAppDomain*, which I can
</I>&gt;<i> &gt; presumably
</I>&gt;<i> &gt; &gt; use to call AppDomain.Load(Byte[]) to load a
</I>&gt;<i> &gt; script's
</I>&gt;<i> &gt; &gt; assembly, which will be unloaded (along with JIT
</I>&gt;<i> &gt; &gt; output etc.) when I call unloadDomain?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; MonoAppDomain is the unmanaged representation of
</I>&gt;<i> &gt; System.AppDomain.
</I>&gt;<i> &gt; You can call every System.AppDomain method using
</I>&gt;<i> &gt; mono_runtime_invoke,
</I>&gt;<i> &gt; like in my sample above.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; How do I turn the MonoAppDomain in to a MonoDomain
</I>&gt;<i> &gt; &gt; required by mono_object_new, mono_string_new etc.?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Indeed, there is no accessor defined for it, but you
</I>&gt;<i> &gt; can
</I>&gt;<i> &gt; define this struct somewhere after you include
</I>&gt;<i> &gt; appdomain.h:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; struct _MonoAppDomain {
</I>&gt;<i> &gt;          MonoObject obj;
</I>&gt;<i> &gt;          MonoObject *identity;
</I>&gt;<i> &gt;          MonoDomain *data;
</I>&gt;<i> &gt; };
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; That is what my intermediate managed assemblies
</I>&gt;<i> &gt; were
</I>&gt;<i> &gt; &gt; doing: executing an assembly in the new domain
</I>&gt;<i> &gt; which
</I>&gt;<i> &gt; &gt; would call mono_domain_get() to get me a
</I>&gt;<i> &gt; MonoDomain*
</I>&gt;<i> &gt; &gt; for the new MonoAppDomain.
</I>&gt;<i> &gt;  &gt;
</I>&gt;<i> &gt; &gt; Do I even need a MonoDomain* for the new
</I>&gt;<i> &gt; &gt; MonoAppDomain? At the moment I try to allocate any
</I>&gt;<i> &gt; &gt; objects used by a script in the AppDomain that I
</I>&gt;<i> &gt; &gt; loaded the script's assembly in to, but I suppose
</I>&gt;<i> &gt; I
</I>&gt;<i> &gt; &gt; could allocate the other objects in the root
</I>&gt;<i> &gt; domain.
</I>&gt;<i> &gt; &gt; Would there be any problems doing this? My concern
</I>&gt;<i> &gt; &gt; would be that the root domain would end up loading
</I>&gt;<i> &gt; the
</I>&gt;<i> &gt; &gt; script's assembly which I then couldn't unload.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You have to use the proper MonoDomain.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Robert
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ___________________________________________________________
</I>&gt;<i> Yahoo! Photos &#8211; NEW, now offering a quality print service from just 8p a photo <A HREF="http://uk.photos.yahoo.com">http://uk.photos.yahoo.com</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016585.html">[Mono-dev] Creating AppDomains From Embedded Mono
</A></li>
	<LI>Next message: <A HREF="016588.html">[Mono-dev] Creating AppDomains From Embedded Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16586">[ date ]</a>
              <a href="thread.html#16586">[ thread ]</a>
              <a href="subject.html#16586">[ subject ]</a>
              <a href="author.html#16586">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
