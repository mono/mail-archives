<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20MS.NET%20compatible%20Path.GetTempFileName&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016496.html">
   <LINK REL="Next"  HREF="016499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20MS.NET%20compatible%20Path.GetTempFileName&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName">kornelpal at hotmail.com
       </A><BR>
    <I>Fri Jan  6 15:20:19 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="016496.html">[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName
</A></li>
        <LI>Next message: <A HREF="016499.html">[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16497">[ date ]</a>
              <a href="thread.html#16497">[ thread ]</a>
              <a href="subject.html#16497">[ subject ]</a>
              <a href="author.html#16497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

&gt;<i> I have no idea how on earth an application could depend on this specific
</I>&gt;<i> pattern (without being completely pendantic and checking for .tmp). Did
</I>&gt;<i> this issue happen with some real life app?
</I>
The actual issue I experienced is the fact that Path.GetTempFileName
implementation of Mono creates a file with no extension while MS.NET creates
a file with extension .tmp.

I am working on some Win32 resource file and resource table (in PE file)
generation framework that is compatible with MS cvtres.exe (that is used by
MS.NET SRE and compilers). cvtres.exe appends .res extension if the resource
file has no extension. This causes a bug in MS.NET in fact but as far as I
know Mono policy is to copy MS.NET bugs.

I experienced this bug when I used filenames generated by GetTempFileName.
They worked on MS.NET but failed on Mono.

I think format of temp file names may be and can be assumed as it is clearly
documented.
(<A HREF="http://msdn.microsoft.com/library/en-us/fileio/fs/gettempfilename.asp">http://msdn.microsoft.com/library/en-us/fileio/fs/gettempfilename.asp</A>)

&gt;<i> What does msft do if you create all 64k files tmp0000.tmp to tmpffff.tmp?
</I>&gt;<i> That sounds like a trivial DoS.
</I>
(Note that there is no zero padding so first file name is tmp0.tmp.) MS.NET
will throw an exception (IOException with ERROR_FILE_EXISTS) while Mono will
hang in an infinite loop. 32-bit integers can owerflow as well so it isn't a
protection agains DoS (of course I understand what you mean that a 16-bit
integer can overflow earlier but this is true for MS.NET as well). A correct
solution should avoid infinite loop anyway.

If you are interested in the actual result of this overflow run the attached
on MS.NET. It will finish in a reasonable time.

Also note that the behavior regarding this infinite loop is not affected by
my patch.

The only thing I cannot understand it the fact that if I submit a patch that
corrects an MS.NET bug in Mono it is rejected or isn't welcomed altought the
same is true for a patch that implements an MS.NET bug.

But note that this patch implements designed and documented behavior rather
than a bug.

Korn&#233;l

----- Original Message -----
From: &quot;Ben Maurer&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;
Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Friday, January 06, 2006 8:44 PM
Subject: Re: [Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName


&gt;&gt;<i> MS.NET uses Windows API GetTempFileName function for
</I>&gt;&gt;<i> Path.GetTempFileName. If we want full compatibility we should implement
</I>&gt;&gt;<i> it in the I/O layer using a global unsigned 16-bit counter that starts
</I>&gt;&gt;<i> from zero and is incremented without overflow check each time
</I>&gt;&gt;<i> GetTempFileName is called.
</I>&gt;<i>
</I>&gt;<i> I have no idea how on earth an application could depend on this specific
</I>&gt;<i> pattern (without being completely pendantic and checking for .tmp). Did
</I>&gt;<i> this issue happen with some real life app?
</I>&gt;<i>
</I>&gt;&gt;<i> Altough a managed implementation can be as good as a native one I think
</I>&gt;&gt;<i> the file name pattern should be the same. The attached patch modifies
</I>&gt;&gt;<i> the pattern to &quot;tmp&lt;UUUU&gt;.tmp&quot; that is the same used by MS.NET. (There
</I>&gt;&gt;<i> is no zero padding in &lt;UUUU&gt;.)
</I>&gt;<i>
</I>&gt;<i> What does msft do if you create all 64k files tmp0000.tmp to tmpffff.tmp?
</I>&gt;<i> That sounds like a trivial DoS.
</I>&gt;<i>
</I>&gt;<i> -- Ben
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: GetTempFileNameOverflow.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060106/9d475886/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060106/9d475886/attachment.pl</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016496.html">[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName
</A></li>
	<LI>Next message: <A HREF="016499.html">[Mono-dev] [PATCH] MS.NET compatible Path.GetTempFileName
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16497">[ date ]</a>
              <a href="thread.html#16497">[ thread ]</a>
              <a href="subject.html#16497">[ subject ]</a>
              <a href="author.html#16497">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
