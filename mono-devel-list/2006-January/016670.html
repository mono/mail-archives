<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20%5BMono-devel-list%5D%20Limiting%20Memory%20Allocation&In-Reply-To=295e750a0601180536na6ecaabu8a0bb46886e37ea4%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016664.html">
   <LINK REL="Next"  HREF="016662.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation</H1>
    <B>Jim Purbrick</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20%5BMono-devel-list%5D%20Limiting%20Memory%20Allocation&In-Reply-To=295e750a0601180536na6ecaabu8a0bb46886e37ea4%40mail.gmail.com"
       TITLE="[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation">jimpurbrick at yahoo.co.uk
       </A><BR>
    <I>Wed Jan 18 15:18:44 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="016664.html">[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation
</A></li>
        <LI>Next message: <A HREF="016662.html">[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16670">[ date ]</a>
              <a href="thread.html#16670">[ thread ]</a>
              <a href="subject.html#16670">[ subject ]</a>
              <a href="author.html#16670">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At the moment no memory is allocated by the script,
it's all allocated by calls in to unmanaged library
functions or by Deserialization, so I could get the
library calls to track the memory they allocate for
scripts and then store that in the script, so when
it's deserialized I still know how much memory the
script is using. 

That works in the short term, but isn't a general
solution for when we allow other languages which can
dynamically allocate memory outside library calls and
open up bits of the .NET framework which may allocate
memory themselves. I don't want to have to transform
the bytecode of all the .NET libraries to inject code
around every newobj or newarr instruction. Also, is
there enough information present at bytecode
transormation time to work out how much memory is
being allocted?

The profiler approach is nice if only I could avoid
including the extra Deserialization info and measuring
the size of binary serializations seems simple and
general too.

If anyone else has any ideas how best to do this
please let me know.

Cheers,

Jim.


--- Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:

&gt;<i>                                               Hi,
</I>&gt;<i> 
</I>&gt;<i>   If you are talking about the memory allocated by
</I>&gt;<i> the script itself,
</I>&gt;<i> I think the best solution would be to explicitly
</I>&gt;<i> generate code to
</I>&gt;<i> track it, i.e. for each newobj
</I>&gt;<i> or newarr IL opcode you emit, emit some statements
</I>&gt;<i> to increase a counter or
</I>&gt;<i> something.
</I>&gt;<i> 
</I>&gt;<i>                                  Zoltan
</I>&gt;<i> 
</I>&gt;<i> On 1/18/06, Jim Purbrick &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jimpurbrick at yahoo.co.uk</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; Hi Ben/Everyone,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --- Ben Maurer &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; Look at heap-prof. My profiler traps memory
</I>&gt;<i> freed by
</I>&gt;<i> &gt; &gt; the gc.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This is currently what I'm using to measure the
</I>&gt;<i> memory
</I>&gt;<i> &gt; used by different scripts. I basically wrap calls
</I>&gt;<i> to
</I>&gt;<i> &gt; the scripts in calls to the profiler which turn on
</I>&gt;<i> and
</I>&gt;<i> &gt; off memory allocation monitoring.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There are 2 problems with this approach:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1) When I deserialize a script the single call to
</I>&gt;<i> &gt; IFormatter.Deserialise allocates a lot of memory
</I>&gt;<i> other
</I>&gt;<i> &gt; than the memory used by the script and a lot of
</I>&gt;<i> those
</I>&gt;<i> &gt; objects don't seem to be GCed, so a lot of objects
</I>&gt;<i> not
</I>&gt;<i> &gt; allocated by the script end up being counted
</I>&gt;<i> towards
</I>&gt;<i> &gt; the script's memory usage.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2) I end up using a lot of memory to keep
</I>&gt;<i> references
</I>&gt;<i> &gt; to every object allocated by the script so that
</I>&gt;<i> when a
</I>&gt;<i> &gt; GC occurs I can iterate through the list and
</I>&gt;<i> return
</I>&gt;<i> &gt; memory to the script for every object in the list
</I>&gt;<i> &gt; which has been collected.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Can anyone think of ways round these problems or
</I>&gt;<i> &gt; better ways to keep track of the memory allocated
</I>&gt;<i> by
</I>&gt;<i> &gt; scripts? Given that I use serialization to move
</I>&gt;<i> &gt; scripts between appdomains and processes I wonder
</I>&gt;<i> &gt; whether just measuring the size of a binary
</I>&gt;<i> &gt; serialization of the script might be a close
</I>&gt;<i> enough
</I>&gt;<i> &gt; approximation of its memory usage.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Cheers,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Jim.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>___________________________________________________________
&gt;<i> &gt; To help you stay safe and secure online, we've
</I>&gt;<i> developed the all new Yahoo! Security Centre.
</I>&gt;<i> <A HREF="http://uk.security.yahoo.com">http://uk.security.yahoo.com</A>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I><A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
&gt;<i> &gt;
</I>&gt;<i> 
</I>


	
	
		
___________________________________________________________ 
Yahoo! Messenger - NEW crystal clear PC to PC calling worldwide with voicemail <A HREF="http://uk.messenger.yahoo.com">http://uk.messenger.yahoo.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016664.html">[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation
</A></li>
	<LI>Next message: <A HREF="016662.html">[Mono-dev] Re: [Mono-devel-list] Limiting Memory Allocation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16670">[ date ]</a>
              <a href="thread.html#16670">[ thread ]</a>
              <a href="subject.html#16670">[ subject ]</a>
              <a href="author.html#16670">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
