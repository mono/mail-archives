<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Selective Logging patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Selective%20Logging%20patch&In-Reply-To=03d401c3284d%24c9c30560%240500a8c0%40jaybook">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000998.html">
   <LINK REL="Next"  HREF="000999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Selective Logging patch</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Selective%20Logging%20patch&In-Reply-To=03d401c3284d%24c9c30560%240500a8c0%40jaybook"
       TITLE="[Mono-devel-list] Selective Logging patch">lupus at ximian.com
       </A><BR>
    <I>Fri Jun  6 13:36:34 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="000998.html">[Mono-devel-list] Selective Logging patch
</A></li>
        <LI>Next message: <A HREF="000999.html">[Mono-devel-list] IPv6 patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1025">[ date ]</a>
              <a href="thread.html#1025">[ thread ]</a>
              <a href="subject.html#1025">[ subject ]</a>
              <a href="author.html#1025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/01/03 Jerome Laban wrote:
&gt;<i> 	Here is an update for mini of the selective logging patch. I've also updated the man page.
</I>
I committed the utils/ changes, but see below for comments.

&gt;<i> +          asm      Show assembly loading messages
</I>
aload instead of asm sounds better to me, asm is too much connectted to
assembly language, while I guess someone will object if we use 'ass':-)

&gt;<i> Index: mono/jit/mono.c
</I>
The old jit is dead, so no need for this.

&gt;<i> +static void mono_gc_warn_handler(char *msg, GC_word arg);
</I>
Put a space between the function name and the parens, also in all the
calls below.

&gt;<i> -		g_warning (&quot;can't resolve internal call, method is null&quot;);
</I>&gt;<i> +		mono_trace_warning (MONO_TRACE_TYPE, &quot;can't resolve internal call, method is null&quot;);
</I>
I'm not sure TRACE_TYPE is appropriate for an icall, maybe this warrants
it's own trace flag.

&gt;<i> --- mono/mini/driver.c	29 May 2003 09:53:39 -0000	1.18
</I>&gt;<i> +++ mono/mini/driver.c	1 Jun 2003 14:44:11 -0000
</I>&gt;<i> @@ -35,6 +35,7 @@
</I>&gt;<i> +		} else if (strncmp (argv [i], &quot;--log-level=&quot;, 12) == 0) {
</I>&gt;<i> +			mono_trace_set_level_string (&amp;argv [i][12]);
</I>
Use argv [i] + 12.

&gt;<i> typedef enum {
</I>&gt;<i> 	MONO_TRACE_ASSEMBLY		= (1&lt;&lt;0),
</I>&gt;<i> 	MONO_TRACE_TYPE			= (1&lt;&lt;1),
</I>&gt;<i> 	MONO_TRACE_DLLIMPORT	= (1&lt;&lt;2),
</I>&gt;<i> 	MONO_TRACE_GC			= (1&lt;&lt;3),
</I>&gt;<i> 
</I>&gt;<i> 	MONO_TRACE_ALL			=   MONO_TRACE_ASSEMBLY |
</I>&gt;<i> 								MONO_TRACE_TYPE |
</I>&gt;<i> 								MONO_TRACE_DLLIMPORT |
</I>&gt;<i> 								MONO_TRACE_GC,
</I>
No comma at the end of the enum list.

&gt;<i> void 
</I>&gt;<i> mono_trace_set_mask_string (char *value);
</I>
This needs to take a const char*, more below.

&gt;<i> static void 
</I>&gt;<i> mono_trace_init (void)
</I>&gt;<i> {
</I>&gt;<i> 	if(level_stack == NULL) {
</I>&gt;<i> 		level_stack = g_queue_new();
</I>&gt;<i> 
</I>&gt;<i> 		mono_trace_set_mask_string(getenv(&quot;MONO_LOG_MASK&quot;));
</I>&gt;<i> 		mono_trace_set_level_string(getenv(&quot;MONO_LOG_LEVEL&quot;));
</I>
Add a space before the opening parens, same for the rest of the code.

&gt;<i> 	if(level &lt;= current_level &amp;&amp; mask &amp; current_mask) {
</I>
Use parens around &quot;mask &amp; current_mask&quot;.

&gt;<i> 		MonoLogLevelEntry *entry = g_malloc(sizeof(MonoLogLevelEntry));
</I>&gt;<i> 		entry-&gt;level	= current_level;
</I>&gt;<i> 		entry-&gt;mask		= current_mask;
</I>&gt;<i> 
</I>&gt;<i>         g_queue_push_head (level_stack, (gpointer)entry);
</I>
There is some whitespace-damage here, use TABs to indent the beginning
of the code, but not to align the '=' in assignments.

&gt;<i> void 
</I>&gt;<i> mono_trace_set_level_string (const char *value)
</I>&gt;<i> {
</I>&gt;<i> 	int i = 0;
</I>&gt;<i> 	const char *valid_vals[] = {&quot;error&quot;, &quot;critical&quot;, &quot;warning&quot;, &quot;message&quot;, &quot;info&quot;, &quot;debug&quot;, NULL};
</I>&gt;<i> 	const GLogLevelFlags valid_ids[] = {G_LOG_LEVEL_ERROR, G_LOG_LEVEL_CRITICAL, G_LOG_LEVEL_WARNING,
</I>&gt;<i> 										G_LOG_LEVEL_MESSAGE, G_LOG_LEVEL_INFO, G_LOG_LEVEL_DEBUG };
</I>
Make the arrays static outside of the function.

&gt;<i> 	while(valid_vals[i]) {
</I>&gt;<i> 		if(!strcmp(valid_vals[i], value)){
</I>&gt;<i> 			mono_trace_set_level(valid_ids[i]);
</I>
Add a space before the opening parens, both '(' and '['.

&gt;<i> void 
</I>&gt;<i> mono_trace_set_mask_string (char *value)
</I>
Value needs to be const char*: you're currently modifying the passed-in
string (with strtok).

&gt;<i> {
</I>&gt;<i> 	int i;
</I>&gt;<i> 	char *tok;
</I>&gt;<i> 	guint32 flags = 0;
</I>&gt;<i> 
</I>&gt;<i> 	const char *valid_flags[] = {&quot;asm&quot;, &quot;type&quot;, &quot;dll&quot;, &quot;gc&quot;, &quot;all&quot;, NULL};
</I>&gt;<i> 	const MonoTraceMask	valid_masks[] = {MONO_TRACE_ASSEMBLY, MONO_TRACE_TYPE, MONO_TRACE_DLLIMPORT,
</I>&gt;<i> 											MONO_TRACE_GC, MONO_TRACE_ALL };
</I>
Make the arrays static outside of the function.

&gt;<i> 	tok	= strtok (value, &quot;,&quot;);
</I>
No need to align here.
strtok is not thread-safe, so it's better avoided, use strchr, for
example.

Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000998.html">[Mono-devel-list] Selective Logging patch
</A></li>
	<LI>Next message: <A HREF="000999.html">[Mono-devel-list] IPv6 patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1025">[ date ]</a>
              <a href="thread.html#1025">[ thread ]</a>
              <a href="subject.html#1025">[ subject ]</a>
              <a href="author.html#1025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
