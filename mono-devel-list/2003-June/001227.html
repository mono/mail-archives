<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for PATH_INFO
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=fwd%3A%20Re%3A%20%5BMono-devel-list%5D%20SimpleWorkerRequest%20patch%20for%20PATH_INFO&In-Reply-To=1055602946.3288.10.camel%40Ben">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001130.html">
   <LINK REL="Next"  HREF="001232.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for PATH_INFO</H1>
    <B>eric lindvall</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=fwd%3A%20Re%3A%20%5BMono-devel-list%5D%20SimpleWorkerRequest%20patch%20for%20PATH_INFO&In-Reply-To=1055602946.3288.10.camel%40Ben"
       TITLE="fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for PATH_INFO">eric at 5stops.com
       </A><BR>
    <I>Wed Jun 25 01:51:33 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001130.html">fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for	PATH_INFO
</A></li>
        <LI>Next message: <A HREF="001232.html">fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for	PATH_INFO
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1227">[ date ]</a>
              <a href="thread.html#1227">[ thread ]</a>
              <a href="subject.html#1227">[ subject ]</a>
              <a href="author.html#1227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>this should fix the problems with the previous patch.

i checked how the MS .NET framework dealt with the PATH_INFO, and the
things i noticed were:

- if it finds a file that exists, everything after that is the PATH_INFO
- if it finds a directory that exists, the entry before it is considered
  the &quot;file&quot;, and everything after that is the PATH_INFO


<A HREF="http://localhost:8080/one/two/index.aspx/happy/days">http://localhost:8080/one/two/index.aspx/happy/days</A>

so if &quot;/one/two/index.aspx&quot; exists, &quot;/one/two/index.aspx&quot; is the _Page, &quot;/happy/days&quot; is the PATH_INFO.

if &quot;/one&quot; exists, &quot;/one/two&quot; is the _Page, &quot;/index.aspx/happy/days&quot; is the
PATH_INFO.

e.


On Sat, 14 Jun 2003, Ben Maurer wrote:

&gt;<i> On Sat, 2003-06-14 at 02:12, eric lindvall wrote:
</I>&gt;<i> &gt; what this does:
</I>&gt;<i> &gt;  - adds PATH_INFO support
</I>&gt;<i> &gt;  - updates GetFilePathTranslated() to make use of Path.Combine()
</I>&gt;<i> &gt;  - gets rid of the null check in GetPathInfo() (we're setting _PathInfo to 
</I>&gt;<i> &gt;    String.Empty now)
</I>&gt;<i> &gt;  - fixed CreatePath() so that it doesn't return String.Empty if the 
</I>&gt;<i> &gt;    _AppVirtualPath is not &quot;/&quot; (to match MS runtime -- does anyone know why it 
</I>&gt;<i> &gt;    was returning String.Empty?)
</I>&gt;<i> 
</I>&gt;<i> Eric,
</I>&gt;<i> 
</I>&gt;<i> Thank you for this patch, this may end up saving my rear ;-). It does do
</I>&gt;<i> a few things wrong however.
</I>&gt;<i> 
</I>&gt;<i> If you request <A HREF="http://localhost:8080/dir/path_info,">http://localhost:8080/dir/path_info,</A> you will get a 404
</I>&gt;<i> (tested with Cassini, IIS). If you request
</I>&gt;<i> <A HREF="http://localhost:8080/trace.axd/pathinfo,">http://localhost:8080/trace.axd/pathinfo,</A> where trace.axd is handled by
</I>&gt;<i> a handler (as it is with MS's impl), you do get a page.
</I>&gt;<i> 
</I>&gt;<i> We need to figure out the way MS does this.
</I>&gt;<i> 
</I>&gt;<i> Also, can you please make sure that this is implemented in System.Web
</I>&gt;<i> under MS? I think I tested this before and it was not. 
</I>&gt;<i> 
</I>&gt;<i> -- Ben
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>-------------- next part --------------
Index: SimpleWorkerRequest.cs
===================================================================
RCS file: /mono/mcs/class/System.Web/System.Web.Hosting/SimpleWorkerRequest.cs,v
retrieving revision 1.6
diff -u -p -u -r1.6 SimpleWorkerRequest.cs
--- SimpleWorkerRequest.cs	4 Feb 2003 17:05:45 -0000	1.6
+++ SimpleWorkerRequest.cs	25 Jun 2003 05:42:15 -0000
@@ -17,7 +17,7 @@ namespace System.Web.Hosting
 	{
 		private string _Page;
 		private string _Query;
-		private string _PathInfo;
+		private string _PathInfo = String.Empty;
 		private string _AppVirtualPath;
 		private string _AppPhysicalPath;
 		private string _AppInstallPath;
@@ -31,7 +31,6 @@ namespace System.Web.Hosting
 		public SimpleWorkerRequest (string Page, string Query, TextWriter Output)
 		{
 			_Page = Page;
-			ParsePathInfo ();
 
 			_Query = Query;
 			AppDomain current = AppDomain.CurrentDomain;
@@ -55,6 +54,8 @@ namespace System.Web.Hosting
 				throw new HttpException (&quot;Invalid app domain&quot;);
 
 			_HasInstallInfo = true;
+
+			ExtractPagePathInfo();
 		}
 
 		public SimpleWorkerRequest (string AppVirtualPath,
@@ -67,12 +68,13 @@ namespace System.Web.Hosting
 				throw new HttpException (&quot;Invalid app domain&quot;);
 
 			_Page = Page;
-			ParsePathInfo ();
 			_Query = Query;
 			_AppVirtualPath = AppVirtualPath;
 			_AppPhysicalPath = CheckAndAddSlash (AppPhysicalPath);
 			_Output = Output;
 			_HasInstallInfo = false;
+
+			ExtractPagePathInfo();
 		}
 
 		[MonoTODO(&quot;Implement security&quot;)]
@@ -114,15 +116,19 @@ namespace System.Web.Hosting
 
 		public override string GetFilePath ()
 		{
-			return CreatePath (false);
+                        return CreatePath (false);
 		}
 
 		public override string GetFilePathTranslated ()
 		{
+                        string page = _Page;
+
 			if (Path.DirectorySeparatorChar != '/')
-				return _AppPhysicalPath + _Page.Replace ('/', Path.DirectorySeparatorChar);
+                        {
+                                page = _Page.Replace ('/', Path.DirectorySeparatorChar);
+                        }
 
-			return _AppPhysicalPath + _Page;
+			return (Path.Combine (_AppPhysicalPath, page));
 		}
 
 		public override string GetHttpVerbName ()
@@ -147,7 +153,7 @@ namespace System.Web.Hosting
 
 		public override string GetPathInfo ()
 		{
-			return (null != _PathInfo) ? _PathInfo : String.Empty;
+			return _PathInfo;
 		}
 
 		public override string GetQueryString ()
@@ -157,8 +163,8 @@ namespace System.Web.Hosting
 
 		public override string GetRawUrl ()
 		{
-			string path = CreatePath (true);
-			if (null != _Query &amp;&amp; _Query.Length &gt; 0)
+                        string path = CreatePath (true);
+                        if (null != _Query &amp;&amp; _Query.Length &gt; 0)
 				return path + &quot;?&quot; + _Query;
 
 			return path;
@@ -256,30 +262,68 @@ namespace System.Web.Hosting
 		}
 
 		// Create's a path string
-		private string CreatePath (bool bIncludePathInfo)
-		{
-			string sPath;
-
-			if (&quot;/&quot; != _AppVirtualPath)
-				sPath = &quot;/&quot; + _Page;
-			else
-				sPath = String.Empty;
-
-			if (bIncludePathInfo &amp;&amp; null != _PathInfo)
-				return sPath + _PathInfo;
-
-			return sPath;
-		}
-
-		// Parses out the string after / known as the &quot;path info&quot;
-		private void ParsePathInfo ()
-		{
-		/*	int iPos = _Page.LastIndexOf(&quot;/&quot;);
-			if (iPos &gt;= 0) {
-				_PathInfo = _Page.Substring (iPos);
-				_Page = _Page.Substring (0, iPos);
-			}*/
-		}
+                private string CreatePath (bool bIncludePathInfo)
+                {
+                        string sPath = Path.Combine (_AppVirtualPath, _Page);
+
+                        if (bIncludePathInfo)
+                        {
+                                sPath += _PathInfo;
+                        }
+
+                        return sPath;
+		}
+
+                //  &quot;The extra path information, as given by the client. In
+                //  other words, scripts can be accessed by their virtual
+                //  pathname, followed by extra information at the end of this
+                //  path. The extra information is sent as PATH_INFO.&quot;
+                private void ExtractPagePathInfo ()
+                {
+                        if (_Page == null || _Page == String.Empty)
+                        {
+                                return;
+                        }
+
+                        string FullPath = GetFilePathTranslated();
+
+                        int PathInfoLength = 0;
+
+                        string LastFile = String.Empty;
+
+                        while (PathInfoLength &lt; _Page.Length)
+                        {
+                                if (LastFile.Length &gt; 0)
+                                {
+                                        // increase it by the length of the file plus 
+                                        // a &quot;/&quot;
+                                        //
+                                        PathInfoLength += LastFile.Length + 1;
+                                }
+
+                                if (File.Exists (FullPath) == true)
+                                {
+                                        break;
+                                }
+
+                                if (Directory.Exists (FullPath) == true)
+                                {
+                                        PathInfoLength -= (LastFile.Length + 1);
+                                        break;
+                                }
+
+                                LastFile = Path.GetFileName (FullPath);
+                                FullPath = Path.GetDirectoryName (FullPath);
+                        }
+
+                        if (PathInfoLength &gt; _Page.Length)
+                        {
+                                return;
+                        }
+
+                        _PathInfo = _Page.Substring (_Page.Length - PathInfoLength);
+                        _Page = _Page.Substring (0, _Page.Length - PathInfoLength);
+                }
 	}
 }
 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001130.html">fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for	PATH_INFO
</A></li>
	<LI>Next message: <A HREF="001232.html">fwd: Re: [Mono-devel-list] SimpleWorkerRequest patch for	PATH_INFO
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1227">[ date ]</a>
              <a href="thread.html#1227">[ thread ]</a>
              <a href="subject.html#1227">[ subject ]</a>
              <a href="author.html#1227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
