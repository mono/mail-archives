<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] poor compression with mono 2.6 (Re: mono 2.6+ : Garbage	added to BinaryWriter/GZipStream output?)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20poor%20compression%20with%20mono%202.6%20%28Re%3A%20mono%202.6%2B%20%3A%20Garbage%0A%09added%20to%20BinaryWriter/GZipStream%20output%3F%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033996.html">
   <LINK REL="Next"  HREF="034004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] poor compression with mono 2.6 (Re: mono 2.6+ : Garbage	added to BinaryWriter/GZipStream output?)</H1>
    <B>Hin-Tak Leung</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20poor%20compression%20with%20mono%202.6%20%28Re%3A%20mono%202.6%2B%20%3A%20Garbage%0A%09added%20to%20BinaryWriter/GZipStream%20output%3F%29&In-Reply-To="
       TITLE="[Mono-dev] poor compression with mono 2.6 (Re: mono 2.6+ : Garbage	added to BinaryWriter/GZipStream output?)">hintak_leung at yahoo.co.uk
       </A><BR>
    <I>Wed Jan 27 21:49:58 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="033996.html">[Mono-dev] [patch] rework the simd intrinsics versioning to bit flags and reorder some structs and arrays to support more open bits.
</A></li>
        <LI>Next message: <A HREF="034004.html">[Mono-dev] poor compression with mono 2.6 (Re: mono 2.6+ :	Garbage added to BinaryWriter/GZipStream output?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34003">[ date ]</a>
              <a href="thread.html#34003">[ thread ]</a>
              <a href="subject.html#34003">[ subject ]</a>
              <a href="author.html#34003">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I found the source of my problem with the poor GZipStream compression with mono 2.6 - it is r138254, which rewrites the gzipstream implementation:

------------------
Author: gonzalo &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gonzalo at e3ebcda4-bce8-0310-ba0a-eca2169e7518</A>&gt;
Date:   Tue Jul 21 02:25:00 2009 +0000

    2009-07-20 Gonzalo Paniagua Javier &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gonzalo at novell.com</A>&gt;
    
        * Makefile.am: replaced zlib_macros.c with zlib-helper.c
        * zlib_macros.c: Removed file.
        * zlib-helper.c: new interface for DeflateStream. Flush() actually
        does something.
------------------

The problem is that this change makes the zlib code compress per each write (before the change, it buffers by the zlib default, which is trying to compress per 32k input). Most of my little program culculates and write 1 byte out, so it is mostly 5-byte zlib header overhead + 1 byte! and the file size is increased about 6 times.

I have tried and tested this patch, which restore the zlib default to the compression code to buffer data before compression. With this patch, I can just replace libMonoPosixHelper.so and get compression behavior similiar to mono 2.4.

So the mono-2.4 behavior and with this patch, 1.2MB data is written out as 280k ; without this patch, mono 2.6 writes 8.1MB out (about x6). Curiously, Microsoft .Net's runtime's Gzipstream implementation seems to do something between - it generates a filesize of 2MB, which possibly means it buffers and compresses by 4-byte chunks, not 1 byte and not 32k. (5-byte overhead + 2-3 bytes after compression).

So a question for Gonzalo Paniagua Javier: do I need to file a bug report properly to get the attached patch committed? It should be obvious why it does what it does.

Cheers,
Hin-Tak

--- On Wed, 27/1/10, Hin-Tak Leung &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">hintak_leung at yahoo.co.uk</A>&gt; wrote:

&gt;<i> (I am not on the list - please CC)
</I>&gt;<i> 
</I>&gt;<i> I have a small application which writes gzip'ed data like
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i> sw = new BinaryWriter(new GZipStream(new
</I>&gt;<i> FileStream(filename,
</I>&gt;<i> &#160; &#160; &#160; FileMode.Create, FileAccess.Write,
</I>&gt;<i> FileShare.None),
</I>&gt;<i> &#160; &#160; &#160; CompressionMode.Compress, true
</I>&gt;<i> &#160; &#160; &#160; );
</I>&gt;<i> sw.Write(...);
</I>&gt;<i> sw.Write(...);
</I>&gt;<i> sw.Flush();
</I>&gt;<i> sw.Close();
</I>&gt;<i> 
</I>&gt;<i> It use to work fine with mono 2.4, and still does in a way
</I>&gt;<i> with mono 2.6 . 
</I>&gt;<i> What happens is that now it seems to append a lot of extra
</I>&gt;<i> garbage to the end of the output.
</I>&gt;<i> 
</I>&gt;<i> The uncompressed data is 1234127 bytes, and still
</I>&gt;<i> recoverable in a indentical manner from the output with gzip
</I>&gt;<i> -dc; but the output file is now 8126815 bytes with mono
</I>&gt;<i> 2.6.x instead of 282363 bytes under mono 2.4.x , so almost
</I>&gt;<i> 8MB of garbage is added somehow. I tried truncating the
</I>&gt;<i> file, but it seems to truncate the gz stream as well.
</I>&gt;<i> 
</I>&gt;<i> So does anybody else observe similiar problems and/or know
</I>&gt;<i> of any reasons why mono 2.6 behaves differently in this
</I>&gt;<i> regard compared to mono 2.4?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>
</I>

      
-------------- next part --------------
A non-text attachment was scrubbed...
Name: gzipstream-patch
Type: application/octet-stream
Size: 423 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100128/9ef66638/attachment-0001.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100128/9ef66638/attachment-0001.obj</A> 
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033996.html">[Mono-dev] [patch] rework the simd intrinsics versioning to bit flags and reorder some structs and arrays to support more open bits.
</A></li>
	<LI>Next message: <A HREF="034004.html">[Mono-dev] poor compression with mono 2.6 (Re: mono 2.6+ :	Garbage added to BinaryWriter/GZipStream output?)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34003">[ date ]</a>
              <a href="thread.html#34003">[ thread ]</a>
              <a href="subject.html#34003">[ subject ]</a>
              <a href="author.html#34003">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
