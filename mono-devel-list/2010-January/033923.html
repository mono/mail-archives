<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for CookieContainer.SetCookies
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20CookieContainer.SetCookies&In-Reply-To=93ED628A-6BFF-4ABC-B73A-F92F8A4246D4%40logos.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033922.html">
   <LINK REL="Next"  HREF="033928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for CookieContainer.SetCookies</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20CookieContainer.SetCookies&In-Reply-To=93ED628A-6BFF-4ABC-B73A-F92F8A4246D4%40logos.com"
       TITLE="[Mono-dev] Patch for CookieContainer.SetCookies">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Wed Jan 20 16:58:02 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="033922.html">[Mono-dev] Patch for CookieContainer.SetCookies
</A></li>
        <LI>Next message: <A HREF="033928.html">[Mono-dev] Patch for CookieContainer.SetCookies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33923">[ date ]</a>
              <a href="thread.html#33923">[ thread ]</a>
              <a href="subject.html#33923">[ subject ]</a>
              <a href="author.html#33923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello again,

Sorry I hit send adding my comments on the patch itself.

&gt;<i> Index: mcs/class/System/System.Net/CookieContainer.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/class/System/System.Net/CookieContainer.cs      (revision 149764)
</I>&gt;<i> +++ mcs/class/System/System.Net/CookieContainer.cs      (working copy)
</I>&gt;<i> @@ -36,6 +36,7 @@
</I>&gt;<i>  using System.Globalization;
</I>&gt;<i>  using System.Runtime.Serialization;
</I>&gt;<i>  using System.Text;
</I>&gt;<i> +using System.Text.RegularExpressions;
</I>&gt;<i>  
</I>&gt;<i>  namespace System.Net 
</I>&gt;<i>  {
</I>&gt;<i> @@ -53,7 +54,7 @@
</I>&gt;<i>                 int perDomainCapacity = DefaultPerDomainCookieLimit;
</I>&gt;<i>                 int maxCookieSize = DefaultCookieLengthLimit;
</I>&gt;<i>                 CookieCollection cookies;
</I>&gt;<i> -                               
</I>&gt;<i> +
</I>&gt;<i>                 // ctors
</I>&gt;<i>                 public CookieContainer ()
</I>&gt;<i>                 { 
</I>&gt;<i> @@ -146,7 +147,16 @@
</I>&gt;<i>                         if (cookie.Value.Length &gt; maxCookieSize)
</I>&gt;<i>                                 throw new CookieException (&quot;value is larger than MaxCookieSize.&quot;);
</I>&gt;<i>  
</I>&gt;<i> -                       AddCookie (cookie);
</I>&gt;<i> +                       // .NET's Add (Cookie) is fundamentally broken and does not copy properties
</I>&gt;<i> +                       // like Secure, HttpOnly and Expires so we clone the parts that .NET
</I>&gt;<i> +                       // does keep before calling AddCookie
</I>&gt;<i> +                       Cookie c = new Cookie (cookie.Name, cookie.Value);
</I>&gt;<i> +                       c.Path = (cookie.Path.Length == 0) ? &quot;/&quot; : cookie.Path;
</I>&gt;<i> +                       c.Domain = cookie.Domain;
</I>&gt;<i> +                       c.ExactDomain = cookie.ExactDomain;
</I>&gt;<i> +                       c.Version = cookie.Version;
</I>&gt;<i> +                       
</I>&gt;<i> +                       AddCookie (c);
</I>&gt;<i>                 }
</I>&gt;<i>  
</I>&gt;<i>                 void AddCookie (Cookie cookie)
</I>&gt;<i> @@ -169,6 +179,16 @@
</I>&gt;<i>                         c.Domain = cookie.Domain;
</I>&gt;<i>                         c.ExactDomain = cookie.ExactDomain;
</I>&gt;<i>                         c.Version = cookie.Version;
</I>&gt;<i> +                       c.Expires = cookie.Expires;
</I>&gt;<i> +                       c.CommentUri = cookie.CommentUri;
</I>&gt;<i> +                       c.Comment = cookie.Comment;
</I>&gt;<i> +                       c.Discard = c.Discard;
</I>
				^ that's unlikely to be correct ;-)

&gt;<i> +                       if (cookie.HttpOnly) {
</I>&gt;<i> +                               c.HttpOnly = true;
</I>&gt;<i> +                       }
</I>&gt;<i> +                       if (cookie.Secure) {
</I>&gt;<i> +                               c.Secure = true;
</I>&gt;<i> +                       }
</I>
why not simply 
			c.HttpOnly = cookie.HttpOnly;
			c.Secure = cookie.Secure;
?

if there's a problem with this simpler code then it does not get caught
by your new unit tests.

&gt;<i>  
</I>&gt;<i>                         cookies.Add (c);
</I>&gt;<i>                         CheckExpiration ();
</I>&gt;<i> @@ -373,10 +393,21 @@
</I>&gt;<i>                                 return;
</I>&gt;<i>                         
</I>&gt;<i>                         // Cookies must be separated by ',' (like documented on MSDN)
</I>&gt;<i> -                       string [] jar = cookieHeader.Split (',');
</I>&gt;<i> -                       foreach (string cookie in jar) {
</I>&gt;<i> +                       // but expires uses DAY, DD-MMM-YYYY HH:MM:SS GMT, so simple ',' search is wrong.
</I>&gt;<i> +                       // See <A HREF="http://msdn.microsoft.com/en-us/library/aa384321%28VS.85%29.aspx">http://msdn.microsoft.com/en-us/library/aa384321%28VS.85%29.aspx</A>
</I>&gt;<i> +                       string[] jar = cookieHeader.Split(',');
</I>&gt;<i> +                       string tmpCookie;
</I>&gt;<i> +                       for (int i = 0; i &lt; jar.Length; i++) {
</I>&gt;<i> +                               tmpCookie = jar[i];
</I>&gt;<i> +
</I>&gt;<i> +                               if (jar.Length &gt; i + 1
</I>&gt;<i> +                                       &amp;&amp; Regex.IsMatch (jar[i], @&quot;.*expires\s*=\s*(Mon|Tue|Wed|Thu|Fri|Sat|Sun)&quot;, RegexOptions.IgnoreCase) 
</I>&gt;<i> +                                       &amp;&amp; Regex.IsMatch (jar[i+1], @&quot;\s\d{2}-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-\d{4} \d{2}:\d{2}:\d{2} GMT&quot;, RegexOptions.IgnoreCase)) {
</I>&gt;<i> +                                       tmpCookie = new StringBuilder(tmpCookie).Append(&quot;,&quot;).Append(jar[++i]).ToString();
</I>&gt;<i> +                               }
</I>&gt;<i> +
</I>&gt;<i>                                 try {
</I>&gt;<i> -                                       Cookie c = Parse (cookie);
</I>&gt;<i> +                                       Cookie c = Parse (tmpCookie);
</I>&gt;<i>  
</I>&gt;<i>                                         // add default values from URI if missing from the string
</I>&gt;<i>                                         if (c.Path.Length == 0) {
</I>&gt;<i> @@ -392,7 +423,7 @@
</I>&gt;<i>                                                 c.ExactDomain = true;
</I>&gt;<i>                                         }
</I>&gt;<i>  
</I>&gt;<i> -                                       Add (c);
</I>&gt;<i> +                                       AddCookie (c);
</I>&gt;<i>                                 }
</I>&gt;<i>                                 catch (Exception e) {
</I>&gt;<i>                                         string msg = String.Format (&quot;Could not parse cookies for '{0}'.&quot;, uri);
</I>&gt;<i> @@ -430,6 +461,17 @@
</I>&gt;<i>                                                 c.ExactDomain = false;
</I>&gt;<i>                                         }
</I>&gt;<i>                                         break;
</I>&gt;<i> +                               case &quot;expires&quot;:
</I>&gt;<i> +                               case &quot;$expires&quot;:
</I>&gt;<i> +                                       if (c.Expires == DateTime.MinValue)
</I>&gt;<i> +                                               c.Expires = DateTime.SpecifyKind(DateTime.ParseExact(value, @&quot;ddd, dd-MMM-yyyy HH:mm:ss G\MT&quot;, CultureInfo.InvariantCulture), DateTimeKind.Utc);
</I>&gt;<i> +                                               break;
</I>&gt;<i> +                               case &quot;httponly&quot;:
</I>&gt;<i> +                                       c.HttpOnly = true;
</I>&gt;<i> +                                       break;
</I>&gt;<i> +                               case &quot;secure&quot;:
</I>&gt;<i> +                                       c.Secure = true;
</I>&gt;<i> +                                       break;
</I>
Your additional unit tests do not cover the &quot;secure&quot; case above (i.e.
please add test for all new code). 

I suspect the &quot;expires&quot; case is the buggy one wrt your unit test
(previous email).

Sebastien

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033922.html">[Mono-dev] Patch for CookieContainer.SetCookies
</A></li>
	<LI>Next message: <A HREF="033928.html">[Mono-dev] Patch for CookieContainer.SetCookies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33923">[ date ]</a>
              <a href="thread.html#33923">[ thread ]</a>
              <a href="subject.html#33923">[ subject ]</a>
              <a href="author.html#33923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
