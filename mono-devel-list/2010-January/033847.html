<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] BufferedStream.ReadByte and WriteByte are extremely	inefficient
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BufferedStream.ReadByte%20and%20WriteByte%20are%20extremely%0A%09inefficient&In-Reply-To=F062280F9B9B0C4FAC8C2DDFAF81BADD091376C2BA%40mx01.lrscorp.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="033846.html">
   <LINK REL="Next"  HREF="033848.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely	inefficient</H1>
    <B>Alan McGovern</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BufferedStream.ReadByte%20and%20WriteByte%20are%20extremely%0A%09inefficient&In-Reply-To=F062280F9B9B0C4FAC8C2DDFAF81BADD091376C2BA%40mx01.lrscorp.net"
       TITLE="[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely	inefficient">alan.mcgovern at gmail.com
       </A><BR>
    <I>Sun Jan 10 12:05:50 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="033846.html">[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely	inefficient
</A></li>
        <LI>Next message: <A HREF="033848.html">[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely inefficient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33847">[ date ]</a>
              <a href="thread.html#33847">[ thread ]</a>
              <a href="subject.html#33847">[ subject ]</a>
              <a href="author.html#33847">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alternatively you could just allocate and retain a 1 byte array inside the
BufferedStream class and constantly re-use it. BinaryReader already uses
this approach. As BufferedStream is sealed, the exact approach used doesn't
particularly matter as the user can't tell the difference.

Would any of the other Stream subclasses benefit from similar optimisations?


Alan.

On Sun, Jan 10, 2010 at 3:35 PM, Tom Philpot &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tom.philpot at logos.com</A>&gt; wrote:

&gt;<i> It looks like the implementation of ReadByte and WriteByte in
</I>&gt;<i> BufferedStream follow the default behavior for Stream by allocating a 1-byte
</I>&gt;<i> array and then calling Read() or Write(). This is exactly what the MSDN docs
</I>&gt;<i> for ReadByte and WriteByte ask implementers NOT to do:
</I>&gt;<i>
</I>&gt;<i> &gt;From
</I>&gt;<i> <A HREF="http://msdn.microsoft.com/en-us/library/system.io.stream.readbyte.aspx">http://msdn.microsoft.com/en-us/library/system.io.stream.readbyte.aspx</A>
</I>&gt;<i> Notes to Implementers:
</I>&gt;<i>
</I>&gt;<i> The default implementation on Stream creates a new single-byte array and
</I>&gt;<i> then calls Read. While this is formally correct, it is inefficient. Any
</I>&gt;<i> stream with an internal buffer should override this method and provide a
</I>&gt;<i> much more efficient version that reads the buffer directly, avoiding the
</I>&gt;<i> extra array allocation on every call.
</I>&gt;<i>
</I>&gt;<i> Granted, most people don't really ever read one byte at a time from a
</I>&gt;<i> Stream, but in our case, we need to.
</I>&gt;<i>
</I>&gt;<i> In my simple tests, reading 1.5 GB of data using ReadByte from
</I>&gt;<i> BufferedStream versus FileStream yielded the following the following results
</I>&gt;<i> (Late 2008 MacBook 13.3&quot; 2.0 Ghz, 5400 rpm disk):
</I>&gt;<i> Test #1:
</I>&gt;<i> Using default BufferedStream ReadByte implementation: 763.814 seconds
</I>&gt;<i> Using FileStream ReadByte implementation: 43.53 seconds
</I>&gt;<i>
</I>&gt;<i> Test #2:
</I>&gt;<i> Using default BufferedStream ReadByte implementation: 765.427 seconds
</I>&gt;<i> Using FileStream ReadByte implementation: 42.678 seconds
</I>&gt;<i>
</I>&gt;<i> Obviously the alloc and GC cost of this one byte array is huge. I just
</I>&gt;<i> thought I'd throw this out there in case one of the Mono devs (or someone
</I>&gt;<i> else) wanted to work on a patch before I got a chance to submit one sometime
</I>&gt;<i> on Monday.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Tom
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100110/c91ce7ee/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100110/c91ce7ee/attachment.html</A> 
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="033846.html">[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely	inefficient
</A></li>
	<LI>Next message: <A HREF="033848.html">[Mono-dev] BufferedStream.ReadByte and WriteByte are extremely inefficient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33847">[ date ]</a>
              <a href="thread.html#33847">[ thread ]</a>
              <a href="subject.html#33847">[ subject ]</a>
              <a href="author.html#33847">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
