<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Calling .NET code from unmanaged C
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Calling%20.NET%20code%20from%20unmanaged%20C&In-Reply-To=02b201c5fb19%24e1a135c0%240ff4010a%40brahms">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016087.html">
   <LINK REL="Next"  HREF="016088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Calling .NET code from unmanaged C</H1>
    <B>Thomas Harning Jr.</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Calling%20.NET%20code%20from%20unmanaged%20C&In-Reply-To=02b201c5fb19%24e1a135c0%240ff4010a%40brahms"
       TITLE="[Mono-dev] Calling .NET code from unmanaged C">harningt at gmail.com
       </A><BR>
    <I>Wed Dec  7 11:41:38 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="016087.html">[Mono-dev] Calling .NET code from unmanaged C
</A></li>
        <LI>Next message: <A HREF="016088.html">[Mono-dev] gmcs: 'Type.IsGenericInstance' property
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16092">[ date ]</a>
              <a href="thread.html#16092">[ thread ]</a>
              <a href="subject.html#16092">[ subject ]</a>
              <a href="author.html#16092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A portable option for this is to have your C code compile into a
library and write a C# program that calls into your C library.

In order to give your C program access to C# functions, you would
want to send delegates into the unmanaged code. One option is to
send in all your delegates through registration functions, another
directly through the program startup function, and yet another loads
the delegates into structs.
(Loading them into structs could lead to near-direct object usage by
using a create_() function to load up a struct with function
pointers and accessors).

A short example.. which I've tested:

C# Program:

using System;
using System.Runtime.InteropServices;

class TestApp {
	delegate int DoFooDelegate(string foo, int doo);

	private int instVar = 0;
	public int DoFoo(string foo, int doo) {
		instVar += doo;
		Console.WriteLine(&quot;{0} : {1}&quot;, foo, instVar);
		return instVar;
	}

	[DllImport(&quot;./test.so&quot;)]
	static extern int runProgram(DoFooDelegate doFoo);

	public static int Main(string[] args)
	{
		TestApp appInstance = new TestApp();
		return appInstance.RunApp();	
		// Use instance call to ensure DoFoo's delegation is tied to
		//the instance... (Is that necessary, or is there a better way?)
	}
	int RunApp()
	{
		DoFooDelegate fooDelegate = new DoFooDelegate(DoFoo); // .Net 1.1
syntax... portability in compilation
		return runProgram(fooDelegate);
	}
}

#### END C#
compile any way..
#### C Program/Library

typedef int (*DoFooFPtr)(const char*, int);

int runProgram(DoFooFPtr fPtr)
{
	const int bufferSize = 128;
	char buffer[bufferSize];
	for(int x = 0; x &lt; 20; x++) {
		snprintf(buffer, bufferSize, &quot;Bob counts: %i&quot;, x);
		int ret = fPtr(buffer, x);
		printf(&quot;Returned ((%i)) from fPtr(\&quot;%s\&quot;, %i)\n&quot;, ret, buffer, x);
	}
	return 0;
}

#### END C Library
Compile with:    gcc -std=c99 -fPIC -shared test.c -o test.so
####
-- 
Thomas Harning Jr.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 265 bytes
Desc: OpenPGP digital signature
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051207/66bad67a/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20051207/66bad67a/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016087.html">[Mono-dev] Calling .NET code from unmanaged C
</A></li>
	<LI>Next message: <A HREF="016088.html">[Mono-dev] gmcs: 'Type.IsGenericInstance' property
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16092">[ date ]</a>
              <a href="thread.html#16092">[ thread ]</a>
              <a href="subject.html#16092">[ subject ]</a>
              <a href="author.html#16092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
