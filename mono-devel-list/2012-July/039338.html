<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mono / llvm inlining situations (or failures thereof)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20mono%20/%20llvm%20inlining%20situations%20%28or%20failures%20thereof%29&In-Reply-To=%3CCACmR%2BBC8EzEf5UtzUZZX4C-m313es1ujWZa23Eyx5e2kNXpXDw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039337.html">
   <LINK REL="Next"  HREF="039339.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mono / llvm inlining situations (or failures thereof)</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20mono%20/%20llvm%20inlining%20situations%20%28or%20failures%20thereof%29&In-Reply-To=%3CCACmR%2BBC8EzEf5UtzUZZX4C-m313es1ujWZa23Eyx5e2kNXpXDw%40mail.gmail.com%3E"
       TITLE="[Mono-dev] mono / llvm inlining situations (or failures thereof)">kumpera at gmail.com
       </A><BR>
    <I>Mon Jul 16 16:20:22 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039337.html">[Mono-dev] mono / llvm inlining situations (or failures thereof)
</A></li>
        <LI>Next message: <A HREF="039339.html">[Mono-dev] mono / llvm inlining situations (or failures thereof)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39338">[ date ]</a>
              <a href="thread.html#39338">[ thread ]</a>
              <a href="subject.html#39338">[ subject ]</a>
              <a href="author.html#39338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jonathan,

There are a few factors that affect inlining.

We don't inline more than 10 levels deep, but I doubt this is your problem.
We don't inline synchronized methods, methods that belong to MarshalByRef
classes or method that do exception handlibg. Not your case, probably.
We only inline methods smaller than 20bytes of IL. It might be your
case. You can control this with the MONO_INLINELIMIT env var or use the
AgressiveInlining compiler hint.
We don't inline calls to classes that need their class constructor to be
ran. Might be your case.
We don't do inlining when generics are involved. Doesn't look to be your
case;
And, finally, we don't inline methods that call other methods (including
constructors).

The last restriction does look to be your issue. We do it due to a pair of
issues, first because it produces broken stacktraces
and because it breaks calls that check caller assembly. Both can be fixed
if mono had support for inlining maps.

My suggestion is that you play with MONO_INLINELIMIT and AgressiveInlining.
This can be reported as a feature request.
I would love to see this done.

Regards,
Rodrigo

On Sat, Jul 14, 2012 at 9:36 PM, Jonathan Shore &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jonathan.shore at gmail.com</A>&gt;wrote:

&gt;<i>
</I>&gt;<i> I have a significant # of numerical routines that make use of vectors,
</I>&gt;<i> matrices, etc.   I have observed that mono --llvm does seem not inline
</I>&gt;<i> access in some situations where it reasonably could.   This means for a
</I>&gt;<i> difference in performance of about 25% in my code.
</I>&gt;<i>
</I>&gt;<i> I am using a 3rd party library for vector / matrix functionality that has
</I>&gt;<i> a generic class  Vector&lt;T&gt;.   I have created a number of specializations of
</I>&gt;<i> this class, such as:
</I>&gt;<i>
</I>&gt;<i> class SpecialVector : Vector&lt;double&gt;
</I>&gt;<i> {
</I>&gt;<i> ...
</I>&gt;<i> public override double this[int i]
</I>&gt;<i> {
</I>&gt;<i> get { return _data[i]; }
</I>&gt;<i> set { _data[i] = value; }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> public override double[] Data
</I>&gt;<i> { get { return _data; } }
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> private double[] _data;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have a rather tight-looped numerical algorithm on a number of these
</I>&gt;<i> vectors.  Such as:
</I>&gt;<i>
</I>&gt;<i> for (int i = 0 ; i &lt; len ; i++)
</I>&gt;<i> {
</I>&gt;<i> var x = x[i];
</I>&gt;<i> ...
</I>&gt;<i> for (int k = ileft; k &lt;= iright; k++)
</I>&gt;<i> {
</I>&gt;<i> var xk = x[k];
</I>&gt;<i> var yk = y[k];
</I>&gt;<i> ..
</I>&gt;<i> }
</I>&gt;<i> ...
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Where,  *x* and *y* are instances of these vectors.   x[i] and y[i] call
</I>&gt;<i> the this[int] accessor on their respective vectors.   *Vector&lt;double&gt;* defines
</I>&gt;<i> *double this[int i]* as a virtual function.
</I>&gt;<i> *
</I>&gt;<i> *
</I>&gt;<i> *SpecialVector* is a sealed class, however.   Nevertheless, I realize a
</I>&gt;<i> 25% increase in performance if I do the following:
</I>&gt;<i>
</I>&gt;<i> *var vx = x.Data;*
</I>&gt;<i> *var vy = y.Data;*
</I>&gt;<i> for (int i = 0 ; i &lt; len ; i++)
</I>&gt;<i> {
</I>&gt;<i> var x = *vx*[i];
</I>&gt;<i> ...
</I>&gt;<i> for (int k = ileft; k &lt;= iright; k++)
</I>&gt;<i> {
</I>&gt;<i> var xk = *vx*[k];
</I>&gt;<i> var yk = *vy*[k];
</I>&gt;<i> ..
</I>&gt;<i> }
</I>&gt;<i> ...
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> I suspect that mono / LLVM is not attempting inline *this[int i] *since
</I>&gt;<i> is a virtual method, in spite of being trivially determined to be leaf
</I>&gt;<i> class.  OR is there another reason why this is not inlined?
</I>&gt;<i>
</I>&gt;<i> Should this be reported as a bug or feature request?
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Jonathan
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120716/d4f6a1cc/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120716/d4f6a1cc/attachment.html</A>&gt;
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039337.html">[Mono-dev] mono / llvm inlining situations (or failures thereof)
</A></li>
	<LI>Next message: <A HREF="039339.html">[Mono-dev] mono / llvm inlining situations (or failures thereof)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39338">[ date ]</a>
              <a href="thread.html#39338">[ thread ]</a>
              <a href="subject.html#39338">[ subject ]</a>
              <a href="author.html#39338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
