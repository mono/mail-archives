<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] AOT and generics
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20and%20generics&In-Reply-To=%3CCAEigO1r3LhC1EFe21UwMgOiE-mzWcTUcty4U5F%2B6E-ssmUiQ0Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039312.html">
   <LINK REL="Next"  HREF="039316.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] AOT and generics</H1>
    <B>Virgile Bello</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20and%20generics&In-Reply-To=%3CCAEigO1r3LhC1EFe21UwMgOiE-mzWcTUcty4U5F%2B6E-ssmUiQ0Q%40mail.gmail.com%3E"
       TITLE="[Mono-dev] AOT and generics">virgile.bello at gmail.com
       </A><BR>
    <I>Fri Jul  6 15:21:15 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039312.html">[Mono-dev] AOT and generics
</A></li>
        <LI>Next message: <A HREF="039316.html">[Mono-dev] AOT and generics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39313">[ date ]</a>
              <a href="thread.html#39313">[ thread ]</a>
              <a href="subject.html#39313">[ subject ]</a>
              <a href="author.html#39313">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the confirmation, that's what I could guess as well (one shared
code for every ref instance).
However, in that case, I can't think of any way this code can run because
for every ref type in A, the method B::Test&lt;X&lt;T&gt;&gt;() will need to be
generated (X being a struct -- it's just like &quot;bringing&quot; a non-shareable
struct type into the shared generic instance). Basically, if the class is
requested with T, if it has any method call depending on T, they should be
generated. It seems to actually be done if B::Test&lt;T&gt; is called but not
B::Test&lt;X&lt;T&gt;&gt;. There might be some other related cases as well (when
bringing a struct into a generic type). That's why I was suggesting sharing
might be problematic in this case, I will take a look at the code to have a
better idea of it.

Also, I will double check my setup, but it pretty seems standard (other AOT
stuff works fine, experimenting under linux x64).
Anyway, I will fill a bug to not pollute the mailing list too much.

Virgile

On Fri, Jul 6, 2012 at 11:39 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:

&gt;<i> The FullAOT compiler handles generics by compiling a single shared
</I>&gt;<i> instance for all ref-only type arguments.
</I>&gt;<i> so List&lt;object&gt; shares code with List&lt;string&gt; but List&lt;int&gt; gets its own
</I>&gt;<i> version. This is the default behavior.
</I>&gt;<i>
</I>&gt;<i> If this is not the case, then you have something broken in your setup.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Jul 6, 2012 at 11:24 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> It would be for platforms supporting only AOT.
</I>&gt;&gt;<i> Of course we would license Mono. We already had a quick discussion about
</I>&gt;&gt;<i> licensing maybe a year ago (it's still R&amp;D/proof of concept for now, and it
</I>&gt;&gt;<i> was only Windows until now so we just delayed actual deal until necessary),
</I>&gt;&gt;<i> but thanks for pointing out, maybe now is a good time to start the
</I>&gt;&gt;<i> discussion again with Xamarin, I will send an email right away.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Fri, Jul 6, 2012 at 10:31 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> You need to correctly drive the FullAOT compiler.
</I>&gt;&gt;&gt;<i> Why do you want to use FullAOT anyway?
</I>&gt;&gt;&gt;<i> Do you plan to run it on a target that disables JIT?
</I>&gt;&gt;&gt;<i> Do you hold a license that allows you to do so? Mono is LGPL and FullAOT
</I>&gt;&gt;&gt;<i> doesn't work with it.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Fri, Jul 6, 2012 at 9:29 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> During full AOT, It seems that if generics is a ref type, AOT is
</I>&gt;&gt;&gt;&gt;<i> skipped (which makes sense because most of the time it is not necessary,
</I>&gt;&gt;&gt;&gt;<i> one codegen for any ref type is usually enough).
</I>&gt;&gt;&gt;&gt;<i> However, if the class internally uses a struct based on the generic
</I>&gt;&gt;&gt;&gt;<i> types, it will fail at runtime.
</I>&gt;&gt;&gt;&gt;<i> Here is a simple example showcasing the issue:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public class B
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     public void Test&lt;T&gt;()
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>         System.Console.WriteLine(typeof(T));
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public class A&lt;T&gt;
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     public void Test()
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>         new B().Test&lt;System.Collections.Generic.KeyValuePair&lt;T, T&gt;&gt;();
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> class P
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     static void Main(string[] args)
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>         new A&lt;int&gt;().Test();
</I>&gt;&gt;&gt;&gt;<i>         new A&lt;string&gt;().Test();
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If I run this program with full aot, it will fail.
</I>&gt;&gt;&gt;&gt;<i> new A&lt;int&gt; will work (AOT forced because value type)
</I>&gt;&gt;&gt;&gt;<i> However, new A&lt;string&gt; will generate a JIT exception (because even
</I>&gt;&gt;&gt;&gt;<i> though string is a ref type, A should be AOT for this specific type because
</I>&gt;&gt;&gt;&gt;<i> KeyValuePair inside A&lt;T&gt; needs to be JITed.)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> But maybe I misunderstood the problem (or it is just a specific bug),
</I>&gt;&gt;&gt;&gt;<i> because this other case actually work (I was expecting it to have the same
</I>&gt;&gt;&gt;&gt;<i> issue):
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public class B
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     public void Test&lt;T&gt;()
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> System.Console.WriteLine(typeof(System.Collections.Generic.KeyValuePair&lt;T,
</I>&gt;&gt;&gt;&gt;<i> T&gt;));
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> public class A&lt;T&gt;
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     public void Test()
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>         new B().Test&lt;T&gt;();
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> class P
</I>&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;<i>     static void Main(string[] args)
</I>&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;<i>         new A&lt;int&gt;().Test();
</I>&gt;&gt;&gt;&gt;<i>         new A&lt;string&gt;().Test();
</I>&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Just wanted to check if I understood the issue right and if there would
</I>&gt;&gt;&gt;&gt;<i> be nothing preventing from fixing it?
</I>&gt;&gt;&gt;&gt;<i> I wouldn't mind taking a look at the sources by myself if necessary.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Virgile
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120707/fb5faced/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120707/fb5faced/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039312.html">[Mono-dev] AOT and generics
</A></li>
	<LI>Next message: <A HREF="039316.html">[Mono-dev] AOT and generics
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39313">[ date ]</a>
              <a href="thread.html#39313">[ thread ]</a>
              <a href="subject.html#39313">[ subject ]</a>
              <a href="author.html#39313">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
