<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] AOT and generics
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20and%20generics&In-Reply-To=%3CCACmR%2BBAob-DqhbFhG8B_xcS94YbBs-tfz35vCE-g_Y1AWQ_avQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039316.html">
   <LINK REL="Next"  HREF="039314.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] AOT and generics</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20AOT%20and%20generics&In-Reply-To=%3CCACmR%2BBAob-DqhbFhG8B_xcS94YbBs-tfz35vCE-g_Y1AWQ_avQ%40mail.gmail.com%3E"
       TITLE="[Mono-dev] AOT and generics">kumpera at gmail.com
       </A><BR>
    <I>Mon Jul  9 13:47:10 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039316.html">[Mono-dev] AOT and generics
</A></li>
        <LI>Next message: <A HREF="039314.html">[Mono-dev] TCP Async
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39318">[ date ]</a>
              <a href="thread.html#39318">[ thread ]</a>
              <a href="subject.html#39318">[ subject ]</a>
              <a href="author.html#39318">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I see your problem now.

You're invoking the FullAOT compiler incorrectly. When using it, you must
full aot all used assemblies. In your sample,
if you full aot mscorlib as well, it should work.


On Mon, Jul 9, 2012 at 2:21 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:

&gt;<i> Ok, just did a bug report:
</I>&gt;<i> <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=6040">https://bugzilla.xamarin.com/show_bug.cgi?id=6040</A>
</I>&gt;<i> Also, I attempted to fix it, seems working so far.
</I>&gt;<i> I published it on github (link is inside the bug report).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, Jul 7, 2012 at 12:21 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thanks for the confirmation, that's what I could guess as well (one
</I>&gt;&gt;<i> shared code for every ref instance).
</I>&gt;&gt;<i> However, in that case, I can't think of any way this code can run because
</I>&gt;&gt;<i> for every ref type in A, the method B::Test&lt;X&lt;T&gt;&gt;() will need to be
</I>&gt;&gt;<i> generated (X being a struct -- it's just like &quot;bringing&quot; a non-shareable
</I>&gt;&gt;<i> struct type into the shared generic instance). Basically, if the class is
</I>&gt;&gt;<i> requested with T, if it has any method call depending on T, they should be
</I>&gt;&gt;<i> generated. It seems to actually be done if B::Test&lt;T&gt; is called but not
</I>&gt;&gt;<i> B::Test&lt;X&lt;T&gt;&gt;. There might be some other related cases as well (when
</I>&gt;&gt;<i> bringing a struct into a generic type). That's why I was suggesting sharing
</I>&gt;&gt;<i> might be problematic in this case, I will take a look at the code to have a
</I>&gt;&gt;<i> better idea of it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, I will double check my setup, but it pretty seems standard (other
</I>&gt;&gt;<i> AOT stuff works fine, experimenting under linux x64).
</I>&gt;&gt;<i> Anyway, I will fill a bug to not pollute the mailing list too much.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Virgile
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Fri, Jul 6, 2012 at 11:39 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The FullAOT compiler handles generics by compiling a single shared
</I>&gt;&gt;&gt;<i> instance for all ref-only type arguments.
</I>&gt;&gt;&gt;<i> so List&lt;object&gt; shares code with List&lt;string&gt; but List&lt;int&gt; gets its own
</I>&gt;&gt;&gt;<i> version. This is the default behavior.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If this is not the case, then you have something broken in your setup.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Fri, Jul 6, 2012 at 11:24 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>&gt;wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It would be for platforms supporting only AOT.
</I>&gt;&gt;&gt;&gt;<i> Of course we would license Mono. We already had a quick discussion
</I>&gt;&gt;&gt;&gt;<i> about licensing maybe a year ago (it's still R&amp;D/proof of concept for now,
</I>&gt;&gt;&gt;&gt;<i> and it was only Windows until now so we just delayed actual deal until
</I>&gt;&gt;&gt;&gt;<i> necessary), but thanks for pointing out, maybe now is a good time to start
</I>&gt;&gt;&gt;&gt;<i> the discussion again with Xamarin, I will send an email right away.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Fri, Jul 6, 2012 at 10:31 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> You need to correctly drive the FullAOT compiler.
</I>&gt;&gt;&gt;&gt;&gt;<i> Why do you want to use FullAOT anyway?
</I>&gt;&gt;&gt;&gt;&gt;<i> Do you plan to run it on a target that disables JIT?
</I>&gt;&gt;&gt;&gt;&gt;<i> Do you hold a license that allows you to do so? Mono is LGPL and
</I>&gt;&gt;&gt;&gt;&gt;<i> FullAOT doesn't work with it.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On Fri, Jul 6, 2012 at 9:29 AM, Virgile Bello &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">virgile.bello at gmail.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> During full AOT, It seems that if generics is a ref type, AOT is
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> skipped (which makes sense because most of the time it is not necessary,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> one codegen for any ref type is usually enough).
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> However, if the class internally uses a struct based on the generic
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> types, it will fail at runtime.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Here is a simple example showcasing the issue:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> public class B
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     public void Test&lt;T&gt;()
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         System.Console.WriteLine(typeof(T));
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> public class A&lt;T&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     public void Test()
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new B().Test&lt;System.Collections.Generic.KeyValuePair&lt;T, T&gt;&gt;();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> class P
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     static void Main(string[] args)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new A&lt;int&gt;().Test();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new A&lt;string&gt;().Test();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> If I run this program with full aot, it will fail.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> new A&lt;int&gt; will work (AOT forced because value type)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> However, new A&lt;string&gt; will generate a JIT exception (because even
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> though string is a ref type, A should be AOT for this specific type because
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> KeyValuePair inside A&lt;T&gt; needs to be JITed.)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> But maybe I misunderstood the problem (or it is just a specific bug),
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> because this other case actually work (I was expecting it to have the same
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> issue):
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> public class B
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     public void Test&lt;T&gt;()
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> System.Console.WriteLine(typeof(System.Collections.Generic.KeyValuePair&lt;T,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> T&gt;));
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> public class A&lt;T&gt;
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     public void Test()
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new B().Test&lt;T&gt;();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> class P
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     static void Main(string[] args)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     {
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new A&lt;int&gt;().Test();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>         new A&lt;string&gt;().Test();
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>     }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> }
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Just wanted to check if I understood the issue right and if there
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> would be nothing preventing from fixing it?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> I wouldn't mind taking a look at the sources by myself if necessary.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Virgile
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120709/fb6b1e01/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20120709/fb6b1e01/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039316.html">[Mono-dev] AOT and generics
</A></li>
	<LI>Next message: <A HREF="039314.html">[Mono-dev] TCP Async
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39318">[ date ]</a>
              <a href="thread.html#39318">[ thread ]</a>
              <a href="subject.html#39318">[ subject ]</a>
              <a href="author.html#39318">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
