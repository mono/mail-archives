<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] EventWaitHandle.WaitOne #2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20EventWaitHandle.WaitOne%20%232&In-Reply-To=%3CD65E55BF26234D4EB86607792CFF958509CB191877%40CL-DE-EXMB-02.sma.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038750.html">
   <LINK REL="Next"  HREF="038758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] EventWaitHandle.WaitOne #2</H1>
    <B>Mirko Wischer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20EventWaitHandle.WaitOne%20%232&In-Reply-To=%3CD65E55BF26234D4EB86607792CFF958509CB191877%40CL-DE-EXMB-02.sma.de%3E"
       TITLE="[Mono-dev] EventWaitHandle.WaitOne #2">Mirko.Wischer at sma.de
       </A><BR>
    <I>Tue Apr 10 08:58:04 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="038750.html">[Mono-dev] SerialPort.Open() problem: MonoDevelop indicate it is not member of SerialPort Class
</A></li>
        <LI>Next message: <A HREF="038758.html">[Mono-dev] mod-mono/XSP - HttpRequest.Path is unenescaped twice from the raw URL that came over the wire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38754">[ date ]</a>
              <a href="thread.html#38754">[ thread ]</a>
              <a href="subject.html#38754">[ subject ]</a>
              <a href="author.html#38754">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,


in january I wrote to the mailing list about a problem

in EventWaitHandle.WaitOne because WaitForSingleObjectEx

does not use a monotonic clock.

I also wrote a bug report:

<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=3025">https://bugzilla.xamarin.com/show_bug.cgi?id=3025</A>

Until a week ago I thought this only happens on named events.

But now I realized the problem also exists using unnamed events

under some circumstances (One thread changes time just after another

thread called WaitOne. I think my patch should also cover this error

but I did not test it yet. First I would like to know if my patch seems

to be okay or if I missed some possible race conditions.


Regards, Mirko




My old posting:


Hi everyone,


 


we hit a problem concerning EventWaitHandle.WaitOne(timeout) in
conjunction with


changing system time during long timeouts.

The problem only exists using named events. After a short analysis I
think I found the main problem:


 


In the io-layer  the WaitForSingleObjectEx method uses
_wapi_calc_timeout (from misc.c) to compute


an absolute time from the given timeout, but the absolute timeout is
computed using &#8220;gettimeofday&#8221;.


That will cause problems if the system clock changes during checking
(named events spin through fake timeouts


until the absolute timeout seems to be reached).


                Unnamed events also use the _wapi_calc_timeout method to
compute the absolute timeout. This timeout is


then used in mono_cond_timedwait (but this only wraps &#8220;normal&#8221; pthread
conditions). 


So I prepared a patch (see attached files) using
clock_gettime(CLOCK_MONOTONIC,..) instead of gettimeofday, but this also
requires


a change for unnamed events, because the pthreads condition needs to
know what kind of clock provides the


absolute timeout.


 


This seems to fix the issue for us.  Is this an appropriate way to fix
this? What do you think.


_wapi_calc_timeout is also used in some other timeout relevant
functions, but I just found


the &#8220;faketimeout&#8221; way of checking the absolute timeout and the
mono_cond_timed_wait.


Or do I miss some occurrences/cases checking the absolute timeout.


 


Thanks for looking at this.


 


CU Mirko

___________________________________________________

SMA Solar Technology AG
Aufsichtsrat: Guenther Cramer (Vorsitzender)
Vorstand: Juergen Dolle, Roland Grebe, Pierre-Pascal Urbon, Marko Werner
Handelsregister: Amtsgericht Kassel HRB 3972
Sitz der Gesellschaft: 34266 Niestetal
USt-ID-Nr. DE 113 08 59 54
WEEE-Reg.-Nr. DE 95881150
___________________________________________________
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038750.html">[Mono-dev] SerialPort.Open() problem: MonoDevelop indicate it is not member of SerialPort Class
</A></li>
	<LI>Next message: <A HREF="038758.html">[Mono-dev] mod-mono/XSP - HttpRequest.Path is unenescaped twice from the raw URL that came over the wire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38754">[ date ]</a>
              <a href="thread.html#38754">[ thread ]</a>
              <a href="subject.html#38754">[ subject ]</a>
              <a href="author.html#38754">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
