<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] libmtp bindings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20libmtp%20bindings&In-Reply-To=45AFEB8B.80300%40canada.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022183.html">
   <LINK REL="Next"  HREF="022185.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] libmtp bindings</H1>
    <B>Ted Bullock</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20libmtp%20bindings&In-Reply-To=45AFEB8B.80300%40canada.com"
       TITLE="[Mono-dev] libmtp bindings">tbullock at canada.com
       </A><BR>
    <I>Fri Jan 19 02:11:36 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="022183.html">[Mono-dev]  libmtp bindings
</A></li>
        <LI>Next message: <A HREF="022185.html">[Mono-dev] libmtp bindings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22184">[ date ]</a>
              <a href="thread.html#22184">[ thread ]</a>
              <a href="subject.html#22184">[ subject ]</a>
              <a href="author.html#22184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, I am still having a bit of trouble here.  The double indirection
thing is pretty confusing when trying to deal with it across the
unmanaged/managed barriers.

Here is the original c structure.  It is pretty straightforward.

struct device_entry_struct {
  char *name;
  uint16_t vendor_id;
  uint16_t product_id;
  uint32_t device_flags;
};

Normally an array of pointers to this structure is generated as a list
of devices that libmtp supports.  This list is statically defined within
the library itself.

Programs that link to this library can access this list through the
following function, again notice the const:

void Get_Supported_Devices(device_entry_t ** const, int * const);

So I have the following C# code to wrap this.  Note that this code
*does* run when I test it, however the results are *incorrect*

[StructLayout(LayoutKind.Sequential)]
public class DeviceEntry
{
  private IntPtr name;
  private ushort vendor_id;
  private ushort product_id;
  private uint device_flags;
	
[DllImport (&quot;libmtp&quot;)]
internal static extern void Get_Supported_Devices(
	out IntPtr devicelist,
	out int NumDevices);
	
public static DeviceEntry[] SupportedDeviceList()
{
IntPtr DeviceList;
int NumDevices;

Get_Supported_Devices(out DeviceList, out NumDevices);
		
if (NumDevices &lt;= 0)
  return new DeviceEntry[]{};

DeviceEntry[] Devices = new DeviceEntry[NumDevices];
		
for (int i = 0; i &lt; NumDevices; ++i)
{
  IntPtr s = Marshal.ReadIntPtr(DeviceList, i *
	Marshal.SizeOf(typeof(DeviceEntry)));
  Devices[i] = (DeviceEntry)Marshal.PtrToStructure(s,
	typeof(DeviceEntry));
}
		
return Devices;
}

}

Then I have a small Main function to test with.  However the product
IDs, Vendor IDs are not the same as the ones listed in the libmtp
library itself. :(  and executing the Device.GetDeviceName() causes the
program to die.

public static void Main(string[] args)
{

DeviceEntry[] DeviceList = SupportedDeviceList();
		
Console.WriteLine(&quot;Number of Supported Devices &quot; + DeviceList.Length);
		
foreach(DeviceEntry Device in DeviceList) {
  Console.Write(&quot;Product Id: &quot; + Device.GetProductID())
  Console.WriteLine(&quot; Vendor Id: &quot; + Device.GetVendorID());

  // Crashes on the following line
  Console.WriteLine(&quot;Device Name: &quot; + Device.GetDeviceName());
  }
}

Lastly a couple of GET methods

public ushort GetVendorID()
{
  return vendor_id;
}
	
public ushort GetProductID()
{
  return product_id;
}
	
public uint GetDeviceFlags()
{
  return device_flags;
}
	
public string GetDeviceName()
{
  if(name == IntPtr.Zero)
    return &quot;Unknown Device&quot;;

  return Marshal.PtrToStringAuto(name);
}


Sorry for the long email. I suppose that I could attach this as an
extension.  Anyways, I am very frustrated with this since I have been
working on it for most of the day with almost no progress whatsoever.

-Ted

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022183.html">[Mono-dev]  libmtp bindings
</A></li>
	<LI>Next message: <A HREF="022185.html">[Mono-dev] libmtp bindings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22184">[ date ]</a>
              <a href="thread.html#22184">[ thread ]</a>
              <a href="subject.html#22184">[ subject ]</a>
              <a href="author.html#22184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
