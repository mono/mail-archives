<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] COM, Threads and Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20COM%2C%20Threads%20and%20Mono&In-Reply-To=CANqeOFo%2BG%3DpD3gQO4bLW5VV3Hh7%2BtLSWhxSsyumuzZ5fSTr_Mw%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038040.html">
   <LINK REL="Next"  HREF="038046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] COM, Threads and Mono</H1>
    <B>Jonathan Chambers</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20COM%2C%20Threads%20and%20Mono&In-Reply-To=CANqeOFo%2BG%3DpD3gQO4bLW5VV3Hh7%2BtLSWhxSsyumuzZ5fSTr_Mw%40mail.gmail.com"
       TITLE="[Mono-dev] COM, Threads and Mono">joncham at gmail.com
       </A><BR>
    <I>Fri Sep  2 11:26:02 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="038040.html">[Mono-dev] COM, Threads and Mono
</A></li>
        <LI>Next message: <A HREF="038046.html">[Mono-dev] COM, Threads and Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38041">[ date ]</a>
              <a href="thread.html#38041">[ thread ]</a>
              <a href="subject.html#38041">[ subject ]</a>
              <a href="author.html#38041">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Miguel and Tom,

I added this same response to the bug report.

This was an issue I ignored when initially implementing COM interop for
mono. Theoretically, we should be marshaling (in the COM sense) interfaces
between threads to properly support COM apartments. We don't at this point,
but as long as the user code is not accessing the COM object from multiple
threads it should not be an issue. The only place we force the access of a
COM object from a different thread is in the case of finalization of the
wrapper object.

The problem with COM marshalling between threads is that you can easily
cause deadlock. Cross apartment (thread) COM calls are handled via Windows
messages. If you perform a wait on a thread (Sleep, WaitForSingleObject,
etc) that does not pump messages, or have a processing loop that does not
pump messages you will run into hangs or deadlock.

Problem in short:
1. We are not currently marshaling COM interfaces
2. Marshaling could be done, but could introduce deadlocks without message
pumping
3. The run time would need to use message pumping waits where possible
4. What to do on non-Windows platforms? There is no Win32 message pump
5. Even if we do all this, you can still get deadlocks. See long post on
msdn from cbrumme. tl;dr it's a mess and took hacks in the CLR (from 2004):
<A HREF="http://blogs.msdn.com/b/cbrumme/archive/2004/02/02/66219.aspx">http://blogs.msdn.com/b/cbrumme/archive/2004/02/02/66219.aspx</A>

Proposed Solution:

I think we should just solve the finalizer issue, rather than the general
marshaling issue. Of course we cannot add a new API to class libs, but how
about either a environment variable

MONO_COM_FINALIZER_FUNC=&lt;TypeName.FuncName&gt;

Assuming the function specified is signature taking a single IntPtr and no
return value.

Or, we could export a function in the runtime that could be called via an
icall when running on mono.

[DllImport(&quot;__Internal&quot;)]
void mono_set_com_finalizer(Action&lt;IntPtr&gt; func);

Thoughts?

Thanks,
Jonathan



On Fri, Sep 2, 2011 at 11:05 AM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt; wrote:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>     Tom filed recently a bug against Mono that boils down to Mono calling
</I>&gt;<i> the finalizer for COM objects in the finalizer thread, which is something
</I>&gt;<i> that most COM applications are not expecting.
</I>&gt;<i>
</I>&gt;<i>      His solution is to extend the .NET API to do this, which is not going
</I>&gt;<i> to work for Mono.   What is probably happening is that we have not correctly
</I>&gt;<i> implemented the semantics for destruction of COM objects.   That said, I do
</I>&gt;<i> not know enough about COM to know how this is handled on Windows.
</I>&gt;<i>
</I>&gt;<i>      If you know some COM, I would love if you could take a look at this:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://bugzilla.novell.com/show_bug.cgi?id=672879">https://bugzilla.novell.com/show_bug.cgi?id=672879</A>
</I>&gt;<i>
</I>&gt;<i> Miguel
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110902/4aa7b0b7/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110902/4aa7b0b7/attachment.html</A> 
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038040.html">[Mono-dev] COM, Threads and Mono
</A></li>
	<LI>Next message: <A HREF="038046.html">[Mono-dev] COM, Threads and Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38041">[ date ]</a>
              <a href="thread.html#38041">[ thread ]</a>
              <a href="subject.html#38041">[ subject ]</a>
              <a href="author.html#38041">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
