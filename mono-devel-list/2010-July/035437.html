<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Registering internal calls at runtime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Registering%20internal%20calls%20at%20runtime&In-Reply-To=i1g1ro%24d6a%241%40dough.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035436.html">
   <LINK REL="Next"  HREF="035438.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Registering internal calls at runtime</H1>
    <B>MBoisse</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Registering%20internal%20calls%20at%20runtime&In-Reply-To=i1g1ro%24d6a%241%40dough.gmane.org"
       TITLE="[Mono-dev] Registering internal calls at runtime">mboisse at noesisinnovation.net
       </A><BR>
    <I>Mon Jul 12 19:02:42 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035436.html">[Mono-dev] Registering internal calls at runtime
</A></li>
        <LI>Next message: <A HREF="035438.html">[Mono-dev] Registering internal calls at runtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35437">[ date ]</a>
              <a href="thread.html#35437">[ thread ]</a>
              <a href="subject.html#35437">[ subject ]</a>
              <a href="author.html#35437">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Thank you Robert, I appreciate your involvement.

Here's our problem: any calls to mono_add_internal_call is ineffective when made from managed code. 
Our initial idea was to use P/Invoke to load a dynamic library and run some initialization method in it which would make the appropriate registrations. Based on tests we did, any call which doesn't precede the mono_jit_exec call has no effect.

Which of these assumptions can we make?
  Do classes using internal calls have their methods bound to internal methods as soon as their owning assembly is initialized?
  Or is the internal method registry is simply completely sealed once mono_jit_exec is running?

I was hoping the binding process was done &quot;on request&quot;, only the first time a method is called from managed code (because an exception is thrown only when a call to the unfound internal method is made).

Actually, internal method declarations in the managed code like
  [MethodImplAttribute(MethodImplOptions.InternalCall)]
would be considerably more powerful if it allowed a module and a method symbol to be supplied directly some way like this:
  [MethodImplAttribute(MethodImplOptions.MonoNativeCall, &quot;MyDynamicLibrary.dll&quot;, &quot;MyMethod&quot;)]

This last approach gives us a bunch of important features:
  1) Late binding to dynamic libraries implementing managed classes in C becomes possible.
  2) No fancy registration mechanism (as suggested, and yet not totally working / risk free for late binding scenarios) is necessary from the unmanaged code to register methods.
  3) Dynamic library loading can be made implicitly (from the explicit dependency embodied by the attribute declaration). 

I wish something like that existed to call native code. Please tell me there's a way.

Cheers



From: Robert Jordan [via Mono] 
Sent: Monday, July 12, 2010 5:36 PM
To: MBoisse 
Subject: Re: Registering internal calls at runtime


On 12.07.2010 21:43, MBoisse wrote: 

&gt;<i> 
</I>&gt;<i> Has there been any improvements regarding late registrations of internal 
</I>&gt;<i> methods at runtime using &quot;mono_add_internal_call&quot;? 
</I>&gt;<i> 
</I>&gt;<i> Would it make sense to load and register C functions in a dll from managed 
</I>&gt;<i> code, and only then have the assembly referring to them loaded? 
</I>&gt;<i> 
</I>&gt;<i> There are many scenarios in which the C functions we need to make calls to 
</I>&gt;<i> aren't known at compile time of the embedding unmanaged code (ie mono.exe) 
</I>&gt;<i> and therefore registrations can't be made before the call to mono_jit_exec 
</I>&gt;<i> is made. However, most often the functions are known at the managed code 
</I>&gt;<i> compile time. 
</I>&gt;<i> 
</I>&gt;<i> Is P/Invoke still our only option? 
</I>
You could add an internal call that adds internal calls ;) Problem solved. 

Or resort to an internal p/invoke from the runtime itself: 

[DllImport(&quot;__Internal&quot;) 
static extern void mono_add_internal_call(string desc, IntPtr ftnptr); 

Robert 

_______________________________________________ 
Mono-devel-list mailing list 
[hidden email] 
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>



--------------------------------------------------------------------------------

View message @ <A HREF="http://mono.1490590.n4.nabble.com/Registering-internal-calls-at-runtime-tp1527179p2286774.html">http://mono.1490590.n4.nabble.com/Registering-internal-calls-at-runtime-tp1527179p2286774.html</A> 
To unsubscribe from Re: Registering internal calls at runtime, click here. 

-- 
View this message in context: <A HREF="http://mono.1490590.n4.nabble.com/Registering-internal-calls-at-runtime-tp1527179p2286841.html">http://mono.1490590.n4.nabble.com/Registering-internal-calls-at-runtime-tp1527179p2286841.html</A>
Sent from the Mono - Dev mailing list archive at Nabble.com.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100712/2df8598a/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100712/2df8598a/attachment.html</A> 
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035436.html">[Mono-dev] Registering internal calls at runtime
</A></li>
	<LI>Next message: <A HREF="035438.html">[Mono-dev] Registering internal calls at runtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35437">[ date ]</a>
              <a href="thread.html#35437">[ thread ]</a>
              <a href="subject.html#35437">[ subject ]</a>
              <a href="author.html#35437">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
