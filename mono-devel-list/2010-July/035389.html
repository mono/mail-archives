<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Proposed Patch - Google Native Client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Proposed%20Patch%20-%20Google%20Native%20Client&In-Reply-To=AANLkTil2PuTVIcy6s_PllJnwobEL2BObUt0n-2Xq1iv8%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035406.html">
   <LINK REL="Next"  HREF="035392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Proposed Patch - Google Native Client</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Proposed%20Patch%20-%20Google%20Native%20Client&In-Reply-To=AANLkTil2PuTVIcy6s_PllJnwobEL2BObUt0n-2Xq1iv8%40mail.gmail.com"
       TITLE="[Mono-dev] Proposed Patch - Google Native Client">vargaz at gmail.com
       </A><BR>
    <I>Fri Jul  2 15:41:48 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035406.html">[Mono-dev] Problem in SvcHttpHandler.cs ?
</A></li>
        <LI>Next message: <A HREF="035392.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35389">[ date ]</a>
              <a href="thread.html#35389">[ thread ]</a>
              <a href="subject.html#35389">[ subject ]</a>
              <a href="author.html#35389">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

  I finally managed to read the codegen specific changes, and here are my
comments:
- I'd prefer the nacl related changes to be in as few places as possible, so
later changes by
  people who don't know nacl won't break nacl support.
  There are three places where this is not done:
  - x86_prefix - this might be unavoidable
  - the calls to nacl_pad_call_reg/call_membase (). Could this be folded
into
    x86_call_reg/x86_call_membase () ?
  - places the where code is later patched. I think it would be better to
modify
    x86_patch () so it skips the padding added by nacl so these changes are
not needed.

                                                                  Zoltan

On Tue, Jun 22, 2010 at 7:29 PM, Elijah Taylor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">elijahtaylor at google.com</A>&gt;wrote:

&gt;<i> Greetings Mono Developers,
</I>&gt;<i>
</I>&gt;<i> Attached is a patch to support 32-bit x86 code generation for Google Native
</I>&gt;<i> Client (<A HREF="http://code.google.com/p/nativeclient/">http://code.google.com/p/nativeclient/</A>).  I encourage you to
</I>&gt;<i> browse our project for more information if you're curious.  I apologize for
</I>&gt;<i> the large diff, let me try to explain the highlights to make it easier to
</I>&gt;<i> digest.
</I>&gt;<i>
</I>&gt;<i> There is a code generation component (define: __native_client_codegen__)
</I>&gt;<i> which affects the Mono bytecode -&gt; native code generation for x86-32.  There
</I>&gt;<i> are a set of alignment restrictions, illegal instructions, and replacement
</I>&gt;<i> instructions we use for Native Client to ensure proper control-flow
</I>&gt;<i> sandboxing.  Please see
</I>&gt;<i> <A HREF="http://nativeclient.googlecode.com/svn/data/docs_tarball/nacl/googleclient/native_client/documentation/nacl_paper.pdffor">http://nativeclient.googlecode.com/svn/data/docs_tarball/nacl/googleclient/native_client/documentation/nacl_paper.pdffor</A> more details.
</I>&gt;<i>
</I>&gt;<i> There is also a runtime component (define: __native_client__) which
</I>&gt;<i> modifies or disables some functionality to be compatible with the Native
</I>&gt;<i> Client runtime.
</I>&gt;<i>
</I>&gt;<i> We also had to modify some code that doesn't fall under either of the above
</I>&gt;<i> defines.  Most of these changes revolved around type safety.  The modified
</I>&gt;<i> version of gcc we use to compile Native Client modules is more strict about
</I>&gt;<i> types, and it caught what look like legitimate issues with the Mono
</I>&gt;<i> codebase.  The largest issue in terms of number of errors was the use of
</I>&gt;<i> mono_bool and gboolean interchangeably between declaration and definition of
</I>&gt;<i> many functions.  gboolean is defined as an &quot;int&quot; but mono_bool is defined as
</I>&gt;<i> int32_t.  Other type issues are listed directly below.  Feedback is
</I>&gt;<i> appreciated on these changes because of our unfamiliarity with this code,
</I>&gt;<i> but I modified these in the way that seemed most &quot;right&quot; at the time.
</I>&gt;<i>
</I>&gt;<i> mono/metadata/decimal.h:47 mono_decimal2string int -&gt; gint32
</I>&gt;<i> mono/metadata/filewatcher.h:28 gboolean -&gt; int
</I>&gt;<i> mono/metadata/filewatcher.c:158 int32 -&gt; gint32
</I>&gt;<i> mono/metadata/threads-type.h:64 int -&gt; gint32
</I>&gt;<i>
</I>&gt;<i> mono/mini/mini.h:1546  gboolean sort_end -&gt; int sort_type
</I>&gt;<i> mono/mini/mini.h:1733  gboolean fp -&gt; int bank
</I>&gt;<i>
</I>&gt;<i> The last bit of modification is to genmdesc and the Makefiles in general.
</I>&gt;<i> We added a new flag to genmdesc called &quot;nacl&quot; which overrides the given max
</I>&gt;<i> length of an instruction.  Native Client code tends to be larger because of
</I>&gt;<i> some of the instruction requirements we have, so some of the instructions in
</I>&gt;<i> cpu-x86.md had to be modified.  This is all tied to a new configure flag
</I>&gt;<i> called &quot;--enable-nacl-codegen&quot;, which enables the codegen define, and sets
</I>&gt;<i> up calls to genmdesc with a --nacl flag.  It also modifies the mono-wrapper
</I>&gt;<i> script so one aspect of our code generation rules (masking jump targets to
</I>&gt;<i> 32-byte boundaries) is turned off while compiling and testing mono from the
</I>&gt;<i> Makefiles, which is required when testing outside of the Native Client
</I>&gt;<i> environment.  We're also including a standalone check &quot;fsacheck&quot; which tests
</I>&gt;<i> mono code generation as full AOT and a the library linked into a fully
</I>&gt;<i> static executable.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I look forward to your comments, questions, and suggestions.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Elijah Taylor
</I>&gt;<i> Google Native Client Team
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100702/31bdaa94/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100702/31bdaa94/attachment.html</A> 
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035406.html">[Mono-dev] Problem in SvcHttpHandler.cs ?
</A></li>
	<LI>Next message: <A HREF="035392.html">[Mono-dev] Proposed Patch - Google Native Client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35389">[ date ]</a>
              <a href="thread.html#35389">[ thread ]</a>
              <a href="subject.html#35389">[ subject ]</a>
              <a href="author.html#35389">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
