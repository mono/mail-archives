<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Registering internal calls at runtime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Registering%20internal%20calls%20at%20runtime&In-Reply-To=i1g1ro%24d6a%241%40dough.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035437.html">
   <LINK REL="Next"  HREF="035443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Registering internal calls at runtime</H1>
    <B>Michel Boiss&#233;</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Registering%20internal%20calls%20at%20runtime&In-Reply-To=i1g1ro%24d6a%241%40dough.gmane.org"
       TITLE="[Mono-dev] Registering internal calls at runtime">mboisse at noesisinnovation.net
       </A><BR>
    <I>Mon Jul 12 19:05:19 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035437.html">[Mono-dev] Registering internal calls at runtime
</A></li>
        <LI>Next message: <A HREF="035443.html">[Mono-dev] Registering internal calls at runtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35438">[ date ]</a>
              <a href="thread.html#35438">[ thread ]</a>
              <a href="subject.html#35438">[ subject ]</a>
              <a href="author.html#35438">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you Robert, I appreciate your involvement.

Here's our problem: any calls to mono_add_internal_call is ineffective when 
made from managed code.
Our initial idea was to use P/Invoke to load a dynamic library and run some 
initialization method in it which would make the appropriate registrations. 
Based on tests we did, any call which doesn't precede the mono_jit_exec call 
has no effect.

Which of these assumptions can we make?
  Do classes using internal calls have their methods bound to internal 
methods as soon as their owning assembly is initialized?
  Or is the internal method registry is simply completely sealed once 
mono_jit_exec is running?

I was hoping the binding process was done &quot;on request&quot;, only the first time 
a method is called from managed code (because an exception is thrown only 
when a call to the unfound internal method is made).

Actually, internal method declarations in the managed code like
  [MethodImplAttribute(MethodImplOptions.InternalCall)]
would be considerably more powerful if it allowed a module and a method 
symbol to be supplied directly some way like this:
  [MethodImplAttribute(MethodImplOptions.MonoNativeCall, 
&quot;MyDynamicLibrary.dll&quot;, &quot;MyMethod&quot;)]

This last approach gives us a bunch of important features:
  1) Late binding to dynamic libraries implementing managed classes in C 
becomes possible.
  2) No fancy registration mechanism (as suggested, and yet not totally 
working / risk free for late binding scenarios) is necessary from the 
unmanaged code to register methods.
  3) Dynamic library loading can be made implicitly (from the explicit 
dependency embodied by the attribute declaration).

I wish something like that existed to call native code. Please tell me 
there's a way.

Cheers

--------------------------------------------------
From: &quot;Robert Jordan&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt;
Sent: Monday, July 12, 2010 5:35 PM
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Subject: Re: [Mono-dev] Registering internal calls at runtime

&gt;<i> On 12.07.2010 21:43, MBoisse wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Has there been any improvements regarding late registrations of internal
</I>&gt;&gt;<i> methods at runtime using &quot;mono_add_internal_call&quot;?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Would it make sense to load and register C functions in a dll from 
</I>&gt;&gt;<i> managed
</I>&gt;&gt;<i> code, and only then have the assembly referring to them loaded?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are many scenarios in which the C functions we need to make calls 
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> aren't known at compile time of the embedding unmanaged code (ie 
</I>&gt;&gt;<i> mono.exe)
</I>&gt;&gt;<i> and therefore registrations can't be made before the call to 
</I>&gt;&gt;<i> mono_jit_exec
</I>&gt;&gt;<i> is made. However, most often the functions are known at the managed code
</I>&gt;&gt;<i> compile time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is P/Invoke still our only option?
</I>&gt;<i>
</I>&gt;<i> You could add an internal call that adds internal calls ;) Problem solved.
</I>&gt;<i>
</I>&gt;<i> Or resort to an internal p/invoke from the runtime itself:
</I>&gt;<i>
</I>&gt;<i> [DllImport(&quot;__Internal&quot;)
</I>&gt;<i> static extern void mono_add_internal_call(string desc, IntPtr ftnptr);
</I>&gt;<i>
</I>&gt;<i> Robert
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I></PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035437.html">[Mono-dev] Registering internal calls at runtime
</A></li>
	<LI>Next message: <A HREF="035443.html">[Mono-dev] Registering internal calls at runtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35438">[ date ]</a>
              <a href="thread.html#35438">[ thread ]</a>
              <a href="subject.html#35438">[ subject ]</a>
              <a href="author.html#35438">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
