<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Make mono_dl_register_library into a fallback
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Make%20mono_dl_register_library%20into%20a%20fallback&In-Reply-To=20100702101827.GO18979%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035378.html">
   <LINK REL="Next"  HREF="035439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Make mono_dl_register_library into a fallback</H1>
    <B>Michael Hutchinson</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Make%20mono_dl_register_library%20into%20a%20fallback&In-Reply-To=20100702101827.GO18979%40debian.org"
       TITLE="[Mono-dev] [PATCH] Make mono_dl_register_library into a fallback">m.j.hutchinson at gmail.com
       </A><BR>
    <I>Fri Jul  2 12:38:34 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035378.html">[Mono-dev] [PATCH] Make mono_dl_register_library into a	fallback
</A></li>
        <LI>Next message: <A HREF="035439.html">[Mono-dev] [PATCH] Make mono_dl_register_library into a fallback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35384">[ date ]</a>
              <a href="thread.html#35384">[ thread ]</a>
              <a href="subject.html#35384">[ subject ]</a>
              <a href="author.html#35384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jul 2, 2010 at 6:18 AM, Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; wrote:
&gt;<i> On 07/01/10 Michael Hutchinson wrote:
</I>&gt;&gt;<i> The mono_dl_register_library function can currently be used to
</I>&gt;&gt;<i> register P/Invoke mappings for platforms that do not have a dynamic
</I>&gt;&gt;<i> linker. The attached patch makes it also function as a fallback when
</I>&gt;&gt;<i> the system's dynamic linker cannot resolve the library, so that it is
</I>&gt;&gt;<i> always available to embedders.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'll also need to restore mono/utils/mono-embed.h to the public
</I>&gt;&gt;<i> headers in the autotools build (but this patch was created using MSVC
</I>&gt;&gt;<i> on Windows).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OK to commit to trunk?
</I>&gt;<i>
</I>&gt;<i> This interface is not suitable as a fallback mechanism, it would be too
</I>&gt;<i> cumbersome to use and it's probably not ideal even for its intended
</I>&gt;<i> purpose. What about a callback registration system instead?
</I>
The intended purpose, AFAIK, is to expose statically linked libraries
to P/Invoke. That's what I'm using it for, and it's very
straightforward to use this way. I have a trivial C# tool that
reflects over the library with the P/Invokes and dumps the mappings to
source files.

My patch isn't intended to provide a generic dynamic linker fallback.
It's meant to provide an easy way to P/Invoke statically linked
libraries for all embedders, not just those on platforms without
dynamic linkers.

&gt;<i> It is more flexible as a fallback since it doesn't require to register
</I>&gt;<i> upfront all the possible names and load the all functions at startup.
</I>&gt;<i> It's likely better also for the original purpose when, for example,
</I>&gt;<i> even if dynamic linking is not possible it is possible to lookup a
</I>&gt;<i> symbol at runtime.
</I>&gt;<i> It opens up the possibility of also generating the code at runtime
</I>&gt;<i> (for redirecting some win32 p/invokes to winforms for example, or other
</I>&gt;<i> tricks).
</I>&gt;<i>
</I>&gt;<i> Something along these lines:
</I>&gt;<i>
</I>&gt;<i> typedef void* (*MonoDlFallbackLoad) (const char *name, int flags, char **err, void *user_data);
</I>&gt;<i> typedef void* (*MonoDlFallbackSymbol) (void *handle, const char *name, char **err, void *user_data);
</I>&gt;<i> typedef void* (*MonoDlFallbackClose) (void *handle, void *user_data);
</I>&gt;<i>
</I>&gt;<i> void mono_dl_register_fallback (MonoDlFallbackLoad load_func, MonoDlFallbackSymbol symbol_func,
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;MonoDlFallbackClose close_func, void *user_data);
</I>&gt;<i>
</I>&gt;<i> The old interface could be easily implemented on top of this new one (though we
</I>&gt;<i> likely could drop it as well).
</I>
That's certainly more flexible, but I'm not convinced it's necessary
at this time without concrete use cases. If we're going to include the
old interface anyway - else we make embedders responsible for
reimplementing its functionality - then why not go this path for now,
and reimplement it on top of the callbacks later?

The tricks you mention could be much more useful if callbacks could
intercept lookups for individual symbols, rather than acting as a
fallback for handling whole libraries. But this would require much
more substantial changes to the dynamic linker code.

-- 
Michael Hutchinson
<A HREF="http://mjhutchinson.com">http://mjhutchinson.com</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035378.html">[Mono-dev] [PATCH] Make mono_dl_register_library into a	fallback
</A></li>
	<LI>Next message: <A HREF="035439.html">[Mono-dev] [PATCH] Make mono_dl_register_library into a fallback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35384">[ date ]</a>
              <a href="thread.html#35384">[ thread ]</a>
              <a href="subject.html#35384">[ subject ]</a>
              <a href="author.html#35384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
