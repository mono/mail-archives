<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Runtime.MonoIline
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Runtime.MonoIline&In-Reply-To=8cca42d80901240602v2dcc50c8lcb3f009832c44f92%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030743.html">
   <LINK REL="Next"  HREF="030633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Runtime.MonoIline</H1>
    <B>Jerry Maine</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Runtime.MonoIline&In-Reply-To=8cca42d80901240602v2dcc50c8lcb3f009832c44f92%40mail.gmail.com"
       TITLE="[Mono-dev] Runtime.MonoIline">crashfourit at gmail.com
       </A><BR>
    <I>Sat Jan 24 15:00:09 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030743.html">[Mono-dev]  Help on deploying library to gac using autotools
</A></li>
        <LI>Next message: <A HREF="030633.html">[Mono-dev] Runtime.MonoIline
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30632">[ date ]</a>
              <a href="thread.html#30632">[ thread ]</a>
              <a href="subject.html#30632">[ subject ]</a>
              <a href="author.html#30632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Rodrigo Kumpera wrote:
&gt;<i> No, I spend to whole week fixing race conditions and been sick.
</I>&gt;<i> The code is pretty simple, thou:
</I>&gt;<i>
</I>&gt;<i> /*NOTE, this doesn't work with dynamic assemblies*/
</I>&gt;<i> void
</I>&gt;<i> mono_image_has_assembly_ref (MonoImage *image, const char
</I>&gt;<i> *target_assembly)
</I>&gt;<i>         MonoTableInfo *t;
</I>&gt;<i>         int i;
</I>&gt;<i>         if (image-&gt;dynamic)
</I>&gt;<i>             return FALSE;
</I>&gt;<i>         t =  = &amp;image-&gt;tables [MONO_TABLE_ASSEMBLYREF];
</I>&gt;<i>         for (i = 0; i &lt; t-&gt;rows; i++) {
</I>&gt;<i>             const char *ref_name = mono_metadata_string_heap
</I>&gt;<i> (mono_metadata_decode_row_col (t, i, MONO_ASSEMBLYREF_NAME))
</I>&gt;<i>             if (!strcmp (target_assembly, ref_name))
</I>&gt;<i>                 return TRUE;
</I>&gt;<i>         }
</I>&gt;<i>         return FALSE;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The part that checks for the presence of the attribute I didn't work
</I>&gt;<i> much, but it's a trimmed down version of
</I>&gt;<i> reflection.c mono_custom_attrs_from_index
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Jan 23, 2009 at 7:39 PM, Jerry Maine &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">crashfourit at gmail.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">crashfourit at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     Kumpera, have you finished your patch that would make my inlining
</I>&gt;<i>     patch simpler?
</I>&gt;<i>
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     Mono-devel-list mailing list
</I>&gt;<i>     <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>This is the idea, most cases we won't find the assembly reference in
the image and it will speed up those cases. Then we can add those
optimizations you here talking about to test if the attribute is
present in small increments over time.

/*NOTE, this doesn't work with dynamic assemblies*/
gboolean
mono_image_has_assembly_ref (MonoImage *image, const char
*target_assembly)
{
    MonoTableInfo *t;
    int i;
 
    //TODO: make this work with dynamic assemblies.
    if (image-&gt;dynamic)
        return FALSE;

    t = &amp;image-&gt;tables [MONO_TABLE_ASSEMBLYREF];
        for (i = 0; i &lt; t-&gt;rows; i++) {
        const char *ref_name = mono_metadata_string_heap
(mono_metadata_decode_row_col (t, i, MONO_ASSEMBLYREF_NAME))
        if (!strcmp (target_assembly, ref_name))
        return TRUE;
    }
    return FALSE;
}


gboolean
mono_assembly_has_custom_attr_partial (MonoAssembly *assembly, const
char *attr_assembly, const char *attr_namespace, const char *attr)
{
    MonoCustomAttrInfo *attributes;

    if (attr_assembly != NULL)
        if (!mono_image_has_assembly_ref(assembly-&gt;image, attr_assembly)
            return FALSE;

    attributes = mono_custom_attrs_from_assembly(assembly);

    if (attributes) {
        for (i = 0; i &lt; attributes-&gt;num_attrs; ++i) {
            MonoClass *klass = attributes-&gt;attrs [i].ctor-&gt;klass;
            if (strcmp (klass-&gt;image-&gt;assembly_name, attr_assembly) ==
0) {
                if (strcmp (klass-&gt;name_space, attr_namespace) == 0)
                    if (strcmp (klass-&gt;name, attr) == 0)
                        return TRUE;
            }
        }
        mono_custom_attrs_free (attributes); 
    }

    return FALSE;
}

gboolean
mono_method_has_custom_attr_partial (MonoMethod *method, const char
*attr_assembly, const char *attr_namespace, const char *attr)
{
    MonoCustomAttrInfo *attributes;

    if (attr_assembly != NULL)
        if (!mono_image_has_assembly_ref(method-&gt;klass-&gt;image,
attr_assembly)
            return FALSE;

    attributes = mono_custom_attrs_from_method(method);

    if (attributes) {
        for (i = 0; i &lt; attributes-&gt;num_attrs; ++i) {
            MonoClass *klass = attributes-&gt;attrs [i].ctor-&gt;klass;
            if (strcmp (klass-&gt;image-&gt;assembly_name, attr_assembly) ==
0) {
                if (strcmp (klass-&gt;name_space, attr_namespace) == 0)
                    if (strcmp (klass-&gt;name, attr) == 0)
                        return TRUE;
            }
        }
        mono_custom_attrs_free (attributes); 
    }
 
    return FALSE;
}

gboolean
mono_class_has_custom_attr_partial (MonoClass *klass, const char
*attr_assembly, const char *attr_namespace, const char *attr)
{
    MonoCustomAttrInfo *attributes;

    if (attr_assembly != NULL)
        if (!mono_image_has_assembly_ref(klass-&gt;image, attr_assembly)
            return FALSE;

    attributes = mono_custom_attrs_from_class(klass);

    if (attributes) {
        for (i = 0; i &lt; attributes-&gt;num_attrs; ++i) {
            MonoClass *klass = attributes-&gt;attrs [i].ctor-&gt;klass;
            if (strcmp (klass-&gt;image-&gt;assembly_name, attr_assembly) ==
0) {
                if (strcmp (klass-&gt;name_space, attr_namespace) == 0)
                    if (strcmp (klass-&gt;name, attr) == 0)
                        return TRUE;
            }
        }
        mono_custom_attrs_free (attributes); 
    }
 
    return FALSE;
}
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iEYEARECAAYFAkl7c0IACgkQ1jvea6V8vHIZ2gCdGGDm0jbOLwmenqjMoiOBUtn9
VjgAnAjMyeWWAsib5PiBebyvU+DAwrE9
=SczF
-----END PGP SIGNATURE-----

</PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030743.html">[Mono-dev]  Help on deploying library to gac using autotools
</A></li>
	<LI>Next message: <A HREF="030633.html">[Mono-dev] Runtime.MonoIline
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30632">[ date ]</a>
              <a href="thread.html#30632">[ thread ]</a>
              <a href="subject.html#30632">[ subject ]</a>
              <a href="author.html#30632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
