<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Tweaks needed in security.c for running Mono on	Android - patch included
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Tweaks%20needed%20in%20security.c%20for%20running%20Mono%20on%0A%09Android%20-%20patch%20included&In-Reply-To=F66FBFAB4D3589419492C54F8C7AF34EA7803C444B%40Koushik-Exch.CLOCKWORKS.KOUSHIKDUTTA.COM">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030441.html">
   <LINK REL="Next"  HREF="030443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Tweaks needed in security.c for running Mono on	Android - patch included</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Tweaks%20needed%20in%20security.c%20for%20running%20Mono%20on%0A%09Android%20-%20patch%20included&In-Reply-To=F66FBFAB4D3589419492C54F8C7AF34EA7803C444B%40Koushik-Exch.CLOCKWORKS.KOUSHIKDUTTA.COM"
       TITLE="[Mono-dev] Tweaks needed in security.c for running Mono on	Android - patch included">kumpera at gmail.com
       </A><BR>
    <I>Mon Jan 12 13:23:55 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030441.html">[Mono-dev] Tweaks needed in security.c for running Mono on Android - patch included
</A></li>
        <LI>Next message: <A HREF="030443.html">[Mono-dev]  Simd struct improvements. (the .cs files)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30447">[ date ]</a>
              <a href="thread.html#30447">[ thread ]</a>
              <a href="subject.html#30447">[ subject ]</a>
              <a href="author.html#30447">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Koushik,

To have your patch accepted into the mono runtime you need to state that
your contribution is under the MIT/X11 license
otherwise we can't commit it.

Besides this, most of the code in System.Security is windows centered and
makes no sense under Android. Maybe the best
solution is just remove it as using it would make no sense at all.

Thanks,
Rodrigo


2009/1/11 Koushik K. Dutta &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">koush at koushikdutta.com</A>&gt;

&gt;<i>  Hi all, I'm working on getting Mono running under Android. So far, I've
</I>&gt;<i> been able to get things running with next to no code changes (by way of
</I>&gt;<i> configure, compiler and linker options).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I did run into one issue though that required a code change. Mono has a
</I>&gt;<i> dependency on libc.so. On Android, Google implemented a custom lightweight
</I>&gt;<i> version of libc.so, which they call &quot;Bionic&quot;. I have tried building Mono
</I>&gt;<i> against Bionic, but at the moment, it seems basically impossible because
</I>&gt;<i> Bionic does not have Unicode support. (I will dig into other solutions for
</I>&gt;<i> this further, but it's low priority at the moment&#8230; I want to get things
</I>&gt;<i> running J)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So, as a result, Mono on Android needs to be packaged with the standard
</I>&gt;<i> ARM/Linux version of libc.  However, there are significant differences
</I>&gt;<i> between the Linux file system and Android file system. So when Mono's uses
</I>&gt;<i> libc's getpwuid and getpwuid_r, it fails, and causes further problems in the
</I>&gt;<i> runtime. Linux's getpwuid works by examining various files in /etc. But,
</I>&gt;<i> Android does not have a /etc. Android has a uid/gid repository that is very
</I>&gt;<i> different from typical Linux distributions.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For reference, here is Bionic's implementation of getpwuid (there is no
</I>&gt;<i> getpwuid_r):
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> struct passwd* getpwuid(uid_t uid)
</I>&gt;<i>
</I>&gt;<i> {
</I>&gt;<i>
</I>&gt;<i>     stubs_state_t*  state = __stubs_state();
</I>&gt;<i>
</I>&gt;<i>     struct passwd*  pw;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     if (state == NULL)
</I>&gt;<i>
</I>&gt;<i>         return NULL;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     pw = &amp;state-&gt;passwd;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     if ( android_id_to_passwd(pw, uid) != NULL )
</I>&gt;<i>
</I>&gt;<i>         return pw;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     if (uid &lt; AID_APP) {
</I>&gt;<i>
</I>&gt;<i>         errno = ENOENT;
</I>&gt;<i>
</I>&gt;<i>         return NULL;
</I>&gt;<i>
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     snprintf( state-&gt;app_name_buffer, sizeof state-&gt;app_name_buffer,
</I>&gt;<i>
</I>&gt;<i>               &quot;app_%d&quot;, uid - AID_APP );
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     pw-&gt;pw_name  = state-&gt;app_name_buffer;
</I>&gt;<i>
</I>&gt;<i>     pw-&gt;pw_dir   = &quot;/data&quot;;
</I>&gt;<i>
</I>&gt;<i>     pw-&gt;pw_shell = &quot;/system/bin/sh&quot;;
</I>&gt;<i>
</I>&gt;<i>     pw-&gt;pw_uid   = uid;
</I>&gt;<i>
</I>&gt;<i>     pw-&gt;pw_gid   = uid;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     return pw;
</I>&gt;<i>
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> getpwuid is used in three locations Mono. The two troublesome ones are in
</I>&gt;<i> mono/metadata/security.c in the functions &quot;GetTokenName&quot; and &quot;IsMemberOf&quot;.
</I>&gt;<i> (The third is in pwd.c for Mono's Posix syscall wrapper, but that is not
</I>&gt;<i> causing the problem. I'll fix that later.)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have attached a patch file that I have successfully built and tested
</I>&gt;<i> against Android.  It is also regression safe, as all the new code is inside
</I>&gt;<i> a #ifdef PLATFORM_ANDROID block. The workaround is simple, and there are
</I>&gt;<i> comments explaining how the Android uid model works.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Alternatively, I can obviously compile a custom version of libc.so for
</I>&gt;<i> Mono, but I do not think that is a good solution. Mono is already using
</I>&gt;<i> #ifdef PLATFORM_WIN32 at the same points in code that I placed my
</I>&gt;<i> PLATFORM_ANDROID, and I'm assuming that the Mono developers will be more
</I>&gt;<i> open to my proposed changes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For information about how to build Mono to target Android, you can
</I>&gt;<i> reference my post:
</I>&gt;<i> <A HREF="http://www.koushikdutta.com/2009/01/building-mono-for-android.html.">http://www.koushikdutta.com/2009/01/building-mono-for-android.html.</A> Or
</I>&gt;<i> feel free to contact me.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Koushik Dutta
</I>&gt;<i>
</I>&gt;<i> www.koushikdutta.com
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Koushik Dutta
</I>&gt;<i>
</I>&gt;<i> www.koushikdutta.com
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090112/23a39ba1/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090112/23a39ba1/attachment-0001.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030441.html">[Mono-dev] Tweaks needed in security.c for running Mono on Android - patch included
</A></li>
	<LI>Next message: <A HREF="030443.html">[Mono-dev]  Simd struct improvements. (the .cs files)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30447">[ date ]</a>
              <a href="thread.html#30447">[ thread ]</a>
              <a href="subject.html#30447">[ subject ]</a>
              <a href="author.html#30447">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
