<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] patch to mono-mman.c to accommodate Android, bug report for Arm thunk handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patch%20to%20mono-mman.c%20to%20accommodate%20Android%2C%0A%20bug%20report%20for%20Arm%20thunk%20handling&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030589.html">
   <LINK REL="Next"  HREF="030580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] patch to mono-mman.c to accommodate Android, bug report for Arm thunk handling</H1>
    <B>Koushik K. Dutta</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patch%20to%20mono-mman.c%20to%20accommodate%20Android%2C%0A%20bug%20report%20for%20Arm%20thunk%20handling&In-Reply-To="
       TITLE="[Mono-dev] patch to mono-mman.c to accommodate Android, bug report for Arm thunk handling">koush at koushikdutta.com
       </A><BR>
    <I>Tue Jan 20 21:37:39 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030589.html">[Mono-dev] 2.2 broken for solaris
</A></li>
        <LI>Next message: <A HREF="030580.html">[Mono-dev] patch to mono-mman.c to accommodate Android,	bug 	report for Arm thunk handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30579">[ date ]</a>
              <a href="thread.html#30579">[ thread ]</a>
              <a href="subject.html#30579">[ subject ]</a>
              <a href="author.html#30579">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello again!

Android's libc has an implementation of mmap, but does not implement shmem functions. Instead Android uses a different implementation of memory sharing called &quot;ashmem&quot;.

mono-mman.c assumes that if mmap is available/implemented, so is shm_open. This change further reorganizes the code so that mmap and and shm_open are uncoupled (as they are not really dependent on each other). This allows Mono on Android to use mmap instead of malloc.


Incidentally, this change came out of necessity: if mmap is not available, Mono falls back to using the malloc based implementation of mono_valloc. The problem with malloc is that it exposed a bug in the Arm thunk handling:
If the delta between the of a branch-and-link and the target's instruction pointer is greater than 0x1ffffff, it will attempt to utilize a thunk to explicitly set the program counter to the target. The problem with this is that the number of entries in the thunk table is hard coded to (code chunk length / 8). So if the intended thunk table fills up due to numerous thunks, it will check the other tables that are available. This is where malloc and mmap seem to behave differently:

*         mmap seems to provide sequential memory addresses with every successive call to the function. This works out well, since then the original branch-and-link that is being modified is in branch range of thunk tables that were created for other code chunks.

*         malloc , at least on Android, seems to provide wildly different addresses with each successive call (in a deterministic manner it seems). In my case, it starts out providing addresses in the 0x00700000 range. Then the addresses jump up into the 0x40000000 range. This is where if a thunk table fills up, and Mono can't find a suitable thunk slot (one that is in branch range), it fails at the assert in mini-arm.c:handle_thunk:~2035.

So, although this bug exists for any Arm build, this patch just keeps it from surfacing on Android (for now). I looked into actually fixing this properly, because it is possible that it could occur with mmap (it is just very unlikely). But from my investigation, the changes would be too deep (changes to arm_patch, and more). And I'm not familiar enough with the code... yet. :)

Koushik Dutta
www.koushikdutta.com&lt;<A HREF="http://www.koushikdutta.com/">http://www.koushikdutta.com/</A>&gt;

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090120/146bc2c6/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090120/146bc2c6/attachment.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: androidmono.patch
Type: application/octet-stream
Size: 2727 bytes
Desc: androidmono.patch
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090120/146bc2c6/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090120/146bc2c6/attachment.obj</A> 
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030589.html">[Mono-dev] 2.2 broken for solaris
</A></li>
	<LI>Next message: <A HREF="030580.html">[Mono-dev] patch to mono-mman.c to accommodate Android,	bug 	report for Arm thunk handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30579">[ date ]</a>
              <a href="thread.html#30579">[ thread ]</a>
              <a href="subject.html#30579">[ subject ]</a>
              <a href="author.html#30579">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
