<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] bug-60172 : OdbcConnection not closing properly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20bug-60172%20%3A%20OdbcConnection%20not%20closing%20properly&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006568.html">
   <LINK REL="Next"  HREF="006571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] bug-60172 : OdbcConnection not closing properly</H1>
    <B>T Sureshkumar</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20bug-60172%20%3A%20OdbcConnection%20not%20closing%20properly&In-Reply-To="
       TITLE="[Mono-devel-list] [PATCH] bug-60172 : OdbcConnection not closing properly">tsureshkumar at novell.com
       </A><BR>
    <I>Mon Jun 21 00:59:40 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006568.html">[Mono-devel-list] Filling Datatable not working
</A></li>
        <LI>Next message: <A HREF="006571.html">[Mono-devel-list] Mono.Security.Dll dependency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6569">[ date ]</a>
              <a href="thread.html#6569">[ thread ]</a>
              <a href="subject.html#6569">[ subject ]</a>
              <a href="author.html#6569">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
   I have attached a patch for bug bugzila-id :60172. The detailed description of the patch is given at the end of this mail.

  The patch is for OdbcConnection class ( mcs/class/System.Data/System.Data.Odbc/OdbcConnection.cs ). I have moved the env handle allocation to  Open method rather than the constructor, so that we can free them when Close method is called. In the Close method, I have disconnected the Odbc connection using SQLDisconnect &amp; freed the handles env &amp; dbc using SQLFreeHandle.

  I have checked the fix against MySql db &amp; mono/MS.NET runtime.

  Somebody could verify the patch &amp; please suggest me any problem/enhancement with this patch.

  FYI : The second part of the patch is for method &quot;Open&quot;. diff does not show the method name in the diff file in this case.. i.e. after the line ----  &quot;@@ -220,11 +228,22 @@&quot;

Best Regards,
Suresh.

BUG DESCRIPTION : 60172
================================================================================
Opened by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien.robitaille at croesus.com</A> (S&#233;bastien Robitaille) on  2004-06-14 18:23   Long Description 


Description of Problem:

An exception is thrown when OdbcConnection.Open is called more than 188 
times.

Hint: OdbcConnection is leaking ODBC resource handles.

The following members in OdbcConnection.cs are allocated with 
SQLAllocHandle but are never freed with SQLFreeHandle:

henv, hdbc

Steps to reproduce the problem:
1. Call OdbcConnection.Open() many times and see that after 188 calls, an 
exception is thrown:

System.Data.Odbc.OdbcException: [unixODBC][FreeTDS][SQL Server]Login 
incorrect.
in &lt;0x003c8&gt; System.Data.Odbc.OdbcConnection:Open ()
in &lt;0x0004f&gt; (wrapper remoting-invoke-with-check) 
System.Data.Odbc.OdbcConnection:Open ()
in &lt;0x0006b&gt; MonoOdbcDataSetTest.Class1:TestConnections ()


2. Execute the following code:

OdbcConnection connection = new OdbcConnection(connectionString);
for(int nIndex = 0; nIndex &lt; 1000; nIndex++)
{
	connection.Open();
	System.Console.WriteLine(nIndex);
	connection.Close();
}


Actual Results:
0
1
...
186
187
188
System.Data.Odbc.OdbcException: [unixODBC][FreeTDS][SQL Server]Login 
incorrect.
in &lt;0x003c8&gt; System.Data.Odbc.OdbcConnection:Open ()
in &lt;0x0004f&gt; (wrapper remoting-invoke-with-check) 
System.Data.Odbc.OdbcConnection:Open ()
in &lt;0x0006b&gt; MonoOdbcDataSetTest.Class1:TestConnections ()


Expected Results:
0
1
...
998
999

How often does this happen? 
Always

Additional Information:

Sybase Database
mono-0.95
freetds-0.62.3
unixODBC-2.2.8
------- Additional Comments From S&#233;bastien Robitaille 2004-06-15 15:01 -------
After investigation, the number &quot;188&quot; specified un the Bug 
description is related to the maximum number of simultaneous 
connections authorized by the database engine (200 on my database).

The Close method doesn't seem to behave correctly (It doesn't 
actually close the database connection).


 


-------------- next part --------------
A non-text attachment was scrubbed...
Name: 60172_patch.diff
Type: application/octet-stream
Size: 4768 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20040620/92d6b295/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20040620/92d6b295/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006568.html">[Mono-devel-list] Filling Datatable not working
</A></li>
	<LI>Next message: <A HREF="006571.html">[Mono-devel-list] Mono.Security.Dll dependency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6569">[ date ]</a>
              <a href="thread.html#6569">[ thread ]</a>
              <a href="subject.html#6569">[ subject ]</a>
              <a href="author.html#6569">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
