<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] String.Replace patch to Managed code.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20String.Replace%20patch%20to%20Managed%20code.&In-Reply-To=003d01c44763%24db6c9fc0%246464a8c0%40ansuria">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006132.html">
   <LINK REL="Next"  HREF="006103.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] String.Replace patch to Managed code.</H1>
    <B>grompf</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20String.Replace%20patch%20to%20Managed%20code.&In-Reply-To=003d01c44763%24db6c9fc0%246464a8c0%40ansuria"
       TITLE="[Mono-devel-list] String.Replace patch to Managed code.">grompf at sublimeintervention.com
       </A><BR>
    <I>Tue Jun  1 13:26:48 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006132.html">[Mono-devel-list] [Patch] First patch for making String	managed
</A></li>
        <LI>Next message: <A HREF="006103.html">[Mono-devel-list] String.Replace patch to Managed code.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6102">[ date ]</a>
              <a href="thread.html#6102">[ thread ]</a>
              <a href="subject.html#6102">[ subject ]</a>
              <a href="author.html#6102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andreas,

   Admittedly and fully understood that what I initially presented 
wasn't optimized.  I was working on tackling the bug first (with &quot;safe&quot; 
managed code), before moving it to the optimized unsafe version (which 
you posted for Replace(char, char) and looks pretty good.

   Now, that being said, considering your latest patch with IndexOf 
improvments.  Your second &quot;optimized&quot; patch, wouldn't it be faster to 
do:

int pos = this.IndexOf(oldChar);
if(pos == -1)
	return this;

fixed (char *source = &amp;start_char) {
   string tmp = InternalAllocateStr(length);
   CharCopy(source, dest, pos);
   for(int i = 0; i &lt; length; i++) {
     if(source[x] == oldChar)
	dest[x] = newChar;
     else
	dest[x] = source[x];
   }
   return tmp;
}


??

-kangaroo

On 31-May-04, at 7:06 PM, Andreas Nahr wrote:

&gt;<i> Hi,
</I>&gt;<i> &#160;
</I>&gt;<i> I'm working on string for quite some time now, but&#160;only when&#160;I find 
</I>&gt;<i> spare&#160;time to do so, so things are progressing relatively slow in that 
</I>&gt;<i> field (especially as things are very performance sensitive in there 
</I>&gt;<i> and need a *lot* of testing)
</I>&gt;<i> &#160;
</I>&gt;<i> And I think that also a slight problem with your patch. Just from 
</I>&gt;<i> looking at it (without too much&#160;testing): The performance of it would 
</I>&gt;<i> be really bad.
</I>&gt;<i> For the invariant version a relatively fast&#160;managed implementation is 
</I>&gt;<i> relatively easy (unfortunatelly it is still a little bit slower than 
</I>&gt;<i> native, but a lot faster than your solution):
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;&#160;&#160;string tmp = InternalAllocateStr (length);
</I>&gt;<i> &#160;&#160;&#160;fixed (char* s = &amp;start_char, d = tmp) {
</I>&gt;<i> &#160;&#160;&#160;&#160;char* source = s, dest = d;
</I>&gt;<i> &#160;&#160;&#160;&#160;for (int x = 0; x &lt; length; x++) {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;if (*source == oldChar)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;*dest = newChar;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;else
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;*dest = *source;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;source++;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;dest++;
</I>&gt;<i> &#160;&#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;return tmp;
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;
</I>&gt;<i> If you like to test things&#160;a little bit you could also look at this 
</I>&gt;<i> optimized version (needs the CharCopy patch I submitted to this list):
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;&#160;&#160;fixed (char* source = &amp;start_char) {
</I>&gt;<i> &#160;&#160;&#160;&#160;for (int x = 0; x &lt; length; x++) {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;if (source[x] == oldChar) {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;string tmp = InternalAllocateStr (length);
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;fixed (char* dest = tmp) {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;CharCopy (source, dest, x);
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;source[x] = newChar;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;for (; x &lt; length; x++) {
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if (source[x] == oldChar)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;dest[x] = newChar;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;else
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;dest[x] = source[x];
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;return tmp;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;}
</I>&gt;<i> &#160;&#160;&#160;return this;
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;
</I>&gt;<i> &#160;
</I>&gt;<i> Andreas
</I>&gt;<i> &#160;
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i>  From: grompf
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Sent: Monday, May 31, 2004 9:03 PM
</I>&gt;<i> Subject: [Mono-devel-list] String.Replace patch to Managed code.
</I>&gt;<i>
</I>&gt;<i> In my effort to address bug #59274, I tracked the problem down to 
</I>&gt;<i> icu/glib in locales.c not replacing \0.
</I>&gt;<i>
</I>&gt;<i> Attached is a patch for String.cs to replace the internal methods with 
</I>&gt;<i> managed code.
</I>&gt;<i>
</I>&gt;<i> There is probably a more efficient way of Replace(String, String), but 
</I>&gt;<i> both of these methods have been tested and working for bug #59274 as 
</I>&gt;<i> well as other Replace testings. However, I'm a little unsure how to 
</I>&gt;<i> test the culture dependancy of Replace(String, String). Considering 
</I>&gt;<i> the IndexOf call should determine the culture as well, it _should_ be 
</I>&gt;<i> ok as far I understand the culture dependancy stuff.
</I>&gt;<i>
</I>&gt;<i> If this looks good, let me know and I'll move on to some other methods 
</I>&gt;<i> (like IndexOf).
</I>&gt;<i>
</I>&gt;<i> -kangaroo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160;
</I>&gt;<i>  !DSPAM:40bbba5f248971207617767!
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: text/enriched
Size: 7361 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20040601/fa8a9815/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20040601/fa8a9815/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006132.html">[Mono-devel-list] [Patch] First patch for making String	managed
</A></li>
	<LI>Next message: <A HREF="006103.html">[Mono-devel-list] String.Replace patch to Managed code.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6102">[ date ]</a>
              <a href="thread.html#6102">[ thread ]</a>
              <a href="subject.html#6102">[ subject ]</a>
              <a href="author.html#6102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
