<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Incorrect interpretation of operator	arguments?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Incorrect%20interpretation%20of%20operator%0A%09arguments%3F&In-Reply-To=40C5EF4F.4090701%40cureos.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006333.html">
   <LINK REL="Next"  HREF="006306.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Incorrect interpretation of operator	arguments?</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Incorrect%20interpretation%20of%20operator%0A%09arguments%3F&In-Reply-To=40C5EF4F.4090701%40cureos.com"
       TITLE="[Mono-devel-list] Incorrect interpretation of operator	arguments?">jonpryor at vt.edu
       </A><BR>
    <I>Tue Jun  8 18:34:52 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006333.html">[Mono-devel-list] Incorrect interpretation of operator      arguments?
</A></li>
        <LI>Next message: <A HREF="006306.html">[Mono-devel-list] RE: Protected message (VIRUS Found)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6320">[ date ]</a>
              <a href="thread.html#6320">[ thread ]</a>
              <a href="subject.html#6320">[ subject ]</a>
              <a href="author.html#6320">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Below...

On Tue, 2004-06-08 at 12:54, Anders Gustafsson wrote:
&gt;<i> This might be a general C# language question; if that is so, I am sorry 
</I>&gt;<i> in beforehand that I have posted the issue in this forum :-)
</I>
It's a C# language question... :-)

&gt;<i> To follow-up on my bug report (#59694, see 
</I>&gt;<i> <A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=59694">http://bugzilla.ximian.com/show_bug.cgi?id=59694</A>), I made a simple test 
</I>&gt;<i> program, TestClass.cs:
</I>&gt;<i> 
</I>&gt;<i> *****
</I>&gt;<i> using System;
</I>&gt;<i> 
</I>&gt;<i> class TestClass
</I>
  ^---  this is your problem, as I explain below. :-)

&lt;snip/&gt;

&gt;<i> Upon compiling (mcs TestClass.cs or gmcs TestClass.cs) and running (mono 
</I>&gt;<i> TestClass.exe) it, I get the following output (Mono 1.0 Beta 2, Fedora 
</I>&gt;<i> Core 2, Linux kernel 2.6.5-1.358):
</I>&gt;<i> 
</I>&gt;<i> ****
</I>&gt;<i> t1 is 30, should be 10
</I>&gt;<i> t2 is 20, should be 20
</I>&gt;<i> t3 is 30, should be 30
</I>&gt;<i> ****
</I>&gt;<i> 
</I>&gt;<i> i.e. t1 is modified in the addition operation t3 = t1 + t2 !
</I>
This is the correct behavior.

&gt;<i> As far as I understand, arguments are passed by value if not explicitly 
</I>&gt;<i> specified otherwise (ref, out; see e.g. ECMA-334 C# Language 
</I>&gt;<i> Specification, secs. 8.3 and 17.5.1). 
</I>
Actually, this is always true, period.  The question is, *what* are you
&quot;always&quot; passing by value?

For value types (ints, enumerations, structures, etc.), you pass the
entire value type by value.  For *everything* *else*, you're passing a
pointer to the actual object.  (Whether this is the &quot;object reference&quot;
or the implicit pointer used for &quot;ref&quot; and &quot;out&quot; doesn't matter; it's
still, ultimately, a pointer.)

The problem is that TestClass is a reference type, not a value type. 
Consequently, you're passing a *reference* (pointer) to the object to
your, so in your operator+ method:

    public static TestClass operator+(TestClass iLhs, TestClass iRhs)
    {
        TestClass ret = iLhs;
        ret.mX = ret.mX + iRhs.mX;
        return ret;
    }

you're actually modifying the existing &quot;iLhs&quot; object, as, again, the
&quot;pass-by-value&quot; is for the object reference, not the object itself.

For the behavior you want, use a struct instead of a class.

To prove this is correct, add the following to the end of Main():

	Console.WriteLine (&quot;&amp;t1 == &amp;t3? {0}, should be False&quot;,
		((object)t1 == (object)t3));

If it prints True (as it does with classes), t1 and t3 refer to the same
object, which is why they both have the same value.  When structures are
used, t1 and t3 are boxed, which is why the equality operator returns
false.

&lt;snip/&gt;

&gt;<i> Now, this problem is not confined to Mono. I have compiled the same 
</I>&gt;<i> source code with Microsoft.NET compiler csc (through Borland C# 
</I>&gt;<i> Builder), and I get the same result as with Mono!
</I>
This should have indicated immediately that things didn't work like you
thought they did. :-)

 - Jon



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006333.html">[Mono-devel-list] Incorrect interpretation of operator      arguments?
</A></li>
	<LI>Next message: <A HREF="006306.html">[Mono-devel-list] RE: Protected message (VIRUS Found)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6320">[ date ]</a>
              <a href="thread.html#6320">[ thread ]</a>
              <a href="subject.html#6320">[ subject ]</a>
              <a href="author.html#6320">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
