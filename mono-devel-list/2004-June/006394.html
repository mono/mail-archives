<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] IKVM show stopper
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20IKVM%20show%20stopper&In-Reply-To=788B535AB1F9CB49BB9C229372B50ACC10CB9C%40LEMBU.sumatrasoftware.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006386.html">
   <LINK REL="Next"  HREF="006392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] IKVM show stopper</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20IKVM%20show%20stopper&In-Reply-To=788B535AB1F9CB49BB9C229372B50ACC10CB9C%40LEMBU.sumatrasoftware.com"
       TITLE="[Mono-devel-list] IKVM show stopper">lupus at ximian.com
       </A><BR>
    <I>Thu Jun 10 14:24:11 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006386.html">[Mono-devel-list] IKVM show stopper
</A></li>
        <LI>Next message: <A HREF="006392.html">[Mono-devel-list] public API adjustment and jay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6394">[ date ]</a>
              <a href="thread.html#6394">[ thread ]</a>
              <a href="subject.html#6394">[ subject ]</a>
              <a href="author.html#6394">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/10/04 Jeroen Frijters wrote:
&gt;<i> To fix an IKVM bug, I had to make a change to how MethodBuilder
</I>&gt;<i> instances are converted into their baked MethodInfo equivalents. This
</I>&gt;<i> exposed a bug in Mono's (0.95) ModuleBuilder.GetMethodToken().
</I>&gt;<i> 
</I>&gt;<i> The attached program demonstrates that ModuleBuilder.GetMethodToken()
</I>&gt;<i> allocates a new token, instead of returning the existing one, when it is
</I>&gt;<i> called with a MethodInfo (instead of a MethodBuilder).
</I>&gt;<i> 
</I>&gt;<i> I think the bug is in mono_image_create_token (reflection.c), as that
</I>&gt;<i> just blindly assigns a new token value when the passed in object is a
</I>&gt;<i> MonoMethod.
</I>
I fixed this for methods and ctors in cvs. Do you need it for fields as
well as all the other tokens?

&gt;<i> Also, if you look at the generated test.dll, you'll see that the actual
</I>&gt;<i> method token is also one off from the one reported by
</I>&gt;<i> MethodBuilder.GetToken().
</I>
Yes. Do you rely on that behaviour? Since it's not possible to guarantee
it in the general case, I avoided the issue. Currently you get the
tokens to match on mono if you create first all the ctors and then all
the methods, because that is the order we emit them in the final binary
(it's easier since we keep separate arrays for ctors and normal methods).
In the general case the tokens won't match, because the methods of a
type need to be contiguous in the PE file, but with reflection you can
create a few mthods for a type, then for another, then for the old one
again and the tokesn are assigned sequentially.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006386.html">[Mono-devel-list] IKVM show stopper
</A></li>
	<LI>Next message: <A HREF="006392.html">[Mono-devel-list] public API adjustment and jay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6394">[ date ]</a>
              <a href="thread.html#6394">[ thread ]</a>
              <a href="subject.html#6394">[ subject ]</a>
              <a href="author.html#6394">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
