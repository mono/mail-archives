<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Embedding API changes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20API%20changes&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006559.html">
   <LINK REL="Next"  HREF="006566.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Embedding API changes</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20API%20changes&In-Reply-To="
       TITLE="[Mono-devel-list] Embedding API changes">lupus at ximian.com
       </A><BR>
    <I>Sat Jun 19 13:47:49 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006559.html">[Mono-devel-list] patch: System.Decimal ctor should be locale-independent
</A></li>
        <LI>Next message: <A HREF="006566.html">[Mono-devel-list] Embedding API changes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6553">[ date ]</a>
              <a href="thread.html#6553">[ thread ]</a>
              <a href="subject.html#6553">[ subject ]</a>
              <a href="author.html#6553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The last few days I cleaned up the headers and the interfaces used
to embed Mono in C applications.
The short term result is that basically all the non trivial
applications will not compile anymore. The good news is that,
once updated, the apps will be source and binary compatible
for the versions of mono that will follow this year and the next.
This will allow us to change some implementation details and lower
the memory usage of some data structures, for example, without 
breaking binary or source compatibility.

Most of the data structures are no more directly accessible, but
you'll need to use function accessors to get at the fields.
Examples include (with their replacement):

	method-&gt;name 		mono_method_get_name (method)
	method-&gt;signature	mono_method_get_signature (method)
	...
	klass-&gt;name 		mono_class_get_name (method)
	klass-&gt;image		mono_class_get_image (method)

etc. You got the idea, it's a pretty straightforward change.
Slightly different are the changes required to iterate over
methods in a class or other metadata elements like that. The old code 
looked like:

	for (i = 0; i &lt; klass-&gt;method.count; ++i) {
		// use klass-&gt;methods [i]
	}

This kind of code will now make use of iterators. An iterator is a
simple gpointer data, initialized to NULL to start at the beginning,
so the code becomes:

	gpointer iter = NULL;
	while ((method = mono_class_get_methods (klass, &amp;iter))) {
		// use method
	}

Note: I haven't yet changed the headers to hide also the structures
MonoType and MonoMethodSignature, but I added already the accessors that
are needed so the code can be changed to not access the structures
directly: please start changing to the new code as those strcutures
will only be available as typedeffed symbols in a few days.

Another data structure that used to be accessed directly was
mono_defaults, to get a MonoClass for some often used classes in corlib:
the code changes in this case are trival:

	mono_defaults.corlib       -&gt; mono_get_corlib ()
	mono_defaults.object_class -&gt; mono_get_object_class ()
	mono_defaults.byte_class   -&gt; mono_get_byte_class ()
	...

I may have missed a few needed accessors or helper methods that could be
useful for embedders: feel free to mail to the list or file bug reports,
so that I can add them before the mono 1.0 release.
People may also want to take a look at the new test in
mono/sameples/embed/test-metadata.c, where simple uses of the new API 
is showed.

Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006559.html">[Mono-devel-list] patch: System.Decimal ctor should be locale-independent
</A></li>
	<LI>Next message: <A HREF="006566.html">[Mono-devel-list] Embedding API changes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6553">[ date ]</a>
              <a href="thread.html#6553">[ thread ]</a>
              <a href="subject.html#6553">[ subject ]</a>
              <a href="author.html#6553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
