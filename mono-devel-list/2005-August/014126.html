<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Need help with signal handlers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20with%20signal%20handlers.&In-Reply-To=1124504559.17765.21.camel%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014115.html">
   <LINK REL="Next"  HREF="014183.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Need help with signal handlers.</H1>
    <B>Mike Hull</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20with%20signal%20handlers.&In-Reply-To=1124504559.17765.21.camel%40localhost.localdomain"
       TITLE="[Mono-dev] Need help with signal handlers.">mike.hull at coversant.net
       </A><BR>
    <I>Sat Aug 20 12:13:02 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014115.html">[Mono-dev] Need help with signal handlers.
</A></li>
        <LI>Next message: <A HREF="014183.html">[Mono-dev] Need help with signal handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14126">[ date ]</a>
              <a href="thread.html#14126">[ thread ]</a>
              <a href="subject.html#14126">[ subject ]</a>
              <a href="author.html#14126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan Pryor wrote:

&gt;<i>On Fri, 2005-08-19 at 15:43 -0700, Mike Hull wrote:
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>I'm trying to pass signals received with signal.h into managed code.  
</I>&gt;&gt;<i>After I mono_runtime_exec_managed_code I can not receive signals using 
</I>&gt;&gt;<i>signal(sig,signal_handler).  If I don't mono_runtime_exec_managed_code I 
</I>&gt;&gt;<i>receive the signals just fine.
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>You're in a world of hurt. :-)
</I>&gt;<i>
</I>&gt;<i>Mono.Posix.Syscall.signal() is horribly, horribly broken.  How broken?
</I>&gt;<i>It takes a raw `int' as the signal number to catch.  You *cannot* use
</I>&gt;<i>Mono.Posix.Signals because those don't match *ANY* operating system's
</I>&gt;<i>values.  Consequently, it's inherently non-portable.
</I>&gt;<i>
</I>&gt;<i>Mono.Unix.Stdlib.signal() is the replacement, but it isn't without the
</I>&gt;<i>next problem.
</I>&gt;<i>
</I>&gt;<i>The larger problem is one of reentrancy: Mono is not reentrant, and
</I>&gt;<i>neither is the P/Invoke layer.
</I>&gt;<i>
</I>&gt;<i>Reentrancy is similar to thread safety, but different: when a signal
</I>&gt;<i>occurs, a (potentially random) process thread is &quot;hijacked&quot;, a new stack
</I>&gt;<i>frame is added (or worse, the current stack frame is re-used), and the
</I>&gt;<i>signal handler is executed.  (Since an existing thread is re-used, and
</I>&gt;<i>probably the most recently executing thread, normal thread-safety tricks
</I>&gt;<i>such as mutexes won't work -- you have to protect against the *same*
</I>&gt;<i>thread re-entering the currently executing function.  Fun.)
</I>&gt;<i>
</I>&gt;<i>The only safe thing you can do is call other reentrant functions, and
</I>&gt;<i>*most* functions are NOT reentrant (malloc(3) isn't, neither is free(2),
</I>&gt;<i>function calls are &quot;iffy&quot; depending on how much stack space you
</I>&gt;<i>have...).
</I>&gt;<i>
</I>&gt;<i>In short, signal handlers are a whole new world of pain.  Managed code
</I>&gt;<i>only makes things worse, since the entire P/Invoke layer isn't
</I>&gt;<i>reentrant, so you risk many unknowns just trying to use a managed
</I>&gt;<i>delegate as a signal handler, never mind doing anything complicated from
</I>&gt;<i>the handler.
</I>&gt;<i>
</I>&gt;<i>Thus, the advice: assuming you risk using a signal handler in managed
</I>&gt;<i>code, all you can do from managed code is modify a variable.  That's it.
</I>&gt;<i>Anything else, *especially* a P/Invoke call, is suspect.
</I>&gt;<i>
</I>&gt;<i>Alternatively, all your signal handlers should be implemented in C.  You
</I>&gt;<i>could hook them up from C#.  If you do this, take care that your handler
</I>&gt;<i>only calls reentrant functions.
</I>&gt;<i>
</I>&gt;<i> - Jon
</I>&gt;<i>
</I>So what if I passed the C program that the C# application is embedded in 
a ManualResetEvent when I want it to initialize the signal handlers?  
Instead of calling a method on the managed object.  Then the thread that 
is waiting on that ManualResetEvent queires a &quot;GetSiganl&quot; InternalCall 
that returns the signal.
-- 
Mike Hull
Coversant, Inc.
<A HREF="http://www.coversant.net">http://www.coversant.net</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014115.html">[Mono-dev] Need help with signal handlers.
</A></li>
	<LI>Next message: <A HREF="014183.html">[Mono-dev] Need help with signal handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14126">[ date ]</a>
              <a href="thread.html#14126">[ thread ]</a>
              <a href="subject.html#14126">[ subject ]</a>
              <a href="author.html#14126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
