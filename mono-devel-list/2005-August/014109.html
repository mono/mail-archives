<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Need help with signal handlers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20with%20signal%20handlers.&In-Reply-To=4306608E.1070801%40coversant.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014107.html">
   <LINK REL="Next"  HREF="014115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Need help with signal handlers.</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Need%20help%20with%20signal%20handlers.&In-Reply-To=4306608E.1070801%40coversant.net"
       TITLE="[Mono-dev] Need help with signal handlers.">jonpryor at vt.edu
       </A><BR>
    <I>Fri Aug 19 22:22:38 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014107.html">[Mono-dev] Need help with signal handlers.
</A></li>
        <LI>Next message: <A HREF="014115.html">[Mono-dev] Need help with signal handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14109">[ date ]</a>
              <a href="thread.html#14109">[ thread ]</a>
              <a href="subject.html#14109">[ subject ]</a>
              <a href="author.html#14109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2005-08-19 at 15:43 -0700, Mike Hull wrote:
&gt;<i> I'm trying to pass signals received with signal.h into managed code.  
</I>&gt;<i> After I mono_runtime_exec_managed_code I can not receive signals using 
</I>&gt;<i> signal(sig,signal_handler).  If I don't mono_runtime_exec_managed_code I 
</I>&gt;<i> receive the signals just fine.
</I>
You're in a world of hurt. :-)

Mono.Posix.Syscall.signal() is horribly, horribly broken.  How broken?
It takes a raw `int' as the signal number to catch.  You *cannot* use
Mono.Posix.Signals because those don't match *ANY* operating system's
values.  Consequently, it's inherently non-portable.

Mono.Unix.Stdlib.signal() is the replacement, but it isn't without the
next problem.

The larger problem is one of reentrancy: Mono is not reentrant, and
neither is the P/Invoke layer.

Reentrancy is similar to thread safety, but different: when a signal
occurs, a (potentially random) process thread is &quot;hijacked&quot;, a new stack
frame is added (or worse, the current stack frame is re-used), and the
signal handler is executed.  (Since an existing thread is re-used, and
probably the most recently executing thread, normal thread-safety tricks
such as mutexes won't work -- you have to protect against the *same*
thread re-entering the currently executing function.  Fun.)

The only safe thing you can do is call other reentrant functions, and
*most* functions are NOT reentrant (malloc(3) isn't, neither is free(2),
function calls are &quot;iffy&quot; depending on how much stack space you
have...).

In short, signal handlers are a whole new world of pain.  Managed code
only makes things worse, since the entire P/Invoke layer isn't
reentrant, so you risk many unknowns just trying to use a managed
delegate as a signal handler, never mind doing anything complicated from
the handler.

Thus, the advice: assuming you risk using a signal handler in managed
code, all you can do from managed code is modify a variable.  That's it.
Anything else, *especially* a P/Invoke call, is suspect.

Alternatively, all your signal handlers should be implemented in C.  You
could hook them up from C#.  If you do this, take care that your handler
only calls reentrant functions.

 - Jon



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014107.html">[Mono-dev] Need help with signal handlers.
</A></li>
	<LI>Next message: <A HREF="014115.html">[Mono-dev] Need help with signal handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14109">[ date ]</a>
              <a href="thread.html#14109">[ thread ]</a>
              <a href="subject.html#14109">[ subject ]</a>
              <a href="author.html#14109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
