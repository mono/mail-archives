<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mcs patch for default encoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20for%20default%20encoding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014251.html">
   <LINK REL="Next"  HREF="014165.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mcs patch for default encoding</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20for%20default%20encoding&In-Reply-To="
       TITLE="[Mono-dev] mcs patch for default encoding">kornelpal at hotmail.com
       </A><BR>
    <I>Wed Aug 24 04:14:37 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014251.html">[Mono-dev] mcs patch for default encoding
</A></li>
        <LI>Next message: <A HREF="014165.html">[Mono-dev] Re: [Mono-devel-list] mcs patch for default encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14256">[ date ]</a>
              <a href="thread.html#14256">[ thread ]</a>
              <a href="subject.html#14256">[ subject ]</a>
              <a href="author.html#14256">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Now the patch is well designed as well. I support it.

Korn&#233;l

----- Original Message -----
From: &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;
Cc: &quot;mono-devel mailing list&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;; &quot;Marek
Safar&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">marek.safar at seznam.cz</A>&gt;
Sent: Wednesday, August 24, 2005 5:16 AM
Subject: Re: [Mono-dev] mcs patch for default encoding


&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I attached revised one based on your suggestions ...
</I>&gt;<i>
</I>&gt;&gt;<i> I think /codepage:restore should be named /codepage:default and
</I>&gt;&gt;<i> /codepage:utf8 should be /codepage:utf-8. csc.exe does not support named
</I>&gt;&gt;<i> code pages but this may cause incompatiblity with older mcs version.
</I>&gt;<i>
</I>&gt;<i> ... while I left them as is (needs separate design decision).
</I>&gt;<i>
</I>&gt;&gt;<i> And there is no use to comment out lines in UTF8Encoding. Old version
</I>&gt;&gt;<i> will
</I>&gt;&gt;<i> be available in SVN.
</I>&gt;<i>
</I>&gt;<i> Yeah, it's just for patch readability.
</I>&gt;<i>
</I>&gt;<i> Thanks Korn&#233;l.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> Index: mcs/support.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/support.cs (revision 48738)
</I>&gt;<i> +++ mcs/support.cs (working copy)
</I>&gt;<i> @@ -359,36 +359,8 @@
</I>&gt;<i>  // Let the StreamWriter autodetect the encoder
</I>&gt;<i>  reader.Peek ();
</I>&gt;<i>
</I>&gt;<i> - reader.BaseStream.Position = 0;
</I>&gt;<i>  Encoding enc = reader.CurrentEncoding;
</I>&gt;<i> - // First of all, get at least a char
</I>&gt;<i> -
</I>&gt;<i> - byte[] auxb = new byte [50];
</I>&gt;<i> - int num_bytes = 0;
</I>&gt;<i> - int num_chars = 0;
</I>&gt;<i> - int br = 0;
</I>&gt;<i> - do {
</I>&gt;<i> - br = reader.BaseStream.Read (auxb, num_bytes, auxb.Length - num_bytes);
</I>&gt;<i> - num_bytes += br;
</I>&gt;<i> - num_chars = enc.GetCharCount (auxb, 0, num_bytes);
</I>&gt;<i> - }
</I>&gt;<i> - while (num_chars == 0 &amp;&amp; br &gt; 0);
</I>&gt;<i> -
</I>&gt;<i> - if (num_chars != 0)
</I>&gt;<i> - {
</I>&gt;<i> - // Now, check which bytes at the beginning have no effect in the
</I>&gt;<i> - // char count
</I>&gt;<i> -
</I>&gt;<i> - int p = 0;
</I>&gt;<i> - while (enc.GetCharCount (auxb, p, num_bytes-p) &gt;= num_chars)
</I>&gt;<i> - p++;
</I>&gt;<i> -
</I>&gt;<i> - preamble_size = p - 1;
</I>&gt;<i> - reader.BaseStream.Position = 0;
</I>&gt;<i> - reader.DiscardBufferedData ();
</I>&gt;<i> -
</I>&gt;<i> - buffer_start = preamble_size;
</I>&gt;<i> - }
</I>&gt;<i> + preamble_size = (int) reader.BaseStream.Position;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  public SeekableStreamReader (Stream stream, Encoding encoding, bool
</I>&gt;<i> detect_encoding_from_bytemarks)
</I>&gt;<i> Index: mcs/driver.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mcs/driver.cs (revision 48738)
</I>&gt;<i> +++ mcs/driver.cs (working copy)
</I>&gt;<i> @@ -91,16 +91,11 @@
</I>&gt;<i>  static DateTime last_time, first_time;
</I>&gt;<i>
</I>&gt;<i>  //
</I>&gt;<i> - // Encoding: ISO-Latin1 is 28591
</I>&gt;<i> + // Encoding.
</I>&gt;<i>  //
</I>&gt;<i>  static Encoding encoding;
</I>&gt;<i>
</I>&gt;<i> - //
</I>&gt;<i> - // Whether the user has specified a different encoder manually
</I>&gt;<i> - //
</I>&gt;<i> - static bool using_default_encoder = true;
</I>&gt;<i>
</I>&gt;<i> -
</I>&gt;<i>  static public void Reset ()
</I>&gt;<i>  {
</I>&gt;<i>  want_debugging_support = false;
</I>&gt;<i> @@ -114,7 +109,6 @@
</I>&gt;<i>  defines = null;
</I>&gt;<i>  output_file = null;
</I>&gt;<i>  encoding = null;
</I>&gt;<i> - using_default_encoder = true;
</I>&gt;<i>  first_source = null;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> @@ -158,7 +152,7 @@
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  using (input){
</I>&gt;<i> - SeekableStreamReader reader = new SeekableStreamReader (input, encoding,
</I>&gt;<i> using_default_encoder);
</I>&gt;<i> + SeekableStreamReader reader = new SeekableStreamReader (input, encoding,
</I>&gt;<i> true);
</I>&gt;<i>  Tokenizer lexer = new Tokenizer (reader, file, defines);
</I>&gt;<i>  int token, tokens = 0, errors = 0;
</I>&gt;<i>
</I>&gt;<i> @@ -186,7 +180,7 @@
</I>&gt;<i>  return;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> - SeekableStreamReader reader = new SeekableStreamReader (input, encoding,
</I>&gt;<i> using_default_encoder);
</I>&gt;<i> + SeekableStreamReader reader = new SeekableStreamReader (input, encoding,
</I>&gt;<i> true);
</I>&gt;<i>
</I>&gt;<i>  // Check 'MZ' header
</I>&gt;<i>  if (reader.Read () == 77 &amp;&amp; reader.Read () == 90) {
</I>&gt;<i> @@ -1304,28 +1298,22 @@
</I>&gt;<i>  return true;
</I>&gt;<i>
</I>&gt;<i>  case &quot;/codepage&quot;:
</I>&gt;<i> - int cp = -1;
</I>&gt;<i> -
</I>&gt;<i> - if (value == &quot;utf8&quot;){
</I>&gt;<i> + switch (value) {
</I>&gt;<i> + case &quot;utf8&quot;:
</I>&gt;<i>  encoding = new UTF8Encoding();
</I>&gt;<i> - using_default_encoder = false;
</I>&gt;<i> - return true;
</I>&gt;<i> + break;
</I>&gt;<i> + case &quot;reset&quot;:
</I>&gt;<i> + encoding = Encoding.Default;
</I>&gt;<i> + break;
</I>&gt;<i> + default:
</I>&gt;<i> + try {
</I>&gt;<i> + encoding = Encoding.GetEncoding (
</I>&gt;<i> + Int32.Parse (value));
</I>&gt;<i> + } catch {
</I>&gt;<i> + Report.Error (2016, &quot;Code page `{0}' is invalid or not installed&quot;,
</I>&gt;<i> value);
</I>&gt;<i> + }
</I>&gt;<i> + break;
</I>&gt;<i>  }
</I>&gt;<i> - if (value == &quot;reset&quot;){
</I>&gt;<i> - //
</I>&gt;<i> - // 28591 is the code page for ISO-8859-1 encoding.
</I>&gt;<i> - //
</I>&gt;<i> - cp = 28591;
</I>&gt;<i> - using_default_encoder = true;
</I>&gt;<i> - }
</I>&gt;<i> -
</I>&gt;<i> - try {
</I>&gt;<i> - cp = Int32.Parse (value);
</I>&gt;<i> - encoding = Encoding.GetEncoding (cp);
</I>&gt;<i> - using_default_encoder = false;
</I>&gt;<i> - } catch {
</I>&gt;<i> - Report.Error (2016, &quot;Code page `{0}' is invalid or not installed&quot;,
</I>&gt;<i> value);
</I>&gt;<i> - }
</I>&gt;<i>  return true;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> @@ -1373,13 +1361,8 @@
</I>&gt;<i>  int i;
</I>&gt;<i>  bool parsing_options = true;
</I>&gt;<i>
</I>&gt;<i> - try {
</I>&gt;<i> - encoding = Encoding.GetEncoding (28591);
</I>&gt;<i> - } catch {
</I>&gt;<i> - Console.WriteLine (&quot;Error: could not load encoding 28591, trying 1252&quot;);
</I>&gt;<i> - encoding = Encoding.GetEncoding (1252);
</I>&gt;<i> - }
</I>&gt;<i> -
</I>&gt;<i> + encoding = Encoding.Default;
</I>&gt;<i> +
</I>&gt;<i>  references = new ArrayList ();
</I>&gt;<i>  soft_references = new ArrayList ();
</I>&gt;<i>  modules = new ArrayList ();
</I>&gt;<i> Index: class/corlib/System.Text/UTF8Encoding.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- class/corlib/System.Text/UTF8Encoding.cs (revision 48738)
</I>&gt;<i> +++ class/corlib/System.Text/UTF8Encoding.cs (working copy)
</I>&gt;<i> @@ -426,33 +426,31 @@
</I>&gt;<i>  if (++leftSoFar &gt;= leftSize) {
</I>&gt;<i>  // We have a complete character now.
</I>&gt;<i>  if (leftBits &lt; (uint)0x10000) {
</I>&gt;<i> - if (leftBits != (uint)0xFEFF) {
</I>&gt;<i> - // is it an overlong ?
</I>&gt;<i> - bool overlong = false;
</I>&gt;<i> - switch (leftSize) {
</I>&gt;<i> - case 2:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x7F);
</I>&gt;<i> - break;
</I>&gt;<i> - case 3:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x07FF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 4:
</I>&gt;<i> - overlong = (leftBits &lt;= 0xFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 5:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x1FFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 6:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x03FFFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> - }
</I>&gt;<i> - if (overlong) {
</I>&gt;<i> - if (throwOnInvalid)
</I>&gt;<i> - throw new ArgumentException (_(&quot;Overlong&quot;), leftBits.ToString ());
</I>&gt;<i> - }
</I>&gt;<i> - else
</I>&gt;<i> - ++length;
</I>&gt;<i> + // is it an overlong ?
</I>&gt;<i> + bool overlong = false;
</I>&gt;<i> + switch (leftSize) {
</I>&gt;<i> + case 2:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x7F);
</I>&gt;<i> + break;
</I>&gt;<i> + case 3:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x07FF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 4:
</I>&gt;<i> + overlong = (leftBits &lt;= 0xFFFF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 5:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x1FFFFF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 6:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x03FFFFFF);
</I>&gt;<i> + break;
</I>&gt;<i>  }
</I>&gt;<i> + if (overlong) {
</I>&gt;<i> + if (throwOnInvalid)
</I>&gt;<i> + throw new ArgumentException (_(&quot;Overlong&quot;), leftBits.ToString ());
</I>&gt;<i> + }
</I>&gt;<i> + else
</I>&gt;<i> + ++length;
</I>&gt;<i>  } else if (leftBits &lt; (uint)0x110000) {
</I>&gt;<i>  length += 2;
</I>&gt;<i>  } else if (throwOnInvalid) {
</I>&gt;<i> @@ -571,37 +569,35 @@
</I>&gt;<i>  if (++leftSoFar &gt;= leftSize) {
</I>&gt;<i>  // We have a complete character now.
</I>&gt;<i>  if (leftBits &lt; (uint)0x10000) {
</I>&gt;<i> - if (leftBits != (uint)0xFEFF) {
</I>&gt;<i> - // is it an overlong ?
</I>&gt;<i> - bool overlong = false;
</I>&gt;<i> - switch (leftSize) {
</I>&gt;<i> - case 2:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x7F);
</I>&gt;<i> - break;
</I>&gt;<i> - case 3:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x07FF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 4:
</I>&gt;<i> - overlong = (leftBits &lt;= 0xFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 5:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x1FFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> - case 6:
</I>&gt;<i> - overlong = (leftBits &lt;= 0x03FFFFFF);
</I>&gt;<i> - break;
</I>&gt;<i> + // is it an overlong ?
</I>&gt;<i> + bool overlong = false;
</I>&gt;<i> + switch (leftSize) {
</I>&gt;<i> + case 2:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x7F);
</I>&gt;<i> + break;
</I>&gt;<i> + case 3:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x07FF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 4:
</I>&gt;<i> + overlong = (leftBits &lt;= 0xFFFF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 5:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x1FFFFF);
</I>&gt;<i> + break;
</I>&gt;<i> + case 6:
</I>&gt;<i> + overlong = (leftBits &lt;= 0x03FFFFFF);
</I>&gt;<i> + break;
</I>&gt;<i> + }
</I>&gt;<i> + if (overlong) {
</I>&gt;<i> + if (throwOnInvalid)
</I>&gt;<i> + throw new ArgumentException (_(&quot;Overlong&quot;), leftBits.ToString ());
</I>&gt;<i> + }
</I>&gt;<i> + else {
</I>&gt;<i> + if (posn &gt;= length) {
</I>&gt;<i> + throw new ArgumentException
</I>&gt;<i> + (_(&quot;Arg_InsufficientSpace&quot;), &quot;chars&quot;);
</I>&gt;<i>  }
</I>&gt;<i> - if (overlong) {
</I>&gt;<i> - if (throwOnInvalid)
</I>&gt;<i> - throw new ArgumentException (_(&quot;Overlong&quot;), leftBits.ToString ());
</I>&gt;<i> - }
</I>&gt;<i> - else {
</I>&gt;<i> - if (posn &gt;= length) {
</I>&gt;<i> - throw new ArgumentException
</I>&gt;<i> - (_(&quot;Arg_InsufficientSpace&quot;), &quot;chars&quot;);
</I>&gt;<i> - }
</I>&gt;<i> - chars[posn++] = (char)leftBits;
</I>&gt;<i> - }
</I>&gt;<i> + chars[posn++] = (char)leftBits;
</I>&gt;<i>  }
</I>&gt;<i>  } else if (leftBits &lt; (uint)0x110000) {
</I>&gt;<i>  if ((posn + 2) &gt; length) {
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014251.html">[Mono-dev] mcs patch for default encoding
</A></li>
	<LI>Next message: <A HREF="014165.html">[Mono-dev] Re: [Mono-devel-list] mcs patch for default encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14256">[ date ]</a>
              <a href="thread.html#14256">[ thread ]</a>
              <a href="subject.html#14256">[ subject ]</a>
              <a href="author.html#14256">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
