<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mcs patch to say goodbye to SeekableStreamReader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20to%20say%20goodbye%20to%20SeekableStreamReader&In-Reply-To=1125408713.7610.16.camel%40linux.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014401.html">
   <LINK REL="Next"  HREF="014421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mcs patch to say goodbye to SeekableStreamReader</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20to%20say%20goodbye%20to%20SeekableStreamReader&In-Reply-To=1125408713.7610.16.camel%40linux.site"
       TITLE="[Mono-dev] mcs patch to say goodbye to SeekableStreamReader">atsushi at ximian.com
       </A><BR>
    <I>Wed Aug 31 00:04:37 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014401.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
        <LI>Next message: <A HREF="014421.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14419">[ date ]</a>
              <a href="thread.html#14419">[ thread ]</a>
              <a href="subject.html#14419">[ subject ]</a>
              <a href="author.html#14419">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Thanks to Korn&#233;l's msg I noticed that I shouldn't reset cached token
on identifier &quot;partial&quot;. Thus I created fixed patch.

&gt;&gt;<i> Now I blame SeekableStreamReader on bringing UTF8 related bug
</I>&gt;&gt;<i> (without proof ;-) so I made a patch to eliminate this class.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Additionally I made tiny modification for 'MZ' executable check
</I>&gt;&gt;<i> (even with a test case bom-mz.cs that differentiates csc and mcs).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm not sure if it really is the culprit, but now we don't have
</I>&gt;&gt;<i> tricky stream usage, so now the code should be a bit healthy.
</I>&gt;<i> 
</I>&gt;<i> In general adding more tests to the xtoken() routine hurts performance,
</I>&gt;<i> that is why we have avoided it.  I also believe that the new code is a
</I>&gt;<i> bit more difficult to follow: just how many saved variables are we going
</I>&gt;<i> to have?
</I>
I agree that xtoken() could be performance sensitive, but on the
other hand, current code moves back the stream, which results in
extraneous parse on every parenthesized expressions. Actually
as mentioned later, the patched code seems faster. Note that
SeekableStreamReader has to call encoding GetCharCount() when
we reposition the stream.

For complexity, SeekableStreamReader is much more difficult to
debug; it requires us to debug not only tokenizer but also
Stream repositioning, Encoding conversion sanity, relationship
between Stream repositioning and conversion in-process bytes
(incomplete blocks).

I needed to introduce just one cached token and one boolean flag
to support putback from parser (the latter one is required because
there could be another putback_char).

&gt;<i> Before we can do something about this, I would like two tests to be
</I>&gt;<i> done:
</I>&gt;<i> 
</I>&gt;<i> 	time mcs --parse sourcefiles
</I>&gt;<i> 
</I>&gt;<i> Where sourcefiles means a lot of source code, measure before and after.
</I>&gt;<i> 
</I>&gt;<i> Then we should measure the impact of the allocation of SavedToken with
</I>&gt;<i> mono --profile before and after.
</I>
Actually the resulting performance is better than existing code:

existing code at *best*:
real    0m2.711s
user    0m0.080s
sys     0m0.050s

Total memory allocated: 34835 KB

patched code at *worst*:
real    0m2.635s
user    0m0.020s
sys     0m0.030s
Total memory allocated: 34083 KB

Most of the memory consumption difference comes from
SeekableStreamReader:

########################
     731 KB Mono.CSharp.SeekableStreamReader::.ctor(StreamReader)
         731 KB      363 System.Char[]
  Callers (with count) that contribute at least for 1%:
         363  100 % Mono.CSharp.SeekableStreamReader::.ctor(Stream,Encoding)

Atsushi Eno
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: goodbye-seekablestreamreader.patch
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050831/f0c36db4/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050831/f0c36db4/attachment.pl</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014401.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
	<LI>Next message: <A HREF="014421.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14419">[ date ]</a>
              <a href="thread.html#14419">[ thread ]</a>
              <a href="subject.html#14419">[ subject ]</a>
              <a href="author.html#14419">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
