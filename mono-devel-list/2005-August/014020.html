<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] patches for RegionInfo support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To=20050816132914.GS4118%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014010.html">
   <LINK REL="Next"  HREF="014021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] patches for RegionInfo support</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To=20050816132914.GS4118%40debian.org"
       TITLE="[Mono-dev] patches for RegionInfo support">atsushi at ximian.com
       </A><BR>
    <I>Tue Aug 16 21:34:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014010.html">[Mono-dev] patches for RegionInfo support
</A></li>
        <LI>Next message: <A HREF="014021.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14020">[ date ]</a>
              <a href="thread.html#14020">[ thread ]</a>
              <a href="subject.html#14020">[ subject ]</a>
              <a href="author.html#14020">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Paolo Molaro wrote:
&gt;<i> On 08/16/05 Atsushi Eno wrote:
</I>&gt;&gt;&gt;&gt;<i> +typedef struct {
</I>&gt;&gt;&gt;&gt;<i> +	const stridx_t name;
</I>&gt;&gt;&gt;&gt;<i> +	gint16 region_entry_index;
</I>&gt;&gt;&gt;&gt;<i> +} RegionInfoNameEntry;
</I>&gt;&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;&gt;<i> +typedef struct {
</I>&gt;&gt;&gt;&gt;<i> +	gint16 lcid;
</I>&gt;&gt;&gt;&gt;<i> +	gint16 region_entry_index;
</I>&gt;&gt;&gt;<i> It likely makes sense to put region_entry_index inside CultureInfoNameEntry
</I>&gt;&gt;&gt;<i> instead of having a separate lookup array.
</I>&gt;&gt;<i> Mmm, I need clarification here: do you mean, RegionInfoNameEntry
</I>&gt;&gt;<i> could be just replaced by CultureNameInfoEntry ? Then I think yes,
</I>&gt;&gt;<i> I just created it because of its name nature.
</I>&gt;&gt;<i> If you mean having region_entry_index as a member of
</I>&gt;&gt;<i> CultureInfoNameEntry, it is waste of memory, though it is tiny.
</I>&gt;&gt;<i> If you mean unifying region name index array into culture name index
</I>&gt;&gt;<i> array, then the code could be the same, but it is extra cost of
</I>&gt;&gt;<i> lookup, though the cost is tiny here too.
</I>&gt;&gt;<i> Any of the above fixes are of course ok for me.
</I>&gt;<i> 
</I>&gt;<i> I meant in the last structure quoted, RegionLCIDMap. It seems to map
</I>&gt;<i> from a locale id to a region index. If you include the region index into
</I>&gt;<i> the CultureInfoEntry you save the duplicated lcid fields.
</I>
Ah, ok that seems much better :-)

&gt;&gt;&gt;<i> This looks wrong: CurrentRegion sounds like a per-thread value and you're 
</I>&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;<i> a static var which is per-domain. Also, even if using a simple static var 
</I>&gt;&gt;&gt;<i> is
</I>&gt;&gt;&gt;<i> the right thing, the lock is not needed: the worse that can happe is
</I>&gt;&gt;&gt;<i> that we create two identical objects and one gets collected by the GC.
</I>&gt;&gt;<i> I also guessed so at first, but there seems no CurrentRegion inside
</I>&gt;&gt;<i> a thread unlike CurrentCulture.
</I>&gt;<i> 
</I>&gt;<i> Not sure what you mean: the MS documentation is very confused as usual,
</I>&gt;<i> but it mentions it's per thread.
</I>
Oh. Hmm, I meant there is no Thread member that is related to
RegionInfo thus I thought it would be domain specific, and
CurrentRegion is not related to CurrentCulture (changing this
property does not affect on RegionInfo.CurrentRegion value).

For now I'll make change on Thread.cs and RegionInfo.cs so that
every thread will create CurrentRegion on demand as we do the
same for CurrentCulture.

&gt;&gt;<i> Based on the assumption that CurrentRegion is instantiated per-domain,
</I>&gt;&gt;<i> I'm not understanding that one is likely to be collected by the GC
</I>&gt;&gt;<i> (well, one could be collected in another domain, but it does not
</I>&gt;&gt;<i> sound problematic). I think that without the lock CurrentRegion could
</I>&gt;&gt;<i> be different instance in the same domain in a race condition.
</I>&gt;<i> 
</I>&gt;<i> If you hit the race, the worse that can happen is that two equivalent region
</I>&gt;<i> objects are created and they are both stored in the static var: the last
</I>&gt;<i> one will be kept alive and the first one will be collected by the GC.
</I>&gt;<i> So there is no issue that needs locking here, IMHO.
</I>
Agreed. I remember that such code that compares CultureInfo instances
could behave unexpectedly (same culture in different instances),
so the same rule would apply to RegionInfo.

Atsushi Eno

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014010.html">[Mono-dev] patches for RegionInfo support
</A></li>
	<LI>Next message: <A HREF="014021.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14020">[ date ]</a>
              <a href="thread.html#14020">[ thread ]</a>
              <a href="subject.html#14020">[ subject ]</a>
              <a href="author.html#14020">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
