<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] patches for RegionInfo support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014153.html">
   <LINK REL="Next"  HREF="014184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] patches for RegionInfo support</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To="
       TITLE="[Mono-dev] patches for RegionInfo support">kornelpal at hotmail.com
       </A><BR>
    <I>Mon Aug 22 05:36:49 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014153.html">[Mono-dev] patches for RegionInfo support
</A></li>
        <LI>Next message: <A HREF="014184.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14174">[ date ]</a>
              <a href="thread.html#14174">[ thread ]</a>
              <a href="subject.html#14174">[ subject ]</a>
              <a href="author.html#14174">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

You are misinterpreting CurrentRegion.
CurrentRegion is no way related to CurrentCulture.

RegionInfo.CurrentRegion:
<A HREF="http://msdn2.microsoft.com/library/7kcxkdc9(en-us,vs.80">http://msdn2.microsoft.com/library/7kcxkdc9(en-us,vs.80</A>).aspx

The documentation describes the actual behaviour of CurrentRegion (I have
done some tests):

The value is AppDomain scoped (in other words stored in a static filed). A
single instance is constructed at the first call to CurrentRegion then a
cached value is retruned. On Windows this is based on the value selected in
&quot;Regional and Language Options&quot;. This is per-user setting on Windows and can
be retrieved using GetUserDefaultLCID. You can change however this setting
(on Windows) without rebooting so the value may change. But it will have no
effect to CurrentRegion if it's already cached unless you call
CultureInfo.ClearCachedData.

And CurrentRegion is read-only.

CultureInfo.ClearCachedData:
<A HREF="http://msdn2.microsoft.com/library/65x0h0wh(en-us,vs.80">http://msdn2.microsoft.com/library/65x0h0wh(en-us,vs.80</A>).aspx:

It simply clears (or reinitializes) the cached values of
CultureInfo.CurrentCulture, CultureInfo.CurrentUICulture,
RegionInfo.CurrentRegion and TimeZone.CurrentTimeZone.

Note that TimeZone.CurrentTimeZone reset is not documented but is can simply
tested by changing time zone in Control Panel the calling
CultureInfo.ClearCachedData. CurrentTimeZone is cached just like
CurrentRegion and can be changed without restart as well.

CultureInfo.CurrentCulture and CultureInfo.CurrentUICulture are not changed
on existing threads (documented and I tested as well) but the updated values
will be used for new threads. This reveals that MS.NET is caching the
default values (as they know how Windows select default thread locale:) and
associates them to new threads rather than using GetThreadLocale for example
on new threads.

As such CultureInfo.ClearCachedData seems to deal only with static fields
but it is an instance method.:)

At the beginning I said that &quot;CurrentRegion is no way related to
CurrentCulture.&quot;. This is true but I don't know other OS' internals
regarding RegionInfo so using CultureInfo may be required but CurrentRegion
is an AppDomain scope cached value that will be refreshed only when calling
ClearCachedData. So CurrentCulture should not be used as it can be changed
but the default value for CurrentCulture can be used if it's required.

Korn&#233;l

----- Original Message -----
From: &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, August 22, 2005 3:42 AM
Subject: Re: [Mono-dev] patches for RegionInfo support


&gt;<i> Oops, the corlib patch was wrong. Reattached ones should work fine.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno wrote:
</I>&gt;&gt;<i> Hola,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Paolo Molaro wrote:
</I>&gt;&gt;&gt;<i> On 08/17/05 Atsushi Eno wrote:
</I>&gt;&gt;&gt;&gt;<i> I mostly copied those icall code from CurrentCulture support,
</I>&gt;&gt;&gt;&gt;<i> but one thing I don't understand is NUM_CACHED_CULTURES ... why
</I>&gt;&gt;&gt;&gt;<i> it is set as 4? Is it safe to guess NUM_CACHED_REGIONS 4 as well?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I would store a single copy, ie not an array of objects, since nobody
</I>&gt;&gt;&gt;<i> uses this stuff.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yeah, agreed.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> +        static object region_lock = new object ();
</I>&gt;&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;&gt;<i> +        internal RegionInfo CurrentRegion {
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Make this static so it can be called only on the current thread and
</I>&gt;&gt;&gt;<i> remove the locking.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Am mazed... is there any reason that RegionInfo is different from
</I>&gt;&gt;<i> CultureInfo here (other than that CurrentCulture is exposed as
</I>&gt;&gt;<i> nonstatic)?  Anyways I attached the patch that fixes above.
</I>&gt;&gt;<i> If there seems no further problem, I'll commit it later.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> Index: threads.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- threads.c (revision 48630)
</I>&gt;<i> +++ threads.c (working copy)
</I>&gt;<i> @@ -823,6 +823,43 @@
</I>&gt;<i>  mono_monitor_exit (this-&gt;synch_lock);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> +MonoObject*
</I>&gt;<i> +ves_icall_System_Threading_Thread_GetCachedCurrentRegion (MonoThread
</I>&gt;<i> *this)
</I>&gt;<i> +{
</I>&gt;<i> + MonoObject *res;
</I>&gt;<i> + MonoDomain *domain;
</I>&gt;<i> + int i;
</I>&gt;<i> +
</I>&gt;<i> + /* No need to lock here */
</I>&gt;<i> + if (this-&gt;region_info) {
</I>&gt;<i> + domain = mono_domain_get ();
</I>&gt;<i> + res = this-&gt;region_info;
</I>&gt;<i> + if (res &amp;&amp; res-&gt;vtable-&gt;domain == domain)
</I>&gt;<i> + return res;
</I>&gt;<i> + }
</I>&gt;<i> +
</I>&gt;<i> + return NULL;
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> +void
</I>&gt;<i> +ves_icall_System_Threading_Thread_SetCachedCurrentRegion (MonoThread
</I>&gt;<i> *this, MonoObject *region)
</I>&gt;<i> +{
</I>&gt;<i> + int i;
</I>&gt;<i> + MonoDomain *domain = mono_domain_get ();
</I>&gt;<i> +
</I>&gt;<i> + mono_monitor_enter (this-&gt;synch_lock);
</I>&gt;<i> +
</I>&gt;<i> + if (this-&gt;region_info) {
</I>&gt;<i> + if (this-&gt;region_info-&gt;vtable-&gt;domain == domain)
</I>&gt;<i> + /* Replace */
</I>&gt;<i> + this-&gt;region_info = region;
</I>&gt;<i> + }
</I>&gt;<i> + else
</I>&gt;<i> + /* Free entry */
</I>&gt;<i> + this-&gt;region_info = region;
</I>&gt;<i> + mono_monitor_exit (this-&gt;synch_lock);
</I>&gt;<i> +}
</I>&gt;<i> +
</I>&gt;<i> /* the jit may read the compiled code of this function */
</I>&gt;<i> MonoThread *
</I>&gt;<i> mono_thread_current (void)
</I>&gt;<i> Index: object-internals.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- object-internals.h (revision 48630)
</I>&gt;<i> +++ object-internals.h (working copy)
</I>&gt;<i> @@ -223,6 +223,7 @@
</I>&gt;<i>  HANDLE     handle;
</I>&gt;<i>  MonoObject **culture_info;
</I>&gt;<i>  MonoObject **ui_culture_info;
</I>&gt;<i> + MonoObject *region_info;
</I>&gt;<i>  MonoBoolean threadpool_thread;
</I>&gt;<i>  gunichar2  *name;
</I>&gt;<i>  guint32     name_len;
</I>&gt;<i> Index: threads-types.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- threads-types.h (revision 48630)
</I>&gt;<i> +++ threads-types.h (working copy)
</I>&gt;<i> @@ -48,6 +48,8 @@
</I>&gt;<i> extern MonoArray*
</I>&gt;<i> ves_icall_System_Threading_Thread_GetSerializedCurrentUICulture
</I>&gt;<i> (MonoThread *this_obj);
</I>&gt;<i> extern void ves_icall_System_Threading_Thread_SetCachedCurrentUICulture
</I>&gt;<i> (MonoThread *this_obj, MonoObject *culture);
</I>&gt;<i> void ves_icall_System_Threading_Thread_SetSerializedCurrentUICulture
</I>&gt;<i> (MonoThread *this_obj, MonoArray *arr);
</I>&gt;<i> +extern MonoObject*
</I>&gt;<i> ves_icall_System_Threading_Thread_GetCachedCurrentRegion (MonoThread
</I>&gt;<i> *this_obj);
</I>&gt;<i> +extern void ves_icall_System_Threading_Thread_SetCachedCurrentRegion
</I>&gt;<i> (MonoThread *this_obj, MonoObject *culture);
</I>&gt;<i> extern HANDLE
</I>&gt;<i> ves_icall_System_Threading_Mutex_CreateMutex_internal(MonoBoolean owned,
</I>&gt;<i> MonoString *name, MonoBoolean *created);
</I>&gt;<i> extern void ves_icall_System_Threading_Mutex_ReleaseMutex_internal (HANDLE
</I>&gt;<i> handle );
</I>&gt;<i> extern HANDLE ves_icall_System_Threading_Events_CreateEvent_internal
</I>&gt;<i> (MonoBoolean manual, MonoBoolean initial, MonoString *name);
</I>&gt;<i> Index: icall.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- icall.c (revision 48630)
</I>&gt;<i> +++ icall.c (working copy)
</I>&gt;<i> @@ -6884,6 +6884,7 @@
</I>&gt;<i>  {&quot;ClrState&quot;, ves_icall_System_Threading_Thread_ClrState},
</I>&gt;<i>  {&quot;CurrentThread_internal&quot;, mono_thread_current},
</I>&gt;<i>  {&quot;GetCachedCurrentCulture&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_GetCachedCurrentCulture},
</I>&gt;<i> + {&quot;GetCachedCurrentRegion&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_GetCachedCurrentRegion},
</I>&gt;<i>  {&quot;GetCachedCurrentUICulture&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_GetCachedCurrentUICulture},
</I>&gt;<i>  {&quot;GetDomainID&quot;, ves_icall_System_Threading_Thread_GetDomainID},
</I>&gt;<i>  {&quot;GetName_internal&quot;, ves_icall_System_Threading_Thread_GetName_internal},
</I>&gt;<i> @@ -6894,6 +6895,7 @@
</I>&gt;<i>  {&quot;ResetAbort_internal()&quot;, ves_icall_System_Threading_Thread_ResetAbort},
</I>&gt;<i>  {&quot;Resume_internal()&quot;, ves_icall_System_Threading_Thread_Resume},
</I>&gt;<i>  {&quot;SetCachedCurrentCulture&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_SetCachedCurrentCulture},
</I>&gt;<i> + {&quot;SetCachedCurrentRegion&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_SetCachedCurrentRegion},
</I>&gt;<i>  {&quot;SetCachedCurrentUICulture&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_SetCachedCurrentUICulture},
</I>&gt;<i>  {&quot;SetName_internal&quot;, ves_icall_System_Threading_Thread_SetName_internal},
</I>&gt;<i>  {&quot;SetSerializedCurrentCulture&quot;,
</I>&gt;<i> ves_icall_System_Threading_Thread_SetSerializedCurrentCulture},
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> Index: System.Globalization/RegionInfo.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- System.Globalization/RegionInfo.cs (revision 48630)
</I>&gt;<i> +++ System.Globalization/RegionInfo.cs (working copy)
</I>&gt;<i> @@ -29,28 +29,17 @@
</I>&gt;<i> //
</I>&gt;<i> using System.Globalization;
</I>&gt;<i> using System.Runtime.CompilerServices;
</I>&gt;<i> +using System.Threading;
</I>&gt;<i>
</I>&gt;<i> namespace System.Globalization
</I>&gt;<i> {
</I>&gt;<i>  [Serializable]
</I>&gt;<i>  public class RegionInfo
</I>&gt;<i>  {
</I>&gt;<i> - static RegionInfo currentRegion;
</I>&gt;<i> -
</I>&gt;<i>  // This property is not synchronized with CurrentCulture, so
</I>&gt;<i>  // we need to use bootstrap CurrentCulture LCID.
</I>&gt;<i>  public static RegionInfo CurrentRegion {
</I>&gt;<i> - get {
</I>&gt;<i> - if (currentRegion == null) {
</I>&gt;<i> - // make sure to fill BootstrapCultureID.
</I>&gt;<i> - CultureInfo ci = CultureInfo.CurrentCulture;
</I>&gt;<i> - // If current culture is invariant then region is not available.
</I>&gt;<i> - if (ci == null || CultureInfo.BootstrapCultureID == 0x7F)
</I>&gt;<i> - return null;
</I>&gt;<i> - currentRegion = new RegionInfo (CultureInfo.BootstrapCultureID);
</I>&gt;<i> - }
</I>&gt;<i> - return currentRegion;
</I>&gt;<i> - }
</I>&gt;<i> + get { return Thread.CurrentRegion; }
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  int regionId;
</I>&gt;<i> Index: System.Threading/Thread.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- System.Threading/Thread.cs (revision 48630)
</I>&gt;<i> +++ System.Threading/Thread.cs (working copy)
</I>&gt;<i> @@ -59,6 +59,7 @@
</I>&gt;<i>
</I>&gt;<i>  private IntPtr culture_info;
</I>&gt;<i>  private IntPtr ui_culture_info;
</I>&gt;<i> + private IntPtr region_info;
</I>&gt;<i>  private bool threadpool_thread;
</I>&gt;<i>  /* accessed only from unmanaged code */
</I>&gt;<i>  private IntPtr name;
</I>&gt;<i> @@ -317,6 +318,9 @@
</I>&gt;<i>  private extern CultureInfo GetCachedCurrentUICulture ();
</I>&gt;<i>
</I>&gt;<i>  [MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i> + private static extern RegionInfo GetCachedCurrentRegion (Thread
</I>&gt;<i> current);
</I>&gt;<i> +
</I>&gt;<i> + [MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i>  private extern byte[] GetSerializedCurrentUICulture ();
</I>&gt;<i>
</I>&gt;<i>  [MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i> @@ -325,6 +329,9 @@
</I>&gt;<i>  [MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i>  private extern void SetSerializedCurrentUICulture (byte[] culture);
</I>&gt;<i>
</I>&gt;<i> + [MethodImplAttribute (MethodImplOptions.InternalCall)]
</I>&gt;<i> + private static extern void SetCachedCurrentRegion (Thread current,
</I>&gt;<i> RegionInfo region);
</I>&gt;<i> +
</I>&gt;<i>  /* If the current_lcid() isn't known by CultureInfo,
</I>&gt;<i>  * it will throw an exception which may cause
</I>&gt;<i>  * String.Concat to try and recursively look up the
</I>&gt;<i> @@ -476,6 +483,23 @@
</I>&gt;<i>  }
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> + internal static RegionInfo CurrentRegion {
</I>&gt;<i> + get {
</I>&gt;<i> + RegionInfo region = GetCachedCurrentRegion (CurrentThread);
</I>&gt;<i> + // unlike CurrentCulture, creating different
</I>&gt;<i> + // instance between AppDomain should be OK.
</I>&gt;<i> + if (region != null)
</I>&gt;<i> + return region;
</I>&gt;<i> +
</I>&gt;<i> + // make sure that CurrentCulture exists.
</I>&gt;<i> + CultureInfo current = CurrentThread.CurrentCulture;
</I>&gt;<i> + region = new RegionInfo (
</I>&gt;<i> + CultureInfo.BootstrapCultureID);
</I>&gt;<i> + SetCachedCurrentRegion (CurrentThread, region);
</I>&gt;<i> + return region;
</I>&gt;<i> + }
</I>&gt;<i> + }
</I>&gt;<i> +
</I>&gt;<i>  public bool IsThreadPoolThread {
</I>&gt;<i>  get {
</I>&gt;<i>  return IsThreadPoolThreadInternal;
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014153.html">[Mono-dev] patches for RegionInfo support
</A></li>
	<LI>Next message: <A HREF="014184.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14174">[ date ]</a>
              <a href="thread.html#14174">[ thread ]</a>
              <a href="subject.html#14174">[ subject ]</a>
              <a href="author.html#14174">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
