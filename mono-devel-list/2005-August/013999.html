<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] patches for RegionInfo support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To=20050816085124.GJ4118%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013989.html">
   <LINK REL="Next"  HREF="014010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] patches for RegionInfo support</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20patches%20for%20RegionInfo%20support&In-Reply-To=20050816085124.GJ4118%40debian.org"
       TITLE="[Mono-dev] patches for RegionInfo support">atsushi at ximian.com
       </A><BR>
    <I>Tue Aug 16 06:47:28 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013989.html">[Mono-dev] patches for RegionInfo support
</A></li>
        <LI>Next message: <A HREF="014010.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13999">[ date ]</a>
              <a href="thread.html#13999">[ thread ]</a>
              <a href="subject.html#13999">[ subject ]</a>
              <a href="author.html#13999">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for comments Paolo. Actually I've already checked in them
with Miguel's suggestion, so am on fixing them.

&gt;&gt;<i> +MonoBoolean
</I>&gt;&gt;<i> +ves_icall_System_Globalization_RegionInfo_construct_internal_region_from_name (MonoRegionInfo *this,
</I>&gt;&gt;<i> +		MonoString *name)
</I>&gt;&gt;<i> +{
</I>&gt;&gt;<i> +	const RegionInfoNameEntry *ne;
</I>&gt;&gt;<i> +	char *n;
</I>&gt;&gt;<i> +	
</I>&gt;&gt;<i> +	MONO_ARCH_SAVE_REGS;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	n = mono_string_to_utf8 (name);
</I>&gt;&gt;<i> +	ne = bsearch (n, region_name_entries, NUM_REGION_ENTRIES,
</I>&gt;&gt;<i> +			sizeof (RegionInfoNameEntry), region_name_locator);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +	if (ne == NULL) {
</I>&gt;&gt;<i> +                /*g_print (&quot;ne (%s) is null\n&quot;, n);*/
</I>&gt;&gt;<i> +        	g_free (n);
</I>&gt;&gt;<i> +		return FALSE;
</I>&gt;&gt;<i> +        }
</I>&gt;&gt;<i> +        g_free (n);
</I>&gt;<i> 
</I>&gt;<i> Indentation is wrong here.
</I>
Oops, yes. I'm fixing it, and the original one in CultureInfo stuff.

&gt;&gt;<i> +
</I>&gt;&gt;<i>  #ifdef HAVE_ICU
</I>&gt;<i> 
</I>&gt;<i> Feel free to completely remove the icu stuff with another patch, too;-)
</I>&gt;<i> 
</I>&gt;&gt;<i> Index: culture-info.h
</I>&gt;&gt;<i> ===================================================================
</I>&gt;&gt;<i> --- culture-info.h	(revision 48380)
</I>&gt;&gt;<i> +++ culture-info.h	(working copy)
</I>&gt;&gt;<i> @@ -115,5 +115,28 @@
</I>&gt;&gt;<i>  	gint16 culture_entry_index;
</I>&gt;&gt;<i>  } CultureInfoNameEntry;
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> +typedef struct {
</I>&gt;&gt;<i> +	gint16 region_id;
</I>&gt;&gt;<i> +	/* gint8 measurement_system; // 0:metric 1:US 2:UK */
</I>&gt;&gt;<i> +	/* gint16 geo_id; */
</I>&gt;&gt;<i> +	const stridx_t iso2name;
</I>&gt;&gt;<i> +	const stridx_t iso3name;
</I>&gt;&gt;<i> +	const stridx_t win3name;
</I>&gt;&gt;<i> +	const stridx_t english_name;
</I>&gt;&gt;<i> +	const stridx_t currency_symbol;
</I>&gt;&gt;<i> +	const stridx_t iso_currency_symbol;
</I>&gt;&gt;<i> +	const stridx_t currency_english_name;
</I>&gt;&gt;<i> +} RegionInfoEntry;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +typedef struct {
</I>&gt;&gt;<i> +	const stridx_t name;
</I>&gt;&gt;<i> +	gint16 region_entry_index;
</I>&gt;&gt;<i> +} RegionInfoNameEntry;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +typedef struct {
</I>&gt;&gt;<i> +	gint16 lcid;
</I>&gt;&gt;<i> +	gint16 region_entry_index;
</I>&gt;<i> 
</I>&gt;<i> It likely makes sense to put region_entry_index inside CultureInfoNameEntry
</I>&gt;<i> instead of having a separate lookup array.
</I>
Mmm, I need clarification here: do you mean, RegionInfoNameEntry
could be just replaced by CultureNameInfoEntry ? Then I think yes,
I just created it because of its name nature.
If you mean having region_entry_index as a member of
CultureInfoNameEntry, it is waste of memory, though it is tiny.
If you mean unifying region name index array into culture name index
array, then the code could be the same, but it is extra cost of
lookup, though the cost is tiny here too.
Any of the above fixes are of course ok for me.

&gt;&gt;<i> Index: RegionInfo.cs
</I>&gt;&gt;<i> ===================================================================
</I>&gt;&gt;<i> --- RegionInfo.cs	(revision 48291)
</I>&gt;&gt;<i> +++ RegionInfo.cs	(working copy)
</I>&gt;&gt;<i> @@ -22,10 +22,170 @@
</I>&gt;&gt;<i>  // WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</I>&gt;&gt;<i>  //
</I>&gt;&gt;<i>  using System.Globalization;
</I>&gt;&gt;<i> +using System.Runtime.CompilerServices;
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i>  namespace System.Globalization {
</I>&gt;&gt;<i>  
</I>&gt;&gt;<i> +#if true
</I>&gt;&gt;<i>  	[Serializable]
</I>&gt;&gt;<i> +	public class RegionInfo
</I>&gt;&gt;<i> +	{
</I>&gt;&gt;<i> +		static object forLock = new object ();
</I>&gt;&gt;<i> +		static RegionInfo currentRegion;
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +		// This property is not synchronized with CurrentCulture, so
</I>&gt;&gt;<i> +		// we need to use bootstrap CurrentCulture LCID.
</I>&gt;&gt;<i> +		public static RegionInfo CurrentRegion {
</I>&gt;&gt;<i> +			get {
</I>&gt;&gt;<i> +				if (currentRegion == null) {
</I>&gt;&gt;<i> +					CultureInfo ci = CultureInfo.CurrentCulture;
</I>&gt;&gt;<i> +					// If current culture is invariant then region is not available.
</I>&gt;&gt;<i> +					if (ci == null || CultureInfo.BootstrapCultureID == 0x7F)
</I>&gt;&gt;<i> +						return null;
</I>&gt;&gt;<i> +					lock (forLock) {
</I>&gt;&gt;<i> +						// make sure to fill BootstrapCultureID.
</I>&gt;&gt;<i> +						currentRegion = new RegionInfo (CultureInfo.BootstrapCultureID);
</I>&gt;&gt;<i> +					}
</I>&gt;&gt;<i> +				}
</I>&gt;&gt;<i> +				return currentRegion;
</I>&gt;&gt;<i> +			}
</I>&gt;&gt;<i> +		}
</I>&gt;<i> 
</I>&gt;<i> This looks wrong: CurrentRegion sounds like a per-thread value and you're using
</I>&gt;<i> a static var which is per-domain. Also, even if using a simple static var is
</I>&gt;<i> the right thing, the lock is not needed: the worse that can happe is
</I>&gt;<i> that we create two identical objects and one gets collected by the GC.
</I>
I also guessed so at first, but there seems no CurrentRegion inside
a thread unlike CurrentCulture.

Based on the assumption that CurrentRegion is instantiated per-domain,
I'm not understanding that one is likely to be collected by the GC
(well, one could be collected in another domain, but it does not
sound problematic). I think that without the lock CurrentRegion could
be different instance in the same domain in a race condition.

&gt;&gt;<i> +		bool ConstructInternalRegionFromName (string locale)
</I>&gt;&gt;<i> +		{
</I>&gt;&gt;<i> +			if (!construct_internal_region_from_name (locale))
</I>&gt;&gt;<i> +				return false;
</I>&gt;&gt;<i> +			return true;
</I>&gt;&gt;<i> +		}
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> +		bool ConstructInternalRegionFromLcid (int lcid)
</I>&gt;&gt;<i> +		{
</I>&gt;&gt;<i> +			if (!construct_internal_region_from_lcid (lcid))
</I>&gt;&gt;<i> +				return false;
</I>&gt;&gt;<i> +			return true;
</I>&gt;&gt;<i> +		}
</I>&gt;<i> 
</I>&gt;<i> These two wrappers look completely useless.
</I>
Ah, true. I'll replace them with direct invocations.

Atsushi Eno

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013989.html">[Mono-dev] patches for RegionInfo support
</A></li>
	<LI>Next message: <A HREF="014010.html">[Mono-dev] patches for RegionInfo support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13999">[ date ]</a>
              <a href="thread.html#13999">[ thread ]</a>
              <a href="subject.html#13999">[ subject ]</a>
              <a href="author.html#13999">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
