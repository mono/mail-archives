<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mcs patch to say goodbye to SeekableStreamReader
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20to%20say%20goodbye%20to%20SeekableStreamReader&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014423.html">
   <LINK REL="Next"  HREF="014422.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mcs patch to say goodbye to SeekableStreamReader</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mcs%20patch%20to%20say%20goodbye%20to%20SeekableStreamReader&In-Reply-To="
       TITLE="[Mono-dev] mcs patch to say goodbye to SeekableStreamReader">kornelpal at hotmail.com
       </A><BR>
    <I>Tue Aug 30 10:26:58 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="014423.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
        <LI>Next message: <A HREF="014422.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14402">[ date ]</a>
              <a href="thread.html#14402">[ thread ]</a>
              <a href="subject.html#14402">[ subject ]</a>
              <a href="author.html#14402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I tried your patch with ComIStreamMarshaler.cs and used -codepage:65001. It
worked as expected but it fails with SVN head. The expected behaviour is to
compile without errors so you patch solves the bug.

And I agree that SeekableStreamReader is a too tricky solution and seems to
be the cause of the bug. Maybe SeekableStreamReader could be fixed but if
there is no need to use it I think it's better to remove it to avoid
possible bugs.

I've done some tests with files readed as UTF-8 but containing invalid byte
sequences even with BOM and it worked as expected.

If this patch does not cause any regressions I support it.

I think the patch should be ported to gmcs as well.

I think we should return using Encoding.Default as the default encoding in
mcs but should comfigure mcs using -codepage:28591 -codepage:1252 in
mcs/build to use that encoding.

Korn&#233;l

----- Original Message -----
From: &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
To: &quot;mono-devel mailing list&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, August 29, 2005 1:55 PM
Subject: [Mono-dev] mcs patch to say goodbye to SeekableStreamReader


&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Now I blame SeekableStreamReader on bringing UTF8 related bug
</I>&gt;<i> (without proof ;-) so I made a patch to eliminate this class.
</I>&gt;<i>
</I>&gt;<i> Additionally I made tiny modification for 'MZ' executable check
</I>&gt;<i> (even with a test case bom-mz.cs that differentiates csc and mcs).
</I>&gt;<i>
</I>&gt;<i> I'm not sure if it really is the culprit, but now we don't have
</I>&gt;<i> tricky stream usage, so now the code should be a bit healthy.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> Index: support.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- support.cs (revision 49060)
</I>&gt;<i> +++ support.cs (working copy)
</I>&gt;<i> @@ -344,6 +344,7 @@
</I>&gt;<i>  }
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> +/*
</I>&gt;<i>  /// &lt;summary&gt;
</I>&gt;<i>  ///   This is a wrapper around StreamReader which is seekable.
</I>&gt;<i>  /// &lt;/summary&gt;
</I>&gt;<i> @@ -442,6 +443,7 @@
</I>&gt;<i>  return buffer [pos++];
</I>&gt;<i>  }
</I>&gt;<i>  }
</I>&gt;<i> +*/
</I>&gt;<i>
</I>&gt;<i>  public class DoubleHash {
</I>&gt;<i>  const int DEFAULT_INITIAL_BUCKETS = 100;
</I>&gt;<i> Index: cs-tokenizer.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- cs-tokenizer.cs (revision 49060)
</I>&gt;<i> +++ cs-tokenizer.cs (working copy)
</I>&gt;<i> @@ -31,7 +31,7 @@
</I>&gt;<i>
</I>&gt;<i>  public class Tokenizer : yyParser.yyInput
</I>&gt;<i>  {
</I>&gt;<i> - SeekableStreamReader reader;
</I>&gt;<i> + StreamReader reader;
</I>&gt;<i>  SourceFile ref_name;
</I>&gt;<i>  SourceFile file_name;
</I>&gt;<i>  int ref_line = 1;
</I>&gt;<i> @@ -45,6 +45,8 @@
</I>&gt;<i>  Location current_location;
</I>&gt;<i>  Location current_comment_location = Location.Null;
</I>&gt;<i>  ArrayList escapedIdentifiers = new ArrayList ();
</I>&gt;<i> + SavedToken saved_token = SavedToken.Null;
</I>&gt;<i> + bool putback_ambiguous_close_parens = false;
</I>&gt;<i>
</I>&gt;<i>  //
</I>&gt;<i>  // XML documentation buffer. The save point is used to divide
</I>&gt;<i> @@ -385,7 +387,7 @@
</I>&gt;<i>  defines [def] = true;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> - public Tokenizer (SeekableStreamReader input, SourceFile file, ArrayList
</I>&gt;<i> defs)
</I>&gt;<i> + public Tokenizer (StreamReader input, SourceFile file, ArrayList defs)
</I>&gt;<i>  {
</I>&gt;<i>  this.ref_name = file;
</I>&gt;<i>  this.file_name = file;
</I>&gt;<i> @@ -467,19 +469,11 @@
</I>&gt;<i>
</I>&gt;<i>  --deambiguate_close_parens;
</I>&gt;<i>
</I>&gt;<i> - // Save current position and parse next token.
</I>&gt;<i> - int old = reader.Position;
</I>&gt;<i> - int old_ref_line = ref_line;
</I>&gt;<i> - int old_col = col;
</I>&gt;<i> -
</I>&gt;<i> - // disable preprocessing directives when peeking
</I>&gt;<i> - process_directives = false;
</I>&gt;<i> + // Save next token.
</I>&gt;<i> + Location cur_loc = current_location;
</I>&gt;<i>  int new_token = token ();
</I>&gt;<i> - process_directives = true;
</I>&gt;<i> - reader.Position = old;
</I>&gt;<i> - ref_line = old_ref_line;
</I>&gt;<i> - col = old_col;
</I>&gt;<i> - putback_char = -1;
</I>&gt;<i> + saved_token = new SavedToken (new_token, val, Location);
</I>&gt;<i> + current_location = cur_loc;
</I>&gt;<i>
</I>&gt;<i>  if (new_token == Token.OPEN_PARENS)
</I>&gt;<i>  return Token.CLOSE_PARENS_OPEN_PARENS;
</I>&gt;<i> @@ -658,7 +652,7 @@
</I>&gt;<i>
</I>&gt;<i>  public void Deambiguate_CloseParens ()
</I>&gt;<i>  {
</I>&gt;<i> - putback (')');
</I>&gt;<i> + putback_ambiguous_close_parens = true;
</I>&gt;<i>  deambiguate_close_parens++;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> @@ -1087,6 +1081,10 @@
</I>&gt;<i>  int getChar ()
</I>&gt;<i>  {
</I>&gt;<i>  int x;
</I>&gt;<i> + if (putback_ambiguous_close_parens) {
</I>&gt;<i> + putback_ambiguous_close_parens = false;
</I>&gt;<i> + return ')';
</I>&gt;<i> + }
</I>&gt;<i>  if (putback_char != -1) {
</I>&gt;<i>  x = putback_char;
</I>&gt;<i>  putback_char = -1;
</I>&gt;<i> @@ -1106,6 +1104,8 @@
</I>&gt;<i>
</I>&gt;<i>  int peekChar ()
</I>&gt;<i>  {
</I>&gt;<i> + if (putback_ambiguous_close_parens)
</I>&gt;<i> + return ')';
</I>&gt;<i>  if (putback_char != -1)
</I>&gt;<i>  return putback_char;
</I>&gt;<i>  putback_char = reader.Read ();
</I>&gt;<i> @@ -1114,6 +1114,8 @@
</I>&gt;<i>
</I>&gt;<i>  int peekChar2 ()
</I>&gt;<i>  {
</I>&gt;<i> + if (putback_ambiguous_close_parens)
</I>&gt;<i> + return ')';
</I>&gt;<i>  if (putback_char != -1)
</I>&gt;<i>  return putback_char;
</I>&gt;<i>  return reader.Peek ();
</I>&gt;<i> @@ -1202,7 +1204,14 @@
</I>&gt;<i>
</I>&gt;<i>  public int token ()
</I>&gt;<i>                 {
</I>&gt;<i> - current_token = xtoken ();
</I>&gt;<i> + if (!saved_token.Location.IsNull) {
</I>&gt;<i> + current_token = saved_token.Token;
</I>&gt;<i> + val = saved_token.Value;
</I>&gt;<i> + current_location = saved_token.Location;
</I>&gt;<i> + saved_token = SavedToken.Null;
</I>&gt;<i> + }
</I>&gt;<i> + else
</I>&gt;<i> + current_token = xtoken ();
</I>&gt;<i>                         return current_token;
</I>&gt;<i>                 }
</I>&gt;<i>
</I>&gt;<i> @@ -1844,29 +1853,21 @@
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  if (res == Token.PARTIAL) {
</I>&gt;<i> - // Save current position and parse next token.
</I>&gt;<i> - int old = reader.Position;
</I>&gt;<i> - int old_putback = putback_char;
</I>&gt;<i> - int old_ref_line = ref_line;
</I>&gt;<i> - int old_col = col;
</I>&gt;<i> -
</I>&gt;<i> - putback_char = -1;
</I>&gt;<i> -
</I>&gt;<i> + // Save next token.
</I>&gt;<i> + Location cur_loc = Location;
</I>&gt;<i>  int next_token = token ();
</I>&gt;<i> + saved_token = new SavedToken (next_token, val, Location);
</I>&gt;<i> + current_location = cur_loc;
</I>&gt;<i>  bool ok = (next_token == Token.CLASS) ||
</I>&gt;<i>  (next_token == Token.STRUCT) ||
</I>&gt;<i>  (next_token == Token.INTERFACE) ||
</I>&gt;<i>  (next_token == Token.ENUM); // &quot;partial&quot; is a keyword in 'partial enum',
</I>&gt;<i> even though it's not valid
</I>&gt;<i>
</I>&gt;<i> - reader.Position = old;
</I>&gt;<i> - ref_line = old_ref_line;
</I>&gt;<i> - col = old_col;
</I>&gt;<i> - putback_char = old_putback;
</I>&gt;<i> -
</I>&gt;<i>  if (ok)
</I>&gt;<i>  return res;
</I>&gt;<i>  else {
</I>&gt;<i>  val = new LocatedToken (Location, &quot;partial&quot;);
</I>&gt;<i> + saved_token = SavedToken.Null;
</I>&gt;<i>  return Token.IDENTIFIER;
</I>&gt;<i>  }
</I>&gt;<i>  }
</I>&gt;<i> @@ -2309,6 +2310,23 @@
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  }
</I>&gt;<i> +
</I>&gt;<i> + public struct SavedToken
</I>&gt;<i> + {
</I>&gt;<i> + public static readonly SavedToken Null =
</I>&gt;<i> + new SavedToken (0, null, Location.Null);
</I>&gt;<i> +
</I>&gt;<i> + public readonly int Token;
</I>&gt;<i> + public readonly object Value;
</I>&gt;<i> + public readonly Location Location;
</I>&gt;<i> +
</I>&gt;<i> + public SavedToken (int token, object value, Location loc)
</I>&gt;<i> + {
</I>&gt;<i> + Token = token;
</I>&gt;<i> + Value = value;
</I>&gt;<i> + Location = loc;
</I>&gt;<i> + }
</I>&gt;<i> + }
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  //
</I>&gt;<i> Index: cs-parser.jay
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- cs-parser.jay (revision 49060)
</I>&gt;<i> +++ cs-parser.jay (working copy)
</I>&gt;<i> @@ -4856,7 +4856,7 @@
</I>&gt;<i>  }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> -public CSharpParser (SeekableStreamReader reader, SourceFile file,
</I>&gt;<i> ArrayList defines)
</I>&gt;<i> +public CSharpParser (StreamReader reader, SourceFile file, ArrayList
</I>&gt;<i> defines)
</I>&gt;<i> {
</I>&gt;<i>  current_namespace = new NamespaceEntry (null, file, null, Location.Null);
</I>&gt;<i>  this.name = file.Name;
</I>&gt;<i> Index: driver.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- driver.cs (revision 49060)
</I>&gt;<i> +++ driver.cs (working copy)
</I>&gt;<i> @@ -153,7 +153,7 @@
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  using (input){
</I>&gt;<i> - SeekableStreamReader reader = new SeekableStreamReader (input,
</I>&gt;<i> encoding);
</I>&gt;<i> + StreamReader reader = new StreamReader (input, encoding, true);
</I>&gt;<i>  Tokenizer lexer = new Tokenizer (reader, file, defines);
</I>&gt;<i>  int token, tokens = 0, errors = 0;
</I>&gt;<i>
</I>&gt;<i> @@ -181,16 +181,16 @@
</I>&gt;<i>  return;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> - SeekableStreamReader reader = new SeekableStreamReader (input,
</I>&gt;<i> encoding);
</I>&gt;<i> -
</I>&gt;<i>  // Check 'MZ' header
</I>&gt;<i> - if (reader.Read () == 77 &amp;&amp; reader.Read () == 90) {
</I>&gt;<i> + if (input.ReadByte () == 77 &amp;&amp; input.ReadByte () == 90) {
</I>&gt;<i>  Report.Error (2015, &quot;Source file `{0}' is a binary file and not a text
</I>&gt;<i> file&quot;, file.Name);
</I>&gt;<i>  input.Close ();
</I>&gt;<i>  return;
</I>&gt;<i>  }
</I>&gt;<i> + input.Position = 0;
</I>&gt;<i>
</I>&gt;<i> - reader.Position = 0;
</I>&gt;<i> + StreamReader reader = new StreamReader (input, encoding, true);
</I>&gt;<i> +
</I>&gt;<i>  parser = new CSharpParser (reader, file, defines);
</I>&gt;<i>  parser.ErrorOutput = Report.Stderr;
</I>&gt;<i>  try {
</I>&gt;<i>
</I>

--------------------------------------------------------------------------------


&gt;<i> &#12539;&#12477;MZ
</I>

--------------------------------------------------------------------------------


&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014423.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
	<LI>Next message: <A HREF="014422.html">[Mono-dev] mcs patch to say goodbye to SeekableStreamReader
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14402">[ date ]</a>
              <a href="thread.html#14402">[ thread ]</a>
              <a href="subject.html#14402">[ subject ]</a>
              <a href="author.html#14402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
