<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Generic Type Definition / Open	Instantiation	mismatch patch.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20Type%20Definition%20/%20Open%09Instantiation%0A%09mismatch%20patch.&In-Reply-To=8cca42d80709210822k4e83e719h4d724ad2595fe329%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025067.html">
   <LINK REL="Next"  HREF="025060.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Generic Type Definition / Open	Instantiation	mismatch patch.</H1>
    <B>Juraj Skripsky</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20Type%20Definition%20/%20Open%09Instantiation%0A%09mismatch%20patch.&In-Reply-To=8cca42d80709210822k4e83e719h4d724ad2595fe329%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Generic Type Definition / Open	Instantiation	mismatch patch.">js at hotfeet.ch
       </A><BR>
    <I>Tue Sep 25 05:16:52 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025067.html">[Mono-dev] Fwd: [PATCH] Generic Type Definition /	Open	Instantiation mismatch patch.
</A></li>
        <LI>Next message: <A HREF="025060.html">[Mono-dev] [PATCH] Generic Type Definition / Open Instantiation	mismatch patch.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25049">[ date ]</a>
              <a href="thread.html#25049">[ thread ]</a>
              <a href="subject.html#25049">[ subject ]</a>
              <a href="author.html#25049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rodrigo,

Thank for working on this! I wasn't aware of this bug before and it bit
me a couple of times (with me slowly growing desperate) when using Mono
with Db4o and generic collections.

I've applied it to my local tree and it works fine so far. I'll try to
do some more testing and will keep you posted about any problems I run
into.

Just a cosmetic detail - you are a duplicated if() block in
mono_class_setup_generic_type_container():

+	if (container-&gt;gtd_class)
+               return;
+
+
+       if (container-&gt;gtd_class) {
+               return;
+       }

- Juraj


On Fri, 2007-09-21 at 12:22 -0300, Rodrigo Kumpera wrote:
&gt;<i> Hey guys,
</I>&gt;<i> 
</I>&gt;<i> The patch if finally done and it works perfectly well against head.
</I>&gt;<i> This patch turned to be very different from what it started to look
</I>&gt;<i> like and fortunately this meant a reduction of more than an order of
</I>&gt;<i> magnitude in its size, from 3.000 lines to a bit more than 230.
</I>&gt;<i> 
</I>&gt;<i> To have the patch make sense I need to first define what it fixes.
</I>&gt;<i> Right now mono treat the generic type definition and the open
</I>&gt;<i> instantiation over its own parameters (or just open instantiation from
</I>&gt;<i> now on) as two different classes. For example, given the type &quot;class
</I>&gt;<i> Example&lt;T,M&gt;&quot;, the generic type definition is &quot;Example`2&quot; and the open
</I>&gt;<i> instantiation is &quot;Example`2&lt;T,M&gt;&quot; where T and M are the parameters of
</I>&gt;<i> Example`2. If that doesn't make much sense, the following code might
</I>&gt;<i> help: 
</I>&gt;<i> 
</I>&gt;<i> Type gtd = typeof (Example&lt;,&gt;);
</I>&gt;<i> Type openInst = gtd.MakeGenericType (gtd.GetGenericArguments
</I>&gt;<i> ()); //openInst and gtd should be the same instance
</I>&gt;<i> 
</I>&gt;<i> This property is very important for all parts of mono that play with
</I>&gt;<i> raw (non inflated) generic code. Analyzing the IL of generic code
</I>&gt;<i> ilustrate this issue well better: 
</I>&gt;<i> 
</I>&gt;<i> .class public A`1&lt;T&gt; extends [mscorlib]System.Object
</I>&gt;<i> {
</I>&gt;<i>     .field  private  !0 fld
</I>&gt;<i> 
</I>&gt;<i>     .method public instance void Example () 
</I>&gt;<i>     {
</I>&gt;<i>         .maxstack 2
</I>&gt;<i>         .locals init (
</I>&gt;<i>             !T      V_0)
</I>&gt;<i>         ldarg.0 
</I>&gt;<i>         ldfld !0 class A`1&lt;!0&gt;::fld
</I>&gt;<i>         stloc.0 
</I>&gt;<i>         ret 
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> The current situation is that the non-inflated method Example will be
</I>&gt;<i> bound to a different MonoClass instance than the token of ldfld. Which
</I>&gt;<i> will lead the runtime to view it as an error. Right now only the
</I>&gt;<i> verifier is affected by this situation but I think the generics code
</I>&gt;<i> sharing work might profit from the fix too. 
</I>&gt;<i> 
</I>&gt;<i> The original idea of how to fix it was to change the this_arg and
</I>&gt;<i> byref_arg of the MonoClass struct to have type MONO_TYPE_GENERICINST.
</I>&gt;<i> With that set, when a generic type was initialized, the open
</I>&gt;<i> instantation MonoGenericClass would be bound to it. This works quite
</I>&gt;<i> well except that it introduced a lot of issues. The main one that the
</I>&gt;<i> container_type of generic instantiations would no longer be a
</I>&gt;<i> MONO_TYPE_CLASS. 
</I>&gt;<i> 
</I>&gt;<i> First all code than handled MONO_TYPE_GENERICINST need to be changed
</I>&gt;<i> to couple with this fact, this required changes across most of
</I>&gt;<i> metadata and even in mini.c, some places expect a MONO_TYPE_CLASS and
</I>&gt;<i> don't even guard the retrieval from the data union of MonoType. This
</I>&gt;<i> led to many hard to spot bugs. 
</I>&gt;<i> 
</I>&gt;<i> The last issue was with TypeBuilders, the way they are currently set,
</I>&gt;<i> the associated MonoClass cannot be a MONO_TYPE_GENERICINST until
</I>&gt;<i> CreateType () is called. Changing (this|byval)_arg.type during
</I>&gt;<i> mono_reflection_create_runtime_class turned to be a bad idea, as it
</I>&gt;<i> breaks the invariant that once the MonoClass is first initialized it
</I>&gt;<i> won't change (this|byval)_arg.type in such drastic way. I had to patch
</I>&gt;<i> too many places trying to get around this issue. 
</I>&gt;<i> 
</I>&gt;<i> The bottom line is that this approach won't work and the resulting
</I>&gt;<i> patch would introduce a big chunk of new bugs. In the other hand, the
</I>&gt;<i> runtime seens to be fine with breaking another premise, that all
</I>&gt;<i> MonoClass instances bould to MonoGenericClass have type
</I>&gt;<i> MONO_TYPE_GENERICINST. 
</I>&gt;<i> 
</I>&gt;<i> This is how it works: when the generic type definition is initialized
</I>&gt;<i> at the end of either mono_reflection_create_runtime_class or
</I>&gt;<i> mono_class_setup_mono_type, we lookup the open instantiation and bind
</I>&gt;<i> it - IOW we set MonoGenericClass::cached_class to the 
</I>&gt;<i> MonoClass instance of the generic type definition.
</I>&gt;<i> 
</I>&gt;<i> There is one finall twist on this patch, the way
</I>&gt;<i> System.Reflection.Emit in mono is incompatible with .net. On mono,
</I>&gt;<i> TypeBuilder::MakeGenericType returns a Type that is functional (one
</I>&gt;<i> you can call GetConstructors). This means that you cannot have the
</I>&gt;<i> same behavior that happens with types loaded from an assembly. To get
</I>&gt;<i> arround this fact, either I could either &quot;fix&quot; gmcs to work with the
</I>&gt;<i> crippled .net SRE API, or special case for TypeBuilder. I have choosen
</I>&gt;<i> the later one as it makes more sense. 
</I>&gt;<i> 
</I>&gt;<i> This mean that in mono_metadata_lookup_generic_class we check if we
</I>&gt;<i> are looking up the open instantiation of a TypeBuilder and return a
</I>&gt;<i> MonoGenericClass than won't be the same for the created type.
</I>&gt;<i> 
</I>&gt;<i> What could receive some love in the patch is the way the check for the
</I>&gt;<i> TypeBuilder is done could be optimized by doing pre-calculating it in
</I>&gt;<i> mono_metadata_get_generic_inst. This could be done if you guys find
</I>&gt;<i> that's a good idea, I'm just not sure if it's work the trouble. Right
</I>&gt;<i> now the tests are using NUnit, maybe some should be moved to the
</I>&gt;<i> regression suite. 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Rodrigo
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025067.html">[Mono-dev] Fwd: [PATCH] Generic Type Definition /	Open	Instantiation mismatch patch.
</A></li>
	<LI>Next message: <A HREF="025060.html">[Mono-dev] [PATCH] Generic Type Definition / Open Instantiation	mismatch patch.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25049">[ date ]</a>
              <a href="thread.html#25049">[ thread ]</a>
              <a href="subject.html#25049">[ subject ]</a>
              <a href="author.html#25049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
