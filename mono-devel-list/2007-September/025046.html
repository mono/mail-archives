<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Replicating System.Web.Script.Serialization bugs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replicating%20System.Web.Script.Serialization%20bugs&In-Reply-To=68CC0483-21EF-4D9B-A52F-9FDB3D317A72%40monkeypox.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025018.html">
   <LINK REL="Next"  HREF="025051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Replicating System.Web.Script.Serialization bugs</H1>
    <B>Konstantin Triger</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Replicating%20System.Web.Script.Serialization%20bugs&In-Reply-To=68CC0483-21EF-4D9B-A52F-9FDB3D317A72%40monkeypox.org"
       TITLE="[Mono-dev] Replicating System.Web.Script.Serialization bugs">kostat at mainsoft.com
       </A><BR>
    <I>Tue Sep 25 04:09:32 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025018.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
        <LI>Next message: <A HREF="025051.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25046">[ date ]</a>
              <a href="thread.html#25046">[ thread ]</a>
              <a href="subject.html#25046">[ subject ]</a>
              <a href="author.html#25046">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Tyler,

Regardless of the compatibility with MS 'bug', I think that leaving uninitialized the fields in this case will raise several logical problems:

1. For value types: since there is no notion of 'null' value (unlike many dymanic languages) it would be very hard to differentiate between the 'default' and deserialized values if they are equal. (If you have a field of type 'Int32' and its value after deserialization is 0, where is it from?!)

2. For String type: should {&quot;some_key&quot; : &quot;&quot;} be deserialized to null or empty string?

In other words, the 'bug' compatibility is not casual.

&gt;<i>From the other hand, I think that for nullable types, setting them to null in our case can be acceptable (did not check, possibly it already works this way 'by mistake').
</I>
Regards,
Konstantin Triger

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:mono-devel-list-
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bounces at lists.ximian.com</A>] On Behalf Of R. Tyler Ballance
</I>&gt;<i> Sent: Sunday, September 23, 2007 3:58 PM
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: [Mono-dev] Replicating System.Web.Script.Serialization bugs
</I>&gt;<i> 
</I>&gt;<i> I discovered that whilst consuming Facebook's API data in JSON
</I>&gt;<i> format, that both .NET 2.0 and Mono (from trunk) have the exact same
</I>&gt;<i> System.Web.Script.Serialization bug when dealing with empty value
</I>&gt;<i> fields in the JSON key/value string, for example:
</I>&gt;<i> 
</I>&gt;<i> {&quot;some_key&quot; : &quot;&quot;}
</I>&gt;<i> 
</I>&gt;<i> Which is handled properly as an empty value by Python and Javascript
</I>&gt;<i> alike, barfs inside the stronger-typed C#, when you try to serialize
</I>&gt;<i> it to a &quot;long&quot; value (for example), throwing the following exception
</I>&gt;<i> on both .NET and Mono
</I>&gt;<i> 
</I>&gt;<i> Unhandled Exception: System.Exception:  is not a valid value for
</I>&gt;<i> Int64. ---&gt; System.FormatException: Input string was not in the
</I>&gt;<i> correct format: s.Length==0.
</I>&gt;<i>    at System.Int64.Parse (System.String s, NumberStyles style,
</I>&gt;<i> IFormatProvider fp) [0x00000]
</I>&gt;<i>    at System.ComponentModel.Int64Converter.ConvertFromString
</I>&gt;<i> (System.String value, System.Globalization.NumberFormatInfo format)
</I>&gt;<i> [0x00000]
</I>&gt;<i>    at System.ComponentModel.BaseNumberConverter.ConvertFrom
</I>&gt;<i> (ITypeDescriptorContext context, System.Globalization.CultureInfo
</I>&gt;<i> culture, System.Object value) [0x00000]
</I>&gt;<i> 
</I>&gt;<i> [full stack trace from attached test code at the bottom of this email]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Ideally this would just *not* be serialized out, leaving the object's
</I>&gt;<i> property that maps to &quot;some_key&quot; empty/uninitialized, but instead the
</I>&gt;<i> application that consumes and deserializes the JSON will explode,
</I>&gt;<i> especially if the JSON provider (Facebook in my case) provides fields
</I>&gt;<i> such as this as optional.
</I>&gt;<i> 
</I>&gt;<i> As I mentioned to sontek in the IRC channel, it certainly seems like
</I>&gt;<i> I'm screwed in this case, since we are &quot;compatible&quot; with Microsoft's
</I>&gt;<i> bugs :( So the bigger question is, what work around or recourse do I
</I>&gt;<i> have in this case? I have kicked around the idea of adding a
</I>&gt;<i> Mono.Script.Serialization to trunk that would essentially just apply
</I>&gt;<i> a series of patches to System.Web.Script.Serialization, but I'd
</I>&gt;<i> rather avoid that route as it doesn't tend to grow well, but I don't
</I>&gt;<i> see a really decent workaround except to implement a &quot;magic&quot; property
</I>&gt;<i> for EVERY single optional JSON key (which in some calls can be up to
</I>&gt;<i> about 50 keys) to do a Convert.ToInt64 if there's a string on get {},
</I>&gt;<i> otherwise return a null (this sucks, and I don't want to implement it
</I>&gt;<i> for every frakking deserializable attribute that could need to be
</I>&gt;<i> deserialized as anything but a string)
</I>&gt;<i> 
</I>&gt;<i> I've attached my test case, but I have a sense someone is going to
</I>&gt;<i> point out that the emperor has no clothes, and that I am indeed
</I>&gt;<i> screwed :-P
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Cheers
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025018.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
	<LI>Next message: <A HREF="025051.html">[Mono-dev] Replicating System.Web.Script.Serialization bugs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25046">[ date ]</a>
              <a href="thread.html#25046">[ thread ]</a>
              <a href="subject.html#25046">[ subject ]</a>
              <a href="author.html#25046">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
