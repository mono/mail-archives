<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] DataContext Implementation Advice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DataContext%20Implementation%20Advice&In-Reply-To=88d636060709210311p55e4dc1di6fd065a22797454e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024985.html">
   <LINK REL="Next"  HREF="024986.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] DataContext Implementation Advice</H1>
    <B>Paul Stovell</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DataContext%20Implementation%20Advice&In-Reply-To=88d636060709210311p55e4dc1di6fd065a22797454e%40mail.gmail.com"
       TITLE="[Mono-dev] DataContext Implementation Advice">paul at paulstovell.com
       </A><BR>
    <I>Fri Sep 21 07:08:38 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="024985.html">[Mono-dev] DataContext Implementation Advice
</A></li>
        <LI>Next message: <A HREF="024986.html">[Mono-dev] DataContext Implementation Advice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25054">[ date ]</a>
              <a href="thread.html#25054">[ thread ]</a>
              <a href="subject.html#25054">[ subject ]</a>
              <a href="author.html#25054">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Kevin,

I'm enjoying reading these posts of yours - very fascinating.

With regards to change tracking, the last time I looked, DLINQ objects raise
a PropertyChanging (INotifyPropertyChanging, part of System.ComponentModel )
event when properties are changed. Since it is your QueryProvider (the
DataContext) which is returning the objects, it can subscribe to these
events and use them to builds its hashtable when updateable items are
modified.

So a Dictionary&lt;Row, Change&gt; (where a &quot;Change&quot; represents the original and
new value), as you suggested, would seem like the way to go to me.

Cheers,

Paul
www.paulstovell.net


On 9/21/07, Kevin Kubasik &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kevin at kubasik.net</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Ok, so I've been able to create a pretty generic (if highly adaptable)
</I>&gt;<i> IQueryProvider which implements very basic Linq -&gt; Sql support(More on
</I>&gt;<i> that later). This project was to better understand the roll played by
</I>&gt;<i> different components in the linq-&gt;sql pipeline. While the more
</I>&gt;<i> complicated and optimized we try to make the Linq-SQL conversion, the
</I>&gt;<i> harder it becomes, the core of implementing a Provider is pretty easy.
</I>&gt;<i> We could write custom _query_ providers all day long and have linq to
</I>&gt;<i> the world. The problem is that we want updates, deletes, sprocs etc.
</I>&gt;<i> That is where the DataContext comes in, and my headaches start.
</I>&gt;<i>
</I>&gt;<i> The principal of the DataContext is easy enough, its like the ADO.NET
</I>&gt;<i> 2.0 DataSets in that it can be generated as a strongly-typed extension
</I>&gt;<i> of the core DataContex, or as a generic and adaptable class. The
</I>&gt;<i> DataContext sits in System.Data.Linq, and is the gatekeeper between
</I>&gt;<i> the query language and a provider. In addition to just being in the
</I>&gt;<i> way, the DataContext provides metadata about a database, has an
</I>&gt;<i> understanding of tables and relationships, as well as stored
</I>&gt;<i> procedures. It is also responsible for object caches.
</I>&gt;<i>
</I>&gt;<i> This is all fun and good, with some decent mapping code we can do all
</I>&gt;<i> that without breaking a sweat. The problem is
</I>&gt;<i> DataContext.SubmitChanges(). As tables are manipulated etc. these
</I>&gt;<i> changes are tracked in-memory (or some other awesometastic way) and
</I>&gt;<i> eventually either reverted or submitted. More importantly, to anyone
</I>&gt;<i> using the DataContext's tables gets the modified information. Again,
</I>&gt;<i> things don't sound too bad, and there are already implementations
</I>&gt;<i> (DataTable, DataSet etc.). The difference is they have all the data,
</I>&gt;<i> and execute a modification upon call, then store the old value and the
</I>&gt;<i> current state of the data. Linq is all deferred execution, we don't
</I>&gt;<i> have an in memory representation of the data on the database, we just
</I>&gt;<i> have a list of instructions, each of which will return a result.
</I>&gt;<i>
</I>&gt;<i> So, basically I've determined that out DataContext will have to track
</I>&gt;<i> everything happening in each of its tables. This got me thinking, an
</I>&gt;<i> event driven model would be perfect, we would only act when actual
</I>&gt;<i> action was being taken.  Now, I basically have both ends of the
</I>&gt;<i> spectrum, we get every object associated with an expression utilizing
</I>&gt;<i> a DataContext, and flag it in our cool DiffTracker, using a Dictionary
</I>&gt;<i> or Hashtable for fast lookups based upon the entity itself, then we
</I>&gt;<i> process each event as it happens (which is pretty much the last thing
</I>&gt;<i> an expression will do). I think we can get away with only the current
</I>&gt;<i> state of each noteworthy object and the most recent past.I figure if
</I>&gt;<i> the state is Insert, who cares what the object was before, if the
</I>&gt;<i> state is Update, we just update all values to their current value,
</I>&gt;<i> selecting on the old object, and if its delete.... yeah. There is a
</I>&gt;<i> States.cs Enum in the System.Data.Linq directory with all the states a
</I>&gt;<i> DataContext  is aware of.
</I>&gt;<i>
</I>&gt;<i> The problem is the massive middleman, I've gotten absolutely worlds
</I>&gt;<i> better with some of C#'s more advanced language structures in the few
</I>&gt;<i> days I've been working on this, but I am not 100% sure of hows the
</I>&gt;<i> best way to go about this. As a result, I would really love some help.
</I>&gt;<i> I can get the DataContext to respond intelligently to Linq queries,
</I>&gt;<i> and continue to process the subtree into a table. Once we are at that
</I>&gt;<i> point, its all on the individual Sql implementation (which isn't
</I>&gt;<i> important yet, and isn't really on the immeidate radar.).
</I>&gt;<i>
</I>&gt;<i> If someone could help me out a bit with the actual construction of the
</I>&gt;<i> DiffTracker and DiffWrapper classes, it would be greatly appreciated.
</I>&gt;<i> You aren't obligated to use my design, or even help at all. But I
</I>&gt;<i> would _greatly_ appreciate some feedback or any ideas anyone has about
</I>&gt;<i> this. Specifically with regard too keeping this light and simple, as I
</I>&gt;<i> feel like it could quickly become a massive buggy mess.
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Cheers,
</I>&gt;<i> Kevin Kubasik
</I>&gt;<i> <A HREF="http://kubasik.net/blog">http://kubasik.net/blog</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070921/d3034ae7/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070921/d3034ae7/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024985.html">[Mono-dev] DataContext Implementation Advice
</A></li>
	<LI>Next message: <A HREF="024986.html">[Mono-dev] DataContext Implementation Advice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25054">[ date ]</a>
              <a href="thread.html#25054">[ thread ]</a>
              <a href="subject.html#25054">[ subject ]</a>
              <a href="author.html#25054">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
