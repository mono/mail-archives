<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Question%20on%20the%20C-%3EC%23%20translation%20of%20WinApi%20MSG%0A%09struct.&In-Reply-To=15aef24e0709220142h4aa0516fqc73ba290bb7a8278%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025005.html">
   <LINK REL="Next"  HREF="025020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.</H1>
    <B>Mike Edenfield</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Question%20on%20the%20C-%3EC%23%20translation%20of%20WinApi%20MSG%0A%09struct.&In-Reply-To=15aef24e0709220142h4aa0516fqc73ba290bb7a8278%40mail.gmail.com"
       TITLE="[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.">kutulu at kutulu.org
       </A><BR>
    <I>Sat Sep 22 16:16:28 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025005.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG struct.
</A></li>
        <LI>Next message: <A HREF="025020.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25010">[ date ]</a>
              <a href="thread.html#25010">[ thread ]</a>
              <a href="subject.html#25010">[ subject ]</a>
              <a href="author.html#25010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>StApostol wrote:
&gt;<i> I am writing OpenTK, a game development toolkit which makes extensive 
</I>&gt;<i> use of P/Invoke calls. On the Windows platform, I encountered some 
</I>&gt;<i> strange behavior regarding the MSG struct.
</I>&gt;<i> 
</I>&gt;<i> In winuser.h, MSG is defined like this:
</I>&gt;<i> 
</I>&gt;<i> typedef struct tagMSG {
</I>&gt;<i>   HWND hwnd;
</I>&gt;<i>   UINT message;
</I>&gt;<i>   WPARAM wParam;
</I>&gt;<i>   LPARAM lParam;
</I>&gt;<i>   DWORD time;
</I>&gt;<i>   POINT pt;
</I>&gt;<i> #ifdef _MAC
</I>&gt;<i>   DWORD lPrivate;
</I>&gt;<i> #endif
</I>&gt;<i> } MSG;
</I>&gt;<i> 
</I>&gt;<i> The C# equivalent, as suggested at the .Net dev forums, would look like 
</I>&gt;<i> this:
</I>&gt;<i> 
</I>&gt;<i> [StructLayout(LayoutKind.Sequential), CLSCompliant(false)]
</I>&gt;<i> public struct MSG
</I>&gt;<i> {
</I>&gt;<i>   public IntPtr HWnd;
</I>&gt;<i>   public WindowMessage Message;
</I>&gt;<i>   public IntPtr WParam;
</I>&gt;<i>   public IntPtr LParam;
</I>&gt;<i>   public uint Time;
</I>&gt;<i>   public POINT Point;
</I>&gt;<i> 
</I>&gt;<i>   public override string ToString()
</I>&gt;<i>   {
</I>&gt;<i>       return String.Format(&quot;msg=0x{0:x} ({1}) hwnd=0x{2:x} 
</I>&gt;<i> wparam=0x{3:x} lparam=0x{4:x} pt=0x{5:x}&quot;, (int)Message, 
</I>&gt;<i> Message.ToString(), HWnd.ToInt32(), WParam.ToInt32(), LParam.ToInt32(), 
</I>&gt;<i> Point);
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> However, Mono's implementation in xplatui adds one more field to the struct:
</I>&gt;<i> 
</I>&gt;<i> [StructLayout(LayoutKind.Sequential), CLSCompliant(false)]
</I>&gt;<i> public struct MSG
</I>&gt;<i> {
</I>&gt;<i>   public IntPtr HWnd;
</I>&gt;<i>   public WindowMessage Message;
</I>&gt;<i>   public IntPtr WParam;
</I>&gt;<i>   public IntPtr LParam;
</I>&gt;<i>   public uint Time;
</I>&gt;<i>   public POINT Point;
</I>&gt;<i> 
</I>&gt;<i>   public object RefObject;
</I>&gt;<i> 
</I>&gt;<i>   public override string ToString()
</I>&gt;<i>   {
</I>&gt;<i>        return String.Format(&quot;msg=0x{0:x} ({1}) hwnd=0x{2:x} 
</I>&gt;<i> wparam=0x{3:x} lparam=0x{4:x} pt=0x{5:x}&quot;, (int)Message, 
</I>&gt;<i> Message.ToString(), HWnd.ToInt32(), WParam.ToInt32(), LParam.ToInt32 (), 
</I>&gt;<i> Point);
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i> My guess is that it is used for some kind of synchronization, but will 
</I>&gt;<i> this not corrupt the stack? Both seem to work correctly for extended 
</I>&gt;<i> periods of time on both 32- and 64-bit platforms, which I find a little 
</I>&gt;<i> strange. Which is the correct one? What is RefObject doing there?
</I>
The Windows API almost always passes structures like this as 
pointers.  PeekMessage() and all of the GetMessage() calls 
pass an LPMSG parameter, for example.  The only thing the 
unmanaged code inside Windows knows about are the field 
defined in the header, which are accessed as &quot;x number of 
bytes past the pointer value&quot;.  As long as any additional 
information is at the end of the structure, Windows will 
ignore it.

In fact, Windows uses this fact itself when new features 
come out, by adding fields to the end of key structures and 
internally using sizeof(blah) to figure out what fields are 
available.

The only thing you would need to watch out for is anything 
that tries to take the size of a struct MSG, but I don't 
know of any Windows API call that does so.

-- Mike

Still using IE? Get Firefox!
<A HREF="http://www.spreadfirefox.com/?q=affiliates&amp;id=6492&amp;t=1">http://www.spreadfirefox.com/?q=affiliates&amp;id=6492&amp;t=1</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025005.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG struct.
</A></li>
	<LI>Next message: <A HREF="025020.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25010">[ date ]</a>
              <a href="thread.html#25010">[ thread ]</a>
              <a href="subject.html#25010">[ subject ]</a>
              <a href="author.html#25010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
