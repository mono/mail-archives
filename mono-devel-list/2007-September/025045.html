<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] IIF Bug in Mono.Data.SqlExpressions/Parser.jay
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20IIF%20Bug%20in%20Mono.Data.SqlExpressions/Parser.jay&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025041.html">
   <LINK REL="Next"  HREF="025094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] IIF Bug in Mono.Data.SqlExpressions/Parser.jay</H1>
    <B>Joel Reed</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20IIF%20Bug%20in%20Mono.Data.SqlExpressions/Parser.jay&In-Reply-To="
       TITLE="[Mono-dev] IIF Bug in Mono.Data.SqlExpressions/Parser.jay">joelwreed at gmail.com
       </A><BR>
    <I>Mon Sep 24 22:34:45 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025041.html">[Mono-dev] Compiling-Error
</A></li>
        <LI>Next message: <A HREF="025094.html">[Mono-dev] IIF Bug in Mono.Data.SqlExpressions/Parser.jay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25045">[ date ]</a>
              <a href="thread.html#25045">[ thread ]</a>
              <a href="subject.html#25045">[ subject ]</a>
              <a href="author.html#25045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The following code works on MS.NET but not mono svn head (as of 9/24/07):

  DataTable dt = new DataTable();
  dt.Columns.Add(&quot;SurveyImage&quot;, Type.GetType(&quot;System.String&quot;), 
	  &quot;IIF(LMSurvey, 'g1.gif', 'g2.gif')&quot;);


1) The attached file &quot;Iif.testcase.diff&quot; adds a test case for
this. OK to apply?


2) I first tried fixing this by adding this code to &quot;BoolExpr&quot;

Index: class/System.Data/Mono.Data.SqlExpressions/Parser.jay
===================================================================
--- class/System.Data/Mono.Data.SqlExpressions/Parser.jay	(revision 86284)
+++ class/System.Data/Mono.Data.SqlExpressions/Parser.jay	(working copy)
@@ -118,6 +118,10 @@
 		$$ = new Negation ((IExpression)$2);
 	}
 	| Predicate
+	| SingleColumnValue
+	{
+		$$ = new BoolOperation(Operation.EQ, (IExpression)$1, new Literal (true));
+	}
 	;
 
 Predicate


But this broke alot of test cases (about 8). I think Parser.jay needs more surgery to fix
these test cases. For example, this line in &quot;CalcFunction&quot;

  SUBSTRING PAROPEN Expr COMMA NumberLiteral COMMA NumberLiteral PARCLOSE

Doesn't seem correct. Expr is defined as &quot;BoolExpr | ArithExpr&quot;. But SUBSTRING
doesn't work on a BoolOperation or ArithmeticOperation afaik. It works now because
ArithExpr can also be a &quot;Value&quot;. Come to think of it, shouldn't NumberLiteral actually
be ArithExpr? I'll have to try that on MS.NET...

Anyway, not wanting to make lots of changes to this file without checking in here first,
I instead made this change:

Index: class/System.Data/Mono.Data.SqlExpressions/Parser.jay
===================================================================
--- class/System.Data/Mono.Data.SqlExpressions/Parser.jay	(revision 86284)
+++ class/System.Data/Mono.Data.SqlExpressions/Parser.jay	(working copy)
@@ -269,11 +269,19 @@
 	| VAR		{ $$ = AggregationFunction.Var; }
 	;
 
-CalcFunction
+IifFunction
 	: IIF PAROPEN BoolExpr COMMA Expr COMMA Expr PARCLOSE
 	{
 		$$ = new IifFunction ((IExpression)$3, (IExpression)$5, (IExpression)$7);
 	}
+	| IIF PAROPEN SingleColumnValue COMMA Expr COMMA Expr PARCLOSE
+	{
+		$$ = new IifFunction (new BoolOperation(Operation.EQ, (IExpression)$3, new Literal (true)), (IExpression)$5, (IExpression)$7);
+	}
+	;
+
+CalcFunction
+	: IifFunction
 	| SUBSTRING PAROPEN Expr COMMA NumberLiteral COMMA NumberLiteral PARCLOSE
 	{
 		long arg1 = (long) $5;


Which does the job - but seems rather ugly to me. Any comments? Anyone interested in 
this quick fix or me taking the first route &amp; fixing up the rest of this file?

jr
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Iif.testcase.diff
Type: text/x-diff
Size: 994 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: BoolOper.fix.diff
Type: text/x-diff
Size: 481 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment-0001.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: IifFix.diff
Type: text/x-diff
Size: 861 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment-0002.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070924/fba7525b/attachment-0002.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025041.html">[Mono-dev] Compiling-Error
</A></li>
	<LI>Next message: <A HREF="025094.html">[Mono-dev] IIF Bug in Mono.Data.SqlExpressions/Parser.jay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25045">[ date ]</a>
              <a href="thread.html#25045">[ thread ]</a>
              <a href="subject.html#25045">[ subject ]</a>
              <a href="author.html#25045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
