<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Generic Type Definition / Open Instantiation	mismatch patch.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20Type%20Definition%20/%20Open%20Instantiation%0A%09mismatch%20patch.&In-Reply-To=1190711812.3294.6.camel%40leonardo.hotfeet.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025049.html">
   <LINK REL="Next"  HREF="025004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Generic Type Definition / Open Instantiation	mismatch patch.</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Generic%20Type%20Definition%20/%20Open%20Instantiation%0A%09mismatch%20patch.&In-Reply-To=1190711812.3294.6.camel%40leonardo.hotfeet.ch"
       TITLE="[Mono-dev] [PATCH] Generic Type Definition / Open Instantiation	mismatch patch.">kumpera at gmail.com
       </A><BR>
    <I>Tue Sep 25 08:15:07 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025049.html">[Mono-dev] [PATCH] Generic Type Definition / Open	Instantiation	mismatch patch.
</A></li>
        <LI>Next message: <A HREF="025004.html">[Mono-dev] Is AJAX ready
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25060">[ date ]</a>
              <a href="thread.html#25060">[ thread ]</a>
              <a href="subject.html#25060">[ subject ]</a>
              <a href="author.html#25060">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Juraj,

Thanks for pointing out the double &quot;if()&quot;, I I did some locking cleanup and
all paths were called with the loader lock held, so no need to lock and
re-check.

Cheers,
Rodrigo

On 9/25/07, Juraj Skripsky &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hi Rodrigo,
</I>&gt;<i>
</I>&gt;<i> Thank for working on this! I wasn't aware of this bug before and it bit
</I>&gt;<i> me a couple of times (with me slowly growing desperate) when using Mono
</I>&gt;<i> with Db4o and generic collections.
</I>&gt;<i>
</I>&gt;<i> I've applied it to my local tree and it works fine so far. I'll try to
</I>&gt;<i> do some more testing and will keep you posted about any problems I run
</I>&gt;<i> into.
</I>&gt;<i>
</I>&gt;<i> Just a cosmetic detail - you are a duplicated if() block in
</I>&gt;<i> mono_class_setup_generic_type_container():
</I>&gt;<i>
</I>&gt;<i> +       if (container-&gt;gtd_class)
</I>&gt;<i> +               return;
</I>&gt;<i> +
</I>&gt;<i> +
</I>&gt;<i> +       if (container-&gt;gtd_class) {
</I>&gt;<i> +               return;
</I>&gt;<i> +       }
</I>&gt;<i>
</I>&gt;<i> - Juraj
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, 2007-09-21 at 12:22 -0300, Rodrigo Kumpera wrote:
</I>&gt;<i> &gt; Hey guys,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The patch if finally done and it works perfectly well against head.
</I>&gt;<i> &gt; This patch turned to be very different from what it started to look
</I>&gt;<i> &gt; like and fortunately this meant a reduction of more than an order of
</I>&gt;<i> &gt; magnitude in its size, from 3.000 lines to a bit more than 230.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; To have the patch make sense I need to first define what it fixes.
</I>&gt;<i> &gt; Right now mono treat the generic type definition and the open
</I>&gt;<i> &gt; instantiation over its own parameters (or just open instantiation from
</I>&gt;<i> &gt; now on) as two different classes. For example, given the type &quot;class
</I>&gt;<i> &gt; Example&lt;T,M&gt;&quot;, the generic type definition is &quot;Example`2&quot; and the open
</I>&gt;<i> &gt; instantiation is &quot;Example`2&lt;T,M&gt;&quot; where T and M are the parameters of
</I>&gt;<i> &gt; Example`2. If that doesn't make much sense, the following code might
</I>&gt;<i> &gt; help:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Type gtd = typeof (Example&lt;,&gt;);
</I>&gt;<i> &gt; Type openInst = gtd.MakeGenericType (gtd.GetGenericArguments
</I>&gt;<i> &gt; ()); //openInst and gtd should be the same instance
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This property is very important for all parts of mono that play with
</I>&gt;<i> &gt; raw (non inflated) generic code. Analyzing the IL of generic code
</I>&gt;<i> &gt; ilustrate this issue well better:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; .class public A`1&lt;T&gt; extends [mscorlib]System.Object
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;     .field  private  !0 fld
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     .method public instance void Example ()
</I>&gt;<i> &gt;     {
</I>&gt;<i> &gt;         .maxstack 2
</I>&gt;<i> &gt;         .locals init (
</I>&gt;<i> &gt;             !T      V_0)
</I>&gt;<i> &gt;         ldarg.0
</I>&gt;<i> &gt;         ldfld !0 class A`1&lt;!0&gt;::fld
</I>&gt;<i> &gt;         stloc.0
</I>&gt;<i> &gt;         ret
</I>&gt;<i> &gt;     }
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The current situation is that the non-inflated method Example will be
</I>&gt;<i> &gt; bound to a different MonoClass instance than the token of ldfld. Which
</I>&gt;<i> &gt; will lead the runtime to view it as an error. Right now only the
</I>&gt;<i> &gt; verifier is affected by this situation but I think the generics code
</I>&gt;<i> &gt; sharing work might profit from the fix too.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The original idea of how to fix it was to change the this_arg and
</I>&gt;<i> &gt; byref_arg of the MonoClass struct to have type MONO_TYPE_GENERICINST.
</I>&gt;<i> &gt; With that set, when a generic type was initialized, the open
</I>&gt;<i> &gt; instantation MonoGenericClass would be bound to it. This works quite
</I>&gt;<i> &gt; well except that it introduced a lot of issues. The main one that the
</I>&gt;<i> &gt; container_type of generic instantiations would no longer be a
</I>&gt;<i> &gt; MONO_TYPE_CLASS.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; First all code than handled MONO_TYPE_GENERICINST need to be changed
</I>&gt;<i> &gt; to couple with this fact, this required changes across most of
</I>&gt;<i> &gt; metadata and even in mini.c, some places expect a MONO_TYPE_CLASS and
</I>&gt;<i> &gt; don't even guard the retrieval from the data union of MonoType. This
</I>&gt;<i> &gt; led to many hard to spot bugs.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The last issue was with TypeBuilders, the way they are currently set,
</I>&gt;<i> &gt; the associated MonoClass cannot be a MONO_TYPE_GENERICINST until
</I>&gt;<i> &gt; CreateType () is called. Changing (this|byval)_arg.type during
</I>&gt;<i> &gt; mono_reflection_create_runtime_class turned to be a bad idea, as it
</I>&gt;<i> &gt; breaks the invariant that once the MonoClass is first initialized it
</I>&gt;<i> &gt; won't change (this|byval)_arg.type in such drastic way. I had to patch
</I>&gt;<i> &gt; too many places trying to get around this issue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The bottom line is that this approach won't work and the resulting
</I>&gt;<i> &gt; patch would introduce a big chunk of new bugs. In the other hand, the
</I>&gt;<i> &gt; runtime seens to be fine with breaking another premise, that all
</I>&gt;<i> &gt; MonoClass instances bould to MonoGenericClass have type
</I>&gt;<i> &gt; MONO_TYPE_GENERICINST.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This is how it works: when the generic type definition is initialized
</I>&gt;<i> &gt; at the end of either mono_reflection_create_runtime_class or
</I>&gt;<i> &gt; mono_class_setup_mono_type, we lookup the open instantiation and bind
</I>&gt;<i> &gt; it - IOW we set MonoGenericClass::cached_class to the
</I>&gt;<i> &gt; MonoClass instance of the generic type definition.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There is one finall twist on this patch, the way
</I>&gt;<i> &gt; System.Reflection.Emit in mono is incompatible with .net. On mono,
</I>&gt;<i> &gt; TypeBuilder::MakeGenericType returns a Type that is functional (one
</I>&gt;<i> &gt; you can call GetConstructors). This means that you cannot have the
</I>&gt;<i> &gt; same behavior that happens with types loaded from an assembly. To get
</I>&gt;<i> &gt; arround this fact, either I could either &quot;fix&quot; gmcs to work with the
</I>&gt;<i> &gt; crippled .net SRE API, or special case for TypeBuilder. I have choosen
</I>&gt;<i> &gt; the later one as it makes more sense.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This mean that in mono_metadata_lookup_generic_class we check if we
</I>&gt;<i> &gt; are looking up the open instantiation of a TypeBuilder and return a
</I>&gt;<i> &gt; MonoGenericClass than won't be the same for the created type.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What could receive some love in the patch is the way the check for the
</I>&gt;<i> &gt; TypeBuilder is done could be optimized by doing pre-calculating it in
</I>&gt;<i> &gt; mono_metadata_get_generic_inst. This could be done if you guys find
</I>&gt;<i> &gt; that's a good idea, I'm just not sure if it's work the trouble. Right
</I>&gt;<i> &gt; now the tests are using NUnit, maybe some should be moved to the
</I>&gt;<i> &gt; regression suite.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Rodrigo
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070925/06aa52f6/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070925/06aa52f6/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025049.html">[Mono-dev] [PATCH] Generic Type Definition / Open	Instantiation	mismatch patch.
</A></li>
	<LI>Next message: <A HREF="025004.html">[Mono-dev] Is AJAX ready
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25060">[ date ]</a>
              <a href="thread.html#25060">[ thread ]</a>
              <a href="subject.html#25060">[ subject ]</a>
              <a href="author.html#25060">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
