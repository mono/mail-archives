<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Question on the C-&gt;C# translation of WinApi MSG struct.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Question%20on%20the%20C-%3EC%23%20translation%20of%20WinApi%20MSG%20struct.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025006.html">
   <LINK REL="Next"  HREF="025010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG struct.</H1>
    <B>StApostol</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Question%20on%20the%20C-%3EC%23%20translation%20of%20WinApi%20MSG%20struct.&In-Reply-To="
       TITLE="[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG struct.">stapostol at gmail.com
       </A><BR>
    <I>Sat Sep 22 04:42:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="025006.html">[Mono-dev] Is AJAX ready
</A></li>
        <LI>Next message: <A HREF="025010.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25005">[ date ]</a>
              <a href="thread.html#25005">[ thread ]</a>
              <a href="subject.html#25005">[ subject ]</a>
              <a href="author.html#25005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am writing OpenTK, a game development toolkit which makes extensive use of
P/Invoke calls. On the Windows platform, I encountered some strange behavior
regarding the MSG struct.

In winuser.h, MSG is defined like this:

typedef struct tagMSG {
  HWND hwnd;
  UINT message;
  WPARAM wParam;
  LPARAM lParam;
  DWORD time;
  POINT pt;
#ifdef _MAC
  DWORD lPrivate;
#endif
} MSG;

The C# equivalent, as suggested at the .Net dev forums, would look like
this:

[StructLayout(LayoutKind.Sequential), CLSCompliant(false)]
public struct MSG
{
  public IntPtr HWnd;
  public WindowMessage Message;
  public IntPtr WParam;
  public IntPtr LParam;
  public uint Time;
  public POINT Point;

  public override string ToString()
  {
      return String.Format(&quot;msg=0x{0:x} ({1}) hwnd=0x{2:x} wparam=0x{3:x}
lparam=0x{4:x} pt=0x{5:x}&quot;, (int)Message, Message.ToString(), HWnd.ToInt32(),
WParam.ToInt32(), LParam.ToInt32(), Point);
  }
}

However, Mono's implementation in xplatui adds one more field to the struct:

[StructLayout(LayoutKind.Sequential), CLSCompliant(false)]
public struct MSG
{
  public IntPtr HWnd;
  public WindowMessage Message;
  public IntPtr WParam;
  public IntPtr LParam;
  public uint Time;
  public POINT Point;

  public object RefObject;

  public override string ToString()
  {
       return String.Format(&quot;msg=0x{0:x} ({1}) hwnd=0x{2:x} wparam=0x{3:x}
lparam=0x{4:x} pt=0x{5:x}&quot;, (int)Message, Message.ToString(), HWnd.ToInt32(),
WParam.ToInt32(), LParam.ToInt32(), Point);
  }
}
My guess is that it is used for some kind of synchronization, but will this
not corrupt the stack? Both seem to work correctly for extended periods of
time on both 32- and 64-bit platforms, which I find a little strange. Which
is the correct one? What is RefObject doing there?

Thanks,

Stephen A
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070922/59a3288b/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070922/59a3288b/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025006.html">[Mono-dev] Is AJAX ready
</A></li>
	<LI>Next message: <A HREF="025010.html">[Mono-dev] Question on the C-&gt;C# translation of WinApi MSG	struct.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25005">[ date ]</a>
              <a href="thread.html#25005">[ thread ]</a>
              <a href="subject.html#25005">[ subject ]</a>
              <a href="author.html#25005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
