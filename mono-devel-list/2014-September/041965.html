<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] a set of tests to find out the difference between .Net and Mono implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20a%20set%20of%20tests%20to%20find%20out%20the%20difference%20between%0A%20.Net%20and%20Mono%20implementation&In-Reply-To=%3C49473CAD-F0C0-40A0-A979-C01675DF7B89%40vt.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041970.html">
   <LINK REL="Next"  HREF="041969.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20a%20set%20of%20tests%20to%20find%20out%20the%20difference%20between%0A%20.Net%20and%20Mono%20implementation&In-Reply-To=%3C49473CAD-F0C0-40A0-A979-C01675DF7B89%40vt.edu%3E"
       TITLE="[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation">jonpryor at vt.edu
       </A><BR>
    <I>Tue Sep 16 16:31:37 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041970.html">[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation
</A></li>
        <LI>Next message: <A HREF="041969.html">[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41965">[ date ]</a>
              <a href="thread.html#41965">[ thread ]</a>
              <a href="subject.html#41965">[ subject ]</a>
              <a href="author.html#41965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sep 16, 2014, at 6:10 AM, &#20309;&#23376;&#26480;Hzj_jie &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">hzj_jie at hotmail.com</A>&gt; wrote:
&gt;<i> 1. GC
</I>&gt;<i> thought GC.Collect() does not guarantee all the inaccessible objects are finalized and reclaimed, .Net implementation usually be able to delete all the inaccessible objects.
</I>&gt;<i> impacts, delegate_pinning_test, it make sure the delegate / event in .net will release the object after itself has been released.
</I>&gt;<i> weak_pointer_test, weak_pointer is a simple wrapper of WeakReference, which is strong-typed.
</I>&gt;<i> event_disposer_test, event_disposer is a strong-typed pointer, which provide disposing event when disposing.
</I>&gt;<i> lifetime_binder_test, lifetime_binder is a collection to avoid the object to be finalized.
</I>
Developers need to write tests for finalizers, and writing tests for finalizers can be tricky for a variety of reasons. As such, it is quite possible that a GC-related test that &quot;works&quot; on .NET won't work on Mono w/o change.

If you want to test your class' finalizer, then you need to use two threads + WeakReference:

	WeakReference r = null;
	var t = new Thread (() =&gt; {
		var v = new ClassToTest ();
		r = new WeakReference (t);
	});
	t.Start ();
	t.Join ();
	GC.Collect ();
	GC.WaitForPendingFinalizers ();

	// can now [0] check r.IsAlive, etc.

The reason you create the instance + WeakReference on another thread is because Mono's GC will *conservatively* scan the thread's heap looking for valid references. By using a new thread *which exits*, the conservative stack scan will &quot;skip&quot; the exited thread, and thus won't find any valid references to the allocated instance. This in turn allows you to use the WeakReference to determine if the instance has in fact been collected. (Or not, if your ClassToTest registers itself with some static collection or something...)

 - Jon

[0]: <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=20503">https://bugzilla.xamarin.com/show_bug.cgi?id=20503</A>

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041970.html">[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation
</A></li>
	<LI>Next message: <A HREF="041969.html">[Mono-dev] a set of tests to find out the difference between .Net and Mono implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41965">[ date ]</a>
              <a href="thread.html#41965">[ thread ]</a>
              <a href="subject.html#41965">[ subject ]</a>
              <a href="author.html#41965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
