<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Possible bugs in tramp-amd64.c when addresses span 4Gb	boundary
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Possible%20bugs%20in%20tramp-amd64.c%20when%20addresses%20span%204Gb%0A%09boundary&In-Reply-To=%3C5421452F.9060700%40saillune.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="041974.html">
   <LINK REL="Next"  HREF="041996.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Possible bugs in tramp-amd64.c when addresses span 4Gb	boundary</H1>
    <B>Ben Carter</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Possible%20bugs%20in%20tramp-amd64.c%20when%20addresses%20span%204Gb%0A%09boundary&In-Reply-To=%3C5421452F.9060700%40saillune.net%3E"
       TITLE="[Mono-dev] Possible bugs in tramp-amd64.c when addresses span 4Gb	boundary">benml at saillune.net
       </A><BR>
    <I>Tue Sep 23 10:02:23 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="041974.html">[Mono-dev] MonoDevelop not retrieving object values from debug	agent
</A></li>
        <LI>Next message: <A HREF="041996.html">[Mono-dev] Possible bugs in tramp-amd64.c when addresses span	4Gb boundary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41995">[ date ]</a>
              <a href="thread.html#41995">[ thread ]</a>
              <a href="subject.html#41995">[ subject ]</a>
              <a href="author.html#41995">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
  Hi,

  I've been looking into a bug that I've encountered running Mono on a 
64-bit x86 system - specifically, where the &quot;((code - start) &lt; buf_len)&quot; 
assert in mono_arch_get_static_rgctx_trampoline() fires. This seems to 
be a result of this code:

if ((((guint64)addr) &gt;&gt; 32) == 0)
	buf_len = 16;
else
	buf_len = 30;

...which assumes that if the destination address is &lt;4Gb then a 32-bit 
jump will be used, which isn't true if the code being generated is more 
than ~2Gb away.

  Looking further into this, I found that this pattern appears elsewhere 
in tramp-amd64.c as well - and may explain another problem I've been 
seeing where trampolines get &quot;randomly&quot; corrupted to point to 
nonsensical addresses.

  Specifically, what I think is happening there is that 
mono_arch_create_specific_trampoline() is creating the trampoline, and 
that at the time of creation the target address is within a 32-bit jump 
from the source, so it generates a regular 32-bit CALL.

  However, mono_arch_patch_callsite() appears to only check for the 
target address being &gt;4Gb when patching, meaning that it can (as far as 
I can see) end up doing a 32-bit InterlockedExchange() that truncates 
the offset in the case where the target is too far away. This would then 
result in what I'm seeing, which is that the trampoline code is 
well-formed by the target of the CALL is non-executable memory with 
nothing in it.

  Does this sound like a reasonable hypothesis? Or is there something 
that I'm missing about how trampolines operate that means that offsets 
of this nature shouldn't occur in the first place?

  Thanks for any ideas or advice!
-- 
  Ben Carter - <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ben at saillune.net</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="041974.html">[Mono-dev] MonoDevelop not retrieving object values from debug	agent
</A></li>
	<LI>Next message: <A HREF="041996.html">[Mono-dev] Possible bugs in tramp-amd64.c when addresses span	4Gb boundary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41995">[ date ]</a>
              <a href="thread.html#41995">[ thread ]</a>
              <a href="subject.html#41995">[ subject ]</a>
              <a href="author.html#41995">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
