<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Marshaling bools native-&gt;managed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Marshaling%20bools%20native-%3Emanaged&In-Reply-To=295e750a0902111629w7af0eccbl4537ddc246baf46e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030968.html">
   <LINK REL="Next"  HREF="031006.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Marshaling bools native-&gt;managed</H1>
    <B>Bill Holmes</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Marshaling%20bools%20native-%3Emanaged&In-Reply-To=295e750a0902111629w7af0eccbl4537ddc246baf46e%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Marshaling bools native-&gt;managed">billholmes54 at gmail.com
       </A><BR>
    <I>Thu Feb 12 11:13:30 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030968.html">[Mono-dev] [PATCH] Marshaling bools native-&gt;managed
</A></li>
        <LI>Next message: <A HREF="031006.html">[Mono-dev] [PATCH] Marshaling bools native-&gt;managed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31004">[ date ]</a>
              <a href="thread.html#31004">[ thread ]</a>
              <a href="subject.html#31004">[ subject ]</a>
              <a href="author.html#31004">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

After discussing this patch with Zoltan last night on IRC we decided
to make two variations of this patch.  One for the trunk and one for
the 2.4 branch.  The reasoning being that we should not change the
default behavior of marshaling bools from native to managed this close
to the branch release.  For the trunk patch we will now marshal bools
as 32-bit integers by default and for the branch we will continue to
marshal bools as bytes as it has been done in the past.  In both
patches if a MarshalAs attribute is specified it will now be
processed.

This patch does affect all calls from native to managed that include
bool arguments and is not exclusive to COM.

-bill

trunk:
2009-02-13  Bill Holmes  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">billholmes54 at gmail.com</A>&gt;

	* object-internals.h : Fixing a typo in the
	  MonoReflectionComVisibleAttribute struct.

	* marshal.c (cominterop_com_visible): Check the implemented
	  interfaces for ComImport.

	* marshal.c (cominterop_get_native_wrapper_adjusted): For COM calls
	  assume that bools should be treated as VARIANTBOOLs.

	* marshal.c (emit_marshal_boolean): Adding cases for
	  MARSHAL_ACTION_MANAGED_CONV_IN and MARSHAL_ACTION_MANAGED_CONV_OUT.

	* marshal.c (mono_marshal_emit_managed_wrapper): Adding calls to
	  emit_marshal MARSHAL_ACTION_MANAGED_CONV_IN and OUT for bools.

	* marshal.c (cominterop_get_ccw): For COM calls assume that bools
	  should be treated as VARIANTBOOLs.	

	Code is contributed under MIT/X11 license.

branch:
2009-02-13  Bill Holmes  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">billholmes54 at gmail.com</A>&gt;

	Backport of r(fill in later).  This is a safer variant of the
	  trunk for the 2.4 branch. The default in emit_marshal_boolean
	  for this version is I1.

	* object-internals.h : Fixing a typo in the
	  MonoReflectionComVisibleAttribute struct.

	* marshal.c (cominterop_com_visible): Check the implemented
	  interfaces for ComImport.

	* marshal.c (cominterop_get_native_wrapper_adjusted): For COM calls
	  assume that bools should be treated as VARIANTBOOLs.

	* marshal.c (emit_marshal_boolean): Adding cases for
	  MARSHAL_ACTION_MANAGED_CONV_IN and MARSHAL_ACTION_MANAGED_CONV_OUT.

	* marshal.c (mono_marshal_emit_managed_wrapper): Adding calls to
	  emit_marshal MARSHAL_ACTION_MANAGED_CONV_IN and OUT for bools.

	* marshal.c (cominterop_get_ccw): For COM calls assume that bools
	  should be treated as VARIANTBOOLs.	

	Code is contributed under MIT/X11 license.

On Wed, Feb 11, 2009 at 7:29 PM, Zoltan Varga &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vargaz at gmail.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>  This looks ok, I'm just concerned that the new code will be run even
</I>&gt;<i> in non-com situations,
</I>&gt;<i> and it might cause problems, like it uses CEE_LDIND_I4 to load a bool value.
</I>&gt;<i>
</I>&gt;<i>                   Zoltan
</I>&gt;<i>
</I>&gt;<i> 2009/2/12 Bill Holmes &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">billholmes54 at gmail.com</A>&gt;:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The attached patch fixes some problems we are seeing with marshaling
</I>&gt;&gt;<i> bools and IDspatch types in Native code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can split the patch separating the bool changes form the dispatch
</I>&gt;&gt;<i> changes if needed.  I would like to apply this to the 2.4 branch as
</I>&gt;&gt;<i> well.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -bill
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2009-02-12  Bill Holmes  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">billholmes54 at gmail.com</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * object-internals.h : Fixing a typo in the
</I>&gt;&gt;<i>          MonoReflectionComVisibleAttribute struct.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * marshal.c (cominterop_com_visible): Check the implemented
</I>&gt;&gt;<i>          interfaces for ComImport.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * marshal.c (cominterop_get_native_wrapper_adjusted): For COM calls
</I>&gt;&gt;<i>          assume that bools should be treated as VARIANTBOOLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * marshal.c (emit_marshal_boolean): Adding cases for
</I>&gt;&gt;<i>          MARSHAL_ACTION_MANAGED_CONV_IN and MARSHAL_ACTION_MANAGED_CONV_OUT.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * marshal.c (mono_marshal_emit_managed_wrapper): Adding calls to
</I>&gt;&gt;<i>          emit_marshal MARSHAL_ACTION_MANAGED_CONV_IN and OUT for bools.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        * marshal.c (cominterop_get_ccw): For COM calls assume that bools
</I>&gt;&gt;<i>          should be treated as VARIANTBOOLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        Code is contributed under MIT/X11 license.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Native_To_Managed_Bools.patch
Type: text/x-patch
Size: 6548 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090212/359a15b5/attachment-0002.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090212/359a15b5/attachment-0002.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Native_To_Managed_Bools_For_2-4.patch
Type: text/x-patch
Size: 6667 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090212/359a15b5/attachment-0003.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090212/359a15b5/attachment-0003.bin</A> 
</PRE>







































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030968.html">[Mono-dev] [PATCH] Marshaling bools native-&gt;managed
</A></li>
	<LI>Next message: <A HREF="031006.html">[Mono-dev] [PATCH] Marshaling bools native-&gt;managed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31004">[ date ]</a>
              <a href="thread.html#31004">[ thread ]</a>
              <a href="subject.html#31004">[ subject ]</a>
              <a href="author.html#31004">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
