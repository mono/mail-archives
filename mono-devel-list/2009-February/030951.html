<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for IntPtr bug
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20IntPtr%20bug&In-Reply-To=E961123C01E7E94AA29163941172913E078DE958%40mail1.dundee.realtimeworlds.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030950.html">
   <LINK REL="Next"  HREF="030955.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for IntPtr bug</H1>
    <B>russell.kay at realtimeworlds.com</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20IntPtr%20bug&In-Reply-To=E961123C01E7E94AA29163941172913E078DE958%40mail1.dundee.realtimeworlds.com"
       TITLE="[Mono-dev] Patch for IntPtr bug">russell.kay at realtimeworlds.com
       </A><BR>
    <I>Wed Feb 11 11:02:00 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030950.html">[Mono-dev] Patch for IntPtr bug
</A></li>
        <LI>Next message: <A HREF="030955.html">[Mono-dev] Patch for IntPtr bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30951">[ date ]</a>
              <a href="thread.html#30951">[ thread ]</a>
              <a href="subject.html#30951">[ subject ]</a>
              <a href="author.html#30951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Replying to myself here

Using the output from this small program

using System;

namespace ConsoleApplication4
{
    enum Ptr : long
    {
    }

    class Program
    {
        static unsafe void Main(string[] args)
        {
            IntPtr test = new IntPtr(0xffffffff);
            Ptr testLong = (Ptr)test.ToInt64();
            Console.WriteLine(&quot;test = {0}, testLong={1}&quot;, test,
testLong);
            IntPtr testAnother = (IntPtr)testLong;
            Console.WriteLine(&quot;testAnother = {0}&quot;, testAnother);
            void* p = test.ToPointer();
            Console.WriteLine(&quot;p = {0}&quot;, (long)p);
        }
    }
}

You will see that under MS.NET the output is 

test = 4294967295, testLong=4294967295
testAnother = 4294967295
p = 4294967295

note the complete absence of sign extended values.

The output from Mono on OpenSuse 11.0 Linux

test = -1, testLong=-1
testAnother = -1
p = 4294967295

So the pointer conversion from void* to long is not sign extending under
Mono, and it is different output to MS.NET.

Russell

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">russell.kay at realtimeworlds.com</A>
Sent: 11 February 2009 15:45
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Patch for IntPtr bug

We get addresses on Linux that are &gt;2Gb from malloc in the native code,
if we go through the conversion from int (i.e.)IntPtr.ToInt64() is not
giving a sign extended value back when this happens and then a cast to
IntPtr will fail. The cast from a pointer i.e. void* or byte* will also
not sign extend the long.

The conversion is not sign extending the long (perhaps because it does
actually fit)...

My patch is correct.

Russell

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Robert
Jordan
Sent: 11 February 2009 15:24
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] Patch for IntPtr bug

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">russell.kay at realtimeworlds.com</A> wrote:

&gt;<i> I encountered a problem when casting a long to an IntPtr, which is
</I>&gt;<i> something we have ended up doing a lot (we want to keep binary
</I>assembly
&gt;<i> compatibility between x86 and x64, only changing the native code on
</I>the
&gt;<i> different architectures). We encountered a problem with Mono as there
</I>&gt;<i> has been a check introduced into the IntPtr constructor from a long,
</I>&gt;<i> this is checking the range of the long to ensure it is in range,
</I>&gt;<i> unfortunately the check is incorrect. A long can easily hold from
</I>&gt;<i> Int32.MinValue to UInt32.MaxValue (and not Int32.MaxValue as it
</I>&gt;<i> currently in there).
</I>&gt;<i> 
</I>
The patch is wrong, since casting a long &gt; Int32.MaxValue to a
4 byte signed intptr is simply invalid.

The current check in IntPtr.cs also matches MS.NET.

Robert

_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>

____________________________________________________________________
This email has been scanned by the MessageLabs Email Security System

____________________________________________________________________
DISCLAIMER

This message and any attachments contain privileged and confidential
information intended for the use of the addressee named above. If you
are not the intended recipient of this message, you are hereby notified
that any use, dissemination, distribution or reproduction of this
message is prohibited. Please note that we cannot guarantee that this
message or any attachment is virus free or that it has not been
intercepted and amended. The views of the author may not necessarily
reflect those of Realtime Worlds Ltd.

 

Realtime Worlds Ltd is registered in Scotland, number 225628. Registered
Office: 152 West Marketgait, Dundee, DD1 1NJ.
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>

____________________________________________________________________
This email has been scanned by the MessageLabs Email Security System

____________________________________________________________________
DISCLAIMER

This message and any attachments contain privileged and confidential information intended for the use of the addressee named above. If you are not the intended recipient of this message, you are hereby notified that any use, dissemination, distribution or reproduction of this message is prohibited. Please note that we cannot guarantee that this message or any attachment is virus free or that it has not been intercepted and amended. The views of the author may not necessarily reflect those of Realtime Worlds Ltd.

 

Realtime Worlds Ltd is registered in Scotland, number 225628. Registered Office: 152 West Marketgait, Dundee, DD1 1NJ.
</PRE>








































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030950.html">[Mono-dev] Patch for IntPtr bug
</A></li>
	<LI>Next message: <A HREF="030955.html">[Mono-dev] Patch for IntPtr bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30951">[ date ]</a>
              <a href="thread.html#30951">[ thread ]</a>
              <a href="subject.html#30951">[ subject ]</a>
              <a href="author.html#30951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
