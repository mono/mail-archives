<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Thread shutdown hook patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Thread%20shutdown%20hook%20patch&In-Reply-To=20090211145526.GD32523%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030945.html">
   <LINK REL="Next"  HREF="030919.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Thread shutdown hook patch</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Thread%20shutdown%20hook%20patch&In-Reply-To=20090211145526.GD32523%40debian.org"
       TITLE="[Mono-dev] Thread shutdown hook patch">kumpera at gmail.com
       </A><BR>
    <I>Wed Feb 11 15:10:00 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="030945.html">[Mono-dev] Thread shutdown hook patch
</A></li>
        <LI>Next message: <A HREF="030919.html">[Mono-dev]  Trouble running subversion builds in OSX
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30962">[ date ]</a>
              <a href="thread.html#30962">[ thread ]</a>
              <a href="subject.html#30962">[ subject ]</a>
              <a href="author.html#30962">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 11, 2009 at 12:55 PM, Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; wrote:

&gt;<i> On 02/09/09 Rodrigo Kumpera wrote:
</I>&gt;<i> &gt; &gt; The attached patch adds a new hook to allow threads to shutdown after
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; GC finalizer has finished.
</I>&gt;<i> &gt; &gt; The motivation for it is to improve profiler's reliability at shutdown
</I>&gt;<i> &gt; &gt; time.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The new callback notifies the thread when regular shutdown starts and
</I>&gt;<i> gives
</I>&gt;<i> &gt; &gt; it a change to not
</I>&gt;<i> &gt; &gt; finish at this time.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Later on the same callback is used to notify the thread that the last
</I>&gt;<i> stage
</I>&gt;<i> &gt; &gt; in the shutdown sequence
</I>&gt;<i> &gt; &gt; has been reached and it must shutdown.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The callback is per-thread as I don't want to have tools like the
</I>&gt;<i> profiler
</I>&gt;<i> &gt; &gt; messing up with embedded users.
</I>&gt;<i>
</I>&gt;<i> I think this instroduces too much complexity: since the API is public
</I>&gt;<i> we'd need to end up maintaining the semantics as they happen to be now.
</I>&gt;<i> It would be much clearer to have a flag on the thread that behaves
</I>&gt;<i> similarly to critical finalizers: the thread that has it set will be
</I>&gt;<i> destroyed as late as possible on shutdown.
</I>&gt;<i> As for the callback, the existing mono_profiler_thread_end () should be
</I>&gt;<i> enough: if it isn't we need to discuss how we can fix that instead of
</I>&gt;<i> adding yet another callback.
</I>&gt;<i>
</I>&gt;<i> lupus
</I>&gt;<i>
</I>&gt;<i>
</I>
Let's see, to make what you propose work we would have to do the following
changes:

1) Introduce a flag to signal critical threads, which are only shutdown at
the last possible opportunity;
  Together with a mono_thread_set_critical (MonoThread*) public API to set
it, or course.

2) Move the profiler shutdown to mono_runtime_cleanup so it happens before
we wait for critical threads;
  This is required because the thread shutdown code has no means to ask
unmanaged code to shutdown.

A critical thread is one that

mono_profiler_thread_end doesn't play any role for this issue because it is
called once the thread has finished or detached,
which is not the issue here.

With this patch the code in the profiler gets simpler and more natural.
Everything is done from the profiler shutdown hook and
not piece by piece scattered around.

There is one issue with this patch, there is no unmanaged mechanism to
inform a thread that it must shutdown. Right now this isn't
an issue because the only user will be the profiller and it does all it's
cleanup from the shutdown hook. But it might not be the case
for embedders attaching critical threads.

I don't think this is an usable API without a well defined mechanism to let
embedders/tools know when it's time for a critical thread
to begin to shutdown.

The attached patch implements this proposal, please review.

Cheers,
Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090211/1b153b2c/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090211/1b153b2c/attachment.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: shutdown_take4.diff
Type: text/x-diff
Size: 6024 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090211/1b153b2c/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090211/1b153b2c/attachment.bin</A> 
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030945.html">[Mono-dev] Thread shutdown hook patch
</A></li>
	<LI>Next message: <A HREF="030919.html">[Mono-dev]  Trouble running subversion builds in OSX
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30962">[ date ]</a>
              <a href="thread.html#30962">[ thread ]</a>
              <a href="subject.html#30962">[ subject ]</a>
              <a href="author.html#30962">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
