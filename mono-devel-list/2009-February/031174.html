<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono.SIMD
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono.SIMD&In-Reply-To=22116483.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031167.html">
   <LINK REL="Next"  HREF="031146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono.SIMD</H1>
    <B>Alan McGovern</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono.SIMD&In-Reply-To=22116483.post%40talk.nabble.com"
       TITLE="[Mono-dev] Mono.SIMD">alan.mcgovern at gmail.com
       </A><BR>
    <I>Mon Feb 23 05:41:49 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031167.html">[Mono-dev]  Mono.SIMD
</A></li>
        <LI>Next message: <A HREF="031146.html">[Mono-dev] monodevelop! congratulations!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31174">[ date ]</a>
              <a href="thread.html#31174">[ thread ]</a>
              <a href="subject.html#31174">[ subject ]</a>
              <a href="author.html#31174">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

The big issue you're having is that you haven't implemented a SIMD algorithm
;) I spent 15 mins 'optimising' your code and came up with this. Notice that
I made everything a SIMD operation. There is no scalar code in the method
anymore. This tripled performance as compared to the non-SIMD version. On my
machine:

-FLOAT 00:00:00.3888930 Color
-SIMD   00:00:00.1266820 Mono.Simd.Vector4f

You'd want to double check the result just in case I made a mistake with my
alterations.

Alan.

        public static Vector4f GradientSIMD()
        {
            Vector4f finv_WH = new Vector4f (1.0f / (w*h), 1.0f / (w*h),
1.0f / (w*h), 1.0f / (w*h));
            Vector4f ret = new Vector4f();

            Vector4f a = new Vector4f(0.0f, 0.0f, 1.0f, 1.0f);
            a += new Vector4f(0.0f, 1.0f, 0.0f, 1.0f);
            a += new Vector4f(1.0f, 0.0f, 0.0f, 1.0f);
            a += new Vector4f(0.5f, 0.5f, 1.0f, 1.0f);

            //Process operator
            Vector4f yVec = new Vector4f (h, h, 0, 0);
            Vector4f yDiff = new Vector4f (-1, -1, 1, 1);
            for (int y=0; y&lt;h; y++)
            {
                Vector4f factor = yVec * finv_WH;
                yVec += yDiff;

                Vector4f xVec = new Vector4f (w, 0, w, 0);
                Vector4f xDiff = new Vector4f (-1, 1, -1, 1);
                for (int x=0; x&lt;w; x++)
                {
                    ret += (a * xVec * factor);
                    xVec += xDiff;
                }
            }
            return ret;
        }

On Fri, Feb 20, 2009 at 8:12 AM, Johann_fxgen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jnadalutti at gmail.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> I have done some performance tests of SIMD under windows.
</I>&gt;<i>
</I>&gt;<i> Results tests in ms:
</I>&gt;<i> In MS C         235   (Visual Studio Release Mode With SIMD)
</I>&gt;<i> In MS C         360   (Visual Studio Release Mode With 4D Float)
</I>&gt;<i> In Mono C#    453   (With Mono SIMD)
</I>&gt;<i> In Mono C#    562   (With Mono 4D Float)
</I>&gt;<i> In MS C#       609   (Visual Studio With 4D Float)
</I>&gt;<i> In MS C         672   (Visual Studio Debug Mode)
</I>&gt;<i>
</I>&gt;<i> I'm just surprise by difference between C SIMD and mono SIMD version.
</I>&gt;<i>
</I>&gt;<i> Is Mono.SIMD under linux speeder than under windows ?
</I>&gt;<i>
</I>&gt;<i> Johann.
</I>&gt;<i>
</I>&gt;<i> My mono code for test:
</I>&gt;<i>
</I>&gt;<i>        using Mono.Simd;
</I>&gt;<i>        using System;
</I>&gt;<i>        using Mono;
</I>&gt;<i>
</I>&gt;<i>        public struct Color
</I>&gt;<i>        {
</I>&gt;<i>                public float r,g,b,a;
</I>&gt;<i>        };
</I>&gt;<i>
</I>&gt;<i>        public class TestMonoSIMD
</I>&gt;<i>        {
</I>&gt;<i>                public  Color m_pixels;
</I>&gt;<i>                const int w = 4096;
</I>&gt;<i>                const int h = 4096;
</I>&gt;<i>
</I>&gt;<i>                public static void Main ()
</I>&gt;<i>                {
</I>&gt;<i>                        //Debug
</I>&gt;<i>                        Console.WriteLine(&quot;AccelMode: {0}&quot;,
</I>&gt;<i> Mono.Simd.SimdRuntime.AccelMode );
</I>&gt;<i>
</I>&gt;<i>                        //Without SIMD
</I>&gt;<i>                        DateTime start1 = DateTime.Now;
</I>&gt;<i>                        Color ret1 = Gradient();
</I>&gt;<i>                        TimeSpan ts1 = DateTime.Now - start1;
</I>&gt;<i>                        Console.WriteLine(&quot;-FLOAT {0} {1}&quot;, ts1, ret1);
</I>&gt;<i>
</I>&gt;<i>                        //With SIMD
</I>&gt;<i>                        DateTime start2 = DateTime.Now;
</I>&gt;<i>                        Vector4f ret2 = GradientSIMD();
</I>&gt;<i>                        TimeSpan ts2 = DateTime.Now - start2;
</I>&gt;<i>                        Console.WriteLine(&quot;-SIMD  {0} {1}&quot;, ts2, ret2);
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                public static Color Gradient()
</I>&gt;<i>                {
</I>&gt;<i>                        float finv_WH = 1.0f / (float)(w*h);
</I>&gt;<i>                        Color ret = new Color();
</I>&gt;<i>                        ret.r=ret.g=ret.b=ret.a=0.0f;
</I>&gt;<i>
</I>&gt;<i>                        Color a = new Color();
</I>&gt;<i>                        Color b = new Color();
</I>&gt;<i>                        Color c = new Color();
</I>&gt;<i>                        Color d = new Color();
</I>&gt;<i>                        a.r=0.0f;       a.g=0.0f; a.b=1.0f; a.a=1.0f;
</I>&gt;<i>                        b.r=0.0f;       b.g=1.0f; b.b=0.0f; b.a=1.0f;
</I>&gt;<i>                        c.r=1.0f;       c.g=0.0f; c.b=0.0f; c.a=1.0f;
</I>&gt;<i>                        d.r=0.5f;       d.g=0.5f; d.b=1.0f; d.a=1.0f;
</I>&gt;<i>
</I>&gt;<i>                        //Process operator
</I>&gt;<i>                        for (int y=0; y&lt;h; y++)
</I>&gt;<i>                        {
</I>&gt;<i>                                for (int x=0; x&lt;w; x++)
</I>&gt;<i>                                {
</I>&gt;<i>                                        //Calc percent A,B,C,D
</I>&gt;<i>                                        float pa = (float)((w-x)        *
</I>&gt;<i> (h-y)) * finv_WH;
</I>&gt;<i>                                        float pb = (float)((x)          *
</I>&gt;<i> (h-y)) * finv_WH;
</I>&gt;<i>                                        float pc = (float)((w-x)        *
</I>&gt;<i> (y))   * finv_WH;
</I>&gt;<i>                                        float pd = (float)((x)          *
</I>&gt;<i> (y))   * finv_WH;
</I>&gt;<i>
</I>&gt;<i>                                        float cr= ((a.r*pa) + (b.r*pb) +
</I>&gt;<i> (c.r*pc) + (d.r*pd));
</I>&gt;<i>                                        float cg= ((a.g*pa) + (b.g*pb) +
</I>&gt;<i> (c.g*pc) + (d.g*pd));
</I>&gt;<i>                                        float cb= ((a.b*pa) + (b.b*pb) +
</I>&gt;<i> (c.b*pc) + (d.b*pd));
</I>&gt;<i>                                        float ca= ((a.a*pa) + (b.a*pb) +
</I>&gt;<i> (c.a*pc) + (d.a*pd));
</I>&gt;<i>                                        ret.r+=cr;      ret.g+=cg;
</I>&gt;<i>  ret.b+=cb;      ret.a+=ca;
</I>&gt;<i>                                }
</I>&gt;<i>                        }
</I>&gt;<i>                        return ret;
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                public static Vector4f GradientSIMD()
</I>&gt;<i>                {
</I>&gt;<i>                        float finv_WH = 1.0f / (float)(w*h);
</I>&gt;<i>                        Vector4f ret = new Vector4f(0.0f, 0.0f, 0.0f, 0.0f);
</I>&gt;<i>
</I>&gt;<i>                        Vector4f a = new Vector4f(0.0f, 0.0f, 1.0f, 1.0f);
</I>&gt;<i>                        Vector4f b = new Vector4f(0.0f, 1.0f, 0.0f, 1.0f);
</I>&gt;<i>                        Vector4f c = new Vector4f(1.0f, 0.0f, 0.0f, 1.0f);
</I>&gt;<i>                        Vector4f d = new Vector4f(0.5f, 0.5f, 1.0f, 1.0f);
</I>&gt;<i>
</I>&gt;<i>                        //Process operator
</I>&gt;<i>                        Vector4f p = new Vector4f();
</I>&gt;<i>                        Vector4f r = new Vector4f();
</I>&gt;<i>                        for (int y=0; y&lt;h; y++)
</I>&gt;<i>                        {
</I>&gt;<i>                                for (int x=0; x&lt;w; x++)
</I>&gt;<i>                                {
</I>&gt;<i>                                        //Calc percent A,B,C,D
</I>&gt;<i>                                        p.X = (float)((w-x)     * (h-y)) *
</I>&gt;<i> finv_WH;
</I>&gt;<i>                                        p.Y = (float)((x)               *
</I>&gt;<i> (h-y)) * finv_WH;
</I>&gt;<i>                                        p.Z = (float)((w-x)     * (y))   *
</I>&gt;<i> finv_WH;
</I>&gt;<i>                                        p.W = (float)((x)               *
</I>&gt;<i> (y))   * finv_WH;
</I>&gt;<i>
</I>&gt;<i>                                        ret+=a*p + b*p + c*p + d*p;
</I>&gt;<i>                                }
</I>&gt;<i>                        }
</I>&gt;<i>                        return ret;
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> View this message in context:
</I>&gt;<i> <A HREF="http://www.nabble.com/Mono.SIMD-tp22116483p22116483.html">http://www.nabble.com/Mono.SIMD-tp22116483p22116483.html</A>
</I>&gt;<i> Sent from the Mono - Dev mailing list archive at Nabble.com.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090223/5dc931c0/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090223/5dc931c0/attachment-0001.html</A> 
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031167.html">[Mono-dev]  Mono.SIMD
</A></li>
	<LI>Next message: <A HREF="031146.html">[Mono-dev] monodevelop! congratulations!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31174">[ date ]</a>
              <a href="thread.html#31174">[ thread ]</a>
              <a href="subject.html#31174">[ subject ]</a>
              <a href="author.html#31174">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
