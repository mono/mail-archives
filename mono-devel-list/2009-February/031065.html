<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Long term fix for load hook deadlocks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20term%20fix%20for%20load%20hook%20deadlocks&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031150.html">
   <LINK REL="Next"  HREF="031068.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Long term fix for load hook deadlocks</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20term%20fix%20for%20load%20hook%20deadlocks&In-Reply-To="
       TITLE="[Mono-dev] Long term fix for load hook deadlocks">kumpera at gmail.com
       </A><BR>
    <I>Mon Feb 16 10:05:33 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031150.html">[Mono-dev] Win32 sockets regression on trunk.
</A></li>
        <LI>Next message: <A HREF="031068.html">[Mono-dev] ASP.NET MVC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31065">[ date ]</a>
              <a href="thread.html#31065">[ thread ]</a>
              <a href="subject.html#31065">[ subject ]</a>
              <a href="author.html#31065">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

I've spent some time last week on this subject trying to see how this could
be fixed.

My initial idea was to remove the loader lock from all paths that lead to
managed code
been called. Thou it's possible, it would require some very complex changes
to class loading
to support System F recursive type definitions (F : T&lt;F&gt;) in a way to do
safe publishing.

It would buy us more trouble than anything else. Which turned my attention
into fixing ther
other locks instead. Besides the loader lock, only two other are held during
complex interactions
with the system: the domain and domain jit code hash locks.

My idea is to change the locking rules to make the loader lock the bottom
one, this would
make it safe to call managed code while holding it and it's not much
different than what currently
happens.

Both other locks, domain and domain jit code hash are used most of the time
just to protect
resources that are part of MonoDomain.

The issue then would be to rework the part of the runtime that hold the
loader lock together with
the others. All code in metadata can be changed pretty easily as it acquires
one after the other.
The trouble is in mini.c where the interaction between those locks is pretty
complex but changing
it isn't that that hard.

This approach would require us to split all the uses of the loader lock to
protect resources such as the
the uiid table as this is a task for simple locks and might have a bad
interactions with other parts of the
runtime.

Comments?

Cheers,
Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090216/ab1838fc/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090216/ab1838fc/attachment.html</A> 
</PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031150.html">[Mono-dev] Win32 sockets regression on trunk.
</A></li>
	<LI>Next message: <A HREF="031068.html">[Mono-dev] ASP.NET MVC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31065">[ date ]</a>
              <a href="thread.html#31065">[ thread ]</a>
              <a href="subject.html#31065">[ subject ]</a>
              <a href="author.html#31065">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
