<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono 2.4 crashes due to accessing freed data	structures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%202.4%20crashes%20due%20to%20accessing%20freed%20data%0A%09structures&In-Reply-To=200905292014.n4TKEYnh013449%40d12av02.megacenter.de.ibm.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="032302.html">
   <LINK REL="Next"  HREF="032312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%202.4%20crashes%20due%20to%20accessing%20freed%20data%0A%09structures&In-Reply-To=200905292014.n4TKEYnh013449%40d12av02.megacenter.de.ibm.com"
       TITLE="[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures">kumpera at gmail.com
       </A><BR>
    <I>Fri May 29 20:16:51 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="032302.html">[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures
</A></li>
        <LI>Next message: <A HREF="032312.html">[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32303">[ date ]</a>
              <a href="thread.html#32303">[ thread ]</a>
              <a href="subject.html#32303">[ subject ]</a>
              <a href="author.html#32303">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, May 29, 2009 at 5:14 PM, Ulrich Weigand &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">uweigand at de.ibm.com</A>&gt; wrote:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> diff -urNp mono-2.4-orig/mono/metadata/metadata.c
</I>&gt;<i> mono-2.4/mono/metadata/metadata.c
</I>&gt;<i> --- mono-2.4-orig/mono/metadata/metadata.c      2009-02-14
</I>&gt;<i> 00:33:05.000000000 +0100
</I>&gt;<i> +++ mono-2.4/mono/metadata/metadata.c   2009-05-28 20:12:38.000000000 +0200
</I>&gt;<i> @@ -2196,7 +2197,8 @@ inflated_method_in_image (gpointer key,
</I>&gt;<i>        // <A HREF="https://bugzilla.novell.com/show_bug.cgi?id=458168">https://bugzilla.novell.com/show_bug.cgi?id=458168</A>
</I>&gt;<i>        return method-&gt;declaring-&gt;klass-&gt;image == image ||
</I>&gt;<i>                (method-&gt;context.class_inst &amp;&amp; ginst_in_image
</I>&gt;<i> (method-&gt;context.class_inst, image)) ||
</I>&gt;<i> -               (method-&gt;context.method_inst &amp;&amp; ginst_in_image
</I>&gt;<i> (method-&gt;context.method_inst, image)) || signature_in_image
</I>&gt;<i> (mono_method_signature ((MonoMethod*)method), image);
</I>&gt;<i> +               (method-&gt;context.method_inst &amp;&amp; ginst_in_image
</I>&gt;<i> (method-&gt;context.method_inst, image)) ||
</I>&gt;<i> +               (((MonoMethod*)method)-&gt;signature &amp;&amp; signature_in_image
</I>&gt;<i> (((MonoMethod*)method)-&gt;signature, image));
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  static gboolean
</I>&gt;<i>
</I>&gt;<i>
</I>This has been fixed in trunk and 2.4



&gt;<i>
</I>&gt;<i> The second problem is related to wrapper classes allocated by the
</I>&gt;<i> routines in marshal.c.  I've been seeing various instances of crashes
</I>&gt;<i> caused by those routines returning apparently clobbered method structures.
</I>&gt;<i>
</I>&gt;<i> It turns out this was caused by stale entried in the caches maintained
</I>&gt;<i> by the marshal.c routines.  For example, the
</I>&gt;<i> MonoMethod *mono_marshal_get_static_rgctx_invoke (MonoMethod *method)
</I>&gt;<i> routine will store the MonoMethod structure describing the wrapper for
</I>&gt;<i> &quot;method&quot; into a cache allocated on the mempool associated with the
</I>&gt;<i> image related to the method's class.  For &quot;normal&quot; methods, the method
</I>&gt;<i> structure itself was already allocated on that same mempool, so the
</I>&gt;<i> wrapper has identical lifetime as the method it wraps.
</I>&gt;<i>
</I>&gt;<i> However, there is one case where things are more complex: &quot;inflated&quot;
</I>&gt;<i> generic methods.  These are *not* allocated on a mempool, but on the
</I>&gt;<i> heap, and will be freed at a certain point in time.  However, nothing
</I>&gt;<i> ensures that any previously allocated wrapper for such a method is
</I>&gt;<i> also freed at this time.
</I>&gt;<i>
</I>&gt;<i> For the most part, this does not matter much, as the wrapper cache is
</I>&gt;<i> indexed using the address of the MonoMethod structure as key.  If the
</I>&gt;<i> method no longer exists, it isn't looked up, so it doesn't matter that
</I>&gt;<i> a stale value is still in the hash table.
</I>&gt;<i>
</I>&gt;<i> However, it *can* happen that a later allocation of a fresh MonoMethod
</I>&gt;<i> just happens to reside at the same address as a method that was deleted
</I>&gt;<i> previously.  Now, when looking up a wrapper for the new method, the
</I>&gt;<i> stale entry for the old method may indeed be found.  This causes various
</I>&gt;<i> problems; in particular, while the cached wrapper method itself is still
</I>&gt;<i> live, some of the structures it points to (type, signature) may themselves
</I>&gt;<i> have been deleted in the meantime, so random memory may be accessed.
</I>&gt;<i>
</I>&gt;<i> A similar problem seems to occur for dynamic methods, and for those it
</I>&gt;<i> seems special care is taken to remove wrappers for such methods from the
</I>&gt;<i> cache when the method is deleted (mono_marshal_free_dynamic_wrappers).
</I>&gt;<i>
</I>&gt;<i> It looks like a similar approach ought to be taken for inflated methods.
</I>&gt;<i> The following patch implements this.  Again, I'm not complete sure this
</I>&gt;<i> is the right approach, but it fixes the symptoms for me.
</I>&gt;<i>
</I>
Your change isn't required because you only remove from image hash tables,
which are released together with the inflated method.

Can you try OpenSim using mono from the tip of the 2.4 branch?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090529/87953307/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090529/87953307/attachment.html</A> 
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="032302.html">[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures
</A></li>
	<LI>Next message: <A HREF="032312.html">[Mono-dev] Mono 2.4 crashes due to accessing freed data	structures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32303">[ date ]</a>
              <a href="thread.html#32303">[ thread ]</a>
              <a href="subject.html#32303">[ subject ]</a>
              <a href="author.html#32303">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
