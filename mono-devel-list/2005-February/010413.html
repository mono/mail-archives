<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Embedding Mono in a Virtual World
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050210185918.GD23067%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010395.html">
   <LINK REL="Next"  HREF="010443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Embedding Mono in a Virtual World</H1>
    <B>Jim Purbrick</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050210185918.GD23067%40debian.org"
       TITLE="[Mono-devel-list] Embedding Mono in a Virtual World">jimpurbrick at yahoo.co.uk
       </A><BR>
    <I>Fri Feb 11 11:13:24 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010395.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
        <LI>Next message: <A HREF="010443.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10413">[ date ]</a>
              <a href="thread.html#10413">[ thread ]</a>
              <a href="subject.html#10413">[ subject ]</a>
              <a href="author.html#10413">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> --- Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt; wrote: 
&gt;<i> &gt; The easiest way to represent the information would
</I>&gt;<i> &gt; be to build a stack for each script, but could I
</I>mess
&gt;<i> &gt; with the stack pointer to switch stacks or would I
</I>&gt;<i> &gt; have to emulate a stack using heaps and would that
</I>&gt;<i> &gt; be horribly inefficient?
</I>&gt;<i> 
</I>&gt;<i> Not orrible but not very nice either.
</I>
I think this approach generalises to the continuation
based approach used by PicoThreads in Java[1]: you
need to build chains of continuations on the heap that
you can switch between to switch threads, something
that Dan Sugalski suggests is really inefficient and
one of the reasons you might want to use Parrot
instead of the JVM or Mono[2].

&gt;<i> I have no idea what fibers are and how this would
</I>interact
&gt;<i> with the GC and other info the runtime keeps
</I>per-thread.

Fibers are cooperatively scheduled light weight
threads in Win32[3]. The core of the approach boils
down to:

schedule()
{
saveCLRLogicalThreadState(currentThreadState);
switchOSFiber(nextFiber);
restoreCLRLogicalThreadState(nextThreadState);
}

Which is used to keep the logical managed thread state
and fiber in sync. They had some problems with
exceptions using this approach and the logical thread
save and restore methods maybe something that's only
available in Rotor.

&gt;<i> Another option you might want to investigate is to
</I>&gt;<i> use Thread.Suspend (). You'd have a control thread
</I>and
&gt;<i> you'd hand out the scripts to execute to a single
</I>worker
&gt;<i> thread and wait for a timeout. If the script didn't
</I>&gt;<i> finish, the thread is suspended and put on a fifo to
</I>be resumed
&gt;<i> later when you decide it's time to do it. Otherwise
</I>the
&gt;<i> timeout is reset and you make the thread execute
</I>another script.
&gt;<i> This is likely an implementation similar to your
</I>&gt;<i> current code.
</I>
Yes, this sounds interesting and potentially a good
approach. Once you suspended the thread you'd just
start a new thread to execute the next script before
you resumed the last script.

&gt;<i> The tricky issue here is the exact time you suspend
</I>&gt;<i> and long running script. This is likely to cause
</I>deadlocks if
&gt;<i> not handled carefully.
</I>
All the scripts are independent, only communicating
with the engine via library calls, so as long as the
threads didn't suspend duing an interop call, this
should be fine.

&gt;<i> It should be pretty safe if you inject in the user
</I>code checks for a
&gt;<i> global var that signals the event
</I>
Couldn't I just call Thread.Suspend from the main
thread after the timeout? 

&gt;<i> The Suspend method is marked obsolete in 2.0,
</I>&gt;<i> because of the potential for deadlocks, but using it
</I>this way should
&gt;<i> be safe.
</I>
Will I still be able to use this approach with future
versions of Mono then?

&gt;<i> Since most of the scripts should terminate within
</I>&gt;<i> the timeout, if I understood correctly, you should
</I>just have a number
&gt;<i> of threads created as many as the slow scripts 
</I>
Yes, as all bar one of the threads would be suspended
that presumably wouldn't cause any context switching
problems. The only problem would be that each
suspended thread would still have a full OS thread
stack, so might burn a pile of memory.

[1] www.cs.berkeley.edu/~jmacd/cs262.pdf
[2]
<A HREF="http://www.sidhe.org/~dan/blog/archives/000157.html">http://www.sidhe.org/~dan/blog/archives/000157.html</A>
[3] <A HREF="http://msdn.microsoft.com/msdnmag/issues/03/09/CoroutinesinNET/default.aspx">http://msdn.microsoft.com/msdnmag/issues/03/09/CoroutinesinNET/default.aspx</A>


	
	
		
___________________________________________________________ 
ALL-NEW Yahoo! Messenger - all new features - even more fun! <A HREF="http://uk.messenger.yahoo.com">http://uk.messenger.yahoo.com</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010395.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
	<LI>Next message: <A HREF="010443.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10413">[ date ]</a>
              <a href="thread.html#10413">[ thread ]</a>
              <a href="subject.html#10413">[ subject ]</a>
              <a href="author.html#10413">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
