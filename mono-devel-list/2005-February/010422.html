<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Question regarding ASM in mini-x86.c
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20regarding%20ASM%20in%20mini-x86.c&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010418.html">
   <LINK REL="Next"  HREF="010423.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Question regarding ASM in mini-x86.c</H1>
    <B>J Lothian</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20regarding%20ASM%20in%20mini-x86.c&In-Reply-To="
       TITLE="[Mono-devel-list] Question regarding ASM in mini-x86.c">rhalin at gmail.com
       </A><BR>
    <I>Sat Feb 12 00:34:43 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010418.html">[Mono-devel-list] Building svn version on RedHat Enterprise Linux 3
</A></li>
        <LI>Next message: <A HREF="010423.html">[Mono-devel-list] Test Failure in Mono.Security
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10422">[ date ]</a>
              <a href="thread.html#10422">[ thread ]</a>
              <a href="subject.html#10422">[ subject ]</a>
              <a href="author.html#10422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Heyyas,

I seem to have hit a minor roadblock in my quest to get an MSVC 6
build working, mini-x86 seems to do some interesting things dealing
with inline ASM, and this is one of those fields I have nearly zero
experience with.  Before I go and muck about too much, I thought I'd
ask you all opinions on what I can do here.

firstly, MSVC doesn't understand __asm__ __volatile__,  it has __asm,
and a volatile keyword, but I don't believe they can be used together
in this manner.

Here's the blocks giving me trouble:
cpuid (int id, int* p_eax, int* p_ebx, int* p_ecx, int* p_edx)
{
	int have_cpuid = 0;
	__asm__  __volatile__ (
		&quot;pushfl\n&quot;
		&quot;popl %%eax\n&quot;
		&quot;movl %%eax, %%edx\n&quot;
		&quot;xorl $0x200000, %%eax\n&quot;
		&quot;pushl %%eax\n&quot;
		&quot;popfl\n&quot;
		&quot;pushfl\n&quot;
		&quot;popl %%eax\n&quot;
		&quot;xorl %%edx, %%eax\n&quot;
		&quot;andl $0x200000, %%eax\n&quot;
		&quot;movl %%eax, %0&quot;
		: &quot;=r&quot; (have_cpuid)
		:
		: &quot;%eax&quot;, &quot;%edx&quot;
	);

and

void
mono_arch_cpu_init (void)
{
	guint16 fpcw;

	/* spec compliance requires running with double precision */
	__asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));
	fpcw &amp;= ~X86_FPCW_PRECC_MASK;
	fpcw |= X86_FPCW_PREC_DOUBLE;
	__asm__  __volatile__ (&quot;fldcw %0\n&quot;: : &quot;m&quot; (fpcw));
	__asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));

}

The most I can do with these is replace the __asm__ with __asm and
remove the volatile, but I have a feeling it's not going to perform
how it's supposed to and that the asm itself probably needs to be
alterered.   Can anyone help me with this at all?  I'll keep digging
at it a bit, see if I can figure it out, but this looks like one of
those times when I'm really gonna need a bit of a hand.  I can add in
the relavant #ifdef _MSC_VER's to my build notes and svn diff if I can
figure out what to put in there.

Thanks for anything you can come up with!

-J Lothian

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010418.html">[Mono-devel-list] Building svn version on RedHat Enterprise Linux 3
</A></li>
	<LI>Next message: <A HREF="010423.html">[Mono-devel-list] Test Failure in Mono.Security
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10422">[ date ]</a>
              <a href="thread.html#10422">[ thread ]</a>
              <a href="subject.html#10422">[ subject ]</a>
              <a href="author.html#10422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
