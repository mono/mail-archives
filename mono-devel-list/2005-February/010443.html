<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Embedding Mono in a Virtual World
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050211161325.36591.qmail%40web25005.mail.ukl.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010413.html">
   <LINK REL="Next"  HREF="010407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Embedding Mono in a Virtual World</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Embedding%20Mono%20in%20a%20Virtual%20World&In-Reply-To=20050211161325.36591.qmail%40web25005.mail.ukl.yahoo.com"
       TITLE="[Mono-devel-list] Embedding Mono in a Virtual World">lupus at ximian.com
       </A><BR>
    <I>Sun Feb 13 11:12:01 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010413.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
        <LI>Next message: <A HREF="010407.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10443">[ date ]</a>
              <a href="thread.html#10443">[ thread ]</a>
              <a href="subject.html#10443">[ subject ]</a>
              <a href="author.html#10443">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/11/05 Jim Purbrick wrote:
&gt;<i> I think this approach generalises to the continuation
</I>&gt;<i> based approach used by PicoThreads in Java[1]: you
</I>&gt;<i> need to build chains of continuations on the heap that
</I>&gt;<i> you can switch between to switch threads, something
</I>&gt;<i> that Dan Sugalski suggests is really inefficient and
</I>&gt;<i> one of the reasons you might want to use Parrot
</I>&gt;<i> instead of the JVM or Mono[2].
</I>
Except Parrot is still not suitable to develop any of this stuff:-)
Anyway, as I said it will be slow: with mono 2.0 heap
allocations should become much faster, so, depending
on your timeframe it may not be so bad.

&gt;<i> Fibers are cooperatively scheduled light weight
</I>&gt;<i> threads in Win32[3]. The core of the approach boils
</I>&gt;<i> down to:
</I>&gt;<i> 
</I>&gt;<i> schedule()
</I>&gt;<i> {
</I>&gt;<i> saveCLRLogicalThreadState(currentThreadState);
</I>&gt;<i> switchOSFiber(nextFiber);
</I>&gt;<i> restoreCLRLogicalThreadState(nextThreadState);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> Which is used to keep the logical managed thread state
</I>&gt;<i> and fiber in sync. They had some problems with
</I>&gt;<i> exceptions using this approach and the logical thread
</I>&gt;<i> save and restore methods maybe something that's only
</I>&gt;<i> available in Rotor.
</I>
I don't see us implementing any of the support needed for this,
though of corse we would accept good patches to do it.
Personally, I don't think the complexity it introduces is
worth it for the default mono behaviour (the good thing about mono
is that you could write the support and use your own build with
it enabled to run your app:-).

&gt;<i> &gt; It should be pretty safe if you inject in the user
</I>&gt;<i> code checks for a
</I>&gt;<i> &gt; global var that signals the event
</I>&gt;<i> 
</I>&gt;<i> Couldn't I just call Thread.Suspend from the main
</I>&gt;<i> thread after the timeout? 
</I>
Yes, but that coiuld lead to deadlocks, since the script might
hold a lock that another script or your engine needs to acquire
or worse, it may have a lock in the mono runtime. We'll be
putting some protection against the latter issue, in the future, but
until then, it's better to make the script call Suspend, because
you can ensure it's in a safe place wrt your engine (and
calling Suspend from managed code on the current thread is safe
wrt the mono runtime state).

&gt;<i> &gt; The Suspend method is marked obsolete in 2.0,
</I>&gt;<i> &gt; because of the potential for deadlocks, but using it
</I>&gt;<i> this way should
</I>&gt;<i> &gt; be safe.
</I>&gt;<i> 
</I>&gt;<i> Will I still be able to use this approach with future
</I>&gt;<i> versions of Mono then?
</I>
Obsolete means the call will still work, but you'll have
a warning when compiling (if you use a C# compiler or the like).

&gt;<i> &gt; Since most of the scripts should terminate within
</I>&gt;<i> &gt; the timeout, if I understood correctly, you should
</I>&gt;<i> just have a number
</I>&gt;<i> &gt; of threads created as many as the slow scripts 
</I>&gt;<i> 
</I>&gt;<i> Yes, as all bar one of the threads would be suspended
</I>&gt;<i> that presumably wouldn't cause any context switching
</I>&gt;<i> problems. The only problem would be that each
</I>&gt;<i> suspended thread would still have a full OS thread
</I>&gt;<i> stack, so might burn a pile of memory.
</I>
The Mono 2.0 API already implements the calls to specify your 
own thread stack size: the minimum is 128 KB IIRC, but this will
allow you to have 100 'slow' scripts in 13 MBs of memory.
If that's enough for your requirements, this could be a good approach.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010413.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
	<LI>Next message: <A HREF="010407.html">[Mono-devel-list] Embedding Mono in a Virtual World
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10443">[ date ]</a>
              <a href="thread.html#10443">[ thread ]</a>
              <a href="subject.html#10443">[ subject ]</a>
              <a href="author.html#10443">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
