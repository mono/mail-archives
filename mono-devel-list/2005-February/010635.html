<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Problem in Marshaling Runtime Code?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Problem%20in%20Marshaling%20Runtime%20Code%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010632.html">
   <LINK REL="Next"  HREF="010636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Problem in Marshaling Runtime Code?</H1>
    <B>Jesse Towner</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Problem%20in%20Marshaling%20Runtime%20Code%3F&In-Reply-To="
       TITLE="[Mono-devel-list] Problem in Marshaling Runtime Code?">townerj at gmail.com
       </A><BR>
    <I>Wed Feb 23 09:11:35 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010632.html">[Mono-devel-list] Class Regexp misbehavior
</A></li>
        <LI>Next message: <A HREF="010636.html">[Mono-devel-list] Problem in Marshaling Runtime Code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10635">[ date ]</a>
              <a href="thread.html#10635">[ thread ]</a>
              <a href="subject.html#10635">[ subject ]</a>
              <a href="author.html#10635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm not sure if I have identified a potential problem or not, but here goes.

I was examining the code in mono/mono/metadata/marshal.c and I noticed
that there is a single method wrapper cache that is global to the entire
process. However, it is not always the case that methods are also global
to the process because sometimes they're local to the host AppDomain
that their originating assembly has been loaded into. There also appears
to be no mechanism for removing a particular wrapper from the cache, so
it is quite possible that an internal call or some runtime code could
make reference to a method that has been unloaded with its host AppDomain.

I'm also not sure how this ties in with the GC implementation, that is,
if the method wrapper cache induces a live reference to a particular
method and the parent class, which somehow might stop an AppDomain from
being unloaded. But if it doesn't cause the GC to improperly unload an
AppDomain, then their is still the issue of not recollecting dead
wrappers from the method wrapper cache. I'm not sure how XSP works, but
if it is anything like IIS, then this could be a potential memory leak.

Furthermore, since their is only a single method wrapper cache and
guarding mutex, thread contention between threads (from different
AppDomains) competing for access to the one and same cache could occur.
This problem is exacerbated when one considers that the different
threads may be trying to acquire method wrappers to methods that may be
exclusive to a particular AppDomain.

So unless I have missed something in the code, it seems this problem
could rear its ugly head at some point in the future.

If this is indeed an issue not handled elsewhere, the proposed solution
would be to encapsulate the cache and other supporting variables and
objects in a context structure per AppDomain. Then the code in marshal.c
would then be modified to use the marshaling context for the current
AppDomain.

------------------------------------------------------------------------
Jesse Towner, Lead Programmer, Hybrid Mobile Technologies, LLC
Email Addresses: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jtowner at hybrid-mobile.com</A>&gt;, &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">townerj at gmail.com</A>&gt;
PGP Public Key: <A HREF="http://www.virtuallyonline.net/personal/jesse/pgp.html">http://www.virtuallyonline.net/personal/jesse/pgp.html</A>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 254 bytes
Desc: OpenPGP digital signature
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050223/cea5c87c/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050223/cea5c87c/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010632.html">[Mono-devel-list] Class Regexp misbehavior
</A></li>
	<LI>Next message: <A HREF="010636.html">[Mono-devel-list] Problem in Marshaling Runtime Code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10635">[ date ]</a>
              <a href="thread.html#10635">[ thread ]</a>
              <a href="subject.html#10635">[ subject ]</a>
              <a href="author.html#10635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
