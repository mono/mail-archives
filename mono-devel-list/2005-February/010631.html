<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Trampolines...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Trampolines...&In-Reply-To=295e750a050222144167b812d8%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010626.html">
   <LINK REL="Next"  HREF="010633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Trampolines...</H1>
    <B>Willibald Krenn</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Trampolines...&In-Reply-To=295e750a050222144167b812d8%40mail.gmail.com"
       TITLE="[Mono-devel-list] Trampolines...">Willibald.Krenn at gmx.at
       </A><BR>
    <I>Wed Feb 23 07:26:34 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010626.html">[Mono-devel-list] Trampolines...
</A></li>
        <LI>Next message: <A HREF="010633.html">[Mono-devel-list] Trampolines...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10631">[ date ]</a>
              <a href="thread.html#10631">[ thread ]</a>
              <a href="subject.html#10631">[ subject ]</a>
              <a href="author.html#10631">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Zoltan Varga schrieb:
&gt;<i> It is possible to call the same virtual method with boxed and
</I>&gt;<i> non-boxed arguments,
</I>&gt;<i> like:
</I>&gt;<i> 
</I>&gt;<i> SomeStruct s = new SomeStruct ();
</I>&gt;<i> s.ToString ();
</I>&gt;<i> object o = s;
</I>&gt;<i> o.ToString ();
</I>
I understand. But how about this idea:
For virtual methods of value types, we could 'inline' the unbox 
trampoline in the method like

addq 0x10, %r_this	;unbox start
pushq %rbp		;normal start
movq  %rsp, %rbp
....

Normally the JIT gives the addr of pushq back as starting address. In 
the magic service routine (&quot;get unbox trampoline&quot;) we could subtract the 
size of the addq opcode and take that as method starting address. While 
that would make virtual methods of value types still a special case (2 
entry points, so while patching one has to make sure that patching 
starts at the normal start), it would be much easier to handle and we 
would get rid of another jmp indirection...

The arch part of mini will probably need a few new 'functions' (macros):
int mono_arch_get_unbox_size ()
gpointer mono_arch_get_normal_start (gpointer code)

AFAIK the addq would be 4 bytes on AMD64 - instead of ~16 bytes (at 
least 20 bytes allocated) for the unbox tramp. Yes, not every virtual 
method of value types will have an unbox trampoline, but for one 
trampoline we get at least 4 (I assume 6 because of (20+7) &amp; ~7) method 
inlined unbox operations plus we save the jumps.

BTW: Alternatively we could fake-box the this pointer before any call to 
a virtual value type method..

Willi


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010626.html">[Mono-devel-list] Trampolines...
</A></li>
	<LI>Next message: <A HREF="010633.html">[Mono-devel-list] Trampolines...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10631">[ date ]</a>
              <a href="thread.html#10631">[ thread ]</a>
              <a href="subject.html#10631">[ subject ]</a>
              <a href="author.html#10631">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
