<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Trampolines...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Trampolines...&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010614.html">
   <LINK REL="Next"  HREF="010622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Trampolines...</H1>
    <B>Willibald Krenn</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Trampolines...&In-Reply-To="
       TITLE="[Mono-devel-list] Trampolines...">Willibald.Krenn at gmx.at
       </A><BR>
    <I>Mon Feb 21 15:26:20 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010614.html">[Mono-devel-list] [PATCH] Adds .Net v2 String.IsNullOrEmpty method
</A></li>
        <LI>Next message: <A HREF="010622.html">[Mono-devel-list] Trampolines...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10605">[ date ]</a>
              <a href="thread.html#10605">[ thread ]</a>
              <a href="subject.html#10605">[ subject ]</a>
              <a href="author.html#10605">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi guys!

I'm a little bit lost on trampolines (esp AMD64): Currently, if a method 
is compiled the first time within the magic service routine (I'll refer 
to this trampoline 'servic routine' for better separation from the 
others) it is checked if the caller can be patched to directly jump to 
the new code. At the same time, the stub (I'll refer to the 'first' 
trampoline 'stub', because it just emits a call to the real trampoline 
which then calls the C-service routine) is patched not to call into the 
trampoline anymore, but to directly call the newly emitted method. 
(While I can see the benefits of doing this, it also means leaving any 
further possibilities of avoiding the stub-jump by inlining the new 
method's address in other callers unused..)

Is this subject to change?
The reason I'm asking is for stub-reference counting: Upon 
recompilation, the method is changed to a stub that calls a new 
trampoline and ends in a new service routine which will look up the 
recompiled code position and patch the callers accordingly. Thereby 
decreasing some refcount in the stub. Goal is to free the space used by 
the first-time compilation of a method (where the stub is located after 
recompilation)..

If the magic service routine won't be changed, it means that all 
callers, except one will go through the stub - meaning that a newly 
compiled method has at maximum 2 different callers (one is the stub, one 
is the patched call). If the service routine will be changed, this 
assumtion does not hold anymore..

BTW: Recompiling/Patching of virtual and non-virtual methods is working 
here - just the refcount part does not work as it should... But I'll 
change that :-)

Be warned: If this is fixed, I'll clean up the code and post it for 
comments here.

Thanks,
  Willi


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010614.html">[Mono-devel-list] [PATCH] Adds .Net v2 String.IsNullOrEmpty method
</A></li>
	<LI>Next message: <A HREF="010622.html">[Mono-devel-list] Trampolines...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10605">[ date ]</a>
              <a href="thread.html#10605">[ thread ]</a>
              <a href="subject.html#10605">[ subject ]</a>
              <a href="author.html#10605">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
