<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Question regarding ASM in mini-x86.c
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20regarding%20ASM%20in%20mini-x86.c&In-Reply-To=D92197D0A6547B44A1567814F851FA680694B5%40LEMBU.sumatrasoftware.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010424.html">
   <LINK REL="Next"  HREF="010442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Question regarding ASM in mini-x86.c</H1>
    <B>J Lothian</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20regarding%20ASM%20in%20mini-x86.c&In-Reply-To=D92197D0A6547B44A1567814F851FA680694B5%40LEMBU.sumatrasoftware.com"
       TITLE="[Mono-devel-list] Question regarding ASM in mini-x86.c">rhalin at gmail.com
       </A><BR>
    <I>Sat Feb 12 15:39:41 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010424.html">[Mono-devel-list] Question regarding ASM in mini-x86.c
</A></li>
        <LI>Next message: <A HREF="010442.html">[Mono-devel-list] Question regarding ASM in mini-x86.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10431">[ date ]</a>
              <a href="thread.html#10431">[ thread ]</a>
              <a href="subject.html#10431">[ subject ]</a>
              <a href="author.html#10431">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ah, much thanks,  it compiles, which may not be saying much at this
point, but I can work out bugs later when it all links correctly.

stuck this in the cpu_init, think its going to work, I'm not
-entirely- sure if it's doing the same thing ( I may be way off here)
#ifndef _MSC_VER
	__asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));
	fpcw &amp;= ~X86_FPCW_PRECC_MASK;
	fpcw |= X86_FPCW_PREC_DOUBLE;
	__asm__  __volatile__ (&quot;fldcw %0\n&quot;: : &quot;m&quot; (fpcw));
	__asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));
#else
	_control87( _PC_64, MCW_PC );
#endif

Thanks for the help though!

On Sat, 12 Feb 2005 09:22:00 +0100, Jeroen Frijters &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jeroen at sumatra.nl</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> If you don't know x86 then these parts will be quite tricky to convert
</I>&gt;<i> to MSVC, due to the fact that GCC doesn't follow the Intel conventions
</I>&gt;<i> in instruction naming and parameter order.
</I>&gt;<i> 
</I>&gt;<i> For the two cases below, you could probably use the compiler intrinsincs
</I>&gt;<i> _control87() and __cpuid() though.
</I>&gt;<i> 
</I>&gt;<i> Here's an example of what the part of cpuid you quoted would look like:
</I>&gt;<i> 
</I>&gt;<i>        int have_cpuid = 0;
</I>&gt;<i>        __asm {
</I>&gt;<i>                pushfd
</I>&gt;<i>                pop eax
</I>&gt;<i>                mov edx, eax
</I>&gt;<i>                xor eax, 0x200000
</I>&gt;<i>                push eax
</I>&gt;<i>                popfd
</I>&gt;<i>                pushfd
</I>&gt;<i>                pop eax
</I>&gt;<i>                xor eax, edx
</I>&gt;<i>                and eax, 0x200000
</I>&gt;<i>                mov have_cpuid, eax
</I>&gt;<i>        }
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Jeroen
</I>&gt;<i> 
</I>&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-admin at lists.ximian.com</A>
</I>&gt;<i> &gt; [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-admin at lists.ximian.com</A>] On Behalf Of J Lothian
</I>&gt;<i> &gt; Sent: Saturday, February 12, 2005 06:35
</I>&gt;<i> &gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; Subject: [Mono-devel-list] Question regarding ASM in mini-x86.c
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Heyyas,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I seem to have hit a minor roadblock in my quest to get an MSVC 6
</I>&gt;<i> &gt; build working, mini-x86 seems to do some interesting things dealing
</I>&gt;<i> &gt; with inline ASM, and this is one of those fields I have nearly zero
</I>&gt;<i> &gt; experience with.  Before I go and muck about too much, I thought I'd
</I>&gt;<i> &gt; ask you all opinions on what I can do here.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; firstly, MSVC doesn't understand __asm__ __volatile__,  it has __asm,
</I>&gt;<i> &gt; and a volatile keyword, but I don't believe they can be used together
</I>&gt;<i> &gt; in this manner.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here's the blocks giving me trouble:
</I>&gt;<i> &gt; cpuid (int id, int* p_eax, int* p_ebx, int* p_ecx, int* p_edx)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;       int have_cpuid = 0;
</I>&gt;<i> &gt;       __asm__  __volatile__ (
</I>&gt;<i> &gt;               &quot;pushfl\n&quot;
</I>&gt;<i> &gt;               &quot;popl %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;movl %%eax, %%edx\n&quot;
</I>&gt;<i> &gt;               &quot;xorl $0x200000, %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;pushl %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;popfl\n&quot;
</I>&gt;<i> &gt;               &quot;pushfl\n&quot;
</I>&gt;<i> &gt;               &quot;popl %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;xorl %%edx, %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;andl $0x200000, %%eax\n&quot;
</I>&gt;<i> &gt;               &quot;movl %%eax, %0&quot;
</I>&gt;<i> &gt;               : &quot;=r&quot; (have_cpuid)
</I>&gt;<i> &gt;               :
</I>&gt;<i> &gt;               : &quot;%eax&quot;, &quot;%edx&quot;
</I>&gt;<i> &gt;       );
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; and
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; void
</I>&gt;<i> &gt; mono_arch_cpu_init (void)
</I>&gt;<i> &gt; {
</I>&gt;<i> &gt;       guint16 fpcw;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;       /* spec compliance requires running with double precision */
</I>&gt;<i> &gt;       __asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));
</I>&gt;<i> &gt;       fpcw &amp;= ~X86_FPCW_PRECC_MASK;
</I>&gt;<i> &gt;       fpcw |= X86_FPCW_PREC_DOUBLE;
</I>&gt;<i> &gt;       __asm__  __volatile__ (&quot;fldcw %0\n&quot;: : &quot;m&quot; (fpcw));
</I>&gt;<i> &gt;       __asm__  __volatile__ (&quot;fnstcw %0\n&quot;: &quot;=m&quot; (fpcw));
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The most I can do with these is replace the __asm__ with __asm and
</I>&gt;<i> &gt; remove the volatile, but I have a feeling it's not going to perform
</I>&gt;<i> &gt; how it's supposed to and that the asm itself probably needs to be
</I>&gt;<i> &gt; alterered.   Can anyone help me with this at all?  I'll keep digging
</I>&gt;<i> &gt; at it a bit, see if I can figure it out, but this looks like one of
</I>&gt;<i> &gt; those times when I'm really gonna need a bit of a hand.  I can add in
</I>&gt;<i> &gt; the relavant #ifdef _MSC_VER's to my build notes and svn diff if I can
</I>&gt;<i> &gt; figure out what to put in there.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for anything you can come up with!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -J Lothian
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010424.html">[Mono-devel-list] Question regarding ASM in mini-x86.c
</A></li>
	<LI>Next message: <A HREF="010442.html">[Mono-devel-list] Question regarding ASM in mini-x86.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10431">[ date ]</a>
              <a href="thread.html#10431">[ thread ]</a>
              <a href="subject.html#10431">[ subject ]</a>
              <a href="author.html#10431">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
