<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Anonymous Pipe Stream Implementation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Anonymous%20Pipe%20Stream%20Implementation&In-Reply-To=%3C51E51625.9090904%40veritas-vos-liberabit.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040598.html">
   <LINK REL="Next"  HREF="040582.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Anonymous Pipe Stream Implementation</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Anonymous%20Pipe%20Stream%20Implementation&In-Reply-To=%3C51E51625.9090904%40veritas-vos-liberabit.com%3E"
       TITLE="[Mono-dev] Anonymous Pipe Stream Implementation">atsushieno at veritas-vos-liberabit.com
       </A><BR>
    <I>Tue Jul 16 09:45:09 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040598.html">[Mono-dev] Anonymous Pipe Stream Implementation
</A></li>
        <LI>Next message: <A HREF="040582.html">[Mono-dev] WCF in Mono client borking negative numbers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40602">[ date ]</a>
              <a href="thread.html#40602">[ thread ]</a>
              <a href="subject.html#40602">[ subject ]</a>
              <a href="author.html#40602">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, that's quite a lot of effort :)

Whoever touches the runtime part should judge if making changes in the 
runtime/icalls in this manner is acceptable. I'm particulary not sure 
about using icalls from System.Core.dll.

Also we cannot expose any internal API as public, for example:
<A HREF="https://github.com/smokingrope/mono/commit/8837a69d202ddb7d8350ebd052ff44d9e889a627#L7R437">https://github.com/smokingrope/mono/commit/8837a69d202ddb7d8350ebd052ff44d9e889a627#L7R437</A>

Atsushi Eno

SmokingRope wrote:
&gt;<i> Thanks for the feedback
</I>&gt;<i>
</I>&gt;<i> I started this project merely as an investigation into whether it was 
</I>&gt;<i> even possible to implement in unix, and so hadn't really thought far 
</I>&gt;<i> enough ahead as to sharing it. The code is now pushed to a fork on 
</I>&gt;<i> github: 
</I>&gt;<i> <A HREF="https://github.com/smokingrope/mono/commit/8837a69d202ddb7d8350ebd052ff44d9e889a627">https://github.com/smokingrope/mono/commit/8837a69d202ddb7d8350ebd052ff44d9e889a627</A>
</I>&gt;<i>
</I>&gt;<i> In terms of compatiblity i have not needed to change any existing dll 
</I>&gt;<i> references. At this point i have added two internal calls to the 
</I>&gt;<i> corlib\System.IO.MonoIO class. Perhaps you could look over these new 
</I>&gt;<i> internal calls and give a little more specific advice on what (if 
</I>&gt;<i> anything) needs conditioned out.
</I>&gt;<i>         I reused the poll() wrapper from the sockets implementation, 
</I>&gt;<i> (as MonoIO.PollFD) so i assume that is ok.
</I>&gt;<i>         I am re-using the existing CreatePipe() function for pipe 
</I>&gt;<i> creation, so that behaves the same as before.
</I>&gt;<i>         The GetPipeHandle() internal call just initializes a handle 
</I>&gt;<i> that was inherited from a parent process in mono's file descriptor 
</I>&gt;<i> table, which would not strike me as a compatibilty concern on it's own 
</I>&gt;<i> as it's only doing mono platform work.
</I>&gt;<i>
</I>&gt;<i> A new problem has presented itself, which some expert feedback would 
</I>&gt;<i> be appreciated. Based on the sample code: 
</I>&gt;<i> <A HREF="http://msdn.microsoft.com/en-us/library/bb546102.aspx">http://msdn.microsoft.com/en-us/library/bb546102.aspx</A>
</I>&gt;<i>
</I>&gt;<i>   1) Process.Start() is called on the server application to launch the 
</I>&gt;<i> client application
</I>&gt;<i>   2) When the client application is started, it will inherit the pipe 
</I>&gt;<i> handle and eventually start using it
</I>&gt;<i>   3) The server application calls DisposeLocalCopyOfClientHandle()
</I>&gt;<i>   4) The server writes to the pipe
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    There is a synchronization issue between when 2 and 3 run, because 
</I>&gt;<i> in my testing, sometimes the Process.Start() call has not fully 
</I>&gt;<i> completed launching the child process, and closing the client handle 
</I>&gt;<i> on the server side cause the pipe to be broken before the client is 
</I>&gt;<i> fully booted. Because the pipe is broken step 4 should fail, though 
</I>&gt;<i> right now this isn't quite happening :)
</I>&gt;<i>
</I>&gt;<i>   With a Thread.Sleep(10) in DisposeLocalCopyOfClientHandle() the code 
</I>&gt;<i> seems to work about 50% of the time on my machine. With no sleep, the 
</I>&gt;<i> pipe seems to be broken every time.
</I>&gt;<i>
</I>&gt;<i>   With the technical explanation out of the way, is there any way i 
</I>&gt;<i> could wait / yield, and force the Process.Start() to complete 
</I>&gt;<i> launching the client before DisploseLocalCopyOfClientHandle() 
</I>&gt;<i> complete? I can certainly find some threshold where Thread.Sleep() 
</I>&gt;<i> reliably fixes the issue on my machine, but it may not be nearly as 
</I>&gt;<i> reliable across platforms either, and may need to be pretty huge 
</I>&gt;<i> (multiple seconds maybe?) to really get good reliability that way.
</I>&gt;<i>
</I>&gt;<i> I also would still appreciate some feedback on the handle inheritance 
</I>&gt;<i> problem.
</I>&gt;<i>
</I>&gt;<i> There aren't any tests yet, and i'm pretty severely violating the 
</I>&gt;<i> coding standards document at this point, so both of those things are 
</I>&gt;<i> still on my todo list. I'd also like to throw together the win32 
</I>&gt;<i> implementation as well (something that would be compatible with the 
</I>&gt;<i> MS.NET &lt;<A HREF="http://MS.NET">http://MS.NET</A>&gt; implementation).
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040598.html">[Mono-dev] Anonymous Pipe Stream Implementation
</A></li>
	<LI>Next message: <A HREF="040582.html">[Mono-dev] WCF in Mono client borking negative numbers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40602">[ date ]</a>
              <a href="thread.html#40602">[ thread ]</a>
              <a href="subject.html#40602">[ subject ]</a>
              <a href="author.html#40602">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
