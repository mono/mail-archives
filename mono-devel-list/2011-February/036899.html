<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sgen%20garbage%20collector/unmanaged%0A%20resources/multi-thread%20issue&In-Reply-To=AANLkTimmP%2Br908ojRqm_eCOhuQYiuLVVQbFR%3DNWe3e3g%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036898.html">
   <LINK REL="Next"  HREF="036963.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue</H1>
    <B>matteo tesser</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sgen%20garbage%20collector/unmanaged%0A%20resources/multi-thread%20issue&In-Reply-To=AANLkTimmP%2Br908ojRqm_eCOhuQYiuLVVQbFR%3DNWe3e3g%40mail.gmail.com"
       TITLE="[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue">matteo.tesser at gmail.com
       </A><BR>
    <I>Fri Feb 11 12:08:09 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="036898.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
        <LI>Next message: <A HREF="036963.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36899">[ date ]</a>
              <a href="thread.html#36899">[ thread ]</a>
              <a href="subject.html#36899">[ subject ]</a>
              <a href="author.html#36899">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rodrigo,
OK, taking or not taking into consideration memory pressure is a
runtime's implementation choice: if you consider memory pressure, the
runtime will be more reactive to memory usage, in the latter case no,
but unreferenced objects should be freed sooner or later.

I did an additional test: I counted the live object instances of the
object type which references the unmanaged resources over time: while
in windows and os x the live instances oscillate  between 10K and 60K,
 in  linux the live instances arrived to 20 milions. it seems that the
GC does not realize that so many objects  have been allocated. Are 20
milions objects  still a number that should not trigger the GC ?

Probably the problem is not related to unmanaged memory but the
particular structure of my problem highlights a defect.

Matteo



On Fri, Feb 11, 2011 at 3:34 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:
&gt;<i> Mono doesn't take memory pressure into account. This is probably
</I>&gt;<i> what's happening.
</I>&gt;<i> On Fri, Feb 11, 2011 at 3:54 PM, matteo tesser &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matteo.tesser at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a concurrent programming test &#160;which during 5-10 minutes
</I>&gt;&gt;<i> creates and releases a &#160;lot of objects which use unmanaged memory.
</I>&gt;&gt;<i> Every managed object, &#160;respectively &#160;allocates/deallocates the
</I>&gt;&gt;<i> unmanaged memory using &#160;Marshal.AllocHGlobal and Marshall.FreeHGlobal
</I>&gt;&gt;<i> methods &#160;and uses GC.AddMemoryPressure/GC.RemoveMemoryPressure to tell
</I>&gt;&gt;<i> to &#160;the garbage collector the presence of the additional memory.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I experienced some memory problems on linux, &#160;so I did several tests:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1) &#160;In linux machine with openSuse 11.3 64bit dual core with &#160;mono
</I>&gt;&gt;<i> 2.8.2, &#160;the program launched with mono --gc=sgen eats 4GB of RAM in
</I>&gt;&gt;<i> about two minutes (see attached screenshot).
</I>&gt;&gt;<i> If I launch the test by specifying the use of &#160;boehm gc, &#160;the memory
</I>&gt;&gt;<i> is still consumed but at smaller rate.
</I>&gt;&gt;<i> I tried the test also with mono 2.10p3 and the behavior is the same
</I>&gt;&gt;<i> (also using MONO_GC_PARAMS=stack-mark=precise)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2) In Windows/.NET the memory footprint &#160;of the program is constant on
</I>&gt;&gt;<i> time: &#160;80MB,
</I>&gt;&gt;<i> 3) in a dual core mac os x ( with mono 2.10p2) the behavior is the
</I>&gt;&gt;<i> same as windows.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4) In a Virtual Machine with &#160;linux openSuse 11.3 32bit &#160;and 1
</I>&gt;&gt;<i> processor &#160;, mono 2.10p3 the test works fine: the memory footprint &#160;is
</I>&gt;&gt;<i> constant at 50MB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My conclusion is that the problem is restricted to the linux /
</I>&gt;&gt;<i> multi-thread case.
</I>&gt;&gt;<i> Are you aware of such issues on sgen?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried to build-up a simple code reproducing the problem but I did
</I>&gt;&gt;<i> not managed to do it with a simple test case, in case are you
</I>&gt;&gt;<i> interested in a binary test case?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Matteo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036898.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
	<LI>Next message: <A HREF="036963.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36899">[ date ]</a>
              <a href="thread.html#36899">[ thread ]</a>
              <a href="subject.html#36899">[ subject ]</a>
              <a href="author.html#36899">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
