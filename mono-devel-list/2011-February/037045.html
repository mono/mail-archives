<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] mixed-mode assemblies in wine
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mixed-mode%20assemblies%20in%20wine&In-Reply-To=4D6C2F5B.5050203%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037044.html">
   <LINK REL="Next"  HREF="037047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] mixed-mode assemblies in wine</H1>
    <B>Vincent Povirk</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20mixed-mode%20assemblies%20in%20wine&In-Reply-To=4D6C2F5B.5050203%40gmail.com"
       TITLE="[Mono-dev] mixed-mode assemblies in wine">madewokherd at gmail.com
       </A><BR>
    <I>Mon Feb 28 18:53:30 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037044.html">[Mono-dev] mixed-mode assemblies in wine
</A></li>
        <LI>Next message: <A HREF="037047.html">[Mono-dev] Mono-2.8.2 Cross Compiled for ARM processor (Interesting issue with Generics)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37045">[ date ]</a>
              <a href="thread.html#37045">[ thread ]</a>
              <a href="subject.html#37045">[ subject ]</a>
              <a href="author.html#37045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> My preferred way would be to call exports that Windows calls:
</I>&gt;<i> - _CorValidateImage on image load
</I>&gt;<i> - _CorImageUnloading on image unload
</I>&gt;<i> - _CorExeMain instead of exe entry point
</I>&gt;<i> - _CorDllMain instaad of dll entry
</I>
Is there a reason for us to add this to the Wine loader soon? I've
been putting it off because I have to ask for someone else to do it.

&gt;<i> - the C runtime (not the OS) should also call CorExitProcess on normal
</I>&gt;<i> termination (exit)
</I>
Yes, I added this to Wine's msvcrt last week so we can tear things
down properly. Although right now that doesn't work because of the
hooks. :)

&gt;<i> I also planned to get rid of MonoFixupExe &#160;and drop support for mixed-mode
</I>&gt;<i> assemblies by using mono.exe and introduce a loader that would call
</I>&gt;<i> CreateProcess on the managed (may be mixed-mode) .exe, inject a loader .dll
</I>&gt;<i> (or a custom mscoree.dll) by modifying IAT, remove IL-only flag so that the
</I>&gt;<i> OS loader will not load MS.NET mscorlib.dll, and do inicialization in that
</I>&gt;<i> loader .dll called by OS loader. This would not affect functionality of
</I>&gt;<i> mono.dll just would not fixup mscoree.dll by default that also would play
</I>&gt;<i> more nicely with standalone verifier, dumper, etc. tools and CoreCLR.
</I>
That's interesting.

It would seem (to me) that in this case your mscoree.dll and ours can
and should be the same one. The only difference is how libmono is
found and loaded.

&gt;<i> I also have the impression that implementing .NET Framework functionality in
</I>&gt;<i> Wine may not be the right architecture. Ideally those belong to Mono. Since
</I>&gt;<i> I know that Mono does not accept GPL to runtime (requires MIT X11 license or
</I>&gt;<i> special permissions to Novell; althoug is licensed under GPL) and Wine
</I>&gt;<i> prefers GPL this may not be suitable.
</I>&gt;<i>
</I>&gt;<i> Wine loader should call mscoree.dll just like Windows loader does
</I>&gt;<i> (system32\mscoree.dll is hardcoded, cannot use your own).
</I>&gt;<i>
</I>&gt;<i> If you prefer to keep mscoree.dll code in Wine, then I belive that Wine
</I>&gt;<i> mscoree.dll should load mono.dll (as it already does) and forward the above
</I>&gt;<i> five basic exports to mono.dll and implement other exports on its own by
</I>&gt;<i> calling native Mono API.
</I>
My only strong reason for wanting mscoree.dll to be in Wine is so that
it can load without any Mono present (which is enough to install many
apps, and pass tests), and so that it can select between multiple
available Mono setups at runtime (in order to cover .NET versions 1.1,
2.0, and 4.0 simultaneously). For that to work, we need a dll that
loads Mono dynamically rather than linking to it, and it needs to
support both embedding ABI's.

Licensing is not an issue. Wine is LGPL, and we can use MIT code. The
reverse isn't true, but I think it would be possible to relicense most
of Wine's current mscoree code as MIT, since most of that architecture
was written by me for CodeWeavers.

Still, if you want to work on the .NET embedding API, I think we
should find a way to collaborate, in whichever project.

Another possible approach, if we don't share mscoree.dll code, would
be for Wine and Mono to both implement ICLRMetaHost
(<A HREF="http://msdn.microsoft.com/en-us/library/dd233134.aspx">http://msdn.microsoft.com/en-us/library/dd233134.aspx</A>) and
ICLRRuntimeInfo, both of which can be accessed before a runtime is
chosen and loaded, and for only Mono to implement ICLRRuntimeHost,
which requires a loaded runtime. Wine's mscoree.dll's other functions
(except for the _Cor functions which will have to be special) could
then work based on those interfaces.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037044.html">[Mono-dev] mixed-mode assemblies in wine
</A></li>
	<LI>Next message: <A HREF="037047.html">[Mono-dev] Mono-2.8.2 Cross Compiled for ARM processor (Interesting issue with Generics)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37045">[ date ]</a>
              <a href="thread.html#37045">[ thread ]</a>
              <a href="subject.html#37045">[ subject ]</a>
              <a href="author.html#37045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
