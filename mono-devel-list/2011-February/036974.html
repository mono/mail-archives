<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sgen%20garbage%20collector/unmanaged%0A%20resources/multi-thread%20issue&In-Reply-To=AANLkTi%3DZ-khOGSPWVzuFcJA2M9Q1fNcDqaSge8%2B7b%3D-M%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036963.html">
   <LINK REL="Next"  HREF="036900.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue</H1>
    <B>matteo tesser</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20sgen%20garbage%20collector/unmanaged%0A%20resources/multi-thread%20issue&In-Reply-To=AANLkTi%3DZ-khOGSPWVzuFcJA2M9Q1fNcDqaSge8%2B7b%3D-M%40mail.gmail.com"
       TITLE="[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue">matteo.tesser at gmail.com
       </A><BR>
    <I>Fri Feb 18 11:33:26 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="036963.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
        <LI>Next message: <A HREF="036900.html">[Mono-dev] Unable to build Mono 2.10 RC4 on x86_64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36974">[ date ]</a>
              <a href="thread.html#36974">[ thread ]</a>
              <a href="subject.html#36974">[ subject ]</a>
              <a href="author.html#36974">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rodrigo,

Yes, I release memory on finalizers (unfortunately I cannot use Disposable
objects). At the moment, I can provide you a binary test, if you can
reproduce the behavior, and it is needed, I can try to exact the relevant
code for the procedure and provide source code, but it takes time.

you can download the test here:

<A HREF="http://fairmat.com/tests/TestGC.tar.gz">http://fairmat.com/tests/TestGC.tar.gz</A>

and run
mono --gs=bohem TestGC.exe

the test in widows and osx uses constant memory, while in linux you should
obtain the following output:

# date: 233
# Maturity: 30
DSOP Initialize time:00:00:09.6344820
Live 186627 Live 349020 Live 490713 Live 549690 Live 579092 Live 691041 Live
832648 Live 978625 Live 1055648 Live 1233333 Live 1378727 Live 1586629 Live
1780660 Live 2035369 Live 2297367 Live 2504015 Live 2748390 Live 3004210
Live 3264366 Live 3508553 Live 3741829 Live 4015918 Live 4280187 Live
4524532 Live 4781589 Live 5041975 Live 5264760 Live 5529215 Live 5764582
Live 6026585 Live 6221326 Live 6460175 Live 6767039 Live 7014641 Live
7243492


the test program continue to evaluate  a function  and writes an estimation
of live instances every N evaluations, which are always increasing in this
case,

Thanks for looking at it,
Matteo



On Thu, Feb 17, 2011 at 8:13 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:

&gt;<i> Hi Matteo,
</I>&gt;<i>
</I>&gt;<i> I suppose you release memory on finalizers. Sgen has a longer cycle
</I>&gt;<i> to finalize objects than boehm. On why extra retention is happening on
</I>&gt;<i> linux is strange and could be a bug. Can you provide a test case that
</I>&gt;<i> shows this behavior?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Feb 11, 2011 at 6:08 PM, matteo tesser &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matteo.tesser at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Rodrigo,
</I>&gt;&gt;<i> OK, taking or not taking into consideration memory pressure is a
</I>&gt;&gt;<i> runtime's implementation choice: if you consider memory pressure, the
</I>&gt;&gt;<i> runtime will be more reactive to memory usage, in the latter case no,
</I>&gt;&gt;<i> but unreferenced objects should be freed sooner or later.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did an additional test: I counted the live object instances of the
</I>&gt;&gt;<i> object type which references the unmanaged resources over time: while
</I>&gt;&gt;<i> in windows and os x the live instances oscillate  between 10K and 60K,
</I>&gt;&gt;<i>  in  linux the live instances arrived to 20 milions. it seems that the
</I>&gt;&gt;<i> GC does not realize that so many objects  have been allocated. Are 20
</I>&gt;&gt;<i> milions objects  still a number that should not trigger the GC ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Probably the problem is not related to unmanaged memory but the
</I>&gt;&gt;<i> particular structure of my problem highlights a defect.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Matteo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Fri, Feb 11, 2011 at 3:34 PM, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Mono doesn't take memory pressure into account. This is probably
</I>&gt;&gt;<i> &gt; what's happening.
</I>&gt;&gt;<i> &gt; On Fri, Feb 11, 2011 at 3:54 PM, matteo tesser &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">matteo.tesser at gmail.com</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Hello,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I have a concurrent programming test  which during 5-10 minutes
</I>&gt;&gt;<i> &gt;&gt; creates and releases a  lot of objects which use unmanaged memory.
</I>&gt;&gt;<i> &gt;&gt; Every managed object,  respectively  allocates/deallocates the
</I>&gt;&gt;<i> &gt;&gt; unmanaged memory using  Marshal.AllocHGlobal and Marshall.FreeHGlobal
</I>&gt;&gt;<i> &gt;&gt; methods  and uses GC.AddMemoryPressure/GC.RemoveMemoryPressure to tell
</I>&gt;&gt;<i> &gt;&gt; to  the garbage collector the presence of the additional memory.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I experienced some memory problems on linux,  so I did several tests:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 1)  In linux machine with openSuse 11.3 64bit dual core with  mono
</I>&gt;&gt;<i> &gt;&gt; 2.8.2,  the program launched with mono --gc=sgen eats 4GB of RAM in
</I>&gt;&gt;<i> &gt;&gt; about two minutes (see attached screenshot).
</I>&gt;&gt;<i> &gt;&gt; If I launch the test by specifying the use of  boehm gc,  the memory
</I>&gt;&gt;<i> &gt;&gt; is still consumed but at smaller rate.
</I>&gt;&gt;<i> &gt;&gt; I tried the test also with mono 2.10p3 and the behavior is the same
</I>&gt;&gt;<i> &gt;&gt; (also using MONO_GC_PARAMS=stack-mark=precise)
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 2) In Windows/.NET the memory footprint  of the program is constant on
</I>&gt;&gt;<i> &gt;&gt; time:  80MB,
</I>&gt;&gt;<i> &gt;&gt; 3) in a dual core mac os x ( with mono 2.10p2) the behavior is the
</I>&gt;&gt;<i> &gt;&gt; same as windows.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; 4) In a Virtual Machine with  linux openSuse 11.3 32bit  and 1
</I>&gt;&gt;<i> &gt;&gt; processor  , mono 2.10p3 the test works fine: the memory footprint  is
</I>&gt;&gt;<i> &gt;&gt; constant at 50MB
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; My conclusion is that the problem is restricted to the linux /
</I>&gt;&gt;<i> &gt;&gt; multi-thread case.
</I>&gt;&gt;<i> &gt;&gt; Are you aware of such issues on sgen?
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I tried to build-up a simple code reproducing the problem but I did
</I>&gt;&gt;<i> &gt;&gt; not managed to do it with a simple test case, in case are you
</I>&gt;&gt;<i> &gt;&gt; interested in a binary test case?
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Thanks,
</I>&gt;&gt;<i> &gt;&gt; Matteo
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;&gt;<i> &gt;&gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110218/15e3f128/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110218/15e3f128/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036963.html">[Mono-dev] sgen garbage collector/unmanaged resources/multi-thread issue
</A></li>
	<LI>Next message: <A HREF="036900.html">[Mono-dev] Unable to build Mono 2.10 RC4 on x86_64
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36974">[ date ]</a>
              <a href="thread.html#36974">[ thread ]</a>
              <a href="subject.html#36974">[ subject ]</a>
              <a href="author.html#36974">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
