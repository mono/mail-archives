<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Communicating native C structs with managed code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Communicating%20native%20C%20structs%20with%20managed%20code&In-Reply-To=%3Ce4ea2e91-9a21-4443-9ddc-a3368ccf0198%40UFO-Net.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044591.html">
   <LINK REL="Next"  HREF="044594.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Communicating native C structs with managed code</H1>
    <B>Ivo Smits</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Communicating%20native%20C%20structs%20with%20managed%20code&In-Reply-To=%3Ce4ea2e91-9a21-4443-9ddc-a3368ccf0198%40UFO-Net.nl%3E"
       TITLE="[Mono-dev] Communicating native C structs with managed code">Ivo at UFO-Net.nl
       </A><BR>
    <I>Sat Jan  6 20:15:53 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044591.html">[Mono-dev] Communicating native C structs with managed code
</A></li>
        <LI>Next message (by thread): <A HREF="044594.html">[Mono-dev] 5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44593">[ date ]</a>
              <a href="thread.html#44593">[ thread ]</a>
              <a href="subject.html#44593">[ subject ]</a>
              <a href="author.html#44593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Ramin,

You can pass native pointers between C and C# using the IntPtr, void* or 
S1* (where S1 is the struct defined below) in P/Invoke calls. You can 
pass a struct to a P/Invoke using the ref modifier, which will, whenever 
possible, also pass a pointer to the struct. You can pass a native 
pointer from C to a ref parameter in a C# function. To use native 
pointers, you have to mark the affected code block as unsafe. For example:

[StructLayout(LayoutKind.Sequential)]
unsafe struct S1 {
     public double x;
     public double y;
     public Int64 z;
     public fixed int arr[256];
};

The unsafe keyword marks the structure as unsafe - it can only contain 
types which do not need marshalling. StructLayout can be used to specify 
the alignment options, usually the default works. StructLayout.Explicit 
and the FieldOffset attribute can be used to place fields at arbitrary 
offsets, for example to create &quot;unions&quot;.

The fixed (int) defines an inline array which behaves like a pointer 
(like it would in C). This array can not be used as a regular array, but 
its members can be accessed using an index. There's no bounds checking.

You can then pass the struct to an external C function using one of the 
following options:
class Test {
       [DllImport(&quot;native.so&quot;)]
       public static extern void nativemethod1(ref S1 arg);
       [DllImport(&quot;native.so&quot;)]
       public static extern void nativemethod2(S1* arg);
       [DllImport(&quot;native.so&quot;)]
       public static extern void nativemethod3(void* arg);
       [DllImport(&quot;native.so&quot;)]
       public static extern void nativemethod4(IntPtr arg);

     unsafe void Test() {
       S1 s = new S1();
       nativemethod1(ref s);
       nativemethod2(&amp;s); //only works because we're in an unsafe block 
and the struct is marked unsafe
       nativemethod3(&amp;s);
       nativemethod4((IntPtr)(&amp;s));
     }
}

The other way around works as well, for example:
class Test {
       [DllImport(&quot;native.so&quot;)]
       public static extern S1* nativemethod1();
       [DllImport(&quot;native.so&quot;)]
       public static extern IntPtr nativemethod3();

     unsafe void Test() {
       S1* s = nativemethod1();
       s = (S1*)nativemethod3(); //cast if you used an IntPtr
       s-&gt;x = 6; //the structure can now be modified directly. Make sure 
it's not released in the native code...
     }
}

--
Ivo


Op 5-1-2018 om 10:59 schreef R Zaghi:
&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> What would be the most performance efficient method to pass a native C 
</I>&gt;<i> struct of primitive data types (memory aligned or compact) to the 
</I>&gt;<i> managed code in Mono/C# and allow modification of its member variables 
</I>&gt;<i> in the managed code?
</I>&gt;<i>
</I>&gt;<i> Do we have anything specific in Mono that helps eliminate manual 
</I>&gt;<i> marshalling on every call? or could we? :)
</I>&gt;<i>
</I>&gt;<i> Say, in the following scenarios:
</I>&gt;<i>
</I>&gt;<i> struct S1 {
</I>&gt;<i> double x,
</I>&gt;<i> double y,
</I>&gt;<i> double z
</I>&gt;<i> };
</I>&gt;<i>
</I>&gt;<i> Or
</I>&gt;<i>
</I>&gt;<i> struct S2 {
</I>&gt;<i> int arr[256]
</I>&gt;<i> };
</I>&gt;<i>
</I>&gt;<i> Or
</I>&gt;<i>
</I>&gt;<i> struct S3 {
</I>&gt;<i> double x,
</I>&gt;<i> int arr[256]
</I>&gt;<i> };
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ramin
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Ramin Zaghi
</I>&gt;<i>
</I>&gt;<i> *Mosaic3DX™ | User Interface Technology*
</I>&gt;<i> St John's Innovation Centre,
</I>&gt;<i> Cowley Road,
</I>&gt;<i> Cambridge,
</I>&gt;<i> CB4 0WS, UK*
</I>&gt;<i> *
</I>&gt;<i> *E*:**<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">rzaghi at mosaic3dx.com</A> &lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">rzaghi at mosaic3dx.com</A>&gt;
</I>&gt;<i> *T*: +44 1223 421 311
</I>&gt;<i> <A HREF="http://linkedin.com/in/raminzaghi">http://linkedin.com/in/raminzaghi</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.dot.net</A>
</I>&gt;<i> <A HREF="http://lists.dot.net/mailman/listinfo/mono-devel-list">http://lists.dot.net/mailman/listinfo/mono-devel-list</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-devel-list/attachments/20180106/6ecc65a3/attachment.html">http://lists.dot.net/pipermail/mono-devel-list/attachments/20180106/6ecc65a3/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044591.html">[Mono-dev] Communicating native C structs with managed code
</A></li>
	<LI>Next message (by thread): <A HREF="044594.html">[Mono-dev] 5.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44593">[ date ]</a>
              <a href="thread.html#44593">[ thread ]</a>
              <a href="subject.html#44593">[ subject ]</a>
              <a href="author.html#44593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
