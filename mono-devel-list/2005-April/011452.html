<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] patch for bugs in ilasm
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20patch%20for%20bugs%20in%20ilasm&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011450.html">
   <LINK REL="Next"  HREF="011453.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] patch for bugs in ilasm</H1>
    <B>Ankit Jain</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20patch%20for%20bugs%20in%20ilasm&In-Reply-To="
       TITLE="[Mono-devel-list] patch for bugs in ilasm">radical at gmail.com
       </A><BR>
    <I>Thu Apr  7 10:49:09 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011450.html">[Mono-devel-list] Patch for DirectoryServices.DirectoryEntry
</A></li>
        <LI>Next message: <A HREF="011453.html">[Mono-devel-list] On the way to make S.R.E generics API more usable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11452">[ date ]</a>
              <a href="thread.html#11452">[ thread ]</a>
              <a href="subject.html#11452">[ subject ]</a>
              <a href="author.html#11452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Attached is a patch for bugs in ilasm.

As almost all the fixes are on the same file (PEAPI.cs), so it wont be
possible to seperate them out.

Also attached are test cases for reproducing the bugs fixed. These were
discovered and fixed while trying to roundtripping on
Microsoft.VisualBasic.dll (monodis ms.vb.dll &gt; vb.il; ilasm /dll vb.il;
PEVerify.exe vb.dll).

After this patch, PEVerify gives zero errors on the final .dll.

The major chunk is for fixing the handling of ValueTypes in ilasm.

case.cs : 
&quot;ref &lt;valuetype&gt;&quot; .. not encoded correctly. Change required in
ClassRefInst.ctor, typeIndex(base) changed to a ValueType. (see patch)

case2.cs : 
 Two problems: 
               1. for array of ValueTypes
               2. ClassRef to ValueType or Enum, gets encoded as a
valuetype. It should be encoded as a ClassRef to System.ValueType or
System.Enum. Only types derived from these are valuetypes.

i1.il : 
 IL allows method params to have same name. ilasm(mono) uses a hashtable to
store named params.. changed that.

i2.il : 
 Type not set for a ByteArrConst (eg. when .param[1] = bytearray (...) )
ByteArray is set to a string by default.

i3.il :
For a float method param
      .param [1] = float64(0x3FB999999999999A)
ILParser converts (0x3f...) to an int64 and then later tries to convert it
into a float, instead of using the in64's exact bit image to build the float.

nes.cs:
For Nested classes, the entry in the TypeDef table for the nested class
should have namespace=&quot;&quot;, as it is built from the NestedClass &amp;
EnclosingClass in the NestedClass table.

t3.il :
An enum declared in IL with no explicit &quot;extends System.Enum&quot; gets
incorrectly encoded as deriving from System.ValueType.
Fixed in the patch.
------------

For testing the .cs testcases, do

mcs case.cs
monodis case.exe &gt; case.il
ilasm case.il

PEVerify.exe case.exe -&gt; This will show the errors.. 

For the .il files just ilasm and peverify them

The files are attached in bugzilla :
<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=74365">http://bugzilla.ximian.com/show_bug.cgi?id=74365</A>

Eagerly awaiting feedback.. 

-Ankit
-- 
Blog :
Mono hacking : <A HREF="http://mono-nosip.blogspot.com">http://mono-nosip.blogspot.com</A>
Personal : <A HREF="http://www.corewars.org/radical">http://www.corewars.org/radical</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ilasm.patch
Type: text/x-patch
Size: 17893 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050407/ffaee44a/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20050407/ffaee44a/attachment.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011450.html">[Mono-devel-list] Patch for DirectoryServices.DirectoryEntry
</A></li>
	<LI>Next message: <A HREF="011453.html">[Mono-devel-list] On the way to make S.R.E generics API more usable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11452">[ date ]</a>
              <a href="thread.html#11452">[ thread ]</a>
              <a href="subject.html#11452">[ subject ]</a>
              <a href="author.html#11452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
