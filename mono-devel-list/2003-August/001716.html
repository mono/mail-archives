<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] portability and 64bit suggestions for mini
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20portability%20and%2064bit%20suggestions%20for%20mini&In-Reply-To=20030804125113.GH32303%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001713.html">
   <LINK REL="Next"  HREF="001710.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] portability and 64bit suggestions for mini</H1>
    <B>Laurent Morichetti</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20portability%20and%2064bit%20suggestions%20for%20mini&In-Reply-To=20030804125113.GH32303%40debian.org"
       TITLE="[Mono-devel-list] portability and 64bit suggestions for mini">l_m at pacbell.net
       </A><BR>
    <I>Mon Aug  4 14:37:42 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001713.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
        <LI>Next message: <A HREF="001710.html">[Mono-devel-list] about Metada
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1716">[ date ]</a>
              <a href="thread.html#1716">[ thread ]</a>
              <a href="subject.html#1716">[ subject ]</a>
              <a href="author.html#1716">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> &gt; - mini needs to differentiate I4 compares from native int compares.
</I>&gt;<i> Could
</I>&gt;<i> &gt; use COMPARE_I4 for integers and COMPARE for native ints (and pointers).
</I>&gt;<i> 
</I>&gt;<i> I guess you mean the COMPARE_IMM opcode needs to be split to COMPARE_IMM
</I>&gt;<i> and COMPARE_IMMP (for pointer-sized integers). The same should happen
</I>&gt;<i> for some of the others _IMM variants.
</I>&gt;<i> We need also to separate signed and unsigned compares for some platforms.
</I>
No, I meant 32bit vs 64bit compares. Say you want to compare (COMPARE (ref,
ref)) you will need to emit (cmp8 (ptr, ptr)) but for (COMPARE (int, int))
you'll emit (cmp4 (int, int)).

Also, is there any code to deal with sign extension when working with both
nati and int? For example (ADD (nati, i32)) =&gt; (add (nati, sxt4 (i32)))?

&gt;<i> &gt; - The invoke part of mono_jit_runtime_invoke needs to be arch dependent.
</I>&gt;<i> On
</I>&gt;<i> &gt; some platforms a function pointer is not the address of the code. Mini
</I>&gt;<i> &gt; should leave the invocation to arch_mono_invoke (gointer code, ...)
</I>&gt;<i> 
</I>&gt;<i> Uhm, I haven't thought through on this yet. There are several places
</I>&gt;<i> where we invoke functions using an address for the code. One solution is
</I>&gt;<i> to make all the functions that return the code address (for execution
</I>&gt;<i> purposes) return the function descriptor instead. This way
</I>&gt;<i> mono_jit_runtime_invoke() would work as is, right? We'll have to audit
</I>&gt;<i> the code to see when the address of the code is requested and when the
</I>&gt;<i> function descriptor is wanted.
</I>&gt;<i> But we also have to decide if internally in the CLR we want to use
</I>&gt;<i> function descriptors or not. We might want to just use the code
</I>&gt;<i> pointer, to avoid the overhead on virtual function calls (function
</I>&gt;<i> descriptors are just used to setup some global register for faster
</I>&gt;<i> access to data: we might want to do it only during unmanaged-&gt;managed
</I>&gt;<i> transitions). I guess we'd have to do some measurements here.
</I>
Right now, I emit the function descriptor at the beginning of each method
and return a pointer to it. It's just that it's only necessary when going
from static to generated code. Internal calls should never use the
descriptor to call a function as it is an indirect branch and can be very
expensive. I'll keep it that way for now (removing it would only save 16
bytes per method).

&gt;<i> &gt; - On platforms where arguments are passed in registers, LDARGA_S will
</I>&gt;<i> not
</I>&gt;<i> &gt; work as (LDARGA_S (OP_REGVAR)). Somehow, mini needs to box the argument
</I>&gt;<i> or
</I>&gt;<i> &gt; reserve some stack space to save it.
</I>&gt;<i> 
</I>&gt;<i> When LDARGA is used on an argument, the argument is marked with the
</I>&gt;<i> MONO_INST_INDIRECT flag: in this case the arch-specific code is supposed
</I>&gt;<i> to allocate the argument on the stack (this is usually called the home
</I>&gt;<i> location). The copy can be easily done in the prolog (just like in the
</I>&gt;<i> x86 code, an argument that is assigned to a register is copied to the
</I>&gt;<i> register in the prolog).
</I>
I'll check the flag and see if I can reserve some space at the top of the
frame for arg register boxing.

&gt;<i> &gt; Is anybody else looking at a 64bit port of mini (sparc)? Would it be
</I>&gt;<i> better
</I>&gt;<i> &gt; to create a 64bit branch for mini so that the current (32bit) work is
</I>&gt;<i> &gt; undisturbed?
</I>&gt;<i> 
</I>&gt;<i> I don't think any other port of mini to 64 bit archs is underway, yet,
</I>&gt;<i> but I don't think a separate branch is needed. Most of mini should be
</I>&gt;<i> (or can be easily changed to be) 64-bit clean and almost all of the
</I>&gt;<i> differences can be abstracted away with a careful use of a few defines.
</I>&gt;<i> You'll need 64-bit specific burg rules, but that's no issue, it can be
</I>&gt;<i> done in a separate file. Also, if a 64 bit change breaks the 32
</I>&gt;<i> bit mini, we can catch it as soon as it hits cvs, instead of all at the
</I>&gt;<i> same time when the merge is done later.
</I>
Sounds good. The things that I need the most right now are the PCONST and
COMPARE changes.

Thanks,
-Laurent


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001713.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
	<LI>Next message: <A HREF="001710.html">[Mono-devel-list] about Metada
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1716">[ date ]</a>
              <a href="thread.html#1716">[ thread ]</a>
              <a href="subject.html#1716">[ subject ]</a>
              <a href="author.html#1716">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
