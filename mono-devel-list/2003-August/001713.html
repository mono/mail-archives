<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] portability and 64bit suggestions for mini
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20portability%20and%2064bit%20suggestions%20for%20mini&In-Reply-To=20030804051105.65DA763069%40skeptopotamus.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001714.html">
   <LINK REL="Next"  HREF="001716.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] portability and 64bit suggestions for mini</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20portability%20and%2064bit%20suggestions%20for%20mini&In-Reply-To=20030804051105.65DA763069%40skeptopotamus.ximian.com"
       TITLE="[Mono-devel-list] portability and 64bit suggestions for mini">lupus at ximian.com
       </A><BR>
    <I>Mon Aug  4 08:51:14 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001714.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
        <LI>Next message: <A HREF="001716.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1713">[ date ]</a>
              <a href="thread.html#1713">[ thread ]</a>
              <a href="subject.html#1713">[ subject ]</a>
              <a href="author.html#1713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08/03/03 Laurent Morichetti wrote:
&gt;<i> I started the port of mini for IPF and here are some of the issues I
</I>
Excellent!

&gt;<i> - MONO_NEW_PCONST needs to emit an OP_PCONST inst. Rules need to be added to
</I>&gt;<i> match the new OP_PCONST inst.
</I>
Yes, I'll add an OP_PCONST opcode (that will just be a #define for
OP_ICONST on 32 bit systems).

&gt;<i> - mini needs to differentiate I4 compares from native int compares. Could
</I>&gt;<i> use COMPARE_I4 for integers and COMPARE for native ints (and pointers).
</I>
I guess you mean the COMPARE_IMM opcode needs to be split to COMPARE_IMM
and COMPARE_IMMP (for pointer-sized integers). The same should happen
for some of the others _IMM variants.
We need also to separate signed and unsigned compares for some platforms.

&gt;<i> - The invoke part of mono_jit_runtime_invoke needs to be arch dependent. On
</I>&gt;<i> some platforms a function pointer is not the address of the code. Mini
</I>&gt;<i> should leave the invocation to arch_mono_invoke (gointer code, ...)
</I>
Uhm, I haven't thought through on this yet. There are several places
where we invoke functions using an address for the code. One solution is
to make all the functions that return the code address (for execution
purposes) return the function descriptor instead. This way
mono_jit_runtime_invoke() would work as is, right? We'll have to audit
the code to see when the address of the code is requested and when the
function descriptor is wanted.
But we also have to decide if internally in the CLR we want to use
function descriptors or not. We might want to just use the code
pointer, to avoid the overhead on virtual function calls (function
descriptors are just used to setup some global register for faster
access to data: we might want to do it only during unmanaged-&gt;managed
transitions). I guess we'd have to do some measurements here.

&gt;<i> - On platforms where arguments are passed in registers, LDARGA_S will not
</I>&gt;<i> work as (LDARGA_S (OP_REGVAR)). Somehow, mini needs to box the argument or
</I>&gt;<i> reserve some stack space to save it.
</I>
When LDARGA is used on an argument, the argument is marked with the
MONO_INST_INDIRECT flag: in this case the arch-specific code is supposed
to allocate the argument on the stack (this is usually called the home
location). The copy can be easily done in the prolog (just like in the
x86 code, an argument that is assigned to a register is copied to the
register in the prolog).

&gt;<i> Is anybody else looking at a 64bit port of mini (sparc)? Would it be better
</I>&gt;<i> to create a 64bit branch for mini so that the current (32bit) work is
</I>&gt;<i> undisturbed?
</I>
I don't think any other port of mini to 64 bit archs is underway, yet,
but I don't think a separate branch is needed. Most of mini should be
(or can be easily changed to be) 64-bit clean and almost all of the
differences can be abstracted away with a careful use of a few defines.
You'll need 64-bit specific burg rules, but that's no issue, it can be
done in a separate file. Also, if a 64 bit change breaks the 32
bit mini, we can catch it as soon as it hits cvs, instead of all at the
same time when the merge is done later.
Thanks!

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001714.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
	<LI>Next message: <A HREF="001716.html">[Mono-devel-list] portability and 64bit suggestions for mini
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1713">[ date ]</a>
              <a href="thread.html#1713">[ thread ]</a>
              <a href="subject.html#1713">[ subject ]</a>
              <a href="author.html#1713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
