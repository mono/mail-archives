<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] NancyFX self hosting (HttpListener) locking up on	linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20NancyFX%20self%20hosting%20%28HttpListener%29%20locking%20up%20on%0A%09linux&In-Reply-To=%3CCAN5%3DXTBYU469L6gutK-cYnuuUCMAFvDO0hiPRwbA3f7nnQijXQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040657.html">
   <LINK REL="Next"  HREF="040658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] NancyFX self hosting (HttpListener) locking up on	linux</H1>
    <B>Yuriy Solodkyy</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20NancyFX%20self%20hosting%20%28HttpListener%29%20locking%20up%20on%0A%09linux&In-Reply-To=%3CCAN5%3DXTBYU469L6gutK-cYnuuUCMAFvDO0hiPRwbA3f7nnQijXQ%40mail.gmail.com%3E"
       TITLE="[Mono-dev] NancyFX self hosting (HttpListener) locking up on	linux">yuriy at couldbedone.com
       </A><BR>
    <I>Sun Aug  4 21:32:11 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040657.html">[Mono-dev] NancyFX self hosting (HttpListener) locking up on linux
</A></li>
        <LI>Next message: <A HREF="040658.html">[Mono-dev] NancyFX self hosting (HttpListener) locking up on linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40662">[ date ]</a>
              <a href="thread.html#40662">[ thread ]</a>
              <a href="subject.html#40662">[ subject ]</a>
              <a href="author.html#40662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

two notes:

1)

&gt;&gt;<i> That should have the fix in from <A HREF="https://github.com/ysw,">https://github.com/ysw,</A> but setting MONO_DISABLE_AIO
</I>should have worked around that anyway, as its meant to bypass the epoll
backend.
The problem we attempted to fix with async sockets is not only with epoll
backend.  i could reproduce it with plain poll backend as well.  Moreover
the patch we submitted only addresses it for epoll/kqueue and leaves poll
backend unpatched.

2)  From what I understand it is very unlikely it is related to the problem
described here.  The problem we fixed can only be observed if you have
parallel read and write operations on the same socket which is unlikely to
happen in RPC style protocols like HTTP, unless you do request pipelining
from the client.  However, if it is the same problem,  MONO_DISABLE_AIO won't
help as poll backend is not better than epoll/kqueue in this case.

-yuriy


On Sun, Aug 4, 2013 at 2:17 PM, Alfred Hall &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ahall at ahall.org</A>&gt; wrote:

&gt;<i> **
</I>&gt;<i> I meant to say I tried master too:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">root at mulder</A>:~# /opt/ahall-mono/bin/mono -V
</I>&gt;<i> Mono JIT compiler version 3.3.0 (master/2354865 Sun Aug  4 00:42:51 BST
</I>&gt;<i> 2013)
</I>&gt;<i> Copyright (C) 2002-2012 Novell, Inc, Xamarin Inc and Contributors.
</I>&gt;<i> www.mono-project.com
</I>&gt;<i> TLS:           __thread
</I>&gt;<i>  SIGSEGV:       altstack
</I>&gt;<i> Notifications: epoll
</I>&gt;<i> Architecture:  amd64
</I>&gt;<i>  Disabled:      none
</I>&gt;<i> Misc:          softdebug
</I>&gt;<i> LLVM:          supported, not enabled.
</I>&gt;<i>  GC:            sgen
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That should have the fix in from <A HREF="https://github.com/ysw,">https://github.com/ysw,</A> but setting MONO_DISABLE_AIO should have worked around that anyway, as its meant to bypass the epoll backend.
</I>&gt;<i>
</I>&gt;<i> My Nancy service is literally just returning a very simple JSON:
</I>&gt;<i>
</I>&gt;<i>     public class HelloWorldModule : NancyModule
</I>&gt;<i>     {
</I>&gt;<i>         public HelloWorldModule()
</I>&gt;<i>         {
</I>&gt;<i>             Get[&quot;/&quot;] = parameters =&gt; {
</I>&gt;<i>                 return Response.AsJson(new HomeResponse { Message = &quot;Test&quot; });
</I>&gt;<i>             };
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i> In JMeter I'm using 100 threads and loop count of 100 and it locks up
</I>&gt;<i> after like 15 seconds even over the network. Very odd.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original message-----
</I>&gt;<i> &gt; From:&quot;Andr&#233;s G. Aragoneses&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">knocte at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i> &gt; Sent: Sunday 4th August 2013 10:03
</I>&gt;<i> &gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>
</I>&gt;<i> &gt; Subject: Re: [Mono-dev] NancyFX self hosting (HttpListener) locking up on linux
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 04/08/13 03:07, Alfred Hall wrote:
</I>&gt;<i> &gt; &gt; Hi there.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm running the NancyFX web framework in self hosting mode which is
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; using HttpListener which basically means I deploy an executable and run
</I>&gt;<i> &gt; &gt; it and it will start a webserver on localhost on a TCP port of choice. I
</I>&gt;<i> &gt; &gt; then use nginx to proxy to it.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; I first ran my executable on my macbook pro and bombarded it with jmeter
</I>&gt;<i> &gt; &gt; and it coped fine and no issues.
</I>&gt;<i> &gt; &gt; I then deployed on my debian wheezy 64 bit linux box running on top of
</I>&gt;<i> &gt; &gt; KVM using mono 3.2.0 and performed the same jmeter experiment. It locks
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; up fairly quickly and wont take any new requests. I've tried using both
</I>&gt;<i> &gt; &gt; sgen and boehm but they behave similarly although it seems to lock up
</I>&gt;<i> &gt; &gt; faster when using sgen. I also tried enabling MONO_DISABLE_AIO but it
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; doesn't make any difference.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Anyone had similar issues?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I tried using self hosted ServiceStack which also uses HttpListener and
</I>&gt;<i> &gt; &gt; had similar issues so I'm finding it unlikely that the bug is in NancyFX
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; itself.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I tried installing mono 2.10.8 to check if this is a regression, but
</I>&gt;<i> &gt; &gt; getting exactly the same results.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Any idea how I can debug this further or what could be going on.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hey Alfred.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Could you try mono master (3.3) instead of 3.2? I mention this because
</I>&gt;<i> &gt; this pull request [1] has been merged recently, which could help in this
</I>&gt;<i> &gt; situation (and wouldn't make much difference in Mac since the problem in
</I>&gt;<i>
</I>&gt;<i> &gt; this platform is worked-around by avoiding kqueue [2]).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [1] <A HREF="https://github.com/mono/mono/pull/703">https://github.com/mono/mono/pull/703</A>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [2] <A HREF="https://github.com/mono/mono/blob/master/configure.in#L1823">https://github.com/mono/mono/blob/master/configure.in#L1823</A>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Yuriy Solodkyy
(<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">y.solodkyy at gmail.com</A>)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130805/70a9e6dd/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130805/70a9e6dd/attachment-0001.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040657.html">[Mono-dev] NancyFX self hosting (HttpListener) locking up on linux
</A></li>
	<LI>Next message: <A HREF="040658.html">[Mono-dev] NancyFX self hosting (HttpListener) locking up on linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40662">[ date ]</a>
              <a href="thread.html#40662">[ thread ]</a>
              <a href="subject.html#40662">[ subject ]</a>
              <a href="author.html#40662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
