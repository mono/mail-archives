<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Emedding mono: System.Windows.Form trouble
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Emedding%20mono%3A%20System.Windows.Form%20trouble&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037059.html">
   <LINK REL="Next"  HREF="037061.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Emedding mono: System.Windows.Form trouble</H1>
    <B>Guy Sherman</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Emedding%20mono%3A%20System.Windows.Form%20trouble&In-Reply-To="
       TITLE="[Mono-dev] Emedding mono: System.Windows.Form trouble">guy at guysherman.com
       </A><BR>
    <I>Thu Mar  3 05:09:54 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037059.html">[Mono-dev] Fwd:  Mono build procedure
</A></li>
        <LI>Next message: <A HREF="037061.html">[Mono-dev] Emedding mono: System.Windows.Form trouble
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37060">[ date ]</a>
              <a href="thread.html#37060">[ thread ]</a>
              <a href="subject.html#37060">[ subject ]</a>
              <a href="author.html#37060">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

 

I'm working on a sandbox game engine, with mono as the scripting language.
Tonight I got it to attach a DirectX rendering context to a Windows Forms
window created by some .NET code running in mono.

 

I have injected two methods into the runtime:

 

void Renderer::RegisterScriptingInterface()
{
                mono_add_internal_call (&quot;RendererServices::CreateRenderer&quot;,
Renderer::CreateRenderer);
                mono_add_internal_call (&quot;RendererServices::RendererDraw&quot;,
Renderer::RendererDraw);
}

 

 

and have wrapped them appropriately in a C# class with externs, and they
work.

 

Now, I naively thought that I could spin up a window, and have a timer
calling Invalidate(), with an overridden paint which calls RendererDraw
above. The problem is that my timer does not seem to fire. Paint is working
because it calls draw once, and also sometimes when I resize the window (so
when it is invalidated it calls my overridden paint which calls my c++
code).

 

I then tried setting up a thread in the Form's Load method, which
continuously calls RendererDraw, but again, it does not seem to work. The
partial class for my form is below.

 

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Threading;

 
namespace TestPlugin
{
    public partial class MainForm : Form
    {
        private Thread t;
        
        public MainForm()
        {
            InitializeComponent();
            //timer1.Enabled = true;
            //timer1.Start();

            
        }

        private void timer1_Tick(object sender, EventArgs e)
        {
            Invalidate();
            RendererServices.RendererDraw(this.Handle);
        }

        private void MainForm_Paint(object sender, PaintEventArgs e)
        {
            RendererServices.RendererDraw(this.Handle);
        }

        private void drawRepeatedly()
        {
            while (true)
            {
                RendererServices.RendererDraw(this.Handle);
            }

        }

        private void MainForm_Load(object sender, EventArgs e)
        {
            t = new Thread(new ThreadStart(drawRepeatedly));
            t.Start();
        }

        private void button1_Click(object sender, EventArgs e)
        {
            RendererServices.RendererDraw(this.Handle);
        }

        private void MainForm_DoubleClick(object sender, EventArgs e)
        {

        }

        private void MainForm_Click(object sender, EventArgs e)
        {
            RendererServices.RendererDraw(this.Handle);
        }
    }
}

 

You can probably see that I also tried hooking up the on-click event, and a
button. The button didn't show up (probably because I gave the window handle
to DirectX), but the click event didn't seem to be getting raised (although
I wonder if this is because I gave the handle to DirectX. I also tried (but
haven't copied the source) giving DirectX the handle of a panel instead of
the window itself, but still no dice.

 

I'm not expecting a whole lot of help on the DirectX side, but I'm just
wondering if there is something special to do with the UI thread etc when
running a Windows Forms window via the mono embedding api.

 

Oh yeah, the window is created by another piece of .net code.

 

public class PluginHost
    {
        private MainForm mainForm;
        
        public void Start()
        {
            mainForm = new MainForm();
            mainForm.Show();
            
        }
    }

 

which is itself called via the embedding api as follows (not the actual code
but you get the idea).

 

int main()

{

// some stuff

 

mono_config_parse (NULL);

domain = mono_jit_init (file);
assembly = mono_domain_assembly_open(domain, file);
image = mono_assembly_get_image(assembly);

 

// Then I register my internal calls as above

 

//I use a generated wrapper class to construct the PluginHost and call Start
but it boils down to

result = mono_object_new( this-&gt;domain, this-&gt;me /* the MonoImage* */ );

mono_runtime_object_init( result );

 

mono_runtime_invoke( this-&gt;StartMonoMethod, target, args, NULL );  

 

// more stuff

}

 

The program then continues on to process the main event loop of the C++ side
of things.

 

Do I need to call the mono_runtime_invoke above in its own thread, and in my
PluginHost class do an Application.Run(mainForm)?

 

 


Thanks in advance for your help.

 

Guy.

 

Guy Sherman

web: <A HREF="http://www.guysherman.com">http://www.guysherman.com</A>

email: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">guy at guysherman.com</A>

phone: +64 21 355 190

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110303/b592cfc1/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110303/b592cfc1/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037059.html">[Mono-dev] Fwd:  Mono build procedure
</A></li>
	<LI>Next message: <A HREF="037061.html">[Mono-dev] Emedding mono: System.Windows.Form trouble
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37060">[ date ]</a>
              <a href="thread.html#37060">[ thread ]</a>
              <a href="subject.html#37060">[ subject ]</a>
              <a href="author.html#37060">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
