<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Faster
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Faster&In-Reply-To=4D8B721E.8010001%40lyngvig.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037243.html">
   <LINK REL="Next"  HREF="037247.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Faster</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Faster&In-Reply-To=4D8B721E.8010001%40lyngvig.org"
       TITLE="[Mono-dev] Faster">kumpera at gmail.com
       </A><BR>
    <I>Thu Mar 24 12:51:35 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="037243.html">[Mono-dev] Faster
</A></li>
        <LI>Next message: <A HREF="037247.html">[Mono-dev] Faster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37246">[ date ]</a>
              <a href="thread.html#37246">[ thread ]</a>
              <a href="subject.html#37246">[ subject ]</a>
              <a href="author.html#37246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Mono uses zero cost exception handling, so setting up a try-catch handler
has zero cost.

That's the theory, but using try-catch blocks have a few undesirable
implications to control-flow.
The problem are variables that are used in the catch block, for example:

int x;
try {
  x = 1;
  MayThrow ();
  x = 2;
  MayThrow ();
  x = 3;
} catch (Exception) {
  Console.WriteLine (x);
}

On the above code, when we reach the catch block, we can't statically know
which assignment was the last to execute, so we have
to make sure they all use the same storage - which is a very hard problem to
solve.

Mono's current JIT takes the easy solution which is to mark all those
variables as volatile, which has the unfortunate effect of producing
code outside the catch block that is quite worse than otherwise. So, EH has
a very low overhead, but should not be used for those cases.

Now onto the null check. Such a null check will exploit a cpu feature known
as branch prediction, which guesses the outcome of the
conditional jump. Since in the majority of the cases the value won't be
null, the cpu can pretend the branch doesn't exist and keep executing
as it was not taken. This means the null check costs virtually nothing on a
modern cpu.



On Thu, Mar 24, 2011 at 5:32 PM, Mikael Lyngvig &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mikael at lyngvig.org</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm not an expert on the JIT compiler and such, but I do know that in
</I>&gt;<i> virtually all programming languages that support exception handling, the
</I>&gt;<i> cost of a null-check is infinitesimal compared to the cost of setting up
</I>&gt;<i> an exception handler.  On many systems, setting up a try-catch handler
</I>&gt;<i> costs something like 200 instructions whereas the null check only costs
</I>&gt;<i> one or two instructions.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Mikael
</I>&gt;<i>
</I>&gt;<i> Den 24-03-2011 17:06, Steve Bjorg skrev:
</I>&gt;<i> &gt; Is the cost of the if-null check greater than setting up an exception
</I>&gt;<i> catch handler?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - Steve
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ---------------------------------
</I>&gt;<i> &gt; Steve G. Bjorg
</I>&gt;<i> &gt; MindTouch
</I>&gt;<i> &gt; San Diego, CA
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 619.795.8459 office
</I>&gt;<i> &gt; 425.891.5913 mobile
</I>&gt;<i> &gt; <A HREF="http://twitter.com/bjorg">http://twitter.com/bjorg</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Mar 24, 2011, at 9:00 AM, Miguel de Icaza wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hello guys,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Today in the shower I had an idea that I believe we could use to
</I>&gt;<i> &gt;&gt; improve the performance of our class library code.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Plenty of our class library code has code like this:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; void Foo (Something x)
</I>&gt;<i> &gt;&gt; {
</I>&gt;<i> &gt;&gt;     if (x == null)
</I>&gt;<i> &gt;&gt;         throw new ArgumentNullException (&quot;x&quot;);
</I>&gt;<i> &gt;&gt;     x.DoSomething ();
</I>&gt;<i> &gt;&gt;     x.AndThenMore ();
</I>&gt;<i> &gt;&gt; }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Arguably, if this could be inlined, and the JIT could prove that x is
</I>&gt;<i> &gt;&gt; not null, we would skip the first test, for example:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Foo (new Something ());
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; But this is the exception, in general, the JIT would not be able to
</I>&gt;<i> &gt;&gt; know this kind of information for even trivial uses like:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Foo (Bar.GetSomething ());
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Rendering the optimization not very effective.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; But what if we changed our code in Foo across our class libraries to
</I>&gt;<i> &gt;&gt; do this instead:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; void Foo (Something x)
</I>&gt;<i> &gt;&gt; {
</I>&gt;<i> &gt;&gt;     try {
</I>&gt;<i> &gt;&gt;         x.DoSomething ();
</I>&gt;<i> &gt;&gt;     } catch (NullReferenceException e){
</I>&gt;<i> &gt;&gt;         if (x == null)
</I>&gt;<i> &gt;&gt;              throw new ArgumentNullException (&quot;x&quot;);
</I>&gt;<i> &gt;&gt;         else
</I>&gt;<i> &gt;&gt;               throw;
</I>&gt;<i> &gt;&gt;     }
</I>&gt;<i> &gt;&gt;     x.AndThenMore ();
</I>&gt;<i> &gt;&gt; }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This has the advantage that the test for the value of &quot;x&quot; being null
</I>&gt;<i> &gt;&gt; is delayed until we actually need it.    The downside of course is
</I>&gt;<i> &gt;&gt; that DoSomething could actually take other forms and might end up
</I>&gt;<i> &gt;&gt; running code that we do not need before it touches x, for example,
</I>&gt;<i> &gt;&gt; this would be a problem:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; // We should never add null values.
</I>&gt;<i> &gt;&gt; void AddToCache (Something x)
</I>&gt;<i> &gt;&gt; {
</I>&gt;<i> &gt;&gt;     cache.Add (x);
</I>&gt;<i> &gt;&gt; }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; void Foo (Something x)
</I>&gt;<i> &gt;&gt; {
</I>&gt;<i> &gt;&gt;       if (x == null)
</I>&gt;<i> &gt;&gt;           throw new ArgumentNullException (&quot;x&quot;);
</I>&gt;<i> &gt;&gt;       AddToCache (x);
</I>&gt;<i> &gt;&gt; }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; If we rewrite the above code, we would end up with a bug like the one
</I>&gt;<i> &gt;&gt; I described.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Miguel
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Mono-devel-list mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110324/2dfcddac/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20110324/2dfcddac/attachment-0001.html</A> 
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037243.html">[Mono-dev] Faster
</A></li>
	<LI>Next message: <A HREF="037247.html">[Mono-dev] Faster
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37246">[ date ]</a>
              <a href="thread.html#37246">[ thread ]</a>
              <a href="subject.html#37246">[ subject ]</a>
              <a href="author.html#37246">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
