<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Re: Please Help : Leak of wapi handles
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20Please%20Help%20%3A%20Leak%20of%20wapi%20handles&In-Reply-To=1146955282.7350.341.camel%40linux.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018493.html">
   <LINK REL="Next"  HREF="018523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Re: Please Help : Leak of wapi handles</H1>
    <B>Jonathan Gilbert</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20Please%20Help%20%3A%20Leak%20of%20wapi%20handles&In-Reply-To=1146955282.7350.341.camel%40linux.site"
       TITLE="[Mono-dev] Re: Please Help : Leak of wapi handles">2a5gjx302 at sneakemail.com
       </A><BR>
    <I>Sat May  6 23:49:00 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018493.html">[Mono-dev] Re: Please Help : Leak of wapi handles
</A></li>
        <LI>Next message: <A HREF="018523.html">[Mono-dev] Re: Please Help : Leak of wapi handles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18494">[ date ]</a>
              <a href="thread.html#18494">[ thread ]</a>
              <a href="subject.html#18494">[ subject ]</a>
              <a href="author.html#18494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 06:41 PM 06/05/2006 -0400, Miguel de Icaza wrote:
&gt;<i>Hello,
</I>&gt;<i>
</I>&gt;&gt;<i> You probably mean this fix:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/pipermail/mono-patches/2006-May/074236.html">http://lists.ximian.com/pipermail/mono-patches/2006-May/074236.html</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> It doesn't fix the thread handles ref leaks I experienced.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I was able to fix it by changing io-layer/threads.cs:GetCurrentThread
</I>&gt;&gt;<i> to not ref the handle. I'm not sure about the side effects, still
</I>&gt;&gt;<i> testing.
</I>&gt;<i>
</I>&gt;<i>Ah, I felt that would help.
</I>&gt;<i>
</I>&gt;<i>Taking the ref inside GetCurrentThread in my opinion is an incorrect
</I>&gt;<i>change.   But I do not understand the ChangeLog entry nor why was that
</I>&gt;<i>patch supposed to fix the other bug (or if the other bug listed on the
</I>&gt;<i>SVN commit message is even the same fix).
</I>
As I understand it, the problem is that while certainly whenever a handle
is created, it must represent a reference to the underlying object, the
Windows GetCurrentThread() function doesn't actually create a handle. The
comment block above the function in io-layer/threads.c reflects this (and
it is, of course, documented in MSDN). If you create an actual handle but
you don't increment the underlying object's reference count, then when the
handle is closed, it'll decrement the reference count with no matching
increment and the object will end up being released early, before the last
handle is closed. What it boils down to is that it *is* correct behaviour
for GetCurrentThread to not increase the reference count, but it is not
correct behaviour for it to create a handle. Indeed, anyone following the
MSDN documentation will not even bother to pass the handle GetCurrentThread
returns into CloseHandle, so while in that situation, the object wouldn't
end up being freed early as the reference count decrement in CloseHandle
would never happen, a memory leak (albeit a small one) would occur (the
size of whatever sits between a HANDLE and the underlying object). This
leak is very likely what is causing the original poster's defect.

The log message at the quoted URL also confuses me; it looks as though
Gonzalo thinks io-layer's GetCurrentThread() is already matching
Microsoft's pseudohandle behaviour. Certainly, though, the patch is correct
if that code ever has to run on Windows (..and it'll also be correct
if/when mono starts using pseudohandles too). :-) 

Jonathan Gilbert

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018493.html">[Mono-dev] Re: Please Help : Leak of wapi handles
</A></li>
	<LI>Next message: <A HREF="018523.html">[Mono-dev] Re: Please Help : Leak of wapi handles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18494">[ date ]</a>
              <a href="thread.html#18494">[ thread ]</a>
              <a href="subject.html#18494">[ subject ]</a>
              <a href="author.html#18494">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
