<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for HttpRequest.cs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20HttpRequest.cs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018545.html">
   <LINK REL="Next"  HREF="018537.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for HttpRequest.cs</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20HttpRequest.cs&In-Reply-To="
       TITLE="[Mono-dev] Patch for HttpRequest.cs">kornelpal at gmail.com
       </A><BR>
    <I>Tue May  9 09:09:03 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018545.html">[Mono-dev] System.Web.UI/TemplateParser.cs patch
</A></li>
        <LI>Next message: <A HREF="018537.html">[Mono-dev] HttpHandlerAction cosmetic patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18536">[ date ]</a>
              <a href="thread.html#18536">[ thread ]</a>
              <a href="subject.html#18536">[ subject ]</a>
              <a href="author.html#18536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Currently mod_mono and XSP uses UTF-8 to decode query string and UrlDecode 
uses UTF-8 as well.

Do we prefer to use UTF-8 for query string anyway or should we use 
ContentEncoding for query string as well just like MS.NET does?

Note that if we want to use ContentEncoding for query string as well XSP and 
mod_mono should be modified to return the original byte array in 
GetQueryStringRawBytes().

Korn&#233;l

----- Original Message ----- 
From: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
To: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
Cc: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;; 
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, May 08, 2006 5:16 PM
Subject: Re: [Mono-dev] Patch for HttpRequest.cs


&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> The difference you missed (actually I missed this as well as I don't use 
</I>&gt;<i> this constructor:) is that public HttpRequest(string filename, string url, 
</I>&gt;<i> string queryString) of MS.NET seems to initialize QueryString to a 
</I>&gt;<i> NameValueCollection using Encoding.Default as a hard coded encoding (when 
</I>&gt;<i> I changed default code page in Control Panel the encoding used changed so 
</I>&gt;<i> this is Encoding.Default for sure, and no configuration is used). When 
</I>&gt;<i> HttpRequest is created from a HttpWorkerRequest query string is processed 
</I>&gt;<i> only when QueryString property is accessed for the first time.
</I>&gt;<i>
</I>&gt;<i> As query string is processed only once, changing 
</I>&gt;<i> HttpRequest.ContentEncoding has effect only if you change (either 
</I>&gt;<i> programatically, in configuration or using HTTP headers) it before 
</I>&gt;<i> accessing QueryString.
</I>&gt;<i>
</I>&gt;<i> So query string parsing should be moved to a separate method that takes 
</I>&gt;<i> encoding as a parameter. And call with Encoding.Default in the public 
</I>&gt;<i> constructor and with HttpRequest.ContentEncoding in QueryString (and of 
</I>&gt;<i> course only when it was not yet parsed).
</I>&gt;<i>
</I>&gt;<i> Korn&#233;l
</I>&gt;<i>
</I>&gt;<i> ----- Original Message ----- 
</I>&gt;<i> From: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
</I>&gt;<i> To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
</I>&gt;<i> Cc: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;; 
</I>&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Sent: Monday, May 08, 2006 1:41 PM
</I>&gt;<i> Subject: Re: [Mono-dev] Patch for HttpRequest.cs
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was talking about the encoding used during the URL decoding only. My
</I>&gt;&gt;<i> patch fixes that. Running the attached test program demonstrates the
</I>&gt;&gt;<i> need to call HttpUtility.UrlDecode with Latin1 encoding to match MS
</I>&gt;&gt;<i> behaviour. No matter what encoding is set in
</I>&gt;&gt;<i> HttpRequest.ContentEncoding, MS.NET always URL decodes &quot;%e4&quot; to &quot;&#228;&quot;, so
</I>&gt;&gt;<i> it must _always_ be calling
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HttpUtility.UrlDecode(&quot;%e4&quot;, Encoding.GetEncoding(&quot;latin1&quot;))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Or am I missing something? Any feedback appreciated!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Juraj
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, 2006-05-08 at 12:57 +0200, Korn&#233;l P&#225;l wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> You are wrong. HttpRequest.QueryString does the following on MS.NET:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The only encoding it uses is HttpRequest.ContentEncoding. It tries to 
</I>&gt;&gt;&gt;<i> obtain
</I>&gt;&gt;&gt;<i> HttpWorkerRequest.GetQueryStringRawBytes(). If it fails then falls back 
</I>&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;<i> HttpWorkerRequest.GetQueryString(). When it was able to obtain the byte
</I>&gt;&gt;&gt;<i> array it will decode it using HttpRequest.ContentEncoding.GetString(). 
</I>&gt;&gt;&gt;<i> As
</I>&gt;&gt;&gt;<i> such query string is decoded correctly. When no byte array is available 
</I>&gt;&gt;&gt;<i> in
</I>&gt;&gt;&gt;<i> HttpWorkerRequest or the query string was set either in constructor or 
</I>&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;<i> HttpContext.RewritePath for example the string is assumed to be decoded
</I>&gt;&gt;&gt;<i> correctly so no decoding is done.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now we have a string that still may be URL encoded. MS.NET probably 
</I>&gt;&gt;&gt;<i> calls
</I>&gt;&gt;&gt;<i> HttpUtility.UrlDecode just like we do but MS.NET passes
</I>&gt;&gt;&gt;<i> HttpRequest.ContentEncoding as well because query string is assumed to 
</I>&gt;&gt;&gt;<i> be
</I>&gt;&gt;&gt;<i> URL encoded using that encoding.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Note that obtaining query string from HttpWorkerRequest in the 
</I>&gt;&gt;&gt;<i> constructor
</I>&gt;&gt;&gt;<i> as we currently do is a wrong implementation as 
</I>&gt;&gt;&gt;<i> HttpRequest.ContentEncoding
</I>&gt;&gt;&gt;<i> can be changed before HttpRequest.QueryString is first accessed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We should do the following:
</I>&gt;&gt;&gt;<i> - delay query string processing until it is needed (don't obtain query
</I>&gt;&gt;&gt;<i> string in the constructor)
</I>&gt;&gt;&gt;<i> - try HttpWorkerRequest.GetQueryStringRawBytes() as well
</I>&gt;&gt;&gt;<i> - use HttpRequest.ContentEncoding to decode the byte array and for
</I>&gt;&gt;&gt;<i> HttpUtility.UrlDecode
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Korn&#233;l
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ----- Original Message ----- 
</I>&gt;&gt;&gt;<i> From: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
</I>&gt;&gt;&gt;<i> To: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;
</I>&gt;&gt;&gt;<i> Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;&gt;<i> Sent: Monday, May 08, 2006 12:22 PM
</I>&gt;&gt;&gt;<i> Subject: Re: [Mono-dev] Patch for HttpRequest.cs
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt; Hello,
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt; After running more tests, I've found out that on MS.NET the decoding 
</I>&gt;&gt;&gt;<i> &gt; in
</I>&gt;&gt;&gt;<i> &gt; HttpRequest.QueryString does _not_ depend on
</I>&gt;&gt;&gt;<i> &gt; HttpRequest.ContentEncoding. In fact, MS seems to be always using 
</I>&gt;&gt;&gt;<i> &gt; Latin1
</I>&gt;&gt;&gt;<i> &gt; here. All other standard encodings fail.
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt; A revised patch is attached, including a NUnit test case. If no one
</I>&gt;&gt;&gt;<i> &gt; objects, I'll commit.
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt; - Juraj
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt; On Sat, 2006-05-06 at 13:47 -0400, Miguel de Icaza wrote:
</I>&gt;&gt;&gt;<i> &gt;&gt; Hello Juraj,
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; The attached patch makes sure that the get-parameters in 
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; QueryString
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; are
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; url-decoded using the proper encoding (when creating the
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; NameValueCollection).
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; &gt; May I commit?
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; Could you provide NUnit tests for this case?
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;&gt; Miguel
</I>&gt;&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --------------------------------------------------------------------------------
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018545.html">[Mono-dev] System.Web.UI/TemplateParser.cs patch
</A></li>
	<LI>Next message: <A HREF="018537.html">[Mono-dev] HttpHandlerAction cosmetic patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18536">[ date ]</a>
              <a href="thread.html#18536">[ thread ]</a>
              <a href="subject.html#18536">[ subject ]</a>
              <a href="author.html#18536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
