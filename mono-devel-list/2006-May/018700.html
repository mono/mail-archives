<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for HttpRequest.cs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20HttpRequest.cs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018699.html">
   <LINK REL="Next"  HREF="018702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for HttpRequest.cs</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20HttpRequest.cs&In-Reply-To="
       TITLE="[Mono-dev] Patch for HttpRequest.cs">kornelpal at gmail.com
       </A><BR>
    <I>Fri May 26 09:46:03 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018699.html">[Mono-dev] Patch for HttpRequest.cs
</A></li>
        <LI>Next message: <A HREF="018702.html">[Mono-dev] Patch for HttpRequest.cs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18700">[ date ]</a>
              <a href="thread.html#18700">[ thread ]</a>
              <a href="subject.html#18700">[ subject ]</a>
              <a href="author.html#18700">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I didn't do performance tests but the original core ParseQueryString 
implementation may be faster. You should give it a try. I didn't evaluate 
whether movig string query_string to UrlComponents is good so I don't know 
but I like the other modifications. Of course I think you should wait for an 
approval.

Korn&#233;l

----- Original Message ----- 
From: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
Cc: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;; 
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Friday, May 26, 2006 3:26 PM
Subject: Re: [Mono-dev] Patch for HttpRequest.cs


&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Thanks for the comments and modifications. I've added two more:
</I>&gt;<i>
</I>&gt;<i> - cosmetic: rename variable query_string_nvc to query_string
</I>&gt;<i> - avoid code duplication: use HttpUtility.ParseQueryString in
</I>&gt;<i> HttpRequest
</I>&gt;<i> - move core of HttpUtility.ParseQueryString into an internal method
</I>&gt;<i> (which fills the NameValueCollection passed to it)
</I>&gt;<i>
</I>&gt;<i> With the new patch applied, the NUnit tests for System.Web show only the
</I>&gt;<i> one failure I've already mentioned. If it were up to me, I would prefer
</I>&gt;<i> to add a comment and disable it, as we are copying broken behavior. What
</I>&gt;<i> do you think?
</I>&gt;<i>
</I>&gt;<i> I will do some more testing with a few websites of our own. If
</I>&gt;<i> everything works fine, I would like to commit the changes.
</I>&gt;<i>
</I>&gt;<i> - Juraj
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, 2006-05-26 at 10:50 +0200, Korn&#233;l P&#225;l wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I looked at the patch and I have the following comments:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;public HttpRequest (string filename, string url, string queryString)
</I>&gt;&gt;<i> &gt;...
</I>&gt;&gt;<i> &gt;url_components.Query = queryString.TrimStart('?');
</I>&gt;&gt;<i> &gt;encoding = Encoding.Default;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ? should not be trimmed at all. And in fact TrimStart will trim all the ?
</I>&gt;&gt;<i> characters not the first one only.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> encoding should not be initialized because you should get an exception 
</I>&gt;&gt;<i> when
</I>&gt;&gt;<i> you later try to get ContentEncoding as there is no worker request. I 
</I>&gt;&gt;<i> think
</I>&gt;&gt;<i> this is why QueryString is initialized using Encoding.Default in MS.NET.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So QueryString should be initialized using Encoding.Default but
</I>&gt;&gt;<i> ContentEncoding should not be set. I think that the cleanest way is to 
</I>&gt;&gt;<i> move
</I>&gt;&gt;<i> query string parsing to a separate function that takes encoding as a
</I>&gt;&gt;<i> parameter and call it using Encoding.Default in this constructor and 
</I>&gt;&gt;<i> using
</I>&gt;&gt;<i> ContentEncoding in QueryString property.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I attached a patch that implements these modifications. (Please review
</I>&gt;&gt;<i> however as I didn't test it much.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Korn&#233;l
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----- Original Message ----- 
</I>&gt;&gt;<i> From: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
</I>&gt;&gt;<i> To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
</I>&gt;&gt;<i> Cc: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;;
</I>&gt;&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> Sent: Friday, May 26, 2006 2:31 AM
</I>&gt;&gt;<i> Subject: Re: [Mono-dev] Patch for HttpRequest.cs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; Hi,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Sorry for taking so long to get back to you. A new patch is attached
</I>&gt;&gt;<i> &gt; which does the following:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; - get_RootVirtualDir: small cleanup and optimization. 
</I>&gt;&gt;<i> &gt; get_RootVirtualDir
</I>&gt;&gt;<i> &gt; and get_BaseVirtualDir are almost identical, so let the former use the
</I>&gt;&gt;<i> &gt; later.
</I>&gt;&gt;<i> &gt; - get_QueryString: using ContentEncoding when UrlDecoding
</I>&gt;&gt;<i> &gt; - url_components: renamed from uri_builder
</I>&gt;&gt;<i> &gt; - UrlComponent: new private property. Its getter does the job of former
</I>&gt;&gt;<i> &gt; method InitUriBuilder(). Allows to eliminate most of the ugly
</I>&gt;&gt;<i> &gt; &quot;uri_builder == null&quot; checks in HttpRequest.
</I>&gt;&gt;<i> &gt; - UrlCompontent.Query is initialized as suggested by Korn&#233;l (using
</I>&gt;&gt;<i> &gt; HttpWorker.{GetQueryStringRawBytes,GetQueryString},
</I>&gt;&gt;<i> &gt; HttpRequest.ContentEncoding).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; There is one test case failure after applying the patch.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Test &quot;U2&quot; in &quot;Test_PropertiesSimpleConstructor ()&quot;:
</I>&gt;&gt;<i> &gt; ---------------------------------------------------
</I>&gt;&gt;<i> &gt; string url = &quot;<A HREF="http://www.gnome.org/&quot;;">http://www.gnome.org/&quot;;</A>
</I>&gt;&gt;<i> &gt; string qs = &quot;key=value&amp;key2=value%32second&quot;;
</I>&gt;&gt;<i> &gt; HttpRequest r = new HttpRequest (&quot;file&quot;, url, qs);
</I>&gt;&gt;<i> &gt; Assert.AreEqual (url, r.Url.ToString (), &quot;U2&quot;);
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Result:
</I>&gt;&gt;<i> &gt; -------
</I>&gt;&gt;<i> &gt; expected:&lt;&quot;<A HREF="http://www.gnome.org/&quot;">http://www.gnome.org/&quot;</A>&gt;
</I>&gt;&gt;<i> &gt; but was:&lt;&quot;<A HREF="http://www.gnome.org/?key=value&amp;key2=value2second&quot;">http://www.gnome.org/?key=value&amp;key2=value2second&quot;</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I consider this a bug in MS.NET, &quot;r.Url.ToString ()&quot; should be 
</I>&gt;&gt;<i> &gt; returning
</I>&gt;&gt;<i> &gt; the url including the query string at this point. Are there any known
</I>&gt;&gt;<i> &gt; cases where code depends on the presence of this bug? What should we do
</I>&gt;&gt;<i> &gt; about it?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; - Juraj
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On Mon, 2006-05-08 at 12:57 +0200, Korn&#233;l P&#225;l wrote:
</I>&gt;&gt;<i> &gt;&gt; Hi,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; You are wrong. HttpRequest.QueryString does the following on MS.NET:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; The only encoding it uses is HttpRequest.ContentEncoding. It tries to
</I>&gt;&gt;<i> &gt;&gt; obtain
</I>&gt;&gt;<i> &gt;&gt; HttpWorkerRequest.GetQueryStringRawBytes(). If it fails then falls 
</I>&gt;&gt;<i> &gt;&gt; back
</I>&gt;&gt;<i> &gt;&gt; to
</I>&gt;&gt;<i> &gt;&gt; HttpWorkerRequest.GetQueryString(). When it was able to obtain the 
</I>&gt;&gt;<i> &gt;&gt; byte
</I>&gt;&gt;<i> &gt;&gt; array it will decode it using HttpRequest.ContentEncoding.GetString(). 
</I>&gt;&gt;<i> &gt;&gt; As
</I>&gt;&gt;<i> &gt;&gt; such query string is decoded correctly. When no byte array is 
</I>&gt;&gt;<i> &gt;&gt; available
</I>&gt;&gt;<i> &gt;&gt; in
</I>&gt;&gt;<i> &gt;&gt; HttpWorkerRequest or the query string was set either in constructor or
</I>&gt;&gt;<i> &gt;&gt; using
</I>&gt;&gt;<i> &gt;&gt; HttpContext.RewritePath for example the string is assumed to be 
</I>&gt;&gt;<i> &gt;&gt; decoded
</I>&gt;&gt;<i> &gt;&gt; correctly so no decoding is done.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Now we have a string that still may be URL encoded. MS.NET probably 
</I>&gt;&gt;<i> &gt;&gt; calls
</I>&gt;&gt;<i> &gt;&gt; HttpUtility.UrlDecode just like we do but MS.NET passes
</I>&gt;&gt;<i> &gt;&gt; HttpRequest.ContentEncoding as well because query string is assumed to 
</I>&gt;&gt;<i> &gt;&gt; be
</I>&gt;&gt;<i> &gt;&gt; URL encoded using that encoding.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Note that obtaining query string from HttpWorkerRequest in the
</I>&gt;&gt;<i> &gt;&gt; constructor
</I>&gt;&gt;<i> &gt;&gt; as we currently do is a wrong implementation as
</I>&gt;&gt;<i> &gt;&gt; HttpRequest.ContentEncoding
</I>&gt;&gt;<i> &gt;&gt; can be changed before HttpRequest.QueryString is first accessed.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; We should do the following:
</I>&gt;&gt;<i> &gt;&gt; - delay query string processing until it is needed (don't obtain query
</I>&gt;&gt;<i> &gt;&gt; string in the constructor)
</I>&gt;&gt;<i> &gt;&gt; - try HttpWorkerRequest.GetQueryStringRawBytes() as well
</I>&gt;&gt;<i> &gt;&gt; - use HttpRequest.ContentEncoding to decode the byte array and for
</I>&gt;&gt;<i> &gt;&gt; HttpUtility.UrlDecode
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Korn&#233;l
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ----- Original Message ----- 
</I>&gt;&gt;<i> &gt;&gt; From: &quot;Juraj Skripsky&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">js at hotfeet.ch</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; To: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; Sent: Monday, May 08, 2006 12:22 PM
</I>&gt;&gt;<i> &gt;&gt; Subject: Re: [Mono-dev] Patch for HttpRequest.cs
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Hello,
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; After running more tests, I've found out that on MS.NET the decoding 
</I>&gt;&gt;<i> &gt;&gt; &gt; in
</I>&gt;&gt;<i> &gt;&gt; &gt; HttpRequest.QueryString does _not_ depend on
</I>&gt;&gt;<i> &gt;&gt; &gt; HttpRequest.ContentEncoding. In fact, MS seems to be always using
</I>&gt;&gt;<i> &gt;&gt; &gt; Latin1
</I>&gt;&gt;<i> &gt;&gt; &gt; here. All other standard encodings fail.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; A revised patch is attached, including a NUnit test case. If no one
</I>&gt;&gt;<i> &gt;&gt; &gt; objects, I'll commit.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; - Juraj
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; On Sat, 2006-05-06 at 13:47 -0400, Miguel de Icaza wrote:
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Hello Juraj,
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; The attached patch makes sure that the get-parameters in 
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; QueryString
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; are
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; url-decoded using the proper encoding (when creating the
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; NameValueCollection).
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; May I commit?
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Could you provide NUnit tests for this case?
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Miguel
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018699.html">[Mono-dev] Patch for HttpRequest.cs
</A></li>
	<LI>Next message: <A HREF="018702.html">[Mono-dev] Patch for HttpRequest.cs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18700">[ date ]</a>
              <a href="thread.html#18700">[ thread ]</a>
              <a href="subject.html#18700">[ subject ]</a>
              <a href="author.html#18700">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
