<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for Application.Restart ()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20Application.Restart%20%28%29&In-Reply-To=4586FD93.3000505%40informatik.uni-kiel.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021808.html">
   <LINK REL="Next"  HREF="021809.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for Application.Restart ()</H1>
    <B>Chris Toshok</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20Application.Restart%20%28%29&In-Reply-To=4586FD93.3000505%40informatik.uni-kiel.de"
       TITLE="[Mono-dev] Patch for Application.Restart ()">toshok at ximian.com
       </A><BR>
    <I>Tue Dec 19 12:27:33 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021808.html">[Mono-dev] Patch for Application.Restart ()
</A></li>
        <LI>Next message: <A HREF="021809.html">[Mono-dev] PKCS12 and SecretBags
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21827">[ date ]</a>
              <a href="thread.html#21827">[ thread ]</a>
              <a href="subject.html#21827">[ subject ]</a>
              <a href="author.html#21827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please commit.  Thanks much, Daniel.

Chris

On Mon, 2006-12-18 at 21:44 +0100, Daniel Nauck wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> i've implemented Application.Restart ().
</I>&gt;<i> The patch is attached, please review.
</I>&gt;<i> 
</I>&gt;<i> We've also discussed that topic today on #mono-winforms.
</I>&gt;<i> The code for getting the mono path is from
</I>&gt;<i> System.MS.CSharp.CSharpCodeCompiler.
</I>&gt;<i> 
</I>&gt;<i> Somebody also mention that this is not a good solution to get the used
</I>&gt;<i> mono binary, but he can't tell me a better working managed solution.
</I>&gt;<i> 
</I>&gt;<i> This code runs at *nix, windows and .net.
</I>&gt;<i> 
</I>&gt;<i> by,
</I>&gt;<i> Daniel
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> plain text document attachment (Restart.patch)
</I>&gt;<i> Index: Test/System.Windows.Forms/ApplicationTest.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- Test/System.Windows.Forms/ApplicationTest.cs	(Revision 69666)
</I>&gt;<i> +++ Test/System.Windows.Forms/ApplicationTest.cs	(Arbeitskopie)
</I>&gt;<i> @@ -39,5 +39,12 @@
</I>&gt;<i>  
</I>&gt;<i>  			Assert.IsNull (ctx.MainForm, &quot;2&quot;);
</I>&gt;<i>  		}
</I>&gt;<i> +
</I>&gt;<i> +		[Test]
</I>&gt;<i> +		[ExpectedException (typeof (NotSupportedException))]
</I>&gt;<i> +		public void RestartNotSupportedExceptionTest ()
</I>&gt;<i> +		{
</I>&gt;<i> +			Application.Restart ();
</I>&gt;<i> +		}
</I>&gt;<i>  	}
</I>&gt;<i>  }
</I>&gt;<i> Index: System.Windows.Forms/Application.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- System.Windows.Forms/Application.cs	(Revision 69666)
</I>&gt;<i> +++ System.Windows.Forms/Application.cs	(Arbeitskopie)
</I>&gt;<i> @@ -21,6 +21,7 @@
</I>&gt;<i>  //
</I>&gt;<i>  // Authors:
</I>&gt;<i>  //	Peter Bartok	<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pbartok at novell.com</A>
</I>&gt;<i> +//      Daniel Nauck    (dna(at)mono-project(dot)de)
</I>&gt;<i>  //
</I>&gt;<i>  
</I>&gt;<i>  // COMPLETE
</I>&gt;<i> @@ -39,6 +40,7 @@
</I>&gt;<i>  using System.Runtime.InteropServices;
</I>&gt;<i>  using System.Threading;
</I>&gt;<i>  #if NET_2_0
</I>&gt;<i> +using System.Text;
</I>&gt;<i>  using System.Windows.Forms.VisualStyles;
</I>&gt;<i>  #endif
</I>&gt;<i>  
</I>&gt;<i> @@ -374,6 +376,70 @@
</I>&gt;<i>  				return forms;
</I>&gt;<i>  			}
</I>&gt;<i>  		}
</I>&gt;<i> +
</I>&gt;<i> +		public static void Restart ()
</I>&gt;<i> +		{
</I>&gt;<i> +			//FIXME: ClickOnce stuff using the Update or UpdateAsync methods.
</I>&gt;<i> +			//FIXME: SecurityPermission: Restart () requires IsUnrestricted permission.
</I>&gt;<i> +
</I>&gt;<i> +			if (Assembly.GetEntryAssembly () == null)
</I>&gt;<i> +				throw new NotSupportedException (&quot;The method 'Restart' is not supported by this application type.&quot;);
</I>&gt;<i> +
</I>&gt;<i> +			string mono_path = null;
</I>&gt;<i> +
</I>&gt;<i> +			//Get mono path
</I>&gt;<i> +			PropertyInfo gac = typeof (Environment).GetProperty (&quot;GacPath&quot;, BindingFlags.Static | BindingFlags.NonPublic);
</I>&gt;<i> +			MethodInfo get_gac = null;
</I>&gt;<i> +			if (gac != null)
</I>&gt;<i> +				get_gac = gac.GetGetMethod (true);
</I>&gt;<i> +
</I>&gt;<i> +			if (get_gac != null) {
</I>&gt;<i> +				string gac_path = Path.GetDirectoryName ((string)get_gac.Invoke (null, null));
</I>&gt;<i> +				string mono_prefix = Path.GetDirectoryName (Path.GetDirectoryName (gac_path));
</I>&gt;<i> +
</I>&gt;<i> +				if (Environment.OSVersion.Platform == PlatformID.Unix) {
</I>&gt;<i> +					mono_path = Path.Combine (mono_prefix, &quot;bin/mono&quot;);
</I>&gt;<i> +					if (!File.Exists (mono_path))
</I>&gt;<i> +						mono_path = &quot;mono&quot;;
</I>&gt;<i> +				}
</I>&gt;<i> +				else {
</I>&gt;<i> +					mono_path = Path.Combine (mono_prefix, &quot;bin\\mono.bat&quot;);
</I>&gt;<i> +
</I>&gt;<i> +					if (!File.Exists (mono_path))
</I>&gt;<i> +						mono_path = Path.Combine (mono_prefix, &quot;bin\\mono.exe&quot;);
</I>&gt;<i> +
</I>&gt;<i> +					if (!File.Exists (mono_path))
</I>&gt;<i> +						mono_path = Path.Combine (mono_prefix, &quot;mono\\mono\\mini\\mono.exe&quot;);
</I>&gt;<i> +
</I>&gt;<i> +					if (!File.Exists (mono_path))
</I>&gt;<i> +						throw new FileNotFoundException (string.Format (&quot;Windows mono path not found: '{0}'&quot;, mono_path));
</I>&gt;<i> +				}
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			//Get command line arguments
</I>&gt;<i> +			StringBuilder argsBuilder = new StringBuilder ();
</I>&gt;<i> +			string[] args = Environment.GetCommandLineArgs ();
</I>&gt;<i> +			for (int i = 0; i &lt; args.Length; i++)
</I>&gt;<i> +			{
</I>&gt;<i> +				argsBuilder.Append (string.Format (&quot;\&quot;{0}\&quot; &quot;, args[i]));
</I>&gt;<i> +			}
</I>&gt;<i> +			string arguments = argsBuilder.ToString ();
</I>&gt;<i> +			ProcessStartInfo procInfo = Process.GetCurrentProcess ().StartInfo;
</I>&gt;<i> +
</I>&gt;<i> +			if (mono_path == null) { //it is .NET on Windows
</I>&gt;<i> +				procInfo.FileName = args[0];
</I>&gt;<i> +				procInfo.Arguments = arguments.Remove (0, args[0].Length + 3); //1 space and 2 quotes
</I>&gt;<i> +			}
</I>&gt;<i> +			else {
</I>&gt;<i> +				procInfo.Arguments = arguments;
</I>&gt;<i> +				procInfo.FileName = mono_path;
</I>&gt;<i> +			}
</I>&gt;<i> +
</I>&gt;<i> +			procInfo.WorkingDirectory = Environment.CurrentDirectory;
</I>&gt;<i> +
</I>&gt;<i> +			Application.Exit ();
</I>&gt;<i> +			Process.Start (procInfo);
</I>&gt;<i> +		}
</I>&gt;<i>  #endif
</I>&gt;<i>  
</I>&gt;<i>  		public static void Exit() {
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021808.html">[Mono-dev] Patch for Application.Restart ()
</A></li>
	<LI>Next message: <A HREF="021809.html">[Mono-dev] PKCS12 and SecretBags
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21827">[ date ]</a>
              <a href="thread.html#21827">[ thread ]</a>
              <a href="subject.html#21827">[ subject ]</a>
              <a href="author.html#21827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
