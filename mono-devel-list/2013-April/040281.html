<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] TypeForwardedFrom
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20TypeForwardedFrom&In-Reply-To=%3C5163E962.4070409%40gmx.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040279.html">
   <LINK REL="Next"  HREF="040283.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] TypeForwardedFrom</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20TypeForwardedFrom&In-Reply-To=%3C5163E962.4070409%40gmx.net%3E"
       TITLE="[Mono-dev] TypeForwardedFrom">robertj at gmx.net
       </A><BR>
    <I>Tue Apr  9 10:11:46 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040279.html">[Mono-dev] TypeForwardedFrom
</A></li>
        <LI>Next message: <A HREF="040283.html">[Mono-dev] TypeForwardedFrom
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40281">[ date ]</a>
              <a href="thread.html#40281">[ thread ]</a>
              <a href="subject.html#40281">[ subject ]</a>
              <a href="author.html#40281">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Neale,

It looks like your patch doesn't work correctly, because the
assembly references are still the same, as if the patch
didn't have any effect.

Assembly references start with &quot;ff&quot; in your dump (&quot;ff&quot; is
decimal 12). See:

<A HREF="https://github.com/mono/mono/blob/master/mcs/class/corlib/System.Runtime.Serialization.Formatters.Binary/binary_serialization_format.htm">https://github.com/mono/mono/blob/master/mcs/class/corlib/System.Runtime.Serialization.Formatters.Binary/binary_serialization_format.htm</A>


             | ID (LE) | String length | String (assembly name)
--------------------------------------------------------------
Mono:    12 | 3 0 0 0 | 6  | System
Windows: 12 | 3 0 0 0 | 78 | WindowsBase, Version=...


I had a look at Mono's

System.Runtime.Serialization.Formatters.Binary/ObjectWriter.cs

and it seems that the necessary patch isn't quite a smooth sailing.
The code is dealing with Assembly objects which we don't have
if TypeForwardedFrom is in effect. The code must be somehow
changed to deal with plain assembly names (strings).

I'd rename ObjectWriter.WriteAssembly to ObjectWriter.WriteTypeAssembly 
and pass it a Type in place of the type's Assembly object.

Whatever you do, don't forget that there is another
fast serializer implemented in CodeGenerator.cs which must be
kept in sync with ObjectWriter.cs

Robert


On 09.04.2013 00:18, Neale Ferguson wrote:
&gt;<i> Hi,
</I>&gt;<i>   I've taken your code as a base for creating a test fix. It works nicely but
</I>&gt;<i> .NET appears to be doing something a little strange (in my eyes, not theirs
</I>&gt;<i> of course). A program (such as shown in bugzilla 11294) when run creates a
</I>&gt;<i> serialized object but the header contents are different:
</I>&gt;<i>
</I>&gt;<i> Mono -
</I>&gt;<i>
</I>&gt;<i> 0000000 nul soh nul nul nul del del del del soh nul nul nul nul nul nul
</I>&gt;<i> 0000020 nul  ff stx nul nul nul bel   P   r   o   g   r   a   m  ff etx
</I>&gt;<i> 0000040 nul nul nul ack   S   y   s   t   e   m enq soh nul nul nul   9  &lt;==
</I>&gt;<i> 0000060   S   e   r   i   a   l   i   z   a   t   i   o   n   P   r   o
</I>&gt;<i> 0000100   t   o   t   y   p   e   .   D   a   t   a   O   b   j   e   c
</I>&gt;<i> 0000120   t   W   i   t   h   O   b   s   e   r   v   a   b   l   e   C
</I>&gt;<i> 0000140   o   l   l   e   c   t   i   o   n etx nul nul nul  cr   m   _
</I>&gt;<i> 0000160   s   t   r   i   n   g   V   a   l   u   e  cr   m   _   d   o
</I>&gt;<i> 0000200   u   b   l   e   V   a   l   u   e  ff   m   _   c   o   l   l
</I>&gt;<i> 0000220   e   c   t   i   o   n soh nul eot ack dc3 soh   S   y   s   t
</I>&gt;<i> 0000240   e   m   .   C   o   l   l   e   c   t   i   o   n   s   .   O
</I>&gt;<i> 0000260   b   j   e   c   t   M   o   d   e   l   .   O   b   s   e   r
</I>&gt;<i> 0000300   v   a   b   l   e   C   o   l   l   e   c   t   i   o   n
</I>&gt;<i>
</I>&gt;<i> Windows -
</I>&gt;<i>
</I>&gt;<i> 0000000  nul soh nul nul nul  FF  FF  FF  FF soh nul nul nul nul nul nul
</I>&gt;<i> 0000020  nul  ff stx nul nul nul   &gt;   P   r   o   g   r   a   m   ,  sp
</I>&gt;<i> 0000040    V   e   r   s   i   o   n   =   0   .   0   .   0   .   0   ,
</I>&gt;<i> 0000060   sp   C   u   l   t   u   r   e   =   n   e   u   t   r   a   l
</I>&gt;<i> 0000100    ,  sp   P   u   b   l   i   c   K   e   y   T   o   k   e   n
</I>&gt;<i> 0000120    =   n   u   l   l  ff etx nul nul nul   N   W   i   n   d   o &lt;==
</I>&gt;<i> 0000140    w   s   B   a   s   e   ,  sp   V   e   r   s   i   o   n   =
</I>&gt;<i> 0000160    3   .   0   .   0   .   0   ,  sp   C   u   l   t   u   r   e
</I>&gt;<i> 0000200    =   N   e   u   t   r   a   l   ,  sp   P   u   b   l   i   c
</I>&gt;<i> 0000220    K   e   y   T   o   k   e   n   =   3   1   b   f   3   8   5
</I>&gt;<i> 0000240    6   a   d   3   6   4   e   3   5 enq soh nul nul nul   9   S
</I>&gt;<i> 0000260    e   r   i   a   l   i   z   a   t   i   o   n   P   r   o   t
</I>&gt;<i> 0000300    o   t   y   p   e   .   D   a   t   a   O   b   j   e   c   t
</I>&gt;<i> 0000320    W   i   t   h   O   b   s   e   r   v   a   b   l   e   C   o
</I>&gt;<i> 0000340    l   l   e   c   t   i   o   n
</I>&gt;<i>
</I>&gt;<i> Note, that Mono associates System with Program, but .NET associates it with
</I>&gt;<i> WindowsBase. I'm not sure why it does this.
</I>&gt;<i>
</I>&gt;<i> On 4/5/13 10:14 AM, &quot;Robert Jordan&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> You don't need to know how mcs operates. The TypeForwardedFrom
</I>&gt;&gt;<i> information can be obtained via reflection:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040279.html">[Mono-dev] TypeForwardedFrom
</A></li>
	<LI>Next message: <A HREF="040283.html">[Mono-dev] TypeForwardedFrom
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40281">[ date ]</a>
              <a href="thread.html#40281">[ thread ]</a>
              <a href="subject.html#40281">[ subject ]</a>
              <a href="author.html#40281">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
