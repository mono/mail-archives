<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] SiteMapProvider patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SiteMapProvider%20patch&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023733.html">
   <LINK REL="Next"  HREF="023736.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] SiteMapProvider patch</H1>
    <B>Dumitru Ban</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SiteMapProvider%20patch&In-Reply-To="
       TITLE="[Mono-dev] SiteMapProvider patch">dban at dako.ro
       </A><BR>
    <I>Wed May 30 03:03:58 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023733.html">[Mono-dev] SiteMapProvider patch
</A></li>
        <LI>Next message: <A HREF="023736.html">[Mono-dev] SiteMapProvider patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23734">[ date ]</a>
              <a href="thread.html#23734">[ thread ]</a>
              <a href="subject.html#23734">[ subject ]</a>
              <a href="author.html#23734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Yesterday, when I post my questions, the #1 looked like this:

if (node.Roles != null)
    foreach (string rolename in node.Roles)
        if (rolename == &quot;*&quot; || context.User.IsInRole (rolename))
            return true;

It was not returning false if there were roles defined for the node and there was no match for the user.

Marek updated the code and now it looks like this:

IList roles = node.Roles;
if (roles != null &amp;&amp; roles.Count &gt; 0) {
    foreach (string rolename in roles)
        if (rolename == &quot;*&quot; || context.User.IsInRole (rolename))
            return true;
        return false;
}

But, in the MSDN, it says that the method should return true if:
The Roles exists on node and the current user is in at least one of the specified roles.
- or -
The current thread has an associated WindowsIdentity that has file access to the requested URL and the URL is located within the directory structure for the application.
- or -
The current user is authorized specifically for the requested URL in the authorization element for the current application and the URL is located within the directory structure for the application.

In my opinion #1 should not return false at all. It should go and check for #2 and/or #3. The update Marek made is working for the case where no url is defined for the node. But what happens if the node has an url, a role is defined for that node, the user is not in that role, but the user is specifically authorized for the requested url in the authorization element? It will return false, but it should return true...

I think the correct code should look something like this:

/* 1. */
IList roles = node.Roles;
if (roles != null &amp;&amp; roles.Count &gt; 0) {
    foreach (string rolename in roles)
        if (rolename == &quot;*&quot; || context.User.IsInRole (rolename))
            return true;
}

/* 2. */
/* XXX */

/* 3. */
string url = node.Url;
if(!String.IsNullOrEmpty(url)) {
    // TODO check url is located within the current application

    if (VirtualPathUtility.IsAppRelative (url) || !VirtualPathUtility.IsAbsolute (url))
        url = VirtualPathUtility.Combine (VirtualPathUtility.AppendTrailingSlash (HttpRuntime.AppDomainAppVirtualPath), url);

    AuthorizationSection config = (AuthorizationSection) WebConfigurationManager.GetSection (
        &quot;system.web/authorization&quot;,
        url);
    if (config != null)
        return config.IsValidUser (context.User, context.Request.HttpMethod);
}

return false;

What do you think?

Thanks &amp; best regards,
Dumi.

  ----- Original Message ----- 
  From: Konstantin Triger 
  To: Dumitru Ban ; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A> 
  Sent: Wednesday, May 30, 2007 9:11 AM
  Subject: RE: [Mono-dev] SiteMapProvider patch


  Hey Dumitru,

   

  The problem is probably in case #1:

   

  /* 1. */

  IList roles = node.Roles;

  if (roles != null &amp;&amp; roles.Count &gt; 0) {

        foreach (string rolename in roles)

              if (rolename == &quot;*&quot; || context.User.IsInRole (rolename))

                    return true;

        return false;

  }

   

  Either the rolename is not parsed correctly or context.User.IsInRole (rolename) works wrong. To check the later, you may run 'context.User.IsInRole (&quot;Administrator&quot;)' within your user code and see the result.

   

  Regards,

  Konstantin Triger


------------------------------------------------------------------------------

  From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Dumitru Ban
  Sent: Tuesday, May 29, 2007 11:45 AM
  To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
  Subject: [Mono-dev] SiteMapProvider patch

   

  Hi,

   

  I'm trying to create a patch for SiteMapProvider-&gt;IsAccessibleToUser method.

   

  Let's say a web.sitemap file is present, having the following content:

  &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
  &lt;siteMap xmlns=&quot;<A HREF="http://schemas.microsoft.com/AspNet/SiteMap-File-1.0&quot;">http://schemas.microsoft.com/AspNet/SiteMap-File-1.0&quot;</A> &gt;
   &lt;siteMapNode url=&quot;home.aspx&quot; title=&quot;Home&quot;&gt;
    &lt;siteMapNode title=&quot;Test_no_url_no_roles&quot;/&gt;
    &lt;siteMapNode title=&quot;Test_no_url_roles&quot;  roles=&quot;Administrator&quot;/&gt;
    &lt;/siteMapNode&gt;
  &lt;/siteMap&gt;

   

  With Microsoft .NET, the &quot;Test_no_url_no_roles&quot; node is not accessible to any user and the &quot;Test_no_url_roles&quot; is accessible only to an Administrator.

  In mono, both nodes are accessible to anyone. And this is because if the url of the node is null or is the empty string, the method returns true.

   

  On the method there is a [MonoTODO (&quot;need to implement cases 2 and 3&quot;)]. But number 2 is already started and the code

  String url = node.Url;

  if (String.IsNullOrEmpty(url))

      return true;

  is already there. 

  Shouldn't we have the same behaviour as Microsoft .NET?

   

  Thanks &amp; best regards,

  Dumi.



  __________ NOD32 2296 (20070529) Information __________

  This message was checked by NOD32 antivirus system.
  <A HREF="http://www.eset.com">http://www.eset.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070530/37eb74d1/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070530/37eb74d1/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023733.html">[Mono-dev] SiteMapProvider patch
</A></li>
	<LI>Next message: <A HREF="023736.html">[Mono-dev] SiteMapProvider patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23734">[ date ]</a>
              <a href="thread.html#23734">[ thread ]</a>
              <a href="subject.html#23734">[ subject ]</a>
              <a href="author.html#23734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
