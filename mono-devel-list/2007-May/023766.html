<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] IMT patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20IMT%20patch&In-Reply-To=1180604542.4329.61.camel%40matrix.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023762.html">
   <LINK REL="Next"  HREF="023768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] IMT patch</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20IMT%20patch&In-Reply-To=1180604542.4329.61.camel%40matrix.ximian.com"
       TITLE="[Mono-dev] IMT patch">kumpera at gmail.com
       </A><BR>
    <I>Thu May 31 06:55:07 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023762.html">[Mono-dev] IMT patch
</A></li>
        <LI>Next message: <A HREF="023768.html">[Mono-dev] IMT patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23766">[ date ]</a>
              <a href="thread.html#23766">[ thread ]</a>
              <a href="subject.html#23766">[ subject ]</a>
              <a href="author.html#23766">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Massimiliano.

Do you have any measurements of the collision rates the hash function
generates over corlib? This should provide enough data to verify the hash
quality. If collision is too bad, you could store the IMT slot in MonoMethod
and do slot distribution when the interface is loaded.

I've got some points about the IMT thunks:

You are using indirect absolute jmps over the vtable pointer, which is
slower than relative jmps. The code could check if the target method is
already compiled and issue a relative jump directly. The compile trampolines
could patch the thunks, but this could end been really tricky.

The thunks will generate too much relocation in AOT'ed code, one for each
collision, changing it to one for each thunk should improve that, just load
the vtable at the beginning in a register. By the way, AOT'ed code could use
a lot of relative jumps, so this point might be mild if relative jumps are
used.

How fast is the hash function? Shouldn't the IMT slot be cached in
MonoMethod?


The patch looks great, congrats!


Rodrigo



On 5/31/07, Massimiliano Mantione &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">massi at ximian.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is the IMT patch for an initial review.
</I>&gt;<i> See here for an explanation of what IMT is:
</I>&gt;<i> <A HREF="http://primates.ximian.com/~massi/blog/archive/2007/May-10.html">http://primates.ximian.com/~massi/blog/archive/2007/May-10.html</A>
</I>&gt;<i>
</I>&gt;<i> Initially it looked &quot;mildly unstable&quot;: when rebuilding the whole Mono
</I>&gt;<i> I got a couple of NRE in the mcs symbol writer while compiling some
</I>&gt;<i> library; just typing make again worked, so the problem was very hard
</I>&gt;<i> to reproduce.
</I>&gt;<i> However, now I updated my tree, and I just cannot reproduce it anymore.
</I>&gt;<i> I fully rebuilt it three times, running the tests... no crashes.
</I>&gt;<i> The IMT size is set to a ridiculous 4 to get lots of collisions and
</I>&gt;<i> stress the thunks.
</I>&gt;<i>
</I>&gt;<i> TODO:
</I>&gt;<i> - Cleanup the code (mostly remove print statements).
</I>&gt;<i>   BTW, do you think some of the print statements can stay there anyway?
</I>&gt;<i> - Move &quot;mono_convert_imt_slot_to_vtable_slot&quot; elsewhere (mini.c?).
</I>&gt;<i> - Does setting &quot;MonoClass.imt_collisions_bitmap&quot; need locking?
</I>&gt;<i>   If yes, it should be the loader lock, but does acquiring it with the
</I>&gt;<i>   domain lock held (we are building the MonoVTable) risk a deadlock?
</I>&gt;<i> - Add cumulative size of thunks to mono stats.
</I>&gt;<i> - Also add general &quot;performance&quot; of the hash function to the stats?
</I>&gt;<i>   I mean, collision ratio and things like that...
</I>&gt;<i> - Measure memory savings and call slowdown.
</I>&gt;<i> - Tune IMT size and hash function (even if IMO the hash is already OK).
</I>&gt;<i> - Maybe rewrite the thunks to do binary search instead of linear.
</I>&gt;<i> - Port to all the other architectures.
</I>&gt;<i> - Remove the &quot;non IMT&quot; code paths.
</I>&gt;<i>
</I>&gt;<i> Do you think this should be committed before the other archs are ported,
</I>&gt;<i> or should we wait for the port to be complete and commit without the
</I>&gt;<i> current code path?
</I>&gt;<i>
</I>&gt;<i> Ciao,
</I>&gt;<i>   Massi
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070531/95e1fc26/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20070531/95e1fc26/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023762.html">[Mono-dev] IMT patch
</A></li>
	<LI>Next message: <A HREF="023768.html">[Mono-dev] IMT patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23766">[ date ]</a>
              <a href="thread.html#23766">[ thread ]</a>
              <a href="subject.html#23766">[ subject ]</a>
              <a href="author.html#23766">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
