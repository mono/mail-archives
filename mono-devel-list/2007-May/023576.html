<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] : RE: [Mono-patches] r77337 -	inbranches/mainsoft/gh20/mcs/class/System.Web:	System.WebSystem.Web.Configuration_2.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%3A%20RE%3A%20%5BMono-patches%5D%20r77337%20-%0A%09inbranches/mainsoft/gh20/mcs/class/System.Web%3A%0A%09System.WebSystem.Web.Configuration_2.0&In-Reply-To=20070514095610.0E00F9472C%40mono-cvs.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023583.html">
   <LINK REL="Next"  HREF="023577.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] : RE: [Mono-patches] r77337 -	inbranches/mainsoft/gh20/mcs/class/System.Web:	System.WebSystem.Web.Configuration_2.0</H1>
    <B>Eyal Alaluf</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%3A%20RE%3A%20%5BMono-patches%5D%20r77337%20-%0A%09inbranches/mainsoft/gh20/mcs/class/System.Web%3A%0A%09System.WebSystem.Web.Configuration_2.0&In-Reply-To=20070514095610.0E00F9472C%40mono-cvs.ximian.com"
       TITLE="[Mono-dev] : RE: [Mono-patches] r77337 -	inbranches/mainsoft/gh20/mcs/class/System.Web:	System.WebSystem.Web.Configuration_2.0">eyala at mainsoft.com
       </A><BR>
    <I>Tue May 15 05:34:26 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="023583.html">[Mono-dev] SqlCeServer on mono
</A></li>
        <LI>Next message: <A HREF="023577.html">[Mono-dev] MonoDevelop questions...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23576">[ date ]</a>
              <a href="thread.html#23576">[ thread ]</a>
              <a href="subject.html#23576">[ subject ]</a>
              <a href="author.html#23576">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Igor.

I believe that you still need to lock the configuration when you add an
element to it. Or is it OK for the WebConfigurationHost instance not to
unique under stress (if there is a race to initialize it).

@@ -186,13 +186,8 @@
 
 			conf = (_Configuration) configurations [path];
 			if (conf == null) {
-				lock (configurations) {
-					conf = (_Configuration)
configurations [path];
-					if (conf == null) {
 						conf =
ConfigurationFactory.Create (typeof (WebConfigurationHost), null, path,
site, locationSubPath, server, userName, password);
 						configurations [path] =
conf;
-					}
-				}
 			}
 			return conf;
 		}

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A>] On Behalf Of Igor
Zalmanovich (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">igorz at mainsoft.com</A>)
Sent: 14 May 2007 11:56
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ximian.monolist at gmail.com</A>;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-svn-patches-garchive-20758 at googlegroups.com</A>
Subject: [Mono-patches] r77337 -
inbranches/mainsoft/gh20/mcs/class/System.Web:
System.WebSystem.Web.Configuration_2.0

Author: igorz
Date: 2007-05-14 05:56:09 -0400 (Mon, 14 May 2007)
New Revision: 77337

Modified:
 
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/ChangeLog
 
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/WebConfigurationManager.cs
   branches/mainsoft/gh20/mcs/class/System.Web/System.Web/ChangeLog
 
branches/mainsoft/gh20/mcs/class/System.Web/System.Web/HttpApplication.c
s
Log:
merged r77335-77336

Modified:
branches/mainsoft/gh20/mcs/class/System.Web/System.Web/ChangeLog
===================================================================
--- branches/mainsoft/gh20/mcs/class/System.Web/System.Web/ChangeLog
2007-05-14 09:47:41 UTC (rev 77336)
+++ branches/mainsoft/gh20/mcs/class/System.Web/System.Web/ChangeLog
2007-05-14 09:56:09 UTC (rev 77337)
@@ -1,3 +1,9 @@
+2007-05-14 Igor Zelmanovich &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">igorz at mainsoft.com</A>&gt;
+
+	* HttpApplication.cs:
+	prevent DOS attack: remove configuration from the cache in case 
+	of invalid resource not exists	
+
 2007-05-14  Vladimir Krasnov  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vladimirk at mainsoft.com</A>&gt;
 
 	* TraceContext.cs: refactoring, cached TraceManager

Modified:
branches/mainsoft/gh20/mcs/class/System.Web/System.Web/HttpApplication.c
s
===================================================================
---
branches/mainsoft/gh20/mcs/class/System.Web/System.Web/HttpApplication.c
s	2007-05-14 09:47:41 UTC (rev 77336)
+++
branches/mainsoft/gh20/mcs/class/System.Web/System.Web/HttpApplication.c
s	2007-05-14 09:56:09 UTC (rev 77337)
@@ -145,6 +145,7 @@
 #else
 		static Exception initialization_exception;
 #endif
+		bool removeConfigurationFromCache;
 #else
 		HandlerFactoryConfiguration factory_config;
 #endif
@@ -641,6 +642,14 @@
 				}
 			}
 			stop_processing = true;
+#if NET_2_0
+			// we want to remove configuration from the
cache in case of 
+			// invalid resource not exists to prevent DOS
attack.
+			HttpException httpEx = e as HttpException;
+			if (httpEx != null &amp;&amp; httpEx.GetHttpCode () ==
404) {
+				removeConfigurationFromCache = true;
+			}
+#endif
 		}
 		
 		//
@@ -1096,6 +1105,12 @@
 
 		void PostDone ()
 		{
+#if NET_2_0
+			if (removeConfigurationFromCache) {
+
WebConfigurationManager.RemoveConfigurationFromCache (context);
+				removeConfigurationFromCache = false;
+			}
+#endif
 			Thread th = Thread.CurrentThread;
 #if !TARGET_JVM
 			if (Thread.CurrentPrincipal != prev_user)

Modified:
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/ChangeLog
===================================================================
---
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/ChangeLog	2007-05-14 09:47:41 UTC (rev 77336)
+++
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/ChangeLog	2007-05-14 09:56:09 UTC (rev 77337)
@@ -1,3 +1,9 @@
+2007-05-14  Igor Zelmanovich &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">igorz at mainsoft.com</A>&gt;
+
+	* WebConfigurationManager.cs: 
+	make configurations synchronized.
+	added new internal method RemoveConfigurationFromCache.
+
 2007-04-19  Marek Habersack  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mhabersack at novell.com</A>&gt;
 
 	* HttpHandlerAction.cs: look up types in all the toplevel

Modified:
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/WebConfigurationManager.cs
===================================================================
---
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/WebConfigurationManager.cs	2007-05-14 09:47:41 UTC (rev 77336)
+++
branches/mainsoft/gh20/mcs/class/System.Web/System.Web.Configuration_2.0
/WebConfigurationManager.cs	2007-05-14 09:56:09 UTC (rev 77337)
@@ -45,7 +45,7 @@
 	{
 #if !TARGET_J2EE
 		static IInternalConfigConfigurationFactory
configFactory;
-		static Hashtable configurations = new Hashtable ();
+		static Hashtable configurations = Hashtable.Synchronized
(new Hashtable ());
 #else
 		static internal IInternalConfigConfigurationFactory
configFactory
 		{
@@ -79,7 +79,7 @@
 					lock (AppDomain.CurrentDomain){
 						object initialized =
AppDomain.CurrentDomain.GetData(&quot;WebConfigurationManager.configurations.
initialized&quot;);
 						if (initialized ==
null){
-							table = new
Hashtable();
+							table =
Hashtable.Synchronized (new Hashtable ());
 							configurations =
table;
 						}
 					}
@@ -186,13 +186,8 @@
 
 			conf = (_Configuration) configurations [path];
 			if (conf == null) {
-				lock (configurations) {
-					conf = (_Configuration)
configurations [path];
-					if (conf == null) {
 						conf =
ConfigurationFactory.Create (typeof (WebConfigurationHost), null, path,
site, locationSubPath, server, userName, password);
 						configurations [path] =
conf;
-					}
-				}
 			}
 			return conf;
 		}
@@ -225,11 +220,7 @@
 
 		public static object GetSection (string sectionName)
 		{
-			string path = (HttpContext.Current != null
-			    &amp;&amp; HttpContext.Current.Request != null) ?
-				HttpContext.Current.Request.Path :
HttpRuntime.AppDomainAppVirtualPath;
-
-			return GetSection (sectionName, path);
+			return GetSection (sectionName, GetCurrentPath
(HttpContext.Current));
 		}
 
 		public static object GetSection (string sectionName,
string path)
@@ -243,6 +234,16 @@
 			return get_runtime_object.Invoke (section, new
object [0]);
 		}
 
+		static string GetCurrentPath (HttpContext ctx)
+		{
+			return (ctx != null &amp;&amp; ctx.Request != null) ?
ctx.Request.Path : HttpRuntime.AppDomainAppVirtualPath;
+		}
+
+		internal static void RemoveConfigurationFromCache
(HttpContext ctx)
+		{
+			configurations.Remove (GetCurrentPath (ctx));
+		}
+
 		readonly static MethodInfo get_runtime_object = typeof
(ConfigurationSection).GetMethod (&quot;GetRuntimeObject&quot;,
BindingFlags.NonPublic | BindingFlags.Instance);
 
 		public static object GetWebApplicationSection (string
sectionName)

_______________________________________________
Mono-patches maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023583.html">[Mono-dev] SqlCeServer on mono
</A></li>
	<LI>Next message: <A HREF="023577.html">[Mono-dev] MonoDevelop questions...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23576">[ date ]</a>
              <a href="thread.html#23576">[ thread ]</a>
              <a href="subject.html#23576">[ subject ]</a>
              <a href="author.html#23576">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
