<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] OSX Questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20OSX%20Questions&In-Reply-To=68384C56-0372-11D8-BCB8-000393DEF8EA%40dvsconsulting.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002596.html">
   <LINK REL="Next"  HREF="002597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] OSX Questions</H1>
    <B>zalman at peachfish.com</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20OSX%20Questions&In-Reply-To=68384C56-0372-11D8-BCB8-000393DEF8EA%40dvsconsulting.com"
       TITLE="[Mono-devel-list] OSX Questions">zalman at peachfish.com
       </A><BR>
    <I>Tue Oct 21 04:41:30 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002596.html">[Mono-devel-list] OSX Questions
</A></li>
        <LI>Next message: <A HREF="002597.html">[Mono-devel-list] How to link Mono with unicows.lib?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2614">[ date ]</a>
              <a href="thread.html#2614">[ thread ]</a>
              <a href="subject.html#2614">[ subject ]</a>
              <a href="author.html#2614">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The code for InterlockedCompareExchange has a bug that makes it impossible
to use it twice in the same file (or perhaps function). This is a latent
bug in that someone modified cross platform code to use this call twice in
close enough context and suddenly it broke. (I haven't looked at the CVS
logs. There are other ways this could happen. I am guessing...)

In anyevent, replacing the labels in InterlockedCompareExchange with local
ones should fix the problem. In atomic.g, replace the body of
InterlockedCompareExchange with the following code:

inline  gint32 InterlockedCompareExchange(volatile gint32 *dest,
						gint32 exch, gint32 comp) {
	gint32 tmp = 0;

	__asm__ __volatile__ (&quot;\n0:\n\t&quot;
			     &quot;lwarx   %0, 0, %1\n\t&quot;
			     &quot;cmpw    %2, %3\n\t&quot; 
			     &quot;bne-    1f\n\t&quot;
			     &quot;stwcx.  %4, 0, %1\n\t&quot;
			     &quot;bne-    0b\n&quot;
			     &quot;1:&quot;
			     : &quot;=r&quot; (tmp)
			     : &quot;r&quot; (dest), &quot;0&quot; (tmp) ,&quot;r&quot; (comp), &quot;r&quot; (exch));
	return(tmp);
}


Someone also ought to replace the line:

#define InterlockedCompareExchangePointer InterlockedCompareExchange

with something like:

static inline gpointer InterlockedCompareExchangePointer(volatile gpointer
*dest, gpointer exch, gpointer comp)
{
	return (gpointer)InterlockedCompareExchange((volatile gint32 *)dest,
						(gint32)exch, (gint32)comp);
}

(None of the above code has been tested. I did compile the
InterlockedCompareExchange on OS X 10.2.6.)

-Z-

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002596.html">[Mono-devel-list] OSX Questions
</A></li>
	<LI>Next message: <A HREF="002597.html">[Mono-devel-list] How to link Mono with unicows.lib?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2614">[ date ]</a>
              <a href="thread.html#2614">[ thread ]</a>
              <a href="subject.html#2614">[ subject ]</a>
              <a href="author.html#2614">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
