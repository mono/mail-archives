<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Thread stacks sizes - interpreter vs J
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Thread%20stacks%20sizes%20-%20interpreter%20vs%20J&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002327.html">
   <LINK REL="Next"  HREF="002285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Thread stacks sizes - interpreter vs J</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Thread%20stacks%20sizes%20-%20interpreter%20vs%20J&In-Reply-To="
       TITLE="[Mono-devel-list] Thread stacks sizes - interpreter vs J">bernard at ugsolutions.com
       </A><BR>
    <I>Mon Oct  6 20:17:13 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002327.html">[Mono-devel-list] Thread stacks sizes - interpreter vs J
</A></li>
        <LI>Next message: <A HREF="002285.html">[Mono-devel-list] Mono 0.28 - DateTime.MinValue.ToString() crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2338">[ date ]</a>
              <a href="thread.html#2338">[ thread ]</a>
              <a href="subject.html#2338">[ subject ]</a>
              <a href="author.html#2338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After the various replies to my message what I am considering
is making CreateThread take notice of its stacksize argument.
If it is zero use 2Mb/4Mb for 32/64 bits.

Also at the metadata level add a mono_thread_set_default_stacksize
routine to change the default used in the calls to CreateThread
from within metadata. Then the interpreter can set the stack larger
if need be (as I need at present...)

As for other configuration options wouldn't it be better to
have this in an apps config file than in an environment variable?

As for the size. The HP compiler generates a stack frame
of about 3k for the interpreter main routine - that is the statically
calculated size - alloca will increase this at runtime. This is because
every variable is separately allocated on the stack even if by scoping
rules two variables can use the same slot. So the only way of reducing
this is by moving variables up to the top of the routine and reusing
them wherever possible at the source level. This is definitely not my
preference in terms of code style but maybe this is a special case
(or if I could find an option to change the compiler behaviour that
would help too...).

Now I happened to try fiddling with stack sizes while building
corlib_test.dll with mcs. It definitely blows a 16Mb stack size. At this
point the stack is 4,600 frames deep which doing the math is about
what you'd expect for that frame size. The bulk of the stack is
in calls to Resolve &amp; DoResolve methods in mcs from various classes.
I am not sure if any implementation of tail calls and making those work
in the interpreter would actually help here or not as I haven't studied
the compiler code to see if the calls can be optimized this way.

So I think everything is actually behaving predictably and for
the moment I'll stick to setting a 32Mb stack at least for the
interpreter on HP.

Bernie Solomon
----- Original Message ----- 
From: &quot;Paolo Molaro&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Monday, October 06, 2003 7:18 AM
Subject: Re: [Mono-devel-list] Thread stacks sizes - interpreter vs J


&gt;<i> On 10/06/03 Dick Porter wrote:
</I>&gt;<i> &gt; On Sat, 2003-10-04 at 11:32, Varga Zoltan wrote:
</I>&gt;<i> &gt; &gt;    I would recommend adding a function to io-layer to set
</I>&gt;<i> &gt; &gt; the default
</I>&gt;<i> &gt; &gt; stack size. The JIT and the interpreter could call it with
</I>&gt;<i> &gt; &gt; different values on startup.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We can't add any external API to io-layer that isn't in the w32 API.
</I>&gt;<i>
</I>&gt;<i> There is no need for an additional API entry point: CreateThread already
</I>&gt;<i> has an argument to specify the stack size for the thread, so io-layer
</I>&gt;<i> just needs to be fixed to obey that argument and the entry point could
</I>&gt;<i> be added to metadata/.
</I>&gt;<i>
</I>&gt;<i> &gt; For the stack size, CreateThread sets it because of issues with BSD.  It
</I>&gt;<i> &gt; would probably be best to just conditionally define that and let other
</I>&gt;<i> &gt; platforms use their defaults.
</I>&gt;<i>
</I>&gt;<i> As for the original issue: it makes sense to double the default stack
</I>&gt;<i> size for 64 bit apps, but I'm not sure increasing the stack size for mint
</I>is
&gt;<i> a correct solution: if it requires 30+MB of stack, there is something
</I>&gt;<i> else to fix. I would support using an environment variable to set the
</I>&gt;<i> stack size to non-default values, so that specific apps that may have
</I>&gt;<i> particular demands can be tweaked, both increasing the stack size (mint
</I>&gt;<i> until it's fixed) and decreasing it (think an app server with thousand
</I>&gt;<i> of threads on a 32bit system).
</I>&gt;<i>
</I>&gt;<i> lupus
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002327.html">[Mono-devel-list] Thread stacks sizes - interpreter vs J
</A></li>
	<LI>Next message: <A HREF="002285.html">[Mono-devel-list] Mono 0.28 - DateTime.MinValue.ToString() crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2338">[ date ]</a>
              <a href="thread.html#2338">[ thread ]</a>
              <a href="subject.html#2338">[ subject ]</a>
              <a href="author.html#2338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
