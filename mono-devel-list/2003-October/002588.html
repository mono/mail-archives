<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Question about x86 version of mono_create_trampoline .
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20about%20x86%20version%20of%20mono_create_trampoline%20.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002586.html">
   <LINK REL="Next"  HREF="002595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Question about x86 version of mono_create_trampoline .</H1>
    <B>zalman at peachfish.com</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Question%20about%20x86%20version%20of%20mono_create_trampoline%20.&In-Reply-To="
       TITLE="[Mono-devel-list] Question about x86 version of mono_create_trampoline .">zalman at peachfish.com
       </A><BR>
    <I>Mon Oct 20 00:29:34 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002586.html">[Mono-devel-list] CVS is up
</A></li>
        <LI>Next message: <A HREF="002595.html">[Mono-devel-list] Very slow connection via Npgsql from mono 0.26, 0.28
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2588">[ date ]</a>
              <a href="thread.html#2588">[ thread ]</a>
              <a href="subject.html#2588">[ subject ]</a>
              <a href="author.html#2588">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am working on porting Mono to AMD64. (As in long-mode, with 64-bit
address space and new caling convention, more registers, etc.) I noticed
the following code in mono_create_trampoline and am wondering why it is
there:

        /*
         * and align to 16 byte boundary...
         */
        stack_size += 15;
        stack_size &amp;= ~15;

-&gt;        if (stack_size)
-&gt;                x86_alu_reg_imm (p, X86_SUB, X86_ESP, stack_size);

(At or near line 131 of mono/mono/arch/x86/tramp.c , alignment statements
given for context.)

It looks like the code is trying to allocate space for the incoming
arguments so they can be stored into place. But the code below uses push
instructions, or explicitly decrements the stack for floating point
arguments.

Mostly wondering if I'm missing something here, though perhaps there is a
tiny optimization to use less stack for pinvoked calls.

Another issue with this is that the 16-byte alignment is not guaranteed by
the current code if I understand it correctly. (I'm not sure if plain x86
requires that strict a stack frame alignment. AMD64 *does*.)

Thank you,
-Z-



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002586.html">[Mono-devel-list] CVS is up
</A></li>
	<LI>Next message: <A HREF="002595.html">[Mono-devel-list] Very slow connection via Npgsql from mono 0.26, 0.28
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2588">[ date ]</a>
              <a href="thread.html#2588">[ thread ]</a>
              <a href="subject.html#2588">[ subject ]</a>
              <a href="author.html#2588">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
