<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Potential GAC implementation ideas.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Potential%20GAC%20implementation%20ideas.&In-Reply-To=001301c3991d%244b9f53a0%24c400a8c0%40proton">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002630.html">
   <LINK REL="Next"  HREF="002638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Potential GAC implementation ideas.</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Potential%20GAC%20implementation%20ideas.&In-Reply-To=001301c3991d%244b9f53a0%24c400a8c0%40proton"
       TITLE="[Mono-devel-list] Potential GAC implementation ideas.">jonpryor at vt.edu
       </A><BR>
    <I>Thu Oct 23 07:36:35 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="002630.html">[Mono-devel-list] Potential GAC implementation ideas.
</A></li>
        <LI>Next message: <A HREF="002638.html">[Mono-devel-list] Potential GAC implementation ideas.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2637">[ date ]</a>
              <a href="thread.html#2637">[ thread ]</a>
              <a href="subject.html#2637">[ subject ]</a>
              <a href="author.html#2637">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just to continue discussion, there are two alternative methods of
implementing GAC support:

  - Implement GAC support as internal calls within the mono runtime,
    NOT mscorlib.dll.

  - Implement GAC support in a separate native library, and (a) P/Invoke
    into it (for gacutil), or (b) just use the library (from mono)

The upside to these options is that mscorlib.dll doesn't have to be
special (it can be ngened like any other assembly, as long as we go
through our GAC support code before loading mscorlib.dll).

Furthermore, using a separate native library, would likely simplify code
sharing with pnet.  (Though having a well-written spec and two separate
implementations between mono &amp; pnet might be better...)

The downside is that we can't use C#.

If we only need to worry about directory structure &amp; file lookup, then
it should be easy enough to write in C without worrying (too much) about
memory issues and bugs.  This would favor one of the above solutions.

If it's more complicated, we'll probably want to do it in managed code,
simplifying maintenance, which would favor one of Todd's suggestions.

Which would I prefer?  Whichever is easiest. :-)

 - Jon

On Thu, 2003-10-23 at 00:22, Todd Berman wrote:
&gt;<i> Ok. Just a heads up, if the GAC or its potential implementation doesn't
</I>&gt;<i> interest you, stop reading now. As well, if you can't handle somewhat
</I>&gt;<i> rambling thoughts and a somewhat long email, stop right now as well. :)
</I>&gt;<i> 
</I>&gt;<i> This information is all stuff I've seen and looked at, I am not 100% sure of
</I>&gt;<i> all of its validity, and if anyone knows that any of it is erroneous please,
</I>&gt;<i> reply with your information.
</I>&gt;<i> 
</I>&gt;<i> First off, just a bit of background, particularly on ms.net's implementation
</I>&gt;<i> of the GAC and fusion in general.
</I>&gt;<i> 
</I>&gt;<i> Fusion is the internal MS code name for 3 basic technologies, all tied into
</I>&gt;<i> the removal of DLL hell. These 3 technologies basically comprise 1) The GAC,
</I>&gt;<i> 2) Zap (the GAC for ngen'd images), 3) Downloaded Cache.
</I>&gt;<i> 
</I>&gt;<i> Now, ms.net has a unmanaged dll, called fusion.dll that has an api that
</I>&gt;<i> deals with the GAC, documented here:
</I>&gt;<i> <A HREF="http://support.microsoft.com/default.aspx?scid=kb;[LN];317540">http://support.microsoft.com/default.aspx?scid=kb;[LN];317540</A>
</I>&gt;<i> 
</I>&gt;<i> There is also a thin managed wrapper (not sure how feature complete) that
</I>&gt;<i> can be accessed through Reflection in mscorcfg.dll (shared assembly using
</I>&gt;<i> for the .net MMCs and other configuration tools).
</I>&gt;<i> 
</I>&gt;<i> Now, ms.net actually stores the GAC physically on your hard drive in the
</I>&gt;<i> following format:
</I>&gt;<i> 
</I>&gt;<i> &lt;%windir%&gt;/Assembly
</I>&gt;<i> 	/GAC
</I>&gt;<i> 		/${ASSEMBLY_NAME}
</I>&gt;<i> 			/${ASSEMBLY_VERSION}__${PUBLIC_TOKEN}
</I>&gt;<i> 				/${ASSEMBLY_NAME}.dll
</I>&gt;<i> 				/__AssemblyInfo__.ini
</I>&gt;<i> 
</I>&gt;<i> This allows multiple versions of the same assembly to be stored in the gac
</I>&gt;<i> without any issues.
</I>&gt;<i> 
</I>&gt;<i> A sample __AssemblyInfo__.ini looks like:
</I>&gt;<i> 
</I>&gt;<i> [AssemblyInfo]
</I>&gt;<i> Signature=fa793c1dc7da9563140dc468405b7246b4363542
</I>&gt;<i> MVID=a1d9480da4da0341bf4cf61f0831b455
</I>&gt;<i> DisplayName=System, Version=1.0.5000.0, Culture=neutral,
</I>&gt;<i> PublicKeyToken=b77a5c561934e089
</I>&gt;<i> 
</I>&gt;<i> All of these fields except MVID are self evident, and it seems that the MVID
</I>&gt;<i> stores information that allows the GAC to potentially locate ngen'd images.
</I>&gt;<i> 
</I>&gt;<i> Interestingly enough, on my copy of ms.net, mscorlib is ngen'd but not in
</I>&gt;<i> the GAC otherwise.
</I>&gt;<i> 
</I>&gt;<i> Now, onto the mono side of things. I think that the directory structure is
</I>&gt;<i> the right way to do, and also the easiest way to go. Replicating it, but
</I>&gt;<i> replacing &lt;%windir%&gt;/assembly with $prefix/lib/mono will make the most sense
</I>&gt;<i> that I can see.
</I>&gt;<i> 
</I>&gt;<i> On windows, there is a tool, called gacutil, that is used to manipulate the
</I>&gt;<i> gac on the command line. With this tool, you can install, uninstall, list,
</I>&gt;<i> and generally manipulate the gac. To me, this is the first piece of the gac
</I>&gt;<i> that needs to be implemented, because without it, installing assemblies into
</I>&gt;<i> the gac will be more difficult than it needs to be.
</I>&gt;<i> 
</I>&gt;<i> With implementing the gacutil, there are several choices that I can see.
</I>&gt;<i> 
</I>&gt;<i> 1) make gacutil.exe a self contained .exe that can manipulate the gac on its
</I>&gt;<i> own with no special external libraries. This would require the runtime to
</I>&gt;<i> handle locating assemblies in the gac in their own way.
</I>&gt;<i> 
</I>&gt;<i> Potential Pros: Potentially easier to implement. Allows the runtime to do
</I>&gt;<i> whatever it needs to do. Runtime portion will most likely be very fast.
</I>&gt;<i> 
</I>&gt;<i> Potential Cons: Two sets of bugs, two sets of code to maintain.
</I>&gt;<i> 
</I>&gt;<i> 2) an Mono specific class inside the Mono. Namespace in corlib that allows
</I>&gt;<i> easy manipulation of the gac. Now, I suggested this briefly on irc, and
</I>&gt;<i> Miguel disliked the idea initially because of the corlib locating itself
</I>&gt;<i> issue. However, after looking a bit at ms.net, the GAC on my .net framework
</I>&gt;<i> doesn't have mscorlib in it. It does have 2 native images inside the ngen
</I>&gt;<i> image section, but not in the GAC part itself. Using this solution we can
</I>&gt;<i> keep corlib.dll in $prefix/lib and allow the runtime to locate it that way,
</I>&gt;<i> and then call into the corlib to locate the location of assemblies to bind
</I>&gt;<i> to.
</I>&gt;<i> 
</I>&gt;<i> Potential Pros: One set of bugs, one set of code to maintain with future
</I>&gt;<i> revisions, features. Its managed, and managed is good :P
</I>&gt;<i> 
</I>&gt;<i> Potential Cons: Might be a bit slower. Wont remove all the .dlls from
</I>&gt;<i> $prefix/lib
</I>&gt;<i> 
</I>&gt;<i> These are just two potential implementations ideas, I would love to hear
</I>&gt;<i> more, and get a good discussion going on this so we can start laying down
</I>&gt;<i> some code :)
</I>&gt;<i> 
</I>&gt;<i> --Todd
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002630.html">[Mono-devel-list] Potential GAC implementation ideas.
</A></li>
	<LI>Next message: <A HREF="002638.html">[Mono-devel-list] Potential GAC implementation ideas.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2637">[ date ]</a>
              <a href="thread.html#2637">[ thread ]</a>
              <a href="subject.html#2637">[ subject ]</a>
              <a href="author.html#2637">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
