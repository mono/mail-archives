<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Patch for full-featured mcs /doc support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20full-featured%20mcs%20/doc%20support&In-Reply-To=41A46C6D.1020900%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009050.html">
   <LINK REL="Next"  HREF="009067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Patch for full-featured mcs /doc support</H1>
    <B>Marek Safar</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Patch%20for%20full-featured%20mcs%20/doc%20support&In-Reply-To=41A46C6D.1020900%40ximian.com"
       TITLE="[Mono-devel-list] Patch for full-featured mcs /doc support">marek.safar at seznam.cz
       </A><BR>
    <I>Wed Nov 24 13:49:04 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009050.html">[Mono-devel-list] Patch for full-featured mcs /doc support
</A></li>
        <LI>Next message: <A HREF="009067.html">[Mono-devel-list] Patch for full-featured mcs /doc support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9053">[ date ]</a>
              <a href="thread.html#9053">[ thread ]</a>
              <a href="subject.html#9053">[ subject ]</a>
              <a href="author.html#9053">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Eno,

&gt;<i>Finally I finished the complete patch set for /doc features,
</I>&gt;<i>tests and errors, including warning checks and result document
</I>&gt;<i>comparison as long as it makes sense ... except for one thing
</I>&gt;<i>I couldn't complete; cref attribute handling which has no
</I>&gt;<i>information how it is checked.
</I>&gt;<i>
</I>&gt;<i>Would you please review this new patch? Am very sorry but I
</I>&gt;<i>significantly changed the code (like adding much changes on
</I>&gt;<i>parser/tokenizer to detech invalid comments, removing XmlElement
</I>&gt;<i>field from member, using XmlWriter directly to output, etc).
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>Very, very good progress, tests are wonderful. I think that Miguel
should prepare official stamp ;-)

My comments:

+ public string consume_doc_comment ()
+ {
+ if (xml_comment_buffer.Length &gt; 0) {
+ string ret = null;
+ if (xmlCommentSavePoint &gt; 0) {
+ ret = xml_comment_buffer.ToString (0, xmlCommentSavePoint);
+ xml_comment_buffer.Remove (0, xmlCommentSavePoint);
+ } else {
+ ret = xml_comment_buffer.ToString ();
+ xml_comment_buffer.Length = 0;
+ }
+ xmlCommentSavePoint = 0;
+ return ret;
+ }
+ else
+ return null;
+ }

The last else is useless and xmlCommentSavePoint = 0 should be only for
xmlCommentSavePoint &gt; 0.

+ public enum XmlCommentState {
+ OK,
+ NG,
+ Error
+ }

What is NG ?

+ MemberInfo mi = FindDocumentedMember (type, memberName,
parameterTypes, ds, out warnResult);
+ switch (warnResult) {
+ case 1581:
+ Report.Warning (1581, 1, Location, &quot;Invalid return type in XML comment
cref attribute '{0}'&quot;, cref);
+ return;
+ case 1584:
+ Report.Warning (1020, 1, Location, &quot;Overloadable {0} operator is
expected&quot;, parameterTypes.Length == 2 ? &quot;binary&quot; : &quot;unary&quot;);
+ Report.Warning (1584, 1, Location, &quot;XML comment on '{0}' has
syntactically incorrect attribute '{1}'&quot;, GetSignatureForError (), cref);
+ return;
+ }

Why don't do it inside FindDocumentMember to avoid copy&amp;paste.


- : IDENTIFIER
+ : IDENTIFIER
+ {
+ tmpComment = Lexer.consume_doc_comment ();
+ Lexer.doc_state = XmlCommentState.OK;
+ }
OPEN_PARENS opt_formal_parameter_list CLOSE_PARENS
{
oob_stack.Push (lexer.Location);

- current_local_parameters = (Parameters) $3;
+ current_local_parameters = (Parameters) $4;
}
opt_constructor_initializer
{
Location l = (Location) oob_stack.Pop ();
- $$ = new Constructor (current_class, (string) $1, 0, (Parameters) $3,
- (ConstructorInitializer) $6, l);
+ $$ = new Constructor (current_class, (string) $1, 0, (Parameters) $4,
+ (ConstructorInitializer) $7, l);
}

I am confuse, what has been changed.

+ } catch (NotImplementedException ex) {
+ Report.Error (1569, &quot;Error generating XML documentation file '{0}'
('{1}')&quot;, xml_documentation_file, ex.Message);
+ return false;

Does make a sense to catch this exception ?

+ vd.DocComment = ConsumeStoredComment ();
+ Lexer.doc_state = XmlCommentState.OK;

Why don't call this tricky property in ConsumeStroredComment I found
only one place where this combination is missing (bug ??). Should be
possible also to rename this property ?
BTW: I think we should call this call only for /doc option.

+ private MemberInfo FindDocumentedMember (Type type, string memberName,
Type [] paramList, DeclSpace ds, out int warningType)

This is heavyweight. I think we can optimize or reuse some of the
existing code here. But we will have to do it sometimes later.


To Miguel, Martin: Why we have TypeContainer instead of DeclSpace in
MemberCore class. I faced off with this many many times and here it is
again. It looks like I will have to do big clean up ;-)


Marek

&gt;<i>------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>Index: Makefile
</I>&gt;<i>===================================================================
</I>&gt;<i>--- Makefile	(revision 36457)
</I>&gt;<i>+++ Makefile	(working copy)
</I>&gt;<i>@@ -13,7 +13,7 @@
</I>&gt;<i> # force this, we don't case if CSC is broken. This also
</I>&gt;<i> # means we can use --options, yay.
</I>&gt;<i> 
</I>&gt;<i>-MCS = MONO_PATH=&quot;$(topdir)/class/lib/$(PROFILE)$(PLATFORM_PATH_SEPARATOR)$$MONO_PATH&quot; $(INTERNAL_MCS)
</I>&gt;<i>+MCS = MONO_PATH=&quot;$(topdir)/class/lib/$(PROFILE) $(PLATFORM_PATH_SEPARATOR) $$MONO_PATH&quot; $(INTERNAL_MCS)
</I>&gt;<i> endif
</I>&gt;<i> 
</I>&gt;<i> # We don't want debugging info :-)
</I>&gt;<i>@@ -26,7 +26,8 @@
</I>&gt;<i> # He may also move some to TEST_EXCLUDE_net_2_0 if some of the merges are inappropriate for GMCS.
</I>&gt;<i> #
</I>&gt;<i> NEW_TEST_SOURCES_common = test-294 test-304 test-305 test-306 test-307 test-318 mtest-5-dll mtest-5-exe \
</I>&gt;<i>-			test-319-dll test-319-exe
</I>&gt;<i>+			test-319-dll test-319-exe \
</I>&gt;<i>+			$(TEST_SOURCES_XML)
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Please do _not_ add any tests here - all new tests should go into NEW_TEST_SOURCES_common
</I>&gt;<i>@@ -110,14 +111,14 @@
</I>&gt;<i> 	$(TEST_SOURCES_common) $(TEST_SOURCES_$(PROFILE)) $(TEST_SOURCES_$(PLATFORM)))
</I>&gt;<i> 
</I>&gt;<i> # These tests load User32.dll and/or Kernel32.dll
</I>&gt;<i>-TEST_SOURCES_win32 = test-50 test-67
</I>&gt;<i>+TEST_SOURCES_win32 = test-67
</I>&gt;<i> 
</I>&gt;<i> ## FIXME: Need to audit.  Maybe move to 'TEST_EXCLUDES_linux' and 'TEST_EXCLUDES_win32' as approprate
</I>&gt;<i> # A test is a 'no pass' if it fails on either windows or linux
</I>&gt;<i> # Test 120 does not pass because the MS.NET runtime is buggy.
</I>&gt;<i> 
</I>&gt;<i> TEST_NOPASS = test-120 test-132 test-133 a-parameter4.cs 
</I>&gt;<i>-#	test-28 test-45 test-53 test-91 test-102 test-106 test-107 test-122 test-66 test-177
</I>&gt;<i>+#	test-28 test-45 test-50 test-53 test-91 test-102 test-106 test-107 test-122 test-66 test-177
</I>&gt;<i> 
</I>&gt;<i> # The test harness supports running the testcases in parallel.  However, we still need to
</I>&gt;<i> # provide test-ordering rules to support multi-file testcases.  By default, any test named
</I>&gt;<i>@@ -155,7 +156,7 @@
</I>&gt;<i> 
</I>&gt;<i> test-local: 
</I>&gt;<i> 
</I>&gt;<i>-run-test-local: multi test-harness test-casts
</I>&gt;<i>+run-test-local: multi test-harness test-casts xmldocdiff.exe xml-doc
</I>&gt;<i> 
</I>&gt;<i> test-everything:
</I>&gt;<i> 	$(MAKE) PROFILE=default run-test
</I>&gt;<i>@@ -222,3 +223,30 @@
</I>&gt;<i> 	$(INTERNAL_ILASM) /dll property-il.il
</I>&gt;<i> 	$(CSCOMPILE) /r:property-il.dll property-main.cs /out:property-main.exe
</I>&gt;<i> 	$(TEST_RUNTIME) property-main.exe
</I>&gt;<i>+
</I>&gt;<i>+
</I>&gt;<i>+#
</I>&gt;<i>+# Test for /doc option; need to compare result documentation files.
</I>&gt;<i>+#
</I>&gt;<i>+
</I>&gt;<i>+TEST_SOURCES_XML = \
</I>&gt;<i>+	xml-001 xml-002 xml-003 xml-004 xml-005 xml-006 xml-007 xml-008 xml-009 xml-010 \
</I>&gt;<i>+	xml-011 xml-012 xml-013 xml-014 xml-015 xml-016 xml-017 xml-018 xml-019 xml-020 \
</I>&gt;<i>+	xml-021 xml-022 xml-023 xml-024 xml-025 xml-026
</I>&gt;<i>+
</I>&gt;<i>+# currently no formalization on 'cref' attribute was found, so there are some
</I>&gt;<i>+# differences between MS.NET and mono.
</I>&gt;<i>+TEST_SOURCES_XML_PENDING = xml-027
</I>&gt;<i>+
</I>&gt;<i>+xmldocdiff.exe:
</I>&gt;<i>+	$(CSCOMPILE) xmldocdiff.cs
</I>&gt;<i>+
</I>&gt;<i>+xml-doc:
</I>&gt;<i>+	@$(MAKE) -s xml-doc-run
</I>&gt;<i>+
</I>&gt;<i>+xml-doc-tests := $(filter xml-%, $(TEST_SOURCES))
</I>&gt;<i>+
</I>&gt;<i>+xml-doc-run:
</I>&gt;<i>+	@echo &quot;Testing /doc outputs...&quot;
</I>&gt;<i>+	@test -z &quot;$(xml-doc-tests)&quot; || for i in ''$(xml-doc-tests); do $(TEST_RUNTIME) xmldocdiff.exe $$i-ref.xml dir-$(TEST_TAG)/$$i.xml; done
</I>&gt;<i>+
</I>&gt;<i>  
</I>&gt;<i>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009050.html">[Mono-devel-list] Patch for full-featured mcs /doc support
</A></li>
	<LI>Next message: <A HREF="009067.html">[Mono-devel-list] Patch for full-featured mcs /doc support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9053">[ date ]</a>
              <a href="thread.html#9053">[ thread ]</a>
              <a href="subject.html#9053">[ subject ]</a>
              <a href="author.html#9053">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
