<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] CAS - patch for declarative stack modifiers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20CAS%20-%20patch%20for%20declarative%20stack%20modifiers&In-Reply-To=20041130143255.GX2153%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009147.html">
   <LINK REL="Next"  HREF="009153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] CAS - patch for declarative stack modifiers</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20CAS%20-%20patch%20for%20declarative%20stack%20modifiers&In-Reply-To=20041130143255.GX2153%40debian.org"
       TITLE="[Mono-devel-list] CAS - patch for declarative stack modifiers">spouliot at videotron.ca
       </A><BR>
    <I>Tue Nov 30 12:01:35 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009147.html">MINT: Was [Mono-devel-list] CAS - patch for declarative stack modifiers
</A></li>
        <LI>Next message: <A HREF="009153.html">[Mono-devel-list] CAS - patch for declarative stack modifiers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9149">[ date ]</a>
              <a href="thread.html#9149">[ thread ]</a>
              <a href="subject.html#9149">[ subject ]</a>
              <a href="author.html#9149">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i> &gt; Index: mono/mini/mini-exceptions.c
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- mono/mini/mini-exceptions.c	(revision 36773)
</I>&gt;<i> &gt; +++ mono/mini/mini-exceptions.c	(working copy)
</I>&gt;<i> &gt; @@ -243,6 +243,73 @@
</I>&gt;<i> &gt;  	return TRUE;
</I>&gt;<i> &gt;  }
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; +MonoBoolean
</I>&gt;<i> &gt;
</I>&gt;<i> +ves_icall_System_Security_SecurityFrame_GetSecurityFrameInformati
</I>&gt;<i> on (gint32 skip, MonoReflectionMethod **method, gint32 *flags)
</I>&gt;<i> &gt; +{
</I>&gt;<i> &gt; +	MonoDomain *domain = mono_domain_get ();
</I>&gt;<i> &gt; +	MonoJitTlsData *jit_tls = TlsGetValue (mono_jit_tls_id);
</I>&gt;<i> &gt; +	MonoLMF *lmf = jit_tls-&gt;lmf;
</I>&gt;<i> &gt; +	MonoJitInfo *ji, rji;
</I>&gt;<i> &gt; +	MonoContext ctx, new_ctx;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	mono_arch_flush_register_windows ();
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +	MONO_CONTEXT_SET_IP (&amp;ctx,
</I>&gt;<i> ves_icall_System_Security_SecurityFrame_GetSecurityFrameInformation);
</I>&gt;<i> &gt; +	MONO_CONTEXT_SET_BP (&amp;ctx, __builtin_frame_address (0));
</I>&gt;<i>
</I>&gt;<i> It's not a good idea to duplicate this code.
</I>
My bad. I was under the impression (and actually surprised) that
mini-exceptions.c wasn't arch specific. Actually it seems the get_frame
function is shared by most archs (x86, amd64), with very little difference
for S/390[x] and a little more diffs for PPC...

Paolo, I refactored the code (attached) to use a different callback (one for
debug and one for security) as you suggested on IRC (not fully tested but it
bootstraps and runs corlib's unit tests).

Is it better this way ?
It will still need some adjustment for other archs but (hopefully) I
shouldn't be messing with them afterward.

&gt;<i>
</I>&gt;<i> &gt; +	do {
</I>&gt;<i> &gt; +		ji = mono_find_jit_info (domain, jit_tls, &amp;rji,
</I>&gt;<i> NULL, &amp;ctx, &amp;new_ctx, NULL, &amp;lmf, NULL, NULL);
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +		ctx = new_ctx;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +		if (!ji || ji == (gpointer)-1 ||
</I>&gt;<i> MONO_CONTEXT_GET_BP (&amp;ctx) &gt;= jit_tls-&gt;end_of_stack)
</I>&gt;<i> &gt; +			return FALSE;
</I>&gt;<i> &gt; +
</I>&gt;<i> &gt; +		/* skip all wrappers */
</I>&gt;<i>
</I>&gt;<i> And you likely don't want to skip the wrappers: we should also
</I>&gt;<i> make sure that
</I>&gt;<i> the security attributes of the wrapped methods are reflected in
</I>&gt;<i> the wrappers,
</I>&gt;<i> otherwise we're going to lose some security checks.
</I>
&gt;<i> This interface may also be too slow: it requires an icall for
</I>&gt;<i> each stack frame.
</I>&gt;<i> Isn't it possible to design a different one that can return all
</I>&gt;<i> the needed info
</I>&gt;<i> at once?
</I>
Yes - this could be changed to return all the frames/flags in one call
(simple) or even to return all stack modifiers for every frame (not so
simple and I'm unsure if it's worth it - e.g. asserted demands and demands
failures wouldn't need all of them) but it's also worth a look (later for
second part).

Thanks
Sebastien
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cas-mini-frame.diff
Type: application/octet-stream
Size: 6241 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20041130/aff74ace/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20041130/aff74ace/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009147.html">MINT: Was [Mono-devel-list] CAS - patch for declarative stack modifiers
</A></li>
	<LI>Next message: <A HREF="009153.html">[Mono-devel-list] CAS - patch for declarative stack modifiers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9149">[ date ]</a>
              <a href="thread.html#9149">[ thread ]</a>
              <a href="subject.html#9149">[ subject ]</a>
              <a href="author.html#9149">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
