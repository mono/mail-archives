<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Move of Interlocked.Increment/Decrement/Exchange I4 to op codes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Move%20of%20Interlocked.Increment/Decrement/Exchange%20I4%20to%20op%20codes&In-Reply-To=899040034C23FB4B96DF7C936B2F7247CD1AA9%40swsmsx403.ger.corp.intel.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009012.html">
   <LINK REL="Next"  HREF="009096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Move of Interlocked.Increment/Decrement/Exchange I4 to op codes</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Move%20of%20Interlocked.Increment/Decrement/Exchange%20I4%20to%20op%20codes&In-Reply-To=899040034C23FB4B96DF7C936B2F7247CD1AA9%40swsmsx403.ger.corp.intel.com"
       TITLE="[Mono-devel-list] [PATCH] Move of Interlocked.Increment/Decrement/Exchange I4 to op codes">lupus at ximian.com
       </A><BR>
    <I>Fri Nov 26 10:11:17 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="009012.html">[Mono-devel-list] [PATCH] Move of   Interlocked.Increment/Decrement/Exchange I4 to op codes
</A></li>
        <LI>Next message: <A HREF="009096.html">[Mono-devel-list] [PATCH] Move of	Interlocked.Increment/Decrement/Exchange I4 to op codes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9080">[ date ]</a>
              <a href="thread.html#9080">[ thread ]</a>
              <a href="subject.html#9080">[ subject ]</a>
              <a href="author.html#9080">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/23/04 Torstensson, Patrik wrote:
&gt;<i> bus lock prefix (2,5 x speed difference). There is one known issue with
</I>&gt;<i> this patch; it should ignore the mp check when doing AOT, havn't had the
</I>&gt;<i> time to fix that in this patch (simple.. Just check for AOT in
</I>&gt;<i> detection)
</I>
We need to add the number of cpus in the aot file, so if that changes
we won't load it.
The code in io-layer/system.c needs to be changed to be pessimistic:
if it can't figure out the number of processors it should assume 2, not
1 or we may end up generating incorrect code.

&gt;<i> Index: mini-ops.h
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mini-ops.h	(revision 36280)
</I>&gt;<i> +++ mini-ops.h	(working copy)
</I>&gt;<i> @@ -400,6 +400,10 @@
</I>&gt;<i>  MINI_OP(OP_RESTORE_LMF, &quot;restore_lmf&quot;)
</I>&gt;<i>  
</I>&gt;<i>  
</I>&gt;<i> +/* ATOMIC operands */
</I>&gt;<i> +MINI_OP(OP_ATOMIC_INC_I4, &quot;op_atomic_inc_i4&quot;)
</I>&gt;<i> +MINI_OP(OP_ATOMIC_DEC_I4, &quot;op_atomic_dec_i4&quot;)
</I>
How about adding OP_ATOMIC_ADD_IMM and OP_ATOMIC_ADD, instead?
The latter is needed for the next version, anyway, and the first
can be used to get the small optimization.
Using OP_ATOMIC_ADD_IMM requires a small refactoring of
mono_arch_get_opcode_for_method(): it should be changed to
create and return a MonoInst*, so it can also set the immediate value:
this seems more flexible and may be needed for other ops, too.

&gt;<i> +			br1 = code;
</I>&gt;<i> +			if (!up_machine)
</I>&gt;<i> +				x86_prefix (code, X86_LOCK_PREFIX);
</I>&gt;<i> +			x86_cmpxchg_membase_reg (code, ins-&gt;inst_basereg, ins-&gt;inst_offset, sreg2);
</I>&gt;<i> +			x86_branch8 (code, X86_CC_NE, br1 - code - 1, FALSE);
</I>
Use x86_patch, here, instead of hardcoding br1 - code - 1.

Thanks.
lupus


-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009012.html">[Mono-devel-list] [PATCH] Move of   Interlocked.Increment/Decrement/Exchange I4 to op codes
</A></li>
	<LI>Next message: <A HREF="009096.html">[Mono-devel-list] [PATCH] Move of	Interlocked.Increment/Decrement/Exchange I4 to op codes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9080">[ date ]</a>
              <a href="thread.html#9080">[ thread ]</a>
              <a href="subject.html#9080">[ subject ]</a>
              <a href="author.html#9080">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
