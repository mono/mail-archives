<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Double-locking and thread safety
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Double-locking%20and%20thread%20safety&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012760.html">
   <LINK REL="Next"  HREF="012928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Double-locking and thread safety</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Double-locking%20and%20thread%20safety&In-Reply-To="
       TITLE="[Mono-devel-list] Double-locking and thread safety">kornelpal at hotmail.com
       </A><BR>
    <I>Thu Jun 23 15:07:45 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012760.html">[Mono-devel-list] Double-locking and thread safety
</A></li>
        <LI>Next message: <A HREF="012928.html">[Mono-devel-list] machine.config not found on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12761">[ date ]</a>
              <a href="thread.html#12761">[ thread ]</a>
              <a href="subject.html#12761">[ subject ]</a>
              <a href="author.html#12761">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> From: Ben Maurer
</I>&gt;<i> Anyways, there is no use arguing about this stuff. If you can show that
</I>&gt;<i> more complex code results in a measurable speedup, feel free to bring it
</I>&gt;<i> up ;-).
</I>
Although the current code is not complex lock, MemoryBarrier and
CompareExchange could be invoked a hundreds of times but to get proper
results they should be executed on the right architecture (multi-processor
system, threads on different processors, probably on IA64). I think it's
difficult to make a managed thread to use a specific processor and
MemoryBarrier is not implemented at all by Mono so it cannot be tested. And
of course the runtime does not support IA64. I don't want to argue about
this because it seems to be nearly impossible to test it.:)

But you can make sure that creating a new instance requires more time than
waiting for another thread to create it because:
1. We can assume that creating an object requires the same time because
alhough it's slower to create the first instance (static constructors, file
loading from disk, ...) the second thread has to wait these static
constructors so the second instance cannot be created faster.
2. Usually one of the threads start to create the instance earlier so one of
them will be created earlier.
3. Thus one of the threads will create the instance while all the other
threads will not create their instance before the first thread.
4. Usually the other threads will finish later so it's wasting of time.

And doing this has no drawbacks because if all of the threads finish the
same time only one of them did usefull work and all the others were wasting
CPU cycles so it sill has the advantage of CPU cycles.

This theoritically seems to be better than doing the reverse.

&gt;<i> In the meanwhile, I've done a few data-collection things:
</I>&gt;<i>
</I>&gt;<i> [<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">benm at omega</A> ~]$ mono --trace=T:Locale install/lib/monodoc/browser.exe
</I>&gt;<i> ENTER: Locale:GetText (string)([STRING:0x42720:EST], )
</I>&gt;<i> LEAVE: Locale:GetText (string)[STRING:0x42720:EST]
</I>&gt;<i> ENTER: Locale:GetText (string)([STRING:0x42738:EDT], )
</I>&gt;<i> LEAVE: Locale:GetText (string)[STRING:0x42738:EDT]
</I>&gt;<i>
</I>&gt;<i> (this is after browsing about for a bit).
</I>&gt;<i>
</I>&gt;<i> So, it looks like it is possible the people using DateTime will
</I>&gt;<i> experience a bit of slowness. However, I wonder if for this specific
</I>&gt;<i> case, we can rely on the OS's database of time zones.
</I>
You were right I did not know or used these tools.

Note that these strings are localized by the TimeZone class rather than
DateTime.

I don't know whether they should be localized but it is a bad practicle to
localize names in the constructor. They should be localized when the string
is returned because you can use different CurrentUICultures to retrive them
than you used to create the class.

&gt;<i> On mcs, there were *no* calls to Locale.GetText except when I tried to
</I>&gt;<i> compile a non-existent file. In that case, the exception was caught,
</I>&gt;<i> however it was still localized. Can this be avoided?
</I>
No. The problem is that the message (and not a key or format pattern) has to
be passed to the constructor of Exception. As MS.NET uses keys they have to
pass the localized message thus the message will be in the language used to
throw the Exception. This should be done by Mono to preserve compatibility.
Furthermore the message cannot contain any parameters ({0}, {1}, ...) it has
to contain a message with parameters filled in. And as applications can use
any messages (that may be localized by themselves) and probably they don't
want the class library to localize their messages.

&gt;<i> As for the expense of the reflection stuff you used, I have this test
</I>&gt;<i> case:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> using System;
</I>&gt;&gt;<i> using System.Text;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class X {
</I>&gt;&gt;<i>         static void Main ()
</I>&gt;&gt;<i>         {
</I>&gt;&gt;<i>                 Console.WriteLine (&quot;X&quot;);
</I>&gt;&gt;<i>                 //Console.WriteLine (typeof (X).Assembly.GetName
</I>&gt;&gt;<i> ().Name);
</I>&gt;&gt;<i>         }
</I>&gt;&gt;<i> }
</I>&gt;<i>
</I>
My only problem is that I don't know how much penalty does this mean (I
don't know how to interpret the results).

I don't insist on using this code if you have a better solution please let
me know.

Korn&#233;l


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012760.html">[Mono-devel-list] Double-locking and thread safety
</A></li>
	<LI>Next message: <A HREF="012928.html">[Mono-devel-list] machine.config not found on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12761">[ date ]</a>
              <a href="thread.html#12761">[ thread ]</a>
              <a href="subject.html#12761">[ subject ]</a>
              <a href="author.html#12761">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
