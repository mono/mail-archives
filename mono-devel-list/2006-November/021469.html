<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Fix for Membership.{Encrypt, Decrypt}Password
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20for%20Membership.%7BEncrypt%2C%20Decrypt%7DPassword&In-Reply-To=1164115239.3731.163.camel%40poupou.home">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021467.html">
   <LINK REL="Next"  HREF="021468.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Fix for Membership.{Encrypt, Decrypt}Password</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Fix%20for%20Membership.%7BEncrypt%2C%20Decrypt%7DPassword&In-Reply-To=1164115239.3731.163.camel%40poupou.home"
       TITLE="[Mono-dev] [PATCH] Fix for Membership.{Encrypt, Decrypt}Password">grendel at caudium.net
       </A><BR>
    <I>Tue Nov 21 08:44:17 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021467.html">[Mono-dev] [PATCH] Fix for Membership.{Encrypt, Decrypt}Password
</A></li>
        <LI>Next message: <A HREF="021468.html">[Mono-dev] System.IO.Ports Write() bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21469">[ date ]</a>
              <a href="thread.html#21469">[ thread ]</a>
              <a href="subject.html#21469">[ subject ]</a>
              <a href="author.html#21469">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 21 Nov 2006 08:20:38 -0500, Sebastien Pouliot
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien.pouliot at gmail.com</A>&gt; scribbled:

&gt;<i> Hello Marek,
</I>Hey Sebastien,

&gt;<i> On Tue, 2006-11-21 at 11:37 +0100, Marek Habersack wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;   Attached is a diff which reimplements the two methods mentioned in
</I>&gt;<i> &gt; the subject. The current implementation would break if the password
</I>&gt;<i> &gt; passed was larger than the symmetric algorithm block size and it
</I>&gt;<i> &gt; wouldn't take into account the IV embedded into the encrypted
</I>&gt;<i> &gt; password when decrypting. Also, it assumet the IV (salt) size to be
</I>&gt;<i> &gt; 16 bytes,
</I>&gt;<i> 
</I>&gt;<i> Note that a salt and an IV value are, often confused, but different
</I>&gt;<i> things. The IV, when required by the cipher mode, must be equal to the
</I>&gt;<i> symmetric algorithm cipher block. A salt doesn't have this
</I>&gt;<i> restriction.
</I>&gt;<i> 
</I>&gt;<i> Now the real question becomes &quot;is it a salt or an IV ?&quot;
</I>In this case it's the IV. SqlMembershipProvider calls it 'salt', but
the encryption functions require the IV to be provided for the algo
(since it is not specified in machineKey)

&gt;<i> &gt; which isn't forward-compatible. The reimplementation uses
</I>&gt;<i> &gt; CryptoStream and the size of the algorithm's IV to fix both of the
</I>&gt;<i> &gt; problems.
</I>&gt;<i> 
</I>&gt;<i> CryptoStream is nice as it does everything - but it comes at a high
</I>&gt;<i> price (performance wise as it involves, by design, many object/memory
</I>&gt;<i> allocations). I suggest people to avoid it unless they already deal
</I>&gt;<i> with streams.
</I>How would you suggest to approach this situation? We don't know the
length of the password beforehand and it's not limited, so I thought
CryptoStream would fit the bill here.

&gt;<i> &gt;   At first I thought that embedding the IV in the password passed to
</I>&gt;<i> &gt; {Encrypt,Decrypt}Password is incorrect according to the MS.NET
</I>&gt;<i> &gt; documentation, but the tests show that it's the documentation that's
</I>&gt;<i> &gt; wrong. 
</I>&gt;<i> 
</I>&gt;<i> Are the tests available somewhere ?
</I>Too late... I erased the code already :( - basically what I did was to
pass several strings to MS.NET's EncryptPassword and look at the output
and then compare it with the result we get. Also, Chris Toshok did the
tests long ago (he was the person that made me change my original
opinion that our implementation of EncryptPassword is wrong, since it
contradicts the MS.NET docs - he said he tested it when he was
implementing the code and that the tests showed our implementation is
right)

[snip]
&gt;<i> +               internal protected SymmetricAlgorithm Algorithm
</I>&gt;<i> +               {
</I>&gt;<i> 
</I>&gt;<i>         I don't think this is part of the public API so it should be
</I>it's not need - please read the other mail I sent to the list regarding
the issue.

&gt;<i>         private or internal (if reused outside this class). Also the
</I>&gt;<i>         { should be on the same line as the declaration for
</I>&gt;<i> properties.
</I>sorry for the formatting, my emacs style isn't adjusted to the hanging
braces after the properties.

[snip]
[snip]
&gt;<i> +               byte [] EncryptDecryptPassword (byte [] data,
</I>&gt;<i> ICryptoTransform transform)
</I>&gt;<i> +               {
</I>&gt;<i> +                       MemoryStream ms = new MemoryStream ();
</I>&gt;<i> +                       CryptoStream cs = new CryptoStream (ms,
</I>&gt;<i> transform, CryptoStreamMode.Write);
</I>&gt;<i> +                       cs.Write (data, 0, data.Length);
</I>&gt;<i> +                       cs.FlushFinalBlock ();
</I>&gt;<i> +
</I>&gt;<i> +                       byte [] ret = ms.ToArray ();
</I>&gt;<i> +                       cs.Close ();
</I>&gt;<i> +                       return ret;
</I>&gt;<i> +               }
</I>&gt;<i> 
</I>&gt;<i>         If you use streams you should dispose them (better yet use
</I>&gt;<i>         &quot;using&quot; when creating them). This is important for ASP.NET
</I>&gt;<i> code as you can't know how many simultaneous instance could be
</I>&gt;<i>         created (and how long the could be retained in memory).
</I>ok

[snip]
&gt;<i> -                                       return rv;
</I>&gt;<i> +                                       byte [] buf =
</I>&gt;<i> EncryptDecryptPassword (password, decryptor);
</I>&gt;<i> +                                       return buf;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         Please call Array.Clear on arrays that contains &quot;secret&quot; data.
</I>ok.

Please review the attached diff with the changes.

best regards,

marek
-------------- next part --------------
A non-text attachment was scrubbed...
Name: MembershipEncryption.diff
Type: text/x-patch
Size: 4890 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061121/df79952d/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061121/df79952d/attachment.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061121/df79952d/attachment-0001.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20061121/df79952d/attachment-0001.bin</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021467.html">[Mono-dev] [PATCH] Fix for Membership.{Encrypt, Decrypt}Password
</A></li>
	<LI>Next message: <A HREF="021468.html">[Mono-dev] System.IO.Ports Write() bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21469">[ date ]</a>
              <a href="thread.html#21469">[ thread ]</a>
              <a href="subject.html#21469">[ subject ]</a>
              <a href="author.html#21469">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
