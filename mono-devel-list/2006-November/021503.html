<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] String class speed improvements
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20String%20class%20speed%20improvements&In-Reply-To=873.1676-12524-213454305-1164237020%40seznam.cz">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021497.html">
   <LINK REL="Next"  HREF="021480.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] String class speed improvements</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20String%20class%20speed%20improvements&In-Reply-To=873.1676-12524-213454305-1164237020%40seznam.cz"
       TITLE="[Mono-dev] String class speed improvements">lupus at ximian.com
       </A><BR>
    <I>Thu Nov 23 05:06:48 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="021497.html">[Mono-dev] String class speed improvements
</A></li>
        <LI>Next message: <A HREF="021480.html">[Mono-dev] DateTime.Now performance improvement.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21503">[ date ]</a>
              <a href="thread.html#21503">[ thread ]</a>
              <a href="subject.html#21503">[ subject ]</a>
              <a href="author.html#21503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/23/06 marek safar wrote:
&gt;<i> &gt; &gt; +						// We have always at least 2 characters
</I>&gt;<i> &gt; &gt; +						if (*s1_ptr == *any_ptr || *s1_ptr == any_ptr[1])
</I>&gt;<i> &gt; &gt; +							return i;
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +						int ii = anyOfLength;
</I>&gt;<i> &gt; &gt; +						while (ii &gt; 2) {
</I>&gt;<i> &gt; &gt; +							if (*s1_ptr == any_ptr[ii] || *s1_ptr == any_ptr[ii - 1])
</I>&gt;<i> &gt; &gt; +								return i;
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +							ii -= 2;
</I>&gt;<i> &gt; &gt; +						}
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +						if (ii &gt; 1 &amp;&amp; *s1_ptr == any_ptr[2])
</I>&gt;<i> &gt; &gt; +							return i;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Did you experiment also with a simple loop here (using the usual end
</I>&gt;<i> &gt; pointer as well instead of ii)? It should be a good balance between
</I>&gt;<i> &gt; the speed with small and big anyof arrays.
</I>&gt;<i> 
</I>&gt;<i> Yes, I did and for was usually slower. IIRC was definitely slower with mono JIT.
</I>
If you coded it like the rest of the method with the additional index
var I can believe it. What about the optimized code I suggested?
Something like:
	char *anyc = any_ptr;
	do {
		if (*s1_ptr == *anyc)
			return i;
		anyc++;
	while (anyc &lt; anyc_endp);

&gt;<i> &gt; &gt; +					if (s1_ptr[6] == value)
</I>&gt;<i> &gt; &gt; +						return startIndex + 6;
</I>&gt;<i> &gt; &gt; +					if (s1_ptr[7] == value)
</I>&gt;<i> &gt; &gt; +						return startIndex + 7;
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +					s1_ptr += 8;
</I>&gt;<i> &gt; &gt; +					startIndex += 8;
</I>&gt;<i> &gt; &gt; +					count -= 8;
</I>&gt;<i> &gt; &gt; +				}
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Use an end pointer here, too and you can drop one hot var.
</I>&gt;<i> 
</I>&gt;<i> I tried this but it is definitely slower on x86. If I replace
</I>&gt;<i> 
</I>&gt;<i> if (s1_ptr[1] == value)
</I>&gt;<i> 
</I>&gt;<i> with
</I>&gt;<i> 
</I>&gt;<i> if (*++s1_ptr == value)
</I>
This is obviously not what I suggested. See the GetHashCode I mentioned.
The code would look like:

	while (s1_ptr &lt; endp) {
		if (s1_ptr [0] == value)
			return s1_ptr - start;
		if (s1_ptr [1] == value)
			return s1_ptr - start + 1;
		if (s1_ptr [2] == value)
			return s1_ptr - start + 2;
		...
		s1_ptr += 8;
	}
As you see there is one less hot variable that needs to be accessed in
the loop and one is only read and never written to (endp as opposed to
count in your code). There can be oly an issue if the jit thinks start
should go into a register, but in that case the code would not be worse
in any case: we'd still avoid two adds per loop.

&gt;<i> &gt; &gt; +				if (count &gt;= 2) {
</I>&gt;<i> &gt; &gt; +					if (*s1_ptr == value)
</I>&gt;<i> &gt; &gt; +						return startIndex;
</I>&gt;<i> &gt; &gt; +					if (s1_ptr[1] == value)
</I>&gt;<i> &gt; &gt; +						return startIndex + 1;
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +					s1_ptr += 2;
</I>&gt;<i> &gt; &gt; +					startIndex += 2;
</I>&gt;<i> &gt; &gt; +					count -= 2;
</I>&gt;<i> &gt; &gt; +				}
</I>&gt;<i> &gt; &gt; +
</I>&gt;<i> &gt; &gt; +				return count != 0 &amp;&amp; *s1_ptr == value ? startIndex : -1;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; A simple loop for the last 3 chars would likely be better here.
</I>&gt;<i> &gt; Also check if unrolling 8 times really has big perf differences:
</I>&gt;<i> &gt; if we could unroll just four times it would be better for smaller
</I>&gt;<i> &gt; strings.
</I>&gt;<i> 
</I>&gt;<i> Unrolling is always faster when I remove 8 times unrolling I lose
</I>&gt;<i> 10-15%.
</I>
Do it with the optimized code and also with a test bench that doesn't
only exercise the path where big unrolling is faster.

Thanks.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021497.html">[Mono-dev] String class speed improvements
</A></li>
	<LI>Next message: <A HREF="021480.html">[Mono-dev] DateTime.Now performance improvement.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21503">[ date ]</a>
              <a href="thread.html#21503">[ thread ]</a>
              <a href="subject.html#21503">[ subject ]</a>
              <a href="author.html#21503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
