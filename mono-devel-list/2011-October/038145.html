<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] DateTime.Now gives a wrong time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DateTime.Now%20gives%20a%20wrong%20time&In-Reply-To=1510860.PSk2uCM5kr%40klaptop">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="038144.html">
   <LINK REL="Next"  HREF="038146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] DateTime.Now gives a wrong time</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DateTime.Now%20gives%20a%20wrong%20time&In-Reply-To=1510860.PSk2uCM5kr%40klaptop"
       TITLE="[Mono-dev] DateTime.Now gives a wrong time">robertj at gmx.net
       </A><BR>
    <I>Wed Oct 12 16:58:49 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="038144.html">[Mono-dev] DateTime.Now gives a wrong time
</A></li>
        <LI>Next message: <A HREF="038146.html">[Mono-dev] WsSecurity Support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38145">[ date ]</a>
              <a href="thread.html#38145">[ thread ]</a>
              <a href="subject.html#38145">[ subject ]</a>
              <a href="author.html#38145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12.10.2011 22:05, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">k0l0b0k.void at gmail.com</A> wrote:
&gt;<i> Hello guys, thanks for your replies. I think, I've understand the situation.
</I>&gt;<i> Some weeks ago, Ukraine and Belarus has timezone changes by law, and now we
</I>&gt;<i> are FET timezone (GMT+3, without DST). As Robert pointed, I've look into
</I>&gt;<i> TimeZone.* methods, and their native implementations, and found, that wrong
</I>&gt;<i> GMT offset brings by glibc's mktime function. But, it is not mktime bug
</I>&gt;<i> (however, I'm not sure), it is mono issue - code from icall.c:5931:
</I>&gt;<i>
</I>&gt;<i>      memset (&amp;start, 0, sizeof (start));
</I>&gt;<i>
</I>&gt;<i>      start.tm_mday = 1;
</I>&gt;<i>      start.tm_year = year-1900;
</I>&gt;<i>
</I>&gt;<i>      t = mktime (&amp;start);
</I>&gt;<i>
</I>&gt;<i> I've found, that setting only tm_year in start struct is insufficiently. At
</I>&gt;<i> least tm_mon must be set too, to avoid this issue. Simple test:
</I>&gt;<i>
</I>&gt;<i> #include&lt;stdio.h&gt;
</I>&gt;<i> #include&lt;time.h&gt;
</I>&gt;<i> #include&lt;memory.h&gt;
</I>&gt;<i>
</I>&gt;<i> int main(int argc, char *argv[])
</I>&gt;<i> {
</I>&gt;<i>      struct tm t;
</I>&gt;<i>      memset(&amp;t, 0, sizeof(t));
</I>&gt;<i>      t.tm_year = 111; // 2011
</I>&gt;<i>      t.tm_mon = 10;   // wrong tm_gmtoff will received if comment out this line
</I>
tm_mon = 0 means January 1st 2011. Back then, the offset was GMT+2,
Eastern Europe Time, so the call is correct.

The problem is not tm_mon = 0, because Mono does it on purpose
to get the first day of the year:

<A HREF="https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6013">https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6013</A>

Then it starts looping to find out when the GMT offset is changing:

<A HREF="https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6038">https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6038</A>

This probably happened at some date in March:

<A HREF="https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6063">https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6063</A>

Then it loops further to find out when the GMT offset changes again.
But this second change is never happening, because FET remains
forever at GTM+3 =&gt; Mono thinks it's still on DST for the rest of
the year.


I believe the fix is to remove the if-statement at

<A HREF="https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6076">https://github.com/mono/mono/blob/master/mono/metadata/icall.c#L6076</A>

because the code inside the if-statement must be executed
regardless of is_daylight's value.

Robert

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="038144.html">[Mono-dev] DateTime.Now gives a wrong time
</A></li>
	<LI>Next message: <A HREF="038146.html">[Mono-dev] WsSecurity Support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38145">[ date ]</a>
              <a href="thread.html#38145">[ thread ]</a>
              <a href="subject.html#38145">[ subject ]</a>
              <a href="author.html#38145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
