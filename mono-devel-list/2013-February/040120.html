<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Dictionary implementation + concurrency
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Dictionary%20implementation%20%2B%20concurrency&In-Reply-To=%3CCAC9RQtgNUzjk_F4%2B6ickmCLJUg0xJLPEpKvO%2BZyA6da735gAwA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040136.html">
   <LINK REL="Next"  HREF="040126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Dictionary implementation + concurrency</H1>
    <B>Greg Young</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Dictionary%20implementation%20%2B%20concurrency&In-Reply-To=%3CCAC9RQtgNUzjk_F4%2B6ickmCLJUg0xJLPEpKvO%2BZyA6da735gAwA%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Dictionary implementation + concurrency">gregoryyoung1 at gmail.com
       </A><BR>
    <I>Sun Feb  3 19:15:50 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040136.html">[Mono-dev] ARM/NativeClient port
</A></li>
        <LI>Next message: <A HREF="040126.html">[Mono-dev] Dictionary implementation + concurrency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40120">[ date ]</a>
              <a href="thread.html#40120">[ thread ]</a>
              <a href="subject.html#40120">[ subject ]</a>
              <a href="author.html#40120">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The .NET dictionary implementation is thread safe on reads/updates so
long as the internal collection does not grow and size is of reference
type or smaller. eg: if you set size to 1m items and had 100k with a
fill factor that did not cause an internal growth it would be
threadsafe. This assurance has been brought over from Hashtable (well
documented) and is relatively not well documented but many take a
dependency on it. The current mono implementation does not meet this
assurance.

			int cur = table [(hashCode &amp; int.MaxValue) % table.Length] - 1;

			// walk linked list until right slot is found or end is reached
			while (cur != NO_SLOT) {
				// The ordering is important for compatibility with MS and strange
				// Object.Equals () implementations
				if (linkSlots [cur].HashCode == hashCode &amp;&amp; hcp.Equals (keySlots
[cur], key)) {
					value = valueSlots [cur];
					return true;
				}
				cur = linkSlots [cur].Next;
			}

seems fine when accessing. However when adding...

			// find an empty slot
			cur = emptySlot;
			if (cur == NO_SLOT)
				cur = touchedSlots++;
			else
				emptySlot = linkSlots [cur].Next;

			// store the hash code of the added item,
			// prepend the added item to its linked list,
			// update the hash table
			linkSlots [cur].HashCode = hashCode;
			linkSlots [cur].Next = table [index] - 1;
			table [index] = cur + 1;

			// store item's data
			keySlots [cur] = key;
			valueSlots [cur] = value;

Can cause null reads of a key as its in linkSlots but the value slot
has not yet been updated. Setting keySlots after valueSlots would seem
to solve this. Pull request wanted?

Cheers,

Greg

-- 
Le doute n'est pas une condition agr&#233;able, mais la certitude est absurde.
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040136.html">[Mono-dev] ARM/NativeClient port
</A></li>
	<LI>Next message: <A HREF="040126.html">[Mono-dev] Dictionary implementation + concurrency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40120">[ date ]</a>
              <a href="thread.html#40120">[ thread ]</a>
              <a href="subject.html#40120">[ subject ]</a>
              <a href="author.html#40120">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
