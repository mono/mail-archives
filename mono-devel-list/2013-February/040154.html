<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Bug%20in%20mono%203.0.1%20MVC3%20File/FileResult&In-Reply-To=%3CCAB1r_%2BXxpmXv0zmEA54kb3YiFP7SRt0b1-WAjD%3DWpA8aSxc_Nw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="040150.html">
   <LINK REL="Next"  HREF="040155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult</H1>
    <B>Daniel Lo Nigro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Bug%20in%20mono%203.0.1%20MVC3%20File/FileResult&In-Reply-To=%3CCAB1r_%2BXxpmXv0zmEA54kb3YiFP7SRt0b1-WAjD%3DWpA8aSxc_Nw%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult">lists at dan.cx
       </A><BR>
    <I>Fri Feb  8 12:15:35 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="040150.html">[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult
</A></li>
        <LI>Next message: <A HREF="040155.html">[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40154">[ date ]</a>
              <a href="thread.html#40154">[ thread ]</a>
              <a href="subject.html#40154">[ subject ]</a>
              <a href="author.html#40154">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The HttpResponse implementation in Mono is located here:
<A HREF="https://github.com/mono/mono/blob/master/mcs/class/System.Web/System.Web/HttpResponse.cs">https://github.com/mono/mono/blob/master/mcs/class/System.Web/System.Web/HttpResponse.cs</A>

I noticed this piece of code:

if (worker_request != null)
	use_chunked = (worker_request.GetHttpVersion () == &quot;HTTP/1.1&quot;);


Which HttpResponseStream&lt;<A HREF="https://github.com/mono/mono/blob/master/mcs/class/System.Web/System.Web/HttpResponseStream.cs">https://github.com/mono/mono/blob/master/mcs/class/System.Web/System.Web/HttpResponseStream.cs</A>&gt;uses
to determine whether to chunk the response. Maybe you could try
hard-coding that variable to false and see if that fixes your problem?

If so, the fix is probably to disable response chunking when FastCGI is
being used (not just when the protocol is not HTTP/1.1).


On Fri, Feb 8, 2013 at 2:31 AM, SirNoSkill &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">quandary82 at hailmail.net</A>&gt; wrote:

&gt;<i> **
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I've forwarded the error to the nginx mailing list.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://forum.nginx.org/read.php?2,235985,235988#msg-235988">http://forum.nginx.org/read.php?2,235985,235988#msg-235988</A>
</I>&gt;<i>
</I>&gt;<i> The response I got:
</I>&gt;<i> It's bad idea to use &quot;Transfer-Encoding&quot; while working via CGI and
</I>&gt;<i> derived protocols like FastCGI. Quote from RFC 3875,
</I>&gt;<i> <A HREF="http://tools.ietf.org/html/rfc3875#section-6.3.4:">http://tools.ietf.org/html/rfc3875#section-6.3.4:</A>
</I>&gt;<i>
</I>&gt;<i> The script MUST NOT return any header fields that relate to
</I>&gt;<i> client-side communication issues and could affect the server's
</I>&gt;<i> ability to send the response to the client.
</I>&gt;<i>
</I>&gt;<i> As you are talking to nginx via FastCGI, not HTTP, it won't try to
</I>&gt;<i> dig into content returned and decode it according to any
</I>&gt;<i> Transfer-Encoding. Instead, the &quot;Transfer-Encoding&quot; header
</I>&gt;<i> returned will be just dropped by nginx as per RFC 3875.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, Feb 2, 2013, at 09:00 PM, SirNoSkill wrote:
</I>&gt;<i>
</I>&gt;<i> I have more details on the bug.
</I>&gt;<i> The extra bytes that are at the beginning
</I>&gt;<i>
</I>&gt;<i> 31 39 36 62 36 38 0D 0A
</I>&gt;<i>
</I>&gt;<i> which reads 196b68/r/n in ASCII
</I>&gt;<i> 196b68 is the filesize of the original image in hex...
</I>&gt;<i>
</I>&gt;<i> All details + hexdump links added here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/14662795/why-do-i-have-unwanted-extra-bytes-at-the-beginning-of-image">http://stackoverflow.com/questions/14662795/why-do-i-have-unwanted-extra-bytes-at-the-beginning-of-image</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All traffic to that URL [www.daniel-steiger.ch] (except for the folders
</I>&gt;<i> /doc and /images), but including images in /Content, is directly forwarded
</I>&gt;<i> to fastcgi by nginx, as per fastcgi config file for domain.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  server {
</I>&gt;<i>          listen   80;
</I>&gt;<i>          server_name www.daniel-steiger.ch daniel-steiger.ch;
</I>&gt;<i>          access_log   /var/log/nginx/daniel-steiger.ch.access.log;
</I>&gt;<i>
</I>&gt;<i>          location / {
</I>&gt;<i>                  root /home/danillo/www/HomePage;
</I>&gt;<i>                  #index index.html index.htm default.aspx Default.aspx;
</I>&gt;<i>                  #fastcgi_index Default.aspx;
</I>&gt;<i>                  fastcgi_pass 127.0.0.1:9000;
</I>&gt;<i>                  include /etc/nginx/fastcgi_params;
</I>&gt;<i>          }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> location /doc {
</I>&gt;<i> root /usr/share;
</I>&gt;<i> autoindex on;
</I>&gt;<i> allow 127.0.0.1;
</I>&gt;<i> deny all;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> location /images {
</I>&gt;<i> root /usr/share;
</I>&gt;<i> autoindex off;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> #error_page 404 /404.html;
</I>&gt;<i>
</I>&gt;<i> # redirect server error pages to the static page /50x.html
</I>&gt;<i> #
</I>&gt;<i> error_page 500 501 503 504 /50x.html;
</I>&gt;<i> location = /50x.html {
</I>&gt;<i> root /home/danillo/www/HomePage;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> error_page 502 /502.html;
</I>&gt;<i> location = /502.html {
</I>&gt;<i> root /home/danillo/www/HomePage;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It's sufficient to have the file served without FileResult.
</I>&gt;<i> Of course it's more efficient if nginx serves it directly, but this is a
</I>&gt;<i> very low traffic website, so performance is really not my problem ;)
</I>&gt;<i>
</I>&gt;<i> And by the way, the problem is not finding a workaround.
</I>&gt;<i>  I have already fixed it with a workaround about a week ago.
</I>&gt;<i> I really just want to know where the bug is, because if FileResult
</I>&gt;<i> malfunctions, there's probably more to it, and I don't want to walk into a
</I>&gt;<i> subtle not at the first sight spottable bug later, like a botched binary
</I>&gt;<i> upload/download file.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sat, Feb 2, 2013, at 06:51 AM, Daniel Lo Nigro wrote:
</I>&gt;<i>
</I>&gt;<i> Hmm... Maybe try an X-Accel-Redirect header instead. This lets Nginx serve
</I>&gt;<i> the file instead of Mono having to serve it, which makes it more efficient.
</I>&gt;<i> See if that makes a difference, or if it has the same issue.
</I>&gt;<i>
</I>&gt;<i> Why not just link directly to the file, instead of serving it through your
</I>&gt;<i> C# code?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Sun, Feb 3, 2013 at 1:43 AM, quandary82 &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">quandary82 at hailmail.net</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Corrected the mime, but seems to be a mono-bug (or fastcgi) anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  More here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://stackoverflow.com/questions/14662795/why-do-i-have-unwanted-extra-bytes-at-the-beginning-of-image">http://stackoverflow.com/questions/14662795/why-do-i-have-unwanted-extra-bytes-at-the-beginning-of-image</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  --
</I>&gt;&gt;<i>  View this message in context:
</I>&gt;&gt;<i> <A HREF="http://mono.1490590.n4.nabble.com/Bug-in-mono-3-0-1-MVC3-File-FileResult-tp4658382p4658422.html">http://mono.1490590.n4.nabble.com/Bug-in-mono-3-0-1-MVC3-File-FileResult-tp4658382p4658422.html</A>
</I>&gt;&gt;<i>  Sent from the Mono - Dev mailing list archive at Nabble.com.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i>  Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>  SirNoSkill
</I>&gt;<i>  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">quandary82 at hailmail.net</A>
</I>&gt;<i>
</I>&gt;<i> -- <A HREF="http://www.fastmail.fm">http://www.fastmail.fm</A> - mmm... Fastmail...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>  SirNoSkill
</I>&gt;<i>  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">quandary82 at hailmail.net</A>
</I>&gt;<i>
</I>&gt;<i> -- <A HREF="http://www.fastmail.fm">http://www.fastmail.fm</A> - IMAP accessible web-mail
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130208/24317403/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20130208/24317403/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="040150.html">[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult
</A></li>
	<LI>Next message: <A HREF="040155.html">[Mono-dev] Bug in mono 3.0.1 MVC3 File/FileResult
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40154">[ date ]</a>
              <a href="thread.html#40154">[ thread ]</a>
              <a href="subject.html#40154">[ subject ]</a>
              <a href="author.html#40154">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
