<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] WCF multithreaded and property handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20WCF%20multithreaded%20and%20property%20handling&In-Reply-To=F58CD3BF9A7E564C927975D9BF8486730C7501%40sbs.ShoutTelecoms.local">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034703.html">
   <LINK REL="Next"  HREF="034704.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] WCF multithreaded and property handling</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20WCF%20multithreaded%20and%20property%20handling&In-Reply-To=F58CD3BF9A7E564C927975D9BF8486730C7501%40sbs.ShoutTelecoms.local"
       TITLE="[Mono-dev] [PATCH] WCF multithreaded and property handling">atsushieno at veritas-vos-liberabit.com
       </A><BR>
    <I>Sun Apr 18 23:52:47 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034703.html">[Mono-dev] [PATCH] WCF multithreaded and property handling
</A></li>
        <LI>Next message: <A HREF="034704.html">[Mono-dev] BindingList nor BindingSource attach to	INotifyPropertyChanged-based child properties' PropertyChanged event
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34794">[ date ]</a>
              <a href="thread.html#34794">[ thread ]</a>
              <a href="subject.html#34794">[ subject ]</a>
              <a href="author.html#34794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, sorry for the late reply, I'm back here again.

Thanks, I'm going to apply your patch with a little change. This method 
should not return true if the channel has received null HTTP context, 
while WaitOne() just returns true unless it goes timeout.

As for properties patch, I already made a relevant fix (I think I 
mentioned it in my previous posts) which fixed the issue you fixed in 
your own patch, and I didn't find it worthy enough to make an extra change.

Atsushi Eno


On 2010/04/08 18:35, Matt Dargavel wrote:
&gt;<i> Hi again,
</I>&gt;<i>
</I>&gt;<i> 	I'm just going through my outstanding local changes against the
</I>&gt;<i> latest CVS.  Did you have chance to revisit the AutoResetEvent issue as
</I>&gt;<i> mentioned below?  I've attached a new patch against the latest revision
</I>&gt;<i> to show the changes.
</I>&gt;<i>
</I>&gt;<i> 	Also, I don't think the properties patch (my version or your
</I>&gt;<i> version) got applied in the end?  I saw it got rolled back due to a
</I>&gt;<i> regression.  If you could point me in the right direction I'd be happy
</I>&gt;<i> to look in to this in a bit more.
</I>&gt;<i>
</I>&gt;<i> 		Regards,
</I>&gt;<i>
</I>&gt;<i> 			Matt.
</I>&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Matt Dargavel
</I>&gt;&gt;<i> Sent: 24 March 2010 12:29 PM
</I>&gt;&gt;<i> To: 'Atsushi Eno'
</I>&gt;&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> Subject: RE: [PATCH] WCF multithreaded and property handling
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem I was trying to fix was that it's possible for wait to be
</I>&gt;<i> set
</I>&gt;&gt;<i> to null after:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if (wait != null)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> and before:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> wait.WaitOne(...)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> causing a null reference exception.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Looking at MSDN it sounds like an AutoResetEvent should remain
</I>&gt;<i> signalled
</I>&gt;&gt;<i> until a thread calls WaitOne?  The problem is if another thread sets
</I>&gt;<i> the
</I>&gt;&gt;<i> event when it is already set.  If this happens the second Set has no
</I>&gt;&gt;<i> effect.  I don't think that's an issue here as the only place that
</I>&gt;<i> sets the
</I>&gt;&gt;<i> event is the result of the operation we're starting?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You're right that the waiting.Count&gt;  0 check should have stayed in
</I>&gt;<i> there.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My thanks to you for all the work you've put in to WCF- in case you're
</I>&gt;&gt;<i> interested in how it's being used we're embedding a WCF web service in
</I>&gt;<i> to
</I>&gt;&gt;<i> one of our core products (a SIP Switch) and then providing a set of
</I>&gt;<i> web
</I>&gt;&gt;<i> pages that allow users to manage it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 	Matt.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: Atsushi Eno [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushieno at veritas-vos-liberabit.com</A>]
</I>&gt;&gt;&gt;<i> Sent: 24 March 2010 10:58 AM
</I>&gt;&gt;&gt;<i> To: Matt Dargavel
</I>&gt;&gt;&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [PATCH] WCF multithreaded and property handling
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After examining the patch, I have applied some parts of your patch.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -                wait = new AutoResetEvent (false);
</I>&gt;&gt;&gt;<i> -                source.ListenerManager.GetHttpContextAsync
</I>&gt;<i> (timeout,
</I>&gt;&gt;&gt;<i> HttpContextAcquired);
</I>&gt;&gt;&gt;<i> -                if (wait != null) // in case callback is done
</I>&gt;<i> before
</I>&gt;&gt;&gt;<i> WaitOne() here.
</I>&gt;&gt;&gt;<i> -                    return wait.WaitOne (timeout, false);
</I>&gt;&gt;&gt;<i> -                return waiting.Count&gt;  0;
</I>&gt;&gt;&gt;<i> +                    var wait_ = new AutoResetEvent (false);
</I>&gt;&gt;&gt;<i> +                    wait = wait_;    // wait can be set to null if
</I>&gt;&gt;&gt;<i> HttpContextAcquired runs to completion before we do WaitOne
</I>&gt;&gt;&gt;<i> +                    source.ListenerManager.GetHttpContextAsync
</I>&gt;&gt;&gt;<i> (timeout, HttpContextAcquired);
</I>&gt;&gt;&gt;<i> +                    var result = wait_.WaitOne (timeout, false);
</I>&gt;&gt;&gt;<i> +                    return result;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This change is wrong. Since it is AutoResetEvent, it must not call
</I>&gt;&gt;&gt;<i> WaitOne() if it has already finished (SignalAsyncWait). And It it
</I>&gt;<i> set to
</I>&gt;&gt;&gt;<i> null when SignalAsyncWait() is done. Also, it should not depend on
</I>&gt;&gt;&gt;<i> specific GetHttpContextAsync() call result, as another async call
</I>&gt;<i> may
</I>&gt;&gt;&gt;<i> receive a context (hence waiting.Count&gt;  0).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think I have answered to all non-committed parts of your patch,
</I>&gt;<i> but
</I>&gt;&gt;&gt;<i> further comments are welcome. Thanks again for the patch. You're
</I>&gt;<i> hero,
</I>&gt;&gt;&gt;<i> few people dig in such depth into the WCF
</I>&gt;&gt;&gt;<i> core engine :)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Atsushi Eno
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 2010/03/23 22:33, Matt Dargavel wrote:
</I>&gt;&gt;&gt;&gt;<i> Ok, no problem.  I can break them down more.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> You're right, I can provide no guarantees about the Thread.Sleep
</I>&gt;&gt;&gt;&gt;<i> removal!  But it could have been related to locking
</I>&gt;<i> registered_channels
</I>&gt;&gt;&gt;&gt;<i> instead of pending?  I did quite a bit of multithreaded testing,
</I>&gt;<i> and
</I>&gt;&gt;&gt;&gt;<i> there were no problems; but I take your point.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I implemented new functions rather than overriding Properties for
</I>&gt;<i> a few
</I>&gt;&gt;&gt;&gt;<i> reasons.  I wanted to be sure that I found everywhere that used
</I>&gt;<i> the
</I>&gt;&gt;&gt;&gt;<i> properties mechanism to check there were no unwanted side effects,
</I>&gt;<i> and
</I>&gt;&gt;&gt;&gt;<i> to make it more obvious something a little special was going on.
</I>&gt;<i> Also
</I>&gt;&gt;<i> I
</I>&gt;&gt;&gt;&gt;<i> thought that using a function hides the implementation from other
</I>&gt;&gt;&gt;&gt;<i> classes.  For example, the .NET documentation states that
</I>&gt;&gt;&gt;&gt;<i> ChannelListenerBase should search for the property and then
</I>&gt;<i> delegate
</I>&gt;&gt;&gt;&gt;<i> down the stack if it can't find it, so I could see a scenario
</I>&gt;<i> where
</I>&gt;&gt;<i> only
</I>&gt;&gt;&gt;&gt;<i> certain properties were passed to / from inner channels.  But I
</I>&gt;<i> guess
</I>&gt;&gt;&gt;&gt;<i> that's refactoring and personal preference rather than a minimum
</I>&gt;<i> change
</I>&gt;&gt;&gt;&gt;<i> fix. :-)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I can delve in to the test code and come up with some test cases
</I>&gt;<i> for
</I>&gt;&gt;<i> the
</I>&gt;&gt;&gt;&gt;<i> properties fix, but unfortunately I think it'll be impossible to
</I>&gt;<i> write
</I>&gt;&gt;&gt;&gt;<i> test cases for the multithreading issues.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 	Cheers,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 		Matt.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;&gt;&gt;<i> From: Atsushi Eno [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushieno at veritas-vos-liberabit.com</A>]
</I>&gt;&gt;&gt;&gt;&gt;<i> Sent: 23 March 2010 12:50 PM
</I>&gt;&gt;&gt;&gt;&gt;<i> To: Matt Dargavel
</I>&gt;&gt;&gt;&gt;&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> Subject: Re: [PATCH] WCF multithreaded and property handling
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Thanks for the patch. They are looking like a great set of
</I>&gt;<i> attempts
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> for
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> cool bugfixes :) However there is a lot of other changes that
</I>&gt;<i> your
</I>&gt;&gt;&gt;&gt;&gt;<i> description cannot explain. So, please first split the changes
</I>&gt;<i> into
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> further
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> smaller patches for each purpose, and give explanation for each
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> change. For
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> example,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> - // FIXME: this should not be required, but it somehow saves
</I>&gt;<i> some
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> failures
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> wrt concurrent calls.
</I>&gt;&gt;&gt;&gt;&gt;<i> - Thread.Sleep (100);
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> This kind of change should not be made without explanation. (you
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> aren't
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> really sure about why it exists, right?)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> As for ChannelListenerBase.Properties, I'd rather make the
</I>&gt;<i> changes
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> much
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> smaller like the attached change. Isn't it enough? There's no
</I>&gt;<i> test
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> case
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> that I can verify your (and-my) changes.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Atsushi Eno
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 2010/03/23 20:28, Matt Dargavel wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The included patches fix the following:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> multithreaded_fixes.patch: ObjectDisposedException,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> InvalidOperationException(&quot;Another async TryReceiveRequest
</I>&gt;<i> operation
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> is in progress&quot;) and other multithreaded timing fixes. Also
</I>&gt;<i> includes
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> change to make GET ?wsdl case insensitive.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> properties_handling.patch: MetadataPublishingInfo not available
</I>&gt;<i> in
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> TransactionChannelListener's inner_listener. I created a new
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> RetrieveProperty function as overriding GetProperty&lt;T&gt;   didn't
</I>&gt;<i> work-
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> the ChannelListenerBase implementation was still called. Perhaps
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> there's a bug with generic function overrides or maybe I've done
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> something silly there?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> properties_and_wsdl.patch: patch for ServiceMetadataExtension.cs
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> that
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> goes with the properties changes and the ?wsdl change.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Let me know if you have any questions. :-)
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Matt.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034703.html">[Mono-dev] [PATCH] WCF multithreaded and property handling
</A></li>
	<LI>Next message: <A HREF="034704.html">[Mono-dev] BindingList nor BindingSource attach to	INotifyPropertyChanged-based child properties' PropertyChanged event
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34794">[ date ]</a>
              <a href="thread.html#34794">[ thread ]</a>
              <a href="subject.html#34794">[ subject ]</a>
              <a href="author.html#34794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
