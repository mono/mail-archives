<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Implement OpenBSD specific sysctl in EnumProcesses()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Implement%20OpenBSD%20specific%20sysctl%20in%20EnumProcesses%28%29&In-Reply-To=20100402231130.GA27073%40bsd.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034605.html">
   <LINK REL="Next"  HREF="034606.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Implement OpenBSD specific sysctl in EnumProcesses()</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Implement%20OpenBSD%20specific%20sysctl%20in%20EnumProcesses%28%29&In-Reply-To=20100402231130.GA27073%40bsd.hu"
       TITLE="[Mono-dev] Implement OpenBSD specific sysctl in EnumProcesses()">vargaz at gmail.com
       </A><BR>
    <I>Fri Apr  2 20:36:22 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034605.html">[Mono-dev] Implement OpenBSD specific sysctl in EnumProcesses()
</A></li>
        <LI>Next message: <A HREF="034606.html">[Mono-dev] Don't use non-standard /proc dir just to find out if a process is running
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34607">[ date ]</a>
              <a href="thread.html#34607">[ thread ]</a>
              <a href="subject.html#34607">[ subject ]</a>
              <a href="author.html#34607">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

  Applied to SVN HEAD/2.6.

         Zoltan

On Sat, Apr 3, 2010 at 1:11 AM, Robert Nagy &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robert at openbsd.org</A>&gt; wrote:

&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> This diff extends the MACOSX code that uses sysctl
</I>&gt;<i> already, but ours is a wee bit different.
</I>&gt;<i>
</I>&gt;<i> Index: mono/io-layer/processes.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> --- mono/io-layer/processes.c   (revision 154739)
</I>&gt;<i> +++ mono/io-layer/processes.c   (working copy)
</I>&gt;<i> @@ -35,10 +35,12 @@
</I>&gt;<i>  #include &lt;sys/resource.h&gt;
</I>&gt;<i>  #endif
</I>&gt;<i>
</I>&gt;<i> -#ifdef PLATFORM_MACOSX
</I>&gt;<i> +#if defined(PLATFORM_MACOSX) || defined(__OpenBSD__)
</I>&gt;<i>  #include &lt;sys/proc.h&gt;
</I>&gt;<i>  #include &lt;sys/sysctl.h&gt;
</I>&gt;<i> -#include &lt;sys/utsname.h&gt;
</I>&gt;<i> +#  if !defined(__OpenBSD__)
</I>&gt;<i> +#    include &lt;sys/utsname.h&gt;
</I>&gt;<i> +#  endif
</I>&gt;<i>  #endif
</I>&gt;<i>
</I>&gt;<i>  #ifdef PLATFORM_SOLARIS
</I>&gt;<i> @@ -1513,16 +1515,27 @@
</I>&gt;<i>  }
</I>&gt;<i>  #endif /* UNUSED_CODE */
</I>&gt;<i>
</I>&gt;<i> -#ifdef PLATFORM_MACOSX
</I>&gt;<i> +#if defined(PLATFORM_MACOSX) || defined(__OpenBSD__)
</I>&gt;<i>
</I>&gt;<i>  gboolean EnumProcesses (guint32 *pids, guint32 len, guint32 *needed)
</I>&gt;<i>  {
</I>&gt;<i>        guint32 count, fit, i, j;
</I>&gt;<i>        gint32 err;
</I>&gt;<i>        gboolean done;
</I>&gt;<i> +       size_t proclength, size;
</I>&gt;<i> +#if defined(__OpenBSD__)
</I>&gt;<i> +       struct kinfo_proc2 *result;
</I>&gt;<i> +       int name[6];
</I>&gt;<i> +       name[0] = CTL_KERN;
</I>&gt;<i> +       name[1] = KERN_PROC2;
</I>&gt;<i> +       name[2] = KERN_PROC_ALL;
</I>&gt;<i> +       name[3] = 0;
</I>&gt;<i> +       name[4] = sizeof(struct kinfo_proc2);
</I>&gt;<i> +       name[5] = 400; /* XXX */
</I>&gt;<i> +#else
</I>&gt;<i>        struct kinfo_proc *result;
</I>&gt;<i> -       size_t proclength;
</I>&gt;<i>        static const int name[] = { CTL_KERN, KERN_PROC, KERN_PROC_ALL, 0 };
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i>        mono_once (&amp;process_current_once, process_set_current);
</I>&gt;<i>
</I>&gt;<i> @@ -1531,14 +1544,20 @@
</I>&gt;<i>
</I>&gt;<i>        do {
</I>&gt;<i>                proclength = 0;
</I>&gt;<i> -               err = sysctl ((int *)name, (sizeof(name) / sizeof(*name)) -
</I>&gt;<i> 1, NULL, &amp;proclength, NULL, 0);
</I>&gt;<i> +#if defined(__OpenBSD__)
</I>&gt;<i> +               size = (sizeof(name) / sizeof(*name));
</I>&gt;<i> +#else
</I>&gt;<i> +               size = (sizeof(name) / sizeof(*name)) - 1;
</I>&gt;<i> +#endif
</I>&gt;<i> +               err = sysctl ((int *)name, size, NULL, &amp;proclength, NULL,
</I>&gt;<i> 0);
</I>&gt;<i>
</I>&gt;<i>                if (err == 0) {
</I>&gt;<i>                        result = malloc (proclength);
</I>&gt;<i> +
</I>&gt;<i>                        if (result == NULL)
</I>&gt;<i>                                return FALSE;
</I>&gt;<i>
</I>&gt;<i> -                       err = sysctl ((int *) name, (sizeof(name) /
</I>&gt;<i> sizeof(*name)) - 1, result, &amp;proclength, NULL, 0);
</I>&gt;<i> +                       err = sysctl ((int *) name, size, result,
</I>&gt;<i> &amp;proclength, NULL, 0);
</I>&gt;<i>
</I>&gt;<i>                        if (err == 0)
</I>&gt;<i>                                done = TRUE;
</I>&gt;<i> @@ -1554,11 +1573,19 @@
</I>&gt;<i>                }
</I>&gt;<i>                return(FALSE);
</I>&gt;<i>        }
</I>&gt;<i> -
</I>&gt;<i> +
</I>&gt;<i> +#if defined(__OpenBSD__)
</I>&gt;<i> +       count = proclength / sizeof(struct kinfo_proc2);
</I>&gt;<i> +#else
</I>&gt;<i>        count = proclength / sizeof(struct kinfo_proc);
</I>&gt;<i> +#endif
</I>&gt;<i>        fit = len / sizeof(guint32);
</I>&gt;<i>        for (i = 0, j = 0; j&lt; fit &amp;&amp; i &lt; count; i++) {
</I>&gt;<i> +#if defined(__OpenBSD__)
</I>&gt;<i> +               pids [j++] = result [i].p_pid;
</I>&gt;<i> +#else
</I>&gt;<i>                pids [j++] = result [i].kp_proc.p_pid;
</I>&gt;<i> +#endif
</I>&gt;<i>        }
</I>&gt;<i>        free (result);
</I>&gt;<i>        result = NULL;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100403/770d69c7/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100403/770d69c7/attachment.html</A> 
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034605.html">[Mono-dev] Implement OpenBSD specific sysctl in EnumProcesses()
</A></li>
	<LI>Next message: <A HREF="034606.html">[Mono-dev] Don't use non-standard /proc dir just to find out if a process is running
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34607">[ date ]</a>
              <a href="thread.html#34607">[ thread ]</a>
              <a href="subject.html#34607">[ subject ]</a>
              <a href="author.html#34607">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
