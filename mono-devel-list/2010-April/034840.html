<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Make System.IO.Ports work on UNIX systems other than	Linux
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Make%20System.IO.Ports%20work%20on%20UNIX%20systems%20other%20than%0A%09Linux&In-Reply-To=20100422164517.GA3777%40bsd.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034838.html">
   <LINK REL="Next"  HREF="034841.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Make System.IO.Ports work on UNIX systems other than	Linux</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Make%20System.IO.Ports%20work%20on%20UNIX%20systems%20other%20than%0A%09Linux&In-Reply-To=20100422164517.GA3777%40bsd.hu"
       TITLE="[Mono-dev] Make System.IO.Ports work on UNIX systems other than	Linux">andreas.faerber at web.de
       </A><BR>
    <I>Thu Apr 22 13:48:22 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034838.html">[Mono-dev] Make System.IO.Ports work on UNIX systems other than Linux
</A></li>
        <LI>Next message: <A HREF="034841.html">[Mono-dev] Make System.IO.Ports work on UNIX systems other than	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34840">[ date ]</a>
              <a href="thread.html#34840">[ thread ]</a>
              <a href="subject.html#34840">[ subject ]</a>
              <a href="author.html#34840">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Am 22.04.2010 um 18:45 schrieb Robert Nagy:

&gt;<i> Can someone please have a look at this?
</I>&gt;<i>
</I>&gt;<i> On (2010-04-20 23:26), Robert Nagy wrote:
</I>&gt;&gt;<i> The attached diff makes SerialPort.GetPortNames() work on
</I>&gt;&gt;<i> all Unix systems other than Linux too, because ttyS* and
</I>&gt;&gt;<i> ttyUSB* is linux specific and on *BSD the serial ports are
</I>&gt;&gt;<i> tty[0-9]+.
</I>&gt;&gt;<i> (I've tested this code on Linux and it should also support
</I>&gt;&gt;<i> ttySG0 (SGI running Linux (ia64)).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The other way would be to add a different platform id for
</I>&gt;&gt;<i> *BSDs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Comments? (My C# is not good :))
</I>&gt;<i>
</I>&gt;&gt;<i> Index: class/System/System.IO.Ports/SerialPort.cs
</I>&gt;&gt;<i> ===================================================================
</I>&gt;&gt;<i> --- class/System/System.IO.Ports/SerialPort.cs	(revision 155801)
</I>&gt;&gt;<i> +++ class/System/System.IO.Ports/SerialPort.cs	(working copy)
</I>&gt;&gt;<i> @@ -24,6 +24,7 @@
</I>&gt;&gt;<i> using System.ComponentModel;
</I>&gt;&gt;<i> using System.Diagnostics;
</I>&gt;&gt;<i> using System.Text;
</I>&gt;&gt;<i> +using System.Text.RegularExpressions;
</I>&gt;&gt;<i> using System.Runtime.InteropServices;
</I>&gt;&gt;<i> using Microsoft.Win32;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> @@ -525,10 +526,18 @@
</I>&gt;&gt;<i> 			// Are we on Unix?
</I>&gt;&gt;<i> 			if (p == 4 || p == 128 || p == 6) {
</I>&gt;&gt;<i> 				string[] ttys = Directory.GetFiles(&quot;/dev/&quot;, &quot;tty*&quot;);
</I>&gt;&gt;<i> +				Regex lnx = new Regex(@&quot;^\/dev\/tty(S(G)?|USB)[0-9]+$&quot;);
</I>
I'm not a Linux expert, but I think the regex still may be incomplete.  
For instance, I've seen tty0 (virtio), ttyPZ0 (ppc), ttySC0 (sh4 R2D),  
ttyAMA0 (arm RealView) as kernel parameters.

&gt;&gt;<i> +				Regex rem = new Regex(@&quot;^\/dev\/tty(U)?[0-9]+$&quot;);
</I>&gt;&gt;<i> +
</I>&gt;&gt;<i> 				foreach (string dev in ttys) {
</I>&gt;&gt;<i> -					if (dev.StartsWith(&quot;/dev/ttyS&quot;) || dev.StartsWith(&quot;/dev/ 
</I>&gt;&gt;<i> ttyUSB&quot;))
</I>&gt;&gt;<i> -						serial_ports.Add(dev);
</I>&gt;&gt;<i> +					if (lnx.Match(dev).Success)
</I>&gt;&gt;<i> +						rem = lnx;
</I>&gt;&gt;<i> +					serial_ports.Add(dev);
</I>&gt;&gt;<i> 				}
</I>&gt;&gt;<i> +				for (int i = serial_ports.Count - 1; i &gt;= 0; i--) {
</I>&gt;&gt;<i> +					if (!rem.Match(serial_ports[i]).Success)
</I>&gt;&gt;<i> +						serial_ports.RemoveAt(i);
</I>&gt;&gt;<i> +				}
</I>
This seems overly complicated to me. Both the variable naming and  
cross-assignment and the first-add-then-remove approach.

I think we should either try to find one universal regex like /dev/ 
tty[A-Z]*[0-9]+ or initialize the regex based on platform. Either way  
we'd hopefully have one regex we could use to add to the list and  
could drop the second loop.

Platform identification could be done by recognizing a non-Windows  
platform and p/invoking uname.

Andreas

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034838.html">[Mono-dev] Make System.IO.Ports work on UNIX systems other than Linux
</A></li>
	<LI>Next message: <A HREF="034841.html">[Mono-dev] Make System.IO.Ports work on UNIX systems other than	Linux
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34840">[ date ]</a>
              <a href="thread.html#34840">[ thread ]</a>
              <a href="subject.html#34840">[ subject ]</a>
              <a href="author.html#34840">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
