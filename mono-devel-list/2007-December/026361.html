<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Bug in MCS or Mono Runtime 1.2.6
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Bug%20in%20MCS%20or%20Mono%20Runtime%201.2.6&In-Reply-To=75751ca80712271524s5084843bo874dd8785b8cc6ad%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026359.html">
   <LINK REL="Next"  HREF="026355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Bug in MCS or Mono Runtime 1.2.6</H1>
    <B>Bill Holmes</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Bug%20in%20MCS%20or%20Mono%20Runtime%201.2.6&In-Reply-To=75751ca80712271524s5084843bo874dd8785b8cc6ad%40mail.gmail.com"
       TITLE="[Mono-dev] Bug in MCS or Mono Runtime 1.2.6">billholmes54 at gmail.com
       </A><BR>
    <I>Fri Dec 28 16:19:06 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="026359.html">[Mono-dev] Bug in MCS or Mono Runtime 1.2.6
</A></li>
        <LI>Next message: <A HREF="026355.html">[Mono-dev] Mono 1.2.6 VM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26361">[ date ]</a>
              <a href="thread.html#26361">[ thread ]</a>
              <a href="subject.html#26361">[ subject ]</a>
              <a href="author.html#26361">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have been able to reproduce this with the 1.2.6_4 install on
Windows.  I was able to compile the library and exe using csc and it
does run fine on Mono.  Also I have compiled using gmcs and run with
the MS runtime and I get the following exception.

Unhandled Exception: System.InvalidProgramException: Common Language
Runtime detected an invalid program.
   at Sample.MainWindow..ctor()
   at Sample.MainClass.Main(String[] args)

It appears that this is a mcs bug.

After further investigation I have a smaller sample that shows the
bug.  It occurs when you have a unconditional return statement before
a local variable declaration that is assigned inside an anonymous
delegate.  If you move the variable declaration above the return
statement the bug goes away.

I have also verified that this still occurs at the trunk version.
Mono JIT compiler version 1.2.6 (/trunk/ r92000)

I would suggest filing a compiler bug for this.

public class Test
{
    static public void TestFunc ()
    {
        return;

        string testStr;

        System.AppDomain.CurrentDomain.AssemblyLoad += delegate
(object Sender, System.AssemblyLoadEventArgs e)
        {
            testStr = &quot;sss&quot;;
        };
    }

    public static void Main (string[] args)
    {
        TestFunc ();
    }
}


On Dec 27, 2007 6:24 PM, Laurent Debacker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">debackerl at gmail.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm developing a Gtk# application using MonoDevelop Beta 2 and Mono 1.2.6.
</I>&gt;<i> However Mono could not execute the compiled assembly. The error provided is
</I>&gt;<i> the following one:
</I>&gt;<i>
</I>&gt;<i> &gt; Unhandled Exception: System.InvalidProgramException: Invalid IL code in
</I>&gt;<i> Sample.MainWindow:.ctor (): IL_007e: nop
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   at Sample.MainClass.Main (System.String[] args) [0x0000f] in
</I>&gt;<i> /home/gizmo/Sample/Main.cs:12
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I have attached both the generated assembly, and the tarball generated by
</I>&gt;<i> MonoDevelop.
</I>&gt;<i>
</I>&gt;<i> For your conveniance, I have copy-pasted the IL code as dissasembled by
</I>&gt;<i> Reflector of Sample.MainWindow:.ctor () is:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  .method public hidebysig specialname
</I>&gt;<i> rtspecialname instance void
</I>&gt;<i> .ctor() cil managed
</I>&gt;<i> {
</I>&gt;<i>  .maxstack 12
</I>&gt;<i>
</I>&gt;<i> .locals init (
</I>&gt;<i>  [0] class
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated0
</I>&gt;<i>  generated,
</I>&gt;<i>  [1] class [
</I>&gt;<i> gtk-sharp]Gtk.VBox box,
</I>&gt;<i>  [2
</I>&gt;<i> ] class [Ribbons]
</I>&gt;<i> Ribbons.Button button,
</I>&gt;<i>  [3] class [
</I>&gt;<i> gtk-sharp]Gtk.Menu menu,
</I>&gt;<i>  [4
</I>&gt;<i> ] class [
</I>&gt;<i> gtk-sharp]Gtk.MenuItem item,
</I>&gt;<i>  [
</I>&gt;<i> 5] class [
</I>&gt;<i> gtk-sharp]Gtk.MenuItem item2,
</I>&gt;<i>  [
</I>&gt;<i> 6] class [Ribbons]
</I>&gt;<i> Ribbons.Button button2,
</I>&gt;<i>  [7] class [
</I>&gt;<i> Ribbons]Ribbons.Button button3,
</I>&gt;<i>  [8]
</I>&gt;<i> class [gtk-sharp
</I>&gt;<i> ]Gtk.Menu menu2,
</I>&gt;<i>  [9]
</I>&gt;<i> class [gtk-sharp
</I>&gt;<i> ]Gtk.MenuItem item3,
</I>&gt;<i>  [10
</I>&gt;<i> ] class [Ribbons]
</I>&gt;<i> Ribbons.ToolPack pack,
</I>&gt;<i>  [11] class [
</I>&gt;<i> Ribbons]Ribbons.ToolPack pack2,
</I>&gt;<i>  [12
</I>&gt;<i> ] class [Ribbons]
</I>&gt;<i> Ribbons.ToolPack pack3,
</I>&gt;<i>  [13] class [
</I>&gt;<i> gtk-sharp]Gtk.ComboBox box2,
</I>&gt;<i>  [
</I>&gt;<i> 14] class Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated1 generated2,
</I>&gt;<i>  [15] class [
</I>&gt;<i> gtk-sharp]Gtk.HBox box3,
</I>&gt;<i>  [16
</I>&gt;<i> ] class [
</I>&gt;<i> gtk-sharp]Gtk.HBox box4,
</I>&gt;<i>  [17
</I>&gt;<i> ] class [
</I>&gt;<i> gtk-sharp]Gtk.HBox box5,
</I>&gt;<i>  [18
</I>&gt;<i> ] class [Ribbons]
</I>&gt;<i> Ribbons.RibbonGroup group,
</I>&gt;<i>  [19] class [
</I>&gt;<i> gtk-sharp]Gtk.HBox box6,
</I>&gt;<i>  [20
</I>&gt;<i> ] class [
</I>&gt;<i> gtk-sharp]Gtk.Label label,
</I>&gt;<i>  [
</I>&gt;<i> 21] class [
</I>&gt;<i> gtk-sharp]Gtk.Label label2,
</I>&gt;<i>  [
</I>&gt;<i> 22] class [Ribbons]
</I>&gt;<i> Ribbons.Button button4,
</I>&gt;<i>  [23] class
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated4
</I>&gt;<i>  generated3,
</I>&gt;<i>  [24] class [
</I>&gt;<i> gtk-sharp]Gtk.MenuItem item4,
</I>&gt;<i>  [
</I>&gt;<i> 25] class [
</I>&gt;<i> gtk-sharp]Gtk.TextView view)
</I>&gt;<i>  L_0000:
</I>&gt;<i> nop
</I>&gt;<i>  L_0001: ldc.i4 1
</I>&gt;<i>  L_0006:
</I>&gt;<i> pop
</I>&gt;<i>  L_0007: nop
</I>&gt;<i>  L_0008:
</I>&gt;<i> newobj instance void
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated0
</I>&gt;<i> ::.ctor()
</I>&gt;<i>  L_000d:
</I>&gt;<i> stloc.0
</I>&gt;<i>  L_000e: ldarg.0
</I>&gt;<i>  L_000f:
</I>&gt;<i> ldc.i4.0
</I>&gt;<i>  L_0010: call instance
</I>&gt;<i> void [Ribbons]
</I>&gt;<i> Ribbons.SyntheticWindow::.ctor(valuetype
</I>&gt;<i>  [gtk-sharp]
</I>&gt;<i> Gtk.WindowType)
</I>&gt;<i>  L_0015: ldarg.0
</I>&gt;<i>  L_0016:
</I>&gt;<i> ldc.i4 0x304
</I>&gt;<i>  L_001b: call instance
</I>&gt;<i> void [gtk-sharp]
</I>&gt;<i> Gtk.Widget::AddEvents(
</I>&gt;<i> int32)
</I>&gt;<i>  L_0020: ldarg.0
</I>&gt;<i>  L_0021:
</I>&gt;<i> ldstr &quot;Hello World&quot;
</I>&gt;<i>  L_0026:
</I>&gt;<i> newobj instance void [
</I>&gt;<i> Ribbons]Ribbons.Button::
</I>&gt;<i> .ctor(string)
</I>&gt;<i>  L_002b:
</I>&gt;<i> call instance void [
</I>&gt;<i> gtk-sharp]Gtk.Container::
</I>&gt;<i> Add(class [
</I>&gt;<i> gtk-sharp]Gtk.Widget)
</I>&gt;<i>  L_0030:
</I>&gt;<i> ldarg.0
</I>&gt;<i>  L_0031: ldc.i4 200
</I>&gt;<i>  L_0036:
</I>&gt;<i> ldc.i4 200
</I>&gt;<i>  L_003b: call instance
</I>&gt;<i> void [gtk-sharp]
</I>&gt;<i> Gtk.Window::Resize(
</I>&gt;<i> int32, int32)
</I>&gt;<i>  L_0040:
</I>&gt;<i> ldarg.0
</I>&gt;<i>  L_0041: call instance
</I>&gt;<i> void [gtk-sharp]
</I>&gt;<i> Gtk.Widget::ShowAll()
</I>&gt;<i>  L_0046:
</I>&gt;<i> ret
</I>&gt;<i>  L_0047: nop
</I>&gt;<i>  L_0048:
</I>&gt;<i> ldc.i4 2
</I>&gt;<i>  L_004d: pop
</I>&gt;<i>  L_004e:
</I>&gt;<i> nop
</I>&gt;<i>  L_004f: newobj instance
</I>&gt;<i> void
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated1
</I>&gt;<i> ::.ctor()
</I>&gt;<i>  L_0054:
</I>&gt;<i> stloc.s generated2
</I>&gt;<i>  L_0056: ldloc.s generated2
</I>&gt;<i>
</I>&gt;<i>  L_0058: ldloc.0
</I>&gt;<i>  L_0059:
</I>&gt;<i> stfld class Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated0 Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated1::
</I>&gt;<i> &lt;2:scope1&gt;
</I>&gt;<i>  L_005e: nop
</I>&gt;<i>  L_005f:
</I>&gt;<i> ldc.i4 3
</I>&gt;<i>  L_0064: pop
</I>&gt;<i>  L_0065:
</I>&gt;<i> nop
</I>&gt;<i>  L_0066: newobj instance
</I>&gt;<i> void
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated4
</I>&gt;<i> ::.ctor()
</I>&gt;<i>  L_006b:
</I>&gt;<i> stloc.s generated3
</I>&gt;<i>  L_006d: ldloc.s generated3
</I>&gt;<i>
</I>&gt;<i>  L_006f: ldloc.s generated2
</I>&gt;<i>  L_0071:
</I>&gt;<i> stfld class Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated1 Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated4::
</I>&gt;<i> &lt;3:scope2&gt;
</I>&gt;<i>  L_0076: ldloc.s generated3
</I>&gt;<i>  L_0078:
</I>&gt;<i> ldloc.0
</I>&gt;<i>  L_0079: stfld class
</I>&gt;<i> Sample.MainWindow/&lt;&gt;c__CompilerGenerated0
</I>&gt;<i>  Sample.MainWindow/
</I>&gt;<i> &lt;&gt;c__CompilerGenerated4::
</I>&gt;<i> &lt;3:scope1&gt;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Have nice holidays,
</I>&gt;<i> Laurent Debacker.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026359.html">[Mono-dev] Bug in MCS or Mono Runtime 1.2.6
</A></li>
	<LI>Next message: <A HREF="026355.html">[Mono-dev] Mono 1.2.6 VM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26361">[ date ]</a>
              <a href="thread.html#26361">[ thread ]</a>
              <a href="subject.html#26361">[ subject ]</a>
              <a href="author.html#26361">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
