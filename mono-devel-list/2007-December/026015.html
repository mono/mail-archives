<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] DriveInfo implementation - volume space
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20DriveInfo%20implementation%20-%20volume%20space&In-Reply-To=bda1cfca0712071948t294ebdf8q4b3064a41213b79b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026005.html">
   <LINK REL="Next"  HREF="026012.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] DriveInfo implementation - volume space</H1>
    <B>Javier Mart&#237;n</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20DriveInfo%20implementation%20-%20volume%20space&In-Reply-To=bda1cfca0712071948t294ebdf8q4b3064a41213b79b%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] DriveInfo implementation - volume space">lordhabbit at gmail.com
       </A><BR>
    <I>Sun Dec  9 14:29:07 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="026005.html">[Mono-dev] [PATCH] DriveInfo implementation - volume space
</A></li>
        <LI>Next message: <A HREF="026012.html">[Mono-dev] [PATCH] DriveInfo implementation - volume space
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26015">[ date ]</a>
              <a href="thread.html#26015">[ thread ]</a>
              <a href="subject.html#26015">[ subject ]</a>
              <a href="author.html#26015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm back from the no-internet land! Hi again!


Robert Jordan wrote:
&gt;<i>In volumes.c:
</I>&gt;<i>
</I>&gt;<i>+	if (NULL != availFree)
</I>&gt;<i>+		availFree-&gt;QuadPart = buf.f_bavail * buf.f_frsize;
</I>&gt;<i>+	if (NULL != totalSize)
</I>&gt;<i>+		totalSize-&gt;QuadPart = buf.f_blocks * buf.f_frsize;
</I>&gt;<i>+	if (NULL != totalFree)
</I>&gt;<i>+		totalFree-&gt;QuadPart = buf.f_bfree * buf.f_frsize;
</I>&gt;<i>
</I>&gt;<i>On systems w/out LARGE_FILE support (_FILE_OFFSET_BITS != 64),
</I>&gt;<i>the computations are not performed at 64-bit precision, so
</I>&gt;<i>you better cast the result to guint64.
</I>
You are partially right: indeed the result could be performed with
&lt;64b precision on systems with _FILE_OFFSET_BITS &lt; 64 (very few, I
believe, since FUSE requires 64-bit off_t and friends), but you are
wrong on where to apply the fix: casting the (already truncated)
result will just fill the upper 32 bits with zeros. Instead, the cast
should be performed on the arguments, so the computation is performed
with &gt;= 64 bits precision and no data is lost.

In fact, I'm thinking of writing a small macro checking if
_FILE_OFFSET_BITS is less than 64 and then applying the cast. I don't
want the code to break with a 128-bit off_t (though it WILL break
because ULARGE_INTEGER is only 64bits xD). Maybe it could be like
this:

#define WIDEN(x,t) ( (sizeof(x) &lt; sizeof(t)) ? (t)x : x );
So the result could be like this:
availSpace-&gt;QuadPart = WIDEN(buf.f_bavail,guint64) * buf.f_frsize;

This way, the code will always use 64-bits precision (the right
argument for * is automatically casted to the wider type), and when
_FOT &gt; 64 it will fail to compile reminding the 2030 Mono developers
(we should already be looking for newborns and start training them in
the ways of the Force) that the result type needs to be changed. I
consider that better than just random &quot;oh my, I lost ten exbibytes&quot;
errors.

* Disclaimer: this last part was not entirely serious, but it has
induced a reflection in me. Still don't know if I used
System.Reflection or CECIL, though. Seriously now, do I need to resend
the fixed patch or will you insert the three casts required?

&gt;<i>I don't think your patch will make into 1.2.6, but feel free
</I>&gt;<i>to ask the team (Dick, Miguel).
</I>&gt;<i>To avoid stability issues, you can always work with a stable
</I>&gt;<i>branch (e.g. branches/mono-1-2-6/ in SVN) and apply the patch
</I>&gt;<i>to this version.
</I>
That way I discovered a bit after I posted my last message. I was even
able to build .deb packages for my Ubuntu server based on 1.2.4 (last
version &quot;apt-get source&quot; retrieved) with incredible ease. Just had to
re-invoke the autotools so that Makefiles would be regenerated. Thanks
for the advice!

By the way, I'm already thinking about a new patch for this class.
This time, volume names are the target. Beware!

Habbit

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026005.html">[Mono-dev] [PATCH] DriveInfo implementation - volume space
</A></li>
	<LI>Next message: <A HREF="026012.html">[Mono-dev] [PATCH] DriveInfo implementation - volume space
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26015">[ date ]</a>
              <a href="thread.html#26015">[ thread ]</a>
              <a href="subject.html#26015">[ subject ]</a>
              <a href="author.html#26015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
