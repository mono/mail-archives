<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] BSTR Marshalling in Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BSTR%20Marshalling%20in%20Mono&In-Reply-To=17c2d80b0712190709t7dd96233l65d6b9cc77e3036f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026211.html">
   <LINK REL="Next"  HREF="026228.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] BSTR Marshalling in Mono</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20BSTR%20Marshalling%20in%20Mono&In-Reply-To=17c2d80b0712190709t7dd96233l65d6b9cc77e3036f%40mail.gmail.com"
       TITLE="[Mono-dev] BSTR Marshalling in Mono">lupus at ximian.com
       </A><BR>
    <I>Wed Dec 19 11:05:13 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="026211.html">[Mono-dev] BSTR Marshalling in Mono
</A></li>
        <LI>Next message: <A HREF="026228.html">[Mono-dev] BSTR Marshalling in Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26222">[ date ]</a>
              <a href="thread.html#26222">[ thread ]</a>
              <a href="subject.html#26222">[ subject ]</a>
              <a href="author.html#26222">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/19/07 Jonathan Chambers wrote:
&gt;<i>       COM Interop support in mono works pretty well for most basic uses, but
</I>&gt;<i> has some limitations when it comes to strings. Mainly, BSTR marshalling on
</I>&gt;<i> non-Windows platforms is just a default implementation. The problem is that
</I>&gt;<i> most COM systems (both Mainsoft's COM and Mozilla's XPCOM) have specific
</I>&gt;<i> requirements on strings. They need to follow a certain format (usually a
</I>&gt;<i> length prefixed string), use special allocators/deallocators, and use the
</I>&gt;<i> correct byte size (2-byte vs. 4-byte encoding).
</I>[...]
&gt;<i> 1. Expose some methods in the runtime so users could embed mono and adjust
</I>&gt;<i> the BSTR marshalling behavior with callbacks. Something like
</I>&gt;<i> mono_set_bstr_to_string_marshal, mono_set_bstr_from_string_marshal,
</I>&gt;<i> mono_set_bstr_free. This would require users to embed mono.
</I>&gt;<i> 
</I>&gt;<i> 2. Use the dll map in the config file to let the user specify entry points
</I>&gt;<i> to perform BSTR marshalling. This seems a better choice than the first.
</I>&gt;<i> There is then a technical question as to how to implement this.
</I>
The second solution would be better as it doesn't force embedding mono.
For this new feature, though, we'd need to be able to handle both
xpcom and COM at the same time, so a global setting wouldn't be enough.
Is there a way we could use to distinguish the two cases at the time
we're emitting the marshaling code?
As for the implementation, we could load a shared library that
implements the needed bstr methods (this is indeed how I planned at the
time the COM support would work), but these shared libs would need to be
separate from mono, as we don't want the mono build to have to depend on
xulrunner or com dev libs to be installed.
Or we could see if it's possible to access the stuff we need with
dlopen/dlsym directly on the xpcom/com libs and use that inside the
runtime: this ahs the advantage that there is no build or runtime
dependency (unless the feature is actually used at runtime) and the
small drawback that the two systems are hardcoded (though we'd hope few
other com-like systems will be developed).

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026211.html">[Mono-dev] BSTR Marshalling in Mono
</A></li>
	<LI>Next message: <A HREF="026228.html">[Mono-dev] BSTR Marshalling in Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26222">[ date ]</a>
              <a href="thread.html#26222">[ thread ]</a>
              <a href="subject.html#26222">[ subject ]</a>
              <a href="author.html#26222">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
