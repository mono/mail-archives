<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] SSL Channel implementation and SslServerStream
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SSL%20Channel%20implementation%20and%20SslServerStream&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026153.html">
   <LINK REL="Next"  HREF="026160.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] SSL Channel implementation and SslServerStream</H1>
    <B>pablosantosluac</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20SSL%20Channel%20implementation%20and%20SslServerStream&In-Reply-To="
       TITLE="[Mono-dev] SSL Channel implementation and SslServerStream">pablosantosluac at terra.es
       </A><BR>
    <I>Tue Dec 18 02:28:46 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="026153.html">[Mono-dev] SSL Channel implementation and SslServerStream
</A></li>
        <LI>Next message: <A HREF="026160.html">[Mono-dev] SSL Channel implementation and SslServerStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26157">[ date ]</a>
              <a href="thread.html#26157">[ thread ]</a>
              <a href="subject.html#26157">[ subject ]</a>
              <a href="author.html#26157">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Sebastien,

Ok, understood.

Well, I'll run it with the profiler under mono and let you know where I'm 
loosing the time.

So, yes, I have a big problem when running on .net then... :-(

Ok, so, if I understand correctly, this RSA property at X509Certificate 
class shouldn't take time when running under the mono framework, should it? 
It should be invoked anyway, but wouldn't waste time because the 
CryptoServiceProvider is better implemented...

Thanks,

pablo

----- Original Message ----- 
From: &quot;Sebastien Pouliot&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien.pouliot at gmail.com</A>&gt;
To: &quot;pablosantosluac&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pablosantosluac at terra.es</A>&gt;
Cc: &quot;mono-devel-list&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Tuesday, December 18, 2007 1:07 AM
Subject: Re: [Mono-dev] SSL Channel implementation and SslServerStream


&gt;<i> Hey,
</I>&gt;<i>
</I>&gt;<i> On Mon, 2007-12-17 at 22:49 +0100, pablosantosluac wrote:
</I>&gt;&gt;<i> Hi again,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;&gt; Well, the line which is actually consuming 50% of the time is
</I>&gt;&gt;<i> &gt;&gt; new MonoX509.X509Certificate(serverCertificate.GetRawCertData());
</I>&gt;&gt;<i> &gt;&gt; inside the ServerContext constructor.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Are you running this under Mono or MS runtime ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> MS.
</I>&gt;<i>
</I>&gt;<i> well wrong mailing list ;-)
</I>&gt;<i>
</I>&gt;<i> Seriously 1.x frameworks* has a serious design flaw wrt to [RSA|
</I>&gt;<i> DSA]CryptoServiceProvider classes (the former used by the SSL code).
</I>&gt;<i> Each time one you create an instance of it then it *always* creates a
</I>&gt;<i> new keypair - even if it is created to load an existing keypair. This
</I>&gt;<i> makes the classes unusable for server applications.
</I>&gt;<i>
</I>&gt;<i> Mono design is different and a keypair is only created if (and when)
</I>&gt;<i> required.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * at least I think it was fixed in 2.0 - I've been bugging them to fix
</I>&gt;<i> this since 1.0 beta2.
</I>&gt;<i>
</I>&gt;&gt;<i> Running with a profiler. Mono results are currently slower, but it could
</I>&gt;&gt;<i> be related to something else.
</I>&gt;<i>
</I>&gt;<i> If Mono is slower then this is probably elsewhere.
</I>&gt;<i>
</I>&gt;&gt;<i> I'm having problems when creating more than 80
</I>&gt;&gt;<i> threads/sockets. Don't know why yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;&gt; Of course it is related to the RSA calculation inside the MonoX509
</I>&gt;&gt;<i> &gt;&gt; certificate.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Please provide additional details as there is no RSA computation
</I>&gt;&gt;<i> &gt; required in the mentioned ctor.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; I guess it could be catched
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; you mean &quot;cached&quot; ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, sorry, cached!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;&gt; when attending different clients
</I>&gt;&gt;<i> &gt;&gt; with the same server certificate, which would improve overall 
</I>&gt;&gt;<i> &gt;&gt; performance
</I>&gt;&gt;<i> &gt;&gt; (in my previous email I said it was only local to one client, but I 
</I>&gt;&gt;<i> &gt;&gt; was
</I>&gt;&gt;<i> &gt;&gt; wrong).
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; As I said this CANNOT be cached between a server and multiple clients 
</I>&gt;&gt;<i> &gt; (a
</I>&gt;&gt;<i> &gt; little long to explain but it's how SSL is designed).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ok, whatever, there's a property called RSA inside the Mono X509
</I>&gt;&gt;<i> certificate. This property gets invoked once per SSL connection, actually
</I>&gt;&gt;<i> calculating the same for each connection,
</I>&gt;<i>
</I>&gt;<i> Well it's not the same since this is a new key pair each time ;-) but
</I>&gt;<i> yes it's unneeded
</I>&gt;<i>
</I>&gt;&gt;<i> because it is just &quot;completing&quot;
</I>&gt;&gt;<i> (AFAIK) the server's certificate, if I'm not wrong, of course. I mean, 
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> certificate you pass to the SSLServerStream gets converted again and 
</I>&gt;&gt;<i> again,
</I>&gt;&gt;<i> and consuming time. If this can be cached, then the performance can be
</I>&gt;&gt;<i> really boosted. I think this is *just* the server's certificate, nothing 
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> do with the client (I guess). And yes, maybe it is not RSA calculation, 
</I>&gt;&gt;<i> but
</I>&gt;&gt;<i> this is the name of the property where the time is being spent... at 
</I>&gt;&gt;<i> least
</I>&gt;&gt;<i> under MS runtime.
</I>&gt;<i>
</I>&gt;<i> No, as I said, this is probably time &quot;lost&quot; doing unneeded keypair
</I>&gt;<i> generation (but this is not the case for Mono).
</I>&gt;<i>
</I>&gt;&gt;<i> pablo
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Regards,
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; pablo
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; ----- Original Message ----- 
</I>&gt;&gt;<i> &gt;&gt; From: &quot;Sebastien Pouliot&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">sebastien.pouliot at gmail.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; To: &quot;pablosantosluac&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pablosantosluac at terra.es</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; Sent: Monday, December 17, 2007 7:50 PM
</I>&gt;&gt;<i> &gt;&gt; Subject: Re: [Mono-dev] SSL Channel implementation and SslServerStream
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Hello Pablo,
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; On Mon, 2007-12-17 at 17:21 +0100, pablosantosluac wrote:
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Hi again,
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Well, looking into the ServerContext constructor: the code converts
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; between
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; the System.Security cert to a Mono cert. Ok, this calculation could 
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; be
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; skipped if a server is launching threads with the same certificate.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; The
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; performance hit &quot;caching&quot; this one is about a 50% (launching 350
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; client
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; threads simultaneously).
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Sorry but this is confusing. Let me clear this up a bit so the 
</I>&gt;&gt;<i> &gt;&gt; &gt; answer
</I>&gt;&gt;<i> &gt;&gt; &gt; will be meaningful when goggled in the future ;-)
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Converting the certificate between the minimal MS X509Certificate 
</I>&gt;&gt;<i> &gt;&gt; &gt; and
</I>&gt;&gt;<i> &gt;&gt; &gt; the Mono.Security X509Certificate is a very simple process. This 
</I>&gt;&gt;<i> &gt;&gt; &gt; could
</I>&gt;&gt;<i> &gt;&gt; &gt; be cached but this, alone, won't influence much performance.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; The key exchange does an expensive RSA operation, but it cannot be
</I>&gt;&gt;<i> &gt;&gt; &gt; cached in ServerContext.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; Now what *could* help is implementing a session cache in the
</I>&gt;&gt;<i> &gt;&gt; &gt; server[1][2]. However this helps only caching a session between the
</I>&gt;&gt;<i> &gt;&gt; &gt; server and a single client - you cannot share a session between
</I>&gt;&gt;<i> &gt;&gt; &gt; multiple
</I>&gt;&gt;<i> &gt;&gt; &gt; clients.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; That being said the server code won't scale to support, efficiently,
</I>&gt;&gt;<i> &gt;&gt; &gt; 350
</I>&gt;&gt;<i> &gt;&gt; &gt; sessions. If you need high performance SSL code don't look at a 
</I>&gt;&gt;<i> &gt;&gt; &gt; managed
</I>&gt;&gt;<i> &gt;&gt; &gt; implementation (and IMO consider hardware acceleration).
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; [1] the SslClientStream already support session caching
</I>&gt;&gt;<i> &gt;&gt; &gt; [2] contributions welcome
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; I'll try to locate the next bottleneck
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; All cryptographic operations, like key exchange, encryption, 
</I>&gt;&gt;<i> &gt;&gt; &gt; integrity,
</I>&gt;&gt;<i> &gt;&gt; &gt; will show as a &quot;bottleneck&quot; - but they are exactly what you (should)
</I>&gt;&gt;<i> &gt;&gt; &gt; seek by choosing SSL.
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; pablo
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; ----- Original Message ----- 
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; From: &quot;pablosantosluac&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">pablosantosluac at terra.es</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Sent: Monday, December 17, 2007 4:23 PM
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Subject: [Mono-dev] SSL Channel implementation and SslServerStream
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Hi all,
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; I'm implemented a secured TCP remoting channel. I took the 
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; current
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; TCP
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Channel as starting point, and used Ssl{Client|Server}Stream to
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; implement
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; communication, as Robert Jordan suggested.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Well, it seems it works correctly but I've found the following
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; issue:
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; creating each new connection takes time (obviously), but it is
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; basically
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; due
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; to a call to &quot;new ServerContext&quot; inside the SslServerStream
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; constructor.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; The problem, in fact, seems related with the property
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; X509Certificate::RSA.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Each time a new connection is opened, a new certificate is given,
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; and
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; the
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; private key used.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Is there a way to actually make all this initialization just 
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; once?
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; It
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; would
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; greatly improve performance both in Mono and .NET.
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Any idea?
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; thanks
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; pablo
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; _______________________________________________
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; _______________________________________________
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt;&gt; &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026153.html">[Mono-dev] SSL Channel implementation and SslServerStream
</A></li>
	<LI>Next message: <A HREF="026160.html">[Mono-dev] SSL Channel implementation and SslServerStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26157">[ date ]</a>
              <a href="thread.html#26157">[ thread ]</a>
              <a href="subject.html#26157">[ subject ]</a>
              <a href="author.html#26157">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
