<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Implement internal call builders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Implement%20internal%20call%20builders&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028295.html">
   <LINK REL="Next"  HREF="028292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Implement internal call builders</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Implement%20internal%20call%20builders&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Implement internal call builders">kornelpal at gmail.com
       </A><BR>
    <I>Sat Jun 21 07:19:39 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028295.html">[Mono-dev] Bug in ShrinkArray in Xutil.cs?
</A></li>
        <LI>Next message: <A HREF="028292.html">[Mono-dev] No tail call optimization for virtual calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28291">[ date ]</a>
              <a href="thread.html#28291">[ thread ]</a>
              <a href="subject.html#28291">[ subject ]</a>
              <a href="author.html#28291">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

There are a lot of internal calls that could be implemented entirely 
using managed code.

Usually the problem is that they require information about internal data 
structures of the runtime. Sharing internal structures between native 
and managed code is problematic because two declarations has to be kept 
in sync.

Other problem may be that the required opcodes cannot be expressed in C#.

The current solution is to use mini_get_inst_for_method that started to 
get quite big and because it always gets inlined only a small amount of 
code is accepted to this function.

My proposed solution is to introduce internal call builders that 
generate managed code themselves of type MONO_WRAPPER_MANAGED_TO_MANAGED.

My patch contains three reference internal call builder implementations:
- RuntimeHelpers.OffsetToStringData: that is currently implemented in 
mini_get_inst_for_method
- Marshal.UnsafeAddrOfPinnedArrayElement: that is currently implemented 
using native code
- String..ctor: that is currenly implemented as a hack in 
mono_marshal_get_native_wrapper

If internal calls of type MONO_WRAPPER_MANAGED_TO_MANAGED were permitted 
to be inlined there could be more performance gain from this new feature.

If you like this new feature please approve the code. Otherwise please 
help me to improve it.

Thanks.

Korn&#233;l
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: icall_builder.diff.txt
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080621/1c6235d5/attachment-0001.txt">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080621/1c6235d5/attachment-0001.txt</A> 
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028295.html">[Mono-dev] Bug in ShrinkArray in Xutil.cs?
</A></li>
	<LI>Next message: <A HREF="028292.html">[Mono-dev] No tail call optimization for virtual calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28291">[ date ]</a>
              <a href="thread.html#28291">[ thread ]</a>
              <a href="subject.html#28291">[ subject ]</a>
              <a href="author.html#28291">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
