<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] DirectFB and Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DirectFB%20and%20Mono&In-Reply-To=20080626170253.gsw8gggc80c0s4w8%40webmail.researchstudio.at">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028330.html">
   <LINK REL="Next"  HREF="028384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] DirectFB and Mono</H1>
    <B>Csaba Balazs</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20DirectFB%20and%20Mono&In-Reply-To=20080626170253.gsw8gggc80c0s4w8%40webmail.researchstudio.at"
       TITLE="[Mono-dev] DirectFB and Mono">csaba.balazs at researchstudio.at
       </A><BR>
    <I>Mon Jun 30 08:49:47 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028330.html">[Mono-dev] DirectFB and Mono
</A></li>
        <LI>Next message: <A HREF="028384.html">[Mono-dev] DirectFB and Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28383">[ date ]</a>
              <a href="thread.html#28383">[ thread ]</a>
              <a href="subject.html#28383">[ subject ]</a>
              <a href="author.html#28383">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I minimized the C++ and C# codes. The C++ part inits the DirectFB.

Compiling / Running:

1. g++ -shared -D_REENTRANT -o libprobawrap.so probawrap.cpp
-I/usr/include/glib-2.0/ -I/usr/lib/glib-2.0/include/ -I/usr/include/directfb
-ldirectfb
2. gmcs Proba.cs
3. mono Proba.exe

The C# application inits first the DirectFB (with C++ library), and starts
making with Proba_Function garbage string and printing then to screen. .
If I use the DirectFBCreate command, the whole application fails and 
exit, when
the mono GC starts, usually after 60-70 garbages.

Why can it happen? The sources are enclosed.

Thanks.

Csaba

Proba.cs:
---------------------------------------------------------------------------
using System;
using System.Runtime.InteropServices;

class Proba {

	[DllImport(&quot;probawrap&quot;)]
	private static extern void proba_init();

	public Proba() {
		proba_init();
	}

	private void Proba_Function() {
		int i = 0;
		while (true) {
			string garbage = &quot;garbage: &quot; + i;
			i++;
			Console.WriteLine(&quot;C# Proba_Function - &quot; + garbage);
		}
	}

	public static void Main() {
		Proba proba = new Proba();
		proba.Proba_Function();
	}
}


probawrap.cpp
---------------------------------------------------------------------------
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;

#include &lt;directfb/directfb.h&gt;
#include &lt;directfb/directfb_version.h&gt;

/* macro for a safe call to DirectFB functions */
#define DFBCHECK(x...) \
      {                                                                \
           err = x;                                                    \
           if (err != DFB_OK) {                                        \
                fprintf( stderr, &quot;%s &lt;%d&gt;:\n\t&quot;, __FILE__, __LINE__ ); \
                DirectFBErrorFatal( #x, err );                         \
           }                                                           \
      }

IDirectFB *evas_gui_dfb;

extern &quot;C&quot; {

	void proba_init() {
		DFBResult err;
		int argc = 2;
		char* arg0 = &quot;directfb&quot;;
		char* arg1 = &quot;--dfb:system=x11&quot;;

		char** argv = new char*[2];
		argv[0] = arg0;
		argv[1] = arg1;

		IDirectFB	      *evas_gui_dfb;

		DFBCHECK( DirectFBInit(&amp;argc, &amp;argv) );
		DFBCHECK( DirectFBCreate(&amp;evas_gui_dfb) );	// &lt;--- problem, if we use

		delete argv;

	}

}

---------------------------------------------------------------------------




Quoting Csaba Balazs &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">csaba.balazs at researchstudio.at</A>&gt;:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I have found an interesting &quot;bug&quot;. I wrote a simple C# sample, which 
</I>&gt;<i> calls a C
</I>&gt;<i> function.
</I>&gt;<i> This C function sets up the DirectFB (DirectFBInit and DirectFBCreate) and
</I>&gt;<i> returns. And whenever the Garbage Collector starts running, it kills 
</I>&gt;<i> the whole
</I>&gt;<i> application.
</I>&gt;<i> I think they somehow interfere, and GC kills the directFB. Has anyone 
</I>&gt;<i> met this
</I>&gt;<i> problem?
</I>&gt;<i> What can be the solution?
</I>&gt;<i>
</I>&gt;<i> Thanks in advance:
</I>&gt;<i>
</I>&gt;<i> Csaba
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028330.html">[Mono-dev] DirectFB and Mono
</A></li>
	<LI>Next message: <A HREF="028384.html">[Mono-dev] DirectFB and Mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28383">[ date ]</a>
              <a href="thread.html#28383">[ thread ]</a>
              <a href="subject.html#28383">[ subject ]</a>
              <a href="author.html#28383">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
