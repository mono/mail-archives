<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Fwd: [Mono-patches] r106626 -	in	trunk/mcs/class/System.Configuration: .	System.Configuration	Test/System.Configuration Test/standalone]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BFwd%3A%20%5BMono-patches%5D%20r106626%20-%0A%09in%09trunk/mcs/class/System.Configuration%3A%20.%0A%09System.Configuration%09Test/System.Configuration%20Test/standalone%5D&In-Reply-To=4863B886.409%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028331.html">
   <LINK REL="Next"  HREF="028338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Fwd: [Mono-patches] r106626 -	in	trunk/mcs/class/System.Configuration: .	System.Configuration	Test/System.Configuration Test/standalone]</H1>
    <B>Gert Driesen</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BFwd%3A%20%5BMono-patches%5D%20r106626%20-%0A%09in%09trunk/mcs/class/System.Configuration%3A%20.%0A%09System.Configuration%09Test/System.Configuration%20Test/standalone%5D&In-Reply-To=4863B886.409%40ximian.com"
       TITLE="[Mono-dev] [Fwd: [Mono-patches] r106626 -	in	trunk/mcs/class/System.Configuration: .	System.Configuration	Test/System.Configuration Test/standalone]">gert.driesen at telenet.be
       </A><BR>
    <I>Thu Jun 26 13:47:10 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028331.html">[Mono-dev] [Fwd: [Mono-patches] r106626 - in	trunk/mcs/class/System.Configuration: . System.Configuration	Test/System.Configuration Test/standalone]
</A></li>
        <LI>Next message: <A HREF="028338.html">[Mono-dev] [Fwd: [Mono-patches] r106626 -	in	trunk/mcs/class/System.Configuration: .	System.Configuration	Test/System.Configuration Test/standalone]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28335">[ date ]</a>
              <a href="thread.html#28335">[ thread ]</a>
              <a href="subject.html#28335">[ subject ]</a>
              <a href="author.html#28335">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Atsushi,

Apart from the change in ClientConfigurationSystem my patch was about using
the IConfigErrorInfo interface for getting filename/linenumber info instead
of explicitly checking for XmlTextReader, or using internal IConfigXmlNode
interface.

Before the introduction of IConfigErrorInfo, we had to resort to this. My
changes just allow us to use this new interface, which - at the same time -
allows us to write unit tests for this (as this now matches the MS
implementation).

I don't intend to write a book about these trivial changes, but I've
responded to your comments inline.

Gert

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Atsushi Eno
Sent: donderdag 26 juni 2008 17:41
To: Gert Driesen
Cc: 'mono-devel-list'
Subject: Re: [Mono-dev] [Fwd: [Mono-patches] r106626 - in
trunk/mcs/class/System.Configuration: . System.Configuration
Test/System.Configuration Test/standalone]

No. You claim as if your change were only about one issue, which it
NOT true. Here is concrete description:

&gt;<i> Modified:
</I>trunk/mcs/class/System.Configuration/System.Configuration/AppSettingsSection
.cs
&gt;<i> ===================================================================
</I>&gt;<i> ---
</I>trunk/mcs/class/System.Configuration/System.Configuration/AppSettingsSection
.cs	2008-06-26 09:57:29 UTC (rev 106625)
&gt;<i> +++
</I>trunk/mcs/class/System.Configuration/System.Configuration/AppSettingsSection
.cs	2008-06-26 10:31:07 UTC (rev 106626)
&gt;<i> @@ -73,7 +73,7 @@
</I>&gt;<i>  			if (File != &quot;&quot;) {
</I>&gt;<i>  				try {
</I>&gt;<i>  					Stream s = System.IO.File.OpenRead
</I>(File);
&gt;<i> -					XmlReader subreader = new
</I>XmlTextReader (s);
&gt;<i> +					XmlReader subreader = new
</I>ConfigXmlTextReader (s, File);
&gt;<i>  					base.DeserializeElement (subreader,
</I>serializeCollectionKey);
&gt;<i>  					s.Close ();
</I>&gt;<i>  				}
</I>
For example it is about ConfigXmlTextReader change.

=&gt; The use of ConfigXmlTextReader is necessary as it implements
IConfigErrorInfo. I consider this part of the same change.

&gt;<i> Modified:
</I>trunk/mcs/class/System.Configuration/System.Configuration/ClientConfiguratio
nSystem.cs
&gt;<i> ===================================================================
</I>&gt;<i> ---
</I>trunk/mcs/class/System.Configuration/System.Configuration/ClientConfiguratio
nSystem.cs	2008-06-26 09:57:29 UTC (rev 106625)
&gt;<i> +++
</I>trunk/mcs/class/System.Configuration/System.Configuration/ClientConfiguratio
nSystem.cs	2008-06-26 10:31:07 UTC (rev 106626)
&gt;<i> @@ -32,28 +32,39 @@
</I>&gt;<i>  using System.Reflection;
</I>&gt;<i>  using System.Configuration.Internal;
</I>&gt;<i>  
</I>&gt;<i> -namespace System.Configuration {
</I>&gt;<i> -
</I>&gt;<i> +namespace System.Configuration
</I>&gt;<i> +{
</I>&gt;<i>  	internal class ClientConfigurationSystem : IInternalConfigSystem
</I>&gt;<i>  	{
</I>&gt;<i> -		readonly Configuration cfg;
</I>&gt;<i> +		Configuration cfg;
</I>&gt;<i>  
</I>&gt;<i> -		public ClientConfigurationSystem () {
</I>&gt;<i> -			Assembly a = Assembly.GetEntryAssembly();
</I>&gt;<i> -			string exePath =
</I>AppDomain.CurrentDomain.SetupInformation.ConfigurationFile;
&gt;<i> -            
</I>&gt;<i> -			if (a == null &amp;&amp; exePath == null)
</I>&gt;<i> -				exePath = &quot;&quot;;
</I>&gt;<i> -            
</I>&gt;<i> -			cfg =
</I>ConfigurationManager.OpenExeConfigurationInternal
(ConfigurationUserLevel.None, a, exePath);
&gt;<i> +		public ClientConfigurationSystem ()
</I>&gt;<i> +		{
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> +		private Configuration Configuration {
</I>&gt;<i> +			get {
</I>&gt;<i> +				if (cfg == null) {
</I>&gt;<i> +					Assembly a =
</I>Assembly.GetEntryAssembly();
&gt;<i> +					string exePath =
</I>AppDomain.CurrentDomain.SetupInformation.ConfigurationFile;
&gt;<i> +
</I>&gt;<i> +					if (a == null &amp;&amp; exePath == null)
</I>&gt;<i> +						exePath = string.Empty;
</I>&gt;<i> +
</I>&gt;<i> +					try {
</I>&gt;<i> +						cfg =
</I>ConfigurationManager.OpenExeConfigurationInternal (
&gt;<i> +
</I>ConfigurationUserLevel.None, a, exePath);
&gt;<i> +					} catch (Exception ex) {
</I>&gt;<i> +						throw new
</I>ConfigurationErrorsException (&quot;Error Initializing the configuration
system.&quot;, ex);
&gt;<i> +					}
</I>&gt;<i> +				}
</I>&gt;<i> +				return cfg;
</I>&gt;<i> +			}
</I>&gt;<i> +		}
</I>&gt;<i> +
</I>&gt;<i>  		object IInternalConfigSystem.GetSection (string configKey)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (cfg == null)
</I>&gt;<i> -				return null;
</I>&gt;<i> -
</I>&gt;<i> -			ConfigurationSection s = cfg.GetSection (configKey);
</I>&gt;<i> +			ConfigurationSection s = Configuration.GetSection
</I>(configKey);
&gt;<i>  			return s != null ? s.GetRuntimeObject () : null;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>
This is about lazy initialization. There is no bug fixes involved.

=&gt; As I mentioned earlier, this is not related to the IConfigErrorInfo
implementation. However, it does fix a bug. Standalone test t28 failed with
a TypeInitializationException before this fix. 

&gt;<i> @@ -460,17 +459,12 @@
</I>&gt;<i>  				return false;
</I>&gt;<i>  			}
</I>&gt;<i>  
</I>&gt;<i> -			try {
</I>&gt;<i> -				reader = new XmlTextReader (stream);
</I>&gt;<i> +			using (XmlTextReader reader = new
</I>ConfigXmlTextReader (stream, streamName)) {
&gt;<i>  				ReadConfigFile (reader, streamName);
</I>&gt;<i> -			} finally {
</I>&gt;<i> -				if (reader != null)
</I>&gt;<i> -					reader.Close();
</I>&gt;<i>  			}
</I>&gt;<i>  			return true;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -
</I>&gt;<i>  		void ReadConfigFile (XmlTextReader reader, string fileName)
</I>&gt;<i>  		{
</I>&gt;<i>  			reader.MoveToContent ();
</I>
Insignificant change.

=&gt; Same as above. The use of ConfigXmlTextReader is necessary as it
implements IConfigErrorInfo. Also used Disposable pattern (unrelated, big
deal).
 
&gt;<i> Modified:
</I>trunk/mcs/class/System.Configuration/System.Configuration/ConfigurationEleme
nt.cs
&gt;<i> ===================================================================
</I>&gt;<i> ---
</I>trunk/mcs/class/System.Configuration/System.Configuration/ConfigurationEleme
nt.cs	2008-06-26 09:57:29 UTC (rev 106625)
&gt;<i> +++
</I>trunk/mcs/class/System.Configuration/System.Configuration/ConfigurationEleme
nt.cs	2008-06-26 10:31:07 UTC (rev 106626)
&gt;<i> @@ -322,13 +322,13 @@
</I>&gt;<i>  					} else if (this is
</I>ConfigurationSection &amp;&amp; reader.LocalName == &quot;configSource&quot;) {
&gt;<i>  						/* ignore */
</I>&gt;<i>  					} else if
</I>(!OnDeserializeUnrecognizedAttribute (reader.LocalName, reader.Value))
&gt;<i> -						throw new
</I>ConfigurationException (&quot;Unrecognized attribute '&quot; + reader.LocalName +
&quot;'.&quot;);
&gt;<i> +						throw new
</I>ConfigurationErrorsException (&quot;Unrecognized attribute '&quot; + reader.LocalName
+ &quot;'.&quot;, reader);
&gt;<i>  
</I>&gt;<i>  					continue;
</I>&gt;<i>  				}
</I>&gt;<i>  				
</I>&gt;<i>  				if (readProps.ContainsKey (prop))
</I>&gt;<i> -					throw new ConfigurationException
</I>(&quot;The attribute '&quot; + prop.Name + &quot;' may only appear once in this element.&quot;);
&gt;<i> +					throw new
</I>ConfigurationErrorsException (&quot;The attribute '&quot; + prop.Name + &quot;' may only
appear once in this element.&quot;, reader);
&gt;<i>  
</I>&gt;<i>  				string value = null;
</I>&gt;<i>  				try {
</I>
Different bugfix.

=&gt; I agree, but it's all about the same issue. The real bugfix is about
implementing support for IConfigErrorInfo, and this specific change just
allows us to use that implementation of the XmlTextReader for adding
filename/linenumber info to exception messages.

&gt;<i> @@ -141,34 +143,34 @@
</I>&gt;<i>  		//
</I>&gt;<i>  		public static string GetFilename (XmlReader reader)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (reader is XmlTextReader)
</I>&gt;<i> -				return ((XmlTextReader)reader).BaseURI;
</I>&gt;<i> +			if (reader is IConfigErrorInfo)
</I>&gt;<i> +				return ((IConfigErrorInfo) reader).Filename;
</I>&gt;<i>  			else
</I>&gt;<i> -				return String.Empty;
</I>&gt;<i> +				return null;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public static int GetLineNumber (XmlReader reader)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (reader is XmlTextReader)
</I>&gt;<i> -				return ((XmlTextReader)reader).LineNumber;
</I>&gt;<i> +			if (reader is IConfigErrorInfo)
</I>&gt;<i> +				return ((IConfigErrorInfo)
</I>reader).LineNumber;
&gt;<i>  			else
</I>&gt;<i>  				return 0;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public static string GetFilename (XmlNode node)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (!(node is IConfigXmlNode))
</I>&gt;<i> -				return String.Empty;
</I>&gt;<i> +			if (!(node is IConfigErrorInfo))
</I>&gt;<i> +				return null;
</I>&gt;<i>  
</I>&gt;<i> -			return ((IConfigXmlNode) node).Filename;
</I>&gt;<i> +			return ((IConfigErrorInfo) node).Filename;
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i>  		public static int GetLineNumber (XmlNode node)
</I>&gt;<i>  		{
</I>&gt;<i> -			if (!(node is IConfigXmlNode))
</I>&gt;<i> +			if (!(node is IConfigErrorInfo))
</I>&gt;<i>  				return 0;
</I>&gt;<i>  
</I>&gt;<i> -			return ((IConfigXmlNode) node).LineNumber;
</I>&gt;<i> +			return ((IConfigErrorInfo) node).LineNumber;
</I>&gt;<i>  		}
</I>&gt;<i>  		
</I>&gt;<i>  		public override void GetObjectData (SerializationInfo info,
</I>StreamingContext context)
&gt;<i> @@ -178,9 +180,8 @@
</I>&gt;<i>  			info.AddValue (&quot;ConfigurationErrors_Line&quot;, line);
</I>&gt;<i>  		}
</I>&gt;<i>  
</I>&gt;<i> -		string bareMessage = &quot;&quot;;
</I>&gt;<i> -		string filename = &quot;&quot;;
</I>&gt;<i> -		int line = 0;
</I>&gt;<i> +		readonly string filename;
</I>&gt;<i> +		readonly int line;
</I>&gt;<i>  	}
</I>&gt;<i>  #pragma warning restore
</I>&gt;<i>  }
</I>
Insignificant or doubtful changes (I needed to read the actual patch
again after quick check on ChangeLog).

=&gt; There's nothing doubtful about these changes. These are fully covered by
unit tests (that now pass on MS and Mono).

The changes are almost niche as it could have been done as
using XmlTextReader.BaseURI (the only difference between BaseURI and
this Filename thingy is whether it is an absolute URL or a file name,
isn't it) ?

=&gt; More or less, yes. But my changes are about using the IConfigErrorInfo
interface were applicable, instead of relying on the internal IConfigXmlNode
interface, or explicitly checking for XmlTextReader.

=&gt; My changes actually make it a little easier for your XmlNodeReader-based
implementation, as you don't have to check for explicit checks against
XmlTextReader and just need to implement IConfigErrorInfo in your
XmlNodeReader class for getting filename/linenumber info in exception
messages.

I keep somewhat special eyes on your changes because you usually
seem to make larger changes than usual hackers do. And this time
&quot;unfortunately&quot; we were actually discussing System.Configuration
refactoring. That's why your change is specially mentioned.

=&gt; I have no problem with people monitoring my changes. I tend to do that
myself, and this is part of why I like open-source development.

If you feel strong about reverting my changes, please go ahead. If you want
me to update your patch to support IConfigErrorInfo, just let me know.

Gert

Gert Driesen wrote:
&gt;<i> Hey Jb,
</I>&gt;<i> 
</I>&gt;<i> Sorry dude, but this wasn't a large changeset.
</I>&gt;<i> 
</I>&gt;<i> If the definition of a large changeset is a patch which adds a large set
</I>of
&gt;<i> unit tests, then I'm guilty as charged.
</I>&gt;<i> 
</I>&gt;<i> Apart from removing a few extra tabs (my mistake), everything I changed is
</I>&gt;<i> documented in the changelog and covered by unit tests or standalone tests.
</I>&gt;<i> 
</I>&gt;<i> There's only one part of the patch that could be committed separately, and
</I>&gt;<i> this is the change to ClientConfigurationSystem. And again, this change
</I>&gt;<i> fixes a failing standalone test (t28).
</I>&gt;<i> 
</I>&gt;<i> Please be reasonable. What more can you ask?
</I>&gt;<i> 
</I>&gt;<i> Gert
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
</I>&gt;<i> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Jb Evain
</I>&gt;<i> Sent: donderdag 26 juni 2008 15:11
</I>&gt;<i> To: Gert Driesen
</I>&gt;<i> Cc: Atsushi Eno; mono-devel-list
</I>&gt;<i> Subject: Re: [Mono-dev] [Fwd: [Mono-patches] r106626 - in
</I>&gt;<i> trunk/mcs/class/System.Configuration: . System.Configuration
</I>&gt;<i> Test/System.Configuration Test/standalone]
</I>&gt;<i> 
</I>&gt;<i> Hey,
</I>&gt;<i> 
</I>&gt;<i> On 6/26/08, Gert Driesen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gert.driesen at telenet.be</A>&gt; wrote:
</I>&gt;&gt;<i>  &gt; Even only with that point, I'm pretty much tempted to revert your
</I>&gt;&gt;<i>  &gt; changes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yeah, I'm glad my (any?) contributions are that much appreciated.
</I>&gt;<i> 
</I>&gt;<i> Come on Gert, it's definitely not the first time that you're told that
</I>&gt;<i> your commits are:
</I>&gt;<i> 
</I>&gt;<i> * totally not atomic,
</I>&gt;<i> * mixing totally different concerns,
</I>&gt;<i> 
</I>&gt;<i> And for some of us that keep an eye on the code coming in, it makes
</I>&gt;<i> that task much harder.
</I>&gt;<i> 
</I>&gt;<i> That doesn't mean that we don't appreciate contributions. But once
</I>&gt;<i> again, I already told you that I was not happy with the way you're
</I>&gt;<i> making commits, and am not the first one. And I can certainly
</I>&gt;<i> understand the maintainer frustration to see this huge changeset
</I>&gt;<i> coming in.
</I>&gt;<i> 
</I>
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028331.html">[Mono-dev] [Fwd: [Mono-patches] r106626 - in	trunk/mcs/class/System.Configuration: . System.Configuration	Test/System.Configuration Test/standalone]
</A></li>
	<LI>Next message: <A HREF="028338.html">[Mono-dev] [Fwd: [Mono-patches] r106626 -	in	trunk/mcs/class/System.Configuration: .	System.Configuration	Test/System.Configuration Test/standalone]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28335">[ date ]</a>
              <a href="thread.html#28335">[ thread ]</a>
              <a href="subject.html#28335">[ subject ]</a>
              <a href="author.html#28335">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
