<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] malloc error executing OBS-built mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20malloc%20error%20executing%20OBS-built%20mono&In-Reply-To=%3CDBXPR07MB33344D58D103D22E5AFE533DE390%40DBXPR07MB333.eurprd07.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043337.html">
   <LINK REL="Next"  HREF="043339.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] malloc error executing OBS-built mono</H1>
    <B>Miguel Gonz&#225;lez</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20malloc%20error%20executing%20OBS-built%20mono&In-Reply-To=%3CDBXPR07MB33344D58D103D22E5AFE533DE390%40DBXPR07MB333.eurprd07.prod.outlook.com%3E"
       TITLE="[Mono-dev] malloc error executing OBS-built mono">mgonzalez at codicesoftware.com
       </A><BR>
    <I>Tue Oct 20 16:29:41 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043337.html">[Mono-dev] Road to C6
</A></li>
        <LI>Next message: <A HREF="043339.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43338">[ date ]</a>
              <a href="thread.html#43338">[ thread ]</a>
              <a href="subject.html#43338">[ subject ]</a>
              <a href="author.html#43338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have a setup of OBS (SUSE Open Build Service) machines where I create OpenSUSE 12.3 RPM packages of mono 4.3 and GTK# 2.12.29. I'm using code downloaded from <A HREF="http://github.com/mono/mono">http://github.com/mono/mono</A> at commit b6dfce621f70115cd16e75a743cbbdee5ac6610e.

To make the code compile without complains from the OBS worker machine I had to apply this fix:

--- mono/mcs/class/corlib/System/WindowsConsoleDriver.cs      2015-10-14 18:14:36.238365556 +0200
+++ mono/mcs/class/corlib/System/WindowsConsoleDriver.cs      2015-10-15 12:14:12.750179775 +0200
@@ -432,7 +432,7 @@
                    Coord bsize = new Coord (sourceWidth, sourceHeight);
                    Coord bpos = new Coord (0, 0);
                    SmallRect region = new SmallRect (sourceLeft, sourceTop, sourceLeft + sourceWidth - 1, sourceTop + sourceHeight - 1);
-                    fixed (void *ptr = &amp;buffer [0]) {
+                    fixed (CharInfo *ptr = &amp;buffer [0]) {
                          if (!ReadConsoleOutput (outputHandle, ptr, bsize, bpos, ref region))
                                 throw new ArgumentException (String.Empty, &quot;Cannot read from the specified coordinates.&quot;);
                    }

I also had to apply this change in order to avoid an unallowed warning message:
I: Statement might be overflowing a buffer in strncat. Common mistake:
   BAD: strncat(buffer,charptr,sizeof(buffer)) is wrong, it takes the
   left over size as 3rd argument
   GOOD: strncat(buffer,charptr,sizeof(buffer)-strlen(buffer)-1)

(bufferoverflowstrncat)

--- mono/mono/metadata/process.c  2015-10-14 18:21:22.283225690 +0200
+++ mono/mono/metadata/process.c  2015-10-20 11:42:45.094099600 +0200
@@ -383,7 +383,7 @@
      char filename [80] = &quot;[In Memory] &quot;;
      const char *modulename = assembly-&gt;aname.name;
-      strncat (filename, modulename, 80);
+      strncat (filename, modulename, 80 - strlen(filename) - 1);
       /* Build a System.Diagnostics.ProcessModule with the data.
       */

First of all, does this last change make sense? I'd say so -since it's the expected strncat usage- but I'm not completely sure.

At this point I'm able to build mono RPM packages and they're working as I install them using a test OpenSUSE 12.3 virtual machine. However, when the GTK# builds are started -which use the mono packages as build requirement-, the worker is unable to run the mono executable: apparently, malloc is corrupting the heap or something. This is a sample execution as extracted from the OBS build logs:

[  101s] + /opt/plasticscm5/mono/bin/mono /opt/plasticscm5/mono/lib/mono/4.5/gacutil.exe -l

[  101s] *** Error in `/opt/plasticscm5/mono/bin/mono': malloc: top chunk is corrupt: 0x08ab9230 ***
As you might guess, the --prefix value used to compile mono is /opt/plasticscm5/mono) The MALLOC_CHECK_ environment variable is set to 3 by default. If set to 1, a warning message is displayed and the execution continues, but the program ends incorrectly by a segmentation fault.


I'm totally clueless about what might be happening. I have OBS configured to build this exact packages on OpenSUSE 12.2 and (to my dismay) they are being built flawlessly.
Could this be caused by my custom code changes? I don't think that's the cause since all of the remaining distros (Debian 6/8, Ubuntu 14.04, Red Hat 6, Fedora 17/20 and OpenSUSE 12.2) don't reproduce the issue.

I'd be delighted if someone could give me a hint about what might be going on. I'm also available to post any additional information that may be useful to find out the reason behind my mess.

Thank you!

Miguel Gonz&#225;lez


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20151020/f2645a52/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20151020/f2645a52/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043337.html">[Mono-dev] Road to C6
</A></li>
	<LI>Next message: <A HREF="043339.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43338">[ date ]</a>
              <a href="thread.html#43338">[ thread ]</a>
              <a href="subject.html#43338">[ subject ]</a>
              <a href="author.html#43338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
