<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] malloc error executing OBS-built mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20malloc%20error%20executing%20OBS-built%20mono&In-Reply-To=%3CDBXPR07MB333E88E5D1269AC07DC5C9FDE270%40DBXPR07MB333.eurprd07.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043340.html">
   <LINK REL="Next"  HREF="043342.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] malloc error executing OBS-built mono</H1>
    <B>Miguel Gonz&#225;lez</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20malloc%20error%20executing%20OBS-built%20mono&In-Reply-To=%3CDBXPR07MB333E88E5D1269AC07DC5C9FDE270%40DBXPR07MB333.eurprd07.prod.outlook.com%3E"
       TITLE="[Mono-dev] malloc error executing OBS-built mono">mgonzalez at codicesoftware.com
       </A><BR>
    <I>Thu Oct 22 16:04:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043340.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
        <LI>Next message: <A HREF="043342.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43341">[ date ]</a>
              <a href="thread.html#43341">[ thread ]</a>
              <a href="subject.html#43341">[ subject ]</a>
              <a href="author.html#43341">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I executed a sample command (gacutils.exe -l) under gdb to see the trace at the time of the crash.

This is the backtrace as returned by gdb:

Program received signal SIGABRT, Aborted.
0xf7e1b245 in raise () from /lib/libc.so.6
#0  0xf7e1b245 in raise () from /lib/libc.so.6
#1  0xf7e1cac3 in abort () from /lib/libc.so.6
#2  0xf7e635cb in malloc_printerr () from /lib/libc.so.6
#3  0xf7e63aec in top_check () from /lib/libc.so.6
#4  0xf7e65b13 in malloc_check () from /lib/libc.so.6
#5  0xf7e66c45 in malloc () from /lib/libc.so.6
#6  0xf7e6b071 in strdup () from /lib/libc.so.6
#7  0x0827d54c in monoeg_g_strsplit ()
#8  0x081b70a5 in arch_matches ()
#9  0x081b70fa in arch_matches ()
#10 0x081b7770 in dllmap_start ()
#11 0x08283f42 in monoeg_g_markup_parse_context_parse ()
#12 0x081b6e38 in mono_config_parse_xml_with_context ()
#13 0x081b6f6d in mono_config_parse_file_with_context ()
#14 0x081b6fd7 in mono_config_parse_file ()
#15 0x081b808c in mono_config_parse ()
#16 0x080c1449 in mono_main ()
#17 0x08065e52 in main ()

It seems to be failing when the /etc/mono/config file is loaded. This is the config file contents. The zlib line has been manually added to the code retrieved from GitHub.
&lt;configuration&gt;
   &lt;dllmap dll=&quot;i:cygwin1.dll&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot; /&gt;
   &lt;dllmap dll=&quot;libc&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;intl&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;intl&quot; name=&quot;bind_textdomain_codeset&quot; target=&quot;libc.so.6&quot; os=&quot;solaris&quot;/&gt;
   &lt;dllmap dll=&quot;libintl&quot; name=&quot;bind_textdomain_codeset&quot; target=&quot;libc.so.6&quot; os=&quot;solaris&quot;/&gt;
   &lt;dllmap dll=&quot;libintl&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;i:libxslt.dll&quot; target=&quot;libxslt.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;i:odbc32.dll&quot; target=&quot;libodbc.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;i:odbc32.dll&quot; target=&quot;libiodbc.dylib&quot; os=&quot;osx&quot;/&gt;
   &lt;dllmap dll=&quot;oci&quot; target=&quot;libclntsh.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;db2cli&quot; target=&quot;libdb2_36.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;MonoPosixHelper&quot; target=&quot;$mono_libdir/libMonoPosixHelper.so&quot; os=&quot;!windows&quot; /&gt;
   &lt;dllmap dll=&quot;i:msvcrt&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;i:msvcrt.dll&quot; target=&quot;libc.so.6&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;sqlite&quot; target=&quot;libsqlite.so.0&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;sqlite3&quot; target=&quot;libsqlite3.so.0&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;libX11&quot; target=&quot;libX11.so.6&quot; os=&quot;!windows&quot; /&gt;
   &lt;dllmap dll=&quot;libgdk-x11-2.0&quot; target=&quot;libgdk-x11-2.0.so.0&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;libgtk-x11-2.0&quot; target=&quot;libgtk-x11-2.0.so.0&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;libXinerama&quot; target=&quot;libXinerama.so.1&quot; os=&quot;!windows&quot; /&gt;
   &lt;dllmap dll=&quot;libcairo-2.dll&quot; target=&quot;libcairo.so.2&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;libcairo-2.dll&quot; target=&quot;libcairo.2.dylib&quot; os=&quot;osx&quot;/&gt;
   &lt;dllmap dll=&quot;libcups&quot; target=&quot;libcups.so.2&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;libcups&quot; target=&quot;libcups.dylib&quot; os=&quot;osx&quot;/&gt;
   &lt;dllmap dll=&quot;i:kernel32.dll&quot;&gt;
       &lt;dllentry dll=&quot;__Internal&quot; name=&quot;CopyMemory&quot; target=&quot;mono_win32_compat_CopyMemory&quot;/&gt;
       &lt;dllentry dll=&quot;__Internal&quot; name=&quot;FillMemory&quot; target=&quot;mono_win32_compat_FillMemory&quot;/&gt;
       &lt;dllentry dll=&quot;__Internal&quot; name=&quot;MoveMemory&quot; target=&quot;mono_win32_compat_MoveMemory&quot;/&gt;
       &lt;dllentry dll=&quot;__Internal&quot; name=&quot;ZeroMemory&quot; target=&quot;mono_win32_compat_ZeroMemory&quot;/&gt;
   &lt;/dllmap&gt;
   &lt;dllmap dll=&quot;gdiplus&quot; target=&quot;libgdiplus.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;gdiplus.dll&quot; target=&quot;libgdiplus.so&quot;  os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;gdi32&quot; target=&quot;libgdiplus.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;gdi32.dll&quot; target=&quot;libgdiplus.so&quot; os=&quot;!windows&quot;/&gt;
   &lt;dllmap dll=&quot;z&quot; target=&quot;libz.so.1&quot; os=&quot;!windows&quot; /&gt;
&lt;/configuration&gt;

Anyway, as I mentioned, we&#8217;re putting the openSUSE 12.3 build aside. We&#8217;ve noticed that openSUSE 12.3, 13.1 and 13.2 can work with our openSUSE 12.2 repository.

Miguel

From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Miguel Gonz&#225;lez
Sent: 22 October 2015 10:49
To: Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt;
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-dev] malloc error executing OBS-built mono

Hi Miguel,

Thanks for the update :-) I had also an e-mail from Zoltan Varga yesterday telling me that the change had been applied. I updated my code accordingly to see if that could be the fix for my issue, too&#8230; But it didn&#8217;t :-(

I&#8217;ll try using gdb as you suggested. I hadn&#8217;t considered it before since this crash only happens inside the automated build of the OBS worker virtual machine and I&#8217;ve not been able to reproduce in any other environment. However, any additional info is always appreciated! There are also chances of ditching this build and relying on other distros to build our packages, since our OpenSUSE packages seem to be highly compatible between versions.

Thank you,

Miguel

From: Miguel de Icaza [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>]
Sent: 21 October 2015 20:44
To: Miguel Gonz&#225;lez &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mgonzalez at codicesoftware.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mgonzalez at codicesoftware.com</A>&gt;&gt;
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Subject: Re: [Mono-dev] malloc error executing OBS-built mono

Hello Miguel,

I also had to apply this change in order to avoid an unallowed warning message:
I: Statement might be overflowing a buffer in strncat. Common mistake:
   BAD: strncat(buffer,charptr,sizeof(buffer)) is wrong, it takes the
   left over size as 3rd argument
   GOOD: strncat(buffer,charptr,sizeof(buffer)-strlen(buffer)-1)

We replaced that code with the glib string operations just yesterday:

042ddd504c09977682bb48010c5642390826d1da

But thanks for sharing.

At this point I&#8217;m able to build mono RPM packages and they&#8217;re working as I install them using a test OpenSUSE 12.3 virtual machine. However, when the GTK# builds are started &#8211;which use the mono packages as build requirement&#8211;, the worker is unable to run the mono executable: apparently, malloc is corrupting the heap or something. This is a sample execution as extracted from the OBS build logs:

[  101s] + /opt/plasticscm5/mono/bin/mono /opt/plasticscm5/mono/lib/mono/4.5/gacutil.exe -l

[  101s] *** Error in `/opt/plasticscm5/mono/bin/mono': malloc: top chunk is corrupt: 0x08ab9230 ***

What you want to do at this point in time is to run the process under gdb, as this will show where malloc detected the error, and then you should get both the unmanaged stack trace, and if possible the managed one (with the mono_stack gdb macro)

Miguel.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20151022/afacdff0/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20151022/afacdff0/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043340.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
	<LI>Next message: <A HREF="043342.html">[Mono-dev] malloc error executing OBS-built mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43341">[ date ]</a>
              <a href="thread.html#43341">[ thread ]</a>
              <a href="subject.html#43341">[ subject ]</a>
              <a href="author.html#43341">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
