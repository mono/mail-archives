<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Ping on nternal call builders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=4890910F.6040805%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028692.html">
   <LINK REL="Next"  HREF="028694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Ping on nternal call builders</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=4890910F.6040805%40gmail.com"
       TITLE="[Mono-dev] Ping on nternal call builders">lupus at ximian.com
       </A><BR>
    <I>Wed Jul 30 13:20:20 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028692.html">[Mono-dev] Ping on nternal call builders
</A></li>
        <LI>Next message: <A HREF="028694.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28693">[ date ]</a>
              <a href="thread.html#28693">[ thread ]</a>
              <a href="subject.html#28693">[ subject ]</a>
              <a href="author.html#28693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/30/08 Korn&#233;l P&#225;l wrote:
&gt;<i> &gt;Zoltan Varga wrote:
</I>&gt;<i> &gt;   This patch replaces a small, fast, simple piece of code
</I>&gt;<i> &gt; in mono_emit_inst_for_method () with something far more complex. Also,
</I>&gt;<i> 
</I>&gt;<i> The three icall builders are reference implementations for demonstrating
</I>&gt;<i> what icall builders can do. I don't insist on OffsetToStringData being
</I>&gt;<i> replaced with an icall builder. Note that however that my tests showed
</I>&gt;<i> no difference in executing the code. (I didn't do tests on JIT time.)
</I>
If you propose a considerable amount of increased complexity and your
reference 'improvements' are actually a lot worse you should at least
choose better references to show.

&gt;<i> &gt; about replacing
</I>&gt;<i> &gt; icalls with generated IL code:
</I>&gt;<i> &gt; - the code to generate the icalls is usually much bigger and more
</I>&gt;<i> &gt; complex than the icall
</I>&gt;<i> &gt;   itself.
</I>&gt;<i> 
</I>&gt;<i> That's true but UnsafeAddrOfPinnedArrayElement (that is so simple code
</I>&gt;<i> that it should do exactly the same in C and IL) for example was running
</I>&gt;<i> 5.7x faster and I believe only because of omitting the managed to native
</I>&gt;<i> transition.
</I>
This cases are rare and there are far better ways to solve this
particular issue: it could be done with a simple burg rule for the old
jit or with few generated instructions with the new IR.

&gt;<i> &gt; - it replaces code generated by the gcc optimizing C compiler with
</I>&gt;<i> &gt; code generated by out JIT,
</I>&gt;<i> &gt;   which is of much lower quality. So even tough we incur a
</I>&gt;<i> &gt; managed-to-native transition
</I>&gt;<i> &gt; overhead by calling native code, we get some (or all) of it back by
</I>&gt;<i> &gt; having gcc compiled code
</I>&gt;<i> &gt;   in the icall.
</I>&gt;<i> 
</I>&gt;<i> I don't believe that methods like UnsafeAddrOfPinnedArrayElement (and
</I>&gt;<i> there are more methods similarly using fields not exposed to corlib that
</I>&gt;<i> could benefit from this as well) could be optimized better by gcc than
</I>&gt;<i> the JIT.
</I>
There are not many cases like UnsafeAddrOfPinnedArrayElement (the
implementation also likely needs security checks, so in the end the
implementation will be more complex and the transition overhead will be
less significant).

&gt;<i> I belive that memcpy for example should be implemented using native
</I>&gt;<i> assembly but it still is implemented in C#.
</I>
For most common cases the current implementation is faster than a
generic memcpy implementation (I tested this at the time by simply using
the libc implementation as managed code).

&gt;<i> I assume you mean OffsetToStringData. When I wanted to implement
</I>&gt;<i> UnsafeAddrOfPinnedArrayElement in mono_emit_inst_for_method it was not
</I>&gt;<i> accepted.
</I>
You needed to introduce your own opcode with the old jit.
With the linear IR switch we can allow implementing more methods and
icalls by emitting multiple instructions instead of a single tree as in
the old code.
Also note another consideration: we'll add special cases only for
methods and icalls that actually have a perf impact is a real
application and so far it doesn't look like
UnsafeAddrOfPinnedArrayElement is a bottleneck (feel free to show us
applications where it is significant). There is no point in adding
complexity to mono for a microbenchmark only.

&gt;<i> Moving OffsetToStringData out of mono_emit_inst_for_method
</I>&gt;<i> seems not to be accepted either.
</I>
Because you added lots of complexity for no gain and slowed down the
code.

&gt;<i> I see OffsetToStringData and UnsafeAddrOfPinnedArrayElement being
</I>&gt;<i> similar in that they do nothing complex just care about internal
</I>&gt;<i> structure details of the runtime.
</I>
Sure, but your OffsetToStringData change makes things worse and
the UnsafeAddrOfPinnedArrayElement change is better done in other ways.

&gt;<i> icall builders are my proposed solution but I'm open to any other
</I>&gt;<i> solution as well.
</I>
See above.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028692.html">[Mono-dev] Ping on nternal call builders
</A></li>
	<LI>Next message: <A HREF="028694.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28693">[ date ]</a>
              <a href="thread.html#28693">[ thread ]</a>
              <a href="subject.html#28693">[ subject ]</a>
              <a href="author.html#28693">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
