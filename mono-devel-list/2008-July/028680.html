<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Ping on nternal call builders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=8cca42d80807290700q3546910eq83c01795b3c9a465%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028674.html">
   <LINK REL="Next"  HREF="028681.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Ping on nternal call builders</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=8cca42d80807290700q3546910eq83c01795b3c9a465%40mail.gmail.com"
       TITLE="[Mono-dev] Ping on nternal call builders">kornelpal at gmail.com
       </A><BR>
    <I>Tue Jul 29 18:35:29 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028674.html">[Mono-dev] Ping on nternal call builders
</A></li>
        <LI>Next message: <A HREF="028681.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28680">[ date ]</a>
              <a href="thread.html#28680">[ thread ]</a>
              <a href="subject.html#28680">[ subject ]</a>
              <a href="author.html#28680">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

&gt;<i> Rodrigo Kumpera wrote:
</I>&gt;<i>  From your email the advantage of the patch is that by replacing some icalls
</I>&gt;<i> with managed code we would get rid of some managed-native transitions.
</I>
The long term goal would be to replace all native icalls with managed
icalls (build by icall builders) that call no native code that could
eliminate all unnecessary managed to native transitions.

&gt;<i> -It makes the new full AOT mode a bit more complicated as these would be 
</I>&gt;<i> another
</I>&gt;<i> kind of wrappers that would need to be AOT'ed.
</I>
The current string constructor hach is implemented using
managed-to-managed wrappers. If that works, there should be no problem
with AOT. But I don't use AOT so I have little experience with it.

&gt;<i> -Increases the footprint by just a bit, as we need to store the icalls 
</I>&gt;<i> internal representation
</I>&gt;<i> as well. The amount of extra code generated is bounded, specially since 
</I>&gt;<i> we replace a
</I>&gt;<i> managed-to-native wrapper with a managed-to-managed with more code. 
</I>
All the three reference implementations implement very small and fast
code blocks and I believe that it's worth to aviod managed to native
transitions. OffsetToStringData is an exception because that is managed
already but I wanted to show that mini_get_inst_for_method could be
replaced by icall builders.

&gt;<i> -JIT time should not change much, but this is only a guess.
</I>
JIT time should be the same as for IL code contained in assemblies. Lots
of our current icalls are native because we couldn't implement them in
C#. Other icalls are native calls because they call external native code
so it's faster to have only one managed to native transition. I don't
think that there are icalls that are in native code because have better
performance than an IL implementation.

&gt;<i> I wonder if it is really an advantage of following this patch as, for 
</I>&gt;<i> example, OffsetToStringData
</I>&gt;<i> has 22 lines in your patch but 6 in the current setup. Of course the 
</I>&gt;<i> code in your patch ends more
</I>&gt;<i> organized and I find it easier to follow, but should be interesting to 
</I>&gt;<i> rear from the others.
</I>
The 22 lines are the builder but that gets executed only once. After
that only the generated (and JITed) code is used. The actual IL code
just returns a constant.

&gt;<i> -For simple methods such as OffsetToStringData the method call overhead 
</I>&gt;<i> might be a killer. We
</I>&gt;<i> should make sure that these new wrappers get a change to be inlined.
</I>
Currently it doesn't get inlined because the JIT has some logic
preventing (at least types) of wrappers being inlined but should be
possible to inline them.

&gt;<i> -I'm not aware of how stack traces behave with wrappers, but are they 
</I>&gt;<i> preserved with your patch?
</I>
As long as they are not inlined the stack trace is preserved. But this
is true for Class Library methods implemented in C# so icall builders
should not be treated differently.

&gt;<i> -Does it work under trunk?
</I>
It should but the patch may be outdated.

&gt;<i> -Do you have performance numbers on your change? Since it changes 
</I>&gt;<i> performance sensitive
</I>&gt;<i> parts of the runtime, attaching a benchmark (or pointing to an existing 
</I>&gt;<i> one) showing the implications is
</I>&gt;<i> fundamental.
</I>
These are only reference implementations and OffsetToStringData for
example is slower for sure because it don't get inlined. I expect string 
.ctors to have the same performance because the generated IL code is the 
same but using icall builder is a clean way as opposed to the current 
hack. UnsafeAddrOfPinnedArrayElement should benefit because no native 
code will be called.

As for OffsetToStringData I don't know whether mini_get_inst_for_method 
or an icall builder is faster when generating the code but using an 
icall builder solves the things at the highest possible level letting 
low level optimizations do their job.

I don't insist on getting these reference icall builder implementations
into trunk I just would like to get approval for the concept and the 
support code of icall builders. Actual icall builder implementations 
could be evaluated independently.

With the attched test I got:
mono r109162: 99060
mono r109162 with my patch: 17375 (5.7x faster)
MS.NET 2.0 SP1: 17898

The imporvement is purely because of the method being implemented in 
managed code. So mono would benefit form icall builders for sure.

The code that decides what to be inlined is too cryptic to me because I 
believe that there are redundant checks against wrappers but if someone 
could enable the inlining of managed-to-managed wrappers icall builders 
could provide even more performance improvement.

I also have attached an updated patch. (Only line numbers were updated 
no code modification was necessary.)

Korn&#233;l

&gt;<i> 2008/7/29 Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i>     Hi,
</I>&gt;<i> 
</I>&gt;<i>     There is a pending patch:
</I>&gt;<i>     <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/2008-June/028291.html">http://lists.ximian.com/pipermail/mono-devel-list/2008-June/028291.html</A>
</I>&gt;<i> 
</I>&gt;<i>     As far as I can remember I didn't get any feedback regarding this patch.
</I>&gt;<i> 
</I>&gt;<i>     Please review the patch. Thanks.
</I>&gt;<i> 
</I>&gt;<i>     Korn&#233;l
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     Mono-devel-list mailing list
</I>&gt;<i>     <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: ICallBuilderPerfTest.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080730/ab3f64c0/attachment-0001.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080730/ab3f64c0/attachment-0001.pl</A> 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: icall_builder.diff.txt
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080730/ab3f64c0/attachment-0001.txt">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080730/ab3f64c0/attachment-0001.txt</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028674.html">[Mono-dev] Ping on nternal call builders
</A></li>
	<LI>Next message: <A HREF="028681.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28680">[ date ]</a>
              <a href="thread.html#28680">[ thread ]</a>
              <a href="subject.html#28680">[ subject ]</a>
              <a href="author.html#28680">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
