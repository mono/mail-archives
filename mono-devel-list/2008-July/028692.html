<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Ping on nternal call builders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=295e750a0807300522x4c7f2bd4h4d76d43d971fe820%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028688.html">
   <LINK REL="Next"  HREF="028693.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Ping on nternal call builders</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=295e750a0807300522x4c7f2bd4h4d76d43d971fe820%40mail.gmail.com"
       TITLE="[Mono-dev] Ping on nternal call builders">kornelpal at gmail.com
       </A><BR>
    <I>Wed Jul 30 12:04:31 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028688.html">[Mono-dev] Ping on nternal call builders
</A></li>
        <LI>Next message: <A HREF="028693.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28692">[ date ]</a>
              <a href="thread.html#28692">[ thread ]</a>
              <a href="subject.html#28692">[ subject ]</a>
              <a href="author.html#28692">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

&gt;<i>Zoltan Varga wrote:
</I>&gt;<i>   This patch replaces a small, fast, simple piece of code
</I>&gt;<i> in mono_emit_inst_for_method () with something far more complex. Also,
</I>
The three icall builders are reference implementations for demonstrating
what icall builders can do. I don't insist on OffsetToStringData being
replaced with an icall builder. Note that however that my tests showed
no difference in executing the code. (I didn't do tests on JIT time.)

&gt;<i> about replacing
</I>&gt;<i> icalls with generated IL code:
</I>&gt;<i> - the code to generate the icalls is usually much bigger and more
</I>&gt;<i> complex than the icall
</I>&gt;<i>   itself.
</I>
That's true but UnsafeAddrOfPinnedArrayElement (that is so simple code
that it should do exactly the same in C and IL) for example was running
5.7x faster and I believe only because of omitting the managed to native
transition.

&gt;<i> - it replaces code generated by the gcc optimizing C compiler with
</I>&gt;<i> code generated by out JIT,
</I>&gt;<i>   which is of much lower quality. So even tough we incur a
</I>&gt;<i> managed-to-native transition
</I>&gt;<i> overhead by calling native code, we get some (or all) of it back by
</I>&gt;<i> having gcc compiled code
</I>&gt;<i>   in the icall.
</I>
I don't believe that methods like UnsafeAddrOfPinnedArrayElement (and
there are more methods similarly using fields not exposed to corlib that
could benefit from this as well) could be optimized better by gcc than
the JIT.

I belive that memcpy for example should be implemented using native
assembly but it still is implemented in C#.

&gt;<i> - as rodrigo said, every new type of wrapper function adds some
</I>&gt;<i> complexity to our AOT
</I>&gt;<i> compiler which has to know about them.
</I>
I have little knowledge about AOT so I don't know how this affects AOT
performance.

&gt;<i> So I'm not against adding the _ability_ to implement icalls in IL, but
</I>&gt;<i> I'm against using it in
</I>&gt;<i> situations where it just makes things more complex.
</I>
I assume you mean OffsetToStringData. When I wanted to implement
UnsafeAddrOfPinnedArrayElement in mono_emit_inst_for_method it was not
accepted. Moving OffsetToStringData out of mono_emit_inst_for_method
seems not to be accepted either.

I see OffsetToStringData and UnsafeAddrOfPinnedArrayElement being
similar in that they do nothing complex just care about internal
structure details of the runtime.

The managed-to-native transition is such a big overhead (at least for
simple icalls) that its worth to implement icalls in IL that don't call
other native functions.

icall builders are my proposed solution but I'm open to any other
solution as well.

Korn&#233;l


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028688.html">[Mono-dev] Ping on nternal call builders
</A></li>
	<LI>Next message: <A HREF="028693.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28692">[ date ]</a>
              <a href="thread.html#28692">[ thread ]</a>
              <a href="subject.html#28692">[ subject ]</a>
              <a href="author.html#28692">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
