<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] New hook for the profiler API
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20hook%20for%20the%20profiler%20API&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028621.html">
   <LINK REL="Next"  HREF="028627.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] New hook for the profiler API</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20New%20hook%20for%20the%20profiler%20API&In-Reply-To="
       TITLE="[Mono-dev] New hook for the profiler API">massi at ximian.com
       </A><BR>
    <I>Tue Jul 22 17:51:36 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028621.html">[Mono-dev] [Mono-patches] r108492 -	in	branches/mono-2-0/mcs/class/System.Web:	System.Web.UI	Test/System.Web.UI
</A></li>
        <LI>Next message: <A HREF="028627.html">[Mono-dev] New hook for the profiler API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28622">[ date ]</a>
              <a href="thread.html#28622">[ thread ]</a>
              <a href="subject.html#28622">[ subject ]</a>
              <a href="author.html#28622">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I think I really cannot fix the profiler init sequence without adding
another hook to the profiler API, to state that the runtime is
&quot;sufficiently initialized&quot; so that mono_thread_attach can be called
safely.

The reason is the following: I must have the profiler initialized and
the writer thread attached before any of the following happens:
- the 1st profiler buffer is empty,
- a true garbage collection occurrs, or
- an image, module or domain is closed (unloaded).
For some reason (which I did not investigate further),
&quot;mono_image_close&quot; is called directly during &quot;mono_assembly_open&quot; when
the argument of &quot;mono_assembly_open&quot; is the xsp2.exe assembly.
So, basically, I must have the profiler writer thread attached before
&quot;mono_assembly_open&quot; returns (on the main assembly).

This is not a race condition problem: I have semaphores in place to
ensure that when I ask the thread to attach, it does so and then I can
go on, so there are no races now.

This is an event ordering issue: I cannot call &quot;mono_thread_attach&quot;
until I have a MonoDomain to pass to it, which should obviously be the
root domain.
However, &quot;mono_get_root_domain&quot; returns NULL until the root domain has
been fully loaded, which is a bit *after* the profiler receives the
&quot;mono_profiler_appdomain_loaded&quot; event from &quot;mono_domain_create&quot;.
I tried to fake it, and use the MonoDomain passed
to &#65279;&quot;mono_profiler_appdomain_loaded&quot; to attach the thread when I receive
this event, but this does not work, ultimately because
&quot;mono_defaults.thread_class&quot; is still NULL.
In the end, it is OK to call &#65279;&quot;mono_thread_attach&quot; only after the
runtime is properly initialized, and this is why I should add this hook.
&#65279;At the beginning I thought the hook should be called at the end of
&quot;mono_init_internal&quot;, but some testing showed that after calling
&quot;mini_init&quot; in driver.c is the right place.

BTW, I thought to initialize the profiler after &quot;mono_init&quot; has returned
(to eliminate the problem at the root), and it could work, but that way
the profiler would miss all the root appdomain initialization events,
and therefore would have no reference to the root appdomain (and its
images) when it will be unloaded, which I don't really like...

Note that this additional hook is really needed to fix the profiler, so
it should go in 2.0 too.

The attached patch shows the hook and its call.

Thoughts?
  Massi

-------------- next part --------------
A non-text attachment was scrubbed...
Name: runtime-initialized-hook.patch
Type: text/x-patch
Size: 2821 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080722/28310131/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080722/28310131/attachment.bin</A> 
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028621.html">[Mono-dev] [Mono-patches] r108492 -	in	branches/mono-2-0/mcs/class/System.Web:	System.Web.UI	Test/System.Web.UI
</A></li>
	<LI>Next message: <A HREF="028627.html">[Mono-dev] New hook for the profiler API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28622">[ date ]</a>
              <a href="thread.html#28622">[ thread ]</a>
              <a href="subject.html#28622">[ subject ]</a>
              <a href="author.html#28622">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
