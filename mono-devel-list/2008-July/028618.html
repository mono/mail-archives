<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Mono-patches] r108492 - in	branches/mono-2-0/mcs/class/System.Web:	System.Web.UI	Test/System.Web.UI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20r108492%20-%20in%0A%09branches/mono-2-0/mcs/class/System.Web%3A%09System.Web.UI%0A%09Test/System.Web.UI&In-Reply-To=20080722182047.A963E9472C%40mono-cvs.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028614.html">
   <LINK REL="Next"  HREF="028619.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Mono-patches] r108492 - in	branches/mono-2-0/mcs/class/System.Web:	System.Web.UI	Test/System.Web.UI</H1>
    <B>Gert Driesen</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20r108492%20-%20in%0A%09branches/mono-2-0/mcs/class/System.Web%3A%09System.Web.UI%0A%09Test/System.Web.UI&In-Reply-To=20080722182047.A963E9472C%40mono-cvs.ximian.com"
       TITLE="[Mono-dev] [Mono-patches] r108492 - in	branches/mono-2-0/mcs/class/System.Web:	System.Web.UI	Test/System.Web.UI">gert.driesen at telenet.be
       </A><BR>
    <I>Tue Jul 22 15:12:03 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028614.html">[Mono-dev] The current state of assebly signing
</A></li>
        <LI>Next message: <A HREF="028619.html">[Mono-dev] [Mono-patches] r108492 - in branches/mono-2-0/mcs/class/System.Web: System.Web.UI Test/System.Web.UI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28618">[ date ]</a>
              <a href="thread.html#28618">[ thread ]</a>
              <a href="subject.html#28618">[ subject ]</a>
              <a href="author.html#28618">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Dean,

Was this change approved for the 2.0 branch, or did you commit it to the
branch by accident?

Also, your patch was not complete; Stream.Length can/will also throw a
NotSupportedException when the stream is unseekable. I'll commit a slighty
modified version to SVN HEAD in a few minutes.

Gert

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-bounces at lists.ximian.com</A>] On Behalf Of Dean Brettle
(<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dean at brettle.com</A>)
Sent: dinsdag 22 juli 2008 20:21
To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches at lists.ximian.com</A>; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ximian.monolist at gmail.com</A>;
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-svn-patches-garchive-20758 at googlegroups.com</A>
Subject: [Mono-patches] r108492 - in branches/mono-2-0/mcs/class/System.Web:
System.Web.UI Test/System.Web.UI

Author: deanb
Date: 2008-07-22 14:20:47 -0400 (Tue, 22 Jul 2008)
New Revision: 108492

Modified:
   branches/mono-2-0/mcs/class/System.Web/System.Web.UI/ChangeLog
   branches/mono-2-0/mcs/class/System.Web/System.Web.UI/LosFormatter.cs
   branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/ChangeLog
 
branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/LosFormatterTest.c
s
Log:
++ Test/System.Web.UI/ChangeLog	(working copy)

	* LosFormatterTest.cs: added test for bug 411115 where passing an
	unseekable stream to LosFormatter.Deserialize() causes an exception.

++ System.Web.UI/ChangeLog	(working copy)

	* LosFormatter.cs: fixed bug 411115 where passing an unseekable 
	stream to LosFormatter.Deserialize() causes an exception.



Modified: branches/mono-2-0/mcs/class/System.Web/System.Web.UI/ChangeLog
===================================================================
--- branches/mono-2-0/mcs/class/System.Web/System.Web.UI/ChangeLog
2008-07-22 17:35:55 UTC (rev 108491)
+++ branches/mono-2-0/mcs/class/System.Web/System.Web.UI/ChangeLog
2008-07-22 18:20:47 UTC (rev 108492)
@@ -1,3 +1,8 @@
+2008-07-22  Dean Brettle &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dean at brettle.com</A>&gt;
+
+	* LosFormatter.cs: fixed bug 411115 where passing an unseekable 
+	stream to LosFormatter.Deserialize() causes an exception.
+
 2008-07-14  Marek Habersack  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mhabersack at novell.com</A>&gt;
 
 	* Page.cs: fix the failing tests by moving the form

Modified:
branches/mono-2-0/mcs/class/System.Web/System.Web.UI/LosFormatter.cs
===================================================================
--- branches/mono-2-0/mcs/class/System.Web/System.Web.UI/LosFormatter.cs
2008-07-22 17:35:55 UTC (rev 108491)
+++ branches/mono-2-0/mcs/class/System.Web/System.Web.UI/LosFormatter.cs
2008-07-22 18:20:47 UTC (rev 108492)
@@ -70,8 +70,10 @@
 		{
 			if (stream == null)
 				throw new ArgumentNullException (&quot;stream&quot;);
-
-			byte [] bytes = new byte [stream.Length &gt;= 0 ?
stream.Length : 2048];
+			long streamLength = -1;
+			if (stream.CanSeek)
+				streamLength = stream.Length;
+			byte [] bytes = new byte [streamLength &gt;= 0 ?
streamLength : 2048];
 			MemoryStream ms = null;
 			if ((stream is MemoryStream) &amp;&amp; stream.Position ==
0) {
 				// We save allocating a new stream and
reading in this case.

Modified:
branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/ChangeLog
===================================================================
--- branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/ChangeLog
2008-07-22 17:35:55 UTC (rev 108491)
+++ branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/ChangeLog
2008-07-22 18:20:47 UTC (rev 108492)
@@ -1,3 +1,8 @@
+2008-07-22  Dean Brettle &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">dean at brettle.com</A>&gt;
+
+	* LosFormatterTest.cs: added test for bug 411115 where passing an
+	unseekable stream to LosFormatter.Deserialize() causes an exception.
+
 2008-06-14  Gert Driesen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">drieseng at users.sourceforge.net</A>&gt;
 
 	* PageTest.cs: Fixed compile error on MS (as it does not list the

Modified:
branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/LosFormatterTest.c
s
===================================================================
---
branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/LosFormatterTest.c
s	2008-07-22 17:35:55 UTC (rev 108491)
+++
branches/mono-2-0/mcs/class/System.Web/Test/System.Web.UI/LosFormatterTest.c
s	2008-07-22 18:20:47 UTC (rev 108492)
@@ -146,5 +146,34 @@
 			Assert.AreEqual (string.Empty, s1, &quot;#2&quot;);
 #endif
 		}
+
+		[Test] // bug #4111115
+		public void Deserialize_Unseekable ()
+		{
+			string s = &quot;Hello world&quot;;
+			LosFormatter lf = new LosFormatter ();
+			MemoryStream ms = new MemoryStream ();
+			lf.Serialize (ms, s);
+			byte[] serializedBytes = ms.ToArray();
+			UnseekableMemoryStream ums 
+				= new
UnseekableMemoryStream(serializedBytes, 0, serializedBytes.Length, false,
true);
+			string s2 = lf.Deserialize (ums) as string;
+			Assert.IsNotNull (s2, &quot;#1&quot;);
+			Assert.AreEqual (s, s2, &quot;#2&quot;);
+		}
+
+		class UnseekableMemoryStream : MemoryStream
+		{
+			public UnseekableMemoryStream(byte[] byteArray, int
index, int count, 
+			                              bool writable, bool
publiclyVisible) 
+				: base(byteArray, index, count, writable,
publiclyVisible)
+			{
+			}
+			
+			public override bool CanSeek {
+				get { return false; }
+			}				
+		}
+
 	}
 }

_______________________________________________
Mono-patches maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>

</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028614.html">[Mono-dev] The current state of assebly signing
</A></li>
	<LI>Next message: <A HREF="028619.html">[Mono-dev] [Mono-patches] r108492 - in branches/mono-2-0/mcs/class/System.Web: System.Web.UI Test/System.Web.UI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28618">[ date ]</a>
              <a href="thread.html#28618">[ thread ]</a>
              <a href="subject.html#28618">[ subject ]</a>
              <a href="author.html#28618">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
