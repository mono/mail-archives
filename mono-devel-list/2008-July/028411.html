<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] HttpListener hangs with r106513
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20HttpListener%20hangs%20with%20r106513&In-Reply-To=1214348675.14476.10.camel%40localhost">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028467.html">
   <LINK REL="Next"  HREF="028413.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] HttpListener hangs with r106513</H1>
    <B>Gert Driesen</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20HttpListener%20hangs%20with%20r106513&In-Reply-To=1214348675.14476.10.camel%40localhost"
       TITLE="[Mono-dev] HttpListener hangs with r106513">gert.driesen at telenet.be
       </A><BR>
    <I>Thu Jul  3 04:44:36 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028467.html">[Mono-dev] One Version of Mono.Cairo
</A></li>
        <LI>Next message: <A HREF="028413.html">[Mono-dev] HttpListener hangs with r106513
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28411">[ date ]</a>
              <a href="thread.html#28411">[ thread ]</a>
              <a href="subject.html#28411">[ subject ]</a>
              <a href="author.html#28411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Casey,

Miguel prepared a fix for this issue (committed by Martin in r107127), and
I've added a unit test based on your repro.

Gert

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] On Behalf Of Casey
Marshall
Sent: woensdag 25 juni 2008 1:05
To: mono-devel
Subject: [Mono-dev] HttpListener hangs with r106513

I've noticed that it recent SVN mono snapshots (r106513) using
HttpListener and WebRequest in the same process hangs. This doesn't hang
with 1.9.1, and didn't with less recent snapshots.

I haven't tried having the client and server in different processes, and
don't know if it reproduces there.

Test case:


using System;
using System.IO;
using System.Net;
using System.Threading;

class simplehttp
{
        public static void Main(string[] argv)
        {
                simplehttp sh = new simplehttp();
                Thread srv = new Thread(new ThreadStart(sh.ServerMain));
                srv.Name = &quot;HttpServer&quot;;
                srv.Start();

                for (;;)
                {
                        HttpWebRequest req = (HttpWebRequest)
WebRequest.Create (&quot;<A HREF="http://localhost:8888/foobar/&quot;">http://localhost:8888/foobar/&quot;</A>);
                        req.ServicePoint.Expect100Continue = false;
                        req.ServicePoint.UseNagleAlgorithm = false;
                        req.Method = &quot;POST&quot;;
                        StreamWriter w = new
StreamWriter(req.GetRequestStream());
                        w.WriteLine(&quot;Hello, server!&quot;);
                        w.Close();

                        HttpWebResponse resp = (HttpWebResponse)
req.GetResponse();
                        StreamReader r = new
StreamReader(resp.GetResponseStream());
                        System.Console.WriteLine(&quot;client reads: {0}&quot;,
r.ReadToEnd());
                        r.Close();
                }
        }

        private void ServerMain()
        {
                HttpListener listener = new HttpListener();
                listener.Prefixes.Add(&quot;<A HREF="http://*:8888/foobar/&quot;">http://*:8888/foobar/&quot;</A>);
                listener.Start();
                while (true)
                {
                        HttpListenerContext ctx = listener.GetContext();
                        ThreadPool.QueueUserWorkItem(new
WaitCallback(HandleConnection), ctx);
                }
        }

        private void HandleConnection(object state)
        {
                HttpListenerContext ctx = (HttpListenerContext) state;
                HttpListenerRequest req = ctx.Request;
                StreamReader r = new StreamReader(req.InputStream);
                System.Console.WriteLine (&quot;server reads {0}&quot;,
r.ReadToEnd());

                HttpListenerResponse resp = ctx.Response;
                StreamWriter o = new StreamWriter(resp.OutputStream);
                o.WriteLine(&quot;Hello, world!&quot;);
                o.Close();
        }
}

Thanks.
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028467.html">[Mono-dev] One Version of Mono.Cairo
</A></li>
	<LI>Next message: <A HREF="028413.html">[Mono-dev] HttpListener hangs with r106513
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28411">[ date ]</a>
              <a href="thread.html#28411">[ thread ]</a>
              <a href="subject.html#28411">[ subject ]</a>
              <a href="author.html#28411">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
