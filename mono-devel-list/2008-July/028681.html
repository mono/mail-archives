<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Ping on nternal call builders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=488F9B31.6010309%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028680.html">
   <LINK REL="Next"  HREF="028682.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Ping on nternal call builders</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Ping%20on%20nternal%20call%20builders&In-Reply-To=488F9B31.6010309%40gmail.com"
       TITLE="[Mono-dev] Ping on nternal call builders">kumpera at gmail.com
       </A><BR>
    <I>Tue Jul 29 19:48:55 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028680.html">[Mono-dev] Ping on nternal call builders
</A></li>
        <LI>Next message: <A HREF="028682.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28681">[ date ]</a>
              <a href="thread.html#28681">[ thread ]</a>
              <a href="subject.html#28681">[ subject ]</a>
              <a href="author.html#28681">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Jul 29, 2008 at 7:35 PM, Korn&#233;l P&#225;l &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt; wrote:

 -For simple methods such as OffsetToStringData the method call overhead
&gt;<i> might be a killer. We
</I>&gt;<i> should make sure that these new wrappers get a change to be inlined.
</I>&gt;<i>
</I>
Currently it doesn't get inlined because the JIT has some logic
&gt;<i> preventing (at least types) of wrappers being inlined but should be
</I>&gt;<i> possible to inline them.
</I>&gt;<i>
</I>&gt;<i>  -I'm not aware of how stack traces behave with wrappers, but are they
</I>&gt;&gt;<i> preserved with your patch?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> As long as they are not inlined the stack trace is preserved. But this
</I>&gt;<i> is true for Class Library methods implemented in C# so icall builders
</I>&gt;<i> should not be treated differently.
</I>&gt;<i>
</I>&gt;<i>  -Does it work under trunk?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It should but the patch may be outdated.
</I>&gt;<i>
</I>&gt;<i>  -Do you have performance numbers on your change? Since it changes
</I>&gt;&gt;<i> performance sensitive
</I>&gt;&gt;<i> parts of the runtime, attaching a benchmark (or pointing to an existing
</I>&gt;&gt;<i> one) showing the implications is
</I>&gt;&gt;<i> fundamental.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These are only reference implementations and OffsetToStringData for
</I>&gt;<i> example is slower for sure because it don't get inlined. I expect string
</I>&gt;<i> .ctors to have the same performance because the generated IL code is the
</I>&gt;<i> same but using icall builder is a clean way as opposed to the current hack.
</I>&gt;<i> UnsafeAddrOfPinnedArrayElement should benefit because no native code will be
</I>&gt;<i> called.
</I>&gt;<i>
</I>&gt;<i> As for OffsetToStringData I don't know whether mini_get_inst_for_method or
</I>&gt;<i> an icall builder is faster when generating the code but using an icall
</I>&gt;<i> builder solves the things at the highest possible level letting low level
</I>&gt;<i> optimizations do their job.
</I>&gt;<i>
</I>&gt;<i> I don't insist on getting these reference icall builder implementations
</I>&gt;<i> into trunk I just would like to get approval for the concept and the
</I>&gt;<i> support code of icall builders. Actual icall builder implementations could
</I>&gt;<i> be evaluated independently.
</I>&gt;<i>
</I>&gt;<i> With the attched test I got:
</I>&gt;<i> mono r109162: 99060
</I>&gt;<i> mono r109162 with my patch: 17375 (5.7x faster)
</I>&gt;<i> MS.NET 2.0 SP1: 17898
</I>&gt;<i>
</I>&gt;<i> The imporvement is purely because of the method being implemented in
</I>&gt;<i> managed code. So mono would benefit form icall builders for sure.
</I>&gt;<i>
</I>&gt;<i> The code that decides what to be inlined is too cryptic to me because I
</I>&gt;<i> believe that there are redundant checks against wrappers but if someone
</I>&gt;<i> could enable the inlining of managed-to-managed wrappers icall builders
</I>&gt;<i> could provide even more performance improvement.
</I>&gt;<i>
</I>
&gt;<i> I also have attached an updated patch. (Only line numbers were updated no
</I>&gt;<i> code modification was necessary.)
</I>&gt;<i>
</I>&gt;<i>
</I>Making those wrappers inlineable should be straight forward, just add a
mono_marshal_is_managed_icall that checks this info and verify for it in
mono_method_check_inlining and in the code_block that activates inlining for
CEE_CALL. I don't understand the particularities of wrappers, so it might
not be a good idea making all M2M wrapper inlinable. Other than that, it
might be interesting to have support to force it on some of then as well.

Other option is to kill the inline_info bit in MonoMethod and use the space
for a force_inline bit. inline_info can easily be replaced by a hash table
in mini.c. This would be more general and useful.

I like the idea of having some intrinsics expressed as IL instead of the
mini_get_inst_for_method mess. Maybe we should move to use this model and
just leave the icall machine as it currently is.

I think this patch is really nice, so unless someone else opposes to it we
should move forward to put it into commit shape - split the patch in a few
smaller ones: one with just the new icall machinery, other adding the
inlining behavior changes and finally another one with the converted icalls
of your patch.


Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080729/72973d77/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080729/72973d77/attachment.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028680.html">[Mono-dev] Ping on nternal call builders
</A></li>
	<LI>Next message: <A HREF="028682.html">[Mono-dev] Ping on nternal call builders
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28681">[ date ]</a>
              <a href="thread.html#28681">[ thread ]</a>
              <a href="subject.html#28681">[ subject ]</a>
              <a href="author.html#28681">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
