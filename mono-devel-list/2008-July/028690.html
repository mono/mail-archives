<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [Mono-patches] r109263	-	trunk/mcs/class/System.Data/System.Data
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20r109263%0A%09-%09trunk/mcs/class/System.Data/System.Data&In-Reply-To=8cca42d80807300726x55bf7058k85f00490faa517af%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028689.html">
   <LINK REL="Next"  HREF="028691.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [Mono-patches] r109263	-	trunk/mcs/class/System.Data/System.Data</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BMono-patches%5D%20r109263%0A%09-%09trunk/mcs/class/System.Data/System.Data&In-Reply-To=8cca42d80807300726x55bf7058k85f00490faa517af%40mail.gmail.com"
       TITLE="[Mono-dev] [Mono-patches] r109263	-	trunk/mcs/class/System.Data/System.Data">atsushi at ximian.com
       </A><BR>
    <I>Wed Jul 30 11:03:17 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028689.html">[Mono-dev] [Mono-patches] r109263 -	trunk/mcs/class/System.Data/System.Data
</A></li>
        <LI>Next message: <A HREF="028691.html">[Mono-dev] Mono port for AIX and PASE on IBM i
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28690">[ date ]</a>
              <a href="thread.html#28690">[ thread ]</a>
              <a href="subject.html#28690">[ subject ]</a>
              <a href="author.html#28690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

I tried the repro case on that bug and verified it works under .NET.
Then I removed the parameterless constructor. .NET borked.

That means, instead of using XmlReader.ReadContentAsObject(),
you would simply write like below.

--------
IXmlSerializable x = (IXmlSerializable) Activator.CreateInstance (
   col.DataType, new object [0]);
if (!reader.IsEmptyElement) {
   reader.ReadStartElement ();
   reader.MoveToContent ();
   x.ReadXml (reader);
   reader.ReadEndElement ();
}
else
   reader.Skip ();
row [col] = x; // not sure if it is filled in case of empty element...
--------

Atsushi Eno


Rodrigo Kumpera wrote:
&gt;<i> Varadhan,
</I>&gt;<i> 
</I>&gt;<i> Depending on exception on regular paths might lead to disastrous 
</I>&gt;<i> performance.
</I>&gt;<i> Is this just a corner case for compatibility or this kind of situation 
</I>&gt;<i> might happen often?
</I>&gt;<i> We might need to document this shortcoming of our stack.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Rodrigo
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Wed, Jul 30, 2008 at 10:56 AM, Veerapuram Varadhan 
</I>&gt;<i> (<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vvaradhan at novell.com</A> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vvaradhan at novell.com</A>&gt;) 
</I>&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-list at lists.ximian.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-patches-list at lists.ximian.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     Author: varadhan
</I>&gt;<i>     Date: 2008-07-30 09:56:01 -0400 (Wed, 30 Jul 2008)
</I>&gt;<i>     New Revision: 109263
</I>&gt;<i> 
</I>&gt;<i>     Modified:
</I>&gt;<i>       trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i>       trunk/mcs/class/System.Data/System.Data/XmlDataReader.cs
</I>&gt;<i>     Log:
</I>&gt;<i>     Fixes##377146 - handle custom reference types sanely when reading from
</I>&gt;<i>     an XML file
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Modified: trunk/mcs/class/System.Data/System.Data/ChangeLog
</I>&gt;<i>     ===================================================================
</I>&gt;<i>     --- trunk/mcs/class/System.Data/System.Data/ChangeLog   2008-07-30
</I>&gt;<i>     13:40:00 UTC (rev 109262)
</I>&gt;<i>     +++ trunk/mcs/class/System.Data/System.Data/ChangeLog   2008-07-30
</I>&gt;<i>     13:56:01 UTC (rev 109263)
</I>&gt;<i>     @@ -1,3 +1,8 @@
</I>&gt;<i>     +2008-07-29  Veerapuram Varadhan  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vvaradhan at novell.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">vvaradhan at novell.com</A>&gt;&gt;
</I>&gt;<i>     +
</I>&gt;<i>     +       Fixes ##377146
</I>&gt;<i>     +       * XmlDataReader.cs (ReadElementElement): Handle custom
</I>&gt;<i>     reference types sanely.
</I>&gt;<i>     +
</I>&gt;<i>      2008-07-20  Gert Driesen  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">drieseng at users.sourceforge.net</A>
</I>&gt;<i>     &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">drieseng at users.sourceforge.net</A>&gt;&gt;
</I>&gt;<i> 
</I>&gt;<i>            * DataColumnCollection.cs (IndexOf): Include name of column -
</I>&gt;<i>     for which
</I>&gt;<i> 
</I>&gt;<i>     Modified: trunk/mcs/class/System.Data/System.Data/XmlDataReader.cs
</I>&gt;<i>     ===================================================================
</I>&gt;<i>     --- trunk/mcs/class/System.Data/System.Data/XmlDataReader.cs  
</I>&gt;<i>      2008-07-30 13:40:00 UTC (rev 109262)
</I>&gt;<i>     +++ trunk/mcs/class/System.Data/System.Data/XmlDataReader.cs  
</I>&gt;<i>      2008-07-30 13:56:01 UTC (rev 109263)
</I>&gt;<i>     @@ -26,6 +26,7 @@
</I>&gt;<i>      using System.IO;
</I>&gt;<i>      using System.Data;
</I>&gt;<i>      using System.Xml;
</I>&gt;<i>     +using System.Xml.Serialization;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      namespace System.Data
</I>&gt;<i>     @@ -297,7 +298,27 @@
</I>&gt;<i> 
</I>&gt;<i>                                    bool wasEmpty = reader.IsEmptyElement;
</I>&gt;<i>                                    int depth = reader.Depth;
</I>&gt;<i>     -                               row [col] = StringToObject
</I>&gt;<i>     (col.DataType, reader.ReadElementString ());
</I>&gt;<i>     +
</I>&gt;<i>     +                               if (typeof
</I>&gt;<i>     (IXmlSerializable).IsAssignableFrom (col.DataType)) {
</I>&gt;<i>     +#if NET_2_0
</I>&gt;<i>     +                                       try {
</I>&gt;<i>     +                                               // NOTE:
</I>&gt;<i>     ReadElementString works fine with proper XML with CDATA etc,
</I>&gt;<i>     +                                               // however doesn't
</I>&gt;<i>     behave well with XMLs like the one in
</I>&gt;<i>     +                                               //
</I>&gt;<i>     <A HREF="https://bugzilla.novell.com/show_bug.cgi?id=377146">https://bugzilla.novell.com/show_bug.cgi?id=377146</A> which is
</I>&gt;<i>     +                                               // apparently
</I>&gt;<i>     supported by MS.NET &lt;<A HREF="http://MS.NET">http://MS.NET</A>&gt; - to maintain compatibility,
</I>&gt;<i>     +                                               // Try reading the
</I>&gt;<i>     element content as an object type
</I>&gt;<i>     +                                               row [col] =
</I>&gt;<i>     reader.ReadContentAsObject ();
</I>&gt;<i>     +                                       } catch {
</I>&gt;<i>     +#endif
</I>&gt;<i>     +                                               // XML is not in
</I>&gt;<i>     accordance to expected standards, try reading the content as an xml doc
</I>&gt;<i>     +                                               row [col] =
</I>&gt;<i>     reader.ReadInnerXml ();
</I>&gt;<i>     +#if NET_2_0
</I>&gt;<i>     +                                       }
</I>&gt;<i>     +#endif
</I>&gt;<i>     +                               } else {
</I>&gt;<i>     +                                       row [col] = StringToObject
</I>&gt;<i>     (col.DataType, reader.ReadElementString ());
</I>&gt;<i>     +                               }
</I>&gt;<i>     +
</I>&gt;<i>                                    if (!wasEmpty &amp;&amp; reader.Depth &gt; depth) {
</I>&gt;<i>                                    // This means, instance does not
</I>&gt;<i>     match with
</I>&gt;<i>                                    // the schema (because the instance
</I>&gt;<i>     element
</I>&gt;<i> 
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     Mono-patches maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-patches at lists.ximian.com</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.ximian.com/mailman/listinfo/mono-patches">http://lists.ximian.com/mailman/listinfo/mono-patches</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028689.html">[Mono-dev] [Mono-patches] r109263 -	trunk/mcs/class/System.Data/System.Data
</A></li>
	<LI>Next message: <A HREF="028691.html">[Mono-dev] Mono port for AIX and PASE on IBM i
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28690">[ date ]</a>
              <a href="thread.html#28690">[ thread ]</a>
              <a href="subject.html#28690">[ subject ]</a>
              <a href="author.html#28690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
