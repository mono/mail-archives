<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] malloc and free on CLI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20malloc%20and%20free%20on%20CLI&In-Reply-To=20050718092629.GM9882%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013201.html">
   <LINK REL="Next"  HREF="013236.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] malloc and free on CLI</H1>
    <B>Massimiliano Mantione</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20malloc%20and%20free%20on%20CLI&In-Reply-To=20050718092629.GM9882%40debian.org"
       TITLE="[Mono-devel-list] malloc and free on CLI">massi at ximian.com
       </A><BR>
    <I>Tue Jul 19 01:56:54 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013201.html">[Mono-devel-list] malloc and free on CLI
</A></li>
        <LI>Next message: <A HREF="013236.html">[Mono-devel-list] malloc and free on CLI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13221">[ date ]</a>
              <a href="thread.html#13221">[ thread ]</a>
              <a href="subject.html#13221">[ subject ]</a>
              <a href="author.html#13221">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Mon, 2005-07-18 at 11:26 +0200, Paolo Molaro wrote:
&gt;<i> Icalls are completely out of the question
</I>&gt;<i> as an implementation for this.
</I>
Happy to hear this!

&gt;<i> The managed C compiler should implement two patterns, both of which
</I>&gt;<i> are required:
</I>&gt;<i> 1) map a function call to a dllimport
</I>&gt;<i> 2) map a function call to corlib/System/ManagedLibc methods
</I>
This makes sense, and I would add (maybe it was implied) that case
2 includes any kind of managed code, including any C library that
has been compiled into a managed dll.

Later on you describe a way of using C attributes to specify how
to resolve the two kinds of mapping.
I agree this should be done, but IMHO another way should also be
provided.

Think of the following scenario: a library (say zlib) is compiled
to managed code (so we have zlib.dll).
Another existing C program that we want to compile to managed code
uses zlib (which means its sources include the zlib headers).
Now, the zlib headers do not contain any mapping attribute (and
IMHO they should stay as they are), so we need another way to tell
the C compiler how to map those calls.
I presume the C compiler generates a class with a lot of static
methods, one for each C function.
One easy way to specify the mapping outside of the header files
would be to tell the compiler &quot;all the static methods of these
classes are managed C functions, and they have precedence over
their unmanaged dllimported ones&quot;.
Since the C namespace (for linking) is flat, this should work very
well.
An even easier approach would be having a way to tell, in a given
dll, all the managed C functions it contains.
This way, in the above example, it would be enough to tell the
compiler &quot;use zlib.dll&quot;; the compiler should populate the symbol
table with all the C declarations that it can extract from the dll
metadata, and when it later parses the zlib headers, it knows it
must apply the &quot;managed call&quot; mapping style.

I hope I explained the point clearly ;-)

And by the way, I totally agree with Paolo on the issues (risks) of
having two function implementations (one managed and one unmanaged).
This can easily get trickier than expected.
For instance, in the above example, imagine that the program also
depends on another C library (libfoo.so), that for some reason will
not be compiled to managed code.
Suppose that also foo uses zlib (why not?), and suppose that the
program passes zlib &quot;compressed streams&quot; to foo calls...
I think you get the point: if the behavior of zlib.dll and libzlib.so
calls is not *exactly* the same, you'll get all sort of bugs.
By *exactly* the same I in the end mean ABI compatible: structure
layouts, eventual use of static variables... ok, marshalling was
invented to solve these issues, but the above scenario seems messy
anyway to me.

Ciao,
  Massi



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013201.html">[Mono-devel-list] malloc and free on CLI
</A></li>
	<LI>Next message: <A HREF="013236.html">[Mono-devel-list] malloc and free on CLI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13221">[ date ]</a>
              <a href="thread.html#13221">[ thread ]</a>
              <a href="subject.html#13221">[ subject ]</a>
              <a href="author.html#13221">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
