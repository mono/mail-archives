<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20mono%20AES%20performance%20woes%20%28was%3A%20poor%20PPC%20JIT%0A%09output%29&In-Reply-To=56B4A17A-757A-4CD0-9DDC-EC1F15BBA3F2%40counterpop.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013213.html">
   <LINK REL="Next"  HREF="013222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20mono%20AES%20performance%20woes%20%28was%3A%20poor%20PPC%20JIT%0A%09output%29&In-Reply-To=56B4A17A-757A-4CD0-9DDC-EC1F15BBA3F2%40counterpop.net"
       TITLE="[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)">vargaz at gmail.com
       </A><BR>
    <I>Mon Jul 18 15:29:48 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013213.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
        <LI>Next message: <A HREF="013222.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13214">[ date ]</a>
              <a href="thread.html#13214">[ thread ]</a>
              <a href="subject.html#13214">[ subject ]</a>
              <a href="author.html#13214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>                                  Hi,

  This has been fixed in SVN, so you no longer need to call mono_set_defaults
(which isn't in the public headers anyway).

                     Zoltan

On 7/18/05, Allan Hsu &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">allan at counterpop.net</A>&gt; wrote:
&gt;<i> On Jul 18, 2005, at 2:59 AM, Paolo Molaro wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; On 07/15/05 Allan Hsu wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Is there any reference on what sorts of things you can change using
</I>&gt;<i> &gt;&gt; mono_set_defaults? Following the mono source for references to that
</I>&gt;<i> &gt;&gt; function wasn't particularly enlightening. It would be useful if the
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; grep mono_set_defaults *.c
</I>&gt;<i> &gt; mini.c:mono_set_defaults (int verbose_level, guint32 opts)
</I>&gt;<i> &gt; Should be pretty evident. Just always use the result of
</I>&gt;<i> &gt; mono_parse_default_optimizations (NULL) as the opts value.
</I>&gt;<i> 
</I>&gt;<i> I understood the verbose_level parameters, but the opts parameter was
</I>&gt;<i> what mystified me. I should have been more specific about what I was
</I>&gt;<i> looking for. At the time, I didn't understand the value that
</I>&gt;<i> mono_parse_default_optimizations() returns or what values you can
</I>&gt;<i> pass in to affect it. I've since traced it back to the relevant code
</I>&gt;<i> in driver.c and the mini-X.c platform code now and see how it works.
</I>&gt;<i> Is it safe to mess with those parameters, or will it cause undefined
</I>&gt;<i> results?
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; To be fair, the native implementation is able to take advantage of
</I>&gt;<i> &gt;&gt; 64-
</I>&gt;<i> &gt;&gt; bit processors when available, while all mono builds in the above
</I>&gt;<i> &gt;&gt; benchmarks are 32-bit. The Windows XP machine is the standard 32-bit
</I>&gt;<i> &gt;&gt; install, even though the processor is 64-bit. This is a pretty
</I>&gt;<i> &gt;&gt; informal benchmark, but all I'm interested in showing here is how bad
</I>&gt;<i> &gt;&gt; the AES performance under mono is.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The current implementation causes lots of spilling and other
</I>&gt;<i> &gt; unnecessary work which the jit doesn't remove (the work massi is
</I>&gt;<i> &gt; doing should improve this). Some parts of it can be easily changed
</I>&gt;<i> &gt; to use unsafe code and that should improve performance a lot: I'll
</I>&gt;<i> &gt; leave
</I>&gt;<i> &gt; that to Sebastien:-)
</I>&gt;<i> 
</I>&gt;<i> This is good to hear. I hope the benchmarking I did will provide some
</I>&gt;<i> information that somebody will find useful.
</I>&gt;<i> 
</I>&gt;<i> For my specific application, there is no such thing as &quot;enough&quot;
</I>&gt;<i> performance:) I plan on writing a managed wrapper around libcrypto
</I>&gt;<i> for this reason. This will be the subject of another email.
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;&gt; Some of the data looks definitely bogus: it reports a stall even on
</I>&gt;<i> &gt;&gt;&gt; the addi, here:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;    0x2e143c8 lwz      r4,32(r1)    3:1 Stall=2
</I>&gt;<i> &gt;&gt;&gt;    0x2e143cc lwz      r5,12(r4)    3:1 Stall=2
</I>&gt;<i> &gt;&gt;&gt;    0x2e143d0 cmplwi   r5,0x0000     3:1 Stall=2
</I>&gt;<i> &gt;&gt;&gt;    0x2e143d4 blel     $+696 &lt;0x2e1468c [8B]&gt;    2:1
</I>&gt;<i> &gt;&gt;&gt; 0.4%    0x2e143d8 addi     r4,r4,16     2:1 Stall=1
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt; [...]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; As for the stall statistics, you have misread them. Each line that
</I>&gt;<i> &gt;&gt; says &quot;Stall=N&quot; is saying that the instruction latency of the marked
</I>&gt;<i> &gt;&gt; instruction will cause a subsequent dependent instruction to stall,
</I>&gt;<i> &gt;&gt; not that the marked instruction itself will stall. N is the maximum
</I>&gt;<i> &gt;&gt; number of stall cycles for the nearest dependent instruction. The
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Since the tool reports that the addi stalls only sometimes (check the
</I>&gt;<i> &gt; similar code sequences where no stall is reported), my take
</I>&gt;<i> &gt; is that your interpretation or the data reported is not correct.
</I>&gt;<i> 
</I>&gt;<i> I'm not sure if my meaning came across. The line next to the addi
</I>&gt;<i> instruction that says &quot;Stall=1&quot; means that a dependent instruction
</I>&gt;<i> *following* the addi looks like it will stall while waiting for the
</I>&gt;<i> results from addi, not that the addi instruction itself will stall.
</I>&gt;<i> The code that follows that specific instruction looks like this:
</I>&gt;<i> 
</I>&gt;<i> 0.4%    0x2e143d8     addi     r4,r4,16    2:1        Stall=1
</I>&gt;<i>      0x2e143dc     lbz      r4,0(r4)    3:1        Stall=2
</I>&gt;<i>      0x2e143e0     add      r3,r3,r4    2:1        Stall=1
</I>&gt;<i>      0x2e143e4     stw      r3,44(r1)    3:1
</I>&gt;<i> 
</I>&gt;<i> The instruction latency of the addi instruction is 2 cycles; the lbz
</I>&gt;<i> that immediately follows the addi is dependent on the addi. The lbz
</I>&gt;<i> will stall for 1 cycle. That is what the Shark output is trying to say.
</I>&gt;<i> 
</I>&gt;<i>      -Allan
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Allan Hsu &lt;allan at counterpop dot net&gt;
</I>&gt;<i> 1E64 E20F 34D9 CBA7 1300  1457 AC37 CBBB 0E92 C779
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013213.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
	<LI>Next message: <A HREF="013222.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13214">[ date ]</a>
              <a href="thread.html#13214">[ thread ]</a>
              <a href="subject.html#13214">[ subject ]</a>
              <a href="author.html#13214">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
