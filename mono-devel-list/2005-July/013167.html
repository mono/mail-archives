<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] poor PPC JIT output
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20poor%20PPC%20JIT%20output&In-Reply-To=B6CE9681-9C0E-46AE-8DE9-19BA46018F0B%40counterpop.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013164.html">
   <LINK REL="Next"  HREF="013173.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] poor PPC JIT output</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20poor%20PPC%20JIT%20output&In-Reply-To=B6CE9681-9C0E-46AE-8DE9-19BA46018F0B%40counterpop.net"
       TITLE="[Mono-devel-list] poor PPC JIT output">lupus at ximian.com
       </A><BR>
    <I>Fri Jul 15 06:39:36 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013164.html">[Mono-devel-list] poor PPC JIT output
</A></li>
        <LI>Next message: <A HREF="013173.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13167">[ date ]</a>
              <a href="thread.html#13167">[ thread ]</a>
              <a href="subject.html#13167">[ subject ]</a>
              <a href="author.html#13167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/14/05 Allan Hsu wrote:
&gt;<i> Code generated by the PPC code emitter performs very poorly in  
</I>&gt;<i> comparison to the same code emitted for other platforms (most  
</I>&gt;<i> notably, x86). I had a brief conversation about this with Miguel in  
</I>&gt;<i> #mono today and he suggested that I post some examples.
</I>
I'm sure he meant an actual test case, which you didn't provide.

&gt;<i> Preliminary profiling with Shark (a profiling tool that is part of  
</I>&gt;<i> the Apple CHUD tools) shows some heinously inefficient JIT output on  
</I>&gt;<i> both G4 and G5 machines. Here's some sample Shark analysis on the  
</I>&gt;<i> code emitted by mono 1.1.8.1 from  
</I>&gt;<i> System.Security.Cryptography.RijndaelTransform.ECB(byte[], byte[])  
</I>&gt;<i> and System.Security.Cryptography.RijndaelTransform.ShiftRow(bool):
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://strangecargo.org/~allan/mono/">http://strangecargo.org/~allan/mono/</A>
</I>
It looks like optimizations are not enabled: are you embedding mono
in your app?
You should try adding:
	mono_set_defaults (0, mono_parse_default_optimizations (NULL));
before the call to mono_jit_init ().

&gt;<i> Information on how to read Shark analysis comes with Shark (available  
</I>&gt;<i> for free from the Apple Developer Connection website).
</I>
A direct pointer to the doc would be useful.

&gt;<i> (A summary:  
</I>&gt;<i> numerous and frequent pipeline stalls, unoptimized loops).
</I>
Some of the data looks definitely bogus: it reports a stall even on
the addi, here:

	0x2e143c8 lwz      r4,32(r1)	3:1 Stall=2
	0x2e143cc lwz      r5,12(r4)	3:1 Stall=2
	0x2e143d0 cmplwi   r5,0x0000 	3:1 Stall=2
	0x2e143d4 blel     $+696 &lt;0x2e1468c [8B]&gt;	2:1
0.4%	0x2e143d8 addi     r4,r4,16 	2:1 Stall=1

How can it stall while adding an immediate value to a register
that was loaded several instructions before? Anyway, maybe the documentation
for the output format will shed some light, once provided.
As for the loop commentary: did you actually test how much you
gain by aligning loop starts on 32 byte boundaries? It would be
a huge waste of memory in most cases.

&gt;<i> Is there any active effort to optimize the PPC code emitter? The  
</I>
We ususally optimize only when we find performance issues (or when someone
reports them). Sometimes the performance issues are easily addressable,
but if nobody reports them it means they are not important, so we
spend our limited time on other tasks.

&gt;<i> above two methods account for the majority of CPU time on a pegged  
</I>&gt;<i> 2Ghz G5 while decrypting AES blocks coming off the wire. The x86  
</I>&gt;<i> machine encrypting the data (also running mono) doesn't even break a  
</I>&gt;<i> sweat.
</I>
Without a test case this doesn't mean anything: you can't compare
two programs that do two different things and arrive at any
meaningful conclusion.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013164.html">[Mono-devel-list] poor PPC JIT output
</A></li>
	<LI>Next message: <A HREF="013173.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13167">[ date ]</a>
              <a href="thread.html#13167">[ thread ]</a>
              <a href="subject.html#13167">[ subject ]</a>
              <a href="author.html#13167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
