<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] malloc and free on CLI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20malloc%20and%20free%20on%20CLI&In-Reply-To=004301c58a4c%24cc8bf8c0%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013200.html">
   <LINK REL="Next"  HREF="013221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] malloc and free on CLI</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20malloc%20and%20free%20on%20CLI&In-Reply-To=004301c58a4c%24cc8bf8c0%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-devel-list] malloc and free on CLI">lupus at ximian.com
       </A><BR>
    <I>Mon Jul 18 05:26:29 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013200.html">[Mono-devel-list] [PATCH] Reworked unified Locale classes
</A></li>
        <LI>Next message: <A HREF="013221.html">[Mono-devel-list] malloc and free on CLI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13201">[ date ]</a>
              <a href="thread.html#13201">[ thread ]</a>
              <a href="subject.html#13201">[ subject ]</a>
              <a href="author.html#13201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07/16/05 Korn&#233;l P&#225;l wrote:
&gt;<i> I think to get te better berformance you should implement heap functionality
</I>&gt;<i> natively. But not using P/Invoke because it's inefficient. You should rater
</I>&gt;<i> use InternalCalls. Use mono/mono/metadata/icall.c and [MethodImplAttribute
</I>&gt;<i> (MethodImplOptions.InternalCall)].
</I>&gt;<i> 
</I>&gt;<i> This will result in a very good performance because there will be no
</I>&gt;<i> marshaling.
</I>
This is completely incorrect: dllimporting malloc() doesn't need any
marshalling, so using icalls would be the same speed as pinvoke, but
you'd have the disadvantage of having to change the mono runtime and depend
on a specific version. Icalls are completely out of the question
as an implementation for this.

The managed C compiler should implement two patterns, both of which
are required:
1) map a function call to a dllimport
2) map a function call to corlib/System/ManagedLibc methods

The first way is needed to be able to compile programs without
needing to compile every dependent lib with the managed C compiler.
The second option is needed to be able to compile an optimized
managed libc. For example, consider calls to strcmp(): using
dllimport (or icalls) will have a big performance impact, so the
function should be implemented in managed land (wether in C or C#
doesn't matter). But, for example, calls to malloc should still be
dllimported, otherwise you won't be able to use in the managed C
program native libraries that use it (think when a library
returns a pointer you need to call free() on).
You also need to be able to implement some of the managed libc
using corlib or system methods, so that the program is more portable
and it integrates better with the rest of the runtime.

Both mappings could be implemented with creative uses
of gcc's attributes. In your compiler's headers, you'd have
declarations like:

int strcmp(const char *s1, const char *s2) __attribute__((managed(&quot;ManagedLibc(Strings::strcmp(byte*,byte*))&quot;)));

This will instruct the compiler to emit a manged call to the
Strings::strcmp(byte*,byte*) method inside ManagedLibc.

Note that you want to have also malloc redirected to ManagedLibc,
so in your stdlib.h header, you'll have:

void *malloc(size_t size) __attribute__((managed(&quot;ManagedLibc(Stdlib::malloc(IntPtr))&quot;)));

while in the implementation (if you write this part of ManagedLibc in 
managed C), you'd have something like:

void *malloc(size_t size) __attribute__((dllimport(&quot;libc&quot;)));

instead of:

void *malloc(size_t size) {
	... malloc code...
}

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013200.html">[Mono-devel-list] [PATCH] Reworked unified Locale classes
</A></li>
	<LI>Next message: <A HREF="013221.html">[Mono-devel-list] malloc and free on CLI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13201">[ date ]</a>
              <a href="thread.html#13201">[ thread ]</a>
              <a href="subject.html#13201">[ subject ]</a>
              <a href="author.html#13201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
