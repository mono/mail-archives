<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Profile 2.0 assembly versions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Profile%202.0%20assembly%20versions&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013555.html">
   <LINK REL="Next"  HREF="013561.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Profile 2.0 assembly versions</H1>
    <B>Andreas Nahr</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Profile%202.0%20assembly%20versions&In-Reply-To="
       TITLE="[Mono-devel-list] [PATCH] Profile 2.0 assembly versions">ClassDevelopment at A-SoftTech.com
       </A><BR>
    <I>Fri Jul 29 12:10:23 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013555.html">[Mono-devel-list] [PATCH] Profile 2.0 assembly versions
</A></li>
        <LI>Next message: <A HREF="013561.html">[Mono-devel-list] [PATCH] Profile 2.0 assembly versions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13558">[ date ]</a>
              <a href="thread.html#13558">[ thread ]</a>
              <a href="subject.html#13558">[ subject ]</a>
              <a href="author.html#13558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Kornel already said that: its just a suggestion. And as you said it will be 
near to impossible to measure performance gains, because you would need to 
instrument the OS itself. However one thing is clear, you could save 
assembly size (and with it OS disc cache and so on).
And it would allow us to make a few things simpler on the management side 
(like combining all Const.cs files) without having to worry about that 
having any negative effect (in fact I don't like the idea that code that 
uses magic numbers might be better, because it delivers more performance or 
needs less memory).
As I already said for our consts this would add about 2,5kb per assembly 
(Unicode + Fieldnames + Class) just for the consts.cs file (Ben - NONE of 
the fields are ever used again). And there might be some other places where 
this might also make sense.

An example showing (all?) possible cases:

using System;
using System.Reflection;

[assembly: AssemblyVersion (Consts.version)]

public class Class1
{
 [Obsolete(Consts.obsolete + Consts.constructor)]
 public Class1()
 {
  Console.WriteLine (Consts.obsolete + Consts.constructor);
 }
}

internal class Consts
{
 internal const string obsolete = &quot;This member is obsolete: &quot;;
 internal const string constructor = &quot;Class1 Constructor&quot;;

 public const string version = &quot;2.0.0.0&quot;;

 internal const string someunused = &quot;some completely unused const&quot;;
}

The class Consts is entirely useless after compiling and it could be 
completely left out. None of its fields are used and none of the strings are 
shared.
In fact the &quot;This member is obsolete: &quot;&quot;Class1 Constructor&quot; will be stored 
3! times in the resulting assembly, which might surprise quite some people.

By the way - i found a bug in the mcs compiler in the process:
If you change the public version const to internal the compiler refuses to 
compile the class, obviously it should do it (csc works correctly)

Greets
Andreas

&gt;<i> On Fri, 2005-07-29 at 09:32 +0200, Andreas Nahr wrote:
</I>&gt;&gt;<i> ----- Original Message ----- 
</I>&gt;&gt;<i> From: &quot;Ben Maurer&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bmaurer at ximian.com</A>&gt;
</I>&gt;&gt;<i> To: &quot;Andreas Nahr&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ClassDevelopment at A-SoftTech.com</A>&gt;
</I>&gt;&gt;<i> Cc: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at hotmail.com</A>&gt;; &quot;Miguel de Icaza&quot;
</I>&gt;&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
</I>&gt;&gt;<i> Sent: Friday, July 29, 2005 1:15 AM
</I>&gt;&gt;<i> Subject: Re: [Mono-devel-list] [PATCH] Profile 2.0 assembly versions
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; On Fri, 2005-07-29 at 00:42 +0200, Andreas Nahr wrote:
</I>&gt;&gt;<i> &gt;&gt; Yes - it would make a lot of sense to put them into a single file.
</I>&gt;&gt;<i> &gt;&gt; However
</I>&gt;&gt;<i> &gt;&gt; it would come at a cost of up to 2kb of size added to EACH assembly 
</I>&gt;&gt;<i> &gt;&gt; that
</I>&gt;&gt;<i> &gt;&gt; uses Consts.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Maybe the *FILE* will be 2 kb, but the metadata added probably won't 
</I>&gt;&gt;<i> &gt; be.
</I>&gt;&gt;<i> &gt; To add a class with a single const we'd need to add:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If we merge everything into a single file we probably have about 20 
</I>&gt;&gt;<i> consts,
</I>&gt;&gt;<i> each about 50 chars long.
</I>&gt;&gt;<i> Depending whether this is saved in the assembly as unicode or ascii 
</I>&gt;&gt;<i> (which i
</I>&gt;&gt;<i> don't know) this should be 1-2kb just for the strings in the string heap.
</I>&gt;<i>
</I>&gt;<i> stuff on the ldstr table is in unicode. That assumes that the 20 consts
</I>&gt;<i> never get used, however. If they are used in the code at all, they will
</I>&gt;<i> need to be in the ldstr table.
</I>&gt;<i>
</I>&gt;&gt;<i> All the fields are NEVER used at runtime, so I hope they do not get 
</I>&gt;&gt;<i> loaded
</I>&gt;&gt;<i> at all ;)
</I>&gt;&gt;<i> There is no access to these fields. They are only used at compile time, 
</I>&gt;&gt;<i> but
</I>&gt;&gt;<i> not at runtime.
</I>&gt;<i>
</I>&gt;<i> They don't.
</I>&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt; In fact I think we could do something really clever to our compiler 
</I>&gt;&gt;<i> &gt;&gt; here,
</I>&gt;&gt;<i> &gt;&gt; that would also benefit for a lot of other cases.
</I>&gt;&gt;<i> &gt;&gt; AFAIK the compiler can already eliminate dead code. I would propose a
</I>&gt;&gt;<i> &gt;&gt; step
</I>&gt;&gt;<i> &gt;&gt; that allows the compiler to scan for dead code again AFTER constants 
</I>&gt;&gt;<i> &gt;&gt; are
</I>&gt;&gt;<i> &gt;&gt; resolved. This way the compiler would be able to completely eliminate 
</I>&gt;&gt;<i> &gt;&gt; the
</I>&gt;&gt;<i> &gt;&gt; Consts Class after compiling. This would also add lots of added value 
</I>&gt;&gt;<i> &gt;&gt; to
</I>&gt;&gt;<i> &gt;&gt; other applications. It's quite common to use private consts and
</I>&gt;&gt;<i> &gt;&gt; especially
</I>&gt;&gt;<i> &gt;&gt; enums to structure the code and make it more readable. With the 
</I>&gt;&gt;<i> &gt;&gt; proposed
</I>&gt;&gt;<i> &gt;&gt; compiler function all of these things could be thrown out at
</I>&gt;&gt;<i> &gt;&gt; compile-time,
</I>&gt;&gt;<i> &gt;&gt; which could help a lot of applications to get smaller.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; A cecil based il-to-il optimizer could do that in the future. Of 
</I>&gt;&gt;<i> &gt; course,
</I>&gt;&gt;<i> &gt; if you really want to look at &quot;how can we make teh metadata smaller&quot; we
</I>&gt;&gt;<i> &gt; could do a simple obfuscator -- we could rename private / internal
</I>&gt;&gt;<i> &gt; methods/classes to have small names, etc.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are obfuscators out there that you can use, however that is not
</I>&gt;&gt;<i> exactly what I mean:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Look at the example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> const string a = &quot;Hello &quot;;
</I>&gt;&gt;<i> const string b = &quot;World&quot;;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [SomeStringAttribute (a+b)]
</I>&gt;&gt;<i> private void Out () { }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I understand thing right we end up having the following strings in the
</I>&gt;&gt;<i> assembly:
</I>&gt;&gt;<i> &quot;Hello World&quot; (as part of the attribute)
</I>&gt;&gt;<i> &quot;Hello &quot;, &quot;World&quot; (in our case these use their own class)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However after compilation the strings &quot;Hello &quot; and &quot;World&quot; are never used
</I>&gt;&gt;<i> anywhere at runtime, so we could delete them.
</I>&gt;&gt;<i> AFAIK not even the MS compiler is able to do that ;)
</I>&gt;<i>
</I>&gt;<i> That's correct.
</I>&gt;<i>
</I>&gt;<i> Anyways, as I said to Kornel, Feel free to come back with data about
</I>&gt;<i> what effect the optimization will have. Otherwise, let's just spend time
</I>&gt;<i> on real performance issues with measurable results.
</I>&gt;<i>
</I>&gt;<i> -- Ben
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013555.html">[Mono-devel-list] [PATCH] Profile 2.0 assembly versions
</A></li>
	<LI>Next message: <A HREF="013561.html">[Mono-devel-list] [PATCH] Profile 2.0 assembly versions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13558">[ date ]</a>
              <a href="thread.html#13558">[ thread ]</a>
              <a href="subject.html#13558">[ subject ]</a>
              <a href="author.html#13558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
