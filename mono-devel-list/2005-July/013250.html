<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] NetworkStream
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20NetworkStream&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013247.html">
   <LINK REL="Next"  HREF="013263.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] NetworkStream</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20NetworkStream&In-Reply-To="
       TITLE="[Mono-devel-list] NetworkStream">kornelpal at hotmail.com
       </A><BR>
    <I>Wed Jul 20 10:34:03 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013247.html">[Mono-devel-list] NetworkStream
</A></li>
        <LI>Next message: <A HREF="013263.html">[Mono-devel-list] NetworkStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13250">[ date ]</a>
              <a href="thread.html#13250">[ thread ]</a>
              <a href="subject.html#13250">[ subject ]</a>
              <a href="author.html#13250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi K&#225;roly,

&gt;<i> If I do not do the &quot;While Not llogReadEverything&quot; loop, it reads the data.
</I>&gt;<i> Do not understand the reason why. :)
</I>
The problem is this line:

lintSize += tobjNetStream.Read(tbytBuffer, 0, tintFullSize)

As you are using the same buffer to read data you should increase the offset
everytime you read data.

The stream is sequential so the data you already have read is dropped by the
stream. (It it is buffered position is incremented and you have to seek back
if you want to access data you alread read.)

Furthermore you should decrement tintFullSize not to read more than you
want.

And you don't have to check DataAvailable because according to the
documentation it will block until some data is available. This doesn't means
that it will wait for all the data specified in size but it will return at
least one byte unless the connection is closed when it returns zero bytes.

You don't have to use ByRef if you want to access and object or modify an
array. You need it if you want to replace the object or the array with a
different one. I think a static buffer could be more efficient (don't have
to allocate new buffer everytime you call the funtion in the same method as
long as you use the same array) and you could simply use tintFullSize as a
number to be read. If you don't want this change you have to use ByRef as
you did before. And I think it is better to read the number of bytes read
than allways true.

You can ignore the above changes if you want.

I suggest you to use something like this:

Private Function ReadData(ByVal networkStream As NetworkStream, _
ByVal buffer As Byte(), ByVal size As Integer) As Integer
    Dim read As Integer
    Dim offset As Integer = 0

    Do
        read = networkStream.Read(buffer, offset, size)
        offset += read
        size -= read
    Loop Until size &lt;= 0 OrElse read &lt;= 0

    Return offset
End Function

Note that the above function does the same as NetworkStream.Read with the
exception that it will read &quot;size&quot; bytes anyway by waiting for data until
the connection is closed when it may return less bytes as no more is
available and will not arrive after the connection is closed.

Korn&#233;l

-----Original Message-----
From: Martin Hinks [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mhinks at gmail.com</A>]
Sent: Wednesday, July 20, 2005 10:59 AM
To: Arnhoffer K&#225;roly
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-devel-list] NetworkStream


Hi Arnhoffer,

There are various things to try:

1.) Check that tIntFullSize is not 0 when the .Read line is called.
2.) Try this with a plain networkstream derived from a socket rather than
from a TcpClient
3.) If you are trying to read the entire buffer of length tintFullSize, is
it not possible that the server has not sent all the data when the read is
performed? ie. Just because DataAvailable is true does NOT mean that you may
be able to read ALL the data you are expecting from the stream, it might not
have arrived yet, and as you are expecting to be able to read it all it
might return 0 (I think it should block though, which is why it must work on
.NET)
4.) After some of the diagnoses above, file a bugzilla report.

Martin

On 7/20/05, Arnhoffer K&#225;roly &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">karnhoffer at ecron.hu</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I have a server service created by Visual Studio .Net. It is using
</I>&gt;<i> System.Net.Sockets.TcpClient.GetStream to get a stream to communicate
</I>&gt;<i> on the network. When I run this service on a Windows machine (MS .NET
</I>&gt;<i> framework) everything is fine, but when running on a Linux machine
</I>&gt;<i> (SuSE 9.2, Mono 1.1.8 (from RPMs)) the service reads allways zeroes
</I>&gt;<i> from the stream.
</I>&gt;<i>
</I>&gt;<i> Example:
</I>&gt;<i>
</I>&gt;<i>         Private Function ReadData(ByRef tobjNetStream As
</I>&gt;<i> NetworkStream, ByRef tbytBuffer As Byte(), ByVal tintFullSize As
</I>&gt;<i> Integer) As Boolean
</I>&gt;<i>
</I>&gt;<i>                 Dim lintSize As Integer = 0
</I>&gt;<i>                 Dim llogReadEverything As Boolean
</I>&gt;<i>                 Dim lintCounter As Integer
</I>&gt;<i>
</I>&gt;<i>                 ReDim tbytBuffer(tintFullSize - 1)
</I>&gt;<i>
</I>&gt;<i>                 While Not llogReadEverything
</I>&gt;<i>                         While Not tobjNetStream.DataAvailable
</I>&gt;<i>                                 Thread.CurrentThread.Sleep(50)
</I>&gt;<i>                         End While
</I>&gt;<i>
</I>&gt;<i>                         lintSize += tobjNetStream.Read(tbytBuffer, 0,
</I>&gt;<i> tintFullSize)
</I>&gt;<i>                         If lintSize &gt;= tintFullSize Then
</I>&gt;<i>                                 llogReadEverything = True
</I>&gt;<i>                         End If
</I>&gt;<i>                 End While
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                 Return True
</I>&gt;<i>         End Function
</I>&gt;<i>
</I>&gt;<i> A function like this gets zeroes from the stream when nonzero data was
</I>&gt;<i> sent.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i> Arnhoffer K&#225;roly _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

--
Martin Hinks
<A HREF="http://www.m-s-d.net">http://www.m-s-d.net</A>
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013247.html">[Mono-devel-list] NetworkStream
</A></li>
	<LI>Next message: <A HREF="013263.html">[Mono-devel-list] NetworkStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13250">[ date ]</a>
              <a href="thread.html#13250">[ thread ]</a>
              <a href="subject.html#13250">[ subject ]</a>
              <a href="author.html#13250">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
