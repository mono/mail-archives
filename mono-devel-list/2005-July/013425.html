<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] COM Interop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20COM%20Interop&In-Reply-To=BDBFCADE470D2B4A841D51412D2D915D01B97D08%40canonsburgexch2.win.ansys.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013391.html">
   <LINK REL="Next"  HREF="013452.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] COM Interop</H1>
    <B>Andrew Weaver</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20COM%20Interop&In-Reply-To=BDBFCADE470D2B4A841D51412D2D915D01B97D08%40canonsburgexch2.win.ansys.com"
       TITLE="[Mono-devel-list] COM Interop">andrew_weaver at sil.org
       </A><BR>
    <I>Tue Jul 26 13:31:49 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013391.html">[Mono-devel-list] COM Interop
</A></li>
        <LI>Next message: <A HREF="013452.html">[Mono-devel-list] COM Interop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13425">[ date ]</a>
              <a href="thread.html#13425">[ thread ]</a>
              <a href="subject.html#13425">[ subject ]</a>
              <a href="author.html#13425">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan,

We have a lot of legacy code packaged as COM objects that we're calling
using COM Interop from our C# .NET code on Windows.

To enable us to deploy our applications on Linux and Mac OS X using Mono we
think that SWIG (<A HREF="http://www.swig.org">http://www.swig.org</A>) shows some promise. Have you
considered it already? It may need a little more work to add some features
to the C# binding in order to fully support COM (as opposed to plain C++),
but that may be easier than, and preferable to modifying the Mono runtime.

The investigative work and preliminary tests were conducted by a colleague,
so I'm a bit vague on the details. But, if you're interested, then perhaps
we can help each other and the SWIG project for everyone's benefit.

--Andrew


On 25/7/05 11:57 am, &quot;Jonathan S. Chambers&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Jonathan.Chambers at ansys.com</A>&gt;
wrote:

&gt;<i> Thanks for the response Rafael. I have a large amount of C++/COM
</I>&gt;<i> code and migrating it all is not an option (due to shear size and
</I>&gt;<i> performance reasons). I can port this code to *nix but have no way to
</I>&gt;<i> call it.
</I>&gt;<i> I have already discussed this with some members of the mailing
</I>&gt;<i> list offline. Essentially, all I want to do is be able to call into a
</I>&gt;<i> C++ vtable. All of my code is COM in origin; so all my calls are through
</I>&gt;<i> interfaces (C++ abstract base classes), stdcall calling convention,
</I>&gt;<i> HRESULT return value, etc. After some discussion, the idea of
</I>&gt;<i> implementing COM Interop came up. But perhaps this is not the best
</I>&gt;<i> solution. Perhaps I should just host the mono runtime and make any minor
</I>&gt;<i> modifications I need to make. If there is not enough interest/benefit in
</I>&gt;<i> COM Interop, then embedding mono to meet my needs might be the
</I>&gt;<i> easiest/best solution.
</I>&gt;<i> And just an FYI, I don't want all the COM/COM Interop
</I>&gt;<i> functionality. I wanted the runtime to be able to call into the vtable I
</I>&gt;<i> define through a corresponding managed interface, and the ability to
</I>&gt;<i> handle casting by calling QI (if trying to cast an unmanaged component
</I>&gt;<i> to a different interface, a cast can succeed if the QI succeeds even if
</I>&gt;<i> the managed wrapper does not inherit from that interface). Any insight
</I>&gt;<i> on this would be appreciated.
</I>&gt;<i> 
</I>&gt;<i> - Jonathan
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Rafael Teixeira [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">monoman at gmail.com</A>]
</I>&gt;<i> Sent: Monday, July 25, 2005 1:30 PM
</I>&gt;<i> To: Jonathan S. Chambers
</I>&gt;<i> Cc: mono-devel
</I>&gt;<i> Subject: Re: [Mono-devel-list] COM Interop
</I>&gt;<i> 
</I>&gt;<i> On 7/25/05, Jonathan S. Chambers &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Jonathan.Chambers at ansys.com</A>&gt; wrote:
</I>&gt;&gt;<i>         I am interested in implementing some support for COM Interop
</I>&gt;<i> for
</I>&gt;&gt;<i> the mono runtime. A goal is that the mono version of COM Interop could
</I>&gt;&gt;<i> support various component models (COM, XPCOM, and Bonobo have been
</I>&gt;&gt;<i> proposed); whether more than one can be supported at one time is
</I>&gt;<i> another
</I>&gt;&gt;<i> decision that someone will need to make.
</I>&gt;<i> 
</I>&gt;<i> I would hope that not to happen, as COM is just more trouble than it
</I>&gt;<i> is worth. I prefer to rewrite any COM component as something fully
</I>&gt;<i> managed, but yes there are cases (like using OLE Automation to control
</I>&gt;<i> omnipresent apps) that we may have to concede. But I personally would
</I>&gt;<i> not space for COM to breath.
</I>&gt;<i> 
</I>&gt;<i> Alas, you are in the group that may have invested so much on COM, or
</I>&gt;<i> depend on OLE Automation or Third-Party ActiveX Components so let's
</I>&gt;<i> see what I can help than further discuss the merit of the proposition.
</I>&gt;<i> 
</I>&gt;&gt;<i>         Component model specific code will not be part of the mono
</I>&gt;&gt;<i> runtime, but part of an external library loaded at runtime (as
</I>&gt;&gt;<i> requested).
</I>&gt;<i> 
</I>&gt;<i> Very good decision. I just don't think Bonobo will fit in nicely as it
</I>&gt;<i> is very different from the other two, and from the COM-Interop
</I>&gt;<i> premises embedded in .NET.
</I>&gt;<i> 
</I>&gt;&gt;<i> A few questions
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1. Would the mono runtime be aware of common functionality that exists
</I>&gt;&gt;<i> in all (currently proposed) component models; essentially the
</I>&gt;&gt;<i> functionality of the Unknown interface (reference counting and
</I>&gt;<i> interface
</I>&gt;&gt;<i> querying)?
</I>&gt;<i> 
</I>&gt;<i> I fear you'll have to do that: Just to mimic correctly all the
</I>&gt;<i> COM-specific things that the Base Class Library has.
</I>&gt;<i> 
</I>&gt;&gt;<i> 2. As MS has a base COM object wrapper (__ComObject), I was planning a
</I>&gt;&gt;<i> similar one for mono. This wrapper would hold onto the unmanaged
</I>&gt;<i> object
</I>&gt;&gt;<i> pointer and provide additional functionality as required. Does this
</I>&gt;&gt;<i> sound ok?
</I>&gt;<i> 
</I>&gt;<i> Yes, but you'll need a lot more baggage than this class. Issues with
</I>&gt;<i> threading-models and GC x ReferenceCounting clutter this space and are
</I>&gt;<i> mapped in this API surface.
</I>&gt;<i> 
</I>&gt;&gt;<i> 3. I assume some sort of reference counting will take place. For
</I>&gt;&gt;<i> simplicity, I was planning on AddRef'ing/Release'ing at every
</I>&gt;&gt;<i> interaction. This is different that the MS implementation, I believe.
</I>&gt;&gt;<i> For example, (again, I believe) MS keeps track of the IUnknown pointer
</I>&gt;&gt;<i> and addref's only once upon entry into the managed runtime. Each
</I>&gt;&gt;<i> unmanaged component then seems to be wrapped by only one managed
</I>&gt;&gt;<i> wrapper.
</I>&gt;<i> 
</I>&gt;<i> The problem is you can't Release freely as it may kill the object
</I>&gt;<i> prematurely. I'm not sure but I think the Disposable pattern is used
</I>&gt;<i> to control the lifetime of wrapped COM objects a bit better but some
</I>&gt;<i> exceptions to the rule may appear.
</I>&gt;<i> 
</I>&gt;&gt;<i> 4. I assume each unmanaged interfaces will have a corresponding
</I>&gt;<i> managed
</I>&gt;&gt;<i> interface defined and tagged with appropriate attributes. The
</I>&gt;&gt;<i> GuidAttribute would work for COM/XPCOM, but Bonobo takes a string for
</I>&gt;&gt;<i> its QueryInterface.
</I>&gt;<i> 
</I>&gt;<i> Well that is what I said about Bonobo not fitting in. Let's look at
</I>&gt;<i> the problem from the developer that will be using it perspective.
</I>&gt;<i> 
</I>&gt;<i> Bonobo components are normally totally diverse from similar COM
</I>&gt;<i> components, it is hard to imagine having an interface-for-interface
</I>&gt;<i> match that would allow you to write a single hosting code to  accept a
</I>&gt;<i> COM component and an equivalent Bonobo component. That's is easier
</I>&gt;<i> between COM /XPCOM as that was way XPCOM was written in the first
</I>&gt;<i> place.
</I>&gt;<i> 
</I>&gt;<i> So If I want to write apps that use Bonobo components the most I would
</I>&gt;<i> expect is to be able to reuse &quot;concepts&quot;, and similarly named classes,
</I>&gt;<i> but little mor than that.
</I>&gt;<i> 
</I>&gt;<i> So probably a BonoboObject (double-underscores aren't really needed in
</I>&gt;<i> this case) should be built as a counterpart to the __ComObject that
</I>&gt;<i> may be able to deal with COM and XPCOM.
</I>&gt;<i> 
</I>&gt;&gt;<i> (Kornel mentioned having additional namespaces under
</I>&gt;&gt;<i> System.Runtime.InteropServices, such as
</I>&gt;&gt;<i> System.Runtime.InteropServices.Bonobo).
</I>&gt;<i> 
</I>&gt;<i> No way. Adding subnamespaces in the ECMA/MS namespaces isn't allowed.
</I>&gt;<i> We can have a Mono.Runtime.InteropServices.Bonobo or a shorter and
</I>&gt;<i> appropriate Bonobo namespace.
</I>&gt;<i> 
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Jonathan
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Good luck,
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013391.html">[Mono-devel-list] COM Interop
</A></li>
	<LI>Next message: <A HREF="013452.html">[Mono-devel-list] COM Interop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13425">[ date ]</a>
              <a href="thread.html#13425">[ thread ]</a>
              <a href="subject.html#13425">[ subject ]</a>
              <a href="author.html#13425">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
