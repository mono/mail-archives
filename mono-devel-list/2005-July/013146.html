<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Data Adapter problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Data%20Adapter%20problem&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013145.html">
   <LINK REL="Next"  HREF="013203.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Data Adapter problem</H1>
    <B>Daniel Morgan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Data%20Adapter%20problem&In-Reply-To="
       TITLE="[Mono-devel-list] Data Adapter problem">danielmorgan at verizon.net
       </A><BR>
    <I>Wed Jul 13 21:36:43 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013145.html">[Mono-devel-list] DateTime Parameters in MSSQL Server
</A></li>
        <LI>Next message: <A HREF="013203.html">[Mono-devel-list] Data Adapter problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13146">[ date ]</a>
              <a href="thread.html#13146">[ thread ]</a>
              <a href="subject.html#13146">[ subject ]</a>
              <a href="author.html#13146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a problem with the data adapter on Mono 1.1.8 on Windows.  Has 
this been fixed in svn?

Notice my test case does not use column nor table mappings.

Results on Dot Net 1.1:

E:\projects\DotNet\C#\TestSqlClientAdapter\bin\Debug&gt;TestSqlClientAdapter.exe
Apapter Test Begin...
Insert...
Value 0: 3
Value 0: Value inserted
Rows retrieved: 1
Update...
Value 0: 3
Value 0: Value updated
Rows retrieved: 1
Delete...
Rows retrieved: 0
Done.

Results on Mono 1.1.8 on Windows:

E:\projects\DotNet\C#\TestSqlClientAdapter\bin\Debug&gt;mono 
TestSqlClientAdapter.e
xe
Apapter Test Begin...
Insert...

Unhandled Exception: System.IndexOutOfRangeException: 
DataColumnMappingCollectio
n doesn't contain DataColumnMapping with SourceColumn 'num_value'.
in &lt;0x000cd&gt; System.Data.Common.DataColumnMappingCollection:get_Item 
(System.Str
ing sourceColumn)
in (wrapper remoting-invoke-with-check) 
System.Data.Common.DataColumnMappingColl
ection:get_Item (string)
in &lt;0x001eb&gt; System.Data.SqlClient.SqlCommandBuilder:CreateInsertCommand 
(System
.Data.DataRow row, System.Data.Common.DataTableMapping tableMapping)
in (wrapper remoting-invoke-with-check) 
System.Data.SqlClient.SqlCommandBuilder:
CreateInsertCommand 
(System.Data.DataRow,System.Data.Common.DataTableMapping)
in &lt;0x00197&gt; System.Data.SqlClient.SqlCommandBuilder:RowUpdatingHandler 
(System.
Object sender, System.Data.SqlClient.SqlRowUpdatingEventArgs e)


Here is the test case:

using System;
using System.Data;
using System.Data.Common;
using System.Data.SqlClient;

namespace TestSqlClientAdapter {
    public class Test {
        static SqlConnection con;
        static SqlTransaction trans;

        public static void Main (string[] args)
        {
            Console.WriteLine(&quot;Apapter Test Begin...&quot;);
            con = new SqlConnection(&quot;server=localhost;database=pubs;user 
id=sa;password=mypass&quot;);
            con.Open();
           
            Setup();

            trans = con.BeginTransaction();
            Insert();
            trans.Commit();

            trans = con.BeginTransaction();
            Update();
            trans.Commit();

            trans = con.BeginTransaction();
            Delete();
            trans.Commit();

            con.Close();
            Console.WriteLine(&quot;Done.&quot;);
        }

        static void Setup()
        {
            SqlCommand cmd = con.CreateCommand();
            cmd.Transaction = trans;
            cmd.CommandText = &quot;DROP TABLE MONO_TEST_ADAPTER1&quot;;

            try { cmd.ExecuteNonQuery();
            } catch(SqlException e) { }

            cmd.CommandText =
                &quot;CREATE TABLE MONO_TEST_ADAPTER1 (&quot; +
                &quot; num_value int primary key,&quot; +
                &quot; txt_value varchar(64))&quot;;
            cmd.ExecuteNonQuery();

            cmd.Dispose();
            cmd = null;
        }

        static void Insert()
        {
            Console.WriteLine(&quot;Insert...&quot;);

            SqlDataAdapter adapter = new SqlDataAdapter(&quot;SELECT * FROM 
MONO_TEST_ADAPTER1&quot;, con);
            adapter.SelectCommand.Transaction = trans;
            SqlCommandBuilder builder = new SqlCommandBuilder(adapter);
           
            DataSet ds = new DataSet();
            adapter.Fill(ds,&quot;MONO_TEST_ADAPTER1&quot;);
           
            DataRow row = ds.Tables[&quot;MONO_TEST_ADAPTER1&quot;].NewRow();
            row[&quot;num_value&quot;] = 3;
            row[&quot;txt_value&quot;] = &quot;Value inserted&quot;;

            ds.Tables[&quot;MONO_TEST_ADAPTER1&quot;].Rows.Add(row);

            adapter.Update(ds, &quot;MONO_TEST_ADAPTER1&quot;);

            row = null;
            builder = null;
            adapter = null;
            ds = null;
           
            ReadData(con, &quot;SELECT * FROM MONO_TEST_ADAPTER1&quot;);
        }

        static void Update()
        {
            Console.WriteLine(&quot;Update...&quot;);

            SqlDataAdapter adapter = new SqlDataAdapter(&quot;SELECT * FROM 
MONO_TEST_ADAPTER1&quot;, con);
            adapter.SelectCommand.Transaction = trans;
            SqlCommandBuilder builder = new SqlCommandBuilder(adapter);
           
            DataSet ds = new DataSet();
            adapter.Fill(ds,&quot;MONO_TEST_ADAPTER1&quot;);
           
            DataRow row = ds.Tables[&quot;MONO_TEST_ADAPTER1&quot;].Rows[0];
            row[&quot;txt_value&quot;] = &quot;Value updated&quot;;

            adapter.Update(ds, &quot;MONO_TEST_ADAPTER1&quot;);

            row = null;
            builder = null;
            adapter = null;
            ds = null;

            ReadData(con, &quot;SELECT * FROM MONO_TEST_ADAPTER1&quot;);

        }

        static void Delete()
        {
            Console.WriteLine(&quot;Delete...&quot;);

            SqlDataAdapter adapter = new SqlDataAdapter(&quot;SELECT * FROM 
MONO_TEST_ADAPTER1&quot;, con);
            adapter.SelectCommand.Transaction = trans;
            SqlCommandBuilder builder = new SqlCommandBuilder(adapter);
           
            DataSet ds = new DataSet();
            adapter.Fill(ds,&quot;MONO_TEST_ADAPTER1&quot;);
           
            ds.Tables[&quot;MONO_TEST_ADAPTER1&quot;].Rows[0].Delete();

            adapter.Update(ds, &quot;MONO_TEST_ADAPTER1&quot;);

            builder = null;
            adapter = null;
            ds = null;

            ReadData(con, &quot;SELECT * FROM MONO_TEST_ADAPTER1&quot;);

        }

        private static void ReadData(IDbConnection con, string sql)
        {
            IDbCommand cmd = con.CreateCommand();
            cmd.Transaction = trans;
            cmd.CommandText = sql;
            IDataReader reader = cmd.ExecuteReader();
            int rows = 0;
            while(reader.Read()) {
                Console.WriteLine(&quot;Value 0: {0}&quot;, reader[0]);
                Console.WriteLine(&quot;Value 0: {0}&quot;, reader[1]);
                rows++;
            }
            Console.WriteLine(&quot;Rows retrieved: {0}&quot;, rows);
            reader.Close();
            reader = null;
            cmd.Dispose();
            cmd = null;
        }
    }
}




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013145.html">[Mono-devel-list] DateTime Parameters in MSSQL Server
</A></li>
	<LI>Next message: <A HREF="013203.html">[Mono-devel-list] Data Adapter problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13146">[ date ]</a>
              <a href="thread.html#13146">[ thread ]</a>
              <a href="subject.html#13146">[ subject ]</a>
              <a href="author.html#13146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
