<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] [PATCH] Fix null reference exceptions	in	System.Data.DataView
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Fix%20null%20reference%20exceptions%0A%09in%09System.Data.DataView&In-Reply-To=200507061257.41361.haisenko%40webport.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013051.html">
   <LINK REL="Next"  HREF="013063.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] [PATCH] Fix null reference exceptions	in	System.Data.DataView</H1>
    <B>Konstantin Triger</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20%5BPATCH%5D%20Fix%20null%20reference%20exceptions%0A%09in%09System.Data.DataView&In-Reply-To=200507061257.41361.haisenko%40webport.de"
       TITLE="[Mono-devel-list] [PATCH] Fix null reference exceptions	in	System.Data.DataView">kostat at mainsoft.com
       </A><BR>
    <I>Wed Jul  6 08:03:58 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013051.html">[Mono-devel-list] [PATCH] Fix null reference exceptions in	System.Data.DataView
</A></li>
        <LI>Next message: <A HREF="013063.html">[Mono-devel-list] [PATCH] Fix null reference exceptions in	System.Data.DataView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13057">[ date ]</a>
              <a href="thread.html#13057">[ thread ]</a>
              <a href="subject.html#13057">[ subject ]</a>
              <a href="author.html#13057">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Marc,

My view that a problem is deeper: probably we run into a situation where 
the DataView is not functional when it should be. Replacing the 
assignment of rowCache to an empty array will prevent throwing an 
exception, but will not solve the logical problem.

Please open a bugzilla bug with a test case and a patch attached.

Regards,
Konstantin Triger



Marc Haisenko wrote:

&gt;<i>Hi folks,
</I>&gt;<i>I just noticed that a bug in DataView.cs is still/again present in the current 
</I>&gt;<i>revision (r46988, <A HREF="svn://svn.myrealbox.com/source/trunk/mcs/">svn://svn.myrealbox.com/source/trunk/mcs/</A>)
</I>&gt;<i>
</I>&gt;<i>The problem is that a variable, rowCache, is often set to null but no null 
</I>&gt;<i>checks are done. That way a fresh instance of DataView throws a 
</I>&gt;<i>NullReferenceException e.g. when reading the Count property as it simply does 
</I>&gt;<i>&quot;return rowCache.Length;&quot;.
</I>&gt;<i>
</I>&gt;<i>The fix is to never set the variable to null but to an empty array. The 
</I>&gt;<i>attached patch implements this fix (only three lines need that fix). I 
</I>&gt;<i>already sent a patch to fix the very same bug on 11.11.2004, it seems like it 
</I>&gt;<i>never got included...
</I>&gt;<i>
</I>&gt;<i>C'ya,
</I>&gt;<i>	Marc
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;<i>------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>Index: DataView.cs
</I>&gt;<i>===================================================================
</I>&gt;<i>--- DataView.cs	(revision 46985)
</I>&gt;<i>+++ DataView.cs	(working copy)
</I>&gt;<i>@@ -41,7 +41,7 @@
</I>&gt;<i> 		IExpression rowFilterExpr;
</I>&gt;<i> 		string sort = String.Empty;
</I>&gt;<i> 		protected DataViewRowState rowState;
</I>&gt;<i>-		protected DataRowView[] rowCache = null;
</I>&gt;<i>+		protected DataRowView[] rowCache = new DataRowView[0];
</I>&gt;<i> 
</I>&gt;<i> 		// BeginInit() support
</I>&gt;<i> 		bool isInitPhase = false;
</I>&gt;<i>@@ -535,7 +535,7 @@
</I>&gt;<i> 			if (dataTable != null)
</I>&gt;<i> 				UnregisterEventHandlers ();
</I>&gt;<i> 			Index = null;
</I>&gt;<i>-			rowCache = null;
</I>&gt;<i>+			rowCache = new DataRowView[0];
</I>&gt;<i> 			isOpen = false;
</I>&gt;<i> 		}
</I>&gt;<i> 
</I>&gt;<i>@@ -703,7 +703,7 @@
</I>&gt;<i> 		{
</I>&gt;<i> 			// TODO: what really happens?
</I>&gt;<i> 			Close ();
</I>&gt;<i>-			rowCache = null;
</I>&gt;<i>+			rowCache = new DataRowView[0];
</I>&gt;<i> 			Open ();
</I>&gt;<i> 			OnListChanged (new ListChangedEventArgs (ListChangedType.Reset, -1 ));
</I>&gt;<i> 		}
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;<i>------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Mono-devel-list mailing list
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i><A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>  
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013051.html">[Mono-devel-list] [PATCH] Fix null reference exceptions in	System.Data.DataView
</A></li>
	<LI>Next message: <A HREF="013063.html">[Mono-devel-list] [PATCH] Fix null reference exceptions in	System.Data.DataView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13057">[ date ]</a>
              <a href="thread.html#13057">[ thread ]</a>
              <a href="subject.html#13057">[ subject ]</a>
              <a href="author.html#13057">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
