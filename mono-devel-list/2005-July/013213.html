<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20mono%20AES%20performance%20woes%20%28was%3A%20poor%20PPC%20JIT%0A%09output%29&In-Reply-To=20050718095917.GN9882%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013202.html">
   <LINK REL="Next"  HREF="013214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)</H1>
    <B>Allan Hsu</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20mono%20AES%20performance%20woes%20%28was%3A%20poor%20PPC%20JIT%0A%09output%29&In-Reply-To=20050718095917.GN9882%40debian.org"
       TITLE="[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)">allan at counterpop.net
       </A><BR>
    <I>Mon Jul 18 15:18:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="013202.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
        <LI>Next message: <A HREF="013214.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13213">[ date ]</a>
              <a href="thread.html#13213">[ thread ]</a>
              <a href="subject.html#13213">[ subject ]</a>
              <a href="author.html#13213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jul 18, 2005, at 2:59 AM, Paolo Molaro wrote:

&gt;<i> On 07/15/05 Allan Hsu wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Is there any reference on what sorts of things you can change using
</I>&gt;&gt;<i> mono_set_defaults? Following the mono source for references to that
</I>&gt;&gt;<i> function wasn't particularly enlightening. It would be useful if the
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> grep mono_set_defaults *.c
</I>&gt;<i> mini.c:mono_set_defaults (int verbose_level, guint32 opts)
</I>&gt;<i> Should be pretty evident. Just always use the result of
</I>&gt;<i> mono_parse_default_optimizations (NULL) as the opts value.
</I>
I understood the verbose_level parameters, but the opts parameter was  
what mystified me. I should have been more specific about what I was  
looking for. At the time, I didn't understand the value that  
mono_parse_default_optimizations() returns or what values you can  
pass in to affect it. I've since traced it back to the relevant code  
in driver.c and the mini-X.c platform code now and see how it works.  
Is it safe to mess with those parameters, or will it cause undefined  
results?

&gt;&gt;<i> To be fair, the native implementation is able to take advantage of  
</I>&gt;&gt;<i> 64-
</I>&gt;&gt;<i> bit processors when available, while all mono builds in the above
</I>&gt;&gt;<i> benchmarks are 32-bit. The Windows XP machine is the standard 32-bit
</I>&gt;&gt;<i> install, even though the processor is 64-bit. This is a pretty
</I>&gt;&gt;<i> informal benchmark, but all I'm interested in showing here is how bad
</I>&gt;&gt;<i> the AES performance under mono is.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The current implementation causes lots of spilling and other
</I>&gt;<i> unnecessary work which the jit doesn't remove (the work massi is
</I>&gt;<i> doing should improve this). Some parts of it can be easily changed
</I>&gt;<i> to use unsafe code and that should improve performance a lot: I'll  
</I>&gt;<i> leave
</I>&gt;<i> that to Sebastien:-)
</I>
This is good to hear. I hope the benchmarking I did will provide some  
information that somebody will find useful.

For my specific application, there is no such thing as &quot;enough&quot;  
performance:) I plan on writing a managed wrapper around libcrypto  
for this reason. This will be the subject of another email.

&gt;&gt;&gt;<i> Some of the data looks definitely bogus: it reports a stall even on
</I>&gt;&gt;&gt;<i> the addi, here:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    0x2e143c8 lwz      r4,32(r1)    3:1 Stall=2
</I>&gt;&gt;&gt;<i>    0x2e143cc lwz      r5,12(r4)    3:1 Stall=2
</I>&gt;&gt;&gt;<i>    0x2e143d0 cmplwi   r5,0x0000     3:1 Stall=2
</I>&gt;&gt;&gt;<i>    0x2e143d4 blel     $+696 &lt;0x2e1468c [8B]&gt;    2:1
</I>&gt;&gt;&gt;<i> 0.4%    0x2e143d8 addi     r4,r4,16     2:1 Stall=1
</I>&gt;&gt;&gt;<i>
</I>&gt;<i> [...]
</I>&gt;<i>
</I>&gt;&gt;<i> As for the stall statistics, you have misread them. Each line that
</I>&gt;&gt;<i> says &quot;Stall=N&quot; is saying that the instruction latency of the marked
</I>&gt;&gt;<i> instruction will cause a subsequent dependent instruction to stall,
</I>&gt;&gt;<i> not that the marked instruction itself will stall. N is the maximum
</I>&gt;&gt;<i> number of stall cycles for the nearest dependent instruction. The
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since the tool reports that the addi stalls only sometimes (check the
</I>&gt;<i> similar code sequences where no stall is reported), my take
</I>&gt;<i> is that your interpretation or the data reported is not correct.
</I>
I'm not sure if my meaning came across. The line next to the addi  
instruction that says &quot;Stall=1&quot; means that a dependent instruction  
*following* the addi looks like it will stall while waiting for the  
results from addi, not that the addi instruction itself will stall.  
The code that follows that specific instruction looks like this:

0.4%    0x2e143d8     addi     r4,r4,16    2:1        Stall=1
     0x2e143dc     lbz      r4,0(r4)    3:1        Stall=2
     0x2e143e0     add      r3,r3,r4    2:1        Stall=1
     0x2e143e4     stw      r3,44(r1)    3:1

The instruction latency of the addi instruction is 2 cycles; the lbz  
that immediately follows the addi is dependent on the addi. The lbz  
will stall for 1 cycle. That is what the Shark output is trying to say.

     -Allan

--
Allan Hsu &lt;allan at counterpop dot net&gt;
1E64 E20F 34D9 CBA7 1300  1457 AC37 CBBB 0E92 C779

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013202.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
	<LI>Next message: <A HREF="013214.html">[Mono-devel-list] mono AES performance woes (was: poor PPC JIT	output)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13213">[ date ]</a>
              <a href="thread.html#13213">[ thread ]</a>
              <a href="subject.html#13213">[ subject ]</a>
              <a href="author.html#13213">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
