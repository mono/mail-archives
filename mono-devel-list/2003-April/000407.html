<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] implementing the synchronized method	attribute
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20implementing%20the%20synchronized%20method%0A%09attribute&In-Reply-To=20030413085403.GG907%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000406.html">
   <LINK REL="Next"  HREF="000408.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] implementing the synchronized method	attribute</H1>
    <B>dietmar</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20implementing%20the%20synchronized%20method%0A%09attribute&In-Reply-To=20030413085403.GG907%40debian.org"
       TITLE="[Mono-devel-list] implementing the synchronized method	attribute">dietmar at ximian.com
       </A><BR>
    <I>Mon Apr 14 06:20:51 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="000406.html">[Mono-devel-list] implementing the synchronized method a
</A></li>
        <LI>Next message: <A HREF="000408.html">[Mono-devel-list] implementing the synchronized method a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#407">[ date ]</a>
              <a href="thread.html#407">[ thread ]</a>
              <a href="subject.html#407">[ subject ]</a>
              <a href="author.html#407">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>IMO the wrapper approach is much easier to implement since it does not
need to handle any special cases. The exception handling stuff is
already complex enough, and it is also architecture dependent. So I
would implement the wrapper approach until it turns out that its not
usable for some reasons.

- Dietmar

On Sun, 2003-04-13 at 10:54, Paolo Molaro wrote:
&gt;<i> On 04/12/03 Varga Zoltan wrote:
</I>&gt;<i> &gt;   I would like to implement the 'synchronized' method
</I>&gt;<i> &gt; attribute in the
</I>&gt;<i> &gt; runtime. I thought about using the wrapper facility for
</I>&gt;<i> &gt; this, i.e. creating
</I>&gt;<i> &gt; a synchronized wrapper for the method which would call the
</I>&gt;<i> &gt; non-synchronized version. Is this a good idea?
</I>&gt;<i> 
</I>&gt;<i> I don't think using a wrapper would buy you anything.
</I>&gt;<i> The best way, IMO, is to insert the calls to
</I>&gt;<i> mono_monitor_enter/mono_monitor_leave in mono_method_to_ir().
</I>&gt;<i> 
</I>&gt;<i> With:
</I>&gt;<i> void
</I>&gt;<i> mono_monitor_enter (MonoObject* obj)
</I>&gt;<i> {
</I>&gt;<i>         mono_monitor_try_enter (obj, infinite_ms_value);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> The call should be simply added at the start of the init_locals basic
</I>&gt;<i> block; to do so make sure this block is created for synchronized
</I>&gt;<i> methods
</I>&gt;<i> (check mini.c at line about 2130).
</I>&gt;<i> The actual call needs to be inserted at line about 4130, see for
</I>&gt;<i> example
</I>&gt;<i> how the call to mono_domain_get is done there.
</I>&gt;<i> 
</I>&gt;<i> mono_monitor_leave () needs to be handled similarly: I suggest doing
</I>&gt;<i> that in the case for CEE_RET in the big switch (I would also disable
</I>&gt;<i> inlining for synchronized methods).
</I>&gt;<i> 
</I>&gt;<i> Inserting the call is something like:
</I>&gt;<i> 
</I>&gt;<i>                 MonoCallInst *call;
</I>&gt;<i>                 MonoInst *args [1];
</I>&gt;<i> 
</I>&gt;<i>                 NEW_ARGLOAD (cfg, args [0], 0); // load this
</I>&gt;<i>                 MONO_INST_NEW_CALL (cfg, call, CEE_CALL);
</I>&gt;<i>                 call-&gt;args = args;
</I>&gt;<i>                 call-&gt;signature = helper_sig_monitor_op;
</I>&gt;<i>                 call-&gt;fptr = mono_monitor_enter; // mono_monitor_leave
</I>&gt;<i>         
</I>&gt;<i>                 call = mono_arch_call_opcode (cfg, init_localsbb,
</I>&gt;<i> call, FALSE);
</I>&gt;<i>         
</I>&gt;<i>                 MONO_ADD_INS (init_localsbb, call);
</I>&gt;<i> 
</I>&gt;<i> You need to setup helper_sig_monitor_op with a void return type,
</I>&gt;<i> instance method and no arguments.
</I>&gt;<i> That is the easy stuff and after you've done that you can start
</I>&gt;<i> testing
</I>&gt;<i> things.
</I>&gt;<i> At this point there is just one missing issue: calling
</I>&gt;<i> mono_monitor_leave() on stack unwind. This needs to be done in
</I>&gt;<i> exceptions-x86.c: when a synchronized method is exited using stack
</I>&gt;<i> unwind, we need to retrieve the 'this' pointer and call
</I>&gt;<i> mono_monitor_leave() manually. The easy way is to add a field to
</I>&gt;<i> MonoJitInfo (in metadata/appdomain.h) that describes where the this
</I>&gt;<i> pointer is stored (it can be a register or a reg+offset).
</I>&gt;<i> The unwind code has access to the registers, so it can retrieve the
</I>&gt;<i> pointer value and call mono_monitor_leave ().
</I>&gt;<i> The info in MonoJitInfo needs to be saved in mini_method_compile()
</I>&gt;<i> from cfg-&gt;varinfo [0] at line about 5670 in mini.c.
</I>&gt;<i> 
</I>&gt;<i> lupus
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000406.html">[Mono-devel-list] implementing the synchronized method a
</A></li>
	<LI>Next message: <A HREF="000408.html">[Mono-devel-list] implementing the synchronized method a
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#407">[ date ]</a>
              <a href="thread.html#407">[ thread ]</a>
              <a href="subject.html#407">[ subject ]</a>
              <a href="author.html#407">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
