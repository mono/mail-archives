<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Performance of Invoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20of%20Invoke&In-Reply-To=BAY104-DAV116FAFC7973EED7F7E5E14A38D0%40phx.gbl">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018913.html">
   <LINK REL="Next"  HREF="018923.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Performance of Invoke</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20of%20Invoke&In-Reply-To=BAY104-DAV116FAFC7973EED7F7E5E14A38D0%40phx.gbl"
       TITLE="[Mono-dev] Performance of Invoke">jonpryor at vt.edu
       </A><BR>
    <I>Wed Jun 14 07:07:16 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018913.html">[Mono-dev] Performance of Invoke
</A></li>
        <LI>Next message: <A HREF="018923.html">[Mono-dev] Performance of Invoke
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18920">[ date ]</a>
              <a href="thread.html#18920">[ thread ]</a>
              <a href="subject.html#18920">[ subject ]</a>
              <a href="author.html#18920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I don't think that design is very good, for a number of reasons:

  - Performance will suck (due to reflection)
  - It's highly &quot;magical&quot; (due to reflection)
  - Documentation will likely be problematic (due to &quot;magic&quot;)

A cleaner, faster, and more easily documented version would be this
(untested):

        //defined in class library
        class FsmEvent {}
        delegate void FsmEventHandler (object o, FsmEvent e);
        class Fsm
        {
            //events can be posted to the event queue and read from the 
            // dispatch loop from a thread...
            public Queue&lt;fsmEvent&gt;  QueueEvent;
        
            public event FsmEventHandler FsmEvent;
        
            public void dispatchEvent()
            {
                FsmEv e = Queue.Dequeue();
                FsmEvent (this, e);
            }
        }
        
        // defined in user library
        class UserFsmEvent : FsmEvent{}
        class FsmTimerEvent : FsmEvent{}
        
        class FsmUser
        {
            public void MyHandler (object o, FsmEvent e)
            {
                bool handled = false;
                if (!handled) handled = HandleUser (e as UserFsmEvent);
                if (!handled) handled = HandleTimer (e as
        FsmTimerEvent);
                if (!handled) {/* default behavior */}
            }
        
            private bool HandleUser (UserFsmEvent e)
            {
                if (e == null) return false;
                /* ... */
                return true;
            }
        
            private bool HandleTimer (UserFsmEvent e)
            {
                if (e == null) return false;
                /* ... */
                return true;
            }
        }

In short, use an event in Fsm to invoke a FsmEventHandler delegate,
which FsmUser.MyHandler matches.  FsmUser.MyHandler then uses normal
(fast!) type casting with `as' to delegate to the appropriate handler.

Sadly, this requires more work on the User's part, but (1) the work is
highly idiomatic, and (2) gives the user complete control, (3) allows
for saner behavior (less &quot;magic&quot;), and (4) provides excellent
performance.  (The only way to get better performance would be to use a
virtual function, and require that FsmUser inherit from Fsm and override
some virtual/abstract method declared within Fsm.)

If the above still doesn't work for you, you'd have to lookup a delegate
type from the FsmEvent type name, e.g. require that all *FsmEvent types
have a matching *FsmEventHandler delegate within the same assembly, then
use Reflection to lookup this *FsmEventHandler type and create an
appropriate delegate.

This won't help you much, though, unless you cache the delegate lookups
within Fsm; always re-looking up this information won't help performance
at all.

 - Jon

On Tue, 2006-06-13 at 22:06 -0500, Tim Michals wrote:
&gt;<i> I've tested on NET the performance of invoke compared to Delegate,
</I>&gt;<i> Delegate 
</I>&gt;<i> is several orders of magnitude faster.  The problem I'm having is
</I>&gt;<i> creating a 
</I>&gt;<i> delegate with the proper type, Delegate.CreateDelegate requires the
</I>&gt;<i> delegate 
</I>&gt;<i> type to be defined.  But the base library only knows the base type not
</I>&gt;<i> the 
</I>&gt;<i> class defined in the user code
</I>&gt;<i> For example...(This is a very basic pseudo code)   Looking for better 
</I>&gt;<i> perfomance then using Invoke..I read some methods of creating LCG but
</I>&gt;<i> is 
</I>&gt;<i> that the only way?
</I>&gt;<i> 
</I>&gt;<i> //defined in class library
</I>&gt;<i> class fsmEvent{}
</I>&gt;<i> class fsm
</I>&gt;<i> {
</I>&gt;<i>     //events can be posted to the event queue and read from the
</I>&gt;<i> dispatch 
</I>&gt;<i> loop from a thread...
</I>&gt;<i>     public Queue&lt;fsmEvent&gt;  QueueEvent;
</I>&gt;<i> 
</I>&gt;<i>  public void dispatchEvent()
</I>&gt;<i>  {
</I>&gt;<i>   ....
</I>&gt;<i>         fsmEv = Queue.dequeue();
</I>&gt;<i>       Type t= userFsm.GetType();
</I>&gt;<i>       MethodInfo mFsmEvent = t.GetMethod(  ... based on fsmEv type,
</I>&gt;<i> match 
</I>&gt;<i> the parameter list)
</I>&gt;<i>     // invoke proper method
</I>&gt;<i>       mFsmEvent.Invoke(userFsm,new
</I>&gt;<i> object[]{ fsmLoop.fsmEventList[0]});
</I>&gt;<i>    // Want to replace this is some type of Delegate for performance...
</I>&gt;<i> 
</I>&gt;<i>      }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> // define in user library
</I>&gt;<i> class userFsmEvent : fsmEvent{}
</I>&gt;<i> class fsmTimerEvent : fsmEvent{}
</I>&gt;<i> 
</I>&gt;<i> class fsmUser
</I>&gt;<i> {
</I>&gt;<i>     public void hander1(fsmEvent ev){}
</I>&gt;<i>     public void handler2(fsmTimerEvent ev){}
</I>&gt;<i>     public void hander3(userFsmEvent ev){}
</I>&gt;<i> 
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018913.html">[Mono-dev] Performance of Invoke
</A></li>
	<LI>Next message: <A HREF="018923.html">[Mono-dev] Performance of Invoke
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18920">[ date ]</a>
              <a href="thread.html#18920">[ thread ]</a>
              <a href="subject.html#18920">[ subject ]</a>
              <a href="author.html#18920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
