<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-Dev] Cecil bug with Custom Attributes with enum parameters
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-Dev%5D%20Cecil%20bug%20with%20Custom%20Attributes%20with%20enum%20parameters&In-Reply-To=Pine.GSO.4.60.0606121814020.20476%40yen">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018883.html">
   <LINK REL="Next"  HREF="018831.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-Dev] Cecil bug with Custom Attributes with enum parameters</H1>
    <B>Eyal Alaluf</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-Dev%5D%20Cecil%20bug%20with%20Custom%20Attributes%20with%20enum%20parameters&In-Reply-To=Pine.GSO.4.60.0606121814020.20476%40yen"
       TITLE="[Mono-Dev] Cecil bug with Custom Attributes with enum parameters">eyala at mainsoft.com
       </A><BR>
    <I>Mon Jun 12 12:24:59 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018883.html">[Mono-Dev] Cecil bug with Custom Attributes with enum parameters
</A></li>
        <LI>Next message: <A HREF="018831.html">[Mono-dev] C++ code as Internal call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18884">[ date ]</a>
              <a href="thread.html#18884">[ thread ]</a>
              <a href="subject.html#18884">[ subject ]</a>
              <a href="author.html#18884">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Attaching changes to makefiles as well.

Date: Mon, 12 Jun 2006 18:38:30 +0300 (IDT)
From: Eyal Alaluf &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">eyala at mainsoft.com</A>&gt;
To: Jb Evain &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono at evain.net</A>&gt;
Cc: Vladislav Spivak &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">spivak at mainsoft.com</A>&gt;, <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Subject: Re: [Mono-Dev] Cecil bug with Custom Attributes with enum parameters

Hi, JB.

Attached is a patch containing the assembly resolver and its usage to resolve
the actual enum type definition ad the enum underlying type.
Several notes about the patch:
   * The resolver is very simple. It searches for &lt;assembly name&gt;.dll in a
     given search path.
       * It doesn't handle issues that may come to mind like thread safety,
         circular dependencies between assemblies, etc.`
   * Since Cecil does not have a search path defined, I made the resolver
     optional as a public field of AssemblyFactory.
   * I also declared an interface for the resolver that will allow more
     complex and customized implementation.
   * I'd recommend adding the &quot;GetEnumUnderlyingType&quot; as a public service.
     Maybe it makes sense to define an IEnumTypeDfinition and add to it an
     &quot;UnderlyingType&quot; property?

I can propose as an alternative design:
   1. Delay load the custom attributes
   2. Provide a way to resolve all the type references in the assembly.
        * Add an &quot;ITypeDefinition TypeDef&quot; property to &quot;ITypeReference&quot;.
        * After initial load of the assembly, the developer can loop over the
          assembly's type references and set this property to the resolved 
type.
   3. The custom attribute code will use the new property whenever it has an
      unresolved type reference.
As this design is more complex and not developer friendly, I didn't follow it
through. Its advantage is that it avoids very nicely the issues of locking
and circular dependencies.
I'd welcome your comments.

Eyal.

On Wed, 7 Jun 2006, Jb Evain wrote:

&gt;<i> Date: Wed, 07 Jun 2006 19:59:12 +0200
</I>&gt;<i> From: Jb Evain &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono at evain.net</A>&gt;
</I>&gt;<i> To: Eyal Alaluf &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">eyala at mainsoft.com</A>&gt;
</I>&gt;<i> Cc: Vladislav Spivak &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">spivak at mainsoft.com</A>&gt;, 
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-Dev] Cecil bug with Custom Attributes with enum 
</I>&gt;<i> parameters
</I>&gt;<i> 
</I>&gt;<i> Hi Eyal,
</I>&gt;<i> 
</I>&gt;&gt;<i> Do you have any plans to resolve this issue? (I assume from the comment
</I>&gt;&gt;<i> in the code
</I>&gt;&gt;<i> that you are familiar with it)
</I>&gt;&gt;<i> What is the design you are looking for in this case? If you want to have
</I>&gt;&gt;<i> Cecil
</I>&gt;&gt;<i> loading the Enum we can contribute our Resolver that is Cecil based.
</I>&gt;<i> 
</I>&gt;<i> The plan is indeed to load the assembly which contains the type 
</I>&gt;<i> definition. If you can contribute your resolver, I'll see how I can 
</I>&gt;<i> integrate it. Then I'll add some kind of ForceLoad method if the custom 
</I>&gt;<i> attribute is not readable at first try.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> Jb
</I>&gt;<i>
</I>-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: cecil.patch
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060612/87decefc/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060612/87decefc/attachment.pl</A> 
-------------- next part --------------
Index: Mono.Cecil.dll.sources

===================================================================

--- Mono.Cecil.dll.sources	(revision 61523)

+++ Mono.Cecil.dll.sources	(working copy)

@@ -118,6 +118,7 @@

 ./Mono.Cecil/ITypeDefinitionCollection.cs
 ./Mono.Cecil/ITypeReference.cs
 ./Mono.Cecil/ITypeReferenceCollection.cs
+./Mono.Cecil/IAssemblyResolver.cs
 ./Mono.Cecil/ITypeSpecification.cs
 ./Mono.Cecil/LinkedResource.cs
 ./Mono.Cecil/ManifestResourceAttributes.cs
@@ -172,6 +173,7 @@

 ./Mono.Cecil/TypeDefinitionCollection.cs
 ./Mono.Cecil/TypeReference.cs
 ./Mono.Cecil/TypeReferenceCollection.cs
+./Mono.Cecil/AssemblyResolver.cs
 ./Mono.Cecil/TypeSpecification.cs
 ./Mono.Cecil/VariantType.cs
 ./Mono.Cecil.Binary/BaseImageVisitor.cs
Index: Mono.Cecil.csproj

===================================================================

--- Mono.Cecil.csproj	(revision 61523)

+++ Mono.Cecil.csproj	(working copy)

@@ -310,6 +310,7 @@

     &lt;Compile Include=&quot;Mono.Cecil\ITypeDefinitionCollection.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\ITypeReference.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\ITypeReferenceCollection.cs&quot; /&gt;

+    &lt;Compile Include=&quot;Mono.Cecil\ITypeResolver.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\ITypeSpecification.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\LinkedResource.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\ManifestResourceAttributes.cs&quot; /&gt;

@@ -364,6 +365,7 @@

     &lt;Compile Include=&quot;Mono.Cecil\TypeDefinitionCollection.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\TypeReference.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\TypeReferenceCollection.cs&quot; /&gt;

+    &lt;Compile Include=&quot;Mono.Cecil\TypeResolver.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\TypeSpecification.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Cecil\VariantType.cs&quot; /&gt;

     &lt;Compile Include=&quot;Mono.Xml\MiniParser.cs&quot; /&gt;

@@ -386,4 +388,4 @@

   &lt;ItemGroup&gt;

     &lt;Reference Include=&quot;System&quot; /&gt;

   &lt;/ItemGroup&gt;

-&lt;/Project&gt;

\ No newline at end of file

+&lt;/Project&gt;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018883.html">[Mono-Dev] Cecil bug with Custom Attributes with enum parameters
</A></li>
	<LI>Next message: <A HREF="018831.html">[Mono-dev] C++ code as Internal call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18884">[ date ]</a>
              <a href="thread.html#18884">[ thread ]</a>
              <a href="subject.html#18884">[ subject ]</a>
              <a href="author.html#18884">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
