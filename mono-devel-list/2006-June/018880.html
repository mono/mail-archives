<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20Abort%20with%20Non-Typical%20Exception%20Handler%20Layout%20on%0A%09Mono%201.1.13.6&In-Reply-To=e6hhv1%24kkg%241%40sea.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018879.html">
   <LINK REL="Next"  HREF="018882.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6</H1>
    <B>Almann T. Goo</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Re%3A%20Abort%20with%20Non-Typical%20Exception%20Handler%20Layout%20on%0A%09Mono%201.1.13.6&In-Reply-To=e6hhv1%24kkg%241%40sea.gmane.org"
       TITLE="[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6">almann.goo at gmail.com
       </A><BR>
    <I>Sun Jun 11 20:29:49 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018879.html">[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6
</A></li>
        <LI>Next message: <A HREF="018882.html">[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18880">[ date ]</a>
              <a href="thread.html#18880">[ thread ]</a>
              <a href="subject.html#18880">[ subject ]</a>
              <a href="author.html#18880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/12/06, Robert Jordan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">robertj at gmx.net</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Maybe the code doesn't pass verification. Test the assembly with pedump
</I>&gt;<i> or MS.NET's PEVerify.
</I>&gt;<i>
</I>
I ran this with PEVerify and got a couple of errors (I had changed the name
of the assembly so I wouldn't get confused with my other example cases):

Microsoft (R) .NET Framework PE Verifier  Version 1.1.4322.573
Copyright (C) Microsoft Corporation 1998-2002. All rights reserved.

[IL]: Error: [d:\tmp\cs\middle.exe : Middle::Main] [exception #0x00000000]
Lexical nesting.
[IL]: Error: [d:\tmp\cs\middle.exe : Middle::Main] [offset 0x00000000]
fallthru the end of an exception block
2 Errors Verifying middle.exe

On closer inspection of ECMA-335, the reason for the first error was that my
previous code violates 12.4.2.7 of Partition I.  Specifically, the paragraph
regarding lexical nesting of protected blocks.  The reason for the second
error is a control fall through violation by the nop (that is unreachable in
my example), this violates 12.4.2.8.1 of Partition I which states that &quot;exit
from a protected block cannot be accomplished via fall through.&quot;  Even
though the nop is unreachable, this is incorrect IL--easy to fix with a
leave that is still unreachable.

Based on that, I have re-formulated my examples and managed to get PEVerify
passable examples that still abort in Mono 1.1.13.6.

D:\tmp\cs&gt;peverify sample.exe

Microsoft (R) .NET Framework PE Verifier  Version 1.1.4322.573
Copyright (C) Microsoft Corporation 1998-2002. All rights reserved.

All Classes and Methods in sample.exe Verified

D:\tmp\cs&gt;peverify sample2.exe

Microsoft (R) .NET Framework PE Verifier  Version 1.1.4322.573
Copyright (C) Microsoft Corporation 1998-2002. All rights reserved.

All Classes and Methods in sample2.exe Verified

D:\tmp\cs&gt;sample.exe
Start
Finally1
Finally2

D:\tmp\cs&gt;sample2.exe
Start
Finally1

In Mono the following happens (same as with the original example):

$ mono sample2.exe

** ERROR **: file mini.c: line 9517 (mini_method_compile): assertion failed:
(tblock-&gt;native_offset)
aborting...
Aborted

$ mono sample.exe

** ERROR **: file mini.c: line 9517 (mini_method_compile): assertion failed:
(tblock-&gt;native_offset)
aborting...
Aborted

I have attached two CIL assembly source files that compile to the examples
used above.  They pass PEVerify and abort in Mono--I believe these two
examples are compliant to the ECMA-335 specification.

Best regards,
Almann

-- 
Almann T. Goo
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">almann.goo at gmail.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060612/8bb5df1a/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060612/8bb5df1a/attachment.html</A> 
-------------- next part --------------
.assembly extern mscorlib {
    .ver 1:0:5000:0
}
.assembly sample2
{
    .ver  0:0:0:0
}
.module sample2.exe

.class public auto ansi beforefieldinit Sample
{
  .method public hidebysig static void Main(string[] args) cil managed
  {
    .entrypoint
    .maxstack  8

    T_START:
        ldstr   &quot;Start&quot;
        call    void [mscorlib]System.Console::WriteLine(string)
        leave.s COMPLETE
    T1_END:

    COMPLETE:
        ret

    F1_START:
        ldstr   &quot;Finally1&quot;
        call    void [mscorlib]System.Console::WriteLine(string)
        endfinally
    F1_END:

    .try T_START to T1_END finally handler F1_START to F1_END

  }
}
-------------- next part --------------
.assembly extern mscorlib {
    .ver 1:0:5000:0
}
.assembly sample
{
    .ver  0:0:0:0
}
.module sample.exe

.class public auto ansi beforefieldinit Sample
{
  .method public hidebysig static void Main(string[] args) cil managed
  {
    .entrypoint
    .maxstack  8

    T_START:
        ldstr   &quot;Start&quot;
        call    void [mscorlib]System.Console::WriteLine(string)
        leave.s COMPLETE
    T1_END:
    F1_START:
        ldstr   &quot;Finally1&quot;
        call    void [mscorlib]System.Console::WriteLine(string)
        endfinally
    F1_END:
        leave.s COMPLETE
    T2_END:

    COMPLETE:
        ret

    F2_START:
        ldstr   &quot;Finally2&quot;
        call    void [mscorlib]System.Console::WriteLine(string)
        endfinally
    F2_END:

    .try T_START to T1_END finally handler F1_START to F1_END
    .try T_START to T2_END finally handler F2_START to F2_END

  }
}
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018879.html">[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6
</A></li>
	<LI>Next message: <A HREF="018882.html">[Mono-dev] Re: Abort with Non-Typical Exception Handler Layout on	Mono 1.1.13.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18880">[ date ]</a>
              <a href="thread.html#18880">[ thread ]</a>
              <a href="subject.html#18880">[ subject ]</a>
              <a href="author.html#18880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
