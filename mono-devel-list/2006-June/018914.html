<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Speed up ByteEncoding.GetString()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Speed%20up%20ByteEncoding.GetString%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018911.html">
   <LINK REL="Next"  HREF="018924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Speed%20up%20ByteEncoding.GetString%28%29&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()">kornelpal at gmail.com
       </A><BR>
    <I>Tue Jun 13 23:21:43 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018911.html">[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()
</A></li>
        <LI>Next message: <A HREF="018924.html">[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18914">[ date ]</a>
              <a href="thread.html#18914">[ thread ]</a>
              <a href="subject.html#18914">[ subject ]</a>
              <a href="author.html#18914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

The results:
length, conversion: time
1, byte[]: 3391
1, byte[] int int: 3187
4, byte[]: 3641
4, byte[] int int: 3625
1024, byte[]: 14266
1024, byte[] int int: 14187
1048576, byte[]: 8703
1048576, byte[] int int: 8812

Altough I didn't attached performance tests for this patch it's still fast 
indeed. These seem to be a bit slower than the patch using reflection but I 
think it's still correct that this implementation is about three time faster 
than the previous implementation in SVN. Note there is little improvement on 
using InternalAllocateStr when is not called using call instruction. Using 
delegates is the fastest late binding solution but it's still way slower 
than call.

It may be improper to assume that there is an internal method called 
InternalAllocateStr even more improper to assume that strings can be 
modified but I don't think that using reflection to access non-public 
members is improper. If the code has ReflectionPermissionFlag.MemberAccess 
permission it works properly. Otherwise MethodAccessException is thrown that 
can be identified. If we believe that our class library has to work properly 
without full trust we should avoid unsafe code, P/Invoke and almost 
everything that requires more permissions than 
SecurityPermissionFlag.Execution. If we assume full trust however we can use 
unsafe code, P/Invoke, reflection as well as anything else in our class 
library. Note that MS.NET class library assemblies assume as well that they 
are executed with full trust. Also note that I'm not fighting for 
InternalAllocateStr I just speaking about reflection

I attached a test that shows the relation of reflection and CAS.

Korn&#233;l

----- Original Message ----- 
From: &quot;Atsushi Eno&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">atsushi at ximian.com</A>&gt;
To: &quot;Korn&#233;l P&#225;l&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>&gt;
Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Wednesday, June 14, 2006 3:47 AM
Subject: Re: [Mono-dev] [PATCH] Speed up ByteEncoding.GetString()


&gt;&gt;<i> I committed the patch. Note according to my test result this 
</I>&gt;&gt;<i> implementation
</I>&gt;&gt;<i> is about three times faster than the previous one so I consider it to be
</I>&gt;&gt;<i> obvious improvement. Of course this only affects ByteEncoding.GetString()
</I>&gt;&gt;<i> but other encodings were not using StringBuilder so they are faster 
</I>&gt;&gt;<i> altough
</I>&gt;&gt;<i> they could be improved using unsafe code but that requires some
</I>&gt;&gt;<i> infrastructural changes in I18N.
</I>&gt;<i>
</I>&gt;<i> No, you didn't post anything about the perf. result *after* the
</I>&gt;<i> change to remove improper reflection stuff.
</I>&gt;<i>
</I>&gt;&gt;<i> For the referenced bug:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When calling for example MethodInfo.Invoke or Delegate.CreateDelegate 
</I>&gt;&gt;<i> without ReflectionPermissionFlag.MemberAccess permission 
</I>&gt;&gt;<i> MethodAccessException has to be thrown. But I don't think that this is a 
</I>&gt;&gt;<i> mysterious bug. This behaviour is documented on MSDN and if you search 
</I>&gt;&gt;<i> for MethodAccessException you will find the methods that throw 
</I>&gt;&gt;<i> MethodAccessException with the description when they trow it.
</I>&gt;<i>
</I>&gt;<i> Well, I know. Otherwise it is too weird that I mentioned that
</I>&gt;<i> bug here.
</I>&gt;<i>
</I>&gt;<i> Atsushi Eno 
</I>-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: AllocateStringTest.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060614/1758ff31/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060614/1758ff31/attachment.pl</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018911.html">[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()
</A></li>
	<LI>Next message: <A HREF="018924.html">[Mono-dev] [PATCH] Speed up ByteEncoding.GetString()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18914">[ date ]</a>
              <a href="thread.html#18914">[ thread ]</a>
              <a href="subject.html#18914">[ subject ]</a>
              <a href="author.html#18914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
