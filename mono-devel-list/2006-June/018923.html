<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Performance of Invoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20of%20Invoke&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018920.html">
   <LINK REL="Next"  HREF="018915.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Performance of Invoke</H1>
    <B>Tim Michals</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Performance%20of%20Invoke&In-Reply-To="
       TITLE="[Mono-dev] Performance of Invoke">tcmichals at msn.com
       </A><BR>
    <I>Wed Jun 14 07:53:35 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018920.html">[Mono-dev] Performance of Invoke
</A></li>
        <LI>Next message: <A HREF="018915.html">[Mono-dev] Single thread scheduler for Threading.Timers patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18923">[ date ]</a>
              <a href="thread.html#18923">[ thread ]</a>
              <a href="subject.html#18923">[ subject ]</a>
              <a href="author.html#18923">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The goal is to provide a polymorphic functions or delegates based on the 
type of data being past.  Yes, you are correct, this is what I have 
currently but the fsmEvent function has a switch statement decoding the 
type.  In the code I provided, I do have cache of functions, methodInfo etc 
in a tree to assist performance.

----- Original Message ----- 
From: &quot;Jonathan Pryor&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">jonpryor at vt.edu</A>&gt;
To: &quot;Tim Michals&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">tcmichals at msn.com</A>&gt;
Cc: &quot;mono-devel&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Wednesday, June 14, 2006 6:07 AM
Subject: Re: [Mono-dev] Performance of Invoke


&gt;<i>I don't think that design is very good, for a number of reasons:
</I>&gt;<i>
</I>&gt;<i>  - Performance will suck (due to reflection)
</I>&gt;<i>  - It's highly &quot;magical&quot; (due to reflection)
</I>&gt;<i>  - Documentation will likely be problematic (due to &quot;magic&quot;)
</I>&gt;<i>
</I>&gt;<i> A cleaner, faster, and more easily documented version would be this
</I>&gt;<i> (untested):
</I>&gt;<i>
</I>&gt;<i>        //defined in class library
</I>&gt;<i>        class FsmEvent {}
</I>&gt;<i>        delegate void FsmEventHandler (object o, FsmEvent e);
</I>&gt;<i>        class Fsm
</I>&gt;<i>        {
</I>&gt;<i>            //events can be posted to the event queue and read from the
</I>&gt;<i>            // dispatch loop from a thread...
</I>&gt;<i>            public Queue&lt;fsmEvent&gt;  QueueEvent;
</I>&gt;<i>
</I>&gt;<i>            public event FsmEventHandler FsmEvent;
</I>&gt;<i>
</I>&gt;<i>            public void dispatchEvent()
</I>&gt;<i>            {
</I>&gt;<i>                FsmEv e = Queue.Dequeue();
</I>&gt;<i>                FsmEvent (this, e);
</I>&gt;<i>            }
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i>        // defined in user library
</I>&gt;<i>        class UserFsmEvent : FsmEvent{}
</I>&gt;<i>        class FsmTimerEvent : FsmEvent{}
</I>&gt;<i>
</I>&gt;<i>        class FsmUser
</I>&gt;<i>        {
</I>&gt;<i>            public void MyHandler (object o, FsmEvent e)
</I>&gt;<i>            {
</I>&gt;<i>                bool handled = false;
</I>&gt;<i>                if (!handled) handled = HandleUser (e as UserFsmEvent);
</I>&gt;<i>                if (!handled) handled = HandleTimer (e as
</I>&gt;<i>        FsmTimerEvent);
</I>&gt;<i>                if (!handled) {/* default behavior */}
</I>&gt;<i>            }
</I>&gt;<i>
</I>&gt;<i>            private bool HandleUser (UserFsmEvent e)
</I>&gt;<i>            {
</I>&gt;<i>                if (e == null) return false;
</I>&gt;<i>                /* ... */
</I>&gt;<i>                return true;
</I>&gt;<i>            }
</I>&gt;<i>
</I>&gt;<i>            private bool HandleTimer (UserFsmEvent e)
</I>&gt;<i>            {
</I>&gt;<i>                if (e == null) return false;
</I>&gt;<i>                /* ... */
</I>&gt;<i>                return true;
</I>&gt;<i>            }
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i> In short, use an event in Fsm to invoke a FsmEventHandler delegate,
</I>&gt;<i> which FsmUser.MyHandler matches.  FsmUser.MyHandler then uses normal
</I>&gt;<i> (fast!) type casting with `as' to delegate to the appropriate handler.
</I>&gt;<i>
</I>&gt;<i> Sadly, this requires more work on the User's part, but (1) the work is
</I>&gt;<i> highly idiomatic, and (2) gives the user complete control, (3) allows
</I>&gt;<i> for saner behavior (less &quot;magic&quot;), and (4) provides excellent
</I>&gt;<i> performance.  (The only way to get better performance would be to use a
</I>&gt;<i> virtual function, and require that FsmUser inherit from Fsm and override
</I>&gt;<i> some virtual/abstract method declared within Fsm.)
</I>&gt;<i>
</I>&gt;<i> If the above still doesn't work for you, you'd have to lookup a delegate
</I>&gt;<i> type from the FsmEvent type name, e.g. require that all *FsmEvent types
</I>&gt;<i> have a matching *FsmEventHandler delegate within the same assembly, then
</I>&gt;<i> use Reflection to lookup this *FsmEventHandler type and create an
</I>&gt;<i> appropriate delegate.
</I>&gt;<i>
</I>&gt;<i> This won't help you much, though, unless you cache the delegate lookups
</I>&gt;<i> within Fsm; always re-looking up this information won't help performance
</I>&gt;<i> at all.
</I>&gt;<i>
</I>&gt;<i> - Jon
</I>&gt;<i>
</I>&gt;<i> On Tue, 2006-06-13 at 22:06 -0500, Tim Michals wrote:
</I>&gt;&gt;<i> I've tested on NET the performance of invoke compared to Delegate,
</I>&gt;&gt;<i> Delegate
</I>&gt;&gt;<i> is several orders of magnitude faster.  The problem I'm having is
</I>&gt;&gt;<i> creating a
</I>&gt;&gt;<i> delegate with the proper type, Delegate.CreateDelegate requires the
</I>&gt;&gt;<i> delegate
</I>&gt;&gt;<i> type to be defined.  But the base library only knows the base type not
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> class defined in the user code
</I>&gt;&gt;<i> For example...(This is a very basic pseudo code)   Looking for better
</I>&gt;&gt;<i> perfomance then using Invoke..I read some methods of creating LCG but
</I>&gt;&gt;<i> is
</I>&gt;&gt;<i> that the only way?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> //defined in class library
</I>&gt;&gt;<i> class fsmEvent{}
</I>&gt;&gt;<i> class fsm
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>     //events can be posted to the event queue and read from the
</I>&gt;&gt;<i> dispatch
</I>&gt;&gt;<i> loop from a thread...
</I>&gt;&gt;<i>     public Queue&lt;fsmEvent&gt;  QueueEvent;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  public void dispatchEvent()
</I>&gt;&gt;<i>  {
</I>&gt;&gt;<i>   ....
</I>&gt;&gt;<i>         fsmEv = Queue.dequeue();
</I>&gt;&gt;<i>       Type t= userFsm.GetType();
</I>&gt;&gt;<i>       MethodInfo mFsmEvent = t.GetMethod(  ... based on fsmEv type,
</I>&gt;&gt;<i> match
</I>&gt;&gt;<i> the parameter list)
</I>&gt;&gt;<i>     // invoke proper method
</I>&gt;&gt;<i>       mFsmEvent.Invoke(userFsm,new
</I>&gt;&gt;<i> object[]{ fsmLoop.fsmEventList[0]});
</I>&gt;&gt;<i>    // Want to replace this is some type of Delegate for performance...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> // define in user library
</I>&gt;&gt;<i> class userFsmEvent : fsmEvent{}
</I>&gt;&gt;<i> class fsmTimerEvent : fsmEvent{}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class fsmUser
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>     public void hander1(fsmEvent ev){}
</I>&gt;&gt;<i>     public void handler2(fsmTimerEvent ev){}
</I>&gt;&gt;<i>     public void hander3(userFsmEvent ev){}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018920.html">[Mono-dev] Performance of Invoke
</A></li>
	<LI>Next message: <A HREF="018915.html">[Mono-dev] Single thread scheduler for Threading.Timers patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18923">[ date ]</a>
              <a href="thread.html#18923">[ thread ]</a>
              <a href="subject.html#18923">[ subject ]</a>
              <a href="author.html#18923">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
