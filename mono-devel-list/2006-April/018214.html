<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20GetString%20to%20UnicodeEncoding%202.0%0A%09andmodifysome%20Encoding%20wrappers&In-Reply-To=001101c65e35%24c9167e50%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018203.html">
   <LINK REL="Next"  HREF="018204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20GetString%20to%20UnicodeEncoding%202.0%0A%09andmodifysome%20Encoding%20wrappers&In-Reply-To=001101c65e35%24c9167e50%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers">atsushi at ximian.com
       </A><BR>
    <I>Thu Apr 13 03:35:17 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018203.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
        <LI>Next message: <A HREF="018204.html">[Mono-dev] StructLayout with misaligned offsets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18214">[ date ]</a>
              <a href="thread.html#18214">[ thread ]</a>
              <a href="subject.html#18214">[ subject ]</a>
              <a href="author.html#18214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i> This is the revised version of my original patch. Please approve this 
</I>&gt;<i> one and the other things can be modified (if needed) later.
</I>
Comments inline (btw as it is often asked, text/plain is better than
application/octet-stream for patch attachments for review).

&gt;<i> @@ -146,8 +146,7 @@
</I>&gt;<i>  				return GetBytesInternal (charPtr + charIndex, charCount, bytePtr + byteIndex, byteCount);
</I>&gt;<i>  	}
</I>&gt;<i>  
</I>&gt;<i> -#if !NET_2_0
</I>&gt;<i> -	public unsafe override byte [] GetBytes (String s)
</I>&gt;<i> +	public override byte [] GetBytes (String s)
</I>&gt;<i>  	{
</I>&gt;<i>  		if (s == null)
</I>&gt;<i>  			throw new ArgumentNullException (&quot;s&quot;);
</I>&gt;<i> @@ -155,14 +154,10 @@
</I>&gt;<i>  		int byteCount = GetByteCount (s);
</I>&gt;<i>  		byte [] bytes = new byte [byteCount];
</I>&gt;<i>  
</I>&gt;<i> -		if (byteCount != 0)
</I>&gt;<i> -			fixed (char* charPtr = s)
</I>&gt;<i> -				fixed (byte* bytePtr = bytes)
</I>&gt;<i> -					GetBytesInternal (charPtr, s.Length, bytePtr, byteCount);
</I>&gt;<i> +		GetBytes (s, 0, s.Length, bytes, 0);
</I>&gt;<i>  
</I>&gt;<i>  		return bytes;
</I>&gt;<i>  	}
</I>&gt;<i> -#endif
</I>&gt;<i>  
</I>&gt;<i>  	public unsafe override int GetBytes (String s, int charIndex, int charCount,
</I>&gt;<i>  										byte [] bytes, int byteIndex)
</I>
Why do you *dare* make API mismatch here? Don't remove #if NET_2_0.
It does not improve anything.

&gt;<i> @@ -300,6 +299,30 @@
</I>&gt;<i>  	}
</I>&gt;<i>  #endif
</I>&gt;<i>  
</I>&gt;<i> +	// Decode a buffer of bytes into a string.
</I>&gt;<i> +	public unsafe override String GetString (byte [] bytes, int index, int count)
</I>&gt;<i> +	{
</I>&gt;<i> +		if (bytes == null)
</I>&gt;<i> +			throw new ArgumentNullException (&quot;bytes&quot;);
</I>&gt;<i> +		if (index &lt; 0 || index &gt; bytes.Length)
</I>&gt;<i> +			throw new ArgumentOutOfRangeException (&quot;index&quot;, _(&quot;ArgRange_Array&quot;));
</I>&gt;<i> +		if (count &lt; 0 || count &gt; (bytes.Length - index))
</I>&gt;<i> +			throw new ArgumentOutOfRangeException (&quot;count&quot;, _(&quot;ArgRange_Array&quot;));
</I>&gt;<i> +
</I>&gt;<i> +		if (count == 0)
</I>&gt;<i> +			return string.Empty;
</I>&gt;<i> +
</I>&gt;<i> +		// GetCharCountInternal
</I>&gt;<i> +		int charCount = count / 2;
</I>&gt;<i> +		string s = string.InternalAllocateStr (charCount);
</I>&gt;<i> +
</I>&gt;<i> +		fixed (byte* bytePtr = bytes)
</I>&gt;<i> +			fixed (char* charPtr = s)
</I>&gt;<i> +				GetCharsInternal (bytePtr + index, count, charPtr, charCount);
</I>&gt;<i> +
</I>&gt;<i> +		return s;
</I>&gt;<i> +	}
</I>&gt;<i> +
</I>&gt;<i>  	private unsafe int GetCharsInternal (byte* bytes, int byteCount,
</I>&gt;<i>  										char* chars, int charCount)
</I>&gt;<i>  	{
</I>
So, this is the part that you said it is (will be) overriden only in
Mono (for 1.1), right? I think this 1/2 memory consumption is awesome :)

Other than the first point it looks good. Thanks Korn&#233;l.

Atsushi Eno

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018203.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
	<LI>Next message: <A HREF="018204.html">[Mono-dev] StructLayout with misaligned offsets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18214">[ date ]</a>
              <a href="thread.html#18214">[ thread ]</a>
              <a href="subject.html#18214">[ subject ]</a>
              <a href="author.html#18214">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
