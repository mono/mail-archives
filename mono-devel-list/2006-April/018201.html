<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20GetString%20to%20UnicodeEncoding%202.0%0A%09andmodifysome%20Encoding%20wrappers&In-Reply-To=004901c65e18%24ec1d5850%240100a8c0%40kornelpal.hu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018200.html">
   <LINK REL="Next"  HREF="018202.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers</H1>
    <B>Atsushi Eno</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Add%20GetString%20to%20UnicodeEncoding%202.0%0A%09andmodifysome%20Encoding%20wrappers&In-Reply-To=004901c65e18%24ec1d5850%240100a8c0%40kornelpal.hu"
       TITLE="[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers">atsushi at ximian.com
       </A><BR>
    <I>Wed Apr 12 08:04:49 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018200.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
        <LI>Next message: <A HREF="018202.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18201">[ date ]</a>
              <a href="thread.html#18201">[ thread ]</a>
              <a href="subject.html#18201">[ subject ]</a>
              <a href="author.html#18201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Here's the real answer.

I might not be fully understanding you, but if you are saying that
your current patch as is should be applied, then it's no-go (due
to the big difference in ASCII and Unicode as you showed us).

Note that I'm not saying that performance is always higher-rated
matter than compatibility (I'm actually rather anti-pro-optimization
dude than others). If there is a way to achieves this &quot;compatibility&quot;
and does not harm performance, it'd be awesome. I'm just not for
*extermism*. The reason you were once convinced was not because the
evidences are numbers but because the differences are significant.

(Hey, there is no doubt that I love your detailed analysis BTW :-)

I agree with you on that we had better feel free to override virtual
stuff that does not result in MissingMethodException (but it might
be only myself).

For individual changes other than that performance loss, there are
certain goodness in your patches. But for some I'm not convinced
(such as giving new byte [1]) because you really don't provide
evident NUnit tests.

If you don't write any, I will create ones for some changes that I am
convinced. But as I've written in the first reply, the difference is
so minor that it is low priority for me.

BTW thanks for the decent tester code. It conceived me that there are
still some optimizible things.

Atsushi Eno

Korn&#233;l P&#225;l wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I've done some tests:
</I>&gt;<i> New 1.1:
</I>&gt;<i> UnicodeEncoding: 6750
</I>&gt;<i> ASCIIEncoding: 18609
</I>&gt;<i> UTF8Encoding: 9922
</I>&gt;<i> CP932: 14641
</I>&gt;<i> 
</I>&gt;<i> New 2.0:
</I>&gt;<i> UnicodeEncoding: 13594
</I>&gt;<i> ASCIIEncoding: 19562
</I>&gt;<i> UTF8Encoding: 16625
</I>&gt;<i> CP932: 38906
</I>&gt;<i> 
</I>&gt;<i> Old 1.1:
</I>&gt;<i> UnicodeEncoding: 6906
</I>&gt;<i> ASCIIEncoding: 18859
</I>&gt;<i> UTF8Encoding: 10062
</I>&gt;<i> CP932: 21719
</I>&gt;<i> 
</I>&gt;<i> Old 2.0:
</I>&gt;<i> UnicodeEncoding: 6750
</I>&gt;<i> ASCIIEncoding: 7297
</I>&gt;<i> UTF8Encoding: 16719
</I>&gt;<i> CP932: 45469
</I>&gt;<i> 
</I>&gt;<i> I have the following conclusion:
</I>&gt;<i> 
</I>&gt;<i> UnicodeEncoding in 2.0 is slower because GetBytes(string) is not 
</I>&gt;<i> overridden. But performance is improved in 1.1 because the overridden 
</I>&gt;<i> implementation optimized for UnicodeEncoding.
</I>&gt;<i> 
</I>&gt;<i> In ASCIIEncoding you can see the drawback of doing optimizations in 
</I>&gt;<i> Encoding class because the current code is only faster on 2.0. Using the 
</I>&gt;<i> new code 1.1 didn't change because not using unsafe code.
</I>&gt;<i> 
</I>&gt;<i> There is no change in UTF8Encoding (or little but improvement is minimal).
</I>&gt;<i> 
</I>&gt;<i> CP932 is faster because optimization is done in MonoEncoding.
</I>&gt;<i> 
</I>&gt;<i> As a conclusion I think that Encoding should be MS.NET compatible 
</I>&gt;<i> because it's more likely to be used by users. And no improvement can be 
</I>&gt;<i> done in profile 1.1 because there are no unsafe methods so there is no 
</I>&gt;<i> use to sacrifice compatibility for performance.
</I>&gt;<i> 
</I>&gt;<i> I think that the best solution for encoding optimization is to use a 
</I>&gt;<i> single unsafe implementation (for each funtionality; GetBytes, GetChars, 
</I>&gt;<i> GetByteCount, GetCharCount) and other methods (string, char[], byte[]) 
</I>&gt;<i> are calling this single implementation. This makes the code more 
</I>&gt;<i> maintainable as well. This is what I've done in UnicodeEncoding.
</I>&gt;<i> 
</I>&gt;<i> And I think the point where we shouldn't care about MS.NET compatibility 
</I>&gt;<i> are the derived public encoding classes; we should override as much 
</I>&gt;<i> methods as we need even if they aren't overridden in MS.NET. (For 
</I>&gt;<i> private encoding classes layout compatibility is not requirement.)
</I>&gt;<i> 
</I>&gt;<i> For example if I remove !NET_2_0 and NET_2_0 from GetBytes(string) and 
</I>&gt;<i> GetString(byte[], int, int) in UnicodeEncoding significant performance 
</I>&gt;<i> improvement can be achieved in all profiles.
</I>&gt;<i> 
</I>&gt;<i> Is this &quot;deal&quot; acceptable? If you have any objections please let me know.
</I>&gt;<i> 
</I>&gt;<i> Korn&#233;l
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018200.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
	<LI>Next message: <A HREF="018202.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0	andmodifysome Encoding wrappers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18201">[ date ]</a>
              <a href="thread.html#18201">[ thread ]</a>
              <a href="subject.html#18201">[ subject ]</a>
              <a href="author.html#18201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
