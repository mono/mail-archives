<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono Continuations and MicroThreads
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20Continuations%20and%20MicroThreads&In-Reply-To=Pine.LNX.4.64.0604040009090.25870%40baal.bat.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017991.html">
   <LINK REL="Next"  HREF="017996.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono Continuations and MicroThreads</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono%20Continuations%20and%20MicroThreads&In-Reply-To=Pine.LNX.4.64.0604040009090.25870%40baal.bat.org"
       TITLE="[Mono-dev] Mono Continuations and MicroThreads">lupus at ximian.com
       </A><BR>
    <I>Tue Apr  4 06:10:35 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017991.html">[Mono-dev] Mono Continuations and MicroThreads
</A></li>
        <LI>Next message: <A HREF="017996.html">[Mono-dev] Mono Speed and Intermediate Language
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18006">[ date ]</a>
              <a href="thread.html#18006">[ thread ]</a>
              <a href="subject.html#18006">[ subject ]</a>
              <a href="author.html#18006">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/04/06 Tomi Valkeinen wrote:
&gt;<i> Attached is a small patch to mono runtime that implements continuations 
</I>&gt;<i> for amd64 and x86 linux, two C# files that implement basic 
</I>&gt;<i> MicroThread-stuff, and some C# test programs. You can also get a full 
</I>
Wow! Nice:)

&gt;<i> About the overall implementation: IT'S A HACK! =). It works, but I know 
</I>&gt;<i> many ways to break it. It lacks sanity checks. It probably misses a few 
</I>&gt;<i> arguments every now and then. It kinda ignores GC, which probably will 
</I>&gt;<i> also break it. The new GC will probably break it even more. I haven't even 
</I>
If you allocate the area where you store the stack with with
mono_gc_alloc_fixed (size, NULL), both the old and the new GC will
conservatively scan the area for pointers (but make sure that when you
copy it the values are properly aligned (start and top of the copied
stack must be pointer-sized aligned)). You currently use malloc/g_new,
so even the current GC won't see the objects and collect them.
The effect on the new GC will be mostly to slow it down, since it won't
be able to move the objects that may be referenced by the saved stack
(this of course depends on how many objects are referenced and how large
they are).

&gt;<i> thought about CAS. Not forgetting the millions of things that I don't know 
</I>&gt;<i> about that will also break it. But still, the tests I've included work, 
</I>&gt;<i> and it's been great fun playing with them.
</I>
You should likely have the size of the saved stack as a param and of
course you'd need to check for overflows on it.
Also, for continuations that include managed-&gt;unmanaged-&gt;managed
transitions, you need to save and restore the LMF chain (I haven't
checked all your code, so maybe you handle that already).

&gt;<i> My first question to the list is: is anyone else interested in this, using 
</I>&gt;<i> continuations and/or developing them further? Shall I keep quiet from this 
</I>&gt;<i> on or do you want to hear more?
</I>
I think every interesting and clever development with mono is on topic
for this list:) I would love if people would contribute to and enhance your
version. We always envisioned mono as a virtual machine that enables
such projects and support for continuations would enable also more
languages to be targeted at running on the mono runtime...

&gt;<i> My second question is: how to make the native code better? I don't know 
</I>&gt;<i> much about Mono internals, this was my first mono runtime project so all 
</I>&gt;<i> feedback is appreciated. Also I'd very much like to hear if someone can 
</I>&gt;<i> point out why this way of implementing continuations to Monois 
</I>&gt;<i> fundamentally flawed. This requires reading the code, but if some of you 
</I>&gt;<i> Mono-gurus have the time and can educate me...
</I>
See above for a way to deal with GC issues.
Eventually also security info in the stack frames would need to be
saved and you'd have to deal with cross-appdomain transitions.
This mechanism can't work in some scenarios, but they are not easily
accessed in C# code anyway (passing the address of a local var to a real
subthread that is supposed to store or read from it: the stack is saved
and restored bu the subthread doesn't know it ...).

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017991.html">[Mono-dev] Mono Continuations and MicroThreads
</A></li>
	<LI>Next message: <A HREF="017996.html">[Mono-dev] Mono Speed and Intermediate Language
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18006">[ date ]</a>
              <a href="thread.html#18006">[ thread ]</a>
              <a href="subject.html#18006">[ subject ]</a>
              <a href="author.html#18006">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
