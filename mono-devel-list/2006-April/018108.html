<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] FAMWatcher race condition patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20FAMWatcher%20race%20condition%20patch&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018131.html">
   <LINK REL="Next"  HREF="018147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] FAMWatcher race condition patch</H1>
    <B>Thong Nguyen</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20FAMWatcher%20race%20condition%20patch&In-Reply-To="
       TITLE="[Mono-dev] FAMWatcher race condition patch">tum at veridicus.com
       </A><BR>
    <I>Sun Apr  9 00:37:06 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="018131.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0 and	modifysome Encoding wrappers
</A></li>
        <LI>Next message: <A HREF="018147.html">[Mono-dev] FAMWatcher race condition patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18108">[ date ]</a>
              <a href="thread.html#18108">[ thread ]</a>
              <a href="subject.html#18108">[ subject ]</a>
              <a href="author.html#18108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The FAM based FileSystemWatcher has problems monitoring directories
recursively because FAM doesn't support this natively.

FMAWatcher gets around this by telling FAM to monitor a subdirectory every
time a sub directory is created.  This will work but there is a race
condition that occurs when a sub directory is created and populated with
files before FAM is told to monitor the new sub directory.  This results in
files being created without the FSW raising the appropriate events.


For example:

If I'm monitoring the current dir and I do this:

mkdir a; touch a/pok

FAMWatcher should generated a &quot;created a&quot; and a &quot;created pok&quot; event but
actually only generates a &quot;created a&quot; event because the file pok is created
before FAM is told to monitor the ./a directory.  If I put a &quot;sleep 1&quot; pause
between the mkdir and the touch commands FAMWatcher generates the &quot;created
pok&quot; event ok.

The attached patch will help with this situation scanning and raising a
created event for each file or directory discovered in a newly created sub
directory *after* fam is told to monitor it this new sub directory but
before fam events for the new sub directory are dispatched.

The patch isn't perfect.  In some extreme cases, a duplicate created event
may be raised.  The duplicate event would theoretically only occur if the
file is created after FAM is told to monitor the new sub directory but
before the manual scan for the directory (usually a very short amount of
time).  The duplicate event is not ideal but is IMO, much better than
silently missing an event altogether and compared to the race bug in the
example, is a race bug that is very, very unlikely to occur and is not very
detrimental when it occurs.  Most applications will handle the duplicate
created event fine if and when it occurs.

By doing some logging and checking time stamps the duplicate event could be
eliminated but that would require doing a stat() etc on the file/dir and I'm
not sure if the performance hit is worth it...what do people think?

Regards,

^Tum
-------------- next part --------------
A non-text attachment was scrubbed...
Name: fam.patch
Type: application/octet-stream
Size: 3010 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060409/b332698b/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20060409/b332698b/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018131.html">[Mono-dev] [PATCH] Add GetString to UnicodeEncoding 2.0 and	modifysome Encoding wrappers
</A></li>
	<LI>Next message: <A HREF="018147.html">[Mono-dev] FAMWatcher race condition patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18108">[ date ]</a>
              <a href="thread.html#18108">[ thread ]</a>
              <a href="subject.html#18108">[ subject ]</a>
              <a href="author.html#18108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
