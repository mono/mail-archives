<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] ToString() in DateTime failed on embedded mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20ToString%28%29%20in%20DateTime%20failed%20on%20embedded%20mono&In-Reply-To=20030708161140.GA6039%40gordon.oo.cdl2000.co.id">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001419.html">
   <LINK REL="Next"  HREF="001444.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] ToString() in DateTime failed on embedded mono</H1>
    <B>eric lindvall</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20ToString%28%29%20in%20DateTime%20failed%20on%20embedded%20mono&In-Reply-To=20030708161140.GA6039%40gordon.oo.cdl2000.co.id"
       TITLE="[Mono-devel-list] ToString() in DateTime failed on embedded mono">eric at 5stops.com
       </A><BR>
    <I>Tue Jul  8 13:12:50 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001419.html">[Mono-devel-list] ToString() in DateTime failed on embedded mono
</A></li>
        <LI>Next message: <A HREF="001444.html">[Mono-devel-list] ToString() in DateTime failed on embedded	mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1421">[ date ]</a>
              <a href="thread.html#1421">[ thread ]</a>
              <a href="subject.html#1421">[ subject ]</a>
              <a href="author.html#1421">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The exact exception you're running into is that Thread.CurrentThread is
returning null. The reason for this is the environment isn't fully setup.

It isn't documented anywhere, but you have to call
mono_runtime_exec_managed_code() after you do your mono_jit_init(), and
have your C function as the callback to mono_runtime_exec_managed_code().

I haven't gotten any response as to if there are other restrictions, which
have lead me to some questions:

- once i've made the call to mono_runtime_exec_managed_code(), can i then run
  code in the main thread?

- once i've made the call to mono_runtime_exec_managed_code(), can i use
  pthread_create() in the main thread and then use
  mono_thread_attach(domain)?

it would really be nice if the embeded-api.html was updated to include all
of the requirements to being able to embed mono.. it took me a few days to
figure out this problem.

e.


On Tue, 08 Jul 2003, Mohammad DAMT wrote:

&gt;<i> I have test.cs:
</I>&gt;<i> using System;
</I>&gt;<i>                                                                                                                                
</I>&gt;<i> namespace Test
</I>&gt;<i> {
</I>&gt;<i>     public class Test
</I>&gt;<i>     {
</I>&gt;<i>         public String test ()
</I>&gt;<i>         {
</I>&gt;<i> 		return DateTime.Now.ToString()
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> and test.c
</I>&gt;<i> #include &lt;mono/jit/jit.h&gt;
</I>&gt;<i> #include &lt;mono/metadata/debug-helpers.h&gt;
</I>&gt;<i>                                                                                                                                
</I>&gt;<i> char* process()
</I>&gt;<i> {
</I>&gt;<i>     MonoDomain *domain;
</I>&gt;<i>     MonoAssembly *assembly;
</I>&gt;<i>     MonoClass *class;
</I>&gt;<i>     MonoMethod *method;
</I>&gt;<i>     MonoMethodDesc *desc;
</I>&gt;<i>     MonoObject *mono_ret, *exception = NULL;
</I>&gt;<i>     gpointer arguments [4];
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> domain = mono_jit_init (&quot;test&quot;);
</I>&gt;<i>     assembly = mono_domain_assembly_open (domain, &quot;test.dll&quot;);
</I>&gt;<i>     if (!assembly) {
</I>&gt;<i>         fprintf (stderr, &quot;Assembly not loaded\n&quot;);
</I>&gt;<i>         mono_jit_cleanup (domain);
</I>&gt;<i>         return NULL;
</I>&gt;<i>     }
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> class = mono_class_from_name (assembly-&gt;image, &quot;Test&quot;, &quot;Test&quot;);
</I>&gt;<i>     if (!class) {
</I>&gt;<i>         fprintf (stderr, &quot;Class not loaded\n&quot;);
</I>&gt;<i>         mono_jit_cleanup (domain);
</I>&gt;<i>         return NULL;
</I>&gt;<i>     }
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> desc = mono_method_desc_new (&quot;:test()&quot;, 0);
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> method = mono_method_desc_search_in_class (desc, class);
</I>&gt;<i>     if (!method) {
</I>&gt;<i>         fprintf (stderr, &quot;Method Desc not loaded\n&quot;);
</I>&gt;<i>         return NULL;
</I>&gt;<i>     }
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> mono_ret = mono_runtime_invoke (method, NULL, NULL, NULL);
</I>&gt;<i>     fprintf(stderr,&quot;xxx\n&quot;);fflush(stderr);
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> mono_jit_cleanup (domain);
</I>&gt;<i>     return (char *) mono_string_to_utf8((MonoString*) mono_ret);
</I>&gt;<i>                                                                                                                                
</I>&gt;<i> }
</I>&gt;<i>                                                                                                                                
</I>&gt;<i> void main () {
</I>&gt;<i>     char *s;
</I>&gt;<i>                                                                                                                                    
</I>&gt;<i> s = process ();
</I>&gt;<i>     fprintf(stderr, &quot;%s\n&quot;, s);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> compile both with:
</I>&gt;<i> mcs /t:library  test.cs -out:test.dll
</I>&gt;<i> and
</I>&gt;<i> gcc -o t test.c `PKG_CONFIG_PATH=/opt/mono/lib/pkgconfig pkg-config 
</I>&gt;<i> --cflags --libs mono`
</I>&gt;<i> 
</I>&gt;<i> when I ran the program:
</I>&gt;<i> [<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mdamt at gordon</A> src]$ ./t
</I>&gt;<i>  Unhandled Exception: System.NullReferenceException: A null value was 
</I>&gt;<i> found where an object instance was required
</I>&gt;<i> in &lt;0x0000f&gt; 00 System.Globalization.DateTimeFormatInfo:get_CurrentInfo 
</I>&gt;<i> ()
</I>&gt;<i> in &lt;0x00066&gt; 00 System.Globalization.DateTimeFormatInfo:GetInstance 
</I>&gt;<i> (System.IFormatProvider)
</I>&gt;<i> in &lt;0x0002b&gt; 00 System.DateTime:ToString (string,System.IFormatProvider)
</I>&gt;<i> in &lt;0x00017&gt; 00 System.DateTime:ToString ()
</I>&gt;<i> in &lt;0x00039&gt; 00 Test.Test:test ()
</I>&gt;<i> 
</I>&gt;<i> [hangs]
</I>&gt;<i> 
</I>&gt;<i> question 1:
</I>&gt;<i> What I expect is the program showing DateTime.Now.ToString() string. If 
</I>&gt;<i> I change DateTime with something like
</I>&gt;<i> &quot;abc&quot;.ToString(), it returns and print &quot;abc&quot;.
</I>&gt;<i> Did I miss something?
</I>&gt;<i> 
</I>&gt;<i> question 2:
</I>&gt;<i> what is the best method to catch the exception like this without 
</I>&gt;<i> hanging?
</I>&gt;<i> 
</I>&gt;<i> thanks
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001419.html">[Mono-devel-list] ToString() in DateTime failed on embedded mono
</A></li>
	<LI>Next message: <A HREF="001444.html">[Mono-devel-list] ToString() in DateTime failed on embedded	mono
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1421">[ date ]</a>
              <a href="thread.html#1421">[ thread ]</a>
              <a href="subject.html#1421">[ subject ]</a>
              <a href="author.html#1421">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
