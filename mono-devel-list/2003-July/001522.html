<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Mono Interpreter: Dietmar's idea.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Mono%20Interpreter%3A%20Dietmar%27s%20idea.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001501.html">
   <LINK REL="Next"  HREF="001523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Mono Interpreter: Dietmar's idea.</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Mono%20Interpreter%3A%20Dietmar%27s%20idea.&In-Reply-To="
       TITLE="[Mono-devel-list] Mono Interpreter: Dietmar's idea.">bernard at ugsolutions.com
       </A><BR>
    <I>Tue Jul 15 16:53:23 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001501.html">[Mono-devel-list] Mono Interpreter: Dietmar's idea.
</A></li>
        <LI>Next message: <A HREF="001523.html">[Mono-devel-list] Mono Interpreter: Dietmar's idea.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1522">[ date ]</a>
              <a href="thread.html#1522">[ thread ]</a>
              <a href="subject.html#1522">[ subject ]</a>
              <a href="author.html#1522">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Having done some experiments with the current interpreter I thought I'd add
a few comments on what I found. I have to admit having only been studying
the interpreter I don't know what the &quot;IR2&quot; list actually contains so
whether what I found is relevant I don't know.

While it is true the current interpreter tracks types on the stack I don't
think this is the major reason for slowness from what I saw (not to say if
instructions were processed such that type checks were unnecessary it would
not be faster). The reasons I noticed are:

- Continual looking up of tokens to get methods/fields/string constants and
so on. If the instructions are preprocessed in some way so that instructions
like LDFLD have the offset directly to hand, you have preloaded string
constants and know where they are so on then a lot of time can be saved per
call. I think this is the area that would give the biggest speed boost
(another
possible preprocess is to fix up endianess &amp; alignment issues in reading
instructions).

- Copying arguments. I am not quite sure why arguments need to be copied
from the callers stack to another block of memory for the callee. At least
for a normal call from interpreted method to interpreted method. The callee
should be able to just use the stackvals in the callers stack directly since
when the call is done the values are immediately popped off the stack
so they can be safely overwritten by STARG. There may be a case where
copying is necessary if the method signature has pinvoke set but that
seems to be rare as if PINVOKE_IMPL or INTERNAL_CALL is
set those cases are taken out (calling delegates from native code
is one case - not sure about others).

- Valuetypes keep hold of their class with the value. As far as I can make
out this is not necessary as it the actual field is only used in two places:
INITOBJ - which has the class as a token which is currently ignored but
could be used instead - and in LDFLD where we can use the class from the
field (I think). So I think stackval can have this removed and be reduced in
size.

Given the current interpretation technique I think all these can be improved
though no doubt there are other areas - and maybe this is all irrelevant
if a completely different style of interpreter is used.

Bernie Solomon

----- Original Message ----- 
From: &quot;Miguel de Icaza&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at ximian.com</A>&gt;
To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at ximian.com</A>&gt;
Sent: Monday, July 14, 2003 10:08 AM
Subject: [Mono-devel-list] Mono Interpreter: Dietmar's idea.


&gt;<i> Hey guys,
</I>&gt;<i>
</I>&gt;<i>    I just saw some commits from Zoltan to the interpreter to speed it
</I>&gt;<i> up, and that reminded me of a proof-of-concept work that Dietmar did
</I>&gt;<i> with the old JIT engine that might be useful again.
</I>&gt;<i>
</I>&gt;<i>    Our interpreter is not very fast, because it has to track type
</I>&gt;<i> information on the stack, for certain opcodes, like this:
</I>&gt;<i>
</I>&gt;<i> ldc.i4.1
</I>&gt;<i> ldc.i4.2
</I>&gt;<i> add
</I>&gt;<i>
</I>&gt;<i>     That will be an integer add, while:
</I>&gt;<i>
</I>&gt;<i> ldc.r4 1.0
</I>&gt;<i> ldc.r3 2.0
</I>&gt;<i> add
</I>&gt;<i>
</I>&gt;<i>     Would be a 4-byte floating point addition.
</I>&gt;<i>
</I>&gt;<i>     What Dietmar did before, is that he made the interpreter work not on
</I>&gt;<i> the original CIL byte sequence, but on the forest-of-trees that we
</I>&gt;<i> generated later.
</I>&gt;<i>
</I>&gt;<i>     With the new JIT, we have a structure like this:
</I>&gt;<i>
</I>&gt;<i> CIL -&gt; IR1 (forest of trees) -&gt; IR2 (list of instructions) -&gt; native code
</I>&gt;<i>
</I>&gt;<i>     So it occurs to me that we could plug an interpreter for the IR2
</I>&gt;<i> set of operations, this would have many benefits: it would reuse many
</I>&gt;<i> of the optimizations we perform on IR1 and IR2, and it would reuse more
</I>&gt;<i> of the JIT code.
</I>&gt;<i>
</I>&gt;<i> Miguel
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001501.html">[Mono-devel-list] Mono Interpreter: Dietmar's idea.
</A></li>
	<LI>Next message: <A HREF="001523.html">[Mono-devel-list] Mono Interpreter: Dietmar's idea.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1522">[ date ]</a>
              <a href="thread.html#1522">[ thread ]</a>
              <a href="subject.html#1522">[ subject ]</a>
              <a href="author.html#1522">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
