<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit issues)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Alpha%20corlib%20mismatched%20sizes.%20%2864-bit%20issues%29&In-Reply-To=33060.12.235.155.180.1057125005.squirrel%40mail.leavitt.us">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001336.html">
   <LINK REL="Next"  HREF="001306.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit issues)</H1>
    <B>Laramie Leavitt</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Re%3A%20Alpha%20corlib%20mismatched%20sizes.%20%2864-bit%20issues%29&In-Reply-To=33060.12.235.155.180.1057125005.squirrel%40mail.leavitt.us"
       TITLE="[Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit issues)">lar at leavitt.us
       </A><BR>
    <I>Wed Jul  2 02:35:05 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001336.html">[Mono-devel-list] Re: Alpha corlib mismatched sizes.
</A></li>
        <LI>Next message: <A HREF="001306.html">[Mono-devel-list] (De)serialization bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1337">[ date ]</a>
              <a href="thread.html#1337">[ thread ]</a>
              <a href="subject.html#1337">[ subject ]</a>
              <a href="author.html#1337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Laramie Leavitt said:
&gt;<i>
</I>&gt;<i> One of the problems is verify.c, around line 2560
</I>&gt;<i>
</I>&gt;<i> 			if (klass-&gt;valuetype)
</I>&gt;<i> 				struct_offset = 8
</I>&gt;<i> 			else
</I>&gt;<i> 				struct_offset = 0;
</I>&gt;<i>
</I>&gt;<i> change to:
</I>&gt;<i> 			if( klass-&gt;valuetype )
</I>&gt;<i> 				struct_offset = 2 * sizeof( void * );
</I>&gt;<i> 			else
</I>&gt;<i> 				struct_offset = 0;
</I>&gt;<i>
</I>&gt;<i> Laramie.
</I>Ok, that results in the following:

field `types' mismatch in class ModuleBuilder (64 != 56)
field `cattrs' mismatch in class ModuleBuilder (72 != 64)
field `guid' mismatch in class ModuleBuilder (80 != 72)
field `table_idx' mismatch in class ModuleBuilder (88 != 80)

field `hresult' mismatch in class Exception (80 != 76)
field `source' mismatch in class Exception (88 != 80)

Looking at these, for example,

typedef struct {
	MonoObject object;
	MonoArray  *trace_ips;
	MonoObject *inner_ex;
	MonoString *message;
	MonoString *help_link;
	MonoString *class_name;
	MonoString *stack_trace;
	MonoString *remote_stack_trace;
	gint32     *remote_stack_index;
	gint32      hresult;
	MonoString *source;
} MonoException;

We see that for some reason the remote_stack_index appears to
be only 4 bytes, and then 4 bytes for the hresult.

I assume that on x86 this is from an optimization to store the pointer
in the index slot, instead of just the index. This ignores the fact that
pointers are aligned to 8 bytes on alpha, and other 64 bit archs.
Remote_stack_index should then be an gint32 instead of a gint32*.

And on to the other case:

typedef struct {
	MonoObject	obj;
	MonoImage  *image;
	MonoReflectionAssembly *assembly;
	MonoString *fqname;
	MonoString *name;
	MonoString *scopename;
	gboolean is_resource;
} MonoReflectionModule;

typedef struct {
	MonoReflectionModule module;
	MonoArray *types;
	MonoArray *cattrs;
	MonoArray *guid;
	guint32    table_idx;
	MonoReflectionAssemblyBuilder *assemblyb;
	MonoArray *global_methods;
	MonoArray *global_fields;
} MonoReflectionModuleBuilder;

This one looks like MonoReflectionModule is too large.
I suspect that adding the gboolean is_resource is the culprit,
but I don't know who did it.

Laramie.





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001336.html">[Mono-devel-list] Re: Alpha corlib mismatched sizes.
</A></li>
	<LI>Next message: <A HREF="001306.html">[Mono-devel-list] (De)serialization bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1337">[ date ]</a>
              <a href="thread.html#1337">[ thread ]</a>
              <a href="subject.html#1337">[ subject ]</a>
              <a href="author.html#1337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
