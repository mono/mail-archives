<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] More 64 bit changes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20More%2064%20bit%20changes&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001339.html">
   <LINK REL="Next"  HREF="001340.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] More 64 bit changes</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20More%2064%20bit%20changes&In-Reply-To="
       TITLE="[Mono-devel-list] More 64 bit changes">bernard at ugsolutions.com
       </A><BR>
    <I>Wed Jul  2 11:54:44 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001339.html">[Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit issues)
</A></li>
        <LI>Next message: <A HREF="001340.html">[Mono-devel-list] Patch to use ExpectedException in Test XmlTextWriterTests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1344">[ date ]</a>
              <a href="thread.html#1344">[ thread ]</a>
              <a href="subject.html#1344">[ subject ]</a>
              <a href="author.html#1344">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry I didn't get some of these changes in earlier... I have had the first
two below for a while though I have not noticed any other struct mismatches
myself other than remote_stack_index....

I attach some further changes to the metadata directory for 64 bits - though
some of them are needed on HP because it is big endian unlike alphas. Also
there are a couple of gcc-isms which these cover too....

There are a couple of things I am not sure about.

The rounding up to just 4 byte boundaries in mono_type_native_stack_size for
value types doesn't look general enough to me (as commented) though I
haven't fallen over it as yet.

mono_runtime_class_init checks for &quot;initializing&quot; and &quot;initialized&quot; but if
it returns early it would leave the domain locked. I have unlocked it but I
actually think the second thread should actually wait for initialized to
become true shouldn't it?

In mono_marshal_type_size I have changed the alignments of 8 byte values so
they are naturally aligned on HP. Things crash without this. However is this
right or should it be that code generates the same binary data on all
platforms which means more testing on whether unaligned access is allowed in
code that manipulates data using the results of this routine.

Bernie Solomon

----- Original Message ----- 
From: &quot;Paolo Molaro&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt;
To: &quot;Laramie Leavitt&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lar at leavitt.us</A>&gt;
Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>&gt;
Sent: Wednesday, July 02, 2003 4:35 AM
Subject: Re: [Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit
issues)


&gt;<i> On 07/01/03 Laramie Leavitt wrote:
</I>&gt;<i> &gt; Laramie Leavitt said:
</I>&gt;<i> &gt; &gt; One of the problems is verify.c, around line 2560
</I>&gt;<i> [...]
</I>&gt;<i> &gt; &gt; change to:
</I>&gt;<i> &gt; &gt; if( klass-&gt;valuetype )
</I>&gt;<i> &gt; &gt; struct_offset = 2 * sizeof( void * );
</I>&gt;<i>
</I>&gt;<i> I used sizeof (MonoObject) for this change.
</I>&gt;<i>
</I>&gt;<i> &gt; gint32     *remote_stack_index;
</I>&gt;<i> &gt; gint32      hresult;
</I>&gt;<i> &gt; MonoString *source;
</I>&gt;<i> &gt; } MonoException;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We see that for some reason the remote_stack_index appears to
</I>&gt;<i> &gt; be only 4 bytes, and then 4 bytes for the hresult.
</I>&gt;<i>
</I>&gt;<i> I think the '*' is a typo, removing it is the correct fix.
</I>&gt;<i>
</I>&gt;<i> &gt; And on to the other case:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; typedef struct {
</I>&gt;<i> &gt; MonoObject obj;
</I>&gt;<i> &gt; MonoImage  *image;
</I>&gt;<i> &gt; MonoReflectionAssembly *assembly;
</I>&gt;<i> &gt; MonoString *fqname;
</I>&gt;<i> &gt; MonoString *name;
</I>&gt;<i> &gt; MonoString *scopename;
</I>&gt;<i> &gt; gboolean is_resource;
</I>&gt;<i>
</I>&gt;<i> This should be MonoBoolean: I committed the fix, though I'm not sure
</I>&gt;<i> it solves your issue: MonoBoolean is 8 bits, gboolean is an int, so I
</I>&gt;<i> guess 32 bits on your alpha, but either way the structure should still
</I>&gt;<i> be padded to the next 8 bytes.
</I>&gt;<i> Are you using a current corlib (like from the 0.25 release)?
</I>&gt;<i> Check that the following command returns a line:
</I>&gt;<i> monodis --fields corlib.dll |grep is_resource
</I>&gt;<i> If it return nothing you have an old corlib, if it returns a line I
</I>&gt;<i> guess the bug is in the field layout code (class.c).
</I>&gt;<i>
</I>&gt;<i> On 07/01/03 Laramie Leavitt wrote:
</I>&gt;<i> &gt; The verify.c change prints out all mismatched values instead of only the
</I>&gt;<i> &gt; first one, which I find helpful.  Someone will probably want to use
</I>&gt;<i> &gt; g_printf( ... ) there,
</I>&gt;<i> &gt; though.
</I>&gt;<i>
</I>&gt;<i> I made it use a GString and concat all the results. Thanks for the
</I>&gt;<i> patch.
</I>&gt;<i>
</I>&gt;<i> lupus
</I>&gt;<i>
</I>&gt;<i> -- 
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: metadata.diffs
Type: application/octet-stream
Size: 7695 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20030702/6e8250e2/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20030702/6e8250e2/attachment.obj</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001339.html">[Mono-devel-list] Re: Alpha corlib mismatched sizes. (64-bit issues)
</A></li>
	<LI>Next message: <A HREF="001340.html">[Mono-devel-list] Patch to use ExpectedException in Test XmlTextWriterTests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1344">[ date ]</a>
              <a href="thread.html#1344">[ thread ]</a>
              <a href="subject.html#1344">[ subject ]</a>
              <a href="author.html#1344">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
