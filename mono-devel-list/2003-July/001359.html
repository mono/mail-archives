<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Bad IL generated for IntPtr -&gt; int32 cast?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Bad%20IL%20generated%20for%20IntPtr%20-%3E%20int32%20cast%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001350.html">
   <LINK REL="Next"  HREF="001360.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Bad IL generated for IntPtr -&gt; int32 cast?</H1>
    <B>Bernie Solomon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Bad%20IL%20generated%20for%20IntPtr%20-%3E%20int32%20cast%3F&In-Reply-To="
       TITLE="[Mono-devel-list] Bad IL generated for IntPtr -&gt; int32 cast?">bernard at ugsolutions.com
       </A><BR>
    <I>Wed Jul  2 21:05:01 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="001350.html">[Mono-devel-list] Missed a 64bit metadata change
</A></li>
        <LI>Next message: <A HREF="001360.html">[Mono-devel-list] Bad IL generated for IntPtr -&gt; int32 cast?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1359">[ date ]</a>
              <a href="thread.html#1359">[ thread ]</a>
              <a href="subject.html#1359">[ subject ]</a>
              <a href="author.html#1359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In working on more 64 bit issues I have discovered some code inside corlib
for some IntPtr casts which I think is wrong. This:

    public static explicit operator int (IntPtr value)
    {
        return (int) value.value;
    }

generates the folowing IL.

    // method line 621
    .method public static  hidebysig  specialname
           default int32 op_Explicit(native int value)  cil managed
    {
        .param [1]
        // Method begins at RVA 0x8015
        // Code size 8 (0x8)
        .maxstack 8
        IL_0000: ldarga.s 0
        IL_0002: ldfld  void* System.IntPtr::value
        IL_0007: ret
    } // end of method IntPtr::default int32 op_Explicit(native int value)

and there is no conv.i4 generated. You will probably get away with this for
a little endian machine even if 64bits but for a big endian 64 bit machine
the conversion actually does something to get the low order 32 bits of the
value. (as necessary when converting the result of Marshal.OffsetOf into an
int.

I think pointer -&gt; int conversions should always generate this IL (which no
doubt JITs can optimize away).

This code is from the 0.25 corlib.dll as in the tarball - I haven't built it
myself - and I haven't looked at mcs to see how to fix it (I assume this was
built using mcs).

Bernie Solomon



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001350.html">[Mono-devel-list] Missed a 64bit metadata change
</A></li>
	<LI>Next message: <A HREF="001360.html">[Mono-devel-list] Bad IL generated for IntPtr -&gt; int32 cast?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1359">[ date ]</a>
              <a href="thread.html#1359">[ thread ]</a>
              <a href="subject.html#1359">[ subject ]</a>
              <a href="author.html#1359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
