<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] CIL to CIL optimizer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CIL%20to%20CIL%20optimizer&In-Reply-To=44DB2944.4010305%40imf.au.dk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019749.html">
   <LINK REL="Next"  HREF="019753.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] CIL to CIL optimizer</H1>
    <B>Rafael Teixeira</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CIL%20to%20CIL%20optimizer&In-Reply-To=44DB2944.4010305%40imf.au.dk"
       TITLE="[Mono-dev] CIL to CIL optimizer">monoman at gmail.com
       </A><BR>
    <I>Thu Aug 10 09:00:36 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="019749.html">[Mono-dev] CIL to CIL optimizer
</A></li>
        <LI>Next message: <A HREF="019753.html">[Mono-dev] CIL to CIL optimizer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19750">[ date ]</a>
              <a href="thread.html#19750">[ thread ]</a>
              <a href="subject.html#19750">[ subject ]</a>
              <a href="author.html#19750">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Have you looked into the implementation of the SSA optimizations our
JIT already does?
You may find useful insights on it, even if it optimizes not CIL but
another intermediary representation and targets native instructions.

:<i>)
</I>
On 8/10/06, Bjarke Hammersholt Roune &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bjarke.roune at gmail.com</A>&gt; wrote:
&gt;<i> Zoltan Varga skrev:
</I>&gt;<i>  &gt;                                      Hi,
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;   What is the problem with try-finally ? There are two cases:
</I>&gt;<i>  &gt; - if there is an exception, the runtime will call it, just with the
</I>&gt;<i> catch clause
</I>&gt;<i>  &gt; - if there is no exception, control flow just falls from the end of
</I>&gt;<i>  &gt; the try block to
</I>&gt;<i>  &gt; the beginning of the finally block. This is just a normal control
</I>&gt;<i> flow edge.
</I>&gt;<i>  &gt;
</I>&gt;<i> The problem is that what happens after the finally block is done depends
</I>&gt;<i> on the context that caused it to run. Here is a simple example in pseudo
</I>&gt;<i> code:
</I>&gt;<i>
</I>&gt;<i>         try {
</I>&gt;<i>                 if (a) {
</I>&gt;<i> A:                      x = 2;
</I>&gt;<i>                         goto E;
</I>&gt;<i>                 }
</I>&gt;<i> B:              x = 1;
</I>&gt;<i>         } finally {
</I>&gt;<i> C:              print &quot;hello world!&quot;;
</I>&gt;<i>         }
</I>&gt;<i> D:      print x;
</I>&gt;<i> E:      return
</I>&gt;<i>
</I>&gt;<i> Imagine a control flow graph of this code with the labels naming the
</I>&gt;<i> nodes. Then there will be edges A-&gt;C, B-&gt;C, C-&gt;D, C-&gt;E and D-&gt;E. The
</I>&gt;<i> definition of x that reaches D will thus have to go through C, and then
</I>&gt;<i> C will need a phi-function to get the correct definition of x. This will
</I>&gt;<i> make it look like the definition of x from A is needed at C, even though
</I>&gt;<i> obviously it is not. The basic problem is that the control flow graph
</I>&gt;<i> makes it look like the path A-&gt;C-&gt;D is possible. In this example this
</I>&gt;<i> means that we cannot discover that x=2 is dead code.
</I>&gt;<i>
</I>&gt;<i> Suppose that the x=2 at A was something throwing an exception instead
</I>&gt;<i> and we had a catch handler on the innermost try. Then C would need an
</I>&gt;<i> outgoing edge to this handler, making it look like falling through at B
</I>&gt;<i> could cause an exception!
</I>&gt;<i>
</I>&gt;<i> So if we don't do something special for finally, we can get preposterous
</I>&gt;<i>   information. I should perhaps say that I am interested in precise
</I>&gt;<i> analysis to do good optimization, but also because I would like the
</I>&gt;<i> program to have capabilities similar to the Java findbugs program,
</I>&gt;<i> though that would not be a priority at first.
</I>&gt;<i>
</I>&gt;<i> I am sure this CAN be fixed for each analysis by doing the equivalent of
</I>&gt;<i> path sensitive analysis but restricting it to finally. Basically this
</I>&gt;<i> will be the same thing as making the analysis act as if the finally
</I>&gt;<i> block was inlined everywhere it could be called, but without actually
</I>&gt;<i> inlining it. I am not sure how that should interact with SSA-form.
</I>&gt;<i>
</I>&gt;<i> Even if we use the naive approach the control flow graph will need to
</I>&gt;<i> know that removing an edge TO a finally block might or might not
</I>&gt;<i> necessitate removing an edge FROM it, depending on whether or not a
</I>&gt;<i> different branch from inside the corresponding try block has another
</I>&gt;<i> branch that needs to go the same outer destination. If that does not
</I>&gt;<i> make sense consider removing the last branch to a label outside a
</I>&gt;<i> finally-protected try block as compared to removing one of several
</I>&gt;<i> branches that all go to the same label outside the try block.
</I>&gt;<i>
</I>&gt;<i> I expect to discover more of these kinds of differences from normal
</I>&gt;<i> control flow graph behavior as implementation proceeds, since finally
</I>&gt;<i> directs control flow in a different way from anything else.
</I>&gt;<i>
</I>&gt;<i> I hope I have convincingly argued that finally needs special treatment
</I>&gt;<i> and that that treatment is non-trivial if we need reasonably precise
</I>&gt;<i> analysis of program behavior.
</I>&gt;<i>
</I>&gt;<i> /Bjarke
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>

-- 
Rafael &quot;Monoman&quot; Teixeira
---------------------------------------
&quot;The reasonable man adapts himself to the world; the unreasonable one
persists in trying to adapt the world to himself. Therefore all
progress depends on the unreasonable man.&quot; George Bernard Shaw

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019749.html">[Mono-dev] CIL to CIL optimizer
</A></li>
	<LI>Next message: <A HREF="019753.html">[Mono-dev] CIL to CIL optimizer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19750">[ date ]</a>
              <a href="thread.html#19750">[ thread ]</a>
              <a href="subject.html#19750">[ subject ]</a>
              <a href="author.html#19750">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
