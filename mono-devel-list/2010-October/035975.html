<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] CIL optimizer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CIL%20optimizer&In-Reply-To=AANLkTikQv%2BzsvaaO0eYoaePnW57zHE3RWWdguhwvDc4L%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035972.html">
   <LINK REL="Next"  HREF="035973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] CIL optimizer</H1>
    <B>Jeroen Frijters</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20CIL%20optimizer&In-Reply-To=AANLkTikQv%2BzsvaaO0eYoaePnW57zHE3RWWdguhwvDc4L%40mail.gmail.com"
       TITLE="[Mono-dev] CIL optimizer">jeroen at sumatra.nl
       </A><BR>
    <I>Sun Oct  3 03:30:39 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035972.html">[Mono-dev] CIL optimizer
</A></li>
        <LI>Next message: <A HREF="035973.html">[Mono-dev] ASP.MVC Accesing HttpContext.Current from	AsyncController action..
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35975">[ date ]</a>
              <a href="thread.html#35975">[ thread ]</a>
              <a href="subject.html#35975">[ subject ]</a>
              <a href="author.html#35975">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Justin,

I'm currently working on adding a simple CIL peephole optimization phase to ikvmc. The primary reason is to reduce file size, because as Rodrigo pointed out the JIT will also do most of these optimizations, but I believe that file size is important too.

Some of the optimizations I'm doing could very well be done by a general optimizer (in theory*), but others are IKVM specific, so I don't quite know where I stand on a stand-alone CIL optimizer.

* In practice you can't do any CIL rewriting for ikvmc generated code if you want the stack trace line numbers to continue to make sense, because the CIL offset to source line numbers are stored in a custom attribute attached to the method.

Regards,
Jeroen

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:mono-devel-list-
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">bounces at lists.ximian.com</A>] On Behalf Of Justin Malcolm
</I>&gt;<i> Sent: Saturday, October 02, 2010 8:24 PM
</I>&gt;<i> To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-dev] CIL optimizer
</I>&gt;<i> 
</I>&gt;<i> Thank you for the reply Rodrigo,
</I>&gt;<i> 
</I>&gt;<i> Do you mean that there is not much room for optimization of the output
</I>&gt;<i> from 'mcs' or just of CIL in general?  I have heard that the Microsoft
</I>&gt;<i> C++ compiler output better code than the C# one did (at least at some
</I>&gt;<i> point) so I assumed that CIL efficiency mattered.
</I>&gt;<i> 
</I>&gt;<i> I was thinking that a generic CIL optimizer would make it possible for
</I>&gt;<i> compiler writers (and others) to worry less about optimization.  I am
</I>&gt;<i> writing a compiler myself and I was thinking of keeping the compiler
</I>&gt;<i> optimization stupid and implementing a stand-alone CIL optimizer to go
</I>&gt;<i> with it.  That is why I wanted to know if anybody else had done any work
</I>&gt;<i> on it.
</I>&gt;<i> 
</I>&gt;<i> I know one thing, my current compiler puts out some pretty bad CIL.  For
</I>&gt;<i> example, compiling 5+4*3-6/3 in my compiler results in a bunch of 'i4'
</I>&gt;<i> literals along with 'mul', 'add', 'sub', and 'div' instructions.
</I>&gt;<i> Clearly this could be better.  I figured, why do it in every compiler
</I>&gt;<i> when I could just write a generic optimizer instead.
</I>&gt;<i> 
</I>&gt;<i> I guess I do not really know what optimizations .NET and Mono do at the
</I>&gt;<i> JIT level so I am not sure how the CIL affects the quality of the
</I>&gt;<i> machine code that actually gets executed.  Do things like dead code
</I>&gt;<i> elimination, constant propagation, loop unrolling, conversion avoidance,
</I>&gt;<i> and changing things like &quot;idc.i4&quot; to &quot;idc.i4.s&quot; affect the final result
</I>&gt;<i> at all or just the JIT time?
</I>&gt;<i> 
</I>&gt;<i> It sounds like you are implying that the JIT manages pretty well even
</I>&gt;<i> when you feed it inefficient CIL.  Then again, your instrumentation
</I>&gt;<i> comment makes me wonder if I have that right.  If you could elaborate, I
</I>&gt;<i> would appreciate knowing if I would be wasting my time to go down this
</I>&gt;<i> road.
</I>&gt;<i> 
</I>&gt;<i> If you were going to optimize the CIL, where would you expect to get a
</I>&gt;<i> return on your efforts?
</I>&gt;<i> 
</I>&gt;<i> I did not expect that anything had been done but I guess there was no
</I>&gt;<i> harm in asking.  If I get there myself,  I will let you know.
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 2 October 2010 07:26, Rodrigo Kumpera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kumpera at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 	Nothing happened on this front for two reasons.
</I>&gt;<i> 
</I>&gt;<i> 	First that nobody had the time for it. It's a major undertaking.
</I>&gt;<i> 
</I>&gt;<i> 	Second, not one is sure that it will yield any improvements at all.
</I>&gt;<i> Given CIL
</I>&gt;<i> 	is a quite high level format with some rigid structure
</I>&gt;<i> requirements, there isn't
</I>&gt;<i> 	much room for optimization - at least at glance.
</I>&gt;<i> 
</I>&gt;<i> 	It has been suggested that producing a different format, that is
</I>&gt;<i> more amendable
</I>&gt;<i> 	for optimization would allow for better results but, again, it's an
</I>&gt;<i> even harder task
</I>&gt;<i> 	with the same level of uncertainty.
</I>&gt;<i> 
</I>&gt;<i> 	A CIL optimizer has one valid use case thou, that is to optimize
</I>&gt;<i> code that has
</I>&gt;<i> 	been instrumented. This would avoid the instrumentation writer
</I>&gt;<i> having to care
</I>&gt;<i> 	about emitting efficient CIL bytecode.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 	On Sat, Oct 2, 2010 at 4:54 AM, jmalcolm &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">malcolm.justin at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 		I remember reading a very long while back that there might be
</I>&gt;<i> a plan to
</I>&gt;<i> 		create a generic CIL optimizer.  I understood this to mean
</I>&gt;<i> CIL in and better
</I>&gt;<i> 		CIL out.
</I>&gt;<i> 
</I>&gt;<i> 		Did anything ever happen with this?  Is there any code
</I>&gt;<i> anywhere I can dig
</I>&gt;<i> 		up?
</I>&gt;<i> 		--
</I>&gt;<i> 		View this message in context:
</I>&gt;<i> <A HREF="http://mono.1490590.n4.nabble.com/CIL-optimizer-tp2952239p2952239.html">http://mono.1490590.n4.nabble.com/CIL-optimizer-tp2952239p2952239.html</A>
</I>&gt;<i> 		Sent from the Mono - Dev mailing list archive at Nabble.com.
</I>&gt;<i> 		_______________________________________________
</I>&gt;<i> 		Mono-devel-list mailing list
</I>&gt;<i> 		<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> 		<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035972.html">[Mono-dev] CIL optimizer
</A></li>
	<LI>Next message: <A HREF="035973.html">[Mono-dev] ASP.MVC Accesing HttpContext.Current from	AsyncController action..
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35975">[ date ]</a>
              <a href="thread.html#35975">[ thread ]</a>
              <a href="subject.html#35975">[ subject ]</a>
              <a href="author.html#35975">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
