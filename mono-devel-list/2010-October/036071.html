<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Optimization for SystemResPool (managed windows form)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Optimization%20for%20SystemResPool%20%28managed%20windows%20form%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="036174.html">
   <LINK REL="Next"  HREF="036072.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Optimization for SystemResPool (managed windows form)</H1>
    <B>Lionel Cuir</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Optimization%20for%20SystemResPool%20%28managed%20windows%20form%29&In-Reply-To="
       TITLE="[Mono-dev] Optimization for SystemResPool (managed windows form)">lionel_email at aulofee.com
       </A><BR>
    <I>Fri Oct 15 10:21:34 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="036174.html">[Mono-dev] Process problem
</A></li>
        <LI>Next message: <A HREF="036072.html">[Mono-dev] Optimization for SystemResPool (managed windows form)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36071">[ date ]</a>
              <a href="thread.html#36071">[ thread ]</a>
              <a href="subject.html#36071">[ subject ]</a>
              <a href="author.html#36071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The SystemResPool class (in Theme.cs) is quite heavily used across managed
windows forms. Yet, it still use the old Hashtable (instead of Dictionary)
and mainly some of its internal caching dictionary uses strings as key (ex:
to get the cached pen for a given color, it converts the color to a string
rather than using its Argb as a key).
 
Here is the modified code (sorry, I'm sending this code on the fly as I'm
not on a computer right now, and so has no access to any diff program nor
can run the Mono's unit tests).
 
Note also that the CPColor (in Theme.cs) used as key of a
dictionary/hashtable in SystemResPool, should have its Equals and
GetHashCode overloaded, for better performance (if not, the methods of the
ValueType class are used, which use reflection).
 
Cheers,
Lionel
 
 
 internal class SystemResPool
 {
  private Dictionary&lt;int, Pen&gt; pens = new Dictionary&lt;int, Pen&gt;();
  private Dictionary&lt;long, Pen&gt; dashpens = new Dictionary&lt;long, Pen&gt;();
  private Dictionary&lt;long, Pen&gt; sizedpens = new Dictionary&lt;long, Pen&gt;();
  private Dictionary&lt;int, SolidBrush&gt; solidbrushes = new Dictionary&lt;int,
SolidBrush&gt;();
  
  [...]
 
  public Pen GetPen(Color color)
  {
   int hash = color.ToArgb();
 
   lock (pens)
   {
    Pen res;
    if (pens.TryGetValue(hash, out res))
     return res;
 
    Pen pen = new Pen(color);
    pens.Add(hash, pen);
    return pen;
   }
  }
 
  public Pen GetDashPen(Color color, DashStyle dashStyle)
  {
   //string hash = color.ToString() + dashStyle;
   long hash = color.ToArgb() &lt;&lt; 32 + (int)dashStyle;
 
   lock (dashpens)
   {
    Pen res;
    if (dashpens.TryGetValue(hash, out res))
     return res;
 
    Pen pen = new Pen(color);
    pen.DashStyle = dashStyle;
    dashpens[hash] = pen;
    return pen;
   }
  }
 
  public Pen GetSizedPen(Color color, int size)
  {
   //string hash = color.ToString() + size;
   long hash = color.ToArgb() &lt;&lt; 32 + size;
 
   lock (sizedpens)
   {
    Pen res;
    if (sizedpens.TryGetValue(hash, out res))
     return res;
 
    Pen pen = new Pen(color, size);
    sizedpens[hash] = pen;
    return pen;
   }
  }
 
  public SolidBrush GetSolidBrush(Color color)
  {
   int hash = color.ToArgb();
 
   lock (solidbrushes)
   {
    SolidBrush res;
    if (solidbrushes.TryGetValue(hash, out res))
     return res;
 
    SolidBrush brush = new SolidBrush(color);
    solidbrushes.Add(hash, brush);
    return brush;
   }
  }
 
  [...]
  

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20101015/dcd7af24/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20101015/dcd7af24/attachment.html</A> 
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="036174.html">[Mono-dev] Process problem
</A></li>
	<LI>Next message: <A HREF="036072.html">[Mono-dev] Optimization for SystemResPool (managed windows form)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36071">[ date ]</a>
              <a href="thread.html#36071">[ thread ]</a>
              <a href="subject.html#36071">[ subject ]</a>
              <a href="author.html#36071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
