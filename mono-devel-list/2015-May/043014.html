<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Timing/race conditions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Timing/race%20conditions&In-Reply-To=%3CCACmR%2BBC-BeCc%2BB8ENGXUcKHSUWP6GeY4XQDrwnKXSO7WFuee0A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042987.html">
   <LINK REL="Next"  HREF="042997.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Timing/race conditions</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Timing/race%20conditions&In-Reply-To=%3CCACmR%2BBC-BeCc%2BB8ENGXUcKHSUWP6GeY4XQDrwnKXSO7WFuee0A%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Timing/race conditions">kumpera at gmail.com
       </A><BR>
    <I>Thu May 28 18:51:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="042987.html">[Mono-dev] Timing/race conditions
</A></li>
        <LI>Next message: <A HREF="042997.html">[Mono-dev] Error Building mono On Android: Undefined Ref to	mono_threads_core_get_stack_bounds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43014">[ date ]</a>
              <a href="thread.html#43014">[ thread ]</a>
              <a href="subject.html#43014">[ subject ]</a>
              <a href="author.html#43014">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm not keen on introducing yield calls all over the place in the runtime
to work around bad test-environment combinations.

Adding them to the test suite it fine though.

Maybe the 200ms timeout is too low to deal with overloaded systems and must
be increased. The goal is to
detect bugs in the suspend code.

It would be much easier if unix had a way to transfer the quantum in a
yield call instead of just giving up on it.
We can definitely increase the timeout if that would help or make it
optional guarded behind an env var.

Does changing the timeout to infinite fix those crashes?


On Thu, May 21, 2015 at 4:20 PM, Neale Ferguson &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">neale at sinenomine.net</A>&gt;
wrote:

&gt;<i> Hi,
</I>&gt;<i> I have been experiencing some failures with the tests in mono/tests,
</I>&gt;<i> particularly in a single core configuration.
</I>&gt;<i>
</I>&gt;<i> Firstly, the sleep test: when the delegated thread is started, the main
</I>&gt;<i> thread goes to call the StopWatch start method which requires JITting.
</I>&gt;<i> This involves gc interaction as objects are allocated. However, the
</I>&gt;<i> delegated thread gets up and starts issuing GC.Collection() calls which
</I>&gt;<i> end up occurring every 50 microseconds. This means the main thread never
</I>&gt;<i> gets a chance to get out of the allocation phase so never gets to execute
</I>&gt;<i> the stopwatch start, thread sleep etc. so the thread never ends. In a
</I>&gt;<i> multi-core configuration this is not a problem and the test passes. I
</I>&gt;<i> found by inserting a Thread.Yield() as the first method called in the
</I>&gt;<i> delegated thread eliminates the problem [1].
</I>&gt;<i>
</I>&gt;<i> Secondly, the xxxxx-exit (e.g. thread-exit) tests will occasionally fail
</I>&gt;<i> with an abort due to &quot;suspend_thread suspend took xxx ms, which is more
</I>&gt;<i> than the allowed 200 ms&#8221; where xxx exceeds 200. This seems to be due to
</I>&gt;<i> the exiting thread sometimes not getting to the stage of setting the
</I>&gt;<i> thread-&gt;state to ThreadState_Stopped in the
</I>&gt;<i> ves_icall_System_Environment_Exit() processing within the 200ms time
</I>&gt;<i> period. Again, with multiple cores this is not a problem (or the problem
</I>&gt;<i> is much rarer). I found by inserting a mono_thread_info_yield() prior to
</I>&gt;<i> the suspend_internal_thread() in mono_thread_suspend_all_other_threads()
</I>&gt;<i> fixes the problem [2]. I am not sure this is the best option and it&#8217;s
</I>&gt;<i> still theoretically possible for the problem to still occur depending on
</I>&gt;<i> how heavily the system is loaded. I was wondering if the setting of the
</I>&gt;<i> state to ThreadState_stopped could be moved earlier in the process rather
</I>&gt;<i> than in thread_cleanup() or if there&#8217;s another alternative.
</I>&gt;<i>
</I>&gt;<i> While the occasional failure has been experienced with some of the more
</I>&gt;<i> pathological tests, the trouble is they happen nearly 100% of the time on
</I>&gt;<i> a single core virtual machine, less often on a 2 core but in a virtual
</I>&gt;<i> machine environment where there may be 100s of virtual machines competing
</I>&gt;<i> for the real cores the probability of failure increases. In addition tests
</I>&gt;<i> in the main test suite also have failed for the same reason as described
</I>&gt;<i> in the second case.
</I>&gt;<i>
</I>&gt;<i> Neale
</I>&gt;<i>
</I>&gt;<i> [1] Circumvention for case 1 -
</I>&gt;<i>
</I>&gt;<i> --- a/mono/tests/sleep.cs
</I>&gt;<i> +++ b/mono/tests/sleep.cs
</I>&gt;<i> @@ -13,6 +13,7 @@ public class Tests
</I>&gt;<i>         public static int test_0_time_drift () {
</I>&gt;<i>                 // Test the Thread.Sleep () is able to deal with time
</I>&gt;<i> drifting due to interrupts
</I>&gt;<i>                 Thread t = new Thread (delegate () {
</I>&gt;<i> +                               Thread.Yield();
</I>&gt;<i>                                 while (!finished)
</I>&gt;<i>                                         GC.Collect ();
</I>&gt;<i>                         });
</I>&gt;<i>
</I>&gt;<i> [2] Circumvention for case 2 -
</I>&gt;<i>
</I>&gt;<i> --- a/mono/metadata/threads.c
</I>&gt;<i> +++ b/mono/metadata/threads.c
</I>&gt;<i>
</I>&gt;<i> @@ -3132,6 +3147,8 @@ void mono_thread_suspend_all_other_threads (void)
</I>&gt;<i>
</I>&gt;<i>                         UNLOCK_THREAD (thread);
</I>&gt;<i>
</I>&gt;<i> +                       mono_thread_info_yield ();
</I>&gt;<i> +
</I>&gt;<i>                         /* Signal the thread to suspend */
</I>&gt;<i>                         suspend_thread_internal (thre
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150528/c318ebe8/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150528/c318ebe8/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042987.html">[Mono-dev] Timing/race conditions
</A></li>
	<LI>Next message: <A HREF="042997.html">[Mono-dev] Error Building mono On Android: Undefined Ref to	mono_threads_core_get_stack_bounds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43014">[ date ]</a>
              <a href="thread.html#43014">[ thread ]</a>
              <a href="subject.html#43014">[ subject ]</a>
              <a href="author.html#43014">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
