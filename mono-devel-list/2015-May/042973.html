<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] HttpListener
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20HttpListener&In-Reply-To=%3CCABsLVMthp%2BbNiFo8XxiyOBayp1OyJNSjNUQRFxWvB-XyCBBG%2BQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="042972.html">
   <LINK REL="Next"  HREF="042974.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] HttpListener</H1>
    <B>Teravus Ovares</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20HttpListener&In-Reply-To=%3CCABsLVMthp%2BbNiFo8XxiyOBayp1OyJNSjNUQRFxWvB-XyCBBG%2BQ%40mail.gmail.com%3E"
       TITLE="[Mono-dev] HttpListener">teravus at gmail.com
       </A><BR>
    <I>Wed May 20 02:18:46 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="042972.html">[Mono-dev] HttpListener
</A></li>
        <LI>Next message: <A HREF="042974.html">[Mono-dev] Monodevelop &amp; mono version
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42973">[ date ]</a>
              <a href="thread.html#42973">[ thread ]</a>
              <a href="subject.html#42973">[ subject ]</a>
              <a href="author.html#42973">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Since we're talking about the HttpListener..    Any thoughts on making
HttpListener more friendly to longer running, blocked tasks.?   Such as
Event Queues.   Almost all of these edge cases involve reading the input
stream for paths/queryparams/etc, blocking the thread while doing some work
or waiting some amount of time, then servicing the response.   With the
current HTTPListener this leads to lots of precious threadpool threads
blocked and not doing anything but also counting against the mono
threadpool thread limit.  The simplest way that this can be done is simply
decoupling the HttpListener threads from the threadpool thread limit..
 that way the threadpool threads are limited separately.     The more
complicated way could be to allow some sort of thread sleep call that puts
the IO streams for the http requests into a pool of streams managed by a
single worker thread while they're waiting and then restores them to it's
own thread once the work is done to send the response.   I have previously
done the second method with a third party HttpListener replacement and it
saved a lot of threads which freed them up to do other useful things in a
highly parallel server without forcing the end user to manually specify a
larger mono maximum threadpool thread limit.

Regards

Teravus

On Tue, May 19, 2015 at 2:28 PM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt; wrote:

&gt;<i> Yes exactly my intention. The problem is I am only given http prefixes
</I>&gt;<i> in that code.
</I>&gt;<i>
</I>&gt;<i> Consider the case I have an interface 192.168.1.1 and an interface
</I>&gt;<i> 10.114.1.112
</I>&gt;<i>
</I>&gt;<i> Given a http prefix of <A HREF="http://my.elasticip:8080">http://my.elasticip:8080</A> which interface should it
</I>&gt;<i> pick?
</I>&gt;<i>
</I>&gt;<i> As you can see here the prefixes are being used for both:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L77">https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L77</A>
</I>&gt;<i> as well as some odd error conditions which I imagine are to match MS
</I>&gt;<i> implementation but would need to verify that.
</I>&gt;<i>
</I>&gt;<i> If there was a separation between which interface to pick vs which
</I>&gt;<i> http prefixes to use this would solve the problem and is essentially
</I>&gt;<i> what I was talking about putting in as an overload. I know mono is as
</I>&gt;<i> a whole a bit reluctant to add mono specific overloads (which is
</I>&gt;<i> completely understandable). I just find kind any other reasonable way
</I>&gt;<i> here of handling the windows/mono differences.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/HttpListener.cs#L269">https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/HttpListener.cs#L269</A>
</I>&gt;<i> leads to
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L48">https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L48</A>
</I>&gt;<i>
</I>&gt;<i> I could do this in a couple of ways (add state to HttpListener is an
</I>&gt;<i> obvious one + an overload that only changes behaviour if its used).
</I>&gt;<i>
</I>&gt;<i> Greg
</I>&gt;<i>
</I>&gt;<i> On Wed, May 20, 2015 at 12:18 AM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; Shouldn't we bind on the interface based on the IP address?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Would that not solve the problem?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; miguel
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Tue, May 19, 2015 at 4:00 PM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I was thinking a basic code api that allowed the specification of
</I>&gt;<i> &gt;&gt; interface to bind to separately from which prefixes to accept to start
</I>&gt;<i> &gt;&gt; with. The biggest issue here is that the ms api is basically using
</I>&gt;<i> &gt;&gt; httpprefix to mean two very different things.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Tue, May 19, 2015 at 10:58 PM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt;
</I>&gt;<i> &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; Well, it might be best if you explain what you have in mind, before we
</I>&gt;<i> &gt;&gt; &gt; waste
</I>&gt;<i> &gt;&gt; &gt; time with a pull request.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; But either way works.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; On Tue, May 19, 2015 at 3:50 PM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt;
</I>&gt;<i> &gt;&gt; &gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; Miguel,
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; Would it be best to just take a stab at an alternative interface and
</I>&gt;<i> &gt;&gt; &gt;&gt; send a PR for discussion?
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; Greg
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; On Sun, Apr 26, 2015 at 4:43 PM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; This is the code handling the prefixes its here
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> <A HREF="https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L43">https://github.com/mono/mono/blob/master/mcs/class/System/System.Net/EndPointManager.cs#L43</A>
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; There is quite a bit of odd code around this in general. I
</I>&gt;<i> understand
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; much of it is trying to reach compliance with MS but ...
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; On Sun, Apr 26, 2015 at 4:40 PM, Miguel de Icaza &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">miguel at xamarin.com</A>&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; Hello Greg,
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; Is that in HttpListener, or somewhere else?
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; Miguel
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; On Fri, Apr 24, 2015 at 12:41 PM, Greg Young
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; Here is some of the code in question:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; IPAddress addr;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; if (host == &quot;*&quot;)
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;     addr = IPAddress.Any;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; else if (IPAddress.TryParse(host, out addr) == false){
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;     try {
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;         IPHostEntry iphost = Dns.GetHostByName(host);
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;        if (iphost != null)
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;             addr = iphost.AddressList[0];
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;        else
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;             addr = IPAddress.Any;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;    } catch {
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;         addr = IPAddress.Any;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;    }
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; }
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; On Fri, Apr 24, 2015 at 7:29 PM, Greg Young
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; I have been going through a bunch of this code lately after
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; seeing
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; many ... interesting behaviours. I understand that much of the
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; derp
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; in
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; this code is due to not having IIS and MS having an IIS centric
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; API
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; but wow. Some gems I have found...
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 1) synchronous dns calls being made...
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 2) I want to listen on 192.168.0.1:1234 but I want to support
</I>&gt;<i> a
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; host
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; header of whateverdomain can't resolve whatever domain then
</I>&gt;<i> bind
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; listeners to all ips on machine.
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 3) Same as above but dns entry has multiple ips it resovles to
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; [0]
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; doesnt match see #2
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 4) Anything at all to do with elastic ips
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 5) Exceptions thrown to calling code with http status codes in
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; them
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; (I
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; think this is ms legacy but is a pretty biog wtf)
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; 6) failure parsing ip address says bind all interfaces on
</I>&gt;<i> machine
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; (huh?)
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; Perhaps it makes sense to expose a &quot;Microsoft Http
</I>&gt;<i> Compatibility
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; Layer&quot; and then have a &quot;Sane API if you want to use it&quot;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; I dont mind putting some time in on these but is this even
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; worthwhile
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; or is the plan to just burn this code with fire and move to
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; something
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; sane in general?
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; Cheers,
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; Greg
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; --
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; &gt; Studying for the Turing test
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; --
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; Studying for the Turing test
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; Mono-devel-list mailing list
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; --
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; Studying for the Turing test
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; --
</I>&gt;<i> &gt;&gt; &gt;&gt; Studying for the Turing test
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; --
</I>&gt;<i> &gt;&gt; Studying for the Turing test
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Studying for the Turing test
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150519/c337b510/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150519/c337b510/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="042972.html">[Mono-dev] HttpListener
</A></li>
	<LI>Next message: <A HREF="042974.html">[Mono-dev] Monodevelop &amp; mono version
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42973">[ date ]</a>
              <a href="thread.html#42973">[ thread ]</a>
              <a href="subject.html#42973">[ subject ]</a>
              <a href="author.html#42973">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
