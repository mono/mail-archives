<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] NullReferenceException in Mono.Security.X509.X509Certificate.Hash and IsSelfSigned
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20NullReferenceException%20in%0A%20Mono.Security.X509.X509Certificate.Hash%20and%20IsSelfSigned&In-Reply-To=%3CBN3PR0801MB1154EF8D52E00D8A2FCEAF41FACA0%40BN3PR0801MB1154.namprd08.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043023.html">
   <LINK REL="Next"  HREF="043021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] NullReferenceException in Mono.Security.X509.X509Certificate.Hash and IsSelfSigned</H1>
    <B>Edward Ned Harvey (mono)</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20NullReferenceException%20in%0A%20Mono.Security.X509.X509Certificate.Hash%20and%20IsSelfSigned&In-Reply-To=%3CBN3PR0801MB1154EF8D52E00D8A2FCEAF41FACA0%40BN3PR0801MB1154.namprd08.prod.outlook.com%3E"
       TITLE="[Mono-dev] NullReferenceException in Mono.Security.X509.X509Certificate.Hash and IsSelfSigned">edward.harvey.mono at clevertrove.com
       </A><BR>
    <I>Thu May 28 16:31:55 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043023.html">[Mono-dev] Mono build issue: mono-sgen illegal instruction
</A></li>
        <LI>Next message: <A HREF="043021.html">[Mono-dev] NullReferenceException in Mono.Security.X509.X509Certificate.Hash and IsSelfSigned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43010">[ date ]</a>
              <a href="thread.html#43010">[ thread ]</a>
              <a href="subject.html#43010">[ subject ]</a>
              <a href="author.html#43010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Recently, I'm encountering a problem where Mozroots is throwing NullReferenceException. I am working on a reproducible example, but until then, I'd like to revisit this issue:

First, here is reproduction code that shows the mac client requires mozroots to be run. This code throws exception on a pristine mac, but succeeds after mozroots has been run:

const string hostname = &quot;google.com&quot;;
const int PortNumber = 443;
TcpClient client = new TcpClient();
client.Connect(hostname, PortNumber);
using (var mySslStream = new SslStream (client.GetStream (), leaveInnerStreamOpen: false)) {
    mySslStream.AuthenticateAsClient (targetHost: hostname, clientCertificates: null, enabledSslProtocols: SslProtocols.Tls, checkCertificateRevocation: false);
}

Given that the above throws exception, I'd like to ask, are there plans to make the SslStream client on mac utilize the system keychain, and if so, how soon might we expect it? The way things are now, we have to bundle a copy of Mozroots in our app, and programmatically call it. I would love to eliminate the need for this.

Right now, MozRoots is throwing the NullReferenceException on this line:
<A HREF="https://github.com/mosa/Mono-Class-Libraries/blob/master/mcs/tools/security/mozroots.cs#L158">https://github.com/mosa/Mono-Class-Libraries/blob/master/mcs/tools/security/mozroots.cs#L158</A>
                if (!trusted.Contains (root)) {

When I debug and step through, I can see &quot;root&quot; is a Mono.Security.X509.X509Certificate, where Hash and IsSelfSigned both throw NullReferenceException if they're accessed.

System.NullReferenceException: Object reference not set to an instance of an object
  at Mono.Security.X509.X509Certificate.get_Hash () [0x00057] in /private/tmp/source-mono-mac-4.0.0-branch/bockbuild-mono-4.0.0-branch/profiles/mono-mac-xamarin/build-root/mono-4.0.0/mcs/class/Mono.Security/Mono.Security.X509/X509Certificate.cs:301
  at Mono.Security.X509.X509CertificateCollection.IndexOf (Mono.Security.X509.X509Certificate value) [0x00011] in /private/tmp/source-mono-mac-4.0.0-branch/bockbuild-mono-4.0.0-branch/profiles/mono-mac-xamarin/build-root/mono-4.0.0/mcs/class/Mono.Security/Mono.Security.X509/X509CertificateCollection.cs:123
  at Mono.Security.X509.X509CertificateCollection.Contains (Mono.Security.X509.X509Certificate value) [0x00000] in /private/tmp/source-mono-mac-4.0.0-branch/bockbuild-mono-4.0.0-branch/profiles/mono-mac-xamarin/build-root/mono-4.0.0/mcs/class/Mono.Security/Mono.Security.X509/X509CertificateCollection.cs:95

For reasons that I don't yet understand, this exception occurs when we call the MozRoots class in our app, but does not occur when I run &quot;mozroots&quot; command on the Terminal. So I'm still figuring this out and have not yet got example code to reproduce the issue.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150528/b598cbb8/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150528/b598cbb8/attachment.html</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043023.html">[Mono-dev] Mono build issue: mono-sgen illegal instruction
</A></li>
	<LI>Next message: <A HREF="043021.html">[Mono-dev] NullReferenceException in Mono.Security.X509.X509Certificate.Hash and IsSelfSigned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43010">[ date ]</a>
              <a href="thread.html#43010">[ thread ]</a>
              <a href="subject.html#43010">[ subject ]</a>
              <a href="author.html#43010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
