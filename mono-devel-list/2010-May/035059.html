<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Block map support for sgen
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Block%20map%20support%20for%20sgen&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035133.html">
   <LINK REL="Next"  HREF="035084.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Block map support for sgen</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Block%20map%20support%20for%20sgen&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Block map support for sgen">kumpera at gmail.com
       </A><BR>
    <I>Mon May 24 16:38:34 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035133.html">[Mono-dev] Cannot compile monodebugger with mono from svn trunk
</A></li>
        <LI>Next message: <A HREF="035084.html">[Mono-dev] [PATCH] Block map support for sgen
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35059">[ date ]</a>
              <a href="thread.html#35059">[ thread ]</a>
              <a href="subject.html#35059">[ subject ]</a>
              <a href="author.html#35059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey folks,

The attached patch set implements block map support for sgen. It uses a
schema similar to boehm's, which is a 2 level sparse map.
Under 64 bits it uses hashing.

I benchmarked a modified binary-trees without valuetypes. Block maps gives a
very modest speedup under major-copying (about 2%) and
nothing under major-marksweep. I've only used the block map for
major_copy_or_mark_object thou. There are probably other places it
oould be used too.

The design is basically the same as boehm's except for a few things:

-It doesn't store list heads or address on each segment. This allows
segment's size to be a power of 2; and
-LOS is handled by filling all covering slots with its block instead of
using forwarding

Few notes:

Segments are not deallocated since this requires either scanning whole
segments on each deallocation or keeping block counts.
And it's probably not needed since Boehm doesn't do it. It's doable as long
as the block map is only read during GC and mutated
with the gc lock held.

64bits support has not been committed since it is a minor change to the code
in sgen-gc.c and I want to have the current change set
validated first.

A small config option that uses either a 3 level map or just hashing under
32bits can be done with ease.

The embedding of Block in MSBlockInfo wastes a word of memory. This could be
worked out by either factoring Block::role into a separate
struct or by using Block::next in place of MSBlockInfo::next.

Cheers,
Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: block_map_part1.patch
Type: text/x-patch
Size: 5665 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0004.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0004.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: block_map_part2.patch
Type: text/x-patch
Size: 6769 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0005.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0005.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: block_map_part3.patch
Type: text/x-patch
Size: 4954 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0006.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0006.bin</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: block_map_part4.patch
Type: text/x-patch
Size: 3018 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0007.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100524/e4a8c486/attachment-0007.bin</A> 
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035133.html">[Mono-dev] Cannot compile monodebugger with mono from svn trunk
</A></li>
	<LI>Next message: <A HREF="035084.html">[Mono-dev] [PATCH] Block map support for sgen
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35059">[ date ]</a>
              <a href="thread.html#35059">[ thread ]</a>
              <a href="subject.html#35059">[ subject ]</a>
              <a href="author.html#35059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
