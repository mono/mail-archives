<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Porting mcs to IKVM.Reflection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Porting%20mcs%20to%20IKVM.Reflection&In-Reply-To=D395C7FC996C944EBD345AB36164F4B2371C1933%40woyla.sumatrasoftware.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034932.html">
   <LINK REL="Next"  HREF="034935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Porting mcs to IKVM.Reflection</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Porting%20mcs%20to%20IKVM.Reflection&In-Reply-To=D395C7FC996C944EBD345AB36164F4B2371C1933%40woyla.sumatrasoftware.com"
       TITLE="[Mono-dev] Porting mcs to IKVM.Reflection">kornelpal at gmail.com
       </A><BR>
    <I>Fri May  7 12:07:44 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034932.html">[Mono-dev] Porting mcs to IKVM.Reflection
</A></li>
        <LI>Next message: <A HREF="034935.html">[Mono-dev] Porting mcs to IKVM.Reflection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34934">[ date ]</a>
              <a href="thread.html#34934">[ thread ]</a>
              <a href="subject.html#34934">[ subject ]</a>
              <a href="author.html#34934">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jeroen,

Thank you for the fixes.

New problems after the modifications:

SetCustomAttribute now fails for example for DllImportAttribute when 
building mscorlib.dll because ReadFixedArg calls GetEnumUnderlyingType 
and CheckBaked fails.

AssemblyKeyFileAttribute and AssemblyKeyNameAttribute should not be 
considered pseudo custom attributes because even MS csc.exe emits those 
attributes and Debug.Assert fails.

Also note that according to my tests AssemblyHashAlgorithm.None is 
changed to AssemblyHashAlgorithm.SHA1 when setting the assembly name 
because GetName returns AssemblyHashAlgorithm.SHA1 (rather than only 
when calling Save).

Korn&#233;l

Jeroen Frijters wrote:
&gt;<i> Hi Korn&#233;l,
</I>&gt;<i> 
</I>&gt;<i> This has now been fixed.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Jeroen
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Korn&#233;l P&#225;l [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">kornelpal at gmail.com</A>]
</I>&gt;&gt;<i> Sent: Friday, May 07, 2010 10:33 AM
</I>&gt;&gt;<i> To: Jeroen Frijters
</I>&gt;&gt;<i> Cc: Marek Safar; mono-devel; Miguel de Icaza
</I>&gt;&gt;<i> Subject: Re: Porting mcs to IKVM.Reflection
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for applying/enhacing the patches. I'll check it out.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This code will work on both of Mono and MS.NET, but will fail without
</I>&gt;&gt;<i> the WriteGenericSignature patch:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AssemblyBuilder ab = AppDomain.CurrentDomain.DefineDynamicAssembly(new
</I>&gt;&gt;<i> AssemblyName(&quot;myassembly&quot;), AssemblyBuilderAccess.Save);
</I>&gt;&gt;<i> ModuleBuilder mb = ab.DefineDynamicModule(&quot;myassembly&quot;,
</I>&gt;&gt;<i> &quot;myassembly.dll&quot;);
</I>&gt;&gt;<i> TypeBuilder tb = mb.DefineType(&quot;mytype&quot;, TypeAttributes.Public);
</I>&gt;&gt;<i> tb.DefineGenericParameters(new string[] { &quot;T&quot;, &quot;U&quot; });
</I>&gt;&gt;<i> ConstructorBuilder cb =
</I>&gt;&gt;<i> tb.DefineDefaultConstructor(MethodAttributes.Public);
</I>&gt;&gt;<i> MethodBuilder method = tb.DefineMethod(&quot;mymethod&quot;,
</I>&gt;&gt;<i> MethodAttributes.Static | MethodAttributes.Public, tb, Type.EmptyTypes);
</I>&gt;&gt;<i> ILGenerator ig = method.GetILGenerator();
</I>&gt;&gt;<i> ig.DeclareLocal(tb);
</I>&gt;&gt;<i> ig.Emit(OpCodes.Newobj, cb);
</I>&gt;&gt;<i> ig.Emit(OpCodes.Stloc_0);
</I>&gt;&gt;<i> ig.Emit(OpCodes.Ldloc_0);
</I>&gt;&gt;<i> ig.Emit(OpCodes.Ret);
</I>&gt;&gt;<i> tb.CreateType();
</I>&gt;&gt;<i> ab.Save(&quot;myassembly.dll&quot;);
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Although using a generic type definition directly makes little sense,
</I>&gt;&gt;<i> neither makes using tb.MakeGenericType(tb.GetGenericArguments()) much
</I>&gt;&gt;<i> more sense, since you still can use the latter in a context that has
</I>&gt;&gt;<i> fewer generic arguments.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Korn&#233;l
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jeroen Frijters wrote:
</I>&gt;&gt;&gt;<i> Hi Korn&#233;l,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've fixed most of the things that your patch addressed. I also
</I>&gt;&gt;<i> removed support for the TypeForwardedToAttribute and
</I>&gt;&gt;<i> DefaultParameterValueAttribute pseudo custom attributes (because I
</I>&gt;&gt;<i> realized that supporting them is incompatible with my goal to be a drop
</I>&gt;&gt;<i> in replacement for System.Reflection.Emit).
</I>&gt;&gt;&gt;<i> One thing I didn't change is WriteGenericSignature, because your
</I>&gt;&gt;<i> change didn't make sense to me. It should not be possible that this
</I>&gt;&gt;<i> method gets called with a generic type definition.
</I>&gt;&gt;&gt;<i> I have not yet added anything additional for version info unmanaged
</I>&gt;&gt;<i> resources. I need to do more thinking about this.
</I>&gt;&gt;&gt;<i> Regards,
</I>&gt;&gt;&gt;<i> Jeroen
</I>&gt;&gt;&gt;<i>
</I></PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034932.html">[Mono-dev] Porting mcs to IKVM.Reflection
</A></li>
	<LI>Next message: <A HREF="034935.html">[Mono-dev] Porting mcs to IKVM.Reflection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34934">[ date ]</a>
              <a href="thread.html#34934">[ thread ]</a>
              <a href="subject.html#34934">[ subject ]</a>
              <a href="author.html#34934">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
