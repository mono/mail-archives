<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCHES] Bug 480178	-	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does	not handle surrogate characters appropriately.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCHES%5D%20Bug%20480178%0A%09-%09System.Globalization.CharUnicodeInfo.GetUnicodeCategory%28%29%09does%0A%09not%20handle%20surrogate%20characters%20appropriately.&In-Reply-To=87r5lekx54.fsf%40mini.crosstwine.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034986.html">
   <LINK REL="Next"  HREF="034994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCHES] Bug 480178	-	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does	not handle surrogate characters appropriately.</H1>
    <B>Andreas Nahr</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCHES%5D%20Bug%20480178%0A%09-%09System.Globalization.CharUnicodeInfo.GetUnicodeCategory%28%29%09does%0A%09not%20handle%20surrogate%20characters%20appropriately.&In-Reply-To=87r5lekx54.fsf%40mini.crosstwine.com"
       TITLE="[Mono-dev] [PATCHES] Bug 480178	-	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does	not handle surrogate characters appropriately.">ClassDevelopment at A-SoftTech.com
       </A><BR>
    <I>Sat May 15 07:36:17 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034986.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
        <LI>Next message: <A HREF="034994.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34993">[ date ]</a>
              <a href="thread.html#34993">[ thread ]</a>
              <a href="subject.html#34993">[ subject ]</a>
              <a href="author.html#34993">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm the author (of a large part) of the current Char class and unfortunately I think you overlooked some things with the changes.

What you are doing is 
(heavily) degrading the performance of most of the char methods (some of which are VERY commonly used)
for
supporting a single (likely VERY rarely used case) in a single (likely not used very much) method.

1. Lets first start with performance. Unfortunately your micro benchmark is completely omitting the most important speed factor: All the methods were designed to be inlinable (because they tend to be called in tight loops, as they are even within corelib). After your change likely most/none of them would be inlinable anymore. Your benchmark, however, does not CALL A SINGLE METHOD. It just measures the overhead of two additional mathematical operators and a memory access. That is not the big speed-sink. But even then your approach looses 25% perf for no additional gain. The original implementation was the result of (literally) thousands of performance tests.

2. Gain vs. impact. I don't see much sense in changing lots of methods in Char to something worse just to support one corner case that could be handled separately.

3. Imho the alternative is relatively simple: Just leave the Char methods as they are and add the special casing only for the one relevant method. You could just add another table (or two for bi-level table compression or one that reuses the data from the first table) as a separate entity. So you can leave all the original methods intact and ONLY if somebody really uses that method and ONLY if he uses it to query the astral plane using surrogates he actually has to pay the price for it (in the runtime loading the relevant table into memory and using that additional lookup).

Happy hacking
Andreas

P.S. And sorry for being somewhat harsh on the patches.

-----Urspr&#252;ngliche Nachricht-----
Von: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] Im Auftrag von Damien Diederen
Gesendet: Freitag, 14. Mai 2010 23:10
An: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
Betreff: [Mono-dev] [PATCHES] Bug 480178 - System.Globalization.CharUnicodeInfo.GetUnicodeCategory() does not handle surrogate characters appropriately.


Hi,

I just uploaded an updated series of patches addressing bug 480178:

  <A HREF="https://bugzilla.novell.com/show_bug.cgi?id=480178#c27">https://bugzilla.novell.com/show_bug.cgi?id=480178#c27</A>

This is ready to be committed as far as I am concerned, but comments are
of course welcome.  Note that I do *not* have commit privileges, so
somebody else will have to take care of it even in case of green light.

&gt;<i>From the &#8220;cover letter&#8221;:
</I>
&gt;<i> Should apply cleanly on top of mono/mcs r157360.
</I>&gt;<i> 
</I>&gt;<i> This version uses the same technique as v2, as suggested by Paolo
</I>&gt;<i> (cf. comment #18), but supports two sets of tables: one compatible
</I>&gt;<i> with v2.0.50727...v3.5.21022 of Microsoft's framework, and one
</I>&gt;<i> matching v4.0.30319 (which incorporates substantial changes).  The
</I>&gt;<i> appropriate set is automatically chosen based on the 'corlib' profile.
</I>&gt;<i> 
</I>&gt;<i> The mechanism can be extended to an arbitrary number of versions, and
</I>&gt;<i> has also been tested with v1.1.4322, but these additional tables have
</I>&gt;<i> been left out not to bloat the Mono binaries as recent 'mcs' link to
</I>&gt;<i> the 'net_2_0' profile anyway.
</I>&gt;<i> 
</I>&gt;<i> Please cf. the individual ChangeLog entries for more details about the
</I>&gt;<i> compatibility and performance implications.  The first patch is for
</I>&gt;<i> 'mono'; the six others for 'mcs'.
</I>
Cheers,
Damien

-- 
<A HREF="http://crosstwine.com">http://crosstwine.com</A>
tel:  +49 21 89 29 39
cell: +49 174 34 89 428

&#8220;Strong Opinions, Weakly Held&#8221;
                 &#8212; Bob Johansen
_______________________________________________
Mono-devel-list mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034986.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
	<LI>Next message: <A HREF="034994.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34993">[ date ]</a>
              <a href="thread.html#34993">[ thread ]</a>
              <a href="subject.html#34993">[ subject ]</a>
              <a href="author.html#34993">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
