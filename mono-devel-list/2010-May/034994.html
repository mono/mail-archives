<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCHES%5D%20Bug%20480178%20-%0A%09System.Globalization.CharUnicodeInfo.GetUnicodeCategory%28%29%0A%09does%20not%20handle%20surrogate%20characters%20appropriately.&In-Reply-To=000c01caf422%24d5a24f50%2480e6edf0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034993.html">
   <LINK REL="Next"  HREF="034995.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.</H1>
    <B>Damien Diederen</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCHES%5D%20Bug%20480178%20-%0A%09System.Globalization.CharUnicodeInfo.GetUnicodeCategory%28%29%0A%09does%20not%20handle%20surrogate%20characters%20appropriately.&In-Reply-To=000c01caf422%24d5a24f50%2480e6edf0%24%40com"
       TITLE="[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.">dd at crosstwine.com
       </A><BR>
    <I>Sat May 15 11:04:58 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034993.html">[Mono-dev] [PATCHES] Bug 480178	-	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does	not handle surrogate characters appropriately.
</A></li>
        <LI>Next message: <A HREF="034995.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34994">[ date ]</a>
              <a href="thread.html#34994">[ thread ]</a>
              <a href="subject.html#34994">[ subject ]</a>
              <a href="author.html#34994">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Andreas,

&quot;Andreas Nahr&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">ClassDevelopment at A-SoftTech.com</A>&gt; writes:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm the author (of a large part) of the current Char class and
</I>&gt;<i> unfortunately I think you overlooked some things with the changes.
</I>&gt;<i>
</I>&gt;<i> What you are doing is (heavily) degrading the performance of most of
</I>&gt;<i> the char methods (some of which are VERY commonly used) for supporting
</I>&gt;<i> a single (likely VERY rarely used case) in a single (likely not used
</I>&gt;<i> very much) method.
</I>
Thanks for the feedback.  You are completely right: we were discussing
access times to the packed data, and I got sidetracked into measuring
that, mistakenly assuming these accesses would still be inlined in the
interesting cases.

I now had a look at the disassembly (better late than never), which is a
bit sobering.  Thanks for the sanity check!

&gt;<i> 1. Lets first start with performance. Unfortunately your micro
</I>&gt;<i> benchmark is completely omitting the most important speed factor: All
</I>&gt;<i> the methods were designed to be inlinable (because they tend to be
</I>&gt;<i> called in tight loops, as they are even within corelib). After your
</I>&gt;<i> change likely most/none of them would be inlinable anymore. Your
</I>&gt;<i> benchmark, however, does not CALL A SINGLE METHOD. It just measures
</I>&gt;<i> the overhead of two additional mathematical operators and a memory
</I>&gt;<i> access. That is not the big speed-sink. But even then your approach
</I>&gt;<i> looses 25% perf for no additional gain. The original implementation
</I>&gt;<i> was the result of (literally) thousands of performance tests.
</I>
Heh.  Ironically, I introduced the testing method to *avoid* measuring
function call overhead&#8230;

My initial iteration (in Bugzilla) was trying to take advantage of the
initial linear portion of the table, but the conditional function call
would probably also result in the method not being inlineable.

&gt;<i> 2. Gain vs. impact. I don't see much sense in changing lots of methods
</I>&gt;<i> in Char to something worse just to support one corner case that could
</I>&gt;<i> be handled separately.
</I>
Another goal of my approach was to support multiple variants of the
database while still sharing identical pages.  Maybe I should punt on
that, either by only supporting v2.0&#8211;3.5 or by including multiple flat
tables (which shouldn't be faulted in if not used).

&gt;<i> 3. Imho the alternative is relatively simple: Just leave the Char
</I>&gt;<i> methods as they are and add the special casing only for the one
</I>&gt;<i> relevant method. You could just add another table (or two for bi-level
</I>&gt;<i> table compression or one that reuses the data from the first table) as
</I>&gt;<i> a separate entity. So you can leave all the original methods intact
</I>&gt;<i> and ONLY if somebody really uses that method and ONLY if he uses it to
</I>&gt;<i> query the astral plane using surrogates he actually has to pay the
</I>&gt;<i> price for it (in the runtime loading the relevant table into memory
</I>&gt;<i> and using that additional lookup).
</I>
I just implemented such a solution, and quickly measured its performance
with the attached microbenchmark (feel free to point me to a more
representative test suite if you have one at hand).  On this (x86-64)
computer, it (unsurprisingly) results in the same numbers as the
unpached version:

$ time mono -O=all CharMicrobenchs.exe --load /tmp/mono.txt --repeat 5000 --run

  - Original Mono: 10.5s;
  - Bi-level table: 15.6s;
  - Linear + bi-level table: 10.5s.

(Run a few times; jitter is minimal.  Mono.txt is a lynx dump of
<A HREF="http://de.wikipedia.org/wiki/Mono-Projekt.">http://de.wikipedia.org/wiki/Mono-Projekt.</A>)

This approach grows the category data table from 64 to ~70kB, and
requires an additional 8kB index for the astral planes.  The resulting
runtime produces the same results as Microsoft's v2.0.50727 and
v3.5.21022 for the whole Unicode range, but has no support for v4.

Would that be an acceptable overhead?

Would supporting v4.0.30319 be worth it at an additional cost of ~78kB
of data (which shouldn't be faulted in) in the Mono binary?

Further comments are of course welcome.  I will prepare a new series of
patches in the near future.

&gt;<i> Happy hacking
</I>&gt;<i> Andreas
</I>&gt;<i>
</I>&gt;<i> P.S. And sorry for being somewhat harsh on the patches.
</I>
Heh.  That's what I get for cutting corners ;)

Cheers,
Damien
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: CharMicrobenchs.cs
Url: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100515/edc4b02a/attachment.pl">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100515/edc4b02a/attachment.pl</A> 
-------------- next part --------------
-- 
<A HREF="http://crosstwine.com">http://crosstwine.com</A>
tel:  +49 21 89 29 39
cell: +49 174 34 89 428

&#8220;Strong Opinions, Weakly Held&#8221;
                 &#8212; Bob Johansen
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034993.html">[Mono-dev] [PATCHES] Bug 480178	-	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does	not handle surrogate characters appropriately.
</A></li>
	<LI>Next message: <A HREF="034995.html">[Mono-dev] [PATCHES] Bug 480178 -	System.Globalization.CharUnicodeInfo.GetUnicodeCategory()	does not handle surrogate characters appropriately.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34994">[ date ]</a>
              <a href="thread.html#34994">[ thread ]</a>
              <a href="subject.html#34994">[ subject ]</a>
              <a href="author.html#34994">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
