<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Problem with ASP.NET MVC 2: Flawed implementation of	HttpServerUtility.Execute()?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Problem%20with%20ASP.NET%20MVC%202%3A%20Flawed%20implementation%20of%0A%09HttpServerUtility.Execute%28%29%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="035085.html">
   <LINK REL="Next"  HREF="034956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Problem with ASP.NET MVC 2: Flawed implementation of	HttpServerUtility.Execute()?</H1>
    <B>Oskar Berggren</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Problem%20with%20ASP.NET%20MVC%202%3A%20Flawed%20implementation%20of%0A%09HttpServerUtility.Execute%28%29%3F&In-Reply-To="
       TITLE="[Mono-dev] Problem with ASP.NET MVC 2: Flawed implementation of	HttpServerUtility.Execute()?">oskar.berggren at gmail.com
       </A><BR>
    <I>Sun May  9 14:24:14 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="035085.html">[Mono-dev] Playing with Mono.Terminal, no success
</A></li>
        <LI>Next message: <A HREF="034956.html">[Mono-dev] Problem with ASP.NET MVC 2: Flawed implementation of HttpServerUtility.Execute()?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34951">[ date ]</a>
              <a href="thread.html#34951">[ thread ]</a>
              <a href="subject.html#34951">[ subject ]</a>
              <a href="author.html#34951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Summary: Mono's HttpServerUtility.Execute() seems to be a simplified
implementation that turns out to be incompatible with certain features
of ASP.Net MVC2. Or I'm doing something wrong. :)

I'm experimenting with ASP.NET MVC 2 and just added a call to
RenderAction(). This seems to show a problem with HttpServerUtility:

System.NullReferenceException: Object reference not set to an instance
of an object
  at System.Web.HttpServerUtility.Execute (IHttpHandler handler,
System.IO.TextWriter writer, Boolean preserveForm, System.String
exePath, System.String queryString, Boolean isTransfer, Boolean
isInclude) [0x00124] in
/home/oskar/mono24/mono-2.6.4/mono-2.6.4/mcs/class/System.Web/System.Web/HttpServerUtility.cs:184
  at System.Web.HttpServerUtility.Execute (IHttpHandler handler,
System.IO.TextWriter writer, Boolean preserveForm) [0x00011] in
/home/oskar/mono24/mono-2.6.4/mono-2.6.4/mcs/class/System.Web/System.Web/HttpServerUtility.cs:266
  at System.Web.HttpServerUtilityWrapper.Execute (IHttpHandler
handler, System.IO.TextWriter writer, Boolean preserveForm) [0x00000]
in /home/oskar/mono24/mono-2.6.4/mono-2.6.4/mcs/class/System.Web.Abstractions/System.Web/HttpServerUtilityWrapper.cs:111
  at System.Web.Mvc.Html.ChildActionExtensions.ActionHelper
(System.Web.Mvc.HtmlHelper htmlHelper, System.String actionName,
System.String controllerName, System.Web.Routing.RouteValueDictionary
routeValues, System.IO.TextWriter textWriter) [0x00000] in &lt;filename
unknown&gt;:0
  at System.Web.Mvc.Html.ChildActionExtensions.RenderAction
(System.Web.Mvc.HtmlHelper htmlHelper, System.String actionName,
System.String controllerName, System.Web.Routing.RouteValueDictionary
routeValues) [0x00000] in &lt;filename unknown&gt;:0
  at System.Web.Mvc.Html.ChildActionExtensions.RenderAction
(System.Web.Mvc.HtmlHelper htmlHelper, System.String actionName,
System.String controllerName) [0x00000] in &lt;filename unknown&gt;:0
  at ASP.views_cwp_master.__RenderTree (System.Web.UI.HtmlTextWriter
__output, System.Web.UI.Control parameterContainer) [0x00000] in
&lt;filename unknown&gt;:0
  at System.Web.UI.Control.RenderChildren
(System.Web.UI.HtmlTextWriter writer) [0x0000b] in
/home/oskar/mono24/mono-2.6.4/mono-2.6.4/mcs/class/System.Web/System.Web.UI/Control.cs:1133
[... rest of normal asp.net and mvc2 stack trace omitted ...]


In Mono 2.6.4, around line 184 of HttpServerUtility.cs is this:

179 	if (!(handler is IHttpAsyncHandler)) {
180 	    handler.ProcessRequest (context);
181 	} else {
182 	    IHttpAsyncHandler asyncHandler = (IHttpAsyncHandler) handler;
183 	    IAsyncResult ar = asyncHandler.BeginProcessRequest (context,
null, null);
184 	    ar.AsyncWaitHandle.WaitOne ();
185 	    asyncHandler.EndProcessRequest (ar);
186 	}

I believe that AsyncWaitHandle is null here.

In this case, handler should be an instance of MvcHandler, which does
implement IHttpAsyncHandler. Its BeginProcessRequest() will detect
that my controller is synchronous and eventually return an instance of
WrappedAsyncResult. The WrappedAsyncResult instance is set up to do
nothing on Begin(), except set CompletedSynchronously to true and call
any specified callback. When asyncHandler.EndProcessRequest(ar) is
called we eventually end up in WrappedAsyncResult.End(), where the
controller is finally executed in a blocking manner.

WrappedAsyncResult.AsyncWaitHandle is get {
 return _innerAsyncResult.AsyncWaitHandle;
 }
with innerAsyncResult in this case being a SimpleAsyncResult.

SimpleAsyncResult.AsyncWaitHandle in turn returns null:
    // ASP.NET IAsyncResult objects should never expose a WaitHandle
due to potential deadlocking

    public WaitHandle AsyncWaitHandle {
 get {
 return null;
 }
 }

And this then causes the NullReferenceException in HttpServerUtility.Execute().

Any suggestions to resolve this?

/Oskar
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="035085.html">[Mono-dev] Playing with Mono.Terminal, no success
</A></li>
	<LI>Next message: <A HREF="034956.html">[Mono-dev] Problem with ASP.NET MVC 2: Flawed implementation of HttpServerUtility.Execute()?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34951">[ date ]</a>
              <a href="thread.html#34951">[ thread ]</a>
              <a href="subject.html#34951">[ subject ]</a>
              <a href="author.html#34951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
