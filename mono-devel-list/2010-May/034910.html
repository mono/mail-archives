<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Long execution time on first execution (in AOT case)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20execution%20time%20on%20first%20execution%20%28in%20AOT%20case%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034909.html">
   <LINK REL="Next"  HREF="034916.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Long execution time on first execution (in AOT case)</H1>
    <B>Martin D&#228;umler</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20execution%20time%20on%20first%20execution%20%28in%20AOT%20case%29&In-Reply-To="
       TITLE="[Mono-dev] Long execution time on first execution (in AOT case)">mdae at cs.tu-chemnitz.de
       </A><BR>
    <I>Tue May  4 08:16:32 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034909.html">[Mono-dev] Patch for scaled/cropped drawing bug in libgdi
</A></li>
        <LI>Next message: <A HREF="034916.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34910">[ date ]</a>
              <a href="thread.html#34910">[ thread ]</a>
              <a href="subject.html#34910">[ subject ]</a>
              <a href="author.html#34910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Mono developers,


I need some help from Mono internals experts. Briefly speaking,
I want to know exactly why the first execution of a code snippet,
e.g., a P/Invoke, within Mono takes more time than the second run,
especially in AOT case. First of all, I already read the AOT
documentation [1]. I also tried to dive into the code and wrote
some Mono tracing outputs ... but it is quite complex to select
the necessary information from the whole chain of methods that
keep Mono running.

Source files for the example and information about the test system
(for short: Linux on x86) can be downloaded under [2].

   Let's examine a simple P/Invoke which is executed several times.
   The invoked method just returns the method parameter's value. The
   very first P/Invoke takes much more time (JIT: approx. 312 &#181;s,
   AOT: &gt; 100 ms) than the following ones (JIT: 6 or 7 &#181;s, AOT: &lt; 1 &#181;s)
   on the test system. Test2 and Test3 are variants of Test1 which
   demonstrate cache effects. However, the very first execution takes
   longer in every case, so that's not all due to cache effects.


I want to know how to make the execution of a code snippet/method
deterministic, i.e., like C code can be deterministic, not necessarily
&quot;fast&quot;. That is, I tolerate a kind of &quot;initialization&quot; at startup time
of Mono, but the first execution must not take (much) more time than
following executions of the code snippet.


In detail:
==========

   - (How) Is it possible to load a AOT image completely into memory
   (not just map into memory) before executing one of its methods?
   Which function of Mono has to be called which way?

   - (How) Is it possible to fill the GOT- and PLT-entries _before_
   they are used the first time? Maybe a GOT-entry can not be
   filled beforehand if a runtime object's address is not known at
   startup time? Which function is called to do this
   ( decode_patch_info()? )?

   - Which additional functions have to be called when a AOT image's
   method is executed the first time? I.e., how to get metadata
   (mono_aot_get_class_info()?) or other necessary information/runtime
   structures for the Mono runtime in advance?

   - Are there any other functions that could cause longer execution
   time on first execution?

   - Any idea to measure execution time of managed code in granularity
   of &#181;s without using P/Invoke? The Environment.TickCount only provides
   granularity of ms.

   - Why is the execution of code snippets in a loop faster than
   when rolling out the loop in the JIT case?

   - Is it possible to JIT-compile all necessary wrapper methods
   during the &quot;initialization&quot; (instead of porting Full AOT to
   x86)? Note that AOTed wrapper methods (in the Full AOT case)
   could also impose some overhead when starting first execution
   since GOT- and/or PLT-entries have to be filled.



With kind regards,
Martin D&#228;umler


[1] <A HREF="http://mono-project.com/Mono:Runtime:Documentation:AOT">http://mono-project.com/Mono:Runtime:Documentation:AOT</A>
[2] <A HREF="http://www.tu-chemnitz.de/~mdae/sample-code.zip">http://www.tu-chemnitz.de/~mdae/sample-code.zip</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034909.html">[Mono-dev] Patch for scaled/cropped drawing bug in libgdi
</A></li>
	<LI>Next message: <A HREF="034916.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34910">[ date ]</a>
              <a href="thread.html#34910">[ thread ]</a>
              <a href="subject.html#34910">[ subject ]</a>
              <a href="author.html#34910">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
