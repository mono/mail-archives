<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Long execution time on first execution (in AOT case)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20execution%20time%20on%20first%20execution%20%28in%20AOT%20case%29&In-Reply-To=4BE01020.6070208%40cs.tu-chemnitz.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="034910.html">
   <LINK REL="Next"  HREF="035106.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Long execution time on first execution (in AOT case)</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Long%20execution%20time%20on%20first%20execution%20%28in%20AOT%20case%29&In-Reply-To=4BE01020.6070208%40cs.tu-chemnitz.de"
       TITLE="[Mono-dev] Long execution time on first execution (in AOT case)">vargaz at gmail.com
       </A><BR>
    <I>Tue May  4 16:59:55 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="034910.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
        <LI>Next message: <A HREF="035106.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34916">[ date ]</a>
              <a href="thread.html#34916">[ thread ]</a>
              <a href="subject.html#34916">[ subject ]</a>
              <a href="author.html#34916">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

   mono is designed to initialize most things lazily, so the first time &lt;x&gt;
is done, it will take more time. In particular, loading an aot image might
load it from disk, calling a pinvoke method
causes the shared libraries referenced by the pinvoke declaration to be
loaded from disk, etc.
Even calling a method does not initialize all the stuff needed by it, some
things will only be
initialized just before it is needed. So if you want to do soft real time
stuff, mono might not be
the perfect tool for that.

There are some steps that can be taken to decrease the latencies:
- For pinvoke, there is a Marshal.Prelink method which loads/looks up the
pinvoked function.
- For aot, the aot image is loaded when the corresponding assembly is
loaded.

                         Zoltan

On Tue, May 4, 2010 at 2:16 PM, Martin D&#228;umler &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mdae at cs.tu-chemnitz.de</A>&gt;wrote:

&gt;<i> Hello Mono developers,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I need some help from Mono internals experts. Briefly speaking,
</I>&gt;<i> I want to know exactly why the first execution of a code snippet,
</I>&gt;<i> e.g., a P/Invoke, within Mono takes more time than the second run,
</I>&gt;<i> especially in AOT case. First of all, I already read the AOT
</I>&gt;<i> documentation [1]. I also tried to dive into the code and wrote
</I>&gt;<i> some Mono tracing outputs ... but it is quite complex to select
</I>&gt;<i> the necessary information from the whole chain of methods that
</I>&gt;<i> keep Mono running.
</I>&gt;<i>
</I>&gt;<i> Source files for the example and information about the test system
</I>&gt;<i> (for short: Linux on x86) can be downloaded under [2].
</I>&gt;<i>
</I>&gt;<i>   Let's examine a simple P/Invoke which is executed several times.
</I>&gt;<i>   The invoked method just returns the method parameter's value. The
</I>&gt;<i>   very first P/Invoke takes much more time (JIT: approx. 312 &#181;s,
</I>&gt;<i>   AOT: &gt; 100 ms) than the following ones (JIT: 6 or 7 &#181;s, AOT: &lt; 1 &#181;s)
</I>&gt;<i>   on the test system. Test2 and Test3 are variants of Test1 which
</I>&gt;<i>   demonstrate cache effects. However, the very first execution takes
</I>&gt;<i>   longer in every case, so that's not all due to cache effects.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I want to know how to make the execution of a code snippet/method
</I>&gt;<i> deterministic, i.e., like C code can be deterministic, not necessarily
</I>&gt;<i> &quot;fast&quot;. That is, I tolerate a kind of &quot;initialization&quot; at startup time
</I>&gt;<i> of Mono, but the first execution must not take (much) more time than
</I>&gt;<i> following executions of the code snippet.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In detail:
</I>&gt;<i> ==========
</I>&gt;<i>
</I>&gt;<i>   - (How) Is it possible to load a AOT image completely into memory
</I>&gt;<i>   (not just map into memory) before executing one of its methods?
</I>&gt;<i>   Which function of Mono has to be called which way?
</I>&gt;<i>
</I>&gt;<i>   - (How) Is it possible to fill the GOT- and PLT-entries _before_
</I>&gt;<i>   they are used the first time? Maybe a GOT-entry can not be
</I>&gt;<i>   filled beforehand if a runtime object's address is not known at
</I>&gt;<i>   startup time? Which function is called to do this
</I>&gt;<i>   ( decode_patch_info()? )?
</I>&gt;<i>
</I>&gt;<i>   - Which additional functions have to be called when a AOT image's
</I>&gt;<i>   method is executed the first time? I.e., how to get metadata
</I>&gt;<i>   (mono_aot_get_class_info()?) or other necessary information/runtime
</I>&gt;<i>   structures for the Mono runtime in advance?
</I>&gt;<i>
</I>&gt;<i>   - Are there any other functions that could cause longer execution
</I>&gt;<i>   time on first execution?
</I>&gt;<i>
</I>&gt;<i>   - Any idea to measure execution time of managed code in granularity
</I>&gt;<i>   of &#181;s without using P/Invoke? The Environment.TickCount only provides
</I>&gt;<i>   granularity of ms.
</I>&gt;<i>
</I>&gt;<i>   - Why is the execution of code snippets in a loop faster than
</I>&gt;<i>   when rolling out the loop in the JIT case?
</I>&gt;<i>
</I>&gt;<i>   - Is it possible to JIT-compile all necessary wrapper methods
</I>&gt;<i>   during the &quot;initialization&quot; (instead of porting Full AOT to
</I>&gt;<i>   x86)? Note that AOTed wrapper methods (in the Full AOT case)
</I>&gt;<i>   could also impose some overhead when starting first execution
</I>&gt;<i>   since GOT- and/or PLT-entries have to be filled.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> With kind regards,
</I>&gt;<i> Martin D&#228;umler
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [1] <A HREF="http://mono-project.com/Mono:Runtime:Documentation:AOT">http://mono-project.com/Mono:Runtime:Documentation:AOT</A>
</I>&gt;<i> [2] <A HREF="http://www.tu-chemnitz.de/~mdae/sample-code.zip">http://www.tu-chemnitz.de/~mdae/sample-code.zip</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100504/58c83c3c/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20100504/58c83c3c/attachment.html</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="034910.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
	<LI>Next message: <A HREF="035106.html">[Mono-dev] Long execution time on first execution (in AOT case)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34916">[ date ]</a>
              <a href="thread.html#34916">[ thread ]</a>
              <a href="subject.html#34916">[ subject ]</a>
              <a href="author.html#34916">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
