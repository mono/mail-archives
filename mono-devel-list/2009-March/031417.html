<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for ZipPackagePart.GetStreamCore in	System.IO.Packaging (olive)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20ZipPackagePart.GetStreamCore%20in%0A%09System.IO.Packaging%20%28olive%29&In-Reply-To=e4fd36670903161221t59d67dc9w129cdded3345e35c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031394.html">
   <LINK REL="Next"  HREF="031395.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for ZipPackagePart.GetStreamCore in	System.IO.Packaging (olive)</H1>
    <B>Alan McGovern</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20ZipPackagePart.GetStreamCore%20in%0A%09System.IO.Packaging%20%28olive%29&In-Reply-To=e4fd36670903161221t59d67dc9w129cdded3345e35c%40mail.gmail.com"
       TITLE="[Mono-dev] Patch for ZipPackagePart.GetStreamCore in	System.IO.Packaging (olive)">alan.mcgovern at gmail.com
       </A><BR>
    <I>Wed Mar 18 07:58:19 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="031394.html">[Mono-dev] Patch for ZipPackagePart.GetStreamCore in	System.IO.Packaging (olive)
</A></li>
        <LI>Next message: <A HREF="031395.html">[Mono-dev] Announcing Mono 2.4 RC 3...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31417">[ date ]</a>
              <a href="thread.html#31417">[ thread ]</a>
              <a href="subject.html#31417">[ subject ]</a>
              <a href="author.html#31417">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Working on this one now.

Thanks!

Alan.

On Mon, Mar 16, 2009 at 7:21 PM, Yves Dhondt &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">yves.dhondt at gmail.com</A>&gt; wrote:

&gt;<i> Issue:
</I>&gt;<i> -------
</I>&gt;<i> ZipPackagePart.GetStreamCore in System.IO.Packaging does not handle
</I>&gt;<i> Filemode mode input parameter (correctly).
</I>&gt;<i>
</I>&gt;<i> Test program (requires an existing openxml document, for example
</I>&gt;<i> test.docx as input):
</I>&gt;<i> -------------------
</I>&gt;<i> I'm not that good with unit testing, but the following code should be
</I>&gt;<i> easily translated into 4 tests.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i> using System.IO;
</I>&gt;<i> using System.IO.Packaging;
</I>&gt;<i>
</I>&gt;<i> namespace MonoOpenXmlExperiment
</I>&gt;<i> {
</I>&gt;<i>   class Program
</I>&gt;<i>   {
</I>&gt;<i>     static void Main(string[] args)
</I>&gt;<i>     {
</I>&gt;<i>       // Warning do this with a document which can be damaged!!!
</I>&gt;<i>       Package pack = Package.Open(args[0]);
</I>&gt;<i>       PackagePart part = pack.CreatePart(new Uri(&quot;/somepart.xml&quot;,
</I>&gt;<i> UriKind.Relative), &quot;application/xml&quot;);
</I>&gt;<i>
</I>&gt;<i>       try
</I>&gt;<i>       {
</I>&gt;<i>         Stream s2 = part.GetStream(FileMode.CreateNew, FileAccess.Write);
</I>&gt;<i>       }
</I>&gt;<i>       catch (Exception ex)
</I>&gt;<i>       {
</I>&gt;<i>         // An ArgumentException should be throw as CreateNew is an
</I>&gt;<i> unsupported mode.
</I>&gt;<i>         Console.WriteLine(&quot;Expected ArgumentException, got {0}.&quot;,
</I>&gt;<i> ex.GetType().ToString());
</I>&gt;<i>       }
</I>&gt;<i>
</I>&gt;<i>       try
</I>&gt;<i>       {
</I>&gt;<i>         Stream s3 = part.GetStream(FileMode.Truncate, FileAccess.Write);
</I>&gt;<i>       }
</I>&gt;<i>       catch (Exception ex)
</I>&gt;<i>       {
</I>&gt;<i>         // An ArgumentException should be throw as Truncate is an
</I>&gt;<i> unsupported mode.
</I>&gt;<i>         Console.WriteLine(&quot;Expected ArgumentException, got {0}.&quot;,
</I>&gt;<i> ex.GetType().ToString());
</I>&gt;<i>       }
</I>&gt;<i>
</I>&gt;<i>       try
</I>&gt;<i>       {
</I>&gt;<i>         Stream s4 = part.GetStream(FileMode.Append, FileAccess.Write);
</I>&gt;<i>       }
</I>&gt;<i>       catch (Exception ex)
</I>&gt;<i>       {
</I>&gt;<i>         // An ArgumentException should be throw as Append is an
</I>&gt;<i> unsupported mode.
</I>&gt;<i>         Console.WriteLine(&quot;Expected ArgumentException, got {0}.&quot;,
</I>&gt;<i> ex.GetType().ToString());
</I>&gt;<i>       }
</I>&gt;<i>
</I>&gt;<i>       Stream s = part.GetStream(FileMode.OpenOrCreate, FileAccess.Write);
</I>&gt;<i>       StreamWriter sw = new StreamWriter(s);
</I>&gt;<i>       sw.Write(&quot;&lt;test&gt;aaaaaaa&lt;/test&gt;&quot;);
</I>&gt;<i>       sw.Flush();
</I>&gt;<i>
</I>&gt;<i>       Stream s5 = part.GetStream(FileMode.Create, FileAccess.ReadWrite);
</I>&gt;<i>       StreamWriter sw2 = new StreamWriter(s5);
</I>&gt;<i>       sw2.Write(&quot;&lt;test&gt;bbb&lt;/test&gt;&quot;);
</I>&gt;<i>       sw2.Flush();
</I>&gt;<i>
</I>&gt;<i>       // Verify that the part got overwritten correctly.
</I>&gt;<i>       Stream s6 = part.GetStream();
</I>&gt;<i>       StreamReader sr = new StreamReader(s6);
</I>&gt;<i>       Console.WriteLine(&quot;Expected &lt;test&gt;bbb&lt;/test&gt;, got {0}.&quot;,
</I>&gt;<i> sr.ReadToEnd());
</I>&gt;<i>
</I>&gt;<i>       pack.Close();
</I>&gt;<i>     }
</I>&gt;<i>   }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Expected output:
</I>&gt;<i> ------------------------
</I>&gt;<i> Expected ArgumentException, got System.ArgumentException.
</I>&gt;<i> Expected ArgumentException, got System.ArgumentException.
</I>&gt;<i> Expected ArgumentException, got System.ArgumentException.
</I>&gt;<i> Expected &lt;test&gt;bbb&lt;/test&gt;, got &lt;test&gt;bbb&lt;/test&gt;.
</I>&gt;<i>
</I>&gt;<i> Output currently given by mono:
</I>&gt;<i> ---------------------------------------------
</I>&gt;<i> Expected &lt;test&gt;bbb&lt;/test&gt;, got &lt;test&gt;bbb&lt;/test&gt;.
</I>&gt;<i>
</I>&gt;<i> Remarks:
</I>&gt;<i> -------------
</I>&gt;<i> The last test is especially important as it indicates that a create
</I>&gt;<i> would only overwrite part of stream.
</I>&gt;<i>
</I>&gt;<i> Solution:
</I>&gt;<i> ------------
</I>&gt;<i> Replace function by:
</I>&gt;<i>
</I>&gt;<i> protected override Stream GetStreamCore (FileMode mode, FileAccess access)
</I>&gt;<i>     {
</I>&gt;<i>       MemoryStream stream;
</I>&gt;<i>
</I>&gt;<i>       switch (mode)
</I>&gt;<i>       {
</I>&gt;<i>         case FileMode.CreateNew:
</I>&gt;<i>           throw new ArgumentException(&quot;FileMode not supported&quot;,
</I>&gt;<i> &quot;CreateNew&quot;);
</I>&gt;<i>         case FileMode.Truncate:
</I>&gt;<i>           throw new ArgumentException(&quot;FileMode not supported&quot;,
</I>&gt;<i> &quot;Truncate&quot;);
</I>&gt;<i>         case FileMode.Append:
</I>&gt;<i>           throw new ArgumentException(&quot;FileMode not supported&quot;, &quot;Append&quot;);
</I>&gt;<i>         case FileMode.Open:
</I>&gt;<i>           if (Package.PartStreams.TryGetValue(Uri, out stream)) {
</I>&gt;<i>             return new ZipPartStream(Package, stream, access);
</I>&gt;<i>           }
</I>&gt;<i>           else {
</I>&gt;<i>             throw new IOException(); // Verify that this is the
</I>&gt;<i> correct exception.
</I>&gt;<i>           }
</I>&gt;<i>         case FileMode.OpenOrCreate:
</I>&gt;<i>         case FileMode.Create:
</I>&gt;<i>           // Check if a stream is already loaded. If not, load it or
</I>&gt;<i> create an empty one.
</I>&gt;<i>           if (!Package.PartStreams.TryGetValue(Uri, out stream)) {
</I>&gt;<i>             stream = new MemoryStream();
</I>&gt;<i>
</I>&gt;<i>             try
</I>&gt;<i>             {
</I>&gt;<i>               using (UnzipArchive archive = new
</I>&gt;<i> UnzipArchive(Package.PackageStream))
</I>&gt;<i>               {
</I>&gt;<i>                 foreach (string file in archive.GetFiles())
</I>&gt;<i>                 {
</I>&gt;<i>                   if (file != Uri.ToString().Substring(1))
</I>&gt;<i>                     continue;
</I>&gt;<i>
</I>&gt;<i>                   using (Stream archiveStream = archive.GetStream(file))
</I>&gt;<i>                   {
</I>&gt;<i>                     int read = 0;
</I>&gt;<i>                     byte[] buffer = new
</I>&gt;<i> byte[Math.Min(archiveStream.Length, 2 * 1024)];
</I>&gt;<i>                     while ((read = archiveStream.Read(buffer, 0,
</I>&gt;<i> buffer.Length)) != 0)
</I>&gt;<i>                       stream.Write(buffer, 0, read);
</I>&gt;<i>                   }
</I>&gt;<i>                 }
</I>&gt;<i>               }
</I>&gt;<i>             }
</I>&gt;<i>             catch
</I>&gt;<i>             {
</I>&gt;<i>               // The zipfile is invalid, so just create the file
</I>&gt;<i>               // as if it didn't exist
</I>&gt;<i>               stream.SetLength(0);
</I>&gt;<i>             }
</I>&gt;<i>
</I>&gt;<i>             Package.PartStreams.Add(Uri, stream);
</I>&gt;<i>           }
</I>&gt;<i>
</I>&gt;<i>    // This ensures that an existing stream to which a create
</I>&gt;<i>    // is applied will be overwritten.
</I>&gt;<i>    if (mode == FileMode.Create)
</I>&gt;<i>             stream.SetLength(0);
</I>&gt;<i>
</I>&gt;<i>           return new ZipPartStream(Package, stream, access);
</I>&gt;<i>  default:
</I>&gt;<i>    throw new ArgumentOutOfRangeException(&quot;mode&quot;);
</I>&gt;<i>       }
</I>&gt;<i> }
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090318/33e55964/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20090318/33e55964/attachment-0001.html</A> 
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031394.html">[Mono-dev] Patch for ZipPackagePart.GetStreamCore in	System.IO.Packaging (olive)
</A></li>
	<LI>Next message: <A HREF="031395.html">[Mono-dev] Announcing Mono 2.4 RC 3...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31417">[ date ]</a>
              <a href="thread.html#31417">[ thread ]</a>
              <a href="subject.html#31417">[ subject ]</a>
              <a href="author.html#31417">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
