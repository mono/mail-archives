<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] JIT on iOS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20JIT%20on%20iOS&In-Reply-To=%3C50D1F2F3.309%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039948.html">
   <LINK REL="Next"  HREF="039951.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] JIT on iOS</H1>
    <B>Korn&#233;l P&#225;l</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20JIT%20on%20iOS&In-Reply-To=%3C50D1F2F3.309%40gmail.com%3E"
       TITLE="[Mono-dev] JIT on iOS">kornelpal at gmail.com
       </A><BR>
    <I>Wed Dec 19 17:01:39 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="039948.html">[Mono-dev] Xcode project
</A></li>
        <LI>Next message: <A HREF="039951.html">[Mono-dev] JIT on iOS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39950">[ date ]</a>
              <a href="thread.html#39950">[ thread ]</a>
              <a href="subject.html#39950">[ subject ]</a>
              <a href="author.html#39950">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi,

I was thinking about the feasibility of having an interpreter on iOS but 
making JIT functional would have a higher impact without significantly 
increasing future maintenance requirements.

First I found <A HREF="https://gist.github.com/855607">https://gist.github.com/855607</A> that has two relatively 
recent comments at the bottom that basically state that iOS 6 enables 
changing writable non-executable memory to read-only executable.

I also found 
<A HREF="http://www.stuartcarnie.com/2011/03/executable-pages-in-ios-43.html">http://www.stuartcarnie.com/2011/03/executable-pages-in-ios-43.html</A> that 
summarizes that read-only executable pages are of little use for a JIT 
producing multi-threaded code.

I haven't verified any of the claims because I don't usually develop on 
iOS and mprotect with PROT_EXEC may not be accepted to the App Store for 
iOS.

I however think that with some clever hacks the current JIT could be 
used with this W^X policy of iOS:

1. Using per-thread code pools could be used that avoids collisions for 
code used only on a single tread.

2. Temporarily make non-executable but writable the last page of code 
pool when adding a new method to avoid consuming too much memory pages. 
Time spent in non-executable state can be lessened by generating code in 
a separate buffer and only copying it to the code pool after is finished.

3. Resolve race conditions in the SIGSEGV handler by retrying code 
execution. To avoid infinite loops IP address must be checked to point 
to a code pool and code lock should probably be taken to ensure that the 
page is marked as executable again before retrying. This way code is 
ultimately able to be executed even when it takes multiple tries.

As long as the signal handler is not calling mprotect, only verifies 
under the code pool that the page is executable, security is not affected.

Under low JIT load race conditions occur rarely, while under high JIT 
load new code pages are allocated frequently, so race conditions quickly 
stop occurring for any specific function.

As a conclusion I think that this could work fine with very little 
modifications to JIT if PROT_EXEC is indeed supported.

I wonder if you have considered this solution or if you have any 
information regarding the feasibility of using mprotect with PROT_EXEC.

Thank you.

Kornel
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039948.html">[Mono-dev] Xcode project
</A></li>
	<LI>Next message: <A HREF="039951.html">[Mono-dev] JIT on iOS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39950">[ date ]</a>
              <a href="thread.html#39950">[ thread ]</a>
              <a href="subject.html#39950">[ subject ]</a>
              <a href="author.html#39950">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
