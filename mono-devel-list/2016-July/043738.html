<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Assert error for unaligned access in unwind.c
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Assert%20error%20for%20unaligned%20access%20in%20unwind.c&In-Reply-To=%3CA9BEF69C-54B7-458A-BC17-2D2AC04526BB%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043737.html">
   <LINK REL="Next"  HREF="043739.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Assert error for unaligned access in unwind.c</H1>
    <B>Henry Margies</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Assert%20error%20for%20unaligned%20access%20in%20unwind.c&In-Reply-To=%3CA9BEF69C-54B7-458A-BC17-2D2AC04526BB%40gmail.com%3E"
       TITLE="[Mono-dev] Assert error for unaligned access in unwind.c">henry.margies at gmail.com
       </A><BR>
    <I>Fri Jul 15 13:47:48 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="043737.html">[Mono-dev] A inline asm on aix
</A></li>
        <LI>Next message: <A HREF="043739.html">[Mono-dev] Assert error for unaligned access in unwind.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43738">[ date ]</a>
              <a href="thread.html#43738">[ thread ]</a>
              <a href="subject.html#43738">[ subject ]</a>
              <a href="author.html#43738">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I&#8217;m running into a strange problem when trying to use Mono 4.4.1.0 on an ARM architecture.

When I try to execute a Mono application or simply run mcs, I get the following output:

# mcs
* Assertion at unwind.c:385, condition `read16 (p) == (guint32)(op-&gt;when - loc)' not met

Stacktrace:


Native stacktrace:


Debug info from gdb:


=================================================================
Got a SIGABRT while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries 
used by your application.
=================================================================

Aborted


The same application and mcs work fine with Mono 4.0.2, I used a while ago. Looking at the source code in mono/mini/unwind.c in function mono_unwind_ops_encode_full, I can see that the code tries to cast a pointer to a guint16 or guint32 pointer, which will fail on (my) ARM when the address is not aligned (lines 378 and 384).

} else if (op-&gt;when - loc &gt; 256) {
    *p ++ = DW_CFA_advance_loc2;
    *(guint16*)p = (guint16)(op-&gt;when - loc);
    g_assert (read16 (p) == (guint32)(op-&gt;when - loc));


What is interesting, is that the g_assert is using the read16 macro, which deals with alignment issues and also endianness. But with this, I can&#8217;t really see how the code would work successfully with big endianness either. 

The code in question hasn&#8217;t changed between 4.0 and 4.4 but the pointer casting is only executed when &#8220;op-&gt;when - loc &gt; 256&#8221; is true. So I wonder why this changed for me between 4.0 and 4.4 and if I&#8217;m even supposed to run into these cases on an ARM architecture? When I fix the two problems, everything seems to run fine.

Because I don&#8217;t think that I&#8217;m the first to try to execute &#8220;mcs&#8221; or run a Mono application on an ARM architecture, I kind of blame my build system. I use buildroot and run my system on an ARM 926 device. Unfortunately, I have no idea what the code in mono_unwind_ops_encode_full actually does and when op-&gt;when - loc would actually be greater than 256.

I hope that someone here could give me some pointers on why the if condition could be true and never was before or in fact is not true for any ARM device, so I can check my build system.


Thanks,

Henry
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/mono-devel-list/attachments/20160715/eb9e3f4a/attachment.html">http://lists.dot.net/pipermail/mono-devel-list/attachments/20160715/eb9e3f4a/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043737.html">[Mono-dev] A inline asm on aix
</A></li>
	<LI>Next message: <A HREF="043739.html">[Mono-dev] Assert error for unaligned access in unwind.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43738">[ date ]</a>
              <a href="thread.html#43738">[ thread ]</a>
              <a href="subject.html#43738">[ subject ]</a>
              <a href="author.html#43738">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
