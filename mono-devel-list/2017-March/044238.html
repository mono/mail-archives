<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Memory%20Leak%20%28Bitmap%29Image.FromStream%28memory_stream%29&In-Reply-To=%3Cob458r%2475a%241%40blaine.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044237.html">
   <LINK REL="Next"  HREF="044250.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)</H1>
    <B>Robert Jordan</B> 
    <A HREF="mailto:mono-devel-list%40lists.dot.net?Subject=Re%3A%20%5BMono-dev%5D%20Memory%20Leak%20%28Bitmap%29Image.FromStream%28memory_stream%29&In-Reply-To=%3Cob458r%2475a%241%40blaine.gmane.org%3E"
       TITLE="[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)">robertj at gmx.net
       </A><BR>
    <I>Fri Mar 24 22:06:27 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044237.html">[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)
</A></li>
        <LI>Next message (by thread): <A HREF="044250.html">[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44238">[ date ]</a>
              <a href="thread.html#44238">[ thread ]</a>
              <a href="subject.html#44238">[ subject ]</a>
              <a href="author.html#44238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24.03.2017 20:17, Robert Jordan wrote:
&gt;<i> On 23.03.2017 21:51, rgclickit wrote:
</I>&gt;&gt;<i> I believe I discovered a memory leak when creating Bitmaps from the
</I>&gt;&gt;<i> Image.FromStream call. The basic code to reproduce the problem is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using (System.IO.MemoryStream ms = new
</I>&gt;&gt;<i> System.IO.MemoryStream(_sourceArray))
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>      using (Bitmap srcBitmap = (Bitmap)Image.FromStream(ms)) {
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I cannot reproduce this. The odds are that you're not computing
</I>&gt;<i> the memory usage correctly.
</I>&gt;<i>
</I>&gt;<i> See
</I>&gt;<i> <A HREF="http://www.mono-project.com/docs/advanced/performance-tips/#understanding-memory-usage">http://www.mono-project.com/docs/advanced/performance-tips/#understanding-memory-usage</A>
</I>

I was testing with a too large bitmap and hence too few iterations/sec.
With a 1x1 bitmap the leak started to become evident, so it
probably depends on how often Image.FromStream is getting called.

The code behind Image.FromStream is pretty complex because the
underlying unmanaged library (libgdiplus) knows nothing about
managed streams.

Hard to say, where to leak is. It might be an unmanaged one...

You may want to file a bug, ideally with a test case which doesn't
depend on WinForms, like this one:

---
using System;
using System.Drawing;
using System.IO;

class Program
{
	static void Run ()
	{
		using (var stream = File.OpenRead (&quot;test.bmp&quot;))
			using (Image.FromStream (stream)) {
                 }
	}

         static void Main ()
         {
                 for (int i = 0; i &lt; 100000; i++)
                         Run ();
         }
}
---

Robert


</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044237.html">[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)
</A></li>
	<LI>Next message (by thread): <A HREF="044250.html">[Mono-dev] Memory Leak (Bitmap)Image.FromStream(memory_stream)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44238">[ date ]</a>
              <a href="thread.html#44238">[ thread ]</a>
              <a href="subject.html#44238">[ subject ]</a>
              <a href="author.html#44238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
