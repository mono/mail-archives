<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Investigating mono crashes on linux 4.1
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Investigating%20mono%20crashes%20on%20linux%204.1&In-Reply-To=%3CCA%2B1gSVhHTq0rwjtsqrA0s9vz3mx8KRLDnA2aOOMNjORbPp3w4Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043137.html">
   <LINK REL="Next"  HREF="043138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Investigating mono crashes on linux 4.1</H1>
    <B>Rafael Teixeira</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20Investigating%20mono%20crashes%20on%20linux%204.1&In-Reply-To=%3CCA%2B1gSVhHTq0rwjtsqrA0s9vz3mx8KRLDnA2aOOMNjORbPp3w4Q%40mail.gmail.com%3E"
       TITLE="[Mono-dev] Investigating mono crashes on linux 4.1">monoman at gmail.com
       </A><BR>
    <I>Fri Jul 24 13:19:38 UTC 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="043137.html">[Mono-dev] Investigating mono crashes on linux 4.1
</A></li>
        <LI>Next message: <A HREF="043138.html">[Mono-dev] [Mono-list] contributing to mono with monodevelop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43139">[ date ]</a>
              <a href="thread.html#43139">[ thread ]</a>
              <a href="subject.html#43139">[ subject ]</a>
              <a href="author.html#43139">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>AFAIR, memory barriers are CORE to the new sgen GC logic for managing
what/when to collect. Not sure if you still can build with the conservative
(Boehm) GC to compare results, or gain more time to find the real
solution...

On Thu, Jul 23, 2015, 18:06 Taloth Saldono &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">talothsaldono at gmail.com</A>&gt; wrote:

&gt;<i> Hey Greg,
</I>&gt;<i>
</I>&gt;<i> With my current test case it crashes anywhere between 0.1 and 30 sec,
</I>&gt;<i> occasionally longer.
</I>&gt;<i> If I run my test case till it crashes, 10 times in a row, measuring the
</I>&gt;<i> total run time:
</I>&gt;<i> vanilla = 3m9.216s 2m26.571s 2m31.168s 3m8.670s
</I>&gt;<i> clear-at-gc = 1m50.81s 2m01.85s 1m10.21s 1m10.21s
</I>&gt;<i> disable-minor = 0m16.74s 0m16.32s (duh, more major collections. the
</I>&gt;<i> reverse happens if you increase the nursery size.)
</I>&gt;<i>
</I>&gt;<i> So.... yeah, clear-at-gc actually makes it worse. ;)
</I>&gt;<i>
</I>&gt;<i> It quite possibly has something to do with the GC, but i'm trying to find
</I>&gt;<i> the link with that rdtsc instruction.
</I>&gt;<i> Assuming the tsc isn't used in some convoluted way, it means it should be
</I>&gt;<i> a missing memory barrier somewhere.
</I>&gt;<i>
</I>&gt;<i> Taloth
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Jul 23, 2015 at 2:11 PM, Greg Young &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">gregoryyoung1 at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> We have seen some similar crashes of mono in linux (ubuntu and amazon
</I>&gt;&gt;<i> linux).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> One thing we have done that greatly reduces the frequency of the
</I>&gt;&gt;<i> crashes so far (removed 95%+ of them) is. MONO_GC_DEBUG=clear-at-gc
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There is an issue here as well
</I>&gt;&gt;<i> <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=18151">https://bugzilla.xamarin.com/show_bug.cgi?id=18151</A> that is likely
</I>&gt;&gt;<i> related.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Jul 23, 2015 at 3:03 PM, Taloth Saldono &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">talothsaldono at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Hey guys,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; (Initially I incorrectly posted this to the mono-list, so for those
</I>&gt;&gt;<i> &gt; receiving this message twice, my apologies.)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm looking for a mono expert on the managed threading system,
</I>&gt;&gt;<i> hopefully you
</I>&gt;&gt;<i> &gt; can give me a pointer to where to look.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The problem a couple of my users experience is that since linux kernel
</I>&gt;&gt;<i> 4.1
</I>&gt;&gt;<i> &gt; mono crashes in a reproducible manner. (Using test case bug-18026 in a
</I>&gt;&gt;<i> loop,
</I>&gt;&gt;<i> &gt; which is a threadpool stress-test)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; A similar problem occurred in 3.13.0 but that was fixed by backporting
</I>&gt;&gt;<i> some
</I>&gt;&gt;<i> &gt; commits in the ubuntu kernel. (See
</I>&gt;&gt;<i> &gt; <A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=29212">https://bugzilla.xamarin.com/show_bug.cgi?id=29212</A>)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Initially I believed that in 4.1 those commits were reverted, but tests
</I>&gt;&gt;<i> &gt; indicated that wasn't the cause.
</I>&gt;&gt;<i> &gt; So I did a full bisect on linux 4.0-4.1 on a 64-bit Ubuntu 14.04.2
</I>&gt;&gt;<i> &gt; Virtualbox. (~13 compiles of the kernel, took a couple of days)
</I>&gt;&gt;<i> &gt; And it ended up on
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> <A HREF="https://github.com/torvalds/linux/commit/c70e1b475f37f07ab7181ad28458666d59aae634">https://github.com/torvalds/linux/commit/c70e1b475f37f07ab7181ad28458666d59aae634</A>
</I>&gt;&gt;<i> .
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; The problem seems to cause NullReferenceException and possibly native
</I>&gt;&gt;<i> &gt; SIGSEGVs in a variety of places. (I can dump some stacktraces if
</I>&gt;&gt;<i> desired,
</I>&gt;&gt;<i> &gt; but I suspect that won't be helpful coz the corruption is likely caused
</I>&gt;&gt;<i> &gt; elsewhere.)
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; To me it seems impossible that reading the tsc in any way could result
</I>&gt;&gt;<i> in
</I>&gt;&gt;<i> &gt; the nullrefs. So my guess would it a side-effect of the memory barrier.
</I>&gt;&gt;<i> From
</I>&gt;&gt;<i> &gt; what I understand from the commit, the 'mfence+lfence' changed to
</I>&gt;&gt;<i> 'mfence or
</I>&gt;&gt;<i> &gt; lfence' (depending on what the cpu supports) and mfrence=lfence+sfence
</I>&gt;&gt;<i> (not
</I>&gt;&gt;<i> &gt; entirely true, but close), so I have no idea what the heck is going on
</I>&gt;&gt;<i> &gt; there.
</I>&gt;&gt;<i> &gt; But if I would venture a guess that somewhere, indirectly, mono
</I>&gt;&gt;<i> unknowingly
</I>&gt;&gt;<i> &gt; relies on that barrier to be there.
</I>&gt;&gt;<i> &gt; Theoretically it still means other native apps could experience the same
</I>&gt;&gt;<i> &gt; problem, but I would've expected reports about that already.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; My experience in these matters is pretty much non-existent. But dumping
</I>&gt;&gt;<i> &gt; issues on devs is the least productive way to get them fixed, so I try
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> &gt; investigate as far as I can. Especially since it involves an issue that
</I>&gt;&gt;<i> &gt; could be caused by either mono or the kernel.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; So my question is: Is there a likely candidate in mono where it uses
</I>&gt;&gt;<i> the tsc
</I>&gt;&gt;<i> &gt; (possibly for profiling) where the changed barrier could cause this odd
</I>&gt;&gt;<i> &gt; behavior? And obviously, is there anything in particular I could try to
</I>&gt;&gt;<i> &gt; narrow this down further?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Almost forgot, but I did the bisect using mono 4.0.2.5, but I tested the
</I>&gt;&gt;<i> &gt; nightly version as well.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Thank you for your time.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Taloth
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Studying for the Turing test
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150724/cec656d3/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20150724/cec656d3/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043137.html">[Mono-dev] Investigating mono crashes on linux 4.1
</A></li>
	<LI>Next message: <A HREF="043138.html">[Mono-dev] [Mono-list] contributing to mono with monodevelop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43139">[ date ]</a>
              <a href="thread.html#43139">[ thread ]</a>
              <a href="subject.html#43139">[ subject ]</a>
              <a href="author.html#43139">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
