<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Patch for DataGridView crash after Columsn.Clear
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20DataGridView%20crash%20after%20Columsn.Clear&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029824.html">
   <LINK REL="Next"  HREF="029869.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Patch for DataGridView crash after Columsn.Clear</H1>
    <B>jingnan si</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Patch%20for%20DataGridView%20crash%20after%20Columsn.Clear&In-Reply-To="
       TITLE="[Mono-dev] Patch for DataGridView crash after Columsn.Clear">jingnan.si at gmail.com
       </A><BR>
    <I>Wed Nov 12 20:35:26 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="029824.html">[Mono-dev] [PATCH] Implement Process.WaitForInputIdle	on	Windows.
</A></li>
        <LI>Next message: <A HREF="029869.html">[Mono-dev] Patch for DataGridView crash after Columsn.Clear
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29867">[ date ]</a>
              <a href="thread.html#29867">[ thread ]</a>
              <a href="subject.html#29867">[ subject ]</a>
              <a href="author.html#29867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
  First add several columns to DataGridView, then call
DataGridView.Columns.Clear, and re-add all the columns again, Call
DataGridView.Rows.Add(), the application will crash.
  After debug the mcs code, I found when DataGrideViewColumn added, the
DataGridView.RowTemplate will add correspond cell of the column, but when
column removed, it will not update the RowTemplate.
  I create a simple patch to make my application work.

Regards,

diff -r
mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridViewColumnCollection.cs
original/mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridViewColumnCollection.cs
105,108c105
&lt;             //list.Clear();
&lt;             while(Count &gt; 0)
&lt;                 RemoveAt(0);
&lt;
---
&gt;<i>             base.List.Clear ();
</I>202d198
&lt;             DataGridView.OnColumnRemovedInternal (new
DataGridViewColumnEventArgs (dataGridViewColumn));
219,220c215
&lt;             DataGridView.OnColumnRemovedInternal (new
DataGridViewColumnEventArgs (col));
&lt;             OnCollectionChanged (new CollectionChangeEventArgs
(CollectionChangeAction.Remove, col));
---
&gt;<i>             OnCollectionChanged (new CollectionChangeEventArgs
</I>(CollectionChangeAction.Add, col));
diff -r
mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridView.cs
original/mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridView.cs
1033,1034d1032
&lt;                 rowTemplate.SetDataGridView(this);
&lt;
3512d3509
&lt;                 RowTemplate.Cells[RowTemplate.Cells.Count -
1].SetColumnIndex(e.Column.Index);
3650,3678d3646
&lt;         internal void OnColumnRemovedInternal(DataGridViewColumnEventArgs
e)
&lt;         {
&lt;             if (e.Column.Index &gt;= 0) {
&lt;                 foreach(DataGridViewCell cell in RowTemplate.Cells) {
&lt; //System.Console.WriteLine(&quot;Column:&quot; + e.Column.Index + &quot;,&quot; +
cell.ColumnIndex);
&lt;                     if (cell.ColumnIndex == e.Column.Index) {
&lt;                         RowTemplate.Cells.Remove(cell);
&lt;                         break;
&lt;                     }
&lt;                 }
&lt;
&lt;                 foreach (DataGridViewRow row in Rows) {
&lt;                     foreach(DataGridViewCell cell in row.Cells) {
&lt;                         if (cell.ColumnIndex == e.Column.Index) {
&lt;                             RowTemplate.Cells.Remove(cell);
&lt;                             break;
&lt;                         }
&lt;                     }
&lt;                 }
&lt;
&lt;
&lt;             }
&lt;
&lt;             AutoResizeColumnsInternal ();
&lt;             OnColumnRemoved (e);
&lt;             PrepareEditingRow (false, true);
&lt;         }
&lt;
&lt;
diff -r
mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridViewRowCollection.cs
original/mono-2.0/mcs/class/Managed.Windows.Forms/System.Windows.Forms/DataGridViewRowCollection.cs
243,244d242
&lt;             int count = list.Count;
&lt;
246,247d243
&lt;
&lt;             DataGridView.OnRowsRemoved (new
DataGridViewRowsRemovedEventArgs (0, count));
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081113/93d6a1ff/attachment-0001.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081113/93d6a1ff/attachment-0001.html</A> 
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029824.html">[Mono-dev] [PATCH] Implement Process.WaitForInputIdle	on	Windows.
</A></li>
	<LI>Next message: <A HREF="029869.html">[Mono-dev] Patch for DataGridView crash after Columsn.Clear
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29867">[ date ]</a>
              <a href="thread.html#29867">[ thread ]</a>
              <a href="subject.html#29867">[ subject ]</a>
              <a href="author.html#29867">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
