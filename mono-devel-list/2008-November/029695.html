<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Mono.Simd Acceleration Attributes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono.Simd%20Acceleration%20Attributes&In-Reply-To=20081107113011.GX360%40debian.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="029694.html">
   <LINK REL="Next"  HREF="029699.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Mono.Simd Acceleration Attributes</H1>
    <B>Christophe Guillon</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Mono.Simd%20Acceleration%20Attributes&In-Reply-To=20081107113011.GX360%40debian.org"
       TITLE="[Mono-dev] Mono.Simd Acceleration Attributes">christophe.guillon.perso at gmail.com
       </A><BR>
    <I>Fri Nov  7 07:54:39 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="029694.html">[Mono-dev] Mono.Simd Acceleration Attributes
</A></li>
        <LI>Next message: <A HREF="029699.html">[Mono-dev] Mono.Simd Acceleration Attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29695">[ date ]</a>
              <a href="thread.html#29695">[ thread ]</a>
              <a href="subject.html#29695">[ subject ]</a>
              <a href="author.html#29695">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for the explanation. It confirms my point and it seems that we
agree.

For the user guide aspect:
&gt;<i>2) the attributes on the methods are never inspected by the runtime:
</I>&gt;<i>they are there to guide the programmers using Mono.Simd in determining
</I>&gt;<i>what kind of optimizations are usually available or currently enabled.
</I>If it is indeed &quot;just&quot; a guide to the user of Mono.Simd, thus why putting it
in the library and coupling this with the specific architecture (SSE2 or
other). The fact that it is an AddWithSaturation on a Vector16b is
sufficient for the semantic. Then a note in the mono VM documentation can
tell that on SSE2 architectures -O=simd will select the corresponding SSE2
op is sufficient. Optionaly a note in the library documentation can tell
that mono &quot;normally&quot; should catch such calls on SSE2 architectures.

For the choice of the accelerated or not accelerated mode at runtime:
&gt;<i>       static readonly bool use_mono_simd = (SimdRuntime.AccelMode &amp;
</I>AccelMode.SSE2) != &gt;0;
&gt;<i>      ...
</I>&gt;<i>       if (use_mono_simd)
</I>&gt;<i>               // simd codepath
</I>&gt;<i>       else
</I>&gt;<i>               //scalar codepath
</I>If it is actually to overcome a temporary inneficiency due to some copy, it
is imho far too intrusive in the user code. Here the user clearly wrote a
code that is dependent on some &quot;external&quot; context, but instead of querying
the actual VM runtime, or simply a user defined variable that can be found
in some configuration file of the application, the query is on the Mono.Simd
library itself.
While in fact the library itself as no knowledge of the actual efficiency of
the running VM.

Thus I fully agree with this (which is my point):
&quot;Note that we may eventually either return the attribute not based on the
metadata in the assembly, but based on the runtime understanding: this
will avoid the need to have an updated Mono.Simd assembly when new
optimizations are added. Just use the b pattern if you want to avoid
that issue and remember that you don't usually need to check all the
methods, but just the ones you actually need to be optimized.&quot;

All the question there is, whether or not there is a way to get from the
runtime this information and by which mean?
Is it possible to have attributes attached (or simulated) by the runtime?


  -- Christophe

2008/11/7 Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>&gt;

&gt;<i> On 11/07/08 Christophe Guillon wrote:
</I>&gt;<i> &gt; It seems that as soon as the Mono.Simd primitives have a well defined
</I>&gt;<i> &gt; semantic it is not useful to specify which architecture feature is able
</I>&gt;<i> to
</I>&gt;<i> &gt; emulate each of these primitives. I would have expected this to be the
</I>&gt;<i> &gt; choice of the virtual execution environment.
</I>&gt;<i>
</I>&gt;<i> It _is_ ultimately a choice of the runtime.
</I>&gt;<i> These attributes are never inspected by the runtime to decide whether to
</I>&gt;<i> optimize a method call or not.
</I>&gt;<i>
</I>&gt;<i> &gt; - if my underlying hardware XXX (not SSE2) is able to support efficiently
</I>&gt;<i> &gt; add with saturation, I do not have to know whether SSE2 also supports it,
</I>&gt;<i> &gt; the virtual machine for XXX can use the corresponding add with saturation
</I>&gt;<i> &gt; instruction of XXX at the call sites of AddWithSaturation()   anyway,
</I>&gt;<i>
</I>&gt;<i> When the runtime will implement that optimization, the attribute will be
</I>&gt;<i> changed to include SSE2 and your architecture (say AltiVec or Neon
</I>&gt;<i> etc). Yes, this requires a re-release of Mono.Simd, but it's not a big
</I>&gt;<i> deal as the changes will be relatively rare and if you are happy to
</I>&gt;<i> use unoptimized Mono.Simd anyway it doesn't matter.
</I>&gt;<i>
</I>&gt;<i> &gt; - if my underlying hardware features SSE2, the attribute is not useful,
</I>&gt;<i> the
</I>&gt;<i> &gt; virtual machine knows the underlying hardware and thus know that a SSE2
</I>&gt;<i> &gt; instruction is able to emulate this,
</I>&gt;<i>
</I>&gt;<i> It's useful to the Mono.Simd programmers, the runtime doesn't use it.
</I>&gt;<i>
</I>&gt;<i> &gt; - if the attribute is there to restrict the mapping to only SSE2 (and
</I>&gt;<i> above)
</I>&gt;<i> &gt; machines, it is an important restriction to the usage of the library.
</I>&gt;<i> &gt; Imagine as above that I have in the future a hardware support XXX that is
</I>&gt;<i> &gt; able to do AddWithSaturation on Vector16b; if I want a virtual machine to
</I>&gt;<i> &gt; execute efficiently this primitive on XXX I would first have to modify
</I>&gt;<i> the
</I>&gt;<i> &gt; Mono.Simd library to add the corresponding XXX attribute and modify the
</I>&gt;<i> &gt; primitives declaration to account for it.
</I>&gt;<i>
</I>&gt;<i> Nope, this is not correct.
</I>&gt;<i> The behaviour is as follows:
</I>&gt;<i> 1) the runtime will choose whether a method is optimized or not
</I>&gt;<i> depending on the optimization flags (-O=simd, on by default) and on
</I>&gt;<i> the features of the current processor.
</I>&gt;<i> 2) the attributes on the methods are never inspected by the runtime:
</I>&gt;<i> they are there to guide the programmers using Mono.Simd in determining
</I>&gt;<i> what kind of optimizations are usually available or currently enabled.
</I>&gt;<i>
</I>&gt;<i> The reasoning is this: using unoptimized Mono.Simd is currently
</I>&gt;<i> significantly slower than he equivalent scalar code. This has mostly to
</I>&gt;<i> do with the additional copies that happen because of the operator
</I>&gt;<i> overloading. This overhead is expected to decrease as we add more jit
</I>&gt;<i> optimizations. So you have two cases:
</I>&gt;<i>
</I>&gt;<i> 1) the slowdown is not significant to you (you must test! Run your
</I>&gt;<i> program with mono -O=simd and with mono -O=-simd): in this case
</I>&gt;<i> you should ignore completely the acceleration attributes and just enjoy
</I>&gt;<i> the speedup that the jit will give you when it can optimize the methods.
</I>&gt;<i>
</I>&gt;<i> 2) if the slowdown is significant you might want to have two codepaths,
</I>&gt;<i> mostly in the same way in C/C++ you have a C implementation and a simd
</I>&gt;<i> implementation of the critical functions. Now the question becomes:
</I>&gt;<i> how do you choose at runtime if you want to use Mono.Simd or the scalar
</I>&gt;<i> codepath? We offset two patters:
</I>&gt;<i>
</I>&gt;<i> a) do a coarse decision: you take a look at the methods you use in your
</I>&gt;<i> algorithms and see that they are optimized when SSE2 is enabled, so you
</I>&gt;<i> just do:
</I>&gt;<i>        static readobly bool use_mono_simd = (SimdRuntime.AccelMode &amp;
</I>&gt;<i> AccelMode.SSE2) != 0;
</I>&gt;<i>        ...
</I>&gt;<i>        if (use_mono_simd)
</I>&gt;<i>                // simd codepath
</I>&gt;<i>        else
</I>&gt;<i>                //scalar codepath
</I>&gt;<i>
</I>&gt;<i> b) a fine-grained decision based on all or some of the methods you use:
</I>&gt;<i> for each method you check
</I>&gt;<i>        (SimdRuntime.MethodAccelerationMode (typeof(...), &quot;...&quot;) &amp;
</I>&gt;<i> SimdRuntime.AccelMode) != 0
</I>&gt;<i> until you determine that enough of your methods are accelerated to make
</I>&gt;<i> it worth using the Mono.Simd codepath.
</I>&gt;<i>
</I>&gt;<i> Note that we may eventually either return the attribute not based on the
</I>&gt;<i> metadata in the assembly, but based on the runtime understanding: this
</I>&gt;<i> will avoid the need to have an updated Mono.Simd assembly when new
</I>&gt;<i> optimizations are added. Just use the b pattern if you want to avoid
</I>&gt;<i> that issue and remember that you don't usually need to check all the
</I>&gt;<i> methods, but just the ones you actually need to be optimized.
</I>&gt;<i>
</I>&gt;<i> lupus
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> -----------------------------------------------------------------
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081107/307b6020/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20081107/307b6020/attachment.html</A> 
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="029694.html">[Mono-dev] Mono.Simd Acceleration Attributes
</A></li>
	<LI>Next message: <A HREF="029699.html">[Mono-dev] Mono.Simd Acceleration Attributes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29695">[ date ]</a>
              <a href="thread.html#29695">[ thread ]</a>
              <a href="subject.html#29695">[ subject ]</a>
              <a href="author.html#29695">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
