<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Interop with unmanaged code without copying	or memory allocation?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Interop%20with%20unmanaged%20code%20without%20copying%0A%09or%20memory%20allocation%3F&In-Reply-To=004001c3d8ae%24d3b576e0%24037da8c0%40karl">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003538.html">
   <LINK REL="Next"  HREF="003563.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Interop with unmanaged code without copying	or memory allocation?</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Interop%20with%20unmanaged%20code%20without%20copying%0A%09or%20memory%20allocation%3F&In-Reply-To=004001c3d8ae%24d3b576e0%24037da8c0%40karl"
       TITLE="[Mono-devel-list] Interop with unmanaged code without copying	or memory allocation?">jonpryor at vt.edu
       </A><BR>
    <I>Mon Jan 12 22:20:08 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="003538.html">[Mono-devel-list] Interop with unmanaged code without copying or memory allocation?
</A></li>
        <LI>Next message: <A HREF="003563.html">[Mono-devel-list] Interop with unmanaged code without copyingor memory allocation?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3561">[ date ]</a>
              <a href="thread.html#3561">[ thread ]</a>
              <a href="subject.html#3561">[ subject ]</a>
              <a href="author.html#3561">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It sounds like you're trying to wrap a difficult API.  Good luck.

Regarding Problem 1 (interning strings), is there any particular reason
you want the strings interned?  The only time it's useful is if you want
to use pointer comparison instead of string comparison for strings,
which would require that users do this:

	((object) String1) == ((object) String2)

I suspect most people will stick with the typical:

	String1 == String2

which calls Object.Equals, so there's no reason to intern the string
(unless you want to require your users use the first code).

Assuming you do want to intern the string, you could create a hashtable,
manually hash the &quot;const XML_Char *name&quot;, and use this hash value to
lookup the interned string.  This would likely require writing your own
hash function (so it can operate on a &quot;const XML_Char*&quot;), and you'd have
to consider hash table conflicts, but this could be made to work.

Personally, I wouldn't worry about it until you've done the performance
profiling (mono --profile is your friend!) and determined that string
interning would actually be a benefit.

Regarding Problem 2, I can't think of any good way to avoid the
marshaling/copying overhead.  Managed and unmanaged memory must be kept
separate (to permit the use of non-conservative garbage collectors). 
You could employ C# &quot;unsafe&quot; code in the callback methods, but this
would prevent non-C# languages (VB, JavaScript, etc.) from being used as
callbacks...

This is really the problem behind Problem 1 -- memory must be kept
separate, and coming up with efficient ways to bridge the barrier is
difficult, hence the marshaling overhead...

 - Jon

On Sun, 2004-01-11 at 20:53, Karl Waclawek wrote:
&gt;<i> I am fairly new to C#/.NET/Mono, so this may be a trivial problem
</I>&gt;<i> (however, I did read <A HREF="http://www.jprl.com/~jon/interop.html">http://www.jprl.com/~jon/interop.html</A>):
</I>&gt;<i> 
</I>&gt;<i> My task is to write a C# wrapper for the Expat XML parser,
</I>&gt;<i> which is available as a dynamic library (.dll, .so).
</I>&gt;<i> I want this wrapper to have as little overhead as possible,
</I>&gt;<i> as the main &quot;raison d'etre&quot; for Expat is its speed.
</I>&gt;<i> 
</I>&gt;<i> The Expat API is mostly character pointer based, two of the
</I>&gt;<i> most commonly used call-back functions have this signature
</I>&gt;<i> (i.e. call-back from Dll back to application):
</I>&gt;<i> 
</I>&gt;<i> /* atts is array of name/value pairs, terminated by 0;
</I>&gt;<i>    names and values are 0 terminated.
</I>&gt;<i> */
</I>&gt;<i> typedef void (XMLCALL *XML_StartElementHandler) (void *userData,
</I>&gt;<i>                                                  const XML_Char *name,
</I>&gt;<i>                                                  const XML_Char **atts);
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /* s is not 0 terminated. */
</I>&gt;<i> typedef void (XMLCALL *XML_CharacterDataHandler) (void *userData,
</I>&gt;<i>                                                   const XML_Char *s, 
</I>&gt;<i>                                                   int len);
</I>&gt;<i> 
</I>&gt;<i> where XML_Char is a two byte entity (ushort or wchar_t).
</I>&gt;<i> 
</I>&gt;<i> What I would like to do is wrap these call-backs in a way
</I>&gt;<i> that the actual call-backs look like this in C#:
</I>&gt;<i> 
</I>&gt;<i> void StartElement(string Name, IAttributes atts);
</I>&gt;<i>   and
</I>&gt;<i> void Characters(char[] ch, int start, int length);
</I>&gt;<i> 
</I>&gt;<i> (The wrapper routines themselves will have to be delegates, 
</I>&gt;<i> as far as I could tell).
</I>&gt;<i> Ignoring the &quot;IAttributes atts&quot; argument, I have two problems:
</I>&gt;<i> 
</I>&gt;<i> 1) I would like to &quot;intern&quot; the first occurrence of a given name passed to
</I>&gt;<i>    XML_StartElementHandler() and let subsequent occurrences of the same name
</I>&gt;<i>    pass the same interned string object to the StartElement function in C#.
</I>&gt;<i> However, it seems I cannot look up an instance in the string pool
</I>&gt;<i> passing some array or pointer, I have to allocate a new string instance
</I>&gt;<i> based on the contents of name just to call String.Intern. This
</I>&gt;<i> defeats the purpose.
</I>&gt;<i> 
</I>&gt;<i> 2) It would be nice if I could somehow cast the &quot;const XML_Char *s&quot;
</I>&gt;<i>    argument passed to XML_CharacterDataHandler() to an array.
</I>&gt;<i> It seems that the best I can do in C# is to re-use the same array
</I>&gt;<i> instance (for the ch argument) and copy the characters from s into it.
</I>&gt;<i> 
</I>&gt;<i> So, for case 1) I have the problem of new string allocation
</I>&gt;<i> for each call, and for case 2) I have the problem of copying.
</I>&gt;<i> 
</I>&gt;<i> I guess going from unmanaged to managed will always require
</I>&gt;<i> copying, so I won't be able to improve on 2), but case 1) really
</I>&gt;<i> bothers me as it should be possible to look up an interned string
</I>&gt;<i> using something else but another string.
</I>&gt;<i> 
</I>&gt;<i> Any advice?
</I>&gt;<i> 
</I>&gt;<i> Karl
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003538.html">[Mono-devel-list] Interop with unmanaged code without copying or memory allocation?
</A></li>
	<LI>Next message: <A HREF="003563.html">[Mono-devel-list] Interop with unmanaged code without copyingor memory allocation?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3561">[ date ]</a>
              <a href="thread.html#3561">[ thread ]</a>
              <a href="subject.html#3561">[ subject ]</a>
              <a href="author.html#3561">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
