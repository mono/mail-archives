<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Callling convention for interop call-backs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Callling%20convention%20for%20interop%20call-backs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003690.html">
   <LINK REL="Next"  HREF="003695.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Callling convention for interop call-backs</H1>
    <B>Liyu Liu</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Callling%20convention%20for%20interop%20call-backs&In-Reply-To="
       TITLE="[Mono-devel-list] Callling convention for interop call-backs">liyul at hotmail.com
       </A><BR>
    <I>Tue Jan 20 11:44:56 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="003690.html">[Mono-devel-list] Patch for Bug 45976
</A></li>
        <LI>Next message: <A HREF="003695.html">[Mono-devel-list] Callling convention for interop call-backs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3693">[ date ]</a>
              <a href="thread.html#3693">[ thread ]</a>
              <a href="subject.html#3693">[ subject ]</a>
              <a href="author.html#3693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There are two issues with interop:
1. should winapi be cdecl or stdcall?
2. Can mcs be extended to support specifying call conventions in delegate as
an extension to C#?

There are only two call conventions supported in .net, --cdecl or stdcall.
For Microsoft implementation, winapi is stdcall on win32 and cdecl on CE.
The fastcall is almost never used. Currently mono on win32 take default
winapi as cdecl which created compatibility problems. Any assembly
containing P/Invoke working with mono, like Mono.Data.SqliteClient etc,
cannot work with Microsoft .net runtime without source code change and
recompilation. Also same vice versa.

Microsoft's csc doesn't have support for cdecl for callback, thus people has
to be resorted to IL hack to change such

      .method public hidebysig virtual instance int32
              Invoke(native int o,
                     int32 argc,
                     int8** argv,
                     int8** colnames) runtime managed
      {
      } // end of method SqliteCallbackFunction::Invoke

   to
      .method public hidebysig virtual instance int32
modopt([mscorlib]System.Runtime.CompilerServices.CallConvCdecl)
              Invoke(native int o,
                     int32 argc,
                     int8** argv,
                     int8** colnames) runtime managed
      {
      } // end of method SqliteCallbackFunction::Invoke

This should be relatively easy to support in mcs and mono.

It is a breaking change. But seemed to us best way is to extend mcs to
support cdecl callback and change mono to use stdcall as default for winapi
on win32. This will force all P/Invoke done with mono to change to use cdecl
explicitly. But the benefit is final assemeblies working without any hitch
or changes across linux/win32. There will also be no need of IL hacks.

I submitted this as a bug as
<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=52834">http://bugzilla.ximian.com/show_bug.cgi?id=52834</A> and Zoltan seemed to have
fixed it. But we really want to learn a bit more thoughts and make sure it
works.

Luke


&gt;<i> Message: 1
</I>&gt;<i> From: &quot;Karl Waclawek&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">karl at waclawek.net</A>&gt;
</I>&gt;<i> To: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at ximian.com</A>&gt;
</I>&gt;<i> Date: Sat, 17 Jan 2004 18:19:51 -0500
</I>&gt;<i> Subject: [Mono-devel-list] Callling convention for interop call-backs
</I>&gt;<i>
</I>&gt;<i> In the MS version of C# it is possible to define a calling
</I>&gt;<i> convention for PInvoking functions in an unmanaged Dll, but
</I>&gt;<i> there is now way to specify a calling convention for the
</I>&gt;<i> delegates used as call-backs. Well, there is an assembly-hack,
</I>&gt;<i> but no easy way.
</I>&gt;<i>
</I>&gt;<i> Is that the same for C# in Mono?
</I>&gt;<i>
</I>&gt;<i> Karl
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003690.html">[Mono-devel-list] Patch for Bug 45976
</A></li>
	<LI>Next message: <A HREF="003695.html">[Mono-devel-list] Callling convention for interop call-backs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3693">[ date ]</a>
              <a href="thread.html#3693">[ thread ]</a>
              <a href="subject.html#3693">[ subject ]</a>
              <a href="author.html#3693">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
