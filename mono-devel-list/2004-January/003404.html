<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] System.Reflection Performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20System.Reflection%20Performance&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003410.html">
   <LINK REL="Next"  HREF="003405.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] System.Reflection Performance</H1>
    <B>Ben Maurer</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20System.Reflection%20Performance&In-Reply-To="
       TITLE="[Mono-devel-list] System.Reflection Performance">bmaurer at users.sourceforge.net
       </A><BR>
    <I>Fri Jan  2 00:29:42 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="003410.html">[Mono-devel-list] kill specific mono process
</A></li>
        <LI>Next message: <A HREF="003405.html">[Mono-devel-list] System.Reflection Performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3404">[ date ]</a>
              <a href="thread.html#3404">[ thread ]</a>
              <a href="subject.html#3404">[ subject ]</a>
              <a href="author.html#3404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Today I was doing performance testing and noticed that some reflection
operations were taking alot longer than I thought they would. So, I
decided to profile. My origional issue was with MethodBase.Invoke. I
wrote the following test:

using System;
using System.Reflection;

public class A {
	public void Foo (int a, int b, int c, int d, int e, string s, string ss, string sss)
	{
	}
	
	public static void Main ()
	{
		A a = new A ();
		MethodInfo mi = typeof (A).GetMethod (&quot;Foo&quot;);
		object [] rgs = {1, 2, 3, 4, 5, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;};
		
		for (int i = 0; i &lt; 500000; i ++)
			mi.Invoke (a, rgs);
	}
}

On my local Linux box, I got:
[<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">benm at Ben</A> perf]$ time mono ref1.exe
 
real    0m21.470s
user    0m21.360s
sys     0m0.010s

I copied the program over to a Windows box, where it ran in 3 seconds.
The windows box has a lower processor speed and less ram than my Linux
box. I decided to --profile it, and I got (obviously, i reduced the
number of times the loop executed):


&gt;<i> ########################
</I>&gt;<i>  548.976       1  548.976   .A::Main()
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>            1  100 % .A::Main(object,intptr,intptr)
</I>&gt;<i> ########################
</I>&gt;<i>  549.953       1  549.953   .A::Main(object,intptr,intptr)
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i> ########################
</I>&gt;<i>  484.546    5000    0.097   System.Reflection.MethodBase::Invoke(object,object[])
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>         5000  100 % .A::Main()
</I>&gt;<i> ########################
</I>&gt;<i>  475.791    5000    0.095   System.Reflection.MonoMethod::Invoke(object,BindingFlags,Binder,object[],CultureInfo)
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>         5000  100 % System.Reflection.MethodBase::Invoke(object,object[])
</I>&gt;<i> ########################
</I>&gt;<i>  416.657    5000    0.083   System.Reflection.Binder::ConvertArgs(Binder,object[],ParameterInfo[],CultureInfo)
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>         5000  100 % System.Reflection.MonoMethod::Invoke(object,BindingFlags,Binder,object[],CultureInfo)
</I>&gt;<i> ########################
</I>&gt;<i>  292.208   40000    0.007   .Default::ChangeType(object,Type,CultureInfo)
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>        40000  100 % System.Reflection.Binder::ConvertArgs(Binder,object[],ParameterInfo[],CultureInfo)
</I>&gt;<i> ########################
</I>&gt;<i>  222.243   40001    0.006   System.Object::GetType()
</I>&gt;<i>   Callers (with count) that contribute at least for 1%:
</I>&gt;<i>            1  100 % System.Exception::.ctor(string)
</I>&gt;<i> ########################
</I>
So, it is quite obvious that the GetType is the bulk of the problem.

using System;

class T {
	static void Main ()
	{
		object o = 1;
		
		for (int i = 0; i &lt; 5000000; i ++) {
			Type t = o.GetType ();
			// dont opt t away somehow
			if (t == null)
				break;
		}
	}
}

On Mono:
[<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">benm at Ben</A> perf]$ time mono ref2.exe
 
real    0m23.568s
user    0m23.450s
sys     0m0.010s

On the windows box, it ran in .6 seconds. Remember, the windows box is
slower.

I am wondering if any of the runtime gurus can think of ways to make
GetType faster. GetType is by no means *fast* in MS, it is not designed
to be. However, it seems reasonable that it should be a tad bit faster
than this.

As a side note, I did a quick test on the Invoke call in MS.net, it is
pretty clear that they call the Binder iff the parameter type does not
match exactly (I tested by making a Binder that would always return 500,
and then called a method with the sig (int,int) with params (byte,int).
The first parameter was passed as 500, the second was unmodified.) So,
it appears we could change Invoke to do the check in C. In C we would be
able to take alot of shortcuts (not allocating the params array, quicker
type operations, etc, etc). I think this would be an easy way to fix the
specific manifestation of the problem. However, I really think GetType
should be *much* faster. There are alot of tricks that can be done with
GetType that would depend on it being quick.

-- Ben



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003410.html">[Mono-devel-list] kill specific mono process
</A></li>
	<LI>Next message: <A HREF="003405.html">[Mono-devel-list] System.Reflection Performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3404">[ date ]</a>
              <a href="thread.html#3404">[ thread ]</a>
              <a href="subject.html#3404">[ subject ]</a>
              <a href="author.html#3404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
