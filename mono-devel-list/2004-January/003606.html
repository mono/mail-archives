<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] StringBuilder patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20StringBuilder%20patch&In-Reply-To=1074029540.4393.109.camel%40Ben">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003591.html">
   <LINK REL="Next"  HREF="003608.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] StringBuilder patch</H1>
    <B>Paolo Molaro</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20StringBuilder%20patch&In-Reply-To=1074029540.4393.109.camel%40Ben"
       TITLE="[Mono-devel-list] StringBuilder patch">lupus at ximian.com
       </A><BR>
    <I>Wed Jan 14 11:02:10 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="003591.html">[Mono-devel-list] StringBuilder patch
</A></li>
        <LI>Next message: <A HREF="003608.html">[Mono-devel-list] StringBuilder patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3606">[ date ]</a>
              <a href="thread.html#3606">[ thread ]</a>
              <a href="subject.html#3606">[ subject ]</a>
              <a href="author.html#3606">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/13/04 Ben Maurer wrote:
&gt;<i> &gt; The new code already creates a new string if the string buffer is unused
</I>&gt;<i> &gt; for the most part. Maybe the code can be changed in the future to use
</I>&gt;<i> &gt; some different criteria, like, don't waste more than x bytes etc.
</I>&gt;<i> &gt; I don't see any reason to keep the old code around: it's much more a
</I>&gt;<i> &gt; waste to keep it maintained and have two copies of mostly the same code
</I>&gt;<i> &gt; jitted in the same application.
</I>&gt;<i> 
</I>&gt;<i> The real issue is when you create long lasting strings. Lets say you
</I>&gt;<i> create 10 k strings each with a length of 17 bytes. If the buffer is 32
</I>&gt;<i> bytes, you end up wasting 150 kb.
</I>
Yes, there are some worst cases, hence my suggestion to experiment with
some other mechanism than the 'half the buffer'. A Mono built for a
low-mem embedded system most likely wants to use a 'don't waste more
than 4 bytes' or something like that.

&gt;<i> In the MCS tokenizer, for large programs such as corlib, we could end up
</I>&gt;<i> taking a megabyte or more extra memory and holding it.
</I>
If you know you're going to hold the strings and if there is a lot of
wasted space, you can copy the strings yourself (sb.Subsctring is likely
to do that on all the sb implementations). But what you don't seem to
get is that:
*) you (mscorlib user) don't know how much memory might be wasted by
sb.ToString()
*) it doesn't make sense to uglyfy the mcs source code (or other
program's source code) when the gain has not even been measured
*) [mscorlib]System.Text.Stringbuilder is what the 99.9% of apps will
use anyway, so we need to make it perform well enough for those apps:
with that in mind, mainatining a separate package is worthless
(especially since that one has other unsolvable performance issues as
well)

FWIW, a corlib compile wasted about 700KB and only half of the ToString
calls are in the tokenizer, so, assuming all of them get kept around
(unlikely), it uses about 300KB more memory than needed.
If the stringbuilder check is changed to:
	if (_str.Length - _length &gt; 16)
the amount of possibly wasted memory goes down to 30KB (measured:
compare this to your 'prediction' of a megabyte or more. It would be
good if people did their homework before writing emails, but maybe this
is an old-fashioned thing...).
The check likely needs to be more complete, since for large strings it's
going to needlessly copy a lot of data around, but the point is that the
issue can be fixed in the current stringbuilder for everyone, there is no 
need to keep an ugly version of the code around.

lupus

-- 
-----------------------------------------------------------------
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at debian.org</A>                                     debian/rules
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">lupus at ximian.com</A>                             Monkeys do it better

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003591.html">[Mono-devel-list] StringBuilder patch
</A></li>
	<LI>Next message: <A HREF="003608.html">[Mono-devel-list] StringBuilder patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3606">[ date ]</a>
              <a href="thread.html#3606">[ thread ]</a>
              <a href="subject.html#3606">[ subject ]</a>
              <a href="author.html#3606">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
