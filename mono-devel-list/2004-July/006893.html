<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-devel-list] Getting Tao.OpenGl building with Mono and	GTK# with gtkglext-sharp
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Getting%20Tao.OpenGl%20building%20with%20Mono%20and%0A%09GTK%23%20with%20gtkglext-sharp&In-Reply-To=cci7d1%24uks%241%40sea.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006892.html">
   <LINK REL="Next"  HREF="006895.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-devel-list] Getting Tao.OpenGl building with Mono and	GTK# with gtkglext-sharp</H1>
    <B>Jackson Harper</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-devel-list%5D%20Getting%20Tao.OpenGl%20building%20with%20Mono%20and%0A%09GTK%23%20with%20gtkglext-sharp&In-Reply-To=cci7d1%24uks%241%40sea.gmane.org"
       TITLE="[Mono-devel-list] Getting Tao.OpenGl building with Mono and	GTK# with gtkglext-sharp">jackson at ximian.com
       </A><BR>
    <I>Wed Jul  7 23:03:53 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006892.html">[Mono-devel-list] Getting Tao.OpenGl building with Mono and GTK# with gtkglext-sharp
</A></li>
        <LI>Next message: <A HREF="006895.html">[Mono-devel-list] Getting Tao.OpenGl building with Mono and	GTK# with gtkglext-sharp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6893">[ date ]</a>
              <a href="thread.html#6893">[ thread ]</a>
              <a href="subject.html#6893">[ subject ]</a>
              <a href="author.html#6893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The ilasm and monodis patches have been in CVS for a couple of days :-).

Jackson


On Wed, 2004-07-07 at 18:18, Steven Brown wrote:
&gt;<i> Hello, I've been poking on the Tao framework in Mono's CVS trying to get 
</I>&gt;<i> it to build with only Mono instead of depending on Microsoft's tools, 
</I>&gt;<i> and running in Linux with GTK#.  Almost everything works with a couple 
</I>&gt;<i> patches to Tao and Mono, and I can successfully do OpenGL with GTK#. 
</I>&gt;<i> Patches are included here and I'll give some instructions below.  I'm 
</I>&gt;<i> not sure who's the contact now for Tao since it moved into Mono's CVS; 
</I>&gt;<i> should discussion go to mono-devel, the GTK# list, or ..?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> First you need to patch Tao's PostProcess project so it can read monodis 
</I>&gt;<i> -generated il code as well as ildasm il.  The attached patch 
</I>&gt;<i> 'tao-monodis-regex-swb.patch' does this.  (Tao's PostProcess 
</I>&gt;<i> disassembles Tao dlls, does a regex to replace some il code in the 
</I>&gt;<i> IlasmAttribute and a couple other changes, and reassembles the dll.  See 
</I>&gt;<i> their FAQ).
</I>&gt;<i> 
</I>&gt;<i> To build the Tao.OpenGl project, compile the pre-processed dll:
</I>&gt;<i> 
</I>&gt;<i> mcs /d:LINUX /clscheck- /unsafe /t:library /out:Tao.OpenGl.dll *.cs
</I>&gt;<i> 
</I>&gt;<i> Build the PostProcessor:
</I>&gt;<i> 
</I>&gt;<i> mcs /t:exe /out:Tao.PostProcess.exe *.cs
</I>&gt;<i> 
</I>&gt;<i> Disassemble the pre-processed dll:
</I>&gt;<i> 
</I>&gt;<i> monodis Tao.OpenGl.dll --output=Tao.OpenGl.il
</I>&gt;<i> 
</I>&gt;<i> Run the PostProcessor:
</I>&gt;<i> 
</I>&gt;<i> mono PostProcess.exe Tao.OpenGl.il Tao.OpenGl.pp.il /R /Y
</I>&gt;<i> 
</I>&gt;<i> Re-assemble the post-processed il.  You will need the attached patches 
</I>&gt;<i> 'mcs-ilasm-NumberHelper-float.swb.patch' and 
</I>&gt;<i> 'mono-monodis-typing-swb.patch', as Mono's ilasm doesn't recognize 
</I>&gt;<i> floats like &quot;1e+150&quot;, and monodis forgets to wrap it in a float64() 
</I>&gt;<i> cast.  There is still one bug left (but it's being looked at by jackson) 
</I>&gt;<i> that prevents Mono's ilasm from finishing this step, so you'll need to 
</I>&gt;<i> run it with Microsoft's ilasm for now:
</I>&gt;<i> 
</I>&gt;<i> ilasm /dll /output:Tao.OpenGl.dll Tao.OpenGl.pp.il
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> You can then use the resulting Tao.OpenGl.dll with gtkglext-sharp and 
</I>&gt;<i> GTK# to get OpenGL in GTK#.  Nifty. :)  Almost completely independent of 
</I>&gt;<i> Microsoft tools, now.  If you use gtkglext-sharp, you'll also need the 
</I>&gt;<i> two attached .config files to tell it what libraries to use on Linux.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'll add these patches to bugzilla if it looks like they'll fall off the 
</I>&gt;<i> list.  These instructions should also really be CVSed into a README in 
</I>&gt;<i> the Tao module until it gets autoconfed.  What I'd like to see is the 
</I>&gt;<i> GTK# project absorb gtkglext-sharp as one of the optional dlls it 
</I>&gt;<i> builds, as I think its extension of GTK widgets to support OpenGL is a 
</I>&gt;<i> big win for GTK#, and it would prevent gtkglext-sharp from being lost to 
</I>&gt;<i> bitrot.  I'll probably need to ask the GTK# list about that, but what do 
</I>&gt;<i> y'all think about that idea?  It was the best solution to OpenGL with 
</I>&gt;<i> GTK# I could find.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> Change the regex that matches ends of attributes, as Mono fully qualifies the
</I>&gt;<i> names.  E.g.:
</I>&gt;<i> 
</I>&gt;<i> MS: // end of class DelegateCallingConventionCdeclAttribute
</I>&gt;<i> Mono: // end of class Tao.OpenGl.DelegateCallingConventionCdeclAttribute
</I>&gt;<i> 
</I>&gt;<i> Change the regex that cuts the body of the IlasmAttribute to be compatible with
</I>&gt;<i> monodis-genereated il.  Checks for a line with no starting hex rather than
</I>&gt;<i> expecting 'Code size' which should be a tad more generic.
</I>&gt;<i> 
</I>&gt;<i> This will fix PostProcess.exe spinning on monodis generated il.  It should
</I>&gt;<i> remain compatible with Microsoft ildasm generated il.
</I>&gt;<i> 
</I>&gt;<i> - Steven Brown &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">swbrown at ucsd.edu</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Index: Framework/Projects/Tao.PostProcess/ReleaseBuildProcessor.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /mono/tao/Framework/Projects/Tao.PostProcess/ReleaseBuildProcessor.cs,v
</I>&gt;<i> retrieving revision 1.2
</I>&gt;<i> diff -u -r1.2 ReleaseBuildProcessor.cs
</I>&gt;<i> --- Framework/Projects/Tao.PostProcess/ReleaseBuildProcessor.cs	6 Jun 2004 19:51:38 -0000	1.2
</I>&gt;<i> +++ Framework/Projects/Tao.PostProcess/ReleaseBuildProcessor.cs	30 Jun 2004 05:11:48 -0000
</I>&gt;<i> @@ -112,7 +112,7 @@
</I>&gt;<i>          private string ModifyIlasmCalls(string fileContent) {
</I>&gt;<i>              int callStartPosition = -1;
</I>&gt;<i>              int callEndPosition = -1;
</I>&gt;<i> -            Regex callStart = new Regex(@&quot;((?&lt;Method&gt; \.custom instance void Tao\..*?\.IlasmAttribute::\.ctor\(string\) = \((?&lt;Body&gt; .*?) \/\/ Code size .*? )} \/\/ end of)&quot;, RegexOptions.Compiled | RegexOptions.Singleline);
</I>&gt;<i> +            Regex callStart = new Regex(@&quot;((?&lt;Method&gt; \.custom instance void (class )?Tao\..*?\.IlasmAttribute::\.ctor\(string\)\s*=\s*\((?&lt;Body&gt;.*?)(?&lt;LineWithNoHex&gt;\n\s*[^0-9A-Fa-f\s]).*?)}\s*\/\/ end of)&quot;, RegexOptions.Compiled | RegexOptions.Singleline);
</I>&gt;<i>  
</I>&gt;<i>              Match callStartMatch = callStart.Match(fileContent);
</I>&gt;<i>              while(callStartMatch.Success) {
</I>&gt;<i> @@ -235,7 +235,7 @@
</I>&gt;<i>          /// &lt;/remarks&gt;
</I>&gt;<i>          protected override string InjectMsil(string fileContent) {
</I>&gt;<i>              Regex attributeStart = new Regex(@&quot;\.class .*? IlasmAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i> -            Regex attributeEnd = new Regex(@&quot;// end of class IlasmAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i> +            Regex attributeEnd = new Regex(@&quot;// end of class .*IlasmAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i>              fileContent = RemoveAttribute(attributeStart, attributeEnd, fileContent);
</I>&gt;<i>              fileContent = ModifyIlasmCalls(fileContent);
</I>&gt;<i>  
</I>&gt;<i> @@ -258,7 +258,7 @@
</I>&gt;<i>          /// &lt;/remarks&gt;
</I>&gt;<i>          protected override string ModifyCdeclDelegates(string fileContent) {
</I>&gt;<i>              Regex attributeStart = new Regex(@&quot;\.class .*? DelegateCallingConventionCdeclAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i> -            Regex attributeEnd = new Regex(@&quot;// end of class DelegateCallingConventionCdeclAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i> +            Regex attributeEnd = new Regex(@&quot;// end of class .*DelegateCallingConventionCdeclAttribute&quot;, RegexOptions.Compiled);
</I>&gt;<i>              fileContent = RemoveAttribute(attributeStart, attributeEnd, fileContent);
</I>&gt;<i>              fileContent = ModifyCdeclDelegateCalls(fileContent);
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> Literal float tokens as generated by monodis like &quot;1e+150&quot; fail to be parsed by
</I>&gt;<i> ilasm as NumberHelper only checks for a '.' to consider a number a float.
</I>&gt;<i> Quick hack fix of having it also check for an 'e' or 'E'.
</I>&gt;<i> 
</I>&gt;<i> - Steven Brown &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">swbrown at ucsd.edu</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Index: ilasm/scanner/NumberHelper.cs
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /mono/mcs/ilasm/scanner/NumberHelper.cs,v
</I>&gt;<i> retrieving revision 1.8
</I>&gt;<i> diff -u -r1.8 NumberHelper.cs
</I>&gt;<i> --- ilasm/scanner/NumberHelper.cs	10 Jun 2004 21:01:19 -0000	1.8
</I>&gt;<i> +++ ilasm/scanner/NumberHelper.cs	29 Jun 2004 06:00:00 -0000
</I>&gt;<i> @@ -118,7 +118,7 @@
</I>&gt;<i>                          }
</I>&gt;<i>  
</I>&gt;<i>                          try {
</I>&gt;<i> -                                if (num.IndexOf ('.') != -1) {
</I>&gt;<i> +                                if (num.IndexOf ('.') != -1 || num.IndexOf('e') != -1 || num.IndexOf('E') != -1) {
</I>&gt;<i>                                          double d = Double.Parse (num, nstyles, NumberFormatInfo.InvariantInfo);
</I>&gt;<i>                                          result.token = Token.FLOAT64;
</I>&gt;<i>                                          result.val = d;
</I>&gt;<i> 
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> float64 cast for literals as done by ildasm was missing in monodis.  Might not
</I>&gt;<i> matter, but makes the output similiar.
</I>&gt;<i> 
</I>&gt;<i> I assume the same is true for float32, so it was also changed.
</I>&gt;<i> 
</I>&gt;<i> - Steven Brown &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">swbrown at ucsd.edu</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Index: mono/dis/get.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /mono/mono/mono/dis/get.c,v
</I>&gt;<i> retrieving revision 1.82
</I>&gt;<i> diff -u -r1.82 get.c
</I>&gt;<i> --- mono/dis/get.c	25 Jun 2004 18:54:50 -0000	1.82
</I>&gt;<i> +++ mono/dis/get.c	29 Jun 2004 06:13:14 -0000
</I>&gt;<i> @@ -1621,12 +1621,12 @@
</I>&gt;<i>  	case MONO_TYPE_R4: {
</I>&gt;<i>  		float r;
</I>&gt;<i>  		readr4 (ptr, &amp;r);
</I>&gt;<i> -		return g_strdup_printf (&quot;%g&quot;, (double) r);
</I>&gt;<i> +		return g_strdup_printf (&quot;float32(%g)&quot;, (double) r);
</I>&gt;<i>  	}
</I>&gt;<i>  	case MONO_TYPE_R8: {
</I>&gt;<i>  		double r;
</I>&gt;<i>  		readr8 (ptr, &amp;r);
</I>&gt;<i> -		return g_strdup_printf (&quot;%g&quot;, r);
</I>&gt;<i> +		return g_strdup_printf (&quot;float64(%g)&quot;, r);
</I>&gt;<i>  	}
</I>&gt;<i>  	case MONO_TYPE_STRING: {
</I>&gt;<i>  		int i, j, e;
</I>&gt;<i> 
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> &lt;configuration&gt;
</I>&gt;<i>   &lt;dllmap dll=&quot;libgtkglext-win32-1.0-0.dll&quot; target=&quot;libgtkglext-x11-1.0.so.0&quot;/&gt;
</I>&gt;<i>   &lt;dllmap dll=&quot;libgdkglext-win32-1.0-0.dll&quot; target=&quot;libgdkglext-x11-1.0.so.0&quot;/&gt;
</I>&gt;<i> &lt;/configuration&gt;
</I>&gt;<i> 
</I>&gt;<i> ______________________________________________________________________
</I>&gt;<i> &lt;configuration&gt;
</I>&gt;<i>   &lt;dllmap dll=&quot;libgtkglext-win32-1.0-0.dll&quot; target=&quot;libgtkglext-x11-1.0.so.0&quot;/&gt;
</I>&gt;<i>   &lt;dllmap dll=&quot;libgdkglext-win32-1.0-0.dll&quot; target=&quot;libgdkglext-x11-1.0.so.0&quot;/&gt;
</I>&gt;<i> &lt;/configuration&gt;
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006892.html">[Mono-devel-list] Getting Tao.OpenGl building with Mono and GTK# with gtkglext-sharp
</A></li>
	<LI>Next message: <A HREF="006895.html">[Mono-devel-list] Getting Tao.OpenGl building with Mono and	GTK# with gtkglext-sharp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6893">[ date ]</a>
              <a href="thread.html#6893">[ thread ]</a>
              <a href="subject.html#6893">[ subject ]</a>
              <a href="author.html#6893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
