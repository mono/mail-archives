<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev]  [PATCH] Mono DTrace provider
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=C15FA95C-BD18-493E-BA27-5462F678F089%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027997.html">
   <LINK REL="Next"  HREF="028032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev]  [PATCH] Mono DTrace provider</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=C15FA95C-BD18-493E-BA27-5462F678F089%40web.de"
       TITLE="[Mono-dev]  [PATCH] Mono DTrace provider">andreas.faerber at web.de
       </A><BR>
    <I>Mon May 26 18:45:24 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027997.html">[Mono-dev] Mono dtrace provider?
</A></li>
        <LI>Next message: <A HREF="028032.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28025">[ date ]</a>
              <a href="thread.html#28025">[ thread ]</a>
              <a href="subject.html#28025">[ subject ]</a>
              <a href="author.html#28025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here's a patch for adding DTrace USDT support to the Mono runtime.

It introduces a configure switch --enable-dtrace to turn on DTrace  
support. If configured with --enable-dtrace, Mono uses dtrace to  
generate a header in mono/utils/, and only if on Solaris, Makefile  
rules for postprocessing the object files are triggered. Four probes  
are introduced, requiring postprocessing steps for mono, libmono and  
pedump on Solaris. The MONO_GC_END() macro for the gc-end probe causes  
the postprocessing to fail on Solaris, so I've limited it to OSX for  
now.

This patch was tested on OSX ppc and i386 and on Solaris i86. It does  
not yet support OSX x86_64 because I do not have such a machine around  
to check the $host string (is it i*86-*-darwin* or something x64- 
specific?), and for inclusion in SVN it would additionally need a copy  
of the generated header file (such as attached) for systems without  
DTrace or with DTrace disabled.

Comments and suggestions welcome.

Andreas
-------------- next part --------------
A non-text attachment was scrubbed...
Name: DTrace-USDT-1.diff
Type: application/octet-stream
Size: 6988 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080527/593e8090/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080527/593e8090/attachment.obj</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: mono-dtrace.h
Type: application/octet-stream
Size: 1419 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080527/593e8090/attachment-0001.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080527/593e8090/attachment-0001.obj</A> 
-------------- next part --------------

Am 25.05.2008 um 22:59 schrieb Andreas F?rber:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I've revisited the idea of a DTrace provider for Mono and managed to  
</I>&gt;<i> get it working on OpenSolaris 2008.05 (dtrace 1.6) and Mac OS X  
</I>&gt;<i> v10.5 (dtrace 1.2.2).
</I>&gt;<i>
</I>&gt;<i> On OSX, all that is required is the C header file generated by  
</I>&gt;<i> `dtrace -h`.
</I>&gt;<i>
</I>&gt;<i> Weird hacks around libtool are only necessary on (Open)Solaris. The  
</I>&gt;<i> problem with my previous attempt was that `dtrace -G` not only needs  
</I>&gt;<i> read access to the object files but also modifies them! When  
</I>&gt;<i> updating libmono-static.a via `ar r` after `drace -G`, everything is  
</I>&gt;<i> fine and I finally see my test probe!
</I>&gt;<i> The problem with this approach still is that it's a hack, because  
</I>&gt;<i> the location of the .a file and of the .o files is at the discretion  
</I>&gt;<i> of libtool and thus not very portable. But since it appears to be  
</I>&gt;<i> limited to Solaris, we could limit such questionable build steps to  
</I>&gt;<i> that platform and an explicit configuration option.
</I>&gt;<i>
</I>&gt;<i> Attached is my diff, with Solaris stuff disabled. Also attached is  
</I>&gt;<i> the header generated on OSX and OpenSolaris.
</I>&gt;<i> Note that in mono-dtrace.nv.h the #if _DTRACE_VERSION should be  
</I>&gt;<i> replaced with something more sensible via regex (to avoid my  
</I>&gt;<i> workaround in mini.c), same for #include &lt;unistd.h&gt; which I believe  
</I>&gt;<i> hearing was not portable for Windows.
</I>&gt;<i> &lt;dtrace-hack3.diff&gt;&lt;mono-dtrace.osx.h&gt;&lt;mono-dtrace.nv.h&gt;
</I>&gt;<i>
</I>&gt;<i> Am 13.01.2008 um 19:12 schrieb Miguel de Icaza:
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I thought data/ would be an obvious choice for the .d file, and  
</I>&gt;&gt;&gt;<i> chose
</I>&gt;&gt;&gt;<i> mono/utils for the generated header and object file but the object
</I>&gt;&gt;&gt;<i> file seems to depend on all object files with the probes, here  
</I>&gt;&gt;&gt;<i> mini.o
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hand written information can go into the data directory;   Source  
</I>&gt;&gt;<i> code
</I>&gt;&gt;<i> generated by a tool should be generated at compile time.
</I>&gt;<i>
</I>&gt;<i> The issue with that approach is the use-case of the generated  
</I>&gt;<i> header: The Solaris version thereof (dtrace 1.5+?) defines  
</I>&gt;<i> convenience macros for use in the source code, guarded by an #if.  
</I>&gt;<i> I.e., it defines PROVIDERNAME_PROBENAME() and  
</I>&gt;<i> PROVIDERNAME_PROBENAME_ENABLED() as no-op macros for non-DTrace  
</I>&gt;<i> builds. In e.g. mini.c I then #include &lt;mono/utils/mono-dtrace.h&gt;  
</I>&gt;<i> and insert the probe as MONO_TEST ();. For this to compile, the  
</I>&gt;<i> header is needed on non-DTrace-aware platforms, so we'd need some  
</I>&gt;<i> version of the generated file in SVN but could overwrite it on  
</I>&gt;<i> platforms with dtrace available. Or we'd need either a manual header  
</I>&gt;<i> file as wrapper, sync'ed with the generated one, or our own guards  
</I>&gt;<i> added around each macro invocation.
</I>&gt;<i>
</I>&gt;<i> The general idea would be to have a new switch --enable-dtrace which  
</I>&gt;<i> defaults to &quot;no&quot; on all platforms. If enabled, this would check for  
</I>&gt;<i> the dtrace tool and set up some arch flags and an automake/C define.  
</I>&gt;<i> Then, initially, I'd suggest some simple probes for performance  
</I>&gt;<i> evaluation such as ves-init-begin, ves-init-end, gc-begin and gc- 
</I>&gt;<i> end. Does this sound reasonable?
</I>&gt;<i>
</I>&gt;<i> Compare: <A HREF="http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html">http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html</A>
</I>&gt;<i>
</I>&gt;<i> In addition to those static probes, Sun Java on Solaris also has the  
</I>&gt;<i> ability to generate providers and probes dynamically from Java code.  
</I>&gt;<i> I haven't looked into that yet but it might turn out highly platform- 
</I>&gt;<i> specific, and if we want to add such a thing, this too should depend  
</I>&gt;<i> on the suggested configure switch, to have it disabled by default.
</I>&gt;<i>
</I>&gt;<i> Andreas_______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027997.html">[Mono-dev] Mono dtrace provider?
</A></li>
	<LI>Next message: <A HREF="028032.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28025">[ date ]</a>
              <a href="thread.html#28025">[ thread ]</a>
              <a href="subject.html#28025">[ subject ]</a>
              <a href="author.html#28025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
