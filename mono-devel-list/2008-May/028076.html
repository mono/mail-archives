<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev]  [PATCH] Mono DTrace provider v2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20%5BPATCH%5D%20Mono%20DTrace%20provider%20v2&In-Reply-To=D5A070BE-1B78-458B-8415-62922A9CE6BB%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028057.html">
   <LINK REL="Next"  HREF="027998.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev]  [PATCH] Mono DTrace provider v2</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%20%5BPATCH%5D%20Mono%20DTrace%20provider%20v2&In-Reply-To=D5A070BE-1B78-458B-8415-62922A9CE6BB%40web.de"
       TITLE="[Mono-dev]  [PATCH] Mono DTrace provider v2">andreas.faerber at web.de
       </A><BR>
    <I>Fri May 30 18:09:03 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028057.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
        <LI>Next message: <A HREF="027998.html">[Mono-dev] revert of r104029/30/31
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28076">[ date ]</a>
              <a href="thread.html#28076">[ thread ]</a>
              <a href="subject.html#28076">[ subject ]</a>
              <a href="author.html#28076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Here's an updated version of my patch, adding initial DTrace support  
to the Mono runtime.

A new hand-crafted header file has been added, which is to be included  
in place of the generated header file. It defines MONO_PROBE_* macros  
as requested by Zoltan. The generated header file is then only needed  
iff DTrace is enabled.

Ugly build steps for Solaris were moved to a shell script. It extracts  
object files from their library to a temporary directory, patches them  
and puts them back in. This helps keep Makefiles clean and provides a  
one-stop resource to fix things, should they break. Tested on  
OpenSolaris 2008.05 i86. (Warning: I am not experienced in writing  
shell scripts.)

It appears the problem with the gc-end probe on Solaris was due to  
some kind of compiler optimization or the like. Adding a trailing  
sleep(0) call made it work; I have limited this workaround to when the  
gc-end probe is enabled on Solaris, to minimize the impact. Better  
ideas welcome. If we do stick with it and it turns out this is needed  
in more void functions, we could consider turning this into a  
MONO_PROBE_* macro to keep source files clean.

Signed-off-by: Andreas Faerber &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt;

Change Log v2:

* dtrace-prelink.sh.in: New
   Script to prevent ugly Solaris hacks in Makefiles.

* configure.in:
   Prepare support for OSX/x86_64 (untested)
   Output dtrace-prelink.sh script.

* data/mono.d: Renamed (from mono-trace.d)
   Added standard Mono header.
   Added generation argument to gc-{begin,end} probes.
   Added explicit stability attributes.

* mono/utils/dtrace.h: New
   Wrapper around generated mono/utils/mono-dtrace.h.
   Define MONO_PROBE_* macros.

* mono/utils/Makefile.am:
   We no longer need to postprocess the generated header file.

* mono/metadata/Makefile.am,
   mono/mini/Makefile.am:
   Use new dtrace-prelink.sh script.

* mono/mini/mini.c,
   mono/metadata/boehm-gc.c:
   Use new macros

* mono/metadata/boehm-gc.c:
   Add workaround to make gc-end probe work on Solaris.

Andreas
-------------- next part --------------
A non-text attachment was scrubbed...
Name: DTrace-USDT-2.diff
Type: application/octet-stream
Size: 11079 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080531/9ebb2468/attachment.obj">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080531/9ebb2468/attachment.obj</A> 
-------------- next part --------------



</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028057.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
	<LI>Next message: <A HREF="027998.html">[Mono-dev] revert of r104029/30/31
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28076">[ date ]</a>
              <a href="thread.html#28076">[ thread ]</a>
              <a href="subject.html#28076">[ subject ]</a>
              <a href="author.html#28076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
