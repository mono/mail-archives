<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Mono DTrace provider
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=295e750a0805280632g35fa2001t731608df02bf2423%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028044.html">
   <LINK REL="Next"  HREF="028048.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Mono DTrace provider</H1>
    <B>Andreas F&#228;rber</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=295e750a0805280632g35fa2001t731608df02bf2423%40mail.gmail.com"
       TITLE="[Mono-dev] [PATCH] Mono DTrace provider">andreas.faerber at web.de
       </A><BR>
    <I>Wed May 28 10:44:32 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028044.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
        <LI>Next message: <A HREF="028048.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28045">[ date ]</a>
              <a href="thread.html#28045">[ thread ]</a>
              <a href="subject.html#28045">[ subject ]</a>
              <a href="author.html#28045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Zoltan,

Thanks for the comments,

Am 28.05.2008 um 15:32 schrieb Zoltan Varga:

&gt;<i> - I would prefer naming the probe macros something like  
</I>&gt;<i> MONO_PROBE_..., since
</I>&gt;<i>  MONO_GC_BEGIN () doesn't really explain their purpose.
</I>
The PROVIDERNAME_PROBENAME[_ENABLED] scheme cannot be changed. But we  
could add a custom wrapper header, doing something like

/* mono/utils/dtrace.h */
#ifdef DTRACE_ENABLED
#include &lt;mono/utils/mono-dtrace.h&gt; /* the dtrace-generated header */
#define MONO_PROBE_GC_BEGIN(generation) MONO_GC_BEGIN(generation)
#else
#define MONO_PROBE_GC_BEGIN(generation)
#endif

effectively allowing us to use MONO_PROBE_... in Mono's code. As a  
side effect, this would also avoid the need to commit some version of  
the generated header to SVN for non-DTrace platforms.


&gt;<i> - The makefile changes look a bit ugly. Isn't there a more sane way of
</I>&gt;<i> doing them
</I>&gt;<i>  (by instrumenting the .o files after they are generated, for  
</I>&gt;<i> example) ?
</I>
I fully agree. Not sure what you mean by instrumenting them. I see two  
way of improvements:

a) Provide a shell script, as suggested in my response to Miguel, say  
dtrace-prelink.sh, which accepts as command line arguments the  
output .o file name and the input .d and .la or .lo files. This would  
hide the logic in a central place, avoiding to duplicate it in lots of  
Makefile.am files (as seen with pedump). The tool should then extract  
the .a libraries to a temporary directory, like libtool does, provide  
all object files as input to dtrace -G, whether they use probes or  
not, and update the .a archives with them.

b) Try to extend libtool to handle this step itself, reusing its  
helper functions and variables. This would theoretically be best, but  
I do not know if doable.
Also, I noticed you added support for some libtool alternative, right?  
Could you please shed some light on that in terms of where that is  
being used or what it's intended for?

&gt;<i> - why is the PEDUMP_DTRACE stuff needed at all ? Why would anyone  
</I>&gt;<i> want to
</I>&gt;<i>   instrument pedump ?
</I>
As mentioned in my other mail, this is necessary (on Solaris) to avoid  
link failure, even if not instrumented at all:

libruntime[-static].la is being linked into pedump. libruntime[- 
static].la contains boehm-gc.o and thus a probe. Therefore boehm-gc.o  
must be postprocessed specifically for pedump and the modified as well  
as the generated object file linked into pedump.

In practice, with only the gc-begin probe compiled in on Solaris  
currently, this means that executing &quot;mono/metadata/pedump&quot; with  
dtrace finds one probe in it. I haven't checked whether it gets  
strip'ed out during install, but I doubt pedump actually uses the GC.

Unfortunately, the object files don't get recompiled for each  
executable, so we can't use #ifdef to disable probes for pedump builds  
to avoid this step. If you see another way to avoid this, please say  
so. I tried to keep the patch least intrusive as possible, so I did  
not look into splitting up libruntime or the like.

Andreas

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028044.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
	<LI>Next message: <A HREF="028048.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28045">[ date ]</a>
              <a href="thread.html#28045">[ thread ]</a>
              <a href="subject.html#28045">[ subject ]</a>
              <a href="author.html#28045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
