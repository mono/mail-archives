<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Mono DTrace provider
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=F23362C8-DD41-4816-B6A4-73798B3EA2E6%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028025.html">
   <LINK REL="Next"  HREF="028034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Mono DTrace provider</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=F23362C8-DD41-4816-B6A4-73798B3EA2E6%40web.de"
       TITLE="[Mono-dev] [PATCH] Mono DTrace provider">miguel at novell.com
       </A><BR>
    <I>Tue May 27 11:24:30 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028025.html">[Mono-dev]  [PATCH] Mono DTrace provider
</A></li>
        <LI>Next message: <A HREF="028034.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28032">[ date ]</a>
              <a href="thread.html#28032">[ thread ]</a>
              <a href="subject.html#28032">[ subject ]</a>
              <a href="author.html#28032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

    I do not have an opinion on the actual changes to the code, that
should be discussed by someone else, but I believe that we should
auto-detect whether dtrace is installed instead of forcing people to
manually enable it on platforms that support it.

Miguel.

On Tue, 2008-05-27 at 00:45 +0200, Andreas F&#228;rber wrote:
&gt;<i> Here's a patch for adding DTrace USDT support to the Mono runtime.
</I>&gt;<i> 
</I>&gt;<i> It introduces a configure switch --enable-dtrace to turn on DTrace  
</I>&gt;<i> support. If configured with --enable-dtrace, Mono uses dtrace to  
</I>&gt;<i> generate a header in mono/utils/, and only if on Solaris, Makefile  
</I>&gt;<i> rules for postprocessing the object files are triggered. Four probes  
</I>&gt;<i> are introduced, requiring postprocessing steps for mono, libmono and  
</I>&gt;<i> pedump on Solaris. The MONO_GC_END() macro for the gc-end probe causes  
</I>&gt;<i> the postprocessing to fail on Solaris, so I've limited it to OSX for  
</I>&gt;<i> now.
</I>&gt;<i> 
</I>&gt;<i> This patch was tested on OSX ppc and i386 and on Solaris i86. It does  
</I>&gt;<i> not yet support OSX x86_64 because I do not have such a machine around  
</I>&gt;<i> to check the $host string (is it i*86-*-darwin* or something x64- 
</I>&gt;<i> specific?), and for inclusion in SVN it would additionally need a copy  
</I>&gt;<i> of the generated header file (such as attached) for systems without  
</I>&gt;<i> DTrace or with DTrace disabled.
</I>&gt;<i> 
</I>&gt;<i> Comments and suggestions welcome.
</I>&gt;<i> 
</I>&gt;<i> Andreas
</I>&gt;<i> Am 25.05.2008 um 22:59 schrieb Andreas F&#228;rber:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've revisited the idea of a DTrace provider for Mono and managed to  
</I>&gt;<i> &gt; get it working on OpenSolaris 2008.05 (dtrace 1.6) and Mac OS X  
</I>&gt;<i> &gt; v10.5 (dtrace 1.2.2).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On OSX, all that is required is the C header file generated by  
</I>&gt;<i> &gt; `dtrace -h`.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Weird hacks around libtool are only necessary on (Open)Solaris. The  
</I>&gt;<i> &gt; problem with my previous attempt was that `dtrace -G` not only needs  
</I>&gt;<i> &gt; read access to the object files but also modifies them! When  
</I>&gt;<i> &gt; updating libmono-static.a via `ar r` after `drace -G`, everything is  
</I>&gt;<i> &gt; fine and I finally see my test probe!
</I>&gt;<i> &gt; The problem with this approach still is that it's a hack, because  
</I>&gt;<i> &gt; the location of the .a file and of the .o files is at the discretion  
</I>&gt;<i> &gt; of libtool and thus not very portable. But since it appears to be  
</I>&gt;<i> &gt; limited to Solaris, we could limit such questionable build steps to  
</I>&gt;<i> &gt; that platform and an explicit configuration option.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Attached is my diff, with Solaris stuff disabled. Also attached is  
</I>&gt;<i> &gt; the header generated on OSX and OpenSolaris.
</I>&gt;<i> &gt; Note that in mono-dtrace.nv.h the #if _DTRACE_VERSION should be  
</I>&gt;<i> &gt; replaced with something more sensible via regex (to avoid my  
</I>&gt;<i> &gt; workaround in mini.c), same for #include &lt;unistd.h&gt; which I believe  
</I>&gt;<i> &gt; hearing was not portable for Windows.
</I>&gt;<i> &gt; &lt;dtrace-hack3.diff&gt;&lt;mono-dtrace.osx.h&gt;&lt;mono-dtrace.nv.h&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Am 13.01.2008 um 19:12 schrieb Miguel de Icaza:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I thought data/ would be an obvious choice for the .d file, and  
</I>&gt;<i> &gt;&gt;&gt; chose
</I>&gt;<i> &gt;&gt;&gt; mono/utils for the generated header and object file but the object
</I>&gt;<i> &gt;&gt;&gt; file seems to depend on all object files with the probes, here  
</I>&gt;<i> &gt;&gt;&gt; mini.o
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Hand written information can go into the data directory;   Source  
</I>&gt;<i> &gt;&gt; code
</I>&gt;<i> &gt;&gt; generated by a tool should be generated at compile time.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The issue with that approach is the use-case of the generated  
</I>&gt;<i> &gt; header: The Solaris version thereof (dtrace 1.5+?) defines  
</I>&gt;<i> &gt; convenience macros for use in the source code, guarded by an #if.  
</I>&gt;<i> &gt; I.e., it defines PROVIDERNAME_PROBENAME() and  
</I>&gt;<i> &gt; PROVIDERNAME_PROBENAME_ENABLED() as no-op macros for non-DTrace  
</I>&gt;<i> &gt; builds. In e.g. mini.c I then #include &lt;mono/utils/mono-dtrace.h&gt;  
</I>&gt;<i> &gt; and insert the probe as MONO_TEST ();. For this to compile, the  
</I>&gt;<i> &gt; header is needed on non-DTrace-aware platforms, so we'd need some  
</I>&gt;<i> &gt; version of the generated file in SVN but could overwrite it on  
</I>&gt;<i> &gt; platforms with dtrace available. Or we'd need either a manual header  
</I>&gt;<i> &gt; file as wrapper, sync'ed with the generated one, or our own guards  
</I>&gt;<i> &gt; added around each macro invocation.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The general idea would be to have a new switch --enable-dtrace which  
</I>&gt;<i> &gt; defaults to &quot;no&quot; on all platforms. If enabled, this would check for  
</I>&gt;<i> &gt; the dtrace tool and set up some arch flags and an automake/C define.  
</I>&gt;<i> &gt; Then, initially, I'd suggest some simple probes for performance  
</I>&gt;<i> &gt; evaluation such as ves-init-begin, ves-init-end, gc-begin and gc- 
</I>&gt;<i> &gt; end. Does this sound reasonable?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Compare: <A HREF="http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html">http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In addition to those static probes, Sun Java on Solaris also has the  
</I>&gt;<i> &gt; ability to generate providers and probes dynamically from Java code.  
</I>&gt;<i> &gt; I haven't looked into that yet but it might turn out highly platform- 
</I>&gt;<i> &gt; specific, and if we want to add such a thing, this too should depend  
</I>&gt;<i> &gt; on the suggested configure switch, to have it disabled by default.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Andreas_______________________________________________
</I>&gt;<i> &gt; Mono-devel-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I></PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028025.html">[Mono-dev]  [PATCH] Mono DTrace provider
</A></li>
	<LI>Next message: <A HREF="028034.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28032">[ date ]</a>
              <a href="thread.html#28032">[ thread ]</a>
              <a href="subject.html#28032">[ subject ]</a>
              <a href="author.html#28032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
