<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Mono DTrace provider
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=F23362C8-DD41-4816-B6A4-73798B3EA2E6%40web.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028037.html">
   <LINK REL="Next"  HREF="028045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Mono DTrace provider</H1>
    <B>Zoltan Varga</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Mono%20DTrace%20provider&In-Reply-To=F23362C8-DD41-4816-B6A4-73798B3EA2E6%40web.de"
       TITLE="[Mono-dev] [PATCH] Mono DTrace provider">vargaz at gmail.com
       </A><BR>
    <I>Wed May 28 09:32:04 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="028037.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
        <LI>Next message: <A HREF="028045.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28044">[ date ]</a>
              <a href="thread.html#28044">[ thread ]</a>
              <a href="subject.html#28044">[ subject ]</a>
              <a href="author.html#28044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Some comments about the patch:
- I would vote for the --enable style instead of the --disable style,
cause enabling
  things by default is known to break builds on some environments. If
things look ok,
  we can enable it later.
- I would prefer naming the probe macros something like MONO_PROBE_..., since
  MONO_GC_BEGIN () doesn't really explain their purpose.
- The makefile changes look a bit ugly. Isn't there a more sane way of
doing them
  (by instrumenting the .o files after they are generated, for example) ?
 - why is the PEDUMP_DTRACE stuff needed at all ? Why would anyone want to
   instrument pedump ?

                        Zoltan

2008/5/27 Andreas F&#228;rber &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">andreas.faerber at web.de</A>&gt;:
&gt;<i> Here's a patch for adding DTrace USDT support to the Mono runtime.
</I>&gt;<i>
</I>&gt;<i> It introduces a configure switch --enable-dtrace to turn on DTrace support.
</I>&gt;<i> If configured with --enable-dtrace, Mono uses dtrace to generate a header in
</I>&gt;<i> mono/utils/, and only if on Solaris, Makefile rules for postprocessing the
</I>&gt;<i> object files are triggered. Four probes are introduced, requiring
</I>&gt;<i> postprocessing steps for mono, libmono and pedump on Solaris. The
</I>&gt;<i> MONO_GC_END() macro for the gc-end probe causes the postprocessing to fail
</I>&gt;<i> on Solaris, so I've limited it to OSX for now.
</I>&gt;<i>
</I>&gt;<i> This patch was tested on OSX ppc and i386 and on Solaris i86. It does not
</I>&gt;<i> yet support OSX x86_64 because I do not have such a machine around to check
</I>&gt;<i> the $host string (is it i*86-*-darwin* or something x64-specific?), and for
</I>&gt;<i> inclusion in SVN it would additionally need a copy of the generated header
</I>&gt;<i> file (such as attached) for systems without DTrace or with DTrace disabled.
</I>&gt;<i>
</I>&gt;<i> Comments and suggestions welcome.
</I>&gt;<i>
</I>&gt;<i> Andreas
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Am 25.05.2008 um 22:59 schrieb Andreas F&#228;rber:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've revisited the idea of a DTrace provider for Mono and managed to get
</I>&gt;&gt;<i> it working on OpenSolaris 2008.05 (dtrace 1.6) and Mac OS X v10.5 (dtrace
</I>&gt;&gt;<i> 1.2.2).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On OSX, all that is required is the C header file generated by `dtrace
</I>&gt;&gt;<i> -h`.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Weird hacks around libtool are only necessary on (Open)Solaris. The
</I>&gt;&gt;<i> problem with my previous attempt was that `dtrace -G` not only needs read
</I>&gt;&gt;<i> access to the object files but also modifies them! When updating
</I>&gt;&gt;<i> libmono-static.a via `ar r` after `drace -G`, everything is fine and I
</I>&gt;&gt;<i> finally see my test probe!
</I>&gt;&gt;<i> The problem with this approach still is that it's a hack, because the
</I>&gt;&gt;<i> location of the .a file and of the .o files is at the discretion of libtool
</I>&gt;&gt;<i> and thus not very portable. But since it appears to be limited to Solaris,
</I>&gt;&gt;<i> we could limit such questionable build steps to that platform and an
</I>&gt;&gt;<i> explicit configuration option.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Attached is my diff, with Solaris stuff disabled. Also attached is the
</I>&gt;&gt;<i> header generated on OSX and OpenSolaris.
</I>&gt;&gt;<i> Note that in mono-dtrace.nv.h the #if _DTRACE_VERSION should be replaced
</I>&gt;&gt;<i> with something more sensible via regex (to avoid my workaround in mini.c),
</I>&gt;&gt;<i> same for #include &lt;unistd.h&gt; which I believe hearing was not portable for
</I>&gt;&gt;<i> Windows.
</I>&gt;&gt;<i> &lt;dtrace-hack3.diff&gt;&lt;mono-dtrace.osx.h&gt;&lt;mono-dtrace.nv.h&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Am 13.01.2008 um 19:12 schrieb Miguel de Icaza:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I thought data/ would be an obvious choice for the .d file, and chose
</I>&gt;&gt;&gt;&gt;<i> mono/utils for the generated header and object file but the object
</I>&gt;&gt;&gt;&gt;<i> file seems to depend on all object files with the probes, here mini.o
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hand written information can go into the data directory;   Source code
</I>&gt;&gt;&gt;<i> generated by a tool should be generated at compile time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The issue with that approach is the use-case of the generated header: The
</I>&gt;&gt;<i> Solaris version thereof (dtrace 1.5+?) defines convenience macros for use in
</I>&gt;&gt;<i> the source code, guarded by an #if. I.e., it defines
</I>&gt;&gt;<i> PROVIDERNAME_PROBENAME() and PROVIDERNAME_PROBENAME_ENABLED() as no-op
</I>&gt;&gt;<i> macros for non-DTrace builds. In e.g. mini.c I then #include
</I>&gt;&gt;<i> &lt;mono/utils/mono-dtrace.h&gt; and insert the probe as MONO_TEST ();. For this
</I>&gt;&gt;<i> to compile, the header is needed on non-DTrace-aware platforms, so we'd need
</I>&gt;&gt;<i> some version of the generated file in SVN but could overwrite it on
</I>&gt;&gt;<i> platforms with dtrace available. Or we'd need either a manual header file as
</I>&gt;&gt;<i> wrapper, sync'ed with the generated one, or our own guards added around each
</I>&gt;&gt;<i> macro invocation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The general idea would be to have a new switch --enable-dtrace which
</I>&gt;&gt;<i> defaults to &quot;no&quot; on all platforms. If enabled, this would check for the
</I>&gt;&gt;<i> dtrace tool and set up some arch flags and an automake/C define. Then,
</I>&gt;&gt;<i> initially, I'd suggest some simple probes for performance evaluation such as
</I>&gt;&gt;<i> ves-init-begin, ves-init-end, gc-begin and gc-end. Does this sound
</I>&gt;&gt;<i> reasonable?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Compare: <A HREF="http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html">http://java.sun.com/javase/6/docs/technotes/guides/vm/dtrace.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In addition to those static probes, Sun Java on Solaris also has the
</I>&gt;&gt;<i> ability to generate providers and probes dynamically from Java code. I
</I>&gt;&gt;<i> haven't looked into that yet but it might turn out highly platform-specific,
</I>&gt;&gt;<i> and if we want to add such a thing, this too should depend on the suggested
</I>&gt;&gt;<i> configure switch, to have it disabled by default.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Andreas_______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-devel-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I></PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028037.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
	<LI>Next message: <A HREF="028045.html">[Mono-dev] [PATCH] Mono DTrace provider
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28044">[ date ]</a>
              <a href="thread.html#28044">[ thread ]</a>
              <a href="subject.html#28044">[ subject ]</a>
              <a href="author.html#28044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
