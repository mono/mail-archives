<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] [PATCH] Managed code abort trampoline
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Managed%20code%20abort%20trampoline&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027970.html">
   <LINK REL="Next"  HREF="027985.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] [PATCH] Managed code abort trampoline</H1>
    <B>Rodrigo Kumpera</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20%5BPATCH%5D%20Managed%20code%20abort%20trampoline&In-Reply-To="
       TITLE="[Mono-dev] [PATCH] Managed code abort trampoline">kumpera at gmail.com
       </A><BR>
    <I>Tue May 20 17:16:49 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027970.html">[Mono-dev] System.Core patch
</A></li>
        <LI>Next message: <A HREF="027985.html">[Mono-dev] [PATCH] Managed code abort trampoline
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27973">[ date ]</a>
              <a href="thread.html#27973">[ thread ]</a>
              <a href="subject.html#27973">[ subject ]</a>
              <a href="author.html#27973">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

The attached patch implements managed code thread abort by installing a
trampoline on signal return.

This patch introduces two new arch specific functions, that I'll port to arm
and amd64 once the current patch
is committed:

void mono_arch_set_ip_in_context (void *sigctx, void *new_ip) MONO_INTERNAL;
gpointer mono_arch_get_call_interrupt_trampoline (gpointer
process_interrup_function) MONO_INTERNAL;

The first one is used to hijack the managed code execution and call the
trampoline.
The second one fix the callstack, build a MonoContext and call
process_interrup_function. The trampoline
must allow to resume execution of the managed method as it could be inside a
protected wrapper.

I've moved this check out of the signal handler to reduce the amount of
signal safe code we need, which
improves reliability and gives us more freedom on the implementation.

This patch doesn't tackle mono_thread_request_interruption yet. The plan is
to split it into three parts:

-Managed code interrupt, called from the abort trampoline
-Alertable-wait wake up, called as part of Thread::Abort
-Unmanaged code interrupt, called from the signal handler - this should end
been just incrementing thread_interruption_requested.

This doesn't handle the windows situation, which is something I'll do next.

Thanks,
Rodrigo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080520/bf10c239/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080520/bf10c239/attachment.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: managed_code_thread_abort.diff
Type: text/x-patch
Size: 5142 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080520/bf10c239/attachment.bin">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20080520/bf10c239/attachment.bin</A> 
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027970.html">[Mono-dev] System.Core patch
</A></li>
	<LI>Next message: <A HREF="027985.html">[Mono-dev] [PATCH] Managed code abort trampoline
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27973">[ date ]</a>
              <a href="thread.html#27973">[ thread ]</a>
              <a href="subject.html#27973">[ subject ]</a>
              <a href="author.html#27973">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
