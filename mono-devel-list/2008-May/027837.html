<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] Trivial Enumerable Optimizations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Trivial%20Enumerable%20Optimizations&In-Reply-To=1210275377.24633.34.camel%40lina.magi.balthasar.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027831.html">
   <LINK REL="Next"  HREF="027840.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] Trivial Enumerable Optimizations</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=%5BMono-dev%5D%20Trivial%20Enumerable%20Optimizations&In-Reply-To=1210275377.24633.34.camel%40lina.magi.balthasar.com"
       TITLE="[Mono-dev] Trivial Enumerable Optimizations">jonpryor at vt.edu
       </A><BR>
    <I>Fri May  9 08:14:09 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="027831.html">[Mono-dev] Trivial Enumerable Optimizations
</A></li>
        <LI>Next message: <A HREF="027840.html">[Mono-dev] Trivial Enumerable Optimizations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27837">[ date ]</a>
              <a href="thread.html#27837">[ thread ]</a>
              <a href="subject.html#27837">[ subject ]</a>
              <a href="author.html#27837">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2008-05-08 at 15:36 -0400, Jonathan Pryor wrote:
&gt;<i> System.Core.Enumerable already has a set of &quot;obvious&quot; optimizations in
</I>&gt;<i> which the IEnumerable&lt;T&gt; argument is checked to see if it's another
</I>&gt;<i> interface and the implementation is &quot;switched&quot; based on the runtime
</I>&gt;<i> type, e.g.
</I>
A related optimization for LongCount() occurred to me as well, so first
a question: is it safe to assume that if ICollection&lt;T&gt; is implemented
that ICollection&lt;T&gt;.Count will be valid?

In short, does implementing ICollection&lt;T&gt; guarantee that the collection
is limited to int.MaxValue elements?

Obviously not: arrays implement ICollection&lt;T&gt;, yet may support elements
with more than int.MaxValue elements.  (Except no one (until now) has
actually supported arrays with &gt; int.MaxValue elements, so perhaps this
isn't quite so obvious.)

So what are the semantics for ICollection&lt;T&gt;.Count when the collection
contains more elements than int.MaxValue?  MSDN doesn't say.  MSDN
doesn't even state that ICollection&lt;T&gt;.Count should be &gt;= 0, for that
matter:

    <A HREF="http://msdn.microsoft.com/en-us/library/5s3kzhec.aspx">http://msdn.microsoft.com/en-us/library/5s3kzhec.aspx</A>

So is it possible to further optimize the LongCount() extension method?
Perhaps something like this?

    public static long LongCount&lt;TSource&gt; (this IEnumerable&lt;TSource&gt; source)
    {
       // as before...
       ICollection&lt;TSource&gt; c = source as ICollection&lt;TSource&gt;;
       if (c != null) {
           try {
               return c.Count;
           }
           catch {
               // ignore; collection has &gt; int.MaxValue elements, 
               // so count manually below.
           }
       }
       // as before...
    }

This will suffer an obvious performance penalty if the collection has
over int.MaxValue elements (assuming .Count throws an exception when
that happens), but as most (currently all?) collections will have less
than int.MaxValue elements, this should be a performance win.

Thoughts?

 - Jon


</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027831.html">[Mono-dev] Trivial Enumerable Optimizations
</A></li>
	<LI>Next message: <A HREF="027840.html">[Mono-dev] Trivial Enumerable Optimizations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27837">[ date ]</a>
              <a href="thread.html#27837">[ thread ]</a>
              <a href="subject.html#27837">[ subject ]</a>
              <a href="author.html#27837">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
