<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] GIT code generator fails on some MSVC managed code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20GIT%20code%20generator%20fails%20on%20some%20MSVC%20managed%20code&In-Reply-To=%3C56C2E7E1.9020407%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043527.html">
   <LINK REL="Next"  HREF="043529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] GIT code generator fails on some MSVC managed code</H1>
    <B>Paul Gofman</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20GIT%20code%20generator%20fails%20on%20some%20MSVC%20managed%20code&In-Reply-To=%3C56C2E7E1.9020407%40gmail.com%3E"
       TITLE="[Mono-dev] GIT code generator fails on some MSVC managed code">gofmanp at gmail.com
       </A><BR>
    <I>Tue Feb 16 09:12:01 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="043527.html">[Mono-dev] unsubscribe
</A></li>
        <LI>Next message: <A HREF="043529.html">[Mono-dev] Improving Auto-Detection System of Mono Develop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43528">[ date ]</a>
              <a href="thread.html#43528">[ thread ]</a>
              <a href="subject.html#43528">[ subject ]</a>
              <a href="author.html#43528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

    while running x64 mixed mode assemblies under Wine/Mono I came
through the problem that MSVC generated mixed IL code causes 'Invalid IL
code' exception under Mono. The same dll compiled in 32-bit does not
have such a problem. I've created a quick fix patch to
mono/mini/method-to-ir.c which fixes the issue for me and a bug which
now has a IL assembly test case and my patch (along with the initial
MSVC example &amp; description of the problem):
<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=37913">https://bugzilla.xamarin.com/show_bug.cgi?id=37913</A>
    The last IL test case causes crash on native win32 and works under
win64.
   
    To summarize, what happens (as I see it): Windows allows much of
things mixing I8/PTR/I4 to pass compilation (for both 32/64), some of
them get native GPF under Win32. Mono is fully checking assemblies and
does not allow certain things to pass verifier (though if I do allow
I8/PTR mixing in verifier on x64 it works).

    I realize that the patch is probably not an upstream candidate in
its current form.
    The overall idea of arch-dependent assembly checks is probably not
so OK for Mono as assembly code is meant to be arch independent. Windows
might be following this principle but instead has less restrictive
checking allowing the compiled assembly natively crash when needed (and
managed code generator produces a different code for different arch). So
straightforward way to maintain compatibility with real MSVC managed
code under x64 is just allow such code to pass verifier.

    Maybe someone could push me in the right direction how this
compatibility issue can be correctly fixed in Mono? I could possibly
then make an appropriate patch and suggest it upstream.

Thanks,
    Paul.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160216/14fcddd8/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160216/14fcddd8/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043527.html">[Mono-dev] unsubscribe
</A></li>
	<LI>Next message: <A HREF="043529.html">[Mono-dev] Improving Auto-Detection System of Mono Develop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43528">[ date ]</a>
              <a href="thread.html#43528">[ thread ]</a>
              <a href="subject.html#43528">[ subject ]</a>
              <a href="author.html#43528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
