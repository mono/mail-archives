<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-dev] WebRequest timeouts after ThreadPool exhaustion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WebRequest%20timeouts%20after%20ThreadPool%20exhaustion&In-Reply-To=%3CCAGu5pZeR1zWowhWVMrrwkHjRP%3D2Mug6Tf21uaebihOw3XZUMhA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043514.html">
   <LINK REL="Next"  HREF="043516.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-dev] WebRequest timeouts after ThreadPool exhaustion</H1>
    <B>Alan</B> 
    <A HREF="mailto:mono-devel-list%40lists.ximian.com?Subject=Re%3A%20%5BMono-dev%5D%20WebRequest%20timeouts%20after%20ThreadPool%20exhaustion&In-Reply-To=%3CCAGu5pZeR1zWowhWVMrrwkHjRP%3D2Mug6Tf21uaebihOw3XZUMhA%40mail.gmail.com%3E"
       TITLE="[Mono-dev] WebRequest timeouts after ThreadPool exhaustion">alan.mcgovern at gmail.com
       </A><BR>
    <I>Fri Feb 12 13:50:53 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="043514.html">[Mono-dev] WebRequest timeouts after ThreadPool exhaustion
</A></li>
        <LI>Next message: <A HREF="043516.html">[Mono-dev] WebRequest timeouts after ThreadPool exhaustion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43515">[ date ]</a>
              <a href="thread.html#43515">[ thread ]</a>
              <a href="subject.html#43515">[ subject ]</a>
              <a href="author.html#43515">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It's also worth pointing out that the threadpool implementation has changed
completely since mono 4.0. I believe the new threadpool implementation
shipped as the default starting with mono 4.2 (or thereabouts). If you're
on older Monos the odds are high whatever issue you have has been fixed
already.

Alan

On 12 February 2016 at 13:48, Alan &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">alan.mcgovern at gmail.com</A>&gt; wrote:

&gt;<i> Hey,
</I>&gt;<i>
</I>&gt;<i> We have just fixed some issues in that area. They are expected to ship as
</I>&gt;<i> part of a the next mono 4.3+ release. If you want to test them out in the
</I>&gt;<i> meantime you could try building mono with this PR [0] and see if it
</I>&gt;<i> resolves all your issues. If it doesn't then a testcase and bug report on
</I>&gt;<i> <A HREF="http://bugzilla.xamarin.com">http://bugzilla.xamarin.com</A> would be awesome!
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i> [0] <A HREF="https://github.com/mono/mono/pull/2576">https://github.com/mono/mono/pull/2576</A>
</I>&gt;<i>
</I>&gt;<i> On 12 February 2016 at 12:33, Mike Horsley &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mhorsley at vqcomms.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> we&#8217;ve also seen instances of webrequest timeouts that don&#8217;t recover (but
</I>&gt;&gt;<i> curl worked) as well but haven&#8217;t got to the bottom of it yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> we ran your test app and see the same issue with mono 3.12 on OpenSUSE
</I>&gt;&gt;<i> 13.2 (kernel 3.16.7, libc 2.19).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> we&#8217;ll add the diagnostics from your test app into ours and this will tell
</I>&gt;&gt;<i> us whether we are seeing the same issue with the threadpool.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> regards
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Mike
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *From:* <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A> [mailto:
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list-bounces at lists.ximian.com</A>] *On Behalf Of *Seif Attar
</I>&gt;&gt;<i> *Sent:* Friday, February 12, 2016 10:43 AM
</I>&gt;&gt;<i> *To:* <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> *Subject:* [Mono-dev] WebRequest timeouts after ThreadPool exhaustion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We are running mono 4.2.2 in prod and the VM that the process was running
</I>&gt;&gt;<i> on had SAN failure and after storage recovered, all outgoing requests were
</I>&gt;&gt;<i> timing out, even though doing a curl was working fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Theory was that thread pool starved and somehow things didn't recover
</I>&gt;&gt;<i> properly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Managed to reproduce with:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://gist.githubusercontent.com/seif/ae2defbfa5afa26fa8f6/raw/bef351eded56c882658a4bad60fa4818ad32d629/timeout.cs">https://gist.githubusercontent.com/seif/ae2defbfa5afa26fa8f6/raw/bef351eded56c882658a4bad60fa4818ad32d629/timeout.cs</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Even after ThreadPool finishes the tasks and has available threads, it
</I>&gt;&gt;<i> never recovers and subsequent webrequests all timeout.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Running on mono 4.2.2, linux kernel 4.2.0-27 and libc 2.21.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Output from gdb is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (gdb) info threads
</I>&gt;&gt;<i>   Id   Target Id         Frame
</I>&gt;&gt;<i>   13   Thread 0x7fca903ff700 (LWP 27944) &quot;cli&quot; pthread_cond_wait@@GLIBC_2.3.2
</I>&gt;&gt;<i> () at ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_wait.S:185
</I>&gt;&gt;<i>   12   Thread 0x7fca90b34700 (LWP 27945) &quot;Finalizer&quot; 0x00007fca911d70c9
</I>&gt;&gt;<i> in futex_abstimed_wait (cancel=true, private=&lt;optimised out&gt;, abstime=0x0,
</I>&gt;&gt;<i> expected=0, futex=0x948ae0) at sem_waitcommon.c:42
</I>&gt;&gt;<i>   11   Thread 0x7fca8dfff700 (LWP 27946) &quot;Timer-Scheduler&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   10   Thread 0x7fca91ba1700 (LWP 27947) &quot;cli&quot; __clock_nanosleep
</I>&gt;&gt;<i> (clock_id=1, flags=1, req=0x7fca91ba0dc0, rem=0x7fca90f134aa
</I>&gt;&gt;<i> &lt;__clock_nanosleep+138&gt;) at ../sysdeps/unix/sysv/linux/clock_nanosleep.c:48
</I>&gt;&gt;<i>   9    Thread 0x7fca8ddfe700 (LWP 27948) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   8    Thread 0x7fca8dbfd700 (LWP 27949) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   7    Thread 0x7fca8d7fb700 (LWP 27951) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   6    Thread 0x7fca8d3f9700 (LWP 27953) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   5    Thread 0x7fca8d1f8700 (LWP 27954) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   4    Thread 0x7fca8cff7700 (LWP 27955) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   3    Thread 0x7fca8cdf6700 (LWP 27956) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i>   2    Thread 0x7fca8cbf5700 (LWP 27957) &quot;Threadpool work&quot;
</I>&gt;&gt;<i> pthread_cond_timedwait@@GLIBC_2.3.2 () at
</I>&gt;&gt;<i> ../sysdeps/unix/sysv/linux/x86_64/pthread_cond_timedwait.S:238
</I>&gt;&gt;<i> * 1    Thread 0x7fca91cf0780 (LWP 27942) &quot;cli&quot; 0x00007fca911d7e0d in read
</I>&gt;&gt;<i> () at ../sysdeps/unix/syscall-template.S:81
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Could not reproduce on mono 3.12, but it happens on 4.0.3 and 4.2.2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is this a known issue? any workarounds? Tried setting MONO_DNS=1 to use
</I>&gt;&gt;<i> the clr dns, but that didn't help.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Let me know if there is any more info I need to provide.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Seif
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-devel-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">Mono-devel-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-devel-list">http://lists.ximian.com/mailman/listinfo/mono-devel-list</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160212/cb25cc8b/attachment.html">http://lists.ximian.com/pipermail/mono-devel-list/attachments/20160212/cb25cc8b/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043514.html">[Mono-dev] WebRequest timeouts after ThreadPool exhaustion
</A></li>
	<LI>Next message: <A HREF="043516.html">[Mono-dev] WebRequest timeouts after ThreadPool exhaustion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43515">[ date ]</a>
              <a href="thread.html#43515">[ thread ]</a>
              <a href="subject.html#43515">[ subject ]</a>
              <a href="author.html#43515">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-devel-list">More information about the Mono-devel-list
mailing list</a><br>
</body></html>
