<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Tao-list] Update: Tao.Sdl on OSX! (sorta)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Update%3A%20Tao.Sdl%20on%20OSX%21%20%28sorta%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000042.html">
   <LINK REL="Next"  HREF="000047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Tao-list] Update: Tao.Sdl on OSX! (sorta)</H1>
    <B>Nolan J. Darilek</B> 
    <A HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Update%3A%20Tao.Sdl%20on%20OSX%21%20%28sorta%29&In-Reply-To="
       TITLE="[Tao-list] Update: Tao.Sdl on OSX! (sorta)">nolan at thewordnerd.info
       </A><BR>
    <I>Mon Jun 13 18:55:45 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000042.html">[Tao-list] Help with patches: Cross-platform Tao.OpenAl and Tao.Sdl
 for OS X
</A></li>
        <LI>Next message: <A HREF="000047.html">[Tao-list] Using  glActiveTexture or glActiveTextureARB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, think I may have gotten it working. It opens a window, but I
haven't tested it much beyond that. Furthermore, SDL_Init handles
Cocoa initialization automatically via reflection, so you shouldn't
need to link in any additional resources or treat your code
differently.

I opted for the Cocoa# approach illustrated on the mono-osx list a few days
ago because the objc approach looked deceptively simple, and it
wasn't. There was much more involved than simply creating a pool, as was
learned by a simple glance at the sample SDL XCode projects. As a
result, you'll now need CocoaSharp to use Tao.Sdl on OSX.

Any fixes are welcome, though as was stated earlier, this is my first
serious delve into InterOp/Reflection, so I'm sure it's ugly, somewhat
broken and I'm still working to understand it. :)

Index: src/Tao.Sdl/Sdl.cs
===================================================================
--- src/Tao.Sdl/Sdl.cs	(revision 45839)
+++ src/Tao.Sdl/Sdl.cs	(working copy)
@@ -27,6 +27,7 @@
 
 using System;
 using System.Collections;
+using System.Reflection;
 using System.Runtime.InteropServices;
 using System.Security;
 
@@ -74,6 +75,13 @@
 		private const int BYTE_SIZE = 8;
 		#endregion Private Constants
 
+		#region Private Methods
+		// OS X magic.
+		[DllImport(&quot;/System/Library/Frameworks/Cocoa.framework/Cocoa&quot;, EntryPoint=&quot;NSApplicationLoad&quot;)]
+		private static extern void NSApplicationLoad();
+
+		#endregion Private Methods
+
 		#region Public Constants
 		#region SDL.h
 		#region SDL_INIT_TIMER
@@ -4790,6 +4798,13 @@
 		#endregion Public Structs
 
 		#region Private Static Fields
+		/// &lt;summary&gt;
+		///		Private pointers to NSAutoreleasePool class for Cocoa# on OS X.
+		/// &lt;/summary&gt;
+		/// &lt;remarks&gt;
+		///		Used for &lt;see cref=&quot;SDL_Init&quot;/&gt; and &lt;see cref=&quot;SDL_InitSubSystem&quot;/&gt;.
+		/// &lt;/remarks&gt;
+		private static object pool;
 
 		/// &lt;summary&gt;
 		///		Private byte array holding the internal keyboard state.
@@ -4899,6 +4914,14 @@
 		#region Sdl Methods
 		#region SDL.h
 		#region int SDL_Init(int flags)
+        /// &lt;summary&gt;
+        /// 
+        /// &lt;/summary&gt;
+        /// &lt;param name=&quot;body&quot;&gt;&lt;/param&gt;
+        /// &lt;returns&gt;&lt;/returns&gt;
+		[DllImport(SDL_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION, EntryPoint=&quot;SDL_Init&quot;), SuppressUnmanagedCodeSecurity]
+		private static extern int __SDL_Init(int flags);
+
 		/// &lt;summary&gt;
 		///     Initializes SDL and the specified subsystems.
 		/// &lt;/summary&gt;
@@ -4963,11 +4986,28 @@
 		/// &lt;/remarks&gt;
 		/// &lt;seealso cref=&quot;SDL_InitSubSystem&quot; /&gt;
 		/// &lt;seealso cref=&quot;SDL_Quit&quot; /&gt;
-		[DllImport(SDL_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
-		public static extern int SDL_Init(int flags);
+
+		public static int SDL_Init(int flags) {
+			Assembly af = Assembly.LoadWithPartialName(&quot;Apple.Foundation&quot;);
+			if (af != null) {
+				System.Type NSAutoreleasePool = af.GetType(&quot;NSAutoreleasePool&quot;);
+				pool = af.CreateInstance(&quot;Apple.Foundation.NSAutoreleasePool&quot;);
+				pool.GetType().GetMethod(&quot;init&quot;).Invoke(pool, null);
+				NSApplicationLoad();
+			}
+			return __SDL_Init(flags);
+		}
 		#endregion int SDL_Init(int flags)
+		#region int SDL_InitSubSystem(int flags)
+        /// &lt;summary&gt;
+        /// 
+        /// &lt;/summary&gt;
+        /// &lt;param name=&quot;body&quot;&gt;&lt;/param&gt;
+        /// &lt;returns&gt;&lt;/returns&gt;
 
-		#region int SDL_InitSubSystem(int flags)
+		[DllImport(SDL_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION, EntryPoint=&quot;SDL_InitSubSystem&quot;), SuppressUnmanagedCodeSecurity]
+		private static extern int __SDL_InitSubSystem(int flags);
+
 		/// &lt;summary&gt;
 		///     Initializes specified subsystems.
 		/// &lt;/summary&gt;
@@ -5031,8 +5071,16 @@
 		/// &lt;seealso cref=&quot;SDL_Quit&quot; /&gt;
 		/// &lt;seealso cref=&quot;SDL_QuitSubSystem&quot; /&gt;
 		/// 
-		[DllImport(SDL_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
-		public static extern int SDL_InitSubSystem(int flags);
+		public static int SDL_InitSubSystem(int flags) {
+			Assembly af = Assembly.LoadWithPartialName(&quot;Apple.Foundation&quot;);
+			if (af != null) {
+				System.Type NSAutoreleasePool = af.GetType(&quot;NSAutoreleasePool&quot;);
+				pool = af.CreateInstance(&quot;Apple.Foundation.NSAutoreleasePool&quot;);
+				pool.GetType().GetMethod(&quot;init&quot;).Invoke(pool, null);
+				NSApplicationLoad();
+			}
+			return __SDL_InitSubSystem(flags);
+		}
 		#endregion int SDL_InitSubSystem(int flags)
 
 		#region SDL_QuitSubSystem(int flags)
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000042.html">[Tao-list] Help with patches: Cross-platform Tao.OpenAl and Tao.Sdl
 for OS X
</A></li>
	<LI>Next message: <A HREF="000047.html">[Tao-list] Using  glActiveTexture or glActiveTextureARB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46">[ date ]</a>
              <a href="thread.html#46">[ thread ]</a>
              <a href="subject.html#46">[ subject ]</a>
              <a href="author.html#46">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://galactus.ximian.com/mailman/listinfo/tao-list">More information about the Tao-list
mailing list</a><br>
</body></html>
