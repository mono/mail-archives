<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Tao-list] Access Violation in Ode.dGeomSetRotation() -&gt; Solved?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Access%20Violation%20in%20Ode.dGeomSetRotation%28%29%20-%3E%20Solved%3F&In-Reply-To=448FB7B2.3050002%40nuclex.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000564.html">
   <LINK REL="Next"  HREF="000566.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Tao-list] Access Violation in Ode.dGeomSetRotation() -&gt; Solved?</H1>
    <B>Markus Ewald</B> 
    <A HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Access%20Violation%20in%20Ode.dGeomSetRotation%28%29%20-%3E%20Solved%3F&In-Reply-To=448FB7B2.3050002%40nuclex.org"
       TITLE="[Tao-list] Access Violation in Ode.dGeomSetRotation() -&gt; Solved?">cygon at nuclex.org
       </A><BR>
    <I>Wed Jun 14 03:42:21 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000564.html">[Tao-list] Access Violation in Ode.dGeomSetRotation()
</A></li>
        <LI>Next message: <A HREF="000566.html">[Tao-list] Access Violation in Ode.dGeomSetRotation() -&gt; Solved?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#565">[ date ]</a>
              <a href="thread.html#565">[ thread ]</a>
              <a href="subject.html#565">[ subject ]</a>
              <a href="author.html#565">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Once more :)

The function signatures of the Tao.Ode.dll functions and the actual ones 
Ode.dll are different and I'm now quite sure that the dMatrix3 structure 
doesn't get marshaled in a format that is compatible to ODE's array of 
floats (at least on the .NET 1.1 and .NET 2.0 platforms)

Note that dMatrix3 in C++ is just a typedef dReal dMatrix3[4*3] whereas 
it is a structure in C#

Here's dGeomSetRotation()
Tao&gt;        [DllImport(ODE_NATIVE_LIBRARY, 
CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
Tao&gt;        public extern static void dGeomSetRotation(dGeomID geom, 
dMatrix3 R);
Ode&gt;      void dGeomSetRotation (dxGeom *g, const dMatrix3 R);

and here's dMassRotate()
Tao&gt;        [DllImport(ODE_NATIVE_LIBRARY, 
CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
Tao&gt;        public extern static void dMassRotate(ref dMass mass, 
dMatrix3 R);
Ode&gt;        void dMassRotate (dMass *m, const dMatrix3 R);

--

I have attached a patch based on Revision 61689 of the mono repository 
that makes Tao.Ode work in .NET 1.1 and .NET 2.0 for me. I added a 
public ToArray() method to the Tao.Ode.Ode.dMatrix3 structure and 
provided the corrected P/Invoke declarations as well as the old ones as 
wrapper functions in parallel to preserve code compatibility. I didn't 
test it on mono yet.

Cheers,
-Markus-

-------------- next part --------------
Index: Ode.cs
===================================================================
--- Ode.cs	(Revision 61689)
+++ Ode.cs	(Arbeitskopie)
@@ -1104,6 +1104,12 @@
 					}
 				}
 			}
+			
+			public dReal[] ToArray() {
+			  return new dReal[] {
+			    M00, M01, M02, M03, M10, M11, M12, M13, M20, M21, M22, M23
+			  };
+			}
 	};
 	
 		/// &lt;summary&gt;
@@ -3776,17 +3782,22 @@
 		[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
 		public extern static void dMassTranslate(ref dMass mass, dReal x, dReal y, dReal z);
 		
-		/* TLT comment: this seems redundant since call matching actual Ode signature is below */
-		//[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
-		//public extern static void dMassRotate(ref dMass mass, /*dMatrix3*/ dReal[] R);
+		/// &lt;summary&gt;
+		/// Given mass parameters for some object, adjust them to represent the object rotated by R relative to the body frame.
+		/// &lt;/summary&gt;
+		/// &lt;param name=&quot;mass&quot;&gt;A  dMass&lt;/param&gt;
+		/// &lt;param name=&quot;R&quot;&gt;An  array of 12 elements containing a 3x4 rotation matrix&lt;/param&gt;
+		[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
+		public extern static void dMassRotate(ref dMass mass, dReal[] R);
 		
 		/// &lt;summary&gt;
 		/// Given mass parameters for some object, adjust them to represent the object rotated by R relative to the body frame.
 		/// &lt;/summary&gt;
 		/// &lt;param name=&quot;mass&quot;&gt;A  dMass&lt;/param&gt;
 		/// &lt;param name=&quot;R&quot;&gt;A  dMatrix3&lt;/param&gt;
-		[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
-		public extern static void dMassRotate(ref dMass mass, dMatrix3 R);
+		public static void dMassRotate(ref dMass mass, dMatrix3 R) { // for compatibility
+		  dMassRotate(ref mass, R.ToArray());
+		}
 		
 		/// &lt;summary&gt;
 		/// Add the mass b to the mass a.
@@ -3896,9 +3907,24 @@
 		/// Calling this function on a non-placeable geom results in a runtime error in the debug build of ODE.
 		/// &lt;/summary&gt;
 		/// &lt;param name=&quot;geom&quot;&gt;A  dGeomID&lt;/param&gt;
+		/// &lt;param name=&quot;R&quot;&gt;An  array of 12 elements containing a 3x4 rotation matrix&lt;/param&gt;
+		[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
+		public extern static void dGeomSetRotation(dGeomID geom, dReal[] R);
+
+		/// &lt;summary&gt;
+		/// Set the rotation matrix of a placeable geom. 
+		/// 
+		/// This function is analogous to dBodySetRotation.
+		///  
+		/// If the geom is attached to a body, the body's rotation will also be changed.
+		/// 
+		/// Calling this function on a non-placeable geom results in a runtime error in the debug build of ODE.
+		/// &lt;/summary&gt;
+		/// &lt;param name=&quot;geom&quot;&gt;A  dGeomID&lt;/param&gt;
 		/// &lt;param name=&quot;R&quot;&gt;A  dMatrix3&lt;/param&gt;
-		[DllImport(ODE_NATIVE_LIBRARY, CallingConvention=CALLING_CONVENTION), SuppressUnmanagedCodeSecurity]
-		public extern static void dGeomSetRotation(dGeomID geom, dMatrix3 R);
+		public static void dGeomSetRotation(dGeomID geom, dMatrix3 R) { // for compatibility
+		  dGeomSetRotation(geom, R.ToArray());
+		}
 		
 		/// &lt;summary&gt;
 		/// Set the quaternion of a placeable geom. 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000564.html">[Tao-list] Access Violation in Ode.dGeomSetRotation()
</A></li>
	<LI>Next message: <A HREF="000566.html">[Tao-list] Access Violation in Ode.dGeomSetRotation() -&gt; Solved?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#565">[ date ]</a>
              <a href="thread.html#565">[ thread ]</a>
              <a href="subject.html#565">[ subject ]</a>
              <a href="author.html#565">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://galactus.ximian.com/mailman/listinfo/tao-list">More information about the Tao-list
mailing list</a><br>
</body></html>
