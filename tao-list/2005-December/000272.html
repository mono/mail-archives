<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Tao-list] Reading .gif files fast to Tao.Sdl surfaces
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Reading%20.gif%20files%20fast%20to%20Tao.Sdl%20surfaces&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000274.html">
   <LINK REL="Next"  HREF="000273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Tao-list] Reading .gif files fast to Tao.Sdl surfaces</H1>
    <B>Olof Bjarnason</B> 
    <A HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Reading%20.gif%20files%20fast%20to%20Tao.Sdl%20surfaces&In-Reply-To="
       TITLE="[Tao-list] Reading .gif files fast to Tao.Sdl surfaces">olof.bjarnason at gmail.com
       </A><BR>
    <I>Thu Dec  8 14:36:10 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000274.html">[Tao-list] Tao.Ode collision detection problem!
</A></li>
        <LI>Next message: <A HREF="000273.html">[Tao-list] Reading .gif files fast to Tao.Sdl surfaces
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#272">[ date ]</a>
              <a href="thread.html#272">[ thread ]</a>
              <a href="subject.html#272">[ subject ]</a>
              <a href="author.html#272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi there!

I'm fairly new to Tao, and am using it primarily for the Sdl wrapper. I'm in
C#.

Now I want to load images into Sdl's surfaces. I'm using .gif for my
pixel-animation based game, so that format is preferable from my side, and
also I'd like to read them from memory (I'm using binary archive files
instead of the file system.). All 8-bits.

The method I've come up with so far is quite complicated, and as you might
image after reading this, quite slow. The reason for the complication is
because I want to avoid unsafe code sections. Also, I don't exactly know how
the garbage collection of C# work, and how I make sure sdl doesn't garble up
when I throw in an IntPtr (or that pointer's heap space being reclaimed by
the GC).

So bear with me ---

1. To begin with, I have the .gif file loaded into a byte[] called 'bytes'.
Nothing strange here, and it's fast.

2. I use Tao.DevIL to decode 'bytes' to image number 1. This is fast too.
      Il.ilBindImage(1);
      Il.ilLoadL(Il.IL_GIF, bytes, bytes.Length);

3. Find out the bitmap dimensions via DevIL:
      int w = Il.ilGetInteger(Il.IL_IMAGE_WIDTH);
      int h = Il.ilGetInteger(Il.IL_IMAGE_HEIGHT);

4. Gain access to the pixels of the read-in bitmap via DevIL's (an IntPtr)
      IntPtr pixels = Il.ilGetData();

5. In order to gain access to the actual 8-bit bytes of the bitmap, I copy
the
  actual bytes in 'pixels' to another byte[] called 'pixelarray' via C#'s
Marshalling copy function.
  This should be reasonably fast too, given the built-in marshalling
functions are fast, which
  they really should be.
      byte[] pixelarray = new byte[w*h];
      Marshal.Copy(pixels, pixelarray, 0, w*h);

6. Now I'm ready to create the Sdl surface. Since I don't wanna hack around
with byte* I simply
   use Sdl's FillRect to blit the bytes of the loaded bitmap to the sdl
surface:

        IntPtr surface = Sdl.SDL_CreateRGBSurface(Sdl.SDL_SWSURFACE, w, h,
8, 0, 0, 0, 0);
        Sdl.SDL_Rect r = new Sdl.SDL_Rect(0, 0, 1, 1);
        for (short y = 0; y &lt; h; y++)
          for (short x = 0; x &lt; w; x++)
          {
            r.x = x;
            r.y = y;
            Sdl.SDL_FillRect(surface, ref r, pixelarray[w * y + x]);
          }

This step is HORRIBLY slow - something like 5 seconds on my 1.5GHz Pentium
4.

So, is there a faster way to load binar-embedded .gifs without using
'unsafe'? May I safely assume using SDL_CreateRGBSurfaceFrom() will work
with the IntPtr returned from DevIL, as long as I don't delete the DevIL
bitmap?

/Olof
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/tao-list/attachments/20051208/c903462d/attachment-0001.html">http://lists.ximian.com/pipermail/tao-list/attachments/20051208/c903462d/attachment-0001.html</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000274.html">[Tao-list] Tao.Ode collision detection problem!
</A></li>
	<LI>Next message: <A HREF="000273.html">[Tao-list] Reading .gif files fast to Tao.Sdl surfaces
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#272">[ date ]</a>
              <a href="thread.html#272">[ thread ]</a>
              <a href="subject.html#272">[ subject ]</a>
              <a href="author.html#272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://galactus.ximian.com/mailman/listinfo/tao-list">More information about the Tao-list
mailing list</a><br>
</body></html>
