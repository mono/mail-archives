<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Tao-list] Reading .gif files fast to Tao.Sdl surfaces
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Reading%20.gif%20files%20fast%20to%20Tao.Sdl%20surfaces&In-Reply-To=c3dfe1d0512100210v28693f97k4bf39c967b031f6f%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000275.html">
   <LINK REL="Next"  HREF="000276.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Tao-list] Reading .gif files fast to Tao.Sdl surfaces</H1>
    <B>Olof Bjarnason</B> 
    <A HREF="mailto:tao-list%40lists.ximian.com?Subject=%5BTao-list%5D%20Reading%20.gif%20files%20fast%20to%20Tao.Sdl%20surfaces&In-Reply-To=c3dfe1d0512100210v28693f97k4bf39c967b031f6f%40mail.gmail.com"
       TITLE="[Tao-list] Reading .gif files fast to Tao.Sdl surfaces">olof.bjarnason at gmail.com
       </A><BR>
    <I>Sat Dec 10 07:02:09 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000275.html">[Tao-list] Reading .gif files fast to Tao.Sdl surfaces
</A></li>
        <LI>Next message: <A HREF="000276.html">[Tao-list] Tao and desktop eye candy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#277">[ date ]</a>
              <a href="thread.html#277">[ thread ]</a>
              <a href="subject.html#277">[ subject ]</a>
              <a href="author.html#277">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Preliminary results for the new loading routine speaks quite clearly:

Version1 embedded gif decoding/bitmap creation took 5354,8 ms.
Version2 embedded gif decoding/bitmap creation took 13,2 ms.

:<i>) Thanks david. I think I will use SdlImage instead of my DevIL/FillRect
</I>way ....

/Olof


On 12/10/05, Olof Bjarnason &lt;<A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">olof.bjarnason at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Thanks, I will try this out.
</I>&gt;<i>
</I>&gt;<i> But I'm thinking, how does SdlImage handle the multi-frame-format .gif?
</I>&gt;<i> There are no APIs for getting the individual surfaces of a .gif in SdlImage,
</I>&gt;<i> or have I missed something? Of course, I could do something like putting all
</I>&gt;<i> the frames of the .gif into a grid on a single frame.
</I>&gt;<i>
</I>&gt;<i> /Olof
</I>&gt;<i>
</I>&gt;<i> On 12/8/05, <A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">David_Hudson at capgroup.com</A> &lt;<A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">David_Hudson at capgroup.com</A> &gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; for step 6 use this
</I>&gt;<i> &gt; IntPtr surface = SdlImage.IMG_Load_RW(Sdl.SDL_RWFromMem (pixelarray,
</I>&gt;<i> &gt; pixelarray.Length), 1);
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Dave
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">tao-list-bounces at lists.ximian.com</A> wrote on 12/08/2005 11:36:10 AM:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hi there!
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I'm fairly new to Tao, and am using it primarily for the Sdl
</I>&gt;<i> &gt; &gt; wrapper. I'm in C#.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Now I want to load images into Sdl's surfaces. I'm using .gif for my
</I>&gt;<i> &gt; &gt; pixel-animation based game, so that format is preferable from my
</I>&gt;<i> &gt; &gt; side, and also I'd like to read them from memory (I'm using binary
</I>&gt;<i> &gt; &gt; archive files instead of the file system.). All 8-bits.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The method I've come up with so far is quite complicated, and as you
</I>&gt;<i> &gt; &gt; might image after reading this, quite slow. The reason for the
</I>&gt;<i> &gt; &gt; complication is because I want to avoid unsafe code sections. Also,
</I>&gt;<i> &gt; &gt; I don't exactly know how the garbage collection of C# work, and how
</I>&gt;<i> &gt; &gt; I make sure sdl doesn't garble up when I throw in an IntPtr (or that
</I>&gt;<i> &gt; &gt; pointer's heap space being reclaimed by the GC).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; So bear with me ---
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 1. To begin with, I have the .gif file loaded into a byte[] called
</I>&gt;<i> &gt; &gt; 'bytes'. Nothing strange here, and it's fast.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 2. I use Tao.DevIL to decode 'bytes' to image number 1. This is fast
</I>&gt;<i> &gt; too.
</I>&gt;<i> &gt; &gt;       Il.ilBindImage(1);
</I>&gt;<i> &gt; &gt;       Il.ilLoadL(Il.IL_GIF, bytes, bytes.Length);
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 3. Find out the bitmap dimensions via DevIL:
</I>&gt;<i> &gt; &gt;       int w = Il.ilGetInteger(Il.IL_IMAGE_WIDTH);
</I>&gt;<i> &gt; &gt;       int h = Il.ilGetInteger(Il.IL_IMAGE_HEIGHT);
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 4. Gain access to the pixels of the read-in bitmap via DevIL's (an
</I>&gt;<i> &gt; IntPtr)
</I>&gt;<i> &gt; &gt;       IntPtr pixels = Il.ilGetData();
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 5. In order to gain access to the actual 8-bit bytes of the bitmap, I
</I>&gt;<i> &gt; copy the
</I>&gt;<i> &gt; &gt;   actual bytes in 'pixels' to another byte[] called 'pixelarray' via
</I>&gt;<i> &gt; &gt; C#'s Marshalling copy function.
</I>&gt;<i> &gt; &gt;   This should be reasonably fast too, given the built-in marshalling
</I>&gt;<i> &gt; &gt; functions are fast, which
</I>&gt;<i> &gt; &gt;   they really should be.
</I>&gt;<i> &gt; &gt;       byte[] pixelarray = new byte[w*h];
</I>&gt;<i> &gt; &gt;       Marshal.Copy(pixels, pixelarray, 0, w*h);
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 6. Now I'm ready to create the Sdl surface. Since I don't wanna hack
</I>&gt;<i> &gt; &gt; around with byte* I simply
</I>&gt;<i> &gt; &gt;    use Sdl's FillRect to blit the bytes of the loaded bitmap to the
</I>&gt;<i> &gt; &gt; sdl surface:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;         IntPtr surface = Sdl.SDL_CreateRGBSurface(Sdl.SDL_SWSURFACE,
</I>&gt;<i> &gt; &gt; w, h, 8, 0, 0, 0, 0);
</I>&gt;<i> &gt; &gt;         Sdl.SDL_Rect r = new Sdl.SDL_Rect(0, 0, 1, 1);
</I>&gt;<i> &gt; &gt;         for (short y = 0; y &lt; h; y++)
</I>&gt;<i> &gt; &gt;           for (short x = 0; x &lt; w; x++)
</I>&gt;<i> &gt; &gt;           {
</I>&gt;<i> &gt; &gt;             r.x = x;
</I>&gt;<i> &gt; &gt;             r.y = y;
</I>&gt;<i> &gt; &gt;             Sdl.SDL_FillRect(surface, ref r, pixelarray[w * y + x]);
</I>&gt;<i> &gt; &gt;           }
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This step is HORRIBLY slow - something like 5 seconds on my 1.5GHz
</I>&gt;<i> &gt; Pentium 4.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; So, is there a faster way to load binar-embedded .gifs without using
</I>&gt;<i> &gt; &gt; 'unsafe'? May I safely assume using SDL_CreateRGBSurfaceFrom() will
</I>&gt;<i> &gt; &gt; work with the IntPtr returned from DevIL, as long as I don't delete
</I>&gt;<i> &gt; &gt; the DevIL bitmap?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; /Olof
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Tao-list mailing list
</I>&gt;<i> &gt; &gt; <A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">Tao-list at lists.ximian.com</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://galactus.ximian.com/mailman/listinfo/tao-list">http://galactus.ximian.com/mailman/listinfo/tao-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/tao-list/attachments/20051210/eca13555/attachment-0001.html">http://lists.ximian.com/pipermail/tao-list/attachments/20051210/eca13555/attachment-0001.html</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000275.html">[Tao-list] Reading .gif files fast to Tao.Sdl surfaces
</A></li>
	<LI>Next message: <A HREF="000276.html">[Tao-list] Tao and desktop eye candy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#277">[ date ]</a>
              <a href="thread.html#277">[ thread ]</a>
              <a href="subject.html#277">[ subject ]</a>
              <a href="author.html#277">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://galactus.ximian.com/mailman/listinfo/tao-list">More information about the Tao-list
mailing list</a><br>
</body></html>
