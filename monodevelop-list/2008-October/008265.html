<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoDevelop] [Mono-list] marshal a struct
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20%5BMono-list%5D%20marshal%20a%20struct&In-Reply-To=48E5270B.3030100%40gmx.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008262.html">
   <LINK REL="Next"  HREF="008275.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoDevelop] [Mono-list] marshal a struct</H1>
    <B>Chris Howie</B> 
    <A HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20%5BMono-list%5D%20marshal%20a%20struct&In-Reply-To=48E5270B.3030100%40gmx.de"
       TITLE="[MonoDevelop] [Mono-list] marshal a struct">cdhowie at gmail.com
       </A><BR>
    <I>Thu Oct  2 22:27:15 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008262.html">[MonoDevelop] Filure Monodevelop INSTALL
</A></li>
        <LI>Next message: <A HREF="008275.html">[MonoDevelop] [Mono-list] marshal a struct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8265">[ date ]</a>
              <a href="thread.html#8265">[ thread ]</a>
              <a href="subject.html#8265">[ subject ]</a>
              <a href="author.html#8265">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Oct 2, 2008 at 3:54 PM, Norbert Lazzeri &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-list">elnogge at gmx.de</A>&gt; wrote:
&gt;<i> im playing around a bit with c# and dllimports.
</I>&gt;<i>
</I>&gt;<i> my unmanaged function:
</I>&gt;<i> /****************************************/
</I>&gt;<i> struct blub {
</I>&gt;<i>    int size;
</I>&gt;<i>    char data[100];
</I>&gt;<i>    bool flag;
</I>&gt;<i> };
</I>&gt;<i> /****************************************/
</I>&gt;<i> c# - calling code
</I>&gt;<i> /****************************************/
</I>&gt;<i> [StructLayout(LayoutKind.Sequential, CharSet = CharSet.Ansi)]
</I>&gt;<i> public struct INFO
</I>&gt;<i> {
</I>&gt;<i>    public int size;
</I>&gt;<i>    [MarshalAs(UnmanagedType.ByValArray,SizeConst=100)]
</I>&gt;<i>    public char [] data;
</I>&gt;<i>    public bool flag;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> class MainClass
</I>&gt;<i> {
</I>&gt;<i>
</I>&gt;<i>    [DllImport (&quot;libmitcode&quot;, CharSet = CharSet.Ansi)]
</I>&gt;<i>    private static extern int getStruct(int size, ref INFO str);
</I>&gt;<i>
</I>&gt;<i>    public static void Main(string[] args)
</I>&gt;<i>    {
</I>&gt;<i>        INFO str = new INFO();
</I>&gt;<i>        int res = getStruct(Marshal.SizeOf(str), ref str);
</I>&gt;<i>
</I>&gt;<i>        Console.Out.WriteLine(str.size);
</I>&gt;<i>        Console.Out.WriteLine(str.flag);
</I>&gt;<i>        Console.Out.WriteLine(&quot;&lt;&lt; &quot; + new String(str.data) + &quot; &gt;&gt;&quot;);
</I>&gt;<i>        Console.Out.WriteLine(+ res);
</I>&gt;<i>
</I>&gt;<i>    }
</I>&gt;<i> }
</I>&gt;<i> /****************************************/
</I>
A couple of issues:

1. The C type char and C# type char have different sizes.  The
marshaller is probably going to truncate going from C# to C, and
coming back it should be filling the array with invalid (that is, not
unicode) data.  Either store a byte[] on the C# class and use
System.Text.Encoding.ASCII to convert, or use a string, or something.
Somehow the String constructor or the marshaller is figuring this out
by itself but I would not rely on this behavior, unless you can find
where it is documented.

2. The String(char[]) constructor may not be smart enough to
understand that a null ASCII character means end-of-string.  The
terminal may be OK ignoring a null character, but the MD output pane
may not, and that's why you see it truncated there.  (This is still
arguably an MD bug, but you are correct that there are issues with
your code as well.)

-- 
Chris Howie
<A HREF="http://www.chrishowie.com">http://www.chrishowie.com</A>
<A HREF="http://en.wikipedia.org/wiki/User:Crazycomputers">http://en.wikipedia.org/wiki/User:Crazycomputers</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008262.html">[MonoDevelop] Filure Monodevelop INSTALL
</A></li>
	<LI>Next message: <A HREF="008275.html">[MonoDevelop] [Mono-list] marshal a struct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8265">[ date ]</a>
              <a href="thread.html#8265">[ thread ]</a>
              <a href="subject.html#8265">[ subject ]</a>
              <a href="author.html#8265">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-list">More information about the Monodevelop-list
mailing list</a><br>
</body></html>
