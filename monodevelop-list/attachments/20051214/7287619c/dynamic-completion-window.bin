Index: Core/src/MonoDevelop.Projects.Gui/ChangeLog
===================================================================
--- Core/src/MonoDevelop.Projects.Gui/ChangeLog	(revision 54302)
+++ Core/src/MonoDevelop.Projects.Gui/ChangeLog	(working copy)
@@ -1,3 +1,10 @@
+2005-12-14  Jacob Ilsoe Christensen <jacobilsoe@gmail.com> 
+
+	* MonoDevelop.Projects.Gui.Completion/CompletionListWindow.cs:
+	* MonoDevelop.Projects.Gui.Completion/ListWindow.cs:
+	Make the completion window shrink and expand according
+	to what is currently matched.
+	
 2005-10-11  Lluis Sanchez Gual  <lluis@novell.com> 
 
 	* MonoDevelop.Projects.Gui.addin.xml: Fixed addin header information.
Index: Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/CompletionListWindow.cs
===================================================================
--- Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/CompletionListWindow.cs	(revision 54302)
+++ Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/CompletionListWindow.cs	(working copy)
@@ -176,7 +176,7 @@
 				return;
 
 			if (List.GdkWindow == null) return;
-			Gdk.Rectangle rect = List.GetRowArea (List.Selection);
+			Gdk.Rectangle rect = List.GetRowArea (List.Selection + this.FirstMatchingWord);
 			int listpos_x = 0, listpos_y = 0;
 			while (listpos_x == 0 || listpos_y == 0)
 				GetPosition (out listpos_x, out listpos_y);
@@ -191,7 +191,7 @@
 				vert = listpos_y;
 			}
 
-			ICompletionData data = completionData[List.Selection];
+			ICompletionData data = completionData[List.Selection + this.FirstMatchingWord];
 			ICompletionDataWithMarkup datawMarkup = data as ICompletionDataWithMarkup;
 			CodeCompletionData ccdata = (CodeCompletionData) data;
 
Index: Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/ListWindow.cs
===================================================================
--- Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/ListWindow.cs	(revision 54302)
+++ Core/src/MonoDevelop.Projects.Gui/MonoDevelop.Projects.Gui.Completion/ListWindow.cs	(working copy)
@@ -14,7 +14,10 @@
 		
 		StringBuilder word;
 		int curPos;
-		
+
+		private int matchingWords = 0;
+		private int firstMatchingWord = 0;
+	
 		[Flags]
 		public enum KeyAction { Process=1, Ignore=2, CloseWindow=4, Complete=8 } 
 
@@ -47,29 +50,33 @@
 			word = new StringBuilder ();
 			curPos = 0;
 			list.Reset ();
-
-			if (list.VisibleRows >= provider.ItemCount) {
-				this.scrollbar.Hide();
-			}
-			else {
-				scrollbar.Adjustment.Lower = 0;
-				scrollbar.Adjustment.Upper = provider.ItemCount - list.VisibleRows;
-				scrollbar.Adjustment.PageIncrement = list.VisibleRows - 1;
-				scrollbar.Adjustment.StepIncrement = 1;
-			}
-
-			this.Resize(this.list.WidthRequest, this.list.HeightRequest);
+			UpdateScrollbar();		
 		}
 		
 		public IListDataProvider DataProvider
 		{
 			get { return provider; }
-			set { provider = value; }
+			set
+			{
+				this.provider = value;
+				this.matchingWords = this.provider.ItemCount;
+				this.firstMatchingWord = 0;
+			}
 		}
 		
+		public int MatchingWords
+		{
+			get { return this.matchingWords; }
+		}
+
+		public int FirstMatchingWord
+		{
+			get { return this.firstMatchingWord; }
+		}
+		
 		public string CompleteWord
 		{
-			get { return provider.GetText (list.Selection);	}
+			get { return provider.GetText (list.Selection + this.firstMatchingWord); }
 		}
 		
 		public string PartialWord
@@ -179,25 +186,46 @@
 			return KeyAction.CloseWindow | KeyAction.Process;
 		}
 		
+		private void UpdateScrollbar()
+		{
+			if (list.VisibleRows >= this.matchingWords) {
+				scrollbar.Hide();
+			}
+			else {
+				scrollbar.Adjustment.Lower = 0;
+				scrollbar.Adjustment.Upper = provider.ItemCount - list.VisibleRows;
+				scrollbar.Adjustment.PageIncrement = list.VisibleRows - 1;
+				scrollbar.Adjustment.StepIncrement = 1;
+				scrollbar.Show();
+			}
+		}
+		
 		void UpdateWordSelection ()
 		{
 			string s = word.ToString ();
-			int max = (provider == null ? 0 : provider.ItemCount);
+			int max = (provider == null ? 0 : provider.ItemCount);			
+			int matchesFound = 0;
+			int bestMatch = -1;
 			
-			int bestMatch = -1;
 			for (int n=0; n<max; n++) 
 			{
 				string txt = provider.GetText (n);
-				if (txt.StartsWith (s)) {
-					list.Selection = n;
-					return;
+
+				if (txt.ToLower().StartsWith(s.ToLower())) {
+					if (bestMatch == -1)
+						bestMatch = n;					
+					
+					matchesFound++;
 				}
-				else if (bestMatch == -1 && txt.ToLower().StartsWith (s.ToLower()))
-					bestMatch = n;
 			}
 			
 			if (bestMatch != -1) {
-				list.Selection = bestMatch;
+				firstMatchingWord = bestMatch;
+				matchingWords = matchesFound;				
+				list.Reset();
+				list.Selection = 0;
+				Resize(this.list.WidthRequest, this.list.HeightRequest);
+				UpdateScrollbar();
 				return;
 			}
 			
@@ -280,8 +308,8 @@
 			set {
 				if (value < 0)
 					value = 0;
-				else if (value >= win.DataProvider.ItemCount)
-					value = win.DataProvider.ItemCount - 1;
+				else if (value >= win.MatchingWords)
+					value = win.MatchingWords - 1;
 					
 				if (value != selection) 
 				{
@@ -343,18 +371,8 @@
 		{
 			if (!buttonPressed)
 				return base.OnMotionNotifyEvent (e);
-			
-			int winWidth, winHeight;
-			this.GdkWindow.GetSize (out winWidth, out winHeight);
-			
-	/*		int ypos = (int) e.Y;
-			if (ypos < 0) {
-			}
-			else if (ypos >= winHeight) {
-			}
-			else
-	*/			Selection = GetRowByPosition ((int) e.Y);
-			
+								
+			Selection = GetRowByPosition ((int) e.Y);
 			return true;
 		}
 
@@ -372,10 +390,12 @@
 			
 			int ypos = margin;
 			int lineWidth = winWidth - margin*2;
-			int xpos = margin + padding;
-				
-			int n = 0;
-			while (ypos < winHeight - margin && (page + n) < win.DataProvider.ItemCount)
+			int xpos = margin + padding;		
+			int n = win.FirstMatchingWord;                  
+
+			this.GdkWindow.Clear();
+
+			while (ypos < winHeight - margin && (page + n) < win.MatchingWords + win.FirstMatchingWord)
 			{
 				layout.SetMarkup (win.DataProvider.GetText (page + n));
 				Gdk.Pixbuf icon = win.DataProvider.GetIcon (page + n);
@@ -384,8 +404,7 @@
 				layout.GetPixelSize (out wi, out he);
 				typos = he < rowHeight ? ypos + (rowHeight - he) / 2 : ypos;
 				iypos = icon.Height < rowHeight ? ypos + (rowHeight - icon.Height) / 2 : ypos;
-				
-				if (page + n == selection) {
+				if (page + n - win.FirstMatchingWord == selection) {		
 					if (!disableSelection) {
 						this.GdkWindow.DrawRectangle (this.Style.BaseGC (StateType.Selected), true, margin, ypos, lineWidth, he + padding);
 						this.GdkWindow.DrawLayout (this.Style.TextGC (StateType.Selected), xpos + icon.Width + 2, typos, layout);
@@ -441,12 +460,11 @@
 			visibleRows = (winHeight + padding - margin * 2) / rowHeight;
 			
 			int newHeight;
-
-			if (this.win.DataProvider.ItemCount > this.visibleRows)
+ 			if (this.win.MatchingWords > this.visibleRows)
 				newHeight = (rowHeight * visibleRows) + margin * 2;
 			else
-				newHeight = (rowHeight * this.win.DataProvider.ItemCount) + margin * 2;
-			
+				newHeight = (rowHeight * this.win.MatchingWords) + margin * 2;
+				
 			if (lvWidth != listWidth || lvHeight != newHeight)
 				this.SetSizeRequest (listWidth, newHeight);
 		} 
@@ -465,6 +483,7 @@
 			
 			FontDescription des = this.Style.FontDescription.Copy();
 			layout.FontDescription = des;
+			DrawList ();
 			CalcVisibleRows ();
 		}
 	}
