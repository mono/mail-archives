<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoDevelop] code completion database druid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:iain%40mccoy.id.au">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000237.html">
   <LINK REL="Next"  HREF="000244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoDevelop] code completion database druid
   </H1>
    <B>Iain McCoy
    </B> 
    <A HREF="mailto:iain%40mccoy.id.au"
       TITLE="[MonoDevelop] code completion database druid">iain@mccoy.id.au
       </A><BR>
    <I>Wed, 25 Feb 2004 01:55:07 +1100</I>
    <P><UL>
        <LI> Previous message: <A HREF="000237.html">[MonoDevelop] compilation error
</A></li>
        <LI> Next message: <A HREF="000244.html">[MonoDevelop] code completion database druid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#242">[ date ]</a>
              <a href="thread.html#242">[ thread ]</a>
              <a href="subject.html#242">[ subject ]</a>
              <a href="author.html#242">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-K6ciL4OLYw5iLsU1LePL
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Hello,

I've attached my druid patch; it seems to work fine against r1002. I
think it does pretty much what you'd expect. There's a few bits of code
in there that need to be revised - I plan to do that, I just thought I'd
submit something that worked before the release.

This basically tears out the entire code completion wizard system and
replaces it. There's a bunch of reused bits of old code, especially in
the various database generators themselves.

It seems to do the right things and generally work as expected, but I
wouldn't be surprised to find that my testing has missed something
crucial :)

Cheers,
-- 
Iain McCoy &lt;<A HREF="mailto:iain@mccoy.id.au">iain@mccoy.id.au</A>&gt;

--=-K6ciL4OLYw5iLsU1LePL
Content-Disposition: attachment; filename=md-druid.patch
Content-Type: text/x-patch; name=md-druid.patch; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit

diff -urN MonoDevelop.pristine/src/Main/Base/Commands/AutostartCommands.cs MonoDevelop.changes/src/Main/Base/Commands/AutostartCommands.cs
--- MonoDevelop.pristine/src/Main/Base/Commands/AutostartCommands.cs	2004-02-23 13:50:08.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Commands/AutostartCommands.cs	2004-02-25 00:45:32.000000000 +1100
@@ -21,6 +21,7 @@
 using ICSharpCode.SharpDevelop.Services;
 using ICSharpCode.SharpDevelop.Gui;
 using ICSharpCode.SharpDevelop.Gui.Dialogs;
+using ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard;
 using ICSharpCode.SharpDevelop.Gui.ErrorHandlers;
 
 using SA = ICSharpCode.SharpAssembly.Assembly;
@@ -49,13 +50,21 @@
 	
 	public class StartCodeCompletionWizard : AbstractCommand
 	{
-		public override void Run()
+		private string CreateCodeCompletionDir()
 		{
-			PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-			string path = propertyService.GetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty).ToString();
 			FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-			string codeCompletionTemp = fileUtilityService.GetDirectoryNameWithSeparator(path);
-			string codeCompletionProxyFile = codeCompletionTemp + &quot;CodeCompletionProxyDataV02.bin&quot;;
+			PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
+			string path = propertyService.DataDirectory + System.IO.Path.DirectorySeparatorChar + &quot;CodeCompletionData&quot;;
+			if (!Directory.Exists(path))
+				Directory.CreateDirectory(path);
+			propertyService.SetProperty (&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, path);
+			propertyService.SaveProperties ();
+			return fileUtilityService.GetDirectoryNameWithSeparator(path);
+		}
+		public override void Run()
+		{
+			string path = CreateCodeCompletionDir();
+			string codeCompletionProxyFile = path + &quot;CodeCompletionProxyDataV02.bin&quot;;
 
 			if (!File.Exists(codeCompletionProxyFile)) {
 				RunWizard();
@@ -66,29 +75,11 @@
 		
 		void RunWizard()
 		{
-			IProperties customizer = new DefaultProperties();
-			
 			if (SplashScreenForm.SplashScreen.Visible) {
 				SplashScreenForm.SplashScreen.Hide();
 			}
-			PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-			
-			customizer.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;,
-			                       propertyService.GetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty));
 			
-			WizardDialog wizard = new WizardDialog(&quot;Initialize Code Completion Database&quot;, customizer, &quot;/SharpDevelop/CompletionDatabaseWizard&quot;);
-			propertyService.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, customizer.GetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty));
-			
-			wizard.Run ();
-			wizard.Hide ();
-			wizard.Destroy ();
-
-			// restart  &amp; exit 
-			ServiceManager.Services.UnloadAllServices();
-			// FIXME: handle this elegantly
-			// is it really necessary to restart here?
-			//System.Diagnostics.Process.Start(Path.Combine (Application.StartupPath, &quot;SharpDevelop.exe&quot;));
-			Gtk.Application.Quit ();
+			(new GenerateDatabase()).Start();
 		}
 	}
 	
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/ChooseLocationPanel.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/ChooseLocationPanel.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/ChooseLocationPanel.cs	2004-02-14 16:57:43.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/ChooseLocationPanel.cs	1970-01-01 10:00:00.000000000 +1000
@@ -1,135 +0,0 @@
-// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using System.IO;
-using Gtk;
-using MonoDevelop.Gui.Widgets;
-
-using ICSharpCode.SharpDevelop.Internal.Project;
-using ICSharpCode.Core.Properties;
-using ICSharpCode.Core.Services;
-using ICSharpCode.Core.AddIns.Codons;
-
-namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
-{
-	public class ChooseLocationPanel : AbstractWizardPanel
-	{
-		IProperties properties;
-		static FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		
-		RadioButton specifyLocationRadioButton;
-		RadioButton sharpDevelopDirRadioButton;
-		FolderEntry fEntry;
-		
-		public override bool ReceiveDialogMessage(DialogMessage message)
-		{
-			if (message == DialogMessage.Cancel) {
-				properties.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty);
-			} else if (message == DialogMessage.Next || message == DialogMessage.OK) {
-				string path = null;				
-				if (specifyLocationRadioButton.Active) {
-					path = fEntry.Path.TrimEnd (System.IO.Path.DirectorySeparatorChar);
-				} else if (sharpDevelopDirRadioButton.Active) {
-					FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-					PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-				
-					path = propertyService.DataDirectory + 
-					       System.IO.Path.DirectorySeparatorChar + &quot;CodeCompletionData&quot;; 
-				} else {
-					PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-					path = propertyService.ConfigDirectory + &quot;CodeCompletionTemp&quot;;
-				}
-				
-				if (!Directory.Exists(path)) {
-					Directory.CreateDirectory(path);
-				}
-				
-				properties.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, path);
-				propertyService.SetProperty (&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, path);
-				propertyService.SaveProperties ();
-			}
-	    		return true;
-		}
-		
-		void SetEnableStatus(object sender, EventArgs e)
-		{
-			try
-			{
-				fEntry.Sensitive = specifyLocationRadioButton.Active;
-			}
-			catch
-			{
-			}
-			
-			SetFinishedState(sender, e);
-		}
-		
-		void SetFinishedState(object sender, EventArgs e)
-		{
-			FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-			try
-			{
-				EnableFinish = EnableNext = !specifyLocationRadioButton.Active ||
-  			                            (fileUtilityService.IsValidFileName(fEntry.Path) &amp;&amp; 
-  			                            Directory.Exists(fEntry.Path));
-			}
-			catch
-			{
-			}
-		}
-		
-		void SetValues(object sender, EventArgs e)
-		{
-			properties = (IProperties)CustomizationObject;
-		}
-		
-		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-		
-		public ChooseLocationPanel() : base()
-		{
-			VBox mainVBox = new VBox (false, 0);
-			NextWizardPanelID = &quot;CreateDatabasePanel&quot;;
-			
-			fEntry = new FolderEntry (&quot;Choose completion database location&quot;);
-			fEntry.DefaultPath = Environment.GetEnvironmentVariable (&quot;HOME&quot;);
-			fEntry.PathChanged += new EventHandler (SetFinishedState);
-			
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			
-			RadioButton appDirRadioButton = new RadioButton (&quot;Use current user's application directory&quot;);
-			appDirRadioButton.Active = true;
-			appDirRadioButton.Toggled += new EventHandler (SetEnableStatus);
-
-			//FIXME: only should be sensitive if you can write to it
-			sharpDevelopDirRadioButton = new RadioButton (appDirRadioButton, &quot;Use SharpDevelop application directory&quot;);
-			sharpDevelopDirRadioButton.Toggled += new EventHandler (SetEnableStatus);
-			specifyLocationRadioButton = new RadioButton (appDirRadioButton, &quot;Specify code completion database location&quot;);
-			specifyLocationRadioButton.Toggled += new EventHandler (SetEnableStatus);
-
-			TextView t = new TextView ();
-			t.Buffer.Text = resourceService.GetString (&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.ChooseLocationPanel.DescriptionText&quot;);
-			t.Editable = false;
-			t.CursorVisible = false;
-			t.WrapMode = Gtk.WrapMode.Word;
-			
-			HBox hbox = new HBox (false, 0);
-			hbox.PackStart (fEntry);
-		
-			mainVBox.PackStart (t, true, true, 0);
-			mainVBox.PackStart (specifyLocationRadioButton, false, true, 6);
-			mainVBox.PackStart (hbox, false, true, 6);
-			mainVBox.PackStart (sharpDevelopDirRadioButton, false, true, 6);
-			mainVBox.PackStart (appDirRadioButton, false, true, 6);
-			this.Add (mainVBox);
-		
-			SetFinishedState(this, EventArgs.Empty);
-			SetEnableStatus(this, EventArgs.Empty);
-			CustomizationObjectChanged += new EventHandler(SetValues);
-		}
-	}
-}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDatabasePanel.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDatabasePanel.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDatabasePanel.cs	2004-01-22 13:11:24.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDatabasePanel.cs	1970-01-01 10:00:00.000000000 +1000
@@ -1,177 +0,0 @@
-﻿// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using Gtk;
-
-using ICSharpCode.SharpDevelop.Internal.Project;
-using ICSharpCode.Core.Properties;
-using ICSharpCode.Core.Services;
-using ICSharpCode.SharpDevelop.Services;
-
-using ICSharpCode.Core.AddIns.Codons;
-
-namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
-{
-	public class CreateDatabasePanel : AbstractWizardPanel, IProgressMonitor
-	{
-		IProperties properties;
-		GLib.IdleHandler iterate;
-		bool finished = false;
-		bool began = false;
-		int         totalWork = 0;
-		static FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		CheckButton fastCreationCheckBox = new CheckButton (&quot;Enable fast database creation (=slower code completion)&quot;);
-		
-		public override bool ReceiveDialogMessage(DialogMessage message)
-		{
-	    	return true;
-		}
-		
-		void SetValues(object sender, EventArgs e)
-		{
-			properties = (IProperties)CustomizationObject;
-		}
-		
-		void StartCreation(object sender, EventArgs e)
-		{
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			if (began) {
-				SetProgressBarValue(0);
-				createButton.Label = resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.CreateDatabasePanel.StartCreationButton&quot;);
-				EnableCancel = EnablePrevious = true;
-				//fastCreationCheckBox.Active = true;
-			} else {
-				began = true;
-				EnableCancel = EnablePrevious = false;
-				//fastCreationCheckBox.Active = false;
-				iterate = new GLib.IdleHandler (CreateDatabase);
-				GLib.Idle.Add (iterate);
-				
-				createButton.Label = resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.CreateDatabasePanel.CancelCreationButton&quot;);
-			}
-		}
-				// changed to work during GLib.Idle
-		bool CreateDatabase()
-		{
-			try {
-				DefaultParserService parserService  = (DefaultParserService)ICSharpCode.Core.Services.ServiceManager.Services.GetService(typeof(DefaultParserService));
-				string path  = properties.GetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty);
-				//Console.WriteLine (path);
-				if (fastCreationCheckBox.Active) {
-					parserService.GenerateCodeCompletionDatabaseFast(path, this);
-				} else {
-					parserService.GenerateEfficientCodeCompletionDatabase(path, this);
-				}
-			} catch (Exception e) {
-				ResourceService resourceService = (ResourceService) ServiceManager.Services.GetService (typeof (IResourceService));
-				MessageService messageService = (MessageService) ServiceManager.Services.GetService (typeof (IMessageService));
-				//Console.WriteLine (e.ToString ());
-				messageService.ShowError (resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.CreateDatabasePanel.CreateDbErrorMessage&quot;) + &quot;\n&quot; + e.ToString());
-				//throw e;
-			}
-			
-			//Console.WriteLine (!finished);
-			return !finished;
-		}
-
-		Gtk.Button createButton;
-		Gtk.ProgressBar progressBar;
-
-		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-		public CreateDatabasePanel() : base()
-		{
-
-			createButton = new Gtk.Button (&quot;Start database creation&quot;);
-			progressBar = new Gtk.ProgressBar ();
-			progressBar.BarStyle = Gtk.ProgressBarStyle.Continuous;
-		
-			NextWizardPanelID = &quot;CreationSuccessful&quot;;
-			
-			EnableFinish      = false;
-			EnableNext        = false;
-			CustomizationObjectChanged += new EventHandler(SetValues);
-			
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			Gtk.TextView t = new Gtk.TextView ();
-			t.Buffer.Text = resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.CreateDatabasePanel.PanelDescription&quot;);
-			t.WrapMode = Gtk.WrapMode.Word;
-			t.Editable = false;
-			t.CursorVisible = false;
-			
-			Gtk.VBox mainbox = new Gtk.VBox (false, 2);
-			mainbox.PackStart (t);
-			mainbox.PackStart (fastCreationCheckBox, false, false, 2);
-			mainbox.PackStart (createButton, false, false, 2);
-			mainbox.PackStart (progressBar, false, false, 2);
-		
-			this.Add (mainbox);
-			
-			createButton.Clicked += new EventHandler(StartCreation);
-		}
-		
-		void SetButtonFinish(int val)
-		{
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			createButton.Label = resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.CreateDatabasePanel.FinishedCreationButton&quot;);
-			createButton.Sensitive = false;
-			progressBar.Sensitive = false;
-			EnableCancel = EnablePrevious = false;
-			EnableFinish = true;
-			FinishPanel();
-		}
-		
-		void SetProgressBarLimit(int val)
-		{
-		}
-		void SetProgressBarValue(int val)
-		{
-		}
-		
-		delegate void SetValue(int val);
-		
-		public void BeginTask(string name, int totalWork)
-		{
-			this.totalWork = totalWork;
-		}
-		
-		
-		public void Worked(int work, string status)
-		{
-			double tmp = (double) ((double)work / (double)totalWork);
-			progressBar.Fraction = tmp;
-			progressBar.Text = status;
-
-			while(Gtk.Application.EventsPending ()) {
-				Gtk.Application.RunIteration (true);
-			}
-		}
-		
-		public void Done()
-		{
-			finished = true;
-			progressBar.Fraction = 1;
-			SetButtonFinish (1);
-		}
-		
-		public bool Canceled {
-			get {
-				return false;
-			}
-			set {
-			}
-		}
-		
-		public string TaskName {
-			get {
-				return String.Empty;
-			}
-			set {
-			}
-		}
-	}
-}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDBGenerator.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDBGenerator.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDBGenerator.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreateDBGenerator.cs	2004-02-25 00:45:32.000000000 +1100
@@ -0,0 +1,30 @@
+﻿using System;
+using System.IO;
+using Gtk;
+
+using ICSharpCode.SharpDevelop.Internal.Project;
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+using ICSharpCode.Core.AddIns.Codons;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	public class CreateDBGenerator : CreatingGenerator, IDatabaseGenerator
+	{
+		public bool Fast;
+		public void Generate(IProgressMonitor progress)
+		{
+			DefaultParserService parserService  = (DefaultParserService)ICSharpCode.Core.Services.ServiceManager.Services.GetService(typeof(DefaultParserService));
+			Console.WriteLine(&quot;using path &quot; + path);
+			if (Fast) {
+				Console.WriteLine(&quot;Creating DB with fast process&quot;);
+				parserService.GenerateCodeCompletionDatabaseFast(path, progress);
+			} else {
+				Console.WriteLine(&quot;Creating DB with slow process&quot;);
+				parserService.GenerateEfficientCodeCompletionDatabase(path, progress);
+			}
+		}
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreatingGenerator.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreatingGenerator.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreatingGenerator.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreatingGenerator.cs	2004-02-25 00:45:32.000000000 +1100
@@ -0,0 +1,18 @@
+﻿using System;
+using System.IO;
+using Gtk;
+
+using ICSharpCode.SharpDevelop.Internal.Project;
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+using ICSharpCode.Core.AddIns.Codons;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	public abstract class CreatingGenerator
+	{
+		public string path;
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreationFinishedPanel.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreationFinishedPanel.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/CreationFinishedPanel.cs	2004-01-29 08:34:46.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/CreationFinishedPanel.cs	1970-01-01 10:00:00.000000000 +1000
@@ -1,41 +0,0 @@
-﻿// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using Gtk;
-
-using ICSharpCode.SharpDevelop.Internal.Project;
-using ICSharpCode.Core.Properties;
-using ICSharpCode.Core.Services;
-using ICSharpCode.SharpDevelop.Services;
-
-using ICSharpCode.Core.AddIns.Codons;
-
-namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
-{
-	public class CreationFinishedPanel : AbstractWizardPanel
-	{
-		static FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		
-		public override bool ReceiveDialogMessage(DialogMessage message)
-		{
-	    		return true;
-		}
-		
-		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-		public CreationFinishedPanel() : base()
-		{
-			EnableFinish      = true;
-			EnableNext        = false;
-			EnablePrevious    = false;
-			EnableCancel      = false;
-			IsLastPanel       = true;
-			
-			this.Add (new Label (&quot;Creation Finished&quot;));
-		}
-	}
-}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/druid.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/druid.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/druid.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/druid.cs	2004-02-25 01:51:31.000000000 +1100
@@ -0,0 +1,194 @@
+using System;
+using Gtk;
+using Gnome;
+
+using MonoDevelop.Gui.Widgets;
+using ICSharpCode.Core.Services;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard {
+class MethodSelectionPage : DruidPageStandard {
+	internal RadioButton generateDatabase;
+	internal RadioButton useExisting;
+	internal RadioButton download;
+	
+	internal MethodSelectionPage(CodeCompletionDruid druid) : base() {
+		generateDatabase = new RadioButton(&quot;Generate a code completion database&quot;);
+		useExisting = new RadioButton(generateDatabase, &quot;Use a code completion database already on this computer&quot;);
+		download = new RadioButton(generateDatabase, &quot;Download a code completion database&quot;);
+		this.NextClicked += new NextClickedHandler(druid.GoToMethodPage);
+		AppendItem(&quot;&quot;, generateDatabase, &quot;&quot;);
+		AppendItem(&quot;&quot;, useExisting, &quot;&quot;);
+//		AppendItem(&quot;&quot;, download, &quot;&quot;);
+	}
+}
+
+
+class GenerateDatabasePage : DetailsPageBase {
+	internal RadioButton heavy;
+	internal RadioButton light;
+	
+	internal GenerateDatabasePage(CodeCompletionDruid druid) : base(druid) {
+		heavy = new RadioButton(&quot;Heavy process&quot;);
+		light = new RadioButton(heavy, &quot;Light process&quot;);
+		AppendItem(&quot;&quot;, heavy, &quot;This process is slower and more memory-intensive than the light process, but will enable faster code completion&quot;);
+		AppendItem(&quot;&quot;, light, &quot;This process will take less time and memory to produce the code completion database, but code completion will be slower&quot;);
+	}
+}
+
+class UseExistingPage : DetailsPageBase {
+	internal MonoDevelop.Gui.Widgets.FolderEntry filename;
+	
+	internal UseExistingPage(CodeCompletionDruid druid) : base(druid) {
+		filename = new FolderEntry(&quot;Select code completion database&quot;);
+		filename.DefaultPath = System.IO.Directory.GetCurrentDirectory();
+		AppendItem(&quot;Where is the code completion database you would like to copy&quot;, filename, &quot;&quot;);
+	}
+}
+
+class DownloadPage : DetailsPageBase {
+	internal Gtk.Entry uri;
+	
+	internal DownloadPage(CodeCompletionDruid druid) : base(druid) {
+		uri = new Gtk.Entry();
+		AppendItem(&quot;Where would you like to download the code completion database from?&quot;, uri, &quot;&quot;);
+	}
+}
+
+abstract class DetailsPageBase : DruidPageStandard {
+	internal CodeCompletionDruid druid;
+
+	internal DetailsPageBase(CodeCompletionDruid Druid)
+	{
+		this.druid = Druid;
+		this.NextClicked += new NextClickedHandler(MoveNext);
+		this.BackClicked += new BackClickedHandler(MoveBack);
+	}
+
+	internal void MoveNext(object sender, NextClickedArgs args)
+	{
+		druid.PreviousPage = this;
+		druid.ShowLast();
+		args.RetVal = true;
+	}
+
+	internal void MoveBack(object sender, BackClickedArgs args)
+	{
+		druid.ShowMain();
+		args.RetVal = true;
+	}
+}
+
+
+public delegate void DruidFinished(object sender, IDatabaseGenerator generator);
+public delegate void DruidCanceled(object sender);
+
+class CodeCompletionDruid : Druid {
+	internal DruidPageEdge startPage = GetStartPage();
+	internal MethodSelectionPage methodSelectionPage;
+	internal GenerateDatabasePage generateDatabasePage;
+	internal UseExistingPage useExistingPage;
+	internal DownloadPage downloadPage;
+	internal DruidPageEdge endPage;
+
+	internal DruidPage PreviousPage;
+
+	public event DruidFinished Finished;
+	public event DruidCanceled Canceled;
+	public CodeCompletionDruid() : base()
+	{
+		methodSelectionPage = new MethodSelectionPage(this);
+		generateDatabasePage = new GenerateDatabasePage(this);
+		useExistingPage = new UseExistingPage(this);
+		downloadPage = new DownloadPage(this);
+		endPage = GetEndPage();
+
+		this.Cancel += new EventHandler(HandleCancel);
+
+		AppendPage(startPage);
+		AppendPage(methodSelectionPage);
+		AppendPage(generateDatabasePage);
+		AppendPage(useExistingPage);
+		AppendPage(downloadPage);
+		AppendPage(endPage);
+	}
+
+
+	internal void BackToMethodSelection(object sender, BackClickedArgs args)
+	{
+		this.Page = methodSelectionPage;
+	}
+
+	internal static DruidPageEdge GetStartPage()
+	{
+		DruidPageEdge page = new DruidPageEdge(EdgePosition.Start);
+		page.Text = &quot;This druid will guide you through the process of creating a code completion database&quot;;
+		return page;
+	}
+
+	internal DruidPageEdge GetEndPage()
+	{
+		DruidPageEdge page = new DruidPageEdge(EdgePosition.Finish);
+		page.Text = &quot;Click Accept to start the database creation process&quot;;
+		page.BackClicked += new BackClickedHandler(GoToPrev);
+		page.FinishClicked += new FinishClickedHandler(EndOfWizard);
+		return page;
+	}
+
+	internal void GoToPrev(object sender, BackClickedArgs args)
+	{
+		Page = PreviousPage;
+		args.RetVal = true;
+	}
+	
+	internal void EndOfWizard(object sender, FinishClickedArgs args)
+	{
+		Console.WriteLine(&quot;Finishing druid&quot;);
+		IDatabaseGenerator generator = null;
+		if (methodSelectionPage.generateDatabase.Active) {
+			generator = (IDatabaseGenerator)new CreateDBGenerator();
+			if (generateDatabasePage.light.Active)
+				((CreateDBGenerator)generator).Fast = true;
+		} else if (methodSelectionPage.useExisting.Active) {
+			generator = (IDatabaseGenerator)new UseExistingDBGenerator();
+			((UseExistingDBGenerator)generator).Path = useExistingPage.filename.Path;
+	//	} else if (methodSelectionPage.download.Active) {
+		}
+		if (Finished != null)
+			Finished(this, generator);
+	}
+
+	internal void ShowLast()
+	{
+		Page = endPage;
+	}
+	
+	internal void ShowMain()
+	{
+		Console.WriteLine(&quot;Showing main page...&quot;);
+		Page = methodSelectionPage;
+	}
+	
+	internal void GoToMethodPage(object sender, NextClickedArgs args)
+	{
+		if (methodSelectionPage.generateDatabase.Active) {
+			Page = generateDatabasePage;
+		} else if (methodSelectionPage.useExisting.Active) {
+			Page = useExistingPage;
+		} else if (methodSelectionPage.download.Active) {
+			Page = downloadPage;
+		}
+		args.RetVal = true;
+	}
+
+	internal void HandleCancel(object sender, EventArgs args)
+	{
+		MessageService messageService = (MessageService)ServiceManager.Services.GetService(typeof(MessageService));
+		bool really = messageService.AskQuestion(&quot;Are you sure you want to skip database creation? You will not have code completion functionality.&quot;, &quot;Are you sure?&quot;);
+		Console.WriteLine(&quot;Really? &quot; + really);
+		if (really) {
+			this.Destroy();
+			this.Canceled(this);
+		}
+	}
+}
+}
Binary files MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/.druid.cs.swp and MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/.druid.cs.swp differ
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/Exceptions.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/Exceptions.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/Exceptions.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/Exceptions.cs	2004-02-25 00:45:32.000000000 +1100
@@ -0,0 +1,18 @@
+﻿using System;
+using Gtk;
+
+using ICSharpCode.SharpDevelop.Internal.Project;
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+using ICSharpCode.Core.AddIns.Codons;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	public class PathNotCodeCompletionDatabaseException : ApplicationException
+	{
+		public PathNotCodeCompletionDatabaseException(string message) : base(message){}
+		public PathNotCodeCompletionDatabaseException(string message, Exception inner) : base(message, inner){}
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/GenerateDatabase.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/GenerateDatabase.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/GenerateDatabase.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/GenerateDatabase.cs	2004-02-25 01:39:02.000000000 +1100
@@ -0,0 +1,118 @@
+using System;
+using Gtk;
+
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	class ProgressMonitorBar : Gtk.ProgressBar, IProgressMonitor
+	{
+		private bool canceled;
+		public void BeginTask(string name, int totalWork)
+		{
+			this.DiscreteBlocks = (uint)totalWork;
+		}
+				
+		public void Worked(int work, string status)
+		{
+			double f = (double)work / this.DiscreteBlocks;
+			Console.WriteLine(&quot;% is {0}&quot;, f);
+			this.Fraction = f;
+		}
+		public void Done()
+		{
+			this.Fraction = 1;
+		}
+		public bool Canceled {
+			get { return canceled;  }
+			set { canceled = value; }
+		}
+		public string TaskName {
+			get { return &quot;&quot;; }
+			set {  ;}
+		}
+	}
+
+	class GeneratorProgress : Gtk.Window
+	{
+		Gtk.Button cancel;
+		IDatabaseGenerator generator;
+		ProgressMonitorBar progress;
+		
+		public GeneratorProgress (IDatabaseGenerator generator) : base(&quot;Code completion database generator&quot;)
+		{
+			this.generator = generator;
+			
+			Gtk.VBox vb = new Gtk.VBox(false, 6);
+			this.Add(vb);
+				
+			vb.Add(new Gtk.Label(&quot;Creating database...&quot;));
+
+			progress = new ProgressMonitorBar();
+			vb.Add(progress);
+
+			cancel = new Gtk.Button(&quot;Cancel&quot;);
+			cancel.Clicked += new EventHandler(DoCancel);
+			vb.Add(cancel);
+			this.ShowAll();
+			while (Gtk.Application.EventsPending ())
+				Gtk.Application.RunIteration ();
+		
+			generator.Generate(progress);
+			this.Destroy();
+		}
+
+		private void DoCancel(object sender, EventArgs args)
+		{
+			((Button)sender).Sensitive = false;
+			progress.Canceled = true;
+		}
+	}
+	
+	class GenerateDatabase {
+		Window druidHost;
+		
+		public void Start()
+		{
+			CodeCompletionDruid druid = new CodeCompletionDruid();
+			druidHost = new Gtk.Window(&quot;Code completion database druid&quot;);
+			druidHost.Add(druid);
+			druid.Finished += new DruidFinished(GotDruidData);
+			druid.Canceled += new DruidCanceled(DruidCanceled);
+			druidHost.ShowAll();
+
+		}
+
+		void GotDruidData(object sender, IDatabaseGenerator gen)
+		{
+			try {
+				druidHost.Destroy();
+				PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
+				string path = propertyService.GetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, String.Empty);
+
+				if (gen is CreatingGenerator)
+					((CreatingGenerator)gen).path = path;
+
+				GeneratorProgress gp = new GeneratorProgress(gen);
+			} catch (Exception e) {
+				Console.WriteLine(&quot;Failed with exception &quot; + e.GetType().Name + &quot;: &quot; + e.Message);
+				//FIXME: display error message
+				Start();
+			}
+/*			// restart  &amp; exit 
+			ServiceManager.Services.UnloadAllServices();
+			// FIXME: handle this elegantly
+			// is it really necessary to restart here?
+			//System.Diagnostics.Process.Start(Path.Combine (Application.StartupPath, &quot;SharpDevelop.exe&quot;));
+			Gtk.Application.Quit ();*/
+
+		}
+
+		public void DruidCanceled(object o)
+		{
+			druidHost.Destroy();
+		}
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/IDatabaseGenerator.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/IDatabaseGenerator.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/IDatabaseGenerator.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/IDatabaseGenerator.cs	2004-02-25 00:45:32.000000000 +1100
@@ -0,0 +1,24 @@
+﻿// &lt;file&gt;
+//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
+//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
+//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
+//     &lt;version value=&quot;$version&quot;/&gt;
+// &lt;/file&gt;
+
+using System;
+using Gtk;
+
+using ICSharpCode.SharpDevelop.Internal.Project;
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+using ICSharpCode.Core.AddIns.Codons;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	public interface IDatabaseGenerator
+	{
+		void Generate(IProgressMonitor monitor);
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/SetupPanel.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/SetupPanel.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/SetupPanel.cs	2004-01-10 11:25:20.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/SetupPanel.cs	1970-01-01 10:00:00.000000000 +1000
@@ -1,71 +0,0 @@
-﻿// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using Gtk;
-
-using ICSharpCode.SharpDevelop.Internal.Project;
-using ICSharpCode.Core.Properties;
-
-using ICSharpCode.Core.Services;
-using ICSharpCode.Core.AddIns.Codons;
-
-namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
-{
-	public class SetupPanel : AbstractWizardPanel
-	{
-		static FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		
-		RadioButton useExistingRadioButton;
-		RadioButton createNewRadioButton;
-		RadioButton skipCreationRadioButton;
-		
-		void SetSuccessor(object sender, EventArgs e)
-		{
-			IsLastPanel = skipCreationRadioButton.Active;
-			
-			if (createNewRadioButton.Active) {
-				NextWizardPanelID = &quot;ChooseLocationPanel&quot;;
-			} else if (useExistingRadioButton.Active) {
-				NextWizardPanelID = &quot;UseExistingFilePanel&quot;;
-			}
-		}
-		
-		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-		
-		public SetupPanel() : base()
-		{
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			string text = resourceService.GetString(&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.SetupPanel.DescriptionText&quot;);
-			VBox mainVBox = new VBox (false, 0);
-
-			useExistingRadioButton = new RadioButton (&quot;Use existing code completion database&quot;);
-			
-			createNewRadioButton = new RadioButton (useExistingRadioButton, &quot;Create new code completion database&quot;);
-			createNewRadioButton.Active = true;
-			
-			skipCreationRadioButton = new RadioButton (useExistingRadioButton, &quot;Do not create code completion database now&quot;);
-			TextView t = new TextView ();
-			t.Buffer.Text = text;
-
-			t.WrapMode = Gtk.WrapMode.Word;
-			t.Editable = false;
-			t.CursorVisible = false;
-
-			mainVBox.PackStart (t);
-			mainVBox.PackStart (useExistingRadioButton, false, true, 6);
-			mainVBox.PackStart (createNewRadioButton, false, true, 6);
-			mainVBox.PackStart (skipCreationRadioButton, false, true, 6);
-			this.Add (mainVBox);
-			
-			// FIXME: use an event that is only fired once
-			skipCreationRadioButton.Toggled += new EventHandler(SetSuccessor);
-			createNewRadioButton.Toggled += new EventHandler(SetSuccessor);
-			useExistingRadioButton.Toggled += new EventHandler(SetSuccessor);
-		}
-	}
-}
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingFilePanel.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingFilePanel.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingFilePanel.cs	2004-02-14 15:59:03.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingFilePanel.cs	1970-01-01 10:00:00.000000000 +1000
@@ -1,93 +0,0 @@
-// &lt;file&gt;
-//     &lt;copyright see=&quot;<A HREF="prj:///doc/copyright.txt"/">prj:///doc/copyright.txt&quot;/</A>&gt;
-//     &lt;license see=&quot;<A HREF="prj:///doc/license.txt"/">prj:///doc/license.txt&quot;/</A>&gt;
-//     &lt;owner name=&quot;Mike Krüger&quot; email=&quot;<A HREF="mailto:mike@icsharpcode.net">mike@icsharpcode.net</A>&quot;/&gt;
-//     &lt;version value=&quot;$version&quot;/&gt;
-// &lt;/file&gt;
-
-using System;
-using System.IO;
-using Gtk;
-
-using ICSharpCode.SharpDevelop.Internal.Project;
-using ICSharpCode.Core.Properties;
-using ICSharpCode.Core.Services;
-
-using MonoDevelop.Gui.Widgets;
-using ICSharpCode.Core.AddIns.Codons;
-
-namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
-{
-	public class UseExistingFilePanel : AbstractWizardPanel
-	{
-		static FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-		IProperties properties;
-		FolderEntry fEntry;
-		
-		public override bool ReceiveDialogMessage(DialogMessage message)
-		{
-			switch (message) {
-				case DialogMessage.Activated:
-					SetFinishedState(this, EventArgs.Empty);
-					break;
-				case DialogMessage.Prev:
-					EnableFinish = false;
-					break;
-			}
-			return true;
-		}
-
-		void OnPathChanged (object sender, EventArgs e)
-		{
-			SetFinishedState (sender, e);
-		}
-		
-		void SetFinishedState(object sender, EventArgs e)
-		{
-			FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
-			string path = fEntry.Path;
-
-			EnableFinish = fileUtilityService.IsValidFileName(path) &amp;&amp;
-			               Directory.Exists(path) &amp;&amp; 
-			               File.Exists(fileUtilityService.GetDirectoryNameWithSeparator(path) + &quot;CodeCompletionProxyDataV02.bin&quot;);
-			if (EnableFinish) {
-				properties.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, path);
-				propertyService.SetProperty (&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, path);
-				propertyService.SaveProperties ();
-			}
-		}
-		
-		void SetValues(object sender, EventArgs e)
-		{
-			properties = (IProperties)CustomizationObject;
-		}
-		
-		static PropertyService propertyService = (PropertyService)ServiceManager.Services.GetService(typeof(PropertyService));
-		public UseExistingFilePanel()
-		{
-			IsLastPanel       = true;
-			ResourceService resourceService = (ResourceService)ServiceManager.Services.GetService(typeof(IResourceService));
-			
-			VBox mainVBox  = new VBox (false, 0);
-			
-			TextView textBox = new TextView ();
-			textBox.WrapMode = WrapMode.Word;
-			textBox.Buffer.Text = resourceService.GetString (&quot;Dialog.Wizards.CodeCompletionDatabaseWizard.UseExistingFilePanel.PanelDescription&quot;);
-			mainVBox.PackStart (textBox, false, true, 0);
-			mainVBox.PackStart (new Label (&quot;Specify location of existing code completion database.&quot;));
-			
-			fEntry = new FolderEntry (&quot;Select existing database location&quot;);
-			fEntry.DefaultPath = Environment.GetEnvironmentVariable (&quot;HOME&quot;);
-			fEntry.PathChanged += new EventHandler (OnPathChanged);
-
-			HBox hbox = new HBox (false, 0);
-			hbox.PackStart (fEntry, false, true, 0);
-			SetFinishedState(this, EventArgs.Empty);
-			CustomizationObjectChanged += new EventHandler(SetValues);
-			
-			mainVBox.PackStart (hbox, false, true, 6);
-			this.Add (mainVBox);
-		}
-	}
-}
-
diff -urN MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingGenerator.cs MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingGenerator.cs
--- MonoDevelop.pristine/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingGenerator.cs	1970-01-01 10:00:00.000000000 +1000
+++ MonoDevelop.changes/src/Main/Base/Gui/CompletionDatabaseWizard/UseExistingGenerator.cs	2004-02-25 00:45:32.000000000 +1100
@@ -0,0 +1,40 @@
+﻿using System;
+using System.IO;
+using Gtk;
+
+using ICSharpCode.SharpDevelop.Internal.Project;
+using ICSharpCode.Core.Properties;
+using ICSharpCode.Core.Services;
+using ICSharpCode.SharpDevelop.Services;
+
+using ICSharpCode.Core.AddIns.Codons;
+
+namespace ICSharpCode.SharpDevelop.Gui.Dialogs.OptionPanels.CompletionDatabaseWizard
+{
+	public class UseExistingDBGenerator : IDatabaseGenerator
+	{
+		public string Path;
+		// changed to work during GLib.Idle
+		public void Generate(IProgressMonitor progress)
+		{
+			progress.BeginTask(&quot;Referencing existing database&quot;, 2);
+			FileUtilityService fileUtilityService = (FileUtilityService)ServiceManager.Services.GetService(typeof(FileUtilityService));
+
+			if (!fileUtilityService.IsValidFileName(Path))
+				throw new PathNotCodeCompletionDatabaseException(Path + &quot; is not a valid file name\n&quot;);
+			if (!Directory.Exists(Path))
+				throw new PathNotCodeCompletionDatabaseException(&quot;Directory &quot; + Path + &quot; does not exist&quot;);
+			if (!File.Exists(fileUtilityService.GetDirectoryNameWithSeparator(Path) + &quot;CodeCompletionProxyDataV02.bin&quot;))
+				throw new PathNotCodeCompletionDatabaseException(Path + &quot; does not contain valid code completion data&quot;);
+
+
+			PropertyService propertyService = (PropertyService) ServiceManager.Services.GetService (typeof(PropertyService));
+			IProperties properties = (IProperties)propertyService;
+
+			properties.SetProperty(&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, Path);
+			propertyService.SetProperty (&quot;SharpDevelop.CodeCompletion.DataDirectory&quot;, Path);
+			propertyService.SaveProperties ();
+			progress.Worked(2, &quot;Referenced existing database&quot;);
+		}
+	}
+}
diff -urN MonoDevelop.pristine/src/Main/Base/Makefile.am MonoDevelop.changes/src/Main/Base/Makefile.am
--- MonoDevelop.pristine/src/Main/Base/Makefile.am	2004-02-22 16:16:51.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Makefile.am	2004-02-25 00:45:32.000000000 +1100
@@ -120,11 +120,13 @@
 ./Gui/PadContentCollection.cs \
 ./Gui/PixbufList.cs \
 ./Gui/AbstractSecondaryViewContent.cs \
-./Gui/CompletionDatabaseWizard/CreateDatabasePanel.cs \
-./Gui/CompletionDatabaseWizard/CreationFinishedPanel.cs \
-./Gui/CompletionDatabaseWizard/UseExistingFilePanel.cs \
-./Gui/CompletionDatabaseWizard/SetupPanel.cs \
-./Gui/CompletionDatabaseWizard/ChooseLocationPanel.cs \
+./Gui/CompletionDatabaseWizard/CreateDBGenerator.cs \
+./Gui/CompletionDatabaseWizard/CreatingGenerator.cs \
+./Gui/CompletionDatabaseWizard/GenerateDatabase.cs \
+./Gui/CompletionDatabaseWizard/druid.cs \
+./Gui/CompletionDatabaseWizard/Exceptions.cs \
+./Gui/CompletionDatabaseWizard/IDatabaseGenerator.cs \
+./Gui/CompletionDatabaseWizard/UseExistingGenerator.cs \
 ./Gui/ViewContentCollection.cs \
 ./Gui/IWorkbenchWindow.cs \
 ./Gui/HtmlControl/IHTMLDocument2.cs \
diff -urN MonoDevelop.pristine/src/Main/Base/Services/ParserService/DefaultParserService.cs MonoDevelop.changes/src/Main/Base/Services/ParserService/DefaultParserService.cs
--- MonoDevelop.pristine/src/Main/Base/Services/ParserService/DefaultParserService.cs	2004-02-18 13:10:33.000000000 +1100
+++ MonoDevelop.changes/src/Main/Base/Services/ParserService/DefaultParserService.cs	2004-02-25 00:45:32.000000000 +1100
@@ -132,6 +132,16 @@
 				this.myClass           = c;
 			}
 		}
+
+		private bool ContinueWithProcess(IProgressMonitor progressMonitor)
+		{
+			while (Gtk.Application.EventsPending ())
+				Gtk.Application.RunIteration ();
+			if (progressMonitor.Canceled)
+				return false;
+			else
+				return true;
+		}
 		
 		public void GenerateCodeCompletionDatabaseFast(string createPath, IProgressMonitor progressMonitor)
 		{
@@ -167,10 +177,14 @@
 					if (progressMonitor != null) {
 						progressMonitor.Worked(i, &quot;Writing database...&quot;);
 					}
+					if (!ContinueWithProcess(progressMonitor))
+						return;
 				} catch (Exception e) {
 					Console.WriteLine(e.ToString());
 				}
 				System.GC.Collect();
+				if (!ContinueWithProcess(progressMonitor))
+					return;
 			}
 
 			classWriter.Close();
@@ -204,6 +218,8 @@
 					Console.WriteLine(e.ToString());
 				}
 				System.GC.Collect();
+				if (!ContinueWithProcess(progressMonitor))
+					return;
 			}
 					
 			// create all class proxies
@@ -216,6 +232,8 @@
 				if (progressMonitor != null) {
 					progressMonitor.Worked(assemblyList.Length + (i * assemblyList.Length) / frameworkAssemblyInformation.Classes.Count, &quot;Generating database...&quot;);
 				}
+				if (!ContinueWithProcess(progressMonitor))
+					return;
 			}
 
 			// write all classes and proxies to the disc
@@ -232,6 +250,8 @@
 				if (progressMonitor != null) {
 					progressMonitor.Worked(2 * assemblyList.Length + (i * assemblyList.Length) / frameworkAssemblyInformation.Classes.Count, &quot;Writing database...&quot;);
 				}
+				if (!ContinueWithProcess(progressMonitor))
+					return;
 			}
 
 			classWriter.Close();

--=-K6ciL4OLYw5iLsU1LePL--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000237.html">[MonoDevelop] compilation error
</A></li>
	<LI> Next message: <A HREF="000244.html">[MonoDevelop] code completion database druid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#242">[ date ]</a>
              <a href="thread.html#242">[ thread ]</a>
              <a href="subject.html#242">[ subject ]</a>
              <a href="author.html#242">[ author ]</a>
         </LI>
       </UL>
</body></html>
