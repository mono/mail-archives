<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoDevelop] Import Visual Studio .NET Projects
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:dean%40brettle.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001778.html">
   <LINK REL="Next"  HREF="001765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoDevelop] Import Visual Studio .NET Projects
   </H1>
    <B>Dean Brettle
    </B> 
    <A HREF="mailto:dean%40brettle.com"
       TITLE="[MonoDevelop] Import Visual Studio .NET Projects">dean@brettle.com
       </A><BR>
    <I>Thu, 17 Mar 2005 09:13:13 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001778.html">[MonoDevelop] Import Visual Studio .NET Projects
</A></li>
        <LI> Next message: <A HREF="001765.html">[MonoDevelop] [Patch] Small fixes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1783">[ date ]</a>
              <a href="thread.html#1783">[ thread ]</a>
              <a href="subject.html#1783">[ subject ]</a>
              <a href="author.html#1783">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-cQ5dz9MiEZTTKBvz7WYa
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

On Wed, 2005-03-16 at 07:56 -0600, Francisco T. Martinez wrote:
&gt;<i> OK.  I have a decent cure for a lot of ailments in the included patch. 
</I>
Cool!

&gt;<i> Some of the highlights here are:
</I>&gt;<i> 
</I>&gt;<i> * Mono 2.0 has been commented out until further notice.
</I>
Excellent.  That makes all the refs refer to the mono-1.0 assemblies,
which means that I no longer need support for mono-2.0 in order to
import and build cleanly.  Unfortunately, there are still 2 other issues
blocking a clean import and build.

First, one of the projects I'm importing references .\bin
\&lt;AssemblyName&gt;.dll.  The attached patch (to be applied after
Francisco's patch) causes that reference to be converted to an Assembly
reference (with a relative path) instead of a GAC reference.

Second, there is the case-insensitivity issue I've logged at:
<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=73697">http://bugzilla.ximian.com/show_bug.cgi?id=73697</A>
At first, I thought this was a very rare issue, but I've had to
workaround it in 3 of the 13 projects I've imported.  Would a fix
similar to what I describe in the bug be considered for inclusion or
does anyone have a better idea?

Thanks,

--Dean



--=-cQ5dz9MiEZTTKBvz7WYa
Content-Disposition: attachment; filename=monodevelop-relative-assemblies.patch
Content-Type: text/x-patch; name=monodevelop-relative-assemblies.patch; charset=ANSI_X3.4-1968
Content-Transfer-Encoding: 7bit

--- MsPrjHelper.cs.orig	2005-03-16 23:23:02.000000000 -0500
+++ MsPrjHelper.cs	2005-03-17 08:58:37.000000000 -0500
@@ -454,7 +454,11 @@
 				);
 			
 			// convert backslashes to slashes    		
-			csprojFileName = csprojFileName.Replace(&quot;\\&quot;, &quot;/&quot;);			
+			csprojFileName = csprojFileName.Replace('\\', Path.DirectorySeparatorChar);			
+			string csprojDirName = Path.GetDirectoryName(csprojFileName);
+			if (csprojDirName == null) {
+				csprojDirName = Path.GetPathRoot(csprojFileName);
+			} 
 			Console.WriteLine(String.Format(&quot;Will create project filename:{0}&quot;, PrjxFileName));
 
 			// Load the csproj
@@ -472,7 +476,7 @@
 			prjxObj.projecttype = &quot;C#&quot;;
 
 			prjxObj.Contents = GetContents (csprojObj.CSHARP.Files.Include);
-			prjxObj.References = GetReferences(csprojObj.CSHARP.Build.References);
+			prjxObj.References = GetReferences(csprojObj.CSHARP.Build.References, csprojDirName);
 			prjxObj.DeploymentInformation = new MonoDevelop.Prj2Make.Schema.Prjx.DeploymentInformation();
 			prjxObj.DeploymentInformation.target = &quot;&quot;;
 			prjxObj.DeploymentInformation.script = &quot;&quot;;
@@ -627,7 +631,7 @@
 			}
 		}
 
-		protected MonoDevelop.Prj2Make.Schema.Prjx.Reference[] GetReferences(MonoDevelop.Prj2Make.Schema.Csproj.Reference[] References)
+		protected MonoDevelop.Prj2Make.Schema.Prjx.Reference[] GetReferences(MonoDevelop.Prj2Make.Schema.Csproj.Reference[] References, string csprojDirName)
 		{
 			MonoDevelop.Prj2Make.Schema.Prjx.Reference[] theReferences = null;
 			int i = 0;
@@ -806,8 +810,19 @@
 						
 						if(bIsWhereExpected == false)
 						{
-							rfOut.refto = Path.GetFileName(rf.HintPath);
-							rfOut.type = MonoDevelop.Prj2Make.Schema.Prjx.ReferenceType.Gac;
+							// It's not in a standard location.  If it's actually at the location specified 
+							// by the HintPath, add an Assembly reference instead of a GAC reference.
+							// This makes relative references to assemblies work.  If it's not at the
+							// HintPath, add a GAC reference.  The user can then add it to one of the 
+							// standard locations later.
+							string assemblyPath = rf.HintPath.Replace('\\', Path.DirectorySeparatorChar);
+							if (System.IO.File.Exists(Path.Combine(csprojDirName, assemblyPath))) {
+								rfOut.refto = assemblyPath;
+								rfOut.type = MonoDevelop.Prj2Make.Schema.Prjx.ReferenceType.Assembly;
+							} else {
+								rfOut.refto = Path.GetFileName(rf.HintPath);
+								rfOut.type = MonoDevelop.Prj2Make.Schema.Prjx.ReferenceType.Gac;
+							}
 							rfOut.localcopy = MonoDevelop.Prj2Make.Schema.Prjx.ReferenceLocalcopy.True;
 							// increment the iterator value
 							theReferences[i++] = rfOut;

--=-cQ5dz9MiEZTTKBvz7WYa--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001778.html">[MonoDevelop] Import Visual Studio .NET Projects
</A></li>
	<LI> Next message: <A HREF="001765.html">[MonoDevelop] [Patch] Small fixes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1783">[ date ]</a>
              <a href="thread.html#1783">[ thread ]</a>
              <a href="subject.html#1783">[ subject ]</a>
              <a href="author.html#1783">[ author ]</a>
         </LI>
       </UL>
</body></html>
