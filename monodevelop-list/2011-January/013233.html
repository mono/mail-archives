<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoDevelop] Custom tools on multiple files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20Custom%20tools%20on%20multiple%20files&In-Reply-To=4D246BE9.4040407%40initd.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013224.html">
   <LINK REL="Next"  HREF="013240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoDevelop] Custom tools on multiple files</H1>
    <B>Michael Hutchinson</B> 
    <A HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20Custom%20tools%20on%20multiple%20files&In-Reply-To=4D246BE9.4040407%40initd.org"
       TITLE="[MonoDevelop] Custom tools on multiple files">m.j.hutchinson at gmail.com
       </A><BR>
    <I>Wed Jan  5 19:29:58 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="013224.html">[MonoDevelop] Custom tools on multiple files
</A></li>
        <LI>Next message: <A HREF="013240.html">[MonoDevelop] Custom tools on multiple files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13233">[ date ]</a>
              <a href="thread.html#13233">[ thread ]</a>
              <a href="subject.html#13233">[ subject ]</a>
              <a href="author.html#13233">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Jan 5, 2011 at 8:02 AM, Federico Di Gregorio &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-list">fog at initd.org</A>&gt; wrote:
&gt;<i> On 04/01/2011 21:40, Michael Hutchinson wrote:
</I>&gt;<i> [snip]
</I>&gt;&gt;<i> Doing it via xbuild is possibly better because it will work with
</I>&gt;&gt;<i> xbuild, msbuild and VS, but currently will only work with MD if you
</I>&gt;&gt;<i> enable &quot;experimental xbuild support&quot;. Fo this, you simply need a
</I>&gt;&gt;<i> custom targets file. Define a custom target and inject its name into
</I>&gt;&gt;<i> the PrepareForRunDependsOn property. Its inputs would be
</I>&gt;&gt;<i> @(YourBuildAction) - the entire set of items with that action. Your
</I>&gt;&gt;<i> target can then invoke a task - either Exec or some custom task - to
</I>&gt;&gt;<i> do the compile. You may also wish to add the generated file to the
</I>&gt;&gt;<i> FileWrites items so it gets removed by a Clean.
</I>&gt;<i>
</I>&gt;<i> We're already using xbuild so I think I'll go for this one.
</I>&gt;<i>
</I>&gt;<i> I already have some code that implementes ITask and does the packing but
</I>&gt;<i> right now, to test it, I wrote che XML csproj by hand. If I understand
</I>&gt;<i> it correctly I need to have my MD addin add to the project two items:
</I>&gt;<i>
</I>&gt;<i> 1/ &lt;UsingTask&gt; to locate my task assmbly
</I>&gt;<i> 2/ &lt;CssPack&gt; items inside an &lt;ItemGroup&gt;
</I>&gt;<i>
</I>&gt;<i> What's the best way of doing that? It is possible to add properties to
</I>&gt;<i> file types already managed by MD (like css, XML or js)?
</I>
It would be cleaner to have a targets file that you can easily import
into multiple project.

Suppose your project has to define a property for the packed css name:

&lt;PropertyGroup&gt;
        &lt;PackedCssFile&gt;$(OutDir)\packed.css&lt;/PackedCssFile&gt;
&lt;/PropertyGroup&gt;

Then some items:

&lt;ItemGroup&gt;
    &lt;PackableCssFile Include=&quot;Foo.css&quot; /&gt;
    &lt;PackableCssFile Include=&quot;Bar.css&quot; /&gt;
&lt;/ItemGroup&gt;

then import your targets:

&lt;Import Project=&quot;Path\ToSomeCompany.Custom.targets&quot; \&gt;

You could use an absolute or relative path, or use $(MSBuildBinPath)
and install the target file into the shared targets directory.

Your targets file will first pull in your task assembly:

&lt;UsingTask TaskName=&quot;SomeCompany.PackCss&quot;
AssemblyFile=&quot;SomeCompany.PackCss.dll&quot; /&gt;

Then redefine PrepareForRunDependsOn to inject a custom target into
the build sequence, but only if the project has defined the property
and items:

&lt;PropertyGroup Condition=&quot; '$(PackedCssFile)' != '' And
'@(PackableCssFile)' != '' &quot;&gt;
        &lt;PrepareForRunDependsOn&gt;PackCss;$(PrepareForRunDependsOn)&lt;/PrepareForRunDependsOn&gt;
&lt;/PropertyGroup&gt;

Then define your targets. The first one it always runs if it's in the
build sequence, and simply adds the output file to FileWrites, which
means it magically gets cleaned automatically, even if its name
changes.

&lt;Target Name=&quot;PackCss&quot; DependsOnTargets=&quot;_PackCss&quot;&gt;
        &lt;CreateItem Include=&quot;$(PackedCssFile)&quot;
Condition=&quot;Exists('$(PackedCssFile)')&quot;&gt;
                &lt;Output TaskParameter=&quot;Include&quot; ItemName=&quot;FileWrites&quot; /&gt;
        &lt;/CreateItem&gt;
&lt;/Target&gt;

Note the ugly CreateItem MSBuild 2.0 syntax. Unfortunately xbuild does
not yet support the MSBuild 3.5 feature to allow defining ItemGroups
and PropertyGroups within targets, else we would have done

&lt;Target Name=&quot;PackCss&quot; DependsOnTargets=&quot;_PackCss&quot;&gt;
        &lt;ItemGroup Condition=&quot;Exists('$(PackedCssFile)')&quot;&gt;
                &lt;FileWrites Include=&quot;$(PackedCssFile)&quot; /&gt;
        &lt;/ItemGroup&gt;
&lt;/Target&gt;

The task we defined above depends on the real target, which has
specified input and output files, so the targets will be skipped
entirely if the outputs are newer than the inputs. This target invokes
your task:

&lt;Target Name=&quot;_PackCss&quot;
Inputs=&quot;$(MSBuildAllProjects);@(PackableCssFiles)&quot;
Outputs=&quot;$(PackedCssFile)&quot; &gt;
        &lt;PackCss SourceFiles=&quot;$(PackableCssFiles)&quot; Output=&quot;$(PackedCssFile)&quot; /&gt;
&lt;/Target&gt;

In answer to your second question, yes, you can add arbitrary metadata
to items in MD, though you cannot edit them in the GUI unless you
write a propertygrid extender.

For example, you could have

&lt;CssFile Include=&quot;Foo.css&quot;&gt;
    &lt;PackInto&gt;SomePackedFile.css&lt;/PackInto&gt;
&lt;/CssFile&gt;

Then write more complex targets that would aggregate items with
identical &quot;PackInto&quot; metadata and therefore be able to pack into
multiple files. That would be considerable more complex though.

Or you could define the packed files as items (though they would then
show up in the project) and have each define a set of sources. Easy to
implement, but somewhat messy to use.

&lt;PackedCssFile Include=&quot;SomePackedFile.css&quot;&gt;
    &lt;Sources&gt;Foo.css;Bar.css&lt;/Sources&gt;
&lt;/PackedCssFile&gt;

-- 
Michael Hutchinson
<A HREF="http://mjhutchinson.com">http://mjhutchinson.com</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013224.html">[MonoDevelop] Custom tools on multiple files
</A></li>
	<LI>Next message: <A HREF="013240.html">[MonoDevelop] Custom tools on multiple files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13233">[ date ]</a>
              <a href="thread.html#13233">[ thread ]</a>
              <a href="subject.html#13233">[ subject ]</a>
              <a href="author.html#13233">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-list">More information about the Monodevelop-list
mailing list</a><br>
</body></html>
