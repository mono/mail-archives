<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoDevelop] Questions about auto-indent and code completion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20Questions%20about%20auto-indent%20and%20code%20completion&In-Reply-To=1242903795.4312.13.camel%40erin">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009751.html">
   <LINK REL="Next"  HREF="009753.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoDevelop] Questions about auto-indent and code completion</H1>
    <B>Michael Hutchinson</B> 
    <A HREF="mailto:monodevelop-list%40lists.ximian.com?Subject=%5BMonoDevelop%5D%20Questions%20about%20auto-indent%20and%20code%20completion&In-Reply-To=1242903795.4312.13.camel%40erin"
       TITLE="[MonoDevelop] Questions about auto-indent and code completion">m.j.hutchinson at gmail.com
       </A><BR>
    <I>Fri May 22 17:08:59 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="009751.html">[MonoDevelop] Questions about auto-indent and code completion
</A></li>
        <LI>Next message: <A HREF="009753.html">[MonoDevelop] Own addin: missing menu item after second start of MD
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9765">[ date ]</a>
              <a href="thread.html#9765">[ thread ]</a>
              <a href="subject.html#9765">[ subject ]</a>
              <a href="author.html#9765">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2009/5/21 Federico Di Gregorio &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodevelop-list">fog at initd.org</A>&gt;:
&gt;<i> Hi *,
</I>&gt;<i>
</I>&gt;<i> while working on my Flex Binding addin for MD I ended up with several
</I>&gt;<i> questions about auto-indent and code completion. I use as a model both
</I>&gt;<i> PyBinding (quite simple) and CSharpBinding (quite complex). I now have
</I>&gt;<i> an indentation engine based on IDocumentStateEngine (just like C# does)
</I>&gt;<i> but before going on with completion (that requires a parser) I have a
</I>&gt;<i> couple of questions I'd like to ask.
</I>&gt;<i>
</I>&gt;<i> First of all, is this the correct way to go? Or there are other, new
</I>&gt;<i> ways to implement auto-indent and completion?
</I>&gt;<i>
</I>&gt;<i> Then, given that a parser is needed for completion would make sense to
</I>&gt;<i> keep a parse tree in memory and have a single addin manage both indent
</I>&gt;<i> and completion based on that tree?
</I>
Yes, that would make sense.

Here's the brief history of the current system:

Jeff wrote the smart indenter's mini-parser for MD 1.0 as a relatively
simplistic, forward-only, character-by-character parser, the idea
being that as you typed, it would only have to parse each character
you typed. The &quot;real&quot; C# parser was only invoked in certain
situations, e.g. on the &quot;.&quot; character, and at these times, it would
parse the whole document from the beginning -- as you can imagine,
this didn't scale well at all. As such, it couldn't be used by the
smart indenter.

Unfortunately, the smart indenter had *huge* performance issues going
*backwards* in large documents, e.g. backspace or navigation, because
this caused it to reparse from the beginning on every keystroke. In
fixing this bug, I wrote the DocumentStateEngine. This snapshots the
state of the parser every few hundred characters, to make the
backwards movement a near-constant cost, instead of rising with
document size.

For MD2, Mike rewrote the C# completion engine to perform aggressive
completion. None of use are happy with the smart indenter, but we
didn't have time to replace it, so we took advantage of its state to
limit the triggering of the C# completion parser, so that e.g. it's
not invoked inside of string or comments. One of the really expensive
things in the MD1 completion parser was parsing the whole document to
determine whether it was inside a string or comment -- since the
current parser doesn't have to do this, it can just backtrack to the
start of the member (I'm not sure if it does this yet, but it
certainly avoids the full string/comment check).

So, basically, the reason we have two parsers is because we haven't
had time to consolidate them... the &quot;real&quot; parser is more accurate and
has more info, but is expensive and doesn't recover from errors well.
The smart indenter provides cheap&amp;robust state info, and right now
it's easier to use that.

Note that the parser service is *already* parsing every document in a
thread, so you have the ParsedDocument is memory already. Although
it's a little out of date (by a few seconds), this should be good
enough to recover some local state in most cases. Also, the text
editor's highlighting engine has state.

Ultimately I'd probably like to use the text editor's highlighting
state to determine if we're in a comment or string, then use the
parser service's current parsed document to find the end the previous
current class/member, and use the real parser from there, on every
keystroke, for both indenting and completion. Assuming the parser
thread is parsing the whole document every few seconds, this should
work pretty smoothly.

For XML/HTML/XAML/ASP.NET completion, I wrote a single parser that
could be used by a DocumentStateTracker but had enough state for
completion too. However, an XML parser is quite a bit simpler than a
C# parser. I still wonder whether using the current ParsedDocument to
find the end of the previous tag instead would be better than
DocumentStateTracker. Maintaining a ton of state snapshots in addition
to the ParsedDocument seems kinda wasteful. Sometime I'll get round to
profiling it.

In summary, because you have a clean slate, you can do it however you
want, but I hope this helps you decide what will work best :-)

&gt;<i> And finally, does MD editor support for nested modes? MXML files are XML
</I>&gt;<i> files that can contains &lt;mx:Script&gt; blocks and I'd like to switch from
</I>&gt;<i> XML indent (with MXML tags completion) to ActionScript 3 inside the
</I>&gt;<i> script blocks.
</I>
Not yet, but I've been pestering Mike to add this support so I can use
it for ASP.NET.

-- 
Michael Hutchinson
<A HREF="http://mjhutchinson.com">http://mjhutchinson.com</A>
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009751.html">[MonoDevelop] Questions about auto-indent and code completion
</A></li>
	<LI>Next message: <A HREF="009753.html">[MonoDevelop] Own addin: missing menu item after second start of MD
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9765">[ date ]</a>
              <a href="thread.html#9765">[ thread ]</a>
              <a href="subject.html#9765">[ subject ]</a>
              <a href="author.html#9765">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-list">More information about the Monodevelop-list
mailing list</a><br>
</body></html>
