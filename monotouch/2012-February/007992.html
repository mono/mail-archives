<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Why%20is%20the%20MonoTouch%20version%20of%20this%20Mandelbrot%20Set%0A%20test%202.8%20times%20slower%3F&In-Reply-To=%3C74F8A26D96EB384B822652EABB938F6D1660EC75%40VNDSRV22.corp.infosupport.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007986.html">
   <LINK REL="Next"  HREF="007987.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?</H1>
    <B>Roy Cornelissen</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Why%20is%20the%20MonoTouch%20version%20of%20this%20Mandelbrot%20Set%0A%20test%202.8%20times%20slower%3F&In-Reply-To=%3C74F8A26D96EB384B822652EABB938F6D1660EC75%40VNDSRV22.corp.infosupport.com%3E"
       TITLE="[MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?">royc at infosupport.com
       </A><BR>
    <I>Wed Feb 15 12:57:01 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="007986.html">[MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?
</A></li>
        <LI>Next message: <A HREF="007987.html">[MonoTouch] Touches are  recognized with delay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7992">[ date ]</a>
              <a href="thread.html#7992">[ thread ]</a>
              <a href="subject.html#7992">[ subject ]</a>
              <a href="author.html#7992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rolf,

Thanks for having a look at this. Goes to show that having a second look helps. I wasn't aware of the 100x loop, totally overlooked that, DOH!

Anyway, your clarification helps a lot, so thanks for that!

Regards, Roy

From: Rolf Bjarne Kvinge [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">rolf at xamarin.com</A>]
Sent: woensdag 15 februari 2012 13:41
To: Roy Cornelissen
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">monotouch at lists.ximian.com</A>
Subject: Re: [MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?

Hi,

I tried your projects, and got somewhat different results (on an iPad2).

Objective-C implementation: 0,296s
MonoTouch (release mode): 0,677s
MonoTouch (release mode, with LLVM enabled): 0,397

So just MonoTouch release mode is 2.3x times slower, but once you enable LLVM, this goes down to 1.34x slower.

I also noticed that BitmapContext.FillRect is called a lot (39635 times), so I commented it out and now I get these timings:
Objective-C implementation: 0,224s
MonoTouch (LLVM enabled): 0,293s

So just calling FillRect 39635 times takes 0,072s in ObjC and 0,104s with MonoTouch - the discrepancy is due to the fact that the MonoTouch version obviously has to do more work (it has to do a managed-to-native transition (and back again)). So now MonoTouch is 1.31x slower.

The point is that LLVM mode is exactly for this kind of cpu intensitive tasks, since our jit doesn't generate as optimized code as the LLVM one can.

Now I started looking a bit deeper, and realized that the loop in IsInMandelbrotSet loops 100 times in the MonoTouch version and only 50 times in the ObjC version. Redoing the tests in MonoTouch, but this time only looping 50 times, I get this:

MonoTouch (LLVM enabled): 0,290s.
Yes, that's correct. The MonoTouch (with LLVM) version is actually 1% faster than the ObjectiveC version with identical code.

And as shown this difference can probably be increased (by not calling FillRect 40k times, but perhaps manually create the bitmap in managed memory and then draw the bitmap with one call - this change would likely benefit both implementations, but it would benefit MonoTouch most).

I hope this helps :)

Rolf

On Wed, Feb 15, 2012 at 10:14 AM, RoyCornelissen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">royc at infosupport.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">royc at infosupport.com</A>&gt;&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Just as a little exercise I decided to try out a Mandelbrot test in
</I>&gt;<i> MonoTouch just to have a look at performance. I took this Objective-C
</I>&gt;<i> implementation  <A HREF="https://github.com/ddeville/Mandelbrot-set-on-iPhone">https://github.com/ddeville/Mandelbrot-set-on-iPhone</A> on
</I>&gt;<i> GitHub  as a basis and ported the implementation of the view 1-to-1 to
</I>&gt;<i> MonoTouch. Because of some differences in API not all of the code is 100%
</I>&gt;<i> the same, and I'm no CoreGraphics expert, but as far as I know this looks
</I>&gt;<i> OK. The MonoTouch implementation can be found here
</I>&gt;<i> <A HREF="http://dl.dropbox.com/u/1135505/MonobrotSet.zip">http://dl.dropbox.com/u/1135505/MonobrotSet.zip</A>
</I>&gt;<i>
</I>&gt;<i> Now when I run this on my iPhone, the MonoTouch version is 2.8 times slower
</I>&gt;<i> than the Objective-C version, specifically the part where the Mandelbrot Set
</I>&gt;<i> is drawn in the bitmap. Objective-C takes ~0.99 seconds, MonoTouch ~2.8
</I>&gt;<i> seconds.
</I>&gt;<i>
</I>&gt;<i> Can anyone help explain where the overhead is coming from? Is there anything
</I>&gt;<i> I could have done to make this faster given the reference implementation in
</I>&gt;<i> Objective-C? I'm not looking for a faster Mandelbrot algorithm but merely
</I>&gt;<i> trying to explain what is making the big difference. Or did I make a mistake
</I>&gt;<i> in translating the Objective-C code to MonoTouch?
</I>&gt;<i>
</I>&gt;<i> Here's the C# code that does the work, I tried to stay as close as possible
</I>&gt;<i> to the Objective-C implementation of the view
</I>&gt;<i> <A HREF="https://github.com/ddeville/Mandelbrot-set-on-iPhone/blob/master/Classes/MandelbrotView.m">https://github.com/ddeville/Mandelbrot-set-on-iPhone/blob/master/Classes/MandelbrotView.m</A>
</I>&gt;<i> (link)
</I>&gt;<i>
</I>&gt;<i>        [Register(&quot;MandelbrotView&quot;)]
</I>&gt;<i>        public class MandelbrotView: UIView
</I>&gt;<i>        {
</I>&gt;<i>                private const int MANDELBROT_STEPS = 50;
</I>&gt;<i>
</I>&gt;<i>                public MandelbrotView ()
</I>&gt;<i>                {
</I>&gt;<i>                        Initialize();
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                public MandelbrotView(IntPtr handle): base (handle)
</I>&gt;<i>                {
</I>&gt;<i>                        Initialize();
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                public override void Draw (System.Drawing.RectangleF rect)
</I>&gt;<i>                {
</I>&gt;<i>                        DateTime reference = DateTime.Now;
</I>&gt;<i>
</I>&gt;<i>                        // get an image representation of the bitmap context
</I>&gt;<i>                        var image = _bitmapContext.ToImage();
</I>&gt;<i>
</I>&gt;<i>                        // draw the image in the current context
</I>&gt;<i>                        var context = UIGraphics.GetCurrentContext();
</I>&gt;<i>                        context.DrawImage(rect, image);
</I>&gt;<i>
</I>&gt;<i>                        // release the image
</I>&gt;<i>                        image.Dispose();
</I>&gt;<i>
</I>&gt;<i>                        Console.WriteLine(&quot;draw rect duration = {0}&quot;, (DateTime.Now -
</I>&gt;<i> reference).TotalMilliseconds / 1000);
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                private CGBitmapContext _bitmapContext;
</I>&gt;<i>
</I>&gt;<i>                private void Initialize ()
</I>&gt;<i>                {
</I>&gt;<i>                        Console.WriteLine(&quot;MonoTouch Mandelbrot implementation&quot;);
</I>&gt;<i>                        var reference = DateTime.Now;
</I>&gt;<i>
</I>&gt;<i>                        // instantiate the bitmap context
</I>&gt;<i>                        _bitmapContext = CreateCustomBitmapContextWithSize(new SizeF(480.0f,
</I>&gt;<i> 320.0f));
</I>&gt;<i>
</I>&gt;<i>                        Console.WriteLine(&quot;bitmap context creation duration = {0}&quot;, (DateTime.Now
</I>&gt;<i> - reference).TotalMilliseconds / 1000);
</I>&gt;<i>                        reference = DateTime.Now;
</I>&gt;<i>
</I>&gt;<i>                        // draw the Mandelbrot Set
</I>&gt;<i>                        var center =  new PointF(this.Center.Y, this.Center.X);
</I>&gt;<i>                        DrawMandelbrot(center, 1);
</I>&gt;<i>
</I>&gt;<i>                        Console.WriteLine(&quot;drawing mandelbrot in bitmap duration = {0}&quot;,
</I>&gt;<i> (DateTime.Now - reference).TotalMilliseconds / 1000);
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                private CGBitmapContext CreateCustomBitmapContextWithSize(SizeF size)
</I>&gt;<i>                {
</I>&gt;<i>                        CGBitmapContext context = null ;
</I>&gt;<i>
</I>&gt;<i>                        var bitmapBytesPerRow = (size.Width * 4) ;
</I>&gt;<i>                        bitmapBytesPerRow += (16 - bitmapBytesPerRow%16)%16 ;
</I>&gt;<i>
</I>&gt;<i>                        var bitmapByteCount = (bitmapBytesPerRow * size.Height) ;
</I>&gt;<i>
</I>&gt;<i>                        CGColorSpace colorSpace = CGColorSpace.CreateDeviceRGB();
</I>&gt;<i>
</I>&gt;<i>                        var bitmapData = new byte[(int) bitmapByteCount];
</I>&gt;<i>
</I>&gt;<i>                        context = new CGBitmapContext(bitmapData, (int) size.Width, (int)
</I>&gt;<i> size.Height, 8, (int) bitmapBytesPerRow, colorSpace,
</I>&gt;<i> CGBitmapFlags.PremultipliedLast);
</I>&gt;<i>
</I>&gt;<i>                        if (context == null)
</I>&gt;<i>                        {
</I>&gt;<i>                                bitmapData = null;
</I>&gt;<i>                                Console.WriteLine(&quot;Context not created!&quot;);
</I>&gt;<i>                                return null;
</I>&gt;<i>                        }
</I>&gt;<i>
</I>&gt;<i>                        return context;
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                private void DrawMandelbrot(PointF center, float zoom)
</I>&gt;<i>                {
</I>&gt;<i>                        _bitmapContext.SetAllowsAntialiasing(false);
</I>&gt;<i>                        _bitmapContext.SetRGBFillColor(0.0f, 0.0f, 0.0f, 1.0f);
</I>&gt;<i>
</I>&gt;<i>                        float re;
</I>&gt;<i>                        float im;
</I>&gt;<i>
</I>&gt;<i>                        // mapping the bounding box to pixels
</I>&gt;<i>
</I>&gt;<i>                        // zoom 1 has to be between -2 and 1 and -1 to 1
</I>&gt;<i>                        // any additional zoom divides these by the zoom
</I>&gt;<i>
</I>&gt;<i>                        // loop through every pixel of the frame...
</I>&gt;<i>                        for (int i = 0 ; i &lt; 480 ; i++)
</I>&gt;<i>                        {
</I>&gt;<i>                                for (int j = 0 ; j &lt; 320 ; j++)
</I>&gt;<i>                                {
</I>&gt;<i>                                        re = (((float)i - 1.33f * center.X)/160) ;      // -2 to 1      -       screen width  =
</I>&gt;<i> 480
</I>&gt;<i>                                        im = (((float)j - 1.00f * center.Y)/160) ;      // -1 to 1      -       screen height =
</I>&gt;<i> 320
</I>&gt;<i>
</I>&gt;<i>                                        re /= zoom ;
</I>&gt;<i>                                        im /= zoom ;
</I>&gt;<i>
</I>&gt;<i>                                        if (IsInMandelbrotSet(re, im))
</I>&gt;<i>                                        {
</I>&gt;<i>                                                _bitmapContext.FillRect(new RectangleF(i, j, 1.0f, 1.0f));
</I>&gt;<i>                                        }
</I>&gt;<i>                                }
</I>&gt;<i>                        }
</I>&gt;<i>                }
</I>&gt;<i>
</I>&gt;<i>                private bool IsInMandelbrotSet(float re, float im)
</I>&gt;<i>                {
</I>&gt;<i>                        float x = 0 ;   float nx ;
</I>&gt;<i>                        float y = 0 ;   float ny ;
</I>&gt;<i>                        bool fl = true;
</I>&gt;<i>                        for(int i = 0 ; i &lt; MANDELBROT_STEPS ; i++)
</I>&gt;<i>                        {
</I>&gt;<i>                                // We calculate the real part of the sequence
</I>&gt;<i>                                nx = x*x - y*y + re ;
</I>&gt;<i>                                // We calculate the imaginary part of the sequence
</I>&gt;<i>                                ny = 2*x*y + im ;
</I>&gt;<i>                                // We compute the magnitude at each step
</I>&gt;<i>                                // We check if it's greater than 2
</I>&gt;<i>                                if((nx*nx + ny*ny) &gt; 4)
</I>&gt;<i>                                {
</I>&gt;<i>                                        fl = false ;
</I>&gt;<i>                                        break ;
</I>&gt;<i>                                }
</I>&gt;<i>                                x = nx ;
</I>&gt;<i>                                y = ny ;
</I>&gt;<i>                        }
</I>&gt;<i>
</I>&gt;<i>                        return fl ;
</I>&gt;<i>                }
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i> Thanks, Roy
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> View this message in context: <A HREF="http://monotouch.2284126.n4.nabble.com/Why-is-the-MonoTouch-version-of-this-Mandelbrot-Set-test-2-8-times-slower-tp4389869p4389869.html">http://monotouch.2284126.n4.nabble.com/Why-is-the-MonoTouch-version-of-this-Mandelbrot-Set-test-2-8-times-slower-tp4389869p4389869.html</A>
</I>&gt;<i> Sent from the MonoTouch mailing list archive at Nabble.com.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> MonoTouch mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>&lt;mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>&gt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>
Op dit e-mailbericht is de disclaimer van Info Support van toepassing, zie <A HREF="http://www.infosupport.com/disclaimer">http://www.infosupport.com/disclaimer</A>

[cid:disclaimer3d6c.jpg]&lt;<A HREF="http://www.infosupport.com/">http://www.infosupport.com/</A>&gt;

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20120215/b565ddc3/attachment-0001.html">http://lists.ximian.com/pipermail/monotouch/attachments/20120215/b565ddc3/attachment-0001.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: disclaimer3d6c.jpg
Type: image/jpeg
Size: 15776 bytes
Desc: disclaimer3d6c.jpg
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20120215/b565ddc3/attachment-0001.jpg">http://lists.ximian.com/pipermail/monotouch/attachments/20120215/b565ddc3/attachment-0001.jpg</A>&gt;
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007986.html">[MonoTouch] Why is the MonoTouch version of this Mandelbrot Set test 2.8 times slower?
</A></li>
	<LI>Next message: <A HREF="007987.html">[MonoTouch] Touches are  recognized with delay
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7992">[ date ]</a>
              <a href="thread.html#7992">[ thread ]</a>
              <a href="subject.html#7992">[ subject ]</a>
              <a href="author.html#7992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
