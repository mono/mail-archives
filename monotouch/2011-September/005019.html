<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] LINQ JIT error, again
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20LINQ%20JIT%20error%2C%20again&In-Reply-To=CAN5R1GF8A3waOCGSrkJ_%2Bx%3Dx9vJHhTsTkkGcChS0g7KTA9yNRA%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005232.html">
   <LINK REL="Next"  HREF="005040.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] LINQ JIT error, again</H1>
    <B>Brian Schuth</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20LINQ%20JIT%20error%2C%20again&In-Reply-To=CAN5R1GF8A3waOCGSrkJ_%2Bx%3Dx9vJHhTsTkkGcChS0g7KTA9yNRA%40mail.gmail.com"
       TITLE="[MonoTouch] LINQ JIT error, again">brian at alphce.com
       </A><BR>
    <I>Fri Sep  9 10:41:54 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="005232.html">[MonoTouch] Create Video from image sequences - IOS
</A></li>
        <LI>Next message: <A HREF="005040.html">[MonoTouch] LINQ JIT error, again
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5019">[ date ]</a>
              <a href="thread.html#5019">[ thread ]</a>
              <a href="subject.html#5019">[ subject ]</a>
              <a href="author.html#5019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have simplified this even further; with all the interface cruft out
of the way, it seems like the problem is that even the simplest &quot;join&quot;
is going to cause a JIT error? This sounds like a bug to me, but I'm
happy to be told it's my fault :).

The code that causes the problem is below, reduced to about its bare
minimum. <A HREF="git://github.com/bschuth/MT-JIT-Problem.git">git://github.com/bschuth/MT-JIT-Problem.git</A> has been updated
as well...

But the problem is really simple: I have two collections of objects
(sessions and scores) connected by an integer key in a one-to-many
relationship, where score.OwnerID equal session.SessionID. This linq
fails:

from s in sessions
join score in scores
on s.SessionID equals score.OwnerID
select score.Name;

Are joins just not possible here? What to do? Thanks.

==== Source: PROBLEMLINQ.CS STARTS
using System;
using System.Linq;
using System.Collections.Generic;

namespace JIT20110908
{
public class ProblemLinq
{
public IList&lt;string&gt; Execute ()
{
List&lt;ActualScore&gt; scores = new List&lt;ActualScore&gt; ();
ActualScore score1 = new ActualScore () {
Name = &quot;ACTIVITIES&quot;,
OwnerID = 666
};
scores.Add (score1);

List&lt;MySession&gt; sessions = new List&lt;MySession&gt; ();
MySession mysession = new MySession () {
SessionID = 666,
};
sessions.Add (mysession);

var summaryVar = from s in sessions
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;join score in scores
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;on s.SessionID equals score.OwnerID
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;select score.Name;

List&lt;string&gt; summaryRows = summaryVar.ToList();
return summaryRows;
}
}

public class MySession
{
public int SessionID { get; set; }
}

public class ActualScore
{
public int OwnerID { get; set; }
public string Name { get; set; }
}
}

On Fri, Sep 9, 2011 at 9:07 AM, Brian Schuth &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">brian at alphce.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Thanks, this confirms my vague sense that the problem came from something the LINQ depends on that is not generated during compilation. This specific fix doesn't work, since the type involved isn't quite the same. I'm relatively new to the guts of LINQ, so I think I need some help parsing exactly what the error is.
</I>&gt;<i> The stack trace says it is attempting to compile this method:
</I>&gt;<i> System.Linq.Enumerable:&lt;ToLookup`2&gt;m__18&lt;JIT20110908.ActualScore, int&gt;(JIT20110908.ActualScore)
</I>&gt;<i> I tried just substituting ActualScore as the type in your fix, but that doesn't seem to do it either.
</I>&gt;<i> The exception occurs inside the method:
</I>&gt;<i> at System.Linq.Enumerable.ToLookup[ActualScore,Int32,ActualScore] (IEnumerable`1 source, System.Func`2 keySelector, System.Func`2 elementSelector, IEqualityComparer`1 comparer) [0x00079] in /Developer/MonoTouch/Source/mono/mcs/class/System.Core/System.Linq/Enumerable.cs:2915
</I>&gt;<i> I've read the docs on Enumerable.ToLookup, and maybe I just need more coffee, but I'm not quite getting what this may be trying to do at the mysterious line 2915 that is causing a crash...
</I>&gt;<i> Can anyone point me just a little closer? I'm just trying random stuff at the moment to see if I magically create the thing that MT wants.
</I>&gt;<i> If there's a resource out there that explains the guts of LINQ well enough to start figuring out what's going on under the hood here, I'd love to know about it!
</I>&gt;<i> Thanks,
</I>&gt;<i> bjs
</I>&gt;<i> On Fri, Sep 9, 2011 at 3:15 AM, Pete Macko &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">pmacko at me.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Try putting this in your code and calling it from FinishedLaunching
</I>&gt;&gt;<i> private void MonoTouchForcedCompilationHacks()
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> var hack1 = new&#160;IFooSession[0];
</I>&gt;&gt;<i> if(!((ICollection&lt;&#160;IFooSession&gt;)hack1).Contains(// some bogus lambda or other thing to force the system to evaluate the collection))
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i> blah blah blah log some crap here or whatever
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> Could put this anywhere I guess, but I got tired of dealing with jit errors and stuck all this sort of stuff in one place for the sake of organization.
</I>&gt;&gt;<i> Then again, it could be your sample values in the code that are making baby jeebus cry -- and MT is watching! :)
</I>&gt;&gt;<i> -pm
</I>&gt;&gt;<i> On Sep 8, 2011, at 4:22 PM, Brian Schuth wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A couple of months back I hit JIT errors when using LINQ for objects. I was never able to resolve them, but as the LINQ involved was pretty simple, I just &quot;unrolled&quot; it into procedural code.
</I>&gt;&gt;<i> Now I'm getting more of them, and I'd really prefer to leave the LINQ alone if possible. The exception I'm getting today is:
</I>&gt;&gt;<i> Attempting to JIT compile method 'System.Linq.Enumerable:&lt;ToLookup`2&gt;m__18&lt;JIT20110908.ActualScore, int&gt; (JIT20110908.ActualScore)' while running with --aot-only.
</I>&gt;&gt;<i> Below is my ProblemLinq.cs file, which contains a class with an Execute() method that causes this error. I realize there's a lot of interfaces and classes here; this is a severely dumbed-down version of the actual code, which is part of a cross-platform reporting library. The code in question is running in Windows as part of a production product.
</I>&gt;&gt;<i> I've read the &quot;Limitations&quot; section on the xamarin website, and while I can't say I understand it totally, I don't see that my code is doing any of the verboten virtualization things; although LINQ does enough magic that I don't necessarily know the secondary effects of the code.
</I>&gt;&gt;<i> The stack trace from the error this class causes follows the code.
</I>&gt;&gt;<i> I'm running MT 4.0.7 and MD2.6.
</I>&gt;&gt;<i> Am I doing some LINQ thing I shouldn't? Or is MT missing something?
</I>&gt;&gt;<i> Thanks.
</I></PRE>






























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005232.html">[MonoTouch] Create Video from image sequences - IOS
</A></li>
	<LI>Next message: <A HREF="005040.html">[MonoTouch] LINQ JIT error, again
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5019">[ date ]</a>
              <a href="thread.html#5019">[ thread ]</a>
              <a href="subject.html#5019">[ subject ]</a>
              <a href="author.html#5019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
