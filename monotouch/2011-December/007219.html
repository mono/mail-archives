<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Odd sporatic error on WAV uploads via PUT HTTP	request.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Odd%20sporatic%20error%20on%20WAV%20uploads%20via%20PUT%20HTTP%0A%09request.&In-Reply-To=CALm_Lx0Ce5Lpu1vz6jZMHgVFNqQUEi-O8f1PG9YkEDnfWJsAKg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007216.html">
   <LINK REL="Next"  HREF="007222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Odd sporatic error on WAV uploads via PUT HTTP	request.</H1>
    <B>Rolf Bjarne Kvinge</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Odd%20sporatic%20error%20on%20WAV%20uploads%20via%20PUT%20HTTP%0A%09request.&In-Reply-To=CALm_Lx0Ce5Lpu1vz6jZMHgVFNqQUEi-O8f1PG9YkEDnfWJsAKg%40mail.gmail.com"
       TITLE="[MonoTouch] Odd sporatic error on WAV uploads via PUT HTTP	request.">rolf at xamarin.com
       </A><BR>
    <I>Tue Dec 20 03:27:50 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="007216.html">[MonoTouch] Assistance tracing an intermittent crash
</A></li>
        <LI>Next message: <A HREF="007222.html">[MonoTouch] SecureChannelFailure when using WebProxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7219">[ date ]</a>
              <a href="thread.html#7219">[ thread ]</a>
              <a href="subject.html#7219">[ subject ]</a>
              <a href="author.html#7219">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Dec 20, 2011 at 2:07 AM, Jeff Lindborg &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">jlindborg2000 at gmail.com</A>&gt;wrote:

&gt;<i> Couple notes I can provide after testing...
</I>
1. Can't do HTTP, server wont allow it and I don't control that side
&gt;<i> of it - I suppose I could spin up my own REST service to test that...
</I>&gt;<i>
</I>
Yes, I think the best way to track down the problem is to create a smaller
test case. That way it's easier for other people (us) to try it out to.

Rolf


&gt;<i>
</I>&gt;<i> 2. It fails after you start to upload - smaller files don't fail often
</I>&gt;<i> (smaller meaning about 2 seconds of linear PCM recording - think of a
</I>&gt;<i> voice name for an IVR system here).  But if you try enough times it'll
</I>&gt;<i> eventually fail.  Large files (think 30 seconds of linear PCM
</I>&gt;<i> recording) fail nearly all the time - retries will eventually go
</I>&gt;<i> through but I've seen it take as many as 20 (!!!!) tries.  Clearly not
</I>&gt;<i> ideal.
</I>&gt;<i>
</I>&gt;<i> I'm using this same class library on Windows forms apps - I've
</I>&gt;<i> uploaded 3 to 5 minute recordings (yeah... people record 5 minute
</I>&gt;<i> greetings for their IVR setups - evil but there it is) and they go
</I>&gt;<i> through ok to the same servers on the same network (my home) so I'm
</I>&gt;<i> not imagining a network problem popping in here.
</I>&gt;<i>
</I>&gt;<i> I changed the upload process to &quot;chunk&quot; the stream into 10,000 byte
</I>&gt;<i> pieces just to see if it would behave differently - it didn't but I
</I>&gt;<i> could see the chunks flying by before it failed so I know it's
</I>&gt;<i> starting the process.
</I>&gt;<i>
</I>&gt;<i> Dunno how to narrow it down any further - if there's some sort of diag
</I>&gt;<i> output I can gather for you guys, let me know.  The WAV file handling
</I>&gt;<i> for this app is kind of it's main deal so I'm keen to smooth the edges
</I>&gt;<i> on this.
</I>&gt;<i>
</I>&gt;<i> thanks
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Dec 19, 2011 at 4:23 PM, Rolf Bjarne Kvinge &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">rolf at xamarin.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don't know exactly what's going on, but I have a few questions that
</I>&gt;<i> might
</I>&gt;<i> &gt; help you:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; * It seems you're using https, do you have the same problem with just
</I>&gt;<i> http?
</I>&gt;<i> &gt; * Does it fail instantly when it fails, or does it start uploading and
</I>&gt;<i> then
</I>&gt;<i> &gt; fail after some random amount of time?
</I>&gt;<i> &gt; * (If it doesn't fail instantly) does a slow network make it fail
</I>&gt;<i> &gt; faster/more often?
</I>&gt;<i> &gt; * You say you're uploading &quot;very large wav files&quot;, but exactly how large
</I>&gt;<i> is
</I>&gt;<i> &gt; &quot;very large&quot;?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don't think it's an iOS restriction you're running into if it works
</I>&gt;<i> &gt; sometimes. To me it sounds either like a network hiccup, or an obscure
</I>&gt;<i> bug
</I>&gt;<i> &gt; inside MonoTouch (and the questions above will help point the location,
</I>&gt;<i> but
</I>&gt;<i> &gt; in any case a reproducible test case would likely be required to track
</I>&gt;<i> down
</I>&gt;<i> &gt; a MonoTouch bug).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Rolf
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Sun, Dec 18, 2011 at 4:23 AM, jlindborg &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">jlindborg2000 at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Hey folks &#8211; been banging heads with this for several hours today &#8211; just
</I>&gt;<i> &gt;&gt; adding a simple WAV file upload/download facility into my app to a REST
</I>&gt;<i> &gt;&gt; based server &#8211; all the downloads work dandy regardless of size, however
</I>&gt;<i> &gt;&gt; uploads will occasionally throw an error on me &#8211; if you retry the file a
</I>&gt;<i> &gt;&gt; time or two when you get the failure they do go through but that makes
</I>&gt;<i> me
</I>&gt;<i> &gt;&gt; sad&#8230; I&#8217;d rather not have to resort to a retry hack to smother this.
</I>&gt;<i> &gt;&gt;  Largely
</I>&gt;<i> &gt;&gt; the same C# code is in use on my WinForms projects and uploads of very
</I>&gt;<i> &gt;&gt; large
</I>&gt;<i> &gt;&gt; wav files (long winded voice mail greetings for instance) go through ok
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; the same servers.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; So&#8230; I&#8217;m not sure if this is me being a bonehead about something (always
</I>&gt;<i> a
</I>&gt;<i> &gt;&gt; possibility) or if I&#8217;m not taking some iOS limitation into account or
</I>&gt;<i> this
</I>&gt;<i> &gt;&gt; is a bug somewhere in Mono&#8230; anyway &#8211; here&#8217;s the upload code (simplified
</I>&gt;<i> a
</I>&gt;<i> &gt;&gt; bit for brevity) .
</I>&gt;<i> &gt;&gt; ==========
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; private static bool UploadWavFile(string pFullResourcePath, string
</I>&gt;<i> pLogin,
</I>&gt;<i> &gt;&gt;                          string pPassword, string pLocalWavFilePath)
</I>&gt;<i> &gt;&gt;    {
</I>&gt;<i> &gt;&gt;        Stream oStream = null;
</I>&gt;<i> &gt;&gt;        HttpWebRequest webReq;
</I>&gt;<i> &gt;&gt;        byte[] buffer;
</I>&gt;<i> &gt;&gt;        BinaryReader binReader = null;
</I>&gt;<i> &gt;&gt;              FileStream oFileStream = null;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;        try
</I>&gt;<i> &gt;&gt;        {
</I>&gt;<i> &gt;&gt;           oFileStream = File.Open(pLocalWavFilePath, FileMode.Open);
</I>&gt;<i> &gt;&gt;           binReader = new BinaryReader(oFileStream);
</I>&gt;<i> &gt;&gt;           buffer = new
</I>&gt;<i> byte[Convert.ToInt32(binReader.BaseStream.Length) +
</I>&gt;<i> &gt;&gt; 1];
</I>&gt;<i> &gt;&gt;           binReader.Read(buffer, 0, buffer.Length);
</I>&gt;<i> &gt;&gt;        }
</I>&gt;<i> &gt;&gt;        catch (Exception ex)
</I>&gt;<i> &gt;&gt;        {
</I>&gt;<i> &gt;&gt;                Console.WriteLine(ex.ToString());
</I>&gt;<i> &gt;&gt;                return false;
</I>&gt;<i> &gt;&gt;        }
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;    webReq = (HttpWebRequest)WebRequest.Create(pFullResourcePath);
</I>&gt;<i> &gt;&gt;    webReq.Method = &quot;PUT&quot;;
</I>&gt;<i> &gt;&gt;    webReq.ContentLength = buffer.Length;
</I>&gt;<i> &gt;&gt;    webReq.ContentType = &quot;audio/wav&quot;;
</I>&gt;<i> &gt;&gt;    webReq.Credentials = new NetworkCredential(pLogin, pPassword);
</I>&gt;<i> &gt;&gt;    webReq.KeepAlive = false;
</I>&gt;<i> &gt;&gt;    webReq.ReadWriteTimeout= 50000;
</I>&gt;<i> &gt;&gt;    oStream = webReq.GetRequestStream();
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;        Try
</I>&gt;<i> &gt;&gt;                {
</I>&gt;<i> &gt;&gt;                            //LINE THAT THROWS ERROR FROM TIME TO TIME
</I>&gt;<i> &gt;&gt;                            oStream.Write(buffer,0, buffer.Length);
</I>&gt;<i> &gt;&gt;                }
</I>&gt;<i> &gt;&gt;                catch (Exception ex)
</I>&gt;<i> &gt;&gt;                {
</I>&gt;<i> &gt;&gt;                  Console.WriteLine (ex.ToString());
</I>&gt;<i> &gt;&gt;                  return false;
</I>&gt;<i> &gt;&gt;                }
</I>&gt;<i> &gt;&gt; ...
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; And here&#8217;s the error it&#8217;s throwing at the noted line:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; System.IO.IOException: IO exception during Write. ---&gt;
</I>&gt;<i> &gt;&gt; System.NullReferenceException: Object reference not set to an instance
</I>&gt;<i> of
</I>&gt;<i> &gt;&gt; an
</I>&gt;<i> &gt;&gt; object\n  at Mono.Security.Protocol.Tls.SslStreamBase.InternalBeginWrite
</I>&gt;<i> &gt;&gt; (Mono.Security.Protocol.Tls.InternalAsyncResult asyncResult) [0x00031]
</I>&gt;<i> in
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> /Developer/MonoTouch/Source/mono/mcs/class/Mono.Security/Mono.Security.Protocol.Tls/SslStreamBase.cs:775
</I>&gt;<i> &gt;&gt; \n  --- End of inner exception stack trace ---\n  at
</I>&gt;<i> &gt;&gt; Mono.Security.Protocol.Tls.SslStreamBase.InternalBeginWrite
</I>&gt;<i> &gt;&gt; (Mono.Security.Protocol.Tls.InternalAsyncResult asyncResult) [0x00089]
</I>&gt;<i> in
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> /Developer/MonoTouch/Source/mono/mcs/class/Mono.Security/Mono.Security.Protocol.Tls/SslStreamBase.cs:788
</I>&gt;<i> &gt;&gt; \n  at Mono.Security.Protocol.Tls.SslStreamBase.BeginWrite
</I>&gt;<i> (System.Byte[]
</I>&gt;<i> &gt;&gt; buffer, Int32 offset, Int32 count, System.AsyncCallback callback,
</I>&gt;<i> &gt;&gt; System.Object state) [0x000a3] in
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> /Developer/MonoTouch/Source/mono/mcs/class/Mono.Security/Mono.Security.Protocol.Tls/SslStreamBase.cs:857
</I>&gt;<i> &gt;&gt; \n  at System.Net.WebConnection.BeginWrite (System.Net.HttpWebRequest
</I>&gt;<i> &gt;&gt; request, System.Byte[] buffer, Int32 offset, Int32 size,
</I>&gt;<i> &gt;&gt; System.AsyncCallback cb, System.Object state) [0x00055] in
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> /Developer/MonoTouch/Source/mono/mcs/class/System/System.Net/WebConnection.cs:927
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; --
</I>&gt;<i> &gt;&gt; View this message in context:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> <A HREF="http://monotouch.2284126.n4.nabble.com/Odd-sporatic-error-on-WAV-uploads-via-PUT-HTTP-request-tp4210028p4210028.html">http://monotouch.2284126.n4.nabble.com/Odd-sporatic-error-on-WAV-uploads-via-PUT-HTTP-request-tp4210028p4210028.html</A>
</I>&gt;<i> &gt;&gt; Sent from the MonoTouch mailing list archive at Nabble.com.
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; MonoTouch mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20111220/a1bea394/attachment-0001.html">http://lists.ximian.com/pipermail/monotouch/attachments/20111220/a1bea394/attachment-0001.html</A> 
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007216.html">[MonoTouch] Assistance tracing an intermittent crash
</A></li>
	<LI>Next message: <A HREF="007222.html">[MonoTouch] SecureChannelFailure when using WebProxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7219">[ date ]</a>
              <a href="thread.html#7219">[ thread ]</a>
              <a href="subject.html#7219">[ subject ]</a>
              <a href="author.html#7219">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
