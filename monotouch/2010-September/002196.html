<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Image In Cell Can Leak Memory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Image%20In%20Cell%20Can%20Leak%20Memory&In-Reply-To=C8B5027E.909F%25tscott%40lunaversesoftware.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002189.html">
   <LINK REL="Next"  HREF="002183.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Image In Cell Can Leak Memory</H1>
    <B>Miguel de Icaza</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Image%20In%20Cell%20Can%20Leak%20Memory&In-Reply-To=C8B5027E.909F%25tscott%40lunaversesoftware.com"
       TITLE="[MonoTouch] Image In Cell Can Leak Memory">miguel at novell.com
       </A><BR>
    <I>Tue Sep 14 16:39:03 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002189.html">[MonoTouch] Image In Cell Can Leak Memory
</A></li>
        <LI>Next message: <A HREF="002183.html">[MonoTouch] detect hardware type snippet
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2196">[ date ]</a>
              <a href="thread.html#2196">[ thread ]</a>
              <a href="subject.html#2196">[ subject ]</a>
              <a href="author.html#2196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

&gt;<i> I just learned something that I thought I would share.  Did you know
</I>&gt;<i> that this will leak memory?
</I>
This is actually a well understood problem with garbage collectors that
have objects wrapping expensive resources.

As far as the garbage collector knows, the &quot;UIImage&quot; object that you
created is consuming some 16 bytes or so.   It does not know that the 16
bytes actually point to a larger block of memory in the unmanaged heap.
The 4 byte pointer in there could be pointing to a 2 meg image, for all
you know.

But the garbage collector has no idea that these innocent 16 bytes are
actually contributing to a large amount of memory pressure.  This is not
a problem limited to images, it happens with any other operating system
resources like sockets, file descriptor, database connections and
locks.  

This is why objects that wrap expensive resources expose the IDisposable
interface, it allows programmer to actively manage the resources by
allowing the object to be explicitly released with the Dispose call.

You could wait for the GC and kick-in, but in some circumstances, you
will run out of your resource before the GC ever notices:

<A HREF="http://msdn.microsoft.com/en-us/magazine/cc163392.aspx">http://msdn.microsoft.com/en-us/magazine/cc163392.aspx</A>

&gt;<i> 
</I>&gt;<i> public class MyCell : UITableViewCell
</I>&gt;<i> {
</I>&gt;<i>     UImageView myImageView;
</I>&gt;<i> 
</I>&gt;<i>     public MyCell () : base(UITableViewCellStyle.Default, &#8220;myCell&#8221;)
</I>&gt;<i>     {
</I>&gt;<i>         ...
</I>&gt;<i>         myImageView = new UIImageView(someRectF);
</I>&gt;<i>         myImageView.Image = UiImage.FromFile(&#8220;Images/myimage.png&#8221;);
</I>&gt;<i>     }
</I>&gt;<i>     ...
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> It makes sense that this image is duplicated in memory for each cell.
</I>&gt;<i>  That&#8217;s bad enough.  The bigger problem, it seems,  is that these
</I>&gt;<i> images do not get disposed when the table controller is popped.  If
</I>&gt;<i> you push and pop this controller enough times with enough cells, you
</I>&gt;<i> will run out of memory.
</I>&gt;<i> 
</I>&gt;<i> I solved it like this:
</I>&gt;<i> 
</I>&gt;<i> public static class Images
</I>&gt;<i> {
</I>&gt;<i>     static Images ()
</I>&gt;<i>     {
</I>&gt;<i>         MyImage = UIImage.FromFile (&quot;Images/ myimage.png&quot;);
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>     public static UIImage MyImage { get; private set; }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> Then in the ctor of the cell:
</I>&gt;<i> 
</I>&gt;<i> myImageView.Image = Images .MyImage;
</I>&gt;<i> 
</I>&gt;<i> Comments??? 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> MonoTouch mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002189.html">[MonoTouch] Image In Cell Can Leak Memory
</A></li>
	<LI>Next message: <A HREF="002183.html">[MonoTouch] detect hardware type snippet
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2196">[ date ]</a>
              <a href="thread.html#2196">[ thread ]</a>
              <a href="subject.html#2196">[ subject ]</a>
              <a href="author.html#2196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
