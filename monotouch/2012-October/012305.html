<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Understanding the memory profiler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Understanding%20the%20memory%20profiler&In-Reply-To=%3C059301cdb5ac%247fac8ef0%247f05acd0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012304.html">
   <LINK REL="Next"  HREF="012307.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Understanding the memory profiler</H1>
    <B>Randy Ficker</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Understanding%20the%20memory%20profiler&In-Reply-To=%3C059301cdb5ac%247fac8ef0%247f05acd0%24%40gmail.com%3E"
       TITLE="[MonoTouch] Understanding the memory profiler">randyficker at gmail.com
       </A><BR>
    <I>Mon Oct 29 08:07:52 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="012304.html">[MonoTouch] Stream and NSStream and Asset Library
</A></li>
        <LI>Next message: <A HREF="012307.html">[MonoTouch] Understanding the memory profiler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12305">[ date ]</a>
              <a href="thread.html#12305">[ thread ]</a>
              <a href="subject.html#12305">[ subject ]</a>
              <a href="author.html#12305">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I believe my MonoTouch app is leaking memory, and I've been struggling at
figuring out why.

 

By using Instruments I can see the allocated memory grow and grow over the
life of the app, eventually causing the app to die after 10 minutes or so of
general use on my 3GS.

 

To help isolate the problem, I first picked a specific action in my app I
can easily repeat - just opening a menu and closing it again, which
shouldn't leave any garbage behind as the code is well-contained. Using
Instruments, I can see that just opening and closing this menu adds about
90KB of allocations each time.  If I open and close it 11 times, I've added
a megabyte to my app's memory use.

 

I first tried enabling SGen and then the reference counting extension.
Neither configuration changed the memory allocated.

 

I tried commenting out parts of the menu that I thought might be leaking
(images, custom-draw views, etc.).  Doing this did reduce the memory
leakage, but even if I comment out all of the functionality (to the point
where my menu came up blank) it was still leaking 40KB each time. So I still
feel I'm missing something fundamental.

 

I was concerned that the garbage collector might just not be running,
flawing my test results.  I added a call to GC.Collect() but that didn't
change anything.  I also tried doing it 50 times in a row, leaking over 4
megs of memory, to see if the GC would eventually collect it all. It never
did.

 

Throughout this, I've been trying to understand the mono memory profiler.
Following the instructions, I take a shot, open and close my app's menu, and
take another shot, then diff them, and I see this:
<A HREF="http://i.imgur.com/N4Ngb.png.">http://i.imgur.com/N4Ngb.png.</A>  Checking &quot;Roots only&quot; doesn't change anything
(the three new columns are empty).   Instruments-&gt;Leaks shows this:
<A HREF="http://i.imgur.com/hbJQ1.png">http://i.imgur.com/hbJQ1.png</A>

 

For comparison, I also ran the profiler against my code with virtually all
of my code commented out (it was just bringing up a blank menu).  Memory
leak is about 40KB in this scenario:  <A HREF="http://i.imgur.com/eIlK7.png">http://i.imgur.com/eIlK7.png</A>

 

I'm very confused by these results. My questions are:

 

1.       What is &lt;Other Root&gt; and why does it have thousands of instances
that total 0 memory?  This appears to be the common factor in both of them.

2.       In the first one, it says 20KB of strings leaked.  How can I tell
where these are coming from or why they aren't being collected?

3.       What uses System.WeakReference and why would it be leaking?

4.       The mono profiler only seems to account for a small part of the
total memory being leaked.  Is there anything else I can try?

5.       What else can I do to try and figure out why my app is continually
growing in memory? 

 

I feel like I'm missing something fundamental here.  I'd appreciate any
advice anyone can offer!

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20121029/42acf242/attachment.html">http://lists.ximian.com/pipermail/monotouch/attachments/20121029/42acf242/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012304.html">[MonoTouch] Stream and NSStream and Asset Library
</A></li>
	<LI>Next message: <A HREF="012307.html">[MonoTouch] Understanding the memory profiler
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12305">[ date ]</a>
              <a href="thread.html#12305">[ thread ]</a>
              <a href="subject.html#12305">[ subject ]</a>
              <a href="author.html#12305">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
