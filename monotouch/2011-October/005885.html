<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] SDK 5 issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20SDK%205%20issue&In-Reply-To=1318955054941-3915935.post%40n4.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005874.html">
   <LINK REL="Next"  HREF="005903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] SDK 5 issue</H1>
    <B>Jeff Stedfast</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20SDK%205%20issue&In-Reply-To=1318955054941-3915935.post%40n4.nabble.com"
       TITLE="[MonoTouch] SDK 5 issue">jeff at xamarin.com
       </A><BR>
    <I>Tue Oct 18 15:32:45 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="005874.html">[MonoTouch] SDK 5 issue
</A></li>
        <LI>Next message: <A HREF="005903.html">[MonoTouch] SDK 5 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5885">[ date ]</a>
              <a href="thread.html#5885">[ thread ]</a>
              <a href="subject.html#5885">[ subject ]</a>
              <a href="author.html#5885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Sergio,

&gt;<i>From looking at the code, I'm guessing that the problem is that your
</I>MyUIOperation is getting GC'd. You only hold a reference to the latest one
added, but if you click multiple times, you might add multiple operations to
your queue and all but the last one added will have been GC'd.

You might have to keep your own managed (C#) queue of NSOperations and have
.Main() remove itself from your _queue.

Hope that helps,

Jeff

On Tue, Oct 18, 2011 at 12:24 PM, Sergio Fadda &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">sergio.fadda at logobject.ch</A>&gt;wrote:

&gt;<i> Ok, after solving the issue in the topic, I finally isolated the problem I
</I>&gt;<i> have in my project. Should be a synchronization issue with the GC. Here's
</I>&gt;<i> the app that replicate the issue:
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i> using System.Drawing;
</I>&gt;<i> using MonoTouch.Foundation;
</I>&gt;<i> using MonoTouch.UIKit;
</I>&gt;<i>
</I>&gt;<i> namespace MTFailure
</I>&gt;<i> {
</I>&gt;<i> 	public class Application
</I>&gt;<i> 	{
</I>&gt;<i> 		static void Main (string[] args)
</I>&gt;<i> 		{
</I>&gt;<i> 			UIApplication.Main (args, null, &quot;AppDelegate&quot;);
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> 	
</I>&gt;<i> 	public class MyUIOperation : NSOperation
</I>&gt;<i> 	{
</I>&gt;<i> 		private NSAction _action;
</I>&gt;<i> 		
</I>&gt;<i> 		public MyUIOperation(NSAction action)
</I>&gt;<i> 		{
</I>&gt;<i> 			_action = action;
</I>&gt;<i> 		}
</I>&gt;<i> 		
</I>&gt;<i> 		public override void Main ()
</I>&gt;<i> 		{
</I>&gt;<i> 			// Execute these actions in the main thread since it's a UI manipulation
</I>&gt;<i> 			InvokeOnMainThread(_action);
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> 	
</I>&gt;<i> 	[Register(&quot;AppDelegate&quot;)]
</I>&gt;<i> 	public class AppDelegate : UIApplicationDelegate
</I>&gt;<i> 	{
</I>&gt;<i> 		private MonoTouch.UIKit.UIWindow __mt_window;
</I>&gt;<i> 		private UINavigationController _navCtrl;
</I>&gt;<i> 		
</I>&gt;<i> 		public override bool FinishedLaunching (UIApplication app, NSDictionary options)
</I>&gt;<i> 		{
</I>&gt;<i> 			__mt_window = new UIWindow(UIScreen.MainScreen.Bounds);
</I>&gt;<i> 			__mt_window.BackgroundColor = UIColor.White;
</I>&gt;<i> 			
</I>&gt;<i> 			_navCtrl = new UINavigationController();
</I>&gt;<i> 			_navCtrl.PushViewController(CreatePage(), true);
</I>&gt;<i> 			
</I>&gt;<i> 			__mt_window.AddSubview(_navCtrl.View);
</I>&gt;<i> 			__mt_window.MakeKeyAndVisible ();
</I>&gt;<i> 	
</I>&gt;<i> 			return true;
</I>&gt;<i> 		}
</I>&gt;<i> 		
</I>&gt;<i> 		protected UIViewController CreatePage()
</I>&gt;<i> 		{
</I>&gt;<i> 			UIViewController result = new UIViewController();
</I>&gt;<i> 			UIView pageView = new UIView(UIScreen.MainScreen.Bounds);
</I>&gt;<i> 			
</I>&gt;<i> 			UIButton btn = UIButton.FromType(UIButtonType.RoundedRect);
</I>&gt;<i> 			btn.Frame = new RectangleF(0, 50, 320, 37);
</I>&gt;<i> 			btn.TouchUpInside += HandleBtnTouchUpInside;
</I>&gt;<i> 			btn.SetTitle(&quot;Touch me!!!&quot;, UIControlState.Normal);
</I>&gt;<i> 			pageView.AddSubview(btn);
</I>&gt;<i> 			
</I>&gt;<i> 			result.View = pageView;
</I>&gt;<i> 			
</I>&gt;<i> 			return result;
</I>&gt;<i> 		}
</I>&gt;<i>
</I>&gt;<i> 		private NSOperationQueue _queue = new NSOperationQueue();
</I>&gt;<i> 		private NSOperation _op;
</I>&gt;<i> 		
</I>&gt;<i> 		void HandleBtnTouchUpInside (object sender, EventArgs e)
</I>&gt;<i> 		{
</I>&gt;<i> 			// Enqueue the operation and let the os to handle it in another thread
</I>&gt;<i> 			_op = new MyUIOperation(DeferredAction);
</I>&gt;<i> 			_queue.AddOperation(_op);
</I>&gt;<i> 		}
</I>&gt;<i> 		
</I>&gt;<i> 		private UIViewController _subCtrl;
</I>&gt;<i> 		
</I>&gt;<i> 		private void DeferredAction()
</I>&gt;<i> 		{
</I>&gt;<i> 			_navCtrl.PushViewController(CreatePage (), true);
</I>&gt;<i> 		}
</I>&gt;<i>
</I>&gt;<i> 		// This method is required in iPhoneOS 3.0
</I>&gt;<i> 		public override void OnActivated (UIApplication application)
</I>&gt;<i> 		{
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> That is, a simple navigation app with a button in a view; the action of the
</I>&gt;<i> button must be deferred and usually is a UI manipulation; running the
</I>&gt;<i> application and pressing the button a variable number of times the
</I>&gt;<i> application crashes and displays the following message:
</I>&gt;<i>
</I>&gt;<i> Stacktrace:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Native stacktrace:
</I>&gt;<i>
</I>&gt;<i> 	0   MTFailure                           0x000d5c18 mono_handle_native_sigsegv + 408
</I>&gt;<i> 	1   MTFailure                           0x00012fcf mono_sigsegv_signal_handler + 351
</I>&gt;<i> 	2   libsystem_c.dylib                   0x9435859b _sigtramp + 43
</I>&gt;<i> 	3   ???                                 0xffffffff 0x0 + 4294967295
</I>&gt;<i> 	4   libobjc.A.dylib                     0x0199dc09 _class_getVariable + 99
</I>&gt;<i> 	5   libobjc.A.dylib                     0x0199415f object_getInstanceVariable + 56
</I>&gt;<i> 	6   MTFailure                           0x002cc543 monotouch_release_trampoline + 419
</I>&gt;<i> 	7   Foundation                          0x00747d16 __release_object_op + 37
</I>&gt;<i> 	8   libdispatch.dylib                   0x0214cc7b _dispatch_async_f_redirect_invoke + 146
</I>&gt;<i> 	9   libdispatch.dylib                   0x0214c4e6 _dispatch_worker_thread2 + 284
</I>&gt;<i> 	10  libsystem_c.dylib                   0x94302b24 _pthread_wqthread + 346
</I>&gt;<i> 	11  libsystem_c.dylib                   0x943046fe start_wqthread + 30
</I>&gt;<i>
</I>&gt;<i> =================================================================
</I>&gt;<i> Got a SIGSEGV while executing native code. This usually indicates
</I>&gt;<i> a fatal error in the mono runtime or one of the native libraries
</I>&gt;<i> used by your application.
</I>&gt;<i> =================================================================
</I>&gt;<i>
</I>&gt;<i> This issue is present only with iOS 5 (both device and simulator), but in
</I>&gt;<i> iOS 4.3 works fine!
</I>&gt;<i>
</I>&gt;<i> What's wrong now?
</I>&gt;<i> Thanks,
</I>&gt;<i> Sergio
</I>&gt;<i> ------------------------------
</I>&gt;<i> View this message in context: Re: SDK 5 issue&lt;<A HREF="http://monotouch.2284126.n4.nabble.com/SDK-5-issue-tp3912223p3915935.html">http://monotouch.2284126.n4.nabble.com/SDK-5-issue-tp3912223p3915935.html</A>&gt;
</I>&gt;<i>
</I>&gt;<i> Sent from the MonoTouch mailing list archive&lt;<A HREF="http://monotouch.2284126.n4.nabble.com/">http://monotouch.2284126.n4.nabble.com/</A>&gt;at Nabble.com.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> MonoTouch mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20111018/b8757cdb/attachment.html">http://lists.ximian.com/pipermail/monotouch/attachments/20111018/b8757cdb/attachment.html</A> 
</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005874.html">[MonoTouch] SDK 5 issue
</A></li>
	<LI>Next message: <A HREF="005903.html">[MonoTouch] SDK 5 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5885">[ date ]</a>
              <a href="thread.html#5885">[ thread ]</a>
              <a href="subject.html#5885">[ subject ]</a>
              <a href="author.html#5885">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
