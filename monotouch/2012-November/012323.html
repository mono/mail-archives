<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Understanding the memory profiler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Understanding%20the%20memory%20profiler&In-Reply-To=%3C07ec01cdb7ff%2478585210%246908f630%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="012324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Understanding the memory profiler</H1>
    <B>Randy Ficker</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Understanding%20the%20memory%20profiler&In-Reply-To=%3C07ec01cdb7ff%2478585210%246908f630%24%40gmail.com%3E"
       TITLE="[MonoTouch] Understanding the memory profiler">randyficker at gmail.com
       </A><BR>
    <I>Thu Nov  1 07:06:51 UTC 2012</I>
    <P><UL>
        
        <LI>Next message: <A HREF="012324.html">[MonoTouch] Code Collaboration online
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12323">[ date ]</a>
              <a href="thread.html#12323">[ thread ]</a>
              <a href="subject.html#12323">[ subject ]</a>
              <a href="author.html#12323">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rolf,

 

Indeed, I never remove these objects from their parent view.  Therefore, I
repeated this process for its parent, and found the same thing. So I
continued all the way up the tree until I got to the UIViewController:
<A HREF="http://i.imgur.com/hRgzZ.png">http://i.imgur.com/hRgzZ.png</A>

 

It certainly feels like we're getting closer to the root cause, but
unfortunately I'm still not able to see why the UIViewController is not
getting collected.  This gets pushed onto my UINavigationController and then
later popped off, yet for some reason the retain count is still 1 at the
end.  I fired up the mono profiler again but it just shows &lt;Other Root&gt;
under the UIViewController.

 

I tried manually calling .Dispose() on it after I popped it off of the
navigation controller. Unfortunately after disposing it MonoTouch throws
this error:

 

System.Exception: Selector invoked from objective-c on a managed object of
type WAML.Controls.Screen+MyUIViewControler (0x886DF30) that has been GC'ed
---&gt; System.MissingMethodException: No constructor found for
WAML.Controls.Screen+MyUIViewControler::.ctor(System.IntPtr)

  at System.Activator.CreateInstance (System.Type type, BindingFlags
bindingAttr, System.Reflection.Binder binder, System.Object[] args,
System.Globalization.CultureInfo culture, System.Object[]
activationAttributes) [0x00174] in
/Developer/MonoTouch/Source/mono/mcs/class/corlib/System/Activator.cs:299 

  at System.Activator.CreateInstance (System.Type type, System.Object[]
args, System.Object[] activationAttributes) [0x00000] in
/Developer/MonoTouch/Source/mono/mcs/class/corlib/System/Activator.cs:234 

  at System.Activator.CreateInstance (System.Type type, System.Object[]
args) [0x00000] in &lt;filename unknown&gt;:0 

  at MonoTouch.ObjCRuntime.Runtime.ConstructNSObject (IntPtr ptr, IntPtr
klass) [0x0000d] in
/Developer/MonoTouch/Source/monotouch/src/ObjCRuntime/Runtime.cs:210 

  --- End of inner exception stack trace ---

  at MonoTouch.ObjCRuntime.Runtime.ConstructNSObject (IntPtr ptr, IntPtr
klass) [0x00045] in
/Developer/MonoTouch/Source/monotouch/src/ObjCRuntime/Runtime.cs:215 

  at MonoTouch.ObjCRuntime.Runtime.GetNSObject (IntPtr ptr) [0x0001f] in
/Developer/MonoTouch/Source/monotouch/src/ObjCRuntime/Runtime.cs:259 

  at MonoTouch.ObjCRuntime.Runtime.GetNSObjectWrapped (IntPtr ptr) [0x00000]
in /Developer/MonoTouch/Source/monotouch/src/ObjCRuntime/Runtime.cs:276 

  at (wrapper native-to-managed)
MonoTouch.ObjCRuntime.Runtime:GetNSObjectWrapped (intptr)

  at MonoTouch.UIKit.UIApplication.Main (System.String[] args, System.String
principalClassName, System.String delegateClassName) [0x0004c] in
/Developer/MonoTouch/Source/monotouch/src/UIKit/UIApplication.cs:38 

  at WamlEntryPoint.Main (System.String[] args) [0x00000] in
/Users/user/Desktop/WarLight/Project/WamlEntryPoint.cs:35

 

Does this mean something in MonoTouch is still referencing it?  Where can I
go from here?

 

Thanks!

 

From: Rolf Bjarne Kvinge [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">rolf at xamarin.com</A>] 
Sent: Wednesday, October 31, 2012 5:29 AM
To: Randy Ficker
Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">monotouch at lists.ximian.com</A>
Subject: Re: [MonoTouch] Understanding the memory profiler

 

Hi,

On Wed, Oct 31, 2012 at 12:29 PM, Randy Ficker &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">randyficker at gmail.com</A>&gt;
wrote:

Hey Rolf,

 

Okay, I enabled reference counting as you showed and examined an object that
I'm 100% sure should have been released:  <A HREF="http://i.imgur.com/qdj4v.png">http://i.imgur.com/qdj4v.png</A>

 

I see monotouch_retain_trampoline doing 4 retains and 2 releases.  Here's
the full stacktraces from all events: <A HREF="http://pastebin.com/jmYzQWHn">http://pastebin.com/jmYzQWHn</A>

 

The first two retains have identical stack traces.  I can tell from the
stack trace that these are both happening when I insert the UIView into the
visual tree (I'm just passing it to InsertSubview)

 

The third and fourth retains are getting released immediately after they're
taken with an almost identical stack trace.  So I believe the big question
is: why aren't the first two retains getting released?

 

I'm gathering that MonoTouch calls retain when a view is added to the visual
tree (twice?).  Under normal operation, when would the corresponding
releases get called, and do you have any idea why this might not be
happening here?

 

This is a bit confusing, but the fact that monotouch_retain_trampoline shows
up in the stack trace does not mean that MonoTouch (or your code) directly
called retain - we override the retain selectors for all objects so
monotouch_retain_trampoline will show up in every retain stack trace. You
have to look a little bit further down to see exactly who is retaining your
object. 

 

In fact it is iOS who calls retain when you insert the objects into the
visual tree:

 

2 iosWarLight monotouch_retain_trampoline
/Developer/MonoTouch/Source/monotouch/libmonotouch/monotouch-glue.m:1179

3 UIKit -[UIView(Internal) _addSubview:positioned:relativeTo:] 

4 UIKit -[UIView(Hierarchy) insertSubview:atIndex:] 

 

Do you ever remove those objects from the container they're added to? If you
don't, but believe the container should be freed (and thus automatically
release those inserted objects), you need to do the same procedure for the
container to see why that object isn't freed.

 

Rolf

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20121101/91992d5b/attachment.html">http://lists.ximian.com/pipermail/monotouch/attachments/20121101/91992d5b/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="012324.html">[MonoTouch] Code Collaboration online
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12323">[ date ]</a>
              <a href="thread.html#12323">[ thread ]</a>
              <a href="subject.html#12323">[ subject ]</a>
              <a href="author.html#12323">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
