<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] When to implement Foo(IntPtr) constructors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20When%20to%20implement%20Foo%28IntPtr%29%20constructors&In-Reply-To=%3COF12696E9E.C5E98660-ON86257A4C.0054EF88-86257A4C.00551BCE%40ni.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010983.html">
   <LINK REL="Next"  HREF="010997.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] When to implement Foo(IntPtr) constructors</H1>
    <B>Adam Kemp</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20When%20to%20implement%20Foo%28IntPtr%29%20constructors&In-Reply-To=%3COF12696E9E.C5E98660-ON86257A4C.0054EF88-86257A4C.00551BCE%40ni.com%3E"
       TITLE="[MonoTouch] When to implement Foo(IntPtr) constructors">adam.kemp at ni.com
       </A><BR>
    <I>Tue Jul 31 15:29:37 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="010983.html">[MonoTouch] When to implement Foo(IntPtr) constructors
</A></li>
        <LI>Next message: <A HREF="010997.html">[MonoTouch] When to implement Foo(IntPtr) constructors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10996">[ date ]</a>
              <a href="thread.html#10996">[ thread ]</a>
              <a href="subject.html#10996">[ subject ]</a>
              <a href="author.html#10996">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I finally narrowed this down to a smaller test case that shows what I 
think is a bug. Here is the bug report:
<A HREF="https://bugzilla.xamarin.com/show_bug.cgi?id=6338">https://bugzilla.xamarin.com/show_bug.cgi?id=6338</A>

The missing piece from my previous attempts to reproduce it in a smaller 
example was a UINavigationController. Having one of those in the picture 
is somehow convincing the runtime that it needs to reconstruct my managed 
object, and I don't think it should need to in this case. I have a 
workaround now (dispose the navigation controller as well), but I filed 
the bug report anyway so maybe someone can explain what's going on.

Thanks.
--
Adam Kemp
<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>
(512) 683-6058

Nic Wise &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">nicw at fastchicken.co.nz</A>&gt; wrote on 07/30/2012 04:05:54 PM:

&gt;<i> From: Nic Wise &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">nicw at fastchicken.co.nz</A>&gt;
</I>&gt;<i> To: Adam Kemp &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>&gt;
</I>&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">monotouch at lists.ximian.com</A>, Rolf Bjarne Kvinge 
</I>&gt;<i> &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">rolf at xamarin.com</A>&gt;, Sebastien Pouliot &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">sebastien at xamarin.com</A>&gt;
</I>&gt;<i> Date: 07/30/2012 04:05 PM
</I>&gt;<i> Subject: Re: [MonoTouch] When to implement Foo(IntPtr) constructors
</I>&gt;<i> 
</I>&gt;<i> Hi Adam
</I>&gt;<i> 
</I>&gt;<i> If you have a reproducible case, make a bugzilla bug with it
</I>&gt;<i> (bugzilla.xamarin.com) and email <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">support at xamarin</A> with a reference to
</I>&gt;<i> it. They can then assign it to the right person to have a look at.
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Nic
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Mon, Jul 30, 2012 at 2:26 PM, Adam Kemp &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>&gt; wrote:
</I>&gt;<i> &gt; Thanks for the response, Nic. That explanation makes sense to me, but 
</I>it
&gt;<i> &gt; doesn't really answer why in this particular case the MonoTouch 
</I>runtime
&gt;<i> &gt; wants to resurrect the managed object. I am in fact releasing my last
</I>&gt;<i> &gt; reference to that object, but that is because I really am completely 
</I>done
&gt;<i> &gt; with it. It should actually be leaving memory. That is, when that 
</I>managed
&gt;<i> &gt; reference goes away the unmanaged reference should leave memory as 
</I>well.
&gt;<i> &gt;
</I>&gt;<i> &gt; What's happening in this case is that the UIViewController base class
</I>&gt;<i> &gt; subscribes to a notification for low memory warnings. I am releasing 
</I>my
&gt;<i> &gt; last managed reference to this view controller in my own handler for 
</I>low
&gt;<i> &gt; memory warnings (in a different view controller), but something 
</I>(perhaps
&gt;<i> &gt; an autorelease call?) is keeping the view controller I want to go away 
</I>to
&gt;<i> &gt; stay in memory long enough to want to handle that low memory 
</I>notification.
&gt;<i> &gt; This is the behavior that I can reproduce in a test project. However, 
</I>in
&gt;<i> &gt; my test project I can only get it to reproduce if I override 
</I>ViewDidUnload
&gt;<i> &gt; or DidReceiveMemoryWarning in the view controller that I want to go 
</I>away.
&gt;<i> &gt; In my real project I didn't implement either one of those, and yet it 
</I>is
&gt;<i> &gt; being resurrected anyway. As I said, the only method I override in 
</I>this
&gt;<i> &gt; view controller class is ViewDidLoad, and that method is not being 
</I>called.
&gt;<i> &gt; Why would the runtime try to reconstruct the managed object if it's 
</I>not
&gt;<i> &gt; needed by anything? If I could get some kind of hint in the debugger 
</I>about
&gt;<i> &gt; why it's being reconstructed then that would help.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My main concern is that in this case if I can't release the reference 
</I>to
&gt;<i> &gt; this view controller here then I'm not sure where I could safely 
</I>release
&gt;<i> &gt; it. The view controller is no longer on screen. It shouldn't be 
</I>referenced
&gt;<i> &gt; by anything else. There's no reason I can think of that it shouldn't 
</I>be
&gt;<i> &gt; safe to allow it to leave memory at this point. I'd like to get to the
</I>&gt;<i> &gt; bottom of why it is being resurrected.
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Adam Kemp
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>
</I>&gt;<i> &gt; (512) 683-6058
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Nic Wise &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">nicw at fastchicken.co.nz</A>&gt; wrote on 07/30/2012 01:01:26 PM:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; From: Nic Wise &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">nicw at fastchicken.co.nz</A>&gt;
</I>&gt;<i> &gt;&gt; To: Adam Kemp &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>&gt;
</I>&gt;<i> &gt;&gt; Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">monotouch at lists.ximian.com</A>, Sebastien Pouliot
</I>&gt;<i> &gt;&gt; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">sebastien at xamarin.com</A>&gt;, Rolf Bjarne Kvinge &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">rolf at xamarin.com</A>&gt;
</I>&gt;<i> &gt;&gt; Date: 07/30/2012 01:01 PM
</I>&gt;<i> &gt;&gt; Subject: Re: [MonoTouch] When to implement Foo(IntPtr) constructors
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Hi Adam
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; You really need a reply from Rolf or Sebastian, but they are in 
</I>Boston
&gt;<i> &gt;&gt; at the moment at the (annual?) company meetup. I've CCed them, but I
</I>&gt;<i> &gt;&gt; dont know how much spare time they have this week.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; So, just so this doesn't drop off the bottom of the list, this SO 
</I>item
&gt;<i> &gt;&gt; from Miguel explains it well:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; <A HREF="http://stackoverflow.com/questions/5623223/no-constructor-found-for-">http://stackoverflow.com/questions/5623223/no-constructor-found-for-</A>
</I>&gt;<i> &gt;&gt; viewcontroller-ctorsystem-intptr
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I suspect that it might be a case where you need to keep a reference
</I>&gt;<i> &gt;&gt; to the object in a class-local variable, rather than a method-local
</I>&gt;<i> &gt;&gt; one or just assigning it to a (obj-c?) object.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I've never really implemented them, tho maybe I should :). I used to
</I>&gt;<i> &gt;&gt; have the same exceptions as this, but I've not seen it in live debug
</I>&gt;<i> &gt;&gt; logs for ages - it's possible that the GC got fixed (or improved)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Drop the list an email back if that doesn't answer your question
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Cheers
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Nic
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Fri, Jul 27, 2012 at 8:10 PM, Adam Kemp &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt; I'm hitting a crash when receiving memory warnings in some 
</I>situations.
&gt;<i> &gt; In
</I>&gt;<i> &gt;&gt; &gt; one view controller (A) we are handling the memory warning by 
</I>calling
&gt;<i> &gt;&gt; &gt; Dispose() on another view controller (B) which is no longer 
</I>necessary.
&gt;<i> &gt;&gt; &gt; Unfortunately, something later on during the process of the 
</I>(native)
&gt;<i> &gt;&gt; &gt; memory warning handling code is trying to call a method in view
</I>&gt;<i> &gt; controller
</I>&gt;<i> &gt;&gt; &gt; B, and it's trying to construct a managed object to do so. This 
</I>causes
&gt;<i> &gt; an
</I>&gt;<i> &gt;&gt; &gt; exception because I don't have a constructor which takes an IntPtr 
</I>so
&gt;<i> &gt; the
</I>&gt;<i> &gt;&gt; &gt; runtime can't construct the managed object.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; I know that if implementing the IntPtr constructor the crash 
</I>doesn't
&gt;<i> &gt;&gt; &gt; occur. I also know that it goes away if I remove the call to 
</I>Dispose,
&gt;<i> &gt; but
</I>&gt;<i> &gt;&gt; &gt; I don't think that's a guaranteed fix since the object could still 
</I>be
&gt;<i> &gt;&gt; &gt; GCed. I'm looking for the &quot;right&quot; fix, but I have several 
</I>unanswered
&gt;<i> &gt;&gt; &gt; questions about what is going on that I need to find an answer to 
</I>in
&gt;<i> &gt; order
</I>&gt;<i> &gt;&gt; &gt; to find it.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; The first question is what method is being called on view 
</I>controller
&gt;<i> &gt; B,
</I>&gt;<i> &gt;&gt; &gt; and why is it wanting a managed object to call that method? I don't
</I>&gt;<i> &gt; have
</I>&gt;<i> &gt;&gt; &gt; an override for DidReceiveMemoryWarning or ViewDidUnload. In fact, 
</I>the
&gt;<i> &gt;&gt; &gt; only override in that view controller (which inherits directly from
</I>&gt;<i> &gt;&gt; &gt; UITableViewController) is ViewDidLoad. The exception tells me
</I>&gt;<i> &gt; &quot;Selector
</I>&gt;<i> &gt;&gt; &gt; invoked from objective-c on a managed object (0xB9E72D0) that has 
</I>been
&gt;<i> &gt;&gt; &gt; GC'ed&quot;, but it won't tell me which selector was invoked. In a 
</I>simpler
&gt;<i> &gt; test
</I>&gt;<i> &gt;&gt; &gt; case that I created I could only reproduce the crash if I overrode
</I>&gt;<i> &gt; either
</I>&gt;<i> &gt;&gt; &gt; DidReceiveMemoryWarning or ViewDidUnload, but in my full 
</I>application I
&gt;<i> &gt; get
</I>&gt;<i> &gt;&gt; &gt; the crash even though I haven't implemented either. I don't 
</I>understand
&gt;<i> &gt;&gt; &gt; why. Is there a trick to figuring out which method is being invoked
</I>&gt;<i> &gt; when
</I>&gt;<i> &gt;&gt; &gt; this exception occurs?
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; The second question is what are the rules for when we are expected 
</I>to
&gt;<i> &gt;&gt; &gt; implement the IntPtr constructor for classes that inherit from
</I>&gt;<i> &gt; NSObject? I
</I>&gt;<i> &gt;&gt; &gt; don't want to blindly add it to every class, especially since in 
</I>some
&gt;<i> &gt;&gt; &gt; cases it probably can't be implemented in a sane way at all (the
</I>&gt;<i> &gt; Dispose
</I>&gt;<i> &gt;&gt; &gt; method might have released resources that you can't get back 
</I>without
&gt;<i> &gt;&gt; &gt; arguments from a real constructor). Is there some rule for this? 
</I>Does
&gt;<i> &gt; my
</I>&gt;<i> &gt;&gt; &gt; situation fit that rule?
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt; Thanks.
</I>&gt;<i> &gt;&gt; &gt; --
</I>&gt;<i> &gt;&gt; &gt; Adam Kemp
</I>&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">adam.kemp at ni.com</A>
</I>&gt;<i> &gt;&gt; &gt; (512) 683-6058
</I>&gt;<i> &gt;&gt; &gt; _______________________________________________
</I>&gt;<i> &gt;&gt; &gt; MonoTouch mailing list
</I>&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; --
</I>&gt;<i> &gt;&gt; Nic Wise
</I>&gt;<i> &gt;&gt; t.  +44 7788 592 806 | @fastchicken | 
</I><A HREF="http://www.linkedin.com/in/nicwise">http://www.linkedin.com/in/nicwise</A>
&gt;<i> &gt;&gt; b. <A HREF="http://www.fastchicken.co.nz/">http://www.fastchicken.co.nz/</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; mobileAgent (for FreeAgent): get your accounts in your pocket.
</I>&gt;<i> &gt;&gt; <A HREF="http://goo.gl/IuBU">http://goo.gl/IuBU</A>
</I>&gt;<i> &gt;&gt; Trip Wallet: Keep track of your budget on the go: <A HREF="http://goo.gl/ePhKa">http://goo.gl/ePhKa</A>
</I>&gt;<i> &gt;&gt; Earnest: Self-employed? Track your business expenses and income.
</I>&gt;<i> &gt;&gt; <A HREF="http://earnestapp.com">http://earnestapp.com</A>
</I>&gt;<i> &gt;&gt; Nearest Bus: find when the next bus is coming to your stop. <A HREF="http://">http://</A>
</I>&gt;<i> &gt;&gt; goo.gl/Vcz1p
</I>&gt;<i> &gt;&gt; London Bike App: Find the nearest Boris Bike, and get riding!
</I>&gt;<i> &gt;&gt; <A HREF="http://goo.gl/Icp2">http://goo.gl/Icp2</A>
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Nic Wise
</I>&gt;<i> t.  +44 7788 592 806 | @fastchicken | <A HREF="http://www.linkedin.com/in/nicwise">http://www.linkedin.com/in/nicwise</A>
</I>&gt;<i> b. <A HREF="http://www.fastchicken.co.nz/">http://www.fastchicken.co.nz/</A>
</I>&gt;<i> 
</I>&gt;<i> mobileAgent (for FreeAgent): get your accounts in your pocket.
</I>&gt;<i> <A HREF="http://goo.gl/IuBU">http://goo.gl/IuBU</A>
</I>&gt;<i> Trip Wallet: Keep track of your budget on the go: <A HREF="http://goo.gl/ePhKa">http://goo.gl/ePhKa</A>
</I>&gt;<i> Earnest: Self-employed? Track your business expenses and income.
</I>&gt;<i> <A HREF="http://earnestapp.com">http://earnestapp.com</A>
</I>&gt;<i> Nearest Bus: find when the next bus is coming to your stop. <A HREF="http://">http://</A>
</I>&gt;<i> goo.gl/Vcz1p
</I>&gt;<i> London Bike App: Find the nearest Boris Bike, and get riding! 
</I>&gt;<i> <A HREF="http://goo.gl/Icp2">http://goo.gl/Icp2</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010983.html">[MonoTouch] When to implement Foo(IntPtr) constructors
</A></li>
	<LI>Next message: <A HREF="010997.html">[MonoTouch] When to implement Foo(IntPtr) constructors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10996">[ date ]</a>
              <a href="thread.html#10996">[ thread ]</a>
              <a href="subject.html#10996">[ subject ]</a>
              <a href="author.html#10996">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
