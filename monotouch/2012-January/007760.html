<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Lazy loading help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Lazy%20loading%20help&In-Reply-To=%3C1328041921338-4345783.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007758.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Lazy loading help</H1>
    <B>ilmdaniel</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Lazy%20loading%20help&In-Reply-To=%3C1328041921338-4345783.post%40n4.nabble.com%3E"
       TITLE="[MonoTouch] Lazy loading help">ilmdaniel at yahoo.com
       </A><BR>
    <I>Tue Jan 31 20:32:01 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="007758.html">[MonoTouch] Updating XCode project (or not!) when source files	on network
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7760">[ date ]</a>
              <a href="thread.html#7760">[ thread ]</a>
              <a href="subject.html#7760">[ subject ]</a>
              <a href="author.html#7760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi guys,

Ok, I really need your help on this one.

I'm trying to use the iCarousel library in monotouch. I successfully ported
the library, everything works perfectly but the application crashes if you
enter too many UIImageViews with images inside, which is normal because
iCarousel is just like a UIScrollView.

I definitely have to use lazy loading system somehow from a secondary thread
and display only 3-4 images at once but I do not know how to make this work
smooth.

At this point, I set this in the iCarousel Delegate:

bool threadsAlive = true;

public cDelegate()
{
    ThreadPool.QueueUserWorkItem( delegate { refresh_visible(); } );
}

public override void DidScroll (iCarousel carousel)
{
	scrolling = true;
}

public override void DidEndScrollingAnimation (iCarousel carousel)
{
	scrolling = false;	
	//show images that are currently on the screen
	ThreadPool.QueueUserWorkItem( delegate { ShowCurrent();         } );
	//hides images that are not on the screen        
	ThreadPool.QueueUserWorkItem( delegate { hideInvisibleImages(); } );
}

void refresh_visible()
{
	while( threadsAlive )
	{
		while( scrolling )
		{
			ShowCurrent();
		}
	}
}

void refresh_hidden()
{
	while( threadsAlive )
	{
		while( scrolling )
		{
			hideInvisibleImages();
		}
	}
}

public void ShowCurrent()
{
	var          ds = _carousel.DataSource as cDataSource;
	var left_index  = _carousel.CurrentItemIndex - 1;
	var right_index = _carousel.CurrentItemIndex + 2;
	if( left_index  &lt;  0 ) left_index  = 0;
	if( right_index &gt;= ds.Lista.Count ) right_index = ds.Lista.Count - 1;
	//
	for( var i = left_index; i &lt; right_index ; i++ )
	{
		var img = ds.Lista[i];
		if( img.Image == null )
		{
			BeginInvokeOnMainThread( delegate{
				img.Image = UIImage.FromFile( img.UserObject.ToString() );
			});
		}
	}
}


void hideInvisibleImages()
{
	Console.WriteLine(&quot;ascund!&quot;);
	var          ds = _carousel.DataSource as cDataSource;
	var left_index  = _carousel.CurrentItemIndex - 1;
	var right_index = _carousel.CurrentItemIndex + 2;
	if( left_index  &lt;  0 ) left_index  = 0;
	if( right_index &gt;= ds.Lista.Count ) right_index = ds.Lista.Count - 1;
	//
	for( var i=0; i&lt;left_index; i++ )
	{
		var img   = ds.Lista[i];
		if( img.Image != null )
		{
			img.Image.Dispose();
			img.Image = null;
		}
	}
	for( var i=right_index; i&lt;ds.Lista.Count; i++ )
	{
		var img   = ds.Lista[i];
		if( img.Image != null )
		{
			img.Image.Dispose();
			img.Image = null;
		}
	}
}

The code is actually very simple: there is a main thread that only shows 1
image from the left of the current index and two images in advance, and
another thread that cleans all other images, hides them.

It's working, memory is ok, but it's not smooth on the device, it &quot;hangs&quot; a
little when I scroll.  There is another way of doing this ? Or maybe I
should change the algoritm? 

--
View this message in context: <A HREF="http://monotouch.2284126.n4.nabble.com/Lazy-loading-help-tp4345783p4345783.html">http://monotouch.2284126.n4.nabble.com/Lazy-loading-help-tp4345783p4345783.html</A>
Sent from the MonoTouch mailing list archive at Nabble.com.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007758.html">[MonoTouch] Updating XCode project (or not!) when source files	on network
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7760">[ date ]</a>
              <a href="thread.html#7760">[ thread ]</a>
              <a href="subject.html#7760">[ subject ]</a>
              <a href="author.html#7760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
