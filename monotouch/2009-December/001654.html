<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch]  Mono/MonoTouch Embedding problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20%20Mono/MonoTouch%20Embedding%20problem&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001653.html">
   <LINK REL="Next"  HREF="001655.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch]  Mono/MonoTouch Embedding problem</H1>
    <B>Levente Babos</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20%20Mono/MonoTouch%20Embedding%20problem&In-Reply-To="
       TITLE="[MonoTouch]  Mono/MonoTouch Embedding problem">Levente.Babos at fh-landshut.de
       </A><BR>
    <I>Mon Dec  7 08:17:16 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001653.html">[MonoTouch] APNS, MonoTouch and MD
</A></li>
        <LI>Next message: <A HREF="001655.html">[MonoTouch] Mono/MonoTouch Embedding problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1654">[ date ]</a>
              <a href="thread.html#1654">[ thread ]</a>
              <a href="subject.html#1654">[ subject ]</a>
              <a href="author.html#1654">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all!

I have a problem with embedding a C#-Mono-program into a XCode application.

My GUI is made in ObjC/XCode. From here, I want to call methods in my
C#-program. I've compiled the C#-solution and used &quot;mtouch
--xcode=output_dir MyMonoAssembly.exe&quot; to get the embedding-code (.m, .s
files, etc.). Then I replaced the XCode &quot;main.m&quot; with the mtouch main.m and
added the code to call the ObjC-GUI (for code see below). In the XCode GUI
App-Delegate I have an event handler (IBAction) for a button, which should
trigger a method call in my C#-assembly.

So far I could load the Mono runtime and instantiate a C#-class from Obj-C.
But now I have a problem with calling methods. I tried several things to get
a handle for the desired methods using the Mono-Embedding-API, but it
doesn't work. When I iterate through the methods of a class, I always get
ONE method only, even if there are more in the class.

Is this a bug or am I doing something wrong?

Below is an example of what I'm trying to do.

Versions used:
Mono: 2.4.2.3
MonoTouch: 1.3.1
MonoDevelop 2.2 RC 20091111-1
XCode: 3.1
iPhone SDK: 3.1

C# Main Application Class:
------------------------------------------------------------------
namespace MyMonoSample
{
	public class Application
	{	
		static void Main (string[] args)
		{
			Console.WriteLine(&quot;Mono app started
-------------------------&quot;);
			// next line isn't needed as the GUI is in Obj-C
			//UIApplication.Main (args);
		}

		// I'd like to call this method &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
		public int calc(int a, int b) {
			return a + b;	
		}
		
	}
}

main.m in XCode (heavily truncated)
------------------------------------------------------------------
	MonoAssembly *assembly;
	char *managed_argv[] = { &quot;MyMonoSample.exe&quot; };
	//...
	mono_config_parse_memory ((const char*) mtouch_config);
	mono_register_machine_config ((const char*) mtouch_machine_config);
	mono_jit_init_version (&quot;iPhone#-MyMonoSample&quot;, &quot;v2.0.50727&quot;);
	
	monotouch_init ();
	monotouch_register (mono_assembly_load_with_partial_name
(&quot;monotouch&quot;, NULL));

	// Load and register my assembly
	assembly = mono_assembly_load_with_partial_name (&quot;MyMonoSample&quot;,
NULL);
	monotouch_register (assembly);
	//...
	// Execute assembly
	mono_jit_exec(mono_domain_get(), assembly, 1, managed_argv);
	
	// Start Obj-C GUI
	int retVal = UIApplicationMain(argc, argv, nil, nil);
	[pool release];
	
	return retVal;

MyProgAppDelegate.m
------------------------------------------------------------------
// ...
#include &lt;mono/jit/jit.h&gt;
#include &lt;mono/metadata/assembly.h&gt;
#include &lt;mono/metadata/mono-config.h&gt;
#include &lt;mono/metadata/mono-debug.h&gt;
#include &lt;mono/metadata/debug-helpers.h&gt;
#include &lt;monotouch/gc.h&gt;
#include &lt;monotouch/monotouch.h&gt;

	MonoAssembly *assembly;
	MonoDomain *domain;

@implementation MyProgAppDelegate

@synthesize window;

- (IBAction) buttonPressed
{
	NSLog(@&quot;*** oink ***&quot;);
	
	// Get image from assembly
	MonoImage *image = mono_assembly_get_image(assembly);
	
	if (image) {
		NSLog(@&quot;---- Image found&quot;);
	} else {
		NSLog(@&quot;---- Image NOT found&quot;);
	}

	// Get class from image
	MonoClass *myClass = mono_class_from_name(image, &quot;MyMonoSample&quot;,
&quot;Application&quot;);

	if (myClass)
		NSLog(@&quot;---- Class found&quot;);
	else {
		NSLog(@&quot;---- Class NOT found&quot;);
	}

	
	// Allocate memory for object
	MonoObject *myObject = mono_object_new(domain, myClass);
	
	// Do not call constructor, since there is none
	//mono_runtime_object_init(myObject);
	
	// Tell GC to keep a handle on my object and do not destroy it right
away
	mono_gchandle_new(myObject, 1);
	
	// Method lookup ------------------------------

	// First, make a MonoMethodDesc	
	MonoMethodDesc *myMethodDesc = mono_method_desc_new(&quot;:calc(int,
int)&quot;, 0);

	// Then, search in class. Neither one works.
	MonoMethod *myMethod =
mono_method_desc_search_in_class(myMethodDesc, myClass);
	//or: MonoMethod *myMethod =
mono_method_desc_search_in_image(myMethodDesc, image);
	//or: MonoMethod *myMethod =
mono_class_get_method_from_name(myClass, &quot;calc()&quot;, 2);	

	if (myMethod) {
		NSLog(@&quot;---- Method found&quot;);
	} else {
		NSLog(@&quot;---- Method NOT found&quot;);
	}

	// Since that doesn't work, print ALL methods of the class
	MonoMethod *m;
	gpointer iter = NULL;
	
	while ((m = mono_class_get_methods(myClass, &amp;iter))) {
		NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:
mono_method_get_name(m)]);
	}

	// Now give me the number of all methods
	// PROBLEM: Always shows &quot;1&quot;, even with other test-classes. Other
methods doesn't seem to be visible.
	NSLog(@&quot;Number of Methods in class: %i&quot;,
mono_class_num_methods(myClass));
	
	// If I had a method handle, this is how I'd continue
--------------------------------------
	
	/*
	void *args[2];
	int param1 = 1;
	int param2 = 2;
	args[0] = &amp;param1;
	args[1] = &amp;param2;
	
	MonoObject *result = mono_runtime_invoke(myMethod, myObject, args,
NULL);
	int int_result = *(int*)mono_object_unbox(result);
	
	NSLog(@&quot;==== Result: %i&quot;, int_result);
	*/
	NSLog(@&quot;---------End---------&quot;);
}

- (void)applicationDidFinishLaunching:(UIApplication *)application {    

    // Override point for customization after application launch
    [window makeKeyAndVisible];
		
	// Set domain and assembly
	domain = mono_domain_get();
	assembly = mono_assembly_loaded(&quot;MyMonoSample&quot;);
	NSLog(@&quot;---- GUI loaded&quot;);
}
// ...

Console output
------------------------------------------------------------------
---- GUI loaded
*** oink *** (after button pressed)
---- Image found
---- Class found
---- Method NOT found
Main (iteration of all methods)
Number of Methods in class: 1
---------End---------


</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001653.html">[MonoTouch] APNS, MonoTouch and MD
</A></li>
	<LI>Next message: <A HREF="001655.html">[MonoTouch] Mono/MonoTouch Embedding problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1654">[ date ]</a>
              <a href="thread.html#1654">[ thread ]</a>
              <a href="subject.html#1654">[ subject ]</a>
              <a href="author.html#1654">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
