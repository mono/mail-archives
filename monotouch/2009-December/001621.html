<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] CGImageCreate?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20CGImageCreate%3F&In-Reply-To=92216DC6-BEE8-4927-9891-DF60C5E8AE93%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001620.html">
   <LINK REL="Next"  HREF="001622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] CGImageCreate?</H1>
    <B>Frank Krueger</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20CGImageCreate%3F&In-Reply-To=92216DC6-BEE8-4927-9891-DF60C5E8AE93%40novell.com"
       TITLE="[MonoTouch] CGImageCreate?">fak at kruegersystems.com
       </A><BR>
    <I>Wed Dec  2 03:44:13 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001620.html">[MonoTouch] How to do NUnit test that referes Mono.Data.SQLite	on MonoTouch ?
</A></li>
        <LI>Next message: <A HREF="001622.html">[MonoTouch] CGImageCreate?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1621">[ date ]</a>
              <a href="thread.html#1621">[ thread ]</a>
              <a href="subject.html#1621">[ subject ]</a>
              <a href="author.html#1621">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Thanks for the patch Miguel, I've recently come to need it.

I have been able to use it successfully, but I wanted to mention a few small
&quot;gotchas&quot; that I've run into during development. Here is my function that
takes a byte array (_data) and constructs a UIImage from it:

public UIImage GetUIImage() {
UIImage image = null;
 _dataPtr = Marshal.AllocHGlobal(_data.Length);
Marshal.Copy(_data, 0, _dataPtr, _data.Length);
 using (var colorSpace = CGColorSpace.CreateDeviceRGB()) {
var provider = new CGDataProvider (_dataPtr, _data.Length);
var cgi = new CGImage(Width, Height,
              8, 32, Width*4,
                      colorSpace,
(CGBitmapFlags)CGImageAlphaInfo.PremultipliedFirst,
                      provider,
                      null, false, CGColorRenderingIntent.Default);
image = UIImage.FromImage(cgi);
}
 return image;
}


   - You'll notice that in this code I do not call Marshal.Free. That is
   because the image data is loaded lazily (or maybe even on-demand!), so I
   have to keep the buffer alive until then. (To keep things simple, I've
   created an IDisposable reference to that buffer. This is fine for my
   application, but its not pretty.) The problem is simply that the
   CGDataProvider is retained, but it doesn't &quot;retain&quot; the HGlobal. Not sure if
   there is anything the library can do about this though.
   - I had to cast a CGImageAlphaInfo to CGBitmapFlags. In the Apple API and
   docs, these are two different C enums, however CoreGraphics treats them as
   one set of flags. On the CGBitmapContext constructor, we
   have CGImageAlphaInfo whereas CGBitmapFlags has been used for the CGImage
   constructor. It would be nice to get this cleaned up.
   - There seems to be a 90 deg rotation somewhere between CGBitmapContexts,
   CGImage, and UIImage. Everything comes out sideways. :-) Again, not really
   your problem, but something to watch out for.

Thanks again!
-Frank


On Sun, Nov 29, 2009 at 4:55 PM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">miguel at novell.com</A>&gt; wrote:

&gt;<i> Hello Ed,
</I>&gt;<i>
</I>&gt;<i>      Please download:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://tirania.org/tmp/monotouch.dll">http://tirania.org/tmp/monotouch.dll</A>
</I>&gt;<i>
</I>&gt;<i>     After backing up your
</I>&gt;<i> /Developer/MonoTouch/usr/lib/mono/2.1/monotouch.dll, override it with this
</I>&gt;<i> file.
</I>&gt;<i>
</I>&gt;<i>     You can now use CGDataProvider like this:
</I>&gt;<i>
</I>&gt;<i> using (var image = new CGDataProvider (your_memory_block, size_of_block)){
</I>&gt;<i> var image = new CGImage (...., provider, ...);
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>      Let me know if there are any problems with it.
</I>&gt;<i>
</I>&gt;<i> On Nov 28, 2009, at 1:44 AM, Ed Anuff wrote:
</I>&gt;<i>
</I>&gt;<i> Hi Miguel, thanks for looking into this.  I've got an image decoder for an
</I>&gt;<i> image format that UIImage doesn't support.  The image decoder returns a raw
</I>&gt;<i> RGB byte array of the pixels.  I had hoped to use CGImageCreate to convert
</I>&gt;<i> these into a CGImage and then a UIImage since CGImageCreate is very flexible
</I>&gt;<i> in terms of the source data it can process.  The workaround I've implemented
</I>&gt;<i> is to convert the image data into TIFF format since UIImages can be created
</I>&gt;<i> from TIFF data and I found some fairly simple code for doing this (while
</I>&gt;<i> TIFF is a complicated format because of all the options it supports, an
</I>&gt;<i> uncompressed 24bit image can be stored by preprending a small header to the
</I>&gt;<i> raw image data and then appending some minimal metadata at the end).
</I>&gt;<i>
</I>&gt;<i> On Fri, Nov 27, 2009 at 10:20 PM, Miguel de Icaza &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">miguel at novell.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hello Ed,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Can you describe the scenario that requires these APIs?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     I am trying to determine how I should expose these functions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Nov 27, 2009, at 5:16 PM, Ed Anuff wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  I can't find a binding for CGImageCreate.  Is there anyway to use this?
</I>&gt;&gt;&gt;<i>  I'm not realy sure how to bind Core Foundation functions.  It looks like
</I>&gt;&gt;&gt;<i> CGDataProvider isn't bound either, which CGImageCreate needs.  :(
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Ed
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> MonoTouch mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> MonoTouch mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/monotouch/attachments/20091202/a1a4157c/attachment-0001.html">http://lists.ximian.com/pipermail/monotouch/attachments/20091202/a1a4157c/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001620.html">[MonoTouch] How to do NUnit test that referes Mono.Data.SQLite	on MonoTouch ?
</A></li>
	<LI>Next message: <A HREF="001622.html">[MonoTouch] CGImageCreate?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1621">[ date ]</a>
              <a href="thread.html#1621">[ thread ]</a>
              <a href="subject.html#1621">[ subject ]</a>
              <a href="author.html#1621">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
