<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Mono/MonoTouch Embedding problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Mono/MonoTouch%20Embedding%20problem&In-Reply-To=001801ca773f%249a17daa0%24ce478fe0%24%40Babos%40fh-landshut.de">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001654.html">
   <LINK REL="Next"  HREF="001658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Mono/MonoTouch Embedding problem</H1>
    <B>Geoff Norton</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=%5BMonoTouch%5D%20Mono/MonoTouch%20Embedding%20problem&In-Reply-To=001801ca773f%249a17daa0%24ce478fe0%24%40Babos%40fh-landshut.de"
       TITLE="[MonoTouch] Mono/MonoTouch Embedding problem">gnorton at novell.com
       </A><BR>
    <I>Mon Dec  7 11:13:36 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001654.html">[MonoTouch]  Mono/MonoTouch Embedding problem
</A></li>
        <LI>Next message: <A HREF="001658.html">[MonoTouch] Sql data access options, my review.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1655">[ date ]</a>
              <a href="thread.html#1655">[ thread ]</a>
              <a href="subject.html#1655">[ subject ]</a>
              <a href="author.html#1655">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Levente,

  Are you running the linker which is probably stripping the method out?

Geoff

On 2009-12-07, at 8:17 AM, Levente Babos wrote:

&gt;<i> Hi all!
</I>&gt;<i> 
</I>&gt;<i> I have a problem with embedding a C#-Mono-program into a XCode application.
</I>&gt;<i> 
</I>&gt;<i> My GUI is made in ObjC/XCode. From here, I want to call methods in my
</I>&gt;<i> C#-program. I've compiled the C#-solution and used &quot;mtouch
</I>&gt;<i> --xcode=output_dir MyMonoAssembly.exe&quot; to get the embedding-code (.m, .s
</I>&gt;<i> files, etc.). Then I replaced the XCode &quot;main.m&quot; with the mtouch main.m and
</I>&gt;<i> added the code to call the ObjC-GUI (for code see below). In the XCode GUI
</I>&gt;<i> App-Delegate I have an event handler (IBAction) for a button, which should
</I>&gt;<i> trigger a method call in my C#-assembly.
</I>&gt;<i> 
</I>&gt;<i> So far I could load the Mono runtime and instantiate a C#-class from Obj-C.
</I>&gt;<i> But now I have a problem with calling methods. I tried several things to get
</I>&gt;<i> a handle for the desired methods using the Mono-Embedding-API, but it
</I>&gt;<i> doesn't work. When I iterate through the methods of a class, I always get
</I>&gt;<i> ONE method only, even if there are more in the class.
</I>&gt;<i> 
</I>&gt;<i> Is this a bug or am I doing something wrong?
</I>&gt;<i> 
</I>&gt;<i> Below is an example of what I'm trying to do.
</I>&gt;<i> 
</I>&gt;<i> Versions used:
</I>&gt;<i> Mono: 2.4.2.3
</I>&gt;<i> MonoTouch: 1.3.1
</I>&gt;<i> MonoDevelop 2.2 RC 20091111-1
</I>&gt;<i> XCode: 3.1
</I>&gt;<i> iPhone SDK: 3.1
</I>&gt;<i> 
</I>&gt;<i> C# Main Application Class:
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> namespace MyMonoSample
</I>&gt;<i> {
</I>&gt;<i> 	public class Application
</I>&gt;<i> 	{	
</I>&gt;<i> 		static void Main (string[] args)
</I>&gt;<i> 		{
</I>&gt;<i> 			Console.WriteLine(&quot;Mono app started
</I>&gt;<i> -------------------------&quot;);
</I>&gt;<i> 			// next line isn't needed as the GUI is in Obj-C
</I>&gt;<i> 			//UIApplication.Main (args);
</I>&gt;<i> 		}
</I>&gt;<i> 
</I>&gt;<i> 		// I'd like to call this method &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> 		public int calc(int a, int b) {
</I>&gt;<i> 			return a + b;	
</I>&gt;<i> 		}
</I>&gt;<i> 		
</I>&gt;<i> 	}
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> main.m in XCode (heavily truncated)
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> 	MonoAssembly *assembly;
</I>&gt;<i> 	char *managed_argv[] = { &quot;MyMonoSample.exe&quot; };
</I>&gt;<i> 	//...
</I>&gt;<i> 	mono_config_parse_memory ((const char*) mtouch_config);
</I>&gt;<i> 	mono_register_machine_config ((const char*) mtouch_machine_config);
</I>&gt;<i> 	mono_jit_init_version (&quot;iPhone#-MyMonoSample&quot;, &quot;v2.0.50727&quot;);
</I>&gt;<i> 	
</I>&gt;<i> 	monotouch_init ();
</I>&gt;<i> 	monotouch_register (mono_assembly_load_with_partial_name
</I>&gt;<i> (&quot;monotouch&quot;, NULL));
</I>&gt;<i> 
</I>&gt;<i> 	// Load and register my assembly
</I>&gt;<i> 	assembly = mono_assembly_load_with_partial_name (&quot;MyMonoSample&quot;,
</I>&gt;<i> NULL);
</I>&gt;<i> 	monotouch_register (assembly);
</I>&gt;<i> 	//...
</I>&gt;<i> 	// Execute assembly
</I>&gt;<i> 	mono_jit_exec(mono_domain_get(), assembly, 1, managed_argv);
</I>&gt;<i> 	
</I>&gt;<i> 	// Start Obj-C GUI
</I>&gt;<i> 	int retVal = UIApplicationMain(argc, argv, nil, nil);
</I>&gt;<i> 	[pool release];
</I>&gt;<i> 	
</I>&gt;<i> 	return retVal;
</I>&gt;<i> 
</I>&gt;<i> MyProgAppDelegate.m
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> // ...
</I>&gt;<i> #include &lt;mono/jit/jit.h&gt;
</I>&gt;<i> #include &lt;mono/metadata/assembly.h&gt;
</I>&gt;<i> #include &lt;mono/metadata/mono-config.h&gt;
</I>&gt;<i> #include &lt;mono/metadata/mono-debug.h&gt;
</I>&gt;<i> #include &lt;mono/metadata/debug-helpers.h&gt;
</I>&gt;<i> #include &lt;monotouch/gc.h&gt;
</I>&gt;<i> #include &lt;monotouch/monotouch.h&gt;
</I>&gt;<i> 
</I>&gt;<i> 	MonoAssembly *assembly;
</I>&gt;<i> 	MonoDomain *domain;
</I>&gt;<i> 
</I>&gt;<i> @implementation MyProgAppDelegate
</I>&gt;<i> 
</I>&gt;<i> @synthesize window;
</I>&gt;<i> 
</I>&gt;<i> - (IBAction) buttonPressed
</I>&gt;<i> {
</I>&gt;<i> 	NSLog(@&quot;*** oink ***&quot;);
</I>&gt;<i> 	
</I>&gt;<i> 	// Get image from assembly
</I>&gt;<i> 	MonoImage *image = mono_assembly_get_image(assembly);
</I>&gt;<i> 	
</I>&gt;<i> 	if (image) {
</I>&gt;<i> 		NSLog(@&quot;---- Image found&quot;);
</I>&gt;<i> 	} else {
</I>&gt;<i> 		NSLog(@&quot;---- Image NOT found&quot;);
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	// Get class from image
</I>&gt;<i> 	MonoClass *myClass = mono_class_from_name(image, &quot;MyMonoSample&quot;,
</I>&gt;<i> &quot;Application&quot;);
</I>&gt;<i> 
</I>&gt;<i> 	if (myClass)
</I>&gt;<i> 		NSLog(@&quot;---- Class found&quot;);
</I>&gt;<i> 	else {
</I>&gt;<i> 		NSLog(@&quot;---- Class NOT found&quot;);
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	
</I>&gt;<i> 	// Allocate memory for object
</I>&gt;<i> 	MonoObject *myObject = mono_object_new(domain, myClass);
</I>&gt;<i> 	
</I>&gt;<i> 	// Do not call constructor, since there is none
</I>&gt;<i> 	//mono_runtime_object_init(myObject);
</I>&gt;<i> 	
</I>&gt;<i> 	// Tell GC to keep a handle on my object and do not destroy it right
</I>&gt;<i> away
</I>&gt;<i> 	mono_gchandle_new(myObject, 1);
</I>&gt;<i> 	
</I>&gt;<i> 	// Method lookup ------------------------------
</I>&gt;<i> 
</I>&gt;<i> 	// First, make a MonoMethodDesc	
</I>&gt;<i> 	MonoMethodDesc *myMethodDesc = mono_method_desc_new(&quot;:calc(int,
</I>&gt;<i> int)&quot;, 0);
</I>&gt;<i> 
</I>&gt;<i> 	// Then, search in class. Neither one works.
</I>&gt;<i> 	MonoMethod *myMethod =
</I>&gt;<i> mono_method_desc_search_in_class(myMethodDesc, myClass);
</I>&gt;<i> 	//or: MonoMethod *myMethod =
</I>&gt;<i> mono_method_desc_search_in_image(myMethodDesc, image);
</I>&gt;<i> 	//or: MonoMethod *myMethod =
</I>&gt;<i> mono_class_get_method_from_name(myClass, &quot;calc()&quot;, 2);	
</I>&gt;<i> 
</I>&gt;<i> 	if (myMethod) {
</I>&gt;<i> 		NSLog(@&quot;---- Method found&quot;);
</I>&gt;<i> 	} else {
</I>&gt;<i> 		NSLog(@&quot;---- Method NOT found&quot;);
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	// Since that doesn't work, print ALL methods of the class
</I>&gt;<i> 	MonoMethod *m;
</I>&gt;<i> 	gpointer iter = NULL;
</I>&gt;<i> 	
</I>&gt;<i> 	while ((m = mono_class_get_methods(myClass, &amp;iter))) {
</I>&gt;<i> 		NSLog(@&quot;%@&quot;, [NSString stringWithUTF8String:
</I>&gt;<i> mono_method_get_name(m)]);
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> 	// Now give me the number of all methods
</I>&gt;<i> 	// PROBLEM: Always shows &quot;1&quot;, even with other test-classes. Other
</I>&gt;<i> methods doesn't seem to be visible.
</I>&gt;<i> 	NSLog(@&quot;Number of Methods in class: %i&quot;,
</I>&gt;<i> mono_class_num_methods(myClass));
</I>&gt;<i> 	
</I>&gt;<i> 	// If I had a method handle, this is how I'd continue
</I>&gt;<i> --------------------------------------
</I>&gt;<i> 	
</I>&gt;<i> 	/*
</I>&gt;<i> 	void *args[2];
</I>&gt;<i> 	int param1 = 1;
</I>&gt;<i> 	int param2 = 2;
</I>&gt;<i> 	args[0] = &amp;param1;
</I>&gt;<i> 	args[1] = &amp;param2;
</I>&gt;<i> 	
</I>&gt;<i> 	MonoObject *result = mono_runtime_invoke(myMethod, myObject, args,
</I>&gt;<i> NULL);
</I>&gt;<i> 	int int_result = *(int*)mono_object_unbox(result);
</I>&gt;<i> 	
</I>&gt;<i> 	NSLog(@&quot;==== Result: %i&quot;, int_result);
</I>&gt;<i> 	*/
</I>&gt;<i> 	NSLog(@&quot;---------End---------&quot;);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> - (void)applicationDidFinishLaunching:(UIApplication *)application {    
</I>&gt;<i> 
</I>&gt;<i>    // Override point for customization after application launch
</I>&gt;<i>    [window makeKeyAndVisible];
</I>&gt;<i> 		
</I>&gt;<i> 	// Set domain and assembly
</I>&gt;<i> 	domain = mono_domain_get();
</I>&gt;<i> 	assembly = mono_assembly_loaded(&quot;MyMonoSample&quot;);
</I>&gt;<i> 	NSLog(@&quot;---- GUI loaded&quot;);
</I>&gt;<i> }
</I>&gt;<i> // ...
</I>&gt;<i> 
</I>&gt;<i> Console output
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> ---- GUI loaded
</I>&gt;<i> *** oink *** (after button pressed)
</I>&gt;<i> ---- Image found
</I>&gt;<i> ---- Class found
</I>&gt;<i> ---- Method NOT found
</I>&gt;<i> Main (iteration of all methods)
</I>&gt;<i> Number of Methods in class: 1
</I>&gt;<i> ---------End---------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> MonoTouch mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">MonoTouch at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monotouch">http://lists.ximian.com/mailman/listinfo/monotouch</A>
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001654.html">[MonoTouch]  Mono/MonoTouch Embedding problem
</A></li>
	<LI>Next message: <A HREF="001658.html">[MonoTouch] Sql data access options, my review.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1655">[ date ]</a>
              <a href="thread.html#1655">[ thread ]</a>
              <a href="subject.html#1655">[ subject ]</a>
              <a href="author.html#1655">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
