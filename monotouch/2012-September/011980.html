<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [MonoTouch] Random crashes using NSUrlProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Random%20crashes%20using%20NSUrlProtocol&In-Reply-To=%3C1348677614937-4657239.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011999.html">
   <LINK REL="Next"  HREF="011998.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[MonoTouch] Random crashes using NSUrlProtocol</H1>
    <B>Gusman</B> 
    <A HREF="mailto:monotouch%40lists.ximian.com?Subject=Re%3A%20%5BMonoTouch%5D%20Random%20crashes%20using%20NSUrlProtocol&In-Reply-To=%3C1348677614937-4657239.post%40n4.nabble.com%3E"
       TITLE="[MonoTouch] Random crashes using NSUrlProtocol">geniwab at gmail.com
       </A><BR>
    <I>Wed Sep 26 16:40:14 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="011999.html">[MonoTouch] Strange crashes debugging after upgrade to	MonoTouch 6
</A></li>
        <LI>Next message: <A HREF="011998.html">[MonoTouch] Random crashes using NSUrlProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11980">[ date ]</a>
              <a href="thread.html#11980">[ thread ]</a>
              <a href="subject.html#11980">[ subject ]</a>
              <a href="author.html#11980">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again.

I have implemented NSUrlProtocol to trap http requests and handle them.

It works well but some times i'm getting random exceptions about the client
being null, Url being null and once got a disposed exception.

It seems like sometimes the protocol is being disposed by the garbage
collector but I have a reference to the protocol handler and never dispose
it.

Any idea on how to stop this??

Here is the code of my protocol handler and the instantiation of it:


        public class ProtocolHandler : NSUrlProtocol
	{
		private NSUrlConnection Connection;

		private NSMutableUrlRequest req;

		public override NSUrlRequest Request 
		{
			get 
			{
				return req;
			}
		}

		public ProtocolHandler ()
		{
		}

		[Export (&quot;initWithRequest:cachedResponse:client:&quot;)]
		public ProtocolHandler (NSUrlRequest Request, NSCachedUrlResponse
CachedResponse, NSUrlProtocolClient Client) : base(Request, CachedResponse,
Client)
	    {
			req = (NSMutableUrlRequest)Request.MutableCopy();
			req[&quot;X-Protocol-gDocs&quot;] = &quot;Yes&quot;;
	    }       

		[Export (&quot;canInitWithRequest:&quot;)]
		public static new bool CanInitWithRequest (NSUrlRequest request)
		{
			try {
				if (request == null || request.Url == null)
					return false;

				if ((request.Url.Scheme == &quot;http&quot; || request.Url.Scheme == &quot;https&quot;) &amp;&amp;
(request.Headers == null || request.Headers [&quot;X-Protocol-gDocs&quot;] == null))
//&lt;-- random crash, Url is null.  &#191;?
					return true;

				return false;
			} catch {
				return false;
			}
	    }

		[Export (&quot;canonicalRequestForRequest:&quot;)]
		public static new NSUrlRequest GetCanonicalRequest (NSUrlRequest
forRequest)
		{
			return forRequest;
		}

		public override void StartLoading ()
		{
			ProtocolConnectionDelegate del = new ProtocolConnectionDelegate();
			del.Handler = this;
			this.Connection = new NSUrlConnection(this.Request, del);
		}

		public override void StopLoading ()
		{
			try {
				this.Connection.Cancel ();
				this.Connection.Dispose ();
				this.Connection = null;
			} catch {
			}
		}
	}


----

and on my AppDelegate:

---

                Class currentHandler;

                public override bool FinishedLaunching (UIApplication app,
NSDictionary options)
		{

			//...

			currentHandler = new Class(typeof(ProtocolHandler));

			NSUrlProtocol.RegisterClass(currentHandler);

                }



--
View this message in context: <A HREF="http://monotouch.2284126.n4.nabble.com/Random-crashes-using-NSUrlProtocol-tp4657239.html">http://monotouch.2284126.n4.nabble.com/Random-crashes-using-NSUrlProtocol-tp4657239.html</A>
Sent from the MonoTouch mailing list archive at Nabble.com.
</PRE>

































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011999.html">[MonoTouch] Strange crashes debugging after upgrade to	MonoTouch 6
</A></li>
	<LI>Next message: <A HREF="011998.html">[MonoTouch] Random crashes using NSUrlProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11980">[ date ]</a>
              <a href="thread.html#11980">[ thread ]</a>
              <a href="subject.html#11980">[ subject ]</a>
              <a href="author.html#11980">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monotouch">More information about the MonoTouch
mailing list</a><br>
</body></html>
