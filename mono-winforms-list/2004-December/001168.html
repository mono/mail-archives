<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] More System.Graphics changes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:grompf%40sublimeintervention.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001167.html">
   <LINK REL="Next"  HREF="001169.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] More System.Graphics changes
   </H1>
    <B>kangaroo
    </B> 
    <A HREF="mailto:grompf%40sublimeintervention.com"
       TITLE="[Mono-winforms-list] More System.Graphics changes">grompf@sublimeintervention.com
       </A><BR>
    <I>Thu, 9 Dec 2004 16:44:12 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001167.html">[Mono-winforms-list] More System.Graphics changes
</A></li>
        <LI> Next message: <A HREF="001169.html">[Mono-winforms-list] MonthCalendar Draing optimisations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1168">[ date ]</a>
              <a href="thread.html#1168">[ thread ]</a>
              <a href="subject.html#1168">[ subject ]</a>
              <a href="author.html#1168">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--Apple-Mail-17--232598801
Content-Transfer-Encoding: 7bit
Content-Type: text/plain;
	charset=US-ASCII;
	format=flowed

updated patch

-kangaroo

--Apple-Mail-17--232598801
Content-Transfer-Encoding: 7bit
Content-Type: application/octet-stream;
	x-unix-mode=0644;
	name=&quot;graph.diff&quot;
Content-Disposition: attachment;
	filename=graph.diff

Index: System.Drawing.dll.sources
===================================================================
--- System.Drawing.dll.sources	(revision 37438)
+++ System.Drawing.dll.sources	(working copy)
@@ -5,6 +5,7 @@
 System.Drawing/Brush.cs
 System.Drawing/Brushes.cs
 System.Drawing/CharacterRange.cs
+System.Drawing/carbonFunctions.cs
 System.Drawing/ColorConverter.cs
 System.Drawing/Color.cs
 System.Drawing/ColorTranslator.cs
Index: System.Drawing/carbonFunctions.cs
===================================================================
--- System.Drawing/carbonFunctions.cs	(revision 0)
+++ System.Drawing/carbonFunctions.cs	(revision 0)
@@ -0,0 +1,79 @@
+//
+// System.Drawing.carbonFunctions.cs
+//
+// Authors:
+//      Geoff Norton (<A HREF="mailto:gnorton@customerdna.com">gnorton@customerdna.com</A>&gt;
+//
+// Copyright (C) 2004 Novell, Inc. (<A HREF="http://www.novell.com">http://www.novell.com</A>)
+//
+// Permission is hereby granted, free of charge, to any person obtaining
+// a copy of this software and associated documentation files (the
+// &quot;Software&quot;), to deal in the Software without restriction, including
+// without limitation the rights to use, copy, modify, merge, publish,
+// distribute, sublicense, and/or sell copies of the Software, and to
+// permit persons to whom the Software is furnished to do so, subject to
+// the following conditions:
+//
+// The above copyright notice and this permission notice shall be
+// included in all copies or substantial portions of the Software.
+//
+// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
+// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
+// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
+// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
+// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
+//
+
+using System.Runtime.InteropServices;
+
+namespace System.Drawing {
+	internal class Carbon {
+		[DllImport(&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern int HIViewGetBounds (IntPtr vHnd, ref HIRect r);
+                [DllImport(&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern int HIViewConvertRect (ref HIRect r, IntPtr a, IntPtr b);
+
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern IntPtr GetControlOwner (IntPtr aView);
+
+                [DllImport(&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern int GetWindowBounds (IntPtr wHnd, uint reg, ref QRect rect);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern IntPtr GetWindowPort (IntPtr hWnd);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern int CGContextClipToRect (IntPtr cgContext, HIRect clip);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern void CreateCGContextForPort (IntPtr port, ref IntPtr cgc);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern void CGContextTranslateCTM (IntPtr cgc, double tx, double ty);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern void CGContextScaleCTM (IntPtr cgc, double x, double y);
+                [DllImport (&quot;/System/Library/Frameworks/Carbon.framework/Versions/Current/Carbon&quot;)]
+                internal static extern void CGContextFlush (IntPtr cgc);
+	}
+
+	internal struct CGSize {
+		public float width;
+		public float height;
+	}
+
+	internal struct CGPoint {
+		public float x;
+		public float y;
+	}
+
+	internal struct HIRect {
+		public CGPoint origin;
+		public CGSize size;
+	}
+
+	internal struct QRect
+	{
+		public short top;
+		public short left;
+		public short bottom;
+		public short right;
+	}
+}
Index: System.Drawing/Graphics.cs
===================================================================
--- System.Drawing/Graphics.cs	(revision 37462)
+++ System.Drawing/Graphics.cs	(working copy)
@@ -1228,7 +1228,9 @@
 		public void Flush (FlushIntention intention)
 		{
 			Status status = GDIPlus.GdipFlush (nativeObject, intention);
-                        GDIPlus.CheckStatus (status);                     
+                        GDIPlus.CheckStatus (status);                    
+			if (use_quartz_drawable)
+				Carbon.CGContextFlush (display);
 		}
 
 		[EditorBrowsable (EditorBrowsableState.Advanced)]		
@@ -1260,9 +1262,36 @@
 			IntPtr graphics;
 
 			if (use_quartz_drawable) {
-				QuartzContext qc = (QuartzContext) Marshal.PtrToStructure (hwnd, typeof (QuartzContext));
-				GDIPlus.GdipCreateFromQuartz_macosx (qc.cgContext, qc.width,qc.height, out graphics);
+				IntPtr cgContext = IntPtr.Zero;
 				
+				// Grab the window we're in
+				IntPtr window = Carbon.GetControlOwner (hwnd);
+				// Get the port of the window
+				IntPtr port = Carbon.GetWindowPort (window);
+				// Create a CGContext ref
+				Carbon.CreateCGContextForPort (port, ref cgContext);
+
+				// Get the bounds of the window
+				QRect wBounds = new QRect ();
+				Carbon.GetWindowBounds (window, 32, ref wBounds);
+			
+				// Get the bounds of the view
+				HIRect vBounds = new HIRect ();
+				Carbon.HIViewGetBounds (hwnd, ref vBounds);
+
+				// Convert the view local bounds to window coordinates
+				Carbon.HIViewConvertRect (ref vBounds, hwnd, IntPtr.Zero);
+				Carbon.CGContextTranslateCTM (cgContext, vBounds.origin.x, (wBounds.bottom-wBounds.top)-(vBounds.origin.y+vBounds.size.height));
+				/* FIXME: Do we need this or is it inherintly clipped */
+				HIRect rcClip = new HIRect ();
+				rcClip.origin.x = 0;
+				rcClip.origin.y = 0;
+				rcClip.size.width = vBounds.size.width;
+				rcClip.size.height = vBounds.size.height;
+				Carbon.CGContextClipToRect (cgContext, rcClip);
+				GDIPlus.GdipCreateFromQuartz_macosx (cgContext, (int)vBounds.size.width, (int)vBounds.size.height, out graphics);
+				
+				display = cgContext;
 				return new Graphics (graphics);
 			}
 			if (use_x_drawable) {
@@ -1985,13 +2014,6 @@
                                 return rect;
 			}
 		}
-
-		internal struct QuartzContext
-		{
-			public IntPtr cgContext;
-			public int width;
-			public int height;
-		}
 	}
 }
 

--Apple-Mail-17--232598801
Content-Transfer-Encoding: 7bit
Content-Type: text/plain;
	charset=US-ASCII;
	format=flowed


On 9-Dec-04, at 4:18 PM, Peter Dennis Bartok wrote:

&gt;<i> I think it'd be better to have the quartz stuff in a separate file.
</I>&gt;<i> quartzFunctions.cs sounds good. Similar to gdipFunctions.
</I>&gt;<i> It will me much cleaner that way.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>   Peter
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: &quot;kangaroo&quot; &lt;<A HREF="mailto:grompf@sublimeintervention.com">grompf@sublimeintervention.com</A>&gt;
</I>&gt;<i> To: &lt;<A HREF="mailto:mono-winforms-list@lists.ximian.com">mono-winforms-list@lists.ximian.com</A>&gt;
</I>&gt;<i> Date: 09 December, 2004 14:12
</I>&gt;<i> Subject: [Mono-winforms-list] More System.Graphics changes
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I've found and implemented a way to support FromHwnd for the Quartz
</I>&gt;&gt;<i> backend; however it involves some apple-only pinvoking in
</I>&gt;&gt;<i> System.Graphics;  my question is; ok to commit as is; or should I 
</I>&gt;&gt;<i> split
</I>&gt;&gt;<i> the internal structs and DllImports off into something like
</I>&gt;&gt;<i> quartzFunctions.cs?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -kangaroo
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-winforms-list maillist  -  <A HREF="mailto:Mono-winforms-list@lists.ximian.com">Mono-winforms-list@lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">http://lists.ximian.com/mailman/listinfo/mono-winforms-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> !DSPAM:41b8c048110401055871702!
</I>&gt;<i>
</I>
--Apple-Mail-17--232598801--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001167.html">[Mono-winforms-list] More System.Graphics changes
</A></li>
	<LI> Next message: <A HREF="001169.html">[Mono-winforms-list] MonthCalendar Draing optimisations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1168">[ date ]</a>
              <a href="thread.html#1168">[ thread ]</a>
              <a href="subject.html#1168">[ subject ]</a>
              <a href="author.html#1168">[ author ]</a>
         </LI>
       </UL>
</body></html>
