<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] Patch for MessageBox and XplatUIX11
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:Ashwin%20Bharambe%20%3Cashwinb%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001198.html">
   <LINK REL="Next"  HREF="001200.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] Patch for MessageBox and XplatUIX11
   </H1>
    <B>Ashwin Bharambe
    </B> 
    <A HREF="mailto:Ashwin%20Bharambe%20%3Cashwinb%40gmail.com%3E"
       TITLE="[Mono-winforms-list] Patch for MessageBox and XplatUIX11">Ashwin Bharambe &lt;ashwinb@gmail.com&gt;
       </A><BR>
    <I>Sat, 18 Dec 2004 20:20:30 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001198.html">[Mono-winforms-list] Splitter
</A></li>
        <LI> Next message: <A HREF="001200.html">[Mono-winforms-list] Patch for MessageBox and XplatUIX11
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1199">[ date ]</a>
              <a href="thread.html#1199">[ thread ]</a>
              <a href="subject.html#1199">[ subject ]</a>
              <a href="author.html#1199">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>------=_Part_1025_9589164.1103419230956
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Content-Disposition: inline

Hi all,

Attached is a patch for:
 
 - a small fix to MessageBox bug (setting Visible = false before
calling ShowDialog)
 - adds modal support for dialog windows (XplatUIX11)

As a result of this a simple MessageBox.Show(&quot;text&quot;, &quot;caption&quot;) dialog
works fine on my linux box.

Thanks,
Ashwin

PS: Do let me know about the procedure and the granularity of sending
patches. I think this is probably too small a granularity for sending
patches.

------=_Part_1025_9589164.1103419230956
Content-Type: text/x-patch; name=&quot;mboxmodalx11.patch&quot;
Content-Transfer-Encoding: quoted-printable
Content-Disposition: attachment; filename=&quot;mboxmodalx11.patch&quot;

Index: XplatUIX11.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
--- XplatUIX11.cs=09(revision 37928)
+++ XplatUIX11.cs=09(working copy)
@@ -66,6 +66,12 @@
 =09=09=09internal int=09interval;=09=09=09// in milliseconds, how long to =
hold before hover is generated
 =09=09=09internal int=09hevent;=09=09=09=09// X Atom
 =09=09}
+
+=09=09internal enum NetWindowManagerState {
+=09=09=09Remove =3D 0,
+=09=09=09Add =3D 1,
+=09=09=09Toggle =3D 2
+=09=09}
 =09=09#endregion=09// Structure Definitions
=20
 =09=09#region Local Variables
@@ -690,11 +696,29 @@
 =09=09=09// We do nothing; On X11 SetModal is used to create modal dialogs=
, on Win32 this function is used (see comment there)
 =09=09}
=20
-=09=09internal override void SetModal(IntPtr handle, bool Modal) {
-=09=09=09// We need to use the Motif window manager hints to build modal s=
tuff; see freedesktop.org
-=09=09=09throw new NotImplementedException(&quot;Finish me&quot;);
+=09=09[MonoTODO(&quot;We may want to cache the XInternAtom calls here&quot;)]
+=09=09internal override void SetModal(IntPtr handle, bool Modal)=20
+=09=09{
+=09=09=09XEvent xev =3D new XEvent();
+=09=09=09XClientMessageEvent client =3D xev.ClientMessageEvent;
+
+=09=09=09client.type =3D XEventName.ClientMessage;
+=09=09=09client.serial =3D 0;
+=09=09=09client.send_event =3D true;
+=09=09=09client.window =3D handle;
+=09=09=09client.message_type =3D (IntPtr) net_wm_state;
+=09=09=09client.format =3D 32;
+=09=09=09client.ptr1 =3D (IntPtr) (Modal ? NetWindowManagerState.Add : Net=
WindowManagerState.Remove);
+=09=09=09client.ptr2 =3D (IntPtr) XInternAtom(DisplayHandle, &quot;_NET_WM_STAT=
E_MODAL&quot;, false);
+=09=09=09client.ptr3 =3D (IntPtr) 0;
+=09=09=09client.ptr4 =3D (IntPtr) 0;
+=09=09=09client.ptr5 =3D (IntPtr) 0;
+
+=09=09=09XSendEvent(DisplayHandle, root_window, false,=20
+=09=09=09=09=09EventMask.SubstructureRedirectMask | EventMask.Substructure=
NotifyMask, ref xev);
 =09=09}
=20
+
 =09=09internal override void Invalidate (IntPtr handle, Rectangle rc, bool=
 clear) {
 =09=09=09if (clear) {
 =09=09=09=09XClearArea (DisplayHandle, handle, rc.Left, rc.Top, rc.Width, =
rc.Height, true);
Index: MessageBox.cs
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=
=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D=3D
--- MessageBox.cs=09(revision 37928)
+++ MessageBox.cs=09(working copy)
@@ -135,6 +135,7 @@
 =09=09=09=09=09InitFormsSize ();
 =09=09=09=09}
=20
+=09=09=09=09this.Visible =3D false;
 =09=09=09=09this.ShowDialog ();
=20
 =09=09=09=09return this.DialogResult;

------=_Part_1025_9589164.1103419230956--

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001198.html">[Mono-winforms-list] Splitter
</A></li>
	<LI> Next message: <A HREF="001200.html">[Mono-winforms-list] Patch for MessageBox and XplatUIX11
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1199">[ date ]</a>
              <a href="thread.html#1199">[ thread ]</a>
              <a href="subject.html#1199">[ subject ]</a>
              <a href="author.html#1199">[ author ]</a>
         </LI>
       </UL>
</body></html>
