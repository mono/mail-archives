<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] Initial MacOS/Quartz patches
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:grompf%40sublimeintervention.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001162.html">
   <LINK REL="Next"  HREF="001164.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] Initial MacOS/Quartz patches
   </H1>
    <B>kangaroo
    </B> 
    <A HREF="mailto:grompf%40sublimeintervention.com"
       TITLE="[Mono-winforms-list] Initial MacOS/Quartz patches">grompf@sublimeintervention.com
       </A><BR>
    <I>Tue, 7 Dec 2004 21:40:11 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001162.html">[Mono-winforms-list] XplatUIOSX.cs
</A></li>
        <LI> Next message: <A HREF="001164.html">[Mono-winforms-list] Initial MacOS/Quartz patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1163">[ date ]</a>
              <a href="thread.html#1163">[ thread ]</a>
              <a href="subject.html#1163">[ subject ]</a>
              <a href="author.html#1163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--Apple-Mail-3--387639638
Content-Transfer-Encoding: 7bit
Content-Type: text/plain;
	charset=US-ASCII;
	format=flowed

Heres the first in the patchset for MacOS/Quartz support;

this set is relatively simple; we add a FromHwndWithSize call to 
graphics (we need to pass width and height for quartz) for mac only 
calls; we check for an environment variable 
(MONO_MWF_USE_QUARTZ_BACKEND) to see if we're going to use 
XplatUIOSX.cs (this will be fine going forward cause we can set that in 
the bundlemaker script)

umm; and it adds the call into the libgdiplus land

libgdiplus patches to follow soon; they're a little more difficult due 
to X11/Quartz conflicting definitions (Point/Rect/Etc); I should be 
able to make them play nice tho by just avoiding some of the explicity 
casting in quartz that isn't really needed.

Ok to commit?

--Apple-Mail-3--387639638
Content-Transfer-Encoding: 7bit
Content-Type: application/octet-stream;
	x-unix-mode=0644;
	name=&quot;mwf.diff&quot;
Content-Disposition: attachment;
	filename=mwf.diff

Index: System.Drawing/System.Drawing/gdipFunctions.cs
===================================================================
--- System.Drawing/System.Drawing/gdipFunctions.cs	(revision 37350)
+++ System.Drawing/System.Drawing/gdipFunctions.cs	(working copy)
@@ -1601,6 +1601,10 @@
 
 		}
 		
+		/* Mac only function calls */
+		[DllImport(&quot;gdiplus.dll&quot;)]
+		internal static extern Status GdipCreateFromQuartz_macosx (IntPtr cgref, int width, int height, out IntPtr graphics);
+
 		/* Linux only function calls*/
 		[DllImport(&quot;gdiplus.dll&quot;)]
 		internal static extern Status GdipSetVisibleClip_linux (IntPtr graphics, ref Rectangle rect);
Index: System.Drawing/System.Drawing/Graphics.cs
===================================================================
--- System.Drawing/System.Drawing/Graphics.cs	(revision 37350)
+++ System.Drawing/System.Drawing/Graphics.cs	(working copy)
@@ -1253,6 +1253,13 @@
 			return null;
 		}
 
+		public static Graphics FromHwndWithSize (IntPtr hwnd, int width, int height) {
+			IntPtr graphics;
+			Status s = GDIPlus.GdipCreateFromQuartz_macosx (hwnd, width, height, out graphics);
+			GDIPlus.CheckStatus (s);
+			return new Graphics (graphics);
+		}
+
 		[EditorBrowsable (EditorBrowsableState.Advanced)]		
 		public static Graphics FromHwnd (IntPtr hwnd)
 		{
@@ -1264,6 +1271,7 @@
 				}
 
 				return FromXDrawable (hwnd, display);
+
 			}
 
 			Status status = GDIPlus.GdipCreateFromHWND (hwnd, out graphics);
Index: Managed.Windows.Forms/System.Windows.Forms/XplatUI.cs
===================================================================
--- Managed.Windows.Forms/System.Windows.Forms/XplatUI.cs	(revision 37359)
+++ Managed.Windows.Forms/System.Windows.Forms/XplatUI.cs	(working copy)
@@ -183,7 +183,10 @@
 			default_class_name=&quot;SWFClass&quot;;
 
 			if (Environment.OSVersion.Platform == (PlatformID)128) {
-				driver=XplatUIX11.GetInstance();
+				if (Environment.GetEnvironmentVariable (&quot;MONO_MWF_USE_QUARTZ_BACKEND&quot;) != null)
+					driver=XplatUIOSX.GetInstance();
+				else
+					driver=XplatUIX11.GetInstance();
 			} else {
 				driver=XplatUIWin32.GetInstance();
 			}
Index: Managed.Windows.Forms/System.Windows.Forms.dll.sources
===================================================================
--- Managed.Windows.Forms/System.Windows.Forms.dll.sources	(revision 37350)
+++ Managed.Windows.Forms/System.Windows.Forms.dll.sources	(working copy)
@@ -233,3 +233,4 @@
 System.Windows.Forms/XplatUIStructs.cs
 System.Windows.Forms/XplatUIWin32.cs
 System.Windows.Forms/XplatUIX11.cs
+System.Windows.Forms/XplatUIOSX.cs

--Apple-Mail-3--387639638
Content-Transfer-Encoding: 7bit
Content-Type: text/plain;
	charset=US-ASCII;
	format=flowed


-kangaroo

--Apple-Mail-3--387639638--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001162.html">[Mono-winforms-list] XplatUIOSX.cs
</A></li>
	<LI> Next message: <A HREF="001164.html">[Mono-winforms-list] Initial MacOS/Quartz patches
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1163">[ date ]</a>
              <a href="thread.html#1163">[ thread ]</a>
              <a href="subject.html#1163">[ subject ]</a>
              <a href="author.html#1163">[ author ]</a>
         </LI>
       </UL>
</body></html>
