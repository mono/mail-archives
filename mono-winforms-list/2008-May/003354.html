<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] [RFC] Multiple NativeWindows per Handle Patch	for bug #374660
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20%5BRFC%5D%20Multiple%20NativeWindows%20per%20Handle%20Patch%0A%09for%20bug%20%23374660&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003353.html">
   <LINK REL="Next"  HREF="003355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] [RFC] Multiple NativeWindows per Handle Patch	for bug #374660</H1>
    <B>Ivan N. Zlatev</B> 
    <A HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20%5BRFC%5D%20Multiple%20NativeWindows%20per%20Handle%20Patch%0A%09for%20bug%20%23374660&In-Reply-To="
       TITLE="[Mono-winforms-list] [RFC] Multiple NativeWindows per Handle Patch	for bug #374660">contact at i-nz.net
       </A><BR>
    <I>Mon May  5 16:34:49 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003353.html">[Mono-winforms-list] UpDownBase refactoring
</A></li>
        <LI>Next message: <A HREF="003355.html">[Mono-winforms-list] Correct behaviour?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3354">[ date ]</a>
              <a href="thread.html#3354">[ thread ]</a>
              <a href="subject.html#3354">[ subject ]</a>
              <a href="author.html#3354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Team,

To fix bug #374660
(<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=374660">https://bugzilla.novell.com/show_bug.cgi?id=374660</A>) I had to
introduce support in NativeWindow for dealing with multiple
NativeWindows per Handle, where one (the first one) is organic (the
ControlNativeWindow) and the rest are synthetic. Messages pass through
both. This is allowed in MS's implementation and is what the test code
in the bug uses to loose couple the drawing code from the behavior
code. Ugly I know, but I guess seems natural to people coming from
hardcore Win32 coding background or something.

Anyway the attached patch, which I am asking you to check out just in case:

   * All tests pass. woo! In theory no regressions.
   * Handles single handle vs multiple handles in the following way,
where window_collection is a Hashtable with key-value pair, where the
key is the handle and the value is either a single NativeWindow or an
ArrayList of handles

				object current = window_collection[handle];
				if (current != null) {
					NativeWindow currentWindow = current as NativeWindow;
					if (currentWindow != null) {
						// only one handle - do stuff
					} else { // list of windows
						ArrayList windows = (ArrayList) window_collection[handle];
						// multiple handles (first one is organic always) - do stuff
					}
				}


   * Most notably doesn't increase our current memory consumption and
should not have any performance impact.

   * Probably decreases the current memory consumption a bit. It came
to my attention that NativeWindow.FromHandle instantiates a new
NativeWindow instead of returning one from the internal table.

   * NativeWindow.window_handle: internal -&gt; private - we don't use
this anywhere and we shouldn't provide access to this to future code
as it breaks encapuslation and allows avoiding
AssignHandle/CreateHandle, InvalidateHandle. Evil.

   * NativeWindow.windows_collection: internal -&gt; private - now that
multiple handles are allowed and the way those are handled is an
implementation detail, code shouldn't have access to the collection
directly. I have replaced the few direct references to the field with
a method to return the organic handle.

Does anyone have any objections or should I go ahead and commit?

Thanks in advance,
Ivan
-------------- next part --------------
A non-text attachment was scrubbed...
Name: multiple-windows-per-handle.patch
Type: text/x-patch
Size: 11885 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/mono-winforms-list/attachments/20080505/a56e3a5b/attachment.bin">http://lists.ximian.com/pipermail/mono-winforms-list/attachments/20080505/a56e3a5b/attachment.bin</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003353.html">[Mono-winforms-list] UpDownBase refactoring
</A></li>
	<LI>Next message: <A HREF="003355.html">[Mono-winforms-list] Correct behaviour?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3354">[ date ]</a>
              <a href="thread.html#3354">[ thread ]</a>
              <a href="subject.html#3354">[ subject ]</a>
              <a href="author.html#3354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">More information about the Mono-winforms-list
mailing list</a><br>
</body></html>
