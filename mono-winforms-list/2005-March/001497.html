<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] libgdiplus/System.Drawing patch:
 native support for indexed Bitmaps
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:2a5gjx302%40sneakemail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001510.html">
   <LINK REL="Next"  HREF="001500.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] libgdiplus/System.Drawing patch:
 native support for indexed Bitmaps
   </H1>
    <B>Jonathan Gilbert
    </B> 
    <A HREF="mailto:2a5gjx302%40sneakemail.com"
       TITLE="[Mono-winforms-list] libgdiplus/System.Drawing patch:
 native support for indexed Bitmaps">2a5gjx302@sneakemail.com
       </A><BR>
    <I>Sun, 13 Mar 2005 18:04:33 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="001510.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
        <LI> Next message: <A HREF="001500.html">[Mono-winforms-list] libgdiplus/System.Drawing patch: native support for indexed Bitmaps
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1497">[ date ]</a>
              <a href="thread.html#1497">[ thread ]</a>
              <a href="subject.html#1497">[ subject ]</a>
              <a href="author.html#1497">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I originally wrote this message 4 days ago, and the list moderator has
still not approved it for submission (it was held because the attachments
exceed 40 KB). So, I have placed the attachments on a web server and
re-sent the messages without them.

The attachments are available at:

   <A HREF="http://israel.logiclrd.cx/patch/">http://israel.logiclrd.cx/patch/</A>

I'll take them down once the message with attachments hits the list.

Jonathan Gilbert

-----------------
Original message:
-----------------
At 02:12 AM 05/03/2005 -0500, I wrote:
&gt;<i>Please find attached the following files:
</I>&gt;<i>
</I>&gt;<i>* libgdiplus.diff (patch -p0 in ./libgdiplus)
</I>&gt;<i>* System.Drawing.diff (patch -p0 in ./mcs/class/System.Drawing)
</I>&gt;<i>* lockbits.tgz (tar zvfx in ./)
</I>
Updated diffs and some extra testing code: testgif.tgz (DOES NOT contain a
subdirectory; untar directly within the intended destination)

Changes from the previous patch:
* Fixed the call to gdip_is_an_indexed_pixelformat that did not actually
call the function because it was missing the argument list.
* Added indexed loading &amp; saving support to gifcodec.c.
* Updated Image.Palette to behave like Microsoft's implementation. I
discovered its bizarre behaviour when I tried to write a program for the
Microsoft framework to save an indexed 8-bit Bitmap with a custom palette.
It does not actually behave like a property, and should really have been
engineered as two separate functions, since there is no persistence
involved. Reading from the property creates a new instance of
System.Drawing.Imaging.ColorPalette and fills it from the underlying GDI+
GpImage object. However, the underlying GpImage's palette is only updated
if you assign to the property. Since you are not allowed to create
instances of ColorPalette directly, you end up having to write code like this:

ColorPalette palette = my_bitmap.Palette;

for (int i=0; i &lt; palette.Entries.Length; i++)
  palette.Entries[i] = Color.FromArgb(ar, gu, ments);

my_bitmap.Palette = palette; /* assign the same instance back! if this is
skipped, the image file will display and save with the old palette */

This is not documented in MSDN! But whatever the case, mono now behaves the
same way.

Oh, and one other thing: This time I actually verified that the diffs apply
cleanly :-)

Jonathan Gilbert


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001510.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
	<LI> Next message: <A HREF="001500.html">[Mono-winforms-list] libgdiplus/System.Drawing patch: native support for indexed Bitmaps
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1497">[ date ]</a>
              <a href="thread.html#1497">[ thread ]</a>
              <a href="subject.html#1497">[ subject ]</a>
              <a href="author.html#1497">[ author ]</a>
         </LI>
       </UL>
</body></html>
