<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] Matrix memory management in GDI+ bug
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:jordi%40ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001493.html">
   <LINK REL="Next"  HREF="001495.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] Matrix memory management in GDI+ bug
   </H1>
    <B>Jordi Mas
    </B> 
    <A HREF="mailto:jordi%40ximian.com"
       TITLE="[Mono-winforms-list] Matrix memory management in GDI+ bug">jordi@ximian.com
       </A><BR>
    <I>Sat, 12 Mar 2005 17:41:03 +0100</I>
    <P><UL>
        <LI> Previous message: <A HREF="001493.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
        <LI> Next message: <A HREF="001495.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1494">[ date ]</a>
              <a href="thread.html#1494">[ thread ]</a>
              <a href="subject.html#1494">[ subject ]</a>
              <a href="author.html#1494">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-6r+UoCdO/IseuQcFdbQN
Content-Type: text/plain; charset=ISO-8859-1
Content-Transfer-Encoding: 8bit

El ds 12 de 03 del 2005 a les 11:18 +0100, en/na Laurent Debacker va
escriure:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> There's is a bug in the way mono manage the unmanaged matrix in libgdiplus.
</I>&gt;<i> 
</I>&gt;<i> What I wanted to do is to save the transform matrix used in a Graphics
</I>&gt;<i> object, save it in a global variable to reuse it later in other
</I>&gt;<i> Graphics objects. It's just for optimization purpose.
</I>&gt;<i> 
</I>&gt;<i> However Mono's System.Drawing.Drawing2D.Matrix doesn't behave like
</I>&gt;<i> Microsoft's one.
</I>&gt;<i> 
</I>&gt;<i> With Microsoft I can take the transform matrix from a matrix, even
</I>&gt;<i> Dispose() it, then give it to another Graphics object, and it still
</I>&gt;<i> works. I know it's tricky to Dispose() there, but I wanted to do
</I>&gt;<i> futher research.
</I>&gt;<i> 
</I>&gt;<i> In Mono, Matrix.Dipose() (see source code
</I>&gt;<i> <A HREF="http://svn.myrealbox.com/viewcvs/trunk/mcs/class/System.Drawing/System.Drawing.Drawing2D/Matrix.cs?rev=31166&view=auto">http://svn.myrealbox.com/viewcvs/trunk/mcs/class/System.Drawing/System.Drawing.Drawing2D/Matrix.cs?rev=31166&amp;view=auto</A>
</I>&gt;<i>  just always call GdipDeleteMatrix in libgdiplus
</I>&gt;<i> (<A HREF="http://svn.myrealbox.com/viewcvs/trunk/libgdiplus/src/matrix.c?rev=39075&view=auto">http://svn.myrealbox.com/viewcvs/trunk/libgdiplus/src/matrix.c?rev=39075&amp;view=auto</A>),
</I>&gt;<i> which in turn calls cairo_matrix_destroy
</I>&gt;<i> (<A HREF="http://svn.myrealbox.com/viewcvs/trunk/libgdiplus/cairo/src/cairo_matrix.c?rev=39488&view=auto">http://svn.myrealbox.com/viewcvs/trunk/libgdiplus/cairo/src/cairo_matrix.c?rev=39488&amp;view=auto</A>),
</I>&gt;<i> which simply do a free().
</I>&gt;<i> 
</I>&gt;<i> So your implementation is logic, but isn't compatible with Microsoft's one.
</I>&gt;<i> 
</I>&gt;<i> I would recommand you to call GdipDeleteMatrix in the destructor of
</I>&gt;<i> System.Drawing.Drawing2D.Matrix, and leave Dipose() empty. That way as
</I>&gt;<i> long as the managed Matrix lives, the unmanaged one will also.
</I>&gt;<i> 
</I>&gt;<i> The error message I got with my code was &quot;mono in free(): error: chunk
</I>&gt;<i> is already free&quot; under FreeBSD 5.3-RELEASE, and libgdiplus-devel,
</I>&gt;<i> mono-devel (1.1.4) from the BSD# project
</I>&gt;<i> (<A HREF="http://forge.novell.com/modules/xfmod/project/?bsd-sharp">http://forge.novell.com/modules/xfmod/project/?bsd-sharp</A>).
</I>
Laurent,

If you call Dispose the resource should be freed, as users will expect.
Also, Microsoft does works this way.

Attached you have a patch that fixes our Dispose method. Please, if this
still do not work for you, send me the sample and I'll look into it.

Thanks for your feedback Laurent,

Jordi,

-- 
Jordi Mas i Hernàndez - Mono development team - <A HREF="http://www.mono-project.com">http://www.mono-project.com</A>
Homepage and LiveJournal at <A HREF="http://www.softcatala.org/~jmas">http://www.softcatala.org/~jmas</A>


--=-6r+UoCdO/IseuQcFdbQN
Content-Disposition: attachment; filename=matrix.diff
Content-Type: text/x-patch; name=matrix.diff; charset=ISO-8859-1
Content-Transfer-Encoding: 7bit

Index: Matrix.cs
===================================================================
--- Matrix.cs	(revision 41526)
+++ Matrix.cs	(working copy)
@@ -131,8 +131,13 @@
         
                 public void Dispose ()
                 {
-			Status status = GDIPlus.GdipDeleteMatrix (nativeMatrix);
-			GDIPlus.CheckStatus (status);
+			if (nativeMatrix != IntPtr.Zero) {
+				Status status = GDIPlus.GdipDeleteMatrix (nativeMatrix);
+				GDIPlus.CheckStatus (status);
+				nativeMatrix = IntPtr.Zero;
+			}
+
+			GC.SuppressFinalize (true);
                 }                       
         
                 public override bool Equals (object obj)

--=-6r+UoCdO/IseuQcFdbQN--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001493.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
	<LI> Next message: <A HREF="001495.html">[Mono-winforms-list] Matrix memory management in GDI+ bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1494">[ date ]</a>
              <a href="thread.html#1494">[ thread ]</a>
              <a href="subject.html#1494">[ subject ]</a>
              <a href="author.html#1494">[ author ]</a>
         </LI>
       </UL>
</body></html>
