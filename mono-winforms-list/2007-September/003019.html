<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] New to the list
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20New%20to%20the%20list&In-Reply-To=46E08081.4030209%40jpobst.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003018.html">
   <LINK REL="Next"  HREF="003021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] New to the list</H1>
    <B>Ernesto</B> 
    <A HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20New%20to%20the%20list&In-Reply-To=46E08081.4030209%40jpobst.com"
       TITLE="[Mono-winforms-list] New to the list">equistango at gmail.com
       </A><BR>
    <I>Fri Sep  7 09:17:22 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003018.html">[Mono-winforms-list] New to the list
</A></li>
        <LI>Next message: <A HREF="003021.html">[Mono-winforms-list] New to the list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3019">[ date ]</a>
              <a href="thread.html#3019">[ thread ]</a>
              <a href="subject.html#3019">[ subject ]</a>
              <a href="author.html#3019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan Pobst wrote:
&gt;<i> Hey Ernesto!
</I>&gt;<i>
</I>&gt;<i> The changes look harmless, but I have a feeling they are simply hiding 
</I>&gt;<i> a bigger problem, ie: what is trying to set a scroll position bigger 
</I>&gt;<i> than the maximum and why.  The ListView maintainer (calberto) thinks 
</I>&gt;<i> the same about the ListView one.  Do you have a test case or code 
</I>&gt;<i> snippet for each of them that reproduces the crash so we can dig a bit 
</I>&gt;<i> a deeper?
</I>&gt;<i>
</I>Heh... yes, I have that feeling too. I just didn't want to made 
design-level changes (and even if I did want, I didn't dare since this 
is my first day with the winforms source code).
However, I can explain how I see the problem so you guys decide if 
deeper changes are necesary.

The ListView problem:

1) When a new SubItem is added, the ListViewSubItem constructor sets the 
SubItem text.
2) Text.set in the SubItem Text property calls Invalidate(Bounds).
3) Bounds.get calls GetBounds() and this calls GetItemLocation().
4) GetItemLocation() uses the items_location[] array.

Now, items_location[] is set to an initial lenght of [16] by the 
ListView constructor, and extended by AdjustItemsPositionArray if needed.
AdjustItemsPositionArray is only called by CalculateListView, which is 
called only before a redraw.

So, if you add a 17th item before a redraw, you get an index out of 
bounds at ListView.GetItemLocation().

I think the problem here is that Invalidate() ends up usign 
items_location[], which is only calculated when redrawing. That doesn't 
seem to make sense sometimes, since Invalidate() happens _before_ the 
redraw.

Anyway, my patch only ensures the items_location[] array grows when the 
collection grows. It doesn't seem to care if items_location[] has valid 
information because we are not redrawing, just invalidating.


The ScrollBar problem is much simpler.

           vscrollbar.LargeChange = 0;
           vscrollbar.Maximum = 100;
           vscrollbar.Value = 20;
           vscrollbar.Maximum = 0;   // BONGGGGG!!!

It only happens if LargeChange == 0, because of this code in UpdatePos() 
in ScrollBar.cs:

   if (newPos &gt; maximum + 1 - large_change)
       pos = maximum + 1 - large_change;
   else
       pos = newPos;

For a large_change value of 5
   if (20 &gt; 0 + 1 - 5)
       pos = -4;
   else
       pos = newPos;

and then

   if (pos &lt; minimum)
       pos = minimum;

will reset pos to 0 (or wharever minimum is).

But for large_change value of 0,

   if (20 &gt; 0 + 1 - 0)
       pos = maximum + 1 - large_change;
   else
       pos = newPos;

pos == 1, which is more than Maximum, so a SetValue (pos) a few lines 
below will fail.

LargeChange values of 0 should be accepted. On the other hand &quot;if 
(newPos &gt; maximum + 1 - large_change) pos = maximum + 1 - large_change;&quot; 
sounds correct to me, but may result in negative values that must be 
corrected.

In short, I tought it was a good idea to give pos a last check before 
calling SetValue(pos).
However, if you think that's not correct, and that I should find another 
solution to fix UpdatePos(), I will. I just want the problem solved, you 
can tell me how.

Regards,
Ernesto

</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003018.html">[Mono-winforms-list] New to the list
</A></li>
	<LI>Next message: <A HREF="003021.html">[Mono-winforms-list] New to the list
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3019">[ date ]</a>
              <a href="thread.html#3019">[ thread ]</a>
              <a href="subject.html#3019">[ subject ]</a>
              <a href="author.html#3019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">More information about the Mono-winforms-list
mailing list</a><br>
</body></html>
