<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] MWF painting VERY slow compared to .NET
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20MWF%20painting%20VERY%20slow%20compared%20to%20.NET&In-Reply-To=09e901c593a1%24ae9b05a0%24a2c163a4%40pdb">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001799.html">
   <LINK REL="Next"  HREF="001801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] MWF painting VERY slow compared to .NET</H1>
    <B>Peter De Jager</B> 
    <A HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20MWF%20painting%20VERY%20slow%20compared%20to%20.NET&In-Reply-To=09e901c593a1%24ae9b05a0%24a2c163a4%40pdb"
       TITLE="[Mono-winforms-list] MWF painting VERY slow compared to .NET">peterdj at telkomsa.net
       </A><BR>
    <I>Thu Jul 28 16:46:46 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001799.html">[Mono-winforms-list] MWF painting VERY slow compared to .NET
</A></li>
        <LI>Next message: <A HREF="001801.html">[Mono-winforms-list] MWF painting VERY slow compared to .NET
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1800">[ date ]</a>
              <a href="thread.html#1800">[ thread ]</a>
              <a href="subject.html#1800">[ subject ]</a>
              <a href="author.html#1800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm attaching a small code snippet. You *should* use Invoke() instead of
painting to a Form directly, but in this (very simple) example, no other
thread is painting to the form so it should be safe.

You can compile with .NET or mcs. Put an image file, &quot;Image.png&quot;, in the
same directory as the executable before running it. The image should be
smaller than approx. 800x600 otherwise it will be clipped. When the form is
displayed, it shows nothing (not even a background, except on Mono where the
background is incorrectly painted). When you click on the form, it
repeatedly paints the bitmap to the form and displays the mean frame rate
over a 10 second period. On my hardware (and using my &quot;Image.png&quot;), the
figures at the end of the 10 seconds are 162 for .NET and 7.65 for Mono.

With regards to Mac, I know very little about X11 (as with Linux). To be
honest, I don't even understand your question ;-). When trying to get MWF
and gtk-sharp running I saw on the mailing lists that X11 needs to be
installed, so I did that. I also tried to run 'mono.exe' from an X11
terminal (I don't know how this differs from a normal terminal on Mac).
After macpack I've managed to get a MWF app displaying for an instant before
quitting, so my success has been limited so far. However, all of my non-gui
code is running without problems under Mono on OS X, albeit at approximately
half the speed of Mono on Linux (FC 4), on the same PowerPC hardware.

Pete.
 

&gt;<i> -----Original Message-----
</I>&gt;<i> From: Peter Dennis Bartok [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">peter at novonyx.com</A>] 
</I>&gt;<i> Sent: Thursday, July 28, 2005 20:25
</I>&gt;<i> To: Peter De Jager; 'Miguel de Icaza'
</I>&gt;<i> Cc: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">mono-winforms-list at lists.ximian.com</A>
</I>&gt;<i> Subject: Re: [Mono-winforms-list] MWF painting VERY slow 
</I>&gt;<i> compared to .NET
</I>&gt;<i> 
</I>&gt;<i> Peter,
</I>&gt;<i> 
</I>&gt;<i> I am curious as to how you tested performance/framerate. Any 
</I>&gt;<i> chance you could provide the code? (Binary should be ok, 
</I>&gt;<i> doesn't have to be source yet). I'd love to go through and 
</I>&gt;<i> see where we spend the cycles. (And I will also test with our 
</I>&gt;<i> MWF but Microsoft's GDI+ on Win32, which will give an idea of 
</I>&gt;<i> how much impact our managed approach to drawing controls has)
</I>&gt;<i> 
</I>&gt;<i> When Jackson worked on improving performance of the X11 
</I>&gt;<i> driver's event loop, he went through the Gtk+ code, so I'd 
</I>&gt;<i> assume he modeled it after theirs and we should have the same 
</I>&gt;<i> benefits.
</I>&gt;<i> 
</I>&gt;<i> Also, you mention OS X. Are you testing with the X11 driver 
</I>&gt;<i> or with the OS X driver?
</I>&gt;<i> 
</I>&gt;<i> Also, so far we have spent little time optimizing things, 
</I>&gt;<i> we've only tried to get to a code-complete state, but we're 
</I>&gt;<i> reaching the point where we're looking into performance, so 
</I>&gt;<i> you picked the perfect time to bring up the issue :-)
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i>   Peter
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: &quot;Peter De Jager&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">peterdj at telkomsa.net</A>&gt;
</I>&gt;<i> To: &quot;'Miguel de Icaza'&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">miguel at ximian.com</A>&gt;
</I>&gt;<i> Cc: &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">mono-winforms-list at lists.ximian.com</A>&gt;
</I>&gt;<i> Date: 28 July, 2005 12:08
</I>&gt;<i> Subject: RE: [Mono-winforms-list] MWF painting VERY slow 
</I>&gt;<i> compared to .NET
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;That would make sense. It almost appears as if the MWF event loop is 
</I>&gt;<i> &gt;clocked at a fixed frequency, resulting in the (almost) fixed frame 
</I>&gt;<i> &gt;rate regardless of architecture or video drivers. Of course 
</I>&gt;<i> it will be 
</I>&gt;<i> &gt;more complex than that, but it does appear that the delay is 
</I>&gt;<i> at least 
</I>&gt;<i> &gt;in part due to the event loop.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;What would be the best way to proceed though? In the last few days I 
</I>&gt;<i> &gt;have tried gtk-sharp on Mac without much success, having had 
</I>&gt;<i> a lot of 
</I>&gt;<i> &gt;trouble installing gtk-sharp under PowerPC (at least with Mono 1.1.8 
</I>&gt;<i> &gt;and FC4). I saw the post by Attila Balogh who provides a 
</I>&gt;<i> modified Mono 
</I>&gt;<i> &gt;framework for OS X Tiger (90MB), which includes gtk-sharp 
</I>&gt;<i> 1.0.10, but I 
</I>&gt;<i> &gt;haven't tried it yet.
</I>&gt;<i> &gt;I
</I>&gt;<i> &gt;thought I'd hold out for a while and keep testing on Linux 
</I>&gt;<i> (Intel/PPC) 
</I>&gt;<i> &gt;using MWF. I've also had a look at wx.Net but it appears 
</I>&gt;<i> that gtk-sharp 
</I>&gt;<i> &gt;is more widely supported. In a perfect world I would use MWF 
</I>&gt;<i> since this 
</I>&gt;<i> &gt;requires no change from my .NET code, but failing that, I 
</I>&gt;<i> was hoping to 
</I>&gt;<i> &gt;use a single GUI toolkit for both Linux and OS X. Does gtk-sharp fit 
</I>&gt;<i> &gt;the bill?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Pete.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; -----Original Message-----
</I>&gt;<i> &gt;&gt; From: Miguel de Icaza [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">miguel at ximian.com</A>]
</I>&gt;<i> &gt;&gt; Sent: Thursday, July 28, 2005 19:32
</I>&gt;<i> &gt;&gt; To: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">vlindos at nucleusys.com</A>
</I>&gt;<i> &gt;&gt; Cc: Peter De Jager; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">mono-winforms-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; Subject: Re: [Mono-winforms-list] MWF painting VERY slow 
</I>&gt;<i> compared to 
</I>&gt;<i> &gt;&gt; .NET
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Hello,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt; Slowness of MWF drawing comes from Cairo. MWF uses 
</I>&gt;<i> libgdiplus for 
</I>&gt;<i> &gt;&gt; &gt; drawing, libgdiplus uses cairo/libpixmain backends for 
</I>&gt;<i> drawing and 
</I>&gt;<i> &gt;&gt; &gt; uses version 0.3.0 of Cairo. Currently Cairo is version 
</I>&gt;<i> 0.5.2. The 
</I>&gt;<i> &gt;&gt; &gt; problem is that Cairo isn't yet stable project as API is
</I>&gt;<i> &gt;&gt; changed even
</I>&gt;<i> &gt;&gt; &gt; on minor version change. On mailing lists of Cairo there 
</I>&gt;<i> is talk of 
</I>&gt;<i> &gt;&gt; &gt; soon releasing of version 1 which means freezing the API.
</I>&gt;<i> &gt;&gt; But 'soon'
</I>&gt;<i> &gt;&gt; &gt; could be month or year by my opinion.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Although Cairo is known to be a part of the problem, 
</I>&gt;<i> another part of 
</I>&gt;<i> &gt;&gt; the equation might be the event loop processing.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I do not remember the details, but Gtk+ spent quite a bit of time 
</I>&gt;<i> &gt;&gt; dealing with improving their main loop and event processing to 
</I>&gt;<i> &gt;&gt; improve performance.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Miguel.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;_______________________________________________
</I>&gt;<i> &gt;Mono-winforms-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">Mono-winforms-list at lists.ximian.com</A>
</I>&gt;<i> &gt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">http://lists.ximian.com/mailman/listinfo/mono-winforms-list</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> 
</I>-------------- next part --------------
using System;
using System.ComponentModel;
using System.Drawing;
using System.IO;
using System.Reflection;
using System.Threading;
using System.Windows.Forms;

class Test {

	static TestForm testForm = new TestForm();

	static void Main() {
		Application.Run(testForm);
	}

	class TestForm : Form {

		public TestForm() {
			Text = &quot;Paint Test&quot;;
			Size = new Size(800, 600);
			StartPosition = FormStartPosition.CenterScreen;
		}

		protected override void OnPaintBackground(PaintEventArgs e) { }

		protected override void OnMouseDown(MouseEventArgs e) {
			new Thread(new ThreadStart(PaintTest)).Start();
		}
	}

	public static void PaintTest() {

		// setup
		string currentPath = Path.GetDirectoryName(Assembly.GetExecutingAssembly().GetModules()[0].FullyQualifiedName);
		Bitmap image = new Bitmap(Path.GetFullPath(currentPath + Path.DirectorySeparatorChar + &quot;Image.png&quot;));
		Bitmap canvas = new Bitmap(image);
		Font font = new Font(FontFamily.GenericMonospace, 12);

		// test
		int frames = 0;
		DateTime start = DateTime.Now;
		using (Graphics gScreen = testForm.CreateGraphics()) {
			using (Graphics gCanvas = Graphics.FromImage(canvas)) {

				// for 10 seconds...
				while (DateTime.Now.Subtract(start) &lt; new TimeSpan(0, 0, 10)) {

					// paint image
					gCanvas.DrawImage(image, new Rectangle(0, 0, image.Width, image.Height), new Rectangle(0, 0, image.Width, image.Height), GraphicsUnit.Pixel);

					// write framerate
					++frames;
					if (DateTime.Now.Subtract(start).TotalSeconds &gt; 0) {
						double fps = frames / DateTime.Now.Subtract(start).TotalSeconds;
						gCanvas.FillRectangle(new SolidBrush(Color.White), 0, 0, image.Width, 32);
						gCanvas.DrawString(string.Format(&quot;Fps: {0}&quot;, Math.Round(fps, 2)), font, Brushes.Black, new Point(4, 4));
					}

					// display
					gScreen.DrawImage(canvas, new Rectangle(0, 0, canvas.Width, canvas.Height), new Rectangle(0, 0, canvas.Width, canvas.Height), GraphicsUnit.Pixel);
				}
			}
		}
	}
}
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001799.html">[Mono-winforms-list] MWF painting VERY slow compared to .NET
</A></li>
	<LI>Next message: <A HREF="001801.html">[Mono-winforms-list] MWF painting VERY slow compared to .NET
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1800">[ date ]</a>
              <a href="thread.html#1800">[ thread ]</a>
              <a href="subject.html#1800">[ subject ]</a>
              <a href="author.html#1800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">More information about the Mono-winforms-list
mailing list</a><br>
</body></html>
