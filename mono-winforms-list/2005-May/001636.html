<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] [PATCH] Stack propagation for Control.BeginInvoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20%5BPATCH%5D%20Stack%20propagation%20for%20Control.BeginInvoke&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001635.html">
   <LINK REL="Next"  HREF="001637.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] [PATCH] Stack propagation for Control.BeginInvoke</H1>
    <B>Peter Dennis Bartok</B> 
    <A HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20%5BPATCH%5D%20Stack%20propagation%20for%20Control.BeginInvoke&In-Reply-To="
       TITLE="[Mono-winforms-list] [PATCH] Stack propagation for Control.BeginInvoke">peter@novonyx.com
       </A><BR>
    <I>Thu May 12 00:43:34 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001635.html">[Mono-winforms-list] [PATCH] Stack propagation for Control.BeginInvoke
</A></li>
        <LI>Next message: <A HREF="001637.html">[Mono-winforms-list] Patch for System.Windows.Forms.Design.EventsTab
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1636">[ date ]</a>
              <a href="thread.html#1636">[ thread ]</a>
              <a href="subject.html#1636">[ subject ]</a>
              <a href="author.html#1636">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've modified the patch slightly and commited it (r44415). I took care of 
the fixme, Invoke() no longer calls Begin/EndInvoke() if it's not needed, 
and I've moved the ExecuteClientMessage code into a new class 
XplatUIDriverSupport, to allow usage by all drivers. I've also made the 
Win32 driver use it.

Thanks!

 Cheers,
  Peter

-----Original Message-----
From: &quot;Sebastien Pouliot&quot; &lt;<A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>&gt;
To: &quot;Mono WinForms List&quot; &lt;<A HREF="mailto:mono-winforms-list@lists.ximian.com">mono-winforms-list@lists.ximian.com</A>&gt;
Date: 11 May, 2005 15:20
Subject: [Mono-winforms-list] [PATCH] Stack propagation for 
Control.BeginInvoke


&gt;<i>Hello,
</I>&gt;<i>
</I>&gt;<i>Here's a patch to enabled stack propagation to work for
</I>&gt;<i>Control.BeginInvoke. For people who wonder what stack propagation is,
</I>&gt;<i>here's a short explanation...
</I>&gt;<i>
</I>&gt;<i>        Stack propagation ensure that Code Access Security (CAS)
</I>&gt;<i>        permissions can work across threads for asynchronous calls. This
</I>&gt;<i>        ensure that code cannot be given more privileges because it's
</I>&gt;<i>        being executed by another thread (which wouldn't have all the
</I>&gt;<i>        restrictions that the original thread may have).
</I>&gt;<i>
</I>&gt;<i>A test case is available in SVN under:
</I>&gt;<i> /mono/mono/tests/cas/threads/swf-control1.cs
</I>&gt;<i>
</I>&gt;<i>The sample code shows that the &quot;main&quot; code is restricted from reading
</I>&gt;<i>the username. Which means that the &quot;invoked&quot; code (via Control.
</I>&gt;<i>BeginInvoke) should also have the same restriction (even if it's being
</I>&gt;<i>executed in the control's thread).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>* If you execute the sample &quot;normally&quot; you should see the
</I>&gt;<i>SecurityManager status, the current time and your username for a few
</I>&gt;<i>seconds.
</I>&gt;<i>
</I>&gt;<i>% mono swf-control1.exe
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>* Additional debugging output can be displayed by adding a(ny)
</I>&gt;<i>parameters on the command-line.
</I>&gt;<i>
</I>&gt;<i>% mono swf-control1.exe x
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>* If you execute it with the security manager enabled the username will
</I>&gt;<i>be replaced (well if the patch is applied ;-) by &quot;SecurityException&quot;.
</I>&gt;<i>
</I>&gt;<i>% mono --security swf-control1.exe x
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Notes:
</I>&gt;<i>
</I>&gt;<i>* The current patch is only for the X11 driver, but it shouldn't be hard
</I>&gt;<i>to port to the other drivers (or to move elsewhere);
</I>&gt;<i>
</I>&gt;<i>* Stack propagation only occurs if the security manager is active (i.e.
</I>&gt;<i>--security) so it's impact should be minimal (even invisible) for most
</I>&gt;<i>users;
</I>&gt;<i>
</I>&gt;<i>* The code is a little different for the Fx 2.0 because propagation
</I>&gt;<i>isn't only done for the security stack (a lot of other contexts are
</I>&gt;<i>also, or will be, propagated). The code looks different but still the
</I>&gt;<i>_stack_ propagation is only done if the security manager is active;
</I>&gt;<i>
</I>&gt;<i>* About the sample, it's window should close itself after
</I>&gt;<i>Application.Exit is called. However it seems to wait for the next X
</I>&gt;<i>event (mouse, keyboard) to do so. This works normally under Windows and
</I>&gt;<i>isn't related to my patch;
</I>&gt;<i>
</I>&gt;<i>* The sample shouldn't hang after the Application.Exit call (and closing
</I>&gt;<i>the Windows). However it does hang (for me) or, sometimes, display a
</I>&gt;<i>NullReferenceException. This also works normally under Windows and I
</I>&gt;<i>don't think it's related to the patch (but it may be related to recent
</I>&gt;<i>thread shutdown problems);
</I>&gt;<i>
</I>&gt;<i>* Of course Control.BeginInvoke is only a (small) subset of the work
</I>&gt;<i>required to complete stack propagation - but most of it will occur
</I>&gt;<i>outside SWF.
</I>&gt;<i>
</I>&gt;<i>-- 
</I>&gt;<i>Sebastien Pouliot  &lt;<A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>&gt;
</I>&gt;<i>blog: <A HREF="http://pages.infinit.net/ctech/poupou.html">http://pages.infinit.net/ctech/poupou.html</A>
</I>&gt;<i> 
</I>

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001635.html">[Mono-winforms-list] [PATCH] Stack propagation for Control.BeginInvoke
</A></li>
	<LI>Next message: <A HREF="001637.html">[Mono-winforms-list] Patch for System.Windows.Forms.Design.EventsTab
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1636">[ date ]</a>
              <a href="thread.html#1636">[ thread ]</a>
              <a href="subject.html#1636">[ subject ]</a>
              <a href="author.html#1636">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">More information about the Mono-winforms-list
mailing list</a><br>
</body></html>
