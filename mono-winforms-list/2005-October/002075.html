<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-winforms-list] TreeView - selected node is hide
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20TreeView%20-%20selected%20node%20is%20hide&In-Reply-To=434D7847.6030804%40bansky.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002071.html">
   <LINK REL="Next"  HREF="002081.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-winforms-list] TreeView - selected node is hide</H1>
    <B>Rafael Teixeira</B> 
    <A HREF="mailto:mono-winforms-list%40lists.ximian.com?Subject=%5BMono-winforms-list%5D%20TreeView%20-%20selected%20node%20is%20hide&In-Reply-To=434D7847.6030804%40bansky.net"
       TITLE="[Mono-winforms-list] TreeView - selected node is hide">monoman at gmail.com
       </A><BR>
    <I>Thu Oct 13 15:30:25 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002071.html">[Mono-winforms-list] TreeView - selected node is hide
</A></li>
        <LI>Next message: <A HREF="002081.html">[Mono-winforms-list] TreeView - selected node is hide
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2075">[ date ]</a>
              <a href="thread.html#2075">[ thread ]</a>
              <a href="subject.html#2075">[ subject ]</a>
              <a href="author.html#2075">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a patch pending approval for more than a month now to correct
some miscalculations on the rectangle-size (it is not using the font
metrics to do it currently) that may cause this behaviour as it wraps
text incorrectly, when the rectangle is to small.

An update version of the patch for TreeView.cs is attached. See if it helps.

Regards,

On 10/12/05, Pavel Bansky &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">levap at bansky.net</A>&gt; wrote:
&gt;<i> Hello Mono folks,
</I>&gt;<i>
</I>&gt;<i> I found strange behaivor of TreeView under KDE. Selected node is hiden
</I>&gt;<i> under 'selection' so you can't see the text. Seems like rectangle around
</I>&gt;<i> selected item is filled with colour. Here is the screenshot
</I>&gt;<i> <A HREF="http://bansky.net/treeview.png">http://bansky.net/treeview.png</A>
</I>&gt;<i>
</I>&gt;<i> have a nice day
</I>&gt;<i>
</I>&gt;<i> Pavel
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Code goes here:
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i> using System.Drawing;
</I>&gt;<i> using System.Windows.Forms;
</I>&gt;<i>
</I>&gt;<i> namespace TreeViewTest
</I>&gt;<i> {
</I>&gt;<i>
</I>&gt;<i>         public class MyNode : TreeNode
</I>&gt;<i>         {
</I>&gt;<i>                 public string filename;
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         public class MainForm : Form
</I>&gt;<i>         {
</I>&gt;<i>                 private System.Windows.Forms.StatusBar statusBar1;
</I>&gt;<i>                 private System.Windows.Forms.TreeView treeView1;
</I>&gt;<i>                 private System.Windows.Forms.Button btnAdd;
</I>&gt;<i>                 public MainForm()
</I>&gt;<i>                 {
</I>&gt;<i>                 this.btnAdd = new System.Windows.Forms.Button();
</I>&gt;<i>                 this.treeView1 = new System.Windows.Forms.TreeView();
</I>&gt;<i>                 this.statusBar1 = new System.Windows.Forms.StatusBar();
</I>&gt;<i>                 this.SuspendLayout();
</I>&gt;<i>
</I>&gt;<i>                 this.btnAdd.Location = new System.Drawing.Point(8, 8);
</I>&gt;<i>                 this.btnAdd.Name = &quot;btnAdd&quot;;
</I>&gt;<i>                 this.btnAdd.Text = &quot;button1&quot;;
</I>&gt;<i>                 this.btnAdd.Click += new System.EventHandler(this.BtnAddClick);
</I>&gt;<i>
</I>&gt;<i>                 this.treeView1.ImageIndex = -1;
</I>&gt;<i>                 this.treeView1.Location = new System.Drawing.Point(104, 8);
</I>&gt;<i>                 this.treeView1.Name = &quot;treeView1&quot;;
</I>&gt;<i>                 this.treeView1.ItemHeight = 20;
</I>&gt;<i>                 this.treeView1.Size = new System.Drawing.Size(121, 192);
</I>&gt;<i>                 this.treeView1.AfterSelect += new
</I>&gt;<i> System.Windows.Forms.TreeViewEventHandler(this.TreeView1AfterSelect);
</I>&gt;<i>
</I>&gt;<i>                 this.statusBar1.Location = new System.Drawing.Point(0, 223);
</I>&gt;<i>                 this.statusBar1.Name = &quot;statusBar1&quot;;
</I>&gt;<i>                 this.statusBar1.Size = new System.Drawing.Size(240, 22);
</I>&gt;<i>                 this.statusBar1.Text = &quot;statusBar1&quot;;
</I>&gt;<i>
</I>&gt;<i>                 this.AutoScaleBaseSize = new System.Drawing.Size(5, 13);
</I>&gt;<i>                 this.ClientSize = new System.Drawing.Size(240, 245);
</I>&gt;<i>                 this.Controls.Add(this.statusBar1);
</I>&gt;<i>                 this.Controls.Add(this.btnAdd);
</I>&gt;<i>                 his.Controls.Add(this.treeView1);
</I>&gt;<i>                 this.Name = &quot;MainForm&quot;;
</I>&gt;<i>                 this.Text = &quot;MainForm&quot;;
</I>&gt;<i>                 this.ResumeLayout(false);
</I>&gt;<i>                 }
</I>&gt;<i>
</I>&gt;<i>                 [STAThread]
</I>&gt;<i>                 public static void Main(string[] args)
</I>&gt;<i>                 {
</I>&gt;<i>                         Application.Run(new MainForm());
</I>&gt;<i>                 }
</I>&gt;<i>
</I>&gt;<i>                 void BtnAddClick(object sender, System.EventArgs e)
</I>&gt;<i>                 {
</I>&gt;<i>                         MyNode mn = new MyNode();
</I>&gt;<i>                         mn.Text = &quot;Some_file&quot;;
</I>&gt;<i>                         mn.filename = &quot;some_name.txt&quot;;
</I>&gt;<i>                         treeView1.Nodes.Add(mn);
</I>&gt;<i>                 }
</I>&gt;<i>
</I>&gt;<i>                 void TreeView1AfterSelect(object sender,
</I>&gt;<i> System.Windows.Forms.TreeViewEventArgs e)
</I>&gt;<i>                 {
</I>&gt;<i>                         MyNode mn = (MyNode)treeView1.SelectedNode;
</I>&gt;<i>                         statusBar1.Text = mn.filename;
</I>&gt;<i>                 }
</I>&gt;<i>
</I>&gt;<i>         }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> __________________________________________________________
</I>&gt;<i>
</I>&gt;<i> Pavel B&#225;nsk&#253;
</I>&gt;<i> levap at bansky.net                        I write code...
</I>&gt;<i> __________________________________________________________
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-winforms-list maillist  -  <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">Mono-winforms-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">http://lists.ximian.com/mailman/listinfo/mono-winforms-list</A>
</I>&gt;<i>
</I>

--
Rafael &quot;Monoman&quot; Teixeira
---------------------------------------
I'm trying to become a &quot;Rosh Gadol&quot; before my own eyes.
See <A HREF="http://www.joelonsoftware.com/items/2004/12/06.html">http://www.joelonsoftware.com/items/2004/12/06.html</A> for enlightment.
It hurts!
-------------- next part --------------
Index: ChangeLog
===================================================================
--- ChangeLog	(revision 51682)
+++ ChangeLog	(working copy)
@@ -1,3 +1,6 @@
+2005-10-13  Rafael Teixeira &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">rafaelteixeirabr at hotmail.com</A>&gt;
+	* TreeView.cs: correct calculations of node bounds
+
 2005-10-13  Peter Dennis Bartok  &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">pbartok at novell.com</A>&gt;
 
 	* XplatUI.cs, XplatUIDriver.cs, XplatUIOSX.cs: Added 
Index: TreeView.cs
===================================================================
--- TreeView.cs	(revision 51682)
+++ TreeView.cs	(working copy)
@@ -78,6 +78,7 @@
 		private int used_height;
 		
 		private int update_stack;
+		private StringFormat string_format;
 
 		private TreeViewEventHandler on_after_check;
 		private TreeViewEventHandler on_after_collapse;
@@ -94,12 +95,15 @@
 		private int open_node_count = -1;
 
 		private long handle_count = 1;
-
 		#endregion	// Fields
 
 		#region Public Constructors	
 		public TreeView ()
 		{
+			string_format = new StringFormat();
+			string_format.Alignment = StringAlignment.Center;
+			string_format.LineAlignment = StringAlignment.Center;
+
 			base.background_color = ThemeEngine.Current.ColorWindow;
 			base.foreground_color = ThemeEngine.Current.ColorWindowText;
 
@@ -1031,14 +1035,12 @@
 			UpdateNode(edit_node);
 		}
 
-		[MonoTODO(&quot;When Graphics.MeasureString starts to work correctly use it&quot;)]
 		private void UpdateNodeBounds (TreeNode node, int x, int y, int item_height, Graphics dc)
 		{
-//			SizeF size = dc.MeasureString (Text, Font, ClientSize.Width, new StringFormat ());
-//		int width = (int) size.Width + 3;
 			Font font = node.NodeFont;
 			if (node.NodeFont == null)
 				font = Font;
+			SizeF size = dc.MeasureString (node.Text, font, 0, string_format);
 			int width = (int)(node.Text.Length * font.Size * 0.85);
 			node.UpdateBounds (x, y, width, item_height);
 		}
@@ -1055,9 +1057,6 @@
 		 
 		private void DrawStaticNode (TreeNode node, Graphics dc)
 		{
-			StringFormat format = new StringFormat ();
-			format.LineAlignment = StringAlignment.Center;
-
 			if (!full_row_select)
 				DrawSelectionAndFocus(node, dc, node.Bounds);
 
@@ -1068,7 +1067,7 @@
 					ThemeEngine.Current.ColorHighlightText : node.ForeColor);
 			dc.DrawString (node.Text, font,
 					ThemeEngine.Current.ResPool.GetSolidBrush (text_color),
-					node.Bounds, format);
+					node.Bounds, string_format);
 		}
 
 		private void DrawNode (TreeNode node, Graphics dc, Rectangle clip, ref int depth, int item_height, int max_height)
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002071.html">[Mono-winforms-list] TreeView - selected node is hide
</A></li>
	<LI>Next message: <A HREF="002081.html">[Mono-winforms-list] TreeView - selected node is hide
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2075">[ date ]</a>
              <a href="thread.html#2075">[ thread ]</a>
              <a href="subject.html#2075">[ subject ]</a>
              <a href="author.html#2075">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-winforms-list">More information about the Mono-winforms-list
mailing list</a><br>
</body></html>
