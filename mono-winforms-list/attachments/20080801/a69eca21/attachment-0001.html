<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;Fri,&nbsp;Jul&nbsp;25,&nbsp;2008&nbsp;at&nbsp;11:34&nbsp;AM,&nbsp;Ivan&nbsp;N.&nbsp;Zlatev&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:contact@i-nz.net&quot;&gt;contact@i-nz.net&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;Carlos&nbsp;Alberto&nbsp;Cortez&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&nbsp;Hey,&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;The&nbsp;new&nbsp;code&nbsp;that&nbsp;detects&nbsp;not&nbsp;visibles&nbsp;areas&nbsp;of&nbsp;the&nbsp;window&nbsp;to&nbsp;scroll&lt;br&gt;<br>
&amp;gt;&nbsp;(obscured&nbsp;by&nbsp;other&nbsp;mwf&nbsp;windows&nbsp;or&nbsp;x11&nbsp;top&nbsp;level&nbsp;ones),&nbsp;although&nbsp;working&lt;br&gt;<br>
&amp;gt;&nbsp;fine,&nbsp;is&nbsp;somewhat&nbsp;slow,&nbsp;as&nbsp;some&nbsp;people&nbsp;have&nbsp;noticed.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;After&nbsp;some&nbsp;research,&nbsp;I&nbsp;found&nbsp;that&nbsp;getting&nbsp;all&nbsp;the&nbsp;child&nbsp;windows&nbsp;for&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;root&nbsp;window&nbsp;(using&nbsp;XQueryTree&nbsp;on&nbsp;RootWindow,&nbsp;this&nbsp;is,&nbsp;top&nbsp;level&nbsp;windows)&lt;br&gt;<br>
&amp;gt;&nbsp;is&nbsp;the&nbsp;hot&nbsp;spot,&nbsp;and&nbsp;was&nbsp;causing&nbsp;the&nbsp;slow&nbsp;down.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;And&nbsp;after&nbsp;some&nbsp;more&nbsp;research&nbsp;in&nbsp;other&nbsp;graphics&nbsp;tool&nbsp;kits,&nbsp;found&nbsp;that:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;*&nbsp;Most&nbsp;of&nbsp;them&nbsp;make&nbsp;use&nbsp;of&nbsp;GraphicsExpose&nbsp;event,&nbsp;handling&nbsp;it&nbsp;by&nbsp;directly&lt;br&gt;<br>
&amp;gt;&nbsp;generating&nbsp;expose&nbsp;events&nbsp;or&nbsp;invalidating&nbsp;the&nbsp;area&nbsp;pointed&nbsp;by&lt;br&gt;<br>
&amp;gt;&nbsp;GraphicsExpose&nbsp;(Gtk+&nbsp;as&nbsp;far&nbsp;as&nbsp;I&nbsp;know,&nbsp;and&nbsp;also&nbsp;Ivan&nbsp;told&nbsp;me&nbsp;other&lt;br&gt;<br>
&amp;gt;&nbsp;frameworks&nbsp;do&nbsp;that).&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;Yes,&nbsp;this&nbsp;is&nbsp;because&nbsp;GraphicsExpose&nbsp;is&nbsp;designed&nbsp;exactly&nbsp;for&nbsp;that&lt;br&gt;<br>
purpose.&nbsp;It&nbsp;is&nbsp;fired&nbsp;when&nbsp;a&nbsp;destination&nbsp;area&nbsp;can&amp;#39;t&nbsp;be&nbsp;copied&nbsp;(XCopyArea)&lt;br&gt;<br>
to&nbsp;because&nbsp;the&nbsp;source&nbsp;area&nbsp;is&nbsp;obscured.&nbsp;I&nbsp;still&nbsp;fail&nbsp;to&nbsp;see&nbsp;why&nbsp;we&nbsp;need&lt;br&gt;<br>
special&nbsp;obscured-areas-checking&nbsp;logic&nbsp;when&nbsp;we&nbsp;can&nbsp;just&nbsp;handle&nbsp;that&nbsp;message.&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;You&nbsp;answer&nbsp;your&nbsp;question&nbsp;below&nbsp;-&nbsp;the&nbsp;reason&nbsp;why&nbsp;we&nbsp;couldn&amp;#39;t&nbsp;use&nbsp;GraphicsExpose&nbsp;is&nbsp;precisely&nbsp;because&nbsp;of&nbsp;the&nbsp;timing&nbsp;issue.&amp;nbsp;&nbsp;Calculating&nbsp;the&nbsp;exact&nbsp;region&nbsp;to&nbsp;expose&nbsp;is&nbsp;just&nbsp;one&nbsp;possible&nbsp;solution&nbsp;(which&nbsp;turns&nbsp;out&nbsp;to&nbsp;likely&nbsp;be&nbsp;the&nbsp;wrong&nbsp;one).&lt;br&gt;<br>
&amp;nbsp;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
I&nbsp;do&nbsp;understand&nbsp;that&nbsp;if&nbsp;we&nbsp;do&nbsp;indeed&nbsp;handle&nbsp;the&nbsp;GraphicsExpose&nbsp;message&lt;br&gt;<br>
we&nbsp;stand&nbsp;the&nbsp;problem&nbsp;that&nbsp;it&nbsp;might&nbsp;get&nbsp;delayed&nbsp;(X11&nbsp;message&nbsp;roundtrip&lt;br&gt;<br>
time)&nbsp;until&nbsp;after&nbsp;we&nbsp;perform&nbsp;the&nbsp;next&nbsp;ScrollWindow/XCopyArea,&nbsp;so&nbsp;because&lt;br&gt;<br>
the&nbsp;destination&nbsp;area&nbsp;(for&nbsp;the&nbsp;previous&nbsp;ScrollWindow&nbsp;call)&nbsp;won&amp;#39;t&nbsp;be&lt;br&gt;<br>
repainted&nbsp;yet&nbsp;we&nbsp;will&nbsp;copy&nbsp;that&nbsp;garbage&nbsp;from&nbsp;it&nbsp;to&nbsp;the&nbsp;next&nbsp;offset.&lt;br&gt;<br>
&lt;br&gt;<br>
However&nbsp;we&nbsp;currently&nbsp;have&nbsp;an&nbsp;explicit&nbsp;AddExpose&nbsp;just&nbsp;after&nbsp;the&lt;br&gt;<br>
XCopyArea,&nbsp;so&nbsp;we&nbsp;are&nbsp;working&nbsp;around&nbsp;this&nbsp;problem&nbsp;by&nbsp;forcing&nbsp;a&nbsp;repaint&nbsp;on&lt;br&gt;<br>
the&nbsp;queue,&nbsp;so&nbsp;that&nbsp;we&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;repainted&nbsp;prior&nbsp;to&nbsp;the&nbsp;next&lt;br&gt;<br>
ScrollWindow.&nbsp;And&nbsp;this&nbsp;just-works&nbsp;(tm)&nbsp;:-)&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;we&nbsp;want&nbsp;to&nbsp;handle&nbsp;it&nbsp;&amp;quot;properly&amp;quot;&nbsp;we&nbsp;can&nbsp;either&amp;quot;&lt;br&gt;<br>
&lt;br&gt;<br>
1)&nbsp;Flush&nbsp;the&nbsp;paint&nbsp;queue&nbsp;prior&nbsp;to&nbsp;XCopyArea&nbsp;somehow&lt;br&gt;<br>
...&nbsp;or&nbsp;...&lt;br&gt;<br>
2)&nbsp;&amp;quot;Block&amp;quot;&nbsp;the&nbsp;message&nbsp;queue&nbsp;until&nbsp;we&nbsp;get&nbsp;the&nbsp;last&nbsp;GraphicsExpose&nbsp;for&lt;br&gt;<br>
the&nbsp;window,&nbsp;invalidate&nbsp;and&nbsp;then&nbsp;&amp;quot;unblock&amp;quot;&nbsp;the&nbsp;message&nbsp;queue.&lt;br&gt;<br>
...&nbsp;or&nbsp;...&lt;br&gt;<br>
3)&nbsp;Something&nbsp;better&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;And&nbsp;also,&nbsp;regarding&nbsp;our&nbsp;code:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;*&nbsp;When&nbsp;using&nbsp;composite&nbsp;(Xgl&nbsp;or&nbsp;similar)&nbsp;it&amp;#39;s&nbsp;not&nbsp;necessary&nbsp;to&nbsp;do&nbsp;this&lt;br&gt;<br>
&amp;gt;&nbsp;detection,&nbsp;since&nbsp;the&nbsp;window&nbsp;manager&nbsp;(*it&nbsp;seems*)&nbsp;is&nbsp;doing&nbsp;something&nbsp;that&lt;br&gt;<br>
&amp;gt;&nbsp;somehow&nbsp;already&nbsp;knows&nbsp;which&nbsp;areas&nbsp;need&nbsp;to&nbsp;get&nbsp;an&nbsp;expose&nbsp;event&nbsp;(in&nbsp;other&lt;br&gt;<br>
&amp;gt;&nbsp;words:&nbsp;only&nbsp;mwf&nbsp;overlapping&nbsp;detection&nbsp;is&nbsp;needed,&nbsp;not&nbsp;for&nbsp;x&nbsp;top&nbsp;level&lt;br&gt;<br>
&amp;gt;&nbsp;windows).&lt;br&gt;<br>
&amp;gt;&nbsp;*&nbsp;The&nbsp;new&nbsp;code,&nbsp;at&nbsp;least&nbsp;in&nbsp;my&nbsp;laptop,&nbsp;without&nbsp;using&nbsp;composite,&nbsp;seems&nbsp;to&lt;br&gt;<br>
&amp;gt;&nbsp;work&nbsp;fine&nbsp;(no&nbsp;performance&nbsp;lost),&nbsp;and&nbsp;don&amp;#39;t&nbsp;know&nbsp;if&nbsp;it&amp;#39;s&nbsp;because&lt;br&gt;<br>
&amp;gt;&nbsp;XQueryTree&nbsp;on&nbsp;RootTree&nbsp;returns&nbsp;a&nbsp;minor&nbsp;number&nbsp;of&nbsp;windows&nbsp;(61&nbsp;with&nbsp;no&lt;br&gt;<br>
&amp;gt;&nbsp;composite,&nbsp;instead&nbsp;of&nbsp;89&nbsp;with&nbsp;composite,&nbsp;using&nbsp;5&nbsp;terminals&nbsp;and&nbsp;a&nbsp;gtk+&lt;br&gt;<br>
&amp;gt;&nbsp;application,&nbsp;for&nbsp;example).&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;This&nbsp;I&nbsp;think&nbsp;is&nbsp;very&nbsp;implementation/environment/window&nbsp;manager/toolkit&lt;br&gt;<br>
specific.&nbsp;E.g&nbsp;some&nbsp;toolkits/window&nbsp;managers&nbsp;might&nbsp;keep&nbsp;menu&nbsp;windows&nbsp;as&lt;br&gt;<br>
hidden,&nbsp;but&nbsp;still&nbsp;mapped&nbsp;toplevels.&nbsp;I&nbsp;think&nbsp;this&nbsp;was&nbsp;referred&nbsp;to&nbsp;as&nbsp;one&lt;br&gt;<br>
of&nbsp;the&nbsp;reason&nbsp;for&nbsp;the&nbsp;huge&nbsp;number&nbsp;of&nbsp;toplevels&nbsp;in&nbsp;some&nbsp;email&nbsp;I&nbsp;saw&nbsp;on&nbsp;a&lt;br&gt;<br>
mailing&nbsp;list&nbsp;long&nbsp;time&nbsp;ago.&nbsp;Because&nbsp;of&nbsp;the&nbsp;variety&nbsp;of&nbsp;setups&nbsp;out&nbsp;there&lt;br&gt;<br>
(window&nbsp;managers,&nbsp;toolkits,&nbsp;etc,&nbsp;etc)&nbsp;we&nbsp;can&amp;#39;t&nbsp;really&nbsp;know&nbsp;with&nbsp;how&nbsp;many&lt;br&gt;<br>
toplevels&nbsp;we&nbsp;are&nbsp;going&nbsp;to&nbsp;deal.&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;give&nbsp;you&nbsp;an&nbsp;example&nbsp;of&nbsp;the&nbsp;problem&nbsp;-&nbsp;on&nbsp;my&nbsp;GNOME&nbsp;+&nbsp;Metacity&nbsp;desktop&lt;br&gt;<br>
with&nbsp;a&nbsp;standard&nbsp;set&nbsp;of&nbsp;programs&nbsp;running&nbsp;(Firefox,&nbsp;terminal,&nbsp;pidgin,&lt;br&gt;<br>
nautilus,&nbsp;thunderbird,&nbsp;etc)&nbsp;XQueryTree&nbsp;returns&nbsp;228&nbsp;toplevels.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;br&gt;<br>
&amp;gt;&nbsp;So,&nbsp;it&nbsp;seems&nbsp;that&nbsp;we&nbsp;should&nbsp;actually&nbsp;handle&nbsp;GraphicsExpose&nbsp;(which&nbsp;all&nbsp;it&lt;br&gt;<br>
&amp;gt;&nbsp;involves)&nbsp;*or&nbsp;maybe*&nbsp;try&nbsp;to&nbsp;detect&nbsp;if&nbsp;we&nbsp;are&nbsp;using&nbsp;composite&nbsp;-&nbsp;if&nbsp;we&lt;br&gt;<br>
&amp;gt;&nbsp;are,&nbsp;simply&nbsp;don&amp;#39;t&nbsp;use&nbsp;this&nbsp;new&nbsp;code,&nbsp;but&nbsp;just&nbsp;do&nbsp;simple&nbsp;calculations,&lt;br&gt;<br>
&amp;gt;&nbsp;and&nbsp;if&nbsp;we&nbsp;are&nbsp;not&nbsp;using&nbsp;it,&nbsp;do&nbsp;the&nbsp;detection,&nbsp;since&nbsp;it&nbsp;won&amp;#39;t&nbsp;harm&nbsp;the&lt;br&gt;<br>
&amp;gt;&nbsp;performance.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;My&nbsp;personal&nbsp;position&nbsp;on&nbsp;the&nbsp;matter&nbsp;is&nbsp;that&nbsp;short-term&nbsp;(as&nbsp;in&nbsp;for&nbsp;Mono&lt;br&gt;<br>
2.0)&nbsp;we&nbsp;just&nbsp;handle&nbsp;GraphicsExpose&nbsp;instead&nbsp;of&nbsp;the&nbsp;new&nbsp;code&nbsp;and&nbsp;keep&nbsp;the&lt;br&gt;<br>
AddExpose&nbsp;after&nbsp;XCopyArea&nbsp;to&nbsp;workaround&nbsp;the&nbsp;timing&nbsp;issue.&nbsp;Long-term&nbsp;we&lt;br&gt;<br>
can&nbsp;look&nbsp;into&nbsp;adding&nbsp;a&nbsp;proper&nbsp;handling&nbsp;for&nbsp;the&nbsp;delays&nbsp;of&nbsp;GraphicsExpose&lt;br&gt;<br>
if&nbsp;it&amp;#39;s&nbsp;feasible.&lt;br&gt;<br>
&lt;div&nbsp;class=&quot;Ih2E3d&quot;&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;This&nbsp;has&nbsp;me&nbsp;a&nbsp;little&nbsp;confused&nbsp;-&nbsp;adding&nbsp;handling&nbsp;for&nbsp;GraphicsExpose&nbsp;isn&amp;#39;t&nbsp;going&nbsp;to&nbsp;help&nbsp;anything&nbsp;if&nbsp;it&amp;#39;s&nbsp;not&nbsp;done&nbsp;properly.&amp;nbsp;&nbsp;What&nbsp;I&nbsp;mean&nbsp;is,&nbsp;adding&nbsp;the&nbsp;handling&nbsp;for&nbsp;GraphicsExpose&nbsp;(essentially&nbsp;adding&nbsp;the&nbsp;case&nbsp;statement&nbsp;and&nbsp;doing&nbsp;an&nbsp;AddExpose)&nbsp;won&amp;#39;t&nbsp;give&nbsp;us&nbsp;anything&nbsp;more&nbsp;than&nbsp;what&nbsp;we&nbsp;currently&nbsp;have,&nbsp;since&nbsp;we&nbsp;can&amp;#39;t&nbsp;guarantee&nbsp;that&nbsp;any&nbsp;of&nbsp;those&nbsp;events&nbsp;will&nbsp;have&nbsp;been&nbsp;received.&amp;nbsp;&nbsp;It&amp;#39;s&nbsp;a&nbsp;trivial&nbsp;change,&nbsp;and&nbsp;might&nbsp;lessen&nbsp;the&nbsp;problem&nbsp;somewhat,&nbsp;but&nbsp;it&nbsp;won&amp;#39;t&nbsp;fix&nbsp;it.&lt;br&gt;<br>
&lt;br&gt;I&amp;#39;m&nbsp;also&nbsp;not&nbsp;sure&nbsp;flushing&nbsp;the&nbsp;paint&nbsp;queue&nbsp;before&nbsp;doing&nbsp;the&nbsp;XCopyArea&nbsp;(suggestion&nbsp;1&nbsp;above)&nbsp;will&nbsp;be&nbsp;enough&nbsp;either.&amp;nbsp;&nbsp;It&amp;#39;s&nbsp;very&nbsp;easy&nbsp;to&nbsp;imagine&nbsp;a&nbsp;scenario&nbsp;where&nbsp;you&amp;#39;re&nbsp;scrolling&nbsp;and&nbsp;we&nbsp;do&nbsp;another&nbsp;ScrollWindow&nbsp;before&nbsp;all&nbsp;the&nbsp;GraphicsExpose&nbsp;events&nbsp;have&nbsp;been&nbsp;received.&amp;nbsp;&nbsp;We&nbsp;really&nbsp;do&nbsp;need&nbsp;to&nbsp;block&nbsp;things&nbsp;somehow.&amp;nbsp;&nbsp;And&nbsp;it&amp;#39;ll&nbsp;be&nbsp;more&nbsp;than&nbsp;just&nbsp;blocking&nbsp;the&nbsp;message&nbsp;queue&nbsp;-&nbsp;we&amp;#39;ll&nbsp;need&nbsp;to&nbsp;actually&nbsp;stop&nbsp;the&nbsp;thread&nbsp;if&nbsp;there&amp;#39;s&nbsp;a&nbsp;call&nbsp;to&nbsp;ScrollWindow&nbsp;(or&nbsp;anything&nbsp;else&nbsp;that&nbsp;ends&nbsp;up&nbsp;copying)&nbsp;until&nbsp;the&nbsp;GraphicsExposes&nbsp;have&nbsp;been&nbsp;handled.&lt;br&gt;<br>
&lt;br&gt;chris&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
