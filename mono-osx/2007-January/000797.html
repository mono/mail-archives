<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20%5BMono-dev%5D%20OS%20X%20builds%20and%20-DUSE-MUNMAP&In-Reply-To=0EE5D59D-F451-4DD2-82D5-576F6F292F5F%40mac.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000772.html">
   <LINK REL="Next"  HREF="000798.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP</H1>
    <B>Eoin Norris</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20%5BMono-dev%5D%20OS%20X%20builds%20and%20-DUSE-MUNMAP&In-Reply-To=0EE5D59D-F451-4DD2-82D5-576F6F292F5F%40mac.com"
       TITLE="[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP">e.norris at mac.com
       </A><BR>
    <I>Wed Jan 24 06:02:11 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000772.html">[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP
</A></li>
        <LI>Next message: <A HREF="000798.html">[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#797">[ date ]</a>
              <a href="thread.html#797">[ thread ]</a>
              <a href="subject.html#797">[ subject ]</a>
              <a href="author.html#797">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>
Hmm. I am not so sure that this has made it, or works as advertised.  
i can see - in loading in a very large xml file -

Take this function

	public void PopulateXMLString()
		{
			try
			{
				// Open xml file
				XmlDocument doc = new XmlDocument();
				
				// Turn off external url resolving (e.g. for schema validation)
				doc.XmlResolver = null;

				doc.LoadXml(_libraryXmlString);

				// Read version
				_version = doc.SelectSingleNode(XmlNode_PList).Attributes 
[XmlAttr_Version].Value;
				if (_version != SupportedVersion) throw new FormatException(&quot;Can  
only decode version 1.0 specification files!&quot;);
				
				// My Decode dict ( internal class)
				_contents = Dict.Decode(doc.SelectSingleNode(XmlNode_PList + '/'  
+ XmlNode_Dict));
			}
			catch (System.Threading.ThreadAbortException)
			{
...
			}
			catch (Exception ex)
			{
			...
			}
		}

This bloats to 200MB when reading a 23MB xml file - mostly in  
doc.LoadXml(_libraryXmlString) as far as I can see ( although without  
a full debugger it is hard to tell) . I have also would do the same  
if it were read from disk at this point,   a process that is too slow  
in any case, so I load in the Cocoa layer instead.

( i.e. to read fom disk I can use :

				using (FileStream s = _libraryXmlFile.OpenRead())
				{
					doc.Load(s);
				}

with the same results in terms of memory consumption, or worse)


The size increase is possibly a bug in itself, since the .Net side on  
windows doing similar code does not bloat to that level.

In any case the object that encapsulates this functionality does not  
need to hang around after it's contents are written to a different  
datastore.

so I blow it away like so

	if (xmlString.Length != 0)
		library.PopulateXMLString();

.. do stuff with the library contents

	library = NULL;
	GC.Collect();


The specific call to GC.Collect is just a test case, not normally in  
production code. In any case the code bloats and stays bloated. So I  
dont think that this fix has made it, unless I am doing somthing  
wrong :-)

  Were I to download the sources, where should I look to see if this  
is in the suggested sources i.e. 1.2.2.1 ? Is there a way to tell  
from the dlls ( I suspect not).

I should add this is really a deal breaker in terms of releasing the  
product, as you can imagine not releasing large amounts of memory is  
a big issue.

thanks in advance.

-- Eoin






&gt;<i> According to your quote it's committed, thus likely in 1.2.2 (Dec
</I>&gt;<i> 6th). There is no 2.1 just yet. :-)
</I>&gt;<i>
</I>&gt;<i> Andreas
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 11 Jan 2007, at 12:11, Eoin Norris wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Is this scheduled for a release anytime soon, is it in 2.1?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -- Eoin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2 Dec 2006, at 00:07, Allan Hsu wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Dec 1, 2006, at 2:55 PM, Miguel de Icaza wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Nobody has objected to turning on -DUSE_MUNMAP under OS X since I
</I>&gt;&gt;&gt;&gt;&gt;<i> posted this email... Can somebody give me the go-ahead to  
</I>&gt;&gt;&gt;&gt;&gt;<i> commit the
</I>&gt;&gt;&gt;&gt;&gt;<i> configure.in change needed to switch over?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Go ahead.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Committed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;<i> Allan Hsu &lt;allan at counterpop dot net&gt;
</I>&gt;&gt;&gt;<i> 1E64 E20F 34D9 CBA7 1300  1457 AC37 CBBB 0E92 C779
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Mono-osx mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">Mono-osx at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">http://lists.ximian.com/mailman/listinfo/mono-osx</A>
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-osx/attachments/20070124/5c824f1a/attachment-0001.html">http://lists.ximian.com/pipermail/mono-osx/attachments/20070124/5c824f1a/attachment-0001.html</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000772.html">[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP
</A></li>
	<LI>Next message: <A HREF="000798.html">[Mono-osx] [Mono-dev] OS X builds and -DUSE-MUNMAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#797">[ date ]</a>
              <a href="thread.html#797">[ thread ]</a>
              <a href="subject.html#797">[ subject ]</a>
              <a href="author.html#797">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
