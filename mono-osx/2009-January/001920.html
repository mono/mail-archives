<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] How to logon to Win or Mac using credentials through code?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20How%20to%20logon%20to%20Win%20or%20Mac%20using%20credentials%20through%0A%20code%3F&In-Reply-To=21591295.post%40talk.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001917.html">
   <LINK REL="Next"  HREF="001922.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] How to logon to Win or Mac using credentials through code?</H1>
    <B>d_v</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20How%20to%20logon%20to%20Win%20or%20Mac%20using%20credentials%20through%0A%20code%3F&In-Reply-To=21591295.post%40talk.nabble.com"
       TITLE="[Mono-osx] How to logon to Win or Mac using credentials through code?">dan.vandermolen at figpsoft.com
       </A><BR>
    <I>Thu Jan 22 10:08:38 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001917.html">[Mono-osx] How to logon to Win or Mac using credentials through code?
</A></li>
        <LI>Next message: <A HREF="001922.html">[Mono-osx] How to logon to Win or Mac using credentials through code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1920">[ date ]</a>
              <a href="thread.html#1920">[ thread ]</a>
              <a href="subject.html#1920">[ subject ]</a>
              <a href="author.html#1920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I should be more specific, besides I have not heard any ideas yet :)

When I say &quot;logon&quot; I really mean that I am trying to copy a file over the
network and I would like to supply the username and password and (domain). 
At this point I don't even know if a Mac requires a domain name...

If you can point me in the right direction I would be grateful. even a
link/bone :)


d_v wrote:
&gt;<i> 
</I>&gt;<i> Does anyone have a good way to logon to Windows and a Mac using
</I>&gt;<i> credentials through code?
</I>&gt;<i> 
</I>&gt;<i> I am using the Impersonator code and am now trying to get it to run on Mac
</I>&gt;<i> 2.2_5 (latest build).
</I>&gt;<i> 
</I>&gt;<i> The error I recieved was:
</I>&gt;<i> 
</I>&gt;<i> System.DllNotFoundException: advapi32.dll
</I>&gt;<i>   at (wrapper managed-to-native) MiscImpersonate.Impersonator:RevertToSelf
</I>&gt;<i> ()
</I>&gt;<i>   at MiscImpersonate.Impersonator.ImpersonateValidUser (System.String
</I>&gt;<i> userName, System.String domain, System.String password) [0x00000] 
</I>&gt;<i>   at MiscImpersonate.Impersonator..ctor (System.String userName,
</I>&gt;<i> System.String domainName, System.String password) [0x00000] 
</I>&gt;<i>   at My_App.Form1.VerifyClientSettings_FileFilter () [0x00000]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Impersonator code is from:
</I>&gt;<i> <A HREF="http://www.codeproject.com/KB/cs/zetaimpersonator.aspx">http://www.codeproject.com/KB/cs/zetaimpersonator.aspx</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here is the Impersonator code in my MiscImpersonate unit in C# for DotNet
</I>&gt;<i> 2.x:
</I>&gt;<i> // *********************************************************
</I>&gt;<i> 
</I>&gt;<i> namespace MiscImpersonate
</I>&gt;<i> {
</I>&gt;<i>     #region Using directives.
</I>&gt;<i>     //
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>     using System;
</I>&gt;<i>     using System.Security.Principal;
</I>&gt;<i>     using System.Runtime.InteropServices;
</I>&gt;<i>     using System.ComponentModel;
</I>&gt;<i> 
</I>&gt;<i>     //
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i>     #endregion
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> /////////////////////////////////////////////////////////////////////////
</I>&gt;<i> 
</I>&gt;<i>     /// &lt;summary&gt;
</I>&gt;<i>     /// Impersonation of a user. Allows to execute code under another
</I>&gt;<i>     /// user context.
</I>&gt;<i>     /// Please note that the account that instantiates the Impersonator
</I>&gt;<i> class
</I>&gt;<i>     /// needs to have the 'Act as part of operating system' privilege set.
</I>&gt;<i>     /// &lt;/summary&gt;
</I>&gt;<i>     /// &lt;remarks&gt;	
</I>&gt;<i>     /// Download this file:
</I>&gt;<i> <A HREF="http://www.codeproject.com/KB/cs/zetaimpersonator.aspx">http://www.codeproject.com/KB/cs/zetaimpersonator.aspx</A>
</I>&gt;<i>     /// This class is based on the information in the Microsoft knowledge
</I>&gt;<i> base
</I>&gt;<i>     /// article
</I>&gt;<i> <A HREF="http://support.microsoft.com/default.aspx?scid=kb;en-us;Q306158">http://support.microsoft.com/default.aspx?scid=kb;en-us;Q306158</A>
</I>&gt;<i>     /// 
</I>&gt;<i>     /// Encapsulate an instance into a using-directive like e.g.:
</I>&gt;<i>     /// 
</I>&gt;<i>     ///		...
</I>&gt;<i>     ///		using ( new Impersonator( &quot;myUsername&quot;, &quot;myDomainname&quot;,
</I>&gt;<i> &quot;myPassword&quot; ) )
</I>&gt;<i>     ///		{
</I>&gt;<i>     ///			...
</I>&gt;<i>     ///			[code that executes under the new context]
</I>&gt;<i>     ///			...
</I>&gt;<i>     ///		}
</I>&gt;<i>     ///		...
</I>&gt;<i>     /// 
</I>&gt;<i>     /// Please contact the author Uwe Keim
</I>&gt;<i> (mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">uwe.keim at zeta-software.de</A>)
</I>&gt;<i>     /// for questions regarding this class.
</I>&gt;<i>     /// &lt;/remarks&gt;
</I>&gt;<i>     public class Impersonator :
</I>&gt;<i>         IDisposable
</I>&gt;<i>     {
</I>&gt;<i>         #region Public methods.
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>         /// &lt;summary&gt;
</I>&gt;<i>         /// Constructor. Starts the impersonation with the given
</I>&gt;<i> credentials.
</I>&gt;<i>         /// Please note that the account that instantiates the
</I>&gt;<i> Impersonator class
</I>&gt;<i>         /// needs to have the 'Act as part of operating system' privilege
</I>&gt;<i> set.
</I>&gt;<i>         /// &lt;/summary&gt;
</I>&gt;<i>         /// The name of the user to act as.
</I>&gt;<i>         /// The domain name of the user to act as.
</I>&gt;<i>         /// The password of the user to act as.
</I>&gt;<i>         public Impersonator(
</I>&gt;<i>             string userName,
</I>&gt;<i>             string domainName,
</I>&gt;<i>             string password)
</I>&gt;<i>         {
</I>&gt;<i>             ImpersonateValidUser(userName, domainName, password);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region IDisposable member.
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>         public void Dispose()
</I>&gt;<i>         {
</I>&gt;<i>             UndoImpersonation();
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region P/Invoke.
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>         [DllImport(&quot;advapi32.dll&quot;, SetLastError = true)]
</I>&gt;<i>         private static extern int LogonUser(
</I>&gt;<i>             string lpszUserName,
</I>&gt;<i>             string lpszDomain,
</I>&gt;<i>             string lpszPassword,
</I>&gt;<i>             int dwLogonType,
</I>&gt;<i>             int dwLogonProvider,
</I>&gt;<i>             ref IntPtr phToken);
</I>&gt;<i> 
</I>&gt;<i>         [DllImport(&quot;advapi32.dll&quot;, CharSet = CharSet.Auto, SetLastError =
</I>&gt;<i> true)]
</I>&gt;<i>         private static extern int DuplicateToken(
</I>&gt;<i>             IntPtr hToken,
</I>&gt;<i>             int impersonationLevel,
</I>&gt;<i>             ref IntPtr hNewToken);
</I>&gt;<i> 
</I>&gt;<i>         [DllImport(&quot;advapi32.dll&quot;, CharSet = CharSet.Auto, SetLastError =
</I>&gt;<i> true)]
</I>&gt;<i>         private static extern bool RevertToSelf();
</I>&gt;<i> 
</I>&gt;<i>         [DllImport(&quot;kernel32.dll&quot;, CharSet = CharSet.Auto)]
</I>&gt;<i>         private static extern bool CloseHandle(
</I>&gt;<i>             IntPtr handle);
</I>&gt;<i> 
</I>&gt;<i>         private const int LOGON32_LOGON_INTERACTIVE = 2;
</I>&gt;<i>         private const int LOGON32_PROVIDER_DEFAULT = 0;
</I>&gt;<i> 
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region Private member.
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i>         /// &lt;summary&gt;
</I>&gt;<i>         /// Does the actual impersonation.
</I>&gt;<i>         /// &lt;/summary&gt;
</I>&gt;<i>         /// The name of the user to act as.
</I>&gt;<i>         /// The domain name of the user to act as.
</I>&gt;<i>         /// The password of the user to act as.
</I>&gt;<i>         private void ImpersonateValidUser(
</I>&gt;<i>             string userName,
</I>&gt;<i>             string domain,
</I>&gt;<i>             string password)
</I>&gt;<i>         {
</I>&gt;<i>             WindowsIdentity tempWindowsIdentity = null;
</I>&gt;<i>             IntPtr token = IntPtr.Zero;
</I>&gt;<i>             IntPtr tokenDuplicate = IntPtr.Zero;
</I>&gt;<i> 
</I>&gt;<i>             try
</I>&gt;<i>             {
</I>&gt;<i>                 if (RevertToSelf())
</I>&gt;<i>                 {
</I>&gt;<i>                     if (LogonUser(
</I>&gt;<i>                         userName,
</I>&gt;<i>                         domain,
</I>&gt;<i>                         password,
</I>&gt;<i>                         LOGON32_LOGON_INTERACTIVE,
</I>&gt;<i>                         LOGON32_PROVIDER_DEFAULT,
</I>&gt;<i>                         ref token) != 0)
</I>&gt;<i>                     {
</I>&gt;<i>                         if (DuplicateToken(token, 2, ref tokenDuplicate)
</I>&gt;<i> != 0)
</I>&gt;<i>                         {
</I>&gt;<i>                             tempWindowsIdentity = new
</I>&gt;<i> WindowsIdentity(tokenDuplicate);
</I>&gt;<i>                             impersonationContext =
</I>&gt;<i> tempWindowsIdentity.Impersonate();
</I>&gt;<i>                         }
</I>&gt;<i>                         else
</I>&gt;<i>                         {
</I>&gt;<i>                             throw new
</I>&gt;<i> Win32Exception(Marshal.GetLastWin32Error());
</I>&gt;<i>                         }
</I>&gt;<i>                     }
</I>&gt;<i>                     else
</I>&gt;<i>                     {
</I>&gt;<i>                         throw new
</I>&gt;<i> Win32Exception(Marshal.GetLastWin32Error());
</I>&gt;<i>                     }
</I>&gt;<i>                 }
</I>&gt;<i>                 else
</I>&gt;<i>                 {
</I>&gt;<i>                     throw new Win32Exception(Marshal.GetLastWin32Error());
</I>&gt;<i>                 }
</I>&gt;<i>             }
</I>&gt;<i>             finally
</I>&gt;<i>             {
</I>&gt;<i>                 if (token != IntPtr.Zero)
</I>&gt;<i>                 {
</I>&gt;<i>                     CloseHandle(token);
</I>&gt;<i>                 }
</I>&gt;<i>                 if (tokenDuplicate != IntPtr.Zero)
</I>&gt;<i>                 {
</I>&gt;<i>                     CloseHandle(tokenDuplicate);
</I>&gt;<i>                 }
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         /// &lt;summary&gt;
</I>&gt;<i>         /// Reverts the impersonation.
</I>&gt;<i>         /// &lt;/summary&gt;
</I>&gt;<i>         private void UndoImpersonation()
</I>&gt;<i>         {
</I>&gt;<i>             if (impersonationContext != null)
</I>&gt;<i>             {
</I>&gt;<i>                 impersonationContext.Undo();
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         private WindowsImpersonationContext impersonationContext = null;
</I>&gt;<i> 
</I>&gt;<i>         //
</I>&gt;<i> ------------------------------------------------------------------
</I>&gt;<i>         #endregion
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i>    
</I>&gt;<i> /////////////////////////////////////////////////////////////////////////
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>
-- 
View this message in context: <A HREF="http://www.nabble.com/How-to-logon-to-Win-or-Mac-using-credentials-through-code--tp21591295p21606045.html">http://www.nabble.com/How-to-logon-to-Win-or-Mac-using-credentials-through-code--tp21591295p21606045.html</A>
Sent from the Mono - OSX mailing list archive at Nabble.com.

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001917.html">[Mono-osx] How to logon to Win or Mac using credentials through code?
</A></li>
	<LI>Next message: <A HREF="001922.html">[Mono-osx] How to logon to Win or Mac using credentials through code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1920">[ date ]</a>
              <a href="thread.html#1920">[ thread ]</a>
              <a href="subject.html#1920">[ subject ]</a>
              <a href="author.html#1920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
