<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] Registering an NSThread with Mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Registering%20an%20NSThread%20with%20Mono&In-Reply-To=4A4AE411-B716-410F-9516-671B7B67242F%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002021.html">
   <LINK REL="Next"  HREF="001941.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] Registering an NSThread with Mono</H1>
    <B>Kevin Heeney</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Registering%20an%20NSThread%20with%20Mono&In-Reply-To=4A4AE411-B716-410F-9516-671B7B67242F%40gmail.com"
       TITLE="[Mono-osx] Registering an NSThread with Mono">koheeney at gmail.com
       </A><BR>
    <I>Sun Jan 25 19:44:52 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002021.html">[Mono-osx]  Problem with mod_mono / mono 2.2 on ppc mac
</A></li>
        <LI>Next message: <A HREF="001941.html">[Mono-osx] [ANN] NObjective bridge to Objective-C v0.9.4 Released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1940">[ date ]</a>
              <a href="thread.html#1940">[ thread ]</a>
              <a href="subject.html#1940">[ subject ]</a>
              <a href="author.html#1940">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So this is sort of a thread bump I guess.  I am still having the below
issue; however I am now attaching more information I hope.  I have ObjC
classes that I have written that invoke my Mono classes.  These are working
and I have written an app utilizing these. I am now experimenting using a
library called MacFuse, in essence I pass it an ObjC object which it holds
and calls (a delegate object).  When that object is called from MacFuse
everything works except for when invoking mono, my variables come back null.
The below function is the function that errors out.  My ObjC class still has
all the data it had and when calling this same object from my main thread it
works, so it can't be garbage collection for either ObjC or Mono because I
can still access all of the data from my main thread.  The error is only
when being called from another API (and in this case I believe the OSX
kernel).

The below function outputs the following when being called from the MacFuse
thread:
2009-01-25 18:28:12.885 InvokeMonoTest[670] val is null in
getStringFieldValue
2009-01-25 18:28:12.885 InvokeMonoTest[670] p is null in getStringFieldValue
2009-01-25 18:28:12.885 InvokeMonoTest[670]  ERROR in attributesOfItemAtPath
  *** -[NSPlaceholderString initWithUTF8String:]: NULL cString

-(NSString*) getStringFieldValue: (NSString*) FieldName

{


 MonoClassField *field;

MonoString* val;


mono_thread_attach(domain);



field = mono_class_get_field_from_name ([MonoGlobals monoFClass], [FieldName
UTF8String]);


 if (!field) {

fprintf (stderr, &quot;Can't find field %s in MyType\n&quot;,[FieldName UTF8String]);

exit (1);

}


 if (!fsObject) NSLog(@&quot;fsObject is null in getStringFieldValue&quot;);


 mono_field_get_value (fsObject, field, &amp;val);


 if (!val) NSLog(@&quot;val is null in getStringFieldValue&quot;);


 char *p;

p = mono_string_to_utf8 (val);

 if (!p) NSLog(@&quot;p is null in getStringFieldValue&quot;);


 NSString* retStr = [[NSString alloc] initWithUTF8String:p];

return retStr;


}






On Wed, Nov 26, 2008 at 7:20 PM, Kevin Heeney &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">koheeney at gmail.com</A>&gt; wrote:

&gt;<i> Okay, so I think it is an issue somehow with how I am invoking Mono.  When
</I>&gt;<i> being called from the main thread, the following code works.  When being
</I>&gt;<i> called from a separate thread, on the same object, mono_string_to_utf8
</I>&gt;<i> (val) below returns NULL but does not throw an exception.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> mono_thread_attach(domain);
</I>&gt;<i>
</I>&gt;<i> MonoClassField *field;
</I>&gt;<i> MonoString* val;
</I>&gt;<i>
</I>&gt;<i> field = mono_class_get_field_from_name (myMonoclass, [FieldName
</I>&gt;<i> UTF8String]);
</I>&gt;<i>
</I>&gt;<i> mono_field_get_value (myMonoObject, field, &amp;val);
</I>&gt;<i> char *p;
</I>&gt;<i> p = mono_string_to_utf8 (val);  //p here will be null when being called
</I>&gt;<i> from a secondary thread.
</I>&gt;<i>
</I>&gt;<i> NSString* retStr = [[NSString alloc] initWithUTF8String:p]; //on secondary
</I>&gt;<i> threads, this line throws the exception &quot;-[NSPlaceholderString
</I>&gt;<i> initWithUTF8String:]: NULL cString&quot; because p is null
</I>&gt;<i> return retStr;
</I>&gt;<i>
</I>&gt;<i> I am doing more checks (like checking to make sure the field is found, but
</I>&gt;<i> I have removed that code in this sample).
</I>&gt;<i>
</I>&gt;<i> Any suggestions?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Kevin
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Nov 26, 2008, at 1:15 PM, Kevin Heeney wrote:
</I>&gt;<i>
</I>&gt;<i> I was thinking I had to pass mono_thread_attach a reference to a thread.
</I>&gt;<i>  Would calling mono_thread_attach(myDomain); work?   If so, I might have
</I>&gt;<i> a different issue.
</I>&gt;<i> Thanks,
</I>&gt;<i> Kevin
</I>&gt;<i>
</I>&gt;<i> On Nov 26, 2008, at 1:03 PM, Kevin Heeney wrote:
</I>&gt;<i>
</I>&gt;<i> Is there any way to register an NSThread with Mono?  I am using a 3rd party
</I>&gt;<i> framework which I pass a delegate class and it launches a new Thread.  I
</I>&gt;<i> have that class getting a reference to this created Thread using [NSThread
</I>&gt;<i> currentThread].  I now need to call Mono from this thread but I need
</I>&gt;<i> to register the thread using &quot;mono_thread_attach&quot; I believe.  Is there
</I>&gt;<i> anyway that I can do this with an NSThread?
</I>&gt;<i> Thanks,
</I>&gt;<i> Kevin
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-osx/attachments/20090125/d64ebb0d/attachment.html">http://lists.ximian.com/pipermail/mono-osx/attachments/20090125/d64ebb0d/attachment.html</A> 
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002021.html">[Mono-osx]  Problem with mod_mono / mono 2.2 on ppc mac
</A></li>
	<LI>Next message: <A HREF="001941.html">[Mono-osx] [ANN] NObjective bridge to Objective-C v0.9.4 Released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1940">[ date ]</a>
              <a href="thread.html#1940">[ thread ]</a>
              <a href="subject.html#1940">[ subject ]</a>
              <a href="author.html#1940">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
