<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] Embedding into XCode project
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Embedding%20into%20XCode%20project&In-Reply-To=h2zbba78bc31004050633q12b7bd00qa26089cd073085dd%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002793.html">
   <LINK REL="Next"  HREF="002804.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] Embedding into XCode project</H1>
    <B>Duane Wandless</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Embedding%20into%20XCode%20project&In-Reply-To=h2zbba78bc31004050633q12b7bd00qa26089cd073085dd%40mail.gmail.com"
       TITLE="[Mono-osx] Embedding into XCode project">duane at wandless.net
       </A><BR>
    <I>Mon Apr  5 10:29:35 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002793.html">[Mono-osx] Embedding into XCode project
</A></li>
        <LI>Next message: <A HREF="002804.html">[Mono-osx] Menu Bar for Mac OS X?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2794">[ date ]</a>
              <a href="thread.html#2794">[ thread ]</a>
              <a href="subject.html#2794">[ subject ]</a>
              <a href="author.html#2794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here is some info that may help.  There have been prior posts about this on
this forum as well.  It is not trivial but it is also not hard.  Once all of
this is done your C# classes will be available to the xcode world.

Best of luck.
Duane

Here is my init mono code and the main.m (below).  This is invoked when the
xcode application starts, see main.m.  This code fully embeds the mono
runtime assuming Mono 2.6.  There is code here that attempts to setup the
soft debugger as well (not completely working).  In prior mono releases I
ran into issues using a DLL so I use an EXE.  Note my setup is initmono.m
and host.c are compiled into a dynamic library.  That library is then linked
into the main xcode application.

This code uses mobjc but I've used monobjc before.  The code around
mymonoconfig is required so the dylib can be referenced.

Here is a prebuild command that is required to generate a host.c that is
compiled into your xcode application.  The resulting library is linked into
your application.

# shell script goes here
if [ $ACTION = &quot;build&quot; ]; then
export AS=&quot;as -arch i386&quot;
export
DYLD_LIBRARY_PATH=/Library/Frameworks/Mono.framework/Versions/Current/lib/
mkbundle -o $SRCROOT/host.c --nomain -c -oo $SRCROOT/Mono/libhost.a
$SRCROOT/Mono/MyMessage.dll $SRCROOT/Mono/MacMonoClient.exe
$SRCROOT/Mono/mobjc.dll $SRCROOT/Mono/mcocoa.dll System.dll System.Core.dll
System.Xml.Linq.dll System.Xml.dll System.Drawing.dll mscorlib.dll
System.Configuration.dll Mono.Security.dll System.Security.dll
--machine-config
/Library/Frameworks/Mono.framework/Versions/Current/etc/mono/2.0/machine.config
fi

I do NOT reference the mono.framework in my xcode project.  Instead I
modified the project settings:
LD_DYLIB_INSTALL_NAME = @loader_path/../Libraries/InitMono.dylib
OTHER_LDFLAGS = -pthread
-L/Library/Frameworks/Mono.framework/Versions/Current/lib -lmono -lpthread
-lm -lgthread-2.0 -lglib-2.0 -lintl <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">-rpath at loader_path</A>/../Libraries
LIBRARY_SEARCH_PATHS = Mono
OTHER_CFLAGS = -D_XOPEN_SOURCE -DPLATFORM_MACOSX -DUSE_MMAP -DUSE_MUNMAP
-DGC_MACOSX_THREADS -DGetCurrentProcess=MonoGetCurrentProcess
-DCreateEvent=MonoCreateEvent -DGetCurrentThread=MonoGetCurrentThread
-I/Library/Frameworks/Mono.framework/Versions/Current/lib/glib-2.0/include
-I/Library/Frameworks/Mono.framework/Versions/Current/include/glib-2.0
-D_THREAD_SAFE -D_REENTRANT
-I/Library/Frameworks/Mono.framework/Headers/mono-1.0

In my application bundle:
../My.app/Contents/Libraries
I have this structure:
InitMono.dylib System.dll
System.Xml.dll                 a.dylib
MacMonoClient.exe lib/
MacMonoClient.exe.mdb libglib-2.0.0.dylib
Mono.Security.dll libgthread-2.0.0.dylib
MyMessage.dll libintl.8.0.2.dylib
System.Configuration.dll libmono.0.dylib
System.Core.dll mcocoa.dll
System.Drawing.dll mobjc.dll
System.Drawing.dll.config mymonoconfig2
System.Xml.Linq.dll

Then under lib I have:
mono/2.0/mscorlib.dll

I then run these libraries (below) through install_name_tool.  You only have
to do these next 2 steps once.  The library names may have changed... I
copied the text below from my post on this forum on 10/1/2008.
libglib-2.0.0.1400.1.dylib    libgthread-2.0.0.1400.1.dylib
libmono.0.0.0.dylib
libgmodule-2.0.0.1400.1.dylib    libintl.8.0.1.dylib

Two things have to be performed on these libraries.  First the id of the
file has to be changed from the /Library/Frameworks/Mono.framework reference
to @loader_path/../Libraries/&lt;name&gt;.  Run otool -L &lt;the dylib file&gt;.
install_name_tool -id @loader_path/../Libraries/libintl.8.0.1.dylib
libintl.8.0.1.dylib

The second operation is to change the references to other dynamic libraries
you are embedding.
install_name_tool -change
/Library/Frameworks/Mono.framework/Versions/1.9.1/lib/libintl.8.0.1.dylib
@loader_path/../Libraries/libintl.8.0.1.dylib libglib-2.0.0.1400.1.dylib

Basically what you are doing is telling the runtime app where to find these
dynmaic libraries.  Rather than in the Frameworks directory look relative to
the application.  Place these modified libraires in
&lt;yourapp&gt;.app/Contents/Libraries.

Compile the xcode application normally.  Then run install_name_tool on it as
well, &lt;yourapp&gt;.app/Contents/MacOS/&lt;yourapp&gt;
install_name_tool -change
/Library/Frameworks/Mono.framework/Versions/1.9.1/lib/libgthread-2.0.0.1400.1.dylib
@loader_path/../Libraries/libgthread-2.0.0.1400.1.dylib &lt;yourapp&gt;

Now remember you have to run this install_name_tool many times.  Once for
each library referenced by your application.  And once for each reference in
the dynamic libraries to another dynamic library that you are trying to
embed.  Use otool -L &lt;file&gt; to find the references you need to modify.

##### initmono.m

#import &lt;Cocoa/Cocoa.h&gt;
#include &lt;mono/jit/jit.h&gt;
#include &lt;mono/metadata/assembly.h&gt;
#include &lt;mono/metadata/mono-config.h&gt;
#include &lt;mono/metadata/mono-debug.h&gt;
#include &lt;mono/utils/mono-logger.h&gt;

extern void mono_mkbundle_init();

void InitMono(int argc, char *argv[])
{
NSString *mPath = [[[NSBundle mainBundle] bundlePath]
stringByAppendingPathComponent:@&quot;Contents/Libraries/lib&quot;];
//g_setenv(&quot;MONO_PATH&quot;, [mPath UTF8String], 1);
 //mono_mkbundle_init();  //call this instead of loading the dll below
 MonoDomain *domain;

// these next 2 lines are used to load a file from the bundle directory
// if we call mono_mkbundle_init then we do not need these 2 lines
NSString *libraryPath = [[[NSBundle mainBundle] bundlePath]
stringByAppendingPathComponent:@&quot;Contents/Libraries/&quot;];
NSString *sampleAssemblyPath = [libraryPath stringByAppendingPathComponent:@
&quot;MacMonoClient.exe&quot;];
 //g_setenv(&quot;DYLD_LIBRARY_PATH&quot;, [libraryPath UTF8String], true);
//const gchar* val;
//val = g_getenv(&quot;DYLD_LIBRARY_PATH&quot;);
//NSLog(@&quot;Load Library %s&quot;, val);
//NSString* monoPath = [libraryPath stringByAppendingPathComponent:@&quot;lib&quot;];
//NSLog(@&quot;Mono %@&quot;, monoPath);
//NSLog(@&quot;initmono path %s&quot;, getenv(&quot;MONO_PATH&quot;));
//setenv(&quot;MONO_PATH&quot;, [monoPath UTF8String], true);
// NSLog(@&quot;zero&quot;);
// else NSLog(&quot;one&quot;);
//NSString *sampleAssemblyPath = @&quot;MacMonoClient.exe&quot;;
NSLog(@&quot;libraryPath: %@&quot;, sampleAssemblyPath);

NSString* mymonoconfig = @&quot;&lt;configuration&gt;&lt;dllmap dll=\&quot;mobjc-glue.dylib\&quot;
target=\&quot;&quot;;
mymonoconfig = [mymonoconfig stringByAppendingString:[libraryPath
stringByAppendingPathComponent:@&quot;a.dylib&quot;]];
mymonoconfig = [mymonoconfig stringByAppendingString:@&quot;\&quot;
/&gt;&lt;/configuration&gt;&quot;];
[mymonoconfig writeToFile:[libraryPath
stringByAppendingPathComponent:@&quot;mymonoconfig2&quot;]
atomically:YES encoding:NSASCIIStringEncoding error:NULL];

NSString* configFile = [libraryPath stringByAppendingPathComponent:@
&quot;mymonoconfig2&quot;];
mono_config_parse ([configFile UTF8String]);
#if MONO26_MY
 NSLog(@&quot;about to check for MOON_SOFT_DEBUG&quot;);
 const gchar *soft_debug;
soft_debug = g_getenv (&quot;MOON_SOFT_DEBUG&quot;);
if (soft_debug != NULL) {
NSLog(@&quot;we have MOON_SOFT_DEBUG %s&quot;, soft_debug);
gchar *opt = g_strdup_printf (&quot;--debugger-agent=%s&quot;, soft_debug);
mono_jit_parse_options (1, &amp;opt);
g_free (opt);
 mono_debug_init (MONO_DEBUG_FORMAT_MONO);
}
#endif

const gchar *my_debug;
my_debug = g_getenv (&quot;MY_MONO_DEBUG&quot;);
if (my_debug != NULL) {
NSLog(@&quot;MY DEBUG is %s&quot;, my_debug);
mono_debug_init (MONO_DEBUG_FORMAT_MONO);
}
const gchar *mono_trace_level;
mono_trace_level = g_getenv (&quot;PMONO_TRACE_LEVEL&quot;);
if (mono_trace_level != NULL)
mono_trace_set_level_string(mono_trace_level);

mono_assembly_setrootdir([mPath UTF8String]);
 domain = mono_jit_init ([sampleAssemblyPath UTF8String]);//, &quot;3.0.04506&quot;);
MonoAssembly *monoAssembly = mono_domain_assembly_open(domain,
[sampleAssemblyPath UTF8String]);

NSLog(@&quot;sample assembly: %p&quot;, monoAssembly);
mono_jit_exec (domain, monoAssembly, 1, argv);

}

My main.m:
#import &lt;Cocoa/Cocoa.h&gt;

int main(int argc, char *argv[])
{
NSAutoreleasePool *pool;
pool = [[NSAutoreleasePool alloc] init];
InitMono(argc, (char**)argv);
[pool release];

return NSApplicationMain(argc, (const char **) argv);
}

On Mon, Apr 5, 2010 at 9:33 AM, Alexander Chilcott
&lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">alexchilcott at gmail.com</A>&gt;wrote:

&gt;<i> Hey guys,
</I>&gt;<i>
</I>&gt;<i> I am an experienced C# developer and reasonably new to objective c and
</I>&gt;<i> xcode. I am having issues embedding the Mono framework into an objective-C
</I>&gt;<i> project I am working on. I have added the Mono.Framework to my linked
</I>&gt;<i> frameworks in my xcode project, but there are no header files being
</I>&gt;<i> displayed when I expand the Mono.Framework tree node in the xcode project. I
</I>&gt;<i> have installed the latest mono framework and CSDK.
</I>&gt;<i>
</I>&gt;<i> Does anyone have any experience with this? It seems to be a common theme
</I>&gt;<i> among forum posts for embedding mono in objective-c. Apologies if there is a
</I>&gt;<i> simple solution that I have missed, but I assure you I have googled my heart
</I>&gt;<i> out :)
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-osx mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">Mono-osx at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">http://lists.ximian.com/mailman/listinfo/mono-osx</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-osx/attachments/20100405/d379c94c/attachment-0001.html">http://lists.ximian.com/pipermail/mono-osx/attachments/20100405/d379c94c/attachment-0001.html</A> 
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002793.html">[Mono-osx] Embedding into XCode project
</A></li>
	<LI>Next message: <A HREF="002804.html">[Mono-osx] Menu Bar for Mac OS X?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2794">[ date ]</a>
              <a href="thread.html#2794">[ thread ]</a>
              <a href="subject.html#2794">[ subject ]</a>
              <a href="author.html#2794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
