<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] Active Directory Infinite Loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Active%20Directory%20Infinite%20Loop&In-Reply-To=379e1a8b0704050733t4769b61j6b90f685cb5d1d6%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000935.html">
   <LINK REL="Next"  HREF="000937.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] Active Directory Infinite Loop</H1>
    <B>Jaume Llard&#233;n Prieto</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Active%20Directory%20Infinite%20Loop&In-Reply-To=379e1a8b0704050733t4769b61j6b90f685cb5d1d6%40mail.gmail.com"
       TITLE="[Mono-osx] Active Directory Infinite Loop">jllarden at aim.com
       </A><BR>
    <I>Sat Jun  9 17:25:14 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000935.html">[Mono-osx] installing mod_mono on mac OS x
</A></li>
        <LI>Next message: <A HREF="000937.html">[Mono-osx] Active Directory Infinite Loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#936">[ date ]</a>
              <a href="thread.html#936">[ thread ]</a>
              <a href="subject.html#936">[ subject ]</a>
              <a href="author.html#936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm reanimating this thread because I've been investigating this  
issue for some time and I've arrived to some conclusions I'd like to  
share with the list. Please correct me if any of my assumptions or  
conclusions are wrong.

In my opinion the infinite loop is caused by a poor POSIX compliant  
sysv semaphores implementation on Mac OS X. As already pointed out in  
this list, this problem is not related to AD, but to UIDs over the 16- 
bit boundary (larger than 65535).

The problem is that although semaphores can always be created (semget  
works with small and with large UIDs), they can only be modified or  
deleted with small UIDs. semget fails with large UIDs because the  
owner UID of the semaphore is for some reason truncated to 16 bits  
and then it doesn't match the &quot;right&quot; UID. The consequence: the owner  
process gets a permission denied error.

It's difficult to say were things fail. Mac OS X provides several  
mechanisms for supporting POSIX sysv semaphores, eg:
1) xnu/bsd/sys/ipc.h defines a POSIX compliant and a legacy version  
of the ipc_perm struct. The kernel should be compiled with the POSIX  
compliant version.
2) libc/sys/semctl.c defines a stub function is defined to account  
for the difference in the ipc_perm struct.

[I downloaded libc and xnu from www.opensource.apple.com]

Debugging all this is quite time consuming. I couldn't arrive to a  
conclusion yet (helper functions like kauth_cred_getuid don't make  
things easy). It could be semget (xnu/bsd/kern/sysv_sem.c) failing to  
save large creator UID/GID information (it would truncate it  
instead). Or it could be semctl (also in xnu/bsd/kern/sysv_sem.c)  
failing to retrieve the creator UID/GID information.

I thought of filing a bug to Apple, but wanted to hear some opinions  
on this before.

Thanks,
jaume


PS:
You can test it yourself:
1) Create a user (I called it longuid) with System Preferences and  
change the UID with NetInfo Manager to a value over 65535. Don't  
forget to change as well the uid of its homedir and subdirectories.
2) Create a C file containing this code:

key_t mykey = 0xFEEDF00D;
int nsems = 1;
int flag = IPC_CREAT|IPC_EXCL;
int sem_id;
int status;
mode_t mode = 0666;
struct semid_ds sembuf;
union semun un;

sem_id = semget(mykey, nsems, flag|mode);
if (sem_id == -1) {
    printf(&quot;Error creating set of semaphores: %s\n&quot;,strerror(errno));
    exit(1);
} else {
    printf(&quot;Created set of semaphores with ID: %d\n&quot;, sem_id);
}
status = semctl(sem_id,0,IPC_STAT,un);
if (status == -1) {
    printf(&quot;Error getting semaphore information: %s\n&quot;, strerror(errno));
    exit(1);
}
printf(
    &quot;      uid  = %d\n&quot;
    &quot;      gid  = %d\n&quot;
    &quot;      mode = 0%03o\n&quot;
    &quot;      key  = 0x%08lX\n&quot;,
    (uid_t)sembuf.sem_perm.uid,
    (gid_t)sembuf.sem_perm.gid,
    (unsigned short)sembuf.sem_perm.mode,
    (unsigned long)sembuf.sem_perm._key);
status = semctl(sem_id, 0, IPC_RMID);
if ( status == -1 ) {
    printf(&quot;Error deleting semaphore: %s\n&quot;, strerror(errno));
     exit(1);
} else {
    printf(&quot;Deleted set of semaphores with ID: %d\n&quot;, sem_id);
}

3) Compile with -D__POSIX_C_SOURCE (to use the right version of the  
ipc_perm struct) and run the program with your user ID and with longuid.

With my user ID everything worked fine: a semaphore was created, some  
(correct) info was shown and then it was deleted.
With longuid the semaphore was created, the uid/gid information was  
truncated at the 16-bit boundary and it the semaphore couldn't be  
deleted.



On 5 Apr 2007, at 16:33, Daniel Abrams wrote:

&gt;<i> I appreciate this, it is at least some workaround, unfortunately in
</I>&gt;<i> most cases these settings seem to be only available to a user with
</I>&gt;<i> administrative rights, and having to manage each of these settings
</I>&gt;<i> individually for each user on each machine would be a non-starter for
</I>&gt;<i> most institutions, as they use LDAP and active directory to avoid this
</I>&gt;<i> sort of management.
</I>&gt;<i>
</I>&gt;<i> But, its at least useful for getting started on a developer machine,
</I>&gt;<i> so much appreciated, thanks!
</I>&gt;<i>
</I>&gt;<i> In general, I remain of the opinion that this needs to be fixed before
</I>&gt;<i> Mono is useful as a general deployment environment on OS X, but I
</I>&gt;<i> understand those who don't have users with active directory accounts,
</I>&gt;<i> don't have an issue.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 4/5/07, Jaume Llard&#233;n Prieto &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">jllarden at aim.com</A>&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There's a workaround: define the UID and GID in Directory Access.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The whole process is:
</I>&gt;&gt;<i> Open Directory Access in Applications/Utilities, select Active
</I>&gt;&gt;<i> Directory in panel Services and press Configure. In the Advanced
</I>&gt;&gt;<i> Options, choose tab Mappings and choose a mapping. For my test I
</I>&gt;&gt;<i> chose UID to map to postalCode, UGID to primaryGroupID and GGID again
</I>&gt;&gt;<i> to postalCode (I needed a numeric attribute to play with and
</I>&gt;&gt;<i> postalCode was good enough). Then bind and you're done.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I chose low values: uid=4055, ugid=513 and ggid=4055. And my
</I>&gt;&gt;<i> 'test.exe' worked. Without this workaround I suffered the described
</I>&gt;&gt;<i> problems.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The catch is that you have to change the uid/gid of the home
</I>&gt;&gt;<i> directories of the affected users locally on every Mac.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Kind regards
</I>&gt;&gt;<i> jaume
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 4 Apr 2007, at 17:11, Daniel Abrams wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; uid=435092441
</I>&gt;&gt;<i> &gt; gid=1309106314
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On 4/4/07, Eoin Norris &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">e.norris at mac.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; If you are running on an active directory account what is your gid
</I>&gt;&gt;<i> &gt; and uid - the result of ( as you prob. know) typing id in the
</I>&gt;&gt;<i> &gt; terminal?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; -- Eoin
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; On 4 Apr 2007, at 15:57, Daniel Abrams wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On 4/4/07, Eoin Norris &lt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">e.norris at mac.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Well, my application is generally home-based but I would kinda  
</I>&gt;&gt;<i> think
</I>&gt;&gt;<i> &gt;&gt; 15% of all users high, though it may be 15% of all macs deployed
</I>&gt;&gt;<i> &gt;&gt; across  &quot;schools, colleges, companies, government&quot; but whatever  
</I>&gt;&gt;<i> about
</I>&gt;&gt;<i> &gt;&gt; schools macs in the enterprise are extremely rare. So the total of
</I>&gt;&gt;<i> &gt;&gt; all macs is lower.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; Perhaps.  I worked for Apple in what was the Enterprise and
</I>&gt;&gt;<i> &gt;&gt; Education divisions, and I think my numbers are pretty
</I>&gt;&gt;<i> &gt;&gt; conservative, but maybe the ratio has shrunk.  I can tell you that
</I>&gt;&gt;<i> &gt;&gt; one of my current clients is a large government agency, and macs
</I>&gt;&gt;<i> &gt;&gt; are not as rare as you might think, and they all use active
</I>&gt;&gt;<i> &gt;&gt; directory authentication.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; It is an issue for deployment as well. I am getting reports in the
</I>&gt;&gt;<i> &gt;&gt; field. I dont know specifically where to look in the Mono code
</I>&gt;&gt;<i> &gt;&gt; ( where it is happening) but the thread below ( taken from this  
</I>&gt;&gt;<i> list)
</I>&gt;&gt;<i> &gt;&gt; gives some examples. The original poster does not seem to be on  
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> &gt;&gt; list anymore, or not contributing to this new thread on the same
</I>&gt;&gt;<i> &gt;&gt; issue, but might be available on that email address.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/pipermail/mono-osx/2006-January/">http://lists.ximian.com/pipermail/mono-osx/2006-January/</A> 
</I>&gt;&gt;<i> 000444.html
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; He clearly did some research and ascertained that it was an Apple
</I>&gt;&gt;<i> &gt;&gt; bug.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; I can't say if its an Apple bug or not.  I could certainly believe
</I>&gt;&gt;<i> &gt;&gt; that POSIX threads are done differently in Mac OS X than in Linux,
</I>&gt;&gt;<i> &gt;&gt; and that the Apple implementation is incomplete or buggy, I don't
</I>&gt;&gt;<i> &gt;&gt; have much experience in that area.  But I do know that in higher
</I>&gt;&gt;<i> &gt;&gt; level environments, Java, ObjC, etc, thread and process management
</I>&gt;&gt;<i> &gt;&gt; work fine on OS X and that many other development and deployment
</I>&gt;&gt;<i> &gt;&gt; environments have managed to solve threading issues without dying
</I>&gt;&gt;<i> &gt;&gt; early on Mac OS X.  Unless it's solved, it effectively rules out
</I>&gt;&gt;<i> &gt;&gt; Mono development for us, but I understand that your mileage may  
</I>&gt;&gt;<i> vary.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; _______________________________________________
</I>&gt;&gt;<i> &gt; Mono-osx mailing list
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">Mono-osx at lists.ximian.com</A>
</I>&gt;&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">http://lists.ximian.com/mailman/listinfo/mono-osx</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000935.html">[Mono-osx] installing mod_mono on mac OS x
</A></li>
	<LI>Next message: <A HREF="000937.html">[Mono-osx] Active Directory Infinite Loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#936">[ date ]</a>
              <a href="thread.html#936">[ thread ]</a>
              <a href="subject.html#936">[ subject ]</a>
              <a href="author.html#936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
