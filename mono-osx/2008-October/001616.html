<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] Not require Mono install for a DLL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Not%20require%20Mono%20install%20for%20a%20DLL&In-Reply-To=115252559628305817844074055198366030761-Webmail2%40me.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001614.html">
   <LINK REL="Next"  HREF="001615.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] Not require Mono install for a DLL</H1>
    <B>Duane Wandless</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=%5BMono-osx%5D%20Not%20require%20Mono%20install%20for%20a%20DLL&In-Reply-To=115252559628305817844074055198366030761-Webmail2%40me.com"
       TITLE="[Mono-osx] Not require Mono install for a DLL">duane at wandless.net
       </A><BR>
    <I>Wed Oct  1 17:19:07 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001614.html">[Mono-osx] Not require Mono install for a DLL
</A></li>
        <LI>Next message: <A HREF="001615.html">[Mono-osx] Not require Mono install for a DLL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1616">[ date ]</a>
              <a href="thread.html#1616">[ thread ]</a>
              <a href="subject.html#1616">[ subject ]</a>
              <a href="author.html#1616">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I was able to find a solution.  What is different with my setup is I do not
have a mono executable, just a mono DLL.  This
link&lt;<A HREF="http://www.codeshorts.ca/2007/nov/01/leopard-linking-making-relocatable-libraries-movin">http://www.codeshorts.ca/2007/nov/01/leopard-linking-making-relocatable-libraries-movin</A>&gt;was
very useful.  Be sure to check out this link!

Just some background.. my application is a real Cocoa/Xcode app with ObjC
running the GUI.  The mono code, utilizing monobjc, is hooked up to the NIB
controllers.  So the business logic is run by mono and the UI is run by
ObjC.  I can send NSNotifications back and forth between the mono code and
the ObjC code.  Mono loads data into the controllers, the UI then displays
the data.  Another note, I use Dumbarton to load the DLL and init mono.
There probably is a way to init the DLL without Dumbarton but it works.  Yes
yes I know monobjc can do all the UI work as well... but we already had UI
code on mac and windows.  Now we truly have a common business layer!!!!!

To embed a DLL without mono being installed I am currently performing these
steps:
mkbundle -o xx.c -oo libxx.a --nomain -c  --machine-config ... -L &lt;mono lib
paths&gt; all of the referenced libraries including mscorlib.dll

The xx.c is compiled into the Xcode app.  And libxx.a is linked, with -lxx
as a linker flag.  Add a library search path to where libxx.a is.

I then run these libraries (below) through install_name_tool.  You only have
to do these next 2 steps once.
libglib-2.0.0.1400.1.dylib    libgthread-2.0.0.1400.1.dylib
libmono.0.0.0.dylib
libgmodule-2.0.0.1400.1.dylib    libintl.8.0.1.dylib

Two things have to be performed on these libraries.  First the id of the
file has to be changed from the /Library/Frameworks/Mono.framework reference
to @loader_path/../Libraries/&lt;name&gt;.  Run otool -L &lt;the dylib file&gt;.
install_name_tool -id @loader_path/../Libraries/libintl.8.0.1.dylib
libintl.8.0.1.dylib

The second operation is to change the references to other dynamic libraries
you are embedding.
install_name_tool -change
/Library/Frameworks/Mono.framework/Versions/1.9.1/lib/libintl.8.0.1.dylib
@loader_path/../Libraries/libintl.8.0.1.dylib libglib-2.0.0.1400.1.dylib

Basically what you are doing is telling the runtime app where to find these
dynmaic libraries.  Rather than in the Frameworks directory look relative to
the application.  Place these modified libraires in
&lt;yourapp&gt;.app/Contents/Libraries.

Compile the xcode application normally.  Then run install_name_tool on it as
well, &lt;yourapp&gt;.app/Contents/MacOS/&lt;yourapp&gt;
install_name_tool -change
/Library/Frameworks/Mono.framework/Versions/1.9.1/lib/libgthread-2.0.0.1400.1.dylib
@loader_path/../Libraries/libgthread-2.0.0.1400.1.dylib &lt;yourapp&gt;

Now remember you have to run this install_name_tool many times.  Once for
each library referenced by your application.  And once for each reference in
the dynamic libraries to another dynamic library that you are trying to
embed.  Use otool -L &lt;file&gt; to find the references you need to modify.

I naturally wanted to avoid the static option since that requires special
licensing.  So far this appears to work.  These steps are what mkbundle is
trying to do... but it appears it only really works on executables.... or
I'm missing something.

Hopefully this will prove useful to someone down the road.

Duane


On Wed, Oct 1, 2008 at 4:45 PM, David Rivera &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">mithril at me.com</A>&gt; wrote:

&gt;<i>  Monobjc provides the ability to compile a Cocoa app with the required mono
</I>&gt;<i> frameworks embedded within it so that it does not require mono to be
</I>&gt;<i> installed on the system to run it. It is implemented as a couple Nant tasks.
</I>&gt;<i> I'm not sure if it will work for you or not, but you might look into it, its
</I>&gt;<i> what I use.
</I>&gt;<i>
</I>&gt;<i> www.monobjc.net
</I>&gt;<i>
</I>&gt;<i> -David Rivera
</I>&gt;<i>
</I>&gt;<i> On Wednesday, October 01, 2008, at 08:14AM, &quot;Duane Wandless&quot; &lt;
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">duane at wandless.net</A>&gt; wrote:
</I>&gt;<i> &gt;I am trying to create a DLL that does not require mono to be installed.  I
</I>&gt;<i> &gt;have used mkbundle with this command line:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;mkbundle -o host.c --nomain -c -oo libhost.a -L &lt;path to mono libraries&gt;
</I>&gt;<i> &gt;MacMonoClient.dll System.dll System.Core.dll etc.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I can successfully compile and link the host.c file and the libhost.a
</I>&gt;<i> object
</I>&gt;<i> &gt;file into a Cocoa Objc application.  At runtime I can use
</I>&gt;<i> &gt;mono_domain_assembly_open() to load the 'bundled' library.  And it works.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;However, if I move the Mono.framework out of the way and run the
</I>&gt;<i> application
</I>&gt;<i> &gt;I get this error:
</I>&gt;<i> &gt;dyld: Library not loaded: /Library/Frameworks/Mono.
</I>&gt;<i> &gt;framework/Versions/1.9.1/lib/libintl.8.0.1.dylib
</I>&gt;<i> &gt;  Referenced from: /Users/username/MySrc/mycode/sandbox/My
</I>&gt;<i> &gt;Desktop/build/Debug/My Desktop.app/Contents/MacOS/My Desktop
</I>&gt;<i> &gt;  Reason: image not found
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Now of course I'd like to do all of the relocation magic on the dylib's
</I>&gt;<i> etc
</I>&gt;<i> &gt;so that I do not need Mono installed.  I have had no success in this
</I>&gt;<i> &gt;effort.  The result of mkbundle is not a file that otool can find symbols.
</I>&gt;<i> &gt;install_name_tool appears to do nothing.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;So the basic question is: can I fully embed a mono library so that it is
</I>&gt;<i> not
</I>&gt;<i> &gt;required to have mono installed?  And if yes... then what am I doing
</I>&gt;<i> wrong?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Thanks for any help!
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Mono-osx mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">Mono-osx at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/mono-osx">http://lists.ximian.com/mailman/listinfo/mono-osx</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/mono-osx/attachments/20081001/b03ffeb2/attachment.html">http://lists.ximian.com/pipermail/mono-osx/attachments/20081001/b03ffeb2/attachment.html</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001614.html">[Mono-osx] Not require Mono install for a DLL
</A></li>
	<LI>Next message: <A HREF="001615.html">[Mono-osx] Not require Mono install for a DLL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1616">[ date ]</a>
              <a href="thread.html#1616">[ thread ]</a>
              <a href="subject.html#1616">[ subject ]</a>
              <a href="author.html#1616">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
