<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-osx] HELP! Trouble managing lifetime of NSPanel and other	windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-osx%40lists.ximian.com?Subject=Re%3A%20%5BMono-osx%5D%20HELP%21%20Trouble%20managing%20lifetime%20of%20NSPanel%20and%20other%0A%09windows&In-Reply-To=%3COF4F3F2C2D.D6976A02-ON862579CD.005880A8-862579CD.005A100D%40ni.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004851.html">
   <LINK REL="Next"  HREF="004853.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-osx] HELP! Trouble managing lifetime of NSPanel and other	windows</H1>
    <B>Steve Orth</B> 
    <A HREF="mailto:mono-osx%40lists.ximian.com?Subject=Re%3A%20%5BMono-osx%5D%20HELP%21%20Trouble%20managing%20lifetime%20of%20NSPanel%20and%20other%0A%09windows&In-Reply-To=%3COF4F3F2C2D.D6976A02-ON862579CD.005880A8-862579CD.005A100D%40ni.com%3E"
       TITLE="[Mono-osx] HELP! Trouble managing lifetime of NSPanel and other	windows">steven.orth at ni.com
       </A><BR>
    <I>Mon Mar 26 16:23:50 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="004851.html">[Mono-osx] Linker: SDK Assembly only on debug
</A></li>
        <LI>Next message: <A HREF="004853.html">[Mono-osx] Summer of Code: Student Proposals Now Being Accepted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4852">[ date ]</a>
              <a href="thread.html#4852">[ thread ]</a>
              <a href="subject.html#4852">[ subject ]</a>
              <a href="author.html#4852">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First, a confession: I'm new to the OS X development world's modern APIs 
-- my experience lies mainly in the ancient era (pre OS X/Carbon). I'm now 
working on a UI implementation that's NSWindow / NSView based for a large 
application and have jumped into this in MonoMac / MonoDevelop. So I'm not 
well-versed on the Objective-C layer either - really just walked the plank 
and trying to tread water as I learn this. :-)

My situation is this:

In a simple test application, I am trying to get a feel for managing 
window lifetimes by simply having File&gt;&gt;New create a new NSPanel. I've got 
a couple options to dump the app's window list and also a &quot;debug list&quot; of 
weak references to the NSPanels to see what happens w.r.t. the C# wrapper 
object lifetimes. I've tried w/ and w/o creating a NSWindowController, but 
that seems to have no effect w.r.t. crashing.

I've set the NSPanel's ReleasedWhenClosed to true. I also maintain a 
dictionary of NSPanel, NSWindowController pairs so the C# GC doesn't start 
tossing things out on me. In a nutshell, here's the &quot;important&quot; code:

        public static void NewPanel()
        {
            NSPanel p = new NSPanel();
            _panels[p] = new NSWindowController(p); // stash a reference 
(or two) so GC won't toss the NSPanel out
            p.StyleMask |= NSWindowStyle.Resizable | (NSWindowStyle)16 /* 
NSUtilityWindowMask */;
            p.FloatingPanel = true;
            p.Title = &quot;Panel &quot; + (++_panelNumber);
            p.ReleasedWhenClosed = true;
            p.WillClose += HandlePanelWillClose;

            _panelTracker[p.Title] = new WeakReference(p);

            p.IsVisible = true;
            System.Console.WriteLine(p.Title + &quot; [&quot; + 
p.Handle.ToString(&quot;X&quot;) + &quot;]&quot;);
        }

        private static void HandlePanelWillClose (object sender, EventArgs 
e)
        {
            NSPanel p = (NSPanel)((NSNotification)sender).Object;
            bool removed = _panels.Remove(p);
            System.Console.WriteLine(&quot;Closing &quot; + p.Title + &quot;[&quot; + 
p.Handle.ToString(&quot;X&quot;) + &quot;]; removed: &quot; + removed + &quot;, num in list: &quot; + 
_panels.Count);
            DumpWeakReferenceList();
        }

        public static void DumpWeakReferenceList()
        {
            System.GC.Collect();
            System.Console.WriteLine(&quot;|---- Weak References List ----|&quot;);
            foreach (KeyValuePair&lt;string, WeakReference&gt; pair in 
_panelTracker)
            {
                System.Console.WriteLine(pair.Key + &quot; -&gt; &quot; + 
pair.Value.IsAlive);
            }
            System.Console.WriteLine(&quot;&quot;);
        }

        public static void DumpAppWindowList()
        {
            System.GC.Collect();
            System.Console.WriteLine(&quot;|---- Window List ----|&quot;);
            foreach (NSWindow w in 
NSApplication.SharedApplication.Windows)
            {
                System.Console.WriteLine(&quot; &gt; &quot; + w.Title + &quot; [&quot; + 
w.Handle.ToString(&quot;X&quot;) + &quot;]&quot;);
            }
            System.Console.WriteLine(&quot;&quot;);
        }

At some point, inevitably, the app crashes like this:

  at (wrapper managed-to-native) 
MonoMac.ObjCRuntime.Messaging.void_objc_msgSend (intptr,intptr) &lt;IL 
0x00024, 0xffffffff&gt;
  at MonoMac.Foundation.NSObject/MonoMac_Disposer.Drain 
(MonoMac.Foundation.NSObject) [0x0007b] in 
/cvs/monomac/src/Foundation/NSObject.cs:360
  at (wrapper dynamic-method) 
object.[MonoMac.Foundation.NSObject+MonoMac_Disposer.Void 
Drain(MonoMac.Foundation.NSObject)] 
(MonoMac.Foundation.NSObject,MonoMac.ObjCRuntime.Selector,MonoMac.Foundation.NSObject) 
&lt;IL 0x00011, 0x0004b&gt;
  at (wrapper native-to-managed) 
object.[MonoMac.Foundation.NSObject+MonoMac_Disposer.Void 
Drain(MonoMac.Foundation.NSObject)] 
(MonoMac.Foundation.NSObject,MonoMac.ObjCRuntime.Selector,MonoMac.Foundation.NSObject) 
&lt;IL 0x000b6, 0xffffffff&gt;
  at (wrapper managed-to-native) 
MonoMac.AppKit.NSApplication.NSApplicationMain (int,string[]) &lt;IL 0x0009d, 
0xffffffff&gt;
  at MonoMac.AppKit.NSApplication.Main (string[]) [0x00000] in 
/cvs/monomac/src/AppKit/NSApplication.cs:74
  at SimpleMonoApp.MainClass.Main (string[]) [0x00005] in 
/Users/steveno/projects/NextGen/R2/PlatformFramework/Dev/SimpleMonoApp/Main.cs:14
  at (wrapper runtime-invoke) &lt;Module&gt;.runtime_invoke_void_object 
(object,intptr,intptr,intptr) &lt;IL 0x00050, 0xffffffff&gt;

Native stacktrace:

        0   SimpleMonoApp                       0x00094efc 
mono_handle_native_sigsegv + 284
        1   SimpleMonoApp                       0x00004fe8 
mono_sigsegv_signal_handler + 248
        2   libsystem_c.dylib                   0x944bc59b _sigtramp + 43
        3   ???                                 0xffffffff 0x0 + 
4294967295
        4   ???                                 0x05af3024 0x0 + 95367204
        5   ???                                 0x01f59144 0x0 + 32870724
        6   ???                                 0x01f4c43c 0x0 + 32818236
        7   CoreFoundation                      0x946a6de1 -[NSObject 
performSelector:withObject:] + 65
        8   Foundation                          0x9c4bde40 
__NSThreadPerformPerform + 503
        9   CoreFoundation                      0x9461e3df 
__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 15
        10  CoreFoundation                      0x9461dd96 
__CFRunLoopDoSources0 + 246
        11  CoreFoundation                      0x94647c68 __CFRunLoopRun 
+ 1112
        12  CoreFoundation                      0x9464747c 
CFRunLoopRunSpecific + 332
        13  CoreFoundation                      0x94647328 
CFRunLoopRunInMode + 120
        14  AppKit                              0x918f720e 
_NSUnhighlightCarbonMenu + 199
        15  AppKit                              0x91900ae5 
-[NSCarbonMenuImpl performActionWithHighlightingForItemAtIndex:] + 204
        16  AppKit                              0x9190014d -[NSMenu 
_performActionWithHighlightingForItemAtIndex:sendAccessibilityNotification:] 
+ 79
        17  AppKit                              0x919000f9 -[NSMenu 
_performActionWithHighlightingForItemAtIndex:] + 48
        18  AppKit                              0x91879933 -[NSMenu 
performKeyEquivalent:] + 306
        19  AppKit                              0x918783a2 -[NSApplication 
_handleKeyEquivalent:] + 594
        20  AppKit                              0x9176c4bf -[NSApplication 
sendEvent:] + 5772
        21  AppKit                              0x916fd6d5 -[NSApplication 
run] + 1007
        22  AppKit                              0x91991261 
NSApplicationMain + 1054
        23  ???                                 0x04103e6e 0x0 + 68173422
        24  ???                                 0x04103c6c 0x0 + 68172908
        25  ???                                 0x004a7ff8 0x0 + 4882424
        26  ???                                 0x004a8156 0x0 + 4882774
        27  SimpleMonoApp                       0x0000d282 
mono_jit_runtime_invoke + 722
        28  SimpleMonoApp                       0x001a436a 
mono_runtime_invoke + 170
        29  SimpleMonoApp                       0x001a6f01 
mono_runtime_exec_main + 705
        30  SimpleMonoApp                       0x001a6111 
mono_runtime_run_main + 929
        31  SimpleMonoApp                       0x00069995 mono_jit_exec + 
149
        32  SimpleMonoApp                       0x0006bf13 mono_main + 
9587
        33  SimpleMonoApp                       0x00002299 main + 441
        34  SimpleMonoApp                       0x000020a6 start + 54

Debug info from gdb:


=================================================================
Got a SIGSEGV while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries 
used by your application.
=================================================================

In the larger scope of things, those &quot;NSPanels&quot; aren't going to just be a 
finite set of utility windows, so keeping them around &quot;forever&quot; isn't an 
option. It may well be that I'm doing something grossly incorrect, but in 
this simple app, it should be easier to spot.

Thanks for any insights / advice!

-steve
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/mono-osx/attachments/20120326/c834e19c/attachment.html">http://lists.ximian.com/pipermail/mono-osx/attachments/20120326/c834e19c/attachment.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004851.html">[Mono-osx] Linker: SDK Assembly only on debug
</A></li>
	<LI>Next message: <A HREF="004853.html">[Mono-osx] Summer of Code: Student Proposals Now Being Accepted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4852">[ date ]</a>
              <a href="thread.html#4852">[ thread ]</a>
              <a href="subject.html#4852">[ subject ]</a>
              <a href="author.html#4852">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-osx">More information about the Mono-osx
mailing list</a><br>
</body></html>
