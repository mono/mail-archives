<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-bugs] [Bug 667109] New: Combobox.SelectedItem and Equals override not playing together
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-bugs%40lists.ximian.com?Subject=%5BMoonlight-bugs%5D%20%5BBug%20667109%5D%20New%3A%20Combobox.SelectedItem%20and%20Equals%0A%20override%20not%20playing%20together&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002795.html">
   <LINK REL="Next"  HREF="002801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-bugs] [Bug 667109] New: Combobox.SelectedItem and Equals override not playing together</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:moonlight-bugs%40lists.ximian.com?Subject=%5BMoonlight-bugs%5D%20%5BBug%20667109%5D%20New%3A%20Combobox.SelectedItem%20and%20Equals%0A%20override%20not%20playing%20together&In-Reply-To="
       TITLE="[Moonlight-bugs] [Bug 667109] New: Combobox.SelectedItem and Equals override not playing together">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Jan 25 15:01:17 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002795.html">[Moonlight-bugs] [Bug 666651] Managed parser doesn't tolerate	invalid converters
</A></li>
        <LI>Next message: <A HREF="002801.html">[Moonlight-bugs] [Bug 667109] Combobox.SelectedItem and Equals override not playing together
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2794">[ date ]</a>
              <a href="thread.html#2794">[ thread ]</a>
              <a href="subject.html#2794">[ subject ]</a>
              <a href="author.html#2794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=667109">https://bugzilla.novell.com/show_bug.cgi?id=667109</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=667109#c0">https://bugzilla.novell.com/show_bug.cgi?id=667109#c0</A>


           Summary: Combobox.SelectedItem and Equals override not playing
                    together
    Classification: Mono
           Product: Moonlight
           Version: SVN
          Platform: x86-64
        OS/Version: openSUSE 11.3
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: engine
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-bugs">moonlight-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-bugs">rui at ruicraveiro.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-bugs">moonlight-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=410298)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=410298">http://bugzilla.novell.com/attachment.cgi?id=410298</A>)
Test Case

User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-US) AppleWebKit/534.10
(KHTML, like Gecko) Chrome/8.0.552.224 Safari/534.10

Hi, this is one of those easier demonstrated than explained bugs, so if my
explanation is too confusing, please just jump to the test case I am attaching.
You could come back to the explanation afterwards, however, to pick some
details you might miss just by looking at the demo.

The app I am debugging has the a combobox with the following Xaml:

&lt;ComboBox
  ItemsSource=&quot;{Binding Path=ItemList}&quot; 
  SelectedItem=&quot;{Binding Mode=TwoWay, Path=Item}&quot;
  DisplayMemberPath=&quot;Description&quot; /&gt;

The datacontext will be an instance of a class that has the following
constructor:
class Model
{
        public Model()
        {
            this.ItemList = new List&lt;Item&gt; {
                new Item { Id=1, Description = &quot;First Item - List Item&quot;},
                new Item { Id=2, Description = &quot;Second Item - List Item&quot;},
                new Item { Id=3, Description = &quot;Third Item - List Item&quot; }
            };

            this.Item = new Item { Id=2, Description=&quot;Second Item - Default
Item&quot; };
        }
    // ... rest of the class goes here
}
Now, notice that we are setting two properties to which the combo binds:
ItemsSource and SelectedItem to the model's ItemList and Item properties
respectively. It happens that in the model, the Item property is not referring
to an instance of an item that exists in the ItemList, but to a new instance
created Adhoc. If this were the end of the story, when running the application,
naturally the combo would have nothing selected because the selected item is
none of the instances of the list.

It happens that both the ItemList and the SelectedItem are properties of type
Item and that class goes something along these lines:

    public class Item
    {
        // ... nevermind what's here as it is obvious

        public override bool Equals(object obj)
        {
            Item item = obj as Item;
            if (item == null)
                return false;
            return item.Id == this.Id;
        } 
  // we also override GetHashCode, but that should be irrelevant to the case
    }

Because Item is overriding Equals making instances of this class equivalent as
long as their Ids are the same, when running the App, even though the
SelectedItem is an instance that does not exist in the Items property, the
combo should have selected an item from that list that has the same Id.

This is the behaviour in Silverlight. In Moonlight, not only the combobox
doesn't show the correct selection, as it overrides the Item property of the
model to null.

Reproducible: Always

Steps to Reproduce:
1. Run the TestPage.html in Silverlight.
2. Notice that the combobox has an item selected (the second item).
3. Notice also there is a textblock saying &quot;Second Item - Default Item&quot;. Even
though the description is different of the item in the combo, both items have
the same ID, so the combobox doesn't override the item that shows in the
textblock.
4. Pick a different item and then select again the original item (the second
one) and see that the textblock has been updated with the same description as
the one in the combo. This means that now, the combo and the textblock are
referring to the same instance.
5. Now, try it in Moonlight. You will notice that the textblock says &quot;[it is
null]. This means that because the instance of the Item property in the model
does not exist in the list of instances bound to the combobox, moonlight
decided that the comboboxes selection should be none of them. To make things
worse, since it is selecting no item in the combobox, and because the combobox
is also bound to the Item property in TwoWay mode, then it changes the Item
property to null.
6. Pick any item in the combo and things begin to work correctly.
Actual Results:  
Combobox (or whatever underlying binding logic) is ignoring the Equals method.

Expected Results:  
The Equals method should not be ignored.

ok, maybe even my steps to reproduce the bug might be too complex. If you feel
lost, just run the test case in Silverlight and Moonlight and compare the
differences in behaviour... everything else should become obvious.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002795.html">[Moonlight-bugs] [Bug 666651] Managed parser doesn't tolerate	invalid converters
</A></li>
	<LI>Next message: <A HREF="002801.html">[Moonlight-bugs] [Bug 667109] Combobox.SelectedItem and Equals override not playing together
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2794">[ date ]</a>
              <a href="thread.html#2794">[ thread ]</a>
              <a href="subject.html#2794">[ subject ]</a>
              <a href="author.html#2794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-bugs">More information about the Moonlight-bugs
mailing list</a><br>
</body></html>
