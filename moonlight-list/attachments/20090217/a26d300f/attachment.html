<tt>
Dispose&nbsp;isn&amp;#39;t&nbsp;the&nbsp;answer&nbsp;unless&nbsp;we&nbsp;have&nbsp;a&nbsp;&amp;quot;there&nbsp;is&nbsp;only&nbsp;1&nbsp;ref&nbsp;left&nbsp;and&nbsp;it&nbsp;comes&nbsp;from&nbsp;managed&nbsp;code&amp;quot;,&nbsp;but&nbsp;even&nbsp;then&nbsp;there&nbsp;are&nbsp;problems&nbsp;and&nbsp;holes&nbsp;we&nbsp;can&nbsp;fall&nbsp;into&nbsp;where&nbsp;an&nbsp;unmanaged&nbsp;object&nbsp;lives&nbsp;forever.&amp;nbsp;&nbsp;The&nbsp;bug&nbsp;basically&nbsp;shifts&nbsp;from&nbsp;&amp;quot;we&nbsp;don&amp;#39;t&nbsp;know&nbsp;when&nbsp;we&nbsp;can&nbsp;delete&amp;quot;&nbsp;to&nbsp;&amp;quot;we&nbsp;don&amp;#39;t&nbsp;know&nbsp;when&nbsp;we&nbsp;can&nbsp;Dispose&amp;quot;.&amp;nbsp;&nbsp;Delegates&nbsp;complicate&nbsp;things&nbsp;substantially.&lt;br&gt;<br>
&lt;br&gt;An&nbsp;alternative&nbsp;of&nbsp;course&nbsp;is&nbsp;to&nbsp;remove&nbsp;the&nbsp;addrefs&nbsp;in&nbsp;managed&nbsp;land&nbsp;altogether.&amp;nbsp;&nbsp;But&nbsp;that&nbsp;seems&nbsp;pretty&nbsp;dangerous,&nbsp;considering&nbsp;sometimes&nbsp;a&nbsp;managed&nbsp;object&nbsp;is&nbsp;the&nbsp;only&nbsp;thing&nbsp;keeping&nbsp;an&nbsp;unmanaged&nbsp;object&nbsp;alive.&lt;br&gt;&lt;br&gt;In&nbsp;many&nbsp;cases&nbsp;we&nbsp;can&nbsp;manage&nbsp;lifetime&nbsp;with&nbsp;weakrefs&nbsp;in&nbsp;managed&nbsp;code,&nbsp;there&nbsp;are&nbsp;just&nbsp;specific&nbsp;instances&nbsp;where&nbsp;we&nbsp;can&amp;#39;t&nbsp;(where&nbsp;the&nbsp;managed&nbsp;wrapper&nbsp;maintains&nbsp;state,&nbsp;or&nbsp;is&nbsp;the&nbsp;sole&nbsp;place&nbsp;where&nbsp;functionality&nbsp;lives,&nbsp;as&nbsp;in&nbsp;StackPanel.)&lt;br&gt;<br>
&lt;br&gt;Chris&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Feb&nbsp;17,&nbsp;2009&nbsp;at&nbsp;12:35&nbsp;AM,&nbsp;Rolf&nbsp;Bjarne&nbsp;Kvinge&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:rolflists@ya.com&quot;&gt;rolflists@ya.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;border-left:&nbsp;1px&nbsp;solid&nbsp;rgb(204,&nbsp;204,&nbsp;204);&nbsp;margin:&nbsp;0pt&nbsp;0pt&nbsp;0pt&nbsp;0.8ex;&nbsp;padding-left:&nbsp;1ex;&quot;&gt;<br>
&lt;br&gt;<br>
Why&nbsp;can&amp;#39;t&nbsp;we&nbsp;get&nbsp;to&nbsp;a&nbsp;&amp;quot;Dispose&amp;quot;&nbsp;call&nbsp;to&nbsp;break&nbsp;the&nbsp;circle?&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;From&nbsp;what&nbsp;I&nbsp;gathered&nbsp;from&nbsp;irc&nbsp;you&nbsp;came&nbsp;to&nbsp;the&nbsp;conclusion&nbsp;that&nbsp;managed&nbsp;code&lt;br&gt;<br>
can&amp;#39;t&nbsp;manage&nbsp;lifetime&nbsp;(using&nbsp;weakrefs,&nbsp;etc),&nbsp;since&nbsp;objects&nbsp;would&nbsp;get&nbsp;freed&lt;br&gt;<br>
too&nbsp;early,&nbsp;which&nbsp;only&nbsp;leaves&nbsp;native&nbsp;code&nbsp;to&nbsp;manage&nbsp;lifetime,&nbsp;and&nbsp;then&lt;br&gt;<br>
&amp;quot;Dispose&amp;quot;&nbsp;is&nbsp;a&nbsp;way&nbsp;to&nbsp;break&nbsp;the&nbsp;circle&nbsp;(and&nbsp;I&nbsp;can&amp;#39;t&nbsp;think&nbsp;of&nbsp;any&nbsp;other&nbsp;way&lt;br&gt;<br>
which&nbsp;wouldn&amp;#39;t&nbsp;be&nbsp;the&nbsp;same&nbsp;thing).&lt;br&gt;<br>
&lt;br&gt;<br>
Rolf&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;that&nbsp;involves&nbsp;making&nbsp;unmanaged&nbsp;code&nbsp;additionally&nbsp;deal&nbsp;with&nbsp;GCHandles&nbsp;in&nbsp;all&lt;br&gt;<br>
cases&nbsp;where&nbsp;we&nbsp;accept&nbsp;function&nbsp;pointers&nbsp;now.&amp;nbsp;&nbsp;I&nbsp;agree&nbsp;we&nbsp;need&nbsp;some&nbsp;mechanism&lt;br&gt;<br>
for&nbsp;cleaning&nbsp;up&nbsp;delegates,&nbsp;but&nbsp;I&amp;#39;m&nbsp;not&nbsp;sure&nbsp;GCHandling&nbsp;everything&nbsp;is&nbsp;the&nbsp;way&lt;br&gt;<br>
to&nbsp;&amp;gt;go.&nbsp;The&nbsp;delegate&nbsp;will&nbsp;be&nbsp;alive&nbsp;as&nbsp;long&nbsp;as&nbsp;the&nbsp;managed&nbsp;object&nbsp;or&lt;br&gt;<br>
unmanaged&nbsp;peer&nbsp;is&nbsp;alive.&nbsp;When&nbsp;the&nbsp;unmanaged&nbsp;peer&nbsp;dies,&nbsp;the&nbsp;GCHandle&nbsp;will&nbsp;be&lt;br&gt;<br>
deallocated&nbsp;in&nbsp;unmanaged.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;But&nbsp;see,&nbsp;that&nbsp;doesn&amp;#39;t&nbsp;work.&amp;nbsp;&nbsp;The&nbsp;unmanaged&nbsp;peer&nbsp;will&nbsp;never&nbsp;die&nbsp;when&nbsp;it&amp;#39;s&lt;br&gt;<br>
holding&nbsp;a&nbsp;GCHandle&nbsp;to&nbsp;a&nbsp;delegate&nbsp;which&nbsp;is&nbsp;keeping&nbsp;the&nbsp;managed&nbsp;instance&lt;br&gt;<br>
alive,&nbsp;which&nbsp;holds&nbsp;a&nbsp;ref&nbsp;to&nbsp;the&nbsp;unmanaged&nbsp;peer.&nbsp;We&nbsp;can&amp;#39;t&nbsp;even&nbsp;get&nbsp;to&nbsp;a&lt;br&gt;<br>
&amp;quot;Dispose&amp;quot;&nbsp;call&nbsp;in&nbsp;order&nbsp;to&nbsp;clean&nbsp;up&nbsp;the&nbsp;delegates&nbsp;and&nbsp;break&nbsp;refs&nbsp;in&nbsp;this&lt;br&gt;<br>
scenario.&amp;nbsp;&nbsp;The&nbsp;instant&nbsp;we&nbsp;pass&nbsp;a&nbsp;delegate&nbsp;to&nbsp;unmanaged&nbsp;code&nbsp;(be&nbsp;it&nbsp;in&lt;br&gt;<br>
GCHandle&nbsp;form&nbsp;or&nbsp;after&nbsp;storing&nbsp;it&nbsp;in&nbsp;an&nbsp;instance&nbsp;field&nbsp;of&nbsp;the&nbsp;managed&lt;br&gt;<br>
object),&nbsp;we&amp;#39;re&nbsp;screwed&nbsp;at&nbsp;present.&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;Chris&lt;br&gt;<br>
&amp;gt;&amp;gt;On&nbsp;Mon,&nbsp;Feb&nbsp;16,&nbsp;2009&nbsp;at&nbsp;2:44&nbsp;AM,&nbsp;Alan&nbsp;McGovern&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:alan.mcgovern@gmail.com&quot;&gt;alan.mcgovern@gmail.com&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
wrote:&lt;br&gt;<br>
&amp;gt;&amp;gt;Hey,&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;So&nbsp;the&nbsp;next&nbsp;iteration&nbsp;of&nbsp;the&nbsp;idea&nbsp;would&nbsp;be&nbsp;to&nbsp;register&nbsp;a&nbsp;GCHandle&nbsp;which&lt;br&gt;<br>
holds&nbsp;the&nbsp;delegate&nbsp;instead&nbsp;of&nbsp;the&nbsp;delegate&nbsp;itself&nbsp;(or&nbsp;something&nbsp;similar).&lt;br&gt;<br>
Then&nbsp;the&nbsp;same&nbsp;principle&nbsp;holds&nbsp;true.&nbsp;The&nbsp;delegate&nbsp;will&nbsp;be&nbsp;alive&nbsp;as&nbsp;long&nbsp;as&lt;br&gt;<br>
the&nbsp;managed&nbsp;&amp;gt;&amp;gt;object&nbsp;or&nbsp;unmanaged&nbsp;peer&nbsp;is&nbsp;alive.&nbsp;When&nbsp;the&nbsp;unmanaged&nbsp;peer&lt;br&gt;<br>
dies,&nbsp;the&nbsp;GCHandle&nbsp;will&nbsp;be&nbsp;deallocated&nbsp;in&nbsp;unmanaged.&nbsp;Managed&nbsp;code&nbsp;won&amp;#39;t&nbsp;have&lt;br&gt;<br>
to&nbsp;care&nbsp;about&nbsp;the&nbsp;GCHandle&nbsp;as&nbsp;long&nbsp;as&nbsp;a&nbsp;unique&nbsp;GCHandle&nbsp;is&nbsp;passed&nbsp;to&nbsp;native&lt;br&gt;<br>
every&nbsp;time&nbsp;a&nbsp;&amp;gt;&amp;gt;&amp;gt;delegate&nbsp;is&nbsp;passed&nbsp;to&nbsp;native.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;Alan.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;On&nbsp;Mon,&nbsp;Feb&nbsp;16,&nbsp;2009&nbsp;at&nbsp;6:49&nbsp;AM,&nbsp;Chris&nbsp;Toshok&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:toshok@gmail.com&quot;&gt;toshok@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;It&nbsp;really&nbsp;isn&amp;#39;t&nbsp;that&nbsp;easy.&amp;nbsp;&nbsp;Just&nbsp;one&nbsp;of&nbsp;the&nbsp;interesting&nbsp;cases:&nbsp;we&nbsp;have&lt;br&gt;<br>
many&nbsp;places&nbsp;where&nbsp;unmanaged&nbsp;code&nbsp;is&nbsp;passed&nbsp;delegates&nbsp;which&nbsp;reference&nbsp;the&lt;br&gt;<br>
same&nbsp;object.&amp;nbsp;&nbsp;So&nbsp;we&nbsp;have&nbsp;circular&nbsp;refs&nbsp;between&nbsp;unmanaged&nbsp;and&nbsp;managed&nbsp;peers&lt;br&gt;<br>
which&nbsp;&amp;gt;aren&amp;#39;t&nbsp;&amp;gt;&amp;gt;direct.&amp;nbsp;&nbsp;We&nbsp;really&nbsp;need&nbsp;a&nbsp;system&nbsp;that&nbsp;can&nbsp;treat&nbsp;either&nbsp;as&lt;br&gt;<br>
the&nbsp;root.&amp;nbsp;&nbsp;Anything&nbsp;else&nbsp;is&nbsp;going&nbsp;to&nbsp;be&nbsp;unable&nbsp;to&nbsp;handle&nbsp;things&nbsp;properly.&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;chris&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;On&nbsp;Fri,&nbsp;Feb&nbsp;13,&nbsp;2009&nbsp;at&nbsp;3:14&nbsp;AM,&nbsp;Alan&nbsp;McGovern&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:alan.mcgovern@gmail.com&quot;&gt;alan.mcgovern@gmail.com&lt;/a&gt;&amp;gt;&lt;br&gt;<br>
wrote:&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;Hey&nbsp;guys,&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;I&amp;#39;ve&nbsp;been&nbsp;thinking&nbsp;about&nbsp;the&nbsp;issue&nbsp;and&nbsp;I&nbsp;think&nbsp;one&nbsp;way&nbsp;to&nbsp;solve&nbsp;it&nbsp;would&lt;br&gt;<br>
be&nbsp;to&nbsp;always&nbsp;have&nbsp;unmanaged&nbsp;own&nbsp;the&nbsp;handle.&nbsp;What&nbsp;I&amp;#39;m&nbsp;thinking&nbsp;is&nbsp;this:&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;1)&nbsp;If&nbsp;managed&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;object,&nbsp;then&nbsp;it&amp;#39;ll&nbsp;live&lt;br&gt;<br>
regardless&nbsp;of&nbsp;GCHandle&nbsp;status&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;2)&nbsp;If&nbsp;unmanaged&nbsp;holds&nbsp;a&nbsp;GCHandle,&nbsp;unmanaged&nbsp;will&nbsp;keep&nbsp;it&nbsp;alive&lt;br&gt;<br>
regardless&nbsp;of&nbsp;what&nbsp;managed&nbsp;does.&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;3)&nbsp;If&nbsp;managed&nbsp;has&nbsp;no&nbsp;reference&nbsp;to&nbsp;the&nbsp;object&nbsp;and&nbsp;unmanaged&nbsp;drops&nbsp;its&lt;br&gt;<br>
reference,&nbsp;then&nbsp;the&nbsp;object&nbsp;is&nbsp;safe&nbsp;to&nbsp;be&nbsp;GC&amp;#39;ed.&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;So&nbsp;to&nbsp;implement&nbsp;that&nbsp;logic&nbsp;all&nbsp;we&nbsp;really&nbsp;need&nbsp;to&nbsp;do&nbsp;is&nbsp;to&nbsp;allocate&nbsp;a&lt;br&gt;<br>
GCHandle&nbsp;every&nbsp;time&nbsp;we&nbsp;pass&nbsp;a&nbsp;managed&nbsp;object&nbsp;to&nbsp;native&nbsp;and&nbsp;always&nbsp;let&nbsp;native&lt;br&gt;<br>
clean&nbsp;up&nbsp;the&nbsp;handle.&nbsp;So&nbsp;whenever&nbsp;we&nbsp;destroy&nbsp;a&nbsp;Value&nbsp;*&nbsp;we&nbsp;should&nbsp;deallocate&lt;br&gt;<br>
the&nbsp;&amp;gt;&amp;gt;&amp;gt;&amp;gt;GCHandle&nbsp;if&nbsp;that&amp;#39;s&nbsp;the&nbsp;last&nbsp;reference&nbsp;to&nbsp;the&nbsp;GCHandle&nbsp;that&nbsp;unmanaged&lt;br&gt;<br>
has.&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;Does&nbsp;that&nbsp;make&nbsp;sense&nbsp;or&nbsp;have&nbsp;I&nbsp;missed&nbsp;some&nbsp;important&nbsp;case?&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&amp;gt;&amp;gt;Alan.&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Moonlight-list&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Moonlight-list@lists.ximian.com&quot;&gt;Moonlight-list@lists.ximian.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://lists.ximian.com/mailman/listinfo/moonlight-list&quot;&nbsp;target=&quot;_blank&quot;&gt;http://lists.ximian.com/mailman/listinfo/moonlight-list&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;No&nbsp;virus&nbsp;found&nbsp;in&nbsp;this&nbsp;incoming&nbsp;message.&lt;br&gt;<br>
Checked&nbsp;by&nbsp;AVG&nbsp;-&nbsp;&lt;a&nbsp;href=&quot;http://www.avg.com&quot;&nbsp;target=&quot;_blank&quot;&gt;www.avg.com&lt;/a&gt;&lt;br&gt;<br>
Version:&nbsp;8.0.234&nbsp;/&nbsp;Virus&nbsp;Database:&nbsp;270.10.23/1951&nbsp;-&nbsp;Release&nbsp;Date:&nbsp;02/13/09&lt;br&gt;<br>
06:51:00&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
