<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization	of	accessibility in Moonlight)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%0A%20InternalsVisibleTo%09of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%0A%20initialization%09of%09accessibility%20in%20Moonlight%29&In-Reply-To=gqdkio%247q5%241%40ger.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000350.html">
   <LINK REL="Next"  HREF="000354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization	of	accessibility in Moonlight)</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%0A%20InternalsVisibleTo%09of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%0A%20initialization%09of%09accessibility%20in%20Moonlight%29&In-Reply-To=gqdkio%247q5%241%40ger.gmane.org"
       TITLE="[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization	of	accessibility in Moonlight)">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Wed Mar 25 13:26:56 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000350.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
</A></li>
        <LI>Next message: <A HREF="000354.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#352">[ date ]</a>
              <a href="thread.html#352">[ thread ]</a>
              <a href="subject.html#352">[ subject ]</a>
              <a href="author.html#352">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello &#65279;Andr&#233;s,

On Wed, 2009-03-25 at 12:00 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Regardless of the method picked for distribution of the a11y support of
</I>&gt;<i> moonlight (discussed on previous thread about this), we need to use
</I>&gt;<i> atk-sharp for hooking our classes into the GObject framework that is
</I>&gt;<i> used by Atk, and thus this implies that glib-sharp (which is a
</I>&gt;<i> dependency of atk-sharp) needs to be built against the 2.1 profile.
</I>
Like I said on IRC &quot;there are tons of ways of doing this, some more
painful than others&quot;. With the few previous details above you may be
looking at quite a masochist way.

Seriously can you show us the pros and cons of each strategy you looked
at ? because I strongly feel you did not consider (everything) that
working with moonlight/coreclr requires.

&gt;<i> Since glib-sharp uses a lot of marshaling API (which is not present
</I>&gt;<i> anymore as public in Silverlight) we need to add it to the list of
</I>&gt;<i> InternalsVisibleTo assemblies, with the patch attached. 
</I>
You're making the (wrong) assumption that mscorlib.dll internals are
stable, while they are not.

I.e. the tuner analyze the assemblies from mcs[1] and internalize or
_remove_ stuff that is not needed (publicly or at all). This is done
each time the assemblies are rebuild, meaning that a change inside moon
(or even mcs[2]) could remove stuff you depend on. Since this is done
automatically you can never be sure if your own assemblies, using
InternalsVisibleTo or not, will have what it requires to execute.

[1] assemblies from moon are also processed but with fewer steps
(security attributes)

[2] we had one case earlier this week where the internals changed a lot
when SafeFileHandle was introduced (and later removed).

You're also assuming that the internals you need will have the &quot;right&quot;
security attributes to be used (from your caller), which may not be the
case (and, just like the visibility, may change anytime).

&gt;<i> This step of
</I>&gt;<i> course is under the assumption that our stuff will be loaded as platform
</I>&gt;<i> code, since it will be indeed part of moonlight infrastructure, and
</I>&gt;<i> because it wouldn't be possible otherwise (as glib-sharp needs to use
</I>&gt;<i> P/Invoke extensively).
</I>
Sorry but 1 + 1 == 2, not 3. Loading your code as &quot;platform code&quot; won't
make glib-sharp able to p/invoke. 

You may have read something like &quot;only platform code can p/invoke&quot; but
that's not the whole truth. The right explanations are that &quot;only
platform code can contain critical code&quot; and &quot;only critical code can
p/invoke&quot;.

Now mix this fact with &quot;all code, even platform code, is by default
transparent&quot; and you'll see that even if moonlight &quot;bless&quot; glib-sharp as
&quot;platform code&quot; it won't be able to p/invoke (without multiple changes).

&gt;<i> The patch for making our stuff be loaded as platform code is still in
</I>&gt;<i> the works. I've discussed briefly how to do this with Sebastien, as he's
</I>&gt;<i> working on some security-related patches that will affect this.
</I>
Like I said &quot;this (platform code) is not a big problem&quot;. However it's
_not_ the only problem you're facing. The stuff above does not even
touch the security problem you need to consider with this approach.

&gt;<i> 
</I>&gt;<i> So, can I commit the patch attached? 
</I>
No ;-)

&gt;<i> Any feedback welcome. Thanks!
</I>
Now I don't want to sound negative, nor do I want to comment every patch
with reasons why it won't work or be really painful (and believe me the
pain I see is _much_ more on your side than mine ;-). However I need
more information before I can provide any useful hints.

Sebastien

&gt;<i> 	Andr&#233;s
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Miguel de Icaza wrote:
</I>&gt;<i> &gt;&gt; &gt; Hello,
</I>&gt;<i> &gt;&gt; &gt; 
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; a) In the XPI of Moonlight itself (this seemed to be the preferred
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; election of some people in the IRC channel).
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; Disadvantage: it would pull some dependencies such as atk-sharp and
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; glib-sharp so the XPI size grows.
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; Advantage: everybody gets native accessibility support in Linux if they
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; have their corresponding A11Y client software installed (at-spi, screen
</I>&gt;<i> &gt;&gt;&gt; &gt;&gt; readers, etc.), without the need of packaging the bridge for every distro.
</I>&gt;<i> &gt;&gt; &gt; 
</I>&gt;<i> &gt;&gt; &gt; I would not want to ship glib-sharp, atk-sharp or anything like that.
</I>&gt;<i> &gt;&gt; &gt; 
</I>&gt;<i> &gt;&gt; &gt; The UIA code probably should not use those either, it likely can get
</I>&gt;<i> &gt;&gt; &gt; away by just P/Invoking the handful of calls that it needs.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; As Sandy has already pointed out, we use atk extensively and atk-sharp
</I>&gt;<i> &gt; is extremely useful for that (because we derive from Atk classes, use
</I>&gt;<i> &gt; GInterfaces, etc.). It's a usage very similar to what is done if you
</I>&gt;<i> &gt; want to create a Gtk+ widget with GtkSharp (but in our case it's not
</I>&gt;<i> &gt; just a class, but a lot of them).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Moonlight-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>
</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000350.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
</A></li>
	<LI>Next message: <A HREF="000354.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#352">[ date ]</a>
              <a href="thread.html#352">[ thread ]</a>
              <a href="subject.html#352">[ subject ]</a>
              <a href="author.html#352">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
