<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%20InternalsVisibleTo%0A%20of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%20initialization%20of%0A%20accessibility%20in%20Moonlight%29&In-Reply-To=1238002016.17500.52.camel%40mizar.home">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000352.html">
   <LINK REL="Next"  HREF="000356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)</H1>
    <B>&quot;Andr&#233;s G. Aragoneses&quot;</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%20InternalsVisibleTo%0A%20of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%20initialization%20of%0A%20accessibility%20in%20Moonlight%29&In-Reply-To=1238002016.17500.52.camel%40mizar.home"
       TITLE="[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)">knocte at gmail.com
       </A><BR>
    <I>Wed Mar 25 13:45:40 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000352.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization	of	accessibility in Moonlight)
</A></li>
        <LI>Next message: <A HREF="000356.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#354">[ date ]</a>
              <a href="thread.html#354">[ thread ]</a>
              <a href="subject.html#354">[ subject ]</a>
              <a href="author.html#354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hey, thanks for your answer Sebastien.

Sebastien Pouliot wrote:
&gt;<i> Hello &#65279;Andr&#233;s,
</I>&gt;<i> 
</I>&gt;<i> On Wed, 2009-03-25 at 12:00 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regardless of the method picked for distribution of the a11y support of
</I>&gt;&gt;<i> moonlight (discussed on previous thread about this), we need to use
</I>&gt;&gt;<i> atk-sharp for hooking our classes into the GObject framework that is
</I>&gt;&gt;<i> used by Atk, and thus this implies that glib-sharp (which is a
</I>&gt;&gt;<i> dependency of atk-sharp) needs to be built against the 2.1 profile.
</I>&gt;<i> 
</I>&gt;<i> Like I said on IRC &quot;there are tons of ways of doing this, some more
</I>&gt;<i> painful than others&quot;. With the few previous details above you may be
</I>&gt;<i> looking at quite a masochist way.
</I>&gt;<i> 
</I>&gt;<i> Seriously can you show us the pros and cons of each strategy you looked
</I>&gt;<i> at ? because I strongly feel you did not consider (everything) that
</I>&gt;<i> working with moonlight/coreclr requires.
</I>&gt;<i> 
</I>&gt;&gt;<i> Since glib-sharp uses a lot of marshaling API (which is not present
</I>&gt;&gt;<i> anymore as public in Silverlight) we need to add it to the list of
</I>&gt;&gt;<i> InternalsVisibleTo assemblies, with the patch attached. 
</I>&gt;<i> 
</I>&gt;<i> You're making the (wrong) assumption that mscorlib.dll internals are
</I>&gt;<i> stable, while they are not.
</I>&gt;<i> 
</I>&gt;<i> I.e. the tuner analyze the assemblies from mcs[1] and internalize or
</I>&gt;<i> _remove_ stuff that is not needed (publicly or at all). This is done
</I>&gt;<i> each time the assemblies are rebuild, meaning that a change inside moon
</I>&gt;<i> (or even mcs[2]) could remove stuff you depend on. Since this is done
</I>&gt;<i> automatically you can never be sure if your own assemblies, using
</I>&gt;<i> InternalsVisibleTo or not, will have what it requires to execute.
</I>
I have 2 patches for gtk-sharp module:
1) First one, with code changes, that add #if NET_2_1 sections.
2) Second, with autotools changes, that build glib-sharp with smcs.

If the internals of mscorlib suddendly disappeared or were made internal
when we need them public, we would notice it as soon as this special
build fails.

What other technique do you propose? Using tuning for the glib-sharp
assembly that gets built on the &quot;&lt;2.1&quot; profile?


&gt;<i> [1] assemblies from moon are also processed but with fewer steps
</I>&gt;<i> (security attributes)
</I>&gt;<i> 
</I>&gt;<i> [2] we had one case earlier this week where the internals changed a lot
</I>&gt;<i> when SafeFileHandle was introduced (and later removed).
</I>&gt;<i> 
</I>&gt;<i> You're also assuming that the internals you need will have the &quot;right&quot;
</I>&gt;<i> security attributes to be used (from your caller), which may not be the
</I>&gt;<i> case (and, just like the visibility, may change anytime).
</I>
I was not assuming that. What I was assuming is that we won't need to
care about the security attributes if we have already agreed that
glib-sharp will be loaded as platform code, or am I missing something?


&gt;&gt;<i> This step of
</I>&gt;&gt;<i> course is under the assumption that our stuff will be loaded as platform
</I>&gt;&gt;<i> code, since it will be indeed part of moonlight infrastructure, and
</I>&gt;&gt;<i> because it wouldn't be possible otherwise (as glib-sharp needs to use
</I>&gt;&gt;<i> P/Invoke extensively).
</I>&gt;<i> 
</I>&gt;<i> Sorry but 1 + 1 == 2, not 3. Loading your code as &quot;platform code&quot; won't
</I>&gt;<i> make glib-sharp able to p/invoke. 
</I>&gt;<i> 
</I>&gt;<i> You may have read something like &quot;only platform code can p/invoke&quot; but
</I>&gt;<i> that's not the whole truth. The right explanations are that &quot;only
</I>&gt;<i> platform code can contain critical code&quot; and &quot;only critical code can
</I>&gt;<i> p/invoke&quot;.
</I>
Yeah, sorry that I didn't use the exact wording.


&gt;<i> Now mix this fact with &quot;all code, even platform code, is by default
</I>&gt;<i> transparent&quot; and you'll see that even if moonlight &quot;bless&quot; glib-sharp as
</I>&gt;<i> &quot;platform code&quot; it won't be able to p/invoke (without multiple changes).
</I>
Ok, I'm lost on this one, which multiple changes?


&gt;&gt;<i> The patch for making our stuff be loaded as platform code is still in
</I>&gt;&gt;<i> the works. I've discussed briefly how to do this with Sebastien, as he's
</I>&gt;&gt;<i> working on some security-related patches that will affect this.
</I>&gt;<i> 
</I>&gt;<i> Like I said &quot;this (platform code) is not a big problem&quot;. However it's
</I>&gt;<i> _not_ the only problem you're facing. The stuff above does not even
</I>&gt;<i> touch the security problem you need to consider with this approach.
</I>&gt;<i> 
</I>&gt;&gt;<i> So, can I commit the patch attached? 
</I>&gt;<i> 
</I>&gt;<i> No ;-)
</I>&gt;<i> 
</I>&gt;&gt;<i> Any feedback welcome. Thanks!
</I>&gt;<i> 
</I>&gt;<i> Now I don't want to sound negative, nor do I want to comment every patch
</I>&gt;<i> with reasons why it won't work or be really painful (and believe me the
</I>&gt;<i> pain I see is _much_ more on your side than mine ;-). However I need
</I>&gt;<i> more information before I can provide any useful hints.
</I>
Sure, I'll be happy to provide any new information that is needed.

Thanks,

	Andr&#233;s


&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Miguel de Icaza wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> a) In the XPI of Moonlight itself (this seemed to be the preferred
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> election of some people in the IRC channel).
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Disadvantage: it would pull some dependencies such as atk-sharp and
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> glib-sharp so the XPI size grows.
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Advantage: everybody gets native accessibility support in Linux if they
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> have their corresponding A11Y client software installed (at-spi, screen
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> readers, etc.), without the need of packaging the bridge for every distro.
</I>&gt;&gt;&gt;&gt;&gt;<i> I would not want to ship glib-sharp, atk-sharp or anything like that.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The UIA code probably should not use those either, it likely can get
</I>&gt;&gt;&gt;&gt;&gt;<i> away by just P/Invoking the handful of calls that it needs.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> As Sandy has already pointed out, we use atk extensively and atk-sharp
</I>&gt;&gt;&gt;<i> is extremely useful for that (because we derive from Atk classes, use
</I>&gt;&gt;&gt;<i> GInterfaces, etc.). It's a usage very similar to what is done if you
</I>&gt;&gt;&gt;<i> want to create a Gtk+ widget with GtkSharp (but in our case it's not
</I>&gt;&gt;&gt;<i> just a class, but a lot of them).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Moonlight-list mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Moonlight-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000352.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization	of	accessibility in Moonlight)
</A></li>
	<LI>Next message: <A HREF="000356.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#354">[ date ]</a>
              <a href="thread.html#354">[ thread ]</a>
              <a href="subject.html#354">[ subject ]</a>
              <a href="author.html#354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
