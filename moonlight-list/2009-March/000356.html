<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%0A%20InternalsVisibleTo%09of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%0A%20initialization%20of%09accessibility%20in%20Moonlight%29&In-Reply-To=49CA6DC4.7070002%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000354.html">
   <LINK REL="Next"  HREF="000366.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%0A%20InternalsVisibleTo%09of%20corlib%20in%20the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%0A%20initialization%20of%09accessibility%20in%20Moonlight%29&In-Reply-To=49CA6DC4.7070002%40gmail.com"
       TITLE="[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo	of corlib in the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Wed Mar 25 14:15:53 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000354.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
        <LI>Next message: <A HREF="000366.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#356">[ date ]</a>
              <a href="thread.html#356">[ thread ]</a>
              <a href="subject.html#356">[ subject ]</a>
              <a href="author.html#356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello again,

On Wed, 2009-03-25 at 13:45 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
&gt;<i> Hey, thanks for your answer Sebastien.
</I>&gt;<i> 
</I>&gt;<i> Sebastien Pouliot wrote:
</I>&gt;<i> &gt; Hello &#65279;Andr&#233;s,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Wed, 2009-03-25 at 12:00 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;<i> &gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Regardless of the method picked for distribution of the a11y support of
</I>&gt;<i> &gt;&gt; moonlight (discussed on previous thread about this), we need to use
</I>&gt;<i> &gt;&gt; atk-sharp for hooking our classes into the GObject framework that is
</I>&gt;<i> &gt;&gt; used by Atk, and thus this implies that glib-sharp (which is a
</I>&gt;<i> &gt;&gt; dependency of atk-sharp) needs to be built against the 2.1 profile.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Like I said on IRC &quot;there are tons of ways of doing this, some more
</I>&gt;<i> &gt; painful than others&quot;. With the few previous details above you may be
</I>&gt;<i> &gt; looking at quite a masochist way.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Seriously can you show us the pros and cons of each strategy you looked
</I>&gt;<i> &gt; at ? because I strongly feel you did not consider (everything) that
</I>&gt;<i> &gt; working with moonlight/coreclr requires.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; Since glib-sharp uses a lot of marshaling API (which is not present
</I>&gt;<i> &gt;&gt; anymore as public in Silverlight) we need to add it to the list of
</I>&gt;<i> &gt;&gt; InternalsVisibleTo assemblies, with the patch attached. 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; You're making the (wrong) assumption that mscorlib.dll internals are
</I>&gt;<i> &gt; stable, while they are not.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I.e. the tuner analyze the assemblies from mcs[1] and internalize or
</I>&gt;<i> &gt; _remove_ stuff that is not needed (publicly or at all). This is done
</I>&gt;<i> &gt; each time the assemblies are rebuild, meaning that a change inside moon
</I>&gt;<i> &gt; (or even mcs[2]) could remove stuff you depend on. Since this is done
</I>&gt;<i> &gt; automatically you can never be sure if your own assemblies, using
</I>&gt;<i> &gt; InternalsVisibleTo or not, will have what it requires to execute.
</I>&gt;<i> 
</I>&gt;<i> I have 2 patches for gtk-sharp module:
</I>&gt;<i> 1) First one, with code changes, that add #if NET_2_1 sections.
</I>
That could help (or not) but I can't comment without seeing the
patch ;-)

&gt;<i> 2) Second, with autotools changes, that build glib-sharp with smcs.
</I>
Does not really matter.

&gt;<i> If the internals of mscorlib suddendly disappeared or were made internal
</I>&gt;<i> when we need them public, we would notice it as soon as this special
</I>&gt;<i> build fails.
</I>
Or as soon as the code was shipped ? Even then if you find out &#65279;it's
broken &quot;just before&quot; how do you go fixing it ? &#65279;it will be a bit late to
ask us to change our build process.

And that's assuming the failure is easy to find (e.g. compile time
versus run time, like something that use reflection).

Anyway if your build is out of the &quot;main loop&quot; you'll always be in
reactive (and painful) mode.

&gt;<i> What other technique do you propose? 
</I>
Does not compute, insufficient data. End-of-line ;-)

&gt;<i> Using tuning for the glib-sharp
</I>&gt;<i> assembly that gets built on the &quot;&lt;2.1&quot; profile?
</I>
Using the tuner, with some tweaks*, could solve a lot of issues (but
mostly the ones I have not talked about)

* &#65279;your case does not match what's being done in mcs nor moon

&gt;<i> &gt; [1] assemblies from moon are also processed but with fewer steps
</I>&gt;<i> &gt; (security attributes)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; [2] we had one case earlier this week where the internals changed a lot
</I>&gt;<i> &gt; when SafeFileHandle was introduced (and later removed).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; You're also assuming that the internals you need will have the &quot;right&quot;
</I>&gt;<i> &gt; security attributes to be used (from your caller), which may not be the
</I>&gt;<i> &gt; case (and, just like the visibility, may change anytime).
</I>&gt;<i> 
</I>&gt;<i> I was not assuming that. What I was assuming is that we won't need to
</I>&gt;<i> care about the security attributes if we have already agreed that
</I>&gt;<i> glib-sharp will be loaded as platform code, or am I missing something?
</I>
Definitively. Being &quot;platform code&quot; does not make the code omnipotent
(fully trusted). The rules stays the same* and this means _caring_ about
the security attributes. Otherwise it would not make sense to have
attributes since all non-platform code is transparent (i.e. without
attributes)

* almost, there are a few subtle differences wrt visibility (but nothing
that would help you)

&gt;<i> 
</I>&gt;<i> &gt;&gt; This step of
</I>&gt;<i> &gt;&gt; course is under the assumption that our stuff will be loaded as platform
</I>&gt;<i> &gt;&gt; code, since it will be indeed part of moonlight infrastructure, and
</I>&gt;<i> &gt;&gt; because it wouldn't be possible otherwise (as glib-sharp needs to use
</I>&gt;<i> &gt;&gt; P/Invoke extensively).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Sorry but 1 + 1 == 2, not 3. Loading your code as &quot;platform code&quot; won't
</I>&gt;<i> &gt; make glib-sharp able to p/invoke. 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; You may have read something like &quot;only platform code can p/invoke&quot; but
</I>&gt;<i> &gt; that's not the whole truth. The right explanations are that &quot;only
</I>&gt;<i> &gt; platform code can contain critical code&quot; and &quot;only critical code can
</I>&gt;<i> &gt; p/invoke&quot;.
</I>&gt;<i> 
</I>&gt;<i> Yeah, sorry that I didn't use the exact wording.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Now mix this fact with &quot;all code, even platform code, is by default
</I>&gt;<i> &gt; transparent&quot; and you'll see that even if moonlight &quot;bless&quot; glib-sharp as
</I>&gt;<i> &gt; &quot;platform code&quot; it won't be able to p/invoke (without multiple changes).
</I>&gt;<i> 
</I>&gt;<i> Ok, I'm lost on this one, which multiple changes?
</I>
At a minimum:
* adding the right security attributes everywhere;
* adjusting the visibility of all the API (against reflection);
in your code and glib-sharp (and any friend you wish to include).

&gt;<i> &gt;&gt; The patch for making our stuff be loaded as platform code is still in
</I>&gt;<i> &gt;&gt; the works. I've discussed briefly how to do this with Sebastien, as he's
</I>&gt;<i> &gt;&gt; working on some security-related patches that will affect this.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Like I said &quot;this (platform code) is not a big problem&quot;. However it's
</I>&gt;<i> &gt; _not_ the only problem you're facing. The stuff above does not even
</I>&gt;<i> &gt; touch the security problem you need to consider with this approach.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; So, can I commit the patch attached? 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; No ;-)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; Any feedback welcome. Thanks!
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Now I don't want to sound negative, nor do I want to comment every patch
</I>&gt;<i> &gt; with reasons why it won't work or be really painful (and believe me the
</I>&gt;<i> &gt; pain I see is _much_ more on your side than mine ;-). However I need
</I>&gt;<i> &gt; more information before I can provide any useful hints.
</I>&gt;<i> 
</I>&gt;<i> Sure, I'll be happy to provide any new information that is needed.
</I>
Let's take a step back and look at:
&lt;quote&gt;
&gt;<i> &gt; Seriously can you show us the pros and cons of each strategy you looked
</I>&gt;<i> &gt; at ? because I strongly feel you did not consider (everything) that
</I>&gt;<i> &gt; working with moonlight/coreclr requires.
</I>&lt;/quote&gt;

Sebastien

&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> 	Andr&#233;s
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Miguel de Icaza wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Hello,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; a) In the XPI of Moonlight itself (this seemed to be the preferred
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; election of some people in the IRC channel).
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; Disadvantage: it would pull some dependencies such as atk-sharp and
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; glib-sharp so the XPI size grows.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; Advantage: everybody gets native accessibility support in Linux if they
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; have their corresponding A11Y client software installed (at-spi, screen
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; readers, etc.), without the need of packaging the bridge for every distro.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; I would not want to ship glib-sharp, atk-sharp or anything like that.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; The UIA code probably should not use those either, it likely can get
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; away by just P/Invoking the handful of calls that it needs.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; As Sandy has already pointed out, we use atk extensively and atk-sharp
</I>&gt;<i> &gt;&gt;&gt; is extremely useful for that (because we derive from Atk classes, use
</I>&gt;<i> &gt;&gt;&gt; GInterfaces, etc.). It's a usage very similar to what is done if you
</I>&gt;<i> &gt;&gt;&gt; want to create a Gtk+ widget with GtkSharp (but in our case it's not
</I>&gt;<i> &gt;&gt;&gt; just a class, but a lot of them).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Moonlight-list mailing list
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Moonlight-list mailing list
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> &gt; <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Moonlight-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000354.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
	<LI>Next message: <A HREF="000366.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#356">[ date ]</a>
              <a href="thread.html#356">[ thread ]</a>
              <a href="subject.html#356">[ subject ]</a>
              <a href="author.html#356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
