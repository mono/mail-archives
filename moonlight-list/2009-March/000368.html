<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in	the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%20InternalsVisibleTo%0A%20of%20corlib%20in%09the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%20initialization%0A%20of%09accessibility%20in%20Moonlight%29&In-Reply-To=49CCE844.2050101%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000367.html">
   <LINK REL="Next"  HREF="000369.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in	the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)</H1>
    <B>Sebastien Pouliot</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Add%20glib-sharp%20to%20InternalsVisibleTo%0A%20of%20corlib%20in%09the%202.1%20profile%20%28was%3A%20Re%3A%20Distribution%20and%20initialization%0A%20of%09accessibility%20in%20Moonlight%29&In-Reply-To=49CCE844.2050101%40gmail.com"
       TITLE="[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in	the 2.1 profile (was: Re: Distribution and initialization of	accessibility in Moonlight)">sebastien.pouliot at gmail.com
       </A><BR>
    <I>Fri Mar 27 11:42:54 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000367.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
        <LI>Next message: <A HREF="000369.html">[Moonlight-list] [patch] platform code checks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#368">[ date ]</a>
              <a href="thread.html#368">[ thread ]</a>
              <a href="subject.html#368">[ subject ]</a>
              <a href="author.html#368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

On Fri, 2009-03-27 at 10:52 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
&gt;<i> Sebastien Pouliot wrote:
</I>&gt;<i> &gt; Hello again,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Wed, 2009-03-25 at 13:45 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;<i> &gt;&gt; Hey, thanks for your answer Sebastien.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Sebastien Pouliot wrote:
</I>&gt;<i> &gt;&gt;&gt; Hello &#65279;Andr&#233;s,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; On Wed, 2009-03-25 at 12:00 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Regardless of the method picked for distribution of the a11y support of
</I>&gt;<i> &gt;&gt;&gt;&gt; moonlight (discussed on previous thread about this), we need to use
</I>&gt;<i> &gt;&gt;&gt;&gt; atk-sharp for hooking our classes into the GObject framework that is
</I>&gt;<i> &gt;&gt;&gt;&gt; used by Atk, and thus this implies that glib-sharp (which is a
</I>&gt;<i> &gt;&gt;&gt;&gt; dependency of atk-sharp) needs to be built against the 2.1 profile.
</I>&gt;<i> &gt;&gt;&gt; Like I said on IRC &quot;there are tons of ways of doing this, some more
</I>&gt;<i> &gt;&gt;&gt; painful than others&quot;. With the few previous details above you may be
</I>&gt;<i> &gt;&gt;&gt; looking at quite a masochist way.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Seriously can you show us the pros and cons of each strategy you looked
</I>&gt;<i> &gt;&gt;&gt; at ? because I strongly feel you did not consider (everything) that
</I>&gt;<i> &gt;&gt;&gt; working with moonlight/coreclr requires.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Since glib-sharp uses a lot of marshaling API (which is not present
</I>&gt;<i> &gt;&gt;&gt;&gt; anymore as public in Silverlight) we need to add it to the list of
</I>&gt;<i> &gt;&gt;&gt;&gt; InternalsVisibleTo assemblies, with the patch attached. 
</I>&gt;<i> &gt;&gt;&gt; You're making the (wrong) assumption that mscorlib.dll internals are
</I>&gt;<i> &gt;&gt;&gt; stable, while they are not.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I.e. the tuner analyze the assemblies from mcs[1] and internalize or
</I>&gt;<i> &gt;&gt;&gt; _remove_ stuff that is not needed (publicly or at all). This is done
</I>&gt;<i> &gt;&gt;&gt; each time the assemblies are rebuild, meaning that a change inside moon
</I>&gt;<i> &gt;&gt;&gt; (or even mcs[2]) could remove stuff you depend on. Since this is done
</I>&gt;<i> &gt;&gt;&gt; automatically you can never be sure if your own assemblies, using
</I>&gt;<i> &gt;&gt;&gt; InternalsVisibleTo or not, will have what it requires to execute.
</I>&gt;<i> &gt;&gt; I have 2 patches for gtk-sharp module:
</I>&gt;<i> &gt;&gt; 1) First one, with code changes, that add #if NET_2_1 sections.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; That could help (or not) but I can't comment without seeing the
</I>&gt;<i> &gt; patch ;-)
</I>&gt;<i> 
</I>&gt;<i> The patches are here:
</I>
None of those patches will allow glib-sharp to _run_ under the coreclr
restrictions. 

With Silverlight (and Moonlight) it's easy to compile stuff (what you
achieved with those patches) that _won't_ work at execution time since
the compiler won't warn you about the runtime checks (which will results
in a bunch of TypeLoadException and MethodAccessException).

&gt;<i> 
</I>&gt;<i> (I still have to polish them and hook our build process to this
</I>&gt;<i> gtk-sharp build process. And yes, there are some changes to the
</I>&gt;<i> generator that may seem weird, but I expect to discuss and have the
</I>&gt;<i> review about them later, I mean, I was thinking of having this patches
</I>&gt;<i> committed in a step by step process.)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; 2) Second, with autotools changes, that build glib-sharp with smcs.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Does not really matter.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; If the internals of mscorlib suddendly disappeared or were made internal
</I>&gt;<i> &gt;&gt; when we need them public, we would notice it as soon as this special
</I>&gt;<i> &gt;&gt; build fails.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Or as soon as the code was shipped ? Even then if you find out &#65279;it's
</I>&gt;<i> &gt; broken &quot;just before&quot; how do you go fixing it ? &#65279;it will be a bit late to
</I>&gt;<i> &gt; ask us to change our build process.
</I>&gt;<i> &gt; And that's assuming the failure is easy to find (e.g. compile time
</I>&gt;<i> &gt; versus run time, like something that use reflection).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Anyway if your build is out of the &quot;main loop&quot; you'll always be in
</I>&gt;<i> &gt; reactive (and painful) mode.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Ok, so I assume we want a special process/tool that checks, ahead of
</I>&gt;<i> time, the API elements that glib-sharp is using in order to prevent this
</I>&gt;<i> problem from happening in your &quot;main loop&quot; right? I'll look into that,
</I>&gt;<i> but anyway this patch will still be needed, right?
</I>
Yes, that would be one way to solve this.

&gt;<i> 
</I>&gt;<i> &gt;&gt; What other technique do you propose? 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Does not compute, insufficient data. End-of-line ;-)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt; Using tuning for the glib-sharp
</I>&gt;<i> &gt;&gt; assembly that gets built on the &quot;&lt;2.1&quot; profile?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Using the tuner, with some tweaks*, could solve a lot of issues (but
</I>&gt;<i> &gt; mostly the ones I have not talked about)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; * &#65279;your case does not match what's being done in mcs nor moon
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt;&gt; [1] assemblies from moon are also processed but with fewer steps
</I>&gt;<i> &gt;&gt;&gt; (security attributes)
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; [2] we had one case earlier this week where the internals changed a lot
</I>&gt;<i> &gt;&gt;&gt; when SafeFileHandle was introduced (and later removed).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; You're also assuming that the internals you need will have the &quot;right&quot;
</I>&gt;<i> &gt;&gt;&gt; security attributes to be used (from your caller), which may not be the
</I>&gt;<i> &gt;&gt;&gt; case (and, just like the visibility, may change anytime).
</I>&gt;<i> &gt;&gt; I was not assuming that. What I was assuming is that we won't need to
</I>&gt;<i> &gt;&gt; care about the security attributes if we have already agreed that
</I>&gt;<i> &gt;&gt; glib-sharp will be loaded as platform code, or am I missing something?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Definitively. Being &quot;platform code&quot; does not make the code omnipotent
</I>&gt;<i> &gt; (fully trusted). The rules stays the same* and this means _caring_ about
</I>&gt;<i> &gt; the security attributes. Otherwise it would not make sense to have
</I>&gt;<i> &gt; attributes since all non-platform code is transparent (i.e. without
</I>&gt;<i> &gt; attributes)
</I>&gt;<i> 
</I>&gt;<i> Ok, I have to read more about this SL security stuff, sorry for my lack
</I>&gt;<i> of knowledge! I was assuming that &quot;platform-code&quot; meant &quot;full-trust&quot;. Is
</I>&gt;<i> there a way to have a &quot;full-trust&quot; mode or do we need some API items
</I>&gt;<i> lists like the ones I'm seeing in some patches being committed (.scc
</I>&gt;<i> files, right?)
</I>
Since all code is transparent by default you can _only_ have &quot;full
trust&quot; but only using the right security attributes and by following
_all_ the rules associated with them. Otherwise the security model won't
allow your code to execute properly.

Next you need to be sure you're not opening any security hole because
your code, once loaded, will be available (e.g. thru reflection). So any
error in visibility or the wrong attributes will let the bundled API
accessible to application (i.e. untrusted) code.

So your pain will be in direct relation to the amount of additional code
you bring in. With extra pain for platform code, extra++ pain for &quot;full
trust&quot; code usable by transparent code (like System.Windows.Automation
classes).

&gt;<i> &gt; * almost, there are a few subtle differences wrt visibility (but nothing
</I>&gt;<i> &gt; that would help you)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;&gt;&gt;&gt; This step of
</I>&gt;<i> &gt;&gt;&gt;&gt; course is under the assumption that our stuff will be loaded as platform
</I>&gt;<i> &gt;&gt;&gt;&gt; code, since it will be indeed part of moonlight infrastructure, and
</I>&gt;<i> &gt;&gt;&gt;&gt; because it wouldn't be possible otherwise (as glib-sharp needs to use
</I>&gt;<i> &gt;&gt;&gt;&gt; P/Invoke extensively).
</I>&gt;<i> &gt;&gt;&gt; Sorry but 1 + 1 == 2, not 3. Loading your code as &quot;platform code&quot; won't
</I>&gt;<i> &gt;&gt;&gt; make glib-sharp able to p/invoke. 
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; You may have read something like &quot;only platform code can p/invoke&quot; but
</I>&gt;<i> &gt;&gt;&gt; that's not the whole truth. The right explanations are that &quot;only
</I>&gt;<i> &gt;&gt;&gt; platform code can contain critical code&quot; and &quot;only critical code can
</I>&gt;<i> &gt;&gt;&gt; p/invoke&quot;.
</I>&gt;<i> &gt;&gt; Yeah, sorry that I didn't use the exact wording.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Now mix this fact with &quot;all code, even platform code, is by default
</I>&gt;<i> &gt;&gt;&gt; transparent&quot; and you'll see that even if moonlight &quot;bless&quot; glib-sharp as
</I>&gt;<i> &gt;&gt;&gt; &quot;platform code&quot; it won't be able to p/invoke (without multiple changes).
</I>&gt;<i> &gt;&gt; Ok, I'm lost on this one, which multiple changes?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; At a minimum:
</I>&gt;<i> &gt; * adding the right security attributes everywhere;
</I>&gt;<i> &gt; * adjusting the visibility of all the API (against reflection);
</I>&gt;<i> &gt; in your code and glib-sharp (and any friend you wish to include).
</I>&gt;<i> 
</I>&gt;<i> I'll look into this.
</I>
Like I said on IRC you can try Moonlight with coreclr now (mono has all
the patches needed in SVN HEAD, moonlight only requires one right now).
That will give you a &quot;pain preview&quot; ;-)

&gt;<i> 
</I>&gt;<i> &gt;&gt;&gt;&gt; The patch for making our stuff be loaded as platform code is still in
</I>&gt;<i> &gt;&gt;&gt;&gt; the works. I've discussed briefly how to do this with Sebastien, as he's
</I>&gt;<i> &gt;&gt;&gt;&gt; working on some security-related patches that will affect this.
</I>&gt;<i> &gt;&gt;&gt; Like I said &quot;this (platform code) is not a big problem&quot;. However it's
</I>&gt;<i> &gt;&gt;&gt; _not_ the only problem you're facing. The stuff above does not even
</I>&gt;<i> &gt;&gt;&gt; touch the security problem you need to consider with this approach.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; So, can I commit the patch attached? 
</I>&gt;<i> &gt;&gt;&gt; No ;-)
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Any feedback welcome. Thanks!
</I>&gt;<i> &gt;&gt;&gt; Now I don't want to sound negative, nor do I want to comment every patch
</I>&gt;<i> &gt;&gt;&gt; with reasons why it won't work or be really painful (and believe me the
</I>&gt;<i> &gt;&gt;&gt; pain I see is _much_ more on your side than mine ;-). However I need
</I>&gt;<i> &gt;&gt;&gt; more information before I can provide any useful hints.
</I>&gt;<i> &gt;&gt; Sure, I'll be happy to provide any new information that is needed.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Let's take a step back and look at:
</I>&gt;<i> &gt; &lt;quote&gt;
</I>&gt;<i> &gt;&gt;&gt; Seriously can you show us the pros and cons of each strategy you looked
</I>&gt;<i> &gt;&gt;&gt; at ? because I strongly feel you did not consider (everything) that
</I>&gt;<i> &gt;&gt;&gt; working with moonlight/coreclr requires.
</I>&gt;<i> &gt; &lt;/quote&gt;
</I>&gt;<i> 
</I>&gt;<i> So, with the patches posted above, and the proposal about including the
</I>&gt;<i> check-process in your mainloop, does this accomodate the pros/cons you
</I>&gt;<i> expect it to be included?
</I>
Not quite, right now we only talked about a single (painful)
option. &#65279;I'm sure your current plan was selected as the best with the
data you had but, like I said above, you missed some important data in
your equation. 

So I'd like to know about &quot;all options&quot; pros/cons so we can tell you
(for each option) what this implies wrt moonlight (and the coreclr
security model). Then you can follow up on the option you like best (but
you'll know &quot;everything&quot; about it ;-)

Sebastien

&gt;<i> Thanks again,
</I>&gt;<i> 
</I>&gt;<i> 	Andr&#233;s
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Miguel de Icaza wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; Hello,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; a) In the XPI of Moonlight itself (this seemed to be the preferred
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; election of some people in the IRC channel).
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Disadvantage: it would pull some dependencies such as atk-sharp and
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; glib-sharp so the XPI size grows.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Advantage: everybody gets native accessibility support in Linux if they
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; have their corresponding A11Y client software installed (at-spi, screen
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; readers, etc.), without the need of packaging the bridge for every distro.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; I would not want to ship glib-sharp, atk-sharp or anything like that.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; The UIA code probably should not use those either, it likely can get
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;&gt; away by just P/Invoking the handful of calls that it needs.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; As Sandy has already pointed out, we use atk extensively and atk-sharp
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; is extremely useful for that (because we derive from Atk classes, use
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; GInterfaces, etc.). It's a usage very similar to what is done if you
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; want to create a Gtk+ widget with GtkSharp (but in our case it's not
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; just a class, but a lot of them).
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000367.html">[Moonlight-list] [PATCH] Add glib-sharp to InternalsVisibleTo of corlib in the 2.1 profile (was: Re: Distribution and initialization of accessibility in Moonlight)
</A></li>
	<LI>Next message: <A HREF="000369.html">[Moonlight-list] [patch] platform code checks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#368">[ date ]</a>
              <a href="thread.html#368">[ thread ]</a>
              <a href="subject.html#368">[ subject ]</a>
              <a href="author.html#368">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
