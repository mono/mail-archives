<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] Res:  Help with WriteableBitmap
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20Res%3A%20%20Help%20with%20WriteableBitmap&In-Reply-To=937389.59037.qm%40web111404.mail.gq1.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000547.html">
   <LINK REL="Next"  HREF="000552.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] Res:  Help with WriteableBitmap</H1>
    <B>Geoff Norton</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20Res%3A%20%20Help%20with%20WriteableBitmap&In-Reply-To=937389.59037.qm%40web111404.mail.gq1.yahoo.com"
       TITLE="[Moonlight-list] Res:  Help with WriteableBitmap">gnorton at novell.com
       </A><BR>
    <I>Wed Jul 22 14:12:53 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000547.html">[Moonlight-list] Res:  Help with WriteableBitmap
</A></li>
        <LI>Next message: <A HREF="000552.html">[Moonlight-list] Res:  Res:  Help with WriteableBitmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#551">[ date ]</a>
              <a href="thread.html#551">[ thread ]</a>
              <a href="subject.html#551">[ subject ]</a>
              <a href="author.html#551">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Tony,

   There is likely a bug in my code setting PixelWidth and PixelHeight  
from existing images since I havn't udpated to the RTM code yet.  Can  
you file a bug with a testcase showing the problems you're having?

Thanks

-g

On 21-Jul-09, at 5:44 PM, Tony Alexander Hild wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> The path is right. The image is rendering because is marked as  
</I>&gt;<i> resource.
</I>&gt;<i>
</I>&gt;<i> What I'm trying to do is change this image with WriteableBitmap. The  
</I>&gt;<i> SL 3 RTM have breaking changes, and Moonligth WriteableBitmap is  
</I>&gt;<i> compatible with SL Beta. In SL Beta version was not allowed to write  
</I>&gt;<i> in an image that was already rendered, but now is possible. The  
</I>&gt;<i> acess to pixels was changed from an indexer to a property that  
</I>&gt;<i> returns an array int[], and now it's not possible to acess the pixel  
</I>&gt;<i> through Marshal.ReadInt32 since we don't know the offset. I  tried  
</I>&gt;<i> to using the Marshal.Copy but I get an Security Access error.
</I>&gt;<i>
</I>&gt;<i> I don't know how cast from IntPtr (buffer) directly to an int[].
</I>&gt;<i>
</I>&gt;<i> Another issue is that the BitmapSource return 0 from the PixelWidth  
</I>&gt;<i> and PixelHeight properties. I started digging the C++ code to figure  
</I>&gt;<i> out how the things works.
</I>&gt;<i>
</I>&gt;<i> Tony
</I>&gt;<i>
</I>&gt;<i> De: Diego Frata &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">diego.frata at gmail.com</A>&gt;
</I>&gt;<i> Para: Tony Alexander Hild &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">tony_hild at yahoo.com</A>&gt;
</I>&gt;<i> Enviadas: Ter&#231;a-feira, 21 de Julho de 2009 18:07:18
</I>&gt;<i> Assunto: Re: [Moonlight-list] Help with WriteableBitmap
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I have some experience with WriteableBitmap and BitmapSource on WPF  
</I>&gt;<i> (not on Mono). Maybe I could help you with this implementation.
</I>&gt;<i>
</I>&gt;<i> I was looking at your code and it raised me a question: Can you  
</I>&gt;<i> confirm your instance of BitmapSource points to a valid file? The  
</I>&gt;<i> path you entered doesn't sound right to me Source=&quot;/test;component/ 
</I>&gt;<i> 2.png&quot;.
</I>&gt;<i>
</I>&gt;<i> The image control is rendering the image correctly?
</I>&gt;<i>
</I>&gt;<i> Sorry if it's a dumb question, but I'll try to look at the source  
</I>&gt;<i> code later (i'm at work right now).
</I>&gt;<i>
</I>&gt;<i> Diego Frata
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">diego.frata at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Tue, Jul 21, 2009 at 3:33 PM, Tony Alexander Hild &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">tony_hild at yahoo.com</A> 
</I>&gt;<i> &gt; wrote:
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I have made a simple program to test the WriteableBitmap.
</I>&gt;<i> btnTest_Click calls the Invert function.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>              xmlns:x=&quot;<A HREF="http://schemas.microsoft.com/winfx/2006/xaml&quot;">http://schemas.microsoft.com/winfx/2006/xaml&quot;</A>
</I>&gt;<i>              Width=&quot;1000&quot; Height=&quot;650&quot;
</I>&gt;<i>              x:Class=&quot;HelloMoon.Page&quot;
</I>&gt;<i> &gt;
</I>&gt;<i>     &lt;Grid x:Name=&quot;LayoutRoot&quot; Background=&quot;Black&quot;&gt;
</I>&gt;<i>         &lt;TextBlock x:Name=&quot;tblText&quot; FontSize=&quot;30&quot;  
</I>&gt;<i> Foreground=&quot;White&quot;&gt;Hello Moon!&lt;/TextBlock&gt;
</I>&gt;<i>     &lt;Button x:Name=&quot;btnTest&quot; Width=&quot;200&quot; VerticalAlignment=&quot;Top&quot;  
</I>&gt;<i> Height=&quot;50&quot; Canvas.Top=&quot;0&quot; Canvas.Left=&quot;100&quot; Click=&quot;btnTest_Click&quot;  
</I>&gt;<i> Content=&quot;Click me!&quot;&gt;&lt;/Button&gt;
</I>&gt;<i>     &lt;Image x:Name=&quot;MyBitmap&quot; Source=&quot;/test;component/2.png&quot;
</I>&gt;<i>                Width=&quot;512&quot;
</I>&gt;<i>                Height=&quot;512&quot; /&gt;
</I>&gt;<i>
</I>&gt;<i>     &lt;/Grid&gt;
</I>&gt;<i> &lt;/UserControl&gt;
</I>&gt;<i>
</I>&gt;<i>         private void Invert ()
</I>&gt;<i>         {
</I>&gt;<i>             const int imageWidth = 512;
</I>&gt;<i>             const int imageHeight = 512;
</I>&gt;<i>
</I>&gt;<i>             WriteableBitmap b = new WriteableBitmap  
</I>&gt;<i> ((BitmapSource)MyBitmap.Source);
</I>&gt;<i>             //WriteableBitmap b = new WriteableBitmap (imageWidth,  
</I>&gt;<i> imageHeight, PixelFormats.Bgr32);
</I>&gt;<i>
</I>&gt;<i>             for (int x = 0; x &lt; imageWidth; x++) {
</I>&gt;<i>                 for (int y = 0; y &lt; imageHeight; y++) {
</I>&gt;<i>                     int color = b.Pixels[y * imageWidth + x];
</I>&gt;<i>                     if (color == 0) {
</I>&gt;<i>                         // generate a color in Pbgra32 format
</I>&gt;<i>                         byte[] components = {
</I>&gt;<i>                             255,
</I>&gt;<i>                             255,
</I>&gt;<i>                             255,
</I>&gt;<i>                             0
</I>&gt;<i>                         };
</I>&gt;<i>                         int pixelValue = BitConverter.ToInt32  
</I>&gt;<i> (components, 0);
</I>&gt;<i>                         b.Pixels[y * imageWidth + x] = pixelValue;
</I>&gt;<i>
</I>&gt;<i>                     } else {
</I>&gt;<i>                         b.Pixels[y * imageWidth + x] = b.Pixels[y *  
</I>&gt;<i> imageWidth + x] = 0;
</I>&gt;<i>                     }
</I>&gt;<i>                 }
</I>&gt;<i>             }
</I>&gt;<i>
</I>&gt;<i>             b.Invalidate ();
</I>&gt;<i>             MyBitmap.Source = b;
</I>&gt;<i>
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I also modified the constructor of WriteableBitmap:
</I>&gt;<i>
</I>&gt;<i>         public WriteableBitmap (BitmapSource source) :  
</I>&gt;<i> base(NativeMethods.writeable_bitmap_new (), true)
</I>&gt;<i>         {
</I>&gt;<i>             rendered = true;
</I>&gt;<i>             PixelWidth = source.PixelWidth;
</I>&gt;<i>             PixelHeight = source.PixelHeight;
</I>&gt;<i>             PixelFormat = PixelFormats.Pbgra32;
</I>&gt;<i>             if (source != null)
</I>&gt;<i>                  
</I>&gt;<i> NativeMethods.writeable_bitmap_initialize_from_bitmap_source  
</I>&gt;<i> (native, source.native);
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i> But source.PixelWidth/Height always is 0, so i get this error:
</I>&gt;<i>
</I>&gt;<i> Value must be greater than zero
</I>&gt;<i>
</I>&gt;<i> Exception Details: System.ArgumentException: Value must be greater  
</I>&gt;<i> than zero
</I>&gt;<i>
</I>&gt;<i> Stack Trace:
</I>&gt;<i>
</I>&gt;<i>    at Mono..NativeMethods.CreateManagedException (MoonError err)  
</I>&gt;<i> [0x00000]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    at Mono.NativeMethods..dependency_object_set_value (IntPtr  
</I>&gt;<i> instance, IntPtr property, Mono.Value&amp; value) [0x00000]
</I>&gt;<i>    at Mono.NativeDependencyObjectHelper.SetValue  
</I>&gt;<i> (INativeDependencyObjectWrapper wrapper,  
</I>&gt;<i> System.Windows.DependencyProperty dp, System.Object value) [0x00000]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    at System.Windows.DependencyObject.SetValueImpl  
</I>&gt;<i> (System.Windows.DependencyProperty dp, System.Object value) [0x00000]
</I>&gt;<i>    at System.Windows.DependencyObject.SetValue  
</I>&gt;<i> (System.Windows.DependencyProperty dp, System.Object value) [0x00000]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    at System.Windows.Media.Imaging.BitmapSource.set_PixelWidth  
</I>&gt;<i> (Int32 value) [0x00000]
</I>&gt;<i>    at
</I>&gt;<i>  System.Windows.Media.Imaging.WriteableBitmap..ctor  
</I>&gt;<i> (System.Windows.Media.Imaging.BitmapSource source) [0x00000]
</I>&gt;<i>    at HelloMoon.Page.Invert () [0x00000]
</I>&gt;<i>    at HelloMoon.Page.btnTest_Click (System.Object sender,  
</I>&gt;<i> System.Windows.RoutedEventArgs e) [0x00000]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    at System.Windows.Controls.Primitives.ButtonBase.OnClick ()  
</I>&gt;<i> [0x00000]
</I>&gt;<i>    at  
</I>&gt;<i> System.Windows.Controls.Primitives.ButtonBase.OnMouseLeftButtonUp  
</I>&gt;<i> (System.Windows.Input.MouseButtonEventArgs e) [0x00000]
</I>&gt;<i>    at System.Windows..Controls.Control.InvokeMouseLeftButtonUp  
</I>&gt;<i> (System.Windows.Input.MouseButtonEventArgs e) [0x00000]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    at Mono.Events.mouse_left_button_up_callback (IntPtr target,  
</I>&gt;<i> IntPtr calldata, IntPtr closure) [0x00000]
</I>&gt;<i>    at Mono.Events+&lt;CreateSafeHandler&gt;c__AnonStorey1.&lt;&gt;m__2 (IntPtr  
</I>&gt;<i> a, IntPtr b, IntPtr c) [0x00000]
</I>&gt;<i>
</I>&gt;<i> But as the BitmapSource is already rendered, it should have the  
</I>&gt;<i> Height and Width properties set.
</I>&gt;<i>
</I>&gt;<i> What I'm doing wrong?
</I>&gt;<i> I'm using trunk version, from mono, mcs, libgdi and moon.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Tony
</I>&gt;<i>
</I>&gt;<i> Veja quais s&#227;o os assuntos do momento no Yahoo! + Buscados: Top 10 -  
</I>&gt;<i> Celebridades - M&#250;sica - Esportes
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Moonlight-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Veja quais s&#227;o os assuntos do momento no Yahoo! + Buscados: Top 10 -  
</I>&gt;<i> Celebridades - M&#250;sica -  
</I>&gt;<i> Esportes_______________________________________________
</I>&gt;<i> Moonlight-list mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">Moonlight-list at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">http://lists.ximian.com/mailman/listinfo/moonlight-list</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/moonlight-list/attachments/20090722/1a4e7d55/attachment-0001.html">http://lists.ximian.com/pipermail/moonlight-list/attachments/20090722/1a4e7d55/attachment-0001.html</A> 
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000547.html">[Moonlight-list] Res:  Help with WriteableBitmap
</A></li>
	<LI>Next message: <A HREF="000552.html">[Moonlight-list] Res:  Res:  Help with WriteableBitmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#551">[ date ]</a>
              <a href="thread.html#551">[ thread ]</a>
              <a href="subject.html#551">[ subject ]</a>
              <a href="author.html#551">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
