<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] Prevention of API stripping for	accessibility
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Prevention%20of%20API%20stripping%20for%0A%09accessibility&In-Reply-To=1251974919.12403.34.camel%40mizar.home">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000601.html">
   <LINK REL="Next"  HREF="000605.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] Prevention of API stripping for	accessibility</H1>
    <B>&quot;Andr&#233;s G. Aragoneses&quot;</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20Prevention%20of%20API%20stripping%20for%0A%09accessibility&In-Reply-To=1251974919.12403.34.camel%40mizar.home"
       TITLE="[Moonlight-list] [PATCH] Prevention of API stripping for	accessibility">knocte at gmail.com
       </A><BR>
    <I>Thu Sep  3 14:29:43 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000601.html">[Moonlight-list] [PATCH] Prevention of API stripping	for	accessibility
</A></li>
        <LI>Next message: <A HREF="000605.html">[Moonlight-list] [PATCH] Prevention of API stripping for	accessibility
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#602">[ date ]</a>
              <a href="thread.html#602">[ thread ]</a>
              <a href="subject.html#602">[ subject ]</a>
              <a href="author.html#602">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sebastien Pouliot wrote:
&gt;<i> On Wed, 2009-09-02 at 17:06 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;&gt;<i> Andr&#233;s G. Aragoneses wrote:
</I>&gt;&gt;&gt;<i> I've decided to postpone that problem (discarding that usage for now).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now I've achieved to get an XML with the non-public API usage, for example:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &lt;linker&gt;
</I>&gt;&gt;&gt;<i>   &lt;assembly fullname=&quot;System.Windows&quot;&gt;
</I>&gt;&gt;&gt;<i>     &lt;type fullname=&quot;System.Windows.Automation.Peers.AutomationSingleton&quot;&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Void
</I>&gt;&gt;&gt;<i> add_AutomationPropertyChanged(System.EventHandler`1&amp;lt;System.Windows.Automation.Peers.AutomationPropertyChangedEventArgs&amp;gt;System.EventHandler`1&amp;lt;S$
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Void
</I>&gt;&gt;&gt;<i> add_AutomationEventRaised(System.EventHandler`1&amp;lt;System.Windows.Automation.Peers.AutomationEventEventArgs&amp;gt;System.EventHandler`1&amp;lt;System.Windows.$
</I>&gt;&gt;&gt;<i>       &lt;field
</I>&gt;&gt;&gt;<i> signature=&quot;System.Windows.Automation.Peers.AutomationSingleton Instance&quot; /&gt;
</I>&gt;&gt;&gt;<i>     &lt;/type&gt;
</I>&gt;&gt;&gt;<i>     &lt;type
</I>&gt;&gt;&gt;<i> fullname=&quot;System.Windows.Automation.Peers.AutomationEventEventArgs&quot;&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Windows.Automation.Peers.AutomationPeer
</I>&gt;&gt;&gt;<i> get_Peer()&quot; /&gt;
</I>&gt;&gt;&gt;<i>       &lt;method
</I>&gt;&gt;&gt;<i> signature=&quot;System.Windows.Automation.Peers.AutomationEvents get_Event()&quot; /&gt;
</I>&gt;&gt;&gt;<i>     &lt;/type&gt;
</I>&gt;&gt;&gt;<i>     &lt;type fullname=&quot;System.Windows.Automation.Peers.WindowAutomationPeer&quot;&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Void
</I>&gt;&gt;&gt;<i> .ctor(System.Windows.FrameworkElementSystem.Windows.FrameworkElement)&quot; /&gt;
</I>&gt;&gt;&gt;<i>     &lt;/type&gt;
</I>&gt;&gt;&gt;<i>     &lt;type
</I>&gt;&gt;&gt;<i> fullname=&quot;System.Windows.Automation.Peers.AutomationPropertyChangedEventArgs&quot;&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Windows.Automation.Peers.AutomationPeer
</I>&gt;&gt;&gt;<i> get_Peer()&quot; /&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Windows.Automation.AutomationProperty
</I>&gt;&gt;&gt;<i> get_Property()&quot; /&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Object get_OldValue()&quot; /&gt;
</I>&gt;&gt;&gt;<i>       &lt;method signature=&quot;System.Object get_NewValue()&quot; /&gt;
</I>&gt;&gt;&gt;<i>     &lt;/type&gt;
</I>&gt;&gt;&gt;<i>   &lt;/assembly&gt;
</I>&gt;&gt;&gt;<i> &lt;/linker&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This works for types that are internal in the first place. But what
</I>&gt;&gt;&gt;<i> happens with the types that become internal thanks to the tuning process
</I>&gt;&gt;&gt;<i> (such as System.Collections.ArrayList)?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I could design the API-usage-detector to inspect non-RAW (already tuned)
</I>&gt;&gt;&gt;<i> assemblies but at that time of the process, there may be API that has
</I>&gt;&gt;&gt;<i> already been stripped. So the solution to this may be a bit cumbersome:
</I>&gt;&gt;&gt;<i> split the tuning process from the stripping process in moonlight.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'll think about it more, though, to see if I can think of a better
</I>&gt;&gt;&gt;<i> solution (like a pre-reader of the tuning rules..?).
</I>&gt;&gt;<i> I think I've found a better approach: mark API that is even public,
</I>&gt;&gt;<i> generating a pre-descriptors file, and then later do a 2nd pass with the
</I>&gt;&gt;<i> non-raw assemblies, while reading the pre-descriptors file (to generate
</I>&gt;&gt;<i> a final descriptors file) to find out the internal or missing elements.
</I>&gt;<i> 
</I>&gt;<i> Adding a second pass is one way to do it. 
</I>&gt;<i> 
</I>&gt;<i> The other is to use the same data file that the linker use to produce
</I>&gt;<i> the assemblies - since that already includes all information about
</I>
Yeah, I was referring to this when I said &quot;pre-reader of the tuning
rules&quot; :) I'll have a look and do whatever approach is easier.


&gt;<i> what's visibly available on SL2 assemblies. Anything else you need (from
</I>&gt;<i> the same assemblies) needs to be marked.
</I>&gt;<i> 
</I>&gt;&gt;<i> I'll do that tomorrow as a 2nd phase. In the meantime, can these 2
</I>&gt;&gt;<i> patches be committed for now? 
</I>&gt;<i> 
</I>&gt;<i> No, the generated data is wrong (so I guess that, part of, the process
</I>&gt;<i> is wrong too). The a11y.xml file contains (only) references to types in
</I>&gt;<i> System.Windows.dll.
</I>&gt;<i> 
</I>&gt;<i> This assembly, like other assemblies inside /moon, is not (fully*)
</I>&gt;<i> processed by the linker. So it's useless to include types (or anything
</I>
Oh, I had it right before the patch indeed (as in my patch I'm removing
System.Windows from the blacklist of the descriptor generation, which is
incorrect), so I'll revert that, thanks for pointing out.


&gt;<i> else) from them into your definition file (it's only more work without
</I>&gt;<i> more results).
</I>&gt;<i> 
</I>&gt;<i>         * in the sense that only security attributes are added for /moon
</I>&gt;<i>         assemblies (i.e. no internals are automatically removed).
</I>&gt;<i> 
</I>&gt;<i> &#65279;What you want is to ensure that the linker does not remove stuff (that
</I>&gt;<i> _only_ a11y depends on) from /mcs/class/* assemblies processed by the
</I>&gt;<i> linker for our NET_2_1 build.
</I>&gt;<i> 
</I>&gt;&gt;<i> (Next patch will just add more elements to
</I>&gt;&gt;<i> the XML and a 2nd-pass step; which I'll obviously post for review as well.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 	Andres
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> PS: I guess that 1st patch should be reviewed by spouliot, and 2nd by JB.
</I>&gt;<i> 
</I>&gt;<i> JB needs to review any linker changes (since I never worked on the code)
</I>&gt;<i> but I can handle the &quot;end result&quot;, i.e. your extra xml input.
</I>
Exactly my point :)

Thanks,

	Andr&#233;s

-- 

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000601.html">[Moonlight-list] [PATCH] Prevention of API stripping	for	accessibility
</A></li>
	<LI>Next message: <A HREF="000605.html">[Moonlight-list] [PATCH] Prevention of API stripping for	accessibility
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#602">[ date ]</a>
              <a href="thread.html#602">[ thread ]</a>
              <a href="subject.html#602">[ subject ]</a>
              <a href="author.html#602">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
