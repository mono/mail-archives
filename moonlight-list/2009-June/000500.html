<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] [PATCH] MoonAtkBridge initialization
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20MoonAtkBridge%20initialization&In-Reply-To=4A3951EA.5070104%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000499.html">
   <LINK REL="Next"  HREF="000501.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] [PATCH] MoonAtkBridge initialization</H1>
    <B>&quot;Andr&#233;s G. Aragoneses&quot;</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20%5BPATCH%5D%20MoonAtkBridge%20initialization&In-Reply-To=4A3951EA.5070104%40gmail.com"
       TITLE="[Moonlight-list] [PATCH] MoonAtkBridge initialization">knocte at gmail.com
       </A><BR>
    <I>Wed Jun 17 23:17:46 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="000499.html">[Moonlight-list] [PATCH] MoonAtkBridge initialization
</A></li>
        <LI>Next message: <A HREF="000501.html">[Moonlight-list] [PATCH] MoonAtkBridge initialization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#500">[ date ]</a>
              <a href="thread.html#500">[ thread ]</a>
              <a href="subject.html#500">[ subject ]</a>
              <a href="author.html#500">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andr&#233;s G. Aragoneses wrote:
&gt;<i> Hey, thanks for your prompt answer.
</I>&gt;<i> 
</I>&gt;<i> Sebastien Pouliot wrote:
</I>&gt;&gt;<i> All,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A bit of context: this patch (should) add nothing to Moonlight unless
</I>&gt;&gt;<i> you compile with an MOON_A11Y_INTERNAL_HACK environment variable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This hack will be removed (i.e. activate a11y) only when all security
</I>&gt;&gt;<i> concerns* are resolved (including the one in the comments) but, in the
</I>&gt;&gt;<i> mean time, it allows the a11y team to build ML+A11Y support. Which in
</I>&gt;&gt;<i> turns let them run and debug their own code under the coreclr
</I>&gt;&gt;<i> restrictions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * please state them so they can be either answered (right now) or
</I>&gt;&gt;<i> considered (before the hack is removed and a11y becomes available).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Andr&#233;s: do you have a wiki page that resume our past discussions ? that
</I>&gt;&gt;<i> would provide answers to many questions.
</I>&gt;<i> 
</I>&gt;<i> Good point, I'll create one.
</I>&gt;<i> 
</I>
Created:

<A HREF="http://mono-project.com/Accessibility:_Moonlight_Bridge">http://mono-project.com/Accessibility:_Moonlight_Bridge</A>

Let me know if I'm missing any details please.


&gt;&gt;<i> more comments below...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Wed, 2009-06-17 at 14:59 -0400, &quot;Andr&#233;s G. Aragoneses&quot; wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In a similar way in which we hooked a11y initialization on MWF, I'm
</I>&gt;&gt;&gt;<i> proposing a patch we have developed for moon. It may still not be
</I>&gt;&gt;&gt;<i> complete, but we will be fixing the rest of the cases along the way (for
</I>&gt;&gt;&gt;<i> example, the case in which moon is not installed with an xpi).
</I>&gt;&gt;<i> I think this is the time to think about it, not later, since this risk
</I>&gt;&gt;<i> to invalidate (or replace) the current approach.
</I>&gt;<i> 
</I>&gt;<i> Current approach is this scenario:
</I>&gt;<i> Moon XPI + Moon-a11y XPI.
</I>&gt;<i> 
</I>&gt;<i> Next scenarios to consider are:
</I>&gt;<i> 1) Moon-native + Moon-a11y XPI
</I>&gt;<i> 2) Moon-native + Moon-a11y native
</I>&gt;<i> 3) Moon XPI + Moon-a11y native?
</I>&gt;<i> 
</I>&gt;<i> It seems I'll need to research how to ask firefox about possible
</I>&gt;<i> locations of extensions, but I would say the refactoring needed for this
</I>&gt;<i> would not &quot;invalidate&quot; but just &quot;upgrade&quot; the current approach.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Is it ok to commit? Please review.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>         Andr&#233;s
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -- 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> differences between files attachment (moonlight-a11y-initialization.diff)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Index: m4/mozilla.m4
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- m4/mozilla.m4       (revision 136249)
</I>&gt;&gt;&gt;<i> +++ m4/mozilla.m4       (working copy)
</I>&gt;&gt;&gt;<i> @@ -80,6 +80,11 @@
</I>&gt;&gt;&gt;<i>         MAX_FIREFOX_VERSION=&quot;3.5.*&quot;
</I>&gt;&gt;&gt;<i>         fi
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +       #a11y only works on Firefox trunk
</I>&gt;&gt;&gt;<i> +       if test x$MOON_A11Y_INTERNAL_HACK = x1; then
</I>&gt;&gt;&gt;<i> +               MAX_FIREFOX_VERSION=&quot;3.6.*&quot;
</I>&gt;&gt;&gt;<i> +       fi
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>         AC_SUBST([MIN_FIREFOX_VERSION])
</I>&gt;&gt;&gt;<i>         AC_SUBST([MAX_FIREFOX_VERSION])
</I>&gt;&gt;&gt;<i>         AM_CONDITIONAL(HAVE_MOZILLA, test x$with_mozilla = xyes)
</I>&gt;&gt;&gt;<i> Index: src/security.c
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- src/security.c      (revision 136249)
</I>&gt;&gt;&gt;<i> +++ src/security.c      (working copy)
</I>&gt;&gt;&gt;<i> @@ -16,6 +16,7 @@
</I>&gt;&gt;&gt;<i>  #if MONO_ENABLE_CORECLR_SECURITY
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>  static struct stat platform_stat;
</I>&gt;&gt;&gt;<i> +static struct stat platform_a11y_stat;
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>  const static char* platform_code_assemblies [] = {
</I>&gt;&gt;&gt;<i>         &quot;mscorlib.dll&quot;,
</I>&gt;&gt;&gt;<i> @@ -40,6 +41,8 @@
</I>&gt;&gt;&gt;<i>         struct stat info;
</I>&gt;&gt;&gt;<i>         gchar *dir, *name;
</I>&gt;&gt;&gt;<i>         unsigned int i;
</I>&gt;&gt;&gt;<i> +       struct stat the_platform_stat = platform_stat;
</I>&gt;&gt;&gt;<i> +       gboolean a11y = FALSE;
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>         if (!image_name)
</I>&gt;&gt;&gt;<i>                 return FALSE;
</I>&gt;&gt;&gt;<i> @@ -51,20 +54,35 @@
</I>&gt;&gt;&gt;<i>                 return FALSE;
</I>&gt;&gt;&gt;<i>         }
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +       name = g_path_get_basename (image_name);
</I>&gt;&gt;&gt;<i> +       if (!name) {
</I>&gt;&gt;&gt;<i> +               g_free (dir);
</I>&gt;&gt;&gt;<i> +               return FALSE;
</I>&gt;&gt;&gt;<i> +       }
</I>&gt;&gt;&gt;<i> +       
</I>&gt;&gt;&gt;<i> +#if MOON_A11Y_INTERNAL_HACK_ENABLED
</I>&gt;&gt;&gt;<i> +       if (g_ascii_strcasecmp (name, &quot;MoonAtkBridge.dll&quot;) == 0) {
</I>&gt;&gt;&gt;<i> +               the_platform_stat = platform_a11y_stat;
</I>&gt;&gt;&gt;<i> +               a11y = TRUE;
</I>&gt;&gt;&gt;<i> +       }
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>         /* we avoid comparing strings, e.g. /opt/mono/lib/moon versus /opt/mono//lib/moon */
</I>&gt;&gt;&gt;<i> -       if ((platform_stat.st_mode != info.st_mode) ||
</I>&gt;&gt;&gt;<i> -               (platform_stat.st_ino != info.st_ino) ||
</I>&gt;&gt;&gt;<i> -               (platform_stat.st_dev != info.st_dev)) {
</I>&gt;&gt;&gt;<i> +       if ((the_platform_stat.st_mode != info.st_mode) ||
</I>&gt;&gt;&gt;<i> +               (the_platform_stat.st_ino != info.st_ino) ||
</I>&gt;&gt;&gt;<i> +               (the_platform_stat.st_dev != info.st_dev)) {
</I>&gt;&gt;&gt;<i>                 g_free (dir);
</I>&gt;&gt;&gt;<i> +               g_free (name);
</I>&gt;&gt;&gt;<i>                 return FALSE;
</I>&gt;&gt;&gt;<i>         }
</I>&gt;&gt;&gt;<i>         g_free (dir);
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +       if (a11y == TRUE){
</I>&gt;&gt;&gt;<i> +               g_free (name);
</I>&gt;&gt;&gt;<i> +               return TRUE;
</I>&gt;&gt;&gt;<i> +       }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>         /* we know the names of every platform assembly, because we ship them */
</I>&gt;&gt;&gt;<i> -       name = g_path_get_basename (image_name);
</I>&gt;&gt;&gt;<i> -       if (!name)
</I>&gt;&gt;&gt;<i> -               return FALSE;
</I>&gt;&gt;&gt;<i> -
</I>&gt;&gt;&gt;<i>         for (i = 0; i &lt; G_N_ELEMENTS (platform_code_assemblies); i++) {
</I>&gt;&gt;&gt;<i>                 if (g_ascii_strcasecmp (name, platform_code_assemblies [i]) == 0) {
</I>&gt;&gt;&gt;<i>                         g_free (name);
</I>&gt;&gt;&gt;<i> @@ -88,7 +106,25 @@
</I>&gt;&gt;&gt;<i>                            &quot;you're doing!&quot;);
</I>&gt;&gt;&gt;<i>         } else if (g_path_is_absolute (platform_dir)) {
</I>&gt;&gt;&gt;<i>                 memset (&amp;platform_stat, 0, sizeof (platform_stat));
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>                 if (stat (platform_dir, &amp;platform_stat) == 0) {
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                       const char* moonlight_at_novell = g_strrstr (platform_dir, &quot;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">moonlight at novell.com</A>&quot;);
</I>&gt;&gt;&gt;<i> +                       if (moonlight_at_novell != NULL) {
</I>&gt;&gt;&gt;<i> +                               const char* after = g_strdup (&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">moonlight-a11y at novell.com</A>/components&quot;);
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                               const char* before = g_strndup (platform_dir, 
</I>&gt;&gt;&gt;<i> +                                                               strlen(platform_dir) - strlen(moonlight_at_novell));
</I>&gt;&gt;&gt;<i> +                               const char* platform_a11y_dir = g_strconcat (before, after, NULL);
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                               memset (&amp;platform_a11y_stat, 0, sizeof (platform_a11y_stat));
</I>&gt;&gt;&gt;<i> +                               stat (platform_a11y_dir, &amp;platform_a11y_stat);
</I>&gt;&gt;&gt;<i> +                               g_free (platform_a11y_dir);
</I>&gt;&gt;&gt;<i> +                               g_free (before);
</I>&gt;&gt;&gt;<i> +                               g_free (after);
</I>&gt;&gt;&gt;<i> +                               moonlight_at_novell = NULL;
</I>&gt;&gt;&gt;<i> +                       }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>                         mono_security_enable_core_clr ();
</I>&gt;&gt;&gt;<i>                         mono_security_set_core_clr_platform_callback (determine_platform_image);
</I>&gt;&gt;&gt;<i>                 }
</I>&gt;&gt;&gt;<i> Index: configure.ac
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- configure.ac        (revision 136249)
</I>&gt;&gt;&gt;<i> +++ configure.ac        (working copy)
</I>&gt;&gt;&gt;<i> @@ -106,6 +106,14 @@
</I>&gt;&gt;&gt;<i>  LOADER_LIBS=&quot;$GLIB_LIBS&quot;
</I>&gt;&gt;&gt;<i>  AC_SUBST(LOADER_LIBS)
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +# this hack will be dropped once we get this working:
</I>&gt;&gt;&gt;<i> +# <A HREF="http://www.mono-project.com/Moonlight/SecurityStatus#Assembly_Loading">http://www.mono-project.com/Moonlight/SecurityStatus#Assembly_Loading</A>
</I>&gt;&gt;&gt;<i> +if test &quot;x$MOON_A11Y_INTERNAL_HACK&quot; = &quot;x1&quot;; then
</I>&gt;&gt;&gt;<i> +       AC_DEFINE([MOON_A11Y_INTERNAL_HACK_ENABLED], [1],
</I>&gt;&gt;&gt;<i> +                 [Whether Mono A11y is enabled for now])
</I>&gt;&gt;&gt;<i> +fi
</I>&gt;&gt;&gt;<i> +AM_CONDITIONAL(MOON_A11Y_INTERNAL_HACK,test x$MOON_A11Y_INTERNAL_HACK = x1)
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>  if test x$with_ff3 = xyes; then
</I>&gt;&gt;&gt;<i>     MOZILLA_CFLAGS=$FF3_CFLAGS
</I>&gt;&gt;&gt;<i>  else
</I>&gt;&gt;&gt;<i> Index: class/tuning/SecurityAttributes/overrides/System.Windows.manual
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/tuning/SecurityAttributes/overrides/System.Windows.manual     (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/tuning/SecurityAttributes/overrides/System.Windows.manual     (working copy)
</I>&gt;&gt;&gt;<i> @@ -8,3 +8,6 @@
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>  # this method reflects into GCHandle to avoid creating an exception every time we try a invalid handle
</I>&gt;&gt;&gt;<i>  +SC-M: System.Boolean Mono.Helper::GCHandleInDomain(System.IntPtr)
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +# this method is called by the embedding API from moon
</I>&gt;&gt;&gt;<i> ++SSC-M: System.IntPtr Mono.A11yHelper::GetAccessible()
</I>&gt;&gt;&gt;<i> Index: class/tuning/SecurityAttributes/automatic/System.Windows.auto.ssc
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/tuning/SecurityAttributes/automatic/System.Windows.auto.ssc   (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/tuning/SecurityAttributes/automatic/System.Windows.auto.ssc   (working copy)
</I>&gt;&gt;&gt;<i> @@ -1,7 +1,9 @@
</I>&gt;&gt;&gt;<i>  # [SecuritySafeCritical] needed inside System.Windows to call all [SecurityCritical] methods
</I>&gt;&gt;&gt;<i> -# 462 methods
</I>&gt;&gt;&gt;<i> +# 464 methods
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>  +SSC-M: System.Void Microsoft.Internal.TextBoxView::.ctor()
</I>&gt;&gt;&gt;<i> ++SSC-M: System.Void Mono.A11yHelper::Initialize()
</I>&gt;&gt;&gt;<i> ++SSC-M: System.Void Mono.A11yHelper::Launch(System.String)
</I>&gt;&gt;&gt;<i>  +SSC-M: Mono.Xaml.ManagedXamlLoader Mono.ApplicationLauncher::CreateXamlLoader(System.IntPtr,System.IntPtr,System.IntPtr,System.String,System.String)
</I>&gt;&gt;&gt;<i>  +SSC-M: System.Void Mono.DispatcherTimer::.ctor()
</I>&gt;&gt;&gt;<i>  +SSC-M: System.Void Mono.EasingFunctionWrapper::ReportException(System.Exception)
</I>&gt;&gt;&gt;<i> Index: class/System.Windows/Assembly/AssemblyInfo.cs
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/System.Windows/Assembly/AssemblyInfo.cs       (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/System.Windows/Assembly/AssemblyInfo.cs       (working copy)
</I>&gt;&gt;&gt;<i> @@ -101,3 +101,6 @@
</I>&gt;&gt;&gt;<i>  [assembly: InternalsVisibleTo (&quot;System.Windows.Browser, PublicKey=002400000480000094000000060200000024000052534131000400000100010079159977d2d03a8e6bea7a2e74e8d1afcc93e8851974952bb480a12c9134474d04062447c37e0e68c080536fcf3c3fbe2ff9c979ce998475e506e8ce82dd5b0f350dc10e93bf2eeecf874b24770c5081dbea7447fddafa277b22de47d6ffea449674a4f9fccf84d15069089380284dbdd35f46cdff12a1bd78e4ef0065d016df&quot;)]
</I>&gt;&gt;&gt;<i>  [assembly: InternalsVisibleTo (&quot;Moonlight.Gtk, PublicKey=002400000480000094000000060200000024000052534131000400001100000005E62DA51722818A2ADC73D5CE64289260012A442031582E808F5C290EF155F10AB93441F92A7A59736D3481245ED4E0E864F5E1ACCADD217D53EE0263E6E3852FE94AB6B708984C6C69BA79F40A0896E1FFF820B7C55D4968C8F41CAE2AABC136B16B8AF83D013946CE190BC03C2A6C8DE8C0CB135ED656F46BF9A2D03E8188&quot;)]
</I>&gt;&gt;&gt;<i>  #endif
</I>&gt;&gt;&gt;<i> +#if MOON_A11Y_INTERNAL_HACK
</I>&gt;&gt;&gt;<i> +[assembly: InternalsVisibleTo (&quot;MoonAtkBridge, PublicKey=00240000048000009400000006020000002400005253413100040000110000004bb98b1af6c1df0df8c02c380e116b7a7f0c8c827aecfccddc6e29b7c754cd608b49dfcef4df9699ad182e50f66afa4e68dabc7b6aeeec0aa4719a5f8e0aae8c193080a706adc3443a8356b1f254142034995532ac176398e12a30f6a74a119a89ac47672c9ae24d7e90de686557166e3b873cd707884431a0451d9d6f7fe795&quot;)]
</I>&gt;&gt;&gt;<i> +#endif
</I>&gt;&gt;&gt;<i> Index: class/System.Windows/System.Windows.mdp
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/System.Windows/System.Windows.mdp     (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/System.Windows/System.Windows.mdp     (working copy)
</I>&gt;&gt;&gt;<i> @@ -18,6 +18,7 @@
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;System.Windows/DependencyObject.g.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;Assembly/MonoTODOAttribute.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;Assembly/AssemblyInfo.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i> +    &lt;File name=&quot;Mono/A11yHelper.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;Mono/DispatcherTimer.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;Mono/EventHandlerList.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;File name=&quot;Mono/Events.cs&quot; subtype=&quot;Code&quot; buildaction=&quot;Compile&quot; /&gt;
</I>&gt;&gt;&gt;<i> @@ -514,4 +515,4 @@
</I>&gt;&gt;&gt;<i>      &lt;ProjectReference type=&quot;Gac&quot; localcopy=&quot;True&quot; refto=&quot;System.Xml, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot; /&gt;
</I>&gt;&gt;&gt;<i>      &lt;ProjectReference type=&quot;Gac&quot; localcopy=&quot;True&quot; refto=&quot;System.Core&quot; /&gt;
</I>&gt;&gt;&gt;<i>    &lt;/References&gt;
</I>&gt;&gt;&gt;<i> -&lt;/Project&gt;
</I>&gt;&gt;&gt;<i> \ No newline at end of file
</I>&gt;&gt;&gt;<i> +&lt;/Project&gt;
</I>&gt;&gt;&gt;<i> Index: class/System.Windows/Mono/A11yHelper.cs
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/System.Windows/Mono/A11yHelper.cs     (revision 0)
</I>&gt;&gt;&gt;<i> +++ class/System.Windows/Mono/A11yHelper.cs     (revision 0)
</I>&gt;&gt;&gt;<i> @@ -0,0 +1,92 @@
</I>&gt;&gt;&gt;<i> +//
</I>&gt;&gt;&gt;<i> +// A11yHelper.cs
</I>&gt;&gt;&gt;<i> +//
</I>&gt;&gt;&gt;<i> +// Contact:
</I>&gt;&gt;&gt;<i> +//   Moonlight List (<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">moonlight-list at lists.ximian.com</A>)
</I>&gt;&gt;&gt;<i> +//
</I>&gt;&gt;&gt;<i> +// Copyright 2009 Novell, Inc.
</I>&gt;&gt;&gt;<i> +//
</I>&gt;&gt;&gt;<i> +// Permission is hereby granted, free of charge, to any person obtaining
</I>&gt;&gt;&gt;<i> +// a copy of this software and associated documentation files (the
</I>&gt;&gt;&gt;<i> +// &quot;Software&quot;), to deal in the Software without restriction, including
</I>&gt;&gt;&gt;<i> +// without limitation the rights to use, copy, modify, merge, publish,
</I>&gt;&gt;&gt;<i> +// distribute, sublicense, and/or sell copies of the Software, and to
</I>&gt;&gt;&gt;<i> +// permit persons to whom the Software is furnished to do so, subject to
</I>&gt;&gt;&gt;<i> +// the following conditions:
</I>&gt;&gt;&gt;<i> +// 
</I>&gt;&gt;&gt;<i> +// The above copyright notice and this permission notice shall be
</I>&gt;&gt;&gt;<i> +// included in all copies or substantial portions of the Software.
</I>&gt;&gt;&gt;<i> +// 
</I>&gt;&gt;&gt;<i> +// THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,
</I>&gt;&gt;&gt;<i> +// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
</I>&gt;&gt;&gt;<i> +// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
</I>&gt;&gt;&gt;<i> +// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
</I>&gt;&gt;&gt;<i> +// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
</I>&gt;&gt;&gt;<i> +// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
</I>&gt;&gt;&gt;<i> +// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</I>&gt;&gt;&gt;<i> +//
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +using System;
</I>&gt;&gt;&gt;<i> +using System.IO;
</I>&gt;&gt;&gt;<i> +using System.Reflection;
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +namespace Mono {
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +       internal static class A11yHelper {
</I>&gt;&gt;&gt;<i> +               
</I>&gt;&gt;&gt;<i> +               private const string BRIDGE_ASM_NAME = &quot;MoonAtkBridge.dll&quot;;
</I>&gt;&gt;&gt;<i> +               private const string BRIDGE_FULL_NAME = &quot;Moonlight.AtkBridge.AutomationBridge&quot;;
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +               internal static void Initialize ()
</I>&gt;&gt;&gt;<i> +               {
</I>&gt;&gt;<i> Please use a:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #ifdef &#65279;MOON_A11Y_INTERNAL_HACK_ENABLED
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> around the code. Note that &quot;make detect&quot; won't see it (for non-a11y
</I>&gt;&gt;<i> developers, so the entry should be moved to the *.manual file).
</I>&gt;<i> 
</I>&gt;<i> Ok, but I guess a better place for this #ifdef is in
</I>&gt;<i> ApplicationLauncher.cs, right?
</I>
No need to answer this, I've figured it out, check out the new patch
attached.


&gt;&gt;&gt;<i> +                       string current_assembly_location = Assembly.GetExecutingAssembly ().Location;
</I>&gt;&gt;&gt;<i> +                       int pos = current_assembly_location.IndexOf (&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">moonlight at novell</A>&quot;);
</I>&gt;&gt;<i> that's need a comment to be &quot;kept in sync&quot; with security.c platform code
</I>&gt;&gt;<i> check.
</I>&gt;<i> 
</I>&gt;<i> Ok.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> +                       if (pos &gt; 0) {
</I>&gt;&gt;&gt;<i> +                               string load_location = Path.Combine (current_assembly_location.Substring (0, pos), &quot;<A HREF="http://lists.ximian.com/mailman/listinfo/moonlight-list">moonlight-a11y at novell.com</A>&quot;);
</I>&gt;&gt;&gt;<i> +                               if (Directory.Exists (load_location)) {
</I>&gt;&gt;&gt;<i> +                                       load_location = Path.Combine (Path.Combine (load_location, &quot;components&quot;), BRIDGE_ASM_NAME);
</I>&gt;&gt;&gt;<i> +                                       Launch (load_location);
</I>&gt;&gt;&gt;<i> +                               }
</I>&gt;&gt;&gt;<i> +                       }
</I>&gt;&gt;&gt;<i> +               }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +               internal static void Launch (string location)
</I>&gt;&gt;<i> will this be called outside of Initialize ? I'd rather not add an extra
</I>&gt;&gt;<i> SSC unless required (e.g. by another caller).
</I>&gt;<i> 
</I>&gt;<i> Good point, I'll add only one attrib to Initialize, not Launch.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> +               {
</I>&gt;&gt;&gt;<i> +                       Assembly bridge_asm;
</I>&gt;&gt;&gt;<i> +                       try {
</I>&gt;&gt;&gt;<i> +                               bridge_asm = Assembly.LoadFrom (location);
</I>&gt;&gt;&gt;<i> +                       } catch (Exception e) {
</I>&gt;&gt;&gt;<i> +                               return;
</I>&gt;&gt;&gt;<i> +                       }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                       bridge_type = bridge_asm.GetType (BRIDGE_FULL_NAME);
</I>&gt;&gt;&gt;<i> +                       if (bridge_type == null)
</I>&gt;&gt;&gt;<i> +                               return;
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                       automation_bridge = bridge_type.GetMethod (
</I>&gt;&gt;&gt;<i> +                               &quot;CreateAutomationBridge&quot;,
</I>&gt;&gt;&gt;<i> +                               BindingFlags.Static | BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.InvokeMethod)
</I>&gt;&gt;<i> is it public or not ? since you're selecting a specific method you
</I>&gt;&gt;<i> should already know this
</I>&gt;<i> 
</I>&gt;<i> It's NonPublic, but I was using this because it let us test with and
</I>&gt;<i> without using Linker steps. I'll update the patch.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> +                               .Invoke (null, null);
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                       accessibilityEnabled = (bool) bridge_type.GetMethod (
</I>&gt;&gt;&gt;<i> +                               &quot;IsAccessibilityEnabled&quot;,
</I>&gt;&gt;&gt;<i> +                               BindingFlags.Static | BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.InvokeMethod)
</I>&gt;&gt;<i> same (public / nonpublic)
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> +                               .Invoke (null, null);
</I>&gt;&gt;&gt;<i> +               }
</I>&gt;&gt;&gt;<i> +               
</I>&gt;&gt;&gt;<i> +               private static Type bridge_type;
</I>&gt;&gt;&gt;<i> +               private static object automation_bridge;
</I>&gt;&gt;&gt;<i> +               private static bool accessibilityEnabled = false;
</I>&gt;&gt;&gt;<i> +               
</I>&gt;&gt;&gt;<i> +               public static IntPtr GetAccessible ()
</I>&gt;&gt;<i> I lack context but is this method likely to be called often ? If is the
</I>&gt;&gt;<i> return value expected to change over the plugin life time ?
</I>&gt;<i> 
</I>&gt;<i> It will be called, by the plugin. But that's a second patch we'll
</I>&gt;<i> propose after this one:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://anonsvn.mono-project.com/viewvc/trunk/uia2atk/MoonAtkBridge/patches/moonlight-a11y-slot-tree.diff?view=markup">http://anonsvn.mono-project.com/viewvc/trunk/uia2atk/MoonAtkBridge/patches/moonlight-a11y-slot-tree.diff?view=markup</A>
</I>&gt;<i> 
</I>
So, the function will be called by Firefox when an AT (a11y client, like
a screen reader) requests any a11y information from the plugin. The
return value can change over the lifetime of the plugin (because more
than 1 moonlight app can live at the same time), but AFAIK if we're
talking about the same app, it won't change, so were you thinking that
we should cache it in a field? It will die when the moonlight app is
disposed.


&gt;&gt;&gt;<i> +               {
</I>&gt;&gt;&gt;<i> +                       if (!accessibilityEnabled || automation_bridge == null)
</I>&gt;&gt;&gt;<i> +                               return IntPtr.Zero;
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i> +                       return (IntPtr) bridge_type.GetMethod (
</I>&gt;&gt;&gt;<i> +                               &quot;GetAccessibleHandle&quot;,
</I>&gt;&gt;&gt;<i> +                               BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.InvokeMethod)
</I>&gt;&gt;<i> &#65279;same (public / nonpublic)
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> +                               .Invoke (automation_bridge, null);
</I>&gt;&gt;&gt;<i> +               }
</I>&gt;&gt;&gt;<i> +       }
</I>&gt;&gt;&gt;<i> +}
</I>&gt;&gt;&gt;<i> Index: class/System.Windows/Mono/ApplicationLauncher.cs
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/System.Windows/Mono/ApplicationLauncher.cs    (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/System.Windows/Mono/ApplicationLauncher.cs    (working copy)
</I>&gt;&gt;&gt;<i> @@ -44,6 +44,11 @@
</I>&gt;&gt;&gt;<i>         /// &lt;/summary&gt;  
</I>&gt;&gt;&gt;<i>         class ApplicationLauncher {
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +               static ApplicationLauncher ()
</I>&gt;&gt;&gt;<i> +               {
</I>&gt;&gt;&gt;<i> +                       A11yHelper.Initialize ();
</I>&gt;&gt;&gt;<i> +               }
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>                 /// &lt;summary&gt;
</I>&gt;&gt;&gt;<i>                 ///   Creates a new Loader for a XAML file.
</I>&gt;&gt;&gt;<i>                 /// &lt;/summary&gt;
</I>&gt;&gt;&gt;<i> Index: class/System.Windows/Makefile.am
</I>&gt;&gt;&gt;<i> ===================================================================
</I>&gt;&gt;&gt;<i> --- class/System.Windows/Makefile.am    (revision 136249)
</I>&gt;&gt;&gt;<i> +++ class/System.Windows/Makefile.am    (working copy)
</I>&gt;&gt;&gt;<i> @@ -19,6 +19,12 @@
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i>  CSCFLAGS = /codepage:65001 -d:SANITY -d:NET_1_1 -d:NET_2_0 -d:MOONLIGHT -debug+ -noconfig -r:System -r:System.Core -r:System.Xml -d:AGCLR -unsafe
</I>&gt;&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> +## this hack will be dropped once we get this working:
</I>&gt;&gt;&gt;<i> +## <A HREF="http://www.mono-project.com/Moonlight/SecurityStatus#Assembly_Loading">http://www.mono-project.com/Moonlight/SecurityStatus#Assembly_Loading</A>
</I>&gt;&gt;&gt;<i> +if MOON_A11Y_INTERNAL_HACK
</I>&gt;&gt;&gt;<i> +CSCFLAGS += -define:MOON_A11Y_INTERNAL_HACK
</I>&gt;&gt;&gt;<i> +endif
</I>&gt;&gt;&gt;<i> +
</I>&gt;&gt;&gt;<i>  GMCS = gmcs $(CSCFLAGS) -lib:../lib/moonlight -d:NET_3_0
</I>&gt;&gt;&gt;<i>  SMCS = MONO_PATH=&quot;../lib/2.1:$$MONO_PATH&quot; mono --runtime=moonlight --security=temporary-smcs-hack ../lib/2.1/smcs.exe -r:System.Net $(CSCFLAGS)
</I>&gt;&gt;&gt;<i>  GACUTIL = gacutil /gacdir $(DESTDIR)$(prefix)/lib /root $(DESTDIR)$(prefix)/lib
</I>&gt;&gt;&gt;<i> @@ -38,6 +44,7 @@
</I>&gt;&gt;&gt;<i>         $(srcdir)/MS.Internal/Dummy.cs  \
</I>&gt;&gt;&gt;<i>         $(srcdir)/System.Windows.Hosting/Dummy.cs       \
</I>&gt;&gt;&gt;<i>         $(srcdir)/System.IO/SimpleUnmanagedMemoryStream.cs                      \
</I>&gt;&gt;&gt;<i> +       $(srcdir)/Mono/A11yHelper.cs                                            \
</I>&gt;&gt;&gt;<i>         $(srcdir)/Mono/ApplicationLauncher.cs                                   \
</I>&gt;&gt;&gt;<i>         $(srcdir)/Mono/DispatcherTimer.cs                                       \
</I>&gt;&gt;&gt;<i>         $(srcdir)/Mono/EasingFunctionWrapper.cs                                 \
</I>&gt;&gt;&gt;<i>
</I>

Thanks,

	Andr&#233;s

-- 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: moonlight-a11y-initialization.diff
Type: text/x-patch
Size: 12628 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/moonlight-list/attachments/20090617/8631ddc7/attachment-0001.bin">http://lists.ximian.com/pipermail/moonlight-list/attachments/20090617/8631ddc7/attachment-0001.bin</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000499.html">[Moonlight-list] [PATCH] MoonAtkBridge initialization
</A></li>
	<LI>Next message: <A HREF="000501.html">[Moonlight-list] [PATCH] MoonAtkBridge initialization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#500">[ date ]</a>
              <a href="thread.html#500">[ thread ]</a>
              <a href="subject.html#500">[ subject ]</a>
              <a href="author.html#500">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
