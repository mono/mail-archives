<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Moonlight-list] force-managed-refs WIP diff
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20force-managed-refs%20WIP%20diff&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001067.html">
   <LINK REL="Next"  HREF="001082.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Moonlight-list] force-managed-refs WIP diff</H1>
    <B>Chris Toshok</B> 
    <A HREF="mailto:moonlight-list%40lists.ximian.com?Subject=%5BMoonlight-list%5D%20force-managed-refs%20WIP%20diff&In-Reply-To="
       TITLE="[Moonlight-list] force-managed-refs WIP diff">toshok at novell.com
       </A><BR>
    <I>Tue Jul  6 16:25:33 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="001067.html">[Moonlight-list] Does Moonlight work with the DLR?
</A></li>
        <LI>Next message: <A HREF="001082.html">[Moonlight-list] Xaml Previewer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1081">[ date ]</a>
              <a href="thread.html#1081">[ thread ]</a>
              <a href="subject.html#1081">[ subject ]</a>
              <a href="author.html#1081">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I didn't do *any* cleanup, I just wanted to get this out so that we could
start talking about it.  I'll see if I can remember the salient bits.


   1. In unmanaged code, EnsureManagedRef is called on all objects which
   have a managed peer defined so that the managed object is created.  To
   ensure this was happening, I made all the ctors protected and made two
   factory classes (MoonUnmanagedFactory and MoonManagedFactory).
   MoonUnmanagedFactory creates the object and calls EnsureManagedRef on it.
   MoonManagedFactory doesn't call EnsureManagedRef, since the call is already
   coming from the managed ctor.  I'm not attached to the factory idea (it was
   mostly just done as an aid to finding ctor usage in unmanaged land).
   2. the managed peers register two delegates with unmanaged (AddStrongRef
   and ClearStrongRef).  these let unmanaged code communicate to managed that
   the managed peer should take out a ref on the given object.  The unmanaged
   code for the most part uses the MOON_SET_FIELD and MOON_CLEAR_FIELD macros,
   since those register a DestroyedEvent handler in unmanaged land to clear the
   pointer when the managed GC destroys the referent.
   3. managed Collections use a CollectionChangedEvent handler to maintain a
   mirror of the unmanaged list.  this means that all read access (either
   random access or using enumerators) happens entirely in managed code.
   4. local and autocreated Values present some wrinkles, in that normally
   the Value would hold a ref to the DO*.  A flag is added telling Value
   whether or not it should unref when destroyed, and we explicitly unref the
   DO* - and call AddStrongRef - when the value is set on a parent DO.
   5. AddStrongRef can receive a name from unmanaged.  This makes it
   possible to store the strong managed ref in instance fields instead of in
   the general dictionary.  Deployment.AddStrongRef does that to maintain its
   Surface property.  This is another example of moving the getter completely
   to managed code - this accessor used to call a pinvoke to get the surface
   reference.

I'm sure there's more.. I'll comment more as I remember (or as questions are
raised :)

chris
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/pipermail/moonlight-list/attachments/20100706/f03db2c6/attachment-0001.html">http://lists.ximian.com/pipermail/moonlight-list/attachments/20100706/f03db2c6/attachment-0001.html</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: ref-diff
Type: application/octet-stream
Size: 255710 bytes
Desc: not available
Url : <A HREF="http://lists.ximian.com/pipermail/moonlight-list/attachments/20100706/f03db2c6/attachment-0001.obj">http://lists.ximian.com/pipermail/moonlight-list/attachments/20100706/f03db2c6/attachment-0001.obj</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001067.html">[Moonlight-list] Does Moonlight work with the DLR?
</A></li>
	<LI>Next message: <A HREF="001082.html">[Moonlight-list] Xaml Previewer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1081">[ date ]</a>
              <a href="thread.html#1081">[ thread ]</a>
              <a href="subject.html#1081">[ subject ]</a>
              <a href="author.html#1081">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/moonlight-list">More information about the Moonlight-list
mailing list</a><br>
</body></html>
