<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] Property Binding Support: Present and Future
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:glade-devel%40lists.ximian.com?Subject=%5BGlade-devel%5D%20Property%20Binding%20Support%3A%20Present%20and%20Future&In-Reply-To=1316280750.5639.140.camel%40ragamuffin">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001908.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] Property Binding Support: Present and Future</H1>
    <B>Denis Washington</B> 
    <A HREF="mailto:glade-devel%40lists.ximian.com?Subject=%5BGlade-devel%5D%20Property%20Binding%20Support%3A%20Present%20and%20Future&In-Reply-To=1316280750.5639.140.camel%40ragamuffin"
       TITLE="[Glade-devel] Property Binding Support: Present and Future">denisw at online.de
       </A><BR>
    <I>Thu Sep 22 05:50:04 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001908.html">[Glade-devel] Property Binding Support: Present and Future
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1909">[ date ]</a>
              <a href="thread.html#1909">[ thread ]</a>
              <a href="subject.html#1909">[ subject ]</a>
              <a href="author.html#1909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am 17.09.2011 19:32, schrieb Tristan Van Berkom:
&gt;<i> Hi Denis,
</I>&gt;<i>     Sorry it took me a while to get back to you, I just got back to
</I>&gt;<i> montreal and should have a little time...
</I>
No problem. Thanks for the comments!

&gt;<i>
</I>&gt;<i> On Thu, 2011-09-01 at 09:58 +0200, Denis Washington wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As you may know, I took part in Google Summer of Code this year (thanks
</I>&gt;&gt;<i> to Juan for mentoring me!) and worked on &quot;GObject property binding
</I>&gt;&gt;<i> support for GtkBuilder and Glade&quot;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://live.gnome.org/DenisWashington_GtkBuilder">https://live.gnome.org/DenisWashington_GtkBuilder</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> While talking on IRC with Tristan yesterday, I realized that while I
</I>&gt;&gt;<i> sent out weekly reports to gnome-soc-list and blogged about my work
</I>&gt;&gt;<i> twice, I never actually wrote anything about the code's status or
</I>&gt;&gt;<i> technical details on this mailing list. I would like to apologize for my
</I>&gt;&gt;<i> failure to do so and will try to make up for it by telling you
</I>&gt;&gt;<i> *everything* in this message: what I have done, how I have done it, what
</I>&gt;&gt;<i> works now, where the remaining problems are, and how these issues could
</I>&gt;&gt;<i> be overcome (this is where I really need your feedback!).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For those who don't know, the objective of my work is to extend Glade
</I>&gt;&gt;<i> with support for creating bindings between widget properties in a
</I>&gt;&gt;<i> project. What this means is that you can define a property's value as
</I>&gt;&gt;<i> being directly dependent on the value of another property - whenever the
</I>&gt;&gt;<i> &quot;source&quot; property's value is set, the value of the &quot;target&quot; property is
</I>&gt;&gt;<i> automatically updated, either to the same value or a user-defined
</I>&gt;&gt;<i> transformation thereof (more on this later). GLib supports this through
</I>&gt;&gt;<i> its GBinding API [1]. The goal is to expose this functionality in Glade
</I>&gt;&gt;<i> so that the user can create, modify and delete property bindings in
</I>&gt;&gt;<i> Glade and save them as part of a UI file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This feature requires changes to both GTK+ and Glade, so I created
</I>&gt;&gt;<i> git.gnome.org branches for both of them, named &quot;gtkbuilder-gbinding&quot; and
</I>&gt;&gt;<i> &quot;gbinding&quot;, respectively [2][3]. The GTK+ branch adds support for a new
</I>&gt;&gt;<i> bit of GtkBuilder syntax - the&lt;binding&gt;  element - which makes it
</I>&gt;&gt;<i> possible for GtkBuilder objects to read property bindings from UI files.
</I>&gt;&gt;<i> It is used like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &lt;object name=&quot;button&quot;&gt;
</I>&gt;&gt;<i>       ...
</I>&gt;&gt;<i>       &lt;binding to=&quot;sensitive&quot; from=&quot;active&quot; source=&quot;checkbutton&quot;/&gt;
</I>&gt;&gt;<i>     &lt;/object&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> which means: &quot;Let the 'sensitive' property of 'button' always have the
</I>&gt;&gt;<i> same value as the 'active' property of 'checkbutton'.&quot; Thanks to the
</I>&gt;&gt;<i> existence of GBinding, the code changes required for this are pretty
</I>&gt;&gt;<i> small. No new API is introduced; all bindings are automatically created
</I>&gt;&gt;<i> at the time they are read in by gtk_builder_add_from*(). (But this might
</I>&gt;&gt;<i> change slightly; see the problem discussion later in this epic mail
</I>&gt;&gt;<i> message).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The &quot;gbinding&quot; Glade branch is where the bulk of my work happened. It
</I>&gt;&gt;<i> adds a new &quot;binding-source&quot; property to GladeProperty for representing
</I>&gt;&gt;<i> property bindings in the data model and supports serialization and
</I>&gt;&gt;<i> deserialization of this information to&lt;binding&gt;  elements. (See
</I>&gt;&gt;<i> glade_property_binding_read() and glade_property_binding_write() in
</I>&gt;&gt;<i> glade-property.c, respectively.) Furthermore, it augments Glade's
</I>&gt;&gt;<i> undo/redo framework with a glade_command_bind_property() command for
</I>&gt;&gt;<i> creating and deleting property bindings. On the UI side, this command is
</I>&gt;&gt;<i> exposed through a &quot;Bind to source...&quot; context menu item in the property
</I>&gt;&gt;<i> inspector. (For screenshots of how the UI currently looks, see my blog
</I>&gt;&gt;<i> posts [4][5].)
</I>&gt;<i>
</I>&gt;<i> The dialog is nice enough in general, I think it needs to expose the
</I>&gt;<i> real untranslated property name as well, perhaps with the translated
</I>&gt;<i> name in italic/grey beside it. It would even be interesting to include
</I>&gt;<i> the proper class name introducing that property in the list.
</I>&gt;<i>
</I>&gt;<i> i.e.:
</I>&gt;<i>
</I>&gt;<i>    GtkWidget:tooltip-text   /Tooltip Text/
</I>&gt;<i>    GtkEntry:text            /Text/
</I>&gt;<i>
</I>&gt;<i> (its nice to have the translated titles around, but it's usually
</I>&gt;<i> more important to show something untranslated and informative here).
</I>
I used the translated names because these are what the property 
inspector shows, so it would be arguably inconsistent if we highlighted 
the internal property names as the primary identification means. I think 
better would be:

     Tooltip Text    /GtkWidget:tooltip-text/

&gt;&gt;<i> The UI and data model has been adapted to reflect the defined property
</I>&gt;&gt;<i> bindings:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - glade_command_set_property() was modified to recursively set the value
</I>&gt;&gt;<i> of all properties bound to the originally set property. This means that
</I>&gt;&gt;<i> the effect of a property binding is immediately visible in the Glade
</I>&gt;&gt;<i> workspace.
</I>&gt;<i>
</I>&gt;<i> It sounds like a nice feature but I'm not sure it's the right place.
</I>&gt;<i>
</I>&gt;<i> Perhaps the implementation of glade_property_sync() would be a better
</I>&gt;<i> location for this.
</I>
I chose this location so that all property set operations are recorded 
in the command system (grouped with the original set command, 
naturally), which makes undo trivial.

&gt;<i> Which also brings to mind, there should be some protection to avoid
</I>&gt;<i> circular references and feedback loops which could be easily introduced
</I>&gt;<i> by using bindings, perhaps Glade should simply allow the user to create
</I>&gt;<i> dangerous documents and forcefully avoid feedback internally, or just
</I>&gt;<i> refuse to create circular loops all together (not such a bad limitation
</I>&gt;<i> at first thought...).
</I>
I think prohibit cycles, we would need to provide explicit support for 
two-way bindings (such as offered by a g_object_bind_property() flag) to 
retain the whole power, but this probably wouldn't be worth the 
complication in the code.

I don't know how well GBinding handles cycles currently. It would be 
best if we could avoid infinite loops on that level (e.g. by suspending 
the binding while syncing the target's value to the source, so that a 
resulting update of the source itself doesn't trigger a new sync), but 
I'm not sure how feasible that is.

&gt;&gt;<i> - In the property inspector, the edit widgets for bound properties are
</I>&gt;&gt;<i> insensitive (setting the value of a bound property doesn't make much
</I>&gt;&gt;<i> sense). Also, the tooltip of a bound property shows which other property
</I>&gt;&gt;<i> it is bound to.
</I>&gt;&gt;<i> (See glade-editor-property.c)
</I>&gt;<i>
</I>&gt;<i> If I understand correctly, you are updating property sensitivity
</I>&gt;<i> directly based on whether a property is bound or not, this will
</I>&gt;<i> probably fail in some conditions as the backend is responsible
</I>&gt;<i> currently for updating state.
</I>&gt;<i>
</I>&gt;<i> If for instance, you bind the &quot;label&quot; property of a GtkButton
</I>&gt;<i> and then set the button to be &quot;custom content&quot; or such (using
</I>&gt;<i> the radio buttons in the button editor), then undo... will the
</I>&gt;<i> tooltip of the insensitive &quot;label&quot; property be correct ?
</I>
I don't set the sensitivity in the sense of 
glade_property_set_sensitive(). Rather, I just control the sensitivity 
of the associated GladeEditorProperty in 
glade_editor_property_sensitivity_cb(). Thus, the example you described 
works correctly.

&gt;&gt;<i> Also, I made some precautions to avoid invalid property bindings:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - The &quot;Bind to source...&quot; dialog for choosing the source of a property
</I>&gt;&gt;<i> binding only allows you to select properties that have the same, or a
</I>&gt;&gt;<i> compatible, type, and are enabled (if they are optional) and sensitive
</I>&gt;&gt;<i> (if there are one of multiple alternative properties, e.g. &quot;text&quot;,
</I>&gt;&gt;<i> &quot;stock&quot; and &quot;embedded widget&quot; in GtkButton). All other properties are
</I>&gt;&gt;<i> greyed out and moved to the end of the list.
</I>&gt;&gt;<i> (See glade_editor_property_show_bind_dialog() and its helper functions
</I>&gt;&gt;<i> in glade-editor-property.c)
</I>&gt;<i>
</I>&gt;<i> Right, this should at least take care of possible runtime warnings.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - If the source or target of a property binding disappears because the
</I>&gt;&gt;<i> widget it belongs to is deleted, the binding is automatically removed
</I>&gt;&gt;<i> too. This is properly integrated into the undo/redo system, so undoing
</I>&gt;&gt;<i> the widget removal also brings the property binding back.
</I>&gt;&gt;<i> (See glade_command_delete_binding_refs() in glade-command.c)
</I>&gt;<i>
</I>&gt;<i> Will have to eventually review that in detail, but sounds like the
</I>&gt;<i> right approach there.
</I>&gt;<i>
</I>&gt;&gt;<i> One remaining issue with the current code is that it does not react to
</I>&gt;&gt;<i> property binding sources becoming disabled or insensitive. This is
</I>&gt;&gt;<i> currently not possible in a sane way as changes to a property's
</I>&gt;&gt;<i> enabled/sensitivity state are not tracked with the undo/redo framework
</I>&gt;&gt;<i> at the moment. (I had code to do this in the branch before, but it
</I>&gt;&gt;<i> worked with manual signal handling hackery and was removed later on
</I>&gt;&gt;<i> Tristan's request.) The obvious solution would be to change this by
</I>&gt;&gt;<i> introducing glade_command_set_property_enabled() and
</I>&gt;&gt;<i> glade_command_set_property_sensitive() and porting all of Glade to that.
</I>&gt;&gt;<i> If there is general agreement to do so, I would be willing to do that
</I>&gt;&gt;<i> work. In any case, this has to be fixed in some way before the branch is
</I>&gt;&gt;<i> ready to be merged into master.
</I>&gt;<i>
</I>&gt;<i> Those are the blockers for this integration.
</I>&gt;<i>
</I>&gt;<i> Porting that will take time and effort though, take a look at
</I>&gt;<i> glade-gtk.c and note how sensitivity is generally driven, all of
</I>&gt;<i> that needs to be ported to control sensitivity while updating
</I>&gt;<i> property values at the editor level (that is, things now belong
</I>&gt;<i> on the 'calling' side of GladeCommand instead of the other,
</I>&gt;<i> 'data model' side).
</I>
I will look into that.

&gt;<i> This might mean extending GladeEditorProperty api to give the
</I>&gt;<i> widget class adaptor code easy control on when to control
</I>&gt;<i> sensitivity (the pre/post-commit signals sound like the right
</I>&gt;<i> place to couple in sensitivity commands with property commands).
</I>&gt;<i>
</I>&gt;<i> It's also important that sensitivity cannot be controlled alone
</I>&gt;<i> in a single command... because commands usually should represent
</I>&gt;<i> an action taken in the document (a document is dirty after executing
</I>&gt;<i> any command).
</I>
What about enabling/disabling? Does that invoke &quot;set property&quot; commands 
currently?

&gt;&gt;<i> Other than that, I don't know of any other major showstoppers, but an
</I>&gt;&gt;<i> extensive code review by Juan and Tristan might very well reveal some. ;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The big question, however, it how to support transformation functions
</I>&gt;&gt;<i> for property bindings. This GBinding feature allows you to define a
</I>&gt;&gt;<i> function that processes the value of a binding's source property before
</I>&gt;&gt;<i> it is applied to the target, which allows you to create bindings between
</I>&gt;&gt;<i> properties of different types and generally make property bindings much
</I>&gt;&gt;<i> more useful and interesting. Adding this into the GTK+ and Glade
</I>&gt;&gt;<i> branches is not a big problem in principle, and in fact I did just that
</I>&gt;&gt;<i> during Summer of Code. However, I had to later remove the code again,
</I>&gt;&gt;<i> the reason being on the GTK+/GLib side.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is when and how to resolve the transformation function names
</I>&gt;&gt;<i> that would be stored in the GtkBuilder file to the actual function
</I>&gt;&gt;<i> implementations. In my code, I moved all property binding creation to
</I>&gt;&gt;<i> two new API functions, gtk_builder_create_bindings() and
</I>&gt;&gt;<i> gtk_builder_create_bindings_full(), which take the same arguments as
</I>&gt;&gt;<i> gtk_builder_connect_signals*() and locate transformation functions the
</I>&gt;&gt;<i> same way (GModule or a custom callback, called GtkBuilderBindingFunc).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unfortunately, this setup means more work for language binding authors:
</I>&gt;&gt;<i> because transformation functions are specified as an argument to
</I>&gt;&gt;<i> g_object_bind_property_full() rather than by connecting a signal, a
</I>&gt;&gt;<i> language-specific GtkBuilderConnectFunc for
</I>&gt;&gt;<i> gtk_builder_connect_signals*() cannot be reused and each language
</I>&gt;&gt;<i> binding would be required to provide a GtkBuilderBindingFunc to replace
</I>&gt;&gt;<i> the use of GModule with something appropriate for the language. Also,
</I>&gt;&gt;<i> the introduction of another function to be called for every loaded
</I>&gt;&gt;<i> GtkBuilder function is really not ideal.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Talking with Juan and Tristan, we concluded that a proper solution
</I>&gt;&gt;<i> probably requires changes to GBinding itself. More specifically, if
</I>&gt;&gt;<i> GBinding implemented the transformation function as being the handler of
</I>&gt;&gt;<i> a &quot;transform&quot; signal instead of an anonymous callback, one could reuse
</I>&gt;&gt;<i> gtk_builder_connect_signals*() to locate transformation functions and
</I>&gt;&gt;<i> move property binding creation there. For backwards compatibility and
</I>&gt;&gt;<i> convenience, the g_object_bind_property() API could still stay as it is
</I>&gt;&gt;<i> now. There would be some issues to sort out - for instance, how to
</I>&gt;&gt;<i> behave if multiple signal handlers are connected to the &quot;transform&quot;
</I>&gt;&gt;<i> signal - but it might be doable without breaking anything. This still
</I>&gt;&gt;<i> needs to be talked about with both the GLib and GTK+ team, though.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For reference, you can still find my code with transformation function
</I>&gt;&gt;<i> support in the &quot;gtkbuilder-gbinding&quot; GTK+ and &quot;gbinding-transform&quot; Glade
</I>&gt;&gt;<i> branch.
</I>&gt;<i>
</I>&gt;<i> I don't want to discuss transformation functions in depth until
</I>&gt;<i> finished landing this code in GTK+/Glade.
</I>&gt;<i>
</I>&gt;<i> If transformation functions are implemented at a later date, they should
</I>&gt;<i> use similar semantics as signals, actually reading the code at this
</I>&gt;<i> moment I don't see any reason why the normal GtkBuilderConnectFunc
</I>&gt;<i> couldnt be used by the GtkBuilder during gtk_builder_connect_signals()
</I>&gt;<i> to resolve any gbinding transform function signals.
</I>
*If* we have a GBinding transformation function facility based on 
function, naturally, GtkBuilderConnectFunc is just fine. My comment 
about it unsuitability was based on the assumption that GBinding is like 
it is now, with transformation functions having to be specified on 
g_object_bind_property().

&gt;<i> So *when* we look into this, my vague proposal runs like this:
</I>&gt;<i>    a.) Introduce &quot;transform&quot; signals on GBinding object and
</I>&gt;<i>        probably prefer the signal (the default handler falls
</I>&gt;<i>        back on invoking any registered transform function for
</I>&gt;<i>        backwards compatibility and then defaults to usual GValue
</I>&gt;<i>        transforms and copies).
</I>&gt;<i>
</I>&gt;<i>    b.) Extend GtkBuilder binding parsing slightly to allow specification
</I>&gt;<i>        of a transform function... collect the GBinding objects and
</I>&gt;<i>        transform function data during the parse and cache them for use
</I>&gt;<i>        in gtk_builder_connect_signals() (possibly even in the same cache
</I>&gt;<i>        as the actual&lt;signals&gt;).
</I>&gt;<i>
</I>&gt;<i>    c.) Connect the transform signal callbacks later in the normal way
</I>&gt;<i>        from gtk_builder_connect_signals()
</I>
This assumes that GValue provides default conversions between all pairs 
of types. Is this the case? If not, creating the property bindings first 
and adding transformation functions later won't work. Assuming that 
GValue does handle all of this, however, this seems like a good plan.

&gt;<i> This will imply an api extension in GtkBuilder, so when it gets
</I>&gt;<i> introduced in GTK+ Glade will need to be careful not to register
</I>&gt;<i> transform functions for projects targeting a too old version of GTK+.
</I>&gt;<i>
</I>&gt;<i> Which leads me to another observation, the binding feature itself
</I>&gt;<i> should not be available of the project is targeting&lt;  GTK+ 3.2
</I>&gt;<i> (or whatever GTK+ version we get the feature into).
</I>
True.

&gt;&gt;<i> Well, this is all there is to say about the code now. (This mail is
</I>&gt;&gt;<i> already way too long as it is. ;) I hope you now have a better insight
</I>&gt;&gt;<i> wrt what I have done during GSoC and what is still to do.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As I wrote in the beginning, I need your feedback! If you have any
</I>&gt;&gt;<i> questions, remarks, or suggestions regarding the issues I outlined -
</I>&gt;&gt;<i> especially regarding the transformation function situation - I would be
</I>&gt;&gt;<i> excited to hear them! Thanks. :)
</I>&gt;<i>
</I>&gt;<i> Thanks a lot for the great effort done this year.
</I>
Thanks for your guidance.

&gt;<i> Again, sorry for taking so long to give you some attention.
</I>
No problem. :)

Regards,
Denis
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001908.html">[Glade-devel] Property Binding Support: Present and Future
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1909">[ date ]</a>
              <a href="thread.html#1909">[ thread ]</a>
              <a href="subject.html#1909">[ subject ]</a>
              <a href="author.html#1909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/glade-devel">More information about the Glade-devel
mailing list</a><br>
</body></html>
