<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] Property Binding Support: Present and Future
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:glade-devel%40lists.ximian.com?Subject=%5BGlade-devel%5D%20Property%20Binding%20Support%3A%20Present%20and%20Future&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="001903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] Property Binding Support: Present and Future</H1>
    <B>Denis Washington</B> 
    <A HREF="mailto:glade-devel%40lists.ximian.com?Subject=%5BGlade-devel%5D%20Property%20Binding%20Support%3A%20Present%20and%20Future&In-Reply-To="
       TITLE="[Glade-devel] Property Binding Support: Present and Future">denisw at online.de
       </A><BR>
    <I>Thu Sep  1 03:58:53 EDT 2011</I>
    <P><UL>
        
        <LI>Next message: <A HREF="001903.html">[Glade-devel] Property Binding Support: Present and Future
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1902">[ date ]</a>
              <a href="thread.html#1902">[ thread ]</a>
              <a href="subject.html#1902">[ subject ]</a>
              <a href="author.html#1902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

As you may know, I took part in Google Summer of Code this year (thanks 
to Juan for mentoring me!) and worked on &quot;GObject property binding 
support for GtkBuilder and Glade&quot;:

<A HREF="https://live.gnome.org/DenisWashington_GtkBuilder">https://live.gnome.org/DenisWashington_GtkBuilder</A>

While talking on IRC with Tristan yesterday, I realized that while I 
sent out weekly reports to gnome-soc-list and blogged about my work 
twice, I never actually wrote anything about the code's status or 
technical details on this mailing list. I would like to apologize for my 
failure to do so and will try to make up for it by telling you 
*everything* in this message: what I have done, how I have done it, what 
works now, where the remaining problems are, and how these issues could 
be overcome (this is where I really need your feedback!).

For those who don't know, the objective of my work is to extend Glade 
with support for creating bindings between widget properties in a 
project. What this means is that you can define a property's value as 
being directly dependent on the value of another property - whenever the 
&quot;source&quot; property's value is set, the value of the &quot;target&quot; property is 
automatically updated, either to the same value or a user-defined 
transformation thereof (more on this later). GLib supports this through 
its GBinding API [1]. The goal is to expose this functionality in Glade 
so that the user can create, modify and delete property bindings in 
Glade and save them as part of a UI file.

This feature requires changes to both GTK+ and Glade, so I created 
git.gnome.org branches for both of them, named &quot;gtkbuilder-gbinding&quot; and 
&quot;gbinding&quot;, respectively [2][3]. The GTK+ branch adds support for a new 
bit of GtkBuilder syntax - the &lt;binding&gt; element - which makes it 
possible for GtkBuilder objects to read property bindings from UI files. 
It is used like this:

   &lt;object name=&quot;button&quot;&gt;
     ...
     &lt;binding to=&quot;sensitive&quot; from=&quot;active&quot; source=&quot;checkbutton&quot;/&gt;
   &lt;/object&gt;

which means: &quot;Let the 'sensitive' property of 'button' always have the 
same value as the 'active' property of 'checkbutton'.&quot; Thanks to the 
existence of GBinding, the code changes required for this are pretty 
small. No new API is introduced; all bindings are automatically created 
at the time they are read in by gtk_builder_add_from*(). (But this might 
change slightly; see the problem discussion later in this epic mail 
message).

The &quot;gbinding&quot; Glade branch is where the bulk of my work happened. It 
adds a new &quot;binding-source&quot; property to GladeProperty for representing 
property bindings in the data model and supports serialization and 
deserialization of this information to &lt;binding&gt; elements. (See 
glade_property_binding_read() and glade_property_binding_write() in 
glade-property.c, respectively.) Furthermore, it augments Glade's 
undo/redo framework with a glade_command_bind_property() command for 
creating and deleting property bindings. On the UI side, this command is 
exposed through a &quot;Bind to source...&quot; context menu item in the property 
inspector. (For screenshots of how the UI currently looks, see my blog 
posts [4][5].)

The UI and data model has been adapted to reflect the defined property 
bindings:

- glade_command_set_property() was modified to recursively set the value 
of all properties bound to the originally set property. This means that 
the effect of a property binding is immediately visible in the Glade 
workspace.

- In the property inspector, the edit widgets for bound properties are 
insensitive (setting the value of a bound property doesn't make much 
sense). Also, the tooltip of a bound property shows which other property 
it is bound to.
(See glade-editor-property.c)

Also, I made some precautions to avoid invalid property bindings:

- The &quot;Bind to source...&quot; dialog for choosing the source of a property 
binding only allows you to select properties that have the same, or a 
compatible, type, and are enabled (if they are optional) and sensitive 
(if there are one of multiple alternative properties, e.g. &quot;text&quot;, 
&quot;stock&quot; and &quot;embedded widget&quot; in GtkButton). All other properties are 
greyed out and moved to the end of the list.
(See glade_editor_property_show_bind_dialog() and its helper functions 
in glade-editor-property.c)

- If the source or target of a property binding disappears because the 
widget it belongs to is deleted, the binding is automatically removed 
too. This is properly integrated into the undo/redo system, so undoing 
the widget removal also brings the property binding back.
(See glade_command_delete_binding_refs() in glade-command.c)

One remaining issue with the current code is that it does not react to 
property binding sources becoming disabled or insensitive. This is 
currently not possible in a sane way as changes to a property's 
enabled/sensitivity state are not tracked with the undo/redo framework 
at the moment. (I had code to do this in the branch before, but it 
worked with manual signal handling hackery and was removed later on 
Tristan's request.) The obvious solution would be to change this by 
introducing glade_command_set_property_enabled() and 
glade_command_set_property_sensitive() and porting all of Glade to that. 
If there is general agreement to do so, I would be willing to do that 
work. In any case, this has to be fixed in some way before the branch is 
ready to be merged into master.

Other than that, I don't know of any other major showstoppers, but an 
extensive code review by Juan and Tristan might very well reveal some. ;)

The big question, however, it how to support transformation functions 
for property bindings. This GBinding feature allows you to define a 
function that processes the value of a binding's source property before 
it is applied to the target, which allows you to create bindings between 
properties of different types and generally make property bindings much 
more useful and interesting. Adding this into the GTK+ and Glade 
branches is not a big problem in principle, and in fact I did just that 
during Summer of Code. However, I had to later remove the code again, 
the reason being on the GTK+/GLib side.

The problem is when and how to resolve the transformation function names 
that would be stored in the GtkBuilder file to the actual function 
implementations. In my code, I moved all property binding creation to 
two new API functions, gtk_builder_create_bindings() and 
gtk_builder_create_bindings_full(), which take the same arguments as 
gtk_builder_connect_signals*() and locate transformation functions the 
same way (GModule or a custom callback, called GtkBuilderBindingFunc).

Unfortunately, this setup means more work for language binding authors: 
because transformation functions are specified as an argument to 
g_object_bind_property_full() rather than by connecting a signal, a 
language-specific GtkBuilderConnectFunc for 
gtk_builder_connect_signals*() cannot be reused and each language 
binding would be required to provide a GtkBuilderBindingFunc to replace 
the use of GModule with something appropriate for the language. Also, 
the introduction of another function to be called for every loaded 
GtkBuilder function is really not ideal.

Talking with Juan and Tristan, we concluded that a proper solution 
probably requires changes to GBinding itself. More specifically, if 
GBinding implemented the transformation function as being the handler of 
a &quot;transform&quot; signal instead of an anonymous callback, one could reuse 
gtk_builder_connect_signals*() to locate transformation functions and 
move property binding creation there. For backwards compatibility and 
convenience, the g_object_bind_property() API could still stay as it is 
now. There would be some issues to sort out - for instance, how to 
behave if multiple signal handlers are connected to the &quot;transform&quot; 
signal - but it might be doable without breaking anything. This still 
needs to be talked about with both the GLib and GTK+ team, though.

For reference, you can still find my code with transformation function 
support in the &quot;gtkbuilder-gbinding&quot; GTK+ and &quot;gbinding-transform&quot; Glade 
branch.

Well, this is all there is to say about the code now. (This mail is 
already way too long as it is. ;) I hope you now have a better insight 
wrt what I have done during GSoC and what is still to do.

As I wrote in the beginning, I need your feedback! If you have any 
questions, remarks, or suggestions regarding the issues I outlined - 
especially regarding the transformation function situation - I would be 
excited to hear them! Thanks. :)

Regards,
Denis

[1] <A HREF="http://developer.gnome.org/gobject/unstable/GBinding.html">http://developer.gnome.org/gobject/unstable/GBinding.html</A>
[2] <A HREF="http://git.gnome.org/browse/gtk+/log/?h=gtkbuilder-gbinding">http://git.gnome.org/browse/gtk+/log/?h=gtkbuilder-gbinding</A>
[3] <A HREF="http://git.gnome.org/browse/glade/log/?h=gbinding">http://git.gnome.org/browse/glade/log/?h=gbinding</A>
[4] 
<A HREF="http://denwash.wordpress.com/2011/06/10/glade-and-property-binding-finally-something-to-see/">http://denwash.wordpress.com/2011/06/10/glade-and-property-binding-finally-something-to-see/</A>
[5] 
<A HREF="http://denwash.wordpress.com/2011/07/20/glade-and-property-binding-create-your-own-bindings-now/">http://denwash.wordpress.com/2011/07/20/glade-and-property-binding-create-your-own-bindings-now/</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="001903.html">[Glade-devel] Property Binding Support: Present and Future
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1902">[ date ]</a>
              <a href="thread.html#1902">[ thread ]</a>
              <a href="subject.html#1902">[ subject ]</a>
              <a href="author.html#1902">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/glade-devel">More information about the Glade-devel
mailing list</a><br>
</body></html>
