<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] [PATCH 2/4] Backport	2fcad158ebafce63eeccfbfc7756ed6c69d91c3c.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:glade-devel%40lists.ximian.com?Subject=Re%3A%20%5BGlade-devel%5D%20%5BPATCH%202/4%5D%20Backport%0A%092fcad158ebafce63eeccfbfc7756ed6c69d91c3c.&In-Reply-To=%3C1398279168-19912-3-git-send-email-kugel%40rockbox.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002057.html">
   <LINK REL="Next"  HREF="002055.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] [PATCH 2/4] Backport	2fcad158ebafce63eeccfbfc7756ed6c69d91c3c.</H1>
    <B>kugel at rockbox.org</B> 
    <A HREF="mailto:glade-devel%40lists.ximian.com?Subject=Re%3A%20%5BGlade-devel%5D%20%5BPATCH%202/4%5D%20Backport%0A%092fcad158ebafce63eeccfbfc7756ed6c69d91c3c.&In-Reply-To=%3C1398279168-19912-3-git-send-email-kugel%40rockbox.org%3E"
       TITLE="[Glade-devel] [PATCH 2/4] Backport	2fcad158ebafce63eeccfbfc7756ed6c69d91c3c.">kugel at rockbox.org
       </A><BR>
    <I>Wed Apr 23 18:52:46 UTC 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="002057.html">[Glade-devel] [PATCH 0/4] Backport topological sorting algorithm to	3.8 branch
</A></li>
        <LI>Next message: <A HREF="002055.html">[Glade-devel] [PATCH 3/4] Backport	56f47169dc09cfd6ed13a24cb9752050ecb66d6f.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2058">[ date ]</a>
              <a href="thread.html#2058">[ thread ]</a>
              <a href="subject.html#2058">[ subject ]</a>
              <a href="author.html#2058">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>From: Juan Pablo Ugarte &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/glade-devel">juanpablougarte at gmail.com</A>&gt;

_glade_tsort() simplyfied api by using a GList for edges instead of a
custom linked struct since we do not need the marginal speedup
now that dependencies are only between toplevels.
This allow us to easily sort edges alphabetically.

tests/toplevel-order: Updated to new _glade_tsort() api

Conflicts:
	tests/toplevel-order.c
	tests/toplevel_order_test6.glade
---
 gladeui/glade-tsort.c | 62 ++++++++++++++++++++++++++-------------------------
 gladeui/glade-tsort.h | 13 +++++------
 2 files changed, 38 insertions(+), 37 deletions(-)

diff --git a/gladeui/glade-tsort.c b/gladeui/glade-tsort.c
index 439da33..5d43f70 100644
--- a/gladeui/glade-tsort.c
+++ b/gladeui/glade-tsort.c
@@ -34,8 +34,8 @@
  * 
  * Returns: the new start of the node list.
  */
-_NodeEdge *
-_node_edge_prepend  (_NodeEdge *node,
+GList *
+_node_edge_prepend  (GList *list,
                      gpointer predecessor,
                      gpointer successor)
 {
@@ -43,34 +43,44 @@ _node_edge_prepend  (_NodeEdge *node,
 
   edge-&gt;predecessor = predecessor;
   edge-&gt;successor = successor;
-  edge-&gt;next = node;
   
-  return edge;
+  return g_list_prepend (list, edge);
+}
+
+static void
+_node_edge_free (gpointer data)
+{
+  g_slice_free (_NodeEdge, data);
 }
 
 void
-_node_edge_free (_NodeEdge *node)
+_node_edge_list_free (GList *list)
 {
-  g_slice_free_chain (_NodeEdge, node, next);
+  g_list_free_full (list, _node_edge_free);
 }
 
 static inline void
-tsort_remove_non_start_nodes (GList **nodes, _NodeEdge *edges)
+tsort_remove_non_start_nodes (GList **nodes, GList *edges)
 {
-  _NodeEdge *edge;
+  GList *l;
 
-  for (edge = edges; edge; edge = edge-&gt;next)
-    *nodes = g_list_remove (*nodes, edge-&gt;successor);
+  for (l = edges; l; l = g_list_next (l))
+    {
+      _NodeEdge *edge = l-&gt;data;
+      *nodes = g_list_remove (*nodes, edge-&gt;successor);
+    }
 }
 
 
 static inline gboolean
-tsort_node_has_no_incoming_edge (gpointer node, _NodeEdge *edges)
+tsort_node_has_no_incoming_edge (gpointer node, GList *edges)
 {
-  _NodeEdge *edge;
+  GList *l;
 
-  for (edge = edges; edge; edge = edge-&gt;next)
+  for (l = edges; l; l = g_list_next (l))
     {
+      _NodeEdge *edge = l-&gt;data;
+
       if (node == edge-&gt;successor)
         return FALSE;
     }
@@ -106,7 +116,7 @@ tsort_node_has_no_incoming_edge (gpointer node, _NodeEdge *edges)
  * Returns: a new list sorted by dependency including nodes only present in @edges
  */
 GList *
-_glade_tsort (GList **nodes, _NodeEdge **edges)
+_glade_tsort (GList **nodes, GList **edges)
 {
   GList *sorted_nodes;
 
@@ -119,7 +129,7 @@ _glade_tsort (GList **nodes, _NodeEdge **edges)
   /* while S is non-empty do */
   while (*nodes)
     {
-      _NodeEdge *edge, *next, *prev = NULL;
+      GList *l, *next;
       gpointer n;
 
       /* remove a node n from S */
@@ -128,23 +138,20 @@ _glade_tsort (GList **nodes, _NodeEdge **edges)
 
       /* insert n into L */
       /*if (!glade_widget_get_parent (n)) this would be a specific optimization */
-        sorted_nodes = g_list_prepend (sorted_nodes, n);
+      sorted_nodes = g_list_prepend (sorted_nodes, n);
 
       /* for each node m ... */
-      for (edge = *edges; edge; edge = next)
+      for (l = *edges; l; l = next)
         {
-          next = edge-&gt;next;
+          _NodeEdge *edge = l-&gt;data;
+
+          next = g_list_next (l);
 
           /* ... with an edge e from n to m do */
           if (edge-&gt;predecessor == n)
             {
               /* remove edge e from the graph */
-              if (prev)
-                prev-&gt;next = (prev-&gt;next) ? prev-&gt;next-&gt;next : NULL;
-              else
-                /* edge is the first element in the list so we only need to
-                 * change the start of the list */
-                *edges = next;
+              *edges = g_list_delete_link (*edges, l);
 
               /* if m has no other incoming edges then */
               if (tsort_node_has_no_incoming_edge (edge-&gt;successor, *edges))
@@ -153,11 +160,6 @@ _glade_tsort (GList **nodes, _NodeEdge **edges)
               
               g_slice_free (_NodeEdge, edge);
             }
-          else
-            /* Keep a pointer to the previous node in the iteration to make
-             * things easier when removing a node
-             */
-            prev = edge;
         }
     }
 
@@ -166,7 +168,7 @@ _glade_tsort (GList **nodes, _NodeEdge **edges)
   if (*edges)
     {      
       g_list_free (sorted_nodes);
-      g_slice_free_chain (_NodeEdge, *edges, next);
+      _node_edge_list_free (*edges);
       *edges = NULL;
       return NULL;
     }
diff --git a/gladeui/glade-tsort.h b/gladeui/glade-tsort.h
index 3026e2d..28ed6e4 100644
--- a/gladeui/glade-tsort.h
+++ b/gladeui/glade-tsort.h
@@ -34,17 +34,16 @@ struct __NodeEdge
 {
   gpointer predecessor;
   gpointer successor;
-  _NodeEdge *next;
 };
 
-_NodeEdge *_node_edge_prepend  (_NodeEdge *node,
-                                gpointer predecessor,
-                                gpointer successor);
+GList *_node_edge_prepend   (GList *list,
+                             gpointer predecessor,
+                             gpointer successor);
 
-void       _node_edge_free     (_NodeEdge *node);
+void   _node_edge_list_free (GList *list);
 
-GList     *_glade_tsort        (GList     **nodes,
-                                _NodeEdge **edges);
+GList *_glade_tsort         (GList **nodes,
+                             GList **edges);
 
 G_END_DECLS
 
-- 
1.9.2

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002057.html">[Glade-devel] [PATCH 0/4] Backport topological sorting algorithm to	3.8 branch
</A></li>
	<LI>Next message: <A HREF="002055.html">[Glade-devel] [PATCH 3/4] Backport	56f47169dc09cfd6ed13a24cb9752050ecb66d6f.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2058">[ date ]</a>
              <a href="thread.html#2058">[ thread ]</a>
              <a href="subject.html#2058">[ subject ]</a>
              <a href="author.html#2058">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/glade-devel">More information about the Glade-devel
mailing list</a><br>
</body></html>
