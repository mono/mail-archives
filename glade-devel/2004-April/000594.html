<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] win32 patch for glade-2.5.1 cvs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:email%40ivanwong.info">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000593.html">
   <LINK REL="Next"  HREF="000595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] win32 patch for glade-2.5.1 cvs
   </H1>
    <B>Ivan Wong
    </B> 
    <A HREF="mailto:email%40ivanwong.info"
       TITLE="[Glade-devel] win32 patch for glade-2.5.1 cvs">email@ivanwong.info
       </A><BR>
    <I>Mon, 12 Apr 2004 13:44:09 +0800</I>
    <P><UL>
        <LI> Previous message: <A HREF="000593.html">[Glade-devel] win32 patch for glade-2.5.1 cvs
</A></li>
        <LI> Next message: <A HREF="000595.html">[Glade-devel] win32 patch for glade-2.5.1 cvs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#594">[ date ]</a>
              <a href="thread.html#594">[ thread ]</a>
              <a href="subject.html#594">[ subject ]</a>
              <a href="author.html#594">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Link with MSVCRT.dll (release, multithreaded), passing file pointer across
different M$VC runtime will crash.
I believe that patching 2.5.1 for win32 is more or less the same as patching
2.0.1 (though I haven't really tried), may be this's useful:

<A HREF="http://gladewin32.sf.net">http://gladewin32.sf.net</A>

----- Original Message ----- 
From: &quot;todd&quot; &lt;<A HREF="mailto:taf2@lehigh.edu">taf2@lehigh.edu</A>&gt;
Cc: &lt;<A HREF="mailto:glade-devel@ximian.com">glade-devel@ximian.com</A>&gt;
Sent: Monday, April 12, 2004 09:36
Subject: [Glade-devel] win32 patch for glade-2.5.1 cvs


&gt;<i> Hi,
</I>&gt;<i>     I've recently spent some getting gtk+ 2.4 working win32 for me.  The
</I>&gt;<i> one last thing I'd like to get working is glade.  Everything for me is
</I>&gt;<i> working
</I>&gt;<i> except for the save functionality.   Attached is the set of patches I
</I>&gt;<i> made to the source to get the properties dialog box to open as well as a
</I>&gt;<i> fix for a invalid
</I>&gt;<i> write for both linux and win32 that I found using valgrind.
</I>&gt;<i>
</I>&gt;<i> On my build save is crashing in save.c in the function
</I>&gt;<i> save_project_file_internal when it hits the fprintf, which for me is on
</I>&gt;<i> line 179.
</I>&gt;<i>
</I>&gt;<i> I was hoping to get some feed back on some ideas about why it might be
</I>&gt;<i> crashing on the fprintf, because if i replace the fprintf with an fwrite
</I>&gt;<i> the call works and the file I can see is written to just fine.  It feels
</I>&gt;<i> like some how the call stack is getting corrupted.  In my patch there is
</I>&gt;<i> a fix
</I>&gt;<i> for a win32 #define that sets a pointer to memory on the stack and then
</I>&gt;<i> in other platforms allocates memory for the pointer on the stack but for
</I>&gt;<i> all platforms frees that memory.  So, i'm worried that the call stack
</I>&gt;<i> might be getting corrupted because of other areas that are like this.
</I>&gt;<i>
</I>&gt;<i> The other related bug fix for the file open dialog box is a fix in glib,
</I>&gt;<i> which i reported here in bugzilla:
</I>&gt;<i> <A HREF="http://bugzilla.gnome.org/show_bug.cgi?id=139423">http://bugzilla.gnome.org/show_bug.cgi?id=139423</A>
</I>&gt;<i> I'd really like to get glade 2.5.x working in win32, and think that I'm
</I>&gt;<i> really close with this patch but would like some more help in figuring
</I>&gt;<i> out why the save
</I>&gt;<i> function is dieing on fprintf.  I hope this patch can be helpful
</I>&gt;<i>
</I>&gt;<i> -todd
</I>&gt;<i>
</I>

----------------------------------------------------------------------------
----


&gt;<i> ? fogb.h
</I>&gt;<i> ? fogbframe.c
</I>&gt;<i> ? foogbwindow.c
</I>&gt;<i> ? mypatches.patch
</I>&gt;<i> ? win32fix.patch
</I>&gt;<i> Index: glade/glade_menu_editor.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/glade_menu_editor.c,v
</I>&gt;<i> retrieving revision 1.22
</I>&gt;<i> diff -u -r1.22 glade_menu_editor.c
</I>&gt;<i> --- glade/glade_menu_editor.c 5 Apr 2004 23:18:08 -0000 1.22
</I>&gt;<i> +++ glade/glade_menu_editor.c 12 Apr 2004 01:23:04 -0000
</I>&gt;<i> @@ -25,6 +25,7 @@
</I>&gt;<i>  #include &lt;string.h&gt;
</I>&gt;<i>  #include &lt;time.h&gt;
</I>&gt;<i>
</I>&gt;<i> +#include &lt;gtk/gtkmain.h&gt;
</I>&gt;<i>  #include &lt;gdk/gdkkeysyms.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkarrow.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkaccellabel.h&gt;
</I>&gt;<i> Index: glade/glade_project_options.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/glade_project_options.c,v
</I>&gt;<i> retrieving revision 1.24
</I>&gt;<i> diff -u -r1.24 glade_project_options.c
</I>&gt;<i> --- glade/glade_project_options.c 5 Apr 2004 23:18:08 -0000 1.24
</I>&gt;<i> +++ glade/glade_project_options.c 12 Apr 2004 01:23:04 -0000
</I>&gt;<i> @@ -19,6 +19,7 @@
</I>&gt;<i>  #include &lt;ctype.h&gt;
</I>&gt;<i>  #include &lt;string.h&gt;
</I>&gt;<i>
</I>&gt;<i> +#include &lt;gtk/gtkmain.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkalignment.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkentry.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkeventbox.h&gt;
</I>&gt;<i> Index: glade/glade_project_window.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/glade_project_window.c,v
</I>&gt;<i> retrieving revision 1.27
</I>&gt;<i> diff -u -r1.27 glade_project_window.c
</I>&gt;<i> --- glade/glade_project_window.c 23 Mar 2004 17:41:29 -0000 1.27
</I>&gt;<i> +++ glade/glade_project_window.c 12 Apr 2004 01:23:06 -0000
</I>&gt;<i> @@ -1408,7 +1408,7 @@
</I>&gt;<i>    glade_project_window_update_title (project_window);
</I>&gt;<i>    glade_project_window_setup_interface (project_window);
</I>&gt;<i>
</I>&gt;<i> -  gtk_widget_destroy (GTK_WIDGET (options));
</I>&gt;<i> +  gtk_widget_hide (GTK_WIDGET (options));
</I>&gt;<i>
</I>&gt;<i>    switch (action)
</I>&gt;<i>      {
</I>&gt;<i> @@ -1424,6 +1424,7 @@
</I>&gt;<i>   glade_project_window_real_write_source (project_window);
</I>&gt;<i>        break;
</I>&gt;<i>      }
</I>&gt;<i> +    gtk_widget_destroy (GTK_WIDGET (options));
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Index: glade/main.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/main.c,v
</I>&gt;<i> retrieving revision 1.15
</I>&gt;<i> diff -u -r1.15 main.c
</I>&gt;<i> --- glade/main.c 25 Mar 2004 14:57:21 -0000 1.15
</I>&gt;<i> +++ glade/main.c 12 Apr 2004 01:23:06 -0000
</I>&gt;<i> @@ -23,7 +23,9 @@
</I>&gt;<i>  #include &lt;string.h&gt;
</I>&gt;<i>  #include &lt;sys/types.h&gt;
</I>&gt;<i>  #include &lt;sys/stat.h&gt;
</I>&gt;<i> +#ifdef G_OS_UNIX
</I>&gt;<i>  #include &lt;unistd.h&gt;
</I>&gt;<i> +#endif
</I>&gt;<i>
</I>&gt;<i>  #include &lt;gtk/gtkmain.h&gt;
</I>&gt;<i>  #include &lt;gtk/gtkrc.h&gt;
</I>&gt;<i> @@ -105,7 +107,7 @@
</I>&gt;<i>  int
</I>&gt;<i>  main (int argc, char *argv[])
</I>&gt;<i>  {
</I>&gt;<i> -  gchar *home_dir, *rc_path, *modules, *modules_needed, *new_modules;
</I>&gt;<i> +  gchar *home_dir = 0, *rc_path = 0, *modules = 0, *modules_needed = 0,
</I>*new_modules = 0;
&gt;<i>  #ifdef USE_GNOME
</I>&gt;<i>    GnomeProgram *program;
</I>&gt;<i>    char *icon;
</I>&gt;<i> @@ -195,6 +197,8 @@
</I>&gt;<i>  #else
</I>&gt;<i>    gtk_main ();
</I>&gt;<i>  #endif
</I>&gt;<i> +
</I>&gt;<i> +  g_free( new_modules );
</I>&gt;<i>    return 0;
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i> Index: glade/property.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/property.c,v
</I>&gt;<i> retrieving revision 1.35
</I>&gt;<i> diff -u -r1.35 property.c
</I>&gt;<i> --- glade/property.c 23 Mar 2004 17:41:30 -0000 1.35
</I>&gt;<i> +++ glade/property.c 12 Apr 2004 01:23:09 -0000
</I>&gt;<i> @@ -988,59 +988,63 @@
</I>&gt;<i>      lang_specific_properties[i] = NULL;
</I>&gt;<i>
</I>&gt;<i>    /* Create table for C-specific properties. */
</I>&gt;<i> -  table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> -  gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> -  if (property_language == GLADE_LANGUAGE_C)
</I>&gt;<i> -    gtk_widget_show (table);
</I>&gt;<i> -  lang_specific_properties[GLADE_LANGUAGE_C] = table;
</I>&gt;<i> -  gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> -
</I>&gt;<i> -  property_set_table_position (table, 0);
</I>&gt;<i> -  property_add_filename (GbCSourceFile, _(&quot;Source File:&quot;),
</I>&gt;<i> - _(&quot;The file to write source code into&quot;));
</I>&gt;<i> -  property_add_bool (GbCPublic, _(&quot;Public:&quot;),
</I>&gt;<i> -      _(&quot;If the widget is added to the component's data structure&quot;));
</I>&gt;<i> -
</I>&gt;<i> -  /* Create table for C++-specific properties. */
</I>&gt;<i> -  table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> -  gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> -  if (property_language == GLADE_LANGUAGE_CPP)
</I>&gt;<i> -    gtk_widget_show (table);
</I>&gt;<i> -  lang_specific_properties[GLADE_LANGUAGE_CPP] = table;
</I>&gt;<i> -  gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> -
</I>&gt;<i> -  property_set_table_position (table, 0);
</I>&gt;<i> -  property_add_bool (GbCxxSeparateClass, _(&quot;Separate Class:&quot;),
</I>&gt;<i> -      _(&quot;Put this widget's subtree in a separate class&quot;));
</I>&gt;<i> -  property_add_bool (GbCxxSeparateFile, _(&quot;Separate File:&quot;),
</I>&gt;<i> -      _(&quot;Put this widget in a separate source file&quot;));
</I>&gt;<i> -  property_add_choice (GbCxxVisibility, _(&quot;Visibility:&quot;),
</I>&gt;<i> -        _(&quot;Visibility of widgets. Public widgets are exported to a global
</I>map.&quot;),
&gt;<i> -        GbCxxVisibilityChoices);
</I>&gt;<i> -
</I>&gt;<i> -  /* Create table for Ada95-specific properties. */
</I>&gt;<i> -  table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> -  gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> -  if (property_language == GLADE_LANGUAGE_ADA95)
</I>&gt;<i> -    gtk_widget_show (table);
</I>&gt;<i> -  lang_specific_properties[GLADE_LANGUAGE_ADA95] = table;
</I>&gt;<i> -  gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> -
</I>&gt;<i> -  property_set_table_position (table, 0);
</I>&gt;<i> -  /* No properties yet. */
</I>&gt;<i> -
</I>&gt;<i> -
</I>&gt;<i> -  /* Create table for Perl-specific properties. */
</I>&gt;<i> -  table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> -  gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> -  if (property_language == GLADE_LANGUAGE_PERL)
</I>&gt;<i> -    gtk_widget_show (table);
</I>&gt;<i> -  lang_specific_properties[GLADE_LANGUAGE_PERL] = table;
</I>&gt;<i> -  gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> -
</I>&gt;<i> -  property_set_table_position (table, 0);
</I>&gt;<i> -  /* No properties yet. */
</I>&gt;<i> -
</I>&gt;<i> +  if( GLADE_LANGUAGE_C &lt; GladeNumLanguages ){
</I>&gt;<i> +    table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> +    gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> +    if (property_language == GLADE_LANGUAGE_C)
</I>&gt;<i> +      gtk_widget_show (table);
</I>&gt;<i> +    lang_specific_properties[GLADE_LANGUAGE_C] = table;
</I>&gt;<i> +    gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> +
</I>&gt;<i> +    property_set_table_position (table, 0);
</I>&gt;<i> +    property_add_filename (GbCSourceFile, _(&quot;Source File:&quot;),
</I>&gt;<i> +  _(&quot;The file to write source code into&quot;));
</I>&gt;<i> +    property_add_bool (GbCPublic, _(&quot;Public:&quot;),
</I>&gt;<i> +       _(&quot;If the widget is added to the component's data structure&quot;));
</I>&gt;<i> +  }
</I>&gt;<i> +  if( GLADE_LANGUAGE_CPP &lt; GladeNumLanguages ){
</I>&gt;<i> + /* Create table for C++-specific properties. */
</I>&gt;<i> + table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> + gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> + if (property_language == GLADE_LANGUAGE_CPP)
</I>&gt;<i> + gtk_widget_show (table);
</I>&gt;<i> + lang_specific_properties[GLADE_LANGUAGE_CPP] = table;
</I>&gt;<i> + gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> +
</I>&gt;<i> + property_set_table_position (table, 0);
</I>&gt;<i> + property_add_bool (GbCxxSeparateClass, _(&quot;Separate Class:&quot;),
</I>&gt;<i> + _(&quot;Put this widget's subtree in a separate class&quot;));
</I>&gt;<i> + property_add_bool (GbCxxSeparateFile, _(&quot;Separate File:&quot;),
</I>&gt;<i> + _(&quot;Put this widget in a separate source file&quot;));
</I>&gt;<i> + property_add_choice (GbCxxVisibility, _(&quot;Visibility:&quot;),
</I>&gt;<i> + _(&quot;Visibility of widgets. Public widgets are exported to a global
</I>map.&quot;),
&gt;<i> + GbCxxVisibilityChoices);
</I>&gt;<i> +  }
</I>&gt;<i> +  if( GLADE_LANGUAGE_ADA95 &lt; GladeNumLanguages ){
</I>&gt;<i> + /* Create table for Ada95-specific properties. */
</I>&gt;<i> + table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> + gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> + if (property_language == GLADE_LANGUAGE_ADA95)
</I>&gt;<i> + gtk_widget_show (table);
</I>&gt;<i> + lang_specific_properties[GLADE_LANGUAGE_ADA95] = table;
</I>&gt;<i> + gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> +
</I>&gt;<i> + property_set_table_position (table, 0);
</I>&gt;<i> + /* No properties yet. */
</I>&gt;<i> +
</I>&gt;<i> +  }
</I>&gt;<i> +  if( GLADE_LANGUAGE_PERL &lt; GladeNumLanguages ){
</I>&gt;<i> + /* Create table for Perl-specific properties. */
</I>&gt;<i> + table = gtk_table_new (3, 3, FALSE);
</I>&gt;<i> + gtk_table_set_row_spacings (GTK_TABLE (table), 1);
</I>&gt;<i> + if (property_language == GLADE_LANGUAGE_PERL)
</I>&gt;<i> + gtk_widget_show (table);
</I>&gt;<i> + lang_specific_properties[GLADE_LANGUAGE_PERL] = table;
</I>&gt;<i> + gtk_box_pack_start (GTK_BOX (vbox), table, FALSE, FALSE, 0);
</I>&gt;<i> +
</I>&gt;<i> + property_set_table_position (table, 0);
</I>&gt;<i> + /* No properties yet. */
</I>&gt;<i> +  }
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Index: glade/utils.c
</I>&gt;<i> ===================================================================
</I>&gt;<i> RCS file: /cvs/gnome/glade/glade/utils.c,v
</I>&gt;<i> retrieving revision 1.30
</I>&gt;<i> diff -u -r1.30 utils.c
</I>&gt;<i> --- glade/utils.c 23 Mar 2004 17:41:30 -0000 1.30
</I>&gt;<i> +++ glade/utils.c 12 Apr 2004 01:23:11 -0000
</I>&gt;<i> @@ -21,7 +21,9 @@
</I>&gt;<i>  #include &lt;string.h&gt;
</I>&gt;<i>  #include &lt;sys/types.h&gt;
</I>&gt;<i>  #include &lt;sys/stat.h&gt;
</I>&gt;<i> +#ifdef G_OS_UNIX
</I>&gt;<i>  #include &lt;unistd.h&gt;
</I>&gt;<i> +#endif
</I>&gt;<i>  #include &lt;dirent.h&gt;
</I>&gt;<i>  #include &lt;errno.h&gt;
</I>&gt;<i>
</I>&gt;<i> @@ -1331,7 +1333,10 @@
</I>&gt;<i>    if (dir_pos &gt; root_pos)
</I>&gt;<i>      dir_pos++;
</I>&gt;<i>    len = dir_pos + 1 + (strlen (file) - file_pos) + 1;
</I>&gt;<i> -  path = g_malloc (len);
</I>&gt;<i> +  path = g_try_malloc (len);
</I>&gt;<i> +  if( path == NULL ){
</I>&gt;<i> +    return NULL;
</I>&gt;<i> +  }
</I>&gt;<i>    strncpy (path, dir, dir_pos);
</I>&gt;<i>    path[dir_pos] = G_DIR_SEPARATOR;
</I>&gt;<i>    strcpy (path + dir_pos + 1, file + file_pos);
</I>&gt;<i> @@ -1602,11 +1607,13 @@
</I>&gt;<i>    gint project_num, max_project_num, project_string_len;
</I>&gt;<i>    gint num_matched, chars_matched;
</I>&gt;<i>
</I>&gt;<i> -#ifdef _WIN32
</I>&gt;<i> -  projects_dir = &quot;C:\\Projects&quot;;
</I>&gt;<i> -#else
</I>&gt;<i> +
</I>&gt;<i>    projects_dir = glade_util_make_absolute_path (g_get_home_dir (),
</I>&gt;<i>   _(&quot;Projects&quot;));
</I>&gt;<i> +#ifdef _WIN32
</I>&gt;<i> +  if( projects_dir == NULL ){
</I>&gt;<i> +    projects_dir = g_strdup( &quot;C:\\Projects&quot; );
</I>&gt;<i> +  }
</I>&gt;<i>  #endif
</I>&gt;<i>
</I>&gt;<i>    /* Step through the 'Projects' directory, if it exists, to find
</I>&gt;<i>
</I>

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000593.html">[Glade-devel] win32 patch for glade-2.5.1 cvs
</A></li>
	<LI> Next message: <A HREF="000595.html">[Glade-devel] win32 patch for glade-2.5.1 cvs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#594">[ date ]</a>
              <a href="thread.html#594">[ thread ]</a>
              <a href="subject.html#594">[ subject ]</a>
              <a href="author.html#594">[ author ]</a>
         </LI>
       </UL>
</body></html>
