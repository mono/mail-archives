<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] [patch, glade3] consolidate reparenting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:pborelli%40katamail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000193.html">
   <LINK REL="Next"  HREF="000197.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] [patch, glade3] consolidate reparenting
   </H1>
    <B>paolo borelli
    </B> 
    <A HREF="mailto:pborelli%40katamail.com"
       TITLE="[Glade-devel] [patch, glade3] consolidate reparenting">pborelli@katamail.com
       </A><BR>
    <I>01 Jun 2003 21:35:17 +0200</I>
    <P><UL>
        <LI> Previous message: <A HREF="000193.html">[Glade-devel] help :)
</A></li>
        <LI> Next message: <A HREF="000197.html">[Glade-devel] Cut/Paste + Undo/Redo bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#194">[ date ]</a>
              <a href="thread.html#194">[ thread ]</a>
              <a href="subject.html#194">[ subject ]</a>
              <a href="author.html#194">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-ISsgmxIQ40CJ3k8pcPms
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Hi!

Thanks to Joaquin for reviwing and applying my previous patches.

The attached patch consolidates in one place widget reparenting:
each time we called project_add_widget we also added the widget to the
list of children of the parent (if present), so it makes sense move the
reparenting into the project_add_widget function.

ciao
	paolo

--=-ISsgmxIQ40CJ3k8pcPms
Content-Disposition: attachment; filename=reparent.patch
Content-Type: text/x-patch; name=reparent.patch; charset=UTF-8
Content-Transfer-Encoding: 7bit

diff -upr gnome2/glade3/ChangeLog glade3/ChangeLog
--- gnome2/glade3/ChangeLog	2003-06-01 11:15:02.000000000 +0200
+++ glade3/ChangeLog	2003-06-01 21:21:43.000000000 +0200
@@ -1,3 +1,10 @@
+2003-06-01  Paolo Borelli  &lt;<A HREF="mailto:pborelli@katamail.com">pborelli@katamail.com</A>&gt;
+
+	* src/glade-project.[ch]: do reparenting at project_add time.
+	* src/glade-clipboard: update for the above.
+	* src/glade-command.c: ditto.
+	* src/glade-widget.c: ditto.
+
 2003-05-31  Joaquin Cuenca Abela  &lt;<A HREF="mailto:e98cuenc@yahoo.com">e98cuenc@yahoo.com</A>&gt;
 
 	* src/glade-widget.c: free the resources allocated by a GladeWidget
diff -upr gnome2/glade3/src/glade-clipboard.c glade3/src/glade-clipboard.c
--- gnome2/glade3/src/glade-clipboard.c	2003-05-24 17:41:46.000000000 +0200
+++ glade3/src/glade-clipboard.c	2003-06-01 21:15:26.000000000 +0200
@@ -216,10 +216,7 @@ glade_clipboard_paste (GladeClipboard *c
 	widget-&gt;name = glade_widget_new_name (project, widget-&gt;class);
 	widget-&gt;parent = parent;
 	glade_packing_add_properties (widget);
-	glade_project_add_widget (project, widget);
-
-	if (parent)
-		parent-&gt;children = g_list_prepend (parent-&gt;children, widget);
+	glade_project_add_widget (project, widget, parent);
 
 	glade_widget_set_contents (widget);
 	glade_widget_connect_signals (widget);
diff -upr gnome2/glade3/src/glade-command.c glade3/src/glade-command.c
--- gnome2/glade3/src/glade-command.c	2003-06-01 11:15:03.000000000 +0200
+++ glade3/src/glade-command.c	2003-06-01 21:08:45.000000000 +0200
@@ -617,11 +618,8 @@ glade_command_create_execute (GladeComma
 		me-&gt;placeholder = NULL;
 	}
 
-	if (widget-&gt;parent)
-		widget-&gt;parent-&gt;children = g_list_prepend (widget-&gt;parent-&gt;children, widget);
-
 	glade_project_selection_clear (widget-&gt;project, FALSE);
-	glade_project_add_widget (widget-&gt;project, widget);
+	glade_project_add_widget (widget-&gt;project, widget, widget-&gt;parent);
 
 	if (GTK_IS_WIDGET (widget-&gt;widget)) {
 		glade_project_selection_add (widget, TRUE);
diff -upr gnome2/glade3/src/glade-project.c glade3/src/glade-project.c
--- gnome2/glade3/src/glade-project.c	2003-05-24 17:41:46.000000000 +0200
+++ glade3/src/glade-project.c	2003-06-01 21:03:59.000000000 +0200
@@ -154,35 +154,49 @@ static void
 glade_project_add_widget_real (GladeProject *project,
 			       GladeWidget *widget)
 {
-	GladeWidget *child;
-	GList *list;
-
 	widget-&gt;project = project;
 
-	/*
-	 * Add all the children as well.
-	 */
-	list = widget-&gt;children;
-	for (; list; list = list-&gt;next) {
-		child = list-&gt;data;
-		glade_project_add_widget_real (project, child);
-		child-&gt;project = project;
-	}
-	
 	project-&gt;widgets = g_list_prepend (project-&gt;widgets, widget);
 
 	gtk_signal_emit (GTK_OBJECT (project),
 			 glade_project_signals [ADD_WIDGET], widget);
 }
 
+/**
+ * glade_project_add_widget:
+ * @project: the project the widget is added to
+ * @widget: the GladeWidget to add
+ * @parent: the GladeWidget @widget is reparented to
+ *
+ * Adds a widget to the project. Parent should be NULL for toplevels.
+ **/
 void
 glade_project_add_widget (GladeProject *project,
-			  GladeWidget  *widget)
+			  GladeWidget *widget,
+			  GladeWidget *parent)
 {
+	GladeWidget *child;
+	GList *list;
+
 	g_return_if_fail (GLADE_IS_PROJECT (project));
-	g_return_if_fail (GTK_IS_OBJECT (project));
+	g_return_if_fail (GLADE_IS_WIDGET (widget));
 
 	glade_project_add_widget_real (project, widget);
+
+	/* Add all the children as well */
+	for (list = widget-&gt;children; list; list = list-&gt;next) {
+		child = list-&gt;data;
+		glade_project_add_widget_real (project, child);
+	}
+
+	/* reparent */
+	if (parent) {
+		g_return_if_fail (GLADE_IS_WIDGET (parent));
+
+		widget-&gt;parent = parent;
+		parent-&gt;children = g_list_prepend (parent-&gt;children, widget);
+	}
+
 	project-&gt;changed = TRUE;
 }
 
diff -upr gnome2/glade3/src/glade-project.h glade3/src/glade-project.h
--- gnome2/glade3/src/glade-project.h	2003-05-24 17:41:46.000000000 +0200
+++ glade3/src/glade-project.h	2003-06-01 21:06:11.000000000 +0200
@@ -67,7 +67,8 @@ gboolean glade_project_save (GladeProjec
 /* Widget related stuff */
 void glade_project_remove_widget (GladeWidget *widget);
 void glade_project_add_widget (GladeProject  *project,
-			       GladeWidget *glade_widget);
+			       GladeWidget *widget,
+			       GladeWidget *parent);
 
 GladeWidget *glade_project_get_widget_by_name (GladeProject *project, const char *name);
 char *glade_project_new_widget_name (GladeProject *project, const char *base_name);
diff -upr gnome2/glade3/src/glade-widget.c glade3/src/glade-widget.c
--- gnome2/glade3/src/glade-widget.c	2003-06-01 11:15:04.000000000 +0200
+++ glade3/src/glade-widget.c	2003-06-01 21:14:19.000000000 +0200
@@ -802,13 +802,7 @@ glade_widget_new_full (GladeWidgetClass 
 
 	glade_packing_add_properties (widget);
 	glade_widget_create_gtk_widget (widget);
-	/*
-	glade_project_add_widget (project, widget);
 
-	if (parent)
-		parent-&gt;children = g_list_prepend (parent-&gt;children, widget);
-	*/
-	
 	glade_widget_set_contents (widget);
 	glade_widget_connect_signals (widget);
 

--=-ISsgmxIQ40CJ3k8pcPms--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000193.html">[Glade-devel] help :)
</A></li>
	<LI> Next message: <A HREF="000197.html">[Glade-devel] Cut/Paste + Undo/Redo bug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#194">[ date ]</a>
              <a href="thread.html#194">[ thread ]</a>
              <a href="subject.html#194">[ subject ]</a>
              <a href="author.html#194">[ author ]</a>
         </LI>
       </UL>
</body></html>
