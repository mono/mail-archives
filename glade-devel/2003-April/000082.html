<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Glade-devel] Cut/Paste with Undo/Redo patch.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bighead%40users.sourceforge.net">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000081.html">
   <LINK REL="Next"  HREF="000083.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Glade-devel] Cut/Paste with Undo/Redo patch.
   </H1>
    <B>Archit Baweja
    </B> 
    <A HREF="mailto:bighead%40users.sourceforge.net"
       TITLE="[Glade-devel] Cut/Paste with Undo/Redo patch.">bighead@users.sourceforge.net
       </A><BR>
    <I>Fri, 4 Apr 2003 02:51:30 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="000081.html">[Glade-devel] Undo/Redo for Copy?
</A></li>
        <LI> Next message: <A HREF="000083.html">[Glade-devel] Re: Has glade3 development started?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82">[ date ]</a>
              <a href="thread.html#82">[ thread ]</a>
              <a href="subject.html#82">[ subject ]</a>
              <a href="author.html#82">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi

Here's the patch which has been waiting in my source tree for over 6 months.
Works. Couple of inefficiences and I also noticed a segfault not relating to
clipboard from my initial observations but I don't know really. Will look into
it. Anyways heres the patch.

Feast on it, tear it apart, criticize it and more importantly debug it if u
want to (although I will do all those over the weekend). Have fun!

Cheers!
Archit Baweja


===File ~/Projects/gnome2/glade3/glade3-clipboard-and-undo.patch===
? .cvsignore
? autom4te-2.53.cache
? glade-3.desktop
? glade3-clipboard-and-undo.patch
? stamp-h1
? src/glade-3
Index: ChangeLog
===================================================================
RCS file: /cvs/gnome/glade3/ChangeLog,v
retrieving revision 1.103
diff -u -r1.103 ChangeLog
- --- ChangeLog	2 Apr 2003 19:52:08 -0000	1.103
+++ ChangeLog	4 Apr 2003 07:45:23 -0000
@@ -1,3 +1,17 @@
+2003-04-04  Archit Baweja  &lt;<A HREF="mailto:bighead@users.sourceforge.net">bighead@users.sourceforge.net</A>&gt;
+
+	* src/glade-project-window.c (gpw_cut_cb): use glade_command_cut().
+	(gpw_paste_cb): use glade_command_paste().
+
+	* src/glade-placeholder.c (glade_placeholder_paste_cb): likewise.
+
+	* src/glade-widget.c (glade_widget_cut): likewise.
+
+2002-05-26  Archit Baweja  &lt;<A HREF="mailto:bighead@users.sourceforge.net">bighead@users.sourceforge.net</A>&gt;
+
+	* src/glade-command.c (glade_command_cut_paste_*): cut/paste through
+	the undo/redo system.
+
 2003-04-02  Joaquin Cuenca Abela  &lt;<A HREF="mailto:e98cuenc@yahoo.com">e98cuenc@yahoo.com</A>&gt;
 
 	* src/glade-menu-editor.c: Fix the segfault when adding a new menu item.
Index: src/glade-clipboard.c
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-clipboard.c,v
retrieving revision 1.7
diff -u -r1.7 glade-clipboard.c
- --- src/glade-clipboard.c	13 Mar 2003 23:12:03 -0000	1.7
+++ src/glade-clipboard.c	4 Apr 2003 07:45:23 -0000
@@ -4,7 +4,7 @@
  * Copyright (C) 2001 The GNOME Foundation.
  *
  * Author(s):
- - *      Archit Baweja &lt;<A HREF="mailto:bighead@crosswinds.net">bighead@crosswinds.net</A>&gt;
+ *      Archit Baweja &lt;<A HREF="mailto:bighead@users.sourceforge.net">bighead@users.sourceforge.net</A>&gt;
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License
Index: src/glade-command.c
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-command.c,v
retrieving revision 1.4
diff -u -r1.4 glade-command.c
- --- src/glade-command.c	9 Mar 2003 20:37:46 -0000	1.4
+++ src/glade-command.c	4 Apr 2003 07:45:23 -0000
@@ -18,6 +18,7 @@
  *
  * Authors:
  *   Joaquín Cuenca Abela &lt;<A HREF="mailto:e98cuenc@yahoo.com">e98cuenc@yahoo.com</A>&gt;
+ *   Archit Baweja &lt;<A HREF="mailto:bighead@users.sourceforge.net">bighead@users.sourceforge.net</A>&gt;
  */
 #include &lt;gtk/gtk.h&gt;
 #include &lt;string.h&gt;
@@ -31,6 +32,7 @@
 #include &quot;glade-property.h&quot;
 #include &quot;glade-debug.h&quot;
 #include &quot;glade-placeholder.h&quot;
+#include &quot;glade-clipboard.h&quot;
 #include &quot;glade.h&quot;
 
 #define GLADE_COMMAND_TYPE		(glade_command_get_type ())
@@ -608,4 +610,132 @@
 glade_command_create (GladeWidget *widget)
 {
 	glade_command_create_delete_common (widget, TRUE);
+}
+
+/**
+ * Cut/Paste
+ *
+ * Following is the code to extend the GladeCommand Undo/Redo system to 
+ * Clipboard functions.
+ **/
+typedef struct {
+	GladeCommand parent;
+
+	GladeClipboard *clipboard;
+	GladeWidget *widget;
+	GladePlaceholder *placeholder;
+	gboolean cut;
+} GladeCommandCutPaste;
+
+
+GLADE_MAKE_COMMAND (GladeCommandCutPaste, glade_command_cut_paste);
+#define GLADE_COMMAND_CUT_PASTE_TYPE		(glade_command_cut_paste_get_type ())
+#define GLADE_COMMAND_CUT_PASTE(o)	  	(G_TYPE_CHECK_INSTANCE_CAST ((o), GLADE_COMMAND_CUT_PASTE_TYPE, GladeCommandCutPaste))
+#define GLADE_COMMAND_CUT_PASTE_CLASS(k)	(G_TYPE_CHECK_CLASS_CAST ((k), GLADE_COMMAND_CUT_PASTE_TYPE, GladeCommandCutPasteClass))
+#define IS_GLADE_COMMAND_CUT_PASTE(o)		(G_TYPE_CHECK_INSTANCE_TYPE ((o), GLADE_COMMAND_CUT_PASTE_TYPE))
+#define IS_GLADE_COMMAND_CUT_PASTE_CLASS(k)	(G_TYPE_CHECK_CLASS_TYPE ((k), GLADE_COMMAND_CREATE_DELETE_TYPE))
+
+static gboolean
+glade_command_cut_paste_undo (GladeCommand *cmd)
+{
+	return glade_command_cut_paste_execute (cmd);
+}
+
+static gboolean
+glade_command_paste_execute (GladeCommandCutPaste *me)
+{
+	glade_clipboard_paste (me-&gt;clipboard, me-&gt;placeholder);
+
+	return TRUE;
+}
+
+static gboolean
+glade_command_cut_execute (GladeCommandCutPaste *me)
+{
+	glade_clipboard_cut (me-&gt;clipboard, me-&gt;widget);
+
+	return TRUE;
+}
+
+/**
+ * Execute the cmd and revert it.  Ie, after the execution of this
+ * function cmd will point to the undo action
+ */
+static gboolean
+glade_command_cut_paste_execute (GladeCommand *cmd)
+{
+	GladeCommandCutPaste *me = (GladeCommandCutPaste *) cmd;
+	gboolean retval;
+	
+	if (me-&gt;cut)
+		retval = glade_command_cut_execute (me);
+	else
+		retval = glade_command_paste_execute (me);
+
+	me-&gt;cut = !me-&gt;cut;
+	return retval;
+}
+
+static void
+glade_command_cut_paste_finalize (GObject *obj)
+{
+	GladeCommandCutPaste *cmd = GLADE_COMMAND_CUT_PASTE (obj);
+	g_object_unref (cmd-&gt;widget);
+        glade_command_finalize (obj);
+}
+
+static gboolean
+glade_command_cut_paste_unifies (GladeCommand *this, GladeCommand *other)
+{
+	return FALSE;
+}
+
+static void
+glade_command_cut_paste_collapse (GladeCommand *this, GladeCommand *other)
+{
+	g_return_if_reached ();
+}
+
+static void
+glade_command_cut_paste_common (GladeWidget *widget,
+				GladePlaceholder *placeholder,
+				gboolean cut)
+{
+	GladeCommandCutPaste *me;
+	GladeCommand *cmd;
+	GladeProject *project;
+	GladeProjectWindow *gpw;
+
+	me = (GladeCommandCutPaste *) g_object_new (GLADE_COMMAND_CUT_PASTE_TYPE, NULL);
+	cmd = (GladeCommand *) me;
+	
+	project = glade_project_window_get_project ();
+	gpw = glade_project_window_get ();
+
+	me-&gt;cut = cut;
+	me-&gt;widget = widget;
+	me-&gt;placeholder = placeholder;
+	me-&gt;clipboard = gpw-&gt;clipboard;
+	
+	cmd-&gt;description = g_strdup_printf (_(&quot;%s %s&quot;), cut ? &quot;Cut&quot; : &quot;Paste&quot;, widget-&gt;name);
+	
+	g_debug((&quot;Pushing: %s\n&quot;, cmd-&gt;description));
+
+	/*
+	 * Push it onto the undo stack only on success
+	 */
+	if (glade_command_cut_paste_execute (GLADE_COMMAND (me)))
+		glade_command_push_undo (project, GLADE_COMMAND (me));
+}
+
+void
+glade_command_paste (GladeWidget *widget, GladePlaceholder *placeholder)
+{
+	glade_command_cut_paste_common (widget, placeholder, FALSE);
+}
+
+void
+glade_command_cut (GladeWidget *widget)
+{
+	glade_command_cut_paste_common (widget, NULL, TRUE);
 }
Index: src/glade-command.h
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-command.h,v
retrieving revision 1.2
diff -u -r1.2 glade-command.h
- --- src/glade-command.h	11 Apr 2002 08:01:44 -0000	1.2
+++ src/glade-command.h	4 Apr 2003 07:45:23 -0000
@@ -10,7 +10,11 @@
 const gchar* glade_command_get_description (GList *l);
 
 void glade_command_set_property (GObject *obj, const gchar* name, const GValue* value);
+
 void glade_command_delete (GladeWidget *widget);
 void glade_command_create (GladeWidget *widget);
+
+void glade_command_cut   (GladeWidget *widget);
+void glade_command_paste (GladeWidget *widget, GladePlaceholder *placeholder);
 
 #endif /* GLADE_COMMAND_H */
Index: src/glade-placeholder.c
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-placeholder.c,v
retrieving revision 1.25
diff -u -r1.25 glade-placeholder.c
- --- src/glade-placeholder.c	2 May 2002 09:11:09 -0000	1.25
+++ src/glade-placeholder.c	4 Apr 2003 07:45:23 -0000
@@ -794,12 +794,13 @@
 void
 glade_placeholder_paste_cb (GtkWidget *button, gpointer data)
 {
- -	GladePlaceholder *placeholder = GTK_WIDGET (data);
 	GladeProjectWindow *gpw;
- -	GladeClipboard *clipboard;
 
 	gpw = glade_project_window_get ();
- -	clipboard = gpw-&gt;clipboard;
 
- -	glade_clipboard_paste (clipboard, placeholder);
+	/*
+	 * The data parameter is the placeholder we have to replace with the
+	 * widget.
+	 */
+	glade_command_paste (gpw-&gt;active_widget, GTK_WIDGET (data));
 }
Index: src/glade-project-window.c
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-project-window.c,v
retrieving revision 1.36
diff -u -r1.36 glade-project-window.c
- --- src/glade-project-window.c	2 Apr 2003 19:06:28 -0000	1.36
+++ src/glade-project-window.c	4 Apr 2003 07:45:23 -0000
@@ -193,7 +193,7 @@
 	widget = gpw-&gt;active_widget;
 
 	if (widget)
- -		glade_clipboard_cut (gpw-&gt;clipboard, widget);
+		glade_command_cut (widget);
 }
 
 static void
@@ -202,7 +202,7 @@
 	GladeProjectWindow *gpw;
 
 	gpw = glade_project_window_get ();
- -	glade_clipboard_paste (gpw-&gt;clipboard, gpw-&gt;active_placeholder);
+	glade_command_paste (gpw-&gt;active_widget, gpw-&gt;active_placeholder);
 }
 
 static void
Index: src/glade-widget.c
===================================================================
RCS file: /cvs/gnome/glade3/src/glade-widget.c,v
retrieving revision 1.35
diff -u -r1.35 glade-widget.c
- --- src/glade-widget.c	2 Apr 2003 19:52:10 -0000	1.35
+++ src/glade-widget.c	4 Apr 2003 07:45:24 -0000
@@ -1114,8 +1114,7 @@
 
 	gpw = glade_project_window_get ();
 	clipboard = gpw-&gt;clipboard;
- -
- -	glade_clipboard_cut (clipboard, widget);
+	glade_command_cut (widget);
 }
 
 void
============================================================
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.0.7 (GNU/Linux)
Comment: Processed by Mailcrypt 3.5.6 and Gnu Privacy Guard &lt;<A HREF="http://www.gnupg.org/">http://www.gnupg.org/</A>&gt;

iD8DBQE+jTmC2rWNPKmGjMcRAgjmAKCcGfehSNjMZuawzuHRob05oANA/ACfdf/w
IO/Cv3pPzgY7b2hPs9c9RFQ=
=agWE
-----END PGP SIGNATURE-----

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000081.html">[Glade-devel] Undo/Redo for Copy?
</A></li>
	<LI> Next message: <A HREF="000083.html">[Glade-devel] Re: Has glade3 development started?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82">[ date ]</a>
              <a href="thread.html#82">[ thread ]</a>
              <a href="subject.html#82">[ subject ]</a>
              <a href="author.html#82">[ author ]</a>
         </LI>
       </UL>
</body></html>
