<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [csharplang] Ref/out parameters in operators
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Ref/out%20parameters%20in%20operators&In-Reply-To=%3C58961b5b.951c190a.bd977.c2b3%40mx.google.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000087.html">
   <LINK REL="Next"  HREF="000079.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[csharplang] Ref/out parameters in operators</H1>
    <B>orthoxerox at gmail.com</B> 
    <A HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Ref/out%20parameters%20in%20operators&In-Reply-To=%3C58961b5b.951c190a.bd977.c2b3%40mx.google.com%3E"
       TITLE="[csharplang] Ref/out parameters in operators">orthoxerox at gmail.com
       </A><BR>
    <I>Sat Feb  4 18:20:11 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000087.html">[csharplang] [FUN] Support DestructableAttribution for	deconstructors
</A></li>
        <LI>Next message (by thread): <A HREF="000079.html">[csharplang] Ref/out parameters in operators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#78">[ date ]</a>
              <a href="thread.html#78">[ thread ]</a>
              <a href="subject.html#78">[ subject ]</a>
              <a href="author.html#78">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello everyone.

I propose that C# is changed to allow ref-parameters in operators (original discussion in <A HREF="https://github.com/dotnet/roslyn/issues/12364">https://github.com/dotnet/roslyn/issues/12364</A>). This is useful for expressing operations on large structs in a performant and natural way.

I tested this with an immutable struct of 3 doubles (attached).

1) By value static methods (current operators)
470ms
2) By value/reference static methods (to allow chaining them without temps)
360ms
3) Pure by reference static methods
380ms
4) By reference static methods with an out-parameter
270ms

The ref/out approach is the clear winner.

For these operators both the parameters and the return type must be prefixed with `ref` for the compiler to rewrite them into a ref/out method:
	Unary +, -, !, ~
	Binary +, -, *, /, %, &amp;, |, ^, &lt;&lt;, &gt;&gt;

For these operators only the parameters must be prefixed with ref, and the method is rewritten into a ref method:
	Unary: true, false
	Binary: ==, !=, &lt;, &gt;, &lt;=, &gt;=

I am not sure how to approach ++ and – operators and user-defined conversions. The former don’t look like they will benefit from this in any way, while the latter might be quite useful, but the conversions spec is hard to follow already.

Mixed-refness is an open issue as well. It’s useful when one of the parameters is a lightweight type, but it introduces additional complexity.

Best regards,
orthoxerox
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/csharplang/attachments/20170204/18656110/attachment.html">http://lists.dot.net/pipermail/csharplang/attachments/20170204/18656110/attachment.html</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Program.cs
Type: application/octet-stream
Size: 4130 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.dot.net/pipermail/csharplang/attachments/20170204/18656110/attachment.obj">http://lists.dot.net/pipermail/csharplang/attachments/20170204/18656110/attachment.obj</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000087.html">[csharplang] [FUN] Support DestructableAttribution for	deconstructors
</A></li>
	<LI>Next message (by thread): <A HREF="000079.html">[csharplang] Ref/out parameters in operators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#78">[ date ]</a>
              <a href="thread.html#78">[ thread ]</a>
              <a href="subject.html#78">[ subject ]</a>
              <a href="author.html#78">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/csharplang">More information about the csharplang
mailing list</a><br>
</body></html>
