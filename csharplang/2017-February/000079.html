<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [csharplang] Ref/out parameters in operators
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Ref/out%20parameters%20in%20operators&In-Reply-To=%3C386DA9F6-5F90-48B6-BF40-028B33023EC1%40microsoft.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000078.html">
   <LINK REL="Next"  HREF="000080.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[csharplang] Ref/out parameters in operators</H1>
    <B>Jared Parsons</B> 
    <A HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Ref/out%20parameters%20in%20operators&In-Reply-To=%3C386DA9F6-5F90-48B6-BF40-028B33023EC1%40microsoft.com%3E"
       TITLE="[csharplang] Ref/out parameters in operators">jaredpar at microsoft.com
       </A><BR>
    <I>Sat Feb  4 23:42:49 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000078.html">[csharplang] Ref/out parameters in operators
</A></li>
        <LI>Next message (by thread): <A HREF="000080.html">[csharplang] Ref/out parameters in operators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#79">[ date ]</a>
              <a href="thread.html#79">[ thread ]</a>
              <a href="subject.html#79">[ subject ]</a>
              <a href="author.html#79">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In general C# forces passing by ref to be an explicit by forcing a call site annotation.  This makes it obvious to the caller that the callee is capable of mutating the values here.  Allowing operators to silently accept ref arguments means the developer loses that declarative feedback.  I think that would be a bit of a step backwards here.  Forcing ref at operator call sites seems a bit awkward as well.

There is a feature under consideration [1] that allows for ‘readonly ref’ parameters.  It’s likely these parameters can be passed without call site annotation.  There is no possibility of mutation by caller hence the annotation doesn’t add a lot of value.

I think forcing ‘readonly ref’ here would be more appropriate.

[1] Proposal should be sent to this alias very early next week.

--
JaredPar
<A HREF="https://twitter.com/jaredpar">https://twitter.com/jaredpar</A>

From: csharplang on behalf of &quot;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">orthoxerox at gmail.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">orthoxerox at gmail.com</A>&gt;&quot;
Date: Saturday, February 4, 2017 at 10:20 AM
To: &quot;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;&quot;
Subject: [csharplang] Ref/out parameters in operators

Hello everyone.

I propose that C# is changed to allow ref-parameters in operators (original discussion in <A HREF="https://github.com/dotnet/roslyn/issues/12364">https://github.com/dotnet/roslyn/issues/12364</A>). This is useful for expressing operations on large structs in a performant and natural way.

I tested this with an immutable struct of 3 doubles (attached).


  1.  By value static methods (current operators)
470ms
  2.  By value/reference static methods (to allow chaining them without temps)
360ms
  3.  Pure by reference static methods
380ms
  4.  By reference static methods with an out-parameter
270ms

The ref/out approach is the clear winner.

For these operators both the parameters and the return type must be prefixed with `ref` for the compiler to rewrite them into a ref/out method:
           Unary +, -, !, ~
           Binary +, -, *, /, %, &amp;, |, ^, &lt;&lt;, &gt;&gt;

For these operators only the parameters must be prefixed with ref, and the method is rewritten into a ref method:
           Unary: true, false
           Binary: ==, !=, &lt;, &gt;, &lt;=, &gt;=

I am not sure how to approach ++ and – operators and user-defined conversions. The former don’t look like they will benefit from this in any way, while the latter might be quite useful, but the conversions spec is hard to follow already.

Mixed-refness is an open issue as well. It’s useful when one of the parameters is a lightweight type, but it introduces additional complexity.

Best regards,
orthoxerox
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/csharplang/attachments/20170204/55edaa0e/attachment-0001.html">http://lists.dot.net/pipermail/csharplang/attachments/20170204/55edaa0e/attachment-0001.html</A>&gt;
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000078.html">[csharplang] Ref/out parameters in operators
</A></li>
	<LI>Next message (by thread): <A HREF="000080.html">[csharplang] Ref/out parameters in operators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#79">[ date ]</a>
              <a href="thread.html#79">[ thread ]</a>
              <a href="subject.html#79">[ subject ]</a>
              <a href="author.html#79">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/csharplang">More information about the csharplang
mailing list</a><br>
</body></html>
