<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Operators%20should%20be%20exposed%20for%20%60System.IntPtr%60%0A%20and%20%60System.UIntPtr%60&In-Reply-To=%3CMWHPR03MB2446D50C788FF120DE56D17CC14F0%40MWHPR03MB2446.namprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="000039.html">
   <LINK REL="Next"  HREF="000069.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`</H1>
    <B>Cyrus Najmabadi</B> 
    <A HREF="mailto:csharplang%40lists.dot.net?Subject=Re%3A%20%5Bcsharplang%5D%20Operators%20should%20be%20exposed%20for%20%60System.IntPtr%60%0A%20and%20%60System.UIntPtr%60&In-Reply-To=%3CMWHPR03MB2446D50C788FF120DE56D17CC14F0%40MWHPR03MB2446.namprd03.prod.outlook.com%3E"
       TITLE="[csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`">cyrusn at microsoft.com
       </A><BR>
    <I>Fri Feb  3 05:35:36 UTC 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="000039.html">[csharplang] Operators should be exposed for `System.IntPtr`	and `System.UIntPtr`
</A></li>
        <LI>Next message (by thread): <A HREF="000069.html">[csharplang] Operators should be exposed for `System.IntPtr` and	`System.UIntPtr`
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40">[ date ]</a>
              <a href="thread.html#40">[ thread ]</a>
              <a href="subject.html#40">[ subject ]</a>
              <a href="author.html#40">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Arguably, this request is just having C# catch up
</I>
Features that are just about catching up (especially in corner cases like this) just do not seem to provide enough weight for me.  There’s limited time we can spend on language changes, and I’d much rather them go to non-narrow features that many more customers could benefit from.

&gt;<i> IntPtr is not just any type, though. It's a type that happens to be a valuetype mapped to a primitive IL type
</I>
That *definitely* sounds like a concern of the runtime then ☺.  From the language perspective it looks just like any other type.  I mean the language specification doesn’t even talk about IntPtr (except in reference to volatile fields).  Introducing a whole section to explain the operators for this sort of type seems extremely niche and not worth the effort.

If, however, we had a general proposal (i.e. how to provide operators when types have not provided them), then I could definitely get behind that.  Then we’d have something that would warrant the effort to make the language change and could be something that could be added to IntPtr (without having to ship a new Fx) through things like a nuget package.

--

TLDR: one-off, catch-up features are super low down on my list of things that I think should be done.  I’d much rather have broadly applicable features, or super nice improvements in common areas first.

           -- Cyrus

From: Pavel Minaev [mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">int19h at gmail.com</A>]
Sent: Thursday, February 2, 2017 8:52 PM
To: Cyrus Najmabadi &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">cyrusn at microsoft.com</A>&gt;
Cc: miguel.de.icaza &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">miguel.de.icaza at gmail.com</A>&gt;; <A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>
Subject: Re: [csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`

IntPtr is not just any type, though. It's a type that happens to be a valuetype mapped to a primitive IL type, and the wrapper in question doesn't provide overloaded operators because IL has intrinsic operators capable of handling it - so the assumption of people who wrote System.IntPtr was likely that any language that would want to expose those operators in the first place, would expose them directly. This is in contrast to something like System.Decimal, where the overloaded operators are the one and only way to do anything to it.

You could argue that IntPtr should have had the overloads (but then why not Int32 and Double?). But it doesn't, and C# should have accounted for that. Arguably, this request is just having C# catch up. It doesn't set any meaningful precedent for any other type, unless such a type is also 1) part of the standard library, 2) has operators defined for it in IL, and 3) doesn't overload those operators on the corresponding valuetype. Correct me if I'm wrong, but IntPtr/UIntPtr are literally the only two remaining holdouts in this category.

On Thu, Feb 2, 2017 at 8:21 PM, Cyrus Najmabadi via csharplang &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;&gt; wrote:
I don’t like this approach, as it essentially means that any existing type that we want operators on, must get those operators through compiler upgrades.

Perhaps we could accomplish this some other, more general, language feature.  For example, a way to add ‘extension operators’ would likely help out here.  i.e. operators for a type that don’t need to be contained in the declaration of the operand types.   Then, one could add such operators (backed by straight IL for all I care), and the language could pick it up.  Users could then use this facility for other types that they want to add operators to.

This would at least be a flexible language mechanism that would address the problem for other types in the future.  Instead of doing a special 1-off blessing of IntPtr.

           -- Cyrus

From: Miguel de Icaza [mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">miguel.de.icaza at gmail.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">miguel.de.icaza at gmail.com</A>&gt;]
Sent: Thursday, February 2, 2017 6:51 PM
To: Cyrus Najmabadi &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">cyrusn at microsoft.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">cyrusn at microsoft.com</A>&gt;&gt;
Cc: Justin Spindler &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">justin.spindler at gmail.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">justin.spindler at gmail.com</A>&gt;&gt;; <A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;

Subject: Re: [csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`

While the various operations on data types on C# are specified in in terms of &quot;operator X&quot; in the ECMA spec, the implementation of the operators has historically been embedded in the compiler.

While the runtime could certainly do the work of mapping &quot;call op_Foo&quot; into the equivalent operation these would be more special cases for all the assorted runtimes that exist to be updated to support this.

Additionally, it would make code compiled with the new runtime require a fresher version of mscorlib.dll to contain the operator operations.

Given the above, I believe that if we want to add this operations to IntPtr and UIntPtr, that we should have the compiler get the knowledge to do this.

Miguel.

On Thu, Feb 2, 2017 at 9:44 PM, Cyrus Najmabadi via csharplang &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;&gt; wrote:
Why can’t the implementation of those operators just be implemented in terms of those opcodes.  Certainly the JIT/runtime would then inline all of that effectively?

          -- Cyrus

From: Justin Spindler [mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">justin.spindler at gmail.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">justin.spindler at gmail.com</A>&gt;]
Sent: Thursday, February 2, 2017 6:22 PM
To: Cyrus Najmabadi &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">cyrusn at microsoft.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">cyrusn at microsoft.com</A>&gt;&gt;
Cc: Tanner Gooding &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">tagoo at microsoft.com</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">tagoo at microsoft.com</A>&gt;&gt;; <A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;
Subject: Re: [csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`

Primitive arithmetic operations are a concern of the compiler, which needs to emit the appropriate opcodes to perform the operation.  C#-style overloaded operators aren't declared on these types.  There is no Int32.op_Addition, etc.

On Thu, Feb 2, 2017 at 9:14 PM, Cyrus Najmabadi via csharplang &lt;<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;&gt; wrote:
Why not just add the actual operators to the System.IntPtr and System.UIntPtr structs?  It’s unclear to me why we’d need anything specific in C# for these types.

           -- Cyrus

From: csharplang [mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang-bounces at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang-bounces at lists.dot.net</A>&gt;] On Behalf Of Tanner Gooding via csharplang
Sent: Thursday, February 2, 2017 3:58 PM
To: <A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;
Subject: [csharplang] Operators should be exposed for `System.IntPtr` and `System.UIntPtr`

Copied from: <A HREF="https://github.com/dotnet/roslyn/issues/12836&lt;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Froslyn%2Fissues%2F12836&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C6d6a112dd88541693c2208d44bdb7819%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216853371146110&amp;sdata=IGZbU13gY11ew%2BPWfeVawC4tW2NGhqa9ScSR7P4vh98%3D&amp;reserved=0">https://github.com/dotnet/roslyn/issues/12836&lt;https://na01.safelinks.protection.outlook.com/?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Froslyn%2Fissues%2F12836&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C6d6a112dd88541693c2208d44bdb7819%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216853371146110&amp;sdata=IGZbU13gY11ew%2BPWfeVawC4tW2NGhqa9ScSR7P4vh98%3D&amp;reserved=0</A>&gt;
Issue:
The CLR supports a set of operators for the System.IntPtr and System.UIntPtr types (native int). These operators can be seen in III.1.5 of the Command Language Infrastructure specification. However, these operators are not supported by the C#.
Workaround:
Either directly emit IL or write non-optimal code that does not directly translate to the appropriate IL instructions.
Request:
Language support should be provided for the full set of operators supported by System.IntPtr and System.UIntPtr. These operators are: Add, Divide, Multiply, Remainder, Subtract, Negate, Equals, Compare, And, Not, Or, XOr, ShiftLeft, ShiftRight.
Other Thoughts:
C# seems to treat both IntPtr and UIntPtr as a type only used for interop and for representing pointers in a 'safe' manner, when it is really just:
an integer whose size is platform-specific.
It should be possible for a user to treat the IntPtr and UIntPtr types as an equivalent to the native size_t type. However, in order to do that, one must may have to deal with one or more of the following:

  *   Perform multiple levels of casting
  *   Use integers whose size is larger than their platform's native size
  *   Have branching to use integers that are platform-specific
  *   Work with unsafe code and do pointer arithmetic

-Tanner Gooding

_______________________________________________
csharplang mailing list
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C6d6a112dd88541693c2208d44bdb7819%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216853371146110&amp;sdata=Rbn5dxTPxjfQNXPs8UFBR69jS8xdsUM751bLptURhvI%3D&amp;reserved=0">http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C6d6a112dd88541693c2208d44bdb7819%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216853371146110&amp;sdata=Rbn5dxTPxjfQNXPs8UFBR69jS8xdsUM751bLptURhvI%3D&amp;reserved=0</A>&gt;


_______________________________________________
csharplang mailing list
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C55d03f9f747d416ac55108d44bdf7770%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216870533789867&amp;sdata=8ICtgSdR7fyDdgOhBcGIw31aADs035CLmEFo8ubVNy4%3D&amp;reserved=0">http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C55d03f9f747d416ac55108d44bdf7770%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216870533789867&amp;sdata=8ICtgSdR7fyDdgOhBcGIw31aADs035CLmEFo8ubVNy4%3D&amp;reserved=0</A>&gt;


_______________________________________________
csharplang mailing list
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&lt;mailto:<A HREF="http://lists.dot.net/mailman/listinfo/csharplang">csharplang at lists.dot.net</A>&gt;
<A HREF="http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C0cb41641a5074b5b15d908d44bf07c44%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216943631818552&amp;sdata=WkinYFXp1SV%2F%2Bqoc%2BePqez7gUBAR3mtLEvOnXiXAQ8k%3D&amp;reserved=0">http://lists.dot.net/mailman/listinfo/csharplang&lt;https://na01.safelinks.protection.outlook.com/?url=http%3A%2F%2Flists.dot.net%2Fmailman%2Flistinfo%2Fcsharplang&amp;data=02%7C01%7Ccyrusn%40microsoft.com%7C0cb41641a5074b5b15d908d44bf07c44%7C72f988bf86f141af91ab2d7cd011db47%7C1%7C0%7C636216943631818552&amp;sdata=WkinYFXp1SV%2F%2Bqoc%2BePqez7gUBAR3mtLEvOnXiXAQ8k%3D&amp;reserved=0</A>&gt;

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.dot.net/pipermail/csharplang/attachments/20170203/79253f49/attachment-0001.html">http://lists.dot.net/pipermail/csharplang/attachments/20170203/79253f49/attachment-0001.html</A>&gt;
</PRE>




















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="000039.html">[csharplang] Operators should be exposed for `System.IntPtr`	and `System.UIntPtr`
</A></li>
	<LI>Next message (by thread): <A HREF="000069.html">[csharplang] Operators should be exposed for `System.IntPtr` and	`System.UIntPtr`
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40">[ date ]</a>
              <a href="thread.html#40">[ thread ]</a>
              <a href="subject.html#40">[ subject ]</a>
              <a href="author.html#40">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.dot.net/mailman/listinfo/csharplang">More information about the csharplang
mailing list</a><br>
</body></html>
