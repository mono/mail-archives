<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodevelop-devel] Improving refactoring after 2.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodevelop-devel-list%40lists.ximian.com?Subject=%5BMonodevelop-devel%5D%20Improving%20refactoring%20after%202.0&In-Reply-To=1226046667.3624.105.camel%40linux-yd7m.site">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000070.html">
   <LINK REL="Next"  HREF="000072.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodevelop-devel] Improving refactoring after 2.0</H1>
    <B>Lluis Sanchez Gual</B> 
    <A HREF="mailto:monodevelop-devel-list%40lists.ximian.com?Subject=%5BMonodevelop-devel%5D%20Improving%20refactoring%20after%202.0&In-Reply-To=1226046667.3624.105.camel%40linux-yd7m.site"
       TITLE="[Monodevelop-devel] Improving refactoring after 2.0">lluis at novell.com
       </A><BR>
    <I>Fri Nov  7 11:17:22 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="000070.html">[Monodevelop-devel] Improving refactoring after 2.0
</A></li>
        <LI>Next message: <A HREF="000072.html">[Monodevelop-devel] Improving refactoring after 2.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#71">[ date ]</a>
              <a href="thread.html#71">[ thread ]</a>
              <a href="subject.html#71">[ subject ]</a>
              <a href="author.html#71">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>El dv 07 de 11 de 2008 a les 09:31 +0100, en/na Mike Kr&#252;ger va escriure:
&gt;<i> &#65279;Hi
</I>&gt;<i> 
</I>&gt;<i> &gt; Notice that change previewing for the rename operation can be done
</I>&gt;<i> with
</I>&gt;<i> &gt; the current infrastructure. It's a matter of finding the references,
</I>&gt;<i> &gt; displaying them and do the replace when the user clicks on OK. The API
</I>&gt;<i> &gt; supports that, although we haven't implemented the GUI.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> No not really. It's a hack. There is an operation called:
</I>&gt;<i> 
</I>&gt;<i> IMember RenameMember (RefactorerContext ctx, 
</I>&gt;<i>                       IType cls, 
</I>&gt;<i>                       IMember member, 
</I>&gt;<i>                       string newName);
</I>&gt;<i> 
</I>&gt;<i> And that's it. Ok you've:
</I>&gt;<i> 
</I>&gt;<i> MemberReferenceCollection FindMemberReferences (RefactorerContext ctx,
</I>&gt;<i> string fileName,
</I>&gt;<i> IType cls,
</I>&gt;<i> IMember member);
</I>&gt;<i> MemberReferenceCollection FindVariableReferences (RefactorerContext ctx,
</I>&gt;<i> string fileName, LocalVariable var);
</I>&gt;<i> MemberReferenceCollection FindParameterReferences (RefactorerContext
</I>&gt;<i> ctx, string fileName, IParameter param);
</I>&gt;<i> 
</I>&gt;<i> And with these three methods you can hack something together for this
</I>&gt;<i> one refactoring case - but that's it. Thisis not really what I've in
</I>&gt;<i> mind to do.
</I>&gt;<i> 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &#65279;I'll need to extend/change the current refactoring infrastructure
</I>&gt;<i> for
</I>&gt;<i> &gt; &gt; this. And one of the goals for the new one is: unit test support.
</I>&gt;<i> The
</I>&gt;<i> &gt; &gt; new code completion infrastructure is tested with unit tests and I
</I>&gt;<i> think
</I>&gt;<i> &gt; &gt; that this has improved the code completion correctness greatly.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Any thoughts/inputs here ?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'd like to see a high level design of the API to get an idea of how
</I>&gt;<i> you
</I>&gt;<i> &gt; plan to improve the refactoring infrastructure.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Currently:
</I>&gt;<i> 
</I>&gt;<i> Anything seems to be called &quot;refactorer&quot; (Even classes that don't
</I>&gt;<i> implement IRefactorer) to make it more stangely we've a refactorer
</I>&gt;<i> called CodeGenerator (inheriting from BaseRefactorer). It looks like
</I>&gt;<i> thats currently anything is hacked together.
</I>
Before trying to rewrite any piece of code you should at least study the
current code and try to understand how it works, what are the
responsibilities of each class, and why it was designed in that way.
Only then you'll be qualified to say what's wrong and propose a better
solution. The use of words like &quot;strangely&quot;, &quot;hack&quot; and &quot;looks like&quot;
clearly show that you didn't follow this step.

I'm not saying that the current refactoring infrastructure is perfect.
It is not. Much of it will probably have to be changed if we want to
support more advanced refactoring operations. But you can't arbitrarily
drop all current code, ignoring what has been done. We already had some
bad experiences in MD because of this.

&gt;<i> It starts with clicking on something in the editor window there is a
</I>&gt;<i> class that builds the context menu and this class controls which
</I>&gt;<i> operations are valid.
</I>&gt;<i> 
</I>&gt;<i> I want:
</I>&gt;<i> 
</I>&gt;<i> Split up refactoring a bit to make it clear what each class does.
</I>&gt;<i> 
</I>&gt;<i> I intend to split up the &quot;refactoring&quot; feature. Each refactoring
</I>&gt;<i> operation should be an own class that knows it's responsibilities (based
</I>&gt;<i> on the resolve result) it knows when it's valid to display in the
</I>&gt;<i> refactoring context menu.
</I>&gt;<i> 
</I>&gt;<i> Then we would've classes like:
</I>&gt;<i> 
</I>&gt;<i> &#65279;Rename
</I>&gt;<i> &#65279;Implicit&#65279;ImplementInterface
</I>&gt;<i> ExplicitImplementInterface
</I>&gt;<i> ExtractMethod
</I>&gt;<i> 
</I>&gt;<i> etc.
</I>&gt;<i> 
</I>&gt;<i> These refactorings should be placed in the addin tree.
</I>
Will those refactoring classes be language-specific?
For example, the Rename class, there will be a RenameCSharp and a
RenameVisualBasic? if that's the case, will they share some code?

&gt;<i> 
</I>&gt;<i> We've a RefactorerContext - that's good these context should be
</I>&gt;<i> containing the find functions and some helper functions that are
</I>&gt;<i> currently splitted up between IRefactorer and CodeRefactorer).
</I>&gt;<i> 
</I>&gt;<i> Then we need a CodeGenerator - this is a class that actually builds
</I>&gt;<i> code. Not by changing it, it should produce &quot;diffs&quot;.
</I>
Some add-ins need to perform basic code manipulation operation such as
inserting a new method to a class or adding custom attributes to class
declarations. Which class would provide those operations?

I'd like to see how the high level API will look like. That is, the API
that will allow starting refactoring operations or manipulate code.

&gt;<i> 
</I>&gt;<i> Then we need something like a result of the refactoring operations.
</I>&gt;<i> That'll give us a list of files with diffs as well as a list of the
</I>&gt;<i> class tree with changes. I intend to have a dialog that looks like:
</I>&gt;<i> 
</I>&gt;<i> -----------------
</I>&gt;<i> 
</I>&gt;<i>  Positions
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Diffs
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----------------
</I>&gt;<i> 
</I>&gt;<i> That's what I intend to:
</I>&gt;<i> 
</I>&gt;<i> class &#65279;RefactoringResult {
</I>&gt;<i> 	List&lt;Change&gt; Changes;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> class Change {
</I>&gt;<i> 	string fileName; 
</I>&gt;<i> 	IMember memberLocation;
</I>&gt;<i> 
</I>&gt;<i>         DomLocation position;
</I>&gt;<i> 
</I>&gt;<i>         string old;
</I>&gt;<i> 	string new;
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Something like this an 'positions' should be switchable between class
</I>&gt;<i> view and file view (like the pads).
</I>&gt;<i> 
</I>&gt;<i> The Refactoring should something look like:
</I>&gt;<i> 
</I>&gt;<i> &#65279;IRefactoring {
</I>&gt;<i> 	bool IsSupported (&#65279;ResolveResult result);
</I>&gt;<i> 	string GetDisplaySting (&#65279;&#65279;ResolveResult result);
</I>&gt;<i> 	
</I>&gt;<i> 	void Run ();
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> IResultRefactoring : IRefactoring {
</I>&gt;<i> 	&#65279;&#65279;RefactoringResult DoOperation (RefactorerContext, ResolveResult
</I>&gt;<i> result);
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> I want to support maybe more than one type of refactoring, therefore
</I>&gt;<i> just the &quot;run&quot; method. And there are more types than just the diff
</I>&gt;<i> refactoring - implement/override members for example therefore not all
</I>&gt;<i> refactorings require the position/diff dialogs.
</I>
Can you provide a list of all refactorings you plan to implement and
what are the requirements of each of them?

&gt;<i> Another example could be renaming a local variable or parameter which
</I>&gt;<i> could be displayed inline in the text editor instead of having pop up
</I>&gt;<i> dialogs. (Ok I admit I've worked a bit with eclipse this week :) )
</I>&gt;<i> 
</I>&gt;<i> To decide: On which infrastructure we'll build. Currently it's a bit
</I>&gt;<i> mixed up between CodeDOM and NRefactory. I would've chosen NRefactory
</I>&gt;<i> because we're already building on this and an own AST gives more control
</I>&gt;<i> than a pre defined one.
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> Mike
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000070.html">[Monodevelop-devel] Improving refactoring after 2.0
</A></li>
	<LI>Next message: <A HREF="000072.html">[Monodevelop-devel] Improving refactoring after 2.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#71">[ date ]</a>
              <a href="thread.html#71">[ thread ]</a>
              <a href="subject.html#71">[ subject ]</a>
              <a href="author.html#71">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodevelop-devel-list">More information about the Monodevelop-devel-list
mailing list</a><br>
</body></html>
