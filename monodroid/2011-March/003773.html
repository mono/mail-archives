<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Possible GC Bug?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Possible%20GC%20Bug%3F&In-Reply-To=AANLkTinSYC%3D55A75%3DX8StmGG894TZCGKSb1ACtPkMR49%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003771.html">
   <LINK REL="Next"  HREF="003775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Possible GC Bug?</H1>
    <B>Michael Kestner</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Possible%20GC%20Bug%3F&In-Reply-To=AANLkTinSYC%3D55A75%3DX8StmGG894TZCGKSb1ACtPkMR49%40mail.gmail.com"
       TITLE="[mono-android] Possible GC Bug?">mkestner at novell.com
       </A><BR>
    <I>Fri Mar 18 17:47:07 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003771.html">[mono-android] Possible GC Bug?
</A></li>
        <LI>Next message: <A HREF="003775.html">[mono-android] Possible GC Bug?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3773">[ date ]</a>
              <a href="thread.html#3773">[ thread ]</a>
              <a href="subject.html#3773">[ subject ]</a>
              <a href="author.html#3773">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Mar 18, 2011, at 4:24 PM, Aaron Knabb wrote:

&gt;<i> Thanks for your input Jon. So if I understand correctly, I should call GC.Collect regularly? I don't see how to know what objects (assuming this isn't exclusive to Bitmaps) are allocated in Dalvik and which ones aren't. If that's the case, then I should call collect just in case there's something that needs to be cleaned up.
</I>
Just to add a little to the discussion, calling Dispose on the Bitmap doesn't necessarily cause a java collection of the underlying object.  All that can really happen is that we release our explicit ref to it.  If you have done something with the Bitmap like:

  Canvas canvas = new Canvas();
  canvas.Bitmap = bitmap;

and you don't also dispose the Canvas, then you have to wait for the canvas to be finalized by the mono GC before the java collector is going to be able to release the bitmap.  If the Canvas is being held alive by mono pending a collection, the bitmap is effectively held alive on the java side.  

I mention this scenario because we have seen it explicitly reported, but I am sure there are many ways to get into a situation where you Dispose an object, but java/dalvik can't really get rid of it right away because of outstanding refs.  It's possible you are seeing something similar if an explicit GC.Collect helps.  You probably are missing an additional Dispose.

Mike

&gt;<i> -Aaron
</I>&gt;<i> 
</I>&gt;<i> On Fri, Mar 18, 2011 at 10:56 AM, Jonathan Pryor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">jpryor at novell.com</A>&gt; wrote:
</I>&gt;<i> On Mar 18, 2011, at 12:43 PM, Aaron Knabb wrote:
</I>&gt;<i> &gt; However, if I am creating and disposing of a large bitmap every time my activity is recreated (say in an ImageView), I run out of memory before long.
</I>&gt;<i> 
</I>&gt;<i> The problem -- which is present on every GC system -- is that Mono's GC doesn't know how big the Dalvik-allocated bitmap is (just as .NET's GC doesn't know that you just called Marshal.AllocHGlobal() to allocate 4GB of memory...). Furthermore, Mono's GC _can't_ know how big the Dalvik-allocated bitmap is, and even if you knew how much memory it took GC.AddMemoryPressure() isn't supported.
</I>&gt;<i> 
</I>&gt;<i> Thus, in this (and similar) cases you need to help the GC out, as you know things the GC doesn't, and thus the GC.Collect() call is appropriate.
</I>&gt;<i> 
</I>&gt;<i>  - Jon
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i> 
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i> 
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/mailman/private/monodroid/attachments/20110318/29c2d355/attachment-0001.html">http://lists.ximian.com/mailman/private/monodroid/attachments/20110318/29c2d355/attachment-0001.html</A> 
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003771.html">[mono-android] Possible GC Bug?
</A></li>
	<LI>Next message: <A HREF="003775.html">[mono-android] Possible GC Bug?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3773">[ date ]</a>
              <a href="thread.html#3773">[ thread ]</a>
              <a href="subject.html#3773">[ subject ]</a>
              <a href="author.html#3773">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
