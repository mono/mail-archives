<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Problem with WindowManager
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Problem%20with%20WindowManager&In-Reply-To=90A1E73A-623C-455B-AED4-B502704410E8%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003686.html">
   <LINK REL="Next"  HREF="003688.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Problem with WindowManager</H1>
    <B>Narc&#237;s Calvet</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Problem%20with%20WindowManager&In-Reply-To=90A1E73A-623C-455B-AED4-B502704410E8%40novell.com"
       TITLE="[mono-android] Problem with WindowManager">narcis at steema.com
       </A><BR>
    <I>Wed Mar 16 04:40:48 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003686.html">[mono-android] Problem with WindowManager
</A></li>
        <LI>Next message: <A HREF="003688.html">[mono-android] Cannot use StartActivity() from IAnimationListener
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3709">[ date ]</a>
              <a href="thread.html#3709">[ thread ]</a>
              <a href="subject.html#3709">[ subject ]</a>
              <a href="author.html#3709">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jon,

Thanks for the info. That fixed the issue.


Best Regards,
 
Narc&#237;s Calvet
Steema Software
<A HREF="http://www.steema.com">http://www.steema.com</A> 
<A HREF="http://twitter.com/SteemaSoftware">http://twitter.com/SteemaSoftware</A> 
<A HREF="https://www.facebook.com/SteemaSoftware">https://www.facebook.com/SteemaSoftware</A>

-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A>] On Behalf Of Jonathan Pryor
Sent: dimarts, 15 / mar&#231; / 2011 18:04
To: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid at lists.ximian.com</A>
Subject: Re: [mono-android] Problem with WindowManager

On Mar 15, 2011, at 11:23 AM, Narc&#237;s Calvet wrote:
&gt;<i> I&#146;m trying to get the display size using the code below in an Activity.
</I>&gt;<i>  
</I>&gt;<i>       Java.Lang.Object windowService =
</I>this.GetSystemService(Android.Content.Context.WindowService);
&gt;<i>       Android.Views.IWindowManager windowManager = windowService as
</I>Android.Views.IWindowManager;
&gt;<i>       Android.Views.Display display = windowManager.DefaultDisplay;
</I>&gt;<i>       String str = display.Width.ToString() + &quot; x &quot; +
</I>display.Height.ToString();
&gt;<i>  
</I>&gt;<i> I&#146;d bet this worked last week.
</I>
Much as the mailing list is currently blaming Preview 14 for breakage...  I
doubt it. :-)  (The relevant code hasn't changed in ages.)

&gt;<i> Has there been any change in this field in preview 14? Do I miss anything?
</I>The line where the code fails is when casting the windowService object to
Android.Views.IWindowManager. The debugger says it&#146;s a
android.view.Window$LocalWindowManager but this type is not available.

The fix is to use Extensions.JavaCast&lt;T&gt;() [0]:

	var windowService =
this.GetSystemService(Android.Content.Context.WindowService);
	var windowManager =
windowService.JavaCast&lt;Android.Views.IWindowManager&gt;();
	// ...

The problem is that there are two type systems involved in Mono for Android,
the Android/Java type system, and the Mono type system. Mono for Android
attempts to bridge the two separate runtimes, but occasionally it breaks
down, and this is one such circumstance.

What's happening is that
GetSystemService(Android.Content.Context.WindowService) is returning an
undocumented, internal, Java type (android.view.Window$LocalWindowManager).
Because this type is undocumented, we don't (and can't) generate a managed
wrapper for the type. Consequently, when
Java.Lang.Object.GetObject&lt;T&gt;(IntPtr,bool) tries to find the &quot;most derived&quot;
wrapper type, all it can find is Java.Lang.Object [1], and thus
`windowService.GetType().FullName` is Java.Lang.Object.

Java.Lang.Object can't be cast to an IWindowManager interface, which is why
your `as IWindowManager` returns null.

The correct fix is to use the Extensions.JavaCast&lt;T&gt;() extension method,
which will perform a runtime Java-VM check to see if the instance can be
cast to the IWindowManager interface, and then construct an appropriate
proxy if the runtime check succeeds.

 - Jon

[0]
<A HREF="http://docs.mono-android.net/index.aspx?link=M%3aAndroid.Runtime.Extensions.">http://docs.mono-android.net/index.aspx?link=M%3aAndroid.Runtime.Extensions.</A>
JavaCast``1(Android.Runtime.IJavaObject)

[1] This is arguably a bug, as it currently only checks for types and not
implemented interfaces, but this behavior won't be changing anytime soon,
either.

_______________________________________________
Monodroid mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>

UNSUBSCRIBE INFORMATION:
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>


</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003686.html">[mono-android] Problem with WindowManager
</A></li>
	<LI>Next message: <A HREF="003688.html">[mono-android] Cannot use StartActivity() from IAnimationListener
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3709">[ date ]</a>
              <a href="thread.html#3709">[ thread ]</a>
              <a href="subject.html#3709">[ subject ]</a>
              <a href="author.html#3709">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
