<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Problem with WindowManager
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Problem%20with%20WindowManager&In-Reply-To=00c801cbe324%24e92624b0%24bb726e10%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003682.html">
   <LINK REL="Next"  HREF="003709.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Problem with WindowManager</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Problem%20with%20WindowManager&In-Reply-To=00c801cbe324%24e92624b0%24bb726e10%24%40com"
       TITLE="[mono-android] Problem with WindowManager">jpryor at novell.com
       </A><BR>
    <I>Tue Mar 15 13:04:09 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003682.html">[mono-android] Problem with WindowManager
</A></li>
        <LI>Next message: <A HREF="003709.html">[mono-android] Problem with WindowManager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3686">[ date ]</a>
              <a href="thread.html#3686">[ thread ]</a>
              <a href="subject.html#3686">[ subject ]</a>
              <a href="author.html#3686">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mar 15, 2011, at 11:23 AM, Narc&#237;s Calvet wrote:
&gt;<i> I&#8217;m trying to get the display size using the code below in an Activity.
</I>&gt;<i>  
</I>&gt;<i>       Java.Lang.Object windowService = this.GetSystemService(Android.Content.Context.WindowService);
</I>&gt;<i>       Android.Views.IWindowManager windowManager = windowService as Android.Views.IWindowManager;
</I>&gt;<i>       Android.Views.Display display = windowManager.DefaultDisplay;
</I>&gt;<i>       String str = display.Width.ToString() + &quot; x &quot; + display.Height.ToString();
</I>&gt;<i>  
</I>&gt;<i> I&#8217;d bet this worked last week.
</I>
Much as the mailing list is currently blaming Preview 14 for breakage...  I doubt it. :-)  (The relevant code hasn't changed in ages.)

&gt;<i> Has there been any change in this field in preview 14? Do I miss anything? The line where the code fails is when casting the windowService object to Android.Views.IWindowManager. The debugger says it&#8217;s a android.view.Window$LocalWindowManager but this type is not available.
</I>
The fix is to use Extensions.JavaCast&lt;T&gt;() [0]:

	var windowService = this.GetSystemService(Android.Content.Context.WindowService);
	var windowManager = windowService.JavaCast&lt;Android.Views.IWindowManager&gt;();
	// ...

The problem is that there are two type systems involved in Mono for Android, the Android/Java type system, and the Mono type system. Mono for Android attempts to bridge the two separate runtimes, but occasionally it breaks down, and this is one such circumstance.

What's happening is that GetSystemService(Android.Content.Context.WindowService) is returning an undocumented, internal, Java type (android.view.Window$LocalWindowManager). Because this type is undocumented, we don't (and can't) generate a managed wrapper for the type. Consequently, when Java.Lang.Object.GetObject&lt;T&gt;(IntPtr,bool) tries to find the &quot;most derived&quot; wrapper type, all it can find is Java.Lang.Object [1], and thus `windowService.GetType().FullName` is Java.Lang.Object.

Java.Lang.Object can't be cast to an IWindowManager interface, which is why your `as IWindowManager` returns null.

The correct fix is to use the Extensions.JavaCast&lt;T&gt;() extension method, which will perform a runtime Java-VM check to see if the instance can be cast to the IWindowManager interface, and then construct an appropriate proxy if the runtime check succeeds.

 - Jon

[0] <A HREF="http://docs.mono-android.net/index.aspx?link=M%3aAndroid.Runtime.Extensions.JavaCast``1(Android.Runtime.IJavaObject">http://docs.mono-android.net/index.aspx?link=M%3aAndroid.Runtime.Extensions.JavaCast``1(Android.Runtime.IJavaObject</A>)

[1] This is arguably a bug, as it currently only checks for types and not implemented interfaces, but this behavior won't be changing anytime soon, either.

</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003682.html">[mono-android] Problem with WindowManager
</A></li>
	<LI>Next message: <A HREF="003709.html">[mono-android] Problem with WindowManager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3686">[ date ]</a>
              <a href="thread.html#3686">[ thread ]</a>
              <a href="subject.html#3686">[ subject ]</a>
              <a href="author.html#3686">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
