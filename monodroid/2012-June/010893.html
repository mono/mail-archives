<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Disposing method in View
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Disposing%20method%20in%20View&In-Reply-To=%3CCALD-8DdaxMkuKVd8JuRH1dmPVoEai3PirxeH-DK0i4ukbxfOKw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010889.html">
   <LINK REL="Next"  HREF="010891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Disposing method in View</H1>
    <B>Matthew Leibowitz</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Disposing%20method%20in%20View&In-Reply-To=%3CCALD-8DdaxMkuKVd8JuRH1dmPVoEai3PirxeH-DK0i4ukbxfOKw%40mail.gmail.com%3E"
       TITLE="[mono-android] Disposing method in View">mattleibowmail at gmail.com
       </A><BR>
    <I>Tue Jun 19 07:32:56 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="010889.html">[mono-android] Disposing method in View
</A></li>
        <LI>Next message: <A HREF="010891.html">[mono-android] [ANN] MonoDevelop 3.0.3 and Mono for Android 4.2.3 now available in the Stable Channel
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10893">[ date ]</a>
              <a href="thread.html#10893">[ thread ]</a>
              <a href="subject.html#10893">[ subject ]</a>
              <a href="author.html#10893">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Thanks for the replies, but I think I may have presented the problem
incorrectly.

I have a problem of knowing when a *view *will be disposed of. I have
created a Control that derives from View. This control has a temporary
cache of low res images that it uses. I then use this Control in various
places.

In order to dispose of this cache, I can do something this:

override *MyActivity*.OnFinish()
{
    this.*myControl*.DisposeImages();
}

But this is  not what I really want to do. I don't want my activities to
have to know about when and what my view's images and data are doing. What
I would like is:

override *MyControl*.ViewIsDisposing()
{
    this.DisposeImages();
}

I don't know if something like this exists. But currently I am doing
something like this:

override MyControl.OnDetachedFromWindow()
 {
     this.DisposeImages();
}
override MyControl.OnAttachedToWindow()
 {
     this.CacheImages();
}

This probably will result in the images being cleared and re-cached if the
control is moved around, but this is not such a big problem. Is this method
ok to use. I currently know that when I add the view to the layout, my
images are cached. When I close the activity, my view is unloaded, thus
resulting in the control being detached. This results in my images being
clear. Which is good so far.

Are there any comments or different ways of doing this?


Matthew


On Mon, Jun 18, 2012 at 10:58 PM, Jonathan Pryor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">jonp at xamarin.com</A>&gt; wrote:

&gt;<i> On Jun 18, 2012, at 10:16 AM, Matthew Leibowitz wrote:
</I>&gt;<i> &gt; As my last question suggested, I am working with images. I cache the lo
</I>&gt;<i> res in an array member of a view, but how do I dispose of the images?
</I>&gt;<i>
</I>&gt;<i> By Dispose()ing of them. :-)
</I>&gt;<i>
</I>&gt;<i> &gt; I tried overriding the Dispose(bool) method, but that doesn't seem to be
</I>&gt;<i> called when the Activity is closed.
</I>&gt;<i>
</I>&gt;<i> Dispose(bool) is called by the GC when the value can be collected. This
</I>&gt;<i> will be some point after the Activity is closed, but not immediately after,
</I>&gt;<i> unless you null out your Bitmap fields and call GC.Collect() in
</I>&gt;<i> Activity.OnDestroy(). (Even GC.Collect() may not work immediately, and
</I>&gt;<i> would still require that you null out all Java.Lang.Object-subclass
</I>&gt;<i> fields...)
</I>&gt;<i>
</I>&gt;<i> &gt; What am I doing wrong? :) Is there another method/place?
</I>&gt;<i>
</I>&gt;<i> &gt; The &quot;dispose&quot; should be called when the containing activity is closed,
</I>&gt;<i> but I don't want either the Activity or the View to know about each other.
</I>&gt;<i> &gt; This is because they are used in a few places, but in slightly different
</I>&gt;<i> ways.
</I>&gt;<i>
</I>&gt;<i> I'm not entirely sure how your View is obtaining the array from your
</I>&gt;<i> Activity...but it might not matter.
</I>&gt;<i>
</I>&gt;<i> Let's assume you have code such as [0]:
</I>&gt;<i>
</I>&gt;<i>        Bitmap[] bitmaps = new Bitmap[100];
</I>&gt;<i>        for (int i = 0; i &lt; 100; i++) {
</I>&gt;<i>                bitmaps[i] = BitmapFactory.DecodeFile(...);
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i> Every Bitmap instance will contain a gref, and gref acts as a GC &quot;root&quot;,
</I>&gt;<i> preventing the Java VM from collecting the Java-side object [1]. The above
</I>&gt;<i> will thus necessitate that 100 gref's exist until all 100 Bitmaps instances
</I>&gt;<i> are Dispose()d, OR the GC is able to collect all of them:
</I>&gt;<i>
</I>&gt;<i>        for (int i = 0; i &lt; bitmaps.Length; i++)
</I>&gt;<i>                bitmaps [i].Dispose ();
</I>&gt;<i>
</I>&gt;<i> Can you do better? Somewhat:
</I>&gt;<i>
</I>&gt;<i>        JavaList&lt;Bitmap&gt; bitmaps = new JavaList&lt;Bitmap&gt;();
</I>&gt;<i>        for (int i = 0; i &lt; 100; i++) {
</I>&gt;<i>                using (var bitmap = BitmapFactory.DecodeFile (...))
</I>&gt;<i>                        bitmaps.Add (bitmap);
</I>&gt;<i>        }
</I>&gt;<i>
</I>&gt;<i> The `using` ensures that the managed Bitmap peer instance is disposed of
</I>&gt;<i> ASAP. The above code will require only 1 gref: the gref for the
</I>&gt;<i> JavaList&lt;Bitmap&gt; instance.
</I>&gt;<i>
</I>&gt;<i> When you access `bitmaps`, a new managed peer will be created, which will
</I>&gt;<i> acquire a new gref:
</I>&gt;<i>
</I>&gt;<i>        Bitmap b = bitmaps [0];
</I>&gt;<i>
</I>&gt;<i> To ensure that the gref is disposed of as quickly as possible, you'd still
</I>&gt;<i> want to Dispose() of it:
</I>&gt;<i>
</I>&gt;<i>        using (var b = bitmaps [0])
</I>&gt;<i>                DoSomethingWithTheBitmap (b);
</I>&gt;<i>
</I>&gt;<i> However, since JavaList&lt;Bitmap&gt; still has a gref, everything it references
</I>&gt;<i> will also be kept alive. You'll have 1 gref, but you still have 100 Bitmap
</I>&gt;<i> instance hanging around at once. To allow Dalvik to collect them, you need
</I>&gt;<i> to release the gref:
</I>&gt;<i>
</I>&gt;<i>        bitmaps.Dispose ();
</I>&gt;<i>
</I>&gt;<i> The `bitmaps.Dispose()` call could thus go in Activity.OnDestroy()
</I>&gt;<i>
</I>&gt;<i>  - Jon
</I>&gt;<i>
</I>&gt;<i> [0]
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/11081806/larger-memory-footprint-when-using-bitmapfactory-decodefile-in-c-sharp-and-huge">http://stackoverflow.com/questions/11081806/larger-memory-footprint-when-using-bitmapfactory-decodefile-in-c-sharp-and-huge</A>
</I>&gt;<i>
</I>&gt;<i> [1] <A HREF="http://docs.xamarin.com/android/advanced_topics/garbage_collection">http://docs.xamarin.com/android/advanced_topics/garbage_collection</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i>
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monodroid/attachments/20120619/2388da7e/attachment.html">http://lists.ximian.com/pipermail/monodroid/attachments/20120619/2388da7e/attachment.html</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010889.html">[mono-android] Disposing method in View
</A></li>
	<LI>Next message: <A HREF="010891.html">[mono-android] [ANN] MonoDevelop 3.0.3 and Mono for Android 4.2.3 now available in the Stable Channel
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10893">[ date ]</a>
              <a href="thread.html#10893">[ thread ]</a>
              <a href="subject.html#10893">[ subject ]</a>
              <a href="author.html#10893">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
