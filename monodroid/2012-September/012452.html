<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Activity leaking Service Connection.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Activity%20leaking%20Service%20Connection.&In-Reply-To=%3C1348668821709-5711969.post%40n5.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012451.html">
   <LINK REL="Next"  HREF="012447.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Activity leaking Service Connection.</H1>
    <B>Julian Booth</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Activity%20leaking%20Service%20Connection.&In-Reply-To=%3C1348668821709-5711969.post%40n5.nabble.com%3E"
       TITLE="[mono-android] Activity leaking Service Connection.">julian.booth at rpsgroup.com
       </A><BR>
    <I>Wed Sep 26 14:13:41 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="012451.html">[mono-android] Activity leaking Service Connection.
</A></li>
        <LI>Next message: <A HREF="012447.html">[mono-android] Debugger won't launch anymore in VS2012
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12452">[ date ]</a>
              <a href="thread.html#12452">[ thread ]</a>
              <a href="subject.html#12452">[ subject ]</a>
              <a href="author.html#12452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I guess some of the code may help (I've removed what didn't seem relevant):

Service, Service Connection and Binder:

namespace Services
{
    [Service]
    public class LoginService: IntentService
    {
        public event Action LoggedIn;
        public event Action&lt;String&gt; LogInFailed;
        public event Action&lt;String&gt; LogInCrashed; 

        LoginServiceBinder Binder { get; set; }

        public LoginService()
            : base()
        {
            Binder = new LoginServiceBinder(this); 
        }

        public override IBinder OnBind(Intent intent)
        {
            base.OnBind(intent);
            return Binder;
        }

        protected override void OnHandleIntent(Intent intent)
        {
            try
            {
                ....Does some work here to log the user in...
                
            }
            catch (Exception ex)
            {
                if (LogInCrashed != null) LogInCrashed(ex.Message);
            }
            finally
            {
                StopSelf();
            }
        }

     
    }

    public class LoginServiceBinder: Binder
    {
        public LoginService Service { get; private set; }

        public LoginServiceBinder(LoginService service)
        {
            Service = service; 
        }
    }

    public class LoginServiceConnection : Java.Lang.Object,
IServiceConnection
    {
        public event Action&lt;LoginService&gt; Connected;
        public event Action Disconnected;

        public void OnServiceConnected(ComponentName className, IBinder
binder)
        {
            if (Connected != null) Connected((binder as
LoginServiceBinder).Service); 
        }

        public void OnServiceDisconnected(ComponentName className)
        {
            if (Disconnected != null) Disconnected(); 
        }
    }
}

Activity: 


    public class LoginActivity : Activity
    {
        private ProgressDialog ProgressDialog { get; set; }

        private Services.LoginServiceConnection LoginServiceConnection;
        private Boolean LoginServiceBound;

        protected override void OnCreate(Bundle bundle)
        {
            base.OnCreate(bundle);

            //Use UI created in Main.axml
            SetContentView(Resource.Layout.Login);
            
            SetUpLoginService();
            
            //Set up login button
            Button login = FindViewById&lt;Button&gt;(Resource.Id.Login);
            login.Click += Login;
        }

        protected override void OnPause()
        {
            if (LoginServiceBound)
            {
                UnbindService(LoginServiceConnection);
            }
            base.OnPause();
        }

        protected override void OnResume()
        {
            base.OnResume();
        }

        protected override void OnDestroy()
        {
            if (LoginServiceBound)
            {
                UnbindService(LoginServiceConnection);
            }
            base.OnDestroy();
        }

      
        private void SetUpLoginService()
        {
            LoginServiceConnection = new Services.LoginServiceConnection();
            LoginServiceConnection.Connected += (Services.LoginService
service) =&gt;
            {
                Android.Util.Log.Info(&quot;App&quot;, &quot;Bound to checkin service&quot;);

                service.LoggedIn += () =&gt;
                {
                    RunOnUiThread(() =&gt;
                        {
                            ProgressDialogDismiss();
                            //Updated user works so carry on to the
homepage.
                            GoHome();
                        
                        });
                };

                service.LogInFailed += (message) =&gt;
                {
                    RunOnUiThread(() =&gt;
                    {
                        ProgressDialogDismiss();
                       
FindViewById&lt;TextView&gt;(Resource.Id.LoginWarning).Text = message;
                        Toast.MakeText(this, message,
ToastLength.Long).Show();
                    });
                };

                service.LogInCrashed += (message) =&gt;
                {
                    RunOnUiThread(() =&gt;
                    {
                        ProgressDialogDismiss();
                        Toast.MakeText(this, message,
ToastLength.Long).Show(); 
                    });
                };
            };

            LoginServiceConnection.Disconnected += () =&gt;
            {
                RunOnUiThread(() =&gt;
                {
                    LoginServiceBound = false;
                });
            };
        }



        protected void Login(Object sender, EventArgs e)
        {
            ProgressDialog = Android.App.ProgressDialog.Show(this,
GetString(Resource.String.please_wait),
GetString(Resource.String.logging_in), true);

            AutoCompleteTextView txtUsername =
FindViewById&lt;AutoCompleteTextView&gt;(Resource.Id.username);
            EditText txtPassword =
FindViewById&lt;EditText&gt;(Resource.Id.password);

            var login = new Intent(this, typeof(Services.LoginService))
                .PutExtra(&quot;Username&quot;, txtUsername.Text)
                .PutExtra(&quot;Password&quot;, txtPassword.Text);

            ProgressDialog.Show();

            StartService(login);
            BindService(new Intent(this, typeof(Services.LoginService)),
LoginServiceConnection, Bind.AdjustWithActivity);  
        }

        private void ProgressDialogDismiss()
        {
            if (ProgressDialog != null)
            {
                try
                {
                    ProgressDialog.Dismiss();
                }
                catch (Exception ex)
                {
                    Android.Util.Log.Error(&quot;App&quot;, ex.Message);
                    Toast.MakeText(this, ex.Message,
ToastLength.Long).Show();
                }
            }
        }
    }



--
View this message in context: <A HREF="http://mono-for-android.1047100.n5.nabble.com/Activity-leaking-Service-Connection-tp5711968p5711969.html">http://mono-for-android.1047100.n5.nabble.com/Activity-leaking-Service-Connection-tp5711968p5711969.html</A>
Sent from the Mono for Android mailing list archive at Nabble.com.
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012451.html">[mono-android] Activity leaking Service Connection.
</A></li>
	<LI>Next message: <A HREF="012447.html">[mono-android] Debugger won't launch anymore in VS2012
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12452">[ date ]</a>
              <a href="thread.html#12452">[ thread ]</a>
              <a href="subject.html#12452">[ subject ]</a>
              <a href="author.html#12452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
