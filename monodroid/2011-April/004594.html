<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] App crashes with background thread,	perhaps due to GC
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20App%20crashes%20with%20background%20thread%2C%0A%09perhaps%20due%20to%20GC&In-Reply-To=1303983678179-4346111.post%40n5.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004586.html">
   <LINK REL="Next"  HREF="004599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] App crashes with background thread,	perhaps due to GC</H1>
    <B>Andrew Sinclair</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20App%20crashes%20with%20background%20thread%2C%0A%09perhaps%20due%20to%20GC&In-Reply-To=1303983678179-4346111.post%40n5.nabble.com"
       TITLE="[mono-android] App crashes with background thread,	perhaps due to GC">andrew at magic5software.com
       </A><BR>
    <I>Thu Apr 28 09:23:23 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004586.html">[mono-android] App crashes with background thread, perhaps due to GC
</A></li>
        <LI>Next message: <A HREF="004599.html">[mono-android] App crashes with background thread, perhaps due to GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4594">[ date ]</a>
              <a href="thread.html#4594">[ thread ]</a>
              <a href="subject.html#4594">[ subject ]</a>
              <a href="author.html#4594">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andreas,

I've seen that same assertion, in addition to the:

&quot;Assertion at ../../../../mono/metadata/sgen-internal.c:441, condition
`mh-&gt;size == size + sizeof (LargeInternalMemHeader)' not met&quot;

one that I logged on Bugzilla. Plus another similar one which I can't
remember. It's definitely related to the GC.

I found that using GC.Collect(0) in strategic places has helped reduce the
problem a lot. It's almost as though when the GC kicks in and there's a lot
of things waiting to be collected it has a problem, but if there are
frequent smaller GCs then it seems to cope better.  For instance, I created
a simple Activity and opened and closed it 20 times - it would usually crash
with one of these errors. Then I added in a GC.Collect(0) after each Close
(with no explicit Dispose() or any other changes) and the problem went away
(the Activity could be opened and closed 100 times with no issue.)

With a background thread behaving in a similar way to yours, I added
GC.Collect(0) between web requests and the problem is less frequent.

Having said all of this, the fact is that these errors can still occur and I
think there's an underlying weakness somewhere in the GC. I can understand
that applications will have problems if they're not disposing of resources
often enough, but I don't see why that should lead to internal issues in the
GC (rather than just slowing things down and using too much memory.)

Andy


-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A>
[mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A>] On Behalf Of subsembly
Sent: 28 April 2011 10:41
To: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid at lists.ximian.com</A>
Subject: [mono-android] App crashes with background thread, perhaps due to
GC

Hi all,

I am currently porting a Mobile Banking App that creates a background worker
thread which does a lot of network access and processing. Unfortunately,
when updating many accounts online the backgroud thread always crashes the
App (black screen and restart of the App). The very same code works
flawlessly on the .NET Framework (desktop), on Windows Mobile .NETCF and
even on the iPhone with MonoTouch. The captured logging output lets me
assume that the problem is perhaps somewhere in the GC of MonoDroid.

Here is the logging, captured with todays Mono for Android 1.0.1 release on
a LG Optimus One device with Android 2.2:

I/ActivityManager( 1372): Displayed activity
subsembly.banking/.OnlineBankingActivity: 892 ms (total 892 ms)
I/MainActivity(26143): OnStop
F/MonoDroid(26143): ERROR: Unable to detach current thread from the Java VM!
F/MonoDroid(26143): ERROR: Unable to detach current thread from the Java VM!
F/MonoDroid(26143): ERROR: Unable to detach current thread from the Java VM!
F/MonoDroid(26143): ERROR: Unable to detach current thread from the Java VM!
F/MonoDroid(26143): ERROR: Unable to detach current thread from the Java VM!
F/mono    (26143): * Assertion: should not be reached at
../../../../mono/metadata/sgen-marksweep.c:279
I/ActivityManager( 1372): Process subsembly.banking (pid 26143) has died.

I wonder what these &quot;ERROR: Unable to detach current thread from the Java
VM!&quot; mean. They often occur but usually do not seem to be harmful.

The assertion from &quot;sgen-marksweep.c&quot; is what makes me assume that the
problem could perhaps be due to the GC.

As an addtional info: The background thread uses a Activity.RunOnUiThread()
callback in order to post progress information to the GUI. Could it be that
issue documented under &quot;Dalvik GC&quot; on the page
<A HREF="http://mono-android.net/Documentation/GC">http://mono-android.net/Documentation/GC</A> has something to do with the
problem? To be honest, I still do not understand that issue.

Andreas


--
View this message in context:
<A HREF="http://mono-for-android.1047100.n5.nabble.com/App-crashes-with-background-th">http://mono-for-android.1047100.n5.nabble.com/App-crashes-with-background-th</A>
read-perhaps-due-to-GC-tp4346111p4346111.html
Sent from the Mono for Android mailing list archive at Nabble.com.
_______________________________________________
Monodroid mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>

UNSUBSCRIBE INFORMATION:
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004586.html">[mono-android] App crashes with background thread, perhaps due to GC
</A></li>
	<LI>Next message: <A HREF="004599.html">[mono-android] App crashes with background thread, perhaps due to GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4594">[ date ]</a>
              <a href="thread.html#4594">[ thread ]</a>
              <a href="subject.html#4594">[ subject ]</a>
              <a href="author.html#4594">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
