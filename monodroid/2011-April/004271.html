<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Crash in Bitmap.Compress()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Crash%20in%20Bitmap.Compress%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004289.html">
   <LINK REL="Next"  HREF="004284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Crash in Bitmap.Compress()</H1>
    <B>Nikolai Sander</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20Crash%20in%20Bitmap.Compress%28%29&In-Reply-To="
       TITLE="[mono-android] Crash in Bitmap.Compress()">nikolai at eodsoft.com
       </A><BR>
    <I>Tue Apr 12 03:19:13 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004289.html">[mono-android] WEbview
</A></li>
        <LI>Next message: <A HREF="004284.html">[mono-android] Crash in Bitmap.Compress()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4271">[ date ]</a>
              <a href="thread.html#4271">[ thread ]</a>
              <a href="subject.html#4271">[ subject ]</a>
              <a href="author.html#4271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to save a bitmap that I copied from my OpenGL view to disk and after 3-4 successful saves the app crashes. Here's the code:

It always crashes in bmp.Compress(). Any ideas?

Thanks!
Nikolai


          public Bitmap SavePixels(int x, int y, int w, int h)   
        {
            int size = w * h;
            int[] b=new int[size];               
            GLT.CheckError();
            GL.ReadPixels&lt;int&gt;(x, y, w, h, All.Rgba, All.UnsignedByte, b);
            GLT.CheckError();

            Bitmap sb = Bitmap.CreateBitmap(w, h, Bitmap.Config.Rgb565);
            sb.SetPixels(b, w * h - width, -width, 0, 0, width, height);
  
            return sb;
  
        }
  
        public void SavePNG(String name)
        {
            bool wasPaused = ParticleSystem.ThePS.Paused;
            ParticleSystem.ThePS.Paused = true;
            Util.Log(&quot;Save PNG&quot;);
            Bitmap bmp = SavePixels(0, 0, this.width, this.height);
            try
            {                
                string filePath = null;

                if (Android.OS.Environment.ExternalStorageState != Android.OS.Environment.MediaMounted)
                    filePath = System.IO.Path.Combine(&quot;/mnt/media/My Files/Pictures/&quot;, name);    
                else
                    filePath = System.IO.Path.Combine(&quot;/mnt/sdcard/My Files/Pictures/&quot;, name);
                
                Util.Log(&quot;Trying file &quot;+filePath);
                FileStream s;
                try
                {
                    s = File.Create(filePath);
                    Util.Log(&quot;Created File&quot;);
                    bmp.Compress(Bitmap.CompressFormat.Png, 100, s);
                    Util.Log(&quot;Compressed File&quot;);
                }
                catch
                {
                    try
                    {
                        if (Android.OS.Environment.ExternalStorageState != Android.OS.Environment.MediaMounted)
                            filePath = System.IO.Path.Combine(&quot;/mnt/media/&quot;, name+&quot;b&quot;);
                        else
                            filePath = System.IO.Path.Combine(&quot;/mnt/sdcard/&quot;, name + &quot;b&quot;);
                        Util.Log(&quot;Trying again &quot;+filePath);
                        s = File.Create(filePath);
                        bmp.Compress(Bitmap.CompressFormat.Png, 100, s);
                    }
                    catch
                    {
                        return;// bailing out
                    }
                }

                try
                {
                    Util.Log(&quot;Flush&quot;);
                    s.Flush();
                }
                catch (IOException e)
                {
                    Util.Log(&quot;flush failed!&quot;);
                }
                try
                {
                    s.Close();

                }
                catch (IOException e)
                {
                    Util.Log(&quot;close failed!&quot;);
                }
                Util.Log(&quot;Dispose1&quot;);
                s.Dispose();
                Util.Log(&quot;Dispose2&quot;);
                bmp.Dispose();
                s = null;
                bmp = null;
            }
            catch (FileNotFoundException e)
            {
                // TODO Auto-generated catch block
                Util.Log(&quot;file not found exception&quot;);
            }
            finally
            {
                ParticleSystem.ThePS.Paused = wasPaused;
                SpawnActivity.Activity.RunOnUiThread(delegate { MenuManager.TheMM.MainMenu.RemoveSavingImageStatus(); });
            }
            Util.Log(&quot;Done&quot;);
            
        }


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/mailman/private/monodroid/attachments/20110412/2862d1bf/attachment-0001.html">http://lists.ximian.com/mailman/private/monodroid/attachments/20110412/2862d1bf/attachment-0001.html</A> 
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004289.html">[mono-android] WEbview
</A></li>
	<LI>Next message: <A HREF="004284.html">[mono-android] Crash in Bitmap.Compress()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4271">[ date ]</a>
              <a href="thread.html#4271">[ thread ]</a>
              <a href="subject.html#4271">[ subject ]</a>
              <a href="author.html#4271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
