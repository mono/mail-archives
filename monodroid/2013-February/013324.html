<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] KeyChain API on Android 4.1 and client	certificate authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CEFB98260-510A-4E6D-8072-ED631F375C44%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013323.html">
   <LINK REL="Next"  HREF="013325.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] KeyChain API on Android 4.1 and client	certificate authentication</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CEFB98260-510A-4E6D-8072-ED631F375C44%40xamarin.com%3E"
       TITLE="[mono-android] KeyChain API on Android 4.1 and client	certificate authentication">jonp at xamarin.com
       </A><BR>
    <I>Thu Feb 14 21:00:47 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="013323.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
        <LI>Next message: <A HREF="013325.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13324">[ date ]</a>
              <a href="thread.html#13324">[ thread ]</a>
              <a href="subject.html#13324">[ subject ]</a>
              <a href="author.html#13324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Feb 14, 2013, at 3:20 PM, Nikola &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">anusev at gmail.com</A>&gt; wrote:
&gt;<i> This is not what I want to achieve. What am I trying to do here is, I believe, &quot;officially&quot; called Mutual SSL authentication.
</I>...
&gt;<i> I am pretty sure you are already familiar with how the SSL handshake works :), I just want to be absolutely positive we are on the same page here.
</I>
This is very helpful context. Thank you. :-)

I'm not nearly as familiar with SSL as would be handy at times like this...

&gt;<i> With that in mind, I'll try to rephrase the problem again.  To complete the SSL handshake, it is necessary to encypt some random piece of data with client's private key. The private key used for the encryption is normally stored in X509Certificate2.PrivateKey property - when using such X509Certificate2 with HttpWebRequest, the SSL handshake completes
</I>&gt;<i> successfully and everything is great. 
</I>&gt;<i> 
</I>&gt;<i> On Android, my app uses the KeyChain to get its hands on the certificate and private key.
</I>
Obvious question: Why do you need to use the KeyChain API? Why not just include your client certificate in your app and then use it?

That aside...

&gt;<i> Now, to be able to use .NET HTTP stack and Mutual SSL authentication, I have to create an X509Certificate2 instance and set it up with a private key from the KeyChain. To do that, I have to convert that key to raw bytes, which is no longer possible with Android 4.1 (my original post).
</I>
I believe that this behavior isn't a Mono for Android bug, but an Android change (as per your description, behavior is dependent upon the Android version). Which is known; the question thus becomes how to workaround Android's breakage.

Related: We DID have a bug in KeyStore.Load() handling (no bug number), in which a NullReferenceException would be thrown when calling KeyStore.Load(null, null). This should be fixed in 4.4.x (not sure exact fix date). However, I don't think you're hitting this, as the stack trace you provided doesn't match the one in the commit message...

Related 2: your earlier reported exception that smells like a bug, but I can't repro it (and thus would love one):

&gt;<i>   {System.NullReferenceException: Object reference not set to an instance of an object
</I>&gt;<i>      at Android.Runtime.JNIEnv.CallObjectMethod (IntPtr jobject, IntPtrjmethod)
</I>&gt;<i>      at Java.Net.URLConnection.get_InputStream ()
</I>&gt;<i>     ...
</I>

By any chance is your code using multiple threads?

&gt;<i> It is not that simple to provide you with a complete sample - generally spekaing, to reproduce this, there needs to be a complete environment with HTTPS server requiring client certificates as a part of SSL handshake and any Android 4.1 device with the proper client certificate installed.
</I>
&lt;groan&gt;

&gt;<i> If you think it would help to resolve this, I can prepare such an environment relatively quickly.
</I>
Unfortunately it looks like it's not possible to reproduce the problem without the corresponding environment. With reference to an earlier message about using JNIEnv to invoke the private Android methods, I could provide you that code, but I'd have no way to test it to see that it actually works.

I'll provide that code in a bit; if that doesn't help you, let's see about getting a full repro...

Thanks,
 - Jon

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013323.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
	<LI>Next message: <A HREF="013325.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13324">[ date ]</a>
              <a href="thread.html#13324">[ thread ]</a>
              <a href="subject.html#13324">[ subject ]</a>
              <a href="author.html#13324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
