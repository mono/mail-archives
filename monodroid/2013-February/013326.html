<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] KeyChain API on Android 4.1 and client	certificate authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CCFFD31B1-7555-4E11-ABD6-58EE29150339%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013346.html">
   <LINK REL="Next"  HREF="013307.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] KeyChain API on Android 4.1 and client	certificate authentication</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CCFFD31B1-7555-4E11-ABD6-58EE29150339%40xamarin.com%3E"
       TITLE="[mono-android] KeyChain API on Android 4.1 and client	certificate authentication">jonp at xamarin.com
       </A><BR>
    <I>Thu Feb 14 22:29:03 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="013346.html">[mono-android] KeyChain API on Android 4.1 and client	certificate authentication
</A></li>
        <LI>Next message: <A HREF="013307.html">[mono-android] Critical bug with alternative layouts (sw&lt;N&gt;dp,	etc..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13326">[ date ]</a>
              <a href="thread.html#13326">[ thread ]</a>
              <a href="subject.html#13326">[ subject ]</a>
              <a href="author.html#13326">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Feb 14, 2013, at 4:00 PM, Jonathan Pryor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">jonp at xamarin.com</A>&gt; wrote:
&gt;<i> I'll provide that code in a bit; if that doesn't help you, let's see about getting a full repro...
</I>
Bwa-ha-ha-ha-ha-ah-ha *cough* *splutter*

Firstly, the links I previously provided have been invalidated due to refactoring (yay). That'll teach me to provide links into &quot;master&quot; instead of a proper revision. The mythical processSignJellyBeans() method is now at:

	<A HREF="http://code.google.com/p/ics-openvpn/source/browse/src/de/blinkt/openvpn/VpnProfile.java?spec=svn77efc1af3b4d7a02864f21eb93a92f8568e9f5f0&amp;r=77efc1af3b4d7a02864f21eb93a92f8568e9f5f0#806">http://code.google.com/p/ics-openvpn/source/browse/src/de/blinkt/openvpn/VpnProfile.java?spec=svn77efc1af3b4d7a02864f21eb93a92f8568e9f5f0&amp;r=77efc1af3b4d7a02864f21eb93a92f8568e9f5f0#806</A>

The processSignJellyBeans() method does two things:

1. Extract the &quot;integer pointer to EVP_pkey&quot; from the PrivateKey.
2. Sign data with it.

(1) is reasonably straightforward:

        // ~line by line port of part of processSignJellyBeans():
        // <A HREF="http://code.google.com/p/ics-openvpn/source/browse/src/de/blinkt/openvpn/VpnProfile.java?spec=svn77efc1af3b4d7a02864f21eb93a92f8568e9f5f0&amp;r=77efc1af3b4d7a02864f21eb93a92f8568e9f5f0#806">http://code.google.com/p/ics-openvpn/source/browse/src/de/blinkt/openvpn/VpnProfile.java?spec=svn77efc1af3b4d7a02864f21eb93a92f8568e9f5f0&amp;r=77efc1af3b4d7a02864f21eb93a92f8568e9f5f0#806</A>
        public static int GetPrivateKeyHandle (IPrivateKey privkey)
        {
            var _privkey                        = privkey.JavaCast&lt;Java.Lang.Object&gt;();
            IntPtr privkey_class                = _privkey.Class.Superclass.Handle;
            IntPtr getKey                       = JNIEnv.GetMethodID (privkey_class, &quot;getOpenSSLKey&quot;, &quot;()Lorg/apache/harmony/xnet/provider/jsse/OpenSSLKey;&quot;);
            IntPtr opensslkey                   = JNIEnv.CallObjectMethod (privkey.Handle, getKey);
            IntPtr opensslkey_class             = JNIEnv.GetObjectClass (opensslkey);
            IntPtr opensslkey_getPkeyContext    = JNIEnv.GetMethodID (opensslkey_class, &quot;getPkeyContext&quot;, &quot;()I&quot;);
            int pkey                            = JNIEnv.CallIntMethod (opensslkey, opensslkey_getPkeyContext);

            JNIEnv.DeleteLocalRef (opensslkey);
            JNIEnv.DeleteLocalRef (opensslkey_class);

            return pkey;
        }

The only &quot;requirement&quot; here is having an Android source checkout to help create the JNI method signatures for method lookup.

(2) is the &quot;interesting&quot; bit, and by &quot;interesting&quot; I mean &quot;start praying to your favorite deity.&quot;

What ics-openvpn's de.blinkt.openvpn.VpnProfile.processSignJellyBeans() method does is call the `native` VpnProfile.rsasign() method, which (as mentioned earlier) isn't entirely possible right now because JNIEnv.Handle isn't public.

That's actually easily worked around; just use .NET reflection to grab the JNIEnv.Handle property value. However, that's not the real problem.

Alternatively, the native VpnProfile.rsasign() function could be ported to C#. I don't think this would be too difficult:

	<A HREF="http://code.google.com/p/ics-openvpn/source/browse/jni/jbcrypto.cpp#44">http://code.google.com/p/ics-openvpn/source/browse/jni/jbcrypto.cpp#44</A>

Again, that's not the real problem.

The real problem is that it looks like ics-openvpn works by embedding a COPY of openssl into ics-openvpn!

	<A HREF="http://code.google.com/p/ics-openvpn/source/browse#hg%2Fopenssl">http://code.google.com/p/ics-openvpn/source/browse#hg%2Fopenssl</A>

We are no longer in the realm of Java vs. C#. We're in the realm of &quot;what dependencies do you want your project to have?&quot;

If your app can depend on an ics-openvpn binary/package being installed on the target device (can it?), then you should be able to derive a P/Invoke into libopvpnutil.so!Java_de_blinkt_openvpn_VpnProfile_rsasign():

	[DllImport (&quot;/data/data/@TODO_ics-openvpn_PACKAGE_NAME@/lib/libopenvpnutil.so&quot;)]
	static extern IntPtr Java_de_blinkt_openvpn_VpnProfile_rsasign (IntPtr env, IntPtr klass, IntPtr array, int pkeyRef);

        public static IntPtr GetJniEnvHandle ()
        {
            var handleP = typeof(JNIEnv).GetProperty (&quot;Handle&quot;, BindingFlags.NonPublic | BindingFlags.Static);
            if (handleP == null)
                throw new NotSupportedException (&quot;This doesn't look like Mono for Android...&quot;);
            var handle = (IntPtr) handleP.GetValue (null, null);
            if (handle == IntPtr.Zero)
                throw new InvalidOperationException (&quot;Unpossible!&quot;);
            return handle;
        }

	...

	byte[] data = ...
	IntPtr javaData = JNIEnv.NewArray(data);
	IntPtr signedJavaData = Java_de_blinkt_openvpn_VpnProfile_rsasign (GetJniEnvHandle (), IntPtr.Zero, javaData, GetPrivateKeyHandle (privkey));
	byte[] signedData = JNIEnv.GetArray&lt;byte&gt;(signedJavaData);
	JNIEnv.DeleteLocalRef(signedJavaData);

If your app can't depend on ics-openvpn being installed...then you need to do what they're doing: embed openssl into your app, at which  point you can port Java_de_blinkt_openvpn_VpnProfile_rsasign() to C# and just P/Invoke into your embedded openssl for the implementation.

What's &quot;interesting&quot; is that stackoverflow suggested that you could use libkeystore.so, but I don't see how this would help (particularly as I don't see an RSA_sign() export in libkeystore.so):

	<A HREF="http://stackoverflow.com/a/11387344/83444">http://stackoverflow.com/a/11387344/83444</A>

So I fail to see how libkeystore.so would be useful here. :-/

All of the above makes me wonder if we're missing something. android.security.KeyStore looks entirely useless, as you can't get anything out of it, so what's the point?

It would appear, then, that using HttpsURLConnection is (hopefully?) the way to go.

By any chance could you create a small repro for NullReferenceException? Or does it only occur in this environment?

 - Jon

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013346.html">[mono-android] KeyChain API on Android 4.1 and client	certificate authentication
</A></li>
	<LI>Next message: <A HREF="013307.html">[mono-android] Critical bug with alternative layouts (sw&lt;N&gt;dp,	etc..)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13326">[ date ]</a>
              <a href="thread.html#13326">[ thread ]</a>
              <a href="subject.html#13326">[ subject ]</a>
              <a href="author.html#13326">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
