<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] KeyChain API on Android 4.1 and client	certificate authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CF487E547-84D8-4DAC-B2B0-041E5161CD6E%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013343.html">
   <LINK REL="Next"  HREF="013326.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] KeyChain API on Android 4.1 and client	certificate authentication</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20KeyChain%20API%20on%20Android%204.1%20and%20client%0A%09certificate%20authentication&In-Reply-To=%3CF487E547-84D8-4DAC-B2B0-041E5161CD6E%40xamarin.com%3E"
       TITLE="[mono-android] KeyChain API on Android 4.1 and client	certificate authentication">jonp at xamarin.com
       </A><BR>
    <I>Tue Feb 19 01:41:17 UTC 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="013343.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
        <LI>Next message: <A HREF="013326.html">[mono-android] KeyChain API on Android 4.1 and client	certificate authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13346">[ date ]</a>
              <a href="thread.html#13346">[ thread ]</a>
              <a href="subject.html#13346">[ subject ]</a>
              <a href="author.html#13346">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Feb 18, 2013, at 10:17 AM, Nikola &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">anusev at gmail.com</A>&gt; wrote:
&gt;<i> I've sent you all necessary details to reproduce the NullReference exception.
</I>
Thank you. I'll investigate this tomorrow.

&gt;&gt;<i> I'm told by the resident SSL expert ... and this RSA instance will be used in the SSL handshake logic. 
</I>...
&gt;<i> The last line fails with the following horrible exception:
</I>&gt;<i> 
</I>&gt;<i> System.Net.WebException: ... ---&gt; Java.Lang.ArrayIndexOutOfBoundsException: Exception of type 'Java.Lang.ArrayIndexOutOfBoundsException' was thrown.
</I>...
&gt;<i> java.lang.ArrayIndexOutOfBoundsException: too much data for RSA block
</I>&gt;<i>  at com.android.org.bouncycastle.jce.provider.JCERSACipher.engineDoFinal(JCERSACipher.java:450)
</I>&gt;<i>  at javax.crypto.Cipher.doFinal(Cipher.java:1111)
</I>...

As with many things in Android, you need to (1) read _very_ carefully, and (2) frequently need to dig into the Android source code.

Regarding (1), the error is that you're passing &quot;too much data for RSA block.&quot;

Regarding (2), having an AOSP source checkout is invaluable...

	<A HREF="http://source.android.com/source/index.html">http://source.android.com/source/index.html</A>

JCERSACipher.java:450 leads us ~here: <A HREF="http://www.docjar.org/html/api/org/bouncycastle/jce/provider/JCERSACipher.java.html#441">http://www.docjar.org/html/api/org/bouncycastle/jce/provider/JCERSACipher.java.html#441</A>

	  449                   throw new ArrayIndexOutOfBoundsException(&quot;too much data for RSA block&quot;);

(What's a line or ten among friends and URI anchors?)

In short, I don't think you can pass the entire buffer to DoFinal(byte[]) as you're doing in CustomRSA.DecryptValue() and CustomRSA.EncryptValue(). I believe you'll need to do it &quot;piecewise&quot;, presumably with (repeated?) calls to Cipher.Update(byte[]):

	<A HREF="http://developer.android.com/reference/javax/crypto/Cipher.html#update(byte[">http://developer.android.com/reference/javax/crypto/Cipher.html#update(byte[</A>])

Alternatively (relatedly?):

1. The exception could be due to the use of the wrong API: .NET DecryptValue() is a &quot;raw&quot; (unpadded) decryption (which is what is required here since SSL has it's own padding
requirements), while Decrypt expect a padded input;

2. Endianness: some BigInteger library reverse the byte stream

&gt;<i> I am not really sure why the Mono.Security.Cryptography.PKCS1.Sign_v15 method calls the CustomRSA.DecryptValue method - I would expect that signing would involve encryption of bytes, not their decryption.
</I>
Quoting my SSL expert:

The fact that DecryptValue is called is normal; it's a bit misleading but RSA is foremost used for encryption so those name are used in the API, e.g.

Encryption: anybody (public) can encrypt something only you (private) can decrypt.

So the API is named:
* Encrypt: when using the public key
* Decrypt: when using the private key

Signature: only you (private) can sign a document that anybody (public) can verify.

Reusing the same API you find yourself using Decrypt to sign :-)

In short, it looks like your RSA class is correct, semantically, it's the implementation that is not (as Java is complaining about how you're calling it).

 - Jon

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013343.html">[mono-android] KeyChain API on Android 4.1 and client certificate authentication
</A></li>
	<LI>Next message: <A HREF="013326.html">[mono-android] KeyChain API on Android 4.1 and client	certificate authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13346">[ date ]</a>
              <a href="thread.html#13346">[ thread ]</a>
              <a href="subject.html#13346">[ subject ]</a>
              <a href="author.html#13346">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
