<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Getting intermittent calls to AsyncTask(IntPtr,	Android.Runtime.JniHandleOwnership)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Getting%20intermittent%20calls%20to%20AsyncTask%28IntPtr%2C%0A%09Android.Runtime.JniHandleOwnership%29&In-Reply-To=%3CE4D0519F-80EB-4E72-AE0C-6712727A0A2D%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008914.html">
   <LINK REL="Next"  HREF="008918.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Getting intermittent calls to AsyncTask(IntPtr,	Android.Runtime.JniHandleOwnership)</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Getting%20intermittent%20calls%20to%20AsyncTask%28IntPtr%2C%0A%09Android.Runtime.JniHandleOwnership%29&In-Reply-To=%3CE4D0519F-80EB-4E72-AE0C-6712727A0A2D%40xamarin.com%3E"
       TITLE="[mono-android] Getting intermittent calls to AsyncTask(IntPtr,	Android.Runtime.JniHandleOwnership)">jonp at xamarin.com
       </A><BR>
    <I>Thu Feb 16 16:29:46 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="008914.html">[mono-android] Getting intermittent calls to AsyncTask(IntPtr, Android.Runtime.JniHandleOwnership)
</A></li>
        <LI>Next message: <A HREF="008918.html">[mono-android] Custom AutocolpleteTextView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8919">[ date ]</a>
              <a href="thread.html#8919">[ thread ]</a>
              <a href="subject.html#8919">[ subject ]</a>
              <a href="author.html#8919">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Feb 16, 2012, at 12:01 AM, <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">chris at Terrago</A> wrote:
&gt;<i> I occasionally get external calls to my class' constructor with the following prototype: 	
</I>&gt;<i> AsyncTask(IntPtr, Android.Runtime.JniHandleOwnership).
</I>
The (IntPtr, JniHandleOwnership) constructor is needed whenever a Java object will be exposed to managed code and a wrapper needs to be created. For example, if some Java code creates a java.lang.String instance and that String is exposed to managed code (via method invocation), then the Java.Lang.String(IntPtr, JniHandleOwnership) constructor will be called to wrap the java.lang.String instance.

Once a wrapper has been created, an internal mapping is kept between the Java object and the managed wrapper. This mapping is maintained until both the Java and managed objects are collected by both the Dalvik and Mono GCs, OR until Java.Lang.Object.Dispose() is invoked. Calling Dispose() will break the mapping, allowing both objects to be collected earlier than they otherwise would be.

Here's the problem: if you have an AsyncTask subclass that you create, the creation will implicitly create a corresponding Java object and the mapping between the Java instance and your C# instance. If there is a request for an AsyncTask(IntPtr, JniHandleOwnership) constructor, that means that the mapping was somehow broken, and the Java instance is being re-exposed to managed code.

The problem here is that the execution of a constructor implies the creation of a new instance, meaning the &quot;loss&quot; of any instance state (because you now have a new object with `null`ed out instance data). This is very likely Bad&#8482;, as it will likely result in very subtle bugs (&quot;why is this variable null?!&quot;). :-)

I would check your code to ensure that you're not calling Dispose() on your AsyncTask instance, or if you are calling Dispose() that you're not calling it prematurely. You should only call Dispose() when you KNOW that either:

1. the instance is &quot;just&quot; a wrapper, e.g. Java.Lang.String instances are &quot;just&quot; wrappers over Java instances. For such wrappers, it doesn't matter if the Java object re-enters managed code and a new wrapper is created.

2. the corresponding Java instance will NEVER be exposed to managed code again, and thus a wrapper will not need to be created for it.

&gt;<i> If I include a constructor of this form in my class as a pass through, everything appears fine
</I>...
&gt;<i> I have noticed that this call immediately precedes the throwing of an exception in code called by my AsyncTask
</I>
Is that exception a NullReferenceException? :-)

 - Jon

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008914.html">[mono-android] Getting intermittent calls to AsyncTask(IntPtr, Android.Runtime.JniHandleOwnership)
</A></li>
	<LI>Next message: <A HREF="008918.html">[mono-android] Custom AutocolpleteTextView
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8919">[ date ]</a>
              <a href="thread.html#8919">[ thread ]</a>
              <a href="subject.html#8919">[ subject ]</a>
              <a href="author.html#8919">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
