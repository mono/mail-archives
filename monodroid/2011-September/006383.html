<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] sharing violation trying to save a bitmap
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20sharing%20violation%20trying%20to%20save%20a%20bitmap&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006398.html">
   <LINK REL="Next"  HREF="006384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] sharing violation trying to save a bitmap</H1>
    <B>John Murray</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20sharing%20violation%20trying%20to%20save%20a%20bitmap&In-Reply-To="
       TITLE="[mono-android] sharing violation trying to save a bitmap">john at murray.gb.com
       </A><BR>
    <I>Fri Sep 23 06:57:53 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="006398.html">[mono-android] SQLite null reference.
</A></li>
        <LI>Next message: <A HREF="006384.html">[mono-android] sharing violation trying to save a bitmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6383">[ date ]</a>
              <a href="thread.html#6383">[ thread ]</a>
              <a href="subject.html#6383">[ subject ]</a>
              <a href="author.html#6383">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I cant understand what's going on here 

In MonoDevelop I just get an unhandled exception

In Vis studio I get more of a clue as it says there's a sharing violation 

 

Weirdly stepping through in the debugger it seems to go round the loop twice
(i.e. it steps down to Bitmap.compress then springs back to the File.Exists
line and steps through it again 

hence one can understand that if the stream is already open there may be a
sharing issue

But why does it go round twice?  It gets to the line Bitmap.Compress() then
loops back to File.Exists();

If I remove the File.Exists code then it crashes out at Bitmap.Compress with
the contradictory message

&quot;System.IO.IOException: Win32 IO returned ERROR_SUCCESS&quot;

 

If the File.Exists code is left in I get a sharing violation when it gets to
the Fielstream line 

Presumably because FS is still open having already run through that code
once before.

What is going on - why does it suddenly decide to revisit the earlier lines
of code? Or run through a line of code twice?

 

 

public static void saveBMP(Context cntxt,string filename)

        {

            if (File.Exists(filename))     // shouldn't have to do this if
FileShare.Delete is working as I understand it

            {

                File.Delete(filename);      // on second loop around it
deletes file but then there is an error with file does not exist

            }

 

            FileStream fs = new FileStream(filename, FileMode.Create,
FileAccess.Write, FileShare.Delete);

            System.IO.BufferedStream buf = new System.IO.BufferedStream(fs);

            Bitmap bmp = WXclass5.windmap;

            bmp.Compress(Bitmap.CompressFormat.Png, 90, buf);

            fs.Close();

            buf.Close();

            bmp = null;

            //fout.Close();

            WXclass5.pnglist = getlistpngs(cntxt);

        }

        

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/mailman/private/monodroid/attachments/20110923/bd3b6c80/attachment-0001.html">http://lists.ximian.com/mailman/private/monodroid/attachments/20110923/bd3b6c80/attachment-0001.html</A> 
</PRE>








































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006398.html">[mono-android] SQLite null reference.
</A></li>
	<LI>Next message: <A HREF="006384.html">[mono-android] sharing violation trying to save a bitmap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6383">[ date ]</a>
              <a href="thread.html#6383">[ thread ]</a>
              <a href="subject.html#6383">[ subject ]</a>
              <a href="author.html#6383">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
