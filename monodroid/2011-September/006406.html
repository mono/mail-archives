<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] sharing violation and a method which seems to run	twice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20sharing%20violation%20and%20a%20method%20which%20seems%20to%20run%0A%09twice&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006407.html">
   <LINK REL="Next"  HREF="006408.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] sharing violation and a method which seems to run	twice</H1>
    <B>John Murray</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20sharing%20violation%20and%20a%20method%20which%20seems%20to%20run%0A%09twice&In-Reply-To="
       TITLE="[mono-android] sharing violation and a method which seems to run	twice">john at murray.gb.com
       </A><BR>
    <I>Sat Sep 24 16:23:28 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="006407.html">[mono-android] Drag &amp; Drop
</A></li>
        <LI>Next message: <A HREF="006408.html">[mono-android] sharing violation and a method which seems to	run twice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6406">[ date ]</a>
              <a href="thread.html#6406">[ thread ]</a>
              <a href="subject.html#6406">[ subject ]</a>
              <a href="author.html#6406">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I posted a previous query on this - I have changed the thread calling but I
still have an very odd error

 

I Have a method called from a delegate on a simple button press
Button.Click+=delegate{GetWind(ds);}; 

 

This method checks if the given weather chart has already been downloaded
and saved to sdcard (and is current by its date tag) 

If not it downloads another wx chart and saves that 

 

What seems to happen is that it runs through the GetWind() routine twice and
encounters a sharing violation  or sometimes a java.land throw exception and
sometimes simply unhandled exception 

 

Usually happens when trying to save the bitmap (the save method is nothing
special - 

 WXclass5.windmap.Compress(Bitmap.CompressFormat.Png, 85, new
System.IO.FileStream(filename,FileMode.Create)); 

 

 

What seems to happen on stepping through debug is that it steps around a
second time and calls this save method twice and it is on this second time
around that the exception occurs

 

&lt;Sri&gt; has suggested that this might be due to running on several threads

I did call this method using   ThreadPool.QueueUserWorkItem(o =&gt;
GetWind(ds));

But I have taken that out (see below I have commented out UI lines 

SO there is no calling threads (as far as I can see ) 

 

Can anyone explain why this code doesn't work 

 

 

private void GetWind(string ds)     // ds is a date and time stamp for a
given wx chart

        {

                string filename = &quot;&quot;;

                string mystr = this.GetFileStreamPath(&quot;&quot;).ToString();

                filename = mystr + &quot;/wmap&quot; + WXclass5.altsel + &quot;#&quot; + ds +
&quot;$&quot; + WXclass5.windmapexpires + &quot;.png&quot;;     

                                int rtn =
WXclass5.checksavedwindmap(this,filename);

                                if ( rtn &lt; 0)

                {

                    try

                    {

                     WXclass5.getwindmap(ds, WXclass5.altsel.ToString());

                    filename = mystr + &quot;/wmap&quot; + WXclass5.altsel + &quot;#&quot; + ds
+ &quot;$&quot; + WXclass5.windmapexpires + &quot;.png&quot;;

                     WXclass5.saveBMP(this,filename);

                    }catch(System.Exception xe)

                                    { Toast.MakeText(this, &quot;Error load wx
wind \n&quot; + xe.Message, ToastLength.Long).Show();      }

                                }

                                else

                                {

                                                filename =
mystr+&quot;/&quot;+WXclass5.pnglist[rtn];

                                                FileStream fs = new
FileStream(filename, FileMode.Open, FileAccess.Read);

                                System.IO.BufferedStream buf = new
System.IO.BufferedStream(fs);

                                bm = BitmapFactory.DecodeStream(buf);

                                                    if (fs != null) 

                                                                    {

                                                                fs.Close();

                                                    }

                                            if (buf != null) 

                                                                    {

                                                buf.Close();

                                            }                  

                                WXclass5.windmap = bm; 

                                filename=&quot;&quot;;

                                }

 


        // RunOnUiThread( () =&gt;t1.Text = WXclass5.getaltstring());

                //            RunOnUiThread( () =&gt;
t1.SetBackgroundColor(Color.Transparent));

                //            RunOnUiThread( () =&gt;   t1.TextSize=16);


        //RunOnUiThread( () =&gt;i1.ImageMatrix.Set(mm));                  

        //RunOnUiThread( () =&gt;i1.SetImageBitmap(WXlass5.windmap));

                //RunOnUiThread( () =&gt;pb.Visibility=ViewStates.Invisible);

                                                

                                                i1.ImageMatrix.Set(mm);

 
i1.SetImageBitmap(WXclass5.windmap);

 
pb.Visibility=ViewStates.Invisible;            

     }

 

 

Any help would e much appreciated - been stuck on this for several days now

John Murray

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://lists.ximian.com/mailman/private/monodroid/attachments/20110924/d49eb3ac/attachment-0001.html">http://lists.ximian.com/mailman/private/monodroid/attachments/20110924/d49eb3ac/attachment-0001.html</A> 
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006407.html">[mono-android] Drag &amp; Drop
</A></li>
	<LI>Next message: <A HREF="006408.html">[mono-android] sharing violation and a method which seems to	run twice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6406">[ date ]</a>
              <a href="thread.html#6406">[ thread ]</a>
              <a href="subject.html#6406">[ subject ]</a>
              <a href="author.html#6406">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
