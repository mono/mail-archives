<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] JavaFinalize and .NET Finalizers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JavaFinalize%20and%20.NET%20Finalizers&In-Reply-To=%3CE3C3E5C1DB20E040A23772BAB822E364AA610514%40colo-mail-2.exchange2.ara.wan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014127.html">
   <LINK REL="Next"  HREF="014129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] JavaFinalize and .NET Finalizers</H1>
    <B>Jeremy A. Kolb - ARA/NED</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JavaFinalize%20and%20.NET%20Finalizers&In-Reply-To=%3CE3C3E5C1DB20E040A23772BAB822E364AA610514%40colo-mail-2.exchange2.ara.wan%3E"
       TITLE="[mono-android] JavaFinalize and .NET Finalizers">jkolb at ara.com
       </A><BR>
    <I>Tue Jun 21 19:40:46 UTC 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="014127.html">[mono-android] JavaFinalize and .NET Finalizers
</A></li>
        <LI>Next message: <A HREF="014129.html">[mono-android] JavaFinalize and .NET Finalizers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14128">[ date ]</a>
              <a href="thread.html#14128">[ thread ]</a>
              <a href="subject.html#14128">[ subject ]</a>
              <a href="author.html#14128">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Jon.  Reply is inline.

Jeremy

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A> [mailto:monodroid-
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">bounces at lists.ximian.com</A>] On Behalf Of Jonathan Pryor
</I>&gt;<i> Sent: Monday, June 20, 2016 10:52 PM
</I>&gt;<i> To: Monodroid for Android
</I>&gt;<i> Subject: Re: [mono-android] JavaFinalize and .NET Finalizers
</I>&gt;<i> 
</I>&gt;<i> On Jun 17, 2016, at 9:50 AM, Jeremy A. Kolb - ARA/NED &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">jkolb at ara.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> &gt; I'm investigating <A HREF="https://github.com/MvvmCross/MvvmCross/issues/1343">https://github.com/MvvmCross/MvvmCross/issues/1343</A>
</I>&gt;<i> for a possible memory leak related to our version of the RecyclerView widget
</I>&gt;<i> MvxRecyclerView and have run against an interesting issue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When swapping out the itemsource in the adapter the RecyclerView
</I>&gt;<i> instantiates ViewHolders but never seems to kill them no matter how many
</I>&gt;<i> times I force a GC.  If I add a &quot;~MvxRecyclerViewHolder()&quot;  method to
</I>&gt;<i> MvxRecyclerViewHolder I never get in there.  However I do hit the
</I>&gt;<i> JavaFinalize method and now I am completely confused.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Why would I hit the JavaFinalizer and not the .NET one?  There is never an
</I>&gt;<i> explicit Dispose on the MvxRecyclerView so I can't see why the Java -&gt; .NET
</I>&gt;<i> connection would be severed.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The only instance I've found where Xamarin uses JavaFinalize is at
</I>&gt;<i> <A HREF="https://github.com/xamarin/Xamarin.Forms/blob/master/Xamarin.Forms.Pl">https://github.com/xamarin/Xamarin.Forms/blob/master/Xamarin.Forms.Pl</A>
</I>&gt;<i> atform.Android/Renderers/GenericAnimatorListener.cs#L35 which doesn't
</I>&gt;<i> explain much.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Am I seeing a bug in Xamarin?  In MvvmCross's RecyclerView?  Or more
</I>&gt;<i> likely: am I just confused about the interaction of two garbage collectors.
</I>&gt;<i> 
</I>&gt;<i> The interaction is deep voodoo. :-)
</I>&gt;<i> 
</I>&gt;<i> As usual with these things, enable GREF logging:
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://developer.xamarin.com/guides/android/troubleshooting/tro">https://developer.xamarin.com/guides/android/troubleshooting/tro</A>
</I>&gt;<i> ubleshooting/#Global_Reference_Messages
</I>&gt;<i> 	<A HREF="https://developer.xamarin.com/releases/android/xamarin.android">https://developer.xamarin.com/releases/android/xamarin.android</A>_
</I>&gt;<i> 5/xamarin.android_5.1/#GREF_Logging_Changes
</I>&gt;<i> 
</I>&gt;<i> 	$ adb shell setprop debug.mono.log gref,gc
</I>&gt;<i> 
</I>&gt;<i> The relevant GC bridge code is `take_global_ref_jni()`,
</I>&gt;<i> `take_weak_global_ref_jni()`, and `gc_cross_references()`:
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://github.com/xamarin/xamarin-">https://github.com/xamarin/xamarin-</A>
</I>&gt;<i> android/blob/c3811e8/src/monodroid/jni/monodroid-glue.c#L1140-L1202
</I>&gt;<i> 	<A HREF="https://github.com/xamarin/xamarin-">https://github.com/xamarin/xamarin-</A>
</I>&gt;<i> android/blob/c3811e8/src/monodroid/jni/monodroid-glue.c#L1483-L1522
</I>&gt;<i> 
</I>&gt;<i> This is run as part of Mono&#8217;s GC bridge code&#8230;which I&#8217;m kinda flaky on. The
</I>&gt;<i> *general* idea is as follows:
</I>&gt;<i> 
</I>&gt;<i> 1. Mono&#8217;s GC looks for finalizable objects.
</I>&gt;<i> 2. When a finalizable instance has no more managed references, it&#8217;s placed
</I>&gt;<i> into some finalizer queue 3. *Before* the finalizer queue is emptied, the GC
</I>&gt;<i> bridge is queried to determine if the instance is *actually* finalizable.
</I>&gt;<i> 3.a. If the instance can be finalized, it will be during the next GC.
</I>&gt;<i> 3.b. If the instance can&#8217;t be finalized, it will be kept alive.
</I>&gt;<i> 
</I>&gt;<i> The GC bridge, in this context, is `gc_cross_references()`, which is given a set
</I>&gt;<i> of Java.Lang.Object instances, and:
</I>&gt;<i> 
</I>&gt;<i> 1. Toggles all the GREFs to Weak GREFs&#8230;for the *entire object graph* the
</I>&gt;<i> instance refers to. (Plus some mirroring of the object graph in Java-land&#8230;) 2.
</I>&gt;<i> Kicks off a Java-side GC.
</I>&gt;<i> 3. Checks to see if anything was collected. If it was collected, Mono&#8217;s GC is
</I>&gt;<i> told that the instance can be finalized. Otherwise, the instance is kept alive.
</I>&gt;<i> 4. For all alive instances, toggle the Weak GREFs to GREFs.
</I>&gt;<i> 
</I>&gt;<i> Note: mid-term plan is to unify that code with the ~equivalent code here:
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://github.com/xamarin/java.interop/blob/master/src/java-">https://github.com/xamarin/java.interop/blob/master/src/java-</A>
</I>&gt;<i> interop/java-interop-gc-bridge-mono.c
</I>&gt;<i> 
</I>&gt;<i> That project keeps getting punted as more important work pops up&#8230;
</I>&gt;<i> 
</I>&gt;<i> Very important question: what Android version do you see this on? There
</I>&gt;<i> are two Weak reference implementations, one that uses &#8220;proper&#8221; JNI Weak
</I>&gt;<i> Global References, and one which uses java.lang.WeakReference (because
</I>&gt;<i> API-8 was the first to support JNI Weak Global references, and then Android
</I>&gt;<i> 4.4 + ART broke them&#8230;). The  WeakReference implementation doesn&#8217;t get
</I>&gt;<i> as much testing, so&#8230;it&#8217;s possibly suspect unless you can discount it.
</I>&gt;<i> 
</I>
I've tested this on a Tango device which is 4.4 ART (and I've definitely seen funny bugs with this device),
as well as the API23 emulator image.

&gt;<i> Returning to the original description&#8230;
</I>&gt;<i> `Java.Lang.Object.Handle` is a JNI Global Reference, which *should* keep
</I>&gt;<i> the instance alive. Period. Thus, it shouldn&#8217;t be possible for
</I>&gt;<i> `Object.JavaFinalize()` to be invoked while `Object.Handle` is not IntPtr.Zero.
</I>&gt;<i> 
</I>&gt;<i> I can think of *one* way it would happen, but `GenericAnimatorListener`
</I>&gt;<i> doesn&#8217;t trigger it: if the class had a `T(IntPtr, JniHandleOwnership)`
</I>&gt;<i> constructor, *and* the instance were `Dispose()`d, then I can see
</I>&gt;<i> `JavaFinalize()` being invoked:
</I>&gt;<i> 
</I>&gt;<i> 	class Silly : Java.Lang.Object {
</I>&gt;<i> 		public Silly () {}
</I>&gt;<i> 		public Silly (IntPtr h, JniHandleOwnership t) : base (h, t) {}
</I>&gt;<i> 		protected override void JavaFinalize () {
</I>&gt;<i> 		}
</I>&gt;<i> 	}
</I>&gt;<i> 	// &#8230;
</I>&gt;<i> 	using (var s = new Silly ()) {
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> Once `s.Dispose()` is invoked, nothing will keep the Java-side peer alive, so
</I>&gt;<i> later `Object.finalize()` may eventually be invoked by the Java GC, but since
</I>&gt;<i> there is no longer a registered peer for the JNI instance, we&#8217;ll invoke the
</I>&gt;<i> `Silly(IntPtr, JniHandleOwnership)` constructor to *create a new* peer, and
</I>&gt;<i> invoke `Silly.JavaFinalize()` on the newly created peer, *not* the original
</I>&gt;<i> instance:
</I>&gt;<i> 
</I>&gt;<i> 	// above `using` block + subsequent behavior is as if&#8230;
</I>&gt;<i> 	new Silly ().Dispose();
</I>&gt;<i> 	// time passes...
</I>&gt;<i> 	new Silly (value, JniHandleOwnership.DoNotTransfer).JavaFinalize();
</I>&gt;<i> 
</I>&gt;<i> That&#8217;s clearly not the case in GenericAnimatorListener &#8212; it doesn&#8217;t have the
</I>&gt;<i> right constructor.
</I>&gt;<i> 
</I>&gt;<i> That *may* be the case in MvxRecyclerViewHolder, as it *does* have the
</I>&gt;<i> activation constructor:
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://github.com/MvvmCross/MvvmCross-">https://github.com/MvvmCross/MvvmCross-</A>
</I>&gt;<i> AndroidSupport/blob/e88c556/MvvmCross.Droid.Support.V7.RecyclerView/
</I>&gt;<i> MvxRecyclerViewHolder.cs#L107-L109
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         public MvxRecyclerViewHolder(IntPtr handle, JniHandleOwnership
</I>&gt;<i> transfer)
</I>&gt;<i>             : base(handle, transfer)
</I>&gt;<i>         {}
</I>&gt;<i> 
</I>&gt;<i> I would thus suggest you look into *why* `MvxRecyclerViewHolder ` has an
</I>&gt;<i> Activation constructor. I strongly suggest *avoiding* activation constructors
</I>&gt;<i> unless absolutely necessary:
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://developer.xamarin.com/guides/android/under_the_hood/a">https://developer.xamarin.com/guides/android/under_the_hood/a</A>
</I>&gt;<i> rchitecture/#Java_Activation
</I>
We put Activation constructors almost everywhere because they tend to fix crashes when coming back to an activity.
Plus we allow almost all of our classes to be overridden by the user if they need to do so.  Maybe in this case MvxRecyclerViewHolder
doesn't need to use the constructor.  It's hard to tell when it is needed.

&gt;<i> 
</I>&gt;<i> The Activation constructor has a tendency to &#8220;hide&#8221; or &#8220;change&#8221; the behavior
</I>&gt;<i> of actual buggy behavior, so the fact that `MvxRecyclerViewHolder` provides
</I>&gt;<i> an activation constructor without overriding any virtual methods (other than
</I>&gt;<i> Dispose()) does not fill me with confidence.
</I>
As far as I can tell Dispose() is not being called on MvxRecyclerViewHolder.

&gt;<i> 
</I>&gt;<i> If this is happening, you&#8217;d see the
</I>&gt;<i> `MvxRecyclerViewHolder._bindingContext` is null &#8212; along with all over
</I>&gt;<i> members! You could check for that within your `JavaFinalize()` override, and
</I>&gt;<i> see if the instance has &#8220;meaningful&#8221; data compared to what the instance had
</I>&gt;<i> after construction.
</I>
All the values appear to be meaningful data.

&gt;<i> 
</I>&gt;<i> Additionally, to track *managed* instance lifetimes, I suggest copious use of
</I>&gt;<i> RuntimeHelpers.GetHashCode(object):
</I>&gt;<i> 
</I>&gt;<i> 	<A HREF="https://msdn.microsoft.com/en-us/library/11tbk3h9(v=vs.110">https://msdn.microsoft.com/en-us/library/11tbk3h9(v=vs.110</A>).aspx
</I>&gt;<i> 
</I>&gt;<i>  - Jon
</I>
Thanks for the tips.  I'll enable debugging/logging  and see what I can find.

&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i> 
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I></PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014127.html">[mono-android] JavaFinalize and .NET Finalizers
</A></li>
	<LI>Next message: <A HREF="014129.html">[mono-android] JavaFinalize and .NET Finalizers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14128">[ date ]</a>
              <a href="thread.html#14128">[ thread ]</a>
              <a href="subject.html#14128">[ subject ]</a>
              <a href="author.html#14128">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
