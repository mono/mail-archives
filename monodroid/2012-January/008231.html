<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] drag-drop listener
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20drag-drop%20listener&In-Reply-To=COL122-W522EC180B20BAF66110013AE940%40phx.gbl">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008228.html">
   <LINK REL="Next"  HREF="008233.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] drag-drop listener</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20drag-drop%20listener&In-Reply-To=COL122-W522EC180B20BAF66110013AE940%40phx.gbl"
       TITLE="[mono-android] drag-drop listener">jonp at xamarin.com
       </A><BR>
    <I>Wed Jan  4 21:49:10 EST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="008228.html">[mono-android] drag-drop listener
</A></li>
        <LI>Next message: <A HREF="008233.html">[mono-android] drag-drop listener
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8231">[ date ]</a>
              <a href="thread.html#8231">[ thread ]</a>
              <a href="subject.html#8231">[ subject ]</a>
              <a href="author.html#8231">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 4, 2012, at 9:06 PM, Wally McClure wrote:
&gt;<i> Thanks.  Christntr got me set on this.
</I>
For the benefit of everyone else... ;-)

&gt;<i> The problem is that nothing in myDragListener seems to fire.  I think the problem is when I instantiate the class, I am handing in the incorrect handle.
</I>
&gt;<i>         protected class myDragEventListener : View.IOnDragListener
</I>
Unless you're me [0], always, _always_, ALWAYS inherit from Java.Lang.Object when implementing an Android interface.

Here's why: the IJavaObject.Handle property is the JNI handle of the Java-side object to pass as a parameter. This thus requires that you have a Java-side object to provide (and is why any IJavaObject.Handle implementation which throws an exception or returns IntPtr.Zero is broken). Subclassing Java.Lang.Object handles creating the Java-side instance automatically.

Furthermore, the associated Java object needs to be &quot;correct.&quot; If you're implementing an interface (as `myDragEventListener` does), and passing an instance of that type to a Java method (your previous `iv.SetOnDragListener()` call), then IJavaObject.Handle will be used to obtain the Java instance to use, and _that_ instance will be passed to the Java-side setOnDragListener() method.

That Java-side instance had better implement the Java View.OnDragListener interface. If it doesn't...anything could happen. (ClassCastExceptions, aborts, corruption...)

In your case, you're doing:

	IntPtr IJavaObject.Handle {
		get {return _c.Handle;}
	}

where `_c` is a Context instance. Unless `_c` is your Activity _and_ your Activity is also implementing View.IOnDragListener, you'll be providing a Java object which does _not_ implement the Java VIew.OnDragListener interface.

This is, suffice it to say, Bad&#8482;.

If you instead subclass Java.Lang.Object (as you should!), an Android Callable Wrapper (ACW) will be generated, which will implement the Java-side interfaces which are present in your subclass. The ACW will be created in the Java.Lang.Object constructor, thus ensuring that the Handle property is mapped to an appropriately typed Java instance.

Finally, there's the GC problem. Java.Lang.Object has support for cross-VM object references. If you implement IJavaObject yourself, your class won't, and you'll need to (somehow) ensure that your Java object is eventually freed. Worse, you'll need to figure out some way to keep the managed instance from being GC'd as long as the Java object is alive. Don't go there, just subclass Java.Lang.Object.

 - Jon

[0] ...and I would avoid implementing IJavaObject manually unless there was absolutely no other alternative. Please, just don't.

</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008228.html">[mono-android] drag-drop listener
</A></li>
	<LI>Next message: <A HREF="008233.html">[mono-android] drag-drop listener
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8231">[ date ]</a>
              <a href="thread.html#8231">[ thread ]</a>
              <a href="subject.html#8231">[ subject ]</a>
              <a href="author.html#8231">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
