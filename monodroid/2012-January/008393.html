<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] JNI Help Please
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JNI%20Help%20Please&In-Reply-To=%3C50E23EDF-320D-4B73-9DD6-B401CAD9E30C%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008391.html">
   <LINK REL="Next"  HREF="008432.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] JNI Help Please</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JNI%20Help%20Please&In-Reply-To=%3C50E23EDF-320D-4B73-9DD6-B401CAD9E30C%40xamarin.com%3E"
       TITLE="[mono-android] JNI Help Please">jonp at xamarin.com
       </A><BR>
    <I>Sat Jan 14 02:01:45 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="008391.html">[mono-android] JNI Help Please
</A></li>
        <LI>Next message: <A HREF="008432.html">[mono-android] JNI Help Please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8393">[ date ]</a>
              <a href="thread.html#8393">[ thread ]</a>
              <a href="subject.html#8393">[ subject ]</a>
              <a href="author.html#8393">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 13, 2012, at 8:05 PM, digitalml wrote:
&gt;<i> All JNI examples I've found either return an activity or use static methods and mine is not static and not really an activity I want to show on the screen.
</I>
The SanityTests sample has a more complete example of JNI use:

	<A HREF="https://github.com/xamarin/monodroid-samples/tree/master/SanityTests">https://github.com/xamarin/monodroid-samples/tree/master/SanityTests</A>
	<A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java</A>
	<A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Hello.cs#L514">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Hello.cs#L514</A>

&gt;<i> Here is the .java file im using, it compiles fine...
</I>&gt;<i> ---------------------------------------------------------
</I>&gt;<i> import IDTech.MSR.uniMag.uniMagReader;
</I>&gt;<i> import IDTech.MSR.uniMag.uniMagReaderMsg;
</I>&gt;<i> import android.app.Activity;
</I>&gt;<i> 
</I>&gt;<i> public class jni_helper extends Activity implements uniMagReaderMsg {
</I>
Why does your class extend Activity if you don't want to show it on the screen?

&gt;<i>    private jni_helper()
</I>&gt;<i>    {
</I>&gt;<i> 	}
</I>
...and how are you supposed to obtain an instance of `jni_helper` when the constructor is static?

&gt;<i>    		public void InitializeReader()
</I>&gt;<i> 	{
</I>&gt;<i> 		if(myUniMagReader == null)
</I>&gt;<i> 			myUniMagReader =  new uniMagReader(this, this);
</I>
Is it fair to assume that `uniMagReader` is what calls the onReceiveMsgCardData() method?

&gt;<i> I'd like to be able to call the InitializeReader() method
</I>...
&gt;<i> And here is my .Net helper class to call the JNI. It errors at the JNIEnv.CallVoidMethod()
</I>&gt;<i>        private static IntPtr _helperClass = JNIEnv.FindClass(&quot;Stations/MagHelper/jni_helper&quot;);
</I>&gt;<i>        public static void InitializeReader()
</I>&gt;<i>        {
</I>&gt;<i>            IntPtr methodId = JNIEnv.GetMethodID(_helperClass, &quot;InitializeReader&quot;, &quot;()V&quot;);
</I>&gt;<i>            if (null != methodId)
</I>&gt;<i>                JNIEnv.CallVoidMethod(_helperClass, methodId);
</I>
CallVoidMethod() requires an instance handle, and you're providing a class handle, hence the error. You need to obtain an instance. However, given that the constructor is private, and that that there are no static methods on the class, I'm not sure how you're supposed to obtain an instance.

Assuming that you can actually invoke a private constructor through JNI (which I've never tried), you could do:

	IntPtr ctor = JNIEnv.GetMethodID(_helperClass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);
	IntPtr instance = JNIEnv.NewObject(_helperClass, ctor);
	JNIEnv.CallVoidMethod(instance, methodid /* for InitializeReader */);

&gt;<i> the SwipeCard() method 
</I>
SwipeCard is ~identical to InitializeReader(): obtain an instance &quot;somehow&quot;, then invoke the method:

	IntPtr instance = ...; // same as above?
	IntPtr jni_helper_SwipeCard = JNIEnv.GetMethodID(_helperClass, &quot;SwipeCard&quot;, &quot;()V&quot;);
	IntPtr.CallVoidMethod(instance, jni_helper_SwipeCard);

&gt;<i> listen for the callback onReceiveMsgCardData() 
</I>
This is trickier, as I don't really understand your Java code. What code is calling onReceiveMsgCardData()? How is the instance registered with that code?

I have to assume that `myUniMagReader.registerListen()` causes the `uniMagReader` instance to start invoking the onReceiveMsgCardData() method, but there is no apparent way to alter what object it registers -- it uses `this`, but (as mentioned above) there's no way to instantiate `jni_helper` instances. There's certainly no way to subclass `jni_helper`, as the constructor is private, and the only mechanism I can think of to &quot;listen for the callback onReceiveMsgCardData()&quot; is to subclass `jni_helper` and override that method, and I can't fathom how any of that would work here.

`jni_helper` aside, you CAN subclass Java types in C# and override their virtual methods, it just takes more work. We're working on documentation to explain this, but we do have a sample in the meantime, see:

The base Java class: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java</A>
The C# glue code for inheritance: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs</A>
The C# subclass of the Java type: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs#L155">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs#L155</A>

 - Jon

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008391.html">[mono-android] JNI Help Please
</A></li>
	<LI>Next message: <A HREF="008432.html">[mono-android] JNI Help Please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8393">[ date ]</a>
              <a href="thread.html#8393">[ thread ]</a>
              <a href="subject.html#8393">[ subject ]</a>
              <a href="author.html#8393">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
