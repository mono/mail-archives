<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] JNI Help Please
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JNI%20Help%20Please&In-Reply-To=%3C4006D13A-E1B4-4E2D-B4C5-7A8C913070AB%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008443.html">
   <LINK REL="Next"  HREF="008392.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] JNI Help Please</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20JNI%20Help%20Please&In-Reply-To=%3C4006D13A-E1B4-4E2D-B4C5-7A8C913070AB%40xamarin.com%3E"
       TITLE="[mono-android] JNI Help Please">jonp at xamarin.com
       </A><BR>
    <I>Tue Jan 17 01:45:45 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="008443.html">[mono-android] JNI Help Please
</A></li>
        <LI>Next message: <A HREF="008392.html">[mono-android] NUnit Output
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8446">[ date ]</a>
              <a href="thread.html#8446">[ thread ]</a>
              <a href="subject.html#8446">[ subject ]</a>
              <a href="author.html#8446">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 16, 2012, at 8:06 PM, digitalml wrote:
&gt;<i> I still have the issue of the callback though. What happens in the .java code is that when a hardware event occurs it fires the onReceiveMsgCardData() event.
</I>
My question from before remains the same: what code is calling onReceiveMsgCardData() and how does that code obtain the instance on which to call onReceiveMsgCardData()? That wasn't clear to me.

So let me assume something: the `uniMagReader` instance is responsible for calling onReceiveMsgCardData(), and the `uniMagReader` initialization is done within jni_helper.InitializeReader(). If that's the case, you could declare a Managed Callable Wrapper for `jni_helper` within C# (note: completely untested and uncompiled):

	[Register (&quot;MagHelper/jni_helper&quot;, DoNotGenerateAcw=true)]
	class YourJniHelper : Java.Lang.Object {

		public YourJniHelper ()
		{
		}

		public YourJniHelper (IntPtr handle, JniHandleOwnership transfer)
			: base (handle, transfer)
		{
		}

		static IntPtr class_ref = JNIEnv.FindClass (&quot;MagHelper/jni_helper&quot;);

		protected override Type ThresholdType {
			get {return typeof (YourJniHelper);}
		}

		protected override IntPtr ThresholdClass {
			get {return class_ref;}
		}

		static IntPtr id_InitializeReader;
		public void InitializeReader ()
		{
			if (id_InitializeReader == IntPtr.Zero)
				id_InitializeReader = JNIEnv.GetMethodID(class_ref, &quot;InitializeReader&quot;, &quot;()V&quot;);
			JNIEnv.CallVoidMethod (Handle, id_InitializeReader);
		}

		static IntPtr id_onReceiveMsgCardData;

		[Register (&quot;onReceiveMsgCardData&quot;, &quot;(B[B)V&quot;, &quot;Get_onReceiveMsgCardData_Handler&quot;)]
		public virtual void OnReceiveMsgCardData (sbyte flagOfCardData, JavaArray&lt;byte&gt; cardData)
		{
			if (id_onReceiveMsgCardData == IntPtr.Zero)
				id_onReceiveMsgCardData = JNIEnv.GetMethodID(class_ref, &quot;onReceiveMsgCardData&quot;, &quot;(B[B)V&quot;);
			if (GetType () == ThresholdType) {
				JNIEnv.CallVoidMethod (Handle, id_onReceiveMsgCardData,
						new JValue (flagOfCardData),
						new JValue (JNIEnv.ToJniHandle (cardData)));
				return;
			}
			JNIenv.CallNonvirtualVoidMethod (Handle, ThresholdClass, id_onReceiveMsgCardData,
					new JValue (flagOfCardData),
					new JValue (JNIEnv.ToJniHandle (cardData)));
		}

		static Delegate cb_onReceiveMsgCardData;
		static Delegate Get_onReceiveMsgCardData_Handler ()
		{
			if (cb_onReceiveMsgCardData == null)
				cb_onReceiveMsgCardData = JNINativeWrapper.CreateDelegate ((Action&lt;IntPtr, IntPtr, sbyte, IntPtr&gt;) n_OnReceiveMsgCardData);
			return cb_onReceiveMsgCardData;
		}

		static void n_OnReceiveMsgCardData (IntPtr jnienv, IntPtr lrefThis, byte flagOfCardData, IntPtr n_cardData)
		{
			YourJniHelper __this = Java.Lang.Object.GetObject&lt;YourJniHelper&gt;(lrefThis, JniHandleOwnership.DoNotTransfer);
			using (var cardData = new JavaArray&lt;byte&gt;(n_cardData, JniHandleOwnership.DoNotTransfer))
				__this. OnReceiveMsgCardData (flagOfCardData, cardData);
		}
	}

then subclass it:

	class MyJniHelper : YourJniHelper {
		public override void OnReceiveMsgCardData (sbyte flagOfCardData, IntPtr cardData)
		{
			/* ... */
		}
	}

then use it:

	var helper = new MyJniHelper ();
	helper.InitializeReader ();

You're not currently expected to understand the Managed Callable Wrapper; docs for that are in-progress, though you can follow the existing sample:

	The base Java class: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/Adder.java</A>
	The C# glue code for inheritance: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs</A>
	The C# subclass of the Java type: <A HREF="https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs#L155">https://github.com/xamarin/monodroid-samples/blob/master/SanityTests/ManagedAdder.cs#L155</A>

 - Jon
 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008443.html">[mono-android] JNI Help Please
</A></li>
	<LI>Next message: <A HREF="008392.html">[mono-android] NUnit Output
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8446">[ date ]</a>
              <a href="thread.html#8446">[ thread ]</a>
              <a href="subject.html#8446">[ subject ]</a>
              <a href="author.html#8446">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
