<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] SurfaceHolder AddCallback random errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20SurfaceHolder%20AddCallback%20random%20errors&In-Reply-To=4E40D695.2060304%40veritas-vos-liberabit.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005768.html">
   <LINK REL="Next"  HREF="005773.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] SurfaceHolder AddCallback random errors</H1>
    <B>WyrmUK</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20SurfaceHolder%20AddCallback%20random%20errors&In-Reply-To=4E40D695.2060304%40veritas-vos-liberabit.com"
       TITLE="[mono-android] SurfaceHolder AddCallback random errors">lmee at wyrm.org.uk
       </A><BR>
    <I>Tue Aug  9 03:56:11 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="005768.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
        <LI>Next message: <A HREF="005773.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5770">[ date ]</a>
              <a href="thread.html#5770">[ thread ]</a>
              <a href="subject.html#5770">[ subject ]</a>
              <a href="author.html#5770">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well this is just it. It does work perfectly every time some builds, throws
an exception every time on others (causing the app to crash), and just page
faults every time on others (again causing the app to crash). This seems to
point to a mandroid issue because it's not like it sometimes works and
sometimes page-faults with a single build, if it works for a build then it
always works in that build; but there may be something I'm missing - or
there may be a work-around. I can't catch the exception either as it just
kills the app. Would be good to get some comment from someone who knows more
about the Mono system and ARM devices and why this might be happening. It
could be just a byte-alignment issue and a command line option fixes it. But
I don't know.
Anyone?


Atsushi Eno wrote:
&gt;<i> 
</I>&gt;<i> Actually, I tried it, but I could never get it working fine. It just 
</I>&gt;<i> shows black screen and ended up with crash (I don't remember correctly). 
</I>&gt;<i> Should this equivalent code work in Java form?
</I>&gt;<i> 
</I>&gt;<i> Atsushi Eno
</I>&gt;<i> 
</I>&gt;&gt;<i> Hi.
</I>&gt;&gt;<i> I'm trying to implement an activity which previews the camera and allows
</I>&gt;&gt;<i> a
</I>&gt;&gt;<i> picture to be taken.
</I>&gt;&gt;<i> However I get rather mixed results with each build. One time it will work
</I>&gt;&gt;<i> fine, but I might make a change such as adding a comment and re-compile
</I>&gt;&gt;<i> and
</I>&gt;&gt;<i> I get an error when setting the ISurfaceHolderCallback, then I might take
</I>&gt;&gt;<i> the comment out and re-compile and I get a page fault, then I can do
</I>&gt;&gt;<i> something else and it works again! It seems that it's compile/build
</I>&gt;&gt;<i> related
</I>&gt;&gt;<i> because if I build and it happens to work it will always work; but if I
</I>&gt;&gt;<i> build and it crashes then it will always crash. The below failed with the
</I>&gt;&gt;<i> exception shown, then I took the '.' off the end of the comment,
</I>&gt;&gt;<i> re-compiled
</I>&gt;&gt;<i> and it then worked!!!
</I>&gt;&gt;<i> Is there an issue here or am I failing to set something up properly?
</I>&gt;&gt;<i> I'm running this on a Dell Streak 5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is a snapshot from ADB of one of the errors:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I/ActivityManager(  146): Starting activity: Intent {
</I>&gt;&gt;<i> cmp=uk.co.reach.reachcloud/reachmobilecc.PictureActivity }
</I>&gt;&gt;<i> I/CameraView( 2699): Adding Callback
</I>&gt;&gt;<i> F/PrintK  ( 2699):&lt;2&gt;Exception!!! each.reachcloud: unhandled page fault
</I>&gt;&gt;<i> (11) at 0xed006d4e, code 0x005
</I>&gt;&gt;<i> I/MonoDroid( 2699): UNHANDLED EXCEPTION: System.NullReferenceException:
</I>&gt;&gt;<i> Object reference not set to an instance of an object
</I>&gt;&gt;<i> I/MonoDroid( 2699): at
</I>&gt;&gt;<i> Android.Views.ISurfaceHolderCallbackAdapter.GetHandle
</I>&gt;&gt;<i> (Android.Views.ISurfaceHolderCallback)&lt;0x00038&gt;
</I>&gt;&gt;<i> I/MonoDroid( 2699): at Android.Views.ISurfaceHolderInvoker.AddCallback
</I>&gt;&gt;<i> (Android.Views.ISurfaceHolderCallback)&lt;0x000bf&gt;
</I>&gt;&gt;<i> I/MonoDroid( 2699): at ReachMobileCC.PictureActivity.OnResume ()&lt;0x00073&gt;
</I>&gt;&gt;<i> I/MonoDroid( 2699): at Android.App.Activity.n_OnResume (intptr,intptr)
</I>&gt;&gt;<i> &lt;0x00033&gt;
</I>&gt;&gt;<i> I/MonoDroid( 2699): at (wrapper dynamic-method)
</I>&gt;&gt;<i> object.38c0d09b-61f8-491e-b367-fbed8a6fb14a (intptr,intptr)&lt;0x0002b&gt;
</I>&gt;&gt;<i> E/mono    ( 2699):
</I>&gt;&gt;<i> E/mono    ( 2699): Unhandled Exception: System.NullReferenceException:
</I>&gt;&gt;<i> Object reference not set to an instance of an object
</I>&gt;&gt;<i> E/mono    ( 2699):   at
</I>&gt;&gt;<i> Android.Views.ISurfaceHolderCallbackAdapter.GetHandle
</I>&gt;&gt;<i> (ISurfaceHolderCallback instance) [0x00000] in&lt;filename unknown&gt;:0
</I>&gt;&gt;<i> E/mono    ( 2699):   at Android.Views.ISurfaceHolderInvoker.AddCallback
</I>&gt;&gt;<i> (ISurfaceHolderCallback callback) [0x00000] in&lt;filename unknown&gt;:0
</I>&gt;&gt;<i> E/mono    ( 2699):   at ReachMobileCC.PictureActivity.OnResume ()
</I>&gt;&gt;<i> [0x00000]
</I>&gt;&gt;<i> in&lt;filename unknown&gt;:0
</I>&gt;&gt;<i> E/mono    ( 2699):   at Android.App.Activity.n_OnResume (IntPtr jnienv,
</I>&gt;&gt;<i> IntPtr native__this) [0x00000] in&lt;filename unknown&gt;:0
</I>&gt;&gt;<i> E/mono    ( 2699):   at (wrapper dynamic-method)
</I>&gt;&gt;<i> object:38c0d09b-61f8-491e-b367-fbed8a6fb14a (intptr,intptr)
</I>&gt;&gt;<i> I/ActivityManager(  146): Process uk.co.reach.reachcloud (pid 2699) has
</I>&gt;&gt;<i> died.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is the activity class:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using System;
</I>&gt;&gt;<i> using System.Collections.Generic;
</I>&gt;&gt;<i> using System.Linq;
</I>&gt;&gt;<i> using System.Text;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using Android.App;
</I>&gt;&gt;<i> using Android.Content;
</I>&gt;&gt;<i> using Android.Hardware;
</I>&gt;&gt;<i> using Android.OS;
</I>&gt;&gt;<i> using Android.Runtime;
</I>&gt;&gt;<i> using Android.Views;
</I>&gt;&gt;<i> using Android.Widget;
</I>&gt;&gt;<i> using Android.Util;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> namespace ReachMobileCC
</I>&gt;&gt;<i> {
</I>&gt;&gt;<i>      [Activity(Label = &quot;@string/TakePicture&quot;, ConfigurationChanges =
</I>&gt;&gt;<i> Android.Content.PM.ConfigChanges.Orientation |
</I>&gt;&gt;<i> Android.Content.PM.ConfigChanges.Keyboard |
</I>&gt;&gt;<i> Android.Content.PM.ConfigChanges.KeyboardHidden)]
</I>&gt;&gt;<i>      public class PictureActivity : Activity, ISurfaceHolderCallback,
</I>&gt;&gt;<i> Camera.IPictureCallback
</I>&gt;&gt;<i>      {
</I>&gt;&gt;<i>          #region Fields
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          private bool _previewing = false;
</I>&gt;&gt;<i>          private Camera _camera = null;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #endregion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public static byte[] JpegData { get; set; }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #region Event Handlers
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          protected override void OnCreate(Bundle bundle)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              base.OnCreate(bundle);
</I>&gt;&gt;<i>              SetContentView(Resource.Layout.Picture);
</I>&gt;&gt;<i>              FindViewById&lt;Button&gt;(Resource.Id.TakePicture).Click +=
</I>&gt;&gt;<i> TakePictureClick;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          protected override void OnResume()
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              base.OnResume();
</I>&gt;&gt;<i>              var holder =
</I>&gt;&gt;<i> FindViewById&lt;SurfaceView&gt;(Resource.Id.PicturePreview).Holder;
</I>&gt;&gt;<i>              Log.Info(&quot;CameraView&quot;, &quot;Adding Callback&quot;);
</I>&gt;&gt;<i>              holder.AddCallback(this);
</I>&gt;&gt;<i>              Log.Info(&quot;CameraView&quot;, &quot;Added Callback&quot;);
</I>&gt;&gt;<i>              holder.SetType(SurfaceType.PushBuffers);
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public override bool OnKeyDown(Keycode keyCode, KeyEvent e)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              if (keyCode == Keycode.Back&amp;&amp;  _previewing)
</I>&gt;&gt;<i>              {
</I>&gt;&gt;<i>                  StopPreviewAndExit(false);
</I>&gt;&gt;<i>                  return true;
</I>&gt;&gt;<i>              }
</I>&gt;&gt;<i>              if ((keyCode == Keycode.Camera || keyCode ==
</I>&gt;&gt;<i> Keycode.DpadCenter)
</I>&gt;&gt;<i> &amp;&amp;  _previewing)
</I>&gt;&gt;<i>              {
</I>&gt;&gt;<i>                  TakePictureClick(this, new EventArgs());
</I>&gt;&gt;<i>                  return true;
</I>&gt;&gt;<i>              }
</I>&gt;&gt;<i>              return base.OnKeyDown(keyCode, e);
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          void TakePictureClick(object sender, EventArgs e)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              if (_camera != null)
</I>&gt;&gt;<i>                  _camera.TakePicture(null, null, this);
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #endregion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #region ISurfaceHolderCallback Members
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void SurfaceChanged(ISurfaceHolder holder, int format,
</I>&gt;&gt;<i> int
</I>&gt;&gt;<i> width, int height)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              if (_camera != null)
</I>&gt;&gt;<i>              {
</I>&gt;&gt;<i>                  if (_previewing) _camera.StopPreview();
</I>&gt;&gt;<i>                  var parameters = _camera.GetParameters();
</I>&gt;&gt;<i>                  var previewSize =
</I>&gt;&gt;<i> GetNearestPreviewSize(parameters.SupportedPreviewSizes, width, height);
</I>&gt;&gt;<i>                  parameters.SetPreviewSize(previewSize.Width,
</I>&gt;&gt;<i> previewSize.Height);
</I>&gt;&gt;<i>                  if
</I>&gt;&gt;<i> (parameters.SupportedFocusModes.Contains(Camera.Parameters.FocusModeAuto))
</I>&gt;&gt;<i>                      parameters.FocusMode =
</I>&gt;&gt;<i> Camera.Parameters.FocusModeAuto;
</I>&gt;&gt;<i>                  else if
</I>&gt;&gt;<i> (parameters.SupportedFocusModes.Contains(Camera.Parameters.FocusModeInfinity))
</I>&gt;&gt;<i>                      parameters.FocusMode =
</I>&gt;&gt;<i> Camera.Parameters.FocusModeInfinity;
</I>&gt;&gt;<i>                  parameters.SetRotation(90); // TODO: Match to window
</I>&gt;&gt;<i> orientation.
</I>&gt;&gt;<i>                  _camera.SetParameters(parameters);
</I>&gt;&gt;<i>                  _camera.SetPreviewDisplay(holder);
</I>&gt;&gt;<i>                  _camera.StartPreview();
</I>&gt;&gt;<i>                  _previewing = true;
</I>&gt;&gt;<i>              }
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void SurfaceCreated(ISurfaceHolder holder)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              _camera = Android.Hardware.Camera.Open();
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void SurfaceDestroyed(ISurfaceHolder holder)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              StopPreview();
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #endregion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #region IPictureCallback Members
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void OnPictureTaken(byte[] data, Android.Hardware.Camera
</I>&gt;&gt;<i> camera)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              JpegData = data;
</I>&gt;&gt;<i>              StopPreviewAndExit(true);
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #endregion
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #region Helper Methods
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          private Camera.Size GetNearestPreviewSize(IList&lt;Camera.Size&gt; 
</I>&gt;&gt;<i> sizes,
</I>&gt;&gt;<i> int width, int height)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              Camera.Size nearestSize = sizes[0];
</I>&gt;&gt;<i>              int diff = 99999;
</I>&gt;&gt;<i>              foreach (var size in sizes)
</I>&gt;&gt;<i>              {
</I>&gt;&gt;<i>                  if (size.Width&gt;  width || size.Height&gt;  height)
</I>&gt;&gt;<i> continue;
</I>&gt;&gt;<i>                  var comp = (width - size.Width) + (height -
</I>&gt;&gt;<i> size.Height);
</I>&gt;&gt;<i>                  if (comp&lt;  diff)
</I>&gt;&gt;<i>                  {
</I>&gt;&gt;<i>                      comp = diff;
</I>&gt;&gt;<i>                      nearestSize = size;
</I>&gt;&gt;<i>                  }
</I>&gt;&gt;<i>              }
</I>&gt;&gt;<i>              return nearestSize;
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void StopPreview()
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              if (_camera != null)
</I>&gt;&gt;<i>              {
</I>&gt;&gt;<i>                  _camera.StopPreview();
</I>&gt;&gt;<i>                  _camera.Release();
</I>&gt;&gt;<i>                  _camera = null;
</I>&gt;&gt;<i>              }
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          public void StopPreviewAndExit(bool ok)
</I>&gt;&gt;<i>          {
</I>&gt;&gt;<i>              StopPreview();
</I>&gt;&gt;<i>              SetResult(ok ? Result.Ok : Result.Canceled, new
</I>&gt;&gt;<i> Intent(this.ApplicationContext, typeof(PictureActivity)));
</I>&gt;&gt;<i>              Finish();
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          #endregion
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is the layout:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</I>&gt;&gt;<i> &lt;RelativeLayout
</I>&gt;&gt;<i> xmlns:android=&quot;<A HREF="http://schemas.android.com/apk/res/android&quot;">http://schemas.android.com/apk/res/android&quot;</A>
</I>&gt;&gt;<i>      android:layout_width=&quot;fill_parent&quot;
</I>&gt;&gt;<i>      android:layout_height=&quot;fill_parent&quot;&gt;
</I>&gt;&gt;<i>    &lt;Button
</I>&gt;&gt;<i>        android:id=&quot;@+id/TakePicture&quot;
</I>&gt;&gt;<i>        android:layout_width=&quot;fill_parent&quot;
</I>&gt;&gt;<i>        android:layout_height=&quot;wrap_content&quot;
</I>&gt;&gt;<i>        android:text=&quot;@string/TakePicture&quot;
</I>&gt;&gt;<i>        android:layout_alignParentBottom=&quot;true&quot;
</I>&gt;&gt;<i>      /&gt;
</I>&gt;&gt;<i>    &lt;SurfaceView
</I>&gt;&gt;<i>        android:id=&quot;@+id/PicturePreview&quot;
</I>&gt;&gt;<i>        android:layout_width=&quot;fill_parent&quot;
</I>&gt;&gt;<i>        android:layout_height=&quot;fill_parent&quot;
</I>&gt;&gt;<i>        android:layout_above=&quot;@id/TakePicture&quot;
</I>&gt;&gt;<i>      /&gt;
</I>&gt;&gt;<i> &lt;/RelativeLayout&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> View this message in context:
</I>&gt;&gt;<i> <A HREF="http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4678027.html">http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4678027.html</A>
</I>&gt;&gt;<i> Sent from the Mono for Android mailing list archive at Nabble.com.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Monodroid mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i> 
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;<i> 
</I>

--
View this message in context: <A HREF="http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4681127.html">http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4681127.html</A>
Sent from the Mono for Android mailing list archive at Nabble.com.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005768.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
	<LI>Next message: <A HREF="005773.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5770">[ date ]</a>
              <a href="thread.html#5770">[ thread ]</a>
              <a href="subject.html#5770">[ subject ]</a>
              <a href="author.html#5770">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
