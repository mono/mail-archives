<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] SurfaceHolder AddCallback random errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20SurfaceHolder%20AddCallback%20random%20errors&In-Reply-To=1312543758692-4669293.post%40n5.nabble.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005774.html">
   <LINK REL="Next"  HREF="005692.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] SurfaceHolder AddCallback random errors</H1>
    <B>WyrmUK</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5Bmono-android%5D%20SurfaceHolder%20AddCallback%20random%20errors&In-Reply-To=1312543758692-4669293.post%40n5.nabble.com"
       TITLE="[mono-android] SurfaceHolder AddCallback random errors">lmee at wyrm.org.uk
       </A><BR>
    <I>Thu Aug 11 05:52:03 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="005774.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
        <LI>Next message: <A HREF="005692.html">[mono-android] MonoDroid Mac Setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5835">[ date ]</a>
              <a href="thread.html#5835">[ thread ]</a>
              <a href="subject.html#5835">[ subject ]</a>
              <a href="author.html#5835">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.
I think V1.0.2 has solved this problem. Since installing that I've not had
the issue at all.
Here's to all you who helped made the release happen.
Cheers,
Laurence.


WyrmUK wrote:
&gt;<i> 
</I>&gt;<i> Hi.
</I>&gt;<i> I'm trying to implement an activity which previews the camera and allows a
</I>&gt;<i> picture to be taken.
</I>&gt;<i> However I get rather mixed results with each build. One time it will work
</I>&gt;<i> fine, but I might make a change such as adding a comment and re-compile
</I>&gt;<i> and I get an error when setting the ISurfaceHolderCallback, then I might
</I>&gt;<i> take the comment out and re-compile and I get a page fault, then I can do
</I>&gt;<i> something else and it works again! It seems that it's compile/build
</I>&gt;<i> related because if I build and it happens to work it will always work; but
</I>&gt;<i> if I build and it crashes then it will always crash. The below failed with
</I>&gt;<i> the exception shown, then I took the '.' off the end of the comment,
</I>&gt;<i> re-compiled and it then worked!!!
</I>&gt;<i> Is there an issue here or am I failing to set something up properly?
</I>&gt;<i> I'm running this on a Dell Streak 5.
</I>&gt;<i> 
</I>&gt;<i> *This is a snapshot from ADB of one of the errors:*
</I>&gt;<i> 
</I>&gt;<i> I/ActivityManager(  146): Starting activity: Intent {
</I>&gt;<i> cmp=uk.co.reach.reachcloud/reachmobilecc.PictureActivity }
</I>&gt;<i> I/CameraView( 2699): Adding Callback
</I>&gt;<i> F/PrintK  ( 2699): &lt;2&gt;Exception!!! each.reachcloud: unhandled page fault
</I>&gt;<i> (11) at 0xed006d4e, code 0x005
</I>&gt;<i> I/MonoDroid( 2699): UNHANDLED EXCEPTION: System.NullReferenceException:
</I>&gt;<i> Object reference not set to an instance of an object
</I>&gt;<i> I/MonoDroid( 2699): at
</I>&gt;<i> Android.Views.ISurfaceHolderCallbackAdapter.GetHandle
</I>&gt;<i> (Android.Views.ISurfaceHolderCallback) &lt;0x00038&gt;
</I>&gt;<i> I/MonoDroid( 2699): at Android.Views.ISurfaceHolderInvoker.AddCallback
</I>&gt;<i> (Android.Views.ISurfaceHolderCallback) &lt;0x000bf&gt;
</I>&gt;<i> I/MonoDroid( 2699): at ReachMobileCC.PictureActivity.OnResume () &lt;0x00073&gt;
</I>&gt;<i> I/MonoDroid( 2699): at Android.App.Activity.n_OnResume (intptr,intptr)
</I>&gt;<i> &lt;0x00033&gt;
</I>&gt;<i> I/MonoDroid( 2699): at (wrapper dynamic-method)
</I>&gt;<i> object.38c0d09b-61f8-491e-b367-fbed8a6fb14a (intptr,intptr) &lt;0x0002b&gt;
</I>&gt;<i> E/mono    ( 2699):
</I>&gt;<i> E/mono    ( 2699): Unhandled Exception: System.NullReferenceException:
</I>&gt;<i> Object reference not set to an instance of an object
</I>&gt;<i> E/mono    ( 2699):   at
</I>&gt;<i> Android.Views.ISurfaceHolderCallbackAdapter.GetHandle
</I>&gt;<i> (ISurfaceHolderCallback instance) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> E/mono    ( 2699):   at Android.Views.ISurfaceHolderInvoker.AddCallback
</I>&gt;<i> (ISurfaceHolderCallback callback) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> E/mono    ( 2699):   at ReachMobileCC.PictureActivity.OnResume ()
</I>&gt;<i> [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> E/mono    ( 2699):   at Android.App.Activity.n_OnResume (IntPtr jnienv,
</I>&gt;<i> IntPtr native__this) [0x00000] in &lt;filename unknown&gt;:0
</I>&gt;<i> E/mono    ( 2699):   at (wrapper dynamic-method)
</I>&gt;<i> object:38c0d09b-61f8-491e-b367-fbed8a6fb14a (intptr,intptr)
</I>&gt;<i> I/ActivityManager(  146): Process uk.co.reach.reachcloud (pid 2699) has
</I>&gt;<i> died.
</I>&gt;<i> 
</I>&gt;<i> *This is the activity class:*
</I>&gt;<i> 
</I>&gt;<i> using System;
</I>&gt;<i> using System.Collections.Generic;
</I>&gt;<i> using System.Linq;
</I>&gt;<i> using System.Text;
</I>&gt;<i> 
</I>&gt;<i> using Android.App;
</I>&gt;<i> using Android.Content;
</I>&gt;<i> using Android.Hardware;
</I>&gt;<i> using Android.OS;
</I>&gt;<i> using Android.Runtime;
</I>&gt;<i> using Android.Views;
</I>&gt;<i> using Android.Widget;
</I>&gt;<i> using Android.Util;
</I>&gt;<i> 
</I>&gt;<i> namespace ReachMobileCC
</I>&gt;<i> {
</I>&gt;<i>     [Activity(Label = &quot;@string/TakePicture&quot;, ConfigurationChanges =
</I>&gt;<i> Android.Content.PM.ConfigChanges.Orientation |
</I>&gt;<i> Android.Content.PM.ConfigChanges.Keyboard |
</I>&gt;<i> Android.Content.PM.ConfigChanges.KeyboardHidden)]
</I>&gt;<i>     public class PictureActivity : Activity, ISurfaceHolderCallback,
</I>&gt;<i> Camera.IPictureCallback
</I>&gt;<i>     {
</I>&gt;<i>         #region Fields
</I>&gt;<i> 
</I>&gt;<i>         private bool _previewing = false;
</I>&gt;<i>         private Camera _camera = null;
</I>&gt;<i> 
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         public static byte[] JpegData { get; set; }
</I>&gt;<i> 
</I>&gt;<i>         #region Event Handlers
</I>&gt;<i> 
</I>&gt;<i>         protected override void OnCreate(Bundle bundle)
</I>&gt;<i>         {
</I>&gt;<i>             base.OnCreate(bundle);
</I>&gt;<i>             SetContentView(Resource.Layout.Picture);
</I>&gt;<i>             FindViewById&lt;Button&gt;(Resource.Id.TakePicture).Click +=
</I>&gt;<i> TakePictureClick;
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         protected override void OnResume()
</I>&gt;<i>         {
</I>&gt;<i>             base.OnResume();
</I>&gt;<i>             var holder =
</I>&gt;<i> FindViewById&lt;SurfaceView&gt;(Resource.Id.PicturePreview).Holder;
</I>&gt;<i>             Log.Info(&quot;CameraView&quot;, &quot;Adding Callback&quot;);
</I>&gt;<i>             holder.AddCallback(this);
</I>&gt;<i>             Log.Info(&quot;CameraView&quot;, &quot;Added Callback&quot;);
</I>&gt;<i>             holder.SetType(SurfaceType.PushBuffers);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         public override bool OnKeyDown(Keycode keyCode, KeyEvent e)
</I>&gt;<i>         {
</I>&gt;<i>             if (keyCode == Keycode.Back &amp;&amp; _previewing)
</I>&gt;<i>             {
</I>&gt;<i>                 StopPreviewAndExit(false);
</I>&gt;<i>                 return true;
</I>&gt;<i>             }
</I>&gt;<i>             if ((keyCode == Keycode.Camera || keyCode ==
</I>&gt;<i> Keycode.DpadCenter) &amp;&amp; _previewing)
</I>&gt;<i>             {
</I>&gt;<i>                 TakePictureClick(this, new EventArgs());
</I>&gt;<i>                 return true;
</I>&gt;<i>             }
</I>&gt;<i>             return base.OnKeyDown(keyCode, e);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         void TakePictureClick(object sender, EventArgs e)
</I>&gt;<i>         {
</I>&gt;<i>             if (_camera != null)
</I>&gt;<i>                 _camera.TakePicture(null, null, this);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region ISurfaceHolderCallback Members
</I>&gt;<i> 
</I>&gt;<i>         public void SurfaceChanged(ISurfaceHolder holder, int format, int
</I>&gt;<i> width, int height)
</I>&gt;<i>         {
</I>&gt;<i>             if (_camera != null)
</I>&gt;<i>             {
</I>&gt;<i>                 if (_previewing) _camera.StopPreview();
</I>&gt;<i>                 var parameters = _camera.GetParameters();
</I>&gt;<i>                 var previewSize =
</I>&gt;<i> GetNearestPreviewSize(parameters.SupportedPreviewSizes, width, height);
</I>&gt;<i>                 parameters.SetPreviewSize(previewSize.Width,
</I>&gt;<i> previewSize.Height);
</I>&gt;<i>                 if
</I>&gt;<i> (parameters.SupportedFocusModes.Contains(Camera.Parameters.FocusModeAuto))
</I>&gt;<i>                     parameters.FocusMode =
</I>&gt;<i> Camera.Parameters.FocusModeAuto;
</I>&gt;<i>                 else if
</I>&gt;<i> (parameters.SupportedFocusModes.Contains(Camera.Parameters.FocusModeInfinity))
</I>&gt;<i>                     parameters.FocusMode =
</I>&gt;<i> Camera.Parameters.FocusModeInfinity;
</I>&gt;<i>                 parameters.SetRotation(90); // TODO: Match to window
</I>&gt;<i> orientation.
</I>&gt;<i>                 _camera.SetParameters(parameters);
</I>&gt;<i>                 _camera.SetPreviewDisplay(holder);
</I>&gt;<i>                 _camera.StartPreview();
</I>&gt;<i>                 _previewing = true;
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         public void SurfaceCreated(ISurfaceHolder holder)
</I>&gt;<i>         {
</I>&gt;<i>             _camera = Android.Hardware.Camera.Open();
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         public void SurfaceDestroyed(ISurfaceHolder holder)
</I>&gt;<i>         {
</I>&gt;<i>             StopPreview();
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region IPictureCallback Members
</I>&gt;<i> 
</I>&gt;<i>         public void OnPictureTaken(byte[] data, Android.Hardware.Camera
</I>&gt;<i> camera)
</I>&gt;<i>         {
</I>&gt;<i>             JpegData = data;
</I>&gt;<i>             StopPreviewAndExit(true);
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         #endregion
</I>&gt;<i> 
</I>&gt;<i>         #region Helper Methods
</I>&gt;<i> 
</I>&gt;<i>         private Camera.Size GetNearestPreviewSize(IList&lt;Camera.Size&gt;
</I>&gt;<i> sizes, int width, int height)
</I>&gt;<i>         {
</I>&gt;<i>             Camera.Size nearestSize = sizes[0];
</I>&gt;<i>             int diff = 99999;
</I>&gt;<i>             foreach (var size in sizes)
</I>&gt;<i>             {
</I>&gt;<i>                 if (size.Width &gt; width || size.Height &gt; height) continue;
</I>&gt;<i>                 var comp = (width - size.Width) + (height - size.Height);
</I>&gt;<i>                 if (comp &lt; diff)
</I>&gt;<i>                 {
</I>&gt;<i>                     comp = diff;
</I>&gt;<i>                     nearestSize = size;
</I>&gt;<i>                 }
</I>&gt;<i>             }
</I>&gt;<i>             return nearestSize;
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         public void StopPreview()
</I>&gt;<i>         {
</I>&gt;<i>             if (_camera != null)
</I>&gt;<i>             {
</I>&gt;<i>                 _camera.StopPreview();
</I>&gt;<i>                 _camera.Release();
</I>&gt;<i>                 _camera = null;
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         public void StopPreviewAndExit(bool ok)
</I>&gt;<i>         {
</I>&gt;<i>             StopPreview();
</I>&gt;<i>             SetResult(ok ? Result.Ok : Result.Canceled, new
</I>&gt;<i> Intent(this.ApplicationContext, typeof(PictureActivity)));
</I>&gt;<i>             Finish();
</I>&gt;<i>         }
</I>&gt;<i> 
</I>&gt;<i>         #endregion
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> 
</I>&gt;<i> *This is the layout:*
</I>&gt;<i> 
</I>&gt;<i> &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</I>&gt;<i> &lt;RelativeLayout xmlns:android=&quot;<A HREF="http://schemas.android.com/apk/res/android&quot;">http://schemas.android.com/apk/res/android&quot;</A>
</I>&gt;<i>     android:layout_width=&quot;fill_parent&quot;
</I>&gt;<i>     android:layout_height=&quot;fill_parent&quot;&gt;
</I>&gt;<i>   &lt;Button
</I>&gt;<i>       android:id=&quot;@+id/TakePicture&quot;
</I>&gt;<i>       android:layout_width=&quot;fill_parent&quot;
</I>&gt;<i>       android:layout_height=&quot;wrap_content&quot;
</I>&gt;<i>       android:text=&quot;@string/TakePicture&quot;
</I>&gt;<i>       android:layout_alignParentBottom=&quot;true&quot;
</I>&gt;<i>     /&gt;
</I>&gt;<i>   &lt;SurfaceView
</I>&gt;<i>       android:id=&quot;@+id/PicturePreview&quot;
</I>&gt;<i>       android:layout_width=&quot;fill_parent&quot;
</I>&gt;<i>       android:layout_height=&quot;fill_parent&quot;
</I>&gt;<i>       android:layout_above=&quot;@id/TakePicture&quot;
</I>&gt;<i>     /&gt;
</I>&gt;<i> &lt;/RelativeLayout&gt;
</I>&gt;<i> 
</I>

--
View this message in context: <A HREF="http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4689002.html">http://mono-for-android.1047100.n5.nabble.com/SurfaceHolder-AddCallback-random-errors-tp4669293p4689002.html</A>
Sent from the Mono for Android mailing list archive at Nabble.com.
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005774.html">[mono-android] SurfaceHolder AddCallback random errors
</A></li>
	<LI>Next message: <A HREF="005692.html">[mono-android] MonoDroid Mac Setup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5835">[ date ]</a>
              <a href="thread.html#5835">[ thread ]</a>
              <a href="subject.html#5835">[ subject ]</a>
              <a href="author.html#5835">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
