<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] VM full error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20VM%20full%20error&In-Reply-To=%3CBF9431F8-54F2-435B-A3E0-54900FFA56A5%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009728.html">
   <LINK REL="Next"  HREF="009797.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] VM full error</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20VM%20full%20error&In-Reply-To=%3CBF9431F8-54F2-435B-A3E0-54900FFA56A5%40xamarin.com%3E"
       TITLE="[mono-android] VM full error">jonp at xamarin.com
       </A><BR>
    <I>Fri Apr 13 03:57:51 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="009728.html">[mono-android] VM full error
</A></li>
        <LI>Next message: <A HREF="009797.html">[mono-android] VM full error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9730">[ date ]</a>
              <a href="thread.html#9730">[ thread ]</a>
              <a href="subject.html#9730">[ subject ]</a>
              <a href="author.html#9730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Apr 12, 2012, at 8:02 PM, King Coffee wrote:
&gt;<i> I'm using the following code to allocate an image file to a ImageView control, with instance name: image.
</I>&gt;<i> 
</I>&gt;<i> Bitmap bitmap = BitmapFactory.DecodeFile(matches[0]);
</I>&gt;<i> image.SetImageBitmap(bitmap);
</I>
I've tried to expound upon this [0, 1], and I'm probably still not being clear enough, so let's flip the question around...

When _shouldn't_ you call Dispose()?

You shouldn't call dispose when the runtime type is a C# type, the instance has a peer held in Java code, and Java peer will be re-entering managed code.

Every Java.Lang.Object subclass has a corresponding (generated) Java peer type [1]. When you create an instance of the Java.Lang.Object subclass, you also create an instance of the Java peer type, and the Java peer and managed instance are associated with each other. Calling Dispose() breaks the association.

The problem with breaking the association is that once broken, if the Java peer re-enters managed code, a new Managed Callable Wrapper (MCW) will be instantiated, and a new mapping between the Java peer and the new MCW will be created. If you had any instance state, it will be &quot;lost&quot;, which can be quite confusing. (Or you'll get an exception because the MCW type doesn't provide an (IntPtr, JniHandleOwnership) constructor...)

Note that this only really applies to C# types. If you're only dealing with Java types, you can dispose of the managed wrapper with (near) impunity; a new wrapper will be create if (when) the Java instance is (re-)exposed to managed code.

That is the fact with Bitmap: BitmapFactory.DecodeFile() will _never_ return C# type that contains C# instance state. Consequently, there's no need to ever preserve the association (unless you're storing `image` as a class member), so you can kill the mapping as soon as you're done with it:

	using (Bitmap bitmap = BitmapFactory.DecodeFile(matches[0]))
		image.SetImageBitmap(bitmap);

The result of the above is that only Java code will refer to the Bitmap instance, so when your code later changes the image's bitmap, Android will be able to quickly release the Bitmap instance.

&gt;<i> I tried to dispose of the control's context as follows: image.Context.dipose(), image.CacheDir.dispose(). 
</I>
That won't hurt, but it won't really help either. As mentioned above, if there isn't a wrapper for a Java instance, one will be created when the Java instance enters managed code, so the next time you call `image.Context` you'll simply get a new wrapper. (If you have an e.g. Dictionary&lt;Context, object&gt; you'll likely invalidate your keys if you do that, too. Care must be taken.)

&gt;<i> But, do I real need to dispose of container control, image? and reassign it?
</I>
I don't think you'll need to dispose of the container control, I imagine that just disposing of the image will be sufficient.

 - Jon

[0] <A HREF="http://docs.xamarin.com/android/advanced_topics/garbage_collection#Helping_the_GC">http://docs.xamarin.com/android/advanced_topics/garbage_collection#Helping_the_GC</A>
[1] <A HREF="http://docs.xamarin.com/android/advanced_topics/architecture#Managed_Callable_Wrappers">http://docs.xamarin.com/android/advanced_topics/architecture#Managed_Callable_Wrappers</A>

</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009728.html">[mono-android] VM full error
</A></li>
	<LI>Next message: <A HREF="009797.html">[mono-android] VM full error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9730">[ date ]</a>
              <a href="thread.html#9730">[ thread ]</a>
              <a href="subject.html#9730">[ subject ]</a>
              <a href="author.html#9730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
