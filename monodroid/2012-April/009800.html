<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Excessive JNI global references (Again and again)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Excessive%20JNI%20global%20references%20%28Again%20and%20again%29&In-Reply-To=%3CCAJhyXqKTTSzWEXeSAKny9WC9mDTQhJ%2BA7Br-tnwoUq2HsC_86Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009790.html">
   <LINK REL="Next"  HREF="009802.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Excessive JNI global references (Again and again)</H1>
    <B>Igor Russkih</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Excessive%20JNI%20global%20references%20%28Again%20and%20again%29&In-Reply-To=%3CCAJhyXqKTTSzWEXeSAKny9WC9mDTQhJ%2BA7Br-tnwoUq2HsC_86Q%40mail.gmail.com%3E"
       TITLE="[mono-android] Excessive JNI global references (Again and again)">irusskih at gmail.com
       </A><BR>
    <I>Wed Apr 18 08:11:52 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="009790.html">[mono-android] Excessive JNI global references (Again and again)
</A></li>
        <LI>Next message: <A HREF="009802.html">[mono-android] Excessive JNI global references (Again and again)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9800">[ date ]</a>
              <a href="thread.html#9800">[ thread ]</a>
              <a href="subject.html#9800">[ subject ]</a>
              <a href="author.html#9800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i> &gt; With original list of ~100 items, I'm getting overflow with just a
</I>&gt;<i> couple of device (or emulator) &quot;flips&quot;:
</I>&gt;<i> Is this with Mono for Android 4.0.6 or the 4.1.0 alpha? In 4.1.0 we
</I>&gt;<i> altered things so that when we hit a gref threshold we perform a collection
</I>&gt;<i> automatically. It's still not a great thing to rely on -- the GC might be
</I>&gt;<i> performed at the exact wrong time -- but could help with the gref limit.
</I>&gt;<i>
</I>
I haven't tried 4.1.0 yet, but I do GC.Collect(0) in each onStart. Will try
using full GC.Collect


Not necessarily; `aadapter.Dispose()` will allow the managed ArrayAdapter
&gt;<i> to be collected (and free the associated gref), but it won't do anything
</I>&gt;<i> about what `aadapter` references (in this case `jl`, and everything it
</I>&gt;<i> contains).
</I>&gt;<i>
</I>&gt;<i> You're using the Android.Widget.ArrayAdapter(Context, int, IList)
</I>&gt;<i> constructor, which will construct a JavaList to contain the contents of the
</I>&gt;<i> IList, which will result in a gref for each element within the list. If
</I>&gt;<i> these are strings, it should be more efficient to instead use
</I>&gt;<i> ArrayAdapter&lt;string&gt;:
</I>&gt;<i>
</I>
Why keeping these string grefs inside of M4A framework? I mean I've used an
API method, which is actually a helper, because it does transformation of
my .net list into java list. Why this helper leaves grefs from all the
converted strings? imho it should invoke string.Dispose and not rely on GC.


&gt;<i>  &gt; Is this a bug? Doing a workaround with:
</I>
This workaround is the right idea, but wrong: given that you don't control
&gt;<i> when collections are performed, it's possible that the Java.Lang.String you
</I>&gt;<i> create won't exist by the time you create the ArrayAdapter(). You should
</I>&gt;<i> instead have a second foreach loop to call js.Dispose() after the
</I>&gt;<i> ArrayAdapter constructor call.
</I>&gt;<i>
</I>
Hm. Why? I've already added each string into the _java_ list. I don't care
about string gref as soon as I've  added it into java list, just because
java list object will contain the reference to each java string!


&gt;<i> I'll need to bump the priority of fixing scenarios like this...
</I>&gt;<i>
</I>
Ok, thanks.


&gt;<i> &gt; Another, more annoying issue (no workaround found so far):
</I>&gt;<i> &gt; Tried to remove listener delegates ( doing -=) but that doesn't help.
</I>&gt;<i>
</I>&gt;<i> #facepalm. Oops. Yeah, that's a definite bug. :-/
</I>&gt;<i> &gt; Doing also GC.Collect(0) in each onStart() - doesn't help.
</I>
That's unexpected. Does a full GC.Collect() collect it?
&gt;<i>
</I>
Will try this.


&gt;<i>
</I>&gt;<i> &gt; I've already heard a comment &quot;use real device and see no issues with
</I>&gt;<i> 50000 gref limit&quot;.
</I>&gt;<i> &gt; But IMHO that is something like saying &quot;get a 4Gb device and don't care
</I>&gt;<i> of these memory leaks&quot;.
</I>&gt;<i>
</I>&gt;<i> To a large degree, I agree. However, given the current model, if you have
</I>&gt;<i> a View that _requires_ holding &gt; 2000 grefs, there's no way to make that
</I>&gt;<i> work on the emulator; hardware is the only workaround. (Can we change the
</I>&gt;<i> current gref-based model? Yes. Timeframe? Unknown... :-(
</I>&gt;<i>
</I>
Agree, but I can't imagine the model where you need this amount of grefs
instantly. grefs are just links between java and mono. As soon as I add and
configure controls into the view - I need no more to keep grefs. Even in
java I do not keep view object references, but use findViewById().

Moreover, in my case I have a real device with 2000gref limit (thats a bad
device, I know, but still they exist on a market).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.ximian.com/pipermail/monodroid/attachments/20120418/5644ba57/attachment.html">http://lists.ximian.com/pipermail/monodroid/attachments/20120418/5644ba57/attachment.html</A>&gt;
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009790.html">[mono-android] Excessive JNI global references (Again and again)
</A></li>
	<LI>Next message: <A HREF="009802.html">[mono-android] Excessive JNI global references (Again and again)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9800">[ date ]</a>
              <a href="thread.html#9800">[ thread ]</a>
              <a href="subject.html#9800">[ subject ]</a>
              <a href="author.html#9800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
