<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Services, Activities,	Contexts and separation of concerns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Services%2C%20Activities%2C%0A%09Contexts%20and%20separation%20of%20concerns&In-Reply-To=%3C3C8D09C4-1C62-45BE-AA34-299605A97FD7%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="009537.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Services, Activities,	Contexts and separation of concerns</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Services%2C%20Activities%2C%0A%09Contexts%20and%20separation%20of%20concerns&In-Reply-To=%3C3C8D09C4-1C62-45BE-AA34-299605A97FD7%40xamarin.com%3E"
       TITLE="[mono-android] Services, Activities,	Contexts and separation of concerns">jonp at xamarin.com
       </A><BR>
    <I>Sun Apr  1 00:12:00 UTC 2012</I>
    <P><UL>
        
        <LI>Next message: <A HREF="009537.html">[mono-android] Services, Activities,	Contexts and separation of concerns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9536">[ date ]</a>
              <a href="thread.html#9536">[ thread ]</a>
              <a href="subject.html#9536">[ subject ]</a>
              <a href="author.html#9536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mar 30, 2012, at 11:18 AM, Chris Tacke wrote:
&gt;<i> I had come to the conclusion about inheriting from Java.Lang.Object as well, and that got the service working.  I'm one of those &quot;likes to understand the internals&quot; personalities, so I'm still interested in what the IJavaObject interface requirements are - but only if you have the time and some pointers on resources.
</I>
IJavaObject is a bridging interface; it demarcates &quot;Peer objects&quot; (objects which have both a managed side and a Java side). For every Android-callable type+instance (e.g. an Activity subclass, or an implementation of java.lang.Runnable), there needs to be a Java-side type+instance to invoke.

For example, consider android.app.Activity.runOnUiThread(), which takes a java.lang.Runnable parameter. android.app.Activity instances are Native peers.

Meanwhile, C# code has Android.App.Activity.RunOnUiThread(), which takes a Java.Lang.IRunnable parameter. (There's also an Action parameter, which delegates to the IRunnable overload.) Android.App.Activity instances are Managed peers to android.app.Activity Native peers.

Android knows nothing of C# code, so what happens when you call Activity.RunOnUiThread(IRunnable)? Mono for Android passes a Java instance to Activity.runOnUiThread(); this instance is called a Native Peer.

What Java instance? Whatever Java instance IJavaObject.Handle refers to.

The requirement, then, is that IJavaObject.Handle return a JNI handle (usually a global reference) to a Java-side Naive peer instance. Furthermore, the Native peer must implement whatever interfaces a required at the callsite; e.g. if you call Activity.runOnUiThread(), the returned instance needs to be of a type that implements Runnable. Failure to do so results in interesting runtime type coercion errors. :-)

Is it possible to do this manually? Yes. Would you want to? Probably not.

...then we get to the GC, in which you want (need) to have both GCs interoperate with each other. Java.Lang.Object has support for this. Whatever IJavaObject implementation you cook up will not, and unless your managed object is somehow rooted (static variable?), there's no way to keep Mono's GC from collecting your object when Java is still referring to the Native peer; likewise, there's no way to keep Java from collecting the Native peer when the Managed peer (the C# instance) is still alive.

Furthermore, 4.1 will be introducing a change in which IJavaObject implements IDisposable, so if you manually implement IJavaObject you'll probably be getting a compilation error out of it...

 - Jon

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="009537.html">[mono-android] Services, Activities,	Contexts and separation of concerns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9536">[ date ]</a>
              <a href="thread.html#9536">[ thread ]</a>
              <a href="subject.html#9536">[ subject ]</a>
              <a href="author.html#9536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
