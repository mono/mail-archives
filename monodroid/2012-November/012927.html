<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] ContentResolver.Query takes greater than 10	seconds when returning while the actual DB query takes 4ms
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20ContentResolver.Query%20takes%20greater%20than%2010%0A%09seconds%20when%20returning%20while%20the%20actual%20DB%20query%20takes%204ms&In-Reply-To=%3C6FD4973F-6238-4E7A-B71C-4EE589A2482F%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012926.html">
   <LINK REL="Next"  HREF="012917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] ContentResolver.Query takes greater than 10	seconds when returning while the actual DB query takes 4ms</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20ContentResolver.Query%20takes%20greater%20than%2010%0A%09seconds%20when%20returning%20while%20the%20actual%20DB%20query%20takes%204ms&In-Reply-To=%3C6FD4973F-6238-4E7A-B71C-4EE589A2482F%40xamarin.com%3E"
       TITLE="[mono-android] ContentResolver.Query takes greater than 10	seconds when returning while the actual DB query takes 4ms">jonp at xamarin.com
       </A><BR>
    <I>Wed Nov 21 16:23:05 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="012926.html">[mono-android] ContentResolver.Query takes greater than	10	seconds when returning while the actual DB query takes 4ms
</A></li>
        <LI>Next message: <A HREF="012917.html">[mono-android] Drawable icon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12927">[ date ]</a>
              <a href="thread.html#12927">[ thread ]</a>
              <a href="subject.html#12927">[ subject ]</a>
              <a href="author.html#12927">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Nov 21, 2012, at 11:00 AM, &quot;Jeremy A. Kolb - ARA/NED&quot; &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">jkolb at ara.com</A>&gt; wrote:
&gt;<i> If I wrap the cursor in a &quot;MyCursor&quot; object and forward all the methods on I'm seeing that Count is being called by the ICursorInvoker:
</I>&gt;<i> 
</I>&gt;<i> 	0x1 in MinefieldManagement.Provider.MyCursor.get_Count
</I>&gt;<i> 	0x9 in Android.Database.ICursorInvoker.n_GetCount
</I>&gt;<i> 	0xC in object.c279bfc1-6dc5-4f8f-b576-58cb01b20d3d	(System.Reflection.Emit-generated code)
</I>&gt;<i> 	0x12 in Android.Runtime.JNIEnv.CallObjectMethod
</I>&gt;<i> 	0xB6 in Android.Content.ContentResolver.Query
</I>&gt;<i> 	0xD1 in MinefieldManagement.Overlays.MinefieldOverlay.OnSingleTapConfirmed
</I>

It's being called because Java is calling it. Let's reverse that stack trace so we can see timing:

	0xD1: MinefieldOverlay.OnSingleTapConfirmed calls ContentResolver.Query()
	0xB6: ContentResolver.Query() calls JNIEnv.CallObjectMethod()
	0x12: JNIEnv.CallObjectMethod() goes into Dalvik-land...

	Dalvik-land performs the Java-side ContentResolver.query() call, which is calling back into Managed code?
	Your C# ContentProvider.Query() is invoked, returns an ICursor implementation to Dalvik-land

	0xC: Dalvik-land ContentResolver.query() calls Cursor.getCount()
	0x9: Cursor.getCount() is implemented in managed code, so it hits the Android Callable Wrapper ICursorInvoker.n_GetCount() method
	0x1: ICursorInvoker.n_GetCount() invokes the ICursor.Count property getter

For more information on what ICursorInvoker is doing, see the epic JNI tomb [0, 1]. It's ~all generated code...

It would be interesting to see if any other ICursor methods are being invoked in addition to ICursor.Count...

My guess is that (1) your query is &quot;big&quot;, and (2) Android is trying to copy the entire Cursor contents, and because of (1) the copy takes awhile. To confirm, what value is your ICursor.Count returning, and are the other methods being invoked to grab the data?

 - Jon

[0]: <A HREF="http://docs.xamarin.com/Android/Guides/Advanced_Topics/Java_Integration_Overview/Working_With_JNI">http://docs.xamarin.com/Android/Guides/Advanced_Topics/Java_Integration_Overview/Working_With_JNI</A>
[1]: <A HREF="http://docs.xamarin.com/Android/Guides/Advanced_Topics/Java_Integration_Overview/Working_With_JNI#Invoker_Definition">http://docs.xamarin.com/Android/Guides/Advanced_Topics/Java_Integration_Overview/Working_With_JNI#Invoker_Definition</A>

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012926.html">[mono-android] ContentResolver.Query takes greater than	10	seconds when returning while the actual DB query takes 4ms
</A></li>
	<LI>Next message: <A HREF="012917.html">[mono-android] Drawable icon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12927">[ date ]</a>
              <a href="thread.html#12927">[ thread ]</a>
              <a href="subject.html#12927">[ subject ]</a>
              <a href="author.html#12927">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
