<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=%5BMonodroid%5D%20How%20to%20correctly%20initialize%20data%20in%20constructor%0A%20taking%20IntPtr%20as%20parameter%20or%20potential%20bug%3F&In-Reply-To=8D243ADC-A7C6-4604-9A57-FAC00C88A8AE%40novell.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002689.html">
   <LINK REL="Next"  HREF="002671.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?</H1>
    <B>Michal Sartoris</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=%5BMonodroid%5D%20How%20to%20correctly%20initialize%20data%20in%20constructor%0A%20taking%20IntPtr%20as%20parameter%20or%20potential%20bug%3F&In-Reply-To=8D243ADC-A7C6-4604-9A57-FAC00C88A8AE%40novell.com"
       TITLE="[Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?">miso at resco.net
       </A><BR>
    <I>Wed Jan 26 06:31:03 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002689.html">[Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?
</A></li>
        <LI>Next message: <A HREF="002671.html">[Monodroid] UDP Sockets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2696">[ date ]</a>
              <a href="thread.html#2696">[ thread ]</a>
              <a href="subject.html#2696">[ subject ]</a>
              <a href="author.html#2696">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Jon,

It looks like my problem is the same as already filled bug. So I'll wait till you fix it and we will see then.

Best regards,

Ing. Michal Sartoris
Resco.net


-----Original Message-----
From: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A> [mailto:<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid-bounces at lists.ximian.com</A>] On Behalf Of Jonathan Pryor
Sent: Tuesday, January 25, 2011 11:26 PM
To: <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">monodroid at lists.ximian.com</A>
Subject: Re: [Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?

(Some day, I've got to centralize all of the documentation we've written in the release notes...)

I don't fully understand  you're scenario, so I'll blast a whole ton of text at you and hope something is relevant. :-)

Firstly, THE most important question: how are these instances being instantiated?

If these instances are being instantiated from Android, then you _normally_ don't need to provide a (IntPtr) constructor, you'd instead need to provide the constructor that Android will be invoking:

        <A HREF="http://monodroid.net/Releases/Previews/Preview_7#intptr-constructor">http://monodroid.net/Releases/Previews/Preview_7#intptr-constructor</A>

The exception to this is when the Android base class constructor invokes a virtual method that you've overridden, in which case you WILL need an (IntPtr) constructor; see the above URL.

For &quot;good&quot; measure, in the above scenario the (IntPtr) constructor will be invoked, and then (on the same instance) the &quot;normal&quot; constructor will be invoked -- so you'll have methods invoked on you before your constructor has run.  This is &quot;normal,&quot; in that the same thing can happen in C#, and is why calling virtual methods from constructors is (usually) a Bad Idea(tm).

To help confirm that this is happening, view the 'adb logcat' output and try to find the Java stack trace that follows the managed stack trace; you should find a Java constructor in it (often an &lt;init&gt; function).

If these instances are instead being created from  your code, then you should NEVER need an (IntPtr) constructor; if you DO need one, that's  because of one of two things:

 1. The instance hasn't been properly rooted and was prematurely collected in managed code when Java was still using it.  An example:

        <A HREF="https://bugzilla.novell.com/show_bug.cgi?id=658698#c2">https://bugzilla.novell.com/show_bug.cgi?id=658698#c2</A>

        javaObject.JavaMethod (new SomeTypeInheritingJavaLangObject ());

    The fix here is to ensure that the object is &quot;live&quot; during the Java call.

        using(var v = new SomeTypeInheritingJavaLangObject ())
                javaObject.JavaMethod (v);

 2. The garbage collector has otherwise screwed up; please file a bug with a test case. :-)

 - Jon

On Jan 24, 2011, at 11:58 AM, Michal Sartoris wrote:
&gt;<i> We are using customized ListView with own adapter (derived from BaseAdapter) and own custom View used for rows. Everything works fine, but sometimes both adapter or row view are created from native handle using constructor with IntPtr as parameter and I dont know how to correctly initialize data members defined in our custom classes.
</I>&gt;<i>
</I>&gt;<i> Case 1 - Row view
</I>&gt;<i> During scroll, it sometimes happen that row view is created from native handle using IntPtr constructor. As private data are not initialized, app will crash later (i.e. during draw) or at least draw nothing.
</I>&gt;<i>
</I>&gt;<i> You can take a sample from my previous bug report (<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=656759">https://bugzilla.novell.com/show_bug.cgi?id=656759</A>) and try it yourself. As this happens randomly, you probably will need to run it several times. You also need to update Cell class with constructor taking IntPtr as paramter, otherwise app will crash because of missing constructor.
</I>&gt;<i>
</I>&gt;<i> Stack trace showing when this constructor is called:
</I>&gt;<i>
</I>&gt;<i> at Sample.MonoDroid.ListCell..ctor(IntPtr handle)
</I>&gt;<i>    at System.Reflection.MonoCMethod.Invoke(System.Object obj, BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture)
</I>&gt;<i>    at System.Reflection.MonoCMethod.Invoke(BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, BindingFlags bindingAttr, System.Reflection.Binder binder, System.Object[] args, System.Globalization.CultureInfo culture, System.Object[] activationAttributes)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, System.Object[] args, System.Object[] activationAttributes)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, System.Object[] args)
</I>&gt;<i>    at Android.Runtime.TypeManager.CreateInstance(IntPtr handle, System.Type targetType)
</I>&gt;<i>    at Java.Lang.Object.GetObject(IntPtr handle, System.Type type, Boolean owned)
</I>&gt;<i>    at Java.Lang.Object.GetObject(IntPtr handle, Boolean owned)
</I>&gt;<i>    at Android.Widget.BaseAdapter.n_GetView_ILandroid_view_View_Landroid_view_ViewGroup_(IntPtr jnienv, IntPtr native__this, Int32 position, IntPtr native_convertView, IntPtr native_parent)
</I>&gt;<i>    at System.Object.6061cd18-f656-4e25-8345-392cb54428a0(IntPtr , IntPtr , Int32 , IntPtr , IntPtr )
</I>&gt;<i>
</I>&gt;<i> Or during layout from
</I>&gt;<i>
</I>&gt;<i> at Android.Views.View.n_OnMeasure_II(IntPtr jnienv, IntPtr native__this, Int32 widthMeasureSpec, Int32 heightMeasureSpec)
</I>&gt;<i>
</I>&gt;<i> Case 2 - Adapter
</I>&gt;<i> The same sometimes also happen for adapter class also, like in this stack trace (showing when this special constrctor is called):
</I>&gt;<i>
</I>&gt;<i> at Sample.MonoDroid.ListAdapter..ctor(IntPtr handle)
</I>&gt;<i>    at System.Reflection.MonoCMethod.Invoke(System.Object obj, BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture)
</I>&gt;<i>    at System.Reflection.MonoCMethod.Invoke(BindingFlags invokeAttr, System.Reflection.Binder binder, System.Object[] parameters, System.Globalization.CultureInfo culture)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, BindingFlags bindingAttr, System.Reflection.Binder binder, System.Object[] args, System.Globalization.CultureInfo culture, System.Object[] activationAttributes)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, System.Object[] args, System.Object[] activationAttributes)
</I>&gt;<i>    at System.Activator.CreateInstance(System.Type type, System.Object[] args)
</I>&gt;<i>    at Android.Runtime.TypeManager.CreateInstance(IntPtr handle, System.Type targetType)
</I>&gt;<i>    at Java.Lang.Object.GetObject(IntPtr handle, System.Type type, Boolean owned)
</I>&gt;<i>    at Java.Lang.Object.GetObject(IntPtr handle, Boolean owned)
</I>&gt;<i>    at Android.Widget.BaseAdapter.n_GetCount(IntPtr jnienv, IntPtr native__this)
</I>&gt;<i>    at System.Object.5a7459cc-a37a-46af-be15-dbe22e673533(IntPtr , IntPtr )
</I>&gt;<i>    at &lt;Module&gt;.invoke_void__this___intptr_intptr_intptr_intptr_JValue[](IntPtr , IntPtr , IntPtr , IntPtr , Android.Runtime.JValue[] )
</I>&gt;<i>    at Android.Runtime.JNIEnv.CallNonvirtualVoidMethod(IntPtr jobject, IntPtr jclass, IntPtr jmethod, Android.Runtime.JValue[] parms)
</I>&gt;<i>    at Android.Views.View.OnSizeChanged(Int32 w, Int32 h, Int32 oldw, Int32 oldh)
</I>&gt;<i>
</I>&gt;<i> And then Sample.MonoDroid.ListAdapter.Count is called on this new instance, but as private data are not correctly initialized (are null), app crashes.
</I>&gt;<i>
</I>&gt;<i> So the question is, why this happen and if it is needed, how to reinitialize private data so app wont crash and correct data are displayed?
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i>
</I>&gt;<i> Ing. Michal Sartoris
</I>&gt;<i> Resco.net
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> __________ Information from ESET NOD32 Antivirus, version of virus signature database 5813 (20110124) __________
</I>&gt;<i>
</I>&gt;<i> The message was checked by ESET NOD32 Antivirus.
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.eset.com">http://www.eset.com</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>
_______________________________________________
Monodroid mailing list
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>

UNSUBSCRIBE INFORMATION:
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>





__________ Information from ESET NOD32 Antivirus, version of virus signature database 5819 (20110126) __________

The message was checked by ESET NOD32 Antivirus.

<A HREF="http://www.eset.com">http://www.eset.com</A>



__________ Information from ESET NOD32 Antivirus, version of virus signature database 5820 (20110126) __________

The message was checked by ESET NOD32 Antivirus.

<A HREF="http://www.eset.com">http://www.eset.com</A>


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002689.html">[Monodroid] How to correctly initialize data in constructor taking IntPtr as parameter or potential bug?
</A></li>
	<LI>Next message: <A HREF="002671.html">[Monodroid] UDP Sockets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2696">[ date ]</a>
              <a href="thread.html#2696">[ thread ]</a>
              <a href="subject.html#2696">[ subject ]</a>
              <a href="author.html#2696">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
