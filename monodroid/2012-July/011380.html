<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] Program that reproduces Mono4Android deadlock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Program%20that%20reproduces%20Mono4Android%20deadlock&In-Reply-To=%3C5003FFD9.5010106%40eqqon.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011379.html">
   <LINK REL="Next"  HREF="011415.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] Program that reproduces Mono4Android deadlock</H1>
    <B>Meinrad Recheis</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20Program%20that%20reproduces%20Mono4Android%20deadlock&In-Reply-To=%3C5003FFD9.5010106%40eqqon.com%3E"
       TITLE="[mono-android] Program that reproduces Mono4Android deadlock">meinrad.recheis at eqqon.com
       </A><BR>
    <I>Mon Jul 16 11:49:45 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="011379.html">[mono-android] Program that reproduces Mono4Android deadlock
</A></li>
        <LI>Next message: <A HREF="011415.html">[mono-android] Program that reproduces Mono4Android deadlock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11380">[ date ]</a>
              <a href="thread.html#11380">[ thread ]</a>
              <a href="subject.html#11380">[ subject ]</a>
              <a href="author.html#11380">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan,
Another info: I just tested with an older Samsung Galaxy S that has only
one core and couldn't reproduce any deadlocks even with 10 background
threads whereas with the dual core Galaxy Tab 10.1 it is really easy to
reproduce.
-- Henon

Dipl. Ing. Meinrad Recheis
eqqon GmbH
Friedmanngasse 32/20
1160 Wien, &#214;sterreich
Tel.: +43 (0) 680-31-800-37
Fax: +43 (0) 1-25-330-339-356
<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">meinrad.recheis at eqqon.com</A>

Firma: eqqon GmbH
Rechtsform: Gesellschaft mit beschr&#228;nkter Haftung
Firmensitz: Wien
Firmenbuchnummer: FN 327919 i
Firmenbuchgericht: Handelsgericht Wien

--
eqqon Disclaimer / Legal notice: <A HREF="http://www.eqqon.com/index.php/Disclaimer">http://www.eqqon.com/index.php/Disclaimer</A> 


On 16.07.2012 13:03, Meinrad Recheis wrote:
&gt;<i> Hi Jonathan,
</I>&gt;<i> Thanks for your help!
</I>&gt;<i>
</I>&gt;<i> On 13.07.2012 17:39, Jonathan Pryor wrote:
</I>&gt;&gt;<i> On Jul 12, 2012, at 10:51 AM, henon wrote:
</I>&gt;&gt;&gt;<i> The problem is, that I am experiencing non-deterministic hangups. When hanging I pause the debugger and I always see that the executing thread (mostly my code on the GUI thread) hangs in some random method
</I>&gt;&gt;<i> Which Mono for Android version? (Have you tried the 4.2.4 beta?)
</I>&gt;<i> I use the latest update that has been automatically downloaded by
</I>&gt;<i> MonoDevelop on Windows. I searched around but I don't find a download
</I>&gt;<i> link for 4.2.4 beta. How do you get the beta version? How to find out
</I>&gt;<i> the Version of Mono4Android? Monodevelop says the version of MFA is
</I>&gt;<i> 3.0.3 but I don't believe it ;)
</I>&gt;&gt;<i> Does it have non-deterministic hangups if you don't have the debugger attached?
</I>&gt;<i> Yes, definitely. 
</I>&gt;&gt;&gt;<i> The stacktrace of the hanging thread always looks like this 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> System.Threading.Monitor.TryEnter ...
</I>&gt;&gt;&gt;<i> System.Threading.Monitor.Enter ...
</I>&gt;&gt;&gt;<i> Java.Lang.Object.GetObject ...
</I>&gt;&gt;&gt;<i> Java.Lang.Object._GetObject
</I>&gt;&gt;&gt;<i> Java.Lang.Object.GetObject ...
</I>&gt;&gt;&gt;<i> ...
</I>&gt;&gt;<i> You have any methods beyond that?
</I>&gt;<i> Stacktraces:
</I>&gt;<i>
</I>&gt;<i> Normal case, GuiThread in Deadlock:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> System.Threading.Monitor.TryEnter (obj=, millisecondsTimeout=,
</I>&gt;<i> lockTaken=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:224
</I>&gt;<i> System.Threading.Monitor.Enter (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:198
</I>&gt;<i> Java.Interop.TypeManager.CreateInstance (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Interop/TypeManager.cs:172
</I>&gt;<i> Java.Lang.Object.GetObject (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:226
</I>&gt;<i> Android.Runtime.AndroidEnvironment.GetLastThrowable (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/AndroidEnvironment.cs:57
</I>&gt;<i> Android.Runtime.JNIEnv.FindClass (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/JNIEnv.cs:258
</I>&gt;<i> Android.Runtime.JNIEnv.CreateInstance (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/JNIEnv.cs:203
</I>&gt;<i> Java.Lang.Thread.RunnableImplementor..ctor (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Thread.cs
</I>&gt;<i> Java.Lang.Thread.RunnableImplementor..ctor (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Thread.cs
</I>&gt;<i> Android.App.Activity.RunOnUiThread (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Android.App/Activity.cs:23
</I>&gt;<i> DeadlockRepro.Activity1.ThreadBody (Parameters=) in
</I>&gt;<i> c:\Projects\DeadlockRepro\DeadlockRepro\Activity1.cs:40
</I>&gt;<i> System.Threading.Thread.StartInternal (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Thread.cs:708
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I even managed to reproduce a deadlock where the finalizer Thread is
</I>&gt;<i> involved. All 3 of 4 threads were hanging in TryEnter:
</I>&gt;<i>
</I>&gt;<i> First Thread:
</I>&gt;<i> System.Threading.Monitor.TryEnter (obj=, millisecondsTimeout=,
</I>&gt;<i> lockTaken=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:224
</I>&gt;<i> System.Threading.Monitor.Enter (obj=The vm is not suspended.,
</I>&gt;<i> lockTaken=false) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:198
</I>&gt;<i> Java.Lang.Object.GetObject (handle=0x4143e5c8, transfer=, type=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:215
</I>&gt;<i> Java.Lang.Object._GetObject (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:207
</I>&gt;<i> Java.Lang.Object.GetObject (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:199
</I>&gt;<i> Java.Lang.IRunnableInvoker.n_Run (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/platforms/android-8/src/generated/Java.Lang.IRunnable.cs:68
</I>&gt;<i> object.96985076-ae7e-4301-b924-2b58374646b7 (Parameters=) in
</I>&gt;<i>
</I>&gt;<i> Second Thread:
</I>&gt;<i> System.Threading.Monitor.TryEnter (obj=, millisecondsTimeout=,
</I>&gt;<i> lockTaken=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:224
</I>&gt;<i> System.Threading.Monitor.Enter (obj=The vm is not suspended.,
</I>&gt;<i> lockTaken=false) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:198
</I>&gt;<i> Java.Lang.Object.RegisterInstance (instance=The vm is not suspended.,
</I>&gt;<i> value=0x41376938, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:153
</I>&gt;<i> Java.Lang.Throwable.SetHandle (value=, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Throwable.cs:53
</I>&gt;<i> Java.Lang.Throwable..ctor (handle=, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Throwable.cs:22
</I>&gt;<i> Java.Lang.Error..ctor (javaReference=, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/platforms/android-8/src/generated/Java.Lang.Error.cs
</I>&gt;<i> Java.Lang.LinkageError..ctor (javaReference=, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/platforms/android-8/src/generated/Java.Lang.LinkageError.cs
</I>&gt;<i> Java.Lang.NoClassDefFoundError..ctor (javaReference=, transfer=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/platforms/android-8/src/generated/Java.Lang.NoClassDefFoundError.cs
</I>&gt;<i>
</I>&gt;<i> Third Thread (GUI Thread ?)
</I>&gt;<i> Android.Runtime.JNIEnv.LogCreateLocalRef (jobject=0x0) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/JNIEnv.cs:391
</I>&gt;<i> Android.Runtime.JNIEnv.FindClass
</I>&gt;<i> (classname=&quot;mono/java/lang/RunnableImplementor&quot;) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/JNIEnv.cs:256
</I>&gt;<i> Android.Runtime.JNIEnv.CreateInstance
</I>&gt;<i> (jniClassName=&quot;mono/java/lang/RunnableImplementor&quot;, signature=&quot;()V&quot;,
</I>&gt;<i> constructorParameters={Android.Runtime.JValue[0]}) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Runtime/JNIEnv.cs:203
</I>&gt;<i> Java.Lang.Thread.RunnableImplementor..ctor (handler={System.Action},
</I>&gt;<i> removable=false) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Thread.cs
</I>&gt;<i> Java.Lang.Thread.RunnableImplementor..ctor (handler={System.Action}) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Thread.cs
</I>&gt;<i> Android.App.Activity.RunOnUiThread (action={System.Action}) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Android.App/Activity.cs:23
</I>&gt;<i> DeadlockRepro.Activity1.ThreadBody () in
</I>&gt;<i> c:\Projects\DeadlockRepro\DeadlockRepro\Activity1.cs:40
</I>&gt;<i> System.Threading.Thread.StartInternal () in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Thread.cs:708
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Finalizer Thread
</I>&gt;<i> System.Threading.Monitor.TryEnter (obj=, millisecondsTimeout=,
</I>&gt;<i> lockTaken=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:224
</I>&gt;<i> System.Threading.Monitor.Enter (obj=, lockTaken=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/mono/mcs/class/corlib/System.Threading/Monitor.cs:198
</I>&gt;<i> Java.Lang.Object.DeregisterInstance (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:171
</I>&gt;<i> Java.Lang.Object.Dispose (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Object.cs:118
</I>&gt;<i> Java.Lang.Throwable.Finalize (Parameters=) in
</I>&gt;<i> /Users/builder/data/lanes/monodroid-mac-monodroid-4.2.3-branch/410a5aba/source/monodroid/src/Mono.Android/src/Java.Lang/Throwable.cs:95
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Below is a very simple Mono4Android activity that reproduces the
</I>&gt;<i> deadlock very likely (the stacktraces above are actually taken from it).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Create a new Mono4AndroidProject with below code for Activity1. Nothing
</I>&gt;<i> else is needed. I was able to reproduce the deadlock on my GalaxyTab
</I>&gt;<i> 10.1 very easily even on first run.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> using System;
</I>&gt;<i>
</I>&gt;<i> using Android.App;
</I>&gt;<i> using Android.Content;
</I>&gt;<i> using Android.Runtime;
</I>&gt;<i> using Android.Views;
</I>&gt;<i> using Android.Widget;
</I>&gt;<i> using Android.OS;
</I>&gt;<i> using System.Threading;
</I>&gt;<i>
</I>&gt;<i> namespace DeadlockRepro
</I>&gt;<i> {
</I>&gt;<i>     [Activity (Label = &quot;DeadlockRepro&quot;, MainLauncher = true)]
</I>&gt;<i>     public class Activity1 : Activity
</I>&gt;<i>     {
</I>&gt;<i>         int count = 1;
</I>&gt;<i>         bool m_stop=false;
</I>&gt;<i>
</I>&gt;<i>         Thread m_background_worker;
</I>&gt;<i>
</I>&gt;<i>         protected override void OnCreate (Bundle bundle)
</I>&gt;<i>         {
</I>&gt;<i>             base.OnCreate (bundle);
</I>&gt;<i>
</I>&gt;<i>             // Set our view from the &quot;main&quot; layout resource
</I>&gt;<i>             SetContentView (Resource.Layout.Main);
</I>&gt;<i>
</I>&gt;<i>             // Get our button from the layout resource,
</I>&gt;<i>             // and attach an event to it
</I>&gt;<i>             //Button button = FindViewById&lt;Button&gt; (Resource.Id.myButton);
</I>&gt;<i>            
</I>&gt;<i>             m_background_worker=new Thread(ThreadBody);
</I>&gt;<i>             m_background_worker.Start();
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         private void ThreadBody() {
</I>&gt;<i>             while(!m_stop) {
</I>&gt;<i>                 Thread.Sleep(100);
</I>&gt;<i>                 count++;
</I>&gt;<i>                 RunOnUiThread(GuiUpdate);
</I>&gt;<i>             }
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         private void GuiUpdate() {
</I>&gt;<i>             var button=FindViewById&lt;Button&gt; (Resource.Id.myButton);
</I>&gt;<i>             button.Text=string.Format(&quot;Background thread cycles: {0}&quot;,
</I>&gt;<i> count);
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> If it does not deadlock at the first run, please run it a few times and
</I>&gt;<i> leave it running for a minute or so. It usually hangs within seconds
</I>&gt;<i> after starting and it happens even when detached from the debugger.
</I>&gt;<i> Hope this gets you on the right track. If you need anything else, let me
</I>&gt;<i> know. Please also let me know if you were able to reproduce the behavior.
</I>&gt;<i> Thanks,
</I>&gt;<i> -- Henon
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>  - Jon
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Monodroid mailing list
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Monodroid mailing list
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">Monodroid at lists.ximian.com</A>
</I>&gt;<i>
</I>&gt;<i> UNSUBSCRIBE INFORMATION:
</I>&gt;<i> <A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">http://lists.ximian.com/mailman/listinfo/monodroid</A>
</I>&gt;<i>
</I></PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011379.html">[mono-android] Program that reproduces Mono4Android deadlock
</A></li>
	<LI>Next message: <A HREF="011415.html">[mono-android] Program that reproduces Mono4Android deadlock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11380">[ date ]</a>
              <a href="thread.html#11380">[ thread ]</a>
              <a href="subject.html#11380">[ subject ]</a>
              <a href="author.html#11380">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
