<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] jni error with 4.2.4 on jellybean
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20jni%20error%20with%204.2.4%20on%20jellybean&In-Reply-To=%3C3FC77A2E-EAED-429D-BEDA-CB86891A8887%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011980.html">
   <LINK REL="Next"  HREF="011999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] jni error with 4.2.4 on jellybean</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20jni%20error%20with%204.2.4%20on%20jellybean&In-Reply-To=%3C3FC77A2E-EAED-429D-BEDA-CB86891A8887%40xamarin.com%3E"
       TITLE="[mono-android] jni error with 4.2.4 on jellybean">jonp at xamarin.com
       </A><BR>
    <I>Thu Aug 23 14:54:07 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="011980.html">[mono-android] jni error with 4.2.4 on jellybean
</A></li>
        <LI>Next message: <A HREF="011999.html">[mono-android] jni error with 4.2.4 on jellybean
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11938">[ date ]</a>
              <a href="thread.html#11938">[ thread ]</a>
              <a href="subject.html#11938">[ subject ]</a>
              <a href="author.html#11938">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Aug 23, 2012, at 4:18 AM, mcleodia &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/monodroid">mcleodia at gmail.com</A>&gt; wrote:
&gt;<i> Sorry, I meant the stacktrace I originally provided in the first post, which appears to point the finger at windowManager.DefaultDisplay.GetMetrics() and something going bad internally within the java world when this method was called.
</I>
It's not something &quot;going bad...within the java world.&quot; Java's fine; it's something going bad in the Mono world.

Mono for Android attempts to provide object identity; in the following code, `a` and `b` are the same instance, and the exception is never thrown:

	var a = context.ApplicationContext;
	var b = context.ApplicationContext;
	if (!object.ReferenceEquals (a, b))
		throw new InvalidOperationException ();

The above is true because it would be borderline insane to do otherwise. ;-)

HOWEVER, in order to provide the above desired semantics, internally we basically have a Dictionary&lt;IntPtr, object&gt; mapping JNI handles to object wrapper instances, and when e.g. context.ApplicationContext is accessed we invoke the Java Context.getApplicationContext() method and check to see if the returned JNI handle is registered in the mapping. If it is, we return the associated instance.

The problem happens when things get &quot;messed up&quot;, which you can do deliberately (if inadvisedly):

	JNIEnv.DeleteGlobalRef (a.Handle);
	var d = a.FilesDir;

In the above, we've explicitly deleted the gref associated with `a`. `a` doesn't know that you've done this, so when you invoke the Context.FilesDir property `a` will be using an invalid gref handle. What will happen? It depends on the Android version; on v4.0+ you'll get a Dalvik VM error about using an invalid gref (followed by app crash+exit). Pre-v4.0 it'll probably work, because gref values are direct pointers to the Java instance.

Regardless, doing the above is a Bad Idea&#8482;. Don't do that.

So lets assume no one is doing anything as crazy/evil/stupid as calling JNIEnv.DeleteGlobalRef(a.Handle). Is there any other way for things to get screwed up &quot;by accident&quot;?

Sure: multithreading. If thread T1 calls Dispose() on an instance while thread T2 is using the same instance, it's entirely possible that T2 will be using an invalidated or invalid gref because T1 just mutated the same instance.

This also falls under the Don't Do That mantra: modifying shared instance variables between threads is generally ill advised unless the types are known to be thread safe or locking is used. The issue here is that it's easier to run across shared instances, as unless you _know_ (via documentation) that a Java method is creating a new instance, there's little/no way of knowing whether you're getting a new instance that you can safely dispose.

&gt;<i> I just wanted to verify that stacktrace was an accurate indicator of the exact moment of failure...
</I>
Yes, it should be an accurate indicator.

 - Jon

</PRE>




































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011980.html">[mono-android] jni error with 4.2.4 on jellybean
</A></li>
	<LI>Next message: <A HREF="011999.html">[mono-android] jni error with 4.2.4 on jellybean
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11938">[ date ]</a>
              <a href="thread.html#11938">[ thread ]</a>
              <a href="subject.html#11938">[ subject ]</a>
              <a href="author.html#11938">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
