<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [mono-android] profiling support in monodroid?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20profiling%20support%20in%20monodroid%3F&In-Reply-To=%3C03214EDE-5BCC-4BFE-B0B0-05CE9170A79C%40xamarin.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009351.html">
   <LINK REL="Next"  HREF="009397.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[mono-android] profiling support in monodroid?</H1>
    <B>Jonathan Pryor</B> 
    <A HREF="mailto:monodroid%40lists.ximian.com?Subject=Re%3A%20%5Bmono-android%5D%20profiling%20support%20in%20monodroid%3F&In-Reply-To=%3C03214EDE-5BCC-4BFE-B0B0-05CE9170A79C%40xamarin.com%3E"
       TITLE="[mono-android] profiling support in monodroid?">jonp at xamarin.com
       </A><BR>
    <I>Tue Mar 20 19:00:43 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="009351.html">[mono-android] profiling support in monodroid?
</A></li>
        <LI>Next message: <A HREF="009397.html">[mono-android] profiling support in monodroid?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9377">[ date ]</a>
              <a href="thread.html#9377">[ thread ]</a>
              <a href="subject.html#9377">[ subject ]</a>
              <a href="author.html#9377">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mar 19, 2012, at 1:32 PM, mcleodia wrote:
&gt;<i> I went away and tried to get the profiler running via environment variables as per your suggestion, however I didn't see a way of invoking the profiler other than using the command line option '--profile=log:heapshot'.  
</I>
iirc heapshot is a separate native library, which we don't currently build or bundle. Oops. :-/

&gt;<i> The next step I took was to strip back our codebase to run just the very core network stack (which is cross platform and runs on .NET and Mono),
</I>
Brilliant idea.

&gt;<i> I managed to find a leak when repeatedly starting/stopping our network stack on a busy network on a mac using mono (with boehm GC).
</I>
You should use sgen, as that's what Mono for Android uses. However, with both boehm and sgen the stack is conservatively scanned, so it's possible that the GC believes that a value is still being used when it isn't being used.

&gt;<i> Again, sadly, I also ran into the very same problem that we encountered with the GC crashes bug we discussed previously
</I>
This is very good, actually; if we can repro the issue without needing to run on an Android device, things get much simpler. :-)

Please file a bug at bugzilla.xamarin.com with instructions on how to reproduce. :-)

&gt;<i> - it only seems to happen on a busy network with plenty of Upnp devices kicking about
</I>
:<i>-/
</I>
Would it be possible to fire up some extra threads which create UDP traffic on the appropriate port? (I suspect not; iirc only a single process on a machine can &quot;own&quot; a port, but running an app on a different machine on the same network might be able to create enough UPNP-like traffic that the issue is triggered...)

&gt;<i> My next line of attack was to try to get the mono profiler running on the mac, and try and chase down the leaked objects but unfortunately the profiler requires the use of sgen and as soon as I run it using sgen, both mono 2.10.8 and the 2.10.9 beta crash out with mono-sgen related stacktraces.
</I>
I need to sic the GC guys on this...

&gt;<i> So next I had a shot at compiling and running the latest mono from a fresh git clone today, but this crashed out with an EntryPointNotFoundException trying to run CreateNLSocket() from libMonoPosixHelper
</I>
I'm guessing that you need to set DYLD_LIBRARY_PATH so that your new libMonoPosixHelper.dylib is found when running your newly built mono. For example, this is what I set things to for my git build of mono:

	export MONO_PREFIX=/Users/jon/Development/mono-HEAD/install
	export PATH=$MONO_PREFIX/bin:$PATH
	export PKG_CONFIG_PATH=$MONO_PREFIX/lib/pkgconfig:/Library/Frameworks/Mono.framework/Libraries/pkgconfig:$PKG_CONFIG_PATH
	export ACLOCAL_FLAGS=&quot;-I /Library/Frameworks/Mono.framework/Versions/Current/share/aclocal&quot;
	export DYLD_FALLBACK_LIBRARY_PATH=/Library/Frameworks/Mono.framework/Versions/Current/lib:/lib:/usr/lib

Thanks,
 - Jon

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009351.html">[mono-android] profiling support in monodroid?
</A></li>
	<LI>Next message: <A HREF="009397.html">[mono-android] profiling support in monodroid?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9377">[ date ]</a>
              <a href="thread.html#9377">[ thread ]</a>
              <a href="subject.html#9377">[ subject ]</a>
              <a href="author.html#9377">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/monodroid">More information about the Monodroid
mailing list</a><br>
</body></html>
