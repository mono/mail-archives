<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20345510%5D%20CryptoStream%20ignores%20the%20ICryptoTransform.%0A%20CanTransformMultipleBlocks%20property%20when%20reading&In-Reply-To=bug-345510-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="065890.html">
   <LINK REL="Next"  HREF="065897.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20345510%5D%20CryptoStream%20ignores%20the%20ICryptoTransform.%0A%20CanTransformMultipleBlocks%20property%20when%20reading&In-Reply-To=bug-345510-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Dec  3 15:25:24 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="065890.html">[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading
</A></li>
        <LI>Next message: <A HREF="065897.html">[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65896">[ date ]</a>
              <a href="thread.html#65896">[ thread ]</a>
              <a href="subject.html#65896">[ subject ]</a>
              <a href="author.html#65896">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=345510">https://bugzilla.novell.com/show_bug.cgi?id=345510</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lordhabbit at gmail.com</A> added comment
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=345510#c3">https://bugzilla.novell.com/show_bug.cgi?id=345510#c3</A>


Javier Martin &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lordhabbit at gmail.com</A>&gt; changed:

           What    |Removed                                         |Added
----------------------------------------------------------------------------
             Status|NEEDINFO                                        |ASSIGNED
      Info Provider|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lordhabbit at gmail.com</A>                            |




--- Comment #3 from Javier Martin &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lordhabbit at gmail.com</A>&gt;  2007-12-03 13:25:24 MST ---
As I made pretty clear, the bug is in the CS.Read method, not in CS.Write which
you use in your code example. I know there are other ways I can go -
ComputeHash is a good one for one algorithm, but I'm chaining them. Also, I'd
rather not use CS.Write in order to read data from a file: seems too much of a
hack to me.

This is a sample of the code I'm using, modified to remove some Trace output
and  instances of classes from my project:

        static Stack&lt;byte[]&gt; HashFile(string fileName, HashAlgorithm[]
algorithms)
        {
            if (fileName != null &amp;&amp; algorithms != null &amp;&amp;
File.Exists(fileName))
            {
                Stack&lt;byte[]&gt; output = new Stack&lt;byte[]&gt;;

                foreach (HashAlgorithm alg in algorithms)
                    alg.Initialize();

                using (FileStream source = File.OpenRead(fileName))
                {
                    // Channel all hash CryptoStreams: the output of a hash
                    // ICryptoTransform is the same as its input, while the
                    // result is saved in the HashAlgorithm instance.
                    Stack&lt;Stream&gt; pipes = new Stack&lt;Stream&gt;(algorithms.Length +
1);
                    pipes.Push(source);
                    foreach (HashAlgorithm alg in algorithms)
                        pipes.Push(new CryptoStream(pipes.Peek(), alg,
CryptoStreamMode.Read));
                    Stream lastPipe = pipes.Peek();
                    // Set up a temporary buffer to read and hash just a chunk
                    // at a time instead of reading a possibly very large file
                    // to memory and then hashing.                   
                    byte[] readBuffer = new byte[READBUFFER_SIZE];
                    // The real hashing is done here - on reading, data passes
                    // through all set CryptoStreams. For all that matters, the
                    // loop could well be empty
                    while (0 &lt; lastPipe.Read(readBuffer, 0, READBUFFER_SIZE)) {
}
                    lastPipe.Close();   // Closes all underlying Streams
                }

                // Get the hash values and return it
                foreach (HashAlgorithm alg in algorithms)
                    output.Push(alg.Hash);
                return output;
            }
            else return null;
        }

As you can see, I'm using hash chaining, so resorting to CS.Write would mean
jumping through so many hoops that it'd probably not be useful. Besides, this
code works correctly and efficiently in .NET 2, while in Mono it takes the time
I stated in the first post (about 2 secs) to hash a 3 MB file (that's 1/30 of
your test file).


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="065890.html">[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading
</A></li>
	<LI>Next message: <A HREF="065897.html">[Mono-bugs] [Bug 345510] CryptoStream ignores the ICryptoTransform. CanTransformMultipleBlocks property when reading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65896">[ date ]</a>
              <a href="thread.html#65896">[ thread ]</a>
              <a href="subject.html#65896">[ subject ]</a>
              <a href="author.html#65896">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
