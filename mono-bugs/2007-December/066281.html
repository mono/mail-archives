<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 347476] New: Improper measuring of elapsed time in various classes after changing system clock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20347476%5D%20New%3A%20Improper%20measuring%20of%20elapsed%20time%20in%0A%20various%20classes%20after%20changing%20system%20clock&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="066279.html">
   <LINK REL="Next"  HREF="066284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 347476] New: Improper measuring of elapsed time in various classes after changing system clock</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20347476%5D%20New%3A%20Improper%20measuring%20of%20elapsed%20time%20in%0A%20various%20classes%20after%20changing%20system%20clock&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 347476] New: Improper measuring of elapsed time in various classes after changing system clock">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Dec 11 04:28:59 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="066279.html">[Mono-bugs] [Bug 342892] [Regression] Notepad can start in a state where text cannot be input
</A></li>
        <LI>Next message: <A HREF="066284.html">[Mono-bugs] [Bug 347476] Improper measuring of elapsed time in various classes after changing system clock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#66281">[ date ]</a>
              <a href="thread.html#66281">[ thread ]</a>
              <a href="subject.html#66281">[ subject ]</a>
              <a href="author.html#66281">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=347476">https://bugzilla.novell.com/show_bug.cgi?id=347476</A>


           Summary: Improper measuring of elapsed time in various classes
                    after changing system clock
           Product: Mono: Class Libraries
           Version: 1.2.5
          Platform: x86
        OS/Version: Ubuntu
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: CORLIB
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">przemyslaw.gwozdz at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
          Found By: Development


This bug is related to thread synchronization events (e.g. ManualResetEvent),
System.Timers.Timer, System.Threading.Timer and possibly to some other classes.
Measuring elapsed time in those classes is damaged when user changes current
system time. This bug doesn't appear under Windows.

Example 1:
- System.Threading.Timer is started with 5 seconds interval
- if user changes system clock one minute to the future then Timer will fire
immediately
- if user changes system clock one minute to the past then Timer will fire
after 65 seconds

Expected results:
Timer should always fire with requested interval, regardless of any system
clock changes.

Code for Example 1:

using System;
using System.Threading;
class Program
{
        static void Main(string[] args)
        {
                Console.WriteLine(&quot;Starting timer with 5 seconds interval...&quot;);
                new Timer(new TimerCallback(Callback), null, 0, 5000);
                Console.ReadLine();
        }

        static void Callback(Object state)
        {
                Console.WriteLine(&quot;Callback executed! Current system time =
{0}&quot;, DateTime.Now);
        }
}


Example 2:
- thread enters ManualResetEvent.WaitOne method with timeout 60 seconds
- if user changes system clock one minute to the future then thread will
immediately leave WaitOne
- if user changes system clock one minute to the past then thread will wait in
WaitOne for 60 more seconds than requested

Expected results:
Time spent in WaitOne method should depend only on provided timeout, not on any
changes of system clock.

Code for Example 2:

using System;
using System.Threading;
class Program
{
        static void Main(string[] args)
        {
                Console.WriteLine(&quot;Entering WaitOne, timeout 60 seconds, try
changing system time...&quot;);
                ManualResetEvent mre = new ManualResetEvent(false);
                mre.WaitOne(60000, false);
                Console.WriteLine(&quot;Finished waiting&quot;);
        }
}


Remarks:
This bug can appear whenever system clock is changed. For example:
- user changes time manually
- daylight-saving time change occures
- clock synchronization software updates current time

Solution hints:
Some functions responsible for measuring elapsed time are using C-library
function &quot;gettimeofday&quot; which depends on current system time. They should
probably use &quot;clock_gettime&quot; with &quot;CLOCK_MONOTONIC&quot; parameter.
Changes are probably needed in files:
- mono/io-layer/misc.c
- mono/io-layer/mono-mutex.c
- mono/io-layer/timefuncs.c


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>























































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="066279.html">[Mono-bugs] [Bug 342892] [Regression] Notepad can start in a state where text cannot be input
</A></li>
	<LI>Next message: <A HREF="066284.html">[Mono-bugs] [Bug 347476] Improper measuring of elapsed time in various classes after changing system clock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#66281">[ date ]</a>
              <a href="thread.html#66281">[ thread ]</a>
              <a href="subject.html#66281">[ subject ]</a>
              <a href="author.html#66281">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
