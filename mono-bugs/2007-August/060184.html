<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 82428][Maj] Changed - Cannot deserialize data from	encrypted stream
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2082428%5D%5BMaj%5D%20Changed%20-%20Cannot%20deserialize%20data%20from%0A%09encrypted%20stream&In-Reply-To=bug-82428%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="060183.html">
   <LINK REL="Next"  HREF="060185.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 82428][Maj] Changed - Cannot deserialize data from	encrypted stream</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2082428%5D%5BMaj%5D%20Changed%20-%20Cannot%20deserialize%20data%20from%0A%09encrypted%20stream&In-Reply-To=bug-82428%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 82428][Maj] Changed - Cannot deserialize data from	encrypted stream">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Fri Aug 17 10:34:10 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="060183.html">[Mono-bugs] [Bug 82467][Nor] Changed - CS1955 is not reported	correctly
</A></li>
        <LI>Next message: <A HREF="060185.html">[Mono-bugs] [Bug 82187][Nor] Changed - SaveFileDialog empty and no	longer in center of screen when displayed multiple times
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60184">[ date ]</a>
              <a href="thread.html#60184">[ thread ]</a>
              <a href="subject.html#60184">[ subject ]</a>
              <a href="author.html#60184">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">sebastien at ximian.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=82428">http://bugzilla.ximian.com/show_bug.cgi?id=82428</A>

--- shadow/82428	2007-08-17 09:07:42.000000000 -0400
+++ shadow/82428.tmp.22226	2007-08-17 10:34:10.000000000 -0400
@@ -128,6 +128,73 @@
 this is sensitive
 
 The string length is the same in both case (22) so the end of the
 string must be unprintable garbage.
 
 This used to work, at least it works using my SLED-installed 1.1.13.8
+
+------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">sebastien at ximian.com</A>  2007-08-17 10:34 -------
+It seems the way the serializer calls CryptoStream.Write hits the bug
+on encryption.
+
+Moving the serialization into a MemoryStream and then encrypting the
+stream is ok (see modified sample) and can be decrypted using the
+original code.
+
+//MonoBug - logged by Rusty Howell &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rhowell at novell.com</A>&gt;
+
+//#define USECRYPT
+
+using System;
+using System.IO;
+using System.Security.Cryptography;
+using System.Runtime.Serialization;
+using System.Runtime.Serialization.Formatters.Binary;
+
+namespace Monobug
+{
+	class Program
+	{
+		static void Main(string[] args)
+		{
+			string filename = &quot;test.data&quot;;
+			string data = &quot;*this is sensitive data*&quot;;
+
+			DESCryptoServiceProvider des = new DESCryptoServiceProvider();
+			des.GenerateIV();
+			des.GenerateKey();
+
+			// -----------  WRITING ENCRYPTED SERIALIZED DATA ------------------
+			MemoryStream ms = new MemoryStream ();
+			BinaryFormatter bformatter = new BinaryFormatter();
+			bformatter.Serialize(ms, data);
+			byte[] serdata = ms.ToArray ();
+
+			Stream stream = new FileStream(filename, FileMode.Create,
+FileAccess.Write);
+#if USECRYPT
+			stream = new CryptoStream(stream, des.CreateEncryptor(),
+CryptoStreamMode.Write);
+#endif
+			stream.Write (serdata, 0, serdata.Length);
+			stream.Close();
+
+			stream = null;
+			bformatter = null;
+			data = string.Empty;
+
+			// -----------  READING ENCRYPTED SERIALIZED DATA ------------------
+			stream = new FileStream(filename, FileMode.Open, FileAccess.Read);
+#if USECRYPT
+			stream = new CryptoStream(stream, des.CreateDecryptor(),
+CryptoStreamMode.Read);
+#endif
+			bformatter = new BinaryFormatter();
+			data = (string)bformatter.Deserialize(stream);
+			stream.Close();
+
+			//----------- PRINT RESULTS ----------------
+			Console.WriteLine(&quot;'{0}' (length {1})&quot;, data, data.Length);
+		}
+	}
+}
+
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="060183.html">[Mono-bugs] [Bug 82467][Nor] Changed - CS1955 is not reported	correctly
</A></li>
	<LI>Next message: <A HREF="060185.html">[Mono-bugs] [Bug 82187][Nor] Changed - SaveFileDialog empty and no	longer in center of screen when displayed multiple times
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60184">[ date ]</a>
              <a href="thread.html#60184">[ thread ]</a>
              <a href="subject.html#60184">[ subject ]</a>
              <a href="author.html#60184">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
