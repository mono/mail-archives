<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 525338] New: klass-&gt;parent-&gt;vtable_size is incorrect for generic classes.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20525338%5D%20New%3A%20klass-%3Eparent-%3Evtable_size%20is%0A%20incorrect%20for%20generic%20classes.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="091021.html">
   <LINK REL="Next"  HREF="091127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 525338] New: klass-&gt;parent-&gt;vtable_size is incorrect for generic classes.</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20525338%5D%20New%3A%20klass-%3Eparent-%3Evtable_size%20is%0A%20incorrect%20for%20generic%20classes.&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 525338] New: klass-&gt;parent-&gt;vtable_size is incorrect for generic classes.">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Jul 26 19:22:22 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="091021.html">[Mono-bugs] [Bug 525328] SignatureHelper.GetLocalVarSigHelper ()	crashes.
</A></li>
        <LI>Next message: <A HREF="091127.html">[Mono-bugs] [Bug 525338] klass-&gt;parent-&gt;vtable_size is incorrect for generic classes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#91022">[ date ]</a>
              <a href="thread.html#91022">[ thread ]</a>
              <a href="subject.html#91022">[ subject ]</a>
              <a href="author.html#91022">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=525338">http://bugzilla.novell.com/show_bug.cgi?id=525338</A>


           Summary: klass-&gt;parent-&gt;vtable_size is incorrect for generic
                    classes.
    Classification: Mono
           Product: Mono: Runtime
           Version: SVN
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">miguel at novell.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


The following test crashes the Mono runtime (isolated from a larger test for
Silverlight):

using System;
using System.Reflection;

[DefaultMemberAttribute(&quot;flag&quot;)]
public class MyBase {
    public bool flag;
}

public class Generic2&lt;T&gt; where T : MyBase {
}


public class Crash {
    static void Main ()
    {
            Type gType = typeof(Generic2&lt;MyBase&gt;).GetGenericTypeDefinition();
            Type typeArg = gType.GetGenericArguments()[0];
            FieldInfo fi = typeArg.GetDefaultMembers()[0] as FieldInfo;
    }
}


The error generated is:

**
** ERROR:(icall.c:3789):ves_icall_Type_GetMethodsByName: assertion failed:
(method-&gt;slot &lt; nslots)
Stacktrace:

  at (wrapper managed-to-native) System.MonoType.GetMethodsByName
(string,System.Reflection.BindingFlags,bool,System.Type) &lt;0x0005d&gt;
  at (wrapper managed-to-native) System.MonoType.GetMethodsByName
(string,System.Reflection.BindingFlags,bool,System.Type) &lt;0xffffffff&gt;
  at System.MonoType.GetMethods (System.Reflection.BindingFlags) &lt;0x00023&gt;
  at System.Type.FindMembers
(System.Reflection.MemberTypes,System.Reflection.BindingFlags,System.Reflection.MemberFilter,object)
&lt;0x00301&gt;
  at System.Type.GetMember
(string,System.Reflection.MemberTypes,System.Reflection.BindingFlags) &lt;0x00074&gt;
  at System.Type.GetMember (string,System.Reflection.BindingFlags) &lt;0x0002b&gt;
  at System.Type.GetMember (string) &lt;0x00020&gt;
  at System.Type.GetDefaultMembers () &lt;0x0008f&gt;
  at Crash.Main () &lt;0x00058&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void
(object,intptr,intptr,intptr) &lt;0xffffffff&gt;

The problem is that the number of slots computed in the routine is done like
this:
    if (is_generic_parameter (type-&gt;type)){
        nslots = klass-&gt;parent-&gt;vtable_size;
    } else
        nslots = MONO_CLASS_IS_INTERFACE (klass) ? mono_class_num_methods
(klass) : klass-&gt;vtable_size;

In this case the path taken is nslots = klass-&gt;parent-&gt;vtable_size which
reports 0.   But since the code iterates to the parent classes (due to the flag
DeclaredOnly not being set) eventually it fetches the System.Object.Equals
method and this is where the code hits the assertion.

Either the klass-&gt;parent_vtable_size is incorrectly computed in this case or
the code should perform the same looping through parent classes to determine
the number of methods slots required as it is done just a few lines later.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="091021.html">[Mono-bugs] [Bug 525328] SignatureHelper.GetLocalVarSigHelper ()	crashes.
</A></li>
	<LI>Next message: <A HREF="091127.html">[Mono-bugs] [Bug 525338] klass-&gt;parent-&gt;vtable_size is incorrect for generic classes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#91022">[ date ]</a>
              <a href="thread.html#91022">[ thread ]</a>
              <a href="subject.html#91022">[ subject ]</a>
              <a href="author.html#91022">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
