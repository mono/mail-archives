<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 470120] Socket.EndSend unexpectedly fails with	WSAEWOULDBLOCK
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20470120%5D%20Socket.EndSend%20unexpectedly%20fails%20with%0A%09WSAEWOULDBLOCK&In-Reply-To=bug-470120-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="090899.html">
   <LINK REL="Next"  HREF="090901.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 470120] Socket.EndSend unexpectedly fails with	WSAEWOULDBLOCK</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20470120%5D%20Socket.EndSend%20unexpectedly%20fails%20with%0A%09WSAEWOULDBLOCK&In-Reply-To=bug-470120-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 470120] Socket.EndSend unexpectedly fails with	WSAEWOULDBLOCK">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Jul 22 16:01:22 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="090899.html">[Mono-bugs] [Bug 506729] FontDialog is not modal
</A></li>
        <LI>Next message: <A HREF="090901.html">[Mono-bugs] [Bug 470120] Socket.EndSend unexpectedly fails with	WSAEWOULDBLOCK
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#90900">[ date ]</a>
              <a href="thread.html#90900">[ thread ]</a>
              <a href="subject.html#90900">[ subject ]</a>
              <a href="author.html#90900">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=470120">http://bugzilla.novell.com/show_bug.cgi?id=470120</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">benoit at zeroc.com</A> added comment
<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=470120#c12">http://bugzilla.novell.com/show_bug.cgi?id=470120#c12</A>





--- Comment #12 from Benoit Foucher &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">benoit at zeroc.com</A>&gt;  2009-07-22 14:01:20 MDT ---
Created an attachment (id=306994)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=306994">http://bugzilla.novell.com/attachment.cgi?id=306994</A>)
use kqueue on OS X

I found this after a bit of research:
<A HREF="https://issues.apache.org/bugzilla/show_bug.cgi?id=34332,">https://issues.apache.org/bugzilla/show_bug.cgi?id=34332,</A> poll() on OS X seems
to be broken and even unsupported by Apple: 

    <A HREF="http://devworld.apple.com/technotes/tn2002/tn2071.html">http://devworld.apple.com/technotes/tn2002/tn2071.html</A>

I don't think it's a good idea to keep using it for OS X so I'm re-opening this
bug ;-). I also don't think it would be a good idea to advise to use blocking
sockets instead since this isn't very intuitive and this could lead to hard to
diagnose problems.

Anyway, this time I've attached a patch that includes yours and changes to the
threadpool to use kqueue on OS X instead of poll.

Since kqueue is very similar to epoll, I've mostly replaced the epoll system
calls with kevent calls. You'll notice that the pipe is still needed for
kqeuue... The reason is that it's not possible to interrupt the blocking kevent
by just closing the kqueue FD. Instead, the code closes the write end of the
pipe which wakes up the blocking kevent and the thread then closes the read
side of the pipe.

The tests of our software which make extensive use of .NET sockets pass with
this patch (w/ mono from SVN).

Note that your patch was still necessary. Without it, our tests fails with
spurious EWOULDBLOCK errors in EndReceive. I didn't investigate further but I
believe it can be expected to get sporadic EWOULDBLOCK from read/write even if
kevent/select/etc did report that the socket was ready so it's best if the
thread pool still handles this case. In theory, if the poll primitive isn't
bogus (like poll() is on OS X), this should cause a busy loop.

I only tried this patch on OS X.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>











































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="090899.html">[Mono-bugs] [Bug 506729] FontDialog is not modal
</A></li>
	<LI>Next message: <A HREF="090901.html">[Mono-bugs] [Bug 470120] Socket.EndSend unexpectedly fails with	WSAEWOULDBLOCK
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#90900">[ date ]</a>
              <a href="thread.html#90900">[ thread ]</a>
              <a href="subject.html#90900">[ subject ]</a>
              <a href="author.html#90900">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
