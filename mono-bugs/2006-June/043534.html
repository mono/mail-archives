<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 78570][Wis] Changed - Wrong/missing strack trace
	information for nested type method
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2078570%5D%5BWis%5D%20Changed%20-%20Wrong/missing%20strack%20trace%0A%09information%20for%20nested%20type%20method&In-Reply-To=bug-78570%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="043533.html">
   <LINK REL="Next"  HREF="043535.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 78570][Wis] Changed - Wrong/missing strack trace
	information for nested type method</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2078570%5D%5BWis%5D%20Changed%20-%20Wrong/missing%20strack%20trace%0A%09information%20for%20nested%20type%20method&In-Reply-To=bug-78570%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 78570][Wis] Changed - Wrong/missing strack trace
	information for nested type method">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Mon Jun  5 15:58:31 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="043533.html">[Mono-bugs] [Bug 78481][Nor] Changed - [Patch] Control OnLeave() is
	incorrectly invoked when it gets focus
</A></li>
        <LI>Next message: <A HREF="043535.html">[Mono-bugs] [Bug 78585][Wis] New - Modal dialog allows closing the
	main form
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43534">[ date ]</a>
              <a href="thread.html#43534">[ thread ]</a>
              <a href="subject.html#43534">[ subject ]</a>
              <a href="author.html#43534">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rodrigobamboo at gmail.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=78570">http://bugzilla.ximian.com/show_bug.cgi?id=78570</A>

--- shadow/78570	2006-06-03 13:26:26.000000000 -0400
+++ shadow/78570.tmp.14598	2006-06-05 15:58:31.000000000 -0400
@@ -1,12 +1,12 @@
 Bug#: 78570
 Product: Mono: Runtime
 Version: 1.1
 OS: unknown
 OS Details: Windows XP
-Status: NEEDINFO   
+Status: REOPENED   
 Resolution: 
 Severity: Unknown
 Priority: Wishlist
 Component: debug
 AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">martin at ximian.com</A>                            
 ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rodrigobamboo at gmail.com</A>               
@@ -100,6 +100,95 @@
 ------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">miguel at ximian.com</A>  2006-06-03 13:26 -------
 Please provide a small C#-based test case that illustrates the problem.  
 
 In addition, I realize this is an urgent bug for you, but the only
 person that can fix this will not be around to fix this bug on time
 for your release he is on vacation.
+
+------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rodrigobamboo at gmail.com</A>  2006-06-05 15:58 -------
+using System;
+using System.IO;
+using System.Reflection.Emit;
+using System.Reflection;
+using System.Diagnostics.SymbolStore;
+
+namespace BugReport
+{
+    public interface IFoo
+    {
+        void Bar();
+    }
+
+    class Program
+    {
+        const string DocumentPath = &quot;/temp/test.cs&quot;;
+
+        static void Main(string[] args)
+        {
+            IFoo foo = EmitFoo();
+            try
+            {
+                foo.Bar();
+            }
+            catch (Exception x)
+            {
+                Assert(x.StackTrace.IndexOf(DocumentPath) != -1);
+            }
+        }
+        
+        static void Assert(bool condition)
+        {
+            if (!condition) throw new ApplicationException();
+        }
+
+        static IFoo EmitFoo()
+        {
+            AppDomain currentDomain = AppDomain.CurrentDomain;
+            string fname = Path.Combine(currentDomain.BaseDirectory,
+&quot;bugged.dll&quot;);
+
+            AssemblyName name = new AssemblyName();
+            name.Name = Path.GetFileNameWithoutExtension(fname);
+
+            AssemblyBuilder builder =
+currentDomain.DefineDynamicAssembly(name, AssemblyBuilderAccess.Save,
+Path.GetDirectoryName(fname), null);
+            ModuleBuilder module =
+builder.DefineDynamicModule(Path.GetFileName(fname), true);
+            ISymbolDocumentWriter document =
+module.DefineDocument(DocumentPath, SymDocumentType.Text,
+SymLanguageType.CSharp, Guid.Empty);
+
+            TypeBuilder outer = module.DefineType(&quot;Outer&quot;,
+TypeAttributes.Public | TypeAttributes.Class, typeof(object));
+            TypeBuilder inner = outer.DefineNestedType(&quot;Inner&quot;,
+TypeAttributes.NestedPublic | TypeAttributes.Class, typeof(object));
+            string typeName = &quot;Outer+Inner&quot;;
+            //comment out the two lines above and uncomment the two lines
+            // below to see mono working
+            //TypeBuilder inner = module.DefineType(&quot;Inner&quot;,
+TypeAttributes.Public | TypeAttributes.Class, typeof(object));
+            //string typeName = &quot;Inner&quot;;
+            inner.AddInterfaceImplementation(typeof(IFoo));
+
+            MethodBuilder foo = inner.DefineMethod(&quot;Bar&quot;,
+MethodAttributes.Public | MethodAttributes.Virtual, typeof(void), new
+Type[0]);
+            ILGenerator il = foo.GetILGenerator();
+            il.MarkSequencePoint(document, 10, 0, 11, 0);
+            il.ThrowException(typeof(ApplicationException));
+            // MONO uses the next sequence point as the line number
+for the
+            // exception above
+            il.MarkSequencePoint(document, 10, 0, 11, 0);
+            il.Emit(OpCodes.Ret);
+
+            inner.CreateType();
+            outer.CreateType();
+
+            builder.Save(Path.GetFileName(fname));
+            return
+(IFoo)Activator.CreateInstance(Assembly.LoadFrom(fname).GetType(typeName));
+        }
+    }
+}
+
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="043533.html">[Mono-bugs] [Bug 78481][Nor] Changed - [Patch] Control OnLeave() is
	incorrectly invoked when it gets focus
</A></li>
	<LI>Next message: <A HREF="043535.html">[Mono-bugs] [Bug 78585][Wis] New - Modal dialog allows closing the
	main form
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43534">[ date ]</a>
              <a href="thread.html#43534">[ thread ]</a>
              <a href="subject.html#43534">[ subject ]</a>
              <a href="author.html#43534">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
