<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 581984] New: Incorrect control flow in	Reflection.Emit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20581984%5D%20New%3A%20Incorrect%20control%20flow%20in%0A%09Reflection.Emit&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="097701.html">
   <LINK REL="Next"  HREF="097714.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 581984] New: Incorrect control flow in	Reflection.Emit</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20581984%5D%20New%3A%20Incorrect%20control%20flow%20in%0A%09Reflection.Emit&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 581984] New: Incorrect control flow in	Reflection.Emit">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Feb 22 17:11:29 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="097701.html">[Mono-bugs] [Bug 550968] Inlining causes exceptions if assembly	isn't available
</A></li>
        <LI>Next message: <A HREF="097714.html">[Mono-bugs] [Bug 581984] Incorrect control flow in Reflection.Emit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97704">[ date ]</a>
              <a href="thread.html#97704">[ thread ]</a>
              <a href="subject.html#97704">[ subject ]</a>
              <a href="author.html#97704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=581984">http://bugzilla.novell.com/show_bug.cgi?id=581984</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=581984#c0">http://bugzilla.novell.com/show_bug.cgi?id=581984#c0</A>


           Summary: Incorrect control flow in Reflection.Emit
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.6.x
          Platform: PC
        OS/Version: Windows 7
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">aChrisSmith at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Third Party Developer/Partner
           Blocker: ---


Created an attachment (id=343929)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=343929">http://bugzilla.novell.com/attachment.cgi?id=343929</A>)
C# source file to repro the bug

Description of Problem:
Branches are not taken under Mono for certain Reflection.Emit methods in some
situations. This issue falls into the category of silent bad codegen and leads
to incorrect program execution at runtime.

Steps to reproduce the problem:
1. Compile and run the attached C# Source file

Actual Results:
When executing under Mono 2.6.1 prints '0', when executing under CLR pirnts
'1'.

Expected Results:
Mono matches the CLR.


How often does this happen? 

For the repro, every time. It seems to be related to having multiple &quot;returns&quot;
from a method. Mono doesn't like this sequence when generated via F#
Interactive:

    br L0  // or any other test-and-branch to L0:

    ldc.i4 107
    ret

L0:
    ldc.i4 37
    ret

When run, the code always drops through the branch instruction regardless of
input. (This would indicate a problem with JIT and not IL-bytecode generation.)
Mono does seem content if values are stored in temporary locals, e.g.:

br L0  // or any other test-and-branch to L0:

ldc.i4 107
            stloc 0
            br L1
    L0:
      ldc.i4 37
            stloc 0
    L1:
            ldloc 0
            ret

This looks to be related to 'fixing up' code streams; rearrating calls to
CreateType makes the problem go away.

Additional Information:

Please do let me know if there are any workarounds for this other than changing
the order of CreateType invocations. (We have some leway in code gen to work
around this bug, but unfortunately for the F# Interactive case we cannot change
the order of when we call CreateType.)

For a simpler repro, run the latest F# Interactive window and enter the
following text:

let reduce2&lt;'T&gt; (gen: int list) = 
  match gen with 
  | [_; _] -&gt; 1 
  | [_]    -&gt; 0
  | _      -&gt; 3

System.Console.WriteLine(&quot;result = {0}&quot;, reduce2  [1;2])

FSI on Mono returns from the middle branch '0', while on .NET returns branch
'1'.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="097701.html">[Mono-bugs] [Bug 550968] Inlining causes exceptions if assembly	isn't available
</A></li>
	<LI>Next message: <A HREF="097714.html">[Mono-bugs] [Bug 581984] Incorrect control flow in Reflection.Emit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97704">[ date ]</a>
              <a href="thread.html#97704">[ thread ]</a>
              <a href="subject.html#97704">[ subject ]</a>
              <a href="author.html#97704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
