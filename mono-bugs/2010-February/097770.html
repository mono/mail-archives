<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 582732] New: DataSet method WriteXml fails when DataColumn has extended properties and MaxLength property is set. ReadXml does not read extended properties also.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20582732%5D%20New%3A%20DataSet%20method%20WriteXml%20fails%20when%0A%20DataColumn%20has%20extended%20properties%20and%20MaxLength%20property%20is%20set.%20ReadXml%0A%20does%20not%20read%20extended%20properties%20also.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="097796.html">
   <LINK REL="Next"  HREF="097771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 582732] New: DataSet method WriteXml fails when DataColumn has extended properties and MaxLength property is set. ReadXml does not read extended properties also.</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20582732%5D%20New%3A%20DataSet%20method%20WriteXml%20fails%20when%0A%20DataColumn%20has%20extended%20properties%20and%20MaxLength%20property%20is%20set.%20ReadXml%0A%20does%20not%20read%20extended%20properties%20also.&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 582732] New: DataSet method WriteXml fails when DataColumn has extended properties and MaxLength property is set. ReadXml does not read extended properties also.">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Feb 24 10:13:05 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="097796.html">[Mono-bugs] [Bug 582711] runtime segfaults when running Moq
</A></li>
        <LI>Next message: <A HREF="097771.html">[Mono-bugs] [Bug 582732] DataSet method WriteXml fails when DataColumn has extended properties and MaxLength property is set. ReadXml does not read extended properties also.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97770">[ date ]</a>
              <a href="thread.html#97770">[ thread ]</a>
              <a href="subject.html#97770">[ subject ]</a>
              <a href="author.html#97770">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=582732">http://bugzilla.novell.com/show_bug.cgi?id=582732</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=582732#c0">http://bugzilla.novell.com/show_bug.cgi?id=582732#c0</A>


           Summary: DataSet method WriteXml fails when DataColumn has
                    extended properties and MaxLength property is set.
                    ReadXml does not read extended properties also.
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.6.x
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: Critical
          Priority: P5 - None
         Component: Sys.Data
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">kuritsu at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=344481)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=344481">http://bugzilla.novell.com/attachment.cgi?id=344481</A>)
Test Case which shows the bug.

User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; es-MX; rv:1.9.1.5)
Gecko/20091109 Ubuntu/9.10 (karmic) Firefox/3.5.5

I have a DataSet with a DataTable and several extended properties set in one or
two DataColumn. The MaxLength properties of these DataColumn are also set. When
I call the WriteXml method of the DataSet with a file name and
XmlWriteMode.WriteSchema, the following exception comes out:

This XmlWriter does not accept EndDocument at this state Error.
  at System.Xml.XmlTextWriter.WriteEndDocument () [0x00020] in
/home/jeff/Installers/mono-2.6.1/Mono/mono-2.6.1/mcs/class/System.XML/System.Xml/XmlTextWriter2.cs:520 
  at System.Data.DataSet.WriteXml (System.String fileName, XmlWriteMode mode)
[0x00023] in
/home/jeff/Installers/mono-2.6.1/Mono/mono-2.6.1/mcs/class/System.Data/System.Data/DataSet.cs:726 
  at Bugs.XmlSchemaWriterBug.MainClass.Main (System.String[] args) [0x0010c] in
/home/jeff/Projects/Bugs/Bugs.XmlSchemaWriterBug/Main.cs:25 

Also, when I call the ReadXml with a file name and XmlReadMode.ReadSchema, and
the XML contains information of extended properties, the ExtendedProperties
property of the DataSet, DataTable or DataColumn is not filled with such info.



Reproducible: Always

Steps to Reproduce:
1. Create a C# console application project in MonoDevelop.
2. Add System.Data as reference.
3. In usings section, add System.Collections and System.Data.
4. In the Main method of the main class, put the following code:

DataSet dataSet = new DataSet();
dataSet.ExtendedProperties.Add(&quot;DS1&quot;, &quot;extended0&quot;);
DataTable table = new DataTable(&quot;TABLE1&quot;);
table.ExtendedProperties.Add(&quot;T1&quot;, &quot;extended1&quot;);
table.Columns.Add(&quot;C1&quot;, typeof(int));
table.Columns[0].MaxLength = 10;
table.Columns.Add(&quot;C2&quot;, typeof(string));
table.Columns[0].MaxLength = 20;
table.Columns[0].ExtendedProperties.Add(&quot;C1Ext2&quot;, &quot;extended2&quot;);
table.Columns[1].ExtendedProperties.Add(&quot;C2Ext3&quot;, &quot;extended3&quot;);
dataSet.Tables.Add(table);
table.LoadDataRow(new object[]{1, &quot;One&quot;}, false);
table.LoadDataRow(new object[]{2, &quot;Two&quot;}, false);
try
{
    dataSet.WriteXml(&quot;test.xml&quot;, XmlWriteMode.WriteSchema);
}
catch (Exception ex)
{
    Console.WriteLine(ex.Message);
    Console.WriteLine(ex.StackTrace);
}
dataSet = new DataSet();
// Does not read extended properties
dataSet.ReadXml(&quot;test2.xml&quot;, XmlReadMode.ReadSchema);
Console.WriteLine(&quot;DataSet extended properties:&quot;);
foreach (DictionaryEntry p in dataSet.ExtendedProperties)
{
    Console.WriteLine (String.Format(&quot;{0} = {1}&quot;, p.Key, p.Value));
}
Console.WriteLine(&quot;DataTable extended properties:&quot;);
foreach (DictionaryEntry p in dataSet.Tables[0].ExtendedProperties)
{
    Console.WriteLine (String.Format(&quot;{0} = {1}&quot;, p.Key, p.Value));
}
Console.WriteLine(&quot;DataColumn 0 extended properties:&quot;);
foreach (DictionaryEntry p in dataSet.Tables[0].Columns[0].ExtendedProperties)
{
    Console.WriteLine (String.Format(&quot;{0} = {1}&quot;, p.Key, p.Value));
}
Console.WriteLine(&quot;DataColumn 1 extended properties:&quot;);
foreach (DictionaryEntry p in dataSet.Tables[0].Columns[1].ExtendedProperties)
{
    Console.WriteLine (String.Format(&quot;{0} = {1}&quot;, p.Key, p.Value));
}
Console.ReadLine();

5. Create an XML file like the following (name it test2.xml) to try to read
extended properties:

&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot;?&gt;
&lt;NewDataSet&gt;
  &lt;xs:schema id=&quot;NewDataSet&quot; xmlns=&quot;&quot;
xmlns:xs=&quot;<A HREF="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</A>
xmlns:msdata=&quot;urn:schemas-microsoft-com:xml-msdata&quot;
xmlns:msprop=&quot;urn:schemas-microsoft-com:xml-msprop&quot;&gt;
    &lt;xs:element name=&quot;NewDataSet&quot; msdata:IsDataSet=&quot;true&quot;
msdata:UseCurrentLocale=&quot;true&quot; msprop:DS1=&quot;extended0&quot;&gt;
      &lt;xs:complexType&gt;
        &lt;xs:choice minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
          &lt;xs:element name=&quot;TABLE1&quot; msprop:T1=&quot;extended1&quot;&gt;
            &lt;xs:complexType&gt;
              &lt;xs:sequence&gt;
                &lt;xs:element name=&quot;C1&quot; type=&quot;xs:int&quot; minOccurs=&quot;0&quot;
msprop:C1Ext2=&quot;extended2&quot; /&gt;
                &lt;xs:element name=&quot;C2&quot; type=&quot;xs:string&quot; minOccurs=&quot;0&quot;
msprop:C2Ext3=&quot;extended3&quot; /&gt;
              &lt;/xs:sequence&gt;
            &lt;/xs:complexType&gt;
          &lt;/xs:element&gt;
        &lt;/xs:choice&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
  &lt;/xs:schema&gt;
  &lt;TABLE1&gt;
    &lt;C1&gt;1&lt;/C1&gt;
    &lt;C2&gt;One&lt;/C2&gt;
  &lt;/TABLE1&gt;
  &lt;TABLE1&gt;
    &lt;C1&gt;2&lt;/C1&gt;
    &lt;C2&gt;Two&lt;/C2&gt;
  &lt;/TABLE1&gt;
&lt;/NewDataSet&gt;

6. Run and check the results.
Actual Results:  
This is what is written on the console: 

This XmlWriter does not accept EndDocument at this state Error.
  at System.Xml.XmlTextWriter.WriteEndDocument () [0x00020] in
/home/jeff/Installers/mono-2.6.1/Mono/mono-2.6.1/mcs/class/System.XML/System.Xml/XmlTextWriter2.cs:520 
  at System.Data.DataSet.WriteXml (System.String fileName, XmlWriteMode mode)
[0x00023] in
/home/jeff/Installers/mono-2.6.1/Mono/mono-2.6.1/mcs/class/System.Data/System.Data/DataSet.cs:726 
  at Bugs.XmlSchemaWriterBug.MainClass.Main (System.String[] args) [0x00121] in
/home/jeff/Projects/Bugs/Bugs.XmlSchemaWriterBug/Main.cs:26 
DataSet extended properties:
DataTable extended properties:
DataColumn 0 extended properties:
DataColumn 1 extended properties:

As you can see, an Exception is written by the catch block when calling
WriteXml, and after you call ReadXml, no extended properties info is written on
the console. 

Expected Results:  
The console should show this:

DataSet extended properties:
DS1 = extended0
DataTable extended properties:
T1 = extended1
DataColumn 0 extended properties:
C1Ext2 = extended2
DataColumn 1 extended properties:
C2Ext3 = extended3

Notice how the extended properties info is output. Also, the test.xml file
should look like this:

&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot;?&gt;
&lt;NewDataSet&gt;
  &lt;xs:schema id=&quot;NewDataSet&quot; xmlns=&quot;&quot;
xmlns:xs=&quot;<A HREF="http://www.w3.org/2001/XMLSchema&quot;">http://www.w3.org/2001/XMLSchema&quot;</A>
xmlns:msdata=&quot;urn:schemas-microsoft-com:xml-msdata&quot;
xmlns:msprop=&quot;urn:schemas-microsoft-com:xml-msprop&quot;&gt;
    &lt;xs:element name=&quot;NewDataSet&quot; msdata:IsDataSet=&quot;true&quot;
msdata:UseCurrentLocale=&quot;true&quot; msprop:DS1=&quot;extended0&quot;&gt;
      &lt;xs:complexType&gt;
        &lt;xs:choice minOccurs=&quot;0&quot; maxOccurs=&quot;unbounded&quot;&gt;
          &lt;xs:element name=&quot;TABLE1&quot; msprop:T1=&quot;extended1&quot;&gt;
            &lt;xs:complexType&gt;
              &lt;xs:sequence&gt;
                &lt;xs:element name=&quot;C1&quot; minOccurs=&quot;0&quot; msprop:C1Ext2=&quot;extended2&quot;&gt;
                  &lt;xs:simpleType&gt;
                    &lt;xs:restriction base=&quot;xs:int&quot;&gt;
                      &lt;xs:maxLength value=&quot;20&quot; /&gt;
                    &lt;/xs:restriction&gt;
                  &lt;/xs:simpleType&gt;
                &lt;/xs:element&gt;
                &lt;xs:element name=&quot;C2&quot; type=&quot;xs:string&quot; minOccurs=&quot;0&quot;
msprop:C2Ext3=&quot;extended3&quot; /&gt;
              &lt;/xs:sequence&gt;
            &lt;/xs:complexType&gt;
          &lt;/xs:element&gt;
        &lt;/xs:choice&gt;
      &lt;/xs:complexType&gt;
    &lt;/xs:element&gt;
  &lt;/xs:schema&gt;
  &lt;TABLE1&gt;
    &lt;C1&gt;1&lt;/C1&gt;
    &lt;C2&gt;One&lt;/C2&gt;
  &lt;/TABLE1&gt;
  &lt;TABLE1&gt;
    &lt;C1&gt;2&lt;/C1&gt;
    &lt;C2&gt;Two&lt;/C2&gt;
  &lt;/TABLE1&gt;
&lt;/NewDataSet&gt;

Notice that extended properties and MaxLength info are saved.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="097796.html">[Mono-bugs] [Bug 582711] runtime segfaults when running Moq
</A></li>
	<LI>Next message: <A HREF="097771.html">[Mono-bugs] [Bug 582732] DataSet method WriteXml fails when DataColumn has extended properties and MaxLength property is set. ReadXml does not read extended properties also.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97770">[ date ]</a>
              <a href="thread.html#97770">[ thread ]</a>
              <a href="subject.html#97770">[ subject ]</a>
              <a href="author.html#97770">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
