<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 580714] New: SqlBulkCopy is Broken Badly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20580714%5D%20New%3A%20SqlBulkCopy%20is%20Broken%20Badly&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="097510.html">
   <LINK REL="Next"  HREF="097489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 580714] New: SqlBulkCopy is Broken Badly</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20580714%5D%20New%3A%20SqlBulkCopy%20is%20Broken%20Badly&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 580714] New: SqlBulkCopy is Broken Badly">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Feb 17 17:28:18 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="097510.html">[Mono-bugs] [Bug 580692] Treeview nodes not applying font colour correctly using stylesheet class
</A></li>
        <LI>Next message: <A HREF="097489.html">[Mono-bugs] [Bug 580714] SqlBulkCopy is Broken Badly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97488">[ date ]</a>
              <a href="thread.html#97488">[ thread ]</a>
              <a href="subject.html#97488">[ subject ]</a>
              <a href="author.html#97488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=580714">http://bugzilla.novell.com/show_bug.cgi?id=580714</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=580714#c0">http://bugzilla.novell.com/show_bug.cgi?id=580714#c0</A>


           Summary: SqlBulkCopy is Broken Badly
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.6.x
          Platform: 64bit
        OS/Version: openSUSE 11.1
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: Sys.Data.SqlClient
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">silenuznowan at yahoo.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Description of Problem:

Code using SqlBulkCopy that runs fine in .Net does not work in Mono.  I always
receive an exception.

However when running the code in windows through .Net there are no exceptions
and the data transfers fine.  


Steps to reproduce the problem:
Create a MSSQL server database called MonoBulkCopyTest
Add table to the database with two nvarchar columns.
Add the following code to a winform application and run it.

  //This line must be edited for the connection to the test database

 String connectionString = &quot;Data Source=****;Initial
Catalog=MonoBulkCopyTest;User ID=****;Pwd=****;&quot;;



        //data table to bulk copy

        DataTable dtdata;



        //connection to sql server to do the copy

        System.Data.SqlClient.SqlConnection con;



        //bulk writer to do the actual copy

        System.Data.SqlClient.SqlBulkCopy bulkWriter;

         private void RunTest()
        {

            //create the connection to the database.

            con = new System.Data.SqlClient.SqlConnection(connectionString);



            //create the bulkcopy object

            CreateBulkWriter();



            //create the datatable

            CreateTable();



            //add some data to the datatable

            AddData();



            //try to bulk copy the datatable

            CopyData();

        }



        /// &lt;summary&gt;

        /// Create the data table to test the bulk copy with

        /// &lt;/summary&gt;

        private void CreateTable()

        {

            //create the dtdata datatable to hold information for the bulk copy
to the 

            //Movie table in the database

            dtdata = new DataTable(&quot;table1&quot;);



            //Create title column in dtdata datatable

            dtdata.Columns.Add(&quot;title&quot;, System.Type.GetType(&quot;System.String&quot;));



            //Create year column in dtdata datatable

            dtdata.Columns.Add(&quot;year&quot;, System.Type.GetType(&quot;System.String&quot;));

        }



        /// &lt;summary&gt;

        /// Create the bulkcopy object and set the column mappings

        /// &lt;/summary&gt;

        private void CreateBulkWriter()

        {

            //create a bulk writer to efficently write the data

            bulkWriter = new System.Data.SqlClient.SqlBulkCopy(con);



            //set the destination table of the bulk writer to be the Movie
table

            bulkWriter.DestinationTableName = &quot;Movie&quot;;



            //Map title from source to destination

            bulkWriter.ColumnMappings.Add(&quot;title&quot;, &quot;title&quot;);



            //Map year from source to destination

            bulkWriter.ColumnMappings.Add(&quot;year&quot;, &quot;year&quot;);

        }



        /// &lt;summary&gt;

        /// add some data to the datatable for the bulk copy

        /// &lt;/summary&gt;

        private void AddData()

        {

            DataRow dr = dtdata.NewRow();

            dr[0] = &quot;Citizen Kane&quot;;

            dr[1] = &quot;1941&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;Casablanca&quot;;

            dr[1] = &quot;1942&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;The Godfather&quot;;

            dr[1] = &quot;1972&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;Gone With The Wind&quot;;

            dr[1] = &quot;1939&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;Lawrence Of Arabia&quot;;

            dr[1] = &quot;1962&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;The Wizard Of Oz&quot;;

            dr[1] = &quot;1939&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;The Graduate&quot;;

            dr[1] = &quot;1967&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;On The Waterfront&quot;;

            dr[1] = &quot;1954&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;Schindler's List&quot;;

            dr[1] = &quot;1993&quot;;

            dtdata.Rows.Add(dr);



            dr = dtdata.NewRow();

            dr[0] = &quot;Singin' In The Rain&quot;;

            dr[1] = &quot;1952&quot;;

            dtdata.Rows.Add(dr);



        }



        /// &lt;summary&gt;

        /// Attempts to bulk copy the datatable dtdata to the database

        /// &lt;/summary&gt;

        private void CopyData()

        {

            try

            {

                con.Open();

                bulkWriter.WriteToServer(dtdata);

                entry1.Text = &quot;Success&quot;;

            }

            catch (Exception ex)

            {

                //System.Windows.Forms.MessageBox.Show(ex.ToString(),&quot;Exception
Thrown&quot;, MessageBoxButtons.OK, MessageBoxIcon.Exclamation);

                entry1.Text = ex.ToString();

            }

            finally

            {

                if (con.State == ConnectionState.Open)

                    con.Close();

            }

        }


Actual Results:

System.Data.SqlClient.SqlException: Invalid column type from bcp client for
colid 1.
  at System.Data.SqlClient.SqlConnection.ErrorHandler (System.Object sender,
Mono.Data.Tds.Protocol.TdsInternalErrorMessageEventArgs e) [0x00032] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/System.Data/System.Data.SqlClient/SqlConnection.cs:316 
  at Mono.Data.Tds.Protocol.Tds.OnTdsErrorMessage
(Mono.Data.Tds.Protocol.TdsInternalErrorMessageEventArgs e) [0x0000b] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:1695 
  at Mono.Data.Tds.Protocol.Tds.ProcessMessage (TdsPacketSubType subType)
[0x000ef] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:1735 
  at Mono.Data.Tds.Protocol.Tds.ProcessSubPacket () [0x00130] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:1787 
  at Mono.Data.Tds.Protocol.Tds.NextResult () [0x0004a] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:619 
  at Mono.Data.Tds.Protocol.Tds.SkipToEnd () [0x00005] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:692 
  at Mono.Data.Tds.Protocol.Tds.ExecBulkCopy (Int32 timeout, Boolean
wantResults) [0x0001f] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/Tds.cs:550 
  at Mono.Data.Tds.Protocol.TdsBulkCopy.BulkCopyEnd () [0x00015] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/TdsBulkCopy.cs:98 
  at System.Data.SqlClient.SqlBulkCopy.BulkCopyToServer (System.Data.DataTable
table, DataRowState state) [0x0053d] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/System.Data/System.Data.SqlClient/SqlBulkCopy.cs:424 
  at System.Data.SqlClient.SqlBulkCopy.WriteToServer (System.Data.DataTable
table) [0x00000] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/System.Data/System.Data.SqlClient/SqlBulkCopy.cs:448 
  at MainWindow.CopyData () [0x0000b] in
/home/jordan/projects/MonoSqlbulkCopyBug/MainWindow.cs:137 

Or

System.IndexOutOfRangeException: Array index is out of range.
  at Mono.Data.Tds.Protocol.TdsComm.AppendInternal (Int16 s) [0x00073] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/TdsComm.cs:339 
  at Mono.Data.Tds.Protocol.TdsComm.Append (System.String s) [0x00075] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/TdsComm.cs:389 
  at Mono.Data.Tds.Protocol.TdsComm.Append (System.Object o) [0x000d8] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/TdsComm.cs:237 
  at Mono.Data.Tds.Protocol.TdsBulkCopy.BulkCopyData (System.Object o, Int32
size, Boolean isNewRow) [0x00034] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/Mono.Data.Tds/Mono.Data.Tds.Protocol/TdsBulkCopy.cs:91 
  at System.Data.SqlClient.SqlBulkCopy.BulkCopyToServer (System.Data.DataTable
table, DataRowState state) [0x004aa] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/System.Data/System.Data.SqlClient/SqlBulkCopy.cs:412 
  at System.Data.SqlClient.SqlBulkCopy.WriteToServer (System.Data.DataTable
table) [0x00000] in
/usr/src/packages/BUILD/mono-2.6.1/mcs/class/System.Data/System.Data.SqlClient/SqlBulkCopy.cs:448 
  at IMDBDataExchange.SQLServerWriterBase.ClearCache () [0x00002] in
/home/jordan/projects/IMDBDataExchange/IMDBDataExchange/SQLServerWriterBase.cs:27 

Expected Results:
Should bulk copy the data in the datatable to the database

How often does this happen?
Always


Additional Information:

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="097510.html">[Mono-bugs] [Bug 580692] Treeview nodes not applying font colour correctly using stylesheet class
</A></li>
	<LI>Next message: <A HREF="097489.html">[Mono-bugs] [Bug 580714] SqlBulkCopy is Broken Badly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97488">[ date ]</a>
              <a href="thread.html#97488">[ thread ]</a>
              <a href="subject.html#97488">[ subject ]</a>
              <a href="author.html#97488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
