<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 577821] New: Compiler generics implementation: regression in 2.6.1 causes compiler crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20577821%5D%20New%3A%20Compiler%20generics%20implementation%3A%0A%20regression%20in%202.6.1%20causes%20compiler%20crash&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="097254.html">
   <LINK REL="Next"  HREF="097256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 577821] New: Compiler generics implementation: regression in 2.6.1 causes compiler crash</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20577821%5D%20New%3A%20Compiler%20generics%20implementation%3A%0A%20regression%20in%202.6.1%20causes%20compiler%20crash&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 577821] New: Compiler generics implementation: regression in 2.6.1 causes compiler crash">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Feb  7 23:22:45 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="097254.html">[Mono-bugs] [Bug 565129] UTF8Encoding doesn't throw on incomplete	characters
</A></li>
        <LI>Next message: <A HREF="097256.html">[Mono-bugs] [Bug 577821] Compiler generics implementation: regression in 2.6.1 causes compiler crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97255">[ date ]</a>
              <a href="thread.html#97255">[ thread ]</a>
              <a href="subject.html#97255">[ subject ]</a>
              <a href="author.html#97255">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=577821">http://bugzilla.novell.com/show_bug.cgi?id=577821</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=577821#c0">http://bugzilla.novell.com/show_bug.cgi?id=577821#c0</A>


           Summary: Compiler generics implementation: regression in 2.6.1
                    causes compiler crash
    Classification: Mono
           Product: Mono: Compilers
           Version: 2.6.x
          Platform: Macintosh
        OS/Version: Linux
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brian at sooloos.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Community User
           Blocker: ---


Description of Problem:

gmcs.exe crashes when compiling. This has been reproduced on mac os x (snow
leopard) and linux (ubuntu 9.10). On ubuntu, mono was built from 2.6.1 source
tarball. On mac os x, mono was installed using the 2.6.1 installer published on
the website.


Steps to reproduce the problem:

1. Save t.cs and u.cs
2. Execute the following commands:

$ gmcs -target:library u.cs -out:u.dll
$ gmcs t.cs /r:u.dll

--------------------- contents of t.cs ----------------------------

using System;
using System.Collections.Generic;

namespace Foo {
    using P = Baz.P;
    static class Bar
    {
        public static Baz.Frob&lt;List&lt;T&gt;&gt; MakeArrayParser&lt;T&gt;(string root, Quux&lt;T&gt;
quux)
        {
            return P.Element&lt;List&lt;T&gt;&gt;(root, v =&gt; v.Value = new List&lt;T&gt;(), v =&gt;
P.Children(P.Child(quux(&quot;e&quot;), x =&gt; v.Value.Add(x))));
        }
        public delegate Baz.Frob&lt;T&gt; Quux&lt;T&gt;(string s);
        public static void Main(string[] args) {}
    }
}

--------------------- contents of u.cs ----------------------------

using System;
using System.Xml;

namespace Baz
{
    public abstract class Frob&lt;T&gt; { }
    public abstract class Child&lt;T&gt; { }

    public abstract class Base
    {
        public delegate void Action&lt;U&gt;(U val);
    }

    public class Element&lt;T&gt; : Frob&lt;T&gt;
    {
        public delegate void Start(Ref val);
        public delegate void Children(Ref item);
        public class Ref { public T Value; }
    }

    public static class P
    {
        public static Element&lt;T&gt; Element&lt;T&gt;(string name, Element&lt;T&gt;.Start
start, Element&lt;T&gt;.Children children) { return null; }
        public static object Children(params Base[] children) { return null; }
        public static Base Child&lt;U&gt;(Frob&lt;U&gt; frob, Base.Action&lt;U&gt; action) {
return null; }
    }
}

----------------------------------------------------------------

Actual Results:

$ gmcs -target:library u.cs -out:u.dll
$ gmcs t.cs /r:u.dll

Unhandled Exception: System.ArgumentException: The field handle and the type
handle are incompatible.
  at System.Reflection.FieldInfo.GetFieldFromHandle (RuntimeFieldHandle handle,
RuntimeTypeHandle declaringType) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.AnonymousMethodStorey.MutateField (System.Reflection.FieldInfo
field) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.FieldExpr.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.MemberExpr.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.MethodGroupExpr.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Invocation.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Return.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Block.MutateHoistedGenericType
(Mono.CSharp.AnonymousMethodStorey storey) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.AnonymousExpression+AnonymousMethodMethod.Emit () [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.TypeContainer.EmitType () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.AnonymousMethodStorey.EmitType () [0x00000] in &lt;filename
unknown&gt;:0 
  at Mono.CSharp.TypeContainer.EmitType () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.AnonymousMethodStorey.EmitType () [0x00000] in &lt;filename
unknown&gt;:0 
  at Mono.CSharp.TypeContainer.EmitType () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.RootContext.EmitCode () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Driver.Compile () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Driver.Main (System.String[] args) [0x00000] in &lt;filename
unknown&gt;:0 


Expected Results:

I would expect the compilation to succeed.


How often does this happen? 

Every time.


Additional Information:

This failure happened when compiling a project with over 500k lines of c# code
in hundreds of source files and dozens of assemblies. This case to reproduce
was found via a time consuming manual binary search process. If possible, it
would be great if the compiler could give more information when these kinds of
failures occur. Even minimal information about what module or method is being
processed at the time of the unexpected exception would have saved lots of time
in preparing this bug report.

The code compiles and runs properly using mono 2.4.2.3 and has been running in
production for us for quite a while with 2.4.2.3. This crash is new in the
2.6.x series. The code also compiles and runs properly using ms .net and has
been doing so for a while with ms.net 3.5 and 2.0.

Note that the failure does not occur unless the source files are compiled into
separate assemblies as described above. If I attempt to compile the two files
into the same assembly, the crash doesn't occur.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="097254.html">[Mono-bugs] [Bug 565129] UTF8Encoding doesn't throw on incomplete	characters
</A></li>
	<LI>Next message: <A HREF="097256.html">[Mono-bugs] [Bug 577821] Compiler generics implementation: regression in 2.6.1 causes compiler crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97255">[ date ]</a>
              <a href="thread.html#97255">[ thread ]</a>
              <a href="subject.html#97255">[ subject ]</a>
              <a href="author.html#97255">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
