<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 33745][Wis] New - Socket.Poll appears to be incorrect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40rocky.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="002581.html">
   <LINK REL="Next"  HREF="002583.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 33745][Wis] New - Socket.Poll appears to be incorrect
   </H1>
    <B>bugzilla-daemon@rocky.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40rocky.ximian.com"
       TITLE="[Mono-bugs] [Bug 33745][Wis] New - Socket.Poll appears to be incorrect">bugzilla-daemon@rocky.ximian.com
       </A><BR>
    <I>12 Nov 2002 16:20:41 -0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="002581.html">[Mono-bugs] [Bug 32054][Nor] Changed - Sockets are sometimes garbage collected while still in use
</A></li>
        <LI> Next message: <A HREF="002583.html">[Mono-bugs] [Bug 33745][Wis] Changed - Socket.Poll appears to be incorrect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2582">[ date ]</a>
              <a href="thread.html#2582">[ thread ]</a>
              <a href="subject.html#2582">[ subject ]</a>
              <a href="author.html#2582">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:tim@timcoleman.com.">tim@timcoleman.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=33745">http://bugzilla.ximian.com/show_bug.cgi?id=33745</A>

--- shadow/33745	Tue Nov 12 11:20:41 2002
+++ shadow/33745.tmp.23194	Tue Nov 12 11:20:41 2002
@@ -0,0 +1,120 @@
+Bug#: 33745
+Product: Mono/Class Libraries
+Version: unspecified
+OS: GNU/Linux [Other]
+OS Details: Debian unstable
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Wishlist
+Component: System
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:tim@timcoleman.com">tim@timcoleman.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: Socket.Poll appears to be incorrect
+
+Please fill in this template when reporting a bug, unless you know what 
+you are doing.
+Description of Problem:
+As part of my development for System.Data.SqlClient, I have implemented a 
+connection timeout.  This is done by calling Socket.BeginConnect (), and 
+then polling the socket in a callback.  Once the Socket.Poll with select 
+mode SelectMode.SelectWrite returns true, then it calls Socket.EndConnect 
+() and sets a ManualResetEvent, triggering the initial thread to continue.
+
+If the ManualResetEvent does not get set, then WaitOne returns false and 
+an exception is thrown.
+
+Steps to reproduce the problem:
+Here is a code sample:
+
+using System;
+using System.Net;
+using System.Net.Sockets;
+using System.Threading;
+
+class Test {
+	public static void Main ()
+	{
+		SocketTester tester = new SocketTester (&quot;localhost&quot;, 
+31337);
+	}
+}
+
+class SocketTester {
+
+	Socket socket;
+	int timeout;
+	ManualResetEvent connected = new ManualResetEvent (false);
+
+	public SocketTester (string host, int port)
+		: this (host, port, 15)
+	{
+	}
+
+	public SocketTester (string host, int port, int timeout)
+	{
+		this.timeout = timeout;
+
+		socket = new Socket (AddressFamily.InterNetwork, 
+SocketType.Stream, ProtocolType.Tcp);
+		IPHostEntry hostEntry = Dns.Resolve (host);
+		IPEndPoint endPoint = new IPEndPoint 
+(hostEntry.AddressList [0], port);
+		connected.Reset ();
+		IAsyncResult asyncResult = socket.BeginConnect (endPoint, 
+new AsyncCallback (ConnectCallback), socket);
+		if (!connected.WaitOne (new TimeSpan (0, 0, timeout), 
+true))
+			throw new Exception (&quot;Timeout exceeded.  Could not 
+open socket.&quot;);
+		socket.Close ();
+		Console.WriteLine (&quot;Connection succeeded.&quot;);
+	}
+
+	private void ConnectCallback (IAsyncResult ar)
+	{
+		Socket s = (Socket) ar.AsyncState;
+		if (Poll (s, timeout, SelectMode.SelectWrite)) {
+			socket.EndConnect (ar);
+			connected.Set ();
+		}
+	}
+
+	private bool Poll (Socket s, int seconds, SelectMode selectMode)
+	{
+		long uSeconds = seconds * 1000000;
+		bool bState = false;
+		while (uSeconds &gt; (long) Int32.MaxValue) {
+			bState = s.Poll (Int32.MaxValue, selectMode);
+			if (bState)
+				return true;
+			uSeconds -= Int32.MaxValue;
+		}
+		return s.Poll ((int) uSeconds, selectMode);
+	}
+}
+			
+Actual Results:
+*Immediately* throws two exceptions:
+The main thread throws the System.Exception () indicating a timeout.
+The other thread throws a SocketException (): &quot;Connection refused.&quot;
+
+Expected Results:
+The timeout specified, 15 seconds, should expire, and then the WaitOne 
+will return false.  This should cause the System.Exception () indicating a 
+timeout.  The SocketException should not be thrown.  The SocketException 
+appears to be called from within EndConnect, which is only called if 
+Socket.Poll returns true, which should not happen.
+
+On Windows, Socket.Poll will not return true, and the event will timeout.
+
+How often does this happen? 
+Every time.
+
+Additional Information:
+This only occurs on Linux, not on Windows.  Seems to be a problem with 
+Socket.Poll.


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="002581.html">[Mono-bugs] [Bug 32054][Nor] Changed - Sockets are sometimes garbage collected while still in use
</A></li>
	<LI> Next message: <A HREF="002583.html">[Mono-bugs] [Bug 33745][Wis] Changed - Socket.Poll appears to be incorrect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2582">[ date ]</a>
              <a href="thread.html#2582">[ thread ]</a>
              <a href="subject.html#2582">[ subject ]</a>
              <a href="author.html#2582">[ author ]</a>
         </LI>
       </UL>
</body></html>
