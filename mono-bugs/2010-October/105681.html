<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 650398] New: Nested relation FKs not populated correctly on xml deserialization, with ColumnMapping=MappingType.Hidden
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20650398%5D%20New%3A%20Nested%20relation%20FKs%20not%20populated%0A%20correctly%20on%20xml%20deserialization%2C%20with%20ColumnMapping%3DMappingType.Hidden&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="105680.html">
   <LINK REL="Next"  HREF="105693.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 650398] New: Nested relation FKs not populated correctly on xml deserialization, with ColumnMapping=MappingType.Hidden</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20650398%5D%20New%3A%20Nested%20relation%20FKs%20not%20populated%0A%20correctly%20on%20xml%20deserialization%2C%20with%20ColumnMapping%3DMappingType.Hidden&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 650398] New: Nested relation FKs not populated correctly on xml deserialization, with ColumnMapping=MappingType.Hidden">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Oct 31 15:19:37 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="105680.html">[Mono-bugs] [Bug 650397] New: DataRow.GetParentRows doesn't work with &gt; 1 parent records
</A></li>
        <LI>Next message: <A HREF="105693.html">[Mono-bugs] [Bug 650398] Nested relation FKs not populated correctly on xml deserialization, with ColumnMapping=MappingType.Hidden
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#105681">[ date ]</a>
              <a href="thread.html#105681">[ thread ]</a>
              <a href="subject.html#105681">[ subject ]</a>
              <a href="author.html#105681">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=650398">https://bugzilla.novell.com/show_bug.cgi?id=650398</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=650398#c0">https://bugzilla.novell.com/show_bug.cgi?id=650398#c0</A>


           Summary: Nested relation FKs not populated correctly on xml
                    deserialization, with ColumnMapping=MappingType.Hidden
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.6.x
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.Data
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">cvolzke at live.com.au</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US)
AppleWebKit/532.5 (KHTML, like Gecko) Chrome/4.1.249.1036 Safari/532.5

Nested relation FKs not populated correctly on xml deserialization.
The foreign keys must be ColumnMapping=MappingType.Hidden for the bug to
reproduce, because the child FK value is set to the parent PK value.


Reproducible: Always

Steps to Reproduce:
Test case to reproduce:

        [Test]
        public void Test_SerializeDeserializeNestedDataSet()
        {
            DataSet data = NewDataSet();
            data.Tables[0].Rows.Add(&quot;key1&quot;, &quot;&quot;);
            data.Tables[1].Rows.Add(&quot;key2&quot;, &quot;key1&quot;);
            data.Tables[2].Rows.Add(&quot;&quot;, &quot;key2&quot;);

            string xml = WriteXml(data);
            DataSet deserializedData = NewDataSet();
            deserializedData.ReadXml(new StringReader(xml));
            string deserializedXml = WriteXml(deserializedData);
            Assert.AreEqual(xml, deserializedXml);
        }

        static string WriteXml(DataSet data)
        {
            StringWriter writer = new StringWriter();
            data.WriteXml(writer);
            return writer.GetStringBuilder().ToString();
        }

        static DataSet NewDataSet()
        {
            DataTable table1 = new DataTable();
            DataColumn pk1 = table1.Columns.Add(&quot;PK&quot;);
            DataColumn fk1 = table1.Columns.Add(&quot;FK&quot;);
            fk1.ColumnMapping = MappingType.Hidden;

            DataTable table2 = new DataTable();
            DataColumn pk2 = table2.Columns.Add(&quot;PK&quot;);
            DataColumn fk2 = table2.Columns.Add(&quot;FK&quot;);
            fk2.ColumnMapping = MappingType.Hidden;

            DataTable table3 = new DataTable();
            DataColumn pk3 = table3.Columns.Add(&quot;PK&quot;);
            DataColumn fk3 = table3.Columns.Add(&quot;FK&quot;);
            fk3.ColumnMapping = MappingType.Hidden;

            DataSet data = new DataSet();
            data.Tables.Add(table1);
            data.Tables.Add(table2);
            data.Tables.Add(table3);
            data.Relations.Add(new DataRelation(&quot;r1&quot;, pk1, fk2) { Nested = true
});
            data.Relations.Add(new DataRelation(&quot;r2&quot;, pk2, fk3) { Nested = true
});
            return data;
        }

Actual Results:  
table1.FK and table2.FK are not populated.

The sequence of steps taken to deserialize are:
1. table1 deserialized
2. table1.FK = table2.PK (but table2.PK hasn't been deserialized yet!)
3. table2 deserialized
4. table2.FK = table3.PK (but table3.PK hasn't been deserialized yet!)
5. table3 deserialized

The code that populates the FK is in XmlDataReader.ReadElementElement.


Expected Results:  
The FKs should be populated by following this sequence of steps:

1. table1 deserialized
2. table1.FK = table2.PK (but table2.PK hasn't been deserialized yet!)
3. table2.FK = table3.PK (but table3.PK hasn't been deserialized yet!)
4. table2 deserialized
5. table3 deserialized


Proposed fix (not necessary best or optimised):

XmlDataReader (new field)
-------------------------
List&lt;Action&gt; nestedFKSetters = new List&lt;Action&gt;();

XmlDataReader.ReadElementElement
--------------------------------
:<i>
</I>:<i>
</I>DataRow childRow = rel.ChildTable.NewRow ();
ReadElement (childRow);

nestedFKSetters.Add(delegate {                 // LINE ADDED
    for (int c = 0; c &lt; rel.ChildColumns.Length; c++) {
        childRow [rel.ChildColumns [c]]
            = row [rel.ParentColumns [c]];
    }
});                                            // LINE ADDED
:<i>
</I>:<i>
</I>
XmlDataReader.Process
---------------------
:<i>
</I>:<i>
</I>    else
        ReadTopLevelElement ();
    foreach (Action action in nestedFKSetters)  // LINE ADDED
        action();                               // LINE ADDED
    } finally {
        dataset.EnforceConstraints = 
             savedEnforceConstraints;
    }
:<i>
</I>:<i>
</I>
-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="105680.html">[Mono-bugs] [Bug 650397] New: DataRow.GetParentRows doesn't work with &gt; 1 parent records
</A></li>
	<LI>Next message: <A HREF="105693.html">[Mono-bugs] [Bug 650398] Nested relation FKs not populated correctly on xml deserialization, with ColumnMapping=MappingType.Hidden
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#105681">[ date ]</a>
              <a href="thread.html#105681">[ thread ]</a>
              <a href="subject.html#105681">[ subject ]</a>
              <a href="author.html#105681">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
