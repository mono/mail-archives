<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 79084][Nor] New - socket-io.c and UnixEndPoint	have broken assumptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2079084%5D%5BNor%5D%20New%20-%20socket-io.c%20and%20UnixEndPoint%0A%09have%20broken%20assumptions&In-Reply-To=bug-79084%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="045626.html">
   <LINK REL="Next"  HREF="045628.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 79084][Nor] New - socket-io.c and UnixEndPoint	have broken assumptions</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2079084%5D%5BNor%5D%20New%20-%20socket-io.c%20and%20UnixEndPoint%0A%09have%20broken%20assumptions&In-Reply-To=bug-79084%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 79084][Nor] New - socket-io.c and UnixEndPoint	have broken assumptions">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Wed Aug 16 07:16:49 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="045626.html">[Mono-bugs] [Bug 79083][Nor] New - ComboBox,	can not drag thumb for scrollbar.
</A></li>
        <LI>Next message: <A HREF="045628.html">[Mono-bugs] [Bug 79084][Nor] Changed - socket-io.c and UnixEndPoint	have broken assumptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45627">[ date ]</a>
              <a href="thread.html#45627">[ thread ]</a>
              <a href="subject.html#45627">[ subject ]</a>
              <a href="author.html#45627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">alp at atoker.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=79084">http://bugzilla.ximian.com/show_bug.cgi?id=79084</A>

--- shadow/79084	2006-08-16 07:16:49.000000000 -0400
+++ shadow/79084.tmp.10842	2006-08-16 07:16:49.000000000 -0400
@@ -0,0 +1,88 @@
+Bug#: 79084
+Product: Mono: Runtime
+Version: 1.1
+OS: 
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: io-layer
+AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">dick at ximian.com</A>                            
+ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">alp at atoker.com</A>               
+QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: socket-io.c and UnixEndPoint have broken assumptions
+
+socket-io.c has
+
+*sa_size = sizeof (struct sockaddr_un);
+
+This means that sa_size always ends up being 110 (108 + 2 bytes for the
+address family?).
+
+The result is that we pass junk as part of the socket address when
+sa_family == AF_UNIX.
+
+An strace shows something like:
+
+socket(PF_FILE, SOCK_STREAM, 0)         = 3
+connect(3, {sa_family=AF_FILE, path=&quot;/tmp/foo&quot;}, 110) = 0
+
+It should really be more like:
+
+socket(PF_FILE, SOCK_STREAM, 0)         = 3
+connect(3, {sa_family=AF_FILE, path=&quot;/tmp/foo&quot;}, 9) = 0
+
+This is because &quot;/tmp/foo\0&quot;.Length = 9
+
+It has not been a major problem in the past as there are hacks to the
+managed side (UnixEndPoint in Mono.Unix) to make things appear to work in
+some cases.
+
+The problem was discovered when implementing a program that needs to use
+abstract domain sockets.
+
+In abstract domain sockets, the socket address data payload is prefixed
+with null _instead_ of being suffixed with null. See unix(7) for the lowdown.
+
+In order to allow for the managed code to support abstract domain sockets,
+and not to break hashing in the general case, it is important to
+
+(1) Set the correct length:
+*sa_size = len;
+
+(2) Remove the unmanaged null termination
+-		sock_un-&gt;sun_path [len - 2] = '\0';
+
+(3) Optional exercise: Review this:
+data=mono_array_new(domain, mono_get_byte_class (), sa_size - 2);
+
+Should the - 2 really be there? Maybe, have not thought that far ahead.
+
+
+The null suffix/prefix should instead be added properly in the managed code
+in UnixEndPoint, so we can later add a class called AbstractUnixEndPoint or
+otherwise add support for null prefixing and the abstract namespace.
+
+Once this area is clarified, we also need to look at whether we really want
+to +=2 when marshaling in the opposite direction. Hopefully one day we will
+have tests for this as well, but it doesn't make sense to write tests until
+we understand what's required.
+
+A concept patch for the unmanaged side is attached. This is the most
+important modification for my needs, since without it, managed code never
+has even a chance of using abstract sockets, whereas with it, I can at
+least bundle a fixed UnixEndPoint with my code and require the latest fixed
+Mono release. However, it would be good to clean up the hacks in
+UnixEndPoint now that we have this part cleared up.
+
+strace is the key tool for debugging this. The only consumer of abstract
+sockets I know of that's readily available is dbus-send:
+
+strace dbus-send --system --print-reply=literal --dest=org.freedesktop.DBus
+/org/freedesktop/DBus org.freedesktop.DBus.NameHasOwner string:foo
+
+One expects that it's getting things right.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="045626.html">[Mono-bugs] [Bug 79083][Nor] New - ComboBox,	can not drag thumb for scrollbar.
</A></li>
	<LI>Next message: <A HREF="045628.html">[Mono-bugs] [Bug 79084][Nor] Changed - socket-io.c and UnixEndPoint	have broken assumptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45627">[ date ]</a>
              <a href="thread.html#45627">[ thread ]</a>
              <a href="subject.html#45627">[ subject ]</a>
              <a href="author.html#45627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
