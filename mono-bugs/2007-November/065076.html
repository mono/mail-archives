<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 341443] New: HttpListener - Bad Request (Invalid	Url)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20341443%5D%20New%3A%20HttpListener%20-%20Bad%20Request%20%28Invalid%0A%09Url%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="065071.html">
   <LINK REL="Next"  HREF="065077.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 341443] New: HttpListener - Bad Request (Invalid	Url)</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20341443%5D%20New%3A%20HttpListener%20-%20Bad%20Request%20%28Invalid%0A%09Url%29&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 341443] New: HttpListener - Bad Request (Invalid	Url)">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Nov 13 14:22:47 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="065071.html">[Mono-bugs] [Bug 324856] [Patch] Windows Dropfiles not implemented
</A></li>
        <LI>Next message: <A HREF="065077.html">[Mono-bugs] [Bug 341443] HttpListener - Bad Request (Invalid Url)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65076">[ date ]</a>
              <a href="thread.html#65076">[ thread ]</a>
              <a href="subject.html#65076">[ subject ]</a>
              <a href="author.html#65076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=341443">https://bugzilla.novell.com/show_bug.cgi?id=341443</A>

           Summary: HttpListener - Bad Request (Invalid Url)
           Product: Mono: Class Libraries
           Version: unspecified
          Platform: i686
        OS/Version: Other
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: System
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brinn at crowdus.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
          Found By: Other


Description of Problem:


Steps to reproduce the problem:
1. Create a console application that uses the HttpListener on any port.
2. Start the application.
3. Configure either IE 7, Firefox (2.0.0.9), or Opera 9.23 (happens from all)
to use a proxy that the HttpListener is on.
4. Access any website. I use <A HREF="http://www.google.com">http://www.google.com</A> The result is a 400 Bad
Request with a body of Bad Request (Invalid url).
5. If you remove the proxy settings in either of the browsers and access the
the machine and port the HttpListener is on you get the results in the Response
Stream.
6. Run the application under Microsoft's .NET Framework and you get the
different results when access the application as a Proxy.

Actual Results:
400 Bad Request

Expected Results:
Output from HttpListener / HttpListenerResponse (As a Proxy)

How often does this happen? 
Always.

Additional Information:

All three browser request a url with a relative url in the initial request
line.when not using a proxy. All three request a url with an absolute url in
the initial request line when using a Proxy Server.

*** No Proxy ***
GET / HTTP/1.1
Host: www.google.com

*** Proxy ***
GET <A HREF="http://www.google.com">http://www.google.com</A> HTTP/1.1
Host: www.google.com

The HttpListener instance never gets the Context when this error happens, so
this leads one to believe that this is happending building the
HttpListenerRequest object. It looks as though the Relative vs Absolute Url
Request is not handled.

Again as stated above this works under the .NET 2.0 implementation. I have
attached a very simple console application that I used to reproduce the bug.

**********************************************************
using System;
using System.Collections.Generic;
using System.Text;
using System.Net;
using System.Net.Sockets;
using System.IO;
using System.Threading;


namespace ConsoleApplication
{    
    internal class Program
    {
        static void Main ( string[] args )
        {
            Server http = new Server();
            Proxy proxy = new Proxy();

            new Thread( http.Run ).Start();
            new Thread( proxy.Run ).Start();
            Console.Read();
            http.Stop();
            proxy.Stop();
        }
    }

    internal class Proxy
    {
        private TcpListener Listener = new TcpListener( IPAddress.Loopback,
8081 );

        public Proxy ( )
        {
            Listener.Start();
        }
        public void Stop ( )
        {

            Listener.Stop();
        }
        public void Run ( )
        {
            Socket client;
            try
            {
                while ( true )
                {
                    client = Listener.AcceptSocket();
                    byte[] buffer = new byte[4096];

                    client.Receive( buffer );
                    Console.WriteLine( Encoding.UTF8.GetString( buffer ) );

                    StringBuilder response = new StringBuilder();
                    response.AppendLine( &quot;HTTP/1.1 200 OK&quot; );
                    response.AppendLine( &quot;Content-Type: text/html;
charset=UTF-8&quot; );
                    response.AppendLine( &quot;Content-Length: 6&quot; );
                    response.AppendLine( &quot;Connection: close&quot; );
                    response.AppendLine( &quot;&quot; );
                    response.AppendLine( &quot;NoPage&quot; );

                    buffer = Encoding.UTF8.GetBytes( response.ToString() );
                    client.Send( buffer );
                    client.Shutdown( SocketShutdown.Both );
                    client.Close();
                }
            }
            catch ( SocketException )
            { }

        }
    }
    internal class Server
    {
        private HttpListener Listener = new HttpListener();
        public Server ( )
        {
            Listener.Prefixes.Add( @&quot;<A HREF="http://*:8080/&quot;">http://*:8080/&quot;</A> );
            Listener.Start();
        }
        public void Stop ( )
        {
            Listener.Stop();
        }
        public void Run ( )
        {
            while ( Listener.IsListening )
            {
                try
                {
                    HttpListenerContext context = Listener.GetContext();

                    using ( StreamWriter writer = new StreamWriter(
context.Response.OutputStream ) )
                    {
                        writer.WriteLine( &quot;&lt;html&gt;&quot; );
                        writer.WriteLine( &quot;&lt;head&gt;&quot; );
                        writer.WriteLine( &quot;&lt;title&gt;This is a webpage&lt;/title&gt;&quot; );
                        writer.WriteLine( &quot;&lt;/head&gt;&quot; );
                        writer.WriteLine( &quot;&lt;body&gt;&lt;h1&gt;This is the
body!&lt;/h1&gt;&lt;/body&gt;&quot; );
                        writer.WriteLine( &quot;&lt;/html&gt;&quot; );
                    }
                    context.Response.Close();
                }
                catch ( HttpListenerException )
                {

                }                
            }
        }
    }


}


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>












































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="065071.html">[Mono-bugs] [Bug 324856] [Patch] Windows Dropfiles not implemented
</A></li>
	<LI>Next message: <A HREF="065077.html">[Mono-bugs] [Bug 341443] HttpListener - Bad Request (Invalid Url)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65076">[ date ]</a>
              <a href="thread.html#65076">[ thread ]</a>
              <a href="subject.html#65076">[ subject ]</a>
              <a href="author.html#65076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
