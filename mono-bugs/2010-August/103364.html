<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 549807] WaitHandle.WaitAny returns WAIT_IO_COMPLETION (an impossible return value for .NET)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20549807%5D%20WaitHandle.WaitAny%20returns%0A%20WAIT_IO_COMPLETION%20%28an%20impossible%20return%20value%20for%20.NET%29&In-Reply-To=bug-549807-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="103375.html">
   <LINK REL="Next"  HREF="103365.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 549807] WaitHandle.WaitAny returns WAIT_IO_COMPLETION (an impossible return value for .NET)</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20549807%5D%20WaitHandle.WaitAny%20returns%0A%20WAIT_IO_COMPLETION%20%28an%20impossible%20return%20value%20for%20.NET%29&In-Reply-To=bug-549807-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 549807] WaitHandle.WaitAny returns WAIT_IO_COMPLETION (an impossible return value for .NET)">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Aug 31 01:00:20 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="103375.html">[Mono-bugs] [Bug 635720] gmcs fails to compile nested classes with	generics
</A></li>
        <LI>Next message: <A HREF="103365.html">[Mono-bugs] [Bug 473899] UnicodeEncoding.Unicode.GetString allows invalid code points through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#103364">[ date ]</a>
              <a href="thread.html#103364">[ thread ]</a>
              <a href="subject.html#103364">[ subject ]</a>
              <a href="author.html#103364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=549807">https://bugzilla.novell.com/show_bug.cgi?id=549807</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=549807#c2">https://bugzilla.novell.com/show_bug.cgi?id=549807#c2</A>


--- Comment #2 from Joe Mistachkin &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">joe at mistachkin.com</A>&gt; 2010-08-31 05:00:18 UTC ---
Here is your isolated test case:

1. Compile the following code with gmcs or .NET.
2. Run the code under .NET (no exception occurs).
3. Run the code under Mono (array index out of range exception occurs).
4. Pay special attention to the &quot;WaitAny returned XXX&quot; console output.


using System;
using System.Runtime.InteropServices;
using System.Threading;

namespace ConsoleApplication1
{
    internal static class bug549807
    {
        #region Thread Procedure
        internal static void ThreadStart()
        {
            Program.threadId = unchecked((uint)AppDomain.GetCurrentThreadId());

            EventWaitHandle doneEvent =
                EventWaitHandle.OpenExisting(&quot;done&quot;);

            EventWaitHandle[] handles = new EventWaitHandle[] {
                doneEvent
            };

            int index;

            Console.WriteLine(&quot;Thread entering loop.&quot;);

            while ((index = ManualResetEvent.WaitAny(handles, 4000, false)) &gt;
0)
            {
                Console.WriteLine(&quot;WaitAny returned {0}&quot;, index);

                if (index != EventWaitHandle.WaitTimeout)
                    handles[index].Reset(); /* NOTE: Exception here on Mono. */
            }

            Console.WriteLine(&quot;Thread exited loop.&quot;);
        }
        #endregion

       
///////////////////////////////////////////////////////////////////////////

        #region Asynchronous Event Callback Procedure
        internal static void EventCallback(IntPtr data)
        {
            Console.WriteLine(&quot;this is the event callback&quot;);
        }
        #endregion
    }

    ///////////////////////////////////////////////////////////////////////////

    internal static class Program
    {
        internal static uint threadId = 0;

        internal const uint THREAD_SET_CONTEXT = 0x10; /* NOTE: For
QueueUserAPC. */

        [DllImport(&quot;kernel32&quot;, CallingConvention = CallingConvention.Winapi,
SetLastError = true)]
        internal static extern IntPtr OpenThread(uint desiredAccess, bool
inheritHandle, uint threadId);

        [DllImport(&quot;kernel32&quot;, CallingConvention = CallingConvention.Winapi)]
        internal static extern uint QueueUserAPC(ApcCallback proc, IntPtr
thread, IntPtr data);

        [UnmanagedFunctionPointer(CallingConvention.StdCall)]
        public delegate void ApcCallback(IntPtr data);

        private static void Main(string[] args)
        {
            EventWaitHandle doneEvent = new EventWaitHandle(
                false, EventResetMode.ManualReset, &quot;done&quot;);

            Thread thread = new Thread(bug549807.ThreadStart);

            thread.Start();

            Thread.Sleep(2000);

            IntPtr threadPtr = OpenThread(THREAD_SET_CONTEXT, false, threadId);

            if (QueueUserAPC(bug549807.EventCallback, threadPtr, IntPtr.Zero)
!= 0)
            {
                Console.WriteLine(&quot;APC queued.&quot;);
            }

            Thread.Sleep(2000);

            doneEvent.Set(); /* kill thread. */

            Console.ReadKey();
        }
    }
}

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="103375.html">[Mono-bugs] [Bug 635720] gmcs fails to compile nested classes with	generics
</A></li>
	<LI>Next message: <A HREF="103365.html">[Mono-bugs] [Bug 473899] UnicodeEncoding.Unicode.GetString allows invalid code points through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#103364">[ date ]</a>
              <a href="thread.html#103364">[ thread ]</a>
              <a href="subject.html#103364">[ subject ]</a>
              <a href="author.html#103364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
