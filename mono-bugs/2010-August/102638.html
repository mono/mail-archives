<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 627330] New: Mono doesn't track ICMP Pings and their responses correctly leading to unreliable results under a privileged account
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20627330%5D%20New%3A%20Mono%20doesn%27t%20track%20ICMP%20Pings%20and%0A%20their%20responses%20correctly%20leading%20to%20unreliable%20results%20under%20a%20privileged%0A%20account&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="102637.html">
   <LINK REL="Next"  HREF="102639.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 627330] New: Mono doesn't track ICMP Pings and their responses correctly leading to unreliable results under a privileged account</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20627330%5D%20New%3A%20Mono%20doesn%27t%20track%20ICMP%20Pings%20and%0A%20their%20responses%20correctly%20leading%20to%20unreliable%20results%20under%20a%20privileged%0A%20account&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 627330] New: Mono doesn't track ICMP Pings and their responses correctly leading to unreliable results under a privileged account">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Aug  2 00:01:21 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="102637.html">[Mono-bugs] [Bug 623707] Async sockets + domain unload -&gt; crash
</A></li>
        <LI>Next message: <A HREF="102639.html">[Mono-bugs] [Bug 627330] Mono doesn't track ICMP Pings and their responses correctly leading to unreliable results under a privileged account
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102638">[ date ]</a>
              <a href="thread.html#102638">[ thread ]</a>
              <a href="subject.html#102638">[ subject ]</a>
              <a href="author.html#102638">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=627330">http://bugzilla.novell.com/show_bug.cgi?id=627330</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=627330#c0">http://bugzilla.novell.com/show_bug.cgi?id=627330#c0</A>


           Summary: Mono doesn't track ICMP Pings and their responses
                    correctly leading to unreliable results under a
                    privileged account
    Classification: Mono
           Product: Mono: Class Libraries
           Version: SVN
          Platform: x86-64
        OS/Version: Ubuntu
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: System
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">michael at michael.ie</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=379721)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=379721">http://bugzilla.novell.com/attachment.cgi?id=379721</A>)
Test program

User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US)
AppleWebKit/533.4 (KHTML, like Gecko) Chrome/5.0.375.125 Safari/533.4

The System.Net.NetworkInformation.Ping class has a bug in how it tracks pings
and their pingResponses under privileged user accounts on Linux.

When a ping is sent as root from an app under mono, every sent ICMP Echo (ping)
packet has a fixed Identifier of 0x0100 and a non-incrementing Sequence number
of 0x0000. This leads to Mono unable to track individual pings and responses
between this host and that Endpoint because there is no way to differenciate
each ping response from the Ping that sent it.

The impact of this is serious in my use case where there is a continuous
testing of endpoints on a network, because any ping response will be valid for
any ping request it means *packet loss can be detected accurately* (as the next
response from that endpoint will satisfy the outstanding request, and so on).
It also means the Roundtrip Time can't be accurately measured.

&gt;<i>From my packet captures I see that Windows 7 seems to have a fixed identifier
</I>and an incrementing sequence number for every ping. Ping under Ubuntu seems to
have a different identifier for every process, and an incrementing sequence
number for every sent ping packet. Perhaps mono could adopt one of these
schemes.

The RTT values and individual timeouts are left completely wrong in many
circumstances due to this.

Reproducible: Always

Steps to Reproduce:
1. I spun up an Ubuntu Maverick instance on EC2
2. Running Mono JIT compiler version 2.7 (master/93a12ba Sun Aug  1 17:31:26
UTC 2010)
3. Compile and run the attached demo code to hit any address (tweak timeouts).
mono MonoPingTestAsync2.exe 173.45.237.169
Actual Results:  
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">ubuntu at ip-10-48-99-38</A>:~$ mono MonoPingTestAsync2.exe 173.45.237.169
Response: Success (176) expected:AAAAAAAAAAAAAAAAAAAAAAAA
got:AAAAAAAAAAAAAAAAAAAAAAAA
Response: Success (109) expected:BBBBBBBBBBBBBBBBBBBBBBBB
got:BBBBBBBBBBBBBBBBBBBBBBBB
Response: Success (111) expected:CCCCCCCCCCCCCCCCCCCCCCCC
got:CCCCCCCCCCCCCCCCCCCCCCCC
Response: Success (109) expected:1234567 got:1234567 # This is a different bug
in the unpriv code.
Response: Success (110) expected:DDDDDDDDDDDDDDDDDDDDDDDD
got:DDDDDDDDDDDDDDDDDDDDDDDD
Response: Success (110) expected:EEEEEEEEEEEEEEEEEEEEEEEE
got:EEEEEEEEEEEEEEEEEEEEEEEE
Response: Success (109) expected:FFFFFFFFFFFFFFFFFFFFFFFF
got:FFFFFFFFFFFFFFFFFFFFFFFF

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">ubuntu at ip-10-48-99-38</A>:~$ su
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">root at ip-10-48-99-38</A>:/home/ubuntu# mono MonoPingTestAsync2.exe 173.45.237.169
Response: Success (107) expected:AAAAAAAAAAAAAAAAAAAAAAAA
got:??7AAAAAAAAAAAAAAAA
Response: TimedOut (0) expected:BBBBBBBBBBBBBBBBBBBBBBBB got:
Response: Success (20) expected:CCCCCCCCCCCCCCCCCCCCCCCC
got:??7BBBBBBBBBBBBBBBB
Response: Success (86) expected:1234567 got:??7CCCCCCCCCCCCCCCC
Response: Success (107) expected:DDDDDDDDDDDDDDDDDDDDDDDD
got:??7DDDDDDDDDDDDDDDD
Response: TimedOut (0) expected:EEEEEEEEEEEEEEEEEEEEEEEE got:


Expected Results:  
&gt;<i>From the privileged execution as root, I expected:
</I>Response: Success (176) expected:AAAAAAAAAAAAAAAAAAAAAAAA
got:AAAAAAAAAAAAAAAAAAAAAAAA
Response: TimedOut(0) expected:BBBBBBBBBBBBBBBBBBBBBBBB got:
Response: Success (111) expected:CCCCCCCCCCCCCCCCCCCCCCCC
got:CCCCCCCCCCCCCCCCCCCCCCCC
Response: TimedOut(0) expected:1234567 got:
Response: Success (110) expected:DDDDDDDDDDDDDDDDDDDDDDDD
got:DDDDDDDDDDDDDDDDDDDDDDDD
Response: TimedOut(0) expected:EEEEEEEEEEEEEEEEEEEEEEEE got:
Response: Success (109) expected:FFFFFFFFFFFFFFFFFFFFFFFF
got:FFFFFFFFFFFFFFFFFFFFFFFF

Note: On the EC2 Maverick instance I'm running (US-West AMI: ami-c997c68c) the
ping of 1234567 should always fail due to the firewall or network restrictions
of a payload too small. 
The other two timeouts should be set very low to demo the issue.
Also note the constant ping times of over 109ms vrs skewed results in Actual
(due to answer for different ping)

Also attached is a packet capture (caught with pcapdump -i eth0 -T 15 -w
UbuntuMaverick.pcap) which shows the app running unprivileged and then
privileged. It shows the Identifier changing for every ping as mono calls out
to the ping binary for each run, and the Sequence being 0x0001 as it's the only
packet from that ping instance)
The Privileged execution has an Identifier of 0x0100 always and always has the
same Sequence number of 0x0000 (Please note: I patched the source to check
something else to send 0x3700 - it's notmally 0x0000)

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="102637.html">[Mono-bugs] [Bug 623707] Async sockets + domain unload -&gt; crash
</A></li>
	<LI>Next message: <A HREF="102639.html">[Mono-bugs] [Bug 627330] Mono doesn't track ICMP Pings and their responses correctly leading to unreliable results under a privileged account
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102638">[ date ]</a>
              <a href="thread.html#102638">[ thread ]</a>
              <a href="subject.html#102638">[ subject ]</a>
              <a href="author.html#102638">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
