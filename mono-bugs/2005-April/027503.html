<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 74645][Wis] New - Windows does not decrypt the first block correctly when decrypting some data that was encrypted using mono
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="027502.html">
   <LINK REL="Next"  HREF="027504.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 74645][Wis] New - Windows does not decrypt the first block correctly when decrypting some data that was encrypted using mono
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 74645][Wis] New - Windows does not decrypt the first block correctly when decrypting some data that was encrypted using mono">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Mon, 18 Apr 2005 01:00:08 -0400 (EDT)</I>
    <P><UL>
        <LI> Previous message: <A HREF="027502.html">[Mono-bugs] [Bug 74612][Nor] Changed - Unref messages
</A></li>
        <LI> Next message: <A HREF="027504.html">[Mono-bugs] [Bug 74646][Wis] New - Assertion in handles.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27503">[ date ]</a>
              <a href="thread.html#27503">[ thread ]</a>
              <a href="subject.html#27503">[ subject ]</a>
              <a href="author.html#27503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:eric@extremeboredom.net.">eric@extremeboredom.net.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=74645">http://bugzilla.ximian.com/show_bug.cgi?id=74645</A>

--- shadow/74645	2005-04-18 01:00:08.000000000 -0400
+++ shadow/74645.tmp.8067	2005-04-18 01:00:08.000000000 -0400
@@ -0,0 +1,157 @@
+Bug#: 74645
+Product: Mono: Class Libraries
+Version: 1.0
+OS: 
+OS Details: Linux and Windows XP
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Wishlist
+Component: System.Security
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:eric@extremeboredom.net">eric@extremeboredom.net</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Summary: Windows does not decrypt the first block correctly when decrypting some data that was encrypted using mono
+
+Description of Problem:
+Windows does not decrypt the first block correctly when decrypting some
+data that was encrypted using mono.
+
+spouliot! here's the IRC log as you requested! Please email me or catch me
+on IRC again if there is anything I can help you with!
+
+Thanks a lot!
+
+-----------------
+
+&lt;FireRabbit&gt; hey, could you please let me know when you get back? 
+&lt;spouliot&gt; here I am!
+&lt;FireRabbit&gt; hey, so you did a lot of the System.Security stuff right?
+&lt;spouliot&gt; yep
+&lt;FireRabbit&gt; awesome .. so I am having a problem where when I encrypt
+specific data on mono and try to decrypt it using the .net framework the
+first 10 or so bytes are wrong
+&lt;spouliot&gt; you have some sample code ?
+&lt;FireRabbit&gt; i havent been able to create a testcase its fairly embeded
+into my application ... do you want to test that? its very easy to reproduce..
+&lt;spouliot&gt; open a bugzilla issue with a link to the source code and
+instructions to reproduce
+&lt;spouliot&gt; I'll look at it tomorrow
+&lt;FireRabbit&gt; hm okay, we will try to put together a good test tonight.
+&lt;FireRabbit&gt; its a real pain to test this because it requires a windows and
+linux box basically 
+&lt;FireRabbit&gt; it also doesn't happen with everything that I encrypt .. but
+does happen regardless of if I use 3des or aes.
+&lt;spouliot&gt; I got them - not that I like the requirements to reproduce a bug ;-)
+&lt;spouliot&gt; what mode and padding are you using ?
+&lt;FireRabbit&gt; i tried a bunch of different ones and had the same problem ...
+i think it's using the default one now.
+&lt;spouliot&gt; are you using CryptoStream or not ?
+&lt;FireRabbit&gt; I could have sworn that in 1.1.4 this was fixed (it doesnt
+work in anything newer) but i havent gone back to confirm this.
+&lt;FireRabbit&gt; yeah, CryptoStream.
+&lt;spouliot&gt; it may be a bug in CryptoStream - or in the way you're using it.
+&lt;FireRabbit&gt;
+<A HREF="http://monosvn.mosaix.net/filedetails.php?repname=Meshwork&path=%2Ftrunk%2FlibMeshwork%2FClasses%2FSecurity.cs&rev=0&sc=0">http://monosvn.mosaix.net/filedetails.php?repname=Meshwork&amp;path=%2Ftrunk%2FlibMeshwork%2FClasses%2FSecurity.cs&amp;rev=0&amp;sc=0</A>
+&lt;spouliot&gt; the first block is probably mis-decrypted due to the state of
+the stream (e.g. bug or a missing flush)
+&lt;FireRabbit&gt; hmm.
+&lt;FireRabbit&gt; do you see anything i am doing obviously wrong in those
+Encrypt/Decrypt methods?
+&lt;FireRabbit&gt; (this does work mono&lt;-&gt;mono)
+&lt;spouliot&gt; where is the ICryptoTransform created ?
+&lt;FireRabbit&gt; in this file:
+<A HREF="http://monosvn.mosaix.net/filedetails.php?repname=Meshwork&path=%2Ftrunk%2FlibMeshwork%2FClasses%2FEncryptedConnection.cs&rev=0&sc=0">http://monosvn.mosaix.net/filedetails.php?repname=Meshwork&amp;path=%2Ftrunk%2FlibMeshwork%2FClasses%2FEncryptedConnection.cs&amp;rev=0&amp;sc=0</A>
+&lt;FireRabbit&gt;                                         deTransform =
+cryptoProvider.CreateDecryptor(keyBytes, ivBytes);
+&lt;FireRabbit&gt;                                         enTransform =
+cryptoProvider.CreateEncryptor(keyBytes, ivBytes);
+&lt;spouliot&gt; nothing bad at first look - but you're creating a lot of objects
+for the job (as I guess your data is small as it looks like a password)
+&lt;FireRabbit&gt; no, its more than a password .. all the socket traffic gets
+encrypted.
+&lt;spouliot&gt; so you're creating a CryptoStream/MemoryStream for each
+encrypt/decrypt operation ? (anyway it's offtopic ;-)
+&lt;FireRabbit&gt; yeah well once it _works_ i'll fix that.. its been on my list
+&lt;spouliot&gt; well I don't want to hide the bug before finding it - but it
+would probably _work_ (and faster) if you use the ICryptoTransform methods
+directly
+&lt;FireRabbit&gt; TransformBlock?
+&lt;spouliot&gt; the CryptoStream is nice if you're already working with stream
+(or plan to) but if you're dealing with byte arrays then the
+Transform[Block|FinalBlock] are easier (and requires much less overhead)
+&lt;FireRabbit&gt; shit I never even noticed those methods before :P
+&lt;FireRabbit&gt; well initially i was hoping to be able to create the
+cryptostream ontop of a networkstream but THAT wasnt working either .. so
+one thing at a time yes
+&lt;spouliot&gt; they are not easy to see as the ICryptoTransform classes are
+(mostly) not public
+&lt;spouliot&gt; have you verified that the key and IV are identical on both side
+? (i.e. that it isn't a key exchange problem ?)
+&lt;FireRabbit&gt; i think so but i will double check again.
+&lt;spouliot&gt; I'll try to duplicate the problem with your code. The only
+missing info I need is the typical size of the data you encrypt/decrypt.
+&lt;FireRabbit&gt; i can tell you exactly in one sec .. ill make it write the
+size as it recieves..
+&lt;FireRabbit&gt; okay this is 772 bytes..
+&lt;spouliot&gt; k
+&lt;FireRabbit&gt; if windows would stop crashing i could verify the key/iv...
+&lt;FireRabbit&gt; yep, looks good.
+&lt;spouliot&gt; k, I'm on the case
+&lt;FireRabbit&gt; would you still like me to file a bug?
+&lt;spouliot&gt; yes please. it helps for history
+&lt;spouliot&gt; you can copy/paste our IRC log to make it short, I'll update it
+&lt;FireRabbit&gt; okay one sec
+&lt;spouliot&gt; does the same code works without encryption ?
+&lt;FireRabbit&gt; oh yeah, if i comment out my encryption stuff it works.
+&lt;FireRabbit&gt; or if i overwrite the first block with the correct data manually
+&lt;spouliot&gt; it cannot be a mis-use of the CryptoStream because it's only
+used locally (re-using it could lead to problems if care isn't taken)
+&lt;FireRabbit&gt; right.
+&lt;spouliot&gt; I made a sample with your code (and a similar ICryptoTransform
+code) and I get the same results with both implementations on both Linux and XP
+&lt;FireRabbit&gt; same results meaning same error as me or it works properly?
+&lt;spouliot&gt; works properly
+&lt;FireRabbit&gt; damn ! i dont know what it is about what i am encrypting ...
+&lt;FireRabbit&gt; so your encrypting on linux and decrypting on xp?
+&lt;spouliot&gt; yes I encrypt/decrypt on both and show the encrypted/decrypted
+values
+&lt;spouliot&gt; ok, I recall a issue someone had a few months ago...
+&lt;FireRabbit&gt; the problem is only when you encrypt on one platform and
+decrypt those bytes on another
+&lt;spouliot&gt; that's what I do (on a command line)
+&lt;FireRabbit&gt; oh ok
+&lt;spouliot&gt; what kind of data are you transfering ?
+&lt;FireRabbit&gt; binary serialized object
+&lt;spouliot&gt; did you try mono on XP ? or only the MS runtime ?
+&lt;FireRabbit&gt; only the MS runtime since thats what i am targeting on windows
+&lt;spouliot&gt; I'm gonna attach my sample code to the bug report so you can try
+it too - what's it's number ?
+&lt;FireRabbit&gt; havent filed yet. one sec.
+&lt;FireRabbit&gt; i had tried writing a simple test case too and it worked as
+well...so its gotta be some little thing throwing it off
+&lt;spouliot&gt; very possibly - but I don't see what could affect the
+CryptoStream since it's only used locally
+&lt;spouliot&gt; Are the Linux/Windows software identical in functionalities ? if
+so does the problem happens on both side ?
+&lt;spouliot&gt; I assuming that W-&gt;W and L-&gt;L works and that W-&gt;L and L-&gt;W doesn't
+&lt;FireRabbit&gt; its the same dll on both platforms
+&lt;FireRabbit&gt; let me test W&lt;-&gt;W real quick.
+&lt;spouliot&gt; I must go. Did you fill the bug ?
+&lt;FireRabbit&gt; about to do that (sorry, people are very distracting here) ..
+what's your email? I'll send you the bug#?
+&lt;spouliot&gt; just assign it to me - I'll receive the bug#
+&lt;spouliot&gt; <A HREF="mailto:sebastien@ximian.com">sebastien@ximian.com</A>
+&lt;FireRabbit&gt; okay
+&lt;spouliot&gt; what's yours ? I'll send you the sample code to try
+&lt;FireRabbit&gt; <A HREF="mailto:eric@extremeboredom.net">eric@extremeboredom.net</A>
+&lt;FireRabbit&gt; should I include how to use Meshwork to test this in the bug
+report or shoudl i try to write a test case ... or what? meshwork would
+take a few minutes to set up ...
+&lt;spouliot&gt; keep it simple. Just copy/paste the IRC log in it so I don't
+loose history and details if I cannot work on this tomorrow morning
+&lt;FireRabbit&gt; okay
+&lt;spouliot&gt; cya
+&lt;FireRabbit&gt; thanks a lot !

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="027502.html">[Mono-bugs] [Bug 74612][Nor] Changed - Unref messages
</A></li>
	<LI> Next message: <A HREF="027504.html">[Mono-bugs] [Bug 74646][Wis] New - Assertion in handles.c
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27503">[ date ]</a>
              <a href="thread.html#27503">[ thread ]</a>
              <a href="subject.html#27503">[ subject ]</a>
              <a href="author.html#27503">[ author ]</a>
         </LI>
       </UL>
</body></html>
