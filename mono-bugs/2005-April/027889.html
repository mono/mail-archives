<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 74718][Nor] New - Data Bound Control inherited from Calendar does not render Day on Days with Data Bound items
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="027888.html">
   <LINK REL="Next"  HREF="027891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 74718][Nor] New - Data Bound Control inherited from Calendar does not render Day on Days with Data Bound items
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 74718][Nor] New - Data Bound Control inherited from Calendar does not render Day on Days with Data Bound items">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Sun, 24 Apr 2005 18:57:41 -0400 (EDT)</I>
    <P><UL>
        <LI> Previous message: <A HREF="027888.html">[Mono-bugs] [Bug 74717][Nor] New - [GMCS] SerializableAttribute added for all enums
</A></li>
        <LI> Next message: <A HREF="027891.html">[Mono-bugs] [Bug 74713][Maj] Changed - System.IO.IOException: Invalid handle to path &quot;/tmp/tmp4d062ea3&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27889">[ date ]</a>
              <a href="thread.html#27889">[ thread ]</a>
              <a href="subject.html#27889">[ subject ]</a>
              <a href="author.html#27889">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:joe_audette@yahoo.com.">joe_audette@yahoo.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=74718">http://bugzilla.ximian.com/show_bug.cgi?id=74718</A>

--- shadow/74718	2005-04-24 18:57:41.000000000 -0400
+++ shadow/74718.tmp.22678	2005-04-24 18:57:41.000000000 -0400
@@ -0,0 +1,470 @@
+Bug#: 74718
+Product: Mono: Tools
+Version: 1.1
+OS: SUSE 9.2
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: XSP
+AssignedTo: <A HREF="mailto:gonzalo@ximian.com">gonzalo@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:joe_audette@yahoo.com">joe_audette@yahoo.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: Data Bound Control inherited from Calendar does not render Day on Days with Data Bound items
+
+Please fill in this template when reporting a bug, unless you know what 
+you are doing.
+
+Description of Problem:
+I am trying to use a Data bound control that inherits from the 
+System.Web.UI.WebControls.Calendar and INamingContainer. It works as 
+expected on Windows but under mono the Day number is not rendering on days 
+with data bound items. The Day number should be clickable to select the 
+day. I am attaching a page with inline code and 2 classes that need to be 
+compiled into DataCalendar.dll. Please tell me if you see something I can 
+do to make it work in both places by changing my code.
+
+I am running Suse 9.2 with mono 1.1.7 r43477 from svn
+I am using mod_mono with Apache
+
+
+Steps to reproduce the problem:
+1. Compile the 2 classes DataCalendar and DataCalendarItem into 
+DataCalendar.dll
+2. Try the attached page with the DataCalendar.dll accessible to it in the 
+bin folder
+
+
+Actual Results:
+The Day number does not render in the calendar for days with data bound 
+items.
+
+
+Expected Results:
+The Day number does render and is clickable for postback. This is the 
+behaviour on Windows.
+
+
+How often does this happen? 
+Every Time
+
+Additional Information:
+Page Code Starts here
+-----------------------
+&lt;% @Register Namespace=&quot;DataControls&quot; Assembly=&quot;DataCalendar&quot; 
+TagPrefix=&quot;dc&quot; %&gt;
+
+&lt;% @Import Namespace=&quot;System.Data&quot; %&gt;
+
+&lt;script language=&quot;cs&quot; runat=&quot;server&quot;&gt;
+
+    DataTable GetEventData()
+    {
+        DataTable dt = new DataTable();
+        
+        dt.Columns.Add(&quot;EventTitle&quot;, typeof(String));
+        dt.Columns.Add(&quot;EventDay&quot;, typeof(DateTime));
+        dt.Columns.Add(&quot;Color&quot;, typeof(System.Drawing.Color));
+        
+        DataRow r = dt.NewRow();
+        r[&quot;EventTitle&quot;] = &quot;Today's Event&quot;;
+        r[&quot;EventDay&quot;] = System.DateTime.Today;
+        r[&quot;Color&quot;] = System.Drawing.Color.Black;
+        dt.Rows.Add(r);
+
+        r = dt.NewRow();
+        r[&quot;EventTitle&quot;] = &quot;Tomorrow's Event&quot;;
+        r[&quot;EventDay&quot;] = System.DateTime.Today.AddDays(1);
+        r[&quot;Color&quot;] = System.Drawing.Color.Red;
+        dt.Rows.Add(r);
+
+        r = dt.NewRow();
+        r[&quot;EventTitle&quot;] = &quot;Tomorrow's Event #2&quot;;
+        r[&quot;EventDay&quot;] = System.DateTime.Today.AddDays(1);
+        r[&quot;Color&quot;] = System.Drawing.Color.Blue;
+        dt.Rows.Add(r);
+
+        r = dt.NewRow();
+        r[&quot;EventTitle&quot;] = &quot;Next Week's Event&quot;;
+        r[&quot;EventDay&quot;] = System.DateTime.Today.AddDays(7);
+        r[&quot;Color&quot;] = System.Drawing.Color.Green;
+        dt.Rows.Add(r);
+
+        return dt;
+    }
+    
+
+    void Page_Load(Object o, EventArgs e)
+    {
+        cal1.DataSource = GetEventData();
+    }
+    
+&lt;/script&gt;
+
+
+&lt;html&gt;
+    &lt;head&gt;&lt;title&gt;DataCalendar - Example 1&lt;/title&gt;&lt;/head&gt;
+    
+    &lt;body&gt;
+        &lt;form runat=&quot;server&quot;&gt;
+                    
+            &lt;h3&gt;Events DataTable constructed through code&lt;/h3&gt;
+            
+            &lt;dc:DataCalendar id=&quot;cal1&quot; runat=&quot;server&quot; width=&quot;100%&quot;  
+DayField=&quot;EventDay&quot;
+                             BorderWidth=&quot;1&quot; BorderStyle=&quot;None&quot; 
+CellPadding=&quot;0&quot;
+			     	SelectorStyle-BorderWidth=&quot;0&quot;  Font-
+Name=&quot;Tahoma&quot; SelectionMode=&quot;Day&quot; ShowGridLines=&quot;True&quot;
+			     	 TitleStyle-CssClass=&quot;EventCalendarTitle&quot;
+			     	TitleStyle-BorderWidth=&quot;0&quot; DayHeaderStyle-
+CssClass=&quot;EventCalendarDayHeader&quot; DayStyle-CssClass=&quot;EventCalendarDay&quot;
+			     	WeekendDayStyle-
+CssClass=&quot;EventCalendarWeekendDay&quot; 
+			     	NextPrevStyle-
+CssClass=&quot;EventCalendarNextPrev&quot; NextPrevStyle-ForeColor=&quot;White&quot;&gt;
+			     	&lt;DayWithEventsStyle ForeColor=&quot;#0033ff&quot; 
+Font-Bold=&quot;True&quot; /&gt;
+			     	&lt;CurrentDayStyle BackColor=&quot;WhiteSmoke&quot; 
+ForeColor=&quot;DarkGray&quot; Font-Bold=&quot;True&quot; /&gt;
+					&lt;OtherMonthDayStyle 
+BackColor=&quot;LightGray&quot; ForeColor=&quot;DarkGray&quot; /&gt;
+	
+                &lt;ItemTemplate&gt;
+                    &lt;br /&gt;
+                    &lt;asp:Label id=&quot;lblTitle&quot; runat=&quot;server&quot;
+                               Font-Size=&quot;8&quot;
+                               Font-Name=&quot;Arial&quot; 
+                               Text='&lt;%# Container.DataItem[&quot;EventTitle&quot;] %
+&gt;'
+                               ForeColor='&lt;%# Container.DataItem[&quot;Color&quot;] %
+&gt;'
+                            /&gt;
+                            
+                &lt;/ItemTemplate&gt;
+            &lt;/dc:DataCalendar&gt;
+            
+        &lt;/form&gt;
+    &lt;/body&gt;
+        
+&lt;/html&gt;
+
+---- End Page Code------
+
+//Compile the 2 classes below into DataCalendar.dll and put in the bin 
+where the above page can find it.
+
+using System;
+using System.Web.UI;
+using System.Web.UI.WebControls;
+using System.Data;
+
+namespace DataControls
+{    
+
+	/********************************************************
+	  Class DataCalendarItem
+		- serves as the container for a single calendar entry,
+		  allowing for databinding syntax like the following
+		  to be used in the .aspx page:
+          
+			&lt;%# Container.DataItem(&quot;MyField&quot;) %&gt;            
+	 ********************************************************/
+
+	public class DataCalendarItem : Control, INamingContainer
+	{
+
+		private DataRow _dataItem;
+
+		public DataCalendarItem(DataRow dr) 
+		{
+			_dataItem = dr;
+		}
+
+		// because the source data will be a DataTable
+		// object, it makes sense for our DataItem
+		// property to return a DataRow object
+		// (i.e. a single item in the data source
+		//  corresponds to a single row of data)
+		public DataRow DataItem 
+		{
+			get {return _dataItem;}
+			set {_dataItem = value;}
+		}
+	}
+
+
+	/********************************************************
+	  Class DataCalendar
+		- subclass of the ASP.NET Calendar control for
+		  displaying events from a DataTable with support
+		  for templates
+	 ********************************************************/
+
+	public class DataCalendar : Calendar, INamingContainer
+	{
+        
+		private object _dataSource;
+		private string _dataMember;
+		private string _dayField;
+		private ITemplate _itemTemplate;
+		private ITemplate _noEventsTemplate;
+		private TableItemStyle _dayWithEventsStyle = new 
+TableItemStyle();
+		private TableItemStyle _currentDayStyle = new 
+TableItemStyle();
+		private DataTable _dtSource;
+        
+		// Support either a DataSet or DataTable object
+		// for the DataSource property
+		public object DataSource 
+		{
+			get {return _dataSource;}
+			set 
+			{
+				if (value is DataTable || value is 
+DataSet) 
+					_dataSource = value;
+				else
+					throw new Exception(&quot;The 
+DataSource property of the DataCalendar control&quot; +
+						&quot; must be a DataTable or 
+DataSet object&quot;);
+			}
+		}
+        
+		// If a DataSet is supplied for DataSource,
+		// use this property to determine which
+		// DataTable within the DataSet should
+		// be used; if DataMember is not supplied,
+		// the first table in the DataSet will
+		// be used.
+		public string DataMember 
+		{
+			get {return _dataMember;}
+			set {_dataMember = value;}
+		}
+        
+        
+		// Specify the name of the field within
+		// the source DataTable that contains
+		// a DateTime value for displaying in the
+		// calendar.
+		public string DayField 
+		{
+			get {return _dayField;}
+			set {_dayField = value;}
+		}
+
+
+
+		public TableItemStyle DayWithEventsStyle 
+		{
+			get {return _dayWithEventsStyle;}
+			set {_dayWithEventsStyle = value;}
+		}
+
+		public TableItemStyle CurrentDayStyle 
+		{
+			get {return _currentDayStyle;}
+			set {_currentDayStyle = value;}
+		}
+
+		[TemplateContainer(typeof(DataCalendarItem))]    
+		public ITemplate ItemTemplate
+		{
+			get {return _itemTemplate; }
+			set {_itemTemplate = value;}
+		}
+
+
+		[TemplateContainer(typeof(DataCalendarItem))]    
+		public ITemplate NoEventsTemplate
+		{
+			get {return _noEventsTemplate; }
+			set {_noEventsTemplate = value;}
+		}
+
+		//		[TemplateContainer(typeof
+(DataCalendarItem))]    
+		//		public ITemplate SelectedDayTemplate
+		//		{
+		//			get {return _selectedDayTemplate; }
+		//			set {_selectedDayTemplate = value;}
+		//		}
+
+
+		// Constructor    
+		public DataCalendar() : base() 
+		{
+			// since this control will be used for displaying
+			// events, set these properties as a default
+			this.SelectionMode = CalendarSelectionMode.None;
+			this.ShowGridLines = true;
+		}
+        
+        
+		private void SetupCalendarItem(TableCell cell, DataRow r, 
+ITemplate t) 
+		{
+			// given a calendar cell and a datarow, set up the
+			// templated item and resolve data binding syntax
+			// in the template
+			DataCalendarItem dti = new DataCalendarItem(r);
+			t.InstantiateIn(dti);
+			dti.DataBind();
+			cell.Controls.Add(dti);            
+		}
+        
+        
+		protected override void OnDayRender(TableCell cell, 
+CalendarDay day)
+		{
+			// _dtSource was already set by the Render 
+method            
+			if (_dtSource != null) 
+			{
+                
+				// We have the data source as a DataTable 
+now;                
+				// filter the records in the DataTable for 
+the given day;
+				// force the date format to be MM/dd/yyyy
+				// to ensure compatibility with RowFilter
+				// date expression syntax (#date#).
+				// Also, take the possibility of time
+				// values into account by specifying
+				// a date range, to include the full day
+				DataView dv = new DataView(_dtSource);
+				dv.RowFilter = string.Format(
+					&quot;{0} &gt;= #{1}# and {0} &lt; #{2}#&quot;, 
+					this.DayField, 
+					day.Date.ToString(&quot;MM/dd/yyyy&quot;), 
+					day.Date.AddDays(1).ToString
+(&quot;MM/dd/yyyy&quot;)
+					);
+
+                                
+				// are there events on this day?
+				if (dv.Count &gt; 0) 
+				{
+					// there are events on this day; 
+if indicated, 
+					// apply the DayWithEventsStyle to 
+the table cell
+					if(day.Date == this.SelectedDate)
+					{
+						if (this._currentDayStyle !
+= null) 
+						{
+						
+							cell.ApplyStyle
+(this._currentDayStyle);
+						}
+
+					}
+					else
+					{
+						if 
+(this.DayWithEventsStyle != null) 
+							cell.ApplyStyle
+(this.DayWithEventsStyle);
+					}
+                    
+					// for each event on this day 
+apply the
+					// ItemTemplate, with data bound 
+to the item's row
+					// from the data source
+					if (this.ItemTemplate != null)
+						for (int i=0; i&lt;dv.Count; 
+i++) 
+						{
+							SetupCalendarItem
+(cell, dv[i].Row, this.ItemTemplate);
+						}              
+
+				} 
+				else 
+				{
+					// no events this day;
+					if(day.Date == this.SelectedDate)
+					{
+						if (this._currentDayStyle !
+= null) 
+						{
+							
+							cell.ApplyStyle
+(this._currentDayStyle);
+						}
+					}
+					else
+					{
+						if (this.NoEventsTemplate !
+= null)
+							SetupCalendarItem
+(cell, null, this.NoEventsTemplate);
+					}
+                        
+				}                
+                  
+			}            
+            
+			// call the base render method too
+
+			//  Joe Audette Note: Commenting this out does not 
+change the behaviour under windows
+			// it still works as expected
+			base.OnDayRender(cell, day);
+            
+		}                
+        
+		protected override void Render(HtmlTextWriter html)
+		{
+			_dtSource = null;
+
+			if (this.DataSource != null &amp;&amp; this.DayField != 
+null) 
+			{
+				// determine if the datasource is a 
+DataSet or DataTable
+				if (this.DataSource is DataTable) 
+					_dtSource = (DataTable) 
+this.DataSource;                
+				if (this.DataSource is DataSet)
+				{
+					DataSet ds = (DataSet) 
+this.DataSource;
+					if (this.DataMember == null || 
+this.DataMember == &quot;&quot;)
+						// if data member isn't 
+supplied, default to the first table
+						_dtSource = ds.Tables[0];
+					else
+						// if data member is 
+supplied, use it
+						_dtSource = ds.Tables
+[this.DataMember];                        
+				}
+				// throw an exception if there is a 
+problem with the data source
+				if (_dtSource == null)
+					throw new Exception(&quot;Error finding 
+the DataSource.  Please check &quot; +
+						&quot; the DataSource and 
+DataMember properties.&quot;);
+			}                    
+
+			// call the base Calendar's Render method
+			// allowing OnDayRender() to be executed
+			base.Render(html);
+		}
+           
+    
+	}
+    
+}

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="027888.html">[Mono-bugs] [Bug 74717][Nor] New - [GMCS] SerializableAttribute added for all enums
</A></li>
	<LI> Next message: <A HREF="027891.html">[Mono-bugs] [Bug 74713][Maj] Changed - System.IO.IOException: Invalid handle to path &quot;/tmp/tmp4d062ea3&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27889">[ date ]</a>
              <a href="thread.html#27889">[ thread ]</a>
              <a href="subject.html#27889">[ subject ]</a>
              <a href="author.html#27889">[ author ]</a>
         </LI>
       </UL>
</body></html>
