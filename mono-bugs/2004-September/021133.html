<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="021132.html">
   <LINK REL="Next"  HREF="021134.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Fri, 24 Sep 2004 08:30:33 -0400 (EDT)</I>
    <P><UL>
        <LI> Previous message: <A HREF="021132.html">[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
</A></li>
        <LI> Next message: <A HREF="021134.html">[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21133">[ date ]</a>
              <a href="thread.html#21133">[ thread ]</a>
              <a href="subject.html#21133">[ subject ]</a>
              <a href="author.html#21133">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:ed@catmur.co.uk.">ed@catmur.co.uk.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=60576">http://bugzilla.ximian.com/show_bug.cgi?id=60576</A>

--- shadow/60576	2004-09-24 08:06:18.000000000 -0400
+++ shadow/60576.tmp.384	2004-09-24 08:30:33.000000000 -0400
@@ -633,6 +633,46 @@
 other was originally created by a ximianite, which should lend some
 extra credulity to it (it seems we need that).
 
 ------- Additional Comments From <A HREF="mailto:dick@ximian.com">dick@ximian.com</A>  2004-09-24 08:06 -------
 Don't mark it a dup just yet.
 
+
+------- Additional Comments From <A HREF="mailto:ed@catmur.co.uk">ed@catmur.co.uk</A>  2004-09-24 08:30 -------
+More info:
+
+GC_thread_exit_proc() (libgc/pthread_support.c) is not getting called
+when threads exit. At all. As a result, although the thread in
+question has exited, it remains in the libgc thread table (GC_threads[]).
+
+If that were all then we'd be OK as the thread (which is dead) is not
+signalable so pthread_kill() returns ESRCH and the n_live_threads in
+GC_suspend_all() (libgc/pthread_stop_world.c) is decremented so the
+number of semaphores expected equals the number of threads alive to
+post them.
+
+However, what can happen is that pthread reuses that thread ID, and so
+the pthread_kill() in GC_suspend_all() succeeds multiple times on the
+same thread; however the thread only handles one signal and so the
+semaphore is posted fewer times than expected, leading to semaphore lock.
+
+This suggests a hack:
+
+--- libgc/pthread_support.c     2004-09-06 19:06:56.000000000 +0100
++++ libgc/pthread_support.c     2004-09-24 12:48:23.621325151 +0100
+@@ -603,6 +603,11 @@ GC_thread GC_new_thread(pthread_t id)
+     GC_thread result;
+     static GC_bool first_thread_used = FALSE;
+
++    for (result = GC_threads[hv]; result; result = result-&gt;next)
++           if (pthread_equal(result-&gt;id, id)) {
++                   WARN(&quot;Thread 0x%lx already in table!&quot;, id);
++                   return result;
++           }
+     if (!first_thread_used) {
+        result = &amp;first_thread;
+        first_thread_used = TRUE;
+
+This indeed makes the test case run OK. So, now the question is why
+GC_thread_exit_proc is not getting called (it is set as a
+pthread_cleanup_push function) even though the (nptl) pthread library
+thinks the thread has exited.

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="021132.html">[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
</A></li>
	<LI> Next message: <A HREF="021134.html">[Mono-bugs] [Bug 60576][Maj] Changed - Bad interaction - Mono, Gentoo (nptl) &amp; Muine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21133">[ date ]</a>
              <a href="thread.html#21133">[ thread ]</a>
              <a href="subject.html#21133">[ subject ]</a>
              <a href="author.html#21133">[ author ]</a>
         </LI>
       </UL>
</body></html>
