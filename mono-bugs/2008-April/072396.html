<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20381559%5D%20trivially%20simple%20reproduction%20of%20Invalid%0A%20IL%20code%20bug%20%28%20anonymous%20methods%20%2B%20string%20concat%29&In-Reply-To=bug-381559-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="072395.html">
   <LINK REL="Next"  HREF="072762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20381559%5D%20trivially%20simple%20reproduction%20of%20Invalid%0A%20IL%20code%20bug%20%28%20anonymous%20methods%20%2B%20string%20concat%29&In-Reply-To=bug-381559-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Apr 18 21:25:24 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="072395.html">[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)
</A></li>
        <LI>Next message: <A HREF="072762.html">[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#72396">[ date ]</a>
              <a href="thread.html#72396">[ thread ]</a>
              <a href="subject.html#72396">[ subject ]</a>
              <a href="author.html#72396">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=381559">https://bugzilla.novell.com/show_bug.cgi?id=381559</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">zorander at gmail.com</A> added comment
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=381559#c2">https://bugzilla.novell.com/show_bug.cgi?id=381559#c2</A>





--- Comment #2 from Brian Luczkiewicz &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">zorander at gmail.com</A>&gt;  2008-04-18 19:25:22 MST ---
There are actually two problems here..

  IL_0019:  ldloc.0
  IL_001a:  dup
  IL_001b:  ldc.i4.5
  IL_001c:  newarr     [mscorlib]System.Object
  IL_0021:  dup
  IL_0022:  ldc.i4.0
****************
missing object load here!
****************
  IL_0023:  ldfld      string Fail/'&lt;&gt;c__CompilerGenerated0'::'&lt;1:a&gt;'

In addition to the 'missing object load here', there is an &quot;extra&quot; reference to
the closure state sitting on the stack from the dup at IL_001a that never gets
used (just adding ldloc causes a different IL failure on the ret from the
method as a result of this). 

This only gets generated when Variable.HasInstance is true (which seems only
true for generated closure variables when prepare_for_load is true in
EmitAssign). The purpose of prepare_for_load is to protect against
double-evaluation of the lhs of the assignment, but double-evaluation is not
harmful for closure state since they are simple locals references and have no
side effects.

The dup breaks the auto-generation of arrays for StringConcat nodes when #
nodes &gt; 3 (due to matching the params object[] overload of String.Concat). It
does no harm when the next operation is a ldfld (e.g. for the simple
String.Concat cases where no array is generated).

This solution is probably not totally ideal since it always does ldloc twice on
the closure state object in compound assignments even when dup could have been
used with no troubles.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="072395.html">[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)
</A></li>
	<LI>Next message: <A HREF="072762.html">[Mono-bugs] [Bug 381559] trivially simple reproduction of Invalid IL code bug ( anonymous methods + string concat)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#72396">[ date ]</a>
              <a href="thread.html#72396">[ thread ]</a>
              <a href="subject.html#72396">[ subject ]</a>
              <a href="author.html#72396">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
