<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 384723] New: Dictionary prevents GC
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20384723%5D%20New%3A%20Dictionary%20prevents%20GC&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="072962.html">
   <LINK REL="Next"  HREF="072970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 384723] New: Dictionary prevents GC</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20384723%5D%20New%3A%20Dictionary%20prevents%20GC&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 384723] New: Dictionary prevents GC">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Apr 29 07:51:18 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="072962.html">[Mono-bugs] [Bug 367490] Menu: a wide Menu is drawn off screen edge
</A></li>
        <LI>Next message: <A HREF="072970.html">[Mono-bugs] [Bug 384723] Dictionary prevents GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#72967">[ date ]</a>
              <a href="thread.html#72967">[ thread ]</a>
              <a href="subject.html#72967">[ subject ]</a>
              <a href="author.html#72967">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=384723">https://bugzilla.novell.com/show_bug.cgi?id=384723</A>


           Summary: Dictionary prevents GC
           Product: Mono: Class Libraries
           Version: 1.9.0
          Platform: Other
        OS/Version: Mac OS X 10.4
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: System
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jesjones at mindspring.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Unlike System.Collections.Generic.List System.Collections.Generic.Dictionary
does not zero out elements when they are removed or when the collection is
cleared. Instead Dictionary merely marks the corresponding slot as unused. 

This is pretty bad because it means the default conservative garbage collector
in mono 1.9 will think that there is still a reference to the cleared objects
and prevent them from being collected. They will only be collected when the
slot is reused.

Here's a test case:

// compile with: gmcs -out:app.exe -target:exe Dictionary.cs
using System;
using System.Collections.Generic;
using System.Threading;

// With mono 1.9 I get the following output:
//    removed an item from the dict, but delta is 0
//    cleared the dict, but delta is 0

internal class Item
{        
    ~Item()
    {
        --ms_instanceCount;
    }

    public Item()
    {
        ++ms_instanceCount;
    }

    public static int Count
    {
        get {return ms_instanceCount;}
    }

    private static int ms_instanceCount;
}

internal class Program
{    
    private static void Main()
    {
        TestList();        
        TestDict();

        ForceCollect();
        MyAssert(Item.Count == 0, &quot;finished but count is &quot; + Item.Count);

        if (!ms_failed)
            Console.WriteLine(&quot;passed&quot;);
    }

    private static void TestList()
    {        
        List&lt;Item&gt; l = new List&lt;Item&gt;();

        int initial = Item.Count;
        l.Add(new Item());
        l.Add(new Item());
        l.Add(new Item());
        ForceCollect();
        MyAssert(Item.Count == initial + 3, &quot;added 3 items to a list, but delta
is &quot; + (Item.Count - initial));

        initial = Item.Count;
        l.RemoveAt(0);
        ForceCollect();
        MyAssert(Item.Count == initial - 1, &quot;removed an item from the list, but
delta is &quot; + (Item.Count - initial));

        initial = Item.Count;
        l.Clear();
        ForceCollect();
        MyAssert(Item.Count == initial - 2, &quot;cleared the list, but delta is &quot; +
(Item.Count - initial));
    }

    private static void TestDict()
    {        
        Dictionary&lt;int, Item&gt; d = new Dictionary&lt;int, Item&gt;();

        int initial = Item.Count;
        d.Add(1, new Item());
        d.Add(2, new Item());
        d.Add(3, new Item());
        ForceCollect();
        MyAssert(Item.Count == initial + 3, &quot;added 3 items to a dict, but delta
is &quot; + (Item.Count - initial));

        initial = Item.Count;
        d.Remove(2);
        ForceCollect();
        MyAssert(Item.Count == initial - 1, &quot;removed an item from the dict, but
delta is &quot; + (Item.Count - initial));

        initial = Item.Count;
        d.Clear();
        ForceCollect();
        MyAssert(Item.Count == initial - 2, &quot;cleared the dict, but delta is &quot; +
(Item.Count - initial));
    }

    private static void ForceCollect()
    {
        System.GC.Collect();
        Thread.Sleep(200);        // note that we need to sleep to allow the
finalizer thread to kick in
   }

    private static void MyAssert(bool p, string s)
    {
        if (!p)
        {
            Console.WriteLine(s);
            ms_failed = true;
        }
    }

    private static bool ms_failed;
}


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="072962.html">[Mono-bugs] [Bug 367490] Menu: a wide Menu is drawn off screen edge
</A></li>
	<LI>Next message: <A HREF="072970.html">[Mono-bugs] [Bug 384723] Dictionary prevents GC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#72967">[ date ]</a>
              <a href="thread.html#72967">[ thread ]</a>
              <a href="subject.html#72967">[ subject ]</a>
              <a href="author.html#72967">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
