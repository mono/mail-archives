<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 321325] SSL re-negotiation failure with Postgres
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20321325%5D%20SSL%20re-negotiation%20failure%20with%20Postgres&In-Reply-To=bug-321325-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="083637.html">
   <LINK REL="Next"  HREF="083644.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 321325] SSL re-negotiation failure with Postgres</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20321325%5D%20SSL%20re-negotiation%20failure%20with%20Postgres&In-Reply-To=bug-321325-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 321325] SSL re-negotiation failure with Postgres">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Dec 22 07:43:39 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="083637.html">[Mono-bugs] [Bug 438886] Mono 2.0.1 Windows.Form crashes (Windows	only)
</A></li>
        <LI>Next message: <A HREF="083644.html">[Mono-bugs] [Bug 333891] CS0122 error when accessing member hidden by non-accessible member
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#83642">[ date ]</a>
              <a href="thread.html#83642">[ thread ]</a>
              <a href="subject.html#83642">[ subject ]</a>
              <a href="author.html#83642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=321325">https://bugzilla.novell.com/show_bug.cgi?id=321325</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">laurenz.albe at wien.gv.at</A> added comment
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=321325#c1">https://bugzilla.novell.com/show_bug.cgi?id=321325#c1</A>


Laurenz Albe &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">laurenz.albe at wien.gv.at</A>&gt; changed:

           What    |Removed                                         |Added
----------------------------------------------------------------------------
                 CC|                                                |<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">laurenz.albe at wien.gv.at</A>
             Status|NEEDINFO                                        |ASSIGNED
      Info Provider|<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mfarr at paradise.net.nz</A>                           |




--- Comment #1 from Laurenz Albe &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">laurenz.albe at wien.gv.at</A>&gt;  2008-12-22 05:43:37 MST ---
I can reproduce the bug with Npgsql 2.0.2 with Mono 2.0.1 against PostgreSQL
8.3.5 with OpenSSL 0.9.7a, and I can provide more information.
Unfortunately my understanding of Mono, C# and SSL/TLS is not sufficient that I
can fix the bug.

Maybe somebody can give me a hand?

Here is what I find:

PostgreSQL uses OpenSSL for handling encrypted connections.

After a certain number of bytes transferred (0.5 GB by default), PostgreSQL
will initialize a renegotiation.
OpenSSL sends an encrypted &quot;Hello Request&quot; message to the client.
The decrypted TLS 1.0 Handshake Message looks as follows:

Byte  0   0x00       Hello Request
Bytes 1-3 0x000000   Length of following data

The following ensues in Mono.Security.dll in namespace
Mono.Security.Protocol.Tls:

In class RecordProtocol, method &quot;InternalReceiveRecordCallback&quot; is entered.
The message is duly decrypted and the message type is identified as
ContentType.Handshake.

Method &quot;ProcessHandshakeMessage&quot; in class ClientRecordProtocol is entered.
Variable &quot;length&quot; is read from the input data and becomes 0.
Variable &quot;data&quot; remains null.

Method &quot;createServerHandshakeMessage&quot; in class ClientRecordProtocol is entered.
In the ClientContext, HandshakeState is set to None.

Control returns to method &quot;ProcessHandshakeMessage&quot;, and in the ClientContext,
LastHandshakeMsg is set to HelloRequest.

Then control returns to &quot;InternalReceiveRecordCallback&quot;, and
internalResult.SetComplete is called with the buffer containing the four zero
bytes.

Now somehow, in a way I do not understand, these four bytes are not, as they
should be, discarded, but are returned to the client reading from the
Mono.Security.Protocol.Tls.SslClientStream.

These four zero bytes, which are part of the SSL protocol, but *not* of the
database client-server protocol, cause the problem.
If the client ignores these bytes, SSL renegotiation continues normally, and
work can continue.

It seems that the solution would be to keep the Hello Request in the SSL layer
where it belongs.

Where and how should this be fixed?


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>





































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="083637.html">[Mono-bugs] [Bug 438886] Mono 2.0.1 Windows.Form crashes (Windows	only)
</A></li>
	<LI>Next message: <A HREF="083644.html">[Mono-bugs] [Bug 333891] CS0122 error when accessing member hidden by non-accessible member
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#83642">[ date ]</a>
              <a href="thread.html#83642">[ thread ]</a>
              <a href="subject.html#83642">[ subject ]</a>
              <a href="author.html#83642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
