<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 573312] New: mono compiler compiles struct in fixed block wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20573312%5D%20New%3A%20mono%20compiler%20compiles%20struct%20in%0A%20fixed%20block%20wrong%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="096817.html">
   <LINK REL="Next"  HREF="096819.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 573312] New: mono compiler compiles struct in fixed block wrong?</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20573312%5D%20New%3A%20mono%20compiler%20compiles%20struct%20in%0A%20fixed%20block%20wrong%3F&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 573312] New: mono compiler compiles struct in fixed block wrong?">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Jan 23 15:01:03 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="096817.html">[Mono-bugs] [Bug 471912] Prefer TryParse over Parse
</A></li>
        <LI>Next message: <A HREF="096819.html">[Mono-bugs] [Bug 573312] mono compiler compiles struct in fixed	block wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96818">[ date ]</a>
              <a href="thread.html#96818">[ thread ]</a>
              <a href="subject.html#96818">[ subject ]</a>
              <a href="author.html#96818">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=573312">http://bugzilla.novell.com/show_bug.cgi?id=573312</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=573312#c0">http://bugzilla.novell.com/show_bug.cgi?id=573312#c0</A>


           Summary: mono compiler compiles struct in fixed block wrong?
    Classification: Mono
           Product: Mono: Compilers
           Version: 2.6.x
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">post-christian at freenet.de</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
                CC: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">post-christian at freenet.de</A>
          Found By: ---
           Blocker: ---


Description of Problem:

The structures in the code below get different values in fixed block. It does
not occur when the script is compiled with the Microsoft .Net compiler.

Steps to reproduce the problem:

using System;
using System.Collections.Generic;
using System.Runtime.InteropServices;

class FixedTest
{
    [StructLayout( LayoutKind.Explicit )]
    public unsafe struct Value
    {
        [FieldOffset( 0 )]
        public void* p;
        [FieldOffset( 0 )]
        public double n;
        [FieldOffset( 0 )]
        public long i;
        [FieldOffset( 0 )]
        public bool b;
    }

    public enum ValueType
    {
        Null = 0,
        Boolean = 1,
        Integer = 2,
        Float = 3,
    }

    [StructLayout( LayoutKind.Explicit, Pack = 4 )]
    public unsafe struct TValue
    {
        public Value value;
        public ValueType type;

        public TValue( long x ) {
            value = new Value();
            value.i = x;
            type = ValueType.Integer;
        }

        public TValue( double x ) {
            value = new Value();
            value.n = x;
            type = ValueType.Float;
        }

        public TValue( bool x ) {
            value = new Value();
            value.b = x;
            type = ValueType.Boolean;
        }

        public override string ToString() {
            switch( type ) {
            case ValueType.Null:
                return &quot;(null)&quot;;
            case ValueType.Integer:
                return &quot;(int) &quot; + value.i.ToString();
            case ValueType.Float:
                return &quot;(float) &quot; + value.n.ToString();
            case ValueType.Boolean:
                return &quot;(bool) &quot; + (value.b ? &quot;True&quot; : &quot;False&quot;);
            }
            return base.ToString();
        }

    }

    public static unsafe void Main( string[] arg ) {
        TValue[] values = new TValue[10];
        values[0] = new TValue( 0L );
        values[1] = new TValue( 1000L );
        values[2] = new TValue( 1L );
        Console.WriteLine( &quot;values: {0} {1} {2}&quot;, values[0], values[1],
values[2] );
        fixed( TValue* vals = values ) {
            Console.WriteLine( &quot;fixed: {0} {1} {2}&quot;, vals[0], vals[1], vals[2]
);
        }
    }
}


Actual Results:

values: (int) 0 (int) 1000 (int) 1
fixed: (int) 0 (int) 1000 (int) 1000


Expected Results:

values: (int) 0 (int) 1000 (int) 1
fixed: (int) 0 (int) 1000 (int) 1

How often does this happen? 

every time

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="096817.html">[Mono-bugs] [Bug 471912] Prefer TryParse over Parse
</A></li>
	<LI>Next message: <A HREF="096819.html">[Mono-bugs] [Bug 573312] mono compiler compiles struct in fixed	block wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96818">[ date ]</a>
              <a href="thread.html#96818">[ thread ]</a>
              <a href="subject.html#96818">[ subject ]</a>
              <a href="author.html#96818">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
