<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 571010] New: using(){} with structs shouldn't box to invoke explicitly implemented IDisposable.Dispose method
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20571010%5D%20New%3A%20using%28%29%7B%7D%20with%20structs%20shouldn%27t%20box%0A%20to%20invoke%20explicitly%20implemented%20IDisposable.Dispose%20method&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="096523.html">
   <LINK REL="Next"  HREF="096530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 571010] New: using(){} with structs shouldn't box to invoke explicitly implemented IDisposable.Dispose method</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20571010%5D%20New%3A%20using%28%29%7B%7D%20with%20structs%20shouldn%27t%20box%0A%20to%20invoke%20explicitly%20implemented%20IDisposable.Dispose%20method&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 571010] New: using(){} with structs shouldn't box to invoke explicitly implemented IDisposable.Dispose method">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Jan 15 12:06:11 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="096523.html">[Mono-bugs] [Bug 536816] textfield.Ended doesn't fire unless textfield.AllEditingEvents also 'wired up'
</A></li>
        <LI>Next message: <A HREF="096530.html">[Mono-bugs] [Bug 571131] New: Build fails only on 64bit xen instance with illegal operation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96528">[ date ]</a>
              <a href="thread.html#96528">[ thread ]</a>
              <a href="subject.html#96528">[ subject ]</a>
              <a href="author.html#96528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=571010">http://bugzilla.novell.com/show_bug.cgi?id=571010</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=571010#c0">http://bugzilla.novell.com/show_bug.cgi?id=571010#c0</A>


           Summary: using(){} with structs shouldn't box to invoke
                    explicitly implemented IDisposable.Dispose method
    Classification: Mono
           Product: Mono: Compilers
           Version: SVN
          Platform: x86-64
        OS/Version: openSUSE 11.2
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jpryor at novell.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


&gt;<i>From &#167;15.13 (page 248) in:
</I>
  <A HREF="http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-334.pdf">http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-334.pdf</A>

the statement:

  using (ResourceType resource = expression) embedded-statement

should expand to

  {
    ResourceType resource = expression;
    try {
      embedded-statement
    }
    finally {
      ((System.IDisposable)resource).Dispose();
    }
  }

when ResourceType is a value type (struct).  *Additionally*:

  &quot;casting resource to System.IDisposable shall not cause boxing 
  to occur.&quot;

Thus, consider the following program:

    using System;

    struct Foo : IDisposable {
        void IDisposable.Dispose(){}
        public void Dispose() {}
    }

    class Test {
        public static void Main ()
        {
            using (new Foo()) {
            }
        }
    }

Compile:

  $ gmcs us.cs

Disassemble, and check out the IL for Test.Main():

        // Method begins at RVA 0x20fc
        .entrypoint
        // Code size 26 (0x1a)
        .maxstack 2
        .locals init (
                valuetype Foo   V_0)
        IL_0000:  ldloca.s 0
        IL_0002:  initobj Foo
        .try { // 0
          IL_0008:  leave IL_0019

        } // end .try 0
        finally  { // 0
          IL_000d:  ldloc.0 
          IL_000e:  box Foo
          IL_0013:  callvirt instance void class
[mscorlib]System.IDisposable::Dispose()
          IL_0018:  endfinally 
        } // end handler 0
        IL_0019:  ret 

Notice that gmcs IS boxing here.  gmcs isn't following ECMA.

Compare to what .NET CSC does; same source, different IL:

        // Method begins at RVA 0x2058
        .entrypoint
        // Code size 30 (0x1e)
        .maxstack 1
        .locals init (
                valuetype Foo   V_0)
        IL_0000:  nop 
        IL_0001:  ldloca.s 0
        IL_0003:  initobj Foo
        .try { // 0
          IL_0009:  nop 
          IL_000a:  nop 
          IL_000b:  leave.s IL_001c

        } // end .try 0
        finally  { // 0
          IL_000d:  ldloca.s 0
          IL_000f:  constrained. Foo
          IL_0015:  callvirt instance void class
[mscorlib]System.IDisposable::Dispose()
          IL_001a:  nop 
          IL_001b:  endfinally 
        } // end handler 0
        IL_001c:  nop 
        IL_001d:  ret 

Notice that CSC uses a 'constrained. Foo' instead of 'box Foo' to avoid boxing.

gmcs shouldn do likewise to avoid boxing the resource.

(Note that if you don't explicitly implement IDisposable.Dispose(), gmcs will
properly avoid boxing the resource, so this is only an issue for explicitly
implemented IDisposable.Dispose() methods.)

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="096523.html">[Mono-bugs] [Bug 536816] textfield.Ended doesn't fire unless textfield.AllEditingEvents also 'wired up'
</A></li>
	<LI>Next message: <A HREF="096530.html">[Mono-bugs] [Bug 571131] New: Build fails only on 64bit xen instance with illegal operation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96528">[ date ]</a>
              <a href="thread.html#96528">[ thread ]</a>
              <a href="subject.html#96528">[ subject ]</a>
              <a href="author.html#96528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
