<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 574597] New: [Regression?] poor compression in mono 2.6 with System.IO.Compression.GZipStream
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20574597%5D%20New%3A%20%5BRegression%3F%5D%20poor%20compression%20in%0A%20mono%202.6%20with%20System.IO.Compression.GZipStream&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="096968.html">
   <LINK REL="Next"  HREF="096971.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 574597] New: [Regression?] poor compression in mono 2.6 with System.IO.Compression.GZipStream</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20574597%5D%20New%3A%20%5BRegression%3F%5D%20poor%20compression%20in%0A%20mono%202.6%20with%20System.IO.Compression.GZipStream&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 574597] New: [Regression?] poor compression in mono 2.6 with System.IO.Compression.GZipStream">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Jan 27 22:14:15 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="096968.html">[Mono-bugs] [Bug 502115] Xml schema validation: Inconsistent attribute inheritance in mono &lt;-&gt; .net (Patch included)
</A></li>
        <LI>Next message: <A HREF="096971.html">[Mono-bugs] [Bug 574597] [Regression?] poor compression in mono 2.6 with System.IO.Compression.GZipStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96970">[ date ]</a>
              <a href="thread.html#96970">[ thread ]</a>
              <a href="subject.html#96970">[ subject ]</a>
              <a href="author.html#96970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=574597">http://bugzilla.novell.com/show_bug.cgi?id=574597</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=574597#c0">http://bugzilla.novell.com/show_bug.cgi?id=574597#c0</A>


           Summary: [Regression?] poor compression in mono 2.6 with
                    System.IO.Compression.GZipStream
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 1.2.0
          Platform: x86-64
        OS/Version: Linux
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: System
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">htl10 at users.sourceforge.net</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=339278)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=339278">http://bugzilla.novell.com/attachment.cgi?id=339278</A>)
use NO_FLUSH instead of SYNC_FLUSH on compression

User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-GB; rv:1.9.1.6)
Gecko/20100107 Fedora/3.5.6-1.fc12 Firefox/3.5.6

posted to mono-devel and thought I'll file this properly, with some editing:

--- On Wed, 27/1/10, Hin-Tak Leung &lt;&gt; wrote:


&gt;<i> I have a small application which writes gzip'ed data like
</I>&gt;<i> this:
</I>&gt;<i>
</I>&gt;<i> sw = new BinaryWriter(new GZipStream(new
</I>&gt;<i> FileStream(filename,
</I>&gt;<i>       FileMode.Create, FileAccess.Write,
</I>&gt;<i> FileShare.None),
</I>&gt;<i>       CompressionMode.Compress, true
</I>&gt;<i>       );
</I>&gt;<i> sw.Write(...);
</I>&gt;<i> sw.Write(...);
</I>&gt;<i> sw.Flush();
</I>&gt;<i> sw.Close();
</I>&gt;<i>
</I>&gt;<i> It use to work fine with mono 2.4, and still does in a way
</I>&gt;<i> with mono 2.6 .
</I>
.. What happens is that the output file is now a lot larger.

&gt;<i>
</I>&gt;<i> The uncompressed data is 1234127 bytes, and still
</I>&gt;<i> recoverable in a indentical manner from the output with gzip
</I>&gt;<i> -dc; but the output file is now 8126815 bytes with mono
</I>&gt;<i> 2.6.x instead of 282363 bytes under mono 2.4.x 
</I>
....


I found the source of my problem with the poor GZipStream compression with mono
2.6 - it is r138254, which rewrites the gzipstream implementation:

------------------
Author: gonzalo &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">gonzalo at e3ebcda4-bce8-0310-ba0a-eca2169e7518</A>&gt;
Date:   Tue Jul 21 02:25:00 2009 +0000

    2009-07-20 Gonzalo Paniagua Javier &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">gonzalo at novell.com</A>&gt;

        * Makefile.am: replaced zlib_macros.c with zlib-helper.c
        * zlib_macros.c: Removed file.
        * zlib-helper.c: new interface for DeflateStream. Flush() actually
        does something.
------------------

The problem is that this change makes the zlib code compress per each write
(before the change, it buffers by the zlib default, which is trying to compress
per 32k input). Most of my little program culculates and write 1 byte out, so
it is mostly 5-byte zlib header overhead + 1 byte! and the file size is
increased about 6 times.

I have tried and tested this patch, which restore the zlib default to the
compression code to buffer data before compression. With this patch, I can just
replace libMonoPosixHelper.so and get compression behavior similiar to mono
2.4.

So the mono-2.4 behavior and with this patch, 1.2MB data is written out as 280k
; without this patch, mono 2.6 writes 8.1MB out (about x6). Curiously,
Microsoft .Net's runtime's Gzipstream implementation seems to do something
between - it generates a filesize of 2MB, which possibly means it buffers and
compresses by 4-byte chunks, not 1 byte and not 32k. (5-byte overhead + 2-3
bytes after compression).

---------------------
diff --git a/support/zlib-helper.c b/support/zlib-helper.c
index 1d61c3d..f8f1587 100644
--- a/support/zlib-helper.c
+++ b/support/zlib-helper.c
@@ -207,7 +207,7 @@ WriteZStream (ZStream *stream, guchar *buffer, gint length)
             zs-&gt;next_out = stream-&gt;buffer;
             zs-&gt;avail_out = BUFFER_SIZE;
         }
-        status = deflate (stream-&gt;stream, Z_SYNC_FLUSH);
+        status = deflate (stream-&gt;stream, Z_NO_FLUSH);
         if (status != Z_OK &amp;&amp; status != Z_STREAM_END)
             return status;

----------------------

Reproducible: Always

Steps to Reproduce:
1. see skeleton code and description above.
2.
3.
Actual Results:  
data increases in size.

Expected Results:  
data decrease in size.

NO_FLUSH is the default

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="096968.html">[Mono-bugs] [Bug 502115] Xml schema validation: Inconsistent attribute inheritance in mono &lt;-&gt; .net (Patch included)
</A></li>
	<LI>Next message: <A HREF="096971.html">[Mono-bugs] [Bug 574597] [Regression?] poor compression in mono 2.6 with System.IO.Compression.GZipStream
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#96970">[ date ]</a>
              <a href="thread.html#96970">[ thread ]</a>
              <a href="subject.html#96970">[ subject ]</a>
              <a href="author.html#96970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
