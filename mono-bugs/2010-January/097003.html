<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 574842] New: DomainUnload debug events have wrong id during Domain Unload.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20574842%5D%20New%3A%20DomainUnload%20debug%20events%20have%20wrong%0A%20id%20during%20Domain%20Unload.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="097002.html">
   <LINK REL="Next"  HREF="097004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 574842] New: DomainUnload debug events have wrong id during Domain Unload.</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20574842%5D%20New%3A%20DomainUnload%20debug%20events%20have%20wrong%0A%20id%20during%20Domain%20Unload.&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 574842] New: DomainUnload debug events have wrong id during Domain Unload.">bugzilla_noreply at novell.com
       </A><BR>
    <I>Thu Jan 28 13:42:37 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="097002.html">[Mono-bugs] [Bug 555439] TcpClient fails when using 3G (but not	always)
</A></li>
        <LI>Next message: <A HREF="097004.html">[Mono-bugs] [Bug 574842] DomainUnload debug events have wrong id during Domain Unload.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97003">[ date ]</a>
              <a href="thread.html#97003">[ thread ]</a>
              <a href="subject.html#97003">[ subject ]</a>
              <a href="author.html#97003">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=574842">http://bugzilla.novell.com/show_bug.cgi?id=574842</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=574842#c0">http://bugzilla.novell.com/show_bug.cgi?id=574842#c0</A>


           Summary: DomainUnload debug events have wrong id during Domain
                    Unload.
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.6.x
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: debug
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">martin at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lucas.meijer at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US)
AppleWebKit/532.0 (KHTML, like Gecko) Chrome/3.0.195.38 Safari/532.0

When the runtime unloads a domain, it sends out assembly unload events to the
softdebugger. The assembly-&gt;debuggerprotocol_id  hashtable that is used is
stored in the domain, and is already disposed of at this point.

When the runtime then tries to find the id for the assemblyunloadmessage, it
thinks &quot;hey, there is no id for this guy yet. I'll just make a new one&quot;.

Here's a repro.

Add this to debugger-agent.c:

if (event == EVENT_KIND_ASSEMBLY_LOAD || event == EVENT_KIND_ASSEMBLY_UNLOAD)
{
    DEBUG (1, fprintf (log_file, &quot;The debuggerprotocol's id for this assembly
was: %d\n&quot;, get_id (domain, ID_ASSEMBLY, arg)));
}

right after this line:
DEBUG (1, fprintf (log_file, &quot;[%p] Sent event %s, suspend=%d.\n&quot;,
(gpointer)GetCurrentThreadId (), event_to_string (event), suspend_policy));



Then, try to softdebug this program in MonoDevelop:

using System;
using System.Reflection;

namespace SeperateAppDomainTest
{
    class Program
    {
        static void Main(string[] args)
        {
            LoadAssembly();
        }

        public static void LoadAssembly()
        {
            string pathToDll = Assembly.GetExecutingAssembly().CodeBase;
            AppDomainSetup domainSetup = new AppDomainSetup { PrivateBinPath =
pathToDll };
            var newDomain = AppDomain.CreateDomain(&quot;FooBar&quot;, null,
domainSetup);
            ProxyClass c =
(ProxyClass)(newDomain.CreateInstanceFromAndUnwrap(pathToDll,
typeof(ProxyClass).FullName));
            AppDomain.Unload(newDomain);
        }
    }

    public class ProxyClass : MarshalByRefObject { }
}


After the debug session, inspect the soft debugger logfile,   and look for the
id numbers from the load &amp; unload events.
(showing only relevant lines below)

[00001134] Sent event ASSEMBLY_LOAD, suspend=2.
The debuggerprotocol's id for this assembly was: 1

[00001134] Sent event ASSEMBLY_LOAD, suspend=2.
The debuggerprotocol's id for this assembly was: 4

[00001134] Sent event ASSEMBLY_LOAD, suspend=2.
The debuggerprotocol's id for this assembly was: 5

[00002228] Sent event ASSEMBLY_UNLOAD, suspend=2.
The debuggerprotocol's id for this assembly was: 7
[00002228] Suspended.

Notice how the ID for the unload event does not match any of the id's of the
assemblies that were loaded before.




Reproducible: Always

Steps to Reproduce:
see the details
Actual Results:  


Expected Results:

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="097002.html">[Mono-bugs] [Bug 555439] TcpClient fails when using 3G (but not	always)
</A></li>
	<LI>Next message: <A HREF="097004.html">[Mono-bugs] [Bug 574842] DomainUnload debug events have wrong id during Domain Unload.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#97003">[ date ]</a>
              <a href="thread.html#97003">[ thread ]</a>
              <a href="subject.html#97003">[ subject ]</a>
              <a href="author.html#97003">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
