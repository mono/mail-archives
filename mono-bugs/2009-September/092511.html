<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 538406] New: Bad PKCS7 padding exception is thrown when trying to login or recover password under ASP.NET using encrypted passwords and AspSQLProvider.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20538406%5D%20New%3A%20Bad%20PKCS7%20padding%20exception%20is%20thrown%0A%20when%20trying%20to%20login%20or%20recover%20password%20under%20ASP.NET%20using%20encrypted%0A%20passwords%20and%20AspSQLProvider.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="093146.html">
   <LINK REL="Next"  HREF="092512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 538406] New: Bad PKCS7 padding exception is thrown when trying to login or recover password under ASP.NET using encrypted passwords and AspSQLProvider.</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20538406%5D%20New%3A%20Bad%20PKCS7%20padding%20exception%20is%20thrown%0A%20when%20trying%20to%20login%20or%20recover%20password%20under%20ASP.NET%20using%20encrypted%0A%20passwords%20and%20AspSQLProvider.&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 538406] New: Bad PKCS7 padding exception is thrown when trying to login or recover password under ASP.NET using encrypted passwords and AspSQLProvider.">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Sep 11 10:06:29 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="093146.html">[Mono-bugs] [Bug 538404] ArgumentNullException when running precompiled web app in xsp2.
</A></li>
        <LI>Next message: <A HREF="092512.html">[Mono-bugs] [Bug 538406] Bad PKCS7 padding exception is thrown when trying to login or recover password under ASP.NET using encrypted passwords and AspSQLProvider.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92511">[ date ]</a>
              <a href="thread.html#92511">[ thread ]</a>
              <a href="subject.html#92511">[ subject ]</a>
              <a href="author.html#92511">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=538406">http://bugzilla.novell.com/show_bug.cgi?id=538406</A>


           Summary: Bad PKCS7 padding exception is thrown when trying to
                    login or recover password under ASP.NET using
                    encrypted passwords and AspSQLProvider.
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.4.x
          Platform: i686
        OS/Version: Linux
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: Mono.Security
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">spouliot at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">piotr.walat at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.1.2)
Gecko/20090813 Gentoo Firefox/3.5.2

When using Nauckit Postgresql membership provider for asp.net
(<A HREF="http://dev.nauck-it.de/aspsqlprovider/">http://dev.nauck-it.de/aspsqlprovider/</A>) with passwordFormat set to &quot;Encrypted&quot;
whenever you try to login or recover password you get:
System.Security.Cryptography.CryptographicException: Bad PKCS7 padding. Invalid
length XXX.
exception.

The accounts and passwords can be created and inserted into db without
problems. Same setup under MS.NET works fine. I've tried multiple encryption
keys (generated by code shown here: <A HREF="http://support.microsoft.com/kb/312906,">http://support.microsoft.com/kb/312906,</A>
both on ms.net and mono compiled version of generation tool) with no success.


Reproducible: Always

Steps to Reproduce:
1.Create a new ASP.NET MVC (or ASP.NET WebForms) application
2.Download aspsqlprovider (<A HREF="http://dev.nauck-it.de/aspsqlprovider">http://dev.nauck-it.de/aspsqlprovider</A>)
3.Configure web.config for aspsqlprovider: add connection string (pgsql),
configure providers (<A HREF="http://dev.nauck-it.de/aspsqlprovider/wiki/Configuration">http://dev.nauck-it.de/aspsqlprovider/wiki/Configuration</A>).
Make sure following properties of provider are set:
enablePasswordRetrieval=&quot;true&quot; requiresQuestionAndAnswer=&quot;false&quot;
passwordFormat=&quot;Encrypted&quot;
4.Create database with a proper sql schema (script available in aspsqlprovider
package)
5.In Global.asax 's Application_Start method add the  following code:
            const string adminRoleName = &quot;su&quot;;
            const string adminUserName = &quot;su&quot;;
            const string adminPassword = &quot;test123&quot;;

            if (!Roles.RoleExists(adminRoleName))
            {
                Roles.CreateRole(adminRoleName);
            }

            if (Membership.GetUser(adminUserName) == null)
            {
                Membership.CreateUser(adminUserName, adminPassword,
&quot;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">fake at fake.fake.fake.info</A>&quot;);
            }

            if (!Roles.IsUserInRole(adminUserName, adminRoleName))
            {
                Roles.AddUserToRole(adminUserName, adminRoleName);
            }

this will ensure a proper user is created on app start

6. In your HomeController add a new action (under webforms add simmilar logic
to Page_Load in Default.aspx.cs):

public ContentResult Pass()
        {
            ContentResult cr = new ContentResult();
            MembershipUser user = Membership.GetUser(&quot;su&quot;);
            string password=Membership.Provider.GetPassword(&quot;su&quot;,&quot;&quot;);
            cr.Content=password;
            if(String.IsNullOrEmpty(password))
                cr.Content+=&quot;empty pass&quot;;
            return cr;            
        }

7. Navigate to <A HREF="http://yourapplication/Home/Pass">http://yourapplication/Home/Pass</A> to execute password retreival
logic.
Actual Results:  
An exception is raised or &quot;empty password&quot; string is displayed

Expected Results:  
A user's (su) password (test123) should be displayed

Sample keypair:
&lt;machineKey
validationKey=&quot;1C1954DE3B4EFC9A5B0BC70934E7629CF4F5F7F2DC4D5B80117A3633A5B8F14DC55E8838119F800468A0750CB9392FFA1B0DE9751507AAD44ADEC54A68BEF6FF&quot;
decryptionKey=&quot;7E71DB4347B52C3B120A7309F9EBA6B375B852A6C7343AE6&quot;
validation=&quot;SHA1&quot;/&gt;

Sample credentials:
username: su
pass: test123

encrypted password stored in database (Password column):
lCLiXzaxzn5iyHn1gQjjRQ==

stack trace:
System.Security.Cryptography.CryptographicException: Bad PKCS7 padding. Invalid
length 19.
at Mono.Security.Cryptography.SymmetricTransform.ThrowBadPaddingException
(System.Security.Cryptography.PaddingMode,int,int) [0x0005c] in
/var/tmp/portage/dev-lang/mono-2.4.2.3/work/mono-2.4.2.3/mcs/class/corlib/Mono.Security.Cryptography/SymmetricTransform.cs:363
at Mono.Security.Cryptography.SymmetricTransform.FinalDecrypt (byte[],int,int)
[0x001a3] in
/var/tmp/portage/dev-lang/mono-2.4.2.3/work/mono-2.4.2.3/mcs/class/corlib/Mono.Security.Cryptography/SymmetricTransform.cs:515
at Mono.Security.Cryptography.SymmetricTransform.TransformFinalBlock
(byte[],int,int) [0x00034] in
/var/tmp/portage/dev-lang/mono-2.4.2.3/work/mono-2.4.2.3/mcs/class/corlib/Mono.Security.Cryptography/SymmetricTransform.cs:554
at System.Security.Cryptography.RijndaelManagedTransform.TransformFinalBlock
(byte[],int,int) [0x00000] in
/var/tmp/portage/dev-lang/mono-2.4.2.3/work/mono-2.4.2.3/mcs/class/corlib/System.Security.Cryptography/RijndaelManagedTransform.cs:94
at System.Web.Security.MembershipProvider.DecryptPassword (byte[]) [0x00017] in
/var/tmp/portage/dev-lang/mono-2.4.2.3/work/mono-2.4.2.3/mcs/class/System.Web/System.Web.Security/MembershipProvider.cs:123
at NauckIT.PostgreSQLProvider.PgMembershipProvider.UnEncodePassword (string)
[0x00025] in
/home/pwalat/Projects/enctest/AspSQLProvider/src/NauckIT.PostgreSQLProvider/PgMembershipProvider.cs:1429
at NauckIT.PostgreSQLProvider.PgMembershipProvider.GetPassword (string,string)
[0x00159] in
/home/pwalat/Projects/enctest/AspSQLProvider/src/NauckIT.PostgreSQLProvider/PgMembershipProvider.cs:802

Using different password: testpass didnt generate aforementioned exception, but
resulted in GetPassword() method returning null or empty string
(String.IsNullOrEmpty()==true)

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>



































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="093146.html">[Mono-bugs] [Bug 538404] ArgumentNullException when running precompiled web app in xsp2.
</A></li>
	<LI>Next message: <A HREF="092512.html">[Mono-bugs] [Bug 538406] Bad PKCS7 padding exception is thrown when trying to login or recover password under ASP.NET using encrypted passwords and AspSQLProvider.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#92511">[ date ]</a>
              <a href="thread.html#92511">[ thread ]</a>
              <a href="subject.html#92511">[ subject ]</a>
              <a href="author.html#92511">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
