<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 543133] New: P/Invoke fails for out StringBuilder parameter, wrapping .dll with unicode string
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20543133%5D%20New%3A%20P/Invoke%20fails%20for%20out%20StringBuilder%0A%20parameter%2C%20wrapping%20.dll%20with%20unicode%20string&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="093167.html">
   <LINK REL="Next"  HREF="093172.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 543133] New: P/Invoke fails for out StringBuilder parameter, wrapping .dll with unicode string</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20543133%5D%20New%3A%20P/Invoke%20fails%20for%20out%20StringBuilder%0A%20parameter%2C%20wrapping%20.dll%20with%20unicode%20string&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 543133] New: P/Invoke fails for out StringBuilder parameter, wrapping .dll with unicode string">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Sep 30 07:24:26 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="093167.html">[Mono-bugs] [Bug 412469] [FIXED] Disabling enableEventValidation in web.config has no effect
</A></li>
        <LI>Next message: <A HREF="093172.html">[Mono-bugs] [Bug 543133] P/Invoke fails for out StringBuilder parameter, wrapping .dll with unicode string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93169">[ date ]</a>
              <a href="thread.html#93169">[ thread ]</a>
              <a href="subject.html#93169">[ subject ]</a>
              <a href="author.html#93169">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=543133">http://bugzilla.novell.com/show_bug.cgi?id=543133</A>


           Summary: P/Invoke fails for out StringBuilder parameter,
                    wrapping .dll with unicode string
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.4.x
          Platform: 32bit
        OS/Version: Windows XP
            Status: NEW
          Severity: Minor
          Priority: P5 - None
         Component: interop
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">giorgio.tino at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US)
AppleWebKit/532.0 (KHTML, like Gecko) Chrome/3.0.195.21 Safari/532.0

I'm trying to write a method to wrap a native .dll function. Function signature
is something like that:

#define MY_EXPORT blah blah blah
#define MY_RESULT int
#define OUT
#define IN

// A lot of other stuff

MY_EXPORT MY_RESULT my_get_name(OUT unsigned short **name);

the 'name' is a UNICODE string (array of 16bit unicode chars).

The following marshalling DOES NOT work in Mono but works in .NET:

[DllImport(&quot;MyLibrary.dll&quot;, EntryPoint = &quot;my_get_name&quot;)]
public static extern Int32 MyGetName(out StringBuilder name);

this is how I call the method:

StringBuilder name;

Int32 result = MyGetName(out name);

this is the error I get when executing the code:

**
ERROR:marshal.c:6929:emit_marshal_object: assertion failed: (!t-&gt;byref)

This application has requested the Runtime to terminate it in an unusual way.
Please contact the application's support team for more information.

Since it works in .NET but not in Mono, I assume it can be a Mono issue.

Maybe this this is not the correct way of marshalling this kind of data, but is
it correct that mono crashes?

BTW the following marshalling works OK:

[DllImport(&quot;MyLibrary.dll&quot;, EntryPoint = &quot;my_get_name&quot;)]
public static extern Int32 MyGetName(out IntPtr name);

this is how I call the method:

IntPtr pName;

Int32 result = MyGetName(out pName);

string name = Marshal.PtrToStringUni(pName);

Reproducible: Always

Steps to Reproduce:
1. P/Invoke of MY_EXPORT MY_RESULT my_get_name(OUT unsigned short **name) as 
   [DllImport(&quot;MyLibrary.dll&quot;, EntryPoint = &quot;my_get_name&quot;)]
   public static extern Int32 MyGetName(out StringBuilder name);

2. StringBuilder name;
   Int32 result = MyGetName(out name);
Actual Results:  
**
ERROR:marshal.c:6929:emit_marshal_object: assertion failed: (!t-&gt;byref)

This application has requested the Runtime to terminate it in an unusual way.
Please contact the application's support team for more information.


Expected Results:  
StringBuffer contains the requested unicode string

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="093167.html">[Mono-bugs] [Bug 412469] [FIXED] Disabling enableEventValidation in web.config has no effect
</A></li>
	<LI>Next message: <A HREF="093172.html">[Mono-bugs] [Bug 543133] P/Invoke fails for out StringBuilder parameter, wrapping .dll with unicode string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93169">[ date ]</a>
              <a href="thread.html#93169">[ thread ]</a>
              <a href="subject.html#93169">[ subject ]</a>
              <a href="author.html#93169">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
