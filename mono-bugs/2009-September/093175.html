<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 543207] New: Garbage collection breaks Oracle	client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20543207%5D%20New%3A%20Garbage%20collection%20breaks%20Oracle%0A%09client&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="093174.html">
   <LINK REL="Next"  HREF="093177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 543207] New: Garbage collection breaks Oracle	client</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20543207%5D%20New%3A%20Garbage%20collection%20breaks%20Oracle%0A%09client&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 543207] New: Garbage collection breaks Oracle	client">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Sep 30 12:42:02 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="093174.html">[Mono-bugs] [Bug 543206] New: When getting a string regkey which exists but contains no actual value mono on linux returns null instead of Empty String
</A></li>
        <LI>Next message: <A HREF="093177.html">[Mono-bugs] [Bug 543226] New: The mono-x debugger acts differently when run inside the mono-addon environment than outside
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93175">[ date ]</a>
              <a href="thread.html#93175">[ thread ]</a>
              <a href="subject.html#93175">[ subject ]</a>
              <a href="author.html#93175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=543207">http://bugzilla.novell.com/show_bug.cgi?id=543207</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">warren.puziewicz at realtimeworlds.com</A> added comment
<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=543207#c1">http://bugzilla.novell.com/show_bug.cgi?id=543207#c1</A>

           Summary: Garbage collection breaks Oracle client
    Classification: Mono
           Product: Mono: Class Libraries
           Version: SVN
          Platform: x86-64
        OS/Version: RHEL 5
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.Data
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">bnc-blr-team-mono at forge.provo.novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">warren.puziewicz at realtimeworlds.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Created an attachment (id=320503)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=320503">http://bugzilla.novell.com/attachment.cgi?id=320503</A>)
C# program to reproduce error

User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.0; en-GB; rv:1.9.1.3)
Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)

We are building an application on Mono with an Oracle database.  We are
currently using Mono 2.5 built from source in June.  We recently started
testing the most recent build from source, and have discovered an issue between
garbage collection and the Oracle client.   After a number of operations, a
bind parameter will have a few extra bytes of garbage appended.  This does not
happen on the earlier build.  It can be prevented on the latest build if the
environment variable GC_DONT_GC is set.  Below is information on our
environment, a section of an Oracle client side trace file with the bad data
highlighted, code to reproduce the error.

Our platform is:
$ uname -s -r -v -p -i -o
Linux 2.6.18-92.1.13.el5 #1 SMP Wed Sep 24 19:32:05 EDT 2008 x86_64 x86_64
GNU/Linux

(Failure occurs on this version of Mono)
$ mono -V
Mono JIT compiler version 2.5 (/trunk/mono r142988 Wed Sep 30 13:19:23 BST
2009)
Copyright (C) 2002-2008 Novell, Inc and Contributors. www.mono-project.com
        TLS:           __thread
        GC:            Included Boehm (with typed GC and Parallel Mark)
        SIGSEGV:       altstack
        Notifications: epoll
        Architecture:  amd64
        Disabled:      none

(Works fine on this version of Mono)
$ mono -V
Mono JIT compiler version 2.5 (/trunk/mono r137147 Tue Jun 30 14:46:43 BST
2009)
Copyright (C) 2002-2008 Novell, Inc and Contributors. www.mono-project.com
        TLS:           __thread
        GC:            Included Boehm (with typed GC and Parallel Mark)
        SIGSEGV:       altstack
        Notifications: epoll
        Architecture:  amd64
        Disabled:      none

Oracle client libraries are: Instant Client 11.1.0.7.0 (x64)

==== The exception generated ====
Unhandled Exception: System.Data.OracleClient.OracleException: ORA-01722:
invalid number

  at System.Data.OracleClient.Oci.OciStatementHandle.Execute (Boolean nonQuery,
Boolean useAutoCommit, Boolean schemaOnly) [0x00000]
  at System.Data.OracleClient.Oci.OciStatementHandle.ExecuteNonQuery (Boolean
useAutoCommit) [0x00000]
  at System.Data.OracleClient.OracleCommand.ExecuteNonQueryInternal
(System.Data.OracleClient.Oci.OciStatementHandle statement, Boolean
useAutoCommit) [0x00000]
  at System.Data.OracleClient.OracleCommand.ExecuteNonQuery () [0x00000]
  at (wrapper remoting-invoke-with-check)
System.Data.OracleClient.OracleCommand:ExecuteNonQuery ()
  at ADOTest.Program.ExecSQLTest2 (Int32 numRows) [0x00000]
  at ADOTest.Program.Main (System.String[] args) [0x00000]

==== Snippet from Oracle client trace file ====
2009-09-30 14:28:30.013678 : nsbasic_bsd:00 00 00 00 FE 40 49 4E  |....&#254;@IN|
2009-09-30 14:28:30.013696 : nsbasic_bsd:53 45 52 54 20 49 4E 54  |SERT.INT|
2009-09-30 14:28:30.013723 : nsbasic_bsd:4F 20 64 61 74 61 5F 74  |O.data_t|
2009-09-30 14:28:30.013742 : nsbasic_bsd:65 73 74 20 28 63 6F 6C  |est.(col|
2009-09-30 14:28:30.013770 : nsbasic_bsd:5F 6F 6E 65 2C 20 63 6F  |_one,.co|
2009-09-30 14:28:30.013788 : nsbasic_bsd:6C 5F 74 77 6F 2C 20 63  |l_two,.c|
2009-09-30 14:28:30.013806 : nsbasic_bsd:6F 6C 5F 74 68 72 65 65  |ol_three|
2009-09-30 14:28:30.013824 : nsbasic_bsd:29 20 56 41 4C 55 45 53  |).VALUES|
2009-09-30 14:28:30.013842 : nsbasic_bsd:20 28 3A 70 31 2C 0A 20  |.(:p1,..|
2009-09-30 14:28:30.013860 : nsbasic_bsd:3A 70 32 2C 20 3A 70 33  |:p2,.:p3|
2009-09-30 14:28:30.013878 : nsbasic_bsd:29 00 01 00 00 00 01 00  |).......|
[snipped]
2009-09-30 14:28:30.014297 : nsbasic_bsd:00 07 03 31 32 33 04 34  |...123.4| 
&lt;= length of bind var includes the bad byte
2009-09-30 14:28:30.014315 : nsbasic_bsd:35 36 16 03 37 38 39     |56..789 | 
&lt;= extra byte of garbage data

Starting at the 3rd byte of the next to last line:
&#8220;03 31 32 33&#8221; = 3 bytes, values &#8220;123&#8221;
&#8220;04 34 35 36 16&#8221; = 4 bytes, values &#8220;456&#8221; + 1 garbage byte
&#8220;37 38 39&#8221; = 3 bytes, values &#8220;789&#8221;
In this case, the second parameter (value &#8216;456&#8217;) had an extra byte (0x16)
appended.


Reproducible: Always

Steps to Reproduce:
1. Compile attached program using &quot;mcs program.cs -r:System.Data.OracleClient&quot;
2. Create database table using 'create table' statement in header comments of
attached program.
3. mono program.exe 500  -- fails
4. GC_DONT_GC=YES mono program.exe 500  -- successful
Actual Results:  
Unhandled Exception: System.Data.OracleClient.OracleException: ORA-01722:
invalid number

  at System.Data.OracleClient.Oci.OciStatementHandle.Execute (Boolean nonQuery,
Boolean useAutoCommit, Boolean schemaOnly) [0x00000]
  at System.Data.OracleClient.Oci.OciStatementHandle.ExecuteNonQuery (Boolean
useAutoCommit) [0x00000]
  at System.Data.OracleClient.OracleCommand.ExecuteNonQueryInternal
(System.Data.OracleClient.Oci.OciStatementHandle statement, Boolean
useAutoCommit) [0x00000]
  at System.Data.OracleClient.OracleCommand.ExecuteNonQuery () [0x00000]
  at (wrapper remoting-invoke-with-check)
System.Data.OracleClient.OracleCommand:ExecuteNonQuery ()
  at ADOTest.Program.ExecSQLTest2 (Int32 numRows) [0x00000]
  at ADOTest.Program.Main (System.String[] args) [0x00000]


Expected Results:  
Insert 500 rows into database.

Veerapuram Varadhan has sent me a patch that seems to have fixed the issue.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="093174.html">[Mono-bugs] [Bug 543206] New: When getting a string regkey which exists but contains no actual value mono on linux returns null instead of Empty String
</A></li>
	<LI>Next message: <A HREF="093177.html">[Mono-bugs] [Bug 543226] New: The mono-x debugger acts differently when run inside the mono-addon environment than outside
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#93175">[ date ]</a>
              <a href="thread.html#93175">[ thread ]</a>
              <a href="subject.html#93175">[ subject ]</a>
              <a href="author.html#93175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
