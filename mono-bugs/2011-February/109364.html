<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 673828] New: handle_thunk: assertion failed in mini-arm.c when compiling Linq expression
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20673828%5D%20New%3A%20handle_thunk%3A%20assertion%20failed%20in%0A%20mini-arm.c%20when%20compiling%20Linq%20expression&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="109366.html">
   <LINK REL="Next"  HREF="109379.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 673828] New: handle_thunk: assertion failed in mini-arm.c when compiling Linq expression</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20673828%5D%20New%3A%20handle_thunk%3A%20assertion%20failed%20in%0A%20mini-arm.c%20when%20compiling%20Linq%20expression&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 673828] New: handle_thunk: assertion failed in mini-arm.c when compiling Linq expression">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Feb 21 11:17:26 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="109366.html">[Mono-bugs] [Bug 673813] mono-sgen crashes immediately with	segmentation fault
</A></li>
        <LI>Next message: <A HREF="109379.html">[Mono-bugs] [Bug 673828] handle_thunk: assertion failed in mini-arm.c when compiling Linq expression
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#109364">[ date ]</a>
              <a href="thread.html#109364">[ thread ]</a>
              <a href="subject.html#109364">[ subject ]</a>
              <a href="author.html#109364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=673828">https://bugzilla.novell.com/show_bug.cgi?id=673828</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=673828#c0">https://bugzilla.novell.com/show_bug.cgi?id=673828#c0</A>


           Summary: handle_thunk: assertion failed in mini-arm.c when
                    compiling Linq expression
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.8.x
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">clockworksaint at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Description of Problem:

An assertion failure occurs in handle_thunk in mini-arm.c while compiling a
Linq expression. This only happens if the JIT is attempting to patch a branch
instruction in a code chunk with an address &gt;32MiB distant from all the code
chunks owned by the main code manager in the domain. Only code chunks in the
main code manager are searched when trying to find a suitable slot in a thunk
table. 


Steps to reproduce the problem:

1. Create Crasher.cs as follows:

using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;

public static class Program
{
    static void Main()
    {
        Console.WriteLine(&quot;start&quot;);
        List&lt;Func&lt;int&gt;&gt; delegates = new List&lt;Func&lt;int&gt;&gt;();
        for (int i=0; i!=20000; ++i)
        {
            Console.WriteLine(&quot;Iteration #{0}&quot;, i);
            int copy_of_i = i;
            Expression&lt;Func&lt;int&gt;&gt; expr = () =&gt; copy_of_i;
            delegates.Add(expr.Compile());
        }
    }
}

2. gmcs Crasher.cs
3. mono Crasher.exe


Actual Results:

start
Iteration #1
..
Iteration #6087
Iteration #6088
Iteration #6089
thunk failed for 0x404ddc80 from 0x42e0950c
**
ERROR:mini-arm.c:2579:handle_thunk: assertion failed: (pdata.found == 1)
Stacktrace:

  at (wrapper managed-to-native) System.Delegate.CreateDelegate_internal
(System.Type,object,System.Reflection.MethodInfo,bool) &lt;0xffffffff&gt;
  at System.Delegate.CreateDelegate
(System.Type,object,System.Reflection.MethodInfo,bool) &lt;0x006c0&gt;
  at System.Delegate.CreateDelegate
(System.Type,object,System.Reflection.MethodInfo) &lt;0x0002f&gt;
  at System.Reflection.Emit.DynamicMethod.CreateDelegate (System.Type,object)
&lt;0x0003f&gt;
  at System.Linq.Expressions.EmitContext.CreateDelegate
(System.Runtime.CompilerServices.ExecutionScope) &lt;0x0003f&gt;
  at System.Linq.Expressions.CompilationContext.CreateDelegate
(int,System.Runtime.CompilerServices.ExecutionScope) &lt;0x00043&gt;
  at System.Linq.Expressions.CompilationContext.CreateDelegate () &lt;0x0003f&gt;
  at System.Linq.Expressions.LambdaExpression.Compile () &lt;0x00053&gt;
  at System.Linq.Expressions.Expression`1&lt;object&gt;.Compile () &lt;0x0001b&gt;
  at Program.Main () &lt;0x00103&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void
(object,intptr,intptr,intptr) &lt;0x0006b&gt;

Native stacktrace:


Debug info from gdb:

[Thread debugging using libthread_db enabled]
[New Thread 0x40d35470 (LWP 28978)]
0x401311a4 in read () from /lib/libpthread.so.0
  2 Thread 0x40d35470 (LWP 28978)  0x4012fed8 in sem_wait@@GLIBC_2.4 () from
/lib/libpthread.so.0
* 1 Thread 0x40365000 (LWP 28977)  0x401311a4 in read () from
/lib/libpthread.so.0

Thread 2 (Thread 0x40d35470 (LWP 28978)):
#0  0x4012fed8 in sem_wait@@GLIBC_2.4 () from /lib/libpthread.so.0
#1  0x0017dfc8 in mono_sem_wait ()
#2  0x0010139c in ?? ()
#3  0x0010139c in ?? ()
Backtrace stopped: previous frame identical to this frame (corrupt stack?)

Thread 1 (Thread 0x40365000 (LWP 28977)):
#0  0x401311a4 in read () from /lib/libpthread.so.0
#1  0x40131194 in read () from /lib/libpthread.so.0
Backtrace stopped: previous frame identical to this frame (corrupt stack?)

=================================================================
Got a SIGABRT while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries
used by your application.
=================================================================

Aborted



Expected Results:

No assertion. With sufficient memory, the test program should run to
completion.


How often does this happen? 

This program fails reliably for me at Iteration #6089 on Mono 2.6.7 and #6060
on Mono 2.8.2.

Additional Information:

$ uname -a
Linux sheeva003 2.6.35.9 #8 PREEMPT Wed Jan 26 14:57:57 GMT 2011 armv5tel
GNU/Linux

The device is a Sheevaplug running Debian Squeeze.

The test code here triggers the problem by simply keeping alive all the
dynamically compiled delegates - eventually a code chunk is bound to be
allocated at a sufficiently distant address to trigger the problem. When I
first encountered this bug it was not in such contrived code - there was no
great quantity of dynamically generated code being deliberately kept alive so
long. It seems that the problem was encountered more quickly because a native
library was allocating its own memory, but it was not an easily reduced repro.
The dynamic code was being generated by the Moq library, but it should
generally have been short-lived.

&gt;<i>From what I can tell, the root cause of the problem is that the *only* thunk
</I>table guaranteed to be in range for a given instruction is the one that resides
in the same code chunk, but in the case of dynamically generated code it is not
considered as an option. I'm not sure if just considering it would be enough to
fix the problem - in this case the thunk table is only 32 bytes in size, large
enough for only two entries. (Each entry is 12 bytes.) I don't know how easy it
would be to exhaust those entries.

See also my discussion of this on the mono-devel mailing list:

<A HREF="http://lists.ximian.com/pipermail/mono-devel-list/2011-February/036973.html">http://lists.ximian.com/pipermail/mono-devel-list/2011-February/036973.html</A>

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>















































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="109366.html">[Mono-bugs] [Bug 673813] mono-sgen crashes immediately with	segmentation fault
</A></li>
	<LI>Next message: <A HREF="109379.html">[Mono-bugs] [Bug 673828] handle_thunk: assertion failed in mini-arm.c when compiling Linq expression
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#109364">[ date ]</a>
              <a href="thread.html#109364">[ thread ]</a>
              <a href="subject.html#109364">[ subject ]</a>
              <a href="author.html#109364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
