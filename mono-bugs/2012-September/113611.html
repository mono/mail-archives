<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 781683] New: Mono.Security.Cryptography RijndaelManaged class issue using CFB-8 mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=Re%3A%20%5BMono-bugs%5D%20%5BBug%20781683%5D%20New%3A%20Mono.Security.Cryptography%0A%20RijndaelManaged%20class%20issue%20using%20CFB-8%20mode&In-Reply-To=%3Cbug-781683-28286%40http.bugzilla.novell.com/%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="113610.html">
   <LINK REL="Next"  HREF="113612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 781683] New: Mono.Security.Cryptography RijndaelManaged class issue using CFB-8 mode</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=Re%3A%20%5BMono-bugs%5D%20%5BBug%20781683%5D%20New%3A%20Mono.Security.Cryptography%0A%20RijndaelManaged%20class%20issue%20using%20CFB-8%20mode&In-Reply-To=%3Cbug-781683-28286%40http.bugzilla.novell.com/%3E"
       TITLE="[Mono-bugs] [Bug 781683] New: Mono.Security.Cryptography RijndaelManaged class issue using CFB-8 mode">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Sep 22 20:48:31 UTC 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="113610.html">[Mono-bugs] [Bug 642631] System.Drawing.Icon should recalculate the ImageOffset when the specified ico file has 256x256 image.
</A></li>
        <LI>Next message: <A HREF="113612.html">[Mono-bugs] [Bug 781683] Mono.Security.Cryptography RijndaelManaged class issue using CFB-8 mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#113611">[ date ]</a>
              <a href="thread.html#113611">[ thread ]</a>
              <a href="subject.html#113611">[ subject ]</a>
              <a href="author.html#113611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=781683">https://bugzilla.novell.com/show_bug.cgi?id=781683</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=781683#c0">https://bugzilla.novell.com/show_bug.cgi?id=781683#c0</A>


           Summary: Mono.Security.Cryptography RijndaelManaged class issue
                    using CFB-8 mode
    Classification: Mono
           Product: MonoTouch
           Version: unspecified
          Platform: All
        OS/Version: Windows 7
            Status: NEW
          Severity: Critical
          Priority: P5 - None
         Component: Class Libraries
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">frego at suse.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">netmonitoring at mail.ru</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows NT 6.1; rv:15.0) Gecko/20100101
Firefox/15.0.1

Hi.

I'm writing to report about cryptography issue. The problem happens using
RijndaelManaged class from the System.Security.Cryptography. It is important
for me to use RijndaelManaged with CFB-8 (FeedbackSize = 8) mode without
padding (PaddingMode.None). Such settings configuration makes encrypted data
size equal to the decrypted data size (in my situation it is important).
Unfortunately mono [in my pc it is mono compiler for MVS2010 IDE version
2.0.8152] compiled code throws exception on data encryption with message:
[Unhandled Exception: System.Security.Cryptography.CryptographicException:
invalid block length at
Mono.Security.Cryptography.SymmetricTransform.FinalEncrypt]. Also i made tests
with the .NET framework 4.0 under Windows XP and Windows 7 using native Visual
Studio 2010 compiler and found that microsoft compiler does not throw any
exceptions and the code example works well using native .NET compiler. What is
the problem with mono compiler, why exception rise? Below i paste two examples
(repro code), one for mono which throws exceptions and one for native C#
compiler in this case there are no exceptions. Also i paste online compilers
links to test the codes.

Also i have found that if data which will be encrypted has length which is
devided by 16 then exception does not rise. But in my case i have set
FeedBackSize to 8 (1 byte), so with such setting there should not be matter if
data length is devided by 16 or not. Impression that mono cryptagraphy library
just does not use FeedBackSize parameter correctly with RijndaelManaged class
on CFB mode?

Why code compiled by mono crashes and how to solve it?

Reproducible: Always

Steps to Reproduce:
Mono code sample [Link for online compiler to test:
<A HREF="http://www.compileonline.com/compile_csharp_online.php">http://www.compileonline.com/compile_csharp_online.php</A>]

using System;
using System.IO;
using System.Text;
using System.Security.Cryptography;

namespace Dela.Mono.Examples
{
   public class HelloWorld
   {
      public static void Main(string[] args)
      {
         string plainText = &quot;This will be encrypted.&quot;;
            string plainText2 = &quot;&quot;;

            RijndaelManaged aesAlg = new RijndaelManaged();

            aesAlg.BlockSize = 128;
            aesAlg.KeySize = 256;
            aesAlg.Mode = CipherMode.CFB;
            aesAlg.FeedbackSize = 8;
            aesAlg.Padding = PaddingMode.None;

            aesAlg.GenerateKey();
            aesAlg.GenerateIV();

            ICryptoTransform encryptor = aesAlg.CreateEncryptor();

            MemoryStream msEncrypt = new MemoryStream();
            using (CryptoStream csEncrypt = new CryptoStream(msEncrypt,
encryptor, CryptoStreamMode.Write)) {
                using (StreamWriter swEncrypt = new StreamWriter(csEncrypt)) {
                    swEncrypt.Write(plainText);
                }
            }

            Console.WriteLine(msEncrypt.ToArray().Length);

Console.WriteLine(System.Text.Encoding.UTF8.GetString(msEncrypt.ToArray()));

            byte[] customArray = msEncrypt.ToArray();

            ICryptoTransform decryptor = aesAlg.CreateDecryptor();

            MemoryStream msDecrypt = new MemoryStream(customArray);
            using (CryptoStream csDecrypt = new CryptoStream(msDecrypt,
decryptor, CryptoStreamMode.Read)) {
                using (StreamReader swDecrypt = new StreamReader(csDecrypt)) {
                    plainText2 = swDecrypt.ReadToEnd();
                }
            }

            Console.WriteLine(plainText2.Length);
            Console.WriteLine(plainText2);


      }
   }
}

###########################################################

Native C# code sample [Link for online compiler to test:
<A HREF="http://rextester.com/runcode">http://rextester.com/runcode</A>]

//Title of this code
//Rextester.Program.Main is the entry point for your code. Don't change it.

using System;
using System.IO;
using System.Text;
using System.Security.Cryptography;

namespace Rextester
{
    public class Program
    {
        public static void Main(string[] args)
        {
            string plainText = &quot;This will be encrypted.&quot;;
            string plainText2 = &quot;&quot;;

            RijndaelManaged aesAlg = new RijndaelManaged();

            aesAlg.BlockSize = 128;
            aesAlg.KeySize = 256;
            aesAlg.Mode = CipherMode.CFB;
            aesAlg.FeedbackSize = 8;
            aesAlg.Padding = PaddingMode.None;

            aesAlg.GenerateKey();
            aesAlg.GenerateIV();

            ICryptoTransform encryptor = aesAlg.CreateEncryptor();

            MemoryStream msEncrypt = new MemoryStream();
            using (CryptoStream csEncrypt = new CryptoStream(msEncrypt,
encryptor, CryptoStreamMode.Write)) {
                using (StreamWriter swEncrypt = new StreamWriter(csEncrypt)) {
                    swEncrypt.Write(plainText);
                }
            }

            Console.WriteLine(msEncrypt.ToArray().Length);

Console.WriteLine(System.Text.Encoding.UTF8.GetString(msEncrypt.ToArray()));

            byte[] customArray = msEncrypt.ToArray();

            ICryptoTransform decryptor = aesAlg.CreateDecryptor();

            MemoryStream msDecrypt = new MemoryStream(customArray);
            using (CryptoStream csDecrypt = new CryptoStream(msDecrypt,
decryptor, CryptoStreamMode.Read)) {
                using (StreamReader swDecrypt = new StreamReader(csDecrypt)) {
                    plainText2 = swDecrypt.ReadToEnd();
                }
            }

            Console.WriteLine(plainText2.Length);
            Console.WriteLine(plainText2);
        }
    }
}

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="113610.html">[Mono-bugs] [Bug 642631] System.Drawing.Icon should recalculate the ImageOffset when the specified ico file has 256x256 image.
</A></li>
	<LI>Next message: <A HREF="113612.html">[Mono-bugs] [Bug 781683] Mono.Security.Cryptography RijndaelManaged class issue using CFB-8 mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#113611">[ date ]</a>
              <a href="thread.html#113611">[ thread ]</a>
              <a href="subject.html#113611">[ subject ]</a>
              <a href="author.html#113611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
