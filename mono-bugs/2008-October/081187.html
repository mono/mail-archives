<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 437338] New: HasValue is true on a nullable field which gets null assigned
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20437338%5D%20New%3A%20HasValue%20is%20true%20on%20a%20nullable%20field%0A%20which%20gets%20null%20assigned&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="081513.html">
   <LINK REL="Next"  HREF="081191.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 437338] New: HasValue is true on a nullable field which gets null assigned</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20437338%5D%20New%3A%20HasValue%20is%20true%20on%20a%20nullable%20field%0A%20which%20gets%20null%20assigned&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 437338] New: HasValue is true on a nullable field which gets null assigned">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Oct 21 10:25:08 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="081513.html">[Mono-bugs] [Bug 437312] System.Data.Odbc and Mono 2.0 : Many new problems upgrading from 1.9.1
</A></li>
        <LI>Next message: <A HREF="081191.html">[Mono-bugs] [Bug 437338] HasValue is true on a nullable field which gets null assigned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#81187">[ date ]</a>
              <a href="thread.html#81187">[ thread ]</a>
              <a href="subject.html#81187">[ subject ]</a>
              <a href="author.html#81187">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=437338">https://bugzilla.novell.com/show_bug.cgi?id=437338</A>


           Summary: HasValue is true on a nullable field which gets null
                    assigned
           Product: Mono: Runtime
           Version: 2.0
          Platform: x86-64
        OS/Version: Linux
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">singer at conemis.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Created an attachment (id=246886)
 --&gt; (<A HREF="https://bugzilla.novell.com/attachment.cgi?id=246886">https://bugzilla.novell.com/attachment.cgi?id=246886</A>)
the same code i posted in the description

The following code does some constructor chaining. In one of the chained
constructors the value null is passed to a nullable which is stored in a public
field of the created instance. If you call the HasValue property of this
nullable it should return false. But it returns true on x86_64 if you create
more than one instance of this type.
(g)mcs emits the same IL code on 32 and 64 bit, so i guess the problem is in
the jit.

Here is the code (sorry i did not get it smaller):
  using System;
  public struct ValTyp
  {
    public static readonly ValTyp Empty = new ValTyp(Guid.Empty, 0, 0);
    public Guid g;
    public int i1;
    public int i2;
    public ValTyp(Guid g, int i1, int i2)
    {
      this.g = g;
      this.i1 = i1;
      this.i2 = i2;
    }
  }
  public abstract class Foo
  {
    public ValTyp? nvt;
    protected Foo(ValTyp vt, ValTyp? nvt)
    {
      this.nvt = nvt;
      Console.WriteLine(&quot;in Foo's ctor: nvt.HasValue==&quot; +
        nvt.HasValue.ToString());
    }
  }
  public class Moo : Foo
  {
    public Moo(ValTyp vt, int i) :
      base(vt, null) { } // &lt;-- nvt is set to null here
    public Moo(ValTyp vt) : this(vt, 0) { }
  }
  public static class Bar
  {
    public static void Main()
    {
      Moo moo = new Moo(ValTyp.Empty);
      Console.WriteLine(&quot;in Main(1): moo.nvt.HasValue==&quot; +
        moo.nvt.HasValue.ToString());
      moo = new Moo(ValTyp.Empty);
      Console.WriteLine(&quot;in Main(2): moo.nvt.HasValue==&quot; +
        moo.nvt.HasValue.ToString());
      if(moo.nvt.HasValue)
        Console.WriteLine(&quot;HURRAY! It's Magic!&quot;);
    }
  }

On x86_64 this code outputs:
  in Foo's ctor: nvt.HasValue==False
  in Main(1): moo.nvt.HasValue==False
  in Foo's ctor: nvt.HasValue==True
  in Main(2): moo.nvt.HasValue==True
  HURRAY! It's Magic!
And on x86, sparc and arm (all three are 32 bit) it outputs (as expected):
  in Foo's ctor: nvt.HasValue==False
  in Main(1): moo.nvt.HasValue==False
  in Foo's ctor: nvt.HasValue==False
  in Main(2): moo.nvt.HasValue==False

I tested it on Mono 1.9, 1.9.1 and 2.0. All three the same on x86_64.
Unfortunately i do not have another 64 bit architecture to test it.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>









































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="081513.html">[Mono-bugs] [Bug 437312] System.Data.Odbc and Mono 2.0 : Many new problems upgrading from 1.9.1
</A></li>
	<LI>Next message: <A HREF="081191.html">[Mono-bugs] [Bug 437338] HasValue is true on a nullable field which gets null assigned
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#81187">[ date ]</a>
              <a href="thread.html#81187">[ thread ]</a>
              <a href="subject.html#81187">[ subject ]</a>
              <a href="author.html#81187">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
