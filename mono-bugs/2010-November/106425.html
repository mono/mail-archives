<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 467221] [PATCH] asp.net security trimming / authorization not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20467221%5D%20%5BPATCH%5D%20asp.net%20security%20trimming%20/%0A%20authorization%20not%20working&In-Reply-To=bug-467221-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="106421.html">
   <LINK REL="Next"  HREF="106434.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 467221] [PATCH] asp.net security trimming / authorization not working</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20467221%5D%20%5BPATCH%5D%20asp.net%20security%20trimming%20/%0A%20authorization%20not%20working&In-Reply-To=bug-467221-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 467221] [PATCH] asp.net security trimming / authorization not working">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Nov 20 15:04:08 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="106421.html">[Mono-bugs] [Bug 655146] New: AVURLAsset.PreferPreciseDurationAndTimingKey is missing from SDK
</A></li>
        <LI>Next message: <A HREF="106434.html">[Mono-bugs] [Bug 625583] gmcs emits unused field warning on field used as argument to method invocation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#106425">[ date ]</a>
              <a href="thread.html#106425">[ thread ]</a>
              <a href="subject.html#106425">[ subject ]</a>
              <a href="author.html#106425">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=467221">https://bugzilla.novell.com/show_bug.cgi?id=467221</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=467221#c11">https://bugzilla.novell.com/show_bug.cgi?id=467221#c11</A>


Mike Morano &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mmorano at mikeandwan.us</A>&gt; changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
             Status|REOPENED                    |ASSIGNED
            Summary|asp.net security trimming / |[PATCH] asp.net security
                   |authorization not working   |trimming / authorization
                   |                            |not working

--- Comment #11 from Mike Morano &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mmorano at mikeandwan.us</A>&gt; 2010-11-20 20:04:04 UTC ---
Hello,

I have finally found a bit of time to work on this, and have a more
conservative fix to the issue, and am running this now on my current site with
expected behavior.  When the sitemap is looking for an applicable node for
security trimming, it will call the new method which can return a configuration
location that represents the most specific path configured for the requested
url.  I have not observed any negative side effects of this code with my
website:


diff --git
a/mcs/class/System.Configuration/System.Configuration/Configuration.cs
b/mcs/class/System.Configuration/System.Configuration/Configuration.cs
index b8a3df7..6f80617 100644
--- a/mcs/class/System.Configuration/System.Configuration/Configuration.cs
+++ b/mcs/class/System.Configuration/System.Configuration/Configuration.cs
@@ -100,7 +100,7 @@ namespace System.Configuration {
                        if (relativePath.StartsWith (relConfigPath,
StringComparison.Ordinal))
                                relativePath = relativePath.Substring
(relConfigPath.Length);

-                       ConfigurationLocation loc = Locations.Find
(relativePath);
+                       ConfigurationLocation loc = Locations.FindBest
(relativePath);
                        if (loc == null)
                                return parentConfig;

diff --git
a/mcs/class/System.Configuration/System.Configuration/ConfigurationLocationCollection.cs
b/mcs/class/System.Configuration/System.Configuration/ConfigurationLocationCollection.cs
index c5a439b..b8f8ed3 100644
---
a/mcs/class/System.Configuration/System.Configuration/ConfigurationLocationCollection.cs
+++
b/mcs/class/System.Configuration/System.Configuration/ConfigurationLocationCollection.cs
@@ -54,6 +54,37 @@ namespace System.Configuration {
                                        return loc;
                        return null;
                }
+                               
+               internal ConfigurationLocation FindBest (string location)
+               {
+                       if(location == null)
+                               return null;
+                       
+                       ConfigurationLocation bestMatch = null;
+                                               
+                       foreach (ConfigurationLocation loc in InnerList)
+                       {
+                               if(location.StartsWith(loc.Path,
StringComparison.OrdinalIgnoreCase))
+                               {
+                                       // ensure path based comparisons
consider full directory names (i.e. so 'admin' does not match an
'administration' path)
+                                       if(location.Length &gt; loc.Path.Length &amp;&amp;
location[loc.Path.Length] != '/')
+                                       {
+                                               continue;
+                                       }
+                                       
+                                       if(bestMatch == null)
+                                       {
+                                               bestMatch = loc;
+                                       }
+                                       else if(bestMatch.Path.Length &lt;
loc.Path.Length)
+                                       {
+                                               bestMatch = loc;
+                                       }
+                               }
+                       }
+                       
+                       return bestMatch;
+               }
        }
 }



I believe there could be one other enhancement to this patch, which is not
included in the above.  For example, consider the following in a web.config:

&lt;location path=&quot;admin&quot;&gt;
  &lt;system.web&gt;
    &lt;authorization&gt;
       ...
    &lt;/authorization&gt;
  &lt;/system.web&gt;
&lt;/location&gt;

&lt;location path=&quot;admin/upload&quot;&gt;
  &lt;system.web&gt;
    &lt;httpRuntime /&gt;
  &lt;/system.web&gt;
&lt;/location&gt;

To determine the security settings of a file in the admin/upload path, you
would need to consider the setting in &quot;admin&quot;, as this is the most specific
location that specifies the authorization rules.  I have not tested this, but
currently I might expect to see that &quot;admin/upload&quot; location would be used to
try and identify the authorization rule, but would not be defined there.  As
such, there could be a need to know the config section that is of interest as
part of this search, as it would need to return a configuration location that
contains the settings that are needed (in this example, the
system.web/authorization section).  Of course a data structure could be used to
track the different configured paths, but that looks like it would be quite an
undertaking.

Please let me know if you have any questions.


Thanks,
Mike

&lt;/location&gt;

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>














































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="106421.html">[Mono-bugs] [Bug 655146] New: AVURLAsset.PreferPreciseDurationAndTimingKey is missing from SDK
</A></li>
	<LI>Next message: <A HREF="106434.html">[Mono-bugs] [Bug 625583] gmcs emits unused field warning on field used as argument to method invocation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#106425">[ date ]</a>
              <a href="thread.html#106425">[ thread ]</a>
              <a href="subject.html#106425">[ subject ]</a>
              <a href="author.html#106425">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
