<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 620411] RewritePath crashes with an unidentified null reference exeption in PostAcquireRequestState
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20620411%5D%20RewritePath%20crashes%20with%20an%20unidentified%0A%20null%20reference%20exeption%20in%20PostAcquireRequestState&In-Reply-To=bug-620411-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="102025.html">
   <LINK REL="Next"  HREF="101980.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 620411] RewritePath crashes with an unidentified null reference exeption in PostAcquireRequestState</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20620411%5D%20RewritePath%20crashes%20with%20an%20unidentified%0A%20null%20reference%20exeption%20in%20PostAcquireRequestState&In-Reply-To=bug-620411-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 620411] RewritePath crashes with an unidentified null reference exeption in PostAcquireRequestState">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Jul  9 08:39:56 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="102025.html">[Mono-bugs] [Bug 620411] RewritePath crashes with an unidentified null reference exeption in PostAcquireRequestState
</A></li>
        <LI>Next message: <A HREF="101980.html">[Mono-bugs] [Bug 579058] warning CS0252 not issued by {d,g}mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102047">[ date ]</a>
              <a href="thread.html#102047">[ thread ]</a>
              <a href="subject.html#102047">[ subject ]</a>
              <a href="author.html#102047">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=620411">http://bugzilla.novell.com/show_bug.cgi?id=620411</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=620411#c9">http://bugzilla.novell.com/show_bug.cgi?id=620411#c9</A>


--- Comment #9 from Stefan Winkler &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">s.winkler at studdex.com</A>&gt; 2010-07-09 12:39:55 UTC ---
I have some feedback regarding your fix. I applied it to a mono source I
debugged with monodevelop, after porting our solution over. After applying it,
a completely blank page was returned instead of an error page, so our specific
problem wasn't solved by that. But the fix prevented the crash and didn't have
any harmful side effects, so I guess it's safe to commit it to 2.6 anyway, one
can never have enough null-checks.

I did some more research and I guess I found out what happens, though I still
don't know why: 
The crash doesn't actually happen upon calling RewritePath in
Application_BeginRequest, but afterwards. The request path can't be processed
by the RewritePath method and therefore leads to an invalid location. Then a
regular request is fired for that invalid path and because nothing is found
there, the type of the file to serve can't be determined and therefore no
Handler is selected, causing the error in PostAquireRequestState, where the
CurrentHandler, like you already mentioned, should actually never be null.

So, what was wrong with the request path? 
Well, our rewriting class takes the Request.AppRelativeCurrentExecutionFilePath
as input parameter and if it contains a certain keyword, returns the path to
the real file that needs to be served in the format &quot;~/folders/file.aspx?x=y&quot;.
The ~ is needed if we want to put the result into the path parameter for
methods like Server.Transfer, Response.Redirect, or Server.MapPath. 
For RewritePath however, we need the relative server path, determined like
this: 
application.Request.ApplicationPath + s.Substring(1)
That's because some of our test evironments were using a virtual path and the
files wouldn't be found if that was missing. That also explains why the latest
version didn't fail on our test server, because it used a virtual path. And if
the virtual path is, for example &quot;/vpath&quot;, the input string looks like
&quot;/vpath/folders/file.aspx?x=y&quot; and everything works fine. But if the virtual
path points to the root directory (&quot;/&quot;), then the input string will look like
this:
&quot;//folders/file.aspx?x=y&quot;. 
Double slash at the beginning. Ouch. Windows ignores this (maybe by
automatically replacing each double slash with a single one) and for some
reason, mono apparently did the same in the past (this part of the code is
actually quite old). But for some mysterious reason, modyfing or deleting one
of 3 certain files in our web application's root folder (all of those were
files that used runat-server script blocks instead of codebehind) changed the
bahaviour of that auto-fix or whatever is going on behind the scenes and now it
fails. If I run a string.Replace(&quot;//&quot;,&quot;/&quot;) on the path before submitting it to
RewritePath, everything works fine again. 

Of course that doesn't explain at all what exactly happened internally, but at
least it fixes our error, so I'm fine with that and won't look into the matter
any further, I already spent too much time for that and have to catch up with
development now. Good luck to anyone who wants to search for the mysterious
cause of this, though.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="102025.html">[Mono-bugs] [Bug 620411] RewritePath crashes with an unidentified null reference exeption in PostAcquireRequestState
</A></li>
	<LI>Next message: <A HREF="101980.html">[Mono-bugs] [Bug 579058] warning CS0252 not issued by {d,g}mcs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102047">[ date ]</a>
              <a href="thread.html#102047">[ thread ]</a>
              <a href="subject.html#102047">[ subject ]</a>
              <a href="author.html#102047">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
