<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 626164] System.Net.Mail.SmtpClient sometimes silently drops messages on the floor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20626164%5D%20System.Net.Mail.SmtpClient%20sometimes%0A%20silently%20drops%20messages%20on%20the%20floor&In-Reply-To=bug-626164-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="102551.html">
   <LINK REL="Next"  HREF="102549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 626164] System.Net.Mail.SmtpClient sometimes silently drops messages on the floor</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20626164%5D%20System.Net.Mail.SmtpClient%20sometimes%0A%20silently%20drops%20messages%20on%20the%20floor&In-Reply-To=bug-626164-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 626164] System.Net.Mail.SmtpClient sometimes silently drops messages on the floor">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Jul 31 20:29:40 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="102551.html">[Mono-bugs] [Bug 626164] System.Net.Mail.SmtpClient sometimes silently drops messages on the floor
</A></li>
        <LI>Next message: <A HREF="102549.html">[Mono-bugs] [Bug 626168] New: IsFullyTrusted is missing from System.Reflection.Assembly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102629">[ date ]</a>
              <a href="thread.html#102629">[ thread ]</a>
              <a href="subject.html#102629">[ subject ]</a>
              <a href="author.html#102629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=626164">http://bugzilla.novell.com/show_bug.cgi?id=626164</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=626164#c4">http://bugzilla.novell.com/show_bug.cgi?id=626164#c4</A>


--- Comment #4 from David Barts &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">n5jrn at mac.com</A>&gt; 2010-08-01 00:29:38 UTC ---
I've been looking at the source in
mcs/class/System/System.Net.Mail/SmtpClient.cs and frankly it looks like
something of a mess.

There's three separate objects being used to interact with the TCP socket: a
Stream, a StreamReader, and a StreamWriter. All are directly used for I/O. From
what I've noticed, pains are being taken to flush the StreamWriter after it is
used. But the StreamReader worries me; might not its buffering be causing the
reading of responses to get out of sync? That could explain why emails
mysteriously get dropped on the floor. Some other bugs are garbling the message
or the SMTP commands, the remote server is taking offense and sending an error
reply, but we never get to notice it and throw an exception back to the calling
code.

If I were coding this class, I would have just used the StreamReader and the
StreamWriter objects, and never touched the Stream one. Mixing the use of the
two seems to me to be just asking for headaches caused by buffering.

The code to read the SMTP responses seems very convoluted (Read method starting
at line 361 in the most current version of SmtpClient.cs). I can't help but
suspect there might be a bug or two lurking in there, even though I've tried
working through it and haven't yet found one.

The code to write the message body to the remote server (SendData method
starting at line 719) does definitely have a bug. It only transforms a &quot;.&quot; line
to a &quot;..&quot; one. According to RFC2821, all lines that start with a &quot;.&quot; should
have an extra &quot;.&quot; prepended to, not just bare &quot;.&quot; lines. It also does some
pretty convoluted processing to detect those &quot;.&quot; lines. They're already strings
at this stage, so the code should just use .StartsWith(&quot;.&quot;) and forget about
trying to manually loop through the string.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="102551.html">[Mono-bugs] [Bug 626164] System.Net.Mail.SmtpClient sometimes silently drops messages on the floor
</A></li>
	<LI>Next message: <A HREF="102549.html">[Mono-bugs] [Bug 626168] New: IsFullyTrusted is missing from System.Reflection.Assembly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#102629">[ date ]</a>
              <a href="thread.html#102629">[ thread ]</a>
              <a href="subject.html#102629">[ subject ]</a>
              <a href="author.html#102629">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
