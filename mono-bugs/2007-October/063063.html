<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 333746] New: Possible bug with garbage collection (NHibernate example)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20333746%5D%20New%3A%20Possible%20bug%20with%20garbage%20collection%0A%20%28NHibernate%20example%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="063084.html">
   <LINK REL="Next"  HREF="063064.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 333746] New: Possible bug with garbage collection (NHibernate example)</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20333746%5D%20New%3A%20Possible%20bug%20with%20garbage%20collection%0A%20%28NHibernate%20example%29&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 333746] New: Possible bug with garbage collection (NHibernate example)">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Oct 14 18:06:14 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="063084.html">[Mono-bugs] [Bug 333745] System.Web.Configuration.WebConfigurationManager. GetSection reads from global web.config instead of local app.config
</A></li>
        <LI>Next message: <A HREF="063064.html">[Mono-bugs] [Bug 333746] Possible bug with garbage collection (NHibernate example)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63063">[ date ]</a>
              <a href="thread.html#63063">[ thread ]</a>
              <a href="subject.html#63063">[ subject ]</a>
              <a href="author.html#63063">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=333746">https://bugzilla.novell.com/show_bug.cgi?id=333746</A>

           Summary: Possible bug with garbage collection (NHibernate
                    example)
           Product: Mono: Runtime
           Version: 1.2
          Platform: i586
        OS/Version: Linux
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: GC
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">emarkp at hotmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
          Found By: ---


Created an attachment (id=178314)
 --&gt; (<A HREF="https://bugzilla.novell.com/attachment.cgi?id=178314">https://bugzilla.novell.com/attachment.cgi?id=178314</A>)
All files needed to reproduce this bug.  The only change that should be needed
is the host name in the connection string.

Attatched is a simple project that demonstrates this issue.  All files needed
for execution are in the bin\Release\ folder.  You would need to rebuild the
app changing the host in the connection string.  Here are the queries to set up
the database, this can be ran inside the mysql client:

create database NHTest;
use NHTest;
CREATE TABLE users (
  LogonID nvarchar(20) NOT NULL default '0',
  Name nvarchar(40) default NULL,
  Password nvarchar(20) default NULL,
  EmailAddress nvarchar(40) default NULL,
  LastLogon datetime default NULL,
  PRIMARY KEY  (LogonID)
);
grant all on NHTest.* to 'nhtestuser'@'%' identified by 'nhtestpass';


When running this small test app on mono, I get the following error:

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">miles at trout</A>:~/NHTest$ ./NHTest.exe

Unhandled Exception: System.NullReferenceException: Object reference not set to
an instance of an object
  at NHibernate.Transaction.AdoTransaction.AfterTransactionCompletion (Boolean
successful) [0x00000]
  at NHibernate.Transaction.AdoTransaction.Commit () [0x00000]
  at NHTest.Program.Main (System.String[] args) [0x00000]
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">miles at trout</A>:~/NHTest$

This application runs fine using Microsoft's CLR.  

Here's the strange part, 

The function (In NHibernate.Transaction.AdoTransaction) throwing the
nullreference is: 



      private void AfterTransactionCompletion(bool successful) 
      { 
         session.AfterTransactionCompletion(successful, this); 
         session = null; 
         begun = false; 
      } 



And the only object being dereferenced anywhere is &quot;session&quot; 

Which is where the impossible seems to come in... because in the call stack
AdoTransaction.AfterTransactionCompletion is called directly from Commit which
looks like this: 


                public void Commit()
                {
                        CheckNotDisposed();
                        CheckBegun();

                        log.Debug(&quot;commit&quot;);

                        if (session.FlushMode != FlushMode.Never)
                        {
                                session.Flush();
                        }

                        session.BeforeTransactionCompletion(this);

                        try
                        {
                                trans.Commit();
                                committed = true;
                                AfterTransactionCompletion(true);
                                Dispose();
                        }
                        ...
&lt;snip&gt; 


Session is being dereferenced just fine well before Commit gets around to
calling AfterTransactionCompletion.  I've spent a little time reviewing the
code and it seems that no code between session.FlushMode and trans.Commit() in
the above snippet could set session to null.  I don't think this is a threading
issue because it happens very consistently.  The only thing that crosses my
mind is possibly a garbage collection issue, if somehow it considers that
session object marked for removal and then consistently decides to clean up for
some reason between those points in the code.  This could be a bug with
NHibernate's library that just never happens with the Microsoft CLR and
consistently happens with the mono implementation and if that's the case I
apologize for taking your time.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>





















































































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="063084.html">[Mono-bugs] [Bug 333745] System.Web.Configuration.WebConfigurationManager. GetSection reads from global web.config instead of local app.config
</A></li>
	<LI>Next message: <A HREF="063064.html">[Mono-bugs] [Bug 333746] Possible bug with garbage collection (NHibernate example)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63063">[ date ]</a>
              <a href="thread.html#63063">[ thread ]</a>
              <a href="subject.html#63063">[ subject ]</a>
              <a href="author.html#63063">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
