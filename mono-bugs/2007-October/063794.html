<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 317647] Thread.Interrupt not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20317647%5D%20Thread.Interrupt%20not%20working&In-Reply-To=bug-317647-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="063792.html">
   <LINK REL="Next"  HREF="063796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 317647] Thread.Interrupt not working</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20317647%5D%20Thread.Interrupt%20not%20working&In-Reply-To=bug-317647-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 317647] Thread.Interrupt not working">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Oct 29 10:49:17 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="063792.html">[Mono-bugs] [Bug 321383] [PATCH] TextBoxBase: when RightToLeft is Yes, vertical scrollbar should go left
</A></li>
        <LI>Next message: <A HREF="063796.html">[Mono-bugs] [Bug 323819] XplatUIX11 WS_EX_TRANSPARENT not supported
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63794">[ date ]</a>
              <a href="thread.html#63794">[ thread ]</a>
              <a href="subject.html#63794">[ subject ]</a>
              <a href="author.html#63794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=317647#c2">https://bugzilla.novell.com/show_bug.cgi?id=317647#c2</A>





--- Comment #2 from Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>&gt;  2007-10-29 08:49:16 MST ---
Here are a few findings on this issue:
the number of iterations of the T2 loop are mostly random, you may get just one
or many (and likely forever). This explains the fact that someone can replicate
and others not. Looking at the code, it is clear that the T2 loop has a small
window outside the lock where, if it's preempted by the kernel and control is
passed to T1, the lock is taken by T1 and the program finishes. Adding a small
Sleep in the loop outside of the lock makes this explicit and the program
always terminates after a single loop.
This seems to suggest that the MS runtime (and/or the windows kernel
implementation of the locks) tends to prefer other threads than the one
releasing a Monitor. Doing something similar in our implementation has the same
effect of adding the small sleep to the program. My change in monitor.c looks
like:
@@ -605,6 +617,7 @@
                 */
                if (mon-&gt;entry_count &gt; 0) {
                        ReleaseSemaphore (mon-&gt;entry_sem, 1, NULL);
+                       sched_yield ();
                }
        } else {
                LOCK_DEBUG (g_message (G_GNUC_PRETTY_FUNCTION
(this is inside mono_monitor_exit ()).
I could easily reproduce the mostly infinite T2 loop by just reducing all the
sleep times in the program to one tenth and setting the MONO_NO_SMP=1 env var.

We need someone to confirm that with the MS runtime the T2 loop indeed happens
just once (by running the program at least 10 times, reducing all the sleep
times to one tenth). The same testing should be also done on a uniproc box or
by pinning the process to just one cpu.

Note that I added the yield only in the contended case, so the performance
regression of causing lock fairness shouldn't be large.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>

























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="063792.html">[Mono-bugs] [Bug 321383] [PATCH] TextBoxBase: when RightToLeft is Yes, vertical scrollbar should go left
</A></li>
	<LI>Next message: <A HREF="063796.html">[Mono-bugs] [Bug 323819] XplatUIX11 WS_EX_TRANSPARENT not supported
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63794">[ date ]</a>
              <a href="thread.html#63794">[ thread ]</a>
              <a href="subject.html#63794">[ subject ]</a>
              <a href="author.html#63794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
