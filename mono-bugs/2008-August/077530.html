<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 414166] New: UserControl.OnPaint(e.Graphics.Clip) not set if ControlStyles.OptimizedDoubleBuffer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20414166%5D%20New%3A%20UserControl.OnPaint%28e.Graphics.Clip%29%0A%20not%20set%20if%20ControlStyles.OptimizedDoubleBuffer&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="077561.html">
   <LINK REL="Next"  HREF="077819.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 414166] New: UserControl.OnPaint(e.Graphics.Clip) not set if ControlStyles.OptimizedDoubleBuffer</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20414166%5D%20New%3A%20UserControl.OnPaint%28e.Graphics.Clip%29%0A%20not%20set%20if%20ControlStyles.OptimizedDoubleBuffer&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 414166] New: UserControl.OnPaint(e.Graphics.Clip) not set if ControlStyles.OptimizedDoubleBuffer">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Aug  2 16:02:13 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="077561.html">[Mono-bugs] [Bug 414165] Strange compiler error when using a lambda	expression
</A></li>
        <LI>Next message: <A HREF="077819.html">[Mono-bugs] [Bug 414166] UserControl.OnPaint(e.Graphics.Clip) not set if ControlStyles. OptimizedDoubleBuffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77530">[ date ]</a>
              <a href="thread.html#77530">[ thread ]</a>
              <a href="subject.html#77530">[ subject ]</a>
              <a href="author.html#77530">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=414166">https://bugzilla.novell.com/show_bug.cgi?id=414166</A>


           Summary: UserControl.OnPaint(e.Graphics.Clip) not set if
                    ControlStyles.OptimizedDoubleBuffer
           Product: Mono: Class Libraries
           Version: 2.0
          Platform: Other
               URL: <A HREF="http://limada.sourceforge.net/Limaki/">http://limada.sourceforge.net/Limaki/</A>
        OS/Version: Windows XP
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Windows.Forms
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lytico at users.sourceforge.net</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: DeveloperNet


Description of Problem:

if you have an UserControl and set style to OptimizedDoubleBuffer:
on .NET you'll get the following result in OnPaint:
the Region e.Graphics.Clip is set to
Rectangle.Intersect(e.ClipRectangle,this.ClientRectangle)
on mono:
e.Graphics.Clip is infinite


Steps to reproduce the problem:
1. make a UserControl and set OptimizedDoubleBuffer:
2. override OnPaint and trace e.Graphics.ClipBounds


Actual Results:

Invalidate({X=5,Y=5,Width=500,Height=100})
OnPaint ()
this.ClientRectangle    {X=0,Y=0,Width=445,Height=262}
g.Clip.GetBounds(g)     {X=-4194304,Y=-4194304,Width=8388608,Height=8388608}
g.ClipBounds            {X=-4194304,Y=-4194304,Width=8388608,Height=8388608}
e.ClipRectangle         {X=5,Y=5,Width=440,Height=100}

Expected Results:

Invalidate({X=5,Y=5,Width=500,Height=100})
OnPaint ()
this.ClientRectangle    {X=0,Y=0,Width=445,Height=226}
g.Clip.GetBounds(g)     {X=5,Y=5,Width=440,Height=100}
g.ClipBounds            {X=5,Y=5,Width=440,Height=100}
e.ClipRectangle         {X=5,Y=5,Width=440,Height=100}

How often does this happen? 
always

Additional Information:

a workaround (or solution) could be:
. if OptimizedDoubleBuffer
e.Graphics.SetClip(Rectangle.Intersect(e.ClipRectangle,this.ClientRectangle))


Testcase:

using System;
using System.Collections.Generic;
using System.Text;
using System.Windows.Forms;
using System.Drawing;
using System.Drawing.Drawing2D;

namespace MonoWinformTests {

    public class TestRegionAndOnPaint : UserControl {
        private Rectangle rect = Rectangle.Empty;

        public TestRegionAndOnPaint() {
            this.AutoScroll = true;
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;

            ControlStyles controlStyle =
                ControlStyles.UserPaint
                | ControlStyles.AllPaintingInWmPaint
                // this enables graphics.Clip and graphics.ClipBounds:
                | ControlStyles.OptimizedDoubleBuffer;

            this.SetStyle(controlStyle, true);
        }

        protected override void OnPaint(PaintEventArgs e) {
            base.OnPaint(e);
            Graphics g = e.Graphics;
            Point pt = this.AutoScrollPosition;
            g.TranslateTransform(pt.X, pt.Y);
            if (rect != Rectangle.Empty) {

                g.FillRectangle(SystemBrushes.Window, rect);


            }



            string s = &quot;OnPaint ()&quot;+
                &quot;\nthis.ClientRectangle\t&quot; + this.ClientRectangle +
                &quot;\ng.Clip.GetBounds(g)\t&quot; + g.Clip.GetBounds(g) +
                &quot;\ng.ClipBounds\t\t&quot; + g.ClipBounds +
                &quot;\ne.ClipRectangle\t\t&quot; + e.ClipRectangle;

            // workaround:
            Region region = new Region();
            region.MakeInfinite();
            region.Intersect(
                    
Rectangle.Intersect(e.ClipRectangle,this.ClientRectangle));
            region.Translate(-pt.X, -pt.Y);

            s+=  &quot;\nworkaround:\nregion.GetBounds(g)\t&quot; + region.GetBounds(g);

            System.Console.WriteLine(s);

        }

        public void Execute() {
            rect.Location = new Point(5, 5);
            rect.Size = new Size(500, 100);
            this.AutoScrollMinSize = new Size(rect.Right, rect.Bottom);
            this.Invalidate(rect);
            System.Console.WriteLine(&quot;Invalidate(&quot;+rect+&quot;)&quot;);
        }
    }

    #region Test-Environment
    public class TestForm : Form {
        public TestForm() {
            InitializeComponent();
            testRegionAndOnPaint.Execute();

        }

        private void button1_Click(object sender, EventArgs e) {
            this.testRegionAndOnPaint.Execute();
        }

        protected override void Dispose(bool disposing) {
            if (disposing &amp;&amp; (components != null)) {
                components.Dispose();
            }
            base.Dispose(disposing);
        }


        private void InitializeComponent() {
            this.panel1 = new System.Windows.Forms.Panel();
            this.button1 = new System.Windows.Forms.Button();
            this.testRegionAndOnPaint = new
MonoWinformTests.TestRegionAndOnPaint();
            this.panel1.SuspendLayout();
            this.SuspendLayout();
            // 
            // panel1
            // 
            this.panel1.Controls.Add(this.button2);
            this.panel1.Controls.Add(this.button1);
            this.panel1.Dock = System.Windows.Forms.DockStyle.Left;
            this.panel1.Location = new System.Drawing.Point(0, 0);
            this.panel1.Name = &quot;panel1&quot;;
            this.panel1.Size = new System.Drawing.Size(66, 266);
            this.panel1.TabIndex = 0;
            // 
            // button1
            // 
            this.button1.Dock = System.Windows.Forms.DockStyle.Top;
            this.button1.Location = new System.Drawing.Point(0, 0);
            this.button1.Name = &quot;button1&quot;;
            this.button1.Size = new System.Drawing.Size(66, 23);
            this.button1.TabIndex = 0;
            this.button1.Text = &quot;Invalidate(rect)&quot;;
            this.button1.UseVisualStyleBackColor = true;
            this.button1.Click += new System.EventHandler(this.button1_Click);
            // 
            // testRegionAndOnPaint
            // 
            this.testRegionAndOnPaint.AutoScroll = true;
            this.testRegionAndOnPaint.Dock =
System.Windows.Forms.DockStyle.Fill;
            this.testRegionAndOnPaint.Location = new System.Drawing.Point(66,
0);
            this.testRegionAndOnPaint.Name = &quot;testRegionAndOnPaint&quot;;
            this.testRegionAndOnPaint.Size = new System.Drawing.Size(300, 200);
            this.testRegionAndOnPaint.TabIndex = 1;
            // 
            // TestEnvironmentForm
            // 
            this.AutoScaleDimensions = new System.Drawing.SizeF(6F, 13F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
            this.ClientSize = new System.Drawing.Size(400, 200);
            this.Controls.Add(this.testRegionAndOnPaint);
            this.Controls.Add(this.panel1);
            this.Name = &quot;TestEnvironmentForm&quot;;
            this.Text = &quot;Test AutoScroll&quot;;
            this.panel1.ResumeLayout(false);
            this.ResumeLayout(false);
        }

        private System.ComponentModel.IContainer components = null;
        private System.Windows.Forms.Panel panel1;
        private System.Windows.Forms.Button button2;
        private System.Windows.Forms.Button button1;
        private TestRegionAndOnPaint testRegionAndOnPaint;
    }

    static class TestProgram {
        [STAThread]
        static void Main() {
            Application.EnableVisualStyles();
            Application.SetCompatibleTextRenderingDefault(false);
            Application.Run(new TestForm());
        }
    }

    #endregion
}



cheers, 
lytico
on trying to get Limaki.WidgetDisplay to run on mono


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="077561.html">[Mono-bugs] [Bug 414165] Strange compiler error when using a lambda	expression
</A></li>
	<LI>Next message: <A HREF="077819.html">[Mono-bugs] [Bug 414166] UserControl.OnPaint(e.Graphics.Clip) not set if ControlStyles. OptimizedDoubleBuffer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77530">[ date ]</a>
              <a href="thread.html#77530">[ thread ]</a>
              <a href="subject.html#77530">[ subject ]</a>
              <a href="author.html#77530">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
