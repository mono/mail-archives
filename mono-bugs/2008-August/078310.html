<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 418908] New: . cctor type initializer causes buggy IL when using a lambda expression with a parameter
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20418908%5D%20New%3A%20.%20cctor%20type%20initializer%20causes%20buggy%0A%20IL%20when%20using%20a%20lambda%20expression%20with%20a%20parameter&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="078309.html">
   <LINK REL="Next"  HREF="078325.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 418908] New: . cctor type initializer causes buggy IL when using a lambda expression with a parameter</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20418908%5D%20New%3A%20.%20cctor%20type%20initializer%20causes%20buggy%0A%20IL%20when%20using%20a%20lambda%20expression%20with%20a%20parameter&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 418908] New: . cctor type initializer causes buggy IL when using a lambda expression with a parameter">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Aug 20 16:26:54 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="078309.html">[Mono-bugs] [Bug 315125] MS corlib serializable types cannot be deserialized on Mono
</A></li>
        <LI>Next message: <A HREF="078325.html">[Mono-bugs] [Bug 418908] . cctor type initializer causes buggy IL when using a lambda expression with a parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#78310">[ date ]</a>
              <a href="thread.html#78310">[ thread ]</a>
              <a href="subject.html#78310">[ subject ]</a>
              <a href="author.html#78310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=418908">https://bugzilla.novell.com/show_bug.cgi?id=418908</A>


           Summary: .cctor type initializer causes buggy IL when using a
                    lambda expression with a parameter
           Product: Mono: Compilers
           Version: 2.0
          Platform: x86-64
        OS/Version: Linux
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono at e-tobi.net</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
                CC: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono at e-tobi.net</A>
          Found By: ---


When using a lambda expression with a parameter to initalize a static member,
the generated IL causes an exception.

Please see the code and the exception output below.

This only happens, when the lambda expression has a parameter (&quot;() =&gt; true&quot;
works fine). And it only happens when the lambda expression is directly used to
initialize the static member. If I wrap the lambda expression into a static
method and use this method to initialize the static member, then it works
without any problems.

I'm not an expert, but looking at the IL, it seems, that it initializes the &quot;i&quot;
ParameterExpression AFTER passing the ParameterExpression[] array to
System.Linq.Expressions.Expression.Lambda&lt;...&gt;(...)

Here's the code to reproduce the problem;

using System;
using System.Reflection;
using System.Linq.Expressions;

public static class TestCase
{
    // This causes all the trouble:
    public static bool DUMMY = StaticMethodTakingAnExpression((i) =&gt; true);

    public static bool StaticMethodTakingAnExpression(
      Expression&lt;Func&lt;object, bool&gt;&gt; expression)
    {
        // I don't execute the expression here!!!
        return false;
    }

    public static void DummyToMakeTheStaticsInitialize()
    {
        // Just a dummy method to make this static class get initialized
    }
}

public class Program
{
    public static void Main()
    {
        TestCase.DummyToMakeTheStaticsInitialize();
    }
}

And this is what happens, when you execute this code:

Unhandled Exception: System.TypeInitializationException: An exception was
thrown by the type initializer for TestCase ---&gt; System.NullReferenceException:
Object reference not set to an instance of an object
  at System.Linq.Expressions.Expression.CheckLambda (System.Type delegateType,
System.Linq.Expressions.Expression body,
System.Collections.ObjectModel.ReadOnlyCollection`1 parameters) [0x0006f] in
/home/tobias/sandbox/x/mcs/class/System.Core/System.Linq.Expressions/Expression.cs:1479 
  at System.Linq.Expressions.Expression.Lambda[Func`2]
(System.Linq.Expressions.Expression body, IEnumerable`1 parameters) [0x00018]
in
/home/tobias/sandbox/x/mcs/class/System.Core/System.Linq.Expressions/Expression.cs:1506 
  at System.Linq.Expressions.Expression.Lambda[Func`2]
(System.Linq.Expressions.Expression body,
System.Linq.Expressions.ParameterExpression[] parameters) [0x00000] in
/home/tobias/sandbox/x/mcs/class/System.Core/System.Linq.Expressions/Expression.cs:1496 
  at TestCase..cctor () [0x00000] in
/tmp/sm/Source/StructureMap.Testing/bin/Debug/test2.cs:1 
  --- End of inner exception stack trace ---
  at Program.Main () [0x00005] in
/tmp/sm/Source/StructureMap.Testing/bin/Debug/test2.cs:26


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="078309.html">[Mono-bugs] [Bug 315125] MS corlib serializable types cannot be deserialized on Mono
</A></li>
	<LI>Next message: <A HREF="078325.html">[Mono-bugs] [Bug 418908] . cctor type initializer causes buggy IL when using a lambda expression with a parameter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#78310">[ date ]</a>
              <a href="thread.html#78310">[ thread ]</a>
              <a href="subject.html#78310">[ subject ]</a>
              <a href="author.html#78310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
