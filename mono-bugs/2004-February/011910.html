<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 53788][Nor] New - AppDomainSetup.PrivateBinPath bug in Mono 0.30
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011916.html">
   <LINK REL="Next"  HREF="011911.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 53788][Nor] New - AppDomainSetup.PrivateBinPath bug in Mono 0.30
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 53788][Nor] New - AppDomainSetup.PrivateBinPath bug in Mono 0.30">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Tue,  3 Feb 2004 05:25:03 -0500 (EST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="011916.html">[Mono-bugs] Greatly improve your stamina
</A></li>
        <LI> Next message: <A HREF="011911.html">[Mono-bugs] [Bug 53788][Nor] Changed - AppDomainSetup.PrivateBinPath bug in Mono 0.30
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11910">[ date ]</a>
              <a href="thread.html#11910">[ thread ]</a>
              <a href="subject.html#11910">[ subject ]</a>
              <a href="author.html#11910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:vguzev@yandex.ru.">vguzev@yandex.ru.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=53788">http://bugzilla.ximian.com/show_bug.cgi?id=53788</A>

--- shadow/53788	2004-02-03 05:25:03.000000000 -0500
+++ shadow/53788.tmp.29908	2004-02-03 05:25:03.000000000 -0500
@@ -0,0 +1,275 @@
+Bug#: 53788
+Product: Mono/Class Libraries
+Version: unspecified
+OS: Red Hat 7.3
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: System
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:vguzev@yandex.ru">vguzev@yandex.ru</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: AppDomainSetup.PrivateBinPath bug in Mono 0.30
+
+Description of Problem:
+The example attached works fine on Mono 0.28 and 0.29, but no longer works
+in Mono-0.30.
+
+Steps to reproduce the problem:
+1. Save the attachments (at the end of the report) to the folder /path/
+2. Change the variable 'folder' in file '/path/pinvokecomplex/amcsharp.cs'
+in class AppDomainController in method Test to actual location '/path/'
+3. Compile the sources:
+   cd /path/pinvokecomplex/
+   mcs /t:library amcsharp.cs
+   mcs /r:amcsharp.dll TestPInvoke.cs
+   cp amcsharp.dll ../Temp/
+   mcs /r:amcsharp.dll ../Temp/Test.cs
+4. Run the first part of the program
+   cd /path/Temp/
+This will create the file '/path/Temp/serializedobject.txt' with serialized
+object saved inside.
+5. Run the second part of the program
+   cd /path/pinvokecomplex/; mono TestPInvoke.exe
+
+This program will deserialize object from txt-file and try to launch some
+method of this object.
+
+Actual Results:
+This will throw the following exception:
+8&lt;----------------------------------------------------------
+3:System.IO.FileNotFoundException: File 'Test, Version=0.0.0.0,
+Culture=neutral, PublicKeyToken=null' not found.
+in (unmanaged)
+/local/users_shared/vadim/mono/mono-0.30-1.20040129/lib/libmono.so.0
+(mono_ra
+ise_exception+0x1f) [0x4008b74f]
+in (unmanaged)
+/local/users_shared/vadim/mono/mono-0.30-1.20040129/lib/libmono.so.0
+[0x400b1256]
+in &lt;0x0006c&gt; (wrapper remoting-invoke-with-check)
+System.AppDomain:LoadAssembly (string,System.Security.Policy.Evidence)
+in &lt;0x0006b&gt; System.AppDomain:Load (string)
+in &lt;0x00058&gt; (wrapper remoting-invoke-with-check) System.AppDomain:Load
+(string)
+in &lt;0x0001c&gt; System.Reflection.Assembly:Load (string)
+in &lt;0x00077&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:GetDeserializat
+i
+onType (long,string)
+in &lt;0x0024b&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:ReadTypeMetadat
+a
+(System.IO.BinaryReader,bool)
+in &lt;0x00048&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:ReadObjectInsta
+n
+ce
+(System.IO.BinaryReader,bool,long&amp;,object&amp;,System.Runtime.Serialization.Ser
+i
+alizationInfo&amp;)
+in &lt;0x00095&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:ReadObject
+(System.Runtime.Serialization.Formatters.Binary.BinaryElement,System.IO.Bin
+a
+ryReader,long&amp;,object&amp;,System.Runtime.Serialization.SerializationInfo&amp;)
+in &lt;0x00086&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:ReadNextObject
+(System.IO.BinaryReader)
+in &lt;0x000b6&gt;
+System.Runtime.Serialization.Formatters.Binary.ObjectReader:ReadObjectGraph
+(System.IO.BinaryReader,bool,object&amp;,System.Runtime.Remoting.Messaging.Head
+e
+r[]&amp;)
+in &lt;0x001b0&gt;
+System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Deserialize
+(System.IO.Stream,System.Runtime.Remoting.Messaging.HeaderHandler)
+in &lt;0x00019&gt;
+System.Runtime.Serialization.Formatters.Binary.BinaryFormatter:Deserialize
+(System.IO.Stream)
+in &lt;0x00093&gt; aMCSharp.AppDomainProcessor:CallMethod (string)
+8&lt;----------------------------------------------------------
+
+
+Expected Results:
+8&lt;----------------------------------------------------------
+object after deserialization:
+(ObjectHolder
+ .assemblyName=Test
+ .className=A
+ .methodName=fun1
+ .parameters=World!
+ .object=(some string:111)
+)
+-------------------------------------Hello, World!-------------------------
+----------
+(some string:111)
+8&lt;----------------------------------------------------------
+
+
+How often does this happen? 
+Always
+
+Additional Information:
+
+It seems to me that this bug is connected with the 
+AppDomainSetup.PrivateBinPath variable.
+When deserializing some object mono doesn't check for assemblies in
+PrivateBinPath. Although it can check now only relative paths...
+
+I can send the full example with Makefile (I didn't find how to attach a 
+zip-file here... :-( )
+
+Attachment:
+______________________________________________________
+1. /path/pinvokecomplex/amcsharp.cs:
+______________________________________________________
+using System;
+using System.IO;
+using System.Reflection;
+using System.Runtime.Serialization;
+using System.Runtime.Serialization.Formatters.Binary;
+
+namespace aMCSharp {
+ [Serializable()]
+ public class ObjectHolder {
+  public string assemblyName;
+  public string className;
+  public string methodName;
+  public object parameters;
+  public object serializedObject;
+
+  public ObjectHolder( string assemblyName, string className, string 
+methodName,
+   object parameters, object serializedObject ) {
+   this.assemblyName = assemblyName;
+   this.className = className;
+   this.methodName = methodName;
+   this.parameters = parameters;
+   this.serializedObject = serializedObject;
+  }
+
+  public override string ToString() {
+   return &quot;(ObjectHolder\n&quot; +
+    &quot; .assemblyName=&quot; + assemblyName + &quot;\n&quot; +
+    &quot; .className=&quot; + className + &quot;\n&quot; +
+    &quot; .methodName=&quot; + methodName + &quot;\n&quot; +
+    &quot; .parameters=&quot; + parameters + &quot;\n&quot; +
+    &quot; .object=&quot; + serializedObject.ToString() + &quot;\n)&quot;;
+  }
+ }
+
+ public class AppDomainController {
+  public static AppDomain appDomain;
+  public static AppDomainProcessor processor;
+
+  public static void Test() {
+   string folder = &quot;/home/vadim/archive/pinvokeandserialization/&quot;;
+   AppDomainSetup setup = new AppDomainSetup();
+   setup.ApplicationBase = AppDomain.CurrentDomain.BaseDirectory;
+   setup.PrivateBinPath = folder + &quot;Temp/&quot;;
+   setup.ApplicationName = &quot;1&quot;;
+   setup.ShadowCopyFiles = &quot;true&quot;;
+   try {
+    appDomain = AppDomain.CreateDomain( &quot;1&quot;, null, setup );
+    processor = (AppDomainProcessor)
+      appDomain.CreateInstanceFromAndUnwrap(
+      &quot;amcsharp.dll&quot;,
+      &quot;aMCSharp.AppDomainProcessor&quot; );
+
+    processor.CallMethod( folder + &quot;Temp/serializedobject.txt&quot; );
+   }
+   catch ( Exception e ) {
+    Console.WriteLine( &quot;1:&quot; + e );
+   }
+  }
+ }
+
+ public class AppDomainProcessor : MarshalByRefObject {
+  public void CallMethod( string fileName ) {
+   try {
+    FileStream fs = new FileStream( fileName, FileMode.Open, 
+FileAccess.Read );
+    ObjectHolder oh = (ObjectHolder) new BinaryFormatter().Deserialize( 
+fs );
+    Console.WriteLine( &quot;object after deserialization: \n&quot; + oh );
+    fs.Close();
+
+    Assembly assembly = AppDomain.CurrentDomain.Load( oh.assemblyName );
+    Type type = assembly.GetType( oh.className );
+    MethodInfo method = type.GetMethod( oh.methodName );
+    method.Invoke( oh.serializedObject, new object[] { oh.parameters } );
+   }
+   catch ( Exception e ) {
+    Console.WriteLine( &quot;3:&quot; + e );
+   }
+  }
+ }
+}
+______________________________________________________
+
+______________________________________________________
+2. /path/pinvokecomplex/amcsharp.cs:
+______________________________________________________
+using System;
+using aMCSharp;
+
+public class TestPInvoke {
+ public static void Main( string[] args ) {
+  AppDomainController.Test();
+ }
+}
+______________________________________________________
+
+______________________________________________________
+3. /path/Temp/Test.cs:
+______________________________________________________
+
+using System;
+using System.Runtime.Serialization;
+using aMCSharp;
+using System.Runtime.Serialization.Formatters.Binary;
+using System.IO;
+
+[Serializable()]
+public class A {
+ public string x = &quot;&quot;;
+ public int y = 2;
+ public A( string x, int y ) {
+  this.x = x;
+  this.y = y;
+ }
+
+ public void fun1( string line ) {
+  Console.WriteLine( &quot;-------------------------------------Hello, &quot; + line 
++ &quot;-----------------------------------&quot; );
+  Console.WriteLine( this );
+ }
+
+ public override string ToString() {
+  return &quot;(&quot; + x + &quot;:&quot; + y + &quot;)&quot;;
+ }
+}
+
+[Serializable()]
+public class Test {
+
+ public static void Main( string[] args ) {
+  A a = new A( &quot;some string&quot;, 111 );
+  Console.WriteLine( &quot;A before: &quot; + a );
+  ObjectHolder oh = new ObjectHolder( &quot;Test&quot;, &quot;A&quot;, &quot;fun1&quot;, &quot;World!&quot;, a );
+  Console.WriteLine( oh );
+
+  BinaryFormatter bf = new BinaryFormatter();
+  FileStream fs = new FileStream( &quot;serializedobject.txt&quot;, 
+FileMode.OpenOrCreate, FileAccess.Write );
+  bf.Serialize( fs, oh );
+  fs.Close();
+ }
+}
+______________________________________________________

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011916.html">[Mono-bugs] Greatly improve your stamina
</A></li>
	<LI> Next message: <A HREF="011911.html">[Mono-bugs] [Bug 53788][Nor] Changed - AppDomainSetup.PrivateBinPath bug in Mono 0.30
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11910">[ date ]</a>
              <a href="thread.html#11910">[ thread ]</a>
              <a href="subject.html#11910">[ subject ]</a>
              <a href="author.html#11910">[ author ]</a>
         </LI>
       </UL>
</body></html>
