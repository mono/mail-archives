<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 698127] New: Mono.Data.Sqlite. dll doesn&#8217;t work on Mac OS X 10 .5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%3D%3Futf-8%3Fq%3F%3D5BBug_698127%3D5D_New%3D3A_Mono%3D2EData%3D2ESqlit%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fe%3D2E_dll_doesn%3DE2%3D80%3D99t_work_on_Mac_OS_X_10_%3D2E5%3F%3D&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="112048.html">
   <LINK REL="Next"  HREF="112050.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 698127] New: Mono.Data.Sqlite. dll doesn&#8217;t work on Mac OS X 10 .5</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%3D%3Futf-8%3Fq%3F%3D5BBug_698127%3D5D_New%3D3A_Mono%3D2EData%3D2ESqlit%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fe%3D2E_dll_doesn%3DE2%3D80%3D99t_work_on_Mac_OS_X_10_%3D2E5%3F%3D&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 698127] New: Mono.Data.Sqlite. dll doesn&#8217;t work on Mac OS X 10 .5">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Jun  4 09:41:50 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="112048.html">[Mono-bugs] [Bug 692293] Cannot connect to the specify host, MySQL
</A></li>
        <LI>Next message: <A HREF="112050.html">[Mono-bugs] [Bug 555952] Mono.Data.Sqlite doesn't work in simulator	on Leopard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112049">[ date ]</a>
              <a href="thread.html#112049">[ thread ]</a>
              <a href="subject.html#112049">[ subject ]</a>
              <a href="author.html#112049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=698127">https://bugzilla.novell.com/show_bug.cgi?id=698127</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=698127#c0">https://bugzilla.novell.com/show_bug.cgi?id=698127#c0</A>


           Summary: Mono.Data.Sqlite.dll doesn&#8217;t work on Mac OS X 10.5
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.10.x
          Platform: x86
        OS/Version: Mac OS X 10.5
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: Mono.Data.Sqlite
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mhabersack at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">vyacheslav.com at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Third Party Developer/Partner
           Blocker: Yes


Description of Problem:

Any code, that uses Mono.Data.Sqlite.dll gets exception when attempts to open
SQLite db. Example of such code could be found here:

<A HREF="http://monotouch.net/Documentation/System.Data#Example">http://monotouch.net/Documentation/System.Data#Example</A>

This problem also rises when launching MonoTouch applications on Mac OS X 10.5
and is documented here (and on different forums):

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=555946">https://bugzilla.novell.com/show_bug.cgi?id=555946</A>

That bug is closed, but documentation here:

<A HREF="http://monotouch.net/Documentation/Troubleshoot">http://monotouch.net/Documentation/Troubleshoot</A>

States, that fix will be released in future and for now Snow Leopard should be
used, which could be appropriate for iOS development, but not for Mac OS
support. And the problem is specific to Mono, not MonoTouch, as far as I can
see.

So, Mono.Data.Sqlite.dll imports SQLite3 library as sqlite3, which is mapped to
/Library/Frameworks/Mono.framework/Versions/2.10.2/lib/libsqlite3.0.dylib in
Mono's config file.

When test applications is launched with MONO_LOG_LEVEL=debug in command line,
log shows, that dllmap resolutions works correctly and mono_lookup_pinvoke_call
in mono\metadata\loader.c (line ~1251) tries to load correct library:

Mono: DllImport attempting to load:
'/Library/Frameworks/Mono.framework/Versions/2.10.2/lib/libsqlite3.0.dylib'.

Next code in loader.c (lines ~1370-1371):

char *mdirname = g_path_get_dirname (image-&gt;name);
while ((full_name = mono_dl_build_path (mdirname, file_name, &amp;iter))) {

Combines directory path of Mono.Data.Sqlite.dll and full path to Mono's version
of libsqlite3.0.dylib and tries to load result via cached_module_load;
corresponding log item:

Mono: DllImport loading library:
'/Library/Frameworks/Mono.framework/Versions/2.10.2/lib/mono/gac/Mono.Data.Sqlite/2.0.0.0__0738eb9f132ed756/lib/Library/Frameworks/Mono.framework/Versions/2.10.2/lib/libsqlite3.0.dylib'.

Somehow that call succeeds, but loads /usr/lib/libsqlite3.0.dylib. That library
on Mac OS X 10.5 has version 3.4.0 and this causes exception to be thrown by
Mono.Data.Sqlite.dll code:

Your sqlite3 version is old - please upgrade to at least v3.5.0!
System.EntryPointNotFoundException: sqlite3_next_stmt
  at (wrapper managed-to-native)
Mono.Data.Sqlite.UnsafeNativeMethods:sqlite3_next_stmt (intptr,intptr)
  at Mono.Data.Sqlite.SQLiteBase.ResetConnection
(Mono.Data.Sqlite.SqliteConnectionHandle db) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.Data.Sqlite.SQLiteBase.CloseConnection
(Mono.Data.Sqlite.SqliteConnectionHandle db) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.Data.Sqlite.SqliteConnectionHandle.ReleaseHandle () [0x00000] in
&lt;filename unknown&gt;:0 
  at System.Runtime.InteropServices.CriticalHandle.Dispose (Boolean disposing)
[0x00000] in &lt;filename unknown&gt;:0 
  at System.Runtime.InteropServices.CriticalHandle.Dispose () [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.Data.Sqlite.SQLite3.Close () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.Data.Sqlite.SqliteConnection.Close () [0x00000] in &lt;filename
unknown&gt;:0 
  at Mono.Data.Sqlite.SqliteConnection.Open () [0x00000] in &lt;filename
unknown&gt;:0 
  at SqliteMonoTest.Program.Main (System.String[] args) [0x00000] in &lt;filename
unknown&gt;:0  

On Mac OS x 10.6 that exceptions is not thrown, since
/usr/lib/libsqlite3.0.dylib is newer and it hides the problem, but does not fix
it.

Tried to change *LD_LIBRARY_PATH env variables, change current directory,
manually loading libsqlite3.0.dylib from Mono&#8217;s lib folder via dlopen - same
results.

Steps to reproduce the problem:
1. Run sample app from monotouch site (link above).
2. Additionally, catch exception in Main method of that code and add next lines
after catch block:

ProcessModuleCollection modules = Process.GetCurrentProcess().Modules;
foreach (ProcessModule module in modules)
    Console.WriteLine(&quot;[{0}]: {1}&quot;, module.ModuleName, module.FileName);

To see, that /usr/lib/libsqlite3.0.dylib is loaded:

[mono]: /usr/bin/mono
[CoreFoundation]:
/System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation
[libSystem.B.dylib]: /usr/lib/libSystem.B.dylib
[libiconv.2.dylib]: /usr/lib/libiconv.2.dylib
[libgcc_s.1.dylib]: /usr/lib/libgcc_s.1.dylib
[libicucore.A.dylib]: /usr/lib/libicucore.A.dylib
[libobjc.A.dylib]: /usr/lib/libobjc.A.dylib
[libauto.dylib]: /usr/lib/libauto.dylib
[libstdc++.6.dylib]: /usr/lib/libstdc++.6.dylib
[libmathCommon.A.dylib]: /usr/lib/system/libmathCommon.A.dylib
[libsqlite3.0.dylib]: /usr/lib/libsqlite3.0.dylib 

3. Run app with MONO_LOG_LEVEL=debug to see above log messages.

How often does this happen? 
Always.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="112048.html">[Mono-bugs] [Bug 692293] Cannot connect to the specify host, MySQL
</A></li>
	<LI>Next message: <A HREF="112050.html">[Mono-bugs] [Bug 555952] Mono.Data.Sqlite doesn't work in simulator	on Leopard
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112049">[ date ]</a>
              <a href="thread.html#112049">[ thread ]</a>
              <a href="subject.html#112049">[ subject ]</a>
              <a href="author.html#112049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
