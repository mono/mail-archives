<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 676368] New: Should not use ODBC statement handles after SQLDisconnect called
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20676368%5D%20New%3A%20Should%20not%20use%20ODBC%20statement%20handles%0A%20after%20SQLDisconnect%20called&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="109735.html">
   <LINK REL="Next"  HREF="110345.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 676368] New: Should not use ODBC statement handles after SQLDisconnect called</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20676368%5D%20New%3A%20Should%20not%20use%20ODBC%20statement%20handles%0A%20after%20SQLDisconnect%20called&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 676368] New: Should not use ODBC statement handles after SQLDisconnect called">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Mar  2 13:00:56 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="109735.html">[Mono-bugs] [Bug 676362] New: Bitmap Clone does not format return image to requested PixelFormat
</A></li>
        <LI>Next message: <A HREF="110345.html">[Mono-bugs] [Bug 676368] Should not use ODBC statement handles after SQLDisconnect called
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#109736">[ date ]</a>
              <a href="thread.html#109736">[ thread ]</a>
              <a href="subject.html#109736">[ subject ]</a>
              <a href="author.html#109736">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=676368">https://bugzilla.novell.com/show_bug.cgi?id=676368</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=676368#c0">https://bugzilla.novell.com/show_bug.cgi?id=676368#c0</A>


           Summary: Should not use ODBC statement handles after
                    SQLDisconnect called
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.8.x
          Platform: All
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.Data
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">0richardkk.novell at chiark.greenend.org.uk</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=417126)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=417126">http://bugzilla.novell.com/attachment.cgi?id=417126</A>)
patch that addresses this bug

User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-US) AppleWebKit/534.13
(KHTML, like Gecko) Chrome/9.0.597.107 Safari/534.13

SQLDisconnect() frees any statements allocated on that
connection, so statement handles become invalid (even to free)
after SQLDisconnect() is called.

OdbcConnection keeps a list of OdbcCommands in order to
destroy them before calling SQLDisconnect, but the list is of
weak references (and for good reason), so once their own
destruction commences, they no longer appear in this list.

Due to the vagaries of thread scheduling it can happen that
destruction of the OdbcCommand commences before
SQLDisconnect() is called but SQLFreeStmt() is called after
it.  (Even worse, they could overlap.)

The result is a crash.



The attached patch works for me.

Reproducible: Always

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>





















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="109735.html">[Mono-bugs] [Bug 676362] New: Bitmap Clone does not format return image to requested PixelFormat
</A></li>
	<LI>Next message: <A HREF="110345.html">[Mono-bugs] [Bug 676368] Should not use ODBC statement handles after SQLDisconnect called
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#109736">[ date ]</a>
              <a href="thread.html#109736">[ thread ]</a>
              <a href="subject.html#109736">[ subject ]</a>
              <a href="author.html#109736">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
