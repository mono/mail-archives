<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 683519] New: garbage collector waking up threads that are sleeping infinite
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20683519%5D%20New%3A%20garbage%20collector%20waking%20up%20threads%0A%20that%20are%20sleeping%20infinite&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="110612.html">
   <LINK REL="Next"  HREF="110624.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 683519] New: garbage collector waking up threads that are sleeping infinite</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20683519%5D%20New%3A%20garbage%20collector%20waking%20up%20threads%0A%20that%20are%20sleeping%20infinite&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 683519] New: garbage collector waking up threads that are sleeping infinite">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Mar 29 14:47:48 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="110612.html">[Mono-bugs] [Bug 648403] SplitContainer does not implement	ISupportInitialize
</A></li>
        <LI>Next message: <A HREF="110624.html">[Mono-bugs] [Bug 683519] garbage collector waking up threads that are sleeping infinite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#110613">[ date ]</a>
              <a href="thread.html#110613">[ thread ]</a>
              <a href="subject.html#110613">[ subject ]</a>
              <a href="author.html#110613">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=683519">https://bugzilla.novell.com/show_bug.cgi?id=683519</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=683519#c0">https://bugzilla.novell.com/show_bug.cgi?id=683519#c0</A>


           Summary: garbage collector waking up threads that are sleeping
                    infinite
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.10.x
          Platform: i386
        OS/Version: Other
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: misc
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">michael.jaskiewicz at gdc4s.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Third Party Developer/Partner
           Blocker: No


I build and compile the program below. I'm running it on Red Hat Enterprise
Linux 5.3 with Mono 2.10.1. 

What I'm doing is creating 10 threads that all sleep for an infinite amount of
time. These threads are woken up by the main thread which calls Interrupt() on
each of the children threads. 

What I'm expecting is that each worker thread throws an exception which I catch
and prints a log. This isn't happening all the time. Sometimes threads make the
Sleep call and seem to just continue executing right after that. No exception
is then fired. Since I wrap the sleep in a tight loop, it goes through this
many, many times.

I discovered that if I set the GC_DONT_GC environment variable, the problem
goes away. 

Sincerely,
mj



using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;

namespace SleepTest
{
  class Program
  {
    private static int s_threadID = 0;
    private static int s_threadCount = 2;
    private static List&lt;Thread&gt; s_threads = new List&lt;Thread&gt;();
    private static List&lt;ManualResetEvent&gt; s_resetEvents = new
List&lt;ManualResetEvent&gt;();
    private static object s_lock = new object();

    private static void ThreadProc()
    {
      ManualResetEvent mre = null;
      int threadID = 0;

      lock (s_lock)
      {
        threadID = s_threadID++;
        mre = s_resetEvents[threadID];
      }

      while (true)
      {        
        try
        {
          Console.WriteLine(&quot;{0}: Pre&quot;, threadID);
          Thread.Sleep(Timeout.Infinite);
          //mre.WaitOne();
          //mre.Reset();
          Console.WriteLine(&quot;{0}: Post&quot;, threadID);
        }
        catch (Exception e)
        {
          try
          {
            Console.WriteLine(&quot;{0}: Exception&quot;, threadID);
          }
          catch { }
        }
      }
    }

    static void Main(string[] args)
    {
      for (int i = 0; i &lt; s_threadCount; i++)
      {
        Thread t = new Thread(new ThreadStart(ThreadProc));
        s_threads.Add(t);
        ManualResetEvent mre = new ManualResetEvent(false);
        s_resetEvents.Add(mre);
        t.Start();
      }

      Random r = new Random();
      while (true)
      {
        int index = r.Next(0, s_threadCount-1);
        //ManualResetEvent mre = s_resetEvents[index];
        Console.WriteLine(&quot;Main: signaling {0}&quot;, index);
        //mre.Set();
        Thread.SpinWait(100000);
        Thread t = s_threads[index];
        t.Interrupt();
      }

    }
  }
}

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="110612.html">[Mono-bugs] [Bug 648403] SplitContainer does not implement	ISupportInitialize
</A></li>
	<LI>Next message: <A HREF="110624.html">[Mono-bugs] [Bug 683519] garbage collector waking up threads that are sleeping infinite
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#110613">[ date ]</a>
              <a href="thread.html#110613">[ thread ]</a>
              <a href="subject.html#110613">[ subject ]</a>
              <a href="author.html#110613">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
