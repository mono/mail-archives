<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 679242] New: loading PNG looses data -- seems to be forcing premultiplied alpha
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20679242%5D%20New%3A%20loading%20PNG%20looses%20data%20--%20seems%20to%0A%20be%20forcing%20premultiplied%20alpha&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="110023.html">
   <LINK REL="Next"  HREF="110028.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 679242] New: loading PNG looses data -- seems to be forcing premultiplied alpha</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20679242%5D%20New%3A%20loading%20PNG%20looses%20data%20--%20seems%20to%0A%20be%20forcing%20premultiplied%20alpha&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 679242] New: loading PNG looses data -- seems to be forcing premultiplied alpha">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Mar 14 01:03:44 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="110023.html">[Mono-bugs] [Bug 679199] New: Incomplete IsolatedStorageFile Class
</A></li>
        <LI>Next message: <A HREF="110028.html">[Mono-bugs] [Bug 679242] loading PNG looses data -- seems to be forcing premultiplied alpha
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#110027">[ date ]</a>
              <a href="thread.html#110027">[ thread ]</a>
              <a href="subject.html#110027">[ subject ]</a>
              <a href="author.html#110027">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=679242">https://bugzilla.novell.com/show_bug.cgi?id=679242</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=679242#c0">https://bugzilla.novell.com/show_bug.cgi?id=679242#c0</A>


           Summary: loading PNG looses data -- seems to be forcing
                    premultiplied alpha
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.8.x
          Platform: i686
        OS/Version: Mac OS X 10.6
            Status: NEW
          Severity: Critical
          Priority: P5 - None
         Component: misc
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">danny at sooloos.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows; Windows NT 6.1) AppleWebKit/534.23
(KHTML, like Gecko) Chrome/11.0.686.3 Safari/534.23

When I load a PNG file from disk, the R/G/B values in it come premultiplied
with the Alpha.

This is bad because it looses data (if alpha is 0, the r/g/b values are totally
lost forever), and it is also inconsistent with Microsoft's .NET, which
preserves the proper values from the PNG.

Reproducible: Always

Steps to Reproduce:
using System;
using System.Drawing;
using System.Drawing.Imaging;
namespace AlphaBlend
{
    class MainClass
    {
        static void Print(string pass, Bitmap bmp)
        {
            BitmapData data =
                bmp.LockBits(new Rectangle(0, 0, bmp.Width, bmp.Height),
                             ImageLockMode.ReadOnly,
                             PixelFormat.Format32bppArgb);
            unsafe {
                int j = 0;
                while (j &lt; bmp.Height) {
                    byte *inb = (byte*)data.Scan0.ToPointer() + data.Stride*j;
                    int i = 0;
                    Console.Write(pass + &quot;: |&quot;);
                    while (i &lt; bmp.Width) {
                        Console.Write(&quot;{0:X2},{1:X2},{2:X2},{3:X2}|&quot;,
                                      *inb, *(inb+1), *(inb+2), *(inb+3));
                        inb += 4;
                        i++;
                    }
                    Console.WriteLine();
                    j++;
                }
            }
            bmp.UnlockBits(data);
        }
        public static void Main(string[] args)
        {
            using (Bitmap bmp = new Bitmap(4, 4, PixelFormat.Format32bppArgb))
{
                using (Graphics g = Graphics.FromImage(bmp)) {
                    for (int y = 0; y &lt; bmp.Height; ++y)
                        for (int x = 0; x &lt; bmp.Width; ++x)
                            bmp.SetPixel(x, y,
                                         Color.FromArgb(0x80,0xff,0xff,0xff));
                }
                Print(&quot;       half alpha white&quot;, bmp);
                bmp.Save(&quot;tmp.png&quot;);
            }
            Console.WriteLine();
            using (Bitmap bmp = (Bitmap)Image.FromFile(&quot;tmp.png&quot;)) {
                Print(&quot;loaded half alpha white&quot;, bmp);
            }

            Console.WriteLine(); Console.WriteLine();

            using (Bitmap bmp = new Bitmap(4, 4, PixelFormat.Format32bppArgb))
{
                using (Graphics g = Graphics.FromImage(bmp)) {
                    for (int y = 0; y &lt; bmp.Height; ++y)
                        for (int x = 0; x &lt; bmp.Width; ++x)
                            bmp.SetPixel(x, y,
                                         Color.FromArgb(0x0,0xff,0xff,0xff));
                }
                Print(&quot;         no alpha white&quot;, bmp);
                bmp.Save(&quot;tmp.png&quot;);
            }
            Console.WriteLine();
            using (Bitmap bmp = (Bitmap)Image.FromFile(&quot;tmp.png&quot;)) {
                Print(&quot;  loaded no alpha white&quot;, bmp);
            }
         }
     }
}


Actual Results:  
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|

loaded half alpha white: |80,80,80,80|80,80,80,80|80,80,80,80|80,80,80,80|
loaded half alpha white: |80,80,80,80|80,80,80,80|80,80,80,80|80,80,80,80|
loaded half alpha white: |80,80,80,80|80,80,80,80|80,80,80,80|80,80,80,80|
loaded half alpha white: |80,80,80,80|80,80,80,80|80,80,80,80|80,80,80,80|


         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|

  loaded no alpha white: |00,00,00,00|00,00,00,00|00,00,00,00|00,00,00,00|
  loaded no alpha white: |00,00,00,00|00,00,00,00|00,00,00,00|00,00,00,00|
  loaded no alpha white: |00,00,00,00|00,00,00,00|00,00,00,00|00,00,00,00|
  loaded no alpha white: |00,00,00,00|00,00,00,00|00,00,00,00|00,00,00,00|


Expected Results:  
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
       half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|

loaded half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
loaded half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
loaded half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|
loaded half alpha white: |FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|FF,FF,FF,80|


         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
         no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|

  loaded no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
  loaded no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
  loaded no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|
  loaded no alpha white: |FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|FF,FF,FF,00|

The expected results came from a windows 7 .net 4 machine compiled with csc.
The bad results came from an OS X 10.6.6 machine running Mono 2.8.2 and
compiled with dmcs. gmcs and mcs product the same incorrect result.

This problem is exceptionally annoying when trying to load OpenGl textures
using Mono, and other people on the internet are having similar issues. Some
have suggested a workaround of un-premultiplying the values by dividing the
r/g/b by the alpha/255, but not only is this a terrible fix for quality sake,
but it doesn't work at all when the alpha value is 0.

I was unsure how to mark the severity of the bug, but given that 'Critical'
includes the descriptive text of 'causes you to lose data', I chose that.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="110023.html">[Mono-bugs] [Bug 679199] New: Incomplete IsolatedStorageFile Class
</A></li>
	<LI>Next message: <A HREF="110028.html">[Mono-bugs] [Bug 679242] loading PNG looses data -- seems to be forcing premultiplied alpha
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#110027">[ date ]</a>
              <a href="thread.html#110027">[ thread ]</a>
              <a href="subject.html#110027">[ subject ]</a>
              <a href="author.html#110027">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
