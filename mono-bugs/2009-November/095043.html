<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 556183] New: [Patch] Mac event pump can cause Control.BeginInvoke to block
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20556183%5D%20New%3A%20%5BPatch%5D%20Mac%20event%20pump%20can%20cause%0A%20Control.BeginInvoke%20to%20block&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="095042.html">
   <LINK REL="Next"  HREF="095044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 556183] New: [Patch] Mac event pump can cause Control.BeginInvoke to block</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20556183%5D%20New%3A%20%5BPatch%5D%20Mac%20event%20pump%20can%20cause%0A%20Control.BeginInvoke%20to%20block&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 556183] New: [Patch] Mac event pump can cause Control.BeginInvoke to block">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Nov 17 11:12:48 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="095042.html">[Mono-bugs] [Bug 556181] Wrong Dpi values when created Graphic instance with Graphic.FromImage()
</A></li>
        <LI>Next message: <A HREF="095044.html">[Mono-bugs] [Bug 556183] [Patch] Mac event pump can cause Control.BeginInvoke to block
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95043">[ date ]</a>
              <a href="thread.html#95043">[ thread ]</a>
              <a href="subject.html#95043">[ subject ]</a>
              <a href="author.html#95043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=556183#c0">http://bugzilla.novell.com/show_bug.cgi?id=556183#c0</A>

           Summary: [Patch] Mac event pump can cause Control.BeginInvoke
                    to block
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.4.x
          Platform: x86-64
        OS/Version: Mac OS X 10.6
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Windows.Forms
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">adrian.taylor at realvnc.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---

Created an attachment (id=327942)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=327942">http://bugzilla.novell.com/attachment.cgi?id=327942</A>)
Test case

Description of Problem:

Control.BeginInvoke is supposed to queue a message for asynchronous execution
on the main thread. It's supposed to return immediately as per the Microsoft
documentation here:
<A HREF="http://msdn.microsoft.com/en-us/library/0b1bf3y3.aspx">http://msdn.microsoft.com/en-us/library/0b1bf3y3.aspx</A>

But under some circumstances, on the Mac platform, it can block indefinitely.
This occurs because the Carbon XplatUICarbon.GetMessage function attempts to
act upon messages whilst still holding the message queue lock. This means any
calls to BeginInvoke block until the action is finished. This is causing a
deadlock in our application.

Steps to reproduce the problem:
1. Run attached test case, test.cs
2. Click the &quot;Press here&quot; button

Actual Results:

1. On Mono Linux (Ubuntu 9.04 x86_64, version 2.0.1) the test prints &quot;All OK!&quot;
twice and the form remains responsive.
2. On Mono MacOS X.6 x86_64 (version 2.4.2.3) the test does not print that, and
the UI thread blocks indefinitely.

Expected Results:

UI thread unblocks and application remains responsive.

How often does this happen? 

100% reproducible.


Output under Linux:
Main thread - about to create secondary thread
Secondary thread - created
Main thread: UI thread callback 1 taking place - claiming mutex
Secondary thread - About to BeginInvoke cb2 - if this blocks, it's a bug!
Secondary thread - Finished BeginInvoke cb2
Secondary thread - exiting - all OK!
Main thread: UI thread callback 2 taking place - all OK!


Output under MacOS X:

Main thread - about to create secondary thread
Secondary thread - created
Main thread: UI thread callback 1 taking place - claiming mutex
Secondary thread - About to BeginInvoke cb2 - if this blocks, it's a bug!


Additional Information:

I have attempted to make a patch, which I will attach after I've submitted
this. However I have not tested this - I am struggling to get Mono to build.
It's just my best guess at where the problem lies.


-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



























































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="095042.html">[Mono-bugs] [Bug 556181] Wrong Dpi values when created Graphic instance with Graphic.FromImage()
</A></li>
	<LI>Next message: <A HREF="095044.html">[Mono-bugs] [Bug 556183] [Patch] Mac event pump can cause Control.BeginInvoke to block
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95043">[ date ]</a>
              <a href="thread.html#95043">[ thread ]</a>
              <a href="subject.html#95043">[ subject ]</a>
              <a href="author.html#95043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
