<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 557606] New: Compilation of polymorphic recursion	is too eager
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20557606%5D%20New%3A%20Compilation%20of%20polymorphic%20recursion%0A%09is%20too%20eager&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="095112.html">
   <LINK REL="Next"  HREF="095119.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 557606] New: Compilation of polymorphic recursion	is too eager</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20557606%5D%20New%3A%20Compilation%20of%20polymorphic%20recursion%0A%09is%20too%20eager&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 557606] New: Compilation of polymorphic recursion	is too eager">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Nov 22 11:55:27 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="095112.html">[Mono-bugs] [Bug 557510] Error stepping through code, MonoTouch 1.2,	eval
</A></li>
        <LI>Next message: <A HREF="095119.html">[Mono-bugs] [Bug 557606] Compilation of polymorphic recursion is	too eager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95115">[ date ]</a>
              <a href="thread.html#95115">[ thread ]</a>
              <a href="subject.html#95115">[ subject ]</a>
              <a href="author.html#95115">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=557606">http://bugzilla.novell.com/show_bug.cgi?id=557606</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=557606#c0">http://bugzilla.novell.com/show_bug.cgi?id=557606#c0</A>


           Summary: Compilation of polymorphic recursion is too eager
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.4.x
          Platform: Other
        OS/Version: Ubuntu
            Status: NEW
          Severity: Critical
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">ekirpichov at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Community User
           Blocker: ---


Description of Problem:


Steps to reproduce the problem:
1. Create a file with the following source code:

using System;

namespace csharppolyrec
{
    struct S&lt;T&gt; {}

    class MainClass    {
        private static void f&lt;T&gt;(int i) {
            if(i==42) f&lt;S&lt;T&gt;&gt;(i);
        }
        public static void Main(string[] args) {
            f&lt;int&gt;(0);
            Console.WriteLine(&quot;Hello World!&quot;);
        }
    }
}

2. Compile it.
3. Run the result.


Actual Results:
The program hangs. Running under gdb yields a stacktrace full of
mono_metadata_type_hash, which is a clear sign that mono tries to eagerly
instantiate all the possible parameterizations of f(), of which there is
clearly an infinite number.

Expected Results:
The program should print &quot;Hello world!&quot; and terminate. This is what happens on
the Microsoft CLR virtual machine.

How often does this happen? 
This happens always, at least in version 2.4.2.3.

Additional Information:
If I replace the condition with &quot;if(false)&quot; then the compiler reports an
unreachable code warning but the program runs fine.

Generic instantiation should be done lazily in runtime (at the time of method
invocation), not during some data-flow analysis pass. Of course this is a lot
harder and may slow things down for polymorphically recursive stuff, but this
won't harm performance for monomorphically recursive methods (which are used
99% of the time) if they are detected statically.
I unfortunately do not have access to a Windows machine to check whether
polymorphic recursion gets compiled by MS CLR to slower code than monomorphic
recursion.

This compiler bug prevents one from implementing some polymorphically recursive
data structures, such as the ones described in Okasaki's &quot;Purely functional
data structures, in the chapter on numeric representations, in a type-safe way.
So I think that marking the bug &quot;critical&quot; is fair.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>




















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="095112.html">[Mono-bugs] [Bug 557510] Error stepping through code, MonoTouch 1.2,	eval
</A></li>
	<LI>Next message: <A HREF="095119.html">[Mono-bugs] [Bug 557606] Compilation of polymorphic recursion is	too eager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95115">[ date ]</a>
              <a href="thread.html#95115">[ thread ]</a>
              <a href="subject.html#95115">[ subject ]</a>
              <a href="author.html#95115">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
