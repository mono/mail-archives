<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 79312][Nor] Changed - returning a struct by value	giving unexpected results
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2079312%5D%5BNor%5D%20Changed%20-%20returning%20a%20struct%20by%20value%0A%09giving%20unexpected%20results&In-Reply-To=bug-79312%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="046605.html">
   <LINK REL="Next"  HREF="046607.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 79312][Nor] Changed - returning a struct by value	giving unexpected results</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2079312%5D%5BNor%5D%20Changed%20-%20returning%20a%20struct%20by%20value%0A%09giving%20unexpected%20results&In-Reply-To=bug-79312%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 79312][Nor] Changed - returning a struct by value	giving unexpected results">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Thu Sep  7 18:08:48 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="046605.html">[Mono-bugs] [Bug 79319][Nor] New - Console.SetCursorPosition	doesn't sets the cursor to a remembered position
</A></li>
        <LI>Next message: <A HREF="046607.html">[Mono-bugs] [Bug 78993][Nor] Changed - Mac install broken on Tiger	ppc.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46606">[ date ]</a>
              <a href="thread.html#46606">[ thread ]</a>
              <a href="subject.html#46606">[ subject ]</a>
              <a href="author.html#46606">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">james.eberle at comcast.net.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=79312">http://bugzilla.ximian.com/show_bug.cgi?id=79312</A>

--- shadow/79312	2006-09-07 17:04:09.000000000 -0400
+++ shadow/79312.tmp.20786	2006-09-07 18:08:48.000000000 -0400
@@ -176,6 +176,192 @@
 
 
 
 ------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">robertj at gmx.net</A>  2006-09-07 17:04 -------
 Jim, if you still have questions, reopen the bug.
 
+
+------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">james.eberle at comcast.net</A>  2006-09-07 18:08 -------
+Apologies for dragging this out. I agree w/ your assessment (for the
+most part
+:) ). It's a C-linkage question more than anything to do w/ Mono.
+Short answer
+is that per PPC32 OSX ABI standards, void* are returned in GPR3, whereas
+composite values are returned as an address in GPR3. I'm including the
+code I
+used to demonstrate this to myself.
+
+I still have 2 questions.
+
+1. Since &quot;IntPtr&quot; is defined as struct, why doesn't it fall to the
+same incorrect
+bindings as any other struct? Is it a special-case at the p/invoke code?
+
+2. Can I use a MarshalAs attribute to force the proper return value
+semantics?
+I've tried this but could not get desired behavior.
+
+Many thanks!
+Jim
+
+--- Apple's PPC32 ABI ----
+
+<A HREF="http://developer.apple.com/documentation/DeveloperTools/Conceptual/LowLevelABI/LowLevelABI.pdf">http://developer.apple.com/documentation/DeveloperTools/Conceptual/LowLevelABI/LowLevelABI.pdf</A>
+
+32-bit PowerPC Function Calling Conventions
+
+* Returning Results *
+The following list describes where a function's return value is passed
+to the caller.
+
+- Scalars smaller than 4 bytes (such as char and short) are placed in
+the low
+  word of GPR3. The register's highword is undefined.
+
+- Scalars 4 bytes in size (such as long, int, and pointers, including
+array
+  pointers) are placed in GPR3.
+
+- Values of type long long are returned in the high word of GPR3 and
+the low
+  word of GPR4.
+
+- Floating-point values are placed in FPR1.
+
+- Composite values (such as struct and union) and values larger than 4
+bytes
+  are placed at the location pointed to by GPR3.
+
+--- Apple's PPC32 ABI (End) ----
+
+--- The gory details ----
+
+$ cat pt.c
+
+struct ShortPoint {
+  short x;
+  short y;
+};
+
+struct ShortPoint GetPoint() {
+  struct ShortPoint ret = { 16, 32 };
+  return ret;
+}
+
+void* GetPVoid() {
+  return (void*)8192;
+}
+
+$ gcc -c pt.c
+$ gcc -dynamiclib -o pt.dylib pt.o
+
+$ cat callpt.cs
+
+using System;
+using System.Runtime.InteropServices;
+
+struct ShortPoint {
+  internal short x;
+  internal short y;
+}
+
+struct IntStruct {
+  internal int x;
+}
+
+struct Call {
+  const string LIB = &quot;pt.dylib&quot;;
+
+  public static void Main() {
+    ShortPoint pt = GetPoint();
+    Console.WriteLine(&quot;x: {0} y: {1}&quot;, (int)pt.x, (int)pt.y);
+
+    IntPtr    a = GetPVoid1();
+    IntStruct b = GetPVoid2();
+    Console.WriteLine(&quot;a: {0} b: {1}&quot;, (int)a, (int)b.x);
+  }
+
+  [DllImport(LIB)]
+  public static extern ShortPoint GetPoint();
+
+  [DllImport(LIB, EntryPoint=&quot;GetPVoid&quot;)]
+  public static extern IntPtr GetPVoid1();
+
+  [DllImport(LIB, EntryPoint=&quot;GetPVoid&quot;)]
+  public static extern IntStruct GetPVoid2();
+
+}
+
+$ mcs -warn:4 callpt.cs
+$ mono callpt.exe
+x: 16 y: 32
+a: 8192 b: 0
+
+$ cat callpt.c
+
+#include &lt;dlfcn.h&gt;
+#include &lt;stdio.h&gt;
+
+struct ShortPoint {
+  short x;
+  short y;
+};
+
+typedef struct ShortPoint (*GETPT)();
+typedef void* (*GETPV)();
+
+int main(int argc, char* argv[]) {
+  void* lib = dlopen(&quot;pt.dylib&quot;, RTLD_LAZY);
+  if (lib == 0) {
+    return 1;
+  }
+  GETPT GetPoint = (GETPT)dlsym(lib, &quot;GetPoint&quot;);
+  GETPV GetPVoid = (GETPV)dlsym(lib, &quot;GetPVoid&quot;);
+  struct ShortPoint pt = GetPoint();
+  void* pv = GetPVoid();
+  printf(&quot;x: %hd, y: %hd\n&quot;, pt.x, pt.y);
+  printf(&quot;p: %d\n&quot;, pv);
+  dlclose(lib);
+  return 0;
+}
+
+$ gcc -g -o callpt callpt.c
+$ gcc -g -c pt.c
+$ gcc -dynamiclib -o pt.dylib pt.o
+
+$ ./callpt
+x: 16, y: 32
+p: 8192
+
+$ gdb callpt
+
+(gdb) disas
+Dump of assembler code for function GetPoint:
+0x00006f44 &lt;GetPoint+0&gt;:        stmw    r30,-8(r1)
+0x00006f48 &lt;GetPoint+4&gt;:        stwu    r1,-64(r1)
+0x00006f4c &lt;GetPoint+8&gt;:        mr      r30,r1
+0x00006f50 &lt;GetPoint+12&gt;:       mr      r2,r3
+0x00006f54 &lt;GetPoint+16&gt;:       li      r0,16
+0x00006f58 &lt;GetPoint+20&gt;:       sth     r0,24(r30)
+0x00006f5c &lt;GetPoint+24&gt;:       li      r0,32
+0x00006f60 &lt;GetPoint+28&gt;:       sth     r0,26(r30)
+0x00006f64 &lt;GetPoint+32&gt;:       lwz     r0,24(r30)
+0x00006f68 &lt;GetPoint+36&gt;:       stw     r0,0(r2)
+0x00006f6c &lt;GetPoint+40&gt;:       mr      r3,r2     ; &lt;-- return ref to
+stack in r3
+0x00006f70 &lt;GetPoint+44&gt;:       lwz     r1,0(r1)
+0x00006f74 &lt;GetPoint+48&gt;:       lmw     r30,-8(r1)
+0x00006f78 &lt;GetPoint+52&gt;:       blr
+End of assembler dump.
+
+(gdb) disas
+Dump of assembler code for function GetPVoid:
+0x00006f7c &lt;GetPVoid+0&gt;:        stmw    r30,-8(r1)
+0x00006f80 &lt;GetPVoid+4&gt;:        stwu    r1,-48(r1)
+0x00006f84 &lt;GetPVoid+8&gt;:        mr      r30,r1
+0x00006f88 &lt;GetPVoid+12&gt;:       li      r0,8192
+0x00006f8c &lt;GetPVoid+16&gt;:       mr      r3,r0     ; &lt;-- return value in r3
+0x00006f90 &lt;GetPVoid+20&gt;:       lwz     r1,0(r1)
+0x00006f94 &lt;GetPVoid+24&gt;:       lmw     r30,-8(r1)
+0x00006f98 &lt;GetPVoid+28&gt;:       blr
+End of assembler dump.
+
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="046605.html">[Mono-bugs] [Bug 79319][Nor] New - Console.SetCursorPosition	doesn't sets the cursor to a remembered position
</A></li>
	<LI>Next message: <A HREF="046607.html">[Mono-bugs] [Bug 78993][Nor] Changed - Mac install broken on Tiger	ppc.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46606">[ date ]</a>
              <a href="thread.html#46606">[ thread ]</a>
              <a href="subject.html#46606">[ subject ]</a>
              <a href="author.html#46606">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
