<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 339530] [PATCH] BSTR convertion doesn't roundtrip
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20339530%5D%20%5BPATCH%5D%20BSTR%20convertion%20doesn%27t%20roundtrip&In-Reply-To=bug-339530-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="074309.html">
   <LINK REL="Next"  HREF="074203.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 339530] [PATCH] BSTR convertion doesn't roundtrip</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20339530%5D%20%5BPATCH%5D%20BSTR%20convertion%20doesn%27t%20roundtrip&In-Reply-To=bug-339530-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 339530] [PATCH] BSTR convertion doesn't roundtrip">bugzilla_noreply at novell.com
       </A><BR>
    <I>Thu May 22 19:10:28 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="074309.html">[Mono-bugs] [Bug 393775] SaveFileDialog + richtextbox
</A></li>
        <LI>Next message: <A HREF="074203.html">[Mono-bugs] [Bug 339530] [PATCH] BSTR convertion doesn't roundtrip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74202">[ date ]</a>
              <a href="thread.html#74202">[ thread ]</a>
              <a href="subject.html#74202">[ subject ]</a>
              <a href="author.html#74202">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=339530">https://bugzilla.novell.com/show_bug.cgi?id=339530</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tom_hindle at sil.org</A> added comment
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=339530#c4">https://bugzilla.novell.com/show_bug.cgi?id=339530#c4</A>


tom hindle &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tom_hindle at sil.org</A>&gt; changed:

           What    |Removed                                         |Added
----------------------------------------------------------------------------
                 CC|                                                |<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tom_hindle at sil.org</A>
             Status|RESOLVED                                        |REOPENED
         Resolution|FIXED                                           |




--- Comment #4 from tom hindle &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tom_hindle at sil.org</A>&gt;  2008-05-22 17:10:27 MST ---
This bug fix seems to have been lost.

in functions
mono_string_from_bstr and mono_string_to_bstr in mono/metadata/marshal.c

BSTR's marshaled from string's now incorrectly contain max 'character' length
and not byte length in the 4 bytes preceding the start of the BSTR string data.


the Diff for /trunk/mono/mono/metadata/marshal.c between version 89012 and
103314

seems to suggest that this change possibly got lost when  
'if (com_provider == MONO_COM_DEFAULT) {' stuff was added.



in mono_string_to_bstr:
* ((guint32 *) ret) = slen;                svn number 103314

* ((guint32 *) ret) = slen * 2;            svn number 89012
in mono_string_from_bstr

in the older mono_string_to_bstr marshal.c(89012) slen is correctly multiplied
by 2 to store the byte length.



in mono_string_from_bstr:
return mono_string_new_utf16 (mono_domain_get (), bstr, *(guint32 *)((char
*)bstr - 4));             svn number 103314

return mono_string_new_utf16 (mono_domain_get (), bstr, *(guint32 *)((char
*)bstr - 4) / 2);         svn number 89012

in the older mono_string_from_bstr marshal.c(89012) the byte length is
correctly divided by to give the max number of UTF16 'characters'



This incorrectly constructed BSTR can cause native objects, which perform
operations on BSTR marshaled to them from mono, to only use a maximum of half
the string length.
This occurs if the native objects use the BSTR explicit length rather than the
reading to the BSTR NULL terminator.



-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="074309.html">[Mono-bugs] [Bug 393775] SaveFileDialog + richtextbox
</A></li>
	<LI>Next message: <A HREF="074203.html">[Mono-bugs] [Bug 339530] [PATCH] BSTR convertion doesn't roundtrip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#74202">[ date ]</a>
              <a href="thread.html#74202">[ thread ]</a>
              <a href="subject.html#74202">[ subject ]</a>
              <a href="author.html#74202">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
