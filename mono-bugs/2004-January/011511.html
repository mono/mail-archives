<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 53229][Maj] New - Using BeginReceive on a Socket causes SocketException in worker thread when Socket is closed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="011509.html">
   <LINK REL="Next"  HREF="011512.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 53229][Maj] New - Using BeginReceive on a Socket causes SocketException in worker thread when Socket is closed
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 53229][Maj] New - Using BeginReceive on a Socket causes SocketException in worker thread when Socket is closed">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Thu, 22 Jan 2004 14:45:21 -0500 (EST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="011509.html">[Mono-bugs] [Bug 53227][Nor] New - XmlNode.WriteTo should not inherit writer namespace
</A></li>
        <LI> Next message: <A HREF="011512.html">[Mono-bugs] [Bug 53230][Min] New - Synclock Blocks Not Implemented
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11511">[ date ]</a>
              <a href="thread.html#11511">[ thread ]</a>
              <a href="subject.html#11511">[ subject ]</a>
              <a href="author.html#11511">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:jconley@winfessor.com.">jconley@winfessor.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=53229">http://bugzilla.ximian.com/show_bug.cgi?id=53229</A>

--- shadow/53229	2004-01-22 14:45:21.000000000 -0500
+++ shadow/53229.tmp.18263	2004-01-22 14:45:21.000000000 -0500
@@ -0,0 +1,125 @@
+Bug#: 53229
+Product: Mono/Class Libraries
+Version: unspecified
+OS: 
+OS Details: Windows Server 2003 Enterprise Edition
+Status: NEW   
+Resolution: 
+Severity: Unknown
+Priority: Major
+Component: System
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:jconley@winfessor.com">jconley@winfessor.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: Using BeginReceive on a Socket causes SocketException in worker thread when Socket is closed
+
+Description of Problem: If the asynchronous BeginReceive method is used on 
+a System.Net.Sockets.Socket, an exception will be thrown in the worker 
+thread when the socket is closed, and the AsyncCallback specified in 
+BeginReceive will not be called.
+
+Steps to reproduce the problem:
+1. Create a InterNetwork TCP Socket with no flags.
+2. Connect the socket to something.
+3. Call BeginReceive and specify a callback.
+4. Close the socket.
+
+Actual Results:
+The following exception is thrown in the worker thread and printed to the 
+console and the user code is never notified.
+
+Unhandled Exception: System.Net.Sockets.SocketException: Some sort of w32 
+error occurred: 0
+in (unmanaged) (wrapper managed-to-native) 
+System.Net.Sockets.Socket:Receive_internal (intptr,byte
+[],int,int,System.Net.
+Sockets.SocketFlags)
+in &lt;0x00004&gt; (wrapper managed-to-native) 
+System.Net.Sockets.Socket:Receive_internal (intptr,byte
+[],int,int,System.Net.So
+ckets.SocketFlags)
+in [0x00054] (at /cvs/mcs/class/System/System.Net.Sockets/Socket.cs:872) 
+System.Net.Sockets.Socket:Receive (byte[],int,i
+nt,System.Net.Sockets.SocketFlags)
+in [0x00067] (at /cvs/mcs/class/System/System.Net.Sockets/Socket.cs:874) 
+System.Net.Sockets.Socket:Receive (byte[],int,i
+nt,System.Net.Sockets.SocketFlags)
+in [0x0003c] 
+(at /cvs/mcs/class/System/System.Net.Sockets/Socket.cs:184) .Worker:Receive
+ ()
+in &lt;0x00044&gt; (wrapper delegate-invoke) 
+System.MulticastDelegate:invoke_void ()
+
+
+Expected Results:
+No exception should occur.  Instead, the AsyncCallback should be called 
+and the subsequent call to EndReceive should return 0 bytes.
+
+How often does this happen? 
+Every time.
+
+Additional Information:
+Here's a VB.NET class that can be used to duplicate the problem.  I 
+haven't tried to compile it with Mono, but it runs fine after being 
+compiled with the MS compiler.
+
+Public Class BreakMonoSockets
+    Public Sub DontBreakIt()
+        System.Console.WriteLine(&quot;creating socket&quot;)
+        Dim s As New System.Net.Sockets.Socket
+(Net.Sockets.AddressFamily.InterNetwork, Net.Sockets.SocketType.Stream, 
+Net.Sockets.ProtocolType.Tcp)
+
+        System.Console.WriteLine(&quot;connecting to endpoint&quot;)
+        s.Connect(New System.Net.IPEndPoint(System.Net.Dns.GetHostByName
+(&quot;www.go-mono.org&quot;).AddressList(0), 80))
+
+        System.Console.WriteLine(&quot;closing socket&quot;)
+        s.Close()
+    End Sub
+
+    Public Sub BreakIt()
+        System.Console.WriteLine(&quot;creating socket&quot;)
+        Dim s As New System.Net.Sockets.Socket
+(Net.Sockets.AddressFamily.InterNetwork, Net.Sockets.SocketType.Stream, 
+Net.Sockets.ProtocolType.Tcp)
+
+        System.Console.WriteLine(&quot;connecting to endpoint&quot;)
+        s.Connect(New System.Net.IPEndPoint(System.Net.Dns.GetHostByName
+(&quot;www.go-mono.org&quot;).AddressList(0), 80))
+
+        System.Console.WriteLine(&quot;setting up beginreceive&quot;)
+        Dim receiveBuff(1024) As Byte
+        s.BeginReceive(receiveBuff, 0, receiveBuff.Length, 
+Net.Sockets.SocketFlags.None, AddressOf beginreceivecb, s)
+
+        System.Console.WriteLine(&quot;closing socket&quot;)
+        s.Close()
+    End Sub
+
+    Private Sub beginreceivecb(ByVal ar As IAsyncResult)
+        Try
+            Dim s As System.Net.Sockets.Socket = DirectCast(ar.AsyncState, 
+System.Net.Sockets.Socket)
+            Dim size As Integer = s.EndReceive(ar)
+
+            System.Console.WriteLine(&quot;beginreceivecb called with &quot; &amp; size 
+&amp; &quot; bytes received&quot;)
+
+            If size &gt; 0 Then
+                System.Console.WriteLine(&quot;called beginreceive again&quot;)
+                Dim receiveBuff(1024) As Byte
+                s.BeginReceive(receiveBuff, 0, receiveBuff.Length, 
+Net.Sockets.SocketFlags.None, AddressOf beginreceivecb, s)
+            Else
+                System.Console.WriteLine(&quot;size was less than or equal to 
+0&quot;)
+            End If
+        Catch ex As Exception
+            System.Console.WriteLine(&quot;exception occurred in 
+beginreceivecb: &quot; &amp; ex.ToString)
+        End Try
+    End Sub

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="011509.html">[Mono-bugs] [Bug 53227][Nor] New - XmlNode.WriteTo should not inherit writer namespace
</A></li>
	<LI> Next message: <A HREF="011512.html">[Mono-bugs] [Bug 53230][Min] New - Synclock Blocks Not Implemented
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11511">[ date ]</a>
              <a href="thread.html#11511">[ thread ]</a>
              <a href="subject.html#11511">[ subject ]</a>
              <a href="author.html#11511">[ author ]</a>
         </LI>
       </UL>
</body></html>
