<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 561667] New: Disposing a SqlCommand should dispose associated SqlDataReaders
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20561667%5D%20New%3A%20Disposing%20a%20SqlCommand%20should%20dispose%0A%20associated%20SqlDataReaders&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="095570.html">
   <LINK REL="Next"  HREF="095574.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 561667] New: Disposing a SqlCommand should dispose associated SqlDataReaders</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20561667%5D%20New%3A%20Disposing%20a%20SqlCommand%20should%20dispose%0A%20associated%20SqlDataReaders&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 561667] New: Disposing a SqlCommand should dispose associated SqlDataReaders">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Dec  8 12:21:09 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="095570.html">[Mono-bugs] [Bug 561650] New: MonoDevelop Editor Slowdown
</A></li>
        <LI>Next message: <A HREF="095574.html">[Mono-bugs] [Bug 561723] New: [Regression] Compilation Error error in mojoportal 2.3.3.1 on mono-2.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95572">[ date ]</a>
              <a href="thread.html#95572">[ thread ]</a>
              <a href="subject.html#95572">[ subject ]</a>
              <a href="author.html#95572">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=561667">http://bugzilla.novell.com/show_bug.cgi?id=561667</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=561667#c0">http://bugzilla.novell.com/show_bug.cgi?id=561667#c0</A>


           Summary: Disposing a SqlCommand should dispose associated
                    SqlDataReaders
    Classification: Mono
           Product: Mono: Class Libraries
           Version: SVN
          Platform: x86-64
        OS/Version: openSUSE 11.2
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.Data
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">bnc-blr-team-mono at forge.provo.novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jpryor at novell.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Disposing a System.Data.SqlClient.SqlCommand should close any associated
SqlDataReaders.  Consider this code snippet:

        protected override DataTable GetColumns(DbConnection connection)
        {
            var t = new DataTable(&quot;Columns&quot;);
            using (var c = connection.CreateCommand())
            {
                c.CommandText = &quot;SELECT * FROM [TABLE]&quot;;
                t.Load(c.ExecuteReader());
            }
            return t;
        }

Notice that we ensure that the SqlCommand is disposed.

However, if we subsequently call this same method a second time (or a method
that's identical save for the SQL, the SQL query is really irrelevant), then we
get:

System.InvalidOperationException: There is already an open DataReader
associated with this Connection which must be closed first.
  at System.Data.SqlClient.SqlCommand.ValidateCommand (System.String method,
Boolean async) [0x0010e] in
/home/jon/Development/mono-HEAD/mcs/class/System.Data/System.Data.SqlClient/SqlCommand.cs:776 
  at System.Data.SqlClient.SqlCommand.ExecuteReader (CommandBehavior behavior)
[0x00000] in
/home/jon/Development/mono-HEAD/mcs/class/System.Data/System.Data.SqlClient/SqlCommand.cs:585 
  at System.Data.SqlClient.SqlCommand.ExecuteDbDataReader (CommandBehavior
behavior) [0x00000] in
/home/jon/Development/mono-HEAD/mcs/class/System.Data/System.Data.SqlClient/SqlCommand.cs:786 
  at System.Data.Common.DbCommand.ExecuteReader () [0x00000] in
/home/jon/Development/mono-HEAD/mcs/class/System.Data/System.Data.Common/DbCommand.cs:123 
  at (wrapper remoting-invoke-with-check)
System.Data.Common.DbCommand:ExecuteReader ()

The reason is because the SqlCommand.Dispose() method doesn't call
SqlCommand.CloseDataReader().  To allow such use the user needs to explicitly
dispose the SqlDataReader:

        protected override DataTable GetColumns(DbConnection connection)
        {
            var t = new DataTable(&quot;Columns&quot;);
            using (var c = connection.CreateCommand())
            {
                c.CommandText = &quot;SELECT * FROM [TABLE]&quot;;
                using (var r = c.ExecuteReader())
                    t.Load(r);
            }
            return t;
        }

The point is, though, the original method works as expected under .NET (no
exception), while the second method is required under Mono.  Mono should
support the same source code as .NET.

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="095570.html">[Mono-bugs] [Bug 561650] New: MonoDevelop Editor Slowdown
</A></li>
	<LI>Next message: <A HREF="095574.html">[Mono-bugs] [Bug 561723] New: [Regression] Compilation Error error in mojoportal 2.3.3.1 on mono-2.6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95572">[ date ]</a>
              <a href="thread.html#95572">[ thread ]</a>
              <a href="subject.html#95572">[ subject ]</a>
              <a href="author.html#95572">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
