<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 537764] Mono crashes on OS X Snow Leopard
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20537764%5D%20Mono%20crashes%20on%20OS%20X%20Snow%20Leopard&In-Reply-To=bug-537764-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="095416.html">
   <LINK REL="Next"  HREF="095423.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 537764] Mono crashes on OS X Snow Leopard</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20537764%5D%20Mono%20crashes%20on%20OS%20X%20Snow%20Leopard&In-Reply-To=bug-537764-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 537764] Mono crashes on OS X Snow Leopard">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Dec  2 15:40:26 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="095416.html">[Mono-bugs] [Bug 560064] New: Variable containing result-tree-fragment should be true()
</A></li>
        <LI>Next message: <A HREF="095423.html">[Mono-bugs] [Bug 551211] Please change IOMAP in the VS dialogs to something more descriptive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95422">[ date ]</a>
              <a href="thread.html#95422">[ thread ]</a>
              <a href="subject.html#95422">[ subject ]</a>
              <a href="author.html#95422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=537764">http://bugzilla.novell.com/show_bug.cgi?id=537764</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=537764#c18">http://bugzilla.novell.com/show_bug.cgi?id=537764#c18</A>


--- Comment #18 from Laurent Etiemble &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">laurent.etiemble at gmail.com</A>&gt; 2009-12-02 20:40:17 UTC ---
Created an attachment (id=330599)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=330599">http://bugzilla.novell.com/attachment.cgi?id=330599</A>)
Avoid re-registration of foreign threads on Darwin platforms

Here are the result of my investigations:

I have first try to solve the issue by modifying the way Monobjc plugs into the
Objective-C runtime. There were some success, but the crash did not go away. It
seems that the workaround did not catch all the paths. I don't think we can
achieve a correction this way.

So, I have investigated a bit more about the double-registration of foreign
threads. It appears that it already occurs in Leopard but the crash does not
show.

Here is my understanding:
- When some managed code is called from native library, Mono registers the
current thread as foreign.
- In order to de-register the thread when it exits, Mono binds a destuctor
function (GC_thread_deregister_foreign) to a TSD (Thread Specific Data) key.
- When the foreign thread exits (pthread_exit), all the TSD are cleared and
their non-NULL destructor function are called. Mono de-register the foreign
thread.
- After the TSD are cleared, the Objective-C runtime sends a notification
(NSThreadWillExitNotification). Some code in Monobjc is invoked leading to a
native/managed call. The thread is re-registered as foreign.
- The GC_thread_deregister_foreign is re-bound to its TSD.
- On Leopard (Mac OS X 10.5), the TSD are cleared again thus leading the
re-registered thread to be re-de-registered.
- On Snow Leopard (Mac OS X 10.6), the TSD are not cleared in the same way thus
leaving the re-registered thread as is. The GC has now a stale reference on a
destroyed thread. As the order of the TSD destruction is unspecified, I assume
that it is the cause of the crash.

The first proposed patches aim at hiding the crash when a stale thread was
suspended. It was leaving the GC with some leaked bits.

The attached patch goes a step further. Instead of masking the result of the
double-registration, it avoids it. The trick used is to use a TSD mark on
foreign thread during the first register, so if the same thread is registered
again, the GC does nothing when it detects the mark. To avoid the result of the
unspecified order of the TSD destruction, we re-set the TSD mark in destructor
function (permitted by
<A HREF="http://developer.apple.com/mac/library/documentation/Darwin/Reference/ManPages/man3/pthread_key_create.3.html">http://developer.apple.com/mac/library/documentation/Darwin/Reference/ManPages/man3/pthread_key_create.3.html</A>).

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="095416.html">[Mono-bugs] [Bug 560064] New: Variable containing result-tree-fragment should be true()
</A></li>
	<LI>Next message: <A HREF="095423.html">[Mono-bugs] [Bug 551211] Please change IOMAP in the VS dialogs to something more descriptive
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#95422">[ date ]</a>
              <a href="thread.html#95422">[ thread ]</a>
              <a href="subject.html#95422">[ subject ]</a>
              <a href="author.html#95422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
