<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 695203] New: KnownType for Derived Class not	Resolved
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20695203%5D%20New%3A%20KnownType%20for%20Derived%20Class%20not%0A%09Resolved&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="111940.html">
   <LINK REL="Next"  HREF="111942.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 695203] New: KnownType for Derived Class not	Resolved</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20695203%5D%20New%3A%20KnownType%20for%20Derived%20Class%20not%0A%09Resolved&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 695203] New: KnownType for Derived Class not	Resolved">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri May 20 13:24:40 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="111940.html">[Mono-bugs] [Bug 670294] AddSubview and Garbage collection
</A></li>
        <LI>Next message: <A HREF="111942.html">[Mono-bugs] [Bug 591702] PrivateFontCollection does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#111941">[ date ]</a>
              <a href="thread.html#111941">[ thread ]</a>
              <a href="subject.html#111941">[ subject ]</a>
              <a href="author.html#111941">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=695203">https://bugzilla.novell.com/show_bug.cgi?id=695203</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=695203#c0">https://bugzilla.novell.com/show_bug.cgi?id=695203#c0</A>


           Summary: KnownType for Derived Class not Resolved
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.10.x
          Platform: x86
        OS/Version: openSUSE 11.3
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: WCF
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">atsushi at ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">cristiano.simionato at cocai.eu</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows NT 6.1; WOW64; rv:2.0.1) Gecko/20100101
Firefox/4.0.1

In a hierarchy of classes the base class has to have all KnownTypeAttribute of
the derived and not olny the direct derived.

In this example code, the second serialization throw an SerializationException
of type unexpected, but in .Net all run correctly.

class Program
{
    static void Main()
    {
        using (var mem = new MemoryStream())
        {
            BaseClass data = new DerivedA1 { Code = &quot;1&quot;, CodeA = &quot;A&quot;, CodeA1 =
&quot;A1&quot; };
            Serialize(data, mem);
            mem.Position = 0;
            var docResult = Deserialize&lt;BaseClass&gt;(mem);
        }

        using (var mem = new MemoryStream())
        {
            BaseClass data = new DerivedA2 { Code = &quot;1&quot;, CodeA = &quot;A&quot;, CodeA2 =
&quot;A1&quot; };

            ///////////////////////////////////////////////
            // The next serialization throw an SerializationException
            ///////////////////////////////////////////////
            Serialize(data, mem);


            mem.Position = 0;
            var docResult = Deserialize&lt;BaseClass&gt;(mem);
        }
    }


    public static void Serialize&lt;T&gt;(T instance, Stream destinationStream)
    {
        var serializer = new DataContractSerializer(typeof(T), null,
int.MaxValue, false, true, null);

        using (var writer =
XmlDictionaryWriter.CreateBinaryWriter(destinationStream, null, null, false))
        {
            serializer.WriteObject(writer, instance);
        }
    }


    public static T Deserialize&lt;T&gt;(Stream sourceStream)
    {
        var serializer = new DataContractSerializer(typeof(T), null,
int.MaxValue, false, true, null);

        using (var reader =
XmlDictionaryReader.CreateBinaryReader(sourceStream,
XmlDictionaryReaderQuotas.Max))
        {
            return (T)serializer.ReadObject(reader);
        }
    }
}

[DataContract]
[KnownType(typeof(DerivedA1))]
[KnownType(typeof(DerivedA))]
public abstract class BaseClass
{
    [DataMember]
    public string Code { get; set; }
}


[DataContract]
[KnownType(typeof(DerivedA1))]
[KnownType(typeof(DerivedA2))]
public abstract class DerivedA : BaseClass
{
    public string CodeA { get; set; }
}

[DataContract]
public class DerivedA1 : DerivedA
{
    [DataMember]
    public string CodeA1 { get; set; }
}

[DataContract]
public class DerivedA2 : DerivedA
{
    [DataMember]
    public string CodeA2 { get; set; }
}

Reproducible: Always

Steps to Reproduce:
1. Create an Application Console with the code of the Details targeting .Net4
2. Run the application
3. the second serialization throw the exception.
Actual Results:  
System.Runtime.Serialization.SerializationException has been thrown
&quot;Type 'MyNameSpace.DerivedA2' is unexpected. The type should either be
registered as known type, or DataContractResolver should be used.&quot;

Stack Trace:
  at System.Runtime.Serialization.DataContractSerializer.WriteStartObject
(System.Xml.XmlDictionaryWriter writer, System.Object graph) [0x00137] in
/usr/src/packages/BUILD/mono-2.10.2/mcs/class/System.Runtime.Serialization/System.Runtime.Serialization/DataContractSerializer.cs:463 
  at System.Runtime.Serialization.XmlObjectSerializer.WriteObject
(System.Xml.XmlDictionaryWriter writer, System.Object graph) [0x00000] in
/usr/src/packages/BUILD/mono-2.10.2/mcs/class/System.Runtime.Serialization/System.Runtime.Serialization/XmlObjectSerializer.cs:106 
  at MyNameSpace.Program.Serialize[BaseClass] (MyNameSpace.BaseClass instance,
System.IO.Stream destinationStream) [0x00023] in
/home/xxxx/Projects/MyNameSpace/MyNameSpace/Program.cs:38 
  at MyNameSpace.Program.Main () [0x0008d] in
/home/xxxx/Projects/MyNameSpace/MyNameSpace/Program.cs:25 

Expected Results:  
None exception.

Mono update to last 10.2 stable.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="111940.html">[Mono-bugs] [Bug 670294] AddSubview and Garbage collection
</A></li>
	<LI>Next message: <A HREF="111942.html">[Mono-bugs] [Bug 591702] PrivateFontCollection does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#111941">[ date ]</a>
              <a href="thread.html#111941">[ thread ]</a>
              <a href="subject.html#111941">[ subject ]</a>
              <a href="author.html#111941">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
