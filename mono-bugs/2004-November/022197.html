<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 68972][Nor] New - XSD creates buggy typed datasets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="022196.html">
   <LINK REL="Next"  HREF="022198.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 68972][Nor] New - XSD creates buggy typed datasets
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 68972][Nor] New - XSD creates buggy typed datasets">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Mon,  1 Nov 2004 07:48:15 -0500 (EST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="022196.html">[Mono-bugs] [Bug 68070][Wis] Changed - The xsp hangs or abort on multiple requests.
</A></li>
        <LI> Next message: <A HREF="022198.html">[Mono-bugs] [Bug 67264][Maj] Changed - string.ctor with encoding objunimplemented
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22197">[ date ]</a>
              <a href="thread.html#22197">[ thread ]</a>
              <a href="subject.html#22197">[ subject ]</a>
              <a href="author.html#22197">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:juergen@cis-comsoft.de.">juergen@cis-comsoft.de.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=68972">http://bugzilla.ximian.com/show_bug.cgi?id=68972</A>

--- shadow/68972	2004-11-01 07:48:15.000000000 -0500
+++ shadow/68972.tmp.19584	2004-11-01 07:48:15.000000000 -0500
@@ -0,0 +1,164 @@
+Bug#: 68972
+Product: Mono: Compilers
+Version: unspecified
+OS: GNU/Linux [Other]
+OS Details: Ubuntu 4.10
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: XSD
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:juergen@cis-comsoft.de">juergen@cis-comsoft.de</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: XSD creates buggy typed datasets
+
+Description of Problem:
+
+XSD creates strongly typed DataSets that throw exceptions when accessing
+the column-properties of datarows.
+
+Steps to reproduce the problem:
+step 1.
+Create Database on PostgreSQL
+Use this as input for psql:
+
+CREATE DATABASE test;
+
+\c test
+
+CREATE TABLE &quot;simple&quot; (
+    nr smallint,
+    name character varying(10)
+);
+
+COPY &quot;simple&quot; (nr, name) FROM stdin;
+1	Peter
+2	Paul
+3	Mary
+\.
+
+--### end of psql-input
+
+step 2.
+//Create test_ds.xsd
+
+using System;
+using System.Data;
+using System.Data.Common;
+using Npgsql;
+
+class MainClass
+{
+    public static void Main(string[] args)
+    {
+        string connStr=&quot;Server=localhost;User ID=juergen;Database=test&quot;;
+
+        NpgsqlConnection conn = new Npgsql.NpgsqlConnection(connStr);
+        conn.Open();
+        DataSet ds = new DataSet(&quot;testDataSet&quot;);
+        NpgsqlDataAdapter da = new NpgsqlDataAdapter(&quot;SELECT * FROM simple
+WHERE 1=0;&quot;, conn);
+        Console.WriteLine(da.Fill(ds, &quot;simple&quot;));
+        ds.WriteXmlSchema(&quot;test_ds.xsd&quot;);
+        conn.Close();
+    }
+}
+
+####### 
+output is test_ds.xsd:
+
+&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot;?&gt;
+&lt;xs:schema xmlns:msdata=&quot;urn:schemas-microsoft-com:xml-msdata&quot;
+id=&quot;testDataSet&quot; xmlns:xs=&quot;<A HREF="http://www.w3.org/2001/XMLSchema"">http://www.w3.org/2001/XMLSchema&quot;</A>&gt;
+  &lt;xs:element name=&quot;testDataSet&quot; msdata:IsDataSet=&quot;true&quot; msdata:Locale=&quot;de-DE&quot;&gt;
+    &lt;xs:complexType&gt;
+      &lt;xs:choice maxOccurs=&quot;unbounded&quot;&gt;
+        &lt;xs:element name=&quot;simple&quot;&gt;
+          &lt;xs:complexType&gt;
+            &lt;xs:sequence&gt;
+              &lt;xs:element minOccurs=&quot;0&quot; name=&quot;nr&quot; type=&quot;xs:short&quot; /&gt;
+              &lt;xs:element minOccurs=&quot;0&quot; name=&quot;name&quot; type=&quot;xs:string&quot; /&gt;
+            &lt;/xs:sequence&gt;
+          &lt;/xs:complexType&gt;
+        &lt;/xs:element&gt;
+      &lt;/xs:choice&gt;
+    &lt;/xs:complexType&gt;
+  &lt;/xs:element&gt;
+&lt;/xs:schema&gt;
+
+step 3. 
+Create source for test_ds.c
+
+xsd test_ds.xsd /dataset
+
+step 4.
+Use test_ds:
+
+using System;
+using System.Data;
+using Npgsql;
+
+class MainClass
+{
+    public static void Main(string[] args)
+    {
+        string connStr=&quot;Server=localhost;User ID=juergen;Database=test&quot;;
+
+        NpgsqlConnection conn;
+        Schemas.testDataSet tds = new Schemas.testDataSet();
+
+        conn = new NpgsqlConnection(connStr);
+        NpgsqlDataAdapter da = new NpgsqlDataAdapter(&quot;SELECT * FROM
+simple;&quot;, (NpgsqlConnection)conn);
+        
+        Console.WriteLine(da.Fill(tds.simple));
+
+        Console.WriteLine(tds.simple[0].name);
+        Console.WriteLine(tds.simple[0].nr);
+        
+        conn.Close();
+    }
+}
+
+Actual Results:
+Exceptions accessing tds.simple[0].name and tds.simple[0].nr
+
+Expected Results:
+No exceptions ;-)
+
+How often does this happen? 
+every time
+
+Additional Information:
+There are 2 places in the get-accessor of the column properties of datarows
+that throw exceptions. Look at comments
+
+public virtual short nr {
+    get {
+        // next line (XSD-created) throws NullReferenceException because
+        // InitializeFields for the table is never called and so the
+        // column-variables aren't set. Calling it after InitializeClass
+        // in the table-constructor makes this work (don't know if that's
+        // the right place to call it...).
+        object ret = this[this.table.nrColumn];
+        if ((ret == System.DBNull.Value)) {
+            throw new System.Data.StrongTypingException(&quot;Cannot get strong
+typed value since it is DB null.&quot;, null);
+        }
+        else {
+            // next line (XSD-created) throws InvalidCastException
+            // the equivalent for strings seems to work
+            return ((short)(ret));
+
+            // this works
+            return Convert.ToInt16(ret);
+        }
+    }
+    set {
+        this[this.table.nrColumn] = value;
+    }
+}

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="022196.html">[Mono-bugs] [Bug 68070][Wis] Changed - The xsp hangs or abort on multiple requests.
</A></li>
	<LI> Next message: <A HREF="022198.html">[Mono-bugs] [Bug 67264][Maj] Changed - string.ctor with encoding objunimplemented
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22197">[ date ]</a>
              <a href="thread.html#22197">[ thread ]</a>
              <a href="subject.html#22197">[ subject ]</a>
              <a href="author.html#22197">[ author ]</a>
         </LI>
       </UL>
</body></html>
