<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 62935][Cri] New - System.Data.Odbc.OdbcParameter:setBuffer () causes System.Text.ASCIIEncoding:GetBytes (string, int, int, byte[], int) to throw Arg_InsufficientSpace
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="019692.html">
   <LINK REL="Next"  HREF="019694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 62935][Cri] New - System.Data.Odbc.OdbcParameter:setBuffer () causes System.Text.ASCIIEncoding:GetBytes (string, int, int, byte[], int) to throw Arg_InsufficientSpace
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 62935][Cri] New - System.Data.Odbc.OdbcParameter:setBuffer () causes System.Text.ASCIIEncoding:GetBytes (string, int, int, byte[], int) to throw Arg_InsufficientSpace">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Thu, 12 Aug 2004 11:42:33 -0400 (EDT)</I>
    <P><UL>
        <LI> Previous message: <A HREF="019692.html">[Mono-bugs] [Bug 60033][Maj] Changed - SqlDataAdapter.Fill throws SqlException &quot;Invalid object name 'sp_reset_conection'&quot;
</A></li>
        <LI> Next message: <A HREF="019694.html">[Mono-bugs] [Bug 62948][Maj] New - SqlClient fails to connect to SqlServer dataources.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19693">[ date ]</a>
              <a href="thread.html#19693">[ thread ]</a>
              <a href="subject.html#19693">[ subject ]</a>
              <a href="author.html#19693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:paulsdsrubbish@hotmail.com.">paulsdsrubbish@hotmail.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=62935">http://bugzilla.ximian.com/show_bug.cgi?id=62935</A>

--- shadow/62935	2004-08-12 11:42:32.000000000 -0400
+++ shadow/62935.tmp.12392	2004-08-12 11:42:33.000000000 -0400
@@ -0,0 +1,170 @@
+Bug#: 62935
+Product: Mono: Class Libraries
+Version: unspecified
+OS: All
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Critical
+Component: CORLIB
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:paulsdsrubbish@hotmail.com">paulsdsrubbish@hotmail.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: System.Data.Odbc.OdbcParameter:setBuffer () causes System.Text.ASCIIEncoding:GetBytes (string, int, int, byte[], int) to throw Arg_InsufficientSpace
+
+Description of Problem:
+
+System.Data.Odbc.OdbcParameter:setBuffer () causes
+System.Text.ASCIIEncoding:GetBytes (string, int, int, byte[], int) to throw
+Arg_InsufficientSpace
+
+
+
+Steps to reproduce the problem:
+1. Run an ODBC stored procedure.  My case that's postgres
+2. Actual code:
+
+public int CreateDocumentCollection(System.Data.IDbConnection dbCon, string
+docCollectionExternalId, object docCollectionParentId, string
+docCollectionComment)
+		{
+			int retValue = 0;
+
+			try
+			{
+				//Create command from connection
+				IDbCommand cmd = dbCon.CreateCommand();
+
+				//Command text - will actually be DB 
+				cmd.CommandType = CommandType.StoredProcedure;
+				cmd.CommandText = &quot;select public.create_documentcollection(?, ?, ?);&quot;;
+
+				//Create parameters
+				OdbcParameter param = new OdbcParameter(&quot;&quot;, OdbcType.VarChar, 255);
+				param.Value = DbUtilities.PrepareString(docCollectionExternalId);
+				cmd.Parameters.Add(param);
+
+				param = new OdbcParameter(&quot;&quot;, OdbcType.Int);
+				param.Value = DbUtilities.PrepareInt(docCollectionParentId);
+				cmd.Parameters.Add(param);
+
+				param = new OdbcParameter(&quot;&quot;, OdbcType.NText);
+				param.Value = DbUtilities.PrepareString(docCollectionComment);
+				cmd.Parameters.Add(param);
+
+
+				// Execute command
+				retValue = (int)cmd.ExecuteScalar();
+			}
+			catch (SystemException ex)
+			{
+				throw new XmlDbException(&quot;CreateDocumentCollection failed while
+attempting to execute command on database.&quot; + ex.Message, ex);
+			}
+
+			return retValue;
+		}
+
+[Postgresql procedure]
+CREATE OR REPLACE FUNCTION public.create_documentcollection( 
+documentcollection.doccollectionexternalid%TYPE , 
+documentcollection.doccollectionparentid%TYPE , 
+documentcollection.doccollectioncomment%TYPE)
+RETURNS int4 AS
+'DECLARE
+	arg_doccollectionexternalid ALIAS FOR $1;
+	arg_doccollectionparentid ALIAS FOR $2;
+	arg_doccollectioncomment ALIAS FOR $3;
+
+	uniqueId	documentcollection.doccollectionid%TYPE;
+BEGIN
+	-- First select the id to see if the value already exists.  
+	-- If it does then just return that id, otherwise add it.
+
+	SELECT INTO uniqueId doccollectionid from documentcollection WHERE
+doccollectionexternalid = arg_doccollectionexternalid ;
+
+	IF NOT FOUND THEN
+	BEGIN
+		uniqueId := get_next_documentcollectionid();
+		INSERT INTO documentcollection
+		(
+			doccollectionid , doccollectionexternalid , doccollectionparentid ,
+doccollectioncomment
+		)
+		VALUES
+		(
+			uniqueId , 
+			arg_doccollectionexternalid ,
+			arg_doccollectionparentid ,
+			arg_doccollectioncomment
+		);
+	END;
+	ELSE
+		RETURN uniqueId;
+	END IF;
+
+	RETURN uniqueId;	
+END;
+'LANGUAGE 'plpgsql' VOLATILE;
+
+3. 
+
+Actual Results:
+Inner exception:
+Arg_InsufficientSpace
+in &lt;0x0017b&gt; System.Text.ASCIIEncoding:GetBytes (string,int,int,byte[],int)
+in &lt;0x0016e&gt; System.Data.Odbc.OdbcParameter:setBuffer ()
+in &lt;0x0004c&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcParameter:setBuffer ()
+in &lt;0x0002b&gt; System.Data.Odbc.OdbcParameter:Bind (intptr,int)
+in &lt;0x00062&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcParameter:Bind (intptr,int)
+in &lt;0x00281&gt; System.Data.Odbc.OdbcCommand:Prepare ()
+in &lt;0x0004c&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcCommand:Prepare ()
+in &lt;0x00037&gt; System.Data.Odbc.OdbcCommand:ExecSQL (string)
+in &lt;0x00053&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcCommand:ExecSQL (string)
+in &lt;0x0009f&gt; System.Data.Odbc.OdbcCommand:ExecuteNonQuery (bool)
+in &lt;0x00057&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcCommand:ExecuteNonQuery (bool)
+in &lt;0x00015&gt; System.Data.Odbc.OdbcCommand:ExecuteReader
+(System.Data.CommandBehavior)
+in &lt;0x00051&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcCommand:ExecuteReader (System.Data.CommandBehavior)
+in &lt;0x00016&gt; System.Data.Odbc.OdbcCommand:ExecuteReader ()
+in &lt;0x0004d&gt; (wrapper remoting-invoke-with-check)
+System.Data.Odbc.OdbcCommand:ExecuteReader ()
+in &lt;0x0002d&gt; System.Data.Odbc.OdbcCommand:ExecuteScalar ()
+in &lt;0x001db&gt;
+uk.co.ds.xmldb.odbc.OdbcPgsqlXmlDbIndexerCreation:CreateDocumentCollection
+(System.Data.IDbConnection,string,object,string)
+
+
+Expected Results:
+Same code works flawlessly under the Microsoft .Net Runtime.
+
+
+How often does this happen? 
+Everytime
+
+
+Additional Information:
+
+I believe it has something to do with OdbcParameter.cs, specifically the
+setBuffer() function.  It uses a magic number (20) as part of it's buffer
+array creation stategy, and a class member &quot;size&quot;.  It does not seem to use
+the actual created string (paramValueString) in actually creating the
+byte[] buffer size.
+
+Also it assumes that one character==one byte by passing across
+paramValueString.Length to System.Text.Encoding.ASCII.GetBytes - although
+as it is ascii perhaps that's a valid assumption?
+
+I'm an experienced programmer but new to the mono and linux platforms and
+their tools - otherwise I would probably be able to help more!

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="019692.html">[Mono-bugs] [Bug 60033][Maj] Changed - SqlDataAdapter.Fill throws SqlException &quot;Invalid object name 'sp_reset_conection'&quot;
</A></li>
	<LI> Next message: <A HREF="019694.html">[Mono-bugs] [Bug 62948][Maj] New - SqlClient fails to connect to SqlServer dataources.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19693">[ date ]</a>
              <a href="thread.html#19693">[ thread ]</a>
              <a href="subject.html#19693">[ subject ]</a>
              <a href="author.html#19693">[ author ]</a>
         </LI>
       </UL>
</body></html>
