<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20327608%5D%20BackgroundWorker%3A%20is%20UI-thread%20unsafe%21&In-Reply-To=bug-327608-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="062096.html">
   <LINK REL="Next"  HREF="062099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20327608%5D%20BackgroundWorker%3A%20is%20UI-thread%20unsafe%21&In-Reply-To=bug-327608-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Sep 26 09:05:13 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="062096.html">[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!
</A></li>
        <LI>Next message: <A HREF="062099.html">[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62098">[ date ]</a>
              <a href="thread.html#62098">[ thread ]</a>
              <a href="subject.html#62098">[ subject ]</a>
              <a href="author.html#62098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=327608#c7">https://bugzilla.novell.com/show_bug.cgi?id=327608#c7</A>





--- Comment #7 from Andy Hume &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">andyhume32 at yahoo.co.uk</A>&gt;  2007-09-26 07:05:13 MST ---
Looks good, both the repro apps show correct behaviour.

However the 'book' samples again highlight a problem.  Showing a dialog causes
the WindowsFormsSynchronizationContext to be Uninstall-ed, and the default one
is used thereafter. :-(

I will attach a new repro app, a version of the second original one, but that
now shows MessageBox on completion.  If the &quot;Start again&quot; button is clicked
then the old bad behaviour is seen.

I had logging in SynchronizationContext and in SetSynchronizationContext added
logging of &quot;new StackTrace()&quot;, it shows two calls, the second being the bad
one:
[[
[sc set]
   at
System.Threading.SynchronizationContext.SetSynchronizationContext(System.Threading.SynchronizationContext
syncContext)
   at System.Windows.Forms.Application.RunLoop(Boolean Modal,
System.Windows.Forms.ApplicationContext context)
   at System.Windows.Forms.Application.Run(System.Windows.Forms.Form mainForm)
   at BkgndWkr1.Main()
[sc get_Current]
[sc get_Current]
[sc get_Current]
[sc get_Current]
[sc set]
   at
System.Threading.SynchronizationContext.SetSynchronizationContext(System.Threading.SynchronizationContext
syncContext)
   at System.Windows.Forms.WindowsFormsSynchronizationContext.Uninstall()
   at System.Windows.Forms.Application.RunLoop(Boolean Modal,
System.Windows.Forms.ApplicationContext context)
   at System.Windows.Forms.Form.ShowDialog(IWin32Window ownerWin32)
   at System.Windows.Forms.Form.ShowDialog()
   at System.Windows.Forms.MessageBox+MessageBoxForm.RunDialog()
   at System.Windows.Forms.MessageBox.Show(IWin32Window owner, System.String
text)
   at BkgndWkr1.bkgndWkr_RunWorkerCompleted(System.Object sender,
System.ComponentModel.RunWorkerCompletedEventArgs e)
   at
System.ComponentModel.BackgroundWorker.OnRunWorkerCompleted(System.ComponentModel.RunWorkerCompletedEventArgs
e)
   at
System.ComponentModel.BackgroundWorker+&lt;&gt;c__CompilerGenerated8.&lt;CompleteWorker&gt;c__33(System.Object
darg)
   at System.Reflection.MonoMethod.InternalInvoke(System.Object ,
System.Object[] )
   at System.Reflection.MonoMethod.InternalInvoke(System.Object ,
System.Object[] )
   at System.Reflection.MonoMethod.Invoke(System.Object obj, BindingFlags
invokeAttr, System.Reflection.Binder binder, System.Object[] parameters,
System.Globalization.CultureInfo culture)
   at System.Reflection.MethodBase.Invoke(System.Object obj, System.Object[]
parameters)
   at System.Delegate.DynamicInvokeImpl(System.Object[] args)
   at System.MulticastDelegate.DynamicInvokeImpl(System.Object[] args)
   at System.Delegate.DynamicInvoke(System.Object[] args)
   at System.Windows.Forms.XplatUIDriverSupport.ExecutionCallback(System.Object
state)
   at System.Security.SecurityContext.Run(System.Security.SecurityContext
securityContext, System.Threading.ContextCallback callBack, System.Object
state)
   at System.Threading.ExecutionContext.Run(System.Threading.ExecutionContext
executionContext, System.Threading.ContextCallback callBack, System.Object
state)
   at System.Windows.Forms.XplatUIDriverSupport.ExecuteClientMessage(GCHandle
gchandle)
   at System.Windows.Forms.XplatUIWin32.GetMessage(MSG ByRef msg, IntPtr hWnd,
Int32 wFilterMin, Int32 wFilterMax, Boolean blocking)
   at System.Windows.Forms.XplatUIWin32.GetMessage(System.Object queue_id, MSG
ByRef msg, IntPtr hWnd, Int32 wFilterMin, Int32 wFilterMax)
   at System.Windows.Forms.XplatUI.GetMessage(System.Object queue_id, MSG ByRef
msg, IntPtr hWnd, Int32 wFilterMin, Int32 wFilterMax)
   at System.Windows.Forms.Application.RunLoop(Boolean Modal,
System.Windows.Forms.ApplicationContext context)
   at System.Windows.Forms.Application.Run(System.Windows.Forms.Form mainForm)
   at BkgndWkr1.Main()
]]

Should there be an RunLoop inside a RunLoop?  Anyway we need not to Uninstall
in that case.

For completeness I also attach a expanded GetSyncCtx.cs sample, it shows that
on MSFT that the context is installed by Form creation and not Application.Run.
 Secondly that WFSC.AutoInstall is respected.  Probably both only used in the
rarest of applications however...
[[
$ GetSyncCtx.exe
At Main -- before new FooForm()
  SyncCtx.Current: NULL
At Main -- before Application.Run
  SyncCtx.Current: System.Windows.Forms.WindowsFormsSynchronizatio
At Form_Shown
  SyncCtx.Current: System.Windows.Forms.WindowsFormsSynchronizatio
At Main -- after Application.Run
  SyncCtx.Current: System.Threading.SynchronizationContext

$ GetSyncCtx.exe NO
Setting: WindowsFormsSynchronizationContext.AutoInstall = false
At Main -- before new FooForm()
  SyncCtx.Current: NULL
At Main -- before Application.Run
  SyncCtx.Current: NULL
At Form_Shown
  SyncCtx.Current: System.Threading.SynchronizationContext
At Main -- after Application.Run
  SyncCtx.Current: System.Threading.SynchronizationContext
]]

versus current Mono:

[[
$ mono GetSyncCtx.exe
t
At Main -- before new FooForm()
  SyncCtx.Current: NULL
At Main -- before Application.Run
  SyncCtx.Current: NULL
At Form_Shown
  SyncCtx.Current: System.Windows.Forms.WindowsFormsSynchronizationContext
At Main -- after Application.Run
  SyncCtx.Current: System.Threading.SynchronizationContext

$ mono GetSyncCtx.exe NO
Setting: WindowsFormsSynchronizationContext.AutoInstall = false
At Main -- before new FooForm()
  SyncCtx.Current: NULL
At Main -- before Application.Run
  SyncCtx.Current: NULL
At Form_Shown
  SyncCtx.Current: System.Windows.Forms.WindowsFormsSynchronizationContext
At Main -- after Application.Run
  SyncCtx.Current: System.Threading.SynchronizationContext
]]

Finally, EoL handling is not set on WFSC.cs in SVN.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="062096.html">[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!
</A></li>
	<LI>Next message: <A HREF="062099.html">[Mono-bugs] [Bug 327608] BackgroundWorker: is UI-thread unsafe!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62098">[ date ]</a>
              <a href="thread.html#62098">[ thread ]</a>
              <a href="subject.html#62098">[ subject ]</a>
              <a href="author.html#62098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
