<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 325495] arrays don' t appear to be implementing all the generic interfaces in 2.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20325495%5D%20arrays%20don%27%20t%20appear%20to%20be%20implementing%0A%20all%20the%20generic%20interfaces%20in%202.0&In-Reply-To=bug-325495-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="062212.html">
   <LINK REL="Next"  HREF="062211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 325495] arrays don' t appear to be implementing all the generic interfaces in 2.0</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20325495%5D%20arrays%20don%27%20t%20appear%20to%20be%20implementing%0A%20all%20the%20generic%20interfaces%20in%202.0&In-Reply-To=bug-325495-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 325495] arrays don' t appear to be implementing all the generic interfaces in 2.0">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Sep 28 12:42:47 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="062212.html">[Mono-bugs] [Bug 329450] Custom atributes which take generic types as parameters fail to work
</A></li>
        <LI>Next message: <A HREF="062211.html">[Mono-bugs] [Bug 329450] Custom atributes which take generic types as parameters fail to work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62210">[ date ]</a>
              <a href="thread.html#62210">[ thread ]</a>
              <a href="subject.html#62210">[ subject ]</a>
              <a href="author.html#62210">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=325495#c5">https://bugzilla.novell.com/show_bug.cgi?id=325495#c5</A>


Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>&gt; changed:

           What    |Removed                                         |Added
----------------------------------------------------------------------------
            Summary|Mono crashes with                               |arrays don't appear to be implementing all the
                   |(mono_convert_imt_slot_to_vtable_slot):         |generic interfaces in 2.0
                   |assertion failed: (vtable_offset &gt;= 0)          |




--- Comment #5 from Paolo Molaro &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>&gt;  2007-09-28 10:42:46 MST ---
I made some changes in sn to support this, but it's not enabled yet (search for
ARRAY_IFACES_NUM in metadata/class.c).
The basic issue is this: let's say a class A implements 3 interfaces. A[] needs
to implement IList`1, ICollection`1 and IEnumerable`1 with A and all its
interfaces as a generic type argument, so in the end A[] implements 15
interfaces (this is assuming A derived directly from object, otherwise there
are even more).
Now consider A[][]: it needs to implement the generic interfaces for all the
interfaces supported by A[]. This causes a quick explosion on the number of
implemented interfaces and related data structures the runtime must maintain.
In svn I fixed a few easy offenders: for a simple program Ironpython now has a
15% smaller corlib mempool, but there are many that need fixing yet. I'll try
to list here the ones that come to mind.
Each interface gets assigned a different offset in the vtable for the type and
for each interface method we inflate the corresponding MonoMethod and
additionally we create a wrapper MonoMethod to invoke the real implementation.
First we should get rid of the wrappers as they don't have a real purpose but
to appear in the stacktraces with a somewhat helpful name.
Then we should consider assigning all the compatible interfaces the same offset
in the vtable: this way the array type vtable would be C + interface_methods
instead of C + interface_methods * num_interfaces. These two changes should be
doable without too much pain.
With those changes we'll still have to manage the number of MonoClass generated
to represent the interfaces: I don't have a proposal for a solution in this
area.
A related improvement that is also generally useful would be to lazy-init the
IMT table (we also waste a lot of memory in it because we build the complete
thunks for all the types right away): in practice we set the imt slots to a
magic trampoline (which is unique process-wise, so the memory usage doesn't
depend on the number of methods implemented by a type) which when invoked will
build the complete thunk for just the one slot. As an example the same
ironpython proram uses currently 191 KB of IMT thunks, 260 KB with all the
array interfaces enabled. I'll likely work on this item next.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="062212.html">[Mono-bugs] [Bug 329450] Custom atributes which take generic types as parameters fail to work
</A></li>
	<LI>Next message: <A HREF="062211.html">[Mono-bugs] [Bug 329450] Custom atributes which take generic types as parameters fail to work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62210">[ date ]</a>
              <a href="thread.html#62210">[ thread ]</a>
              <a href="subject.html#62210">[ subject ]</a>
              <a href="author.html#62210">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
