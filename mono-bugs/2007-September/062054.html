<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20328036%5D%20%5BPATCH%5DCasting%20bug%20with%20generic%20collections&In-Reply-To=bug-328036-28286%40https.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="062037.html">
   <LINK REL="Next"  HREF="062085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20328036%5D%20%5BPATCH%5DCasting%20bug%20with%20generic%20collections&In-Reply-To=bug-328036-28286%40https.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Sep 25 18:48:43 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="062037.html">[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections
</A></li>
        <LI>Next message: <A HREF="062085.html">[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62054">[ date ]</a>
              <a href="thread.html#62054">[ thread ]</a>
              <a href="subject.html#62054">[ subject ]</a>
              <a href="author.html#62054">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=328036#c8">https://bugzilla.novell.com/show_bug.cgi?id=328036#c8</A>


Michi Henning &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">michi at zeroc.com</A>&gt; changed:

           What    |Removed                                         |Added
----------------------------------------------------------------------------
                 CC|                                                |<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">michi at zeroc.com</A>




--- Comment #8 from Michi Henning &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">michi at zeroc.com</A>&gt;  2007-09-25 16:48:43 MST ---
(In reply to comment #7 from Robert Jordan)
&gt;<i> I really thought about optimizing this, but I looked like a seldom hit
</I>&gt;<i> corner case to me, because in many cases Key/ValueCollection.CopyTo will
</I>&gt;<i> be called instead of the (hidden) ICollection.CopyTo.
</I>
I think the optimization might be worthwhile. For me, this issue arose in the
context of having existing code that uses sequence that are derived from
CollectionBase, and dictionaries that are derived from DictionaryBase. (This is
with Ice--see <A HREF="http://www.zeroc.com">http://www.zeroc.com</A>)

With C# 2.0, we decided to provide an updated collection mapping that uses
strongly-type containers, such as List&lt;T&gt; and Dictionary&lt;KT, VT&gt;.

Now we need to support both the old and the new mappings, and one of the
requirements is that we need deep equality semantics. Rather than generating
(or requiring the user to write) a separate comparison method for each
strongly-typed collection, I wanted to provide a comparison method that would
work for everthing, both old and new collections. So, for dictionaries, I wrote
the following:

public static bool Equals(System.Collections.IDictionary d1,
                          System.Collections.IDictionary d2)
{
    bool result;

    // Try to determine equality based on reference equality
    // and number of elements first. This avoids the expensive
    // comparison of all elements.

    if(cheapComparison(d1, d2, out result))
    {
        return result;
    }

    // Need to compare all the entries after all, at O(n^2) cost.

    //
    // Get and sort both sets of keys. Keys are unique and non-null.
    //
    System.Collections.ICollection keys1 = d1.Keys;
    System.Collections.ICollection keys2 = d2.Keys;
    object[] ka1 = new object[d1.Count];
    object[] ka2 = new object[d2.Count];
    keys1.CopyTo(ka1, 0);
    keys2.CopyTo(ka2, 0);
    Array.Sort(ka1);
    Array.Sort(ka2);

    try
    {
        System.Collections.IEnumerator e = ka2.GetEnumerator();
        foreach(object o in ka1)
        {
            e.MoveNext();
            if(!o.Equals(e.Current))
            {
                return false;
            }
            if(!Equals(d1[o], d2[o]))
            {
                return false;
            }
        }
    }
    catch(System.Exception)
    {
        return false;
    }

    return true;
}

The array copy is necessary because I need to sort the keys, and I'm using the
generic version because, in the Ice run time, I have no idea what the actual
types involved are.

I haven't benchmarked this but, for large dictionaries, I suspect that the
array copy will account for an appreciable fraction of the total time.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="062037.html">[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections
</A></li>
	<LI>Next message: <A HREF="062085.html">[Mono-bugs] [Bug 328036] [PATCH]Casting bug with generic collections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62054">[ date ]</a>
              <a href="thread.html#62054">[ thread ]</a>
              <a href="subject.html#62054">[ subject ]</a>
              <a href="author.html#62054">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
