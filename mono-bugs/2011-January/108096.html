<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 664839] New: PropertyManager property change doesn't update child binding managers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20664839%5D%20New%3A%20PropertyManager%20property%20change%0A%20doesn%27t%20update%20child%20binding%20managers&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="108095.html">
   <LINK REL="Next"  HREF="108097.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 664839] New: PropertyManager property change doesn't update child binding managers</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20664839%5D%20New%3A%20PropertyManager%20property%20change%0A%20doesn%27t%20update%20child%20binding%20managers&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 664839] New: PropertyManager property change doesn't update child binding managers">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Jan 16 18:13:23 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="108095.html">[Mono-bugs] [Bug 664838] New: CurencyManager and PropertyManager GetItemProperties() method doesn't honor ITypedList.
</A></li>
        <LI>Next message: <A HREF="108097.html">[Mono-bugs] [Bug 664689] monotouch failed with no output (134)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#108096">[ date ]</a>
              <a href="thread.html#108096">[ thread ]</a>
              <a href="subject.html#108096">[ subject ]</a>
              <a href="author.html#108096">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=664839">https://bugzilla.novell.com/show_bug.cgi?id=664839</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=664839#c0">https://bugzilla.novell.com/show_bug.cgi?id=664839#c0</A>


           Summary: PropertyManager property change doesn't update child
                    binding managers
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.6.x
          Platform: x86
        OS/Version: Windows 7
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Windows.Forms
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">cvolzke at live.com.au</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US)
AppleWebKit/532.5 (KHTML, like Gecko) Chrome/4.1.249.1036 Safari/532.5

When the property of a parent PropertyManager changes, the child binding
managers don't update.


Reproducible: Always

Steps to Reproduce:
[Test]
public void Test_WhenParent_PropertyManager_PropertyChanges()
{
    TestDataSourceWithRelatedObjects obj = new
TestDataSourceWithRelatedObjects();
    obj.ObjProperty = new TestDataSource { List = new
BindingList&lt;TestDataSource&gt; { new TestDataSource { IntProperty = 1 } } };

    BindingContext bc = new BindingContext();
    PropertyManager parentBindingManager = (PropertyManager)bc[obj,
&quot;ObjProperty&quot;];
    BindingManagerBase bm = bc[obj, &quot;ObjProperty.List&quot;];

    AssertEquals(1, ((TestDataSource)bm.Current).IntProperty, &quot;Initial value of
ObjProperty.List[0].IntProperty&quot;);
    obj.ObjProperty = new TestDataSource { List = new
BindingList&lt;TestDataSource&gt; { new TestDataSource { IntProperty = 2 } } };
    AssertEquals(2, ((TestDataSource)bm.Current).IntProperty, &quot;Value of
ObjProperty.List[0].IntProperty&quot;);
}

class TestDataSourceWithRelatedObjects
{
    public BindingList&lt;TestDataSource&gt; List { get; set; }
}

class TestDataSource
{
    public event EventHandler IntPropertyChanged;

    public const int IntPropertyDefaultValue = 5;
    int intProperty = IntPropertyDefaultValue;
    public int IntProperty
    {
        get { return intProperty; }
        set
        {
            intProperty = value;
            if (IntPropertyChanged != null)
            {
                IntPropertyChanged(this, EventArgs.Empty);
            }
        }
    }
}

Actual Results:  
Unit test fails.

Expected Results:  
The unit test should pass, as it does with ms.net.

These changes fix the issue and cause the above unit test to pass:

Code modified in RelatedCurrencyManager constructor:
    public RelatedCurrencyManager (BindingManagerBase parent,
PropertyDescriptor prop_desc)
        : base (prop_desc.GetValue (parent.Current))
    {
        this.parent = parent;
        this.prop_desc = prop_desc;

        parent.CurrentItemChanged += new
EventHandler(parent_CurrentItemChanged); // line added
        //parent.PositionChanged += new EventHandler(parent_PositionChanged);
// line removed - PositionChanged is never fired from a PropertyManager
    }

Code modified in RelatedCurrencyManager.parent_PositionChanged:
    private void parent_CurrentItemChanged(object sender, EventArgs args) //
line added
    //private void parent_PositionChanged (object sender, EventArgs args) //
line removed
    {
        if (parent.Position == -1) return; // line added to prevent
IndexOutOfRangeException
        SetDataSource (prop_desc.GetValue (parent.Current));
    }

Code modified in PropertyManager.OnCurrentChanged:
    protected internal override void OnCurrentChanged (EventArgs ea)
    {
        PushData ();

        if (onCurrentChangedHandler != null) {
            onCurrentChangedHandler (this, ea);
        }

        // CurrentChanged implies CurrentItemChanged here // line added
        if (onCurrentItemChangedHandler != null)          // line added
        {                                                 // line added
            onCurrentItemChangedHandler(this, ea);        // line added
        }                                                 // line added
    }

Code modified in ListBindingHelper.GetListItemProperties:
    public static PropertyDescriptorCollection GetListItemProperties (object
list, PropertyDescriptor [] listAccessors)
    {
        list = GetList (list);

        if (list == null)
            return new PropertyDescriptorCollection (null);

        if (list is ITypedList)
            return ((ITypedList)list).GetItemProperties (listAccessors);

        if (listAccessors == null || listAccessors.Length == 0) {
            Type item_type = GetListItemType (list);
            return TypeDescriptor.GetProperties (item_type, 
                new Attribute [] { new BrowsableAttribute (true) });
        }

        // Take into account only the first property
        Type property_type = listAccessors[listAccessors.Length -
1].PropertyType; // line added
        //Type property_type = listAccessors [0].PropertyType;                 
   // line removed
        if (typeof (IList).IsAssignableFrom (property_type)
#if NET_2_0
            || typeof (IList&lt;&gt;).IsAssignableFrom (property_type)
#endif
            ) {

            PropertyInfo property = GetPropertyByReflection (property_type,
&quot;Item&quot;);
            return TypeDescriptor.GetProperties (property.PropertyType);
        }

        return TypeDescriptor.GetProperties(property_type);                    
// line added
        //return new PropertyDescriptorCollection (new PropertyDescriptor [0]);
// line removed
    }

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>
































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="108095.html">[Mono-bugs] [Bug 664838] New: CurencyManager and PropertyManager GetItemProperties() method doesn't honor ITypedList.
</A></li>
	<LI>Next message: <A HREF="108097.html">[Mono-bugs] [Bug 664689] monotouch failed with no output (134)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#108096">[ date ]</a>
              <a href="thread.html#108096">[ thread ]</a>
              <a href="subject.html#108096">[ subject ]</a>
              <a href="author.html#108096">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
