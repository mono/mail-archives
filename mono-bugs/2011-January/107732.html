<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 662381] New: C# lock () fails on latest Mono	runtimes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20662381%5D%20New%3A%20C%23%20lock%20%28%29%20fails%20on%20latest%20Mono%0A%09runtimes&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="107731.html">
   <LINK REL="Next"  HREF="107733.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 662381] New: C# lock () fails on latest Mono	runtimes</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20662381%5D%20New%3A%20C%23%20lock%20%28%29%20fails%20on%20latest%20Mono%0A%09runtimes&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 662381] New: C# lock () fails on latest Mono	runtimes">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Jan  5 01:20:47 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="107731.html">[Mono-bugs] [Bug 635377] Error creating wcf client proxy
</A></li>
        <LI>Next message: <A HREF="107733.html">[Mono-bugs] [Bug 662381] C# lock () fails on latest Mono runtimes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#107732">[ date ]</a>
              <a href="thread.html#107732">[ thread ]</a>
              <a href="subject.html#107732">[ subject ]</a>
              <a href="author.html#107732">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=662381">https://bugzilla.novell.com/show_bug.cgi?id=662381</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=662381#c0">https://bugzilla.novell.com/show_bug.cgi?id=662381#c0</A>


           Summary: C# lock () fails on latest Mono runtimes
    Classification: Mono
           Product: Mono: Runtime
           Version: 2.8.x
          Platform: x86-64
        OS/Version: Ubuntu
            Status: NEW
          Severity: Critical
          Priority: P5 - None
         Component: misc
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">john.costella at petermac.org</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=406983)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=406983">http://bugzilla.novell.com/attachment.cgi?id=406983</A>)
ImageResize solution including executable

User-Agent:       Mozilla/5.0 (X11; U; Linux x86_64; en-US) AppleWebKit/534.10
(KHTML, like Gecko) Chrome/8.0.552.224 Safari/534.10

The lock () construct fails to fully lock on Mono 2.8.1 and the latest daily
build of Mono (2011-01-04): frequently two or three threads are detected inside
the locked section of code at the same time. 

The same .exe file running on Windows XP 64-bit with .NET 4.0 does NOT exhibit
this bug at all.

I am primarily using Mono 2.8.1 and MonoDevelop 2.4.1 built in a parallel
environment from the stable tarball sources. 

The CPU is a 64-bit quad-core (which appears as 8 CPUs to the system).

I have also tested the executable with the latest (2011-01-04) Mono built from
the source tarball, and the same bug occurs.

I am using TPL heavily in C#.

The attached solution is a toy application that resizes an image. 

In the file Magic.cs is the following method:


        public static ResamplerSet GetResamplerSet(IFull o)
        {
            // For the resampler set we will find or create.
            ResamplerSet resamplerSet;

            // Compute the key.
            var key = ComputeKey(o);

            // Lock the resampler sets. Block all threads at this point because
if we need to create it, the constructor does so in parallel.
            lock (resamplerSets)
            {
                // See if we can get a resampler set with the correct source
step value and sufficient destination dimension.
                if (!resamplerSets.TryGetValue(key, out resamplerSet) ||
resamplerSet.MaximumDestinationDimension &lt; o.DestinationDimension)
                {
                    // Failed for one or the other reason. Create or recreate
it now.
                    resamplerSet = new ResamplerSet(o);

                    // *** MONO BUG CHECK ***
                    if (resamplerSets.ContainsKey(key)) Console.WriteLine(&quot;***
MONO BUG: KEY &quot; + key + &quot; ALREADY POPULATED BY ANOTHER THREAD VIOLATING THE
LOCK ***&quot;);

                    // Store it.
                    resamplerSets[key] = resamplerSet;
                }
            }

            // Return the resampler set we found or created.
            return resamplerSet;
        }
        static Dictionary&lt;KeyValuePair&lt;double, double&gt;, ResamplerSet&gt;
resamplerSets = new Dictionary&lt;KeyValuePair&lt;double, double&gt;, ResamplerSet&gt;();


The constructor in 'new ResamplerSet(o)' does NOT call this method
re-entrantly.

The line with &quot;MONO BUG CHECK&quot; should never be printed to the console. However,
running this program on arbitrary image files with arbitrary rescaling factors
frequently causes it to be emitted once per program execution.

I asked a question relating to this code on the MSDN forum and a member
confirmed that the lock should prevent this critical race. 

As I said, it never occurs when running the same executable under Windows.


Reproducible: Sometimes

Steps to Reproduce:
1. Use a Mono environment supporting .NET 4.0.
2. Get some arbitrary bitmap images (BMP, JPG, PNG, any size).
3. Get the executable ImageResize.exe from the attached tar.gz (or build the
solution with MonoDevelop) and then try the following (assume your image is
foo.bmp):

mono ImageResize.exe foo.bmp bar.bmp 0.23 0.45

If you don't get any console output after running this a few times, change the
rescale factors arbitrarily to other numbers. 

I get the bug appearing roughly one out of every two times I execute the
program, on average.
Actual Results:  
Here is an example run:

[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
*** MONO BUG: KEY [2.89855072463768, 0.949275362318841] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
*** MONO BUG: KEY [2.89855072463768, 0.949275362318841] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
*** MONO BUG: KEY [2.89855072463768, 0.949275362318841] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
*** MONO BUG: KEY [4.27350427350427, 1.63675213675214] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
[mono-dev] ~/temp @ mono ImageResize.exe little.bmp bar.bmp 0.234 0.345
*** MONO BUG: KEY [4.27350427350427, 1.63675213675214] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
*** MONO BUG: KEY [2.89855072463768, 0.949275362318841] ALREADY POPULATED BY
ANOTHER THREAD VIOLATING THE LOCK ***
[mono-dev] ~/temp @ 


Expected Results:  
No &quot;MONO BUG&quot; output.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="107731.html">[Mono-bugs] [Bug 635377] Error creating wcf client proxy
</A></li>
	<LI>Next message: <A HREF="107733.html">[Mono-bugs] [Bug 662381] C# lock () fails on latest Mono runtimes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#107732">[ date ]</a>
              <a href="thread.html#107732">[ thread ]</a>
              <a href="subject.html#107732">[ subject ]</a>
              <a href="author.html#107732">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
