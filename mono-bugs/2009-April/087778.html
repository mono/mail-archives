<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 494253] New: Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes use atime as mtime
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20494253%5D%20New%3A%20Mono.Unix.Native.Syscall.utimes%2C%0A%20.lutimes%2C%20.futimes%20use%20atime%20as%20mtime&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="088044.html">
   <LINK REL="Next"  HREF="087790.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 494253] New: Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes use atime as mtime</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20494253%5D%20New%3A%20Mono.Unix.Native.Syscall.utimes%2C%0A%20.lutimes%2C%20.futimes%20use%20atime%20as%20mtime&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 494253] New: Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes use atime as mtime">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Apr 13 00:15:07 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="088044.html">[Mono-bugs] [Bug 494245] ASP.NET Pages not accepting base class with generic type
</A></li>
        <LI>Next message: <A HREF="087790.html">[Mono-bugs] [Bug 494253] Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes use atime as mtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87778">[ date ]</a>
              <a href="thread.html#87778">[ thread ]</a>
              <a href="subject.html#87778">[ subject ]</a>
              <a href="author.html#87778">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=494253">http://bugzilla.novell.com/show_bug.cgi?id=494253</A>


           Summary: Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes
                    use atime as mtime
    Classification: Mono
           Product: Mono: Class Libraries
           Version: SVN
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Mono.POSIX
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">miguel at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">wsstefz8f9 at sxipper.net</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.0.8)
Gecko/2009032609 Firefox/3.0.8 (.NET CLR 3.5.30729)

In the Mono.Unix.Native.Syscall class, in at least 2.0.1 through SVN, the
functions utimes, lutimes, and futimes all have the same bug.  In accordance
with the documentation for the respective system calls, they each take a
Timeval[] which is expected to have length 2, the first being the atime (last
access time) and the second being the mtime (last write time).  However, they
actually set both the atime and the mtime to the time specified by the first
entry in the array.

A glance at the source code in SVN makes it pretty clear that the problem is in
support/sys-time.c in the function copy_utimes, which is used by all 3 of these
functions:

static inline struct timeval*
copy_utimes (struct timeval* to, struct Mono_Posix_Timeval *from)
{
        if (from) {
                to[0].tv_sec  = from-&gt;tv_sec;
                to[0].tv_usec = from-&gt;tv_usec;
                to[1].tv_sec  = from-&gt;tv_sec;    //&lt; WRONG
                to[1].tv_usec = from-&gt;tv_usec;   //&lt; WRONG
                return to;
        }

        return NULL;
}

I would change this to

static inline struct timeval*
copy_utimes (struct timeval* to, struct Mono_Posix_Timeval *from)
{
        if (from) {
                to[0].tv_sec  = from[0].tv_sec;
                to[0].tv_usec = from[0].tv_usec;
                to[1].tv_sec  = from[1].tv_sec;    //&lt; WRONG
                to[1].tv_usec = from[1].tv_usec;   //&lt; WRONG
                return to;
        }

        return NULL;
}

Reproducible: Always

Steps to Reproduce:
// C# code snippet

string path = &quot;t.txt&quot;;
var times = new Mono.Unix.Native.Timeval[] { 
    new Mono.Unix.Native.Timeval { tv_sec = 1000 * 1000000 },
    new Mono.Unix.Native.Timeval { tv_sec = 1100 * 1000000 } };
if (Mono.Unix.Native.Syscall.lutimes(path, times) != 0)
    throw new IOException(&quot;Failed to set utimes for &quot; + path + &quot;.&quot;, new
Mono.Unix.UnixIOException());

// Then stat t.txt at the command line
Actual Results:  
Access: 2001-09-09 01:46:40.000000000 +0000
Modify: 2001-09-09 01:46:40.000000000 +0000
Change: 2009-04-13 03:14:31.284572623 +0000


Expected Results:  
Access: 2001-09-09 01:46:40.000000000 +0000
Modify: 2004-11-09 11:33:20.000000000 +0000
Change: 2009-04-13 03:14:31.284572623 +0000

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>












































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="088044.html">[Mono-bugs] [Bug 494245] ASP.NET Pages not accepting base class with generic type
</A></li>
	<LI>Next message: <A HREF="087790.html">[Mono-bugs] [Bug 494253] Mono.Unix.Native.Syscall.utimes, .lutimes, .futimes use atime as mtime
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87778">[ date ]</a>
              <a href="thread.html#87778">[ thread ]</a>
              <a href="subject.html#87778">[ subject ]</a>
              <a href="author.html#87778">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
