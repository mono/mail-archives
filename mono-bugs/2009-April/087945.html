<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 496192] New: XmlSchema error: The instance type was not found while reading a XML file
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20496192%5D%20New%3A%20XmlSchema%20error%3A%20The%20instance%20type%0A%20was%20not%20found%20while%20reading%20a%20XML%20file&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="087949.html">
   <LINK REL="Next"  HREF="088075.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 496192] New: XmlSchema error: The instance type was not found while reading a XML file</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20496192%5D%20New%3A%20XmlSchema%20error%3A%20The%20instance%20type%0A%20was%20not%20found%20while%20reading%20a%20XML%20file&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 496192] New: XmlSchema error: The instance type was not found while reading a XML file">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Apr 17 17:07:07 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="087949.html">[Mono-bugs] [Bug 496179] System.InvalidCastException: Cannot cast from source type to destination type. at System.Data.Common.Int32DataContainer.DoCopyValue
</A></li>
        <LI>Next message: <A HREF="088075.html">[Mono-bugs] [Bug 496192] XmlSchema error: The instance type was not found while reading a XML file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87945">[ date ]</a>
              <a href="thread.html#87945">[ thread ]</a>
              <a href="subject.html#87945">[ subject ]</a>
              <a href="author.html#87945">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=496192">http://bugzilla.novell.com/show_bug.cgi?id=496192</A>


           Summary: XmlSchema error: The instance type was not found while
                    reading a XML file
    Classification: Mono
           Product: Mono: Class Libraries
           Version: unspecified
          Platform: i686
        OS/Version: All
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.XML
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">atsushi at ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">stu_dan at hispeed.cH</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Created an attachment (id=286601)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=286601">http://bugzilla.novell.com/attachment.cgi?id=286601</A>)
The demo project

User-Agent:       Mozilla/5.0 (X11; U; Linux i686; de; rv:1.9.0.8)
Gecko/2009032711 Ubuntu/8.10 (intrepid) Firefox/3.0.8

Hi

The attached project works fine under Microsoft .NET but fails under Mono with
the following error information:
Unhandled Exception: System.Xml.Schema.XmlSchemaValidationException: XmlSchema
error: The instance type was not found: HotelAddress XML  Line 5, Position 6.

After several hours of trial and error and some debugging I found a workaround.
More about the workaround later in this message.

I'm not sure but the problematic lines of code can be found in the method
XmlQualifiedName.Parse, which is called from the XmlSchemaValidator method
GetXsiType. First I thought it's the lookup of the type done in the method
FindType, cause in my demo program the GlobalTypes table had no entry. But this
was fixed after compiling the the Schemas with:
settings.Schemas.Compile()
and in fact it is not necessary to compile the schemas.

A closer look at the XmlQualifiedName.Parse method made me curious. There is a
namespace lookup for prefixed types, but if there is no prefix, as in my demo
project, the index is &lt; 0 and the qualified name with an empty namespaces is
returned (line: return new XMlQualifiedName (name)).

In my opinion a qualified name always needs a namespace (otherwise it's not a
qualified one) and so I suggest to have the following line:
return new XmlQualifiedName (name, resolver.LookupNamespace(&quot;&quot;)); 


-- Workaround --
Cause there is a lookup for the namespace by the prefix in XmlQualfiedName, you
just have to prefix the elements and xsi-types in the XML file. i.e.

&#65279;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;

&lt;tns:Person xmlns:tns=&quot;<A HREF="http://tempuri.org/Person.xsd&quot;">http://tempuri.org/Person.xsd&quot;</A> Firstname=&quot;Daniel&quot;
Lastname=&quot;Stutz&quot;&gt;

  &lt;tns:Addresses/&gt;
&lt;/tns:Person&gt;

To write such an XML file you need to specifiy the namespace for the
serializer. i.e.
serializer.Serialize(Console.Out, person, new XmlSerializerNamespaces(new
XmlQualifiedName[] { new XmlQualifiedName(&quot;tns&quot;,
&quot;<A HREF="http://tempuri.org/Person.xsd&quot;">http://tempuri.org/Person.xsd&quot;</A>), new XmlQualifiedName(&quot;xsi&quot;,
&quot;<A HREF="http://www.w3.org/2001/XMLSchema-instance&quot;">http://www.w3.org/2001/XMLSchema-instance&quot;</A>) })); 
--

-- XmlSchemaValidator.cs --
private XmlSchemaType FindType (XmlQualifiedName qname)
{
    return (XmlSchemaType) schemas.GlobalTypes [qname];
}


private object GetXsiType (string name)
{
    object xsiType = null;
    XmlQualifiedName typeQName =
        XmlQualifiedName.Parse (name, nsResolver);
    if (typeQName == ComplexType.AnyTypeName)
        xsiType = ComplexType.AnyType;
    else if (XmlSchemaUtil.IsBuiltInDatatypeName (typeQName))
        xsiType = XsDatatype.FromName (typeQName);
    else
        xsiType = FindType (typeQName);
    return xsiType;
}
--

-- XmlQualifiedName.cs --
internal static XmlQualifiedName Parse (string name, IXmlNamespaceResolver
resolver)
{
    int index = name.IndexOf (':');
    if (index &lt; 0)
        return new XmlQualifiedName (name);
    string ns = resolver.LookupNamespace (name.Substring (0, index));
    if (ns == null)
        throw new ArgumentException (&quot;Invalid qualified name.&quot;);
    return new XmlQualifiedName (name.Substring (index + 1), ns);
}
--


-- Full error information --
Unhandled Exception: System.Xml.Schema.XmlSchemaValidationException: XmlSchema
error: The instance type was not found: HotelAddress XML  Line 5, Position 6.
  at System.Xml.XmlReaderSettings.OnValidationError (System.Object o,
System.Xml.Schema.ValidationEventArgs e) [0x00000] 
  at
Mono.Xml.Schema.XmlSchemaValidatingReader+&lt;XmlSchemaValidatingReader&gt;c__AnonStorey2.&lt;&gt;m__1
(System.Object o, System.Xml.Schema.ValidationEventArgs e) [0x00000] 
  at System.Xml.Schema.XmlSchemaValidator.HandleError
(System.Xml.Schema.XmlSchemaValidationException exception, Boolean isWarning)
[0x00000] 
  at System.Xml.Schema.XmlSchemaValidator.HandleError (System.String message,
System.Exception innerException, Boolean isWarning) [0x00000] 
  at System.Xml.Schema.XmlSchemaValidator.HandleError (System.String message)
[0x00000] 
  at System.Xml.Schema.XmlSchemaValidator.HandleXsiType (System.String
typename) [0x00000] 
  at System.Xml.Schema.XmlSchemaValidator.ValidateElement (System.String
localName, System.String ns, System.Xml.Schema.XmlSchemaInfo info,
System.String xsiType, System.String xsiNil, System.String schemaLocation,
System.String noNsSchemaLocation) [0x00000] 
  at Mono.Xml.Schema.XmlSchemaValidatingReader.Read () [0x00000] 
  at System.Xml.XmlReader.MoveToContent () [0x00000] 
  at System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadListElement
(System.Xml.Serialization.XmlTypeMapping typeMap, Boolean isNullable,
System.Object list, Boolean canCreateInstance) [0x00000] 
  at System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadMembers
(System.Xml.Serialization.ClassMap map, System.Object ob, Boolean isValueList,
Boolean readByOrder) [0x00000] 
  at
System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadClassInstanceMembers
(System.Xml.Serialization.XmlTypeMapping typeMap, System.Object ob) [0x00000] 
  at
System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadClassInstance
(System.Xml.Serialization.XmlTypeMapping typeMap, Boolean isNullable, Boolean
checkType) [0x00000] 
  at System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadObject
(System.Xml.Serialization.XmlTypeMapping typeMap, Boolean isNullable, Boolean
checkType) [0x00000] 
  at System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadRoot
(System.Xml.Serialization.XmlTypeMapping rootMap) [0x00000] 
  at System.Xml.Serialization.XmlSerializationReaderInterpreter.ReadRoot ()
[0x00000] 
  at System.Xml.Serialization.XmlSerializer.Deserialize
(System.Xml.Serialization.XmlSerializationReader reader) [0x00000]
--

Reproducible: Always

Steps to Reproduce:
1. Compile and run
2.
3.
Actual Results:  
Works under Microsoft .NET
Fails under Mono

Expected Results:  
Works under Microsoft .NET
Works under Mono

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>








































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="087949.html">[Mono-bugs] [Bug 496179] System.InvalidCastException: Cannot cast from source type to destination type. at System.Data.Common.Int32DataContainer.DoCopyValue
</A></li>
	<LI>Next message: <A HREF="088075.html">[Mono-bugs] [Bug 496192] XmlSchema error: The instance type was not found while reading a XML file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#87945">[ date ]</a>
              <a href="thread.html#87945">[ thread ]</a>
              <a href="subject.html#87945">[ subject ]</a>
              <a href="author.html#87945">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
