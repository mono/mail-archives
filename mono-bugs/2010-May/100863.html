<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 609023] New: Interlocked.Exchange(ref int, int) raises a &quot;System.ExecutionEngineException: SIGILL&quot; exception on a S390X platform
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20609023%5D%20New%3A%20Interlocked.Exchange%28ref%20int%2C%0A%20int%29%20raises%20a%20%22System.ExecutionEngineException%3A%20SIGILL%22%20exception%0A%20on%20a%20S390X%20platform&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="100862.html">
   <LINK REL="Next"  HREF="100884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 609023] New: Interlocked.Exchange(ref int, int) raises a &quot;System.ExecutionEngineException: SIGILL&quot; exception on a S390X platform</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20609023%5D%20New%3A%20Interlocked.Exchange%28ref%20int%2C%0A%20int%29%20raises%20a%20%22System.ExecutionEngineException%3A%20SIGILL%22%20exception%0A%20on%20a%20S390X%20platform&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 609023] New: Interlocked.Exchange(ref int, int) raises a &quot;System.ExecutionEngineException: SIGILL&quot; exception on a S390X platform">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed May 26 08:33:02 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="100862.html">[Mono-bugs] [Bug 499637] SerialPort.BytesToRead throws	NullReferenceException
</A></li>
        <LI>Next message: <A HREF="100884.html">[Mono-bugs] [Bug 609023] Interlocked.Exchange(ref int, int) raises a &quot;System.ExecutionEngineException: SIGILL&quot; exception on a S390X platform
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#100863">[ date ]</a>
              <a href="thread.html#100863">[ thread ]</a>
              <a href="subject.html#100863">[ subject ]</a>
              <a href="author.html#100863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=609023">http://bugzilla.novell.com/show_bug.cgi?id=609023</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=609023#c0">http://bugzilla.novell.com/show_bug.cgi?id=609023#c0</A>


           Summary: Interlocked.Exchange(ref int, int) raises a
                    &quot;System.ExecutionEngineException: SIGILL&quot; exception on
                    a S390X platform
    Classification: Mono
           Product: Mono: Runtime
           Version: SVN
          Platform: S/390-64
        OS/Version: SLES 10
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">aurelien.minvielle+mono at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


Created an attachment (id=364865)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=364865">http://bugzilla.novell.com/attachment.cgi?id=364865</A>)
Suggested patch, result from the &quot;svn diff&quot; command

User-Agent:       Mozilla/5.0 (X11; U; Linux i686; fr; rv:1.9.2.3)
Gecko/20100423 Ubuntu/10.04 (CK-IBM) (CK-IBM) Firefox/3.6.3

Using the Interlocked.Exchange(ref int, int) method on a S390X hadware platfrom
raises a SIGILL exception.

The bug only appears with the Exchange(ref int, int) overload. For instance,
Exchange(ref long, long) works fine.

The following instructions trigger the bug :

int foo = 10;
Interlocked.Exchange(ref foo, 5); // raise the SIGILL exception

Reproducible: Always

Steps to Reproduce:
Here is a trivial test case that triggers the bug :

using System;
using System.Threading;

namespace Test
{
    class MainClass
    {   
        public static void Main (string[] args)
        {
            int foo = 10;
            Interlocked.Exchange(ref foo, 5);
        }
    }
}
Actual Results:  
Unhandled Exception: System.ExecutionEngineException: SIGILL
at Test.MainClass.Main (System.String[] args) [0x00002] in
/root/InterlockedTest.cs:11 

Expected Results:  
foo should equal 5 at the terminaison and no exception should be raised.

The problem is in the JIT compiler. The Interlocked.Exchange method has been
inlined. Here is the interesting part of the S390x assembly code generated at
runtime (from &quot;mono -v -v&quot;) :

0000000000000000 &lt;t_MainClass_Main&gt;:
..
24:    a7 09 00 0a           lghi    %r0,10
28:    e3 00 f0 a8 00 50     sty    %r0,168(%r15) // initialize foo to 10
2e:    b9 04 00 2f           lgr    %r2,%r15    // copy frame base address
32:    a7 2b 00 a8           aghi    %r2,168     // calculate address of foo
36:    a7 39 00 05           lghi    %r3,5       // load new value (5)
3a:    e3 00 20 00 00 04     lg    %r0,0(%r2)  // load current value of foo
40:    ba 03 20 00           cs    %r0,%r3,0(%r2)    // compare r0 with foo and
store 5 if equal
44:    a7 74 ff fc           jne    3c &lt;t_MainClass_Main+0x3c&gt;


First remark : the variable foo is stored as a 64bit integer. That's a bit
strange, 32bits would be enough, and according to the .NET specification, &quot;int&quot;
should be mapped to &quot;Int32&quot;. But let's assume this is wanted (perhaps 64bits
instructions are faster ?)

There are at least two mistakes in this generated assembly code.
The 32bits CS instruction is used instead of the 64bits CSG instruction, thus
comparing the high-order of the storage operand with the low-order of the
register r0. So the comparison with any non-zero value will fail.
The &quot;JNE&quot; jump is then performed. But its offset is obviously wrong : it lands
right in the middle of the LG instruction. It should jump at
t_MainClass_Main+0x3a instead of t_MainClass_Main+0x3c.

This assembly is generated by the following piece of code in
mono/mini/mini-s390x.c: :

case OP_ATOMIC_EXCHANGE_I4: {
    s390_lg  (code, s390_r0, 0, ins-&gt;inst_basereg, ins-&gt;inst_offset);
    s390_cs  (code, s390_r0, ins-&gt;sreg2, ins-&gt;inst_basereg, ins-&gt;inst_offset);
    s390_jnz(code,-4);
    s390_lgfr(code, ins-&gt;dreg, s390_r0);
}

I suggest to replace the s390_cs call by s390_csg, and correct the s390_jnz
offset.
With a CS instruction, the JNZ offset should have been -5, not -4. With a CSG
instruction, It should now be -6.

This would add two half-words to the generated assembly for the
OP_ATOMIC_EXCHANGE_I4 opcode. The &quot;len&quot; specified for this opcode in
cpu-s390x:58 must be extended from 18 to 20.

These corrections seemed to do the trick for me. But perhaps the problem is
deeper : is this 64bits context correct ? Shouldn't the variable &quot;int foo&quot; be
stored as a 32bits integer ?

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>






































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="100862.html">[Mono-bugs] [Bug 499637] SerialPort.BytesToRead throws	NullReferenceException
</A></li>
	<LI>Next message: <A HREF="100884.html">[Mono-bugs] [Bug 609023] Interlocked.Exchange(ref int, int) raises a &quot;System.ExecutionEngineException: SIGILL&quot; exception on a S390X platform
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#100863">[ date ]</a>
              <a href="thread.html#100863">[ thread ]</a>
              <a href="subject.html#100863">[ subject ]</a>
              <a href="author.html#100863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
