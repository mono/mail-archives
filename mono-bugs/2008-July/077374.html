<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 412965] New: MethodBuilder.SetReturnType (null)	may cause NRE
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20412965%5D%20New%3A%20MethodBuilder.SetReturnType%20%28null%29%0A%09may%20cause%20NRE&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="077368.html">
   <LINK REL="Next"  HREF="077384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 412965] New: MethodBuilder.SetReturnType (null)	may cause NRE</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20412965%5D%20New%3A%20MethodBuilder.SetReturnType%20%28null%29%0A%09may%20cause%20NRE&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 412965] New: MethodBuilder.SetReturnType (null)	may cause NRE">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Jul 29 12:14:32 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="077368.html">[Mono-bugs] [Bug 397418] Context.Server. MapPath returns wrong path with cookieless session
</A></li>
        <LI>Next message: <A HREF="077384.html">[Mono-bugs] [Bug 412965] MethodBuilder.SetReturnType (null) may	cause NRE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77374">[ date ]</a>
              <a href="thread.html#77374">[ thread ]</a>
              <a href="subject.html#77374">[ subject ]</a>
              <a href="author.html#77374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=412965">https://bugzilla.novell.com/show_bug.cgi?id=412965</A>


           Summary: MethodBuilder.SetReturnType (null) may cause NRE
           Product: Mono: Class Libraries
           Version: SVN
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Minor
          Priority: P5 - None
         Component: CORLIB
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rkvinge at novell.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Repro:

using System;
using System.Collections.Generic;
using System.Reflection;
using System.Reflection.Emit;
using System.Text;

class vbnc_bugs {
static void Main (string [] args) {

AppDomain domain = AppDomain.CurrentDomain;
AssemblyName name = new AssemblyName (&quot;test&quot;);
AssemblyBuilder assembly = domain.DefineDynamicAssembly (name,
AssemblyBuilderAccess.RunAndSave | (AssemblyBuilderAccess) 0x800);
ModuleBuilder module = assembly.DefineDynamicModule (&quot;module&quot;);

TypeBuilder TBase = module.DefineType (&quot;TBase`1&quot;, TypeAttributes.Public, typeof
(List &lt;&gt;));
GenericTypeParameterBuilder [] TBaseParams = TBase.DefineGenericParameters (new
string [] {&quot;T&quot;});

TypeBuilder TList = module.DefineType (&quot;TList`1&quot;, TypeAttributes.Public,
TBase);
TypeBuilder A = module.DefineType (&quot;A&quot;, TypeAttributes.Public);
GenericTypeParameterBuilder [] TListParams = TList.DefineGenericParameters (new
string [] {&quot;T&quot;});
Type TListInst = TList.MakeGenericType (new Type [] {A});
MethodBuilder method = TList.DefineMethod (&quot;Add&quot;, MethodAttributes.Public,
null, Type.EmptyTypes);
method.SetReturnType (null); // This is the problem
MethodInfo methodInst = TypeBuilder.GetMethod (TListInst, method);

Console.WriteLine (methodInst.GetType ().FullName);
Console.WriteLine (methodInst.DeclaringType.FullName);
Console.WriteLine (methodInst.ReturnType);
Console.WriteLine (method.ReturnType);

method.GetILGenerator ().EmitCall (OpCodes.Call, methodInst, null);

Console.WriteLine (&quot;SUCCESS&quot;);


}
}

Expected output:
(...)
SUCCESS

Actual output:
Unhandled Exception: System.NullReferenceException: Object reference not set to
an instance of an object
  at System.Reflection.MonoGenericClass.InflateType (System.Type type)
[0x00000] in
/mono/main/src/mcs/class/corlib/System.Reflection/MonoGenericClass.cs:123 
  at System.Reflection.Emit.MethodOnTypeBuilderInst.get_ReturnType () [0x0002b]
in
/mono/main/src/mcs/class/corlib/System.Reflection.Emit/MethodOnTypeBuilderInst.cs:80 
  at vbnc_bugs.Main (System.String[] args) [0x000ec] in
/home/rolf/test/reflection.cs:29 
make: *** [reflection] Error 1
2


Note:
This only happen in Compiler mode (adding the 0x800 flag for
AssemblyBuilderAccess when creating the assembly). I've worked around this in
vbnc (using SetReturnType (System.Void) instead of null), so it's not a big
issue anymore (at least for me).

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">rolf at linux</A>:~/test&gt; mono --version
Mono JIT compiler version 2.0 (/trunk/mono r109155)
Copyright (C) 2002-2008 Novell, Inc and Contributors. www.mono-project.com
        TLS:           __thread
        GC:            Included Boehm (with typed GC)
        SIGSEGV:       altstack
        Notifications: epoll
        Architecture:  x86
        Disabled:      none


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="077368.html">[Mono-bugs] [Bug 397418] Context.Server. MapPath returns wrong path with cookieless session
</A></li>
	<LI>Next message: <A HREF="077384.html">[Mono-bugs] [Bug 412965] MethodBuilder.SetReturnType (null) may	cause NRE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#77374">[ date ]</a>
              <a href="thread.html#77374">[ thread ]</a>
              <a href="subject.html#77374">[ subject ]</a>
              <a href="author.html#77374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
