<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 58303][Nor] New - mcs mistakenly reports that types can unify
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="015153.html">
   <LINK REL="Next"  HREF="015155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 58303][Nor] New - mcs mistakenly reports that types can unify
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 58303][Nor] New - mcs mistakenly reports that types can unify">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Mon, 10 May 2004 18:35:51 -0400 (EDT)</I>
    <P><UL>
        <LI> Previous message: <A HREF="015153.html">[Mono-bugs] [Bug 58301][Min] New - &quot;file&quot; Uri constructed with empty &quot;location&quot; has wrong path
</A></li>
        <LI> Next message: <A HREF="015155.html">[Mono-bugs] [Bug 58303][Nor] Changed - mcs mistakenly reports that types can unify
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15154">[ date ]</a>
              <a href="thread.html#15154">[ thread ]</a>
              <a href="subject.html#15154">[ subject ]</a>
              <a href="author.html#15154">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:sestoft@dina.kvl.dk.">sestoft@dina.kvl.dk.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=58303">http://bugzilla.ximian.com/show_bug.cgi?id=58303</A>

--- shadow/58303	2004-05-10 18:35:51.000000000 -0400
+++ shadow/58303.tmp.10884	2004-05-10 18:35:51.000000000 -0400
@@ -0,0 +1,158 @@
+Bug#: 58303
+Product: Mono: Compilers
+Version: unspecified
+OS: 
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: C#
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:sestoft@dina.kvl.dk">sestoft@dina.kvl.dk</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: mcs mistakenly reports that types can unify
+
+Description of Problem:
+
+mcs mistakenly reports that types can unify, but they cannot (missing
+occurs/circularity check in type checker?).
+
+
+Steps to reproduce the problem:
+1. Compile the program below
+
+Actual Results:
+
+Mono C# Compiler 0.91.0.0 for Generics
+ex-gen-class-polynomial.cs(22) error CS0695: `Polynomial!1&lt;E&gt;' cannot
+implement both `AddMul!2[Polynomial!1[E],Polynomial!1[E]]' and
+`AddMul!2[E,Polynomial!1[E]]' because they may unify for some type
+parameter substitutions
+
+
+Expected Results:
+
+Program compiles correctly.
+
+
+Additional Information:
+
+Program text (a little involved, I'm afraid):
+
+using System;
+
+// A type implements AddMul&lt;A,R&gt; if one can add an A to it, giving an R:
+
+interface AddMul&lt;A,R&gt; {
+  R Add(A e);                   // Addition with A, giving R
+  R Mul(A e);                   // Multiplication with A, giving R
+}
+
+// Polynomials over E, Polynomial&lt;E&gt;:
+
+// The base type E of the polynomial must support addition,
+// multiplication and zero (via the nullary constructor).  That's what
+// the type parameter constraint on E says.
+
+// In return, one can add an E or a polynomial over E to a polynomial
+// over E.  Similarly, a polynomial over E can be multiplied by an E
+// or by a polynomial over E.  That's what the interface clauses say.
+
+class Polynomial&lt;E&gt; : AddMul&lt;E,Polynomial&lt;E&gt;&gt;,
+                      AddMul&lt;Polynomial&lt;E&gt;,Polynomial&lt;E&gt;&gt;
+  where E : AddMul&lt;E,E&gt;, new() {
+  // cs contains coefficients of x^0, x^1, ...; absent coefficients are zero.
+  // Invariant: cs != null &amp;&amp; cs.Length &gt;= 0; cs.Length==0 represents zero.
+  private readonly E[] cs;  
+
+  public Polynomial() { 
+    this.cs = new E[0];
+  }
+
+  public Polynomial(E[] cs) { 
+    this.cs = cs;
+  }
+
+  public Polynomial&lt;E&gt; Add(Polynomial&lt;E&gt; that) {
+    int newlen = Math.Max(this.cs.Length, that.cs.Length);
+    int minlen = Math.Min(this.cs.Length, that.cs.Length);
+    E[] newcs = new E[newlen];
+    if (this.cs.Length &lt;= that.cs.Length) {
+      for (int i=0; i&lt;minlen; i++)
+        newcs[i] = this.cs[i].Add(that.cs[i]);
+      for (int i=minlen; i&lt;newlen; i++)
+        newcs[i] = that.cs[i];
+    } else {
+      for (int i=0; i&lt;minlen; i++)
+        newcs[i] = this.cs[i].Add(that.cs[i]);
+      for (int i=minlen; i&lt;newlen; i++)
+        newcs[i] = this.cs[i];
+    }
+    return new Polynomial&lt;E&gt;(newcs);
+  }
+
+  public Polynomial&lt;E&gt; Add(E that) {
+    return this.Add(new Polynomial&lt;E&gt;(new E[] { that }));
+  } 
+
+  public Polynomial&lt;E&gt; Mul(E that) {
+    E[] newcs = new E[cs.Length];
+    for (int i=0; i&lt;cs.Length; i++)
+      newcs[i] = that.Mul(cs[i]);
+    return new Polynomial&lt;E&gt;(newcs);
+  }
+
+  public Polynomial&lt;E&gt; Mul(Polynomial&lt;E&gt; that) {
+    int newlen = Math.Max(1, this.cs.Length + that.cs.Length - 1);
+    E[] newcs = new E[newlen];
+    for (int i=0; i&lt;newlen; i++) {
+      E sum = new E();                     // Permitted by constraint E : new()
+      int start = Math.Max(0, i-that.cs.Length+1);
+      int stop  = Math.Min(i, this.cs.Length-1);
+      for (int j=start; j&lt;=stop; j++) {
+        // assert 0&lt;=j &amp;&amp; j&lt;this.cs.Length &amp;&amp; 0&lt;=i-j &amp;&amp; i-j&lt;that.cs.Length;
+        sum = sum.Add(this.cs[j].Mul(that.cs[i-j]));
+      }
+      newcs[i] = sum;
+    }
+    return new Polynomial&lt;E&gt;(newcs);
+  }
+
+  public E Eval(E x) {
+    E res = new E();                       // Permitted by constraint E : new()
+    for (int j=cs.Length-1; j&gt;=0; j--) 
+      res = res.Mul(x).Add(cs[j]);
+    return res;
+  }
+}  
+
+struct Int : AddMul&lt;Int,Int&gt; {
+  private readonly int i;
+  public Int(int i) {
+    this.i = i;
+  }
+  public Int Add(Int that) {
+    return new Int(this.i + that.i);
+  }
+  public Int Mul(Int that) {
+    return new Int(this.i * that.i);
+  }
+  public override String ToString() {
+    return i.ToString();
+  }
+}
+
+class TestPolynomial {
+  public static void Main(String[] args) {
+    // The integer polynomial 2 + 5x + x^2
+    Polynomial&lt;Int&gt; ip = 
+      new Polynomial&lt;Int&gt;(new Int[] { new Int(2), new Int(5), new Int(1) });
+    Console.WriteLine(ip.Eval(new Int(10)));            // 152
+    Console.WriteLine(ip.Add(ip).Eval(new Int(10)));    // 304 = 152 + 152
+    Console.WriteLine(ip.Mul(ip).Eval(new Int(10)));    // 23104 = 152 * 152
+  }
+}

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="015153.html">[Mono-bugs] [Bug 58301][Min] New - &quot;file&quot; Uri constructed with empty &quot;location&quot; has wrong path
</A></li>
	<LI> Next message: <A HREF="015155.html">[Mono-bugs] [Bug 58303][Nor] Changed - mcs mistakenly reports that types can unify
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15154">[ date ]</a>
              <a href="thread.html#15154">[ thread ]</a>
              <a href="subject.html#15154">[ subject ]</a>
              <a href="author.html#15154">[ author ]</a>
         </LI>
       </UL>
</body></html>
