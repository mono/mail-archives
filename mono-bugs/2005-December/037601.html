<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 77123][Nor] New - file object.c: line 503
	(compute_class_bitmap): assertion failed: ((field-&gt;offset %
	sizeof(gpointer)) == 0)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2077123%5D%5BNor%5D%20New%20-%20file%20object.c%3A%20line%20503%0A%09%28compute_class_bitmap%29%3A%20assertion%20failed%3A%20%28%28field-%3Eoffset%20%25%0A%09sizeof%28gpointer%29%29%20%3D%3D%200%29&In-Reply-To=bug-77123%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="037600.html">
   <LINK REL="Next"  HREF="037602.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 77123][Nor] New - file object.c: line 503
	(compute_class_bitmap): assertion failed: ((field-&gt;offset %
	sizeof(gpointer)) == 0)</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2077123%5D%5BNor%5D%20New%20-%20file%20object.c%3A%20line%20503%0A%09%28compute_class_bitmap%29%3A%20assertion%20failed%3A%20%28%28field-%3Eoffset%20%25%0A%09sizeof%28gpointer%29%29%20%3D%3D%200%29&In-Reply-To=bug-77123%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 77123][Nor] New - file object.c: line 503
	(compute_class_bitmap): assertion failed: ((field-&gt;offset %
	sizeof(gpointer)) == 0)">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Thu Dec 29 15:05:54 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="037600.html">[Mono-bugs] [Bug 77122][Wis] New -
	System.Object:__stfld_wrapper_System.Object
</A></li>
        <LI>Next message: <A HREF="037602.html">[Mono-bugs] [Bug 77122][Wis] Changed -
	System.Object:__stfld_wrapper_System.Object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37601">[ date ]</a>
              <a href="thread.html#37601">[ thread ]</a>
              <a href="subject.html#37601">[ subject ]</a>
              <a href="author.html#37601">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tjfontaine at gmail.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=77123">http://bugzilla.ximian.com/show_bug.cgi?id=77123</A>

--- shadow/77123	2005-12-29 15:05:54.000000000 -0500
+++ shadow/77123.tmp.22415	2005-12-29 15:05:54.000000000 -0500
@@ -0,0 +1,199 @@
+Bug#: 77123
+Product: Mono: Runtime
+Version: unspecified
+OS: GNU/Linux [Other]
+OS Details: ubuntu breezy
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: misc
+AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>                            
+ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">tjfontaine at gmail.com</A>               
+QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: file object.c: line 503 (compute_class_bitmap): assertion failed: ((field-&gt;offset % sizeof(gpointer)) == 0)
+
+Please fill in this template when reporting a bug, unless you know what you
+are doing.
+Description of Problem:
+Everytime code is run it aborts with:
+file object.c: line 503 (compute_class_bitmap): assertion failed:
+((field-&gt;offset % sizeof(gpointer)) == 0)
+
+Steps to reproduce the problem:
+1. Compile the following code with gmcs /unsafe Fat32.cs
+
+using System;
+using System.IO;
+using System.Runtime.InteropServices;
+
+namespace Atx.FileSystem.VFat
+{
+    public class Fat32
+    {
+        private ushort brsanity = 0x55AA;
+        private uint fsisanity1 = 0x52526141;
+        private uint fsisanity2 = 0x72724161;
+
+        private Fat32BootRecord bootrecord;
+        private Fat32FileSystemInfo filesysteminfo;
+
+        private Stream file;
+
+	public static void Main(string[] args)
+	{
+		Fat32 fat;
+		
+		if(File.Exists(args[0]))
+		{
+			using(FileStream fs = new FileStream(args[0], FileMode.Open))
+			{
+				fat = new Fat32(fs);
+			}
+		}
+		else
+		{
+			Console.WriteLine(&quot;Usage: Fat32.exe &lt;fat32 image file&gt;&quot;);
+		}
+	}
+
+        public Fat32(Stream f)
+        {
+            file = f;
+            ReadBootRecord();
+            ReadFileSystemInfo(bootrecord.sectornumfsi,
+bootrecord.bytespersector);
+        }
+
+        private void ReadFileSystemInfo(int sectorNum, int sectorSize)
+        {
+            byte[] buff = new byte[512];
+            file.Seek(sectorNum * sectorSize, SeekOrigin.Begin);
+            file.Read(buff, 0, 512);
+
+            filesysteminfo = ReadStruct&lt;Fat32FileSystemInfo&gt;(buff);
+
+            if (filesysteminfo.brsignature != brsanity ||
+filesysteminfo.firstsignature != fsisanity1 ||
+                filesysteminfo.secondsignature != fsisanity2)
+                throw new Exception(&quot;Failed File System Info Signature
+Sanity Check&quot;);
+        }
+
+        private void ReadBootRecord()
+        {
+            byte[] buff = new byte[512];
+            file.Read(buff, 0, 512);
+
+            bootrecord = ReadStruct&lt;Fat32BootRecord&gt;(buff);
+
+            if (bootrecord.signature != brsanity)
+                throw new Exception(&quot;Failed Boot Record Singature Sanity
+Check&quot;);
+            
+            buff = null;
+        }
+
+        private T ReadStruct&lt;T&gt;(byte[] source) where T: struct
+        {
+            int objectSize = Marshal.SizeOf(typeof(T));
+
+            if (source.Length &lt; objectSize)
+                throw new Exception(&quot;Size Mismatch&quot;);
+            
+            T returnStruct;
+
+            unsafe
+            {
+                fixed (byte* bufferPointer = &amp;source[0])
+                    returnStruct =
+(T)Marshal.PtrToStructure((IntPtr)bufferPointer, typeof(T));
+            }
+
+            return returnStruct; 
+        }
+    }
+
+    [StructLayout(LayoutKind.Sequential, Size=512, Pack = 1)]
+    public struct Fat32FileSystemInfo
+    {
+        public uint firstsignature;
+	[MarshalAs(UnmanagedType.ByValArray, SizeConst=480)]
+        public byte[] unknown;
+        public uint secondsignature;
+        public uint numoffreeclusters;
+        public uint recentclusteralloc;
+	[MarshalAs(UnmanagedType.ByValArray, SizeConst=12)]
+        public byte[] reserved;
+        public ushort unknown2;
+        public ushort brsignature;
+    }
+
+    [StructLayout(LayoutKind.Sequential, Size=512, Pack=1)]
+    public struct Fat32BootRecord
+    {
+        [MarshalAs(UnmanagedType.ByValArray, SizeConst=3)]
+        public byte[] jmpcode;
+        [MarshalAs(UnmanagedType.ByValTStr, SizeConst=8)]
+        public string oemname;
+        public ushort bytespersector;
+        public byte sectorspercluster;
+        public ushort reservedsectors;
+        public byte numoffats;
+        public ushort maxrootentries;
+        public ushort numofsmallsectors;
+        public byte mediadescriptor;
+        public ushort sectorsperfat;
+        public ushort sectorspertrack;
+        public ushort numofheads;
+        public uint numofhiddensectors;
+        public uint numofsectors;
+        public uint numofsectorsperfat;
+        public ushort flags;
+        public ushort version;
+        public uint clusterstartnum;
+        public ushort sectornumfsi;
+        public ushort sectornumback;
+        [MarshalAs(UnmanagedType.ByValArray, SizeConst=12)]
+        public byte[] reserved;
+        public byte logicaldrivenum;
+        public byte unused;
+        public byte extsignature;
+        public uint serialnum;
+        [MarshalAs(UnmanagedType.ByValTStr, SizeConst=11)]
+        public string volumename;
+        [MarshalAs(UnmanagedType.ByValTStr, SizeConst=8)]
+        public string fatname;
+        [MarshalAs(UnmanagedType.ByValArray, SizeConst=420)]
+        public byte[] exectuablecode;
+        public ushort signature;
+    }
+}
+
+2. run with mono Fat32.exe (with or without arguments)
+3. 
+
+Actual Results:
<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">+tjfontaine at xenmaster</A>:~$ mono Fat32.exe fat32.img
+
+** ERROR **: file object.c: line 503 (compute_class_bitmap): assertion
+failed: ((field-&gt;offset % sizeof(gpointer)) == 0)
+aborting...
+Aborted
+
+
+Expected Results:
+it would run
+
+How often does this happen? 
+every time
+
+Additional Information:
+The code compiles fine and runs as expected on ms.net 2.0. I tried several
+different ways to get around it, as it's own seperate assembly, generics
+and no unsafe, no generics with unsafe, and no generics and no unsafe,
+compiling with gmcs or mcs, with latest svn or 1.1.10 on multiple linux
+systems. All resulted in the same error.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="037600.html">[Mono-bugs] [Bug 77122][Wis] New -
	System.Object:__stfld_wrapper_System.Object
</A></li>
	<LI>Next message: <A HREF="037602.html">[Mono-bugs] [Bug 77122][Wis] Changed -
	System.Object:__stfld_wrapper_System.Object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37601">[ date ]</a>
              <a href="thread.html#37601">[ thread ]</a>
              <a href="subject.html#37601">[ subject ]</a>
              <a href="author.html#37601">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
