<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 81749][Maj] New - mod-mono-server2 crashes (w/	workaround)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2081749%5D%5BMaj%5D%20New%20-%20mod-mono-server2%20crashes%20%28w/%0A%09workaround%29&In-Reply-To=bug-81749%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="057661.html">
   <LINK REL="Next"  HREF="057663.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 81749][Maj] New - mod-mono-server2 crashes (w/	workaround)</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2081749%5D%5BMaj%5D%20New%20-%20mod-mono-server2%20crashes%20%28w/%0A%09workaround%29&In-Reply-To=bug-81749%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 81749][Maj] New - mod-mono-server2 crashes (w/	workaround)">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Sun May 27 15:00:01 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="057661.html">[Mono-bugs] [Bug 81685][Wis] Changed - Stack Overflow detection
</A></li>
        <LI>Next message: <A HREF="057663.html">[Mono-bugs] [Bug 81749][Maj] Changed - mod-mono-server2 crashes (w/	workaround)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57662">[ date ]</a>
              <a href="thread.html#57662">[ thread ]</a>
              <a href="subject.html#57662">[ subject ]</a>
              <a href="author.html#57662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mmorano at mikeandwan.us.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=81749">http://bugzilla.ximian.com/show_bug.cgi?id=81749</A>

--- shadow/81749	2007-05-27 15:00:01.000000000 -0400
+++ shadow/81749.tmp.22808	2007-05-27 15:00:01.000000000 -0400
@@ -0,0 +1,119 @@
+Bug#: 81749
+Product: Mono: Class Libraries
+Version: 1.2
+OS: 
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Major
+Component: Sys.Web
+AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mhabersack at novell.com</A>                            
+ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mmorano at mikeandwan.us</A>               
+QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: mod-mono-server2 crashes (w/ workaround)
+
+I recently updated mono/mcs/xsp/mod_mono from svn and afterwards my website
+no longer worked via apache/mod_mono, however it would still work properly
+when accessed via xsp2.
+
+After restarting all the processes, I could see mod-mono-server2 properly
+established and awaiting requests.  However, when I made the first request
+to the site, fairly quickly the process would die.  I was eventually able
+to run the process manually by setting MonoRunXSP to false, and saw that it
+was segfaulting.
+
+I then ran the process manually with tracing enabled using the following
+command:
+
+MONO_OPTIONS=&quot;--trace=T:Mono.WebServer.MonoWorkerRequest,Mono.WebServer.ModMonoWorkerRequest,T:System.Web.Configuration.WebConfigurationManager,T:System.Web.Util.WebEncoding,T:System.Web.Configuration.GlobalizationSection,T:System.Web.Compilation.AppCodeCompiler,T:System.Web.HttpApplicationFactory,T:System.Web.HttpRequest&quot;
+/usr/local/bin/mod-mono-server2 --filename /tmp/mod_mono_server_maw
+--applications www.mikeandwan.us:/:/usr/share/webapps/mikeandwan_us
+--nonstop --root /usr/share/webapps/mikeandwan_us &gt; x.txt
+
+The output (sample is attached after this post) illustrates an issue with
+resolving the Path for the request, and appears to be associated with how
+the system tries to identify the Encoding to use (causes infinite loop).
+
+Anyways, I have been able to work around this issue for now by adding the
+following method to ModMonoWorkerRequest.cs in the xsp tree:
+
+
+        public override byte [] GetQueryStringRawBytes ()
+        {
+            if (queryString == null || queryString.Length == 0)
+                return null;
+
+            return Encoding.GetBytes (queryString);
+        }
+
+
+This was modeled after the same method that is in XSPWorkerRequest, but
+introduces a check so if the length of the querystring is 0, this returns null.
+
+I'm sure this is probably not the correct fix, but it does get around the
+problem for me, and it is not clear to me where to appropriately fix this
+issue.  I was also curious if this is somehow specific to how I have Apache
+configured for this virtual host, which follows below:
+
+
+&lt;VirtualHost *:80&gt;
+    ServerName www.mikeandwan.us
+    ServerAdmin <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mmorano at mikeandwan.us</A>
+    DocumentRoot &quot;/usr/share/webapps/mikeandwan_us&quot;
+
+    Include conf/mod_mono.conf
+    MonoDocumentRootDir maw &quot;/usr/share/webapps/mikeandwan_us&quot;
+    MonoApplications maw &quot;www.mikeandwan.us:/:/usr/share/webapps/mikeandwan_us&quot;
+    MonoServerPath maw &quot;/usr/local/bin/mod-mono-server2&quot;
+
+    #MonoRunXSP maw false
+    #MonoDebug maw true
+    #MonoUnixSocket maw &quot;/tmp/mod_mono_www.mikeandwan.us&quot;
+
+    SetOutputFilter DEFLATE
+
+    ErrorLog /var/log/apache2/mikeandwan_error.log
+    TransferLog /var/log/apache2/mikeandwan_access.log
+
+    &lt;IfModule mod_rewrite.c&gt;
+        RewriteEngine on
+        RewriteCond %{REQUEST_METHOD} !^(GET|POST|HEAD)$
+        RewriteRule .* - [F]
+    &lt;/IfModule&gt;
+
+    &lt;Directory &quot;/usr/share/webapps/mikeandwan_us&quot;&gt;
+        MonoSetServerAlias maw
+        #AddHandler mono .aspx .ascx .asax .ashx .config .cs .asmx .axd
+        SetHandler mono
+
+        &lt;FilesMatch &quot;\.(gif|jp?g|png|css|ico|xsl|wmv|zip)$&quot;&gt;
+            SetHandler None
+        &lt;/FilesMatch&gt;
+
+        Options Indexes FollowSymLinks
+        #DirectoryIndex index.aspx
+        AllowOverride None
+        Order allow,deny
+        Allow from all
+    &lt;/Directory&gt;
+
+    &lt;IfDefine INFO&gt;
+        &lt;Location /mono&gt;
+            SetHandler mono-ctrl
+            Order deny,allow
+            Deny from all
+            Allow from 127.0.0.1
+        &lt;/Location&gt;
+    &lt;/IfDefine&gt;
+&lt;/VirtualHost&gt;
+
+
+Let me know if there is anything else that would be useful to track this
+down, it's taken me a bit of time to get this far...
+
+
+Thanks!
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="057661.html">[Mono-bugs] [Bug 81685][Wis] Changed - Stack Overflow detection
</A></li>
	<LI>Next message: <A HREF="057663.html">[Mono-bugs] [Bug 81749][Maj] Changed - mod-mono-server2 crashes (w/	workaround)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57662">[ date ]</a>
              <a href="thread.html#57662">[ thread ]</a>
              <a href="subject.html#57662">[ subject ]</a>
              <a href="author.html#57662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
