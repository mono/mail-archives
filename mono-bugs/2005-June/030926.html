<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 75374][Wis] New - P/Invoke calls with
	CharSet=CharSet.Unicode do not properly convert returned string
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2075374%5D%5BWis%5D%20New%20-%20P/Invoke%20calls%20with%0A%09CharSet%3DCharSet.Unicode%20do%20not%20properly%20convert%20returned%20string&In-Reply-To=bug-75374%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030925.html">
   <LINK REL="Next"  HREF="030927.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 75374][Wis] New - P/Invoke calls with
	CharSet=CharSet.Unicode do not properly convert returned string</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2075374%5D%5BWis%5D%20New%20-%20P/Invoke%20calls%20with%0A%09CharSet%3DCharSet.Unicode%20do%20not%20properly%20convert%20returned%20string&In-Reply-To=bug-75374%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 75374][Wis] New - P/Invoke calls with
	CharSet=CharSet.Unicode do not properly convert returned string">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Fri Jun 24 19:17:18 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="030925.html">[Mono-bugs] [Bug 70860][Nor] Changed - No stacktrace with
	exceptions in other threads
</A></li>
        <LI>Next message: <A HREF="030927.html">[Mono-bugs] [Bug 75374][Wis] Changed - P/Invoke calls with
	CharSet=CharSet.Unicode do not properly convert returned string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30926">[ date ]</a>
              <a href="thread.html#30926">[ thread ]</a>
              <a href="subject.html#30926">[ subject ]</a>
              <a href="author.html#30926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">chastamar at yahoo.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=75374">http://bugzilla.ximian.com/show_bug.cgi?id=75374</A>

--- shadow/75374	2005-06-24 19:17:18.000000000 -0400
+++ shadow/75374.tmp.4554	2005-06-24 19:17:18.000000000 -0400
@@ -0,0 +1,65 @@
+Bug#: 75374
+Product: Mono: Runtime
+Version: 1.1
+OS: 
+OS Details: Linux 2.6 x86
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Wishlist
+Component: interop
+AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>                            
+ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">chastamar at yahoo.com</A>               
+QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: P/Invoke calls with CharSet=CharSet.Unicode do not properly convert returned string
+
+Please fill in this template when reporting a bug, unless you know what you
+are doing.
+Description of Problem:
+When specifying CharSet=CharSet.Unicode for the DllImport attribute of a
+PInvoke method, the expected behaviour is for string parameters and return
+value to be marshalled to/from unicode (utf16). However, it seems mono
+ignores this attribute for the return value and resortes to the default
+string conversion.
+
+I will attach a test case which includes:
+1. A .c file with a simple function (unicode_str_func) that just copies the
+given string as-is to a newly-allocated buffer and returns it.
+2. A .cs file which calls unicode_str_func (with DllImport specifying
+CharSet=CharSet.Unicode). The original and returned strings are printed.
+The returned string is truncated after the first character - a sign for the
+wrong (8-bit - utf8?) conversion which has occured.
+
+Steps to reproduce the problem:
+1. Compile the attached .cs file with:
+mcs -codepage:utf8 TestUnicodeMarshalling.cs
+2. Compile the attached .c file with:
+gcc -shared TestUnicodeFunc.c -o unicode_str_func.so
+3. Run (with LD_LIBRARY_PATH including &quot;.&quot;):
+mono TestUnicodeMarshalling.exe
+4. Watch and enjoy :-)
+
+Actual Results:
+The returned unicode string is converted as an 8-bit string.
+
+Expected Results:
+Perform the correct conversion (which just copies the string verbatim, as
+utf16 is mono's native string encoding).
+
+How often does this happen? 
+All the time.
+
+Additional Information:
+ECMA-335 says: (14.5.2, asterisks added)
+&quot;The attributes ansi, autochar, and unicode are mutually exclusive.  They
+govern how strings will be marshaled for calls to this method: ansi
+indicates that the native code will receive (and possibly ***return***) a
+platform-specific representation that corresponds to a string encoded in
+the ANSI character set (typically this would match the representation of a
+C or C++ string constant); autochar indicates a platform-specific
+representation that is &#147;natural&#148; for the underlying platform; and unicode
+indicates a platform-specific representation that corresponds to a string
+encoded for use with Unicode methods on that platform.&quot;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030925.html">[Mono-bugs] [Bug 70860][Nor] Changed - No stacktrace with
	exceptions in other threads
</A></li>
	<LI>Next message: <A HREF="030927.html">[Mono-bugs] [Bug 75374][Wis] Changed - P/Invoke calls with
	CharSet=CharSet.Unicode do not properly convert returned string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30926">[ date ]</a>
              <a href="thread.html#30926">[ thread ]</a>
              <a href="subject.html#30926">[ subject ]</a>
              <a href="author.html#30926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
