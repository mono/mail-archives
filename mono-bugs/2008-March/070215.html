<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 366400] New: DynamicMethod hits a &quot;implement me&quot; / &quot; should notbe reached&quot; error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20366400%5D%20New%3A%20DynamicMethod%20hits%20a%20%22implement%20me%22%20/%0A%20%22%20should%20notbe%20reached%22%20error&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="070251.html">
   <LINK REL="Next"  HREF="070218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 366400] New: DynamicMethod hits a &quot;implement me&quot; / &quot; should notbe reached&quot; error</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20366400%5D%20New%3A%20DynamicMethod%20hits%20a%20%22implement%20me%22%20/%0A%20%22%20should%20notbe%20reached%22%20error&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 366400] New: DynamicMethod hits a &quot;implement me&quot; / &quot; should notbe reached&quot; error">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sat Mar  1 10:37:18 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="070251.html">[Mono-bugs] [Bug 366380] can't compile mono
</A></li>
        <LI>Next message: <A HREF="070218.html">[Mono-bugs] [Bug 366400] DynamicMethod hits a &quot;implement me&quot; / &quot;should notbe reached&quot; error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#70215">[ date ]</a>
              <a href="thread.html#70215">[ thread ]</a>
              <a href="subject.html#70215">[ subject ]</a>
              <a href="author.html#70215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=366400">https://bugzilla.novell.com/show_bug.cgi?id=366400</A>


           Summary: DynamicMethod hits a &quot;implement me&quot; / &quot;should notbe
                    reached&quot; error
           Product: Mono: Runtime
           Version: 1.2.6
          Platform: x86
        OS/Version: Windows XP
            Status: NEW
          Severity: Blocker
          Priority: P5 - None
         Component: misc
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">timoch at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Development


Description of Problem:

A program using dynamic methods to map calls to delegates to actual static or
instance methods throws errors when run.

The sample program provided below compiles and runs as expected under ms.net
runtime. However, it does compile but does not run under mono

Steps to reproduce the problem:
1. Compile and run the following program 

using System;
using System.Collections.Generic;
using System.Text;
using System.Reflection.Emit;
using System.Reflection;
using System.Globalization;

namespace DynamicMethodTest {
    class Program {
        public delegate object BodyDelegate(object[] parameters);

        public static int GetInt(int i) {
            return i;
        }

        static void Main(string[] args) {
            MethodInfo minfo = typeof(Program).GetMethod(&quot;GetInt&quot;);
            DynamicMethod method = new DynamicMethod(&quot;GetInt&quot;, typeof(object),
                new Type[] { typeof(object[]) }, typeof(Program).Module);

            // generate the method body
            ILGenerator generator = method.GetILGenerator();

            MethodInfo changetype = typeof(Convert).GetMethod(&quot;ChangeType&quot;, new
Type[] { typeof(object), typeof(Type), typeof(IFormatProvider) });
            MethodInfo gettypefromhandle =
typeof(Type).GetMethod(&quot;GetTypeFromHandle&quot;, new Type[] {
typeof(RuntimeTypeHandle) });
            MethodInfo get_InvariantCulture =
typeof(CultureInfo).GetMethod(&quot;get_InvariantCulture&quot;, BindingFlags.Static |
BindingFlags.Public,
                null, Type.EmptyTypes, null);
            // for each parameter of the original method, load it on stack
            ParameterInfo[] parameters = minfo.GetParameters();
            for (int i = 0; i &lt; parameters.Length; i++) {
                ParameterInfo par = parameters[i];
                // load the array
                generator.Emit(OpCodes.Ldarg, 0);
                // load the index in the array
                generator.Emit(OpCodes.Ldc_I4, (int)i);
                // get the element at given index
                generator.Emit(OpCodes.Ldelem_Ref);
                // convert it if necessary
                if (par.ParameterType.IsPrimitive || par.ParameterType ==
typeof(string)) {
                    // load the parameter type onto stack
                    generator.Emit(OpCodes.Ldtoken, par.ParameterType);
                    generator.EmitCall(OpCodes.Callvirt, gettypefromhandle,
null);
                    // load the invariant culture onto stack
                    generator.EmitCall(OpCodes.Call, get_InvariantCulture,
null);
                    // call Convert.ChangeType
                    generator.EmitCall(OpCodes.Call, changetype, null);
                    // if necessary, unbox the value
                    if (par.ParameterType.IsValueType)
                        generator.Emit(OpCodes.Unbox_Any, par.ParameterType);
                }
            }

            generator.EmitCall(OpCodes.Call, minfo, null);

            if (minfo.ReturnType == typeof(void))
                generator.Emit(OpCodes.Ldnull);
            if (minfo.ReturnType.IsValueType)
                generator.Emit(OpCodes.Box, minfo.ReturnType);
            generator.Emit(OpCodes.Ret);

            BodyDelegate del =
(BodyDelegate)method.CreateDelegate(typeof(BodyDelegate));
            Console.WriteLine(del(new object[] { 0 }));
        }
    }
}

Actual Results:

When run under MacOSX 10.5 : 
** (Program.exe:8198): WARNING **: mono_class_from_mono_type: implement me 0x00


** ERROR **: file class.c: line 3935 (mono_class_from_mono_type): should not be
reached
aborting...
Stacktrace:

  at (wrapper managed-to-native) System.Type.internal_from_handle (intptr)
&lt;0x00004&gt;
  at (wrapper managed-to-native) System.Type.internal_from_handle (intptr)
&lt;0xffffffff&gt;
  at System.Type.GetTypeFromHandle (System.RuntimeTypeHandle) [0x00000] in
/private/tmp/monobuild/build/BUILD/mono-1.2.6/mcs/class/corlib/System/Type.cs:529
  at (wrapper dynamic-method) System.Object.GetInt (object[]) &lt;0xffffffff&gt;
  at DynamicMethodTest.Program.Main (string[]) &lt;0x00841&gt;
  at (wrapper runtime-invoke)
DynamicMethodTest.Program.runtime_invoke_void_string[]
(object,intptr,intptr,intptr) &lt;0xffffffff&gt;
Abort trap


When run under Windows XP : 
** (Program.exe:3112): WARNING **: mono_class_from_mono_type: implement me 0x00


This application has requested the Runtime to terminate it in an unusual way.
Please contact the application's support team for more information.

and a popup windows shows : &quot;** ERROR **: file class.c: line 3935
(mono_class_from_mono_type): should not be reached
aborting...&quot;

Expected Results:

The program should output a single line :
0

How often does this happen? 
Always

Additional Information:
It runs perfectly under ms.net implementation


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="070251.html">[Mono-bugs] [Bug 366380] can't compile mono
</A></li>
	<LI>Next message: <A HREF="070218.html">[Mono-bugs] [Bug 366400] DynamicMethod hits a &quot;implement me&quot; / &quot;should notbe reached&quot; error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#70215">[ date ]</a>
              <a href="thread.html#70215">[ thread ]</a>
              <a href="subject.html#70215">[ subject ]</a>
              <a href="author.html#70215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
