<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 479209] New: [Regression] Compiler generates invalid code on certain inputs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20479209%5D%20New%3A%20%5BRegression%5D%20Compiler%20generates%0A%20invalid%20code%20on%20certain%20inputs&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="086461.html">
   <LINK REL="Next"  HREF="086472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 479209] New: [Regression] Compiler generates invalid code on certain inputs</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20479209%5D%20New%3A%20%5BRegression%5D%20Compiler%20generates%0A%20invalid%20code%20on%20certain%20inputs&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 479209] New: [Regression] Compiler generates invalid code on certain inputs">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Feb 24 14:42:43 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="086461.html">[Mono-bugs] [Bug 479203] New: monodis reports uninformative error when asked to dissassemble non-existent file.
</A></li>
        <LI>Next message: <A HREF="086472.html">[Mono-bugs] [Bug 479209] [Regression] Compiler generates invalid code on certain inputs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#86462">[ date ]</a>
              <a href="thread.html#86462">[ thread ]</a>
              <a href="subject.html#86462">[ subject ]</a>
              <a href="author.html#86462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=479209">https://bugzilla.novell.com/show_bug.cgi?id=479209</A>


           Summary: [Regression] Compiler generates invalid code on
                    certain inputs
    Classification: Mono
           Product: Mono: Compilers
           Version: SVN
          Platform: Macintosh
        OS/Version: Mac OS X 10.5
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">dmitchell at logos.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


User-Agent:       Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_5_6; en-us)
AppleWebKit/525.27.1 (KHTML, like Gecko) Version/3.2.1 Safari/525.27.1

Here's come C# code:

---
using System;

public sealed class Thing&lt;TFirst&gt; where TFirst : class
{
    public static Thing&lt;TFirst&gt; Create&lt;TSecond&gt;(Func&lt;TFirst, TSecond&gt; fn)
        where TSecond : class
    {
        return new Thing&lt;TFirst&gt;(
            delegate(TFirst item)
            {
                TSecond foo = item == null ? null : fn(item);
                Console.WriteLine(foo);
            });
    }

    public void SomeAction()
    {
        _fn(null);
    }

    private Thing(Action&lt;TFirst&gt; fn)
    {
        _fn = fn;
    }

    Action&lt;TFirst&gt; _fn;
}

public static class Program
{
    public static void Main()
    {
        var foo = Thing&lt;object&gt;.Create(x =&gt; x);
        foo.SomeAction();
    }
}
---

Under the 2.2 compiler, this emits valid code, but in the most recent SVN
revisions, it emits code that fails to run correctly under either Mono or
MS.NET. When attempting to run under mono, this is the program output:

---
**
ERROR:method-to-ir.c:2531:emit_get_rgctx: assertion failed:
(method-&gt;is_inflated &amp;&amp; mono_method_get_context (method)-&gt;method_inst)
Stacktrace:

  at Thing`1&lt;object&gt;.SomeAction () &lt;0xffffffff&gt;
  at Thing`1&lt;object&gt;.SomeAction () &lt;0x0003b&gt;
  at Program.Main () &lt;0x00065&gt;
  at (wrapper runtime-invoke) object.runtime_invoke_void
(object,intptr,intptr,intptr) &lt;0xffffffff&gt;

Native stacktrace:

    0   mono                                0x00088321
mono_handle_native_sigsegv + 241
    1   libSystem.B.dylib                   0x965f72bb _sigtramp + 43
    2   ???                                 0xffffffff 0x0 + 4294967295
    3   libSystem.B.dylib                   0x9666b23a raise + 26
    4   libSystem.B.dylib                   0x96677679 abort + 73
    5   libglib-2.0.0.1800.1.dylib          0x0037bf74 g_assertion_message +
253
    6   libglib-2.0.0.1800.1.dylib          0x0037c4b6 g_assertion_message_expr
+ 87
    7   mono                                0x000114af
mono_decompose_array_access_opts + 3519
    8   mono                                0x00011a8f
mono_decompose_array_access_opts + 5023
    9   mono                                0x00028522 mono_method_to_ir +
51426
    10  mono                                0x00006e73 mini_method_compile +
499
    11  mono                                0x0000938f mini_method_compile +
9999
    12  mono                                0x00089c48 mono_delegate_trampoline
+ 504
    13  ???                                 0x00439574 0x0 + 4429172
    14  ???                                 0x004922ee 0x0 + 4793070
    15  ???                                 0x004921fa 0x0 + 4792826
    16  mono                                0x001397eb mono_runtime_exec_main +
251
    17  mono                                0x0013de83 mono_runtime_run_main +
339
    18  mono                                0x00066533 mono_main + 6083
    19  mono                                0x00001ee6 start + 54
    20  ???                                 0x00000002 0x0 + 2

Debug info from gdb:


=================================================================
Got a SIGABRT while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries 
used by your application.
=================================================================


Debug info from gdb:


=================================================================
Got a SIGABRT while executing native code. This usually indicates
a fatal error in the mono runtime or one of the native libraries 
used by your application.
=================================================================

Abort trap


Reproducible: Always

Steps to Reproduce:
1. Compile the included code with a recent svn build of gmcs
2. Run it
3.
Actual Results:  
mono crashes because the executable image is faulty.

Expected Results:  
gmcs should produce an executable image that mono can execute.

Upon dissassembling the code produced by both versions using monodis, the
problem seems to be on line 112 of the 2.4 code, which corresponds to line
IL_000c, below:

---
    // method line 7
    .method assembly hidebysig 
           instance default void '&lt;&gt;m__0' (!TFirst item)  cil managed 
    {
        // Method begins at RVA 0x2180
    // Code size 47 (0x2f)
    .maxstack 5
    .locals init (
        !TSecond    V_0)
    IL_0000:  ldarg.1 
    IL_0001:  box !0
    IL_0006:  brtrue IL_0016

    IL_000b:  ldnull 
    IL_000c:  unbox.any !!0
    IL_0011:  br IL_0022

    IL_0016:  ldarg.0 
    IL_0017:  ldfld class [System.Core]System.Func`2&lt;!0,!1&gt; class
Thing`1/'&lt;Create&gt;c__AnonStorey0`1'&lt;!0,!1&gt;::fn
    IL_001c:  ldarg.1 
    IL_001d:  callvirt instance !1 class [System.Core]System.Func`2&lt;!TFirst,
!TSecond&gt;::Invoke(!0)
    IL_0022:  stloc.0 
    IL_0023:  ldloc.0 
    IL_0024:  box !1
    IL_0029:  call void class [mscorlib]System.Console::WriteLine(object)
    IL_002e:  ret 
    } // end of method &lt;Create&gt;c__AnonStorey0`1::&lt;&gt;m__0
---

&gt;<i>From what I can tell, !!0 is an invalid type token. using !0 or !1 instead (or
</I>removing the line entirely) and reassembling both produce a valid image; I
*believe* the !1 is more appropriate here, but my understanding of il is not
strong enough for me to be entirely certain.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="086461.html">[Mono-bugs] [Bug 479203] New: monodis reports uninformative error when asked to dissassemble non-existent file.
</A></li>
	<LI>Next message: <A HREF="086472.html">[Mono-bugs] [Bug 479209] [Regression] Compiler generates invalid code on certain inputs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#86462">[ date ]</a>
              <a href="thread.html#86462">[ thread ]</a>
              <a href="subject.html#86462">[ subject ]</a>
              <a href="author.html#86462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
