<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 502251] New: Xml schema validation fails in XmlSchemaComplexType in some cases due to incorrect order of checks (patch included)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20502251%5D%20New%3A%20Xml%20schema%20validation%20fails%20in%0A%20XmlSchemaComplexType%20in%20some%20cases%20due%20to%20incorrect%20order%20of%20checks%20%28patch%0A%20included%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="088702.html">
   <LINK REL="Next"  HREF="088705.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 502251] New: Xml schema validation fails in XmlSchemaComplexType in some cases due to incorrect order of checks (patch included)</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20502251%5D%20New%3A%20Xml%20schema%20validation%20fails%20in%0A%20XmlSchemaComplexType%20in%20some%20cases%20due%20to%20incorrect%20order%20of%20checks%20%28patch%0A%20included%29&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 502251] New: Xml schema validation fails in XmlSchemaComplexType in some cases due to incorrect order of checks (patch included)">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri May  8 12:55:12 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="088702.html">[Mono-bugs] [Bug 502216] Starting second instance of monovs-{, gui-}server segfaults
</A></li>
        <LI>Next message: <A HREF="088705.html">[Mono-bugs] [Bug 312409] ThreadPool.RegisterWaitForSingleObject	does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#88704">[ date ]</a>
              <a href="thread.html#88704">[ thread ]</a>
              <a href="subject.html#88704">[ subject ]</a>
              <a href="author.html#88704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=502251">http://bugzilla.novell.com/show_bug.cgi?id=502251</A>

User <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jonas.larsson at manodo.se</A> added comment
<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=502251#c82010">http://bugzilla.novell.com/show_bug.cgi?id=502251#c82010</A>

           Summary: Xml schema validation fails in XmlSchemaComplexType in
                    some cases due to incorrect order of checks (patch
                    included)
    Classification: Mono
           Product: Mono: Class Libraries
           Version: 2.4.x
          Platform: i686
        OS/Version: Ubuntu
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.XML
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">atsushi at ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jonas.larsson at manodo.se</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Created an attachment (id=291049)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=291049">http://bugzilla.novell.com/attachment.cgi?id=291049</A>)
Patch for XmlSchemaComplexType. Fixes this bug without regressions

User-Agent:       Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.10)
Gecko/2009042523 Ubuntu/9.04 (jaunty) Firefox/3.0.10

Under certain circumstances validation of XmlSchemaComplexType fails due to
the order of the different actions in the Validate () method. Judging from
the test case for the non public bug #82010, I think the two are related.
Put shortly: Problems occur if a type somehow can have itself as &quot;child&quot;.

The following test code demonstrates the problem, which only exists on mono
ans not .net. The test code is quite long, sorry for that. Original code is
several thousands of lines. I tried to strip it to keep it as simple as 
possible.

Test code:
fails on mono &quot;XmlSchema error: Invalid start element: foo:Conditional&quot;
-----------

string xsd = @&quot;
   &lt;xs:schema id='foo' targetNamespace='foo' 
     elementFormDefault='qualified' 
     xmlns='foo'     
     xmlns:xs='<A HREF="http://www.w3.org/2001/XMLSchema'">http://www.w3.org/2001/XMLSchema'</A>&gt;

 &lt;xs:group name='LayoutElementTypes'&gt;
  &lt;xs:choice&gt;   
   &lt;xs:element name='Rows' type='Rows' /&gt;
   &lt;xs:element name='Conditional' type='Conditional' /&gt;   
  &lt;/xs:choice&gt;
 &lt;/xs:group&gt;

 &lt;xs:complexType name='Element' abstract='true'&gt;
  &lt;xs:attribute name='id' type='xs:ID' use='optional'/&gt;
 &lt;/xs:complexType&gt;

 &lt;xs:complexType name='SingleChildElement' abstract='true'&gt;
  &lt;xs:complexContent&gt;
   &lt;xs:extension base='Element'&gt;
    &lt;xs:group ref='LayoutElementTypes' minOccurs='1' maxOccurs='1' /&gt;
   &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
 &lt;/xs:complexType&gt;

 &lt;xs:complexType name='Rows'&gt;
  &lt;xs:complexContent&gt;
   &lt;xs:extension base='Element'&gt;
    &lt;xs:sequence minOccurs='1' maxOccurs='unbounded'&gt;
     &lt;xs:element name='Row' type='Row' /&gt;
    &lt;/xs:sequence&gt;    
         &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
 &lt;/xs:complexType&gt; 

   &lt;xs:complexType name='Row'&gt;
  &lt;xs:complexContent&gt;
   &lt;xs:extension base='SingleChildElement'&gt;    
   &lt;/xs:extension&gt;    
  &lt;/xs:complexContent&gt;
 &lt;/xs:complexType&gt;

 &lt;xs:complexType name='Conditional'&gt;
  &lt;xs:complexContent&gt;
   &lt;xs:extension base='Element'&gt;    
   &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
 &lt;/xs:complexType&gt;

 &lt;xs:complexType name='Layout'&gt;
  &lt;xs:complexContent&gt;
   &lt;xs:extension base='SingleChildElement'&gt;
   &lt;/xs:extension&gt;
  &lt;/xs:complexContent&gt;
 &lt;/xs:complexType&gt;

 &lt;xs:element name='Layout' type='Layout' /&gt;
&lt;/xs:schema&gt;&quot;;

XmlDocument doc = new XmlDocument();
doc.LoadXml(@&quot;&lt;Layout xmlns='foo'&gt;
  &lt;Rows&gt;
    &lt;Row&gt;
      &lt;Conditional/&gt;
    &lt;/Row&gt;     
  &lt;/Rows&gt;
&lt;/Layout&gt;&quot;);

XmlSchema schema = XmlSchema.Read(XmlReader.Create(new StringReader(xsd)),
null);

doc.Schemas.Add(schema);
doc.Validate(null); // Mono fails here &quot;XmlSchema error: Invalid start element:
foo:Conditional&quot;

------------

Solution:
Do exactly the same things as today but in a slightly different order. The
patch reorders the operations so that this bug is eliminated. I made the
above code into a unit test. My patch produces no regressions, so it should
be safe to use/commit.

Reproducible: Always

Steps to Reproduce:
Run above code
Actual Results:  
Validation fails

Expected Results:  
Successful validation

The attached patch fixes this bug without regressions. Please feel free to use
the posted code as an unit test. That's what I have locally, but I don't know
how to generate diff for it since it contains new unrelated tests... :-(

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="088702.html">[Mono-bugs] [Bug 502216] Starting second instance of monovs-{, gui-}server segfaults
</A></li>
	<LI>Next message: <A HREF="088705.html">[Mono-bugs] [Bug 312409] ThreadPool.RegisterWaitForSingleObject	does not work
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#88704">[ date ]</a>
              <a href="thread.html#88704">[ thread ]</a>
              <a href="subject.html#88704">[ subject ]</a>
              <a href="author.html#88704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
