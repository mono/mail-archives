<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 28862][Wis] New - Runtime crashes Accessing a Structure that was Marshalled from a native Structure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40rocky.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="001419.html">
   <LINK REL="Next"  HREF="001421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 28862][Wis] New - Runtime crashes Accessing a Structure that was Marshalled from a native Structure
   </H1>
    <B>bugzilla-daemon@rocky.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40rocky.ximian.com"
       TITLE="[Mono-bugs] [Bug 28862][Wis] New - Runtime crashes Accessing a Structure that was Marshalled from a native Structure">bugzilla-daemon@rocky.ximian.com
       </A><BR>
    <I>12 Aug 2002 18:50:24 -0000</I>
    <P><UL>
        <LI> Previous message: <A HREF="001419.html">[Mono-bugs] [Bug 28624][Nor] Changed - Fuzzy problem running xsp when GC is enabled
</A></li>
        <LI> Next message: <A HREF="001421.html">[Mono-bugs] [Bug 28864][Wis] New - Getting Mono.Data.OleDb and libgda to work under Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1420">[ date ]</a>
              <a href="thread.html#1420">[ thread ]</a>
              <a href="subject.html#1420">[ subject ]</a>
              <a href="author.html#1420">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:danmorg@sc.rr.com.">danmorg@sc.rr.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=28862">http://bugzilla.ximian.com/show_bug.cgi?id=28862</A>

--- shadow/28862	Mon Aug 12 14:50:24 2002
+++ shadow/28862.tmp.27964	Mon Aug 12 14:50:24 2002
@@ -0,0 +1,125 @@
+Bug#: 28862
+Product: Mono/Runtime
+Version: unspecified
+OS: 
+OS Details: 
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Wishlist
+Component: misc
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:danmorg@sc.rr.com">danmorg@sc.rr.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: Runtime crashes Accessing a Structure that was Marshalled from a native Structure
+
+The runtime appears to crash when trying to access a C# struct that was 
+marshalled using PtrToStructure from a native C struct.
+
+The code I test comes from mcs/class/Mono.Data.MySql/Mono.Data.MySql
+
+Test.cs contains the test code which gets the native C struct, uses 
+Marshal.PtrToStructure() to marshal it to the C# struct 
+named Field, and accesses
+the data that is contained within that C# struct.
+
+Field.cs has the definition for the C# struct Field that is marshalled to.
+
+Mono.Data.MySql only runs under Cygwin at the moment and has been tested 
+and works with MySql 3.23 for Windows using the MySql client library 
+libmySQL.dll  Note, the original code that this was derived from works 
+under the Microsoft .NET Framework.
+
+Assembly Mono.Data.MySql.dll gets built like other assemblies:
+- in mcs: cd to class/Mono.Data.MySql
+- enter: ../../nant/NAnt.exe
+
+Make sure Mono.Data.MySql.dll and System.Data.dll are 
+at mcs/class/Mono.Data.MySql/Mono.Data.MySql
+
+To compile:
+monomcs Test.cs -r System.Data.dll Mono.Data.MySql.dll
+
+To run:
+monomono Test.exe
+
+Also, a table with the following needs to be created in the test database:
+CREATE TABLE SOMETABLE (
+  TID VARCHAR(8),
+  TCHAR VARCHAR(16),
+  AINT4 INT);
+
+=--- excerpt from Test.cs ---=
+
+public static int Main() {
+        string myStmt = &quot;SELECT * FROM sometable&quot;;
+	IntPtr db = MySql.Init(IntPtr.Zero);
+	IntPtr conn = MySql.Connect(db, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, MySql.Port, &quot;&quot;, 
+(uint)0);
+	int sdb = MySql.SelectDb(db, myDb);
+	int rcq = MySql.Query(db, myStmt);
+	procResults(db);
+}
+
+static void procResults(IntPtr db) {
+	IntPtr res = MySql.StoreResult(db);
+	int numRows = MySql.NumRows(res);
+	Console.WriteLine(&quot;Number of records found: &quot; + numRows);
+	int numFields = MySql.NumFields(res);
+	string[] fields = new string[numFields];
+	for (int i = 0; i &lt; numFields; i++) {
+		Field fd = (Field) Marshal.PtrToStructure(MySql.FetchField
+(res), typeof(Field));
+		fields[i] = fd.Name;
+	}
+	IntPtr row;
+	int recCnt = 1;
+	while ((row = MySql.FetchRow(res)) != IntPtr.Zero) {
+		Console.WriteLine(&quot;Record #&quot; + recCnt + &quot;:&quot;);
+		for (int i = 0, j = 1; i &lt; numFields; i++, j++) {
+			Console.WriteLine(&quot;  Fld #&quot;+j+&quot; (&quot;+fields[i]
++&quot;): &quot;+rowVal(row, i));
+			}
+		MySql.FreeResult(res);
+	}
+
+	static string rowVal(IntPtr res, int index) {
+		IntPtr str = Marshal.ReadIntPtr(res, index*IntPtr.Size);
+		if (str == IntPtr.Zero)
+			return &quot;NULL&quot;;
+		string s = Marshal.PtrToStringAnsi(str);
+		return s;
+	}
+
+=--- excerpt from Field.cs ---=
+namespace Mono.Data.MySql {
+	using System.Runtime.InteropServices;
+	[StructLayout(LayoutKind.Sequential)]
+	public class Field {
+		[MarshalAs(UnmanagedType.LPStr)]
+		public string Name;
+
+		[MarshalAs(UnmanagedType.LPStr)]
+		public string Table;
+
+		[MarshalAs(UnmanagedType.LPStr)]
+		public string Def;
+
+		public int FieldTypes;
+		public uint Length;
+		public uint MaxLength;
+		public uint Flags;
+		public uint Decimals;	
+	}
+}
+
+MySql.cs contains the methods to pinvoke into the MySql client library.
+Excerpt:
+[DllImport(&quot;libmySQL&quot;,			 
+CharSet=System.Runtime.InteropServices.CharSet.Ansi,
+			 EntryPoint=&quot;mysql_thread_end&quot;, 
+ExactSpelling=true)]
+public static extern void ThreadEnd();


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="001419.html">[Mono-bugs] [Bug 28624][Nor] Changed - Fuzzy problem running xsp when GC is enabled
</A></li>
	<LI> Next message: <A HREF="001421.html">[Mono-bugs] [Bug 28864][Wis] New - Getting Mono.Data.OleDb and libgda to work under Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1420">[ date ]</a>
              <a href="thread.html#1420">[ thread ]</a>
              <a href="subject.html#1420">[ subject ]</a>
              <a href="author.html#1420">[ author ]</a>
         </LI>
       </UL>
</body></html>
