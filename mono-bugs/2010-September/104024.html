<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 640709] New: Mono 2.8 Preview 6: gmcs regression -- compiler crash when emitting iterators
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20640709%5D%20New%3A%20Mono%202.8%20Preview%206%3A%20gmcs%20regression%0A%20--%20compiler%20crash%20when%20emitting%20iterators&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="104023.html">
   <LINK REL="Next"  HREF="104030.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 640709] New: Mono 2.8 Preview 6: gmcs regression -- compiler crash when emitting iterators</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20640709%5D%20New%3A%20Mono%202.8%20Preview%206%3A%20gmcs%20regression%0A%20--%20compiler%20crash%20when%20emitting%20iterators&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 640709] New: Mono 2.8 Preview 6: gmcs regression -- compiler crash when emitting iterators">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Sep 21 03:06:24 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="104023.html">[Mono-bugs] [Bug 640702] New: MethodBase.GetCurrentMethod doesn't work inside a DynamicMethod
</A></li>
        <LI>Next message: <A HREF="104030.html">[Mono-bugs] [Bug 640709] Mono 2.8 Preview 6: gmcs regression -- compiler crash when emitting iterators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#104024">[ date ]</a>
              <a href="thread.html#104024">[ thread ]</a>
              <a href="subject.html#104024">[ subject ]</a>
              <a href="author.html#104024">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=640709">https://bugzilla.novell.com/show_bug.cgi?id=640709</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=640709#c0">https://bugzilla.novell.com/show_bug.cgi?id=640709#c0</A>


           Summary: Mono 2.8 Preview 6: gmcs regression -- compiler crash
                    when emitting iterators
    Classification: Mono
           Product: Mono: Compilers
           Version: 2.8.x
          Platform: Macintosh
        OS/Version: Mac OS X 10.6
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brian at sooloos.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


User-Agent:       Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US)
AppleWebKit/534.3 (KHTML, like Gecko) Chrome/6.0.472.25 Safari/534.3

This code compiles successfully using 2.6.7. It also compiles successfully (and
emits warning CS1911) when compiled using microsoft's toolchain.

The 2.8 compiler crashes, however. I was testing using the x86 binary installer
for osx from <A HREF="http://mono.ximian.com/monobuild/preview/download-preview/">http://mono.ximian.com/monobuild/preview/download-preview/</A> 
At the time of the download top of the webpage at that URL indicated the
following version: Mono 2.8 Downloads (Preview 6 [58f029f])

Code to reproduce:

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brian at brianmbp</A> ~ $ cat x.cs         

using System.Collections.Generic;

namespace Test {
    public abstract class Base {
        public virtual IEnumerable&lt;Base&gt; GetStuff(int a) {
            yield return this;
        }
    }

    public abstract class Derived : Base {
        public override IEnumerable&lt;Base&gt; GetStuff(int a) {
            foreach (var x in base.GetStuff(a))
                yield return x;
        }
    }

    public class SpecialDerived : Derived {
        public override IEnumerable&lt;Base&gt; GetStuff(int a) {
            foreach (var x in base.GetStuff(a))
                yield return x;
        }

        public static void Main(string[] args) { }
    }
}

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brian at brianmbp</A> ~ $ gmcs --version
Mono C# compiler version 2.8.0.0

<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">brian at brianmbp</A> ~ $ gmcs x.cs
Internal compiler error at Internal(1,1):: exception caught while emitting
MethodBuilder [SpecialDerived::&lt;GetStuff&gt;__BaseCallProxy0]

Unhandled Exception: System.ArgumentException: Trying to emit a local from a
different ILGenerator.
  at System.Reflection.Emit.ILGenerator.Emit (OpCode opcode,
System.Reflection.Emit.LocalBuilder local) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.EmitContext.Emit (OpCode opcode,
System.Reflection.Emit.LocalBuilder local) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.LocalTemporary.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.MemberExpr.EmitInstance (Mono.CSharp.EmitContext ec, Boolean
prepare_for_load) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.FieldExpr.Emit (Mono.CSharp.EmitContext ec, Boolean
leave_copy) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.HoistedVariable.Emit (Mono.CSharp.EmitContext ec, Boolean
leave_copy) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.VariableReference.Emit (Mono.CSharp.EmitContext ec, Boolean
leave_copy) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.VariableReference.Emit (Mono.CSharp.EmitContext ec) [0x00000]
in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Argument.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.Arguments.Emit (Mono.CSharp.EmitContext ec, Boolean dup_args,
Mono.CSharp.LocalTemporary this_arg) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Invocation.EmitCall (Mono.CSharp.EmitContext ec,
Mono.CSharp.Expression instance_expr, Mono.CSharp.MethodSpec method,
Mono.CSharp.Arguments Arguments, Location loc, Boolean dup_args, Boolean
omit_args) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Invocation.EmitCall (Mono.CSharp.EmitContext ec,
Mono.CSharp.Expression instance_expr, Mono.CSharp.MethodSpec method,
Mono.CSharp.Arguments Arguments, Location loc) [0x00000] in &lt;filename
unknown&gt;:0 
  at Mono.CSharp.MethodGroupExpr.EmitCall (Mono.CSharp.EmitContext ec,
Mono.CSharp.Arguments arguments) [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Invocation.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.Return.DoEmit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.Statement.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.Block.DoEmit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.Block.Emit (Mono.CSharp.EmitContext ec) [0x00000] in &lt;filename
unknown&gt;:0 
  at Mono.CSharp.ExplicitBlock.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.ToplevelBlock.Emit (Mono.CSharp.EmitContext ec) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.MethodData.Emit (Mono.CSharp.DeclSpace parent) [0x00000] in
&lt;filename unknown&gt;:0 
  at Mono.CSharp.MethodOrOperator.Emit () [0x00000] in &lt;filename unknown&gt;:0 
  at Mono.CSharp.Method.Emit () [0x00000] in &lt;filename unknown&gt;:0 


Reproducible: Always

Steps to Reproduce:
See above
Actual Results:  
Compiler crashes

Expected Results:  
Successful compilation

A few interesting things that I found while trying to make the test case as
minimal as possible:

1. If I move the base.GetStuff(a) calls out to separate methods, the crash goes
away.

2. Two levels of inheritance seem to be required to reproduce the bug.

3. The GetStuff() method must have arguments in order for the crash to
manifest.

Also, thanks for adding the &quot;Internal compiler error at Internal(1,1)::
exception caught while emitting MethodBuilder
[SpecialDerived::&lt;GetStuff&gt;__BaseCallProxy0]&quot; information. It saved me dozens
of minutes that I would have had to spend otherwise to narrow down where the
crash was being triggered if I were debugging a previous version of the
compiler.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>








































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="104023.html">[Mono-bugs] [Bug 640702] New: MethodBase.GetCurrentMethod doesn't work inside a DynamicMethod
</A></li>
	<LI>Next message: <A HREF="104030.html">[Mono-bugs] [Bug 640709] Mono 2.8 Preview 6: gmcs regression -- compiler crash when emitting iterators
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#104024">[ date ]</a>
              <a href="thread.html#104024">[ thread ]</a>
              <a href="subject.html#104024">[ subject ]</a>
              <a href="author.html#104024">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
