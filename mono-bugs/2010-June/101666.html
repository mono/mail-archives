<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 617161] New: NRE in dynamic method with nullable	types
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20617161%5D%20New%3A%20NRE%20in%20dynamic%20method%20with%20nullable%0A%09types&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="101665.html">
   <LINK REL="Next"  HREF="101673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 617161] New: NRE in dynamic method with nullable	types</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20617161%5D%20New%3A%20NRE%20in%20dynamic%20method%20with%20nullable%0A%09types&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 617161] New: NRE in dynamic method with nullable	types">bugzilla_noreply at novell.com
       </A><BR>
    <I>Thu Jun 24 12:38:47 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="101665.html">[Mono-bugs] [Bug 607545] Context Menu Strip throws InvalidOperationException on svn Trunk
</A></li>
        <LI>Next message: <A HREF="101673.html">[Mono-bugs] [Bug 617161] NRE in dynamic method with nullable types
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#101666">[ date ]</a>
              <a href="thread.html#101666">[ thread ]</a>
              <a href="subject.html#101666">[ subject ]</a>
              <a href="author.html#101666">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://bugzilla.novell.com/show_bug.cgi?id=617161">http://bugzilla.novell.com/show_bug.cgi?id=617161</A>

<A HREF="http://bugzilla.novell.com/show_bug.cgi?id=617161#c0">http://bugzilla.novell.com/show_bug.cgi?id=617161#c0</A>


           Summary: NRE in dynamic method with nullable types
    Classification: Mono
           Product: Mono: Runtime
           Version: SVN
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: JIT
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lupus at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jbevain at novell.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---
           Blocker: ---


The following test case have to be compiled with dmcs, as the bug is triggered
by what the DLR emits. 

The SRE code in the test case is only to show what the DLR emits. Apparently
it's the same IL that is emitted in the assembly, and in the dynamic method.

When calling the code from the emitted assembly it works just fine, but the
compiled dynamic method throws an NRE.

Test case:

--
using System;
using System.Linq;
using System.Linq.Expressions;
using System.Reflection;
using System.Reflection.Emit;

public class Test {

    public static void Main ()
    {
        var assembly = AppDomain.CurrentDomain.DefineDynamicAssembly (new
AssemblyName (&quot;repro&quot;), AssemblyBuilderAccess.RunAndSave);
        var module = assembly.DefineDynamicModule (&quot;repro.dll&quot;);
        var type = module.DefineType (&quot;Test&quot;, TypeAttributes.Public);
        var method = type.DefineMethod (&quot;Method&quot;, MethodAttributes.Public |
MethodAttributes.Static, typeof (Func&lt;long?&gt;), new Type[] {typeof (long?)});

        var p = Expression.Parameter(typeof(long?), &quot;p&quot;);

        Expression&lt;Func&lt;Func&lt;long?, long?&gt;&gt;&gt; e4 =
Expression.Lambda&lt;Func&lt;Func&lt;long?, long?&gt;&gt;&gt;(
            Expression.Lambda&lt;Func&lt;long?, long?&gt;&gt;(
                Expression.Not(p),
                    new ParameterExpression[] { p }),
            Enumerable.Empty&lt;ParameterExpression&gt;());

        e4.CompileToMethod (method);
        type.CreateType ();
        assembly.Save (&quot;repro.dll&quot;);

        Func&lt;Func&lt;long?, long?&gt;&gt; f4 = e4.Compile ();

        Console.WriteLine (object.Equals (f4 () (0), (long?) ~0));
    }
}
--

-- 
Configure bugmail: <A HREF="http://bugzilla.novell.com/userprefs.cgi?tab=email">http://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="101665.html">[Mono-bugs] [Bug 607545] Context Menu Strip throws InvalidOperationException on svn Trunk
</A></li>
	<LI>Next message: <A HREF="101673.html">[Mono-bugs] [Bug 617161] NRE in dynamic method with nullable types
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#101666">[ date ]</a>
              <a href="thread.html#101666">[ thread ]</a>
              <a href="subject.html#101666">[ subject ]</a>
              <a href="author.html#101666">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
