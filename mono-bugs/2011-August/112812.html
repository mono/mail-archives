<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 707114] crash when collecting all persons from	ABAddressBook
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20707114%5D%20crash%20when%20collecting%20all%20persons%20from%0A%09ABAddressBook&In-Reply-To=bug-707114-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="112811.html">
   <LINK REL="Next"  HREF="112813.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 707114] crash when collecting all persons from	ABAddressBook</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20707114%5D%20crash%20when%20collecting%20all%20persons%20from%0A%09ABAddressBook&In-Reply-To=bug-707114-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 707114] crash when collecting all persons from	ABAddressBook">bugzilla_noreply at novell.com
       </A><BR>
    <I>Tue Aug  2 17:04:04 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="112811.html">[Mono-bugs] [Bug 709890] New: Can't advertise service
</A></li>
        <LI>Next message: <A HREF="112813.html">[Mono-bugs] [Bug 656843] Printing on an iPad using MonoTouch 3.2.x not working as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112812">[ date ]</a>
              <a href="thread.html#112812">[ thread ]</a>
              <a href="subject.html#112812">[ subject ]</a>
              <a href="author.html#112812">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=707114">https://bugzilla.novell.com/show_bug.cgi?id=707114</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=707114#c11">https://bugzilla.novell.com/show_bug.cgi?id=707114#c11</A>


--- Comment #11 from Jonathan Pryor &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jonpryor at vt.edu</A>&gt; 2011-08-02 21:04:03 UTC ---
Based on the code and description, it does appear to be a &quot;premature&quot;
collection, as ABPerson doesn't contain a reference to ABAddressBook, so the GC
won't know that the ABPerson reference depends upon the ABAddressBook instance.

A good way to test to see if this is the case would be to change AddressBook.cs
CollectContacts() to do:

    var addressBook = new ABAddressBook();
    var person = addressBook.GetPeople()[0];  // better have at least one
person...
    addressBook.Dispose();
    _allContacts.Add (new Contact { FirstName = person.FirstName });

As for how to fix this, I'm not sure. We could add an ABRecord.AddressBook
property to keep the ABAddressBook alive, but we'd need to take care to set
this property within ABAddressBook.GetPeople() and any other method that
creates a new ABRecord subclass. This would also be adding a member that
doesn't exist in the underlying API; I'm not sure if this would be desirable.

On a related note, the ABAddressBookCreate() docs explicitly state:

<A HREF="http://developer.apple.com/library/ios/#documentation/AddressBook/Reference/ABAddressBookRef_iPhoneOS/Reference/reference.html#//apple_ref/doc/uid/TP40007099">http://developer.apple.com/library/ios/#documentation/AddressBook/Reference/ABAddressBookRef_iPhoneOS/Reference/reference.html#//apple_ref/doc/uid/TP40007099</A>

    &quot;Important: You must ensure that an instance of ABAddressBookRef is used by
only one thread.&quot;

If the GC is run on a different thread, this could be bad. :-)

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="112811.html">[Mono-bugs] [Bug 709890] New: Can't advertise service
</A></li>
	<LI>Next message: <A HREF="112813.html">[Mono-bugs] [Bug 656843] Printing on an iPad using MonoTouch 3.2.x not working as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112812">[ date ]</a>
              <a href="thread.html#112812">[ thread ]</a>
              <a href="subject.html#112812">[ subject ]</a>
              <a href="author.html#112812">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
