<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20421491%5D%20%22Could%20not%20allocate%20new%20OCI%20Handle%20of%20type%0A%20Statement%22%20message%20when%20accessing%20Oracle&In-Reply-To=bug-421491-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="112900.html">
   <LINK REL="Next"  HREF="112902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20421491%5D%20%22Could%20not%20allocate%20new%20OCI%20Handle%20of%20type%0A%20Statement%22%20message%20when%20accessing%20Oracle&In-Reply-To=bug-421491-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Aug 10 11:37:35 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="112900.html">[Mono-bugs] [Bug 651317] Missing data rows
</A></li>
        <LI>Next message: <A HREF="112902.html">[Mono-bugs] [Bug 682529] Web Reference call crashes - perhaps due to Thumb library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112901">[ date ]</a>
              <a href="thread.html#112901">[ thread ]</a>
              <a href="subject.html#112901">[ subject ]</a>
              <a href="author.html#112901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=421491">https://bugzilla.novell.com/show_bug.cgi?id=421491</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=421491#c11">https://bugzilla.novell.com/show_bug.cgi?id=421491#c11</A>


--- Comment #11 from Dan McFadyen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">danm at cryptocard.com</A>&gt; 2011-08-10 15:37:32 UTC ---
I figured out the issue.

When using connection pooling, any OracleConnection object that gets leaked
without being closed will cause a problem.

The problem being is that because there are no references to the
OracleConnection object any more, the GC will do it's job and dispose the
object. The OracleConnection.Dispose function calls close. Any connection that
gets close called on it while it's part of connection pooling will re-add
itself to the connection pool.

Because there are still references to the pool from other static members, it's
still a valid object. So the dispose function happily re-adds a disposed
connection object back into the pool, then cleans itself up.

The connection is then sitting in the pool as a ticking time bomb for the next
time it's used.

I have no idea what the effects of having references to a GC disposed object
around are, but they can't be good. Even worse, I figured out that the parenth
IntPtr that was null from my last comment, is actually a 'this' reference that
is null.

The only fix I can see is in the OracleConnection.cs file, in the Dispose
function, just before you call Close, set pooling to false, and pool = null.


[MonoTODO]
protected override void Dispose (bool disposing)
{
    if (!disposed) {
-&gt;        pooling = false;
-&gt;        pool = null;
        if (State == ConnectionState.Open)
            Close ();
        dataReader = null;
        transaction = null;
        oci = null;
        pool = null;
        conInfo.Username = string.Empty;
        conInfo.Database = string.Empty;
        conInfo.Password = string.Empty;
        connectionString = null;
        parsedConnectionString = null;
        base.Dispose (disposing);
        disposed = true;
    }
}


Obvious downside here is that any connection you leak won't go back to the pool
and you lose the speed benefit of it. But the only way you could keep the
dispose from being called would be to keep references to it somewhere, which
then you'd have no way of knowing if the connections are leaked.

A bit of performance seems a fair price to pay if connections are being leaked
as it's a bad thing to do. But avoiding a crash is probably much nicer.

I hope that even if you can't reproduce the bug, the description of the
behavior should be enough to get this fixed.

Thanks,

Dan

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="112900.html">[Mono-bugs] [Bug 651317] Missing data rows
</A></li>
	<LI>Next message: <A HREF="112902.html">[Mono-bugs] [Bug 682529] Web Reference call crashes - perhaps due to Thumb library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112901">[ date ]</a>
              <a href="thread.html#112901">[ thread ]</a>
              <a href="subject.html#112901">[ subject ]</a>
              <a href="author.html#112901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
