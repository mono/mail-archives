<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20421491%5D%20%22Could%20not%20allocate%20new%20OCI%20Handle%20of%20type%0A%20Statement%22%20message%20when%20accessing%20Oracle&In-Reply-To=bug-421491-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="112969.html">
   <LINK REL="Next"  HREF="112971.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20421491%5D%20%22Could%20not%20allocate%20new%20OCI%20Handle%20of%20type%0A%20Statement%22%20message%20when%20accessing%20Oracle&In-Reply-To=bug-421491-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 421491] &quot;Could not allocate new OCI Handle of type Statement&quot; message when accessing Oracle">bugzilla_noreply at novell.com
       </A><BR>
    <I>Mon Aug 15 11:20:13 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="112969.html">[Mono-bugs] [Bug 694862] Synchronous Web-Service (.Net 2.0) call becomes stuck if more than 1 MB is to transmitted
</A></li>
        <LI>Next message: <A HREF="112971.html">[Mono-bugs] [Bug 687865] Async methods of HttpWebRequest fail when compiled for the Device
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112970">[ date ]</a>
              <a href="thread.html#112970">[ thread ]</a>
              <a href="subject.html#112970">[ subject ]</a>
              <a href="author.html#112970">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=421491">https://bugzilla.novell.com/show_bug.cgi?id=421491</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=421491#c21">https://bugzilla.novell.com/show_bug.cgi?id=421491#c21</A>


--- Comment #21 from Dan McFadyen &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">danm at cryptocard.com</A>&gt; 2011-08-15 15:20:09 UTC ---
Created an attachment (id=445821)
 --&gt; (<A HREF="http://bugzilla.novell.com/attachment.cgi?id=445821">http://bugzilla.novell.com/attachment.cgi?id=445821</A>)
OracleConnection.cs and OracleConnectionPool.cs


I've read over the files and read some comments from Chris Brown, and there
were a couple things pointed out.

Pointed out by Chris Brown:
 - OracleConnectionPool.cs
   - I think the 'lock (list)' that you have added around the adding and
removing to the list in GetConnection is redundant. The very first level of
braces in that function a lock on the same object.
   - At line 86:  if (connection == null &amp;&amp; list.Count &lt; PoolMaxSize)
     - From the previous code, the intent of this statement is to prevent
creating more connections than the maximum pool size. The problem is that the
list here doesn't maintain references to all the OciGlue objects, just the
unused ones. If every OciGlue class is currently in used, then list.Count will
always be zero. This means that there is no maximum pool size any more. The int
activeConnections you removed was a count of all connections, including the
ones not currently in the pool.
   - I can't see any references to the bool disposed.

Now, there is a lot of good stuff. The OciGlue looks like it will be cleaned up
correctly and properly disposed of now. Aside from the connection pool issue
above, the original issue seems solved. But there is something I noticed with
even my bad attempt at a fix.

The code wasn't broken for trying to add the OciGlue back into the connection
pool. It was broken for trying to add a OciGlue object that had been disposed
back into the pool. This only happens because when the GC goes after the
connection, the OciGlue is only referenced by the connection, and because of
that it goes down with it. If we keep a reference to the OciGlue outside of the
connection, and in the pool, then when the connection gets GC'd it will instead
add a valid OciGlue reference back into the pool. This would keep the intent of
the code (and pooling) intact, so leaked connections are still correctly
pooled.

If a second list was added to the connection pool, one that maintained a list
of all OciGlue objects it ever made, it could be used to fix the issue at line
86, as it would be a valid test against the maximum pool size, and it would
also keep the OciGlue objects alive while the connection objects are destroyed.
This in turn means that the original logic in the OracleConnection class can be
left alone as even if the GC is doing the disposing, what it's doing will be
correct.

The attachment contains copies of your files modified to this end as an
example.

Also, I noticed you fixed up the bug you'd get if you called Close more than
once. Thanks.

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="112969.html">[Mono-bugs] [Bug 694862] Synchronous Web-Service (.Net 2.0) call becomes stuck if more than 1 MB is to transmitted
</A></li>
	<LI>Next message: <A HREF="112971.html">[Mono-bugs] [Bug 687865] Async methods of HttpWebRequest fail when compiled for the Device
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#112970">[ date ]</a>
              <a href="thread.html#112970">[ thread ]</a>
              <a href="subject.html#112970">[ subject ]</a>
              <a href="author.html#112970">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
