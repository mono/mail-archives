<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 77530][Nor] Changed - [PATCH] serialization of
	integral enum value is not correct
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2077530%5D%5BNor%5D%20Changed%20-%20%5BPATCH%5D%20serialization%20of%0A%09integral%20enum%20value%20is%20not%20correct&In-Reply-To=bug-77530%40chernobyl.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="039318.html">
   <LINK REL="Next"  HREF="039320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 77530][Nor] Changed - [PATCH] serialization of
	integral enum value is not correct</H1>
    <B>bugzilla-daemon at bugzilla.ximian.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%2077530%5D%5BNor%5D%20Changed%20-%20%5BPATCH%5D%20serialization%20of%0A%09integral%20enum%20value%20is%20not%20correct&In-Reply-To=bug-77530%40chernobyl.ximian.com"
       TITLE="[Mono-bugs] [Bug 77530][Nor] Changed - [PATCH] serialization of
	integral enum value is not correct">bugzilla-daemon at bugzilla.ximian.com
       </A><BR>
    <I>Thu Feb 16 08:58:53 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="039318.html">[Mono-bugs] [Bug 77520][Nor] Changed - TcpChannel.Parse returns
	incorrect objectURI
</A></li>
        <LI>Next message: <A HREF="039320.html">[Mono-bugs] [Bug 71977][Min] Changed - XmlReader fails/throws
	System.NullReferenceException: Unexpected node type EndElement.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39319">[ date ]</a>
              <a href="thread.html#39319">[ thread ]</a>
              <a href="subject.html#39319">[ subject ]</a>
              <a href="author.html#39319">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lluis at ximian.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=77530">http://bugzilla.ximian.com/show_bug.cgi?id=77530</A>

--- shadow/77530	2006-02-11 08:20:35.000000000 -0500
+++ shadow/77530.tmp.5920	2006-02-16 08:58:53.000000000 -0500
@@ -1,14 +1,14 @@
 Bug#: 77530
 Product: Mono: Class Libraries
 Version: 1.1
-OS: 
+OS: unknown
 OS Details: 
 Status: NEW   
 Resolution: 
-Severity: 
+Severity: Unknown
 Priority: Normal
 Component: Sys.XML
 AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lluis at ximian.com</A>                            
 ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">gert.driesen at pandora.be</A>               
 QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at ximian.com</A>
 TargetMilestone: ---
@@ -60,6 +60,70 @@
 Let me know if its ok to commit this patch.
 
 ------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">gert.driesen at pandora.be</A>  2006-02-11 08:20 -------
 Created an attachment (id=16479)
 Fixes and unit tests
 
+
+------- Additional Comments From <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lluis at ximian.com</A>  2006-02-16 08:58 -------
+Gert, thanks for the patch. Here are some comments:
+
+In EnumMap.GetXmlName:
+* I think the call to XmlCustomFormatter.FromEnum should be done only
+when the enum is a flags enum. If it is not, shouldn't it just return
+the long value?
+* The cration of the names and values arrays should only be done once
+and they should be stored in the enum map.
+
+In SerializationCodeGenerator.GenerateGetXmlEnumValue:
+Same as before, the names and values arrays should not be created for
+each call to the generated conversion method.
+Also, looks like the old line &quot;if (val.ToString () == \&quot;0\&quot;) return
+string.Empty;&quot; is lost?
+
+In GenerateWriteObject:
+
+@@ -608,28 +620,27 @@
+ 			ArrayList types = typeMap.DerivedTypes;
+ 			
+ 			WriteLine (&quot;System.Type type = ob.GetType ();&quot;);
+-			WriteLine (&quot;if (type == typeof(&quot; + typeMap.TypeFullName + &quot;))&quot;);
+-			WriteLine (&quot;\t;&quot;);
+-				
++			WriteLine (&quot;if (type == typeof(&quot; + typeMap.TypeFullName + &quot;)) {&quot;);
++
+ 			for (int n=0; n&lt;types.Count; n++)
+ 			{
+ 				XmlTypeMapping map = (XmlTypeMapping)types[n];
+ 				
+-				WriteLineInd (&quot;else if (type == typeof(&quot; + map.TypeFullName + &quot;))
+{ &quot;);
++				WriteLineInd (&quot;} else if (type == typeof(&quot; + map.TypeFullName +
+&quot;)) { &quot;);
+ 				WriteLine (GetWriteObjectName (map) + &quot;((&quot; + map.TypeFullName +
+&quot;)ob, element, namesp, isNullable, true, writeWrappingElem);&quot;);
+ 				WriteLine (&quot;return;&quot;);
+ 				WriteLineUni (&quot;}&quot;);
+ 			}
+
+This is wrong. It's going to fail if types.Count &gt; 0.
+
+Replacing 
+-			WriteLine (&quot;\t;&quot;);
+by
++			WriteLine (&quot;{ }&quot;);
+looks like a better solution.
+
+
+Which error does this fix:
+@@ -2232,7 +2243,8 @@
+ 		{
+ 			WriteLine (&quot;Reader.ReadStartElement ();&quot;);
+ 			WriteLine (typeMap.TypeFullName + &quot; res = &quot; + GenerateGetEnumValue
+(typeMap, &quot;Reader.ReadString()&quot;) + &quot;;&quot;);
+-			WriteLine (&quot;Reader.ReadEndElement ();&quot;);
++			WriteLineInd (&quot;if (Reader.NodeType != XmlNodeType.None)&quot;);
++			WriteLineUni (&quot;Reader.ReadEndElement ();&quot;);
+ 			WriteLine (&quot;return res;&quot;);
+
+
+
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="039318.html">[Mono-bugs] [Bug 77520][Nor] Changed - TcpChannel.Parse returns
	incorrect objectURI
</A></li>
	<LI>Next message: <A HREF="039320.html">[Mono-bugs] [Bug 71977][Min] Changed - XmlReader fails/throws
	System.NullReferenceException: Unexpected node type EndElement.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39319">[ date ]</a>
              <a href="thread.html#39319">[ thread ]</a>
              <a href="subject.html#39319">[ subject ]</a>
              <a href="author.html#39319">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
