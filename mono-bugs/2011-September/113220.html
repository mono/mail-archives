<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 672879] ReleaseInterfaces is called by GC thread.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20672879%5D%20ReleaseInterfaces%20is%20called%20by%20GC%20thread.&In-Reply-To=bug-672879-28286%40http.bugzilla.novell.com/">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="113219.html">
   <LINK REL="Next"  HREF="113221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 672879] ReleaseInterfaces is called by GC thread.</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20672879%5D%20ReleaseInterfaces%20is%20called%20by%20GC%20thread.&In-Reply-To=bug-672879-28286%40http.bugzilla.novell.com/"
       TITLE="[Mono-bugs] [Bug 672879] ReleaseInterfaces is called by GC thread.">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Sep  2 11:25:30 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="113219.html">[Mono-bugs] [Bug 672879] ReleaseInterfaces is called by GC thread.
</A></li>
        <LI>Next message: <A HREF="113221.html">[Mono-bugs] [Bug 317009] Problem with UTF-8 strings and Cocoa#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#113220">[ date ]</a>
              <a href="thread.html#113220">[ thread ]</a>
              <a href="subject.html#113220">[ subject ]</a>
              <a href="author.html#113220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=672879">https://bugzilla.novell.com/show_bug.cgi?id=672879</A>

<A HREF="https://bugzilla.novell.com/show_bug.cgi?id=672879#c3">https://bugzilla.novell.com/show_bug.cgi?id=672879#c3</A>


--- Comment #3 from Jonathan Chambers &lt;<A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">joncham at gmail.com</A>&gt; 2011-09-02 15:25:29 UTC ---
Miguel and Tom,

This was an issue I ignored when initially implementing COM interop for mono.
Theoretically, we should be marshaling (in the COM sense) interfaces between
threads to properly support COM apartments. We don't at this point, but as long
as the user code is not accessing the COM object from multiple threads it
should not be an issue. The only place we force the access of a COM object from
a different thread is in the case of finalization of the wrapper object.

The problem with COM marshalling between threads is that you can easily cause
deadlock. Cross apartment (thread) COM calls are handled via Windows messages.
If you perform a wait on a thread (Sleep, WaitForSingleObject, etc) that does
not pump messages, or have a processing loop that does not pump messages you
will run into hangs or deadlock.

Problem in short:
1. We are not currently marshaling COM interfaces
2. Marshaling could be done, but could introduce deadlocks without message
pumping
3. The run time would need to use message pumping waits where possible 
4. What to do on non-Windows platforms? There is no Win32 message pump
5. Even if we do all this, you can still get deadlocks. See long post on msdn
from cbrumme. tl;dr it's a mess and took hacks in the CLR (from 2004):
<A HREF="http://blogs.msdn.com/b/cbrumme/archive/2004/02/02/66219.aspx">http://blogs.msdn.com/b/cbrumme/archive/2004/02/02/66219.aspx</A>

Proposed Solution:

I think we should just solve the finalizer issue, rather than the general
marshaling issue. Of course we cannot add a new API to class libs, but how
about either a environment variable

MONO_COM_FINALIZER_FUNC=&lt;TypeName.FuncName&gt;

Assuming the function specified is signature taking a single IntPtr and no
return value.

Or, we could export a function in the runtime that could be called via an icall
when running on mono.

[DllImport(&quot;__Internal&quot;)]
void mono_set_com_finalizer(Action&lt;IntPtr&gt; func);

Thoughts?

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="113219.html">[Mono-bugs] [Bug 672879] ReleaseInterfaces is called by GC thread.
</A></li>
	<LI>Next message: <A HREF="113221.html">[Mono-bugs] [Bug 317009] Problem with UTF-8 strings and Cocoa#
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#113220">[ date ]</a>
              <a href="thread.html#113220">[ thread ]</a>
              <a href="subject.html#113220">[ subject ]</a>
              <a href="author.html#113220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
