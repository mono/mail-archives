<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 444778] New: Dictionary&lt;K, V&gt; cast as ICollection puts wrong values into array in CopyTo
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20444778%5D%20New%3A%20Dictionary%3CK%2C%0A%20V%3E%20cast%20as%20ICollection%20puts%20wrong%20values%20into%20array%20in%20CopyTo&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="082293.html">
   <LINK REL="Next"  HREF="082292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 444778] New: Dictionary&lt;K, V&gt; cast as ICollection puts wrong values into array in CopyTo</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20444778%5D%20New%3A%20Dictionary%3CK%2C%0A%20V%3E%20cast%20as%20ICollection%20puts%20wrong%20values%20into%20array%20in%20CopyTo&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 444778] New: Dictionary&lt;K, V&gt; cast as ICollection puts wrong values into array in CopyTo">bugzilla_noreply at novell.com
       </A><BR>
    <I>Thu Nov 13 14:31:40 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="082293.html">[Mono-bugs] [Bug 444768] Dictionary&lt;K, V&gt; cast as ICollection&lt;K, V&gt; doesn' t have correct behavior for Contains and Remove
</A></li>
        <LI>Next message: <A HREF="082292.html">[Mono-bugs] [Bug 444778] Dictionary&lt;K, V&gt; cast as ICollection puts wrong values into array in CopyTo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82261">[ date ]</a>
              <a href="thread.html#82261">[ thread ]</a>
              <a href="subject.html#82261">[ subject ]</a>
              <a href="author.html#82261">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=444778">https://bugzilla.novell.com/show_bug.cgi?id=444778</A>


           Summary: Dictionary&lt;K, V&gt; cast as ICollection puts wrong values
                    into array in CopyTo
           Product: Mono: Class Libraries
           Version: 1.9
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Sys.Core
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jbevain at novell.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">jonbnews at hotmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


If you cast a Dictionary&lt;K, V&gt; to a non-generic ICollection, and then call
CopyTo on that ICollection, it puts DictionaryEntry types into the array during
the copy.  I believe is should put KeyValuePair&lt;K, V&gt; types into the array.

Here's an example:

         Dictionary&lt;string, int&gt; dict = new Dictionary&lt;string, int&gt;();
         dict.Add(&quot;foo&quot;, 1);
         ICollection col = (ICollection) dict;
         foreach (object obj in col)
         {
            if (obj is KeyValuePair&lt;string, int&gt;)
            {
               Console.Out.WriteLine(&quot;KeyValuePair&quot;);
            }
         }

         object[] arr = new object[1];
         col.CopyTo(arr, 0);
         if (arr[0] is KeyValuePair&lt;string, int&gt;)
         {
            Console.Out.WriteLine(&quot;KeyValuePair&quot;);
         }

I would expect this to output &quot;KeyValuePair&quot; twice, but it only outputs it
once.  This seems cleary wrong.  If you iterate over the collection, you get
KeyValuePairs, but if you copy the collection to an array, you get something
else.

In the Dictionary.cs file, it's clear in the ICollection.CopyTo that it adds a
new DictionaryEntry to the array.  I think this should be a KeyValuePair. 
There's probably an opportunity for some simplification too, since then the
ICollection.CopyTo implementation becomes the same as
ICollection&lt;KeyValuePair&lt;K, V&gt;&gt;.CopyTo.  I suspect the
ICollection&lt;KeyValuePair&lt;K, V&gt;&gt;.CopyTo method could just be implemented by
calling:

((ICollection)this).CopyTo(...)


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
</PRE>




































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="082293.html">[Mono-bugs] [Bug 444768] Dictionary&lt;K, V&gt; cast as ICollection&lt;K, V&gt; doesn' t have correct behavior for Contains and Remove
</A></li>
	<LI>Next message: <A HREF="082292.html">[Mono-bugs] [Bug 444778] Dictionary&lt;K, V&gt; cast as ICollection puts wrong values into array in CopyTo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82261">[ date ]</a>
              <a href="thread.html#82261">[ thread ]</a>
              <a href="subject.html#82261">[ subject ]</a>
              <a href="author.html#82261">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
