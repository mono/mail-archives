<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 450050] New: Mono crashes to freeing invalid pointer when using custom ICustomMarshaler marshaling return value
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20450050%5D%20New%3A%20Mono%20crashes%20to%20freeing%20invalid%0A%20pointer%20when%20using%20custom%20ICustomMarshaler%20marshaling%20return%20value&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="082776.html">
   <LINK REL="Next"  HREF="082781.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 450050] New: Mono crashes to freeing invalid pointer when using custom ICustomMarshaler marshaling return value</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20450050%5D%20New%3A%20Mono%20crashes%20to%20freeing%20invalid%0A%20pointer%20when%20using%20custom%20ICustomMarshaler%20marshaling%20return%20value&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 450050] New: Mono crashes to freeing invalid pointer when using custom ICustomMarshaler marshaling return value">bugzilla_noreply at novell.com
       </A><BR>
    <I>Fri Nov 28 07:20:46 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="082776.html">[Mono-bugs] [Bug 450002] New: Very slow performance in Winforms	ListView
</A></li>
        <LI>Next message: <A HREF="082781.html">[Mono-bugs] [Bug 450050] Mono crashes to freeing invalid pointer when using custom ICustomMarshaler marshaling return value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82780">[ date ]</a>
              <a href="thread.html#82780">[ thread ]</a>
              <a href="subject.html#82780">[ subject ]</a>
              <a href="author.html#82780">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=450050">https://bugzilla.novell.com/show_bug.cgi?id=450050</A>


           Summary: Mono crashes to freeing invalid pointer when using
                    custom ICustomMarshaler marshaling return value
           Product: Mono: Runtime
           Version: 2.0.x
          Platform: x86
        OS/Version: Linux
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: interop
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">juhovh at iki.fi</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Community User


I have tested this on Linux (Ubuntu 10.4) x86 (mono runtime 1.2.6) and Mac OS X
(10.4) PPC (mono runtime 2.0.1), and the crash is exactly the same on both.
When I use a class derived from ICustomMarshaler to marshal a return value, it
gets a call to CleanUpNativeData with an invalid pointer value. When testing
the exactly same assembly file on Microsoft .Net 3.5 framework it doesn't
crash.

Test cases are attached in the zip. Steps to reproduce (on Linux):

gcc -shared -fPIC -o libcrash.so crash.c
gmcs Crash.cs
mono Crash.exe

The test case in mono unit testing directory that tests for ICustomMarshaler
can be found from:

<A HREF="http://anonsvn.mono-project.com/viewvc/trunk/mono/mono/tests/marshal9.cs?view=markup">http://anonsvn.mono-project.com/viewvc/trunk/mono/mono/tests/marshal9.cs?view=markup</A>

It has a REALLY weird condition that causes this bug not to reproduce:

                int alloc_type = Marshal.ReadInt32 (pNativeData);
                if (alloc_type == 1)
                        Marshal.FreeHGlobal (pNativeData);

So the test case doesn't crash for this bug, but the bug is still there. I had
to write a workaround in my program to store each allocated memory block and
when freeing check that the freed pointers are valid to avoid the mono crash. I
think this bug is quite fatal, please comment.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="082776.html">[Mono-bugs] [Bug 450002] New: Very slow performance in Winforms	ListView
</A></li>
	<LI>Next message: <A HREF="082781.html">[Mono-bugs] [Bug 450050] Mono crashes to freeing invalid pointer when using custom ICustomMarshaler marshaling return value
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#82780">[ date ]</a>
              <a href="thread.html#82780">[ thread ]</a>
              <a href="subject.html#82780">[ subject ]</a>
              <a href="author.html#82780">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
