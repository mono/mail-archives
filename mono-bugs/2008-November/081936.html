<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 442129] New: Delay local variable capture until just before anonymous methods
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20442129%5D%20New%3A%20Delay%20local%20variable%20capture%20until%0A%20just%20before%20anonymous%20methods&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="081942.html">
   <LINK REL="Next"  HREF="081939.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 442129] New: Delay local variable capture until just before anonymous methods</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20442129%5D%20New%3A%20Delay%20local%20variable%20capture%20until%0A%20just%20before%20anonymous%20methods&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 442129] New: Delay local variable capture until just before anonymous methods">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Nov  5 23:09:03 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="081942.html">[Mono-bugs] [Bug 442122] Better handling of read-only method variables which appear in closures.
</A></li>
        <LI>Next message: <A HREF="081939.html">[Mono-bugs] [Bug 442129] Delay local variable capture until just before anonymous methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#81936">[ date ]</a>
              <a href="thread.html#81936">[ thread ]</a>
              <a href="subject.html#81936">[ subject ]</a>
              <a href="author.html#81936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=442129">https://bugzilla.novell.com/show_bug.cgi?id=442129</A>


           Summary: Delay local variable capture until just before anonymous
                    methods
           Product: Mono: Compilers
           Version: unspecified
          Platform: Other
        OS/Version: Other
            Status: NEW
          Severity: Enhancement
          Priority: P5 - None
         Component: C#
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">lunchtimemama at gmail.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Test Case:

void Foo()
{
    int i = 0;

    for (; i &lt; 1000; i++) {
        DoSomethingWithAnInt (i);
    }

    DoSomethingWithADelegate (() =&gt; i != 5);
}

Actual Result:

The compiler captures the variable 'i' at the start of the method. This means
that all uses of 'i' in the for loop are done through the instance of the
compiler generated type. Each read requires two IL instructions (ldloc and
ldfld) and each write requires two IL instructions (ldloc and stfld).

Expected Result:

Delay capturing a local variable until just before the first anonymous method
in which it appears. Each use of the variable prior to the anonymous method can
be done directly (reads are a simple ldloc and writes are a simple stloc).
Then, before the anonymous method is used, the variable can be hoisted into the
closure object and all subsequence uses of the variable can be channeled
through that object as per usual. Also, the instantiation of the closure object
could be delayed until just before the first variable is captured rather than
at the start of the method (as is currently done). That way if the method
exists (normally or exceptionally) before the first anonymous method is needed,
an unnecessary object allocation will have been avoided.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="081942.html">[Mono-bugs] [Bug 442122] Better handling of read-only method variables which appear in closures.
</A></li>
	<LI>Next message: <A HREF="081939.html">[Mono-bugs] [Bug 442129] Delay local variable capture until just before anonymous methods
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#81936">[ date ]</a>
              <a href="thread.html#81936">[ thread ]</a>
              <a href="subject.html#81936">[ subject ]</a>
              <a href="author.html#81936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
