<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 357519] New: IDisposable incorrectly implemented	in streams
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20357519%5D%20New%3A%20IDisposable%20incorrectly%20implemented%0A%09in%20streams&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="068607.html">
   <LINK REL="Next"  HREF="068570.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 357519] New: IDisposable incorrectly implemented	in streams</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20357519%5D%20New%3A%20IDisposable%20incorrectly%20implemented%0A%09in%20streams&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 357519] New: IDisposable incorrectly implemented	in streams">bugzilla_noreply at novell.com
       </A><BR>
    <I>Thu Jan 31 02:54:46 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="068607.html">[Mono-bugs] [Bug 357504] [Regression] 2.0/masterpages errors with &quot; Instance creation failed&quot;
</A></li>
        <LI>Next message: <A HREF="068570.html">[Mono-bugs] [Bug 357519] IDisposable incorrectly implemented in	streams
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#68569">[ date ]</a>
              <a href="thread.html#68569">[ thread ]</a>
              <a href="subject.html#68569">[ subject ]</a>
              <a href="author.html#68569">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=357519">https://bugzilla.novell.com/show_bug.cgi?id=357519</A>


           Summary: IDisposable incorrectly implemented in streams
           Product: Mono: Class Libraries
           Version: 1.2.5
          Platform: Other
        OS/Version: Debian Woody
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: System
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">atlaste at yahoo.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: Customer


Description of Problem:

Mono doesn't handle dispose correctly in streams.


Unhandled Exception: System.ObjectDisposedException: The object was used after
being disposed.
  at System.IO.Compression.DeflateStream.FlushInternal (Boolean finish)
[0x00000]
  at System.IO.Compression.DeflateStream.Dispose (Boolean disposing) [0x00000]
  at System.IO.Stream.Close () [0x00000]
  at System.IO.Stream.Dispose () [0x00000]
  at (wrapper remoting-invoke-with-check) System.IO.Stream:Dispose ()
  at System.IO.Compression.GZipStream.Dispose (Boolean disposing) [0x00000]
  at System.IO.Stream.Close () [0x00000]
  at System.IO.BinaryWriter.Dispose (Boolean disposing) [0x00000]
  at System.IO.BinaryWriter.System.IDisposable.Dispose () [0x00000]
  at DictionaryBuilding.ProbDict.Merge.GeneralWriter.WriteAll () [0x00000]
  at DictionaryBuilding.ProbDict.EMAlgorithm.EM (Int32 steps) [0x00000]
  at DictionaryBuilding.DictionaryBuilding.Calculate () [0x00000]
  at DictionaryBuilding.Program.Main (System.String[] args) [0x00000]

Unhandled Exception: System.ObjectDisposedException: The object was used after
being disposed.
  at System.IO.Compression.DeflateStream.FlushInternal (Boolean finish)
[0x00000]
  at System.IO.Compression.DeflateStream.Dispose (Boolean disposing) [0x00000]
  at System.IO.Stream.Close () [0x00000]
  at System.IO.Stream.Dispose () [0x00000]
  at (wrapper remoting-invoke-with-check) System.IO.Stream:Dispose ()
  at System.IO.Compression.GZipStream.Dispose (Boolean disposing) [0x00000]
  at System.IO.Stream.Close () [0x00000]
  at System.IO.Stream.System.IDisposable.Dispose () [0x00000]
  at DictionaryBuilding.ProbDict.Merge.GeneralWriter.WriteAll () [0x00000]
  at DictionaryBuilding.ProbDict.EMAlgorithm.EM (Int32 steps) [0x00000]
  at DictionaryBuilding.DictionaryBuilding.Calculate () [0x00000]
  at DictionaryBuilding.Program.Main (System.String[] args) [0x00000]
*** glibc detected *** mono: double free or corruption (!prev): 0x08483100 ***

Source code:

using (Stream s1 = new BufferedStream(File.OpenWrite(filename))) 
            {
                using (GZipStream s = new GZipStream(s1,
CompressionMode.Compress))
                {
                    using (BinaryWriter bw = new BinaryWriter(s))
                    {
                        foreach (Wordpair wp in child.Iterate())
                        {
                            if (wp.P &gt;= 0.0f)
                            {
                                bw.Write(wp.X);
                                bw.Write(wp.Y);
                                bw.Write(wp.P);
                            }
                        }
                        bw.Write(-1);
                        bw.Write(-1);
                        bw.Write(-1);
                        bw.Close();
                    }
                    s.Close();
                }
                s1.Close();
            }

Note that this code is perfectly legal in .NET!

Actual Results:
Crash

Expected Results:
No crash :-)

How often does this happen? 
Always

Additional Information:
Behavior of IDisposable is incorrect. This happens in almost all classes with
resources that are being managed. The solution is to implement the IDisposable
pattern as stated on microsoft.com correctly.

Greetings,
Stefan.


-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="068607.html">[Mono-bugs] [Bug 357504] [Regression] 2.0/masterpages errors with &quot; Instance creation failed&quot;
</A></li>
	<LI>Next message: <A HREF="068570.html">[Mono-bugs] [Bug 357519] IDisposable incorrectly implemented in	streams
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#68569">[ date ]</a>
              <a href="thread.html#68569">[ thread ]</a>
              <a href="subject.html#68569">[ subject ]</a>
              <a href="author.html#68569">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
