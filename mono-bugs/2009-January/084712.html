<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 467212] New: Mono runtime incorrectly calls MarshalNativeToManaged method of custom marshaler when marshaling Array argument to C++ method using PInvoke
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20467212%5D%20New%3A%20Mono%20runtime%20incorrectly%20calls%0A%20MarshalNativeToManaged%20method%20of%20custom%20marshaler%20when%20marshaling%20Array%0A%20argument%20to%20C%2B%2B%20method%20using%20PInvoke&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="085132.html">
   <LINK REL="Next"  HREF="084713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 467212] New: Mono runtime incorrectly calls MarshalNativeToManaged method of custom marshaler when marshaling Array argument to C++ method using PInvoke</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20467212%5D%20New%3A%20Mono%20runtime%20incorrectly%20calls%0A%20MarshalNativeToManaged%20method%20of%20custom%20marshaler%20when%20marshaling%20Array%0A%20argument%20to%20C%2B%2B%20method%20using%20PInvoke&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 467212] New: Mono runtime incorrectly calls MarshalNativeToManaged method of custom marshaler when marshaling Array argument to C++ method using PInvoke">bugzilla_noreply at novell.com
       </A><BR>
    <I>Sun Jan 18 16:24:46 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="085132.html">[Mono-bugs] [Bug 467202] Bitmap creating from other bitmap not	thread safe.
</A></li>
        <LI>Next message: <A HREF="084713.html">[Mono-bugs] [Bug 467212] Mono runtime incorrectly calls MarshalNativeToManaged method of custom marshaler when marshaling Array argument to C++ method using PInvoke
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#84712">[ date ]</a>
              <a href="thread.html#84712">[ thread ]</a>
              <a href="subject.html#84712">[ subject ]</a>
              <a href="author.html#84712">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=467212">https://bugzilla.novell.com/show_bug.cgi?id=467212</A>


           Summary: Mono runtime incorrectly calls MarshalNativeToManaged
                    method of custom marshaler when marshaling Array
                    argument to C++ method using PInvoke
    Classification: Mono
           Product: Mono: Runtime
           Version: unspecified
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: Major
          Priority: P5 - None
         Component: interop
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mtraudt at quantifisolutions.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Created an attachment (id=265901)
 --&gt; (<A HREF="https://bugzilla.novell.com/attachment.cgi?id=265901">https://bugzilla.novell.com/attachment.cgi?id=265901</A>)
Code sample that can be used to reproduce the problem

User-Agent:       Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; SLCC1;
NET CLR 2.0.50727; .NET CLR 1.1.4322; .NET CLR 3.5.21022; .NET CLR 3.5.30729;
NET CLR 3.0.30618)

In the attached test case, I am calling a C++ method that takes a user-defined
C++ array type as an argument.  I have a custom marshaler that marshals a C#
double[] to a C++ Array&lt;double&gt;.

With MS CLR, when calling this method, the MarshalManagedToNative method of my
custom marshaler is called, as expected.  With Mono, the MarshalNativeToManaged
method will also be called.

I think I understand the rationale behind the Mono behavior, however I assume
that the goal is to match the MS behavior as closely as possible.  Also, in my
case the MS approach is more efficient, since since my custom marshaler already
ensures pass-by-ref semantics.



Reproducible: Always

Steps to Reproduce:
1. Unzip the attached test case on Windows
2. Compile in a VS2005 or VS2008 command shell
3. Run with MS CLR, and again with Mono CLR

I tried to make it as easy as possible to build and run.  I used GNU Make
because I find it simpler for test cases.  If you need a VS project file, or
you want a Makefile that will work on Linux with Mono/GCC, let me know.

We noticed the issue originally on openSUSE11.0 with Mono2.2 and GCC4.3, but as
noted the issue is with the Mono CLR and so I decided to create my test case
entirely on Windows.

Actual Results:  
Build Program.exe and CppLibrary.dll.  When running Program.exe, you should see
that with Mono, ArrayOfDoubleMarshaler.MarshalNativeToManaged is called, but on
MS it is not.


Expected Results:  
I am expecting (hoping) to get the same behavior with Mono as with MS.


This is a critical problem for us, as we rely on the MS behavior (for reasons
that go beyond what is demonstrated in the simplified test case attached).

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>

















































































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="085132.html">[Mono-bugs] [Bug 467202] Bitmap creating from other bitmap not	thread safe.
</A></li>
	<LI>Next message: <A HREF="084713.html">[Mono-bugs] [Bug 467212] Mono runtime incorrectly calls MarshalNativeToManaged method of custom marshaler when marshaling Array argument to C++ method using PInvoke
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#84712">[ date ]</a>
              <a href="thread.html#84712">[ thread ]</a>
              <a href="subject.html#84712">[ subject ]</a>
              <a href="author.html#84712">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
