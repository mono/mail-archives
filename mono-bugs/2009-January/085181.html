<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 470451] New: null reference in	TreeView/MouseMoveHandler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20470451%5D%20New%3A%20null%20reference%20in%0A%09TreeView/MouseMoveHandler&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="085195.html">
   <LINK REL="Next"  HREF="085186.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 470451] New: null reference in	TreeView/MouseMoveHandler</H1>
    <B>bugzilla_noreply at novell.com</B> 
    <A HREF="mailto:mono-bugs%40lists.ximian.com?Subject=%5BMono-bugs%5D%20%5BBug%20470451%5D%20New%3A%20null%20reference%20in%0A%09TreeView/MouseMoveHandler&In-Reply-To="
       TITLE="[Mono-bugs] [Bug 470451] New: null reference in	TreeView/MouseMoveHandler">bugzilla_noreply at novell.com
       </A><BR>
    <I>Wed Jan 28 18:57:31 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="085195.html">[Mono-bugs] [Bug 470427] JIT crash related to generics sharing when	running MD
</A></li>
        <LI>Next message: <A HREF="085186.html">[Mono-bugs] [Bug 470486] New: Run button on toolbar is missing when no debugger is present
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#85181">[ date ]</a>
              <a href="thread.html#85181">[ thread ]</a>
              <a href="subject.html#85181">[ subject ]</a>
              <a href="author.html#85181">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="https://bugzilla.novell.com/show_bug.cgi?id=470451">https://bugzilla.novell.com/show_bug.cgi?id=470451</A>


           Summary: null reference in TreeView/MouseMoveHandler
    Classification: Mono
           Product: Mono: Class Libraries
           Version: SVN
          Platform: All
        OS/Version: All
            Status: NEW
          Severity: Normal
          Priority: P5 - None
         Component: Windows.Forms
        AssignedTo: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
        ReportedBy: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">djlawler at aol.com</A>
         QAContact: <A HREF="http://lists.ximian.com/mailman/listinfo/mono-bugs">mono-bugs at lists.ximian.com</A>
          Found By: ---


Description of Problem:
This bug happens using the multi-select treeview at this url:
<A HREF="http://sourceforge.net/projects/mstreeview">http://sourceforge.net/projects/mstreeview</A>

The multi-select treeview uses the standard TreeView as it's base class but
overrides OnBeforeSelect and e.Cancel's it so that it can control the node
selections.  If the treeview control loses focus, then you click on a node
while moving the mouse the Mono treeview will blow up in the MouseMoveHandler
code with null reference exceptions on one of two assignments (I have not seen
it blow on the highlighted_node).  What happens is that when you click (mouse
down) back on the treeview, the Mono TreeView control regains focus
(GotFocusHandler) and it attempts to set a selected node of some sort (if the
selected_node is currently null).  However when it gets to the (set)
SelectedNode method it calls 'OnBeforeSelect' which is then cancelled by the
multiselect treeview.  This means that when it gets to the MouseMoveHandler
method (because not only did we click on a node but we were moving the mouse)
the selected_node (and focused_node) could very well be null.  As there is no
null checking it blows up.  I have to assume that while unusual, it is 'legal'
for the multi-select treeview to set e.Cancel to true in OnBeforeSelect.  To me
that means that the absense of null checking in the MouseMoveHandler routine is
a bug.  In fact it seems that just about everywhere else in the treeview
the null checking of selected_node is done (OnKeyDown, GotFocusHandler, etc.
etc.).

Steps to reproduce the problem:
1. Use the following short program:

using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Windows.Forms;

namespace WindowsFormsApplication1
{
    public class MyTreeView : TreeView
    {
        protected override void OnBeforeSelect(TreeViewCancelEventArgs e)
        {
            e.Cancel = true;
        }

    }

    public class Form1 : Form
    {
        public Form1()
        {
            InitializeComponent();
        }

        private System.ComponentModel.IContainer components = null;
        private MyTreeView treeView1;

        protected override void Dispose(bool disposing)
        {
            if (disposing &amp;&amp; (components != null))
            {
                components.Dispose();
            }
            base.Dispose(disposing);
        }

        private void InitializeComponent()
        {
            System.Windows.Forms.TreeNode treeNode1 = new
System.Windows.Forms.TreeNode(&quot;Node1&quot;);
            System.Windows.Forms.TreeNode treeNode2 = new
System.Windows.Forms.TreeNode(&quot;Node2&quot;);
            System.Windows.Forms.TreeNode treeNode3 = new
System.Windows.Forms.TreeNode(&quot;Node3&quot;);
            System.Windows.Forms.TreeNode treeNode4 = new
System.Windows.Forms.TreeNode(&quot;Node4&quot;);
            System.Windows.Forms.TreeNode treeNode5 = new
System.Windows.Forms.TreeNode(&quot;Node5&quot;);
            System.Windows.Forms.TreeNode treeNode6 = new
System.Windows.Forms.TreeNode(&quot;Node6&quot;);
            System.Windows.Forms.TreeNode treeNode7 = new
System.Windows.Forms.TreeNode(&quot;Node7&quot;);
            System.Windows.Forms.TreeNode treeNode8 = new
System.Windows.Forms.TreeNode(&quot;Node8&quot;);
            System.Windows.Forms.TreeNode treeNode9 = new
System.Windows.Forms.TreeNode(&quot;Node9&quot;);
            System.Windows.Forms.TreeNode treeNode10 = new
System.Windows.Forms.TreeNode(&quot;Node0&quot;, new System.Windows.Forms.TreeNode[] {
                treeNode1, treeNode2, treeNode3, treeNode4, treeNode5,
treeNode6, treeNode7, treeNode8, treeNode9});
            this.treeView1 = new MyTreeView();
            this.SuspendLayout();
            this.treeView1.Location = new System.Drawing.Point(13, 13);
            this.treeView1.Name = &quot;treeView1&quot;;
            treeNode1.Name = &quot;Node1&quot;;
            treeNode1.Text = &quot;Node1&quot;;
            treeNode2.Name = &quot;Node2&quot;;
            treeNode2.Text = &quot;Node2&quot;;
            treeNode3.Name = &quot;Node3&quot;;
            treeNode3.Text = &quot;Node3&quot;;
            treeNode4.Name = &quot;Node4&quot;;
            treeNode4.Text = &quot;Node4&quot;;
            treeNode5.Name = &quot;Node5&quot;;
            treeNode5.Text = &quot;Node5&quot;;
            treeNode6.Name = &quot;Node6&quot;;
            treeNode6.Text = &quot;Node6&quot;;
            treeNode7.Name = &quot;Node7&quot;;
            treeNode7.Text = &quot;Node7&quot;;
            treeNode8.Name = &quot;Node8&quot;;
            treeNode8.Text = &quot;Node8&quot;;
            treeNode9.Name = &quot;Node9&quot;;
            treeNode9.Text = &quot;Node9&quot;;
            treeNode10.Name = &quot;Node0&quot;;
            treeNode10.Text = &quot;Node0&quot;;
            this.treeView1.Nodes.AddRange(new System.Windows.Forms.TreeNode[]
{treeNode10});
            this.treeView1.Size = new System.Drawing.Size(267, 237);
            this.treeView1.TabIndex = 0;
            this.AutoScaleDimensions = new System.Drawing.SizeF(6F, 13F);
            this.AutoScaleMode = System.Windows.Forms.AutoScaleMode.Font;
            this.ClientSize = new System.Drawing.Size(368, 262);
            this.Controls.Add(this.treeView1);
            this.Name = &quot;Form1&quot;;
            this.Text = &quot;Form1&quot;;
            this.ResumeLayout(false);
        }
    }

    static class Program
    {
        [STAThread]
        static void Main()
        {
            Application.EnableVisualStyles();
            Application.SetCompatibleTextRenderingDefault(false);
            Application.Run(new Form1());
        }
    }
}

2. If you run this program on Mono (latest SVN) it will blow up if you start
the program, expand the treeview, do something so that the application loses
focus.  Then click on a node while moving the mouse.

Actual Results:

System.NullReferenceException: Object reference not set to an instance of an
object in System.Windows.Forms.TreeView.MouseMoveHandler

Expected Results:

There should be no null references

How often does this happen? 

Every time

-- 
Configure bugmail: <A HREF="https://bugzilla.novell.com/userprefs.cgi?tab=email">https://bugzilla.novell.com/userprefs.cgi?tab=email</A>
------- You are receiving this mail because: -------
You are the QA contact for the bug.
You are the assignee for the bug.
</PRE>




























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="085195.html">[Mono-bugs] [Bug 470427] JIT crash related to generics sharing when	running MD
</A></li>
	<LI>Next message: <A HREF="085186.html">[Mono-bugs] [Bug 470486] New: Run button on toolbar is missing when no debugger is present
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#85181">[ date ]</a>
              <a href="thread.html#85181">[ thread ]</a>
              <a href="subject.html#85181">[ subject ]</a>
              <a href="author.html#85181">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.ximian.com/mailman/listinfo/mono-bugs">More information about the mono-bugs
mailing list</a><br>
</body></html>
