<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-bugs] [Bug 73275][Nor] New - Network code fails with Mono, but works with .Net
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="026041.html">
   <LINK REL="Next"  HREF="026043.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-bugs] [Bug 73275][Nor] New - Network code fails with Mono, but works with .Net
   </H1>
    <B>bugzilla-daemon@bugzilla.ximian.com
    </B> 
    <A HREF="mailto:bugzilla-daemon%40bugzilla.ximian.com"
       TITLE="[Mono-bugs] [Bug 73275][Nor] New - Network code fails with Mono, but works with .Net">bugzilla-daemon@bugzilla.ximian.com
       </A><BR>
    <I>Thu,  3 Mar 2005 07:19:00 -0500 (EST)</I>
    <P><UL>
        <LI> Previous message: <A HREF="026041.html">[Mono-bugs] [Bug 73215][Nor] Changed - Memory corruption when using objects from dynamically created types
</A></li>
        <LI> Next message: <A HREF="026043.html">[Mono-bugs] [Bug 73278][Nor] New - Compiler doesn't report use of unassigned variable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26042">[ date ]</a>
              <a href="thread.html#26042">[ thread ]</a>
              <a href="subject.html#26042">[ subject ]</a>
              <a href="author.html#26042">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please do not reply to this email- if you want to comment on the bug, go to the
URL shown below and enter your comments there.

Changed by <A HREF="mailto:r_holmes@yahoo.com.">r_holmes@yahoo.com.</A>

<A HREF="http://bugzilla.ximian.com/show_bug.cgi?id=73275">http://bugzilla.ximian.com/show_bug.cgi?id=73275</A>

--- shadow/73275	2005-03-03 07:19:00.000000000 -0500
+++ shadow/73275.tmp.17615	2005-03-03 07:19:00.000000000 -0500
@@ -0,0 +1,222 @@
+Bug#: 73275
+Product: Mono: Class Libraries
+Version: 1.0
+OS: 
+OS Details: Debian unstable packages of Mono
+Status: NEW   
+Resolution: 
+Severity: 
+Priority: Normal
+Component: Sys.Web
+AssignedTo: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>                            
+ReportedBy: <A HREF="mailto:r_holmes@yahoo.com">r_holmes@yahoo.com</A>               
+QAContact: <A HREF="mailto:mono-bugs@ximian.com">mono-bugs@ximian.com</A>
+TargetMilestone: ---
+URL: 
+Cc: 
+Summary: Network code fails with Mono, but works with .Net
+
+I'm writing a simple application in C# that logs into a Yahoo Mail account
+by simulating a browser. 
+
+During the login process, it is redirected (through the http header)
+through a number of servers until it finally reaches the inbox, if
+successful. To each server it sends the cookies received so far.
+
+However, I can't get the login process to work with Mono (1.0.5, Debian 
+unstable). With .Net-runtime on Windows, it works perfectly.
+
+If we look at the Trace-output running the application on Windows, it 
+reaches my inbox at step 14:
+
+1: Logging into Yahoo Mail with username 'r_holmes' and password 'xxxx'
+2: Opening 
+'<A HREF="http://mail.yahoo.com/config/login?.intl=us&.us=ym&.tries=1&.src=ym&login=r_holmes&passwd=xxxx'">http://mail.yahoo.com/config/login?.intl=us&amp;.us=ym&amp;.tries=1&amp;.src=ym&amp;login=r_holmes&amp;passwd=xxxx'</A>
+3: UpdateCookieCollection()
+4: No previous cookies stored. Store all cookies
+5:    B 4fuqucl12920k&amp;b=2
+6:    F a=J06ons0sva8HnAxcQd0gGflizzgSbIkvrjqtKkO_UelR1SmfYg.SzWz1NeVd&amp;b=_DjV
+7:    Y v=1&amp;n=frfgoo6e3klnv&amp;l=h_7ebc4i/o&amp;p=m2evvdk013000000&amp;jb=16|23|
+3&amp;ig=0f1kb&amp;iz=5932&amp;r=2d&amp;lg=us&amp;intl=us&amp;np=1
+8:    T 
+z=UgIJCBUmdJCBBifXWTwKl.iMjMxBjYzMTYxNE8xNw--&amp;a=QAE&amp;sk=DAAhBq4AhwE.1m&amp;d=c2wBTlRRMkFURTBOakUyTXpnMk1BLS0BYQFRQUUBaWcBVjNTVEJBAXRpcAFRZEtfaEQBenoBVWdJSkNCZ1dB
+9: Redirecting to 
+'<A HREF="http://login.yahoo.com/config/verify?.done=http%3a//us.f546.mail.yahoo.com/ym/login%3f.rand=01gj9h49dpaih'">http://login.yahoo.com/config/verify?.done=http%3a//us.f546.mail.yahoo.com/ym/login%3f.rand=01gj9h49dpaih'</A>
+10: Setting up cookies to sent with the request
+11: Opening 
+'<A HREF="http://login.yahoo.com/config/verify?.done=http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'">http://login.yahoo.com/config/verify?.done=http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'</A>
+12: Redirecting to 
+'<A HREF="http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'">http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'</A>
+13: Setting up cookies to sent with the request
+14: Opening '<A HREF="http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'">http://us.f546.mail.yahoo.com/ym/login?.rand=01gj9h49dpaih'</A>
+15: UpdateCookieCollection()
+16:    Adding new key/value pair: 
+'YM.Gen'/'i=vaJ46Ur8iCyUC6SohqziJVP0lrSkYKjdTmsYzl0doCY2i3KytxJ_HAyp6w7V.c98W1bFLdoH8iGPyhITUWD1wuAX_q2.1hYj4gEQ38OFhLh1mTwwK.Ylm.ZmUV_NPIyjjO74ehM_uuYUTNPQFWkpvNbMNte.Bfd98jAMYAjUbQYm_kFVlNAESrPdnINBKBULD1_zSe0.Q7OE.iI5WGhXBrrYlo0GN44ZcwK3t1v0P_5Ryl1MSiuxuzuFvByz1R4YQ0EJ3Y_BrJHAH6Jom0LbcdtPnstLOHShR6_bgAp_WHGZM8Aa8uMALYZNO7_t5ziChZD5eDy9EPEZMC725W_KIGJfyjmyRRaAwm_z5oWl3vTcyo7dM8K2OiHOmq7jybrbqK92bEJMQw1yhoywCa2i1725CWTyRF6FEvyQLcH3ETmOG7oIVStFQ5hhRvmW5bToznLdm62ddmz1Cg9o5p_7mT5Mwh18M78Ve9Gl3trJUSHknsKYTmsWNgb2WhOOuhDvChQ_X7IP4rek_vXhJ6QNyyAhGSzN5XuxP1pYZeFfH7VjXaSENOOsdagnyPE3Stvz.5JDWsigL.SHgCPdFprBCl7GWertr02iLBBic_0nd3NL8fGDlicXxz6MM4uyhtUolJKWg_BcQL_u.Axc3R190_njne4Ty4OdiH3JdxcHqqc8YMUxcHvz_jGjZ8v3qW5mmoJs.hguE9Fl4bi5cVvPfqtPOFATXLPqCH8Ue4_MK1pH9Bdg2D3Lj35qRTujPib_rqtTUKyb_tsDb6yGKwTO_ZxzI1WjG39j3cCNMSdVn4Dl7JRsl3cxUD.KQIwNuatBxiARtIx31gBPOKXSqO_iOW1Ki9H.E8gCckwQQl6zkPBxibd_FNslukBXiSiGa7BW66r_d7LEYeoiEtxsF7gWmmB_4GiU3eCThkTNmWFpJ4Pm430kDC_Q5j3gtPsOdeBDJbfiL0ILhC060d0mw
 P6bAbqBKv1n_go7OM0E9EeErxQhNv7W0S6T5NyphbU40AJ5sJkjvNi8yk9Kaq3rrRBnGjq2uPsrFzhXAE1rdWMZWbScjWTD1hdcsayzVL7jMifCzE3cnGLpSkMcdKHMQPvLd2dX9SVQlhV2u.zHmBECpiRUYT6WGpMBzvfAML7SFt0BCHztoHyHxeLeoPvFKiurzTPe3eroy.SQtvR0lsJ4e4k30dxqWFYxuHJ2dblV3YJLnnW5v4l7xcKEIDFe0Y.WsVEH9PmA_Ojw4BCi8BI17IDNCG_lZ40XEu557ihM94z9biQg8XkhkjGtjNw9ys9T1heRI50L9K8OoODxxdyCFPYa1n4i51oiymPpTicfMZ5vGHvC8pr5PLN8qEQJ5aWo0zCKRIcESW..8cCi815aZL9QHCB70GYMusTEJtykLLkIaIVxnBtkpSiOEfQYQJbZd1wu.SP.qNQ-&amp;v=1'
+
+And then running the application on linux:
+
+1: Logging into Yahoo Mail with username 'r_holmes' and password 'xxxx'
+2: Opening 
+'<A HREF="http://mail.yahoo.com/config/login?.intl=us&.us=ym&.tries=1&.src=ym&login=r_holmes&passwd=xxxx'">http://mail.yahoo.com/config/login?.intl=us&amp;.us=ym&amp;.tries=1&amp;.src=ym&amp;login=r_holmes&amp;passwd=xxxx'</A>
+3: UpdateCookieCollection()
+4: No previous cookies stored. Store all cookies
+5:    B 18dft0h12937r&amp;b=2
+6:    F a=J06ons0sva8HnAxcQd0gGflizzgSbIkvrjqtKkO_UelR1SmfYg.SzWz1NeVd&amp;b=_DjV
+7:    Y v=1&amp;n=frfgoo6e3klnv&amp;l=h_7ebc4i/o&amp;p=m2evvdk013000000&amp;jb=16|23|
+3&amp;ig=0f1kb&amp;iz=5932&amp;r=2d&amp;lg=us&amp;intl=us&amp;np=1
+8:    T 
+z=7zIJCB75dJCBIjtUO2esw7qMjMxBjYzMTYxNE8xNw--&amp;a=QAE&amp;sk=DAA.qR.7d3F3JI&amp;d=c2wBTlRRMkFURTBOakUyTXpnMk1BLS0BYQFRQUUBaWcBVjNTVEJBAXRpcAFRZEtfaEQBenoBN3pJSkNCZ1dB
+9: Redirecting to 
+'<A HREF="http://login.yahoo.com/config/verify?.done=http%3a//us.f546.mail.yahoo.com/ym/login%3f.rand=8eb8bof6cj070'">http://login.yahoo.com/config/verify?.done=http%3a//us.f546.mail.yahoo.com/ym/login%3f.rand=8eb8bof6cj070'</A>
+10: Setting up cookies to sent with the request
+11: Opening 
+'<A HREF="http://login.yahoo.com/config/verify?.done=http://us.f546.mail.yahoo.com/ym/login?.rand=8eb8bof6cj070'">http://login.yahoo.com/config/verify?.done=http://us.f546.mail.yahoo.com/ym/login?.rand=8eb8bof6cj070'</A>
+
+Step 11 sends me back to the login page instead of to my inbox. The Yahoo 
+error message viewing the URL of step 11 is &quot;The browser you're using
+refuses to sign in. (cookies rejected)&quot;. I'm not sure this really is a
+cookie problem, though.
+
+I've inspected what is actually going on with Ethereal. As a response to 
+opening the URL of step 9 of the linux output, the Yahoo server responds 
+with:
+
+HTTP/1.1 200 OK[Unreassembled Packet]
+
+On Windows, the response is:
+
+HTTP/1.1 302 Found (text/html)
+
+I've attached a stripped down version of my application. Remember to
+compile it with /d:TRACE.
+
+Additional Information:
+
+using System;
+using System.IO;
+using System.Diagnostics;
+using System.Net;
+using System.Text;
+using System.Web;
+
+class YahooDrive {
+        public static void Main() {
+                Trace.Listeners.Add(new TextWriterTraceListener(Console.Out));
+                Trace.AutoFlush = true; 
+        
+                YahooMail ym = new YahooMail();
+                ym.Login(&quot;r_holmes&quot;, &quot;xxxx&quot;); 
+        }
+}
+
+class YahooMail {
+        CookieCollection m_cookies;
+        
+        static string m_httpLogin =
+&quot;<A HREF="http://mail.yahoo.com/config/login?.intl=us&.us=ym&.tries=1&.src=ym";">http://mail.yahoo.com/config/login?.intl=us&amp;.us=ym&amp;.tries=1&amp;.src=ym&quot;;</A>
+
+        public YahooMail() { }
+
+        public void Login(string aUsername, string aPassword) {
+                Debug.Assert(aUsername != &quot;&quot; &amp;&amp; aPassword != &quot;&quot;);
+
+                string urlAppend = &quot;&amp;login=&quot; + aUsername +
+                                                   &quot;&amp;passwd=&quot; + aPassword;
+                
+                Trace.WriteLine(&quot;Logging into Yahoo Mail with username '&quot; +
+aUsername + &quot;' and password '&quot; + aPassword + &quot;'&quot;);
+                RedirectHandler(new Uri(m_httpLogin + urlAppend));
+        }
+        
+        private void RedirectHandler(Uri aUri) {
+                Encoding enc = System.Text.Encoding.GetEncoding(&quot;utf-8&quot;);
+
+                HttpWebRequest request =
+(HttpWebRequest)WebRequest.Create(aUri);
+                request.CookieContainer = new CookieContainer();
+                                
+                if (m_cookies != null &amp;&amp; m_cookies.Count &gt; 0) {
+                        Trace.WriteLine(&quot;Setting up cookies to sent with
+the request&quot;);
+                        request.CookieContainer.Add(m_cookies);
+                }
+
+                SetHeaders(request);
+
+                Trace.WriteLine(&quot;Opening '&quot; + aUri + &quot;'&quot;);              
+                HttpWebResponse response =
+(HttpWebResponse)request.GetResponse();
+
+                if (response.Cookies.Count &gt; 0)
+                        UpdateCookieCollection(response.Cookies);         
+     
+                
+                //StreamReader responseStream = new
+StreamReader(response.GetResponseStream(), enc);    
+                //Console.WriteLine(responseStream.ReadToEnd());
+
+                if ( (response.StatusCode == HttpStatusCode.Redirect) ||
+                         (response.StatusCode == HttpStatusCode.Found) ||
+                         (response.StatusCode == HttpStatusCode.Moved) ||
+                         (response.StatusCode ==
+HttpStatusCode.MovedPermanently) ) {
+                        Trace.WriteLine(&quot;Redirecting to '&quot; +
+response.Headers[&quot;Location&quot;] + &quot;'&quot;);
+                        RedirectHandler(new Uri(response.Headers[&quot;Location&quot;]));
+                } 
+                
+        response.Close();
+        }
+        
+        private void SetHeaders(HttpWebRequest aRequest) {
+                Debug.Assert(aRequest != null);
+
+                aRequest.Method = &quot;GET&quot;;
+                aRequest.UserAgent = &quot;Mozilla/5.0 (X11; U; Linux i686;
+en-US; rv:0.9.4) Gecko/20010914&quot;;
+                aRequest.AllowAutoRedirect = false;
+        }
+        
+        private void UpdateCookieCollection(CookieCollection
+responseCollection) {
+                Trace.WriteLine(&quot;UpdateCookieCollection()&quot;);
+                
+                if (m_cookies == null) {
+                        Trace.WriteLine(&quot;No previous cookies stored. Store
+all cookies&quot;);                       
+                        m_cookies = responseCollection;
+                        Trace.Indent();
+                        
+                        foreach (Cookie c in m_cookies) {
+                                Trace.WriteLine(c.Name + &quot; &quot; + c.Value);
+                        }
+
+                        Trace.Unindent();                       
+                }
+                else {
+                        Trace.Indent();
+
+                        foreach (Cookie responseCookie in responseCollection) {
+                                bool match = false;
+                                
+                                foreach (Cookie storedCookie in m_cookies) {
+                                        if
+(storedCookie.Name.Equals(responseCookie.Name)) {
+                                                storedCookie.Value =
+responseCookie.Value;
+                                                Trace.WriteLine(&quot;Updated
+key/value pair: '&quot; + storedCookie.Name + &quot;'/'&quot; + storedCookie.Value + &quot;'&quot;);
+                                                match = true;
+                                        }
+                                }
+                                                        
+                                if (!match)
+                                        Trace.WriteLine(&quot;Adding new
+key/value pair: '&quot; + responseCookie.Name + &quot;'/'&quot; + responseCookie.Value + &quot;'&quot;);
+                                        m_cookies.Add(responseCookie);
+                        }
+                        
+                        Trace.Unindent();               
+                }
+        }
+}

</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="026041.html">[Mono-bugs] [Bug 73215][Nor] Changed - Memory corruption when using objects from dynamically created types
</A></li>
	<LI> Next message: <A HREF="026043.html">[Mono-bugs] [Bug 73278][Nor] New - Compiler doesn't report use of unassigned variable
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26042">[ date ]</a>
              <a href="thread.html#26042">[ thread ]</a>
              <a href="subject.html#26042">[ subject ]</a>
              <a href="author.html#26042">[ author ]</a>
         </LI>
       </UL>
</body></html>
