<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;<br>
Reply&nbsp;inline&nbsp;-&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Dec&nbsp;13,&nbsp;2016,&nbsp;at&nbsp;6:37&nbsp;PM,&nbsp;Jonathan&nbsp;Pryor&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:jonpryor@vt.edu&quot;&nbsp;class=&quot;&quot;&gt;jonpryor@vt.edu&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Let&nbsp;me&nbsp;go&nbsp;back&nbsp;one&nbsp;step.&nbsp;In&nbsp;general&nbsp;the&nbsp;signal&nbsp;chain&nbsp;looks&nbsp;like&nbsp;this&nbsp;on&nbsp;Android:&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(1)&nbsp;SIGSEGV&nbsp;happens,&nbsp;the&nbsp;ART&nbsp;handler&nbsp;catches&nbsp;it&nbsp;and&nbsp;does&nbsp;some&nbsp;stuff&nbsp;(e.g.&nbsp;&quot;is&nbsp;it&nbsp;caused&nbsp;by&nbsp;my&nbsp;managed&nbsp;code&quot;?).&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(2)&nbsp;if&nbsp;ART&nbsp;doesn't&nbsp;know&nbsp;what&nbsp;to&nbsp;do,&nbsp;it&nbsp;will&nbsp;chain&nbsp;into&nbsp;remaining&nbsp;handlers.&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(3)&nbsp;now&nbsp;it's&nbsp;the&nbsp;mono&nbsp;runtimes&nbsp;handler&nbsp;turn,&nbsp;we&nbsp;do&nbsp;our&nbsp;business,&nbsp;figure&nbsp;out&nbsp;it's&nbsp;a&nbsp;native&nbsp;crash,&nbsp;etc.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(4)&nbsp;(in&nbsp;case&nbsp;we&nbsp;do&nbsp;*NOT*&nbsp;crash)&nbsp;we&nbsp;return&nbsp;to&nbsp;the&nbsp;ART&nbsp;handler&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(5)&nbsp;the&nbsp;ART&nbsp;handler&nbsp;now&nbsp;chains&nbsp;into&nbsp;the&nbsp;next&nbsp;SIGSEGV&nbsp;handler,&nbsp;which&nbsp;was&nbsp;setup&nbsp;by&nbsp;the&nbsp;linker&nbsp;of&nbsp;bionic.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
(6)&nbsp;the&nbsp;libc/bionic&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;debuggerd&nbsp;which&nbsp;ptraces&nbsp;our&nbsp;process&nbsp;and&nbsp;delivers&nbsp;further&nbsp;information&nbsp;(e.g.&nbsp;register&nbsp;dump,&nbsp;native&nbsp;stack&nbsp;trace)&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/blockquote&gt;<br>
...&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Looking&nbsp;at&nbsp;this,&nbsp;I&nbsp;have&nbsp;this&nbsp;conclusion:&nbsp;How&nbsp;about&nbsp;we&nbsp;do&nbsp;not&nbsp;even&nbsp;attempt&nbsp;to&nbsp;do&nbsp;a&nbsp;native&nbsp;stack&nbsp;trace&nbsp;in&nbsp;mono,&nbsp;but&nbsp;just&nbsp;let&nbsp;debuggerd&nbsp;do&nbsp;its&nbsp;business?&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
What&nbsp;do&nbsp;we&nbsp;want?&nbsp;The&nbsp;managed&nbsp;callstack.&nbsp;Yes,&nbsp;a&nbsp;SIGSEGV&nbsp;happened&nbsp;in&nbsp;native&nbsp;code,&nbsp;but&nbsp;mono&nbsp;is&nbsp;the&nbsp;only&nbsp;one&nbsp;that&nbsp;can&nbsp;produce&nbsp;a&nbsp;*managed*&nbsp;callstack&nbsp;leading&nbsp;up&nbsp;to&nbsp;the&nbsp;SIGSEGV,&nbsp;and&nbsp;Android&nbsp;certainly&nbsp;isn’t&nbsp;going&nbsp;to&nbsp;print&nbsp;out&nbsp;the&nbsp;managed&nbsp;stack&nbsp;frames…&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
Of&nbsp;course&nbsp;we&nbsp;still&nbsp;have&nbsp;to&nbsp;print&nbsp;the&nbsp;managed&nbsp;stack&nbsp;trace&nbsp;ourselves.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
My&nbsp;recollection&nbsp;is&nbsp;that&nbsp;we&nbsp;*don’t*&nbsp;reliably&nbsp;print&nbsp;the&nbsp;managed&nbsp;stack&nbsp;trace&nbsp;during&nbsp;native&nbsp;SIGSEGV.&nbsp;(Am&nbsp;I&nbsp;wrong?)&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;Yes.&nbsp;There&nbsp;was&nbsp;an&nbsp;issue&nbsp;with&nbsp;exceeding&nbsp;the&nbsp;altstack&nbsp;limit:&nbsp;This&nbsp;was&nbsp;especially&nbsp;a&nbsp;problem&nbsp;on&nbsp;ARM32&nbsp;because&nbsp;we&nbsp;used&nbsp;a&nbsp;pretty&nbsp;large&nbsp;struct&nbsp;in&nbsp;our&nbsp;unwinding&nbsp;code.&nbsp;It’s&nbsp;fixed&nbsp;by&nbsp;this&nbsp;PR:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/mono/mono/pull/4106&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/mono/mono/pull/4106&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;However,&nbsp;this&nbsp;is&nbsp;only&nbsp;a&nbsp;workaround.&nbsp;&nbsp;Zoltan&nbsp;is&nbsp;experimenting&nbsp;with&nbsp;something&nbsp;similar&nbsp;what&nbsp;we&nbsp;are&nbsp;doing&nbsp;for&nbsp;exception&nbsp;handling&nbsp;already:&nbsp;get&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handler&nbsp;via&nbsp;overriding&nbsp;the&nbsp;PC&nbsp;in&nbsp;the&nbsp;sigctx&nbsp;structure&nbsp;and&nbsp;then&nbsp;do&nbsp;the&nbsp;heavy&nbsp;lifting&nbsp;later&nbsp;(that<br>
&nbsp;is,&nbsp;on&nbsp;a&nbsp;normal&nbsp;stack).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
So&nbsp;long&nbsp;as&nbsp;the&nbsp;managed&nbsp;callstack&nbsp;is&nbsp;*reliably*&nbsp;dumped,&nbsp;I&nbsp;don’t&nbsp;really&nbsp;care&nbsp;what&nbsp;code&nbsp;prints&nbsp;the&nbsp;native&nbsp;callstack,&nbsp;just&nbsp;that&nbsp;we&nbsp;get&nbsp;reliable&nbsp;managed&nbsp;and&nbsp;native&nbsp;callstacks&nbsp;*somewhere*,&nbsp;preferably&nbsp;in&nbsp;some&nbsp;form&nbsp;that&nbsp;will&nbsp;make&nbsp;it&nbsp;back&nbsp;to&nbsp;Google&nbsp;and&nbsp;developers…&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
However,&nbsp;that&nbsp;raises&nbsp;an&nbsp;added&nbsp;wrinkle:&nbsp;IIRC,&nbsp;debuggerd&nbsp;only&nbsp;attaches&nbsp;and&nbsp;dumps&nbsp;the&nbsp;stack&nbsp;traces&nbsp;for&nbsp;*debuggable*&nbsp;applications&nbsp;(`AndroidManifest.xml`&nbsp;has&nbsp;`//application/@android:debuggable=‘true’`).&nbsp;This&nbsp;*is&nbsp;not&nbsp;true*&nbsp;for&nbsp;Release&nbsp;apps,&nbsp;meaning&nbsp;we&nbsp;might&nbsp;not&nbsp;be<br>
&nbsp;able&nbsp;to&nbsp;rely&nbsp;on&nbsp;debuggerd&nbsp;to&nbsp;provide&nbsp;native&nbsp;stack&nbsp;traces&nbsp;in&nbsp;Release&nbsp;apps.&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;<br>
&lt;div&nbsp;class=&quot;&quot;&gt;Is&nbsp;that&nbsp;a&nbsp;problem?&nbsp;(Maybe?)&nbsp;Are&nbsp;native&nbsp;stack&nbsp;dumps&nbsp;when&nbsp;Release&nbsp;crashes&nbsp;something&nbsp;desirable?&nbsp;(I’d&nbsp;think&nbsp;so…?)&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;That’s&nbsp;indeed&nbsp;correct,&nbsp;and&nbsp;setting&nbsp;it&nbsp;in&nbsp;the&nbsp;manifest&nbsp;for&nbsp;release&nbsp;builds&nbsp;isn’t&nbsp;something&nbsp;you&nbsp;should&nbsp;do&nbsp;due&nbsp;to&nbsp;security&nbsp;reasons.&nbsp;Hence&nbsp;this&nbsp;PR:&nbsp;&lt;a&nbsp;href=&quot;https://github.com/mono/mono/pull/4131&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/mono/mono/pull/4131&lt;/a&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;<br>
&lt;/div&gt;<br>
&lt;/div&gt;<br>
-Bernhard&lt;/div&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
