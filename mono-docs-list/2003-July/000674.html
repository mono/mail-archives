<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Mono-docs-list] Monodoc aspx .1 -- Beter version
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:bmaurer%40users.sourceforge.net">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000673.html">
   <LINK REL="Next"  HREF="000676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mono-docs-list] Monodoc aspx .1 -- Beter version
   </H1>
    <B>Ben Maurer
    </B> 
    <A HREF="mailto:bmaurer%40users.sourceforge.net"
       TITLE="[Mono-docs-list] Monodoc aspx .1 -- Beter version">bmaurer@users.sourceforge.net
       </A><BR>
    <I>12 Jul 2003 21:44:23 -0500</I>
    <P><UL>
        <LI> Previous message: <A HREF="000673.html">[Mono-docs-list] Monodoc aspx .1
</A></li>
        <LI> Next message: <A HREF="000676.html">[Mono-docs-list] Monodoc aspx .1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#674">[ date ]</a>
              <a href="thread.html#674">[ thread ]</a>
              <a href="subject.html#674">[ subject ]</a>
              <a href="author.html#674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>--=-gNqXP46pJHwtS+NNgI1b
Content-Type: text/plain
Content-Transfer-Encoding: 7bit

Ok, I have made a better version. New instructions:

     1. install the xml patch in the parent thread
     2. install the attached patch
     3. cd monodoc; ./autogen.sh; make install
     4. cd /xsp/path/bin/; ln -s
        /usr/lib/monodoc/Mono.Website.Handlers.dll .
     5. Use the following for web.config:
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;configuration&gt;
    &lt;system.web&gt;
	&lt;httpHandlers&gt;
		&lt;add verb=&quot;*&quot; path=&quot;*.mdoc&quot;
type=&quot;Mono.Website.Handlers.MonodocHandler,Mono.Website.Handlers.MonodocHandler&quot; /&gt;
	&lt;/httpHandlers&gt; 
	&lt;/system.web&gt;
&lt;/configuration&gt;

You can see the docs at <A HREF="http://localhost:8080/a.mdoc.">http://localhost:8080/a.mdoc.</A>

-- Ben

--=-gNqXP46pJHwtS+NNgI1b
Content-Disposition: attachment; filename=monodocaspx.patch
Content-Type: text/x-patch; name=monodocaspx.patch; charset=UTF-8
Content-Transfer-Encoding: 7bit

Index: .cvsignore
===================================================================
RCS file: /cvs/public/monodoc/browser/.cvsignore,v
retrieving revision 1.2
diff -u -r1.2 .cvsignore
--- .cvsignore	6 Jun 2003 03:28:17 -0000	1.2
+++ .cvsignore	13 Jul 2003 02:46:20 -0000
@@ -1,3 +1,4 @@
+*.dll
 *dbg
 *tree
 Makefile
Index: ChangeLog
===================================================================
RCS file: /cvs/public/monodoc/browser/ChangeLog,v
retrieving revision 1.46
diff -u -r1.46 ChangeLog
--- ChangeLog	11 Jul 2003 02:00:07 -0000	1.46
+++ ChangeLog	13 Jul 2003 02:46:20 -0000
@@ -1,3 +1,9 @@
+2003-07-12  Ben Maurer &lt;<A HREF="mailto:bmaurer@users.sourceforge.net">bmaurer@users.sourceforge.net</A>&gt;
+	* browser.cs: Added support for visiting nodes from the root tree.
+	* ecma-provider.cs: Render the root: url with a list of namespaces
+	* provider.cs: Send the root:/xxx to the help sources. Handle
+	root:
+
 2003-07-10  Ben Maurer &lt;<A HREF="mailto:bmaurer@users.sourceforge.net">bmaurer@users.sourceforge.net</A>&gt;
 
 	* mono-ecma.xsl: Don't generate the excess monodoc namespaces.
Index: Makefile.am
===================================================================
RCS file: /cvs/public/monodoc/browser/Makefile.am,v
retrieving revision 1.17
diff -u -r1.17 Makefile.am
--- Makefile.am	26 Jun 2003 05:51:59 -0000	1.17
+++ Makefile.am	13 Jul 2003 02:46:20 -0000
@@ -1,5 +1,5 @@
 monodocdir = $(libdir)/monodoc
-monodoc_DATA = browser.exe assembler.exe monodoc.xml
+monodoc_DATA = browser.exe assembler.exe monodoc.xml Mono.Website.Handlers.MonodocHandler.dll
 CSC=mcs
 
 shared_sources = $(srcdir)/monohb-provider.cs $(srcdir)/xhtml-provider.cs $(srcdir)/ecma-provider.cs $(srcdir)/simple-provider.cs $(srcdir)/html-helper.cs $(srcdir)/provider.cs $(srcdir)/index.cs
@@ -17,6 +17,9 @@
 
 browser.exe: $(browser_sources) browser.glade mono-ecma.xsl $(srcdir)/../monodoc.png
 	$(CSC) /debug /out:browser.exe $(browser_sources) /resource:$(srcdir)/../monodoc.png,monodoc.png /resource:$(srcdir)/browser.glade,browser.glade /resource:$(srcdir)/mono-ecma.xsl,mono-ecma.xsl $(browser_assemblies)
+
+Mono.Website.Handlers.MonodocHandler.dll: $(shared_sources) mono-ecma.xsl $(srcdir)/../monodoc.png $(srcdir)/MonodocHandler.cs
+	$(CSC) /debug /out:Mono.Website.Handlers.MonodocHandler.dll /target:library $(srcdir)/MonodocHandler.cs -r:ICSharpCode.SharpZipLib.dll -r System.Web.dll $(shared_sources) /resource:$(srcdir)/../monodoc.png,monodoc.png /resource:$(srcdir)/mono-ecma.xsl,mono-ecma.xsl
 
 dump.exe: $(dump_sources) 
 	$(CSC) /debug /out:dump.exe $(dump_sources)  -r:ICSharpCode.SharpZipLib.dll
Index: MonodocHandler.cs
===================================================================
RCS file: MonodocHandler.cs
diff -N MonodocHandler.cs
--- /dev/null	1 Jan 1970 00:00:00 -0000
+++ MonodocHandler.cs	13 Jul 2003 02:46:20 -0000
@@ -0,0 +1,126 @@
+//
+// Mono.Web.Handlers.MonodocHandler
+//
+// Authors:
+//	Ben Maurer (<A HREF="mailto:bmaurer@users.sourceforge.net">bmaurer@users.sourceforge.net</A>)
+//
+// (C) 2003 Ben Maurer
+//
+
+using System;
+using System.Collections;
+using System.IO;
+using System.Text;
+using System.Web;
+using System.Web.UI;
+using System.Xml;
+using System.Xml.Xsl;
+
+namespace Mono.Website.Handlers
+{
+	public class MonodocHandler : IHttpHandler
+	{
+		static RootTree help_tree;
+		static MonodocHandler ()
+		{
+			help_tree = RootTree.LoadTree (&quot;/devel/install/lib/monodoc/&quot;);
+		}
+
+		void IHttpHandler.ProcessRequest (HttpContext context)
+		{
+			string link = (string) context.Request.Params[&quot;link&quot;];
+			if (link == null)
+				link = &quot;root:&quot;;
+			
+			if (link.StartsWith (&quot;source-id:&quot;) &amp;&amp; (link.EndsWith (&quot;.gif&quot;) || link.EndsWith (&quot;.jpeg&quot;) || link.EndsWith (&quot;.jpg&quot;)  || link.EndsWith(&quot;.png&quot;)))
+			{
+				switch (link.Substring (link.LastIndexOf ('.') + 1))
+				{
+					case &quot;gif&quot;:
+						context.Response.ContentType = &quot;image/gif&quot;;
+						break;
+					case &quot;jpeg&quot;:
+					case &quot;jpg&quot;:
+						context.Response.ContentType = &quot;image/jpeg&quot;;
+						break;
+					case &quot;png&quot;:
+						context.Response.ContentType = &quot;image/png&quot;;
+						break;
+					default:
+						throw new Exception (&quot;WTF!?!!?!&quot;);
+				}
+				
+				Stream s = help_tree.GetImage (link);
+				
+				if (s == null)
+					throw new HttpException (404, &quot;File not found&quot;);
+				
+				Copy (s, context.Response.OutputStream);
+				return;
+			}
+			
+			PrintDocs (link, context);
+		}
+		
+		
+		
+		void Copy (Stream input, Stream output)
+		{
+			const int BUFFER_SIZE=1024; // 1k buf
+			byte [] buffer = new byte [BUFFER_SIZE];
+		
+			int len;
+			while ( (len = input.Read (buffer, 0, BUFFER_SIZE)) &gt; 0)
+				output.Write (buffer, 0, len);
+			
+			output.Flush();
+		}
+		
+		void PrintDocs (string url, HttpContext ctx)
+		{
+			Node n;
+			
+			
+			ctx.Response.Write (@&quot;
+&lt;html&gt;
+&lt;head&gt;
+&lt;script&gt;
+&lt;!--
+function load ()
+{
+	objs = document.getElementsByTagName('a');
+	for (i = 0; i &lt; objs.length; i++)
+	{
+		objs[i].href = '&quot; + ctx.Request.Path + @&quot;?link=' + objs[i].href;
+	}
+			
+	objs = document.getElementsByTagName('img');
+	for (i = 0; i &lt; objs.length; i++)
+	{
+		objs[i].src = '&quot; + ctx.Request.Path + @&quot;?link=' + objs[i].src;
+	}
+}
+--&gt;
+&lt;/script&gt;
+&lt;title&gt;Mono Documentation&lt;/title&gt;
+&lt;/head&gt;
+&lt;body onLoad='load()'&gt;
+
+			&quot;);
+			
+			ctx.Response.Write (help_tree.RenderUrl (url, out n));
+		
+			ctx.Response.Write (@&quot;
+			&lt;/body&gt;
+&lt;/html&gt;&quot;);
+		}
+
+		bool IHttpHandler.IsReusable
+		{
+			get {
+				return true;
+			}
+		}
+
+	}
+}
\ No newline at end of file
Index: browser.cs
===================================================================
RCS file: /cvs/public/monodoc/browser/browser.cs,v
retrieving revision 1.37
diff -u -r1.37 browser.cs
--- browser.cs	11 Jul 2003 00:13:10 -0000	1.37
+++ browser.cs	13 Jul 2003 02:46:20 -0000
@@ -529,10 +529,16 @@
 
 		public override void Go ()
 		{
+			string res;
 			Node x;
 			
-			string res = n.tree.HelpSource.GetText (url, out x);
-			((Browser)browser).Render (res, n, url);
+			// The root tree has no help source
+			if (n.tree.HelpSource != null)
+				res = n.tree.HelpSource.GetText (url, out x);
+			else
+				res = ((RootTree)n.tree).RenderUrl (url, out x);
+					
+			browser.Render (res, n, url);
 		}
 	}
 
@@ -554,23 +560,25 @@
 
 		if (tree_view.Selection.GetSelected (out model, ref iter)){
 			Node n = (Node) iter_to_node [iter];
-
-			if (n.tree.HelpSource == null)
-				return;
-
-			string url = n.URL;
 			
-			//
-			// Try the tree-based urls first.
-			//
+			string url = n.URL;
 			Node match;
-			string s = n.tree.HelpSource.GetText (url, out match);
-			if (s != null){
-				((Browser)browser).Render (s, null, url);
-				browser.history.AppendHistory (new NodePageVisit (browser, n, url));
-				return;
+			string s;
+			
+			if (n.tree.HelpSource != null)
+			{
+				//
+				// Try the tree-based urls first.
+				//
+				
+				s = n.tree.HelpSource.GetText (url, out match);
+				if (s != null){
+					((Browser)browser).Render (s, null, url);
+					browser.history.AppendHistory (new NodePageVisit (browser, n, url));
+					return;
+				}
 			}
-
+			
 			//
 			// Try the url resolver next
 			//
Index: ecma-provider.cs
===================================================================
RCS file: /cvs/public/monodoc/browser/ecma-provider.cs,v
retrieving revision 1.51
diff -u -r1.51 ecma-provider.cs
--- ecma-provider.cs	10 Jul 2003 16:34:32 -0000	1.51
+++ ecma-provider.cs	13 Jul 2003 02:46:20 -0000
@@ -384,6 +384,17 @@
 	public override string GetText (string url, out Node match_node)
 	{
 		match_node = null;
+		
+		if (url == &quot;root:&quot;)
+		{
+			StringBuilder sb = new StringBuilder ();
+			
+			foreach (Node ns_node in Tree.Nodes)
+				sb.AppendFormat (&quot;&lt;a href='{0}'&gt;{1}&lt;/a&gt;&lt;/br&gt;&quot;, ns_node.Element, ns_node.Element.Substring (2));				
+				
+			return sb.ToString ();
+		}
+		
 		if (url.StartsWith (&quot;ecma:&quot;))
 			return GetTextFromUrl (url);
 
Index: monohb-provider.cs
===================================================================
RCS file: /cvs/public/monodoc/browser/monohb-provider.cs,v
retrieving revision 1.4
diff -u -r1.4 monohb-provider.cs
--- monohb-provider.cs	18 Jun 2003 13:24:57 -0000	1.4
+++ monohb-provider.cs	13 Jul 2003 02:46:20 -0000
@@ -20,7 +20,7 @@
 			string cssClass = ((XmlElement)node).GetAttribute(&quot;class&quot;);
 			if (cssClass != null &amp;&amp; (cssClass == &quot;topframe&quot; || cssClass == &quot;navbar&quot; || cssClass == &quot;copyright&quot;))
 			{
-				node.RemoveAll();
+				node.ParentNode.RemoveChild (node);
 			}
                                                                                 
 		}
@@ -53,7 +53,7 @@
 		bodynode.RemoveChild(firstheading);
 
 	bodynode.InnerXml =	&quot;&lt;table width=\&quot;100%\&quot;&gt;&quot; +
-			&quot;&lt;tr bgcolor=\&quot;#b0c4dae\&quot;&gt;&lt;td&gt;&lt;i&gt;&lt;/i&gt;Mono Handbook&lt;h3&gt;&quot; + headinginner + &quot;&lt;/h3&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p /&gt;&quot; +
+			&quot;&lt;tr bgcolor=\&quot;#b0c4de\&quot;&gt;&lt;td&gt;&lt;i&gt;&lt;/i&gt;Mono Handbook&lt;h3&gt;&quot; + headinginner + &quot;&lt;/h3&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;p /&gt;&quot; +
 	bodynode.InnerXml;
 }
 catch {
@@ -117,6 +117,8 @@
 
 		}
 	}
-		return docToProcess;
+		XmlDocument ret = new XmlDocument ();
+		ret.LoadXml (docToProcess.GetElementsByTagName(&quot;body&quot;)[0].OuterXml);
+		return ret;
 	}
 }
Index: provider.cs
===================================================================
RCS file: /cvs/public/monodoc/browser/provider.cs,v
retrieving revision 1.34
diff -u -r1.34 provider.cs
--- provider.cs	11 Jul 2003 00:13:10 -0000	1.34
+++ provider.cs	13 Jul 2003 02:46:20 -0000
@@ -552,7 +552,8 @@
 		//
 		// Load the layout
 		//
-		doc.Load (&quot;monodoc.xml&quot;);
+		string layout = Path.Combine (basedir, &quot;monodoc.xml&quot;);
+		doc.Load (layout);
 		XmlNodeList nodes = doc.SelectNodes (&quot;/node/node&quot;);
 
 		root.name_to_node [&quot;root&quot;] = root;
@@ -561,7 +562,7 @@
 		//
 		// Load the sources
 		//
-		string sources_dir = basedir + &quot;/sources/&quot;;
+		string sources_dir = Path.Combine (basedir, &quot;sources&quot;);
 		
 		string [] files = Directory.GetFiles (sources_dir);
 		foreach (string file in files){
@@ -601,10 +602,11 @@
 				string path = a.InnerText;
 
 				HelpSource hs = null;
+				string basefilepath = Path.Combine (sources_dir, basefile);
 				switch (provider){
 				case &quot;ecma&quot;:
 					try {
-						hs = new EcmaHelpSource (sources_dir + basefile, false);
+						hs = new EcmaHelpSource (basefilepath, false);
 					} catch (FileNotFoundException) {
 						Console.Error.WriteLine (&quot;Error: did not find one of the files in sources/&quot;+basefile);
 						break;
@@ -612,7 +614,7 @@
 					break;
 				case &quot;monohb&quot;:
 					try {
-						hs = new MonoHBHelpSource(sources_dir + basefile, false);
+						hs = new MonoHBHelpSource(basefilepath, false);
 					} catch (FileNotFoundException) {
 						Console.Error.WriteLine (&quot;Error: did not find one of the files in sources/&quot;+basefile);
 						break;
@@ -628,7 +630,7 @@
 					break;
 				case &quot;simple&quot;:
 					try {
-						hs = new SimpleHelpSource (sources_dir + basefile, false);
+						hs = new SimpleHelpSource (basefilepath, false);
 					} catch (FileNotFoundException) {
 						Console.Error.WriteLine (&quot;Error: did not find one of the files in sources/&quot;+basefile);
 						break;
@@ -641,6 +643,7 @@
 				if (hs == null)
 					continue;
 				root.help_sources.Add (hs);
+				root.name_to_hs [path] = hs;
 
 				Node parent = (Node) root.name_to_node [path];
 				if (parent == null){
@@ -661,6 +664,7 @@
 	// Maintains the name to node mapping
 	//
 	Hashtable name_to_node = new Hashtable ();
+	Hashtable name_to_hs = new Hashtable ();
 	
 	void Populate (Node parent, XmlNodeList xml_node_list)
 	{
@@ -678,7 +682,7 @@
 			}
 			string name = e.InnerText;
 
-			Node n = parent.LookupNode (label, name);
+			Node n = parent.LookupNode (label, &quot;root:/&quot; + name);
 			n.EnsureNodes ();
 			name_to_node [name] = n;
 			XmlNodeList children = xml_node.SelectNodes (&quot;./node&quot;);
@@ -812,7 +816,20 @@
 	///    URL.
 	/// &lt;/summary&gt;
 	public string RenderUrl (string url, out Node match_node)
-	{
+	{	
+		if (url.StartsWith (&quot;root:&quot;))
+		{
+			match_node = null;
+			if (url == &quot;root:&quot;) {
+				StringBuilder sb = new StringBuilder (&quot;&lt;h1&gt;Welcome to Monodoc&lt;/h1&gt;&quot;);
+				foreach (Node n in Nodes)
+					sb.AppendFormat (&quot;&lt;a href='{0}'&gt;{1}&lt;/a&gt;&lt;/br&gt;&quot;, n.Element, n.Caption);
+				return sb.ToString ();
+				
+			} else
+				return ((HelpSource)name_to_hs [url.Substring (6)]).GetText (&quot;root:&quot;, out match_node);
+		}
+		
 		if (url.StartsWith (&quot;source-id:&quot;)){
 			string rest = url.Substring (10);
 			int p = rest.IndexOf (&quot;:&quot;);
Index: xhtml-provider.cs
===================================================================
RCS file: /cvs/public/monodoc/browser/xhtml-provider.cs,v
retrieving revision 1.11
diff -u -r1.11 xhtml-provider.cs
--- xhtml-provider.cs	26 Jun 2003 19:12:02 -0000	1.11
+++ xhtml-provider.cs	13 Jul 2003 02:46:20 -0000
@@ -55,6 +55,27 @@
 	public override string GetText (string url, out Node match_node)
 	{
 		match_node = null;
+		
+		if (url == &quot;root:&quot;) {
+			StringBuilder sb = new StringBuilder ();
+			foreach (Node n in Tree.Nodes) {
+				if (n.IsLeaf) { 
+					sb.AppendFormat (&quot;&lt;a href='{0}'&gt;{1}&lt;/a&gt;&lt;/br&gt;&quot;, 
+						n.Element.Replace (&quot;source-id:NNN&quot;, &quot;source-id:&quot; + SourceID), 
+						n.Caption);
+				} else {
+					sb.AppendFormat (&quot;&lt;h2&gt;{0}&lt;/h2&gt;&quot;, n.Caption);
+					foreach (Node subNode in n.Nodes) {
+						sb.AppendFormat (&quot;&lt;a href='{0}'&gt;{1}&lt;/a&gt;&lt;/br&gt;&quot;, 
+							subNode.Element.Replace (&quot;source-id:NNN&quot;, &quot;source-id:&quot; + SourceID), 
+							subNode.Caption);
+					}
+				}
+			}
+			
+			return sb.ToString ();
+		}
+		
 		if (url.IndexOf (XHTML_PREFIX) &gt; -1)
 			return GetTextFromUrl (url);
 
@@ -227,7 +248,7 @@
 			
 			XmlDocument processedDoc = ProcessContent(newdoc);
 			XmlDocument docForMonodoc = RewriteLinks(processedDoc, url);
-			return docForMonodoc.InnerXml;
+			return docForMonodoc.DocumentElement.InnerXml; // get rid of &lt;body&gt;
 		}
 
 		else if (s != null &amp;&amp; (fname.EndsWith (&quot;.gif&quot;) || fname.EndsWith (&quot;.jpeg&quot;) || fname.EndsWith (&quot;.jpg&quot;)  || fname.EndsWith(&quot;.png&quot;)))

--=-gNqXP46pJHwtS+NNgI1b--


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000673.html">[Mono-docs-list] Monodoc aspx .1
</A></li>
	<LI> Next message: <A HREF="000676.html">[Mono-docs-list] Monodoc aspx .1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#674">[ date ]</a>
              <a href="thread.html#674">[ thread ]</a>
              <a href="subject.html#674">[ subject ]</a>
              <a href="author.html#674">[ author ]</a>
         </LI>
       </UL>
</body></html>
