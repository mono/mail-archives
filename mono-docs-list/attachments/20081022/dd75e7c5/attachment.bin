Index: ChangeLog
===================================================================
--- ChangeLog	(revision 116516)
+++ ChangeLog	(working copy)
@@ -1,3 +1,26 @@
+2008-10-22  Jonathan Pryor  <jpryor@novell.com>
+
+	* docs (svn:ignore): Ignore generated files.
+	* docs/lang-csharp.source: Added; combined .source file for the C#
+	  language specification and error reference.
+	* docs/Makefile: Support lang-csharp.source, mono-file-formats.*, etc.
+	* *.tree/*.zip should be rebuilt when Makefile is changed.
+	* docs/mono-file-formats.config, docs/mono-file-formats.source: Added;
+	  moving file format documentation out from mono-tools.* so that it's
+	  easier to find.
+	* docs/mono-tools.config: Move mdoc(5), mono-config(5) to
+	  mono-file-formats.config.
+	* docs/mono-tools.source, docs/Mono.source, docs/netdocs.source,
+	  docs/Novell.source, docs/nunit-docs.source: Add /monodoc/node
+	  information so that the documentation is inserted into the correct
+	  location.
+	* docs/monodoc.xml: Vastly simplify the default monodoc.xml as
+	  structure can be/has been pushed out into the .source files.  This
+	  should help simplify the life of downstream packagers who wish to
+	  add additional documentation to monodoc.
+	* docs/ecma334.source, docs/cs-errors.source: Remove (replaced with
+	  lang-csharp.source).
+
 2008-10-20  Jonathan Pryor  <jpryor@novell.com>
 
 	* docs/Makefile (MONO_DIRS): Add Mono.Data.SqliteClient docs.

Property changes on: docs
___________________________________________________________________
Modified: svn:ignore
   - semantic.cache

   + semantic.cache
*.tree
*.zip


Index: docs/nunit-docs.source
===================================================================
--- docs/nunit-docs.source	(revision 116355)
+++ docs/nunit-docs.source	(working copy)
@@ -1,4 +1,5 @@
 <?xml version="1.0"?>
 <monodoc>
+  <node label="NUnit Libraries" name="classlib-nunit" parent="libraries" />
   <source provider="ecma" basefile="nunit-docs" path="classlib-nunit"/>
 </monodoc>
Index: docs/mono-file-formats.source
===================================================================
--- docs/mono-file-formats.source	(revision 0)
+++ docs/mono-file-formats.source	(revision 0)
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<monodoc>
+  <node label="Mono File Formats" name="mono-formats" parent="formats" />
+  <source provider="man" basefile="mono-file-formats" path="mono-formats"/>
+</monodoc>
Index: docs/monodoc.xml
===================================================================
--- docs/monodoc.xml	(revision 116355)
+++ docs/monodoc.xml	(working copy)
@@ -1,24 +1,7 @@
 <?xml version="1.0"?>
-<node label="Mono Documentation" name="root:">
-  <node label="Class Library" name="classlib"/>
-  <node label="Mono Libraries" name="classlib-mono"/>
-  <node label="Gnome Libraries" name="classlib-gnome"/>
-  <node label="Mozilla Libraries" name="classlib-gecko"/>
-  <node label="Novell Libraries" name="classlib-novell"/>
-  <node label="MonoDevelop IDE" name="md">
-    <node label="API Reference" name="monodevelop" />
-    <node label="Extension Point Reference" name="monodevelop-extension-guide" />
-  </node>
-  <node label="Moonlight/Silverlight" name="moonlight"/>
-  <node label="C# Language Specification" name="ecmaspec" />
-  <node label="C# Compiler Error Reference" name="cs-errors" />
-  <node label="Mono Development Tools" name="dev-tools">
-    <node label="Mono Debugger" name="debugger"/>
-  </node>
-  <node label="Mono Embedding" name="embed"/>
-  <node label="Various" name="various">
-    <node label="DiaCanvas Libraries" name="classlib-diacanvas"/>
-    <node label="NUnit Libraries" name="classlib-nunit"/>
-    <node label="Tao" name="tao"/>
-  </node>
+<node label="Mono Documentation" name="libraries">
+  <node label="File Formats" name="formats" />
+  <node label="Languages" name="languages" />
+  <node label="Tools" name="tools" />
+  <node label="Various" name="various" />
 </node>
Index: docs/lang-csharp.source
===================================================================
--- docs/lang-csharp.source	(revision 0)
+++ docs/lang-csharp.source	(revision 0)
@@ -0,0 +1,9 @@
+<?xml version="1.0"?>
+<monodoc>
+  <node label="C#" name="lang-c#" parent="languages">
+    <node label="C# Compiler Error Reference" name="cs-errors"/>
+    <node label="C# Language Specification" name="ecmaspec"/>
+  </node>
+  <source provider="error" basefile="cs-errors" path="cs-errors"/>
+  <source provider="ecmaspec" basefile="ecma334" path="ecmaspec"/>
+</monodoc>
Index: docs/Novell.source
===================================================================
--- docs/Novell.source	(revision 116355)
+++ docs/Novell.source	(working copy)
@@ -1,4 +1,5 @@
 <?xml version="1.0"?>
 <monodoc>
+  <node label="Novell Libraries" name="classlib-novell" parent="libraries" />
   <source provider="ecma" basefile="Novell" path="classlib-novell"/>
 </monodoc>
Index: docs/netdocs.source
===================================================================
--- docs/netdocs.source	(revision 116355)
+++ docs/netdocs.source	(working copy)
@@ -1,4 +1,5 @@
 <?xml version="1.0"?>
 <monodoc>
+  <node label="Base Class Library" name="classlib" parent="libraries" />
   <source provider="ecma" basefile="netdocs" path="classlib"/>
 </monodoc>
Index: docs/ecma334.source
===================================================================
--- docs/ecma334.source	(revision 116355)
+++ docs/ecma334.source	(working copy)
@@ -1,4 +0,0 @@
-<?xml version="1.0"?>
-<monodoc>
-  <source provider="ecmaspec" basefile="ecma334" path="ecmaspec"/>
-</monodoc>
Index: docs/mono-file-formats.config
===================================================================
--- docs/mono-file-formats.config	(revision 0)
+++ docs/mono-file-formats.config	(revision 0)
@@ -0,0 +1,5 @@
+<?xml version="1.0"?>
+<manpages>
+  <manpage name="mdoc(5)"               page="../../mono/man/mdoc.5" />
+  <manpage name="mono-config(5)"        page="../../mono/man/mono-config.5" />
+</manpages>
Index: docs/mono-tools.source
===================================================================
--- docs/mono-tools.source	(revision 116355)
+++ docs/mono-tools.source	(working copy)
@@ -1,4 +1,5 @@
 <?xml version="1.0"?>
 <monodoc>
+  <node label="Mono Development Tools" name="dev-tools" parent="tools" />
   <source provider="man" basefile="mono-tools" path="dev-tools"/>
 </monodoc>
Index: docs/Mono.source
===================================================================
--- docs/Mono.source	(revision 116355)
+++ docs/Mono.source	(working copy)
@@ -1,4 +1,5 @@
 <?xml version="1.0"?>
 <monodoc>
+  <node label="Mono Libraries" name="classlib-mono" parent="libraries" />
   <source provider="ecma" basefile="Mono" path="classlib-mono"/>
 </monodoc>
Index: docs/mono-tools.config
===================================================================
--- docs/mono-tools.config	(revision 116355)
+++ docs/mono-tools.config	(working copy)
@@ -20,7 +20,6 @@
   <manpage name="mdcs2ecma(1)"          page="../../mono/man/mdcs2ecma.1" />
   <manpage name="mdnormalizer(1)"       page="../../mono/man/mdnormalizer.1" />
   <manpage name="mdoc(1)"               page="../../mono/man/mdoc.1" />
-  <manpage name="mdoc(5)"               page="../../mono/man/mdoc.5" />
   <manpage name="mdoc-assemble(1)"      page="../../mono/man/mdoc-assemble.1" />
   <manpage name="mdoc-export-html(1)"   page="../../mono/man/mdoc-export-html.1" />
   <manpage name="mdoc-export-msxdoc(1)" page="../../mono/man/mdoc-export-msxdoc.1" />
@@ -29,7 +28,6 @@
   <manpage name="mdvalidator(1)"        page="../../mono/man/mdvalidator.1" />
   <manpage name="mkbundle(1)"           page="../../mono/man/mkbundle.1" />
   <manpage name="mono(1)"               page="../../mono/man/mono.1" />
-  <manpage name="mono-config(5)"        page="../../mono/man/mono-config.5" />
   <manpage name="mono-service(1)"       page="../../mono/man/mono-service.1" />
   <manpage name="mono-shlib-cop(1)"     page="../../mono/man/mono-shlib-cop.1" />
   <manpage name="monodocer(1)"          page="../../mono/man/monodocer.1" />
Index: docs/Makefile
===================================================================
--- docs/Makefile	(revision 116516)
+++ docs/Makefile	(working copy)
@@ -15,9 +15,9 @@
 	$(wildcard ecma334/*.xml)
 
 DOC_SOURCE_FILES = \
-	cs-errors.source            \
-	ecma334.source              \
+	lang-csharp.source          \
 	mono-tools.source           \
+	mono-file-formats.source    \
 	Mono.source                 \
 	netdocs.source              \
 	Novell.source               \
@@ -27,6 +27,7 @@
 	cs-errors.tree cs-errors.zip      \
 	ecma334.tree ecma334.zip          \
 	mono-tools.tree mono-tools.zip    \
+	mono-file-formats.tree mono-file-formats.zip    \
 	Mono.tree Mono.zip                \
 	netdocs.tree netdocs.zip          \
 	Novell.tree Novell.zip            \
@@ -96,24 +97,27 @@
 
 build-documentation: $(ASSEMBLED_DOCS)
 
-netdocs.tree netdocs.zip:
+netdocs.tree netdocs.zip: Makefile
 	$(MDOC) assemble -o netdocs $(NETDOCS_DIRS)
 
-Mono.tree Mono.zip:
+Mono.tree Mono.zip: Makefile
 	$(MDOC) assemble -o Mono $(MONO_DIRS)
 
-Novell.tree Novell.zip:
+Novell.tree Novell.zip: Makefile
 	$(MDOC) assemble -o Novell $(NOVELL_DIRS)
 
-nunit-docs.tree nunit-docs.zip:
+nunit-docs.tree nunit-docs.zip: Makefile
 	$(MDOC) assemble -o nunit-docs $(NUNIT_DIRS)
 
-cs-errors.tree cs-errors.zip:
-	$(MDOC) assemble -o cs-errors -f error cs-errors.config
+cs-errors.tree cs-errors.zip: cs-errors.config Makefile
+	$(MDOC) assemble -o cs-errors -f error $<
 
-ecma334.tree ecma334.zip:
+ecma334.tree ecma334.zip: Makefile
 	$(MDOC) assemble -o ecma334 -f ecmaspec ecma334
 
-mono-tools.tree mono-tools.zip: mono-tools.config
-	$(MDOC) assemble -o mono-tools -f man mono-tools.config
+mono-tools.tree mono-tools.zip: mono-tools.config Makefile
+	$(MDOC) assemble -o mono-tools -f man $<
 
+mono-file-formats.tree mono-file-formats.zip: mono-file-formats.config Makefile
+	$(MDOC) assemble -o mono-file-formats -f man $<
+
Index: docs/cs-errors.source
===================================================================
--- docs/cs-errors.source	(revision 116355)
+++ docs/cs-errors.source	(working copy)
@@ -1,4 +0,0 @@
-<?xml version="1.0"?>
-<monodoc>
-  <source provider="error" basefile="cs-errors" path="cs-errors"/>
-</monodoc>
Index: tools/monodoc/ChangeLog
===================================================================
--- tools/monodoc/ChangeLog	(revision 116393)
+++ tools/monodoc/ChangeLog	(working copy)
@@ -1,3 +1,26 @@
+2008-10-21  Jonathan Pryor  <jonpryor@vt.edu>
+
+	* Monodoc/provider.cs: 
+	  - Fix Node.Sort() so that it doesn't NRE if nodes == null.
+	  - Fix Node.CompareTo() so that it can sort Nodes that haven't been
+	    loaded yet.
+	  - Add "libraries" as an alias for "root", so that .source files can
+	    refer to the parent "libraries" (which would allow us to change
+	    the location of "libraries" in the future, should we want to).
+	  - If a /monodoc/source/@path refers to a nonexistant node, then
+	    insert the contents under Various instead of ignoring it.
+	  - Sort the top-level nodes.
+	  - Sort the `parent` node after inserting children under it.  This
+	    allows multiple different .source files to insert nodes under the
+	    same parent node and still have the child nodes sorted as most
+	    mortals would expect.
+	  - Support a //node/@parent attribute, which allows for creating
+	    nodes underneath the specified parent node.  This allows multiple
+	    different .source files to contribute to the tree and depend upon
+	    each other.  Thus, instead of having a single monodoc.xml file
+	    that needs to know the entire tree in advance, the entire tree can
+	    be spread across multiple .source files and filled at runtime.
+
 2008-10-18  Jonathan Pryor  <jonpryor@vt.edu>
 
 	* Makefile $(LIBRARY_PACKAGE): Set to `monodoc`, as we historically
Index: tools/monodoc/Monodoc/provider.cs
===================================================================
--- tools/monodoc/Monodoc/provider.cs	(revision 116332)
+++ tools/monodoc/Monodoc/provider.cs	(working copy)
@@ -339,7 +339,8 @@
 
 	public void Sort ()
 	{
-		nodes.Sort ();
+		if (nodes != null)
+			nodes.Sort ();
 	}
 
 	public string URL {
@@ -364,7 +365,15 @@
 
 	int IComparable.CompareTo (object obj)
 	{
-		Node other = (Node) obj;
+		Node other = obj as Node;
+		if (other == null)
+			return -1;
+
+		if (position < 0)
+			LoadNode ();
+		if (other.position < 0)
+			other.LoadNode ();
+
 		return String.CompareOrdinal(caption, other.caption);
 	}
 }
@@ -779,6 +788,7 @@
 		XmlNodeList nodes = doc.SelectNodes ("/node/node");
 
 		root.name_to_node ["root"] = root;
+		root.name_to_node ["libraries"] = root;
 		root.Populate (root, nodes);
 
 		Node third_party = root.LookupEntryPoint ("various");
@@ -845,12 +855,13 @@
 				Node parent = root.LookupEntryPoint (path);
 				if (parent == null){
 					Console.Error.WriteLine ("node `{0}' is not defined on the documentation map", path);
-					continue;
+					parent = third_party;
 				}
 
 				foreach (Node n in hs.Tree.Nodes){
 					parent.AddNode (n);
 				}
+				parent.Sort ();
 			}
 		}
 		
@@ -869,6 +880,8 @@
 		// Clean the tree
 		PurgeNode(root);
 
+		root.Sort ();
+
 		return root;
 	}
 	
@@ -949,7 +962,14 @@
 	void Populate (Node parent, XmlNodeList xml_node_list)
 	{
 		foreach (XmlNode xml_node in xml_node_list){
-			XmlAttribute e = xml_node.Attributes ["label"];
+			XmlAttribute e = xml_node.Attributes ["parent"];
+			if (e != null && name_to_node.ContainsKey (e.InnerText)) {
+				Node p = (Node) name_to_node [e.InnerText];
+				xml_node.Attributes.Remove (e);
+				Populate (p, xml_node.SelectNodes ("."));
+				continue;
+			}
+			e = xml_node.Attributes ["label"];
 			if (e == null){
 				Console.Error.WriteLine ("`label' attribute missing in <node>");
 				continue;
